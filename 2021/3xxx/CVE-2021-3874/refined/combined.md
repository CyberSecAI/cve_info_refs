=== Content from huntr.dev_44226ae8_20250114_205708.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)

=== Content from github.com_883d9e5d_20250114_205705.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2F7224fbcc89f00f2b71644e36bb1b1d96addd1d5a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2F7224fbcc89f00f2b71644e36bb1b1d96addd1d5a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=BookStackApp%2FBookStack)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[BookStackApp](/BookStackApp)
/
**[BookStack](/BookStackApp/BookStack)**
Public

* [Notifications](/login?return_to=%2FBookStackApp%2FBookStack) You must be signed in to change notification settings
* [Fork
  2k](/login?return_to=%2FBookStackApp%2FBookStack)
* [Star
   15.8k](/login?return_to=%2FBookStackApp%2FBookStack)

* [Code](/BookStackApp/BookStack)
* [Issues
  596](/BookStackApp/BookStack/issues)
* [Pull requests
  2](/BookStackApp/BookStack/pulls)
* [Actions](/BookStackApp/BookStack/actions)
* [Security](/BookStackApp/BookStack/security)
* [Insights](/BookStackApp/BookStack/pulse)

Additional navigation options

* [Code](/BookStackApp/BookStack)
* [Issues](/BookStackApp/BookStack/issues)
* [Pull requests](/BookStackApp/BookStack/pulls)
* [Actions](/BookStackApp/BookStack/actions)
* [Security](/BookStackApp/BookStack/security)
* [Insights](/BookStackApp/BookStack/pulse)

## Commit

[Permalink](/BookStackApp/BookStack/commit/7224fbcc89f00f2b71644e36bb1b1d96addd1d5a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Added protections against path traversal in file system operations

[Browse files](/BookStackApp/BookStack/tree/7224fbcc89f00f2b71644e36bb1b1d96addd1d5a)
Browse the repository at this point in the history

```
- Files within the storage/ path could be accessed via path traversal
  references in content, accessed upon HTML export.
- This addresses this via two layers:
  - Scoped local flysystem filesystems down to the specific image &
    file folders since flysystem has built-in checking against the
    escaping of the root folder.
  - Added path normalization before enforcement of uploads/{images,file}
    prefix to prevent traversal at a path level.

Thanks to [@Haxatron](https://github.com/Haxatron) via huntr.dev for discovery and reporting.
Ref: <https://huntr.dev/bounties/ac268a17-72b5-446f-a09a-9945ef58607a/>
```

* Loading branch information

[![@ssddanbrown](https://avatars.githubusercontent.com/u/8343178?s=40&v=4)](/ssddanbrown)

[ssddanbrown](/BookStackApp/BookStack/commits?author=ssddanbrown "View all commits by ssddanbrown")
committed
Oct 8, 2021

1 parent
[81d6b1b](/BookStackApp/BookStack/commit/81d6b1b016bdbb6c7d01f7f7d0a14585d3104c55)

commit 7224fbc

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**92 additions**
and
**54 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* app

  + Config

    - app/Config/filesystems.php
      [filesystems.php](#diff-e94e996c01a36cfc988e6ddcd73719941ac8ac8d8b105bb238af731b3f53f9a5)
  + Uploads

    - app/Uploads/AttachmentService.php
      [AttachmentService.php](#diff-c544885e35b724cc6ffb070aedd0497d250addb043999029cca57c0e8958691e)
    - app/Uploads/ImageService.php
      [ImageService.php](#diff-48424bf269181c9675770debd425d303d0b790db26e9e2ba6fecdc3ca2dafbf4)

## There are no files selected for viewing

9 changes: 7 additions & 2 deletions

9
[app/Config/filesystems.php](#diff-e94e996c01a36cfc988e6ddcd73719941ac8ac8d8b105bb238af731b3f53f9a5 "app/Config/filesystems.php")

Show comments

[View file](/BookStackApp/BookStack/blob/7224fbcc89f00f2b71644e36bb1b1d96addd1d5a/app/Config/filesystems.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,9 +37,14 @@ |
|  |  | 'root' => public\_path(), |
|  |  | ], |
|  |  |  |
|  |  | 'local\_secure' => [ |
|  |  | 'local\_secure\_attachments' => [ |
|  |  | 'driver' => 'local', |
|  |  | 'root' => storage\_path(), |
|  |  | 'root' => storage\_path('uploads/files/'), |
|  |  | ], |
|  |  |  |
|  |  | 'local\_secure\_images' => [ |
|  |  | 'driver' => 'local', |
|  |  | 'root' => storage\_path('uploads/images/'), |
|  |  | ], |
|  |  |  |
|  |  | 's3' => [ |
| Expand Down | |  |

77 changes: 41 additions & 36 deletions

77
[app/Uploads/AttachmentService.php](#diff-c544885e35b724cc6ffb070aedd0497d250addb043999029cca57c0e8958691e "app/Uploads/AttachmentService.php")

Show comments

[View file](/BookStackApp/BookStack/blob/7224fbcc89f00f2b71644e36bb1b1d96addd1d5a/app/Uploads/AttachmentService.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,7 @@ |
|  |  | use Illuminate\Contracts\Filesystem\Filesystem as FileSystemInstance; |
|  |  | use Illuminate\Support\Facades\Log; |
|  |  | use Illuminate\Support\Str; |
|  |  | use League\Flysystem\Util; |
|  |  | use Symfony\Component\HttpFoundation\File\UploadedFile; |
|  |  |  |
|  |  | class AttachmentService |
| Expand All | | @@ -27,15 +28,39 @@ public function \_\_construct(FileSystem $fileSystem) |
|  |  | \* Get the storage that will be used for storing files. |
|  |  | \*/ |
|  |  | protected function getStorage(): FileSystemInstance |
|  |  | { |
|  |  | return $this->fileSystem->disk($this->getStorageDiskName()); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get the name of the storage disk to use. |
|  |  | \*/ |
|  |  | protected function getStorageDiskName(): string |
|  |  | { |
|  |  | $storageType = config('filesystems.attachments'); |
|  |  |  |
|  |  | // Override default location if set to local public to ensure not visible. |
|  |  | if ($storageType === 'local') { |
|  |  | $storageType = 'local\_secure'; |
|  |  | // Change to our secure-attachment disk if any of the local options |
|  |  | // are used to prevent escaping that location. |
|  |  | if ($storageType === 'local' || $storageType === 'local\_secure') { |
|  |  | $storageType = 'local\_secure\_attachments'; |
|  |  | } |
|  |  |  |
|  |  | return $storageType; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Change the originally provided path to fit any disk-specific requirements. |
|  |  | \* This also ensures the path is kept to the expected root folders. |
|  |  | \*/ |
|  |  | protected function adjustPathForStorageDisk(string $path): string |
|  |  | { |
|  |  | $path = Util::normalizePath(str\_replace('uploads/files/', '', $path)); |
|  |  |  |
|  |  | if ($this->getStorageDiskName() === 'local\_secure\_attachments') { |
|  |  | return $path; |
|  |  | } |
|  |  |  |
|  |  | return $this->fileSystem->disk($storageType); |
|  |  | return 'uploads/files/' . $path; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -45,26 +70,21 @@ protected function getStorage(): FileSystemInstance |
|  |  | \*/ |
|  |  | public function getAttachmentFromStorage(Attachment $attachment): string |
|  |  | { |
|  |  | return $this->getStorage()->get($attachment->path); |
|  |  | return $this->getStorage()->get($this->adjustPathForStorageDisk($attachment->path)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Store a new attachment upon user upload. |
|  |  | \* |
|  |  | \* @param UploadedFile $uploadedFile |
|  |  | \* @param int $page\_id |
|  |  | \* |
|  |  | \* @throws FileUploadException |
|  |  | \* |
|  |  | \* @return Attachment |
|  |  | \*/ |
|  |  | public function saveNewUpload(UploadedFile $uploadedFile, $page\_id) |
|  |  | public function saveNewUpload(UploadedFile $uploadedFile, int $page\_id): Attachment |
|  |  | { |
|  |  | $attachmentName = $uploadedFile->getClientOriginalName(); |
|  |  | $attachmentPath = $this->putFileInStorage($uploadedFile); |
|  |  | $largestExistingOrder = Attachment::where('uploaded\_to', '=', $page\_id)->max('order'); |
|  |  | $largestExistingOrder = Attachment::query()->where('uploaded\_to', '=', $page\_id)->max('order'); |
|  |  |  |
|  |  | $attachment = Attachment::forceCreate([ |
|  |  | /\*\* @var Attachment $attachment \*/ |
|  |  | $attachment = Attachment::query()->forceCreate([ |
|  |  | 'name' => $attachmentName, |
|  |  | 'path' => $attachmentPath, |
|  |  | 'extension' => $uploadedFile->getClientOriginalExtension(), |
| Expand All | | @@ -78,17 +98,12 @@ public function saveNewUpload(UploadedFile $uploadedFile, $page\_id) |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Store a upload, saving to a file and deleting any existing uploads |
|  |  | \* Store an upload, saving to a file and deleting any existing uploads |
|  |  | \* attached to that file. |
|  |  | \* |
|  |  | \* @param UploadedFile $uploadedFile |
|  |  | \* @param Attachment $attachment |
|  |  | \* |
|  |  | \* @throws FileUploadException |
|  |  | \* |
|  |  | \* @return Attachment |
|  |  | \*/ |
|  |  | public function saveUpdatedUpload(UploadedFile $uploadedFile, Attachment $attachment) |
|  |  | public function saveUpdatedUpload(UploadedFile $uploadedFile, Attachment $attachment): Attachment |
|  |  | { |
|  |  | if (!$attachment->external) { |
|  |  | $this->deleteFileInStorage($attachment); |
| Expand Down  Expand Up | | @@ -159,9 +174,6 @@ public function updateFile(Attachment $attachment, array $requestData): Attachme |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Delete a File from the database and storage. |
|  |  | \* |
|  |  | \* @param Attachment $attachment |
|  |  | \* |
|  |  | \* @throws Exception |
|  |  | \*/ |
|  |  | public function deleteFile(Attachment $attachment) |
| Expand All | | @@ -179,45 +191,38 @@ public function deleteFile(Attachment $attachment) |
|  |  | /\*\* |
|  |  | \* Delete a file from the filesystem it sits on. |
|  |  | \* Cleans any empty leftover folders. |
|  |  | \* |
|  |  | \* @param Attachment $attachment |
|  |  | \*/ |
|  |  | protected function deleteFileInStorage(Attachment $attachment) |
|  |  | { |
|  |  | $storage = $this->getStorage(); |
|  |  | $dirPath = dirname($attachment->path); |
|  |  | $dirPath = $this->adjustPathForStorageDisk(dirname($attachment->path)); |
|  |  |  |
|  |  | $storage->delete($attachment->path); |
|  |  | $storage->delete($this->adjustPathForStorageDisk($attachment->path)); |
|  |  | if (count($storage->allFiles($dirPath)) === 0) { |
|  |  | $storage->deleteDirectory($dirPath); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Store a file in storage with the given filename. |
|  |  | \* |
|  |  | \* @param UploadedFile $uploadedFile |
|  |  | \* |
|  |  | \* @throws FileUploadException |
|  |  | \* |
|  |  | \* @return string |
|  |  | \*/ |
|  |  | protected function putFileInStorage(UploadedFile $uploadedFile) |
|  |  | protected function putFileInStorage(UploadedFile $uploadedFile): string |
|  |  | { |
|  |  | $attachmentData = file\_get\_contents($uploadedFile->getRealPath()); |
|  |  |  |
|  |  | $storage = $this->getStorage(); |
|  |  | $basePath = 'uploads/files/' . date('Y-m-M') . '/'; |
|  |  |  |
|  |  | $uploadFileName = Str::random(16) . '.' . $uploadedFile->getClientOriginalExtension(); |
|  |  | while ($storage->exists($basePath . $uploadFileName)) { |
|  |  | while ($storage->exists($this->adjustPathForStorageDisk($basePath . $uploadFileName))) { |
|  |  | $uploadFileName = Str::random(3) . $uploadFileName; |
|  |  | } |
|  |  |  |
|  |  | $attachmentPath = $basePath . $uploadFileName; |
|  |  |  |
|  |  | try { |
|  |  | $storage->put($attachmentPath, $attachmentData); |
|  |  | $storage->put($this->adjustPathForStorageDisk($attachmentPath), $attachmentData); |
|  |  | } catch (Exception $e) { |
|  |  | Log::error('Error when attempting file upload:' . $e->getMessage()); |
|  |  |  |
| Expand Down | |  |

60 changes: 44 additions & 16 deletions

60
[app/Uploads/ImageService.php](#diff-48424bf269181c9675770debd425d303d0b790db26e9e2ba6fecdc3ca2dafbf4 "app/Uploads/ImageService.php")

Show comments

[View file](/BookStackApp/BookStack/blob/7224fbcc89f00f2b71644e36bb1b1d96addd1d5a/app/Uploads/ImageService.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ |
|  |  | use Illuminate\Support\Str; |
|  |  | use Intervention\Image\Exception\NotSupportedException; |
|  |  | use Intervention\Image\ImageManager; |
|  |  | use League\Flysystem\Util; |
|  |  | use Symfony\Component\HttpFoundation\File\UploadedFile; |
|  |  |  |
|  |  | class ImageService |
| Expand All | | @@ -38,16 +39,43 @@ public function \_\_construct(Image $image, ImageManager $imageTool, FileSystem $f |
|  |  | /\*\* |
|  |  | \* Get the storage that will be used for storing images. |
|  |  | \*/ |
|  |  | protected function getStorage(string $type = ''): FileSystemInstance |
|  |  | protected function getStorage(string $imageType = ''): FileSystemInstance |
|  |  | { |
|  |  | return $this->fileSystem->disk($this->getStorageDiskName($imageType)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Change the originally provided path to fit any disk-specific requirements. |
|  |  | \* This also ensures the path is kept to the expected root folders. |
|  |  | \*/ |
|  |  | protected function adjustPathForStorageDisk(string $path, string $imageType = ''): string |
|  |  | { |
|  |  | $path = Util::normalizePath(str\_replace('uploads/images/', '', $path)); |
|  |  |  |
|  |  | if ($this->getStorageDiskName($imageType) === 'local\_secure\_images') { |
|  |  | return $path; |
|  |  | } |
|  |  |  |
|  |  | return 'uploads/images/' . $path; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get the name of the storage disk to use. |
|  |  | \*/ |
|  |  | protected function getStorageDiskName(string $imageType): string |
|  |  | { |
|  |  | $storageType = config('filesystems.images'); |
|  |  |  |
|  |  | // Ensure system images (App logo) are uploaded to a public space |
|  |  | if ($type === 'system' && $storageType === 'local\_secure') { |
|  |  | if ($imageType === 'system' && $storageType === 'local\_secure') { |
|  |  | $storageType = 'local'; |
|  |  | } |
|  |  |  |
|  |  | return $this->fileSystem->disk($storageType); |
|  |  | if ($storageType === 'local\_secure') { |
|  |  | $storageType = 'local\_secure\_images'; |
|  |  | } |
|  |  |  |
|  |  | return $storageType; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down  Expand Up | | @@ -104,7 +132,7 @@ public function saveNew(string $imageName, string $imageData, string $type, int |
|  |  |  |
|  |  | $imagePath = '/uploads/images/' . $type . '/' . date('Y-m') . '/'; |
|  |  |  |
|  |  | while ($storage->exists($imagePath . $fileName)) { |
|  |  | while ($storage->exists($this->adjustPathForStorageDisk($imagePath . $fileName, $type))) { |
|  |  | $fileName = Str::random(3) . $fileName; |
|  |  | } |
|  |  |  |
| Expand All | | @@ -114,7 +142,7 @@ public function saveNew(string $imageName, string $imageData, string $type, int |
|  |  | } |
|  |  |  |
|  |  | try { |
|  |  | $this->saveImageDataInPublicSpace($storage, $fullPath, $imageData); |
|  |  | $this->saveImageDataInPublicSpace($storage, $this->adjustPathForStorageDisk($fullPath, $type), $imageData); |
|  |  | } catch (Exception $e) { |
|  |  | \Log::error('Error when attempting image upload:' . $e->getMessage()); |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,13 +244,13 @@ public function getThumbnail(Image $image, $width = 220, $height = 220, $keepRat |
|  |  | } |
|  |  |  |
|  |  | $storage = $this->getStorage($image->type); |
|  |  | if ($storage->exists($thumbFilePath)) { |
|  |  | if ($storage->exists($this->adjustPathForStorageDisk($thumbFilePath, $image->type))) { |
|  |  | return $this->getPublicUrl($thumbFilePath); |
|  |  | } |
|  |  |  |
|  |  | $thumbData = $this->resizeImage($storage->get($imagePath), $width, $height, $keepRatio); |
|  |  | $thumbData = $this->resizeImage($storage->get($this->adjustPathForStorageDisk($imagePath, $image->type)), $width, $height, $keepRatio); |
|  |  |  |
|  |  | $this->saveImageDataInPublicSpace($storage, $thumbFilePath, $thumbData); |
|  |  | $this->saveImageDataInPublicSpace($storage, $this->adjustPathForStorageDisk($thumbFilePath, $image->type), $thumbData); |
|  |  | $this->cache->put('images-' . $image->id . '-' . $thumbFilePath, $thumbFilePath, 60 \* 60 \* 72); |
|  |  |  |
|  |  | return $this->getPublicUrl($thumbFilePath); |
| Expand Down  Expand Up | | @@ -279,10 +307,8 @@ protected function resizeImage(string $imageData, $width = 220, $height = null, |
|  |  | \*/ |
|  |  | public function getImageData(Image $image): string |
|  |  | { |
|  |  | $imagePath = $image->path; |
|  |  | $storage = $this->getStorage(); |
|  |  |  |
|  |  | return $storage->get($imagePath); |
|  |  | return $storage->get($this->adjustPathForStorageDisk($image->path, $image->type)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -292,17 +318,18 @@ public function getImageData(Image $image): string |
|  |  | \*/ |
|  |  | public function destroy(Image $image) |
|  |  | { |
|  |  | $this->destroyImagesFromPath($image->path); |
|  |  | $this->destroyImagesFromPath($image->path, $image->type); |
|  |  | $image->delete(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Destroys an image at the given path. |
|  |  | \* Searches for image thumbnails in addition to main provided path. |
|  |  | \*/ |
|  |  | protected function destroyImagesFromPath(string $path): bool |
|  |  | protected function destroyImagesFromPath(string $path, string $imageType): bool |
|  |  | { |
|  |  | $storage = $this->getStorage(); |
|  |  | $path = $this->adjustPathForStorageDisk($path, $imageType); |
|  |  | $storage = $this->getStorage($imageType); |
|  |  |  |
|  |  | $imageFolder = dirname($path); |
|  |  | $imageFileName = basename($path); |
| Expand All | | @@ -326,7 +353,7 @@ protected function destroyImagesFromPath(string $path): bool |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check whether or not a folder is empty. |
|  |  | \* Check whether a folder is empty. |
|  |  | \*/ |
|  |  | protected function isFolderEmpty(FileSystemInstance $storage, string $path): bool |
|  |  | { |
| Expand Down  Expand Up | | @@ -374,7 +401,7 @@ public function deleteUnusedImages(bool $checkRevisions = true, bool $dryRun = t |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Convert a image URI to a Base64 encoded string. |
|  |  | \* Convert an image URI to a Base64 encoded string. |
|  |  | \* Attempts to convert the URL to a system storage url then |
|  |  | \* fetch the data from the disk or storage location. |
|  |  | \* Returns null if the image data cannot be fetched from storage. |
| Expand All | | @@ -388,6 +415,7 @@ public function imageUriToBase64(string $uri): ?string |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | $storagePath = $this->adjustPathForStorageDisk($storagePath); |
|  |  | $storage = $this->getStorage(); |
|  |  | $imageData = null; |
|  |  | if ($storage->exists($storagePath)) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7224fbc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbookstackapp%2Fbookstack%2Fcommit%2F7224fbcc89f00f2b71644e36bb1b1d96addd1d5a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


