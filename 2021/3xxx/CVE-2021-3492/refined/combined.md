=== Content from git.launchpad.net_19cf1efe_20250114_220909.html ===


| [cgit logo](/) | [index](/) : [~ubuntu-kernel/ubuntu/+source/linux/+git/focal](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/ "~ubuntu-kernel/ubuntu/+source/linux/+git/focal") | hwe-5.11 hwe-5.11-next hwe-5.11-prep hwe-5.13 hwe-5.13-next hwe-5.13-prep hwe-5.15 hwe-5.15-next hwe-5.15-next--2024.02.05-1--auto hwe-5.15-next--2024.03.04-1--auto hwe-5.15-next--2024.04.01-1--auto hwe-5.15-next--2024.04.01-3--auto hwe-5.15-next--2024.04.29-1--auto hwe-5.15-next--2024.04.29-3--auto hwe-5.15-next--2024.06.10-1--auto hwe-5.15-next--2024.06.10-4--auto hwe-5.15-next--2024.09.30-1--auto hwe-5.15-next--2024.10.28-1--auto hwe-5.15-next--s2024.01.08-1--auto hwe-5.15-next--s2024.02.05-1--auto hwe-5.15-next--s2024.04.01-1--auto hwe-5.15-next--s2024.04.29-1--auto hwe-5.15-next--s2024.06.10-1--auto hwe-5.15-next--s2024.08.05-1--auto hwe-5.15-next--s2024.09.02-1--auto hwe-5.15-next--s2024.09.30-1--auto hwe-5.15-next--s2024.10.28-1--auto hwe-5.15-prep hwe-5.8 hwe-5.8-prep master master-next master-next--2024.02.05-1--auto master-next--2024.03.04-1 master-next--2024.03.04-1--auto master-next--2024.03.04-2 master-next--2024.03.04-2--auto master-next--2024.04.01-1 master-next--2024.04.01-1--auto master-next--2024.04.29-1 master-next--2024.04.29-1--auto master-next--2024.06.10-1 master-next--2024.07.08-1 master-next--2024.07.08-1--auto master-next--2024.09.30-2--auto master-next--2024.10.28-2 master-next--2024.10.28-2--auto master-next--s2024.01.08-1--auto master-next--s2024.02.05-1 master-next--s2024.02.05-1--auto master-next--s2024.03.04-1--auto master-next--s2024.04.01-1 master-next--s2024.04.01-1--auto master-next--s2024.04.29-1 master-next--s2024.04.29-1--auto master-next--s2024.06.10-1 master-next--s2024.06.10-1--auto master-next--s2024.07.08-1 master-next--s2024.08.05-1 master-next--s2024.08.05-1--auto master-next--s2024.09.02-1 master-next--s2024.09.30-1--auto master-next--s2024.10.28-1 master-next--s2024.10.28-1--auto master-next--s2024.10.28-2 master-next--s2024.12.02-1 master-prep |
| --- | --- | --- |
| [no description] |  |

| [summary](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/)[refs](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/refs/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)[log](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/log/)[tree](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)[commit](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)[diff](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=25c891a949bf918b59cbc6e4932015ba4c35c333) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Seth Forshee <seth.forshee@canonical.com> | 2021-04-09 13:10:37 -0500 |
| --- | --- | --- |
| committer | Stefan Bader <stefan.bader@canonical.com> | 2021-04-12 17:10:52 +0200 |
| commit | [25c891a949bf918b59cbc6e4932015ba4c35c333](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=25c891a949bf918b59cbc6e4932015ba4c35c333) ([patch](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/patch/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)) | |
| tree | [8f6d99398bb79b0aa55ca96d8629fc8d603d60cc](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/?id=25c891a949bf918b59cbc6e4932015ba4c35c333) | |
| parent | [8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6) ([diff](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=25c891a949bf918b59cbc6e4932015ba4c35c333&id2=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)) | |

UBUNTU: SAUCE: shiftfs: handle copy\_to\_user() return values correctlyshiftfs expects copy\_to\_user() to return a negative error code on
failure, when it actually returns the amount of uncopied data. Fix all
code using copy\_to\_user() to handle the return values correctly.
Signed-off-by: Seth Forshee <seth.forshee@canonical.com>
CVE-2021-3492
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Acked-by: Stefan Bader <stefan.bader@canonical.com>
Acked-by: Marcelo Cerri <marcelo.cerri@canonical.com>
Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
[Diffstat](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)

| -rw-r--r-- | [fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/fs/shiftfs.c?id=25c891a949bf918b59cbc6e4932015ba4c35c333) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/fs/shiftfs.c b/fs/shiftfs.cindex 5dfa41423697..e73b121081e0 100644--- a/[fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/fs/shiftfs.c?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)+++ b/[fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/fs/shiftfs.c?id=25c891a949bf918b59cbc6e4932015ba4c35c333)@@ -1423,7 +1423,7 @@ static int shiftfs\_btrfs\_ioctl\_fd\_restore(int cmd, int fd, void \_\_user \*arg, kfree(v1); kfree(v2); - return ret;+ return ret ? -EFAULT: 0; }  static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg,@@ -1500,6 +1500,7 @@ static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg, \*b2 = v2; } else { shiftfs\_btrfs\_ioctl\_fd\_restore(cmd, \*newfd, arg, v1, v2);+ ret = -EFAULT; }  return ret; |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-14 22:09:09 +0000



=== Content from www.openwall.com_7d7218fa_20250114_220910.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20210415213306.GB5315@nxnw.org>
Date: Thu, 15 Apr 2021 14:33:06 -0700
From: Steve Beattie <steve.beattie@...onical.com>
To: oss-security@...ts.openwall.com
Subject: [CVE-2021-3492] Ubuntu shiftfs Linux kernel file system double free
 vulnerability

Hello,

Shiftfs is an out-of-tree stacking file system for the Linux kernel
included in Ubuntu kernels that can be mounted by unprivileged users
within unprivileged user namespaces.

Vincent Dehors discovered that shiftfs, when passing through
ioctls to the underlying file system, did not properly handle faults
occurring during copy_from_user() correctly, leading to a double-free
vulnerability or not freeing memory at all. An attacker could use
this to cause a denial of service (memory consumption) or execute
arbitrary code.

The commits to address this issue are as follows:

 Ubuntu 20.10:
  5c4ddd2d104e ("UBUNTU: SAUCE: shiftfs: free allocated memory in shiftfs_btrfs_ioctl_fd_replace() error paths")
  [https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/groovy/commit/?id=5c4ddd2d104e5561724c636c9a83ab722255dc2e](https://git.launchpad.net/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/groovy/commit/?id=5c4ddd2d104e5561724c636c9a83ab722255dc2e)
  a92f3ddbb391 ("UBUNTU: SAUCE: shiftfs: handle copy_to_user() return values correctly")
  [https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/groovy/commit/?id=a92f3ddbb391ce466a470e578cb24a37d7eb813c](https://git.launchpad.net/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/groovy/commit/?id=a92f3ddbb391ce466a470e578cb24a37d7eb813c)

 Ubuntu 20.04 LTS:
  8fee52ab9da8 ("UBUNTU: SAUCE: shiftfs: free allocated memory in shiftfs_btrfs_ioctl_fd_replace() error paths")
  [https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6](https://git.launchpad.net/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)
  25c891a949bf ("UBUNTU: SAUCE: shiftfs: handle copy_to_user() return values correctly")
  [https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal/commit/?id=25c891a949bf918b59cbc6e4932015ba4c35c333](https://git.launchpad.net/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=25c891a949bf918b59cbc6e4932015ba4c35c333)

As shiftfs has not been accepted in the upstream Linux kernel, the
upstream Linux kernel is not affected by CVE-2021-3492.

This issue is also identified as ZDI-CAN-13562.
--
Steve Beattie
<sbeattie@...ntu.com>

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.zerodayinitiative.com_66478ba4_20250114_220912.html ===

[![thezdi](/images/logo.svg)](/)

Menu

* [PRIVACY](https://www.trendmicro.com/privacy)
* [WHO WE ARE](/about/)
* [HOW IT WORKS](/about/benefits/)
* [BLOG](/blog/)
* [ADVISORIES](/advisories/)
* [LOG IN](/portal/)
  [SIGN UP](/portal/register/)

Menu

* [PRIVACY](https://www.trendmicro.com/privacy/)
* [WHO WE ARE](/about/)
* [HOW IT WORKS](/about/benefits/)
* [BLOG](/blog/)
* [ADVISORIES](/advisories/)
* [LOG IN](/portal/)
* [SIGN UP](/portal/register/)

* [![thezdi](/images/logo.svg)](/)
* [Trend Micro](https://www.trendmicro.com/)

# Advisory Details

April 21st, 2021
## (Pwn2Own) Canonical Ubuntu ShiftFS File System Double Free Privilege Escalation Vulnerability

### ZDI-21-422ZDI-CAN-13562

| CVE ID | [CVE-2021-3492](https://www.cve.org/CVERecord?id=CVE-2021-3492) |
| --- | --- |
| CVSS SCORE | 8.8, [AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H](http://nvd.nist.gov/cvss.cfm?calculator&version=3.0&vector=AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H) |
| AFFECTED VENDORS | Canonical |
| AFFECTED PRODUCTS | Ubuntu |
| VULNERABILITY DETAILS | This vulnerability allows local attackers to escalate privileges on affected installations of Canonical Ubuntu. An attacker must first obtain the ability to execute high-privileged code on the target system in order to exploit this vulnerability.  The specific flaw exists within the ShiftFS module. The issue results from the lack of validating the existence of an object prior to performing further free operations on the object. An attacker can leverage this vulnerability to escalate privileges and execute code in the context of the kernel. |
| ADDITIONAL DETAILS | Canonical has issued an update to correct this vulnerability. More details can be found at: |
| DISCLOSURE TIMELINE | * 2021-04-19 - Vulnerability reported to vendor * 2021-04-21 - Coordinated public release of advisory |
| CREDIT | Vincent Dehors (@vdehors) from Synacktiv (@Synacktiv) |

[BACK TO ADVISORIES](/advisories/)

### General Inquiries

zdi@trendmicro.com

### Find us on X

[@thezdi](https://twitter.com/thezdi)

### Find us on Mastodon

[Mastodon](https://infosec.exchange/%40thezdi)

### Media Inquiries

media\_relations@trendmicro.com

### Sensitive Email Communications

[PGP Key](https://www.zerodayinitiative.com/documents/zdi-pgp-key.asc)

[WHO WE ARE](/about/)

* [Our Mission](/about/)
* [Trend Micro](https://www.trendmicro.com)
* [TippingPoint IPS](https://www.trendmicro.com/en_us/business/products/network/integrated-atp/next-gen-intrusion-prevention-system.html)

[HOW IT WORKS](/about/benefits/)

* [Process](/about/benefits/#process)
* [Researcher Rewards](/about/benefits/#researcher-rewards)
* [FAQS](/about/faq/)
* [Privacy](https://www.trendmicro.com/privacy/)

[ADVISORIES](/advisories)

* [Published Advisories](/advisories/published)
* [Upcoming Advisories](/advisories/upcoming)
* [RSS Feeds](/rss)

[BLOG](/blog)

[![thezdi](/images/logo-footer.svg)](/)



=== Content from packetstormsecurity.com_fb426a6c_20250114_220907.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from git.launchpad.net_f487ff33_20250114_220909.html ===


| [cgit logo](/) | [index](/) : [~ubuntu-kernel/ubuntu/+source/linux/+git/focal](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/ "~ubuntu-kernel/ubuntu/+source/linux/+git/focal") | hwe-5.11 hwe-5.11-next hwe-5.11-prep hwe-5.13 hwe-5.13-next hwe-5.13-prep hwe-5.15 hwe-5.15-next hwe-5.15-next--2024.02.05-1--auto hwe-5.15-next--2024.03.04-1--auto hwe-5.15-next--2024.04.01-1--auto hwe-5.15-next--2024.04.01-3--auto hwe-5.15-next--2024.04.29-1--auto hwe-5.15-next--2024.04.29-3--auto hwe-5.15-next--2024.06.10-1--auto hwe-5.15-next--2024.06.10-4--auto hwe-5.15-next--2024.09.30-1--auto hwe-5.15-next--2024.10.28-1--auto hwe-5.15-next--s2024.01.08-1--auto hwe-5.15-next--s2024.02.05-1--auto hwe-5.15-next--s2024.04.01-1--auto hwe-5.15-next--s2024.04.29-1--auto hwe-5.15-next--s2024.06.10-1--auto hwe-5.15-next--s2024.08.05-1--auto hwe-5.15-next--s2024.09.02-1--auto hwe-5.15-next--s2024.09.30-1--auto hwe-5.15-next--s2024.10.28-1--auto hwe-5.15-prep hwe-5.8 hwe-5.8-prep master master-next master-next--2024.02.05-1--auto master-next--2024.03.04-1 master-next--2024.03.04-1--auto master-next--2024.03.04-2 master-next--2024.03.04-2--auto master-next--2024.04.01-1 master-next--2024.04.01-1--auto master-next--2024.04.29-1 master-next--2024.04.29-1--auto master-next--2024.06.10-1 master-next--2024.07.08-1 master-next--2024.07.08-1--auto master-next--2024.09.30-2--auto master-next--2024.10.28-2 master-next--2024.10.28-2--auto master-next--s2024.01.08-1--auto master-next--s2024.02.05-1 master-next--s2024.02.05-1--auto master-next--s2024.03.04-1--auto master-next--s2024.04.01-1 master-next--s2024.04.01-1--auto master-next--s2024.04.29-1 master-next--s2024.04.29-1--auto master-next--s2024.06.10-1 master-next--s2024.06.10-1--auto master-next--s2024.07.08-1 master-next--s2024.08.05-1 master-next--s2024.08.05-1--auto master-next--s2024.09.02-1 master-next--s2024.09.30-1--auto master-next--s2024.10.28-1 master-next--s2024.10.28-1--auto master-next--s2024.10.28-2 master-next--s2024.12.02-1 master-prep |
| --- | --- | --- |
| [no description] |  |

| [summary](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/)[refs](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/refs/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)[log](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/log/)[tree](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)[commit](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)[diff](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Seth Forshee <seth.forshee@canonical.com> | 2021-04-09 13:01:06 -0500 |
| --- | --- | --- |
| committer | Stefan Bader <stefan.bader@canonical.com> | 2021-04-12 17:10:51 +0200 |
| commit | [8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6) ([patch](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/patch/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)) | |
| tree | [656653efdcdf3ec599efa19cd422f872f84320db](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6) | |
| parent | [75891ef8c55d4b1b899355c50dd3d7d0bae82a89](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/commit/?id=75891ef8c55d4b1b899355c50dd3d7d0bae82a89) ([diff](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6&id2=75891ef8c55d4b1b899355c50dd3d7d0bae82a89)) | |

UBUNTU: SAUCE: shiftfs: free allocated memory in shiftfs\_btrfs\_ioctl\_fd\_replace() error pathsMany error paths in shiftfs\_btrfs\_ioctl\_fd\_replace() do not free memory
allocated near the top of the function. Fix up these error paths to free
the memory.
Additionally, the addresses for the allocated memory are assigned to
return parameters early in the function, before we know whether or not
the function as a whole will return success. Wait to assign these values
until we know the function was successful, and for good measure
initialize the return parameters to NULL at the start.
Signed-off-by: Seth Forshee <seth.forshee@canonical.com>
CVE-2021-3492
Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
Acked-by: Stefan Bader <stefan.bader@canonical.com>
Acked-by: Marcelo Cerri <marcelo.cerri@canonical.com>
Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
[Diffstat](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)

| -rw-r--r-- | [fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/diff/fs/shiftfs.c?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6) | 28 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 7 deletions

| diff --git a/fs/shiftfs.c b/fs/shiftfs.cindex 6f40cb9272be..5dfa41423697 100644--- a/[fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/fs/shiftfs.c?id=75891ef8c55d4b1b899355c50dd3d7d0bae82a89)+++ b/[fs/shiftfs.c](/~ubuntu-kernel/ubuntu/%2Bsource/linux/%2Bgit/focal/tree/fs/shiftfs.c?id=8fee52ab9da87d82bc6de9ebb3480fff9b4d53e6)@@ -1437,6 +1437,9 @@ static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg, struct btrfs\_ioctl\_vol\_args \*v1 = NULL; struct btrfs\_ioctl\_vol\_args\_v2 \*v2 = NULL; + \*b1 = NULL;+ \*b2 = NULL;+ if (!is\_btrfs\_snap\_ioctl(cmd)) return 0; @@ -1445,23 +1448,23 @@ static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg, if (IS\_ERR(v1)) return PTR\_ERR(v1); oldfd = v1->fd;- \*b1 = v1; } else { v2 = memdup\_user(arg, sizeof(\*v2)); if (IS\_ERR(v2)) return PTR\_ERR(v2); oldfd = v2->fd;- \*b2 = v2; }  src = fdget(oldfd);- if (!src.file)- return -EINVAL;+ if (!src.file) {+ ret = -EINVAL;+ goto err\_free;+ }  ret = shiftfs\_real\_fdget(src.file, &lfd); if (ret) { fdput(src);- return ret;+ goto err\_free; }  /\*@@ -1476,7 +1479,8 @@ static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg, \*newfd = get\_unused\_fd\_flags(lfd.file->f\_flags); if (\*newfd < 0) { fdput(lfd);- return \*newfd;+ ret = \*newfd;+ goto err\_free; }  fd\_install(\*newfd, lfd.file);@@ -1491,8 +1495,18 @@ static int shiftfs\_btrfs\_ioctl\_fd\_replace(int cmd, void \_\_user \*arg, v2->fd = oldfd; } - if (ret)+ if (!ret) {+ \*b1 = v1;+ \*b2 = v2;+ } else { shiftfs\_btrfs\_ioctl\_fd\_restore(cmd, \*newfd, arg, v1, v2);+ }++ return ret;++err\_free:+ kfree(v1);+ kfree(v2);  return ret; } |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-14 22:09:09 +0000


