=== Content from git.kernel.org_932baea3_20250114_224255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Cong Wang <xiyou.wangcong@gmail.com> | 2020-03-13 22:29:54 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2020-03-16 01:59:32 -0700 |
| commit | [ef299cc3fa1a9e1288665a9fdc8bff55629fd359](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)) | |
| tree | [260bd9b4c8d37f9770b4b04e30663812728079d8](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359) | |
| parent | [4ae649e8879d5a96b0ce104c8eae6563c6f368a1](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4ae649e8879d5a96b0ce104c8eae6563c6f368a1) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359&id2=4ae649e8879d5a96b0ce104c8eae6563c6f368a1)) | |
| download | [linux-ef299cc3fa1a9e1288665a9fdc8bff55629fd359.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ef299cc3fa1a9e1288665a9fdc8bff55629fd359.tar.gz) | |

net\_sched: cls\_route: remove the right filter from hashtableroute4\_change() allocates a new filter and copies values from
the old one. After the new filter is inserted into the hash
table, the old filter should be removed and freed, as the final
step of the update.
However, the current code mistakenly removes the new one. This
looks apparently wrong to me, and it causes double "free" and
use-after-free too, as reported by syzbot.
Reported-and-tested-by: syzbot+f9b32aaacd60305d9687@syzkaller.appspotmail.com
Reported-and-tested-by: syzbot+2f8c233f131943d6056d@syzkaller.appspotmail.com
Reported-and-tested-by: syzbot+9c2df9fd5e9445b74e01@syzkaller.appspotmail.com
Fixes: 1109c00547fc ("net: sched: RCU cls\_route")
Cc: Jamal Hadi Salim <jhs@mojatatu.com>
Cc: Jiri Pirko <jiri@resnulli.us>
Cc: John Fastabend <john.fastabend@gmail.com>
Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)

| -rw-r--r-- | [net/sched/cls\_route.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/sched/cls_route.c?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/net/sched/cls\_route.c b/net/sched/cls\_route.cindex 6f8786b06bde17..5efa3e7ace1524 100644--- a/[net/sched/cls\_route.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/cls_route.c?id=4ae649e8879d5a96b0ce104c8eae6563c6f368a1)+++ b/[net/sched/cls\_route.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/sched/cls_route.c?id=ef299cc3fa1a9e1288665a9fdc8bff55629fd359)@@ -534,8 +534,8 @@ static int route4\_change(struct net \*net, struct sk\_buff \*in\_skb, fp = &b->ht[h]; for (pfp = rtnl\_dereference(\*fp); pfp; fp = &pfp->next, pfp = rtnl\_dereference(\*fp)) {- if (pfp == f) {- \*fp = f->next;+ if (pfp == fold) {+ rcu\_assign\_pointer(\*fp, fold->next); break; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 22:41:32 +0000


