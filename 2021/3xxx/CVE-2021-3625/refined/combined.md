=== Content from github.com_8cf84eff_20250115_083254.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzephyrproject-rtos%2Fzephyr%2Fsecurity%2Fadvisories%2FGHSA-c3gr-hgvr-f363)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzephyrproject-rtos%2Fzephyr%2Fsecurity%2Fadvisories%2FGHSA-c3gr-hgvr-f363)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=zephyrproject-rtos%2Fzephyr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zephyrproject-rtos](/zephyrproject-rtos)
/
**[zephyr](/zephyrproject-rtos/zephyr)**
Public

* [Notifications](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr) You must be signed in to change notification settings
* [Fork
  6.8k](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr)
* [Star
   11.2k](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr)

* [Code](/zephyrproject-rtos/zephyr)
* [Issues
  1.9k](/zephyrproject-rtos/zephyr/issues)
* [Pull requests
  872](/zephyrproject-rtos/zephyr/pulls)
* [Discussions](/zephyrproject-rtos/zephyr/discussions)
* [Actions](/zephyrproject-rtos/zephyr/actions)
* [Projects
  20](/zephyrproject-rtos/zephyr/projects)
* [Wiki](/zephyrproject-rtos/zephyr/wiki)
* [Security](/zephyrproject-rtos/zephyr/security)
* [Insights](/zephyrproject-rtos/zephyr/pulse)

Additional navigation options

* [Code](/zephyrproject-rtos/zephyr)
* [Issues](/zephyrproject-rtos/zephyr/issues)
* [Pull requests](/zephyrproject-rtos/zephyr/pulls)
* [Discussions](/zephyrproject-rtos/zephyr/discussions)
* [Actions](/zephyrproject-rtos/zephyr/actions)
* [Projects](/zephyrproject-rtos/zephyr/projects)
* [Wiki](/zephyrproject-rtos/zephyr/wiki)
* [Security](/zephyrproject-rtos/zephyr/security)
* [Insights](/zephyrproject-rtos/zephyr/pulse)

# Buffer overflow in Zephyr USB DFU DNLOAD

Critical

[d3zd3z](/d3zd3z)
published
GHSA-c3gr-hgvr-f363
Oct 5, 2021

## Package

zephyr
(west)

## Affected versions

v2.5.0

## Patched versions

2.7.0

## Description

### Impact

Looking at the implementation of usb\_dfu.c in Zephyr’s github repository I believe that the implementation is not fully secure.

Tracing code execution path in usb\_device.c usb\_handle\_control\_transfer function when one sends a control transfer read request (bmRequestType direction set to 1, device to host transfer) the wLength size exceeding CONFIG\_USB\_REQUEST\_BUFFER\_SIZE will be permitted (usb\_device.c: 310) and a installed handler will be used to further process the request (usb\_device.c: 332). Next in dfu\_class\_handle\_req (usb\_dfu.c) for bRequest set to DFU\_DNLOAD for both dfuIDLE and dfuDNLOAD\_IDLE states memcopy of wLenght bytes will occur. Since wLength value was provided in the frame and might have a value significantly larger than CONFIG\_USB\_REQUEST\_BUFFER\_SIZE – i.e. 0xffff, data will be copied violating buffer boundaries from both dfu\_data\_worker.buf and \*data perspective. Depending on memory layout and possibility to populate memory past end of data buffer this might allow one to modify memory past dfu\_data\_worker.buf to either corrupt data structures or achieve arbitrary code execution.

Furthermore since the supplies wLength is assigned to dfu\_data\_worker.worker\_len it looks like that the dfu worker will write memory copied past dfu\_data\_worker to flash, effectively leaking information, since one can readout the flash contents (i.e. using UPLOAD command with valid wLength).

Finally back in usb\_device.c. line 344 – wLength bytes of data will be sent to the host. Again this value can be significantly larger then the actual buffer size resulting in readout past buffer boundaries (usb\_dev.data\_buf\_residue was set to MIN(usb\_dev.data\_buf\_len, setup->wLength) which equals to setup->wLength as usb\_dev.data\_buf\_len = setup->wLength in usb\_handle\_control\_transfer, line 341). Looks like a serious memory readout problem.

I might be wrong but a similar issue with readout just as above seems to be lurking also for other commands when issues as reads with a fairly large value of wLength and \*data\_len is not altered by the command handler i.e. DFU\_ABORT, DFU\_CLRSTATUS or DFU\_DETACH. My understanding after reading the code is that again wLength bytes of data will be sent back to the host passing the CONFIG\_USB\_REQUEST\_BUFFER\_SIZE Buffer boundary.

Looking at other device classes like cdc\_acm the cdc\_acm\_class\_handle\_req again seems to permit behavior similar to described above. For requests such as SET\_LINE\_CODING or SET\_CONTROL\_LINE\_STATE the response to host (bmRequestType direction again set to 1) will not update the response length value allowing readout past memory buffer boundaries. So the problem might be a bit more wide-spread than only DFU.

Hope the above description makes sense. I added code snippets with comments below to make the description a bit clearer.

Unfortunately I don’t have the hardware to verify the issue.

In case I’m wrong please provide some explanation why you consider the implementation secure as is so I can better understand the case.

usb\_dfu.c : 455

```
    case DFU_DNLOAD:

           LOG_DBG("DFU_DNLOAD block %d, len %d, state %d",

                   pSetup->wValue, pSetup->wLength, dfu_data.state);

           if (dfu_check_app_state()) {

                   return -EINVAL;

           }

           switch (dfu_data.state) {

           case dfuIDLE:

                   LOG_DBG("DFU_DNLOAD start");

                   dfu_reset_counters();

                   k_poll_signal_reset(&dfu_signal);

                   if (dfu_data.flash_area_id !=

                       UPLOAD_FLASH_AREA_ID) {

                          dfu_data.status = errWRITE;

                          dfu_data.state = dfuERROR;

                          LOG_ERR("This area can not be overwritten");

                          break;

                   }

                   dfu_data.state = dfuDNBUSY;

                   dfu_data_worker.worker_state = dfuIDLE;

                   dfu_data_worker.worker_len  = pSetup->wLength;       // SH: data past buffer bounds will be written to flash

                   memcpy(dfu_data_worker.buf, *data, pSetup->wLength); // SH: memcopy past buffer bound

                   k_work_submit_to_queue(&USB_WORK_Q, &dfu_work);

                   break;

           case dfuDNLOAD_IDLE:

                   dfu_data.state = dfuDNBUSY;

                   dfu_data_worker.worker_state = dfuDNLOAD_IDLE;

                   dfu_data_worker.worker_len  = pSetup->wLength;       // SH: data past buffer bounds will be written to flash

                   memcpy(dfu_data_worker.buf, *data, pSetup->wLength); // SH: memcopy past buffer bound

                   k_work_submit_to_queue(&USB_WORK_Q, &dfu_work);

                   break;

```

usb\_device.c: 282

static void usb\_handle\_control\_transfer(uint8\_t ep,

```
                                                                       enum usb_dc_ep_cb_status_code ep_status)

```

{

```
           uint32_t chunk = 0U;

           struct usb_setup_packet *setup = &usb_dev.setup;

           struct usb_setup_packet_packed setup_raw;

           LOG_DBG(“ep 0x%02x, status 0x%02x”, ep, ep_status);

           if (ep == USB_CONTROL_OUT_EP0 && ep_status == USB_DC_EP_SETUP) {

                          /*

                          * OUT transfer, Setup packet,

                          * reset request message state machine

                          */

                          if (usb_dc_ep_read(ep, (uint8_t *)&setup_raw,

                                                           sizeof(setup_raw), NULL) < 0) {

                                         LOG_DBG(“Read Setup Packet failed”);

                                         usb_dc_ep_set_stall(USB_CONTROL_IN_EP0);

                                         return;

                          }

                          /* Take care of endianness */

                          setup->bmRequestType = setup_raw.bmRequestType;

                          setup->bRequest = setup_raw.bRequest;

                          setup->wValue = sys_le16_to_cpu(setup_raw.wValue);

                          setup->wIndex = sys_le16_to_cpu(setup_raw.wIndex);

                          setup->wLength = sys_le16_to_cpu(setup_raw.wLength);                // SH: wLength is extracted from incoming usb frame

                          if (setup->wLength > CONFIG_USB_REQUEST_BUFFER_SIZE) {

                                         if (REQTYPE_GET_DIR(setup->bmRequestType)

                                             != REQTYPE_DIR_TO_HOST) {                                                 // SH: bmRequestType dir set to TO_HOST to proceed

                                                        LOG_ERR("Request buffer too small");

                                                        usb_dc_ep_set_stall(USB_CONTROL_IN_EP0);

                                                        usb_dc_ep_set_stall(USB_CONTROL_OUT_EP0);

                                                        return;

                                         }

                          }

                          usb_dev.data_buf = usb_dev.req_data;

                          usb_dev.data_buf_residue = setup->wLength;

                          usb_dev.data_buf_len = setup->wLength;

                          usb_dev.zlp_flag = false;

                          if (setup->wLength &&

                              REQTYPE_GET_DIR(setup->bmRequestType)

                              == REQTYPE_DIR_TO_DEVICE) {

                                         return;

                          }

                          /* Ask installed handler to process request */

                          if (!usb_handle_request(setup,

                                                                       &usb_dev.data_buf_len,

                                                                       &usb_dev.data_buf)) {

                                         LOG_DBG("usb_handle_request failed");

                                         usb_dc_ep_set_stall(USB_CONTROL_IN_EP0);

                                         return;

                          }

                          /* Send smallest of requested and offered length */

                          usb_dev.data_buf_residue = MIN(usb_dev.data_buf_len,        // SH: if usb_dev.data_buf_len if not altered in handler (like in DFU_ABORT etc.) both values are the same

                                                                              setup->wLength);

                          /* Send first part (possibly a zero-length status message) */

                          usb_data_to_host(setup->wLength);                                             // SH: wLength > CONFIG_USB_REQUEST_BUFFER_SIZE Will be returned to host leaking memory contents

```
### Patches

This has been fixed in:

* main [#36694](https://github.com/zephyrproject-rtos/zephyr/pull/36694) (2.7.0)
* v1.14: TBD

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [zephyr](https://github.com/zephyrproject-rtos/zephyr/issues/)
* Email us at Zephyr-vulnerabilities

embargo: 2021-09-21

### Severity

Critical

9.6

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Adjacent

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
Low

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:A/AC:L/PR:N/UI:N/S:C/C:L/I:H/A:H

### CVE ID

CVE-2021-3625

### Weaknesses

[CWE-122](/advisories?query=cwe%3A122)

### Credits

* [![@szymonh](https://avatars.githubusercontent.com/u/12231135?s=40&v=4)](/szymonh)
  [szymonh](/szymonh)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


