=== Content from github.com_265d4321_20250115_102628.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzephyrproject-rtos%2Fzephyr%2Fsecurity%2Fadvisories%2FGHSA-89j6-qpxf-pfpc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzephyrproject-rtos%2Fzephyr%2Fsecurity%2Fadvisories%2FGHSA-89j6-qpxf-pfpc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=zephyrproject-rtos%2Fzephyr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zephyrproject-rtos](/zephyrproject-rtos)
/
**[zephyr](/zephyrproject-rtos/zephyr)**
Public

* [Notifications](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr) You must be signed in to change notification settings
* [Fork
  6.8k](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr)
* [Star
   11.2k](/login?return_to=%2Fzephyrproject-rtos%2Fzephyr)

* [Code](/zephyrproject-rtos/zephyr)
* [Issues
  1.9k](/zephyrproject-rtos/zephyr/issues)
* [Pull requests
  881](/zephyrproject-rtos/zephyr/pulls)
* [Discussions](/zephyrproject-rtos/zephyr/discussions)
* [Actions](/zephyrproject-rtos/zephyr/actions)
* [Projects
  20](/zephyrproject-rtos/zephyr/projects)
* [Wiki](/zephyrproject-rtos/zephyr/wiki)
* [Security](/zephyrproject-rtos/zephyr/security)
* [Insights](/zephyrproject-rtos/zephyr/pulse)

Additional navigation options

* [Code](/zephyrproject-rtos/zephyr)
* [Issues](/zephyrproject-rtos/zephyr/issues)
* [Pull requests](/zephyrproject-rtos/zephyr/pulls)
* [Discussions](/zephyrproject-rtos/zephyr/discussions)
* [Actions](/zephyrproject-rtos/zephyr/actions)
* [Projects](/zephyrproject-rtos/zephyr/projects)
* [Wiki](/zephyrproject-rtos/zephyr/wiki)
* [Security](/zephyrproject-rtos/zephyr/security)
* [Insights](/zephyrproject-rtos/zephyr/pulse)

# Integer Underflow in 6LoWPAN IPHC Header Uncompression in Zephyr

High

[d3zd3z](/d3zd3z)
published
GHSA-89j6-qpxf-pfpc
Oct 12, 2021

## Package

zephyr
(west)

## Affected versions

>=2.4.0

## Patched versions

2.5.0

## Description

# 5. Integer Underflow in 6LoWPAN IPHC Header Uncompression

* Bug Description: Missing checks on network packet size in uncompress\_IPHC\_header leads to an integer underflow, resulting in corrupted net\_buf bounds
* Bug Result: The size field of a net\_buf\_simple struct gets underflown, significantly enlarging the assumed size of a network buffer, leading to out-of-bounds accesses in IPv6 functionality.
* Bug Impact: Out-of-bounds accesses inside IPv6 parsing logic. I highly suspect this to be exploitable to Arbitrary Code Execution by an attacker sending IPv6 packets (such as maliciously fragmented ICMPv6 Ping requests).

## Bug Details

* Affected code: Header Uncompression logic in subsys/net/ip/6lo.c#net\_6lo\_uncompress->uncompress\_IPHC\_header.

High-Level reasoning for bug occurrence:

1. A recent fix of a bug which I reported earlier added a check to make sure enough buffer tail space was available and that the right amount of bytes were moved during in-place 6LoWPAN IPHC header compression(

   [zephyr/subsys/net/ip/6lo.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/ip/6lo.c#L1356)

   Line 1356
   in
   [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

   |  | memmove(cursor, frag->data, frag->len - diff); |
   | --- | --- |

   )
2. Fuzzing has shown another bug in the handling of the opposite case where the header cannot be uncompressed into the existing buffer.
3. If not enough space is available in the current buffer, an additional buffer is allocated to hold the uncompressed contents
4. In this external-buffer uncompressed handling, the size of the compressed header is calculated based on the metadata of the initial parts of the payload
5. The expected header of the pre-computed size is then stripped from the original fragment using net\_buf\_pull.
6. It is not checked, however, if the buffer held enough bytes to contain this uncompressed header in the first place
7. As a result, net\_buf\_pull will try to remove more bytes from the buffer than are actually present, which makes the buffer's size go negative, which is a large number as it is later interpreted as an unsigned number.
8. This sets the buffer pointer of the net\_buf\_simple buffer out of bounds, such that out-of-bounds memory is treated as a way too large network buffer

[zephyr/subsys/net/ip/6lo.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/ip/6lo.c#L1366)

Line 1366
in
[d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

|  | net\_buf\_pull(pkt->buffer, compressed\_hdr\_size); |
| --- | --- |

Vulnerable code path:

0. Multiple code paths lead to this IP-layer uncompression logic, including Bluetooth, CAN bus, and IEEE 802.15.4 radio packets. I list a sample code path from ieee802154 packets, which were fuzzed using our research prototype.
1. ieee802154\_recv->ieee802154\_manage\_recv\_packet->ieee802154\_reassemble->fragment\_add\_to\_cache
   * Fragments are added via fragment\_add\_to\_cache, and the full packet eventually reconstructed if all required fragments are present
   * Link:

     [zephyr/subsys/net/l2/ieee802154/ieee802154\_fragment.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/l2/ieee802154/ieee802154_fragment.c#L517)

     Line 517
     in
     [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

     |  | if (fragment\_cached\_pkt\_len(cache->pkt) == cache->size) { |
     | --- | --- |
2. fragment\_add\_to\_cache->net\_6lo\_uncompress
   * After reconstructing the packet data, the compressed IPv6 header needs to be uncompressed
   * Link:

     [zephyr/subsys/net/l2/ieee802154/ieee802154\_fragment.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/l2/ieee802154/ieee802154_fragment.c#L527)

     Line 527
     in
     [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

     |  | if (!net\_6lo\_uncompress(pkt)) { |
     | --- | --- |
3. fragment\_add\_to\_cache->net\_6lo\_uncompress->uncompress\_IPHC\_header->get\_ihpc\_inlined\_size
   * To uncompress the header, first the length is determined from the header's 'iphc' tag
   * Link:

     [zephyr/subsys/net/ip/6lo.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/ip/6lo.c#L1330)

     Line 1330
     in
     [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

     |  | inline\_size = get\_ihpc\_inlined\_size(iphc); |
     | --- | --- |
4. fragment\_add\_to\_cache->net\_6lo\_uncompress->uncompress\_IPHC\_header
   * Without checking the actual size of the incoming packet's buffer, the buffer is trimmed by the size which was computed from the 'iphc' tag
   * Link:

     [zephyr/subsys/net/ip/6lo.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/ip/6lo.c#L1366)

     Line 1366
     in
     [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

     |  | net\_buf\_pull(pkt->buffer, compressed\_hdr\_size); |
     | --- | --- |
5. uncompress\_IPHC\_header->net\_buf\_simple\_pull
   * The network buffer API function net\_buf\_pull will then substract the size, underflowing it in the process
   * Link:

     [zephyr/subsys/net/buf.c](https://github.com/zephyrproject-rtos/zephyr/blob/d969aced6dd9ef7834d21ff8131aa561e71cc42d/subsys/net/buf.c#L1126)

     Line 1126
     in
     [d969ace](/zephyrproject-rtos/zephyr/commit/d969aced6dd9ef7834d21ff8131aa561e71cc42d)

     |  | buf->len -= len; |
     | --- | --- |

## Proposed Fix

* After calculating the size of the expected uncompressed header based on the iphc metadata field, check that enough space is actually present within the buffer.
* Note that the single pkt->buffer fragment may not represent all data within the packet, which may consist of multiple fragments

  + Legitimate parties will probably not send a too small fragment as part of the fragments, so the first fragment not holding the full compressed header could be used as an indication to just drop the packet
  + Otherwise, the logic would have to support stripping the uncompressed header from across multiple network packet fragments/buffers
* If the uncompressed header is expected to be present in the first fragment, the following check could be implemented:

```
diff --git a/subsys/net/ip/6lo.c b/subsys/net/ip/6lo.c
index 736cf05839..f870abf4fc 100644
--- a/subsys/net/ip/6lo.c
+++ b/subsys/net/ip/6lo.c
@@ -1348,6 +1348,12 @@ static bool uncompress_IPHC_header(struct net_pkt *pkt)
                        nhc_inline_size;
        }

+       /* Proposed fix: Make sure the buffer holds the full compressed header */
+       if (compressed_hdr_size > pkt->buffer->len) {
+               NET_ERR("Too small packet to hold compressed IPHC header");
+               return false;
+       }
+
        if (net_buf_tailroom(pkt->buffer) >= diff) {
                NET_DBG("Enough tailroom. Uncompress inplace");
                frag = pkt->buffer;

```
### Patches

This has been fixed in:

* main: [#31971](https://github.com/zephyrproject-rtos/zephyr/pull/31971)
* v1.14: NA

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [zephyr](https://github.com/zephyrproject-rtos/zephyr/issues/)
* Email us at Zephyr-vulnerabilities

embargo: 2021-04-14

zepsec: ZEPSEC-116

### Severity

High

8.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
Low

Integrity
Low

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:L/I:L/A:L

### CVE ID

CVE-2021-3323

### Weaknesses

[CWE-191](/advisories?query=cwe%3A191)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


