=== Content from securitylab.github.com_72ca66c6_20250114_230333.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

May 14, 2021
# GHSL-2021-027: Regular expression Denial of Service in ProtonMail - CVE-2021-32816

[![Author avatar](https://avatars.githubusercontent.com/u/4358136)
Kevin Backhouse](https://github.com/kevinbackhouse)

## Coordinated Disclosure Timeline

* 2021-01-21: Emailed report to contact@protonmail.com.
* 2021-01-21: Received auto-reply email from contact@protonmail.com.
* 2021-02-25: Created an [issue](https://github.com/ProtonMail/WebClient/issues/231)
* 2021-02-25: Response from Serge Droz (Proton-CERT: cert@protonmail.ch). They overlooked the original email, but have now found it and are working on a fix.
* 2021-03-12: Bug is [fixed](https://github.com/ProtonMail/WebClient/commit/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)
* 2021-04-13: I notice the bug fix from 2021-03-12 and email contact@protonmail.com to ask for confirmation that the bug is fixed.
* 2021-04-13: Serge Droz confirms that the bug is fixed.

## Summary

The project contains one or more regular expressions that are vulnerable to [ReDoS](https://en.wikipedia.org/wiki/ReDoS) (Regular Expression Denial of Service)

## Product

ProtonMail

## Tested Version

Latest commit at the time of reporting (January 21, 2021).

## Details

### ReDoS

ReDoS, or Regular Expression Denial of Service, is a vulnerability affecting poorly constructed and potentially inefficient regular expressions which can make them perform extremely badly given a creatively constructed input string.

For the specific regular expression reported, it is possible to force it to work with an `O(2^n)` runtime performance when there is [exponential backtracking](http://en.wikipedia.org/wiki/ReDoS#Exponential_backtracking).

ReDoS can be caused by ambiguity or overlapping between some regex clauses. These badly performing regular expressions can become a security issue if a user can control the input. For example if the project is an input validation library, then the project could be used by a server to validate untrusted user input. There is no one size fits all when it comes to fixing ReDoS. But in general it is about removing ambiguity/overlap inside the regular expression.

Before showing the vulnerable regex, it may be helpful to show some examples of regular expressions vulnerable to ReDoS and how to fix them. If you are familiar with this vulnerability and how to fix it, please skip this section.

---

```
var reg = /<!--(.|\s)*?-->/g;

```

The above regular expression matches the start of an HTML comment, followed by any characters, followed by the end of a HTML comment.
The dot in the regular expression (`.`) matches any char except newlines, and `\s` matches any whitespace.
Both `.` and `\s` matches whitespace such as the space character.
There are therefore many possible ways for this regular expression to match a sequence of spaces.
This becomes a problem if the input is a string that starts with `<!--` followed by a long sequence of spaces, because the regular expression evaluator will try every possible way of matching the spaces
(see this debugging session for an example: https://regex101.com/r/XvYgkN/1/debugger).

The fix is to remove the ambiguity, which can be done by changing the regular expression to the below, where there is no overlap between the different elements of the regular expression.

```
var reg = /<!--(.|\r|\n)*?-->/g;

```

---

```
var reg = /(\w+_?)+_(\d+)/;

```

The above matches a snake\_case identifier that ends with some digits.
However, for a string starting with lots of letters, there many ways for the regular expression to match those letters, due to the regex having a repetition matching letters (`w+`) inside another repetition that can match letters (`(\w+_?)+`).
The regular expression evaluator will try every possible grouping of letters into smaller groups of letters (see this debugging session for an example: https://regex101.com/r/fmci1j/1/debugger).
The fix is again to remove ambiguity, by changing the inner repetition to match groups of letters that must end with an underscore.

```
var reg = /(\w+_)+(\d+)/;

```

---

Often the regular expressions are not as simple as the examples above.
Like the below regular expression [that used to be part of VS Code](https://github.com/microsoft/vscode/pull/109964/files).
(the top regular expression is the vulnerable, the bottom is the fixed)

```
var linkPattern = /(\[((!\[[^\]]*?\]\(\s*)([^\s\(\)]+?)\s*\)\]|(?:\\\]|[^\]])*\])\(\s*)(([^\s\(\)]|\(\S*?\))+)\s*(".*?")?\)/g;
var linkPattern = /(\[((!\[[^\]]*?\]\(\s*)([^\s\(\)]+?)\s*\)\]|(?:\\\]|[^\]])*\])\(\s*)(([^\s\(\)]|\([^\s\(\)]*?\))+)\s*(".*?")?\)/g;

```

But this example is actually very similar to the first example.
A section of the regular expression that was too general (`\S`) was changed to something a bit more specific (`[^\s\(\)]`) to remove overlap with another part of the regular expression.

---

### Vulnerability

ProtonMail is a mail client for handling encrypted emails.
The method for extracting public keys from a message is vulnerable to exponential-redos.

This vulnerability was found using a [CodeQL](https://codeql.github.com/) query which identifies inefficient regular expressions.

For simplicity, the PoC has copy-pasted the relevant regular expressions.

### PoC

* Run the below with `node`.

```
var attackString = "_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_= ;_=";

var reg1 = /^(\s*(_[^;\s]*|addr|prefer-encrypt)\s*=\s*[^;\s]*\s*;)*\s*keydata\s*=([^;]*)$/;
reg1.test(attackString); // <- doesn't terminate

var reg2 = /^(\s*(_[^;\s]*|addr)\s*=\s*[^;\s]*\s*;)*\s*prefer-encrypt\s*=\s*mutual\s*;/;
reg2.test(attackString); // <- doesn't terminate

var reg3 = /^(?:\s*(?:[^;\s]*)\s*=\s*[^;\s]*\s*;)*\s*keydata\s*=([^;]*)$/;
reg3.test(attackString); // <- doesn't terminate

```
### Impact

This issue may lead to a denial of service.

## CVE

* CVE-2021-32816

## Credit

This issue was discovered and reported by GitHub team member [@erik-krogh (Erik Krogh Kristensen)](https://github.com/erik-krogh).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2021-027` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from github.com_764acca2_20250114_230332.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FProtonMail%2FWebClients%2Fcommit%2F6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FProtonMail%2FWebClients%2Fcommit%2F6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ProtonMail%2FWebClients)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ProtonMail](/ProtonMail)
/
**[WebClients](/ProtonMail/WebClients)**
Public

* [Notifications](/login?return_to=%2FProtonMail%2FWebClients) You must be signed in to change notification settings
* [Fork
  583](/login?return_to=%2FProtonMail%2FWebClients)
* [Star
   4.6k](/login?return_to=%2FProtonMail%2FWebClients)

* [Code](/ProtonMail/WebClients)
* [Issues
  69](/ProtonMail/WebClients/issues)
* [Pull requests
  2](/ProtonMail/WebClients/pulls)
* [Security](/ProtonMail/WebClients/security)
* [Insights](/ProtonMail/WebClients/pulse)

Additional navigation options

* [Code](/ProtonMail/WebClients)
* [Issues](/ProtonMail/WebClients/issues)
* [Pull requests](/ProtonMail/WebClients/pulls)
* [Security](/ProtonMail/WebClients/security)
* [Insights](/ProtonMail/WebClients/pulse)

## Commit

[Permalink](/ProtonMail/WebClients/commit/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Improve autocrypt parsing

[Browse files](/ProtonMail/WebClients/tree/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)
Browse the repository at this point in the history

* Loading branch information

[![@mmso](https://avatars.githubusercontent.com/u/352607?s=40&v=4)](/mmso)

[mmso](/ProtonMail/WebClients/commits?author=mmso "View all commits by mmso")
committed
Mar 12, 2021

1 parent
[5ea7404](/ProtonMail/WebClients/commit/5ea74046bb4ddf99900a3a625267f203a5a26fda)

commit 6687fbb

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**127 additions**
and
**36 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/app/message/services

  + src/app/message/services/attachedPublicKey.js
    [attachedPublicKey.js](#diff-7d54c074060cbb1fa2152472e74a31eef66e3d012a700c31dd9deb123fc11764)
  + src/app/message/services/autocryptHelper.js
    [autocryptHelper.js](#diff-9aa5cc81f5861d4df26935e0430a5d0f37afb494ff57e4af2db05912aee10426)
* test/specs/message/services

  + test/specs/message/services/autocryptHelper.spec.js
    [autocryptHelper.spec.js](#diff-e9145561b3bb4d4d830e5f95f9328ab22bad3f99b7bddfb93032a2d7ebe216be)

## There are no files selected for viewing

54 changes: 18 additions & 36 deletions

54
[src/app/message/services/attachedPublicKey.js](#diff-7d54c074060cbb1fa2152472e74a31eef66e3d012a700c31dd9deb123fc11764 "src/app/message/services/attachedPublicKey.js")

Show comments

[View file](/ProtonMail/WebClients/blob/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc/src/app/message/services/attachedPublicKey.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,21 +1,14 @@ |
|  |  | import \_ from 'lodash'; |
|  |  | import vCard from 'vcf'; |
|  |  | import { |
|  |  | arrayToBinaryString, |
|  |  | binaryStringToArray, |
|  |  | decodeBase64, |
|  |  | decryptMessageLegacy, |
|  |  | getFingerprint, |
|  |  | getMatchingKey, |
|  |  | keyInfo |
|  |  | } from 'pmcrypto'; |
|  |  | import { arrayToBinaryString, decryptMessageLegacy, getFingerprint, getMatchingKey, keyInfo } from 'pmcrypto'; |
|  |  |  |
|  |  | import { VERIFICATION\_STATUS, EMAIL\_FORMATING, KEY\_FLAGS, LARGE\_KEY\_SIZE, SEND\_TYPES } from '../../constants'; |
|  |  | import { toList } from '../../../helpers/arrayHelper'; |
|  |  | import { getGroup } from '../../../helpers/vcard'; |
|  |  | import { normalizeEmail } from '../../../helpers/string'; |
|  |  | import { addGetKeys, getKeyAsUri } from '../../../helpers/key'; |
|  |  | import { isInternal, getDate } from '../../../helpers/message'; |
|  |  | import { getParsedAutocryptHeader } from './autocryptHelper'; |
|  |  |  |
|  |  | const { OPEN\_TAG\_AUTOCOMPLETE\_RAW, CLOSE\_TAG\_AUTOCOMPLETE\_RAW } = EMAIL\_FORMATING; |
|  |  | const { SIGNED\_AND\_INVALID } = VERIFICATION\_STATUS; |
| Expand Down  Expand Up | | @@ -138,33 +131,21 @@ function attachedPublicKey( |
|  |  | return publicKey.armor(); |
|  |  | }; |
|  |  |  |
|  |  | const extractPublicKeysFromAutocrypt = (message) => { |
|  |  | const extractPublicKeysFromAutocrypt = async (message, keyParser) => { |
|  |  | if (!\_.has(message.ParsedHeaders, 'Autocrypt')) { |
|  |  | return []; |
|  |  | } |
|  |  | const autocrypt = toList(message.ParsedHeaders.Autocrypt); |
|  |  | return \_.filter( |
|  |  | autocrypt.map((header) => { |
|  |  | const match = header.match( |
|  |  | /^(\s\*(\_[^;\s]\*|addr|prefer-encrypt)\s\*=\s\*[^;\s]\*\s\*;)\*\s\*keydata\s\*=([^;]\*)$/ |
|  |  | ); |
|  |  | if (!match) { |
|  |  | return null; |
|  |  | } |
|  |  | const preferEncryptMutual = header.match( |
|  |  | /^(\s\*(\_[^;\s]\*|addr)\s\*=\s\*[^;\s]\*\s\*;)\*\s\*prefer-encrypt\s\*=\s\*mutual\s\*;/ |
|  |  | ); |
|  |  | if (!preferEncryptMutual) { |
|  |  | return null; |
|  |  | } |
|  |  | const keydata = header.match(/^(?:\s\*(?:[^;\s]\*)\s\*=\s\*[^;\s]\*\s\*;)\*\s\*keydata\s\*=([^;]\*)$/); |
|  |  | try { |
|  |  | return binaryStringToArray(decodeBase64(keydata[1])); |
|  |  | } catch (e) { |
|  |  | // not encoded correctly |
|  |  | return null; |
|  |  | } |
|  |  | }) |
|  |  | await Promise.all( |
|  |  | autocrypt.map(async (header) => { |
|  |  | const result = getParsedAutocryptHeader(header, message.Sender.Address); |
|  |  | if (!result) { |
|  |  | return; |
|  |  | } |
|  |  | return keyParser(result.keydata); |
|  |  | }) |
|  |  | ) |
|  |  | ); |
|  |  | }; |
|  |  |  |
| Expand Down  Expand Up | | @@ -229,21 +210,21 @@ function attachedPublicKey( |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | const isKey = (key) => |
|  |  | keyInfo(key).catch(() => { |
|  |  | const keyParser = (key) => { |
|  |  | return keyInfo(key).catch(() => { |
|  |  | return false; |
|  |  | }); |
|  |  | }; |
|  |  |  |
|  |  | const buffers = ( |
|  |  | await Promise.all(candidates.map((c) => AttachmentLoader.get(c, message).catch(() => false))) |
|  |  | ).filter(Boolean); |
|  |  | const armoredFiles = buffers.map(arrayToBinaryString); |
|  |  | const keyInfos = \_.filter(await Promise.all(armoredFiles.map(isKey))); |
|  |  | const keyInfos = \_.filter(await Promise.all(armoredFiles.map(keyParser))); |
|  |  |  |
|  |  | if (keyInfos.length === 0) { |
|  |  | // try to get them from the autocrypt headers |
|  |  | const autocryptdata = extractPublicKeysFromAutocrypt(message); |
|  |  | keyInfos.push(...\_.filter(await Promise.all(autocryptdata.map(isKey)))); |
|  |  | keyInfos.push(...(await extractPublicKeysFromAutocrypt(message, keyParser))); |
|  |  | } |
|  |  |  |
|  |  | const keyInfoObject = await getMatchingKeyInfo(keyInfos, message); |
| Expand Down  Expand Up | | @@ -343,4 +324,5 @@ function attachedPublicKey( |
|  |  | attachPublicKey |
|  |  | }; |
|  |  | } |
|  |  |  |
|  |  | export default attachedPublicKey; |

62 changes: 62 additions & 0 deletions

62
[src/app/message/services/autocryptHelper.js](#diff-9aa5cc81f5861d4df26935e0430a5d0f37afb494ff57e4af2db05912aee10426 "src/app/message/services/autocryptHelper.js")

Show comments

[View file](/ProtonMail/WebClients/blob/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc/src/app/message/services/autocryptHelper.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,62 @@ |
|  |  | import { binaryStringToArray, decodeBase64 } from 'pmcrypto'; |
|  |  |  |
|  |  | const MANDATORY\_FIELDS = ['keydata', 'addr']; |
|  |  | const OPTIONAL\_FIELDS = ['prefer-encrypt']; |
|  |  | const CRITICAL\_FIELDS = OPTIONAL\_FIELDS.concat(MANDATORY\_FIELDS); |
|  |  |  |
|  |  | // Parse according to https://autocrypt.org/level1.html#the-autocrypt-header |
|  |  | export const getParsedAutocryptHeader = (header = '', sender = '') => { |
|  |  | let invalid = false; |
|  |  |  |
|  |  | const result = Object.fromEntries( |
|  |  | header |
|  |  | .split(';') |
|  |  | .map((keyValue) => { |
|  |  | const trimmedKeyValue = keyValue.trim(); |
|  |  |  |
|  |  | // For ease of parsing, the keydata attribute MUST be the last attribute in this header. Avoid splitting by = since it's base64 |
|  |  | if (trimmedKeyValue.startsWith('keydata=')) { |
|  |  | try { |
|  |  | const keydataStringValue = trimmedKeyValue.slice('keydata='.length); |
|  |  | const keydataValue = binaryStringToArray(decodeBase64(keydataStringValue)); |
|  |  | return ['keydata', keydataValue]; |
|  |  | } catch (e) { |
|  |  | return ['', '']; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | const [parsedKey = '', parsedValue = ''] = keyValue.split('='); |
|  |  |  |
|  |  | const key = parsedKey.trim(); |
|  |  |  |
|  |  | // It MUST treat the entire Autocrypt header as invalid if it encounters a “critical” attribute that it doesn’t support. |
|  |  | if (!CRITICAL\_FIELDS.includes(key) && !key.startsWith('\_')) { |
|  |  | invalid = true; |
|  |  | return ['', '']; |
|  |  | } |
|  |  |  |
|  |  | return [key, parsedValue.trim()]; |
|  |  | }) |
|  |  | .filter(([key, value]) => { |
|  |  | return key && value; |
|  |  | }) |
|  |  | ); |
|  |  |  |
|  |  | // The mandatory fields must be present. |
|  |  | if (MANDATORY\_FIELDS.some((field) => !result[field]) || invalid) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // If addr differs from the addr in the From header, the entire Autocrypt header MUST be treated as invalid. |
|  |  | if (result.addr.toLowerCase() !== sender.toLowerCase()) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // The prefer-encrypt attribute is optional and can only occur with the value mutual. |
|  |  | // Its presence in the Autocrypt header indicates an agreement to enable encryption by default. |
|  |  | if (result['prefer-encrypt'] !== 'mutual') { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | return result; |
|  |  | }; |

47 changes: 47 additions & 0 deletions

47
[test/specs/message/services/autocryptHelper.spec.js](#diff-e9145561b3bb4d4d830e5f95f9328ab22bad3f99b7bddfb93032a2d7ebe216be "test/specs/message/services/autocryptHelper.spec.js")

Show comments

[View file](/ProtonMail/WebClients/blob/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc/test/specs/message/services/autocryptHelper.spec.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,47 @@ |
|  |  | import { getParsedAutocryptHeader } from '../../../../src/app/message/services/autocryptHelper'; |
|  |  |  |
|  |  | const validKeyData = { |
|  |  | base64: ` xjMEYAffqRYJKwYBBAHaRw8BAQdAFKaMT9wf5w6gMeW6X+6CSKCwTw5ohqESZQXzNfHG+CrN FDxwcm90b25xYUB5YWhvby5jb20+wncEEBYKAB8FAmAH36kGCwkHCAMCBBUICgIDFgIBAhkB AhsDAh4BAAoJEHhS0KVKBiDsdGgBAMzShBIHmMcpfR9wfXQdJZJBsO/3NTqJfpR6lQM7b0Yh AQDmVdb5v9XofabzXILvXFCsY6G8m2enwfCZw00YK/C0Dc44BGAH36kSCisGAQQBl1UBBQEB B0CnB3qq73mdvkEfyixD+hAk3+5vW/Gg5rZaPoV0gixGOwMBCAfCYQQYFggACQUCYAffqQIb DAAKCRB4UtClSgYg7On/AQDAh4kb5SvbWpxvAj2XJjSD3VnoTq4mXiYVX+5porb2XgEAijZr EgjyGGjkRTwRZ7+ufgn+Qfvk/6+uc7/3efwlngA=`, |
|  |  | uint8array: new Uint8Array([198, 51, 4, 96, 7, 223, 169, 22, 9, 43, 6, 1, 4, 1, 218, 71, 15, 1, 1, 7, 64, 20, 166, 140, 79, 220, 31, 231, 14, 160, 49, 229, 186, 95, 238, 130, 72, 160, 176, 79, 14, 104, 134, 161, 18, 101, 5, 243, 53, 241, 198, 248, 42, 205, 20, 60, 112, 114, 111, 116, 111, 110, 113, 97, 64, 121, 97, 104, 111, 111, 46, 99, 111, 109, 62, 194, 119, 4, 16, 22, 10, 0, 31, 5, 2, 96, 7, 223, 169, 6, 11, 9, 7, 8, 3, 2, 4, 21, 8, 10, 2, 3, 22, 2, 1, 2, 25, 1, 2, 27, 3, 2, 30, 1, 0, 10, 9, 16, 120, 82, 208, 165, 74, 6, 32, 236, 116, 104, 1, 0, 204, 210, 132, 18, 7, 152, 199, 41, 125, 31, 112, 125, 116, 29, 37, 146, 65, 176, 239, 247, 53, 58, 137, 126, 148, 122, 149, 3, 59, 111, 70, 33, 1, 0, 230, 85, 214, 249, 191, 213, 232, 125, 166, 243, 92, 130, 239, 92, 80, 172, 99, 161, 188, 155, 103, 167, 193, 240, 153, 195, 77, 24, 43, 240, 180, 13, 206, 56, 4, 96, 7, 223, 169, 18, 10, 43, 6, 1, 4, 1, 151, 85, 1, 5, 1, 1, 7, 64, 167, 7, 122, 170, 239, 121, 157, 190, 65, 31, 202, 44, 67, 250, 16, 36, 223, 238, 111, 91, 241, 160, 230, 182, 90, 62, 133, 116, 130, 44, 70, 59, 3, 1, 8, 7, 194, 97, 4, 24, 22, 8, 0, 9, 5, 2, 96, 7, 223, 169, 2, 27, 12, 0, 10, 9, 16, 120, 82, 208, 165, 74, 6, 32, 236, 233, 255, 1, 0, 192, 135, 137, 27, 229, 43, 219, 90, 156, 111, 2, 61, 151, 38, 52, 131, 221, 89, 232, 78, 174, 38, 94, 38, 21, 95, 238, 105, 162, 182, 246, 94, 1, 0, 138, 54, 107, 18, 8, 242, 24, 104, 228, 69, 60, 17, 103, 191, 174, 126, 9, 254, 65, 251, 228, 255, 175, 174, 115, 191, 247, 121, 252, 37, 158, 0]) |
|  |  | }; |
|  |  |  |
|  |  | describe('autocrypt helper', () => { |
|  |  | it('should parse a valid string', () => { |
|  |  | const result = `addr=test@yahoo.com; prefer-encrypt=mutual; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual({ |
|  |  | addr: 'test@yahoo.com', |
|  |  | 'prefer-encrypt': 'mutual', |
|  |  | keydata: validKeyData.uint8array |
|  |  | }); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse a valid string that does not contain prefer-encrypt', () => { |
|  |  | const result = `addr=test@yahoo.com; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse a valid string that contains an invalid prefer-encrypt', () => { |
|  |  | const result = `addr=test@yahoo.com; \_other=test; prefer-encrypt=none; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse an invalid string that contains critical unknown attributes', () => { |
|  |  | const result = `addr=test@yahoo.com; other=test; prefer-encrypt=mutual; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse an invalid string that does not contain addr', () => { |
|  |  | const result = `other=test; prefer-encrypt=mutual; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse an invalid string', () => { |
|  |  | const result = `addr=test@yahoo.com; prefer-encrypt=none; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  |  |
|  |  | it('should not parse an unknown sender', () => { |
|  |  | const result = `addr=unknown@yahoo.com; prefer-encrypt=none; keydata=${validKeyData.base64}`; |
|  |  | expect(getParsedAutocryptHeader(result, 'test@yahoo.com')).toEqual(undefined); |
|  |  | }); |
|  |  | }); |

Toggle all file notes
Toggle all file annotations

### 2 comments on commit `6687fbb`

[![@Hanna4156](https://avatars.githubusercontent.com/u/83871430?s=80&v=4)](/Hanna4156)

Copy link

### @Hanna4156 **[Hanna4156](/Hanna4156)** commented on `[6687fbb](/ProtonMail/WebClients/commit/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)` [May 14, 2021](#commitcomment-50835881)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

src/app/message/services/attachedPublicKey.js

Sorry, something went wrong.

All reactions

[![@Hanna4156](https://avatars.githubusercontent.com/u/83871430?s=80&v=4)](/Hanna4156)

Copy link

### @Hanna4156 **[Hanna4156](/Hanna4156)** commented on `[6687fbb](/ProtonMail/WebClients/commit/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)` [May 14, 2021](#commitcomment-50835895)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[6687fbb](https://github.com/ProtonMail/WebClients/commit/6687fbb867ef872c96cf4fde68cb6e9c58d3fddc)

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FProtonMail%2FWebClients%2Fcommit%2F6687fbb867ef872c96cf4fde68cb6e9c58d3fddc) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


