```
{
  "vulnerability": "CVE-2021-32102",
  "information": [
    {
      "source": "community.open-emr.org_1992ba79_20250114_181936.html",
      "content": "OpenEMR 5.0.2 Patch 5 has been released.\n\nThis patch includes a security fix (since this vulnerability was made public recently, decided to get out a quick patch) : Security fix - reported by Dennis Brinkrolf (RIPS Technologies) and fixed by Brady Miller"
    },
    {
      "source": "portswigger.net_21fa9588_20250114_181937.html",
      "content": "Healthcare security: OpenEMR fixes serious flaws that lead to command execution in patient portal.\n\nSecurity researchers achieved unauthenticated command execution on OpenEMR servers thanks to a stored cross-site scripting (XSS) flaw in the open source platform’s Patient Portal, itself unauthenticated courtesy of insecure permissions in the API.\n\nOther, lower privileged user sessions can be misused to exploit an SQL injection vulnerability also found by the researchers and steal patient data from the database.\n\nThe command injection flaw was found in a feature for creating data backups.\n\nThe malicious payload ?form_sel_layouts[]=`touch sonarsource.txt;` resulted in backtick characters materializing in the shell command: echo \"DELETE FROM layout\_options WHERE form\_id = '`touch sonarsource.txt;`';\" >> /tmp/export;\n\nThe problem here is that the echo shell command uses double quotes and thus allows [attackers] to execute sub commands in Linux by using characters like backticks `` or $().\n\nInsecure API permissions surfaced during the new user registration process. Because the session variable is not destroyed at the end of the file an attacker could make the first HTTP request to register.php which creates a session and sets the session variable $_SESSION['register'] to true. Then, without completing the registration, the attacker can access the dispatcher and bypass the authentication because $ignoreAuth is set to true.\n\nThe four security flaws were found in OpenEMR 5.0.2.1."
    },
    {
      "source": "www.open-emr.org_01278b18_20250114_181939.html",
      "content": "5.0.2 Patch (11/4/20)\n\nSecurity fix - reported by Dennis Brinkrolf (RIPS Technologies) and fixed by Brady Miller"
    },
    {
      "source": "community.sonarsource.com_3e0d047d_20250114_181936.html",
        "content": "During our security research of popular web applications, we discovered several critical code vulnerabilities in OpenEMR 5.0.2.1:\n\n*   Command Injection (admin privileges)\n*   Persistent XSS (admin privileges)\n*   Insecure API permissions (unauthenticated)\n*   SQL Injection (user privileges)\n\nA combination of these vulnerabilities allowed remote attackers to execute arbitrary system commands on any OpenEMR server that uses the Patient Portal component. This can lead to the compromise of sensitive patient data, or worse, to a compromise of critical infrastructure."
    },
        {
      "source": "blog.sonarsource.com_e87aea8d_20250114_181935.html",
      "content": "During our security research of popular web applications, we discovered several code vulnerabilities in OpenEMR 5.0.2.1. A combination of these vulnerabilities allowed remote attackers to execute arbitrary system commands on any OpenEMR server that uses the Patient Portal component. This can lead to the compromise of sensitive patient data, or worse, to a compromise of critical infrastructure.\n\nIn this blog post we analyze the technical root cause of three vulnerabilities and demonstrate how attackers could have built a chain for exploitation.\n\nDuring the analysis of OpenEMR 5.0.2.1 we found the following code vulnerabilities:\n\n1.  Command Injection (admin privileges) (CVE-2020-36243)\n2.  Persistent XSS (admin privileges) (CVE-2021-32103)\n3.  Insecure API permissions (unauthenticated) (CVE-2021-32101)\n4.  SQL Injection (user privileges) (CVE-2021-32102, CVE-2021-32104)\n\nThe vulnerabilities impact OpenEMR's Patient Portal that needs to be active and accessible for online patients. A remote attacker can then insert a malicious JavaScript payload (XSS) into any user account. This works even when the portal's registration feature for new users is disabled.\n\nDepending on the privilege role of the victim, further vulnerabilities in the backend can be exploited when a victim’s browser executes the XSS payload unconsciously. For example, if the victim is an administrator, the attacker can take over the entire server via a Command Injection vulnerability that allows to execute OS system commands. Other, lower privileged user sessions can be misused to exploit SQL injection vulnerabilities that enable to steal patient data from the database.\n\n### 1. Command Injection Vulnerability (CVE-2020-36243)\nThe most critical vulnerability hides in the backend of OpenEMR. Here, administrators can use a feature to create data backups. For this purpose, different SQL queries are constructed dynamically that are later executed as system commands when creating the backup file.\n\nAn attacker can send the following payload: ?form_sel_layouts[]=`touch sonarsource.txt;`\n\nNote the backtick characters ` in our payload. This would end up in the shell command like this:\necho \"DELETE FROM layout\_options WHERE form\_id = '`touch sonarsource.txt;`';\"  >> /tmp/export;\n\nThe problem here is that the echo shell command uses double quotes and thus allows to execute sub commands in Linux by using characters like backticks ` or $(). Once our backticks are found within the system command, our new, injected command is executed and the output result is inserted into the initial command. From here, an attacker can fully compromise the system and read sensitive data.\n\n### 2. Persistent Cross-Site Scripting Vulnerability (CVE-2021-32103)\nThe attacker’s payload is hidden within the last name of a user account. This last name can be changed in line 4 of the following code. Note that this action can only be performed by an administrator (we will come back to this in the next section).\n\nHere, in line 6, the user name is embedded into the HTML output without any sanitization. This allows injection of malicious HTML code into the response page that will be rendered by the administrator’s browser. When <script> tags are injected into the last name, then malicious JavaScript code can be executed that will be able to control the victim's browser and its further activities. For example, it can be used to trigger the previously introduced Command Injection vulnerability that only an administrator can execute (Cross-Site Scripting).\n\n### 3. Insecure API Permissions (CVE-2021-32101)\nIn OpenEMR, the Patient Portal has its own API interface to control all portal actions, for example for editing a user account. This API uses the Phreeze framework as a dispatcher that forwards requests to the respective component.\n\nIt creates a new session and checks in line 4 if the user is already on the portal page or whether she is currently trying to register. In this case, the authentication check is deactivated in line 6 (`$ignoreAuth = true`). Otherwise, the authentication check is active and the user has to authenticate.\n\nAn attacker could therefore make the first HTTP request to register.php which creates a session and sets the session variable $_SESSION['register'] to true. Then, without completing the registration, the attacker can access the dispatcher and bypass the authentication because $ignoreAuth is set to true.\n\nOnce the authentication is bypassed, it is possible to use all features of the API as a registered Patient Portal user. This means an attacker can access all patient data or change the email address and passwords of the patients even if registration to the Patient Portal is closed. Of special interest is the user controller of the API which can be used to change information of any backend user like the administrator. The attacker can now take advantage of the previously introduced Persistent XSS vulnerability by adding an XSS payload to the last name of the admin user. This XSS payload can then execute JavaScript code that exploits the Command Injection vulnerability."
    }
  ],
  "summary": "The provided documents describe multiple vulnerabilities in OpenEMR 5.0.2.1, specifically related to command injection, persistent XSS, insecure API permissions, and SQL injection. The identified SQL injection vulnerability (CVE-2021-32102) allows attackers to potentially steal patient data from the database using lower privileged user sessions.",
  "vulnerability_details": {
    "root_cause": "The vulnerability exists due to insufficient input sanitization and the use of double quotes within an `echo` shell command. This allows attackers to execute subcommands using backticks or $() within the command string.",
    "weaknesses": [
      "Insufficient input sanitization.",
      "Use of double quotes in shell commands allowing command injection.",
       "Insecure API permissions",
      "SQL injection vulnerabilities"
    ],
    "impact": "Successful exploitation could lead to data theft of sensitive patient information and potential compromise of critical infrastructure. Attackers could also gain arbitrary command execution on the server.",
    "attack_vectors": [
      "Malicious payload injected into a form field (form_sel_layouts) during backup process.",
      "Exploitation of SQL injection vulnerability.",
        "Bypassing API authentication and planting XSS payload."
    ],
    "attacker_capabilities": "The attacker needs to be able to make web requests to OpenEMR, as well as potentially manipulate HTTP POST parameters. The combination of vulnerabilities allows an attacker to achieve pre-auth command execution when targeting an admin user using XSS and Insecure API permissions.",
    "required_attacker_position": "The attacker can be remote, and does not require prior authentication to trigger the chain of exploits. For directly exploiting the SQLi, attacker needs valid user sessions."
  }
}
```