=== Content from github.com_3e541704_20250114_202835.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fpull%2F2642)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fpull%2F2642)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fpull_requests%2Fshow&source=header-repo&source_repo=hapifhir%2Fhapi-fhir)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[hapifhir](/hapifhir)
/
**[hapi-fhir](/hapifhir/hapi-fhir)**
Public

* [Notifications](/login?return_to=%2Fhapifhir%2Fhapi-fhir) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fhapifhir%2Fhapi-fhir)
* [Star
   2.1k](/login?return_to=%2Fhapifhir%2Fhapi-fhir)

* [Code](/hapifhir/hapi-fhir)
* [Issues
  925](/hapifhir/hapi-fhir/issues)
* [Pull requests
  228](/hapifhir/hapi-fhir/pulls)
* [Actions](/hapifhir/hapi-fhir/actions)
* [Projects
  0](/hapifhir/hapi-fhir/projects)
* [Wiki](/hapifhir/hapi-fhir/wiki)
* [Security](/hapifhir/hapi-fhir/security)
* [Insights](/hapifhir/hapi-fhir/pulse)

Additional navigation options

* [Code](/hapifhir/hapi-fhir)
* [Issues](/hapifhir/hapi-fhir/issues)
* [Pull requests](/hapifhir/hapi-fhir/pulls)
* [Actions](/hapifhir/hapi-fhir/actions)
* [Projects](/hapifhir/hapi-fhir/projects)
* [Wiki](/hapifhir/hapi-fhir/wiki)
* [Security](/hapifhir/hapi-fhir/security)
* [Insights](/hapifhir/hapi-fhir/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fhapifhir%2Fhapi-fhir%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fhapifhir%2Fhapi-fhir%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Resolve weakness in history operation #2642

 Merged

[jamesagnew](/jamesagnew)
merged 9 commits into
[master](/hapifhir/hapi-fhir/tree/master "hapifhir/hapi-fhir:master")
from
[ja\_20210505\_history\_dos](/hapifhir/hapi-fhir/tree/ja_20210505_history_dos "hapifhir/hapi-fhir:ja_20210505_history_dos")

May 7, 2021

 Merged

# [Resolve weakness in history operation](#top) #2642

[jamesagnew](/jamesagnew)
merged 9 commits into
[master](/hapifhir/hapi-fhir/tree/master "hapifhir/hapi-fhir:master")
from
[ja\_20210505\_history\_dos](/hapifhir/hapi-fhir/tree/ja_20210505_history_dos "hapifhir/hapi-fhir:ja_20210505_history_dos")

May 7, 2021

[Conversation
13](/hapifhir/hapi-fhir/pull/2642)
[Commits
9](/hapifhir/hapi-fhir/pull/2642/commits)
[Checks
0](/hapifhir/hapi-fhir/pull/2642/checks)
[Files changed](/hapifhir/hapi-fhir/pull/2642/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=60&v=4)](/jamesagnew)

Copy link

Collaborator

### @jamesagnew **[jamesagnew](/jamesagnew)** commented [May 6, 2021](#issue-877561492)

Fix [#2641](https://github.com/hapifhir/hapi-fhir/issues/2641)

Sorry, something went wrong.

All reactions

 [jamesagnew](/jamesagnew)
added 5 commits
[May 5, 2021 17:04](#commits-pushed-a5e4f56)

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Address DOS issue in History operation](/hapifhir/hapi-fhir/pull/2642/commits/a5e4f56e1c6f55093ff334cf698ffdeea2f33960 "Address DOS issue in History operation")`

`[a5e4f56](/hapifhir/hapi-fhir/pull/2642/commits/a5e4f56e1c6f55093ff334cf698ffdeea2f33960)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Work on history caching](/hapifhir/hapi-fhir/pull/2642/commits/f2934b229c491235ab0e7782dea86b324521082a "Work on history caching")`

`[f2934b2](/hapifhir/hapi-fhir/pull/2642/commits/f2934b229c491235ab0e7782dea86b324521082a)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Add docs](/hapifhir/hapi-fhir/pull/2642/commits/708e1177d5df7911155391a0a170087cfbca93cf "Add docs")`

`[708e117](/hapifhir/hapi-fhir/pull/2642/commits/708e1177d5df7911155391a0a170087cfbca93cf)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Add changelog](/hapifhir/hapi-fhir/pull/2642/commits/d4ef17516f502242e224df80e17acdd6370a8f27 "Add changelog")`

`[d4ef175](/hapifhir/hapi-fhir/pull/2642/commits/d4ef17516f502242e224df80e17acdd6370a8f27)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Merge branch 'master' into ja_20210505_history_dos](/hapifhir/hapi-fhir/pull/2642/commits/5449bc6a85761b61ec057edf2b79282b8d4ced64 "Merge branch 'master' into ja_20210505_history_dos")`

`[5449bc6](/hapifhir/hapi-fhir/pull/2642/commits/5449bc6a85761b61ec057edf2b79282b8d4ced64)`

[![michaelabuckley](https://avatars.githubusercontent.com/u/10764269?s=60&v=4)](/michaelabuckley)

**[michaelabuckley](/michaelabuckley)**
approved these changes
[May 6, 2021](#pullrequestreview-653611710)

 [View reviewed changes](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64)

Copy link

Contributor

### @michaelabuckley **[michaelabuckley](/michaelabuckley)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Approved. Minor complaints in the tests.

Sorry, something went wrong.

All reactions

[hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/JpaHistoryR4Test.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-0f89ec277b006c8dea9bc1b0a0836c8cfcfb490f12020b75cf66fa04f6454758)
Outdated

Show resolved

Hide resolved

[hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/JpaHistoryR4Test.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-0f89ec277b006c8dea9bc1b0a0836c8cfcfb490f12020b75cf66fa04f6454758)

Show resolved

Hide resolved

[hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/JpaHistoryR4Test.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-0f89ec277b006c8dea9bc1b0a0836c8cfcfb490f12020b75cf66fa04f6454758)

|  |  | assertEquals(0, myCaptureQueriesListener.countDeleteQueries()); |
| --- | --- | --- |
|  |  | assertEquals(0, myCaptureQueriesListener.countInsertQueries()); |
|  |  | assertEquals(0, myCaptureQueriesListener.countUpdateQueries()); |
|  |  | assertEquals(2, myCaptureQueriesListener.countSelectQueries()); |

Copy link

Contributor

### @michaelabuckley **[michaelabuckley](/michaelabuckley)** [May 6, 2021](#discussion_r627542351)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Same here. Some day it will change, and someone-not-you might have to figure out why 2 is now 3.

Sorry, something went wrong.

All reactions

[hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/JpaHistoryR4Test.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-0f89ec277b006c8dea9bc1b0a0836c8cfcfb490f12020b75cf66fa04f6454758)

Show resolved

Hide resolved

[hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-d37f5270dae5ceb51a0d16852a200b58b31dc45d88ddf553e18bcf6c7028794a)
Outdated

Show resolved

Hide resolved

[hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/search/PersistedJpaBundleProvider.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-a88b79655b16ce70639338f8dbf9d4ad3b89baacc083ff556a3ef54383a6c6eb)

Show resolved

Hide resolved

[hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/JpaHistoryR4Test.java](/hapifhir/hapi-fhir/pull/2642/files/5449bc6a85761b61ec057edf2b79282b8d4ced64#diff-0f89ec277b006c8dea9bc1b0a0836c8cfcfb490f12020b75cf66fa04f6454758)

Show resolved

Hide resolved

 [jamesagnew](/jamesagnew)
added 4 commits
[May 6, 2021 15:01](#commits-pushed-b53ae23)

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Resolve test failures](/hapifhir/hapi-fhir/pull/2642/commits/b53ae23e6fb8fdb6017aa9e8c688c49a4d91e9f4 "Resolve test failures")`

`[b53ae23](/hapifhir/hapi-fhir/pull/2642/commits/b53ae23e6fb8fdb6017aa9e8c688c49a4d91e9f4)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Test fixes](/hapifhir/hapi-fhir/pull/2642/commits/5dd969aef2c7b552e61dadbabb1d06e8a2d82524 "Test fixes")`

`[5dd969a](/hapifhir/hapi-fhir/pull/2642/commits/5dd969aef2c7b552e61dadbabb1d06e8a2d82524)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Test fix](/hapifhir/hapi-fhir/pull/2642/commits/bcc4d7f3da26a9583a4180b544e93110cfff5dac "Test fix")`

`[bcc4d7f](/hapifhir/hapi-fhir/pull/2642/commits/bcc4d7f3da26a9583a4180b544e93110cfff5dac)`

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&v=4)](/jamesagnew)

`[Test fixes](/hapifhir/hapi-fhir/pull/2642/commits/fb0e229ec65bee722c908c1e0f60471e0a3528e7 "Test fixes")`

`[fb0e229](/hapifhir/hapi-fhir/pull/2642/commits/fb0e229ec65bee722c908c1e0f60471e0a3528e7)`

[![@codecov](https://avatars.githubusercontent.com/in/254?s=80&v=4)](/apps/codecov)

Copy link

### **[codecov](/apps/codecov) bot** commented [May 7, 2021](#issuecomment-834562298)

|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir) Report Merging [#2642](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir) ([fb0e229](https://github.com/hapifhir/hapi-fhir/commit/fb0e229ec65bee722c908c1e0f60471e0a3528e7)) into [master](https://codecov.io/gh/hapifhir/hapi-fhir/commit/64564d5f1e5347553af7ae2c8a37e6c977495f61?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir) ([64564d5](https://github.com/hapifhir/hapi-fhir/commit/64564d5f1e5347553af7ae2c8a37e6c977495f61)) will **increase** coverage by `0.01%`. The diff coverage is `94.52%`.  [Impacted file tree graph](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir)  ``` @@             Coverage Diff              @@ ##             master    #2642      +/-   ## ============================================ + Coverage     82.47%   82.49%   +0.01%      - Complexity    18862    18879      +17      ============================================   Files          1273     1274       +1        Lines         67767    67814      +47        Branches      10352    10360       +8      ============================================ + Hits          55894    55940      +46      + Misses         7875     7874       -1      - Partials       3998     4000       +2      ```  | [Impacted Files](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir) | Coverage Δ | Complexity Δ |  | | --- | --- | --- | --- | | [.../java/ca/uhn/fhir/jpa/util/MemoryCacheService.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1iYXNlL3NyYy9tYWluL2phdmEvY2EvdWhuL2ZoaXIvanBhL3V0aWwvTWVtb3J5Q2FjaGVTZXJ2aWNlLmphdmE=) | `87.67% <86.20%> (-3.24%)` | `10.00 <0.00> (ø)` |  | | [...ain/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1hcGkvc3JjL21haW4vamF2YS9jYS91aG4vZmhpci9qcGEvYXBpL2NvbmZpZy9EYW9Db25maWcuamF2YQ==) | `92.56% <100.00%> (+0.15%)` | `126.00 <7.00> (+2.00)` |  | | [...a/uhn/fhir/jpa/api/model/HistoryCountModeEnum.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1hcGkvc3JjL21haW4vamF2YS9jYS91aG4vZmhpci9qcGEvYXBpL21vZGVsL0hpc3RvcnlDb3VudE1vZGVFbnVtLmphdmE=) | `100.00% <100.00%> (ø)` | `1.00 <1.00> (?)` |  | | [...hn/fhir/jpa/search/PersistedJpaBundleProvider.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1iYXNlL3NyYy9tYWluL2phdmEvY2EvdWhuL2ZoaXIvanBhL3NlYXJjaC9QZXJzaXN0ZWRKcGFCdW5kbGVQcm92aWRlci5qYXZh) | `90.78% <100.00%> (+2.68%)` | `50.00 <10.00> (+10.00)` |  | | [.../jpa/util/CircularQueueCaptureQueriesListener.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1iYXNlL3NyYy9tYWluL2phdmEvY2EvdWhuL2ZoaXIvanBhL3V0aWwvQ2lyY3VsYXJRdWV1ZUNhcHR1cmVRdWVyaWVzTGlzdGVuZXIuamF2YQ==) | `93.33% <100.00%> (+0.20%)` | `48.00 <5.00> (+3.00)` |  | | [.../main/java/ca/uhn/fhir/jpa/dao/HistoryBuilder.java](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir#diff-aGFwaS1maGlyLWpwYXNlcnZlci1iYXNlL3NyYy9tYWluL2phdmEvY2EvdWhuL2ZoaXIvanBhL2Rhby9IaXN0b3J5QnVpbGRlci5qYXZh) | `100.00% <0.00%> (+1.51%)` | `20.00% <0.00%> (+1.00%)` |  |   ---   [Continue to review full report at Codecov](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir).  **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir) `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` Powered by [Codecov](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir). Last update [64564d5...fb0e229](https://codecov.io/gh/hapifhir/hapi-fhir/pull/2642?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=hapifhir). |

All reactions

Sorry, something went wrong.

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&u=e0764f4bf89c5ea416df81bbca45f9995bc89bf5&v=4)](/jamesagnew)
[jamesagnew](/jamesagnew)
merged commit [`5a9f499`](/hapifhir/hapi-fhir/commit/5a9f499fbf60cdcb4320b5774433ca6bc96cdfc5)
into
master

[May 7, 2021](https://github.com/hapifhir/hapi-fhir/pull/2642#event-4703085267)

 [![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&u=e0764f4bf89c5ea416df81bbca45f9995bc89bf5&v=4)](/jamesagnew)
[jamesagnew](/jamesagnew)
deleted the
ja\_20210505\_history\_dos

branch
[May 7, 2021 16:05](#event-4703085341)

[![@BSVogler](https://avatars.githubusercontent.com/u/801818?s=40&v=4)](/BSVogler)
[BSVogler](/BSVogler)
mentioned this pull request
[Feb 9, 2022](#ref-issue-1128779599)

[\_history does not contain all elements after immediate request
#3369](/hapifhir/hapi-fhir/issues/3369)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fpull%2F2642)

Reviewers

[![@michaelabuckley](https://avatars.githubusercontent.com/u/10764269?s=40&v=4)](/michaelabuckley) [michaelabuckley](/michaelabuckley)

michaelabuckley approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [Potential Denial of Service in JPA Server via history operation](https://github.com/hapifhir/hapi-fhir/issues/2641)

2 participants

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=52&v=4)](/jamesagnew) [![@michaelabuckley](https://avatars.githubusercontent.com/u/10764269?s=52&v=4)](/michaelabuckley)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e29c1595_20250114_202832.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fissues%2F2641)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fissues%2F2641)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=hapifhir%2Fhapi-fhir)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[hapifhir](/hapifhir)
/
**[hapi-fhir](/hapifhir/hapi-fhir)**
Public

* [Notifications](/login?return_to=%2Fhapifhir%2Fhapi-fhir) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fhapifhir%2Fhapi-fhir)
* [Star
   2.1k](/login?return_to=%2Fhapifhir%2Fhapi-fhir)

* [Code](/hapifhir/hapi-fhir)
* [Issues
  925](/hapifhir/hapi-fhir/issues)
* [Pull requests
  228](/hapifhir/hapi-fhir/pulls)
* [Actions](/hapifhir/hapi-fhir/actions)
* [Projects
  0](/hapifhir/hapi-fhir/projects)
* [Wiki](/hapifhir/hapi-fhir/wiki)
* [Security](/hapifhir/hapi-fhir/security)
* [Insights](/hapifhir/hapi-fhir/pulse)

Additional navigation options

* [Code](/hapifhir/hapi-fhir)
* [Issues](/hapifhir/hapi-fhir/issues)
* [Pull requests](/hapifhir/hapi-fhir/pulls)
* [Actions](/hapifhir/hapi-fhir/actions)
* [Projects](/hapifhir/hapi-fhir/projects)
* [Wiki](/hapifhir/hapi-fhir/wiki)
* [Security](/hapifhir/hapi-fhir/security)
* [Insights](/hapifhir/hapi-fhir/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fhapifhir%2Fhapi-fhir%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fhapifhir%2Fhapi-fhir%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Potential Denial of Service in JPA Server via history operation #2641

Closed

[jamesagnew](/jamesagnew) opened this issue
May 6, 2021
· 0 comments
 · Fixed by [#2642](https://github.com/hapifhir/hapi-fhir/pull/2642)

Closed

# [Potential Denial of Service in JPA Server via history operation](#top) #2641

[jamesagnew](/jamesagnew) opened this issue
May 6, 2021
· 0 comments
 · Fixed by [#2642](https://github.com/hapifhir/hapi-fhir/pull/2642)

## Comments

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=80&u=e0764f4bf89c5ea416df81bbca45f9995bc89bf5&v=4)](/jamesagnew)

Copy link

Collaborator

### **[jamesagnew](/jamesagnew)** commented [May 6, 2021](#issue-877557526)

| A weakness in our handling of FHIR [history](http://hl7.org/fhir/http.html#history) operations has been reported.  Specifically, on a server with a very large number of resources, if the history operation is executed by many clients (e.g. 200) concurrently, the server becomes unresponsive and ultimately consumes a large amount of disk and becomes unstable.  Our investigation has revealed that the root cause is a `SELECT COUNT(...)` query that executes at the start of all `_history` operations. Essentially, anytime a `_history` is executed, the server executes 2 SQL statements (statements here are approximate):   1. A `SELECT COUNT(pid) FROM hfj_res_ver` is performed to supply a value for `Bundle.total` 2. A `SELECT * FROM hfj_res_ver ORDER BY updated DESC LIMIT 100` is performed to supply the contents   The second query is executed against an index and is very fast. The first query by its nature requires a full index scan and is slow. Executing it 200 concurrent times quickly overwhelms the database and leads to timeouts, exceptions, and eventually instability.  The proposed fix is as follows:   * A new DaoConfig setting is added. This setting introduces a "history count mode" with 3 options:   + Cached. This is the new default: A loading cache will be used for history counts, meaning that counts are stored in RAM for up to one minute, and the loading cache blocks all but one client thread per JVM from actually performing the count. This effectively throttles access to the database.   + Not cached. This is the status quo and does exhibit the weakness described here, but may be appropriate in scenarios where users are trusted and accuracy is always required.   + No count. This setting avoids the count query entirely, saving time and avoiding this weakness at the expense of not including any total in the response.   A huge thanks to **Zachary Minneker at Security Innovation** who discovered and submitted a responsible disclosure of this issue.  This issue will be resolved for the upcoming 5.4.0 release. A CVE number is forthcoming. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&u=e0764f4bf89c5ea416df81bbca45f9995bc89bf5&v=4)](/jamesagnew)
[jamesagnew](/jamesagnew)
mentioned this issue
[May 6, 2021](#ref-pullrequest-877561492)

[Resolve weakness in history operation
#2642](/hapifhir/hapi-fhir/pull/2642)
 Merged

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=40&u=e0764f4bf89c5ea416df81bbca45f9995bc89bf5&v=4)](/jamesagnew)
[jamesagnew](/jamesagnew)
closed this as [completed](/hapifhir/hapi-fhir/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#2642](/hapifhir/hapi-fhir/pull/2642)
[May 7, 2021](#event-4703085277)

[![@ttran428](https://avatars.githubusercontent.com/u/24787668?s=40&v=4)](/ttran428)
[ttran428](/ttran428)
mentioned this issue
[Sep 28, 2022](#ref-issue-1388544521)

[Enable History Counting in application.yaml
hapifhir/hapi-fhir-jpaserver-starter#433](/hapifhir/hapi-fhir-jpaserver-starter/issues/433)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fhapifhir%2Fhapi-fhir%2Fissues%2F2641)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Resolve weakness in history operation](/hapifhir/hapi-fhir/pull/2642)
 [hapifhir/hapi-fhir](/hapifhir/hapi-fhir)

1 participant

[![@jamesagnew](https://avatars.githubusercontent.com/u/3465117?s=52&v=4)](/jamesagnew)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from hapifhir.io_fc76c362_20250114_202836.html ===

[![raccoon mascot](/hapi-fhir/images/logos/raccoon-forwards.png)
![HAPI FHIR logo](/hapi-fhir/images/logos/small-logo.png)](/hapi-fhir/ "Home")

Select HAPI FHIR version to view:

* [Support](https://smilecdr.com/)
* [Github](https://github.com/jamesagnew/hapi-fhir)
* [News](/hapi-fhir/blog/)
* [Documentation](/hapi-fhir/docs/)
* Get Help
  [Getting Help (read this first!)](https://github.com/jamesagnew/hapi-fhir/wiki/Getting-Help)
  [Google Group (ask questions)](https://groups.google.com/d/forum/hapi-fhir)
  [Issue Tracker (report bugs/request features)](https://github.com/jamesagnew/hapi-fhir/issues)
  [chat.fhir.org (live chat with FHIR implementers)](https://chat.fhir.org/)
  [Frequently Asked Questions (FAQ)](/hapi-fhir/docs/appendix/faq.html)
* Test Server
  [HAPI FHIR Public Test Server](http://hapi.fhir.org)

#

HAPI FHIR is a complete implementation of the
[HL7 FHIR](http://hl7.org/fhir/)
standard for healthcare interoperability in Java.
We are an
[open community](/hapi-fhir/contributors.html)
developing software licensed under the business-friendly
[Apache Software License 2.0](/hapi-fhir/license.html).
HAPI FHIR is a product of [Smile Digital Health](https://www.smiledigitalhealth.com/).

[Who's Using HAPI](/hapi-fhir/global-atlas.html)

![World Map of FHIR users](/hapi-fhir/images/map/map.png)

The HAPI FHIR Global Atlas is inspired by our friends at the
[OpenMRS](https://atlas.openmrs.org) project.
We would love to add your project, company, or organization to the map.
[Learn more](/hapi-fhir/global-atlas.html)
about how you can add yourself (or update/remove an existing entry).

This is the homepage for the HAPI-FHIR library. We are developing an open-source
implementation of the FHIR specification in Java. FHIR (Fast Healthcare Interoperability Resources) is a
specification for exchanging healthcare data in a modern and developer friendly way. Note that this is the
home for the FHIR version of HAPI. For HL7 v2 support, see
[hapi-hl7v2.](https://github.com/hapifhir/hapi-hl7v2)

## [HAPI FHIR 6.2.0 (Vishwa) ›](/hapi-fhir/blog/)

Welcome to the winter release of HAPI FHIR! Support has been added for FHIR R4B (4.3.0). See the [R4B Documentation](/hapi-fhir/docs/getting_started/r4b.html) for more information on what this means. Now onto the rest!

### Breaking Changes

* The `ActionRequestDetails` class has been dropped (it has been deprecated
  since HAPI FHIR 4.0.0). This class was used as a parameter to the
  `SERVER_INCOMING_REQUEST_PRE_HANDLED` interceptor pointcut, but can be
  replaced in any existing client code with `RequestDetails`. This change
  also removes an undocumented behaviour where the JPA server internally
  invoked the `SERVER_INCOMING_REQUEST_PRE_HANDLED` a second time from
  within various processing methods. This behaviour caused performance
  problems for some interceptors (e.g. `SearchNarrowingInterceptor`) and
  no longer offers any benefit so it is being removed.
* Previously when ValueSets were pre-expanded after loinc terminology upload, expansion was failing with an exception for each ValueSet
  with more than 10,000 properties. This problem has been fixed.
  This fix changed some freetext mappings (definitions about how resources are freetext indexed) for terminology resources, which requires
  reindexing those resources. To do this use the `reindex-terminology` command."
* Removed Flyway database migration engine. The migration table still tracks successful and failed migrations
  to determine which migrations need to be run at startup. Database migrations no longer need to run differently when
  using an older database version.
* The interceptor system has now deprecated the concept of ThreadLocal interceptors. This feature was
  added for an anticipated use case, but has never seen any real use that we are aware of and removing it
  should provide a minor performance improvement to the interceptor registry.

### Security Changes

* Upon hitting a subscription delivery failure, we currently log the failing payload which could be considered PHI. Resource content is no longer written to logs on subscription failure.

### General Client/Server/Parser Changes

* Previously, Celsius and Fahrenheit temperature quantities were not normalized. This is now fixed.
  This change requires reindexing of resources containing Celsius or Fahrenheit temperature quantities.
* Fixed bug where searching with a target resource parameter (Coverage:payor:Patient) as value to an \_include parameter would fail with a 500 response.
* Previously, DELETE request type is not supported for any operations. DELETE is now supported, and is enabled for operation $export-poll-status to allow cancellation of jobs
* Previously, when a client would provide a requestId within the source uri of a Meta.source, the provided requestId would get discarded and replaced by an id generated by the system. This has been corrected
* In the JPA server, when a resource is being updated, the response will now include any tags or
  security labels which were not present in the request but were carried forward from the previous
  version of the resource.
* Previously, if the Endpoint Base URL is set to something different from the default value, the URL that export-poll-status returned is incorrect.
  After correcting the export-poll-status URL, the binary file URL returned is also incorrect. This error has also been fixed and the URLs that are returned
  from $export and $export-poll-status will not contain the extra path from 'Fixed Value for Endpoint Base URL'.
* Previously, the `:nickname` qualifier only worked with the predefined `name` and `given` SearchParameters.
  This has been fixed and now the `:nickname` qualifier can be used with any string SearchParameters.
* Previously, when executing a '[base]/\_history' search, '\_since' and '\_at' shared the same behaviour. When a user searched for the date between the records' updated date with '\_at', the record of '\_at' time was not returned.
  This has been corrected. '\_since' query parameter works as it previously did, and the '\_at' query parameter returns the record of '\_at' time.
* Previously, creating a DSTU3 SearchParameter with an expression that does not start with a resource type would throw an error. This has been corrected.
* There was a bug in content-type negotiation when reading Binary resources. Previously, when a client requested a Binary resource and with an `Accept`
  header that matched the `contentType` of the stored resource, the server would return an XML representation of the Binary resource. This has been fixed, and a request with a matching `Accept` header will receive
  the stored binary data directly as the requested content type.
* A new built-in server interceptor called the InteractionBlockingInterceptor has been added. This interceptor
  allows individual operations to be included/excluded from a RestfulServer's exported capabilities.
* The OpenApi generator now allows additional CSS customization for the Swagger UI page, as well as the
  option to disable resource type pages.
* Modified BinaryAccessProvider to use a safer method of checking the contents of an input stream. Thanks to @ttntrifork for the fix!
* Fixed issue where adding a sort parameter to a query would return an incomplete result set.
* Added new attribute for the @Operation annotation to define the operation's canonical URL. This canonical URL value will populate
  the operation definition in the CapabilityStatement resource.
* A new interceptor pointcut `STORAGE_TRANSACTION_PROCESSING` has been added. Hooks for this
  pointcut can examine and modify FHIR transaction bundles being processed by the JPA server before
  processing starts.
* In the JPA server, when deleting a resource the associated tags were previously deleted even though
  the FHIR specification states that tags are independent of FHIR versioning. After this fix, resource tags
  and security labels will remain when a resource is deleted. They can be fetched using the `$meta` operation
  against the deleted resource, and will remain if the resource is brought back in a subsequent update.
* Fixed a bug which caused a failure when combining a Consent Interceptor with version conversion via the `Accept` header.

### Bulk Export

* Previously, bulk export for Group type with \_typeFilter did not apply the filter if it was for the patients, and returned all members of the group.
  This has now been fixed, and the filter will apply.
* A regression was introduced in 6.1.0 which caused bulk export jobs to not default to the correct output format when the `_outputFormat` parameter was omitted. This behaviour has been fixed, and if omitted, will now default to the only legal value `application/fhir+ndjson`.
* Fixed a bug in Group Bulk Export where the server would crash in oracle due to too many clauses.
* Fixed a Group Bulk Export bug which was causing it to fail to return resources due to an incorrect search.
* Fixed a Group Bulk Export bug in which the group members would not be expanded correctly.
* Fixed a bug in Group Bulk Export: If a group member was part of multiple groups , it was causing other groups to be included during Group Bulk Export, if the Group resource type was specified. Now, when
  doing an export on a specific group, and you elect to return Group resources, only the called Group will be returned, regardless of cross-membership.
* Previously, Patient Bulk Export only supported endpoint [fhir base]/Patient/$export, which exports all patients.
  Now, Patient Export can be done at the instance level, following this format: `[fhir base]/Patient/[id]/$export`, which will export only the records for one patient.
  Additionally, added support for the `patient` parameter in Patient Bulk Export, which is another way to get the records of only one patient.
* Fixed the `$poll-export-status` endpoint so that when a job is complete, this endpoint now correctly includes the `request` and `requiresAccessToken` attributes.
* Fixed a bug where /Patient/$export would fail if \_type=Patient parameter
  was not included.
* Previously, Group Bulk Export did not support the inclusion of resources referenced in the resources in the patient compartment.
  This is now supported.
* A previous fix resulted in Bulk Export files containing mixed resource types, which is
  not allowed in the bulk data access IG. This has been corrected.
* A previous fix resulted in Bulk Export files containing duplicate resources, which is
  not allowed in the bulk data access IG. This has been corrected.
* Previously, the number of resources per binary file in bulk export was a static 1000. This is now configurable by a new JpaStorageSettings property called
  'setBulkExportFileMaximumCapacity()', and the default value is 1000 resources per file.
* By default, if the `$export` operation receives a request that is identical to one that has been recently
  processed, it will attempt to reuse the batch job from the former request. A new configuration parameter has been
* introduced that disables this behavior and forces a new batch job on every call.
* Bulk Group export was failing to export Patient resources when Client ID mode was set to: ANY. This has been fixed
* Previously, Bulk Export jobs were always reused, even if completed. Now, jobs are only reused if an identical job is already running, and has not yet completed or failed.

### Other Operations

* Extend $member-match to validate matched patient against family name and birthdate
* `$mdm-submit` can now be run as a batch job, which will return a job ID, and can be polled for status. This can be accomplished by sending a `Prefer: respond-async` header with the request.
* Previously, if the `$reindex` operation failed with a `ResourceVersionConflictException` the related

### CLI Tool changes:

* Added a new optional parameter to the `upload-terminology` operation of the HAPI-FHIR CLI. you can pass the `-s` or `--size` parameter to specify
  the maximum size that will be transmitted to the server, before a local file reference is used. This parameter can be filled in using human-readable format, for example:
  `upload-terminology -s \"1GB\"` will permit zip files up to 1 gigabyte, and anything larger than that would default to using a local file reference.
* Previously, using the `import-csv-to-conceptmap` command in the CLI successfully created ConceptMap resources
  without a `ConceptMap.status` element, which is against the FHIR specification. This has been fixed by adding a required
  option for status for the command.
* Added support for -l parameter for providing a local validation profile in the HAPI FHIR CLI.
* Previously, when the upload-terminology command was used to upload a terminology file with endpoint validation enabled, a validation error occurred due to a missing file content type.
  This has been fixed by specifying the file content type of the uploaded file.
* For SNOMED CT, upload-terminology now supports both Canadian and International edition's file names for the SCT Description File
* Documentation was added for `reindex-terminology` command.

### JPA Server General Changes

* Changed Minimum Size (bytes) in FHIR Binary Storage of the persistence module from an integer to a long. This will permit larger binaries.
* Previously, if a FullTextSearchSvcImpl was defined, but was disabled via configuration, there could be data loss when reindexing due to transaction rollbacks. This has been corrected. Thanks to @dyoung-work for the fix!
* Fixed a bug where the $everything operation on Patient instances and the Patient type was not correctly propagating the transactional semantics. This was causing callers to not be in a transactional context.
* Previously when updating a phonetic search parameter, any existing resource will not have its search parameter String updated upon reindex if the normalized String is the same letter as under the old algorithm (ex JN to JAN). Searching on the new normalized String was failing to return results. This has been corrected.
* Previously, when creating a `DocumentReference` with an `Attachment` containing a URL over 254 characters
  an error was thrown. This has been corrected and now an `Attachment` URL can be up to 500 characters.

### JPA Server Performance Changes

* Initial page loading has been optimized to reduce the number of prefetched resources. This should improve the speed of initial search queries in many cases.
* Cascading deletes don't work correctly if multiple threads initiate a delete at the same time. Either the resource won't be found or there will be a collision on inserting the new version. This changes fixes the problem by better handling these conditions to either ignore an already deleted resource or to keep retrying in a new inner transaction.
* When using SearchNarrowingInterceptor, FHIR batch operations with a large number
  of conditional create/update entries exhibited very slow performance due to an
  unnecessary nested loop. This has been corrected.
* When using ForcedOffsetSearchModeInterceptor, any synchronous searches initiated programmatically (i.e. through the
  internal java API, not the REST API) will not be modified. This prevents issues when a java call requests a synchronous
  search larger than the default offset search page size
* Previously, when using \_offset, the queries will result in short pages, and repeats results on different pages.
  This has now been fixed.
* Processing for `_include` and `_revinclude` parameters in the JPA server has been streamlined, which should
  improve performance on systems where includes are heavily used.

### Database-specific Changes

* Database migration steps were failing with Oracle 19C. This has been fixed by allowing the database engine to skip dropping non-existent indexes.

### Terminology Server, Fulltext Search, and Validation Changes

* With Elasticsearch configured, including terminology, an exception was raised while expanding a ValueSet
  with more than 10,000 concepts. This has now been fixed.
* Previously when ValueSets were pre-expanded after loinc terminology upload, expansion was failing with an exception for each ValueSet
  with more than 10,000 properties. This problem has been fixed.
  This fix changed some freetext mappings (definitions about how resources are freetext indexed) for terminology resources, which requires
  reindexing those resources. To do this use the `reindex-terminology` command."
* Added support for AWS OpenSearch to Fulltext Search. If an AWS Region is configured, HAPI-FHIR will assume you intend to connect to an AWS-managed OpenSearch instance, and will use
  Amazon's [DefaultAwsCredentialsProviderChain](https://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html) to authenticate against it. If both username and password are provided, HAPI-FHIR will attempt to use them as a static credentials provider.
* Search for strings with `:text` qualifier was not performing advanced search. This has been corrected.
* LOINC terminology upload process was enhanced to consider 24 additional properties which were defined in
  loinc.csv file but not uploaded.
* LOINC terminology upload process was enhanced by loading `MAP_TO` properties defined in MapTo.csv input file to TermConcept(s).

### MDM (Master Data Management)

* MDM messages were using the resource id as a message key when it should be using the EID as a partition hash key.
  This could lead to duplicate golden resources on systems using Kafka as a message broker.
* `$mdm-submit` can now be run as a batch job, which will return a job ID, and can be polled for status. This can be accomplished by sending a `Prefer: respond-async` header with the request.

### Batch Framework

* Fast-tracking batch jobs that produced only one chunk has been rewritten to use Quartz triggerJob. This will
  ensure that at most one thread is updating job status at a time. Also jobs that had FAILED, ERRORED, or been CANCELLED
  could be accidentally set back to IN\_PROGRESS; this has been corrected
* All Spring Batch dependencies and services have been removed. Async processing has fully migrated to Batch 2.
* In HAPI-FHIR 6.1.0, a regression was introduced into bulk export causing exports beyond the first one to fail in strange ways. This has been corrected.
* A remove method has been added to the Batch2 job registry. This will allow for dynamic job registration
  in the future.
* Batch2 jobs were incorrectly prevented from transitioning from ERRORED to COMPLETE status.

### Package Registry

* Provided the ability to have the NPM package installer skip installing a package if it is already installed and matches the version requested. This can be controlled by
  the `reloadExisting` attribute in PackageInstallationSpec. It defaults to `true`, which is the existing behaviour. Thanks to Craig McClendon (@XcrigX) for the contribution!

Posted: 2022-11-17T13:00:00

By: james

[Read More (Humans)](/hapi-fhir/blog/20221117_hapi_fhir_6_2_0)
[Read More (Robots)](/hapi-fhir/blog/fhir/baseR4/Communication/20221117_hapi_fhir_6_2_0)

## Demonstration/Test Page

A public test server can be found at <http://hapi.fhir.org>.
This server is built entirely using
components of HAPI-FHIR and demonstrates all of its capabilities.
This server is also entirely open source.
You can host your own copy by following instructions on our
[JPA Server documentation](/hapi-fhir/docs/server_jpa/).

## Commercial Support

Commercial support for HAPI FHIR is available through [Smile CDR](https://smilecdr.com).

![raccoon sashay](images/logos/raccoon-sashay.png)

[![Build Status]()](https://dev.azure.com/hapifhir/HAPI%20FHIR/_apis/build/status/jamesagnew.hapi-fhir?branchName=master)
[![Coverage Status]()](https://codecov.io/gh/jamesagnew/hapi-fhir)
[![Total alerts]()](https://lgtm.com/projects/g/jamesagnew/hapi-fhir/alerts/)
[![Maven Central]()](https://maven-badges.herokuapp.com/maven-central/ca.uhn.hapi.fhir/hapi-fhir-base/badge.svg)
[![Apache 2.0 Licensed]()](http://jamesagnew.github.io/hapi-fhir/license.html)

[Star](https://github.com/jamesagnew/hapi-fhir)
[Fork](https://github.com/jamesagnew/hapi-fhir/fork)
[Watch](https://github.com/jamesagnew/hapi-fhir/subscription)

## Some Ways You Can Use HAPI FHIR

HAPI is designed with one main intent: providing a flexible way of adding FHIR capability to applications.
This project was originally developed at
[University Health Network](https://www.uhn.ca) to allow UHN to build up a system of unified FHIR
services to expose data backed by a number of systems and repositories. It is designed to be flexible
and composable above all else.

Use the HAPI FHIR parser and encoder to convert between FHIR and your application's data model.

[Learn More](/hapi-fhir/docs/model/parsers.html)

![diagram of HAPI FHIR parser](images/use-diagrams/infog1.png)

Use the HAPI FHIR client in an application to fetch from or store resources to an external
server.

[Learn More](/hapi-fhir/docs/client/)

![diagram of storing resources](images/use-diagrams/infog2.png)

Use the HAPI FHIR server in an application to allow external applications to access or modify your
application's data.

[Learn More](/hapi-fhir/docs/server_plain/)

![diagram of access resources](images/use-diagrams/infog3.png)

Use the HAPI JPA/Database Server to deploy a fully functional FHIR server you can develop
applications against.

[Learn More](/hapi-fhir/docs/server_jpa/)

![diagram of deploying resources](images/use-diagrams/infog4.png)

# Friends of HAPI FHIR

We are on a mission to improve global healthcare. We know that we can't do it alone though!
HAPI FHIR thanks all of these amazing organizations who have sponsored HAPI FHIR development, helped
out with infrastructure, or otherwise helped us keep the lights on.

[![Smile Digital Health](/hapi-fhir/resources/cdr-web-resources/images/smilecdr_digitalhealth.svg)](https://smiledigitalhealth.com)
[![UHN](/hapi-fhir/images/friends-logos/uhn.jpg)](https://www.uhn.ca/)
[![eHealth Innovation](/hapi-fhir/images/friends-logos/ehi.png)](http://ehealthinnovation.org/)
[![Lister Hill National Centre for Biomedical Computing](/hapi-fhir/images/friends-logos/lhncbc.jpg)](https://lhncbc.nlm.nih.gov/)
[![National Institutes for Health](/hapi-fhir/images/friends-logos/nih.png)](https://nih.gov/)
[![LOINC](/hapi-fhir/images/friends-logos/loinc.png)](https://loinc.org/)
[![JDRF](/hapi-fhir/images/friends-logos/jdrf.png)](https://www.jdrf.org/)
[![ADB](/hapi-fhir/images/friends-logos/adb.png)](https://www.adb.org/)
[![Google Cloud](/hapi-fhir/images/friends-logos/google-cloud.png)](https://cloud.google.com/)
[![HL7 International](/hapi-fhir/images/friends-logos/hl7-int.png)](https://www.hl7.org)
[![SIL ASIA](/hapi-fhir/images/friends-logos/sila.png)](http://sil-asia.org)

---

![raccoon logo without text](/hapi-fhir/images/logos/raccoon-forwards.png)

HAPI HAPI

* [Home](/hapi-fhir/)
* [Download](/hapi-fhir/docs/getting_started/downloading_and_importing.html)
* [Changelog](/hapi-fhir/docs/introduction/changelog.html)
* [License](/hapi-fhir/license.html)
* [News](/hapi-fhir/blog/)

TEST SERVER

* [Public Test Server](http://hapi.fhir.org/)

SUPPORT

* [Smile CDR](https://smilecdr.com/)

USING HAPI

* [Documentation](/hapi-fhir/docs/)
* Command Line Tool (cli)

STARTER PROJECTS

* [Client](https://github.com/FirelyTeam/fhirstarters/tree/master/java/hapi-fhirstarters-client-skeleton)
* [Plain Server](https://github.com/FirelyTeam/fhirstarters/tree/master/java/hapi-fhirstarters-rest-server-skeleton)
* [JPA Server](https://github.com/hapifhir/hapi-fhir-jpaserver-starter)

JAVADOCS

* [Core API](/hapi-fhir/apidocs/hapi-fhir-base/)
* [Model API (DSTU2)](/hapi-fhir/apidocs/hapi-fhir-structures-dstu2/)
* [Model API (DSTU3)](/hapi-fhir/apidocs/hapi-fhir-structures-dstu3/)
* [Model API (R4)](/hapi-fhir/apidocs/hapi-fhir-structures-r4/)
* [Model API (R5)](/hapi-fhir/apidocs/hapi-fhir-structures-r5/)
* [Client API](/hapi-fhir/apidocs/hapi-fhir-client/)
* [Plain Server - API](/hapi-fhir/apidocs/hapi-fhir-server/)
* [Plain Server - MDM API](/hapi-fhir/apidocs/hapi-fhir-server-mdm/)
* [Plain Server - OpenAPI](/hapi-fhir/apidocs/hapi-fhir-server-openapi/)
* [JPA Server - API](/hapi-fhir/apidocs/hapi-fhir-storage/)
* [JPA Server - Model](/hapi-fhir/apidocs/hapi-fhir-jpaserver-model/)
* [JPA Server - Search Param Support](/hapi-fhir/apidocs/hapi-fhir-jpaserver-searchparam/)
* [JPA Server - Subscription](/hapi-fhir/apidocs/hapi-fhir-jpaserver-subscription/)
* [JPA Server - Base](/hapi-fhir/apidocs/hapi-fhir-jpaserver-base/)
* [JPA Server - IPS](/hapi-fhir/apidocs/hapi-fhir-jpaserver-ips/)
* [Validation API](/hapi-fhir/apidocs/hapi-fhir-validation/)
* [Version Converter API](/hapi-fhir/apidocs/hapi-fhir-converter/)
* [Server API (JAX-RS)](/hapi-fhir/apidocs/hapi-fhir-jaxrsserver-base/)

GET HELP

* [How to Ask for Help (read this first!)](https://github.com/jamesagnew/hapi-fhir/wiki/Getting-Help)
* [Google Group (Ask Questions)](https://groups.google.com/d/forum/hapi-fhir)
* [Issue Tracker (Report Bugs/Request Features)](https://github.com/jamesagnew/hapi-fhir/issues)
* [FHIR.org Chat (Live Chat with FHIR Implementors)](https://chat.fhir.org/)
* [Frequently Asked Questions (FAQ)](/hapi-fhir/docs/appendix/faq.html)

CONTRIBUTE

* [Guide to Hacking HAPI](/hapi-fhir/docs/contributing/hacking_guide.html)
* [Contributors](/hapi-fhir/contributors.html)

Updated: 2025-01-07T10:15:29.543-08:00 — Made with  in [![Raccoon](/hapi-fhir/images/icons/raccoon.svg)](https://www.cbc.ca/news/canada/toronto/raccoon-city-wildlife-in-toronto-1.2742231)


