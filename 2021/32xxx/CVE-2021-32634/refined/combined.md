=== Content from github.com_057103be_20250114_182336.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Femissary%2Fsecurity%2Fadvisories%2FGHSA-m5qf-gfmp-7638)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Femissary%2Fsecurity%2Fadvisories%2FGHSA-m5qf-gfmp-7638)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=NationalSecurityAgency%2Femissary)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NationalSecurityAgency](/NationalSecurityAgency)
/
**[emissary](/NationalSecurityAgency/emissary)**
Public

* [Notifications](/login?return_to=%2FNationalSecurityAgency%2Femissary) You must be signed in to change notification settings
* [Fork
  122](/login?return_to=%2FNationalSecurityAgency%2Femissary)
* [Star
   247](/login?return_to=%2FNationalSecurityAgency%2Femissary)

* [Code](/NationalSecurityAgency/emissary)
* [Issues
  1](/NationalSecurityAgency/emissary/issues)
* [Pull requests
  11](/NationalSecurityAgency/emissary/pulls)
* [Actions](/NationalSecurityAgency/emissary/actions)
* [Security](/NationalSecurityAgency/emissary/security)
* [Insights](/NationalSecurityAgency/emissary/pulse)

Additional navigation options

* [Code](/NationalSecurityAgency/emissary)
* [Issues](/NationalSecurityAgency/emissary/issues)
* [Pull requests](/NationalSecurityAgency/emissary/pulls)
* [Actions](/NationalSecurityAgency/emissary/actions)
* [Security](/NationalSecurityAgency/emissary/security)
* [Insights](/NationalSecurityAgency/emissary/pulse)

# Deserialization of Untrusted Data in Emissary

High

[drewfarris](/drewfarris)
published
GHSA-m5qf-gfmp-7638
May 21, 2021

## Package

maven

emissary:emissary
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

6.4.0

## Patched versions

6.6.0

## Description

### Impact

Emissary 6.4.0 is vulnerable to Unsafe Deserialization of post-authenticated requests to the [`WorkSpaceClientEnqueue.action`](https://github.com/NationalSecurityAgency/emissary/blob/30c54ef16c6eb6ed09604a929939fb9f66868382/src/main/java/emissary/server/mvc/internal/WorkSpaceClientEnqueueAction.java) REST endpoint.

This issue may lead to post-auth Remote Code Execution. Since version 6.3.0, the endpoint is protected against CSRF attacks, which reduces the impact of the vulnerability. However, if a new XSS vulnerability is introduced in the future, it might allow an attacker to craft a malicious page that, when visited by a victim, will trigger the unsafe deserialization.

There are two other instances within Emissary that is not currently exercised in the code. These unused code paths will be removed.

### Patches

This issue has been patched in version 6.6.0

### Workarounds

Disable network access to Emissary from untrusted sources.

### References

1. [OWASP Deserialization of Untrusted Data](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data)
2. [MITRE Common Weakness Enumeration (CWE-502: Deserialization of Untrusted Data)](https://cwe.mitre.org/data/definitions/502.html)

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [NationalSecurityAgency/emissary](https://github.com/NationalSecurityAgency/emissary)
* Email us at emissarysupport@evoforge.org

### Severity

High

7.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
High

User interaction
None

Scope
Changed

Confidentiality
Low

Integrity
Low

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:H/UI:N/S:C/C:L/I:L/A:H

### CVE ID

CVE-2021-32634

### Weaknesses

[CWE-502](/advisories?query=cwe%3A502)

### Credits

* [![@pwntester](https://avatars.githubusercontent.com/u/125701?s=40&v=4)](/pwntester)
  [pwntester](/pwntester)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_1d2ac203_20250114_182336.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Femissary%2Fcommit%2F40260b1ec1f76cc92361702cc14fa1e4388e19d7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Femissary%2Fcommit%2F40260b1ec1f76cc92361702cc14fa1e4388e19d7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=NationalSecurityAgency%2Femissary)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NationalSecurityAgency](/NationalSecurityAgency)
/
**[emissary](/NationalSecurityAgency/emissary)**
Public

* [Notifications](/login?return_to=%2FNationalSecurityAgency%2Femissary) You must be signed in to change notification settings
* [Fork
  122](/login?return_to=%2FNationalSecurityAgency%2Femissary)
* [Star
   247](/login?return_to=%2FNationalSecurityAgency%2Femissary)

* [Code](/NationalSecurityAgency/emissary)
* [Issues
  1](/NationalSecurityAgency/emissary/issues)
* [Pull requests
  11](/NationalSecurityAgency/emissary/pulls)
* [Actions](/NationalSecurityAgency/emissary/actions)
* [Security](/NationalSecurityAgency/emissary/security)
* [Insights](/NationalSecurityAgency/emissary/pulse)

Additional navigation options

* [Code](/NationalSecurityAgency/emissary)
* [Issues](/NationalSecurityAgency/emissary/issues)
* [Pull requests](/NationalSecurityAgency/emissary/pulls)
* [Actions](/NationalSecurityAgency/emissary/actions)
* [Security](/NationalSecurityAgency/emissary/security)
* [Insights](/NationalSecurityAgency/emissary/pulse)

## Commit

[Permalink](/NationalSecurityAgency/emissary/commit/40260b1ec1f76cc92361702cc14fa1e4388e19d7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-m5qf-gfmp-7638](https://github.com/NationalSecurityAgency/emissary/security/advisories/GHSA-m5qf-gfmp-7638 "GHSA-m5qf-gfmp-7638")

[Browse files](/NationalSecurityAgency/emissary/tree/40260b1ec1f76cc92361702cc14fa1e4388e19d7)
Browse the repository at this point in the history

```
* Remove unsafe serialization from PayloadUtil

* This code will likely be removed wholesale, but this change
  should be used as a departure point for future development
  if we end up re-implementing moveTo and friends.

* Removed vestigial MoveTo related code.

* Remove unsafe serialization in WorkSpace infra.

* Favor DataInput/DataOutputStream over ObjectInput/ObjectOutputStream
* Implement lightweight serialization in WorkBundle/WorkUnit

* Updates to WorkBundle serDe, added tests.

- set limit on number of WorkUnits per bundle. In practice these are
  commonly less than 1024.
- added null handling for WorkBundle/WorkUnit string fields.
- confirmed readUTF/writeUTF has a limit ensuring strings will
  be 65535 characters or less.

* Minor cleanup to WorkBundleTest

* Minor Change to WorkBundleTest

* Formatting updates
```

* Loading branch information

[![@drewfarris](https://avatars.githubusercontent.com/u/110922?s=40&v=4)](/drewfarris)

[drewfarris](/NationalSecurityAgency/emissary/commits?author=drewfarris "View all commits by drewfarris")
authored
May 21, 2021

1 parent
[fd0e1c2](/NationalSecurityAgency/emissary/commit/fd0e1c25684e3e80c18fc8805acc06f26f46266c)

commit 40260b1

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**248 additions**
and
**423 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + main/java/emissary

    - core

      * src/main/java/emissary/core/IMobileAgent.java
        [IMobileAgent.java](#diff-91554aebea6c79739a4b8ddaa1509e0a721f0fb142b03cc93bbef14320d24680)
    - pickup

      * src/main/java/emissary/pickup/WorkBundle.java
        [WorkBundle.java](#diff-8366c79b0be7edfe8ab8e0e79c483cabe7fe71fd9b83075d858e35be6a912a6f)
      * src/main/java/emissary/pickup/WorkUnit.java
        [WorkUnit.java](#diff-04cbda5489a675959876ab3997c04cb118a99e95fc006527ad0021dd4ba084b5)
    - server/mvc

      * adapters

        + src/main/java/emissary/server/mvc/adapters/MoveToAdapter.java
          [MoveToAdapter.java](#diff-e00c1b6d01b397cf6136c68b20a9dc2f3522f40ca18ac29aebdaa3e347091202)
        + src/main/java/emissary/server/mvc/adapters/WorkSpaceAdapter.java
          [WorkSpaceAdapter.java](#diff-2fe24c5bc096e9ebacbdb17cefac8641a089d0832b8e58802f5852c09ffaa249)
      * internal

        + src/main/java/emissary/server/mvc/internal/MoveToAction.java
          [MoveToAction.java](#diff-78ee3ca00ded59301e7df4ce709520f1a218c924ef7fec53f38b34ed176a7997)
        + src/main/java/emissary/server/mvc/internal/WorkSpaceClientEnqueueAction.java
          [WorkSpaceClientEnqueueAction.java](#diff-e12fe647eb6fb7103339451373168f839ef175995492bd84eea2775b612c5e1e)
    - util

      * src/main/java/emissary/util/PayloadUtil.java
        [PayloadUtil.java](#diff-0059cf542a44c3effb256318f613ad62b1624b3bb1f3d7e26f4ab33df95ea50d)
  + test/java/emissary

    - pickup

      * src/test/java/emissary/pickup/WorkBundleTest.java
        [WorkBundleTest.java](#diff-90ac890259e39e89911b5eb96a9c98a1e04fdcf3cfb1a84319a755aceca357ae)
    - util

      * src/test/java/emissary/util/PayloadUtilTest.java
        [PayloadUtilTest.java](#diff-f3046a82b8ea767a4cbfce3239de7924d87c977977e050a0bb3e2571459278bc)

## There are no files selected for viewing

7 changes: 2 additions & 5 deletions

7
[src/main/java/emissary/core/IMobileAgent.java](#diff-91554aebea6c79739a4b8ddaa1509e0a721f0fb142b03cc93bbef14320d24680 "src/main/java/emissary/core/IMobileAgent.java")

Show comments

[View file](/NationalSecurityAgency/emissary/blob/40260b1ec1f76cc92361702cc14fa1e4388e19d7/src/main/java/emissary/core/IMobileAgent.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,8 +3,6 @@ |
|  |  | import java.io.Serializable; |
|  |  | import java.util.List; |
|  |  |  |
|  |  | import emissary.server.mvc.adapters.MoveToAdapter; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Interface to the MobileAgent |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -59,9 +57,8 @@ void arrive(Object payload, emissary.place.IServiceProviderPlace arrivalPlace, i |
|  |  | boolean isInUse(); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get the payload as an object for serialization during transport Should only be called by the MoveToAdapter |
|  |  | \* |
|  |  | \* @see MoveToAdapter |
|  |  | \* Get the payload as an object for serialization during transport. |
|  |  | \* |
|  |  | \*/ |
|  |  | Object getPayloadForTransport(); |
|  |  |  |
| Expand Down | |  |

124 changes: 113 additions & 11 deletions

124
[src/main/java/emissary/pickup/WorkBundle.java](#diff-8366c79b0be7edfe8ab8e0e79c483cabe7fe71fd9b83075d858e35be6a912a6f "src/main/java/emissary/pickup/WorkBundle.java")

Show comments

[View file](/NationalSecurityAgency/emissary/blob/40260b1ec1f76cc92361702cc14fa1e4388e19d7/src/main/java/emissary/pickup/WorkBundle.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,8 @@ |
|  |  | package emissary.pickup; |
|  |  |  |
|  |  | import java.io.Serializable; |
|  |  | import java.io.DataInputStream; |
|  |  | import java.io.DataOutputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.Iterator; |
|  |  | import java.util.List; |
| Expand All | | @@ -21,13 +23,12 @@ |
|  |  | \* <p> |
|  |  | \* getOldestFileModificationTime() &lt;= getYoungestFileModificationTime() |
|  |  | \*/ |
|  |  | public class WorkBundle implements Serializable, Comparable<WorkBundle> { |
|  |  |  |
|  |  | // Serializable |
|  |  | static final long serialVersionUID = 6339812801001572532L; |
|  |  | public final class WorkBundle implements Comparable<WorkBundle> { |
|  |  |  |
|  |  | private static final Logger logger = LoggerFactory.getLogger(WorkBundle.class); |
|  |  |  |
|  |  | static final int MAX\_UNITS = 1024; |
|  |  |  |
|  |  | // Unique ID for this work bundle |
|  |  | String bundleId; |
|  |  |  |
| Expand Down  Expand Up | | @@ -110,6 +111,80 @@ public WorkBundle(WorkBundle that) { |
|  |  | resetBundleId(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Deserialize a WorkBundle from a DataInputStream |
|  |  | \* |
|  |  | \* @param in the stream to read from |
|  |  | \* @return the deserialized WorkBundle |
|  |  | \* @throws IOException if there is a problem reading the stream or it contains more than <code>MAX\_UNITS</code> work |
|  |  | \* units. |
|  |  | \*/ |
|  |  | public static WorkBundle readFromStream(DataInputStream in) throws IOException { |
|  |  | WorkBundle wb = new WorkBundle(); |
|  |  | wb.bundleId = readUTFOrNull(in); |
|  |  | wb.outputRoot = readUTFOrNull(in); |
|  |  | wb.eatPrefix = readUTFOrNull(in); |
|  |  | wb.caseId = readUTFOrNull(in); |
|  |  | wb.sentTo = readUTFOrNull(in); |
|  |  | wb.errorCount = in.readInt(); |
|  |  | wb.priority = in.readInt(); |
|  |  | wb.simpleMode = in.readBoolean(); |
|  |  | wb.oldestFileModificationTime = in.readLong(); |
|  |  | wb.youngestFileModificationTime = in.readLong(); |
|  |  | wb.totalFileSize = in.readLong(); |
|  |  | int workUnitSize = in.readInt(); |
|  |  | if (workUnitSize > MAX\_UNITS) { |
|  |  | throw new IOException( |
|  |  | "Exception when reading: WorkBundle may not contain more then " + MAX\_UNITS + " WorkUnits (saw: " + workUnitSize + ")."); |
|  |  | } |
|  |  | for (int i = 0; i < workUnitSize; i++) { |
|  |  | wb.addWorkUnit(WorkUnit.readFromStream(in)); |
|  |  | } |
|  |  | return wb; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Serialize this WorkBundle to a DataOutputStream |
|  |  | \* |
|  |  | \* @param out the stream to write to. |
|  |  | \* @throws IOException if there is a problem writing to the stream. |
|  |  | \*/ |
|  |  | public void writeToStream(DataOutputStream out) throws IOException { |
|  |  | writeUTFOrNull(bundleId, out); |
|  |  | writeUTFOrNull(outputRoot, out); |
|  |  | writeUTFOrNull(eatPrefix, out); |
|  |  | writeUTFOrNull(caseId, out); |
|  |  | writeUTFOrNull(sentTo, out); |
|  |  | out.writeInt(errorCount); |
|  |  | out.writeInt(priority); |
|  |  | out.writeBoolean(simpleMode); |
|  |  | out.writeLong(oldestFileModificationTime); |
|  |  | out.writeLong(youngestFileModificationTime); |
|  |  | out.writeLong(totalFileSize); |
|  |  | out.writeInt(workUnitList.size()); |
|  |  | if (workUnitList.size() > MAX\_UNITS) { |
|  |  | throw new IOException( |
|  |  | "Exception when writing: WorkBundle may not contain more then " + MAX\_UNITS + " WorkUnits (saw: " + workUnitList.size() + ")."); |
|  |  | } |
|  |  | for (WorkUnit u : workUnitList) { |
|  |  | u.writeToStream(out); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | static String readUTFOrNull(DataInputStream in) throws IOException { |
|  |  | if (in.readBoolean()) { |
|  |  | return in.readUTF(); |
|  |  | } |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | static void writeUTFOrNull(String s, DataOutputStream out) throws IOException { |
|  |  | out.writeBoolean(s != null); |
|  |  | if (s != null) { |
|  |  | out.writeUTF(s); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Set the work bundle id |
|  |  | \* |
| Expand Down  Expand Up | | @@ -204,8 +279,13 @@ public Iterator<WorkUnit> getWorkUnitIterator() { |
|  |  | \* |
|  |  | \* @param workUnit the workUnit to add |
|  |  | \* @return number of WorkUnits in list after add |
|  |  | \* @throws IllegalStateException if adding the unit would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | public int addWorkUnit(WorkUnit workUnit) { |
|  |  | if (workUnitList.size() >= MAX\_UNITS) { |
|  |  | throw new IllegalStateException("WorkBundle may not contain more than " + MAX\_UNITS + " WorkUnits."); |
|  |  | } |
|  |  | workUnitList.add(workUnit); |
|  |  | return size(); |
|  |  | } |
| Expand All | | @@ -215,10 +295,14 @@ public int addWorkUnit(WorkUnit workUnit) { |
|  |  | \* |
|  |  | \* @param workUnit the workUnit to add |
|  |  | \* @param fileModificationTimeInMillis the file modification time in milliseconds since epoch |
|  |  | \* @param fileSize the size of the file added. |
|  |  | \* @throws IllegalStateException if adding the unit would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \* @return number of files in this set after update |
|  |  | \*/ |
|  |  | public int addWorkUnit(WorkUnit workUnit, long fileModificationTimeInMillis, long fileSize) { |
|  |  | workUnitList.add(workUnit); |
|  |  | addWorkUnit(workUnit); |
|  |  |  |
|  |  | if (fileModificationTimeInMillis < oldestFileModificationTime) { |
|  |  | oldestFileModificationTime = fileModificationTimeInMillis; |
|  |  | } |
| Expand All | | @@ -231,8 +315,16 @@ public int addWorkUnit(WorkUnit workUnit, long fileModificationTimeInMillis, lon |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Add from a list, without adjusting file modification time tracking. |
|  |  | \* |
|  |  | \* @param list a list of WorkUnits to add to this bundle |
|  |  | \* @return the total size of WorkUnits in this bundle |
|  |  | \* @throws IllegalStateException if adding the units would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | protected int addWorkUnits(List<WorkUnit> list) { // This appears to only be used by unit tests and the copy constructor |
|  |  | if (workUnitList.size() + list.size() > MAX\_UNITS) { |
|  |  | throw new IllegalStateException("WorkBundle may not contain more than " + MAX\_UNITS + " WorkUnits."); |
|  |  | } |
|  |  | workUnitList.addAll(list); |
|  |  | return workUnitList.size(); |
|  |  | } |
| Expand Down  Expand Up | | @@ -265,18 +357,22 @@ public Iterator<String> getFileNameIterator() { |
|  |  | \* |
|  |  | \* @param file string file name consistent with outputRoot |
|  |  | \* @return number of files in this set after update |
|  |  | \* @throws IllegalStateException if adding the file would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | public int addFileName(String file) { |
|  |  | workUnitList.add(new WorkUnit(file)); |
|  |  | return size(); |
|  |  | return addWorkUnit(new WorkUnit(file)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Add a file to the list |
|  |  | \* |
|  |  | \* @param file string file name consistent with outputRoot |
|  |  | \* @param fileModificationTimeInMillis the file modification time in milliseconds since epoch |
|  |  | \* @param fileSize the size of the file being added |
|  |  | \* @return number of files in this set after update |
|  |  | \* @throws IllegalStateException if adding the file would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | public int addFileName(String file, long fileModificationTimeInMillis, long fileSize) { |
|  |  | return addWorkUnit(new WorkUnit(file), fileModificationTimeInMillis, fileSize); |
| Expand All | | @@ -287,21 +383,27 @@ public int addFileName(String file, long fileModificationTimeInMillis, long file |
|  |  | \* |
|  |  | \* @param file string file names consistent with outputRoot |
|  |  | \* @return number of files in this set after update |
|  |  | \* @throws IllegalStateException if adding the files would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | protected int addFileNames(String[] file) { // This appears to only be used by unit tests |
|  |  | for (int i = 0; file != null && i < file.length; i++) { |
|  |  | workUnitList.add(new WorkUnit(file[i])); |
|  |  | for (String f : file) { |
|  |  | addWorkUnit(new WorkUnit(f)); |
|  |  | } |
|  |  | return size(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Add from a list, without adjusting file modification time tracking. |
|  |  | \* |
|  |  | \* @param list the list of files to add |
|  |  | \* @throws IllegalStateException if adding the files would cause the bundle to contain more than <code>MAX\_UNITS</code> |
|  |  | \* work units |
|  |  | \*/ |
|  |  | protected int addFileNames(List<String> list) { // This appears to only be used by unit tests and the copy |
|  |  | // constructor |
|  |  | for (String file : list) { |
|  |  | workUnitList.add(new WorkUnit(file)); |
|  |  | addWorkUnit(new WorkUnit(file)); |
|  |  | } |
|  |  | return size(); |
|  |  | } |
| Expand Down | |  |

22 changes: 21 additions & 1 deletion

22
[src/main/java/emissary/pickup/WorkUnit.java](#diff-04cbda5489a675959876ab3997c04cb118a99e95fc006527ad0021dd4ba084b5 "src/main/java/emissary/pickup/WorkUnit.java")

Show comments

[View file](/NationalSecurityAgency/emissary/blob/40260b1ec1f76cc92361702cc14fa1e4388e19d7/src/main/java/emissary/pickup/WorkUnit.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,10 +1,14 @@ |
|  |  | package emissary.pickup; |
|  |  |  |
|  |  | import java.io.DataInputStream; |
|  |  | import java.io.DataOutputStream; |
|  |  | import java.io.IOException; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* A WorkUnit is a unit of work a worker will process. The idea is to replace fileNameList. Currently, WorkBundle is set |
|  |  | \* to only have one file, and so there will only be one WorkUnit. |
|  |  | \*/ |
|  |  | public class WorkUnit { |
|  |  | public final class WorkUnit { |
|  |  | private String fileName; |
|  |  | private String transactionId; |
|  |  | // worker updates this boolean |
| Expand Down  Expand Up | | @@ -36,6 +40,22 @@ public class WorkUnit { |
|  |  | this.failedToProcess = failedToProcess; |
|  |  | } |
|  |  |  |
|  |  | public static WorkUnit readFromStream(DataInputStream in) throws IOException { |
|  |  | final WorkUnit u = new WorkUnit(null); |
|  |  | u.fileName = WorkBundle.readUTFOrNull(in); |
|  |  | u.transactionId = WorkBundle.readUTFOrNull(in); |
|  |  | u.failedToParse = in.readBoolean(); |
|  |  | u.failedToProcess = in.readBoolean(); |
|  |  | return u; |
|  |  | } |
|  |  |  |
|  |  | public void writeToStream(DataOutputStream out) throws IOException { |
|  |  | WorkBundle.writeUTFOrNull(fileName, out); |
|  |  | WorkBundle.writeUTFOrNull(transactionId, out); |
|  |  | out.writeBoolean(failedToParse); |
|  |  | out.writeBoolean(failedToProcess); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Gets the filename for the WorkUnit |
|  |  | \* |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `40260b1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNationalSecurityAgency%2Femissary%2Fcommit%2F40260b1ec1f76cc92361702cc14fa1e4388e19d7) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


