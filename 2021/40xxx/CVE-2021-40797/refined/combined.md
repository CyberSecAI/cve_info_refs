=== Content from security.openstack.org_bd8156d5_20250114_193238.html ===


Toggle navigation

 Search

* [Software](https://www.openstack.org/software/)
  + [Overview](https://www.openstack.org/software/)
  + [OpenStack Components](https://www.openstack.org/software/project-navigator/openstack-components)
  + [SDKs](https://www.openstack.org/software/project-navigator/sdks)
  + [Deployment Tools](https://www.openstack.org/software/project-navigator/deployment-tools)
  + [OpenStack Map](https://www.openstack.org/assets/software/projectmap/openstack-map.pdf)
  + [Sample Configs](https://www.openstack.org/software/sample-configs/)
* [Use Cases](https://www.openstack.org/use-cases/)
  + [Users in Production](https://www.openstack.org/use-cases/)
  + [Ironic Bare Metal](https://www.openstack.org/use-cases/bare-metal/)
  + [Edge Computing](https://www.openstack.org/use-cases/edge-computing/)
  + [Telecom & NFV](https://www.openstack.org/use-cases/telecoms-and-nfv/)
  + [Science and HPC](https://www.openstack.org/use-cases/science/)
  + [Containers](https://www.openstack.org/use-cases/containers/)
  + [Enterprise](https://www.openstack.org/use-cases/enterprise/)
  + [User Survey](https://www.openstack.org/surveys/landing)
* [Events](https://openinfra.dev/summit)
  + [OpenInfra Summit](https://openinfra.dev/summit)
  + [Project Teams Gathering](https://www.openstack.org/ptg/)
  + [OpenDev](https://www.openstack.org/events/opendev-2020/)
  + [Community Events](https://www.openstack.org/events/community-events/)
  + [OpenStack & OpenInfra Days](https://www.openstack.org/events/openstackdays)
  + [Summit Videos](https://www.openstack.org/videos/)
* [Community](https://www.openstack.org/community/)
  + [Welcome! Start Here](https://www.openstack.org/community/)
  + [OpenStack Technical Committee](https://www.openstack.org/community/tech-committee)
  + [Speakers Bureau](https://www.openstack.org/community/speakers/)
  + [OpenStack Wiki](http://wiki.openstack.org)
  + [Get Certified (COA)](https://www.openstack.org/coa/)
  + [Jobs](https://www.openstack.org/community/jobs/)
  + [Marketing Resources](https://www.openstack.org/marketing/)
  + [Community News](https://www.openstack.org/news/)
  + [Superuser Magazine](http://superuser.openstack.org)
  + [OpenInfra Foundation Supporting Organizations](https://www.openstack.org/community/supporting-organizations/)
  + [OpenInfra Foundation](https://openinfra.dev)
* [Marketplace](https://www.openstack.org/marketplace/)
  + [Training](https://www.openstack.org/marketplace/training/)
  + [Distros & Appliances](https://www.openstack.org/marketplace/distros/)
  + [Public Clouds](https://www.openstack.org/marketplace/public-clouds/)
  + [Hosted Private Clouds](https://www.openstack.org/marketplace/hosted-private-clouds/)
  + [Remotely Managed Private Clouds](https://www.openstack.org/marketplace/remotely-managed-private-clouds/)
  + [Consulting & Integrators](https://www.openstack.org/marketplace/consulting/)
  + [Drivers](https://www.openstack.org/marketplace/drivers/)
* [Blog](https://www.openstack.org/blog/)
* [Docs](http://docs.openstack.org/)
* [Join](https://openinfra.dev/join/)
  + [Sign up for Foundation Membership](https://openinfra.dev/join/)
  + [Sponsor the Foundation](https://openinfra.dev/join/)
  + [More about the Foundation](https://openinfra.dev)
* [Log In](https://www.openstack.org/Security/login/?BackURL=/home/)

# OSSA-2021-006: Routes middleware memory leak for nonexistent controllers

# OSSA-2021-006: Routes middleware memory leak for nonexistent controllers[Â¶](#ossa-2021-006-routes-middleware-memory-leak-for-nonexistent-controllers "Link to this heading")

Date:

September 09, 2021

CVE:

CVE-2021-40797

## Affects[Â¶](#affects "Link to this heading")

* Neutron: <16.4.1, >=17.0.0 <17.2.1, >=18.0.0 <18.1.1

## Description[Â¶](#description "Link to this heading")

Slawek Kaplonski with Red Hat reported a vulnerability in Neutronâs routes middleware. By making API requests involving nonexistent controllers, an authenticated user may cause the API worker to consume increasing amounts of memory, resulting in API performance degradation or denial of service. All Neutron deployments are affected.

## Patches[Â¶](#patches "Link to this heading")

* <https://review.opendev.org/807638> (Queens)
* <https://review.opendev.org/807637> (Rocky)
* <https://review.opendev.org/807636> (Stein)
* <https://review.opendev.org/807635> (Train)
* <https://review.opendev.org/807634> (Ussuri)
* <https://review.opendev.org/807633> (Victoria)
* <https://review.opendev.org/807632> (Wallaby)
* <https://review.opendev.org/807335> (Xena)

## Credits[Â¶](#credits "Link to this heading")

* Slawek Kaplonski from Red Hat (CVE-2021-40797)

## References[Â¶](#references "Link to this heading")

* <https://launchpad.net/bugs/1942179>
* <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40797>

## Notes[Â¶](#notes "Link to this heading")

* The stable/train, stable/stein, stable/rocky, and stable/queens
  branches are under extended maintenance and will receive no new point
  releases, but patches for them are provided as a courtesy.

this page last updated: 2025-01-07 18:17:35

[![Creative Commons Attribution 3.0 License](../_static/images/docs/license.png)](https://creativecommons.org/licenses/by/3.0/)

Except where otherwise noted, this document is licensed under
[Creative Commons
Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/). See all [OpenStack Legal Documents](https://www.openstack.org/legal).

found an error? report a bug

OpenStack Documentation

* Guides
* [Install Guides](https://docs.openstack.org/index.html#install-guides)
* [User Guides](https://docs.openstack.org/index.html#user-guides)
* [Configuration Guides](https://docs.openstack.org/index.html#configuration-guides)
* [Operations and Administration Guides](https://docs.openstack.org/index.html#ops-and-admin-guides)
* [API Guides](https://docs.openstack.org/index.html#api-guides)
* [Contributor Guides](https://docs.openstack.org/index.html#contributor-guides)
* Languages
* [Deutsch (German)](https://docs.openstack.org/de/)
* [FranÃ§ais (French)](https://docs.openstack.org/fr/)
* [Bahasa Indonesia (Indonesian)](https://docs.openstack.org/id/)
* [Italiano (Italian)](https://docs.openstack.org/it/)
* [æ¥æ¬èª (Japanese)](https://docs.openstack.org/ja/)
* [íêµ­ì´ (Korean)](https://docs.openstack.org/ko_KR/)
* [PortuguÃªs (Portuguese)](https://docs.openstack.org/pt_BR/)
* [TÃ¼rkÃ§e (TÃ¼rkiye)](https://docs.openstack.org/tr_TR/)
* [ç®ä½ä¸­æ (Simplified Chinese)](https://docs.openstack.org/zh_CN/)

#### Contents

* OSSA-2021-006: Routes middleware memory leak for nonexistent controllers
  + [Affects](#affects)
  + [Description](#description)
  + [Patches](#patches)
  + [Credits](#credits)
  + [References](#references)
  + [Notes](#notes)

### OpenStack

* [Projects](https://www.openstack.org/software/project-navigator/)
* [OpenStack Security](https://security.openstack.org/)
* [Blog](https://openstack.org/blog/)
* [News](https://openstack.org/news/)

### Community

* [User Groups](https://www.meetup.com/pro/openinfradev/)
* [Events](https://openstack.org/community/events/)
* [Jobs](https://openstack.org/community/jobs/)
* [Companies](https://openinfra.dev/members/)
* [Contribute](https://docs.openstack.org/contributors)

### Documentation

* [OpenStack Manuals](https://docs.openstack.org)
* [Getting Started](https://openstack.org/software/start/)
* [API Documentation](https://developer.openstack.org)
* [Wiki](https://wiki.openstack.org)

### Branding & Legal

* [Legal Docs](https://openinfra.dev/legal)
* [Logos & Guidelines](https://openstack.org/brand/)
* [Trademark Policy](https://openinfra.dev/legal/trademark-policy)
* [Privacy Policy](https://openinfra.dev/privacy-policy)
* [OpenInfra CLA](https://docs.openstack.org/contributors/common/setup-gerrit.html#individual-contributor-license-agreement)

### Stay In Touch

The OpenStack project is provided under the
[Apache 2.0 license](https://www.apache.org/licenses/LICENSE-2.0). Docs.openstack.org is powered by
[Rackspace Cloud Computing](https://rackspace.com).



=== Content from www.openwall.com_a13af13c_20250114_193233.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](../../../2021/09/11/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20210909141609.tiluhoctwxabsu6g@yuggoth.org>
Date: Thu, 9 Sep 2021 14:16:09 +0000
From: Jeremy Stanley <fungi@...goth.org>
To: oss-security@...ts.openwall.com
Subject: [OSSA-2021-006] Neutron: Routes middleware memory leak for
 nonexistent controllers (CVE-2021-40797)

========================================================================
OSSA-2021-006: Routes middleware memory leak for nonexistent controllers
========================================================================

:Date: September 09, 2021
:CVE: CVE-2021-40797

Affects
~~~~~~~
- Neutron: <16.4.1, >=17.0.0 <17.2.1, >=18.0.0 <18.1.1

Description
~~~~~~~~~~~
Slawek Kaplonski with Red Hat reported a vulnerability in Neutron's
routes middleware. By making API requests involving nonexistent
controllers, an authenticated user may cause the API worker to
consume increasing amounts of memory, resulting in API performance
degradation or denial of service. All Neutron deployments are
affected.

Patches
~~~~~~~
- <https://review.opendev.org/807638> (Queens)
- <https://review.opendev.org/807637> (Rocky)
- <https://review.opendev.org/807636> (Stein)
- <https://review.opendev.org/807635> (Train)
- <https://review.opendev.org/807634> (Ussuri)
- <https://review.opendev.org/807633> (Victoria)
- <https://review.opendev.org/807632> (Wallaby)
- <https://review.opendev.org/807335> (Xena)

Credits
~~~~~~~
- Slawek Kaplonski from Red Hat (CVE-2021-40797)

References
~~~~~~~~~~
- <https://launchpad.net/bugs/1942179>
- <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40797>

Notes
~~~~~
- The stable/train, stable/stein, stable/rocky, and stable/queens
  branches are under extended maintenance and will receive no new
  point releases, but patches for them are provided as a courtesy.

--
Jeremy Stanley

Download attachment "[signature.asc](2/1)" of type "application/pgp-signature" (964 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from launchpad.net_a3c3d702_20250114_193237.html ===

[Log in / Register](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Blogin)

[![](https://launchpadlibrarian.net/337040413/OpenStack_Project_Neutron_mascot_64x64.png)](https://launchpad.net/neutron)

## [neutron](https://launchpad.net/neutron)

* [Overview](https://launchpad.net/neutron)
* [Code](https://code.launchpad.net/neutron)
* [Bugs](https://bugs.launchpad.net/neutron)
* [Blueprints](https://blueprints.launchpad.net/neutron)
* [Translations](https://translations.launchpad.net/neutron)
* [Answers](https://answers.launchpad.net/neutron)

# [OSSA-2021-006] Routes middleware memory leak for nonexistent controllers (CVE-2021-40797)

Bug #1942179 reported by
[Slawek Kaplonski](https://launchpad.net/~slaweq)
on 2021-08-31

[264](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Medium | Unassigned |  |
|  | [neutron](https://bugs.launchpad.net/neutron) | Fix Released | Critical | Unassigned |  |

### Bug Description

Authorized cloud user may do API requests to neutron to not existing endpoints, like e.g.:

curl -g -i -X GET <http://10.120.0.30:9696/v2.0/blabla> -H "Accept: application/json" -H "User-Agent: openstacksdk/0.59.0 keystoneauth1/4.3.1 python-requests/2.26.0 CPython/3.6.8" -H "X-Auth-Token: $token"

and each such request will increase memory consumption of the neutron-api worker process.

What I did was:

\* start neutron server with just one api worker (easier to calculate memory consumption but it would be the same leak in case of more workers too). Memory consumption was:

sudo pmap 212436 | tail -n 1

 total 183736K

\* now run command like:

$ i=1; while [ $i -lt 2000 ]; do echo "Request $i"; curl -g -i -X GET <http://10.120.0.30:9696/v2.0/blabla> -H "Accept: application/json" -H "User-Agent: openstacksdk/0.59.0 keystoneauth1/4.3.1 python-requests/2.26.0 CPython/3.6.8" -H "X-Auth-Token: $token" 2>1 >/dev/null; i=$(( i+1 )); sleep 0.01; done

\* check memory consumption of the same api worker now:

sudo pmap 212436 | tail -n 1

 total 457896K

See [original description](comments/0)

Tags:

[api](/neutron/%2Bbugs?field.tag=api)
[in-stable-queens](/neutron/%2Bbugs?field.tag=in-stable-queens)
[in-stable-rocky](/neutron/%2Bbugs?field.tag=in-stable-rocky)
[in-stable-stein](/neutron/%2Bbugs?field.tag=in-stable-stein)
[in-stable-train](/neutron/%2Bbugs?field.tag=in-stable-train)
[in-stable-ussuri](/neutron/%2Bbugs?field.tag=in-stable-ussuri)
[in-stable-victoria](/neutron/%2Bbugs?field.tag=in-stable-victoria)
[in-stable-wallaby](/neutron/%2Bbugs?field.tag=in-stable-wallaby)

## CVE References

* [2021-40797](/bugs/cve/2021-40797 "An issue was discovered in the routes...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-08-31: |  |  | [#1](/neutron/%2Bbug/1942179/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete

security advisory task has been added while the core security

reviewers for the affected project or projects confirm the bug and

discuss the scope of any vulnerability along with potential

solutions.

Since this report concerns a possible security risk, an incomplete
security advisory task has been added while the core security
reviewers for the affected project or projects confirm the bug and
discuss the scope of any vulnerability along with potential
solutions.

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-08-31: |  |  | [#2](/neutron/%2Bbug/1942179/comments/2) |
| --- | --- | --- | --- |

This seems like it could represent a fairly quick means of memory consumption on servers where the API worker is running. I guess the impact is service degredation (as it starts to thrash swapspace) and eventually denial of service for the API once the kernel OOM killer gets involved and takes down the Python process?

This seems like it could represent a fairly quick means of memory consumption on servers where the API worker is running. I guess the impact is service degredation (as it starts to thrash swapspace) and eventually denial of service for the API once the kernel OOM killer gets involved and takes down the Python process?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq) wrote on 2021-08-31: |  |  | [#3](/neutron/%2Bbug/1942179/comments/3) |
| --- | --- | --- | --- |

@fungi - yes, it looks like that for me too. We are still investigating this issue with Rodolfo

@fungi - yes, it looks like that for me too. We are still investigating this issue with Rodolfo

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq) wrote on 2021-09-02: |  |  | [#4](/neutron/%2Bbug/1942179/comments/4) |
| --- | --- | --- | --- |

* [0001-Don-t-use-singleton-in-routes.middleware.RoutesMiddl.patch](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Battachment/5522478/%2Bfiles/0001-Don-t-use-singleton-in-routes.middleware.RoutesMiddl.patch)
  [Edit](/neutron/%2Bbug/1942179/%2Battachment/5522478)
  (1.9 KiB,
  text/plain)

After long investigation with Rodolfo on that issue, there is finally proposed fix/workaround for that memory leak in Neutron.

After long investigation with Rodolfo on that issue, there is finally proposed fix/workaround for that memory leak in Neutron.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rodolfo Alonso (rodolfo-alonso-hernandez)](https://launchpad.net/~rodolfo-alonso-hernandez) wrote on 2021-09-02: |  |  | [#5](/neutron/%2Bbug/1942179/comments/5) |
| --- | --- | --- | --- |

Hello:

Slawek found the place where Neutron was leaking memory. This is in the "routes.middleware.RoutesMiddleware" object. When using "singleton=True" (default value), a routes.\_RequestConfig() is always created [1]. This object has a thread safe variable to store the context information for each request.

The problem is that we use evenlet and we monkey patch the "threading" module (among many other ones) at the beginning of the Neutron server. The equivalent to "threading.local()" [1] is "eventlet.corolocal.local()". This object stores the greenthread-safe parameters in a WeakKeyDictionary() located in "eventlet.corolocal.local().\_local\_\_greens".

The problem we see is that this dictionary is not released. The patch provided in the next comment fixes this issue (this is just for testing, this patch could not land "routes" repository).

However, I think this is over engineering. The patch proposed by Slawek, using "singleton-=False" is a valid solution when using greenthreads.

Regards.

[1]<https://github.com/bbangert/routes/blob/c4d5a5fb693ce8dc7cf5dbc591861acfc49d5c23/routes/middleware.py#L98>

[2]<https://github.com/bbangert/routes/blob/c4d5a5fb693ce8dc7cf5dbc591861acfc49d5c23/routes/__init__.py#L12>

Hello:
Slawek found the place where Neutron was leaking memory. This is in the "routes.middleware.RoutesMiddleware" object. When using "singleton=True" (default value), a routes.\_RequestConfig() is always created [1]. This object has a thread safe variable to store the context information for each request.
The problem is that we use evenlet and we monkey patch the "threading" module (among many other ones) at the beginning of the Neutron server. The equivalent to "threading.local()" [1] is "eventlet.corolocal.local()". This object stores the greenthread-safe parameters in a WeakKeyDictionary() located in "eventlet.corolocal.local().\_local\_\_greens".
The problem we see is that this dictionary is not released. The patch provided in the next comment fixes this issue (this is just for testing, this patch could not land "routes" repository).
However, I think this is over engineering. The patch proposed by Slawek, using "singleton-=False" is a valid solution when using greenthreads.
Regards.
[1]https://github.com/bbangert/routes/blob/c4d5a5fb693ce8dc7cf5dbc591861acfc49d5c23/routes/middleware.py#L98
[2]https://github.com/bbangert/routes/blob/c4d5a5fb693ce8dc7cf5dbc591861acfc49d5c23/routes/\_\_init\_\_.py#L12

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rodolfo Alonso (rodolfo-alonso-hernandez)](https://launchpad.net/~rodolfo-alonso-hernandez) wrote on 2021-09-02: |  |  | [#6](/neutron/%2Bbug/1942179/comments/6) |
| --- | --- | --- | --- |

diff --git a/routes/middleware.py b/routes/middleware.py

index 649aa25..d06fd70 100644

--- a/routes/middleware.py

+++ b/routes/middleware.py

@@ -3,10 +3,12 @@ import re

 import logging

from webob import Request

+from eventlet import greenthread

from routes.base import request\_config

 from routes.util import URLGenerator

+

 log = logging.getLogger('routes.middleware')

@@ -155,6 +157,9 @@ class RoutesMiddleware(object):

         # Wrapped in try as in rare cases the attribute will be gone already

         try:

             del self.mapper.environ

+ if self.singleton:

+ cur = greenthread.getcurrent()

+ del config.\_RequestConfig\_\_shared\_state.\_local\_\_greens[cur]

         except AttributeError:

             pass

         return response

diff --git a/routes/middleware.py b/routes/middleware.py
index 649aa25..d06fd70 100644
--- a/routes/middleware.py
+++ b/routes/middleware.py
@@ -3,10 +3,12 @@ import re
import logging
from webob import Request
+from eventlet import greenthread
from routes.base import request\_config
from routes.util import URLGenerator
+
log = logging.getLogger('routes.middleware')
@@ -155,6 +157,9 @@ class RoutesMiddleware(object):
# Wrapped in try as in rare cases the attribute will be gone already
try:
del self.mapper.environ
+ if self.singleton:
+ cur = greenthread.getcurrent()
+ del config.\_RequestConfig\_\_shared\_state.\_local\_\_greens[cur]
except AttributeError:
pass
return response

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq) wrote on 2021-09-02: |  |  | [#7](/neutron/%2Bbug/1942179/comments/7) |
| --- | --- | --- | --- |

I'm not sure if we should make it public now, or should we treat it as private for now? I can propose fixes to stable branches here, that's not a problem at all but I think we should move on with that issue into some direction :)

I'm not sure if we should make it public now, or should we treat it as private for now? I can propose fixes to stable branches here, that's not a problem at all but I think we should move on with that issue into some direction :)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-09-02: |  |  | [#8](/neutron/%2Bbug/1942179/comments/8) |
| --- | --- | --- | --- |

This risk is only exploitable by authenticated users, right? With the worst impact from it being service degradation/denial of service, operators should be able to fairly quickly identify and revoke the malicious account. Given that, I think continuing to work this one in public would be a reasonable choice.

This risk is only exploitable by authenticated users, right? With the worst impact from it being service degradation/denial of service, operators should be able to fairly quickly identify and revoke the malicious account. Given that, I think continuing to work this one in public would be a reasonable choice.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lajos Katona (lajos-katona)](https://launchpad.net/~lajos-katona) wrote on 2021-09-03: |  |  | [#9](/neutron/%2Bbug/1942179/comments/9) |
| --- | --- | --- | --- |

I agree, let's make and fix it publicly.

I agree, let's make and fix it publicly.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-09-03: |  |  | [#10](/neutron/%2Bbug/1942179/comments/10) |
| --- | --- | --- | --- |

I checked with Rodoldo via IRC and he's okay with switching to our public security workflow for this, so I'll do that now.

I checked with Rodoldo via IRC and he's okay with switching to our public security workflow for this, so I'll do that now.

| **description**: | updated |
| --- | --- |
| **information type**: | Private Security → Public Security |
| Changed in ossa: | |
| **status**: | Incomplete → Confirmed |
| **importance**: | Undecided → Medium |
| **assignee**: | nobody → Jeremy Stanley (fungi) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-03:  [**Fix proposed to neutron (master)**](/neutron/%2Bbug/1942179/comments/11) |  |  | [#11](/neutron/%2Bbug/1942179/comments/11) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/neutron/+/807335](https://review.opendev.org/c/openstack/neutron/%2B/807335)

Fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/neutron/+/807335

| Changed in neutron: | |
| --- | --- |
| **status**: | New → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (master)**](/neutron/%2Bbug/1942179/comments/12) |  |  | [#12](/neutron/%2Bbug/1942179/comments/12) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807335](https://review.opendev.org/c/openstack/neutron/%2B/807335)

Committed: <https://opendev.org/openstack/neutron/commit/e610a5eb9e71aa2549fb11e2139370d227787da2>

Submitter: "Zuul (22348)"

Branch: master

commit e610a5eb9e71aa2549fb11e2139370d227787da2

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807335
Committed: https://opendev.org/openstack/neutron/commit/e610a5eb9e71aa2549fb11e2139370d227787da2
Submitter: "Zuul (22348)"
Branch: master
commit e610a5eb9e71aa2549fb11e2139370d227787da2
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

| Changed in neutron: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/wallaby)**](/neutron/%2Bbug/1942179/comments/13) |  |  | [#13](/neutron/%2Bbug/1942179/comments/13) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/wallaby

Review: [https://review.opendev.org/c/openstack/neutron/+/807632](https://review.opendev.org/c/openstack/neutron/%2B/807632)

Fix proposed to branch: stable/wallaby
Review: https://review.opendev.org/c/openstack/neutron/+/807632

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/victoria)**](/neutron/%2Bbug/1942179/comments/14) |  |  | [#14](/neutron/%2Bbug/1942179/comments/14) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/victoria

Review: [https://review.opendev.org/c/openstack/neutron/+/807633](https://review.opendev.org/c/openstack/neutron/%2B/807633)

Fix proposed to branch: stable/victoria
Review: https://review.opendev.org/c/openstack/neutron/+/807633

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/ussuri)**](/neutron/%2Bbug/1942179/comments/15) |  |  | [#15](/neutron/%2Bbug/1942179/comments/15) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: [https://review.opendev.org/c/openstack/neutron/+/807634](https://review.opendev.org/c/openstack/neutron/%2B/807634)

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/c/openstack/neutron/+/807634

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/train)**](/neutron/%2Bbug/1942179/comments/16) |  |  | [#16](/neutron/%2Bbug/1942179/comments/16) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/train

Review: [https://review.opendev.org/c/openstack/neutron/+/807635](https://review.opendev.org/c/openstack/neutron/%2B/807635)

Fix proposed to branch: stable/train
Review: https://review.opendev.org/c/openstack/neutron/+/807635

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/stein)**](/neutron/%2Bbug/1942179/comments/17) |  |  | [#17](/neutron/%2Bbug/1942179/comments/17) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/stein

Review: [https://review.opendev.org/c/openstack/neutron/+/807636](https://review.opendev.org/c/openstack/neutron/%2B/807636)

Fix proposed to branch: stable/stein
Review: https://review.opendev.org/c/openstack/neutron/+/807636

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/rocky)**](/neutron/%2Bbug/1942179/comments/18) |  |  | [#18](/neutron/%2Bbug/1942179/comments/18) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/rocky

Review: [https://review.opendev.org/c/openstack/neutron/+/807637](https://review.opendev.org/c/openstack/neutron/%2B/807637)

Fix proposed to branch: stable/rocky
Review: https://review.opendev.org/c/openstack/neutron/+/807637

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix proposed to neutron (stable/queens)**](/neutron/%2Bbug/1942179/comments/19) |  |  | [#19](/neutron/%2Bbug/1942179/comments/19) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/queens

Review: [https://review.opendev.org/c/openstack/neutron/+/807638](https://review.opendev.org/c/openstack/neutron/%2B/807638)

Fix proposed to branch: stable/queens
Review: https://review.opendev.org/c/openstack/neutron/+/807638

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/wallaby)**](/neutron/%2Bbug/1942179/comments/20) |  |  | [#20](/neutron/%2Bbug/1942179/comments/20) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807632](https://review.opendev.org/c/openstack/neutron/%2B/807632)

Committed: <https://opendev.org/openstack/neutron/commit/c5e86f4f8f7e36233f383323e24e72dbe28efc04>

Submitter: "Zuul (22348)"

Branch: stable/wallaby

commit c5e86f4f8f7e36233f383323e24e72dbe28efc04

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807632
Committed: https://opendev.org/openstack/neutron/commit/c5e86f4f8f7e36233f383323e24e72dbe28efc04
Submitter: "Zuul (22348)"
Branch: stable/wallaby
commit c5e86f4f8f7e36233f383323e24e72dbe28efc04
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-wallaby |
| --- | --- |
| **tags**: | added: in-stable-victoria |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/victoria)**](/neutron/%2Bbug/1942179/comments/21) |  |  | [#21](/neutron/%2Bbug/1942179/comments/21) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807633](https://review.opendev.org/c/openstack/neutron/%2B/807633)

Committed: <https://opendev.org/openstack/neutron/commit/d961731a73128125ebf03fae52b4b34f3e7abf27>

Submitter: "Zuul (22348)"

Branch: stable/victoria

commit d961731a73128125ebf03fae52b4b34f3e7abf27

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807633
Committed: https://opendev.org/openstack/neutron/commit/d961731a73128125ebf03fae52b4b34f3e7abf27
Submitter: "Zuul (22348)"
Branch: stable/victoria
commit d961731a73128125ebf03fae52b4b34f3e7abf27
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/ussuri)**](/neutron/%2Bbug/1942179/comments/22) |  |  | [#22](/neutron/%2Bbug/1942179/comments/22) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807634](https://review.opendev.org/c/openstack/neutron/%2B/807634)

Committed: <https://opendev.org/openstack/neutron/commit/2f642e23e085aa0bd5a23b4b169b436da9ad455c>

Submitter: "Zuul (22348)"

Branch: stable/ussuri

commit 2f642e23e085aa0bd5a23b4b169b436da9ad455c

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807634
Committed: https://opendev.org/openstack/neutron/commit/2f642e23e085aa0bd5a23b4b169b436da9ad455c
Submitter: "Zuul (22348)"
Branch: stable/ussuri
commit 2f642e23e085aa0bd5a23b4b169b436da9ad455c
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-ussuri |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/rocky)**](/neutron/%2Bbug/1942179/comments/23) |  |  | [#23](/neutron/%2Bbug/1942179/comments/23) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807637](https://review.opendev.org/c/openstack/neutron/%2B/807637)

Committed: <https://opendev.org/openstack/neutron/commit/6d773bb8b84b496a71e4ee6c879af967aa031e98>

Submitter: "Zuul (22348)"

Branch: stable/rocky

commit 6d773bb8b84b496a71e4ee6c879af967aa031e98

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807637
Committed: https://opendev.org/openstack/neutron/commit/6d773bb8b84b496a71e4ee6c879af967aa031e98
Submitter: "Zuul (22348)"
Branch: stable/rocky
commit 6d773bb8b84b496a71e4ee6c879af967aa031e98
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-rocky |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-09-07:  [**Re: neutron api worker leaks memory when processing requests to not existing controllers**](/neutron/%2Bbug/1942179/comments/24) |  |  | [#24](/neutron/%2Bbug/1942179/comments/24) |
| --- | --- | --- | --- |

As fixes have merged to all of Neutron's maintained stable branches, we can (and probably should) issue an advisory for this defect. I propose we use the following impact description to request a CVE assignment from MITRE, but please let me know if this isn't entirely accurate so I can correct it:

Title: Routes middleware memory leak for nonexistent controllers

Reporter: Slawek Kaplonski (Red Hat)

Products: Neutron

Affects: <16.4.1, >=17.0.0 <17.2.1, >=18.0.0 <18.1.1

Description:

Slawek Kaplonski with Red Hat reported a vulnerability in Neutron's routes middleware. By making API requests involving nonexistent controllers, an authenticated user may cause the API worker to consume increasing amounts of memory, resulting in API performance degradation or denial of service. All Neutron deployments are affected.

As fixes have merged to all of Neutron's maintained stable branches, we can (and probably should) issue an advisory for this defect. I propose we use the following impact description to request a CVE assignment from MITRE, but please let me know if this isn't entirely accurate so I can correct it:
Title: Routes middleware memory leak for nonexistent controllers
Reporter: Slawek Kaplonski (Red Hat)
Products: Neutron
Affects: <16.4.1, >=17.0.0 <17.2.1, >=18.0.0 <18.1.1
Description:
Slawek Kaplonski with Red Hat reported a vulnerability in Neutron's routes middleware. By making API requests involving nonexistent controllers, an authenticated user may cause the API worker to consume increasing amounts of memory, resulting in API performance degradation or denial of service. All Neutron deployments are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/queens)**](/neutron/%2Bbug/1942179/comments/25) |  |  | [#25](/neutron/%2Bbug/1942179/comments/25) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807638](https://review.opendev.org/c/openstack/neutron/%2B/807638)

Committed: <https://opendev.org/openstack/neutron/commit/dfbb9bcb5dae282c575b33171d691a5fca946beb>

Submitter: "Zuul (22348)"

Branch: stable/queens

commit dfbb9bcb5dae282c575b33171d691a5fca946beb

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807638
Committed: https://opendev.org/openstack/neutron/commit/dfbb9bcb5dae282c575b33171d691a5fca946beb
Submitter: "Zuul (22348)"
Branch: stable/queens
commit dfbb9bcb5dae282c575b33171d691a5fca946beb
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-07:  [**Fix merged to neutron (stable/train)**](/neutron/%2Bbug/1942179/comments/26) |  |  | [#26](/neutron/%2Bbug/1942179/comments/26) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807635](https://review.opendev.org/c/openstack/neutron/%2B/807635)

Committed: <https://opendev.org/openstack/neutron/commit/1977a8d9ba06e2361070f8894825ca388635c043>

Submitter: "Zuul (22348)"

Branch: stable/train

commit 1977a8d9ba06e2361070f8894825ca388635c043

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807635
Committed: https://opendev.org/openstack/neutron/commit/1977a8d9ba06e2361070f8894825ca388635c043
Submitter: "Zuul (22348)"
Branch: stable/train
commit 1977a8d9ba06e2361070f8894825ca388635c043
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-train |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-08:  [**Fix merged to neutron (stable/stein)**](/neutron/%2Bbug/1942179/comments/27) |  |  | [#27](/neutron/%2Bbug/1942179/comments/27) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/807636](https://review.opendev.org/c/openstack/neutron/%2B/807636)

Committed: <https://opendev.org/openstack/neutron/commit/b08715862e360c45cc0abd8341889e37858207bb>

Submitter: "Zuul (22348)"

Branch: stable/stein

commit b08715862e360c45cc0abd8341889e37858207bb

Author: Slawek Kaplonski <email address hidden>

Date: Fri Sep 3 16:04:02 2021 +0200

Don't use singleton in routes.middleware.RoutesMiddleware

It seems that using default singleton=True in the

    routes.middleware.RoutesMiddleware which is leading to use thread-local

    RequestConfig singleton object is not working well with eventlet

    monkeypatching of threading library which we are doing in Neutron.

    As a result it leaks memory in neutron-api workers every time when API

    request to not existing API endpoint is made by user.

To avoid that memory leak, let's use singletone=False in that

    RoutesMiddleware object, at least until problem with thread-local

    singleton and eventlet monkey patching will be solved.

Closes-Bug: #1942179

    Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b

    (cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

Reviewed: https://review.opendev.org/c/openstack/neutron/+/807636
Committed: https://opendev.org/openstack/neutron/commit/b08715862e360c45cc0abd8341889e37858207bb
Submitter: "Zuul (22348)"
Branch: stable/stein
commit b08715862e360c45cc0abd8341889e37858207bb
Author: Slawek Kaplonski <skaplons@redhat.com>
Date: Fri Sep 3 16:04:02 2021 +0200
Don't use singleton in routes.middleware.RoutesMiddleware
It seems that using default singleton=True in the
routes.middleware.RoutesMiddleware which is leading to use thread-local
RequestConfig singleton object is not working well with eventlet
monkeypatching of threading library which we are doing in Neutron.
As a result it leaks memory in neutron-api workers every time when API
request to not existing API endpoint is made by user.
To avoid that memory leak, let's use singletone=False in that
RoutesMiddleware object, at least until problem with thread-local
singleton and eventlet monkey patching will be solved.
Closes-Bug: #1942179
Change-Id: Id3a529248d3984506f0166bdc32e334127a01b7b
(cherry picked from commit e610a5eb9e71aa2549fb11e2139370d227787da2)

| **tags**: | added: in-stable-stein |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-09-08:  [**Re: neutron api worker leaks memory when processing requests to not existing controllers**](/neutron/%2Bbug/1942179/comments/28) |  |  | [#28](/neutron/%2Bbug/1942179/comments/28) |
| --- | --- | --- | --- |

I checked with Slawek and Rodolfo in IRC, and they said they were good with the proposed impact description from comment #24, so I'm using that to submit a CVE request to MITRE now.

I checked with Slawek and Rodolfo in IRC, and they said they were good with the proposed impact description from comment #24, so I'm using that to submit a CVE request to MITRE now.

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2021-09-08

| **summary**: | - neutron api worker leaks memory when processing requests to not existing- controllers+ Routes middleware memory leak for nonexistent controllers+ (CVE-2021-40797) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-08:  [**Fix proposed to ossa (master)**](/neutron/%2Bbug/1942179/comments/29) |  |  | [#29](/neutron/%2Bbug/1942179/comments/29) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/ossa/+/807942](https://review.opendev.org/c/openstack/ossa/%2B/807942)

Fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/ossa/+/807942

| Changed in ossa: | |
| --- | --- |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-09:  [**Fix merged to ossa (master)**](/neutron/%2Bbug/1942179/comments/30) |  |  | [#30](/neutron/%2Bbug/1942179/comments/30) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/ossa/+/807942](https://review.opendev.org/c/openstack/ossa/%2B/807942)

Committed: <https://opendev.org/openstack/ossa/commit/4f5d81b664a81ad7ba4856fbabe1d3f1f12a14e8>

Submitter: "Zuul (22348)"

Branch: master

commit 4f5d81b664a81ad7ba4856fbabe1d3f1f12a14e8

Author: Jeremy Stanley <email address hidden>

Date: Wed Sep 8 20:15:03 2021 +0000

Add OSSA-2021-006 (CVE-2021-40797)

Change-Id: Ie61b5ffbec78e8c90e5ad773c9479f0d7ae1b932

    Closes-Bug: #1942179

Reviewed: https://review.opendev.org/c/openstack/ossa/+/807942
Committed: https://opendev.org/openstack/ossa/commit/4f5d81b664a81ad7ba4856fbabe1d3f1f12a14e8
Submitter: "Zuul (22348)"
Branch: master
commit 4f5d81b664a81ad7ba4856fbabe1d3f1f12a14e8
Author: Jeremy Stanley <fungi@yuggoth.org>
Date: Wed Sep 8 20:15:03 2021 +0000
Add OSSA-2021-006 (CVE-2021-40797)
Change-Id: Ie61b5ffbec78e8c90e5ad773c9479f0d7ae1b932
Closes-Bug: #1942179

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2021-09-09

| **summary**: | - Routes middleware memory leak for nonexistent controllers- (CVE-2021-40797)+ [OSSA-2021-006] Routes middleware memory leak for nonexistent+ controllers (CVE-2021-40797) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2021-09-09: |  |  | [#31](/neutron/%2Bbug/1942179/comments/31) |
| --- | --- | --- | --- |

Notifications have been distributed to the usual mailing lists.

Notifications have been distributed to the usual mailing lists.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-10:  [**Fix included in openstack/neutron 16.4.1**](/neutron/%2Bbug/1942179/comments/32) |  |  | [#32](/neutron/%2Bbug/1942179/comments/32) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 16.4.1 release.

This issue was fixed in the openstack/neutron 16.4.1 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-10:  [**Fix included in openstack/neutron 17.2.1**](/neutron/%2Bbug/1942179/comments/33) |  |  | [#33](/neutron/%2Bbug/1942179/comments/33) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 17.2.1 release.

This issue was fixed in the openstack/neutron 17.2.1 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-10:  [**Fix included in openstack/neutron 18.1.1**](/neutron/%2Bbug/1942179/comments/34) |  |  | [#34](/neutron/%2Bbug/1942179/comments/34) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 18.1.1 release.

This issue was fixed in the openstack/neutron 18.1.1 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-15:  [**Fix included in openstack/neutron 19.0.0.0rc1**](/neutron/%2Bbug/1942179/comments/35) |  |  | [#35](/neutron/%2Bbug/1942179/comments/35) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 19.0.0.0rc1 release candidate.

This issue was fixed in the openstack/neutron 19.0.0.0rc1 release candidate.

[Bernard Cafarelli (bcafarel)](https://launchpad.net/~bcafarel)
on 2021-11-17

| **tags**: | added: neutron-proactive-backport-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [test (bingdiancn)](https://launchpad.net/~bingdiancn) wrote on 2021-11-19 (last edit on 2021-11-19): |  |  | [#36](/neutron/%2Bbug/1942179/comments/36) |
| --- | --- | --- | --- |

sorry，i can't reproduce the bug in the neutron 17.2.0。Could you please give me any help about it?

sorry，i can't reproduce the bug in the neutron 17.2.0。Could you please give me any help about it?

[test (bingdiancn)](https://launchpad.net/~bingdiancn)
on 2021-11-19

| **summary**: | [OSSA-2021-006] Routes middleware memory leak for nonexistent- controllers (CVE-2021-40797)+ controllers (CVE-2021-40797)dsd |
| --- | --- |
| **summary**: | [OSSA-2021-006] Routes middleware memory leak for nonexistent- controllers (CVE-2021-40797)dsd+ controllers (CVE-2021-40797) |
| Changed in ossa: | |
| **assignee**: | Jeremy Stanley (fungi) → nobody |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rodolfo Alonso (rodolfo-alonso-hernandez)](https://launchpad.net/~rodolfo-alonso-hernandez) wrote on 2021-11-19: |  |  | [#38](/neutron/%2Bbug/1942179/comments/38) |
| --- | --- | --- | --- |

Hello:

Slawek provided a method to test it. Actually we tested it, checking the Neutron server memory consumption increased linearly every time we made a HTTP request.

Deploy OpenStack Neutron (without the fix, now present in all versions) and execute this (changing your server IP address):

$ i=1; while [ $i -lt 2000 ]; do echo "Request $i"; curl -g -i -X GET <http://10.120.0.30:9696/v2.0/blabla> -H "Accept: application/json" -H "User-Agent: openstacksdk/0.59.0 keystoneauth1/4.3.1 python-requests/2.26.0 CPython/3.6.8" -H "X-Auth-Token: $token" 2>1 >/dev/null; i=$(( i+1 )); sleep 0.01; done

You'll see how the Neutron server memory grows continuously.

Regards

Hello:
Slawek provided a method to test it. Actually we tested it, checking the Neutron server memory consumption increased linearly every time we made a HTTP request.
Deploy OpenStack Neutron (without the fix, now present in all versions) and execute this (changing your server IP address):
$ i=1; while [ $i -lt 2000 ]; do echo "Request $i"; curl -g -i -X GET http://10.120.0.30:9696/v2.0/blabla -H "Accept: application/json" -H "User-Agent: openstacksdk/0.59.0 keystoneauth1/4.3.1 python-requests/2.26.0 CPython/3.6.8" -H "X-Auth-Token: $token" 2>1 >/dev/null; i=$(( i+1 )); sleep 0.01; done
You'll see how the Neutron server memory grows continuously.
Regards

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [test (bingdiancn)](https://launchpad.net/~bingdiancn) wrote on 2021-11-19: |  |  | [#39](/neutron/%2Bbug/1942179/comments/39) |
| --- | --- | --- | --- |

* [reproduce.zip](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Battachment/5542140/%2Bfiles/reproduce.zip)
  [Edit](/neutron/%2Bbug/1942179/%2Battachment/5542140)
  (1.4 MiB,
  application/zip)

I deployed it by Kolla-ansible and tested it by the method.But the memory keep unchanged. The process as attached pictures below。

I deployed it by Kolla-ansible and tested it by the method.But the memory keep unchanged. The process as attached pictures below。

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq) wrote on 2021-11-22: |  |  | [#40](/neutron/%2Bbug/1942179/comments/40) |
| --- | --- | --- | --- |

Maybe You already have fix for that issue included? Did You check that?

Maybe You already have fix for that issue included? Did You check that?

[Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq)
on 2021-12-10

| **tags**: | removed: neutron-proactive-backport-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-11-18:  [**Fix included in openstack/neutron queens-eol**](/neutron/%2Bbug/1942179/comments/41) |  |  | [#41](/neutron/%2Bbug/1942179/comments/41) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron queens-eol release.

This issue was fixed in the openstack/neutron queens-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-11-18:  [**Fix included in openstack/neutron rocky-eol**](/neutron/%2Bbug/1942179/comments/42) |  |  | [#42](/neutron/%2Bbug/1942179/comments/42) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron rocky-eol release.

This issue was fixed in the openstack/neutron rocky-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-11-18:  [**Fix included in openstack/neutron stein-eol**](/neutron/%2Bbug/1942179/comments/43) |  |  | [#43](/neutron/%2Bbug/1942179/comments/43) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron stein-eol release.

This issue was fixed in the openstack/neutron stein-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-10-10:  [**Fix included in openstack/neutron train-eol**](/neutron/%2Bbug/1942179/comments/44) |  |  | [#44](/neutron/%2Bbug/1942179/comments/44) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron train-eol release.

This issue was fixed in the openstack/neutron train-eol release.

[See full activity log](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/neutron/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/neutron/%2Bbug/1942179/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-Don-t-use-singleton-in-routes.middleware.RoutesMiddl.patch](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Battachment/5522478/%2Bfiles/0001-Don-t-use-singleton-in-routes.middleware.RoutesMiddl.patch)
  [Edit](/neutron/%2Bbug/1942179/%2Battachment/5522478 "Change patch details")

* [Add patch](/neutron/%2Bbug/1942179/%2Baddcomment?field.patch=on)

## Bug attachments

* [reproduce.zip](https://bugs.launchpad.net/neutron/%2Bbug/1942179/%2Battachment/5542140/%2Bfiles/reproduce.zip)
  [Edit](/neutron/%2Bbug/1942179/%2Battachment/5542140 "Change attachment details")

* [Add attachment](/neutron/%2Bbug/1942179/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))


