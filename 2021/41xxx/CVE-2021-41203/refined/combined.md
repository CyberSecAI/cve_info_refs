=== Content from github.com_a046d55a_20250114_214918.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fe8dc63704c88007ee4713076605c90188d66f3d2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fe8dc63704c88007ee4713076605c90188d66f3d2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/e8dc63704c88007ee4713076605c90188d66f3d2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add BuildTensorSlice for building from unvalidated TensorSliceProtos.

[Browse files](/tensorflow/tensorflow/tree/e8dc63704c88007ee4713076605c90188d66f3d2)
Browse the repository at this point in the history

```
This avoids several sources of crashes and undefined behavior when loading
invalid checkpoints.

PiperOrigin-RevId: 392785704
Change-Id: Icd9713c768b882f3b58b427eddac376060696833
```

* Loading branch information

[![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Aug 25, 2021

1 parent
[dd2c199](/tensorflow/tensorflow/commit/dd2c199ce5e22b11aa6d7096b7fe313df4558fcb)

commit e8dc637

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**107 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core

  + framework

    - tensorflow/core/framework/tensor\_slice.cc
      [tensor\_slice.cc](#diff-3bed456e025498faaa55f150e7478e723a32ab600b29bb8c214629f7db5f91f3)
    - tensorflow/core/framework/tensor\_slice.h
      [tensor\_slice.h](#diff-3f1074bbe21b2e6d58b6ae563dd3223c8cdd7b1dce5188aacb6577d5b6ff9d4f)
    - tensorflow/core/framework/tensor\_slice\_test.cc
      [tensor\_slice\_test.cc](#diff-ad3cff10fe81e070a8781bf390ea91cb8923de666a071ae4262b1acbed875968)
  + util

    - tensorflow/core/util/tensor\_slice\_reader.cc
      [tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202)
    - tensorflow/core/util/tensor\_slice\_reader\_test.cc
      [tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770)

## There are no files selected for viewing

31 changes: 31 additions & 0 deletions

31
[tensorflow/core/framework/tensor\_slice.cc](#diff-3bed456e025498faaa55f150e7478e723a32ab600b29bb8c214629f7db5f91f3 "tensorflow/core/framework/tensor_slice.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/e8dc63704c88007ee4713076605c90188d66f3d2/tensorflow/core/framework/tensor_slice.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,7 +14,10 @@ limitations under the License. |
|  |  | ==============================================================================\*/ |
|  |  |  |
|  |  | #include "tensorflow/core/framework/tensor\_slice.h" |
|  |  |  |
|  |  | #include <limits> |
|  |  | #include <vector> |
|  |  |  |
|  |  | #include "tensorflow/core/lib/core/errors.h" |
|  |  | #include "tensorflow/core/lib/strings/numbers.h" |
|  |  | #include "tensorflow/core/lib/strings/str\_util.h" |
| Expand Down  Expand Up | | @@ -44,6 +47,34 @@ TensorSlice::TensorSlice( |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | Status TensorSlice::BuildTensorSlice(const TensorSliceProto& proto, |
|  |  | TensorSlice\* output) { |
|  |  | output->Clear(); |
|  |  | output->starts\_.reserve(proto.extent\_size()); |
|  |  | output->lengths\_.reserve(proto.extent\_size()); |
|  |  | for (const auto& e : proto.extent()) { |
|  |  | int64\_t l = GetExtentLength(e); |
|  |  | if (e.start() != 0 || l != kFullExtent) { |
|  |  | if (e.start() < 0 || l <= 0) { |
|  |  | return errors::InvalidArgument( |
|  |  | "Expected non-negative start and positive length but got start = ", |
|  |  | e.start(), ", length = ", l, ": extent = ", e.ShortDebugString()); |
|  |  | } |
|  |  | // Calculating the extent end must not cause signed integer overflow. |
|  |  | if (static\_cast<uint64\_t>(e.start()) + static\_cast<uint64\_t>(e.length()) > |
|  |  | std::numeric\_limits<int64\_t>::max()) { |
|  |  | return errors::InvalidArgument( |
|  |  | "Extent end exceeds the maximum possible size: extent = ", |
|  |  | e.ShortDebugString()); |
|  |  | } |
|  |  | } |
|  |  | output->starts\_.push\_back(e.start()); |
|  |  | output->lengths\_.push\_back(l); |
|  |  | } |
|  |  |  |
|  |  | return Status::OK(); |
|  |  | } |
|  |  |  |
|  |  | Status TensorSlice::Parse(const string& str, TensorSlice\* slice) { |
|  |  | std::vector<string> items = str\_util::Split(str, ':', str\_util::SkipEmpty()); |
|  |  | slice->starts\_.reserve(items.size()); |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[tensorflow/core/framework/tensor\_slice.h](#diff-3f1074bbe21b2e6d58b6ae563dd3223c8cdd7b1dce5188aacb6577d5b6ff9d4f "tensorflow/core/framework/tensor_slice.h")

Show comments

[View file](/tensorflow/tensorflow/blob/e8dc63704c88007ee4713076605c90188d66f3d2/tensorflow/core/framework/tensor_slice.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -48,6 +48,12 @@ class TensorSlice { |
|  |  | explicit TensorSlice( |
|  |  | std::initializer\_list<std::pair<int64\_t, int64\_t>> extents); |
|  |  |  |
|  |  | // This factory methods should be used instead of the constructor that takes a |
|  |  | // `TensorSliceProto` if calling code cannot validate that the sizes specify a |
|  |  | // valid `TensorSlice`. |
|  |  | static Status BuildTensorSlice(const TensorSliceProto& proto, |
|  |  | TensorSlice\* output); |
|  |  |  |
|  |  | static Status Parse(const string& str, TensorSlice\* output); |
|  |  | static TensorSlice ParseOrDie(const string& str) { |
|  |  | TensorSlice ret; |
| Expand Down | |  |

44 changes: 44 additions & 0 deletions

44
[tensorflow/core/framework/tensor\_slice\_test.cc](#diff-ad3cff10fe81e070a8781bf390ea91cb8923de666a071ae4262b1acbed875968 "tensorflow/core/framework/tensor_slice_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/e8dc63704c88007ee4713076605c90188d66f3d2/tensorflow/core/framework/tensor_slice_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,6 +15,8 @@ limitations under the License. |
|  |  |  |
|  |  | #include "tensorflow/core/framework/tensor\_slice.h" |
|  |  |  |
|  |  | #include <limits> |
|  |  |  |
|  |  | #include "tensorflow/core/lib/core/status\_test\_util.h" |
|  |  | #include "tensorflow/core/platform/logging.h" |
|  |  | #include "tensorflow/core/platform/protobuf.h" |
| Expand Down  Expand Up | | @@ -125,6 +127,48 @@ TEST(TensorSliceTest, Serialization) { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Testing `BuildTensorSlice` with valid and invalid input protos. |
|  |  | TEST(TensorSliceTest, BuildTensorSlice) { |
|  |  | TensorSliceProto proto; |
|  |  | TensorSlice({{0, -1}, {0, 10}, {14, 1}}).AsProto(&proto); |
|  |  | TensorSlice s; |
|  |  |  |
|  |  | // Successful building. |
|  |  | { |
|  |  | TF\_ASSERT\_OK(TensorSlice::BuildTensorSlice(proto, &s)); |
|  |  | EXPECT\_EQ("-:0,10:14,1", s.DebugString()); |
|  |  | } |
|  |  |  |
|  |  | // Failed building due to negative extent start. |
|  |  | { |
|  |  | TensorSliceProto invalid\_proto = proto; |
|  |  | invalid\_proto.mutable\_extent(0)->set\_start(-1); |
|  |  | EXPECT\_FALSE(TensorSlice::BuildTensorSlice(invalid\_proto, &s).ok()); |
|  |  | } |
|  |  |  |
|  |  | // Failed building due to negative extent length. |
|  |  | { |
|  |  | TensorSliceProto invalid\_proto = proto; |
|  |  | invalid\_proto.mutable\_extent(2)->set\_length(-1); |
|  |  | EXPECT\_FALSE(TensorSlice::BuildTensorSlice(invalid\_proto, &s).ok()); |
|  |  | } |
|  |  |  |
|  |  | // Failed building due to missing extent length. |
|  |  | { |
|  |  | TensorSliceProto invalid\_proto = proto; |
|  |  | invalid\_proto.mutable\_extent(2)->clear\_length(); |
|  |  | EXPECT\_FALSE(TensorSlice::BuildTensorSlice(invalid\_proto, &s).ok()); |
|  |  | } |
|  |  |  |
|  |  | // Failed building due to extent end overflowing. |
|  |  | { |
|  |  | TensorSliceProto invalid\_proto = proto; |
|  |  | invalid\_proto.mutable\_extent(2)->set\_length( |
|  |  | std::numeric\_limits<int64\_t>::max()); |
|  |  | EXPECT\_FALSE(TensorSlice::BuildTensorSlice(invalid\_proto, &s).ok()); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Testing the slice intersection |
|  |  | TEST(TensorSliceTest, Intersection) { |
|  |  | // "EVERYTHING" intersects with everything |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[tensorflow/core/util/tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202 "tensorflow/core/util/tensor_slice_reader.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/e8dc63704c88007ee4713076605c90188d66f3d2/tensorflow/core/util/tensor_slice_reader.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -172,7 +172,9 @@ void TensorSliceReader::LoadShard(int shard) const { |
|  |  | status\_ = TensorShape::BuildTensorShapeBase(ssm.shape(), &ssm\_shape); |
|  |  | if (!status\_.ok()) return; |
|  |  | for (const TensorSliceProto& tsp : ssm.slice()) { |
|  |  | TensorSlice ss\_slice(tsp); |
|  |  | TensorSlice ss\_slice; |
|  |  | status\_ = TensorSlice::BuildTensorSlice(tsp, &ss\_slice); |
|  |  | if (!status\_.ok()) return; |
|  |  | status\_ = RegisterTensorSlice(ssm.name(), ssm\_shape, ssm.type(), fname, |
|  |  | ss\_slice, &tensors\_); |
|  |  | if (!status\_.ok()) return; |
| Expand Down | |  |

23 changes: 23 additions & 0 deletions

23
[tensorflow/core/util/tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770 "tensorflow/core/util/tensor_slice_reader_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/e8dc63704c88007ee4713076605c90188d66f3d2/tensorflow/core/util/tensor_slice_reader_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -436,6 +436,29 @@ TEST(TensorSliceReaderTest, NegativeTensorShapeDimension) { |
|  |  | EXPECT\_FALSE(reader.status().ok()); |
|  |  | } |
|  |  |  |
|  |  | TEST(TensorSliceReaderTest, InvalidTensorSlice) { |
|  |  | const string fname = |
|  |  | io::JoinPath(testing::TmpDir(), "invalid\_slice\_checkpoint"); |
|  |  | TensorSliceWriter writer(fname, CreateTableTensorSliceBuilder); |
|  |  | const int32 data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; |
|  |  | TF\_CHECK\_OK(writer.Add("test", TensorShape({4, 5}), |
|  |  | TensorSlice::ParseOrDie("0,2:-"), data)); |
|  |  | TF\_CHECK\_OK(writer.Finish()); |
|  |  |  |
|  |  | MutateSavedTensorSlices(fname, [](SavedTensorSlices sts) { |
|  |  | if (sts.has\_meta()) { |
|  |  | for (auto& tensor : \*sts.mutable\_meta()->mutable\_tensor()) { |
|  |  | tensor.mutable\_slice(0)->mutable\_extent(0)->set\_length(-10); |
|  |  | } |
|  |  | } |
|  |  | return sts.SerializeAsString(); |
|  |  | }); |
|  |  |  |
|  |  | TensorSliceReader reader(fname, OpenTableTensorSliceReader); |
|  |  | // The negative exent length should cause loading to fail. |
|  |  | EXPECT\_FALSE(reader.status().ok()); |
|  |  | } |
|  |  |  |
|  |  | void CachedTensorSliceReaderTesterHelper( |
|  |  | const TensorSliceWriter::CreateBuilderFunction& create\_function, |
|  |  | const TensorSliceReader::OpenTableFunction& open\_function) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e8dc637`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fe8dc63704c88007ee4713076605c90188d66f3d2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fafc7ab8_20250114_214915.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fb619c6f865715ca3b15ef1842b5b95edbaa710ad)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fb619c6f865715ca3b15ef1842b5b95edbaa710ad)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/b619c6f865715ca3b15ef1842b5b95edbaa710ad)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Use BuildTensorShapeBase when parsing unverified TensorShapes during …

[Browse files](/tensorflow/tensorflow/tree/b619c6f865715ca3b15ef1842b5b95edbaa710ad)
Browse the repository at this point in the history

```
…checkpoint loading.

This avoids crashing when the TensorShape has negative dimensions.

PiperOrigin-RevId: 392769882
Change-Id: Id1f7ae7fcf8142193556af47abfda81b13d3cce4
```

* Loading branch information

[![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Aug 24, 2021

1 parent
[24cb834](/tensorflow/tensorflow/commit/24cb8341b3381d6fc48d134fe61716acb1134ab0)

commit b619c6f

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**29 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core/util

  + tensorflow/core/util/tensor\_slice\_reader.cc
    [tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202)
  + tensorflow/core/util/tensor\_slice\_reader\_test.cc
    [tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770)

## There are no files selected for viewing

4 changes: 3 additions & 1 deletion

4
[tensorflow/core/util/tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202 "tensorflow/core/util/tensor_slice_reader.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/b619c6f865715ca3b15ef1842b5b95edbaa710ad/tensorflow/core/util/tensor_slice_reader.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -168,7 +168,9 @@ void TensorSliceReader::LoadShard(int shard) const { |
|  |  | "checkpoint"); |
|  |  | if (!status\_.ok()) return; |
|  |  | for (const SavedSliceMeta& ssm : sts.meta().tensor()) { |
|  |  | TensorShape ssm\_shape(ssm.shape()); |
|  |  | TensorShape ssm\_shape; |
|  |  | status\_ = TensorShape::BuildTensorShapeBase(ssm.shape(), &ssm\_shape); |
|  |  | if (!status\_.ok()) return; |
|  |  | for (const TensorSliceProto& tsp : ssm.slice()) { |
|  |  | TensorSlice ss\_slice(tsp); |
|  |  | status\_ = RegisterTensorSlice(ssm.name(), ssm\_shape, ssm.type(), fname, |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[tensorflow/core/util/tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770 "tensorflow/core/util/tensor_slice_reader_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/b619c6f865715ca3b15ef1842b5b95edbaa710ad/tensorflow/core/util/tensor_slice_reader_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,6 +18,7 @@ limitations under the License. |
|  |  | #include <utility> |
|  |  | #include <vector> |
|  |  |  |
|  |  | #include "tensorflow/core/framework/tensor\_shape.pb.h" |
|  |  | #include "tensorflow/core/framework/types.h" |
|  |  | #include "tensorflow/core/framework/versions.pb.h" |
|  |  | #include "tensorflow/core/lib/core/status\_test\_util.h" |
| Expand Down  Expand Up | | @@ -410,6 +411,31 @@ TEST(TensorSliceReaderTest, UnsupportedTensorType) { |
|  |  | EXPECT\_FALSE(reader.GetTensor("test", &tensor).ok()); |
|  |  | } |
|  |  |  |
|  |  | TEST(TensorSliceReaderTest, NegativeTensorShapeDimension) { |
|  |  | const string fname = |
|  |  | io::JoinPath(testing::TmpDir(), "negative\_dim\_checkpoint"); |
|  |  | TensorSliceWriter writer(fname, CreateTableTensorSliceBuilder); |
|  |  | const int32 data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; |
|  |  | TF\_CHECK\_OK(writer.Add("test", TensorShape({4, 5}), |
|  |  | TensorSlice::ParseOrDie("0,2:-"), data)); |
|  |  | TF\_CHECK\_OK(writer.Finish()); |
|  |  |  |
|  |  | MutateSavedTensorSlices(fname, [](SavedTensorSlices sts) { |
|  |  | if (sts.has\_meta()) { |
|  |  | for (auto& tensor : \*sts.mutable\_meta()->mutable\_tensor()) { |
|  |  | for (auto& dim : \*tensor.mutable\_shape()->mutable\_dim()) { |
|  |  | dim.set\_size(-dim.size()); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | return sts.SerializeAsString(); |
|  |  | }); |
|  |  |  |
|  |  | TensorSliceReader reader(fname, OpenTableTensorSliceReader); |
|  |  | // The negative dimension should cause loading to fail. |
|  |  | EXPECT\_FALSE(reader.status().ok()); |
|  |  | } |
|  |  |  |
|  |  | void CachedTensorSliceReaderTesterHelper( |
|  |  | const TensorSliceWriter::CreateBuilderFunction& create\_function, |
|  |  | const TensorSliceReader::OpenTableFunction& open\_function) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b619c6f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fb619c6f865715ca3b15ef1842b5b95edbaa710ad) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a2aaaea0_20250114_214913.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fabcced051cb1bd8fb05046ac3b6023a7ebcc4578)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fabcced051cb1bd8fb05046ac3b6023a7ebcc4578)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/abcced051cb1bd8fb05046ac3b6023a7ebcc4578)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent crashes when loading tensor slices with unsupported types.

[Browse files](/tensorflow/tensorflow/tree/abcced051cb1bd8fb05046ac3b6023a7ebcc4578)
Browse the repository at this point in the history

```
Also fix the `Tensor(const TensorShape&)` constructor swapping the LOG(FATAL)
messages for the unset and unsupported types.

PiperOrigin-RevId: 392695027
Change-Id: I4beda7db950db951d273e3259a7c8534ece49354
```

* Loading branch information

[![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Aug 24, 2021

1 parent
[0622858](/tensorflow/tensorflow/commit/06228582b71166b151f76210d7c8fd85c375f4fe)

commit abcced0

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**134 additions**
and
**11 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core

  + framework

    - tensorflow/core/framework/BUILD
      [BUILD](#diff-464594a038ba33f5846370e624b49f4dcba72479ce2f9480e61bf951bb9a906c)
    - tensorflow/core/framework/tensor.cc
      [tensor.cc](#diff-1b3c5df98d36d56bc20f9126c0bdd1880c6588afcbc68ef0cda15120c2b3842f)
    - tensorflow/core/framework/tensor.h
      [tensor.h](#diff-af09443df02ca617b3dcab687af960d4af68479da2d91a2b872fbe4edf6cb798)
  + util

    - tensorflow/core/util/tensor\_slice\_reader.cc
      [tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202)
    - tensorflow/core/util/tensor\_slice\_reader\_test.cc
      [tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[tensorflow/core/framework/BUILD](#diff-464594a038ba33f5846370e624b49f4dcba72479ce2f9480e61bf951bb9a906c "tensorflow/core/framework/BUILD")

Show comments

[View file](/tensorflow/tensorflow/blob/abcced051cb1bd8fb05046ac3b6023a7ebcc4578/tensorflow/core/framework/BUILD)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -835,6 +835,7 @@ tf\_cuda\_library( |
|  |  | "//tensorflow/core/lib/strings:str\_util", |
|  |  | "//tensorflow/core/lib/strings:strcat", |
|  |  | "//tensorflow/core/platform:abi", |
|  |  | "//tensorflow/core/platform:errors", |
|  |  | "//tensorflow/core/platform:logging", |
|  |  | "//tensorflow/core/platform:macros", |
|  |  | "//tensorflow/core/platform:platform\_port", |
| Expand Down | |  |

26 changes: 18 additions & 8 deletions

26
[tensorflow/core/framework/tensor.cc](#diff-1b3c5df98d36d56bc20f9126c0bdd1880c6588afcbc68ef0cda15120c2b3842f "tensorflow/core/framework/tensor.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/abcced051cb1bd8fb05046ac3b6023a7ebcc4578/tensorflow/core/framework/tensor.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -52,6 +52,7 @@ limitations under the License. |
|  |  | #include "tensorflow/core/lib/gtl/inlined\_vector.h" |
|  |  | #include "tensorflow/core/lib/strings/str\_util.h" |
|  |  | #include "tensorflow/core/lib/strings/strcat.h" |
|  |  | #include "tensorflow/core/platform/errors.h" |
|  |  | #include "tensorflow/core/platform/logging.h" |
|  |  | #include "tensorflow/core/platform/macros.h" |
|  |  | #include "tensorflow/core/platform/protobuf.h" |
| Expand Down  Expand Up | | @@ -723,11 +724,11 @@ bool Tensor::RefCountIsOne() const { |
|  |  | // The macro CASES() expands to a switch statement conditioned on |
|  |  | // TYPE\_ENUM. Each case expands the STMTS after a typedef for T. |
|  |  | #define SINGLE\_ARG(...) \_\_VA\_ARGS\_\_ |
|  |  | #define CASE(TYPE, STMTS) \ |
|  |  | case DataTypeToEnum<TYPE>::value: { \ |
|  |  | typedef TYPE T;  \ |
|  |  | STMTS; \ |
|  |  | break; \ |
|  |  | #define CASE(TYPE, STMTS)  \ |
|  |  | case DataTypeToEnum<TYPE>::value: {  \ |
|  |  | typedef TF\_ATTRIBUTE\_UNUSED TYPE T; \ |
|  |  | STMTS;  \ |
|  |  | break;  \ |
|  |  | } |
|  |  | #define CASES\_WITH\_DEFAULT(TYPE\_ENUM, STMTS, INVALID, DEFAULT) \ |
|  |  | switch (TYPE\_ENUM) { \ |
| Expand Down  Expand Up | | @@ -763,9 +764,8 @@ bool Tensor::RefCountIsOne() const { |
|  |  | } |
|  |  |  |
|  |  | #define CASES(TYPE\_ENUM, STMTS) \ |
|  |  | CASES\_WITH\_DEFAULT(TYPE\_ENUM, STMTS, \ |
|  |  | LOG(FATAL) << "Unexpected type: " << TYPE\_ENUM; \ |
|  |  | , LOG(FATAL) << "Type not set";) |
|  |  | CASES\_WITH\_DEFAULT(TYPE\_ENUM, STMTS, LOG(FATAL) << "Type not set"; \ |
|  |  | , LOG(FATAL) << "Unexpected type: " << TYPE\_ENUM;) |
|  |  |  |
|  |  | Tensor::Tensor(Allocator\* a, DataType type, const TensorShape& shape) |
|  |  | : shape\_(shape), buf\_(nullptr) { |
| Expand Down  Expand Up | | @@ -795,6 +795,16 @@ Tensor::Tensor(Allocator\* a, DataType type, const TensorShape& shape, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | Status Tensor::BuildTensor(DataType type, const TensorShape& shape, |
|  |  | Tensor\* out\_tensor) { |
|  |  | // Avoid crashes due to invalid or unsupported types. |
|  |  | CASES\_WITH\_DEFAULT( |
|  |  | type, {}, return errors::InvalidArgument("Type not set"), |
|  |  | return errors::InvalidArgument("Unexpected type: ", DataType\_Name(type))); |
|  |  | \*out\_tensor = Tensor(type, shape); |
|  |  | return Status::OK(); |
|  |  | } |
|  |  |  |
|  |  | // NOTE(mrry): The default allocator for a Tensor (when none is specified) is |
|  |  | // the default CPU allocator for NUMA zone 0. Accessing that currently involves |
|  |  | // acquiring a lock, which guards initialization of the per-NUMA zone |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[tensorflow/core/framework/tensor.h](#diff-af09443df02ca617b3dcab687af960d4af68479da2d91a2b872fbe4edf6cb798 "tensorflow/core/framework/tensor.h")

Show comments

[View file](/tensorflow/tensorflow/blob/abcced051cb1bd8fb05046ac3b6023a7ebcc4578/tensorflow/core/framework/tensor.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -170,6 +170,15 @@ class Tensor { |
|  |  | /// for details. |
|  |  | explicit Tensor(DataType type); |
|  |  |  |
|  |  | /// \brief Initializes a tensor with the input `type` and `shape`, or returns |
|  |  | /// an error and leaves `out\_tensor` unmodified. This factory method should be |
|  |  | /// used instead of the corresponding constructor if calling code cannot |
|  |  | /// validate that the `DataType` is valid and supported. |
|  |  | /// |
|  |  | /// The underlying buffer is allocated using a `CPUAllocator`. |
|  |  | static Status BuildTensor(DataType type, const TensorShape& shape, |
|  |  | Tensor\* out\_tensor); |
|  |  |  |
|  |  | private: |
|  |  | // A tag type for selecting the `Tensor` constructor overload that creates a |
|  |  | // scalar tensor in host memory. |
| Expand Down | |  |

4 changes: 3 additions & 1 deletion

4
[tensorflow/core/util/tensor\_slice\_reader.cc](#diff-671e333d4727ff77a00242140f60f0d22250de66a02b675a2e040078c1e43202 "tensorflow/core/util/tensor_slice_reader.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/abcced051cb1bd8fb05046ac3b6023a7ebcc4578/tensorflow/core/util/tensor_slice_reader.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -248,7 +248,9 @@ Status TensorSliceReader::GetTensor( |
|  |  | slice = tss->Slices().begin()->second.slice; |
|  |  | } |
|  |  |  |
|  |  | std::unique\_ptr<tensorflow::Tensor> t(new tensorflow::Tensor(type, shape)); |
|  |  | std::unique\_ptr<tensorflow::Tensor> t(new tensorflow::Tensor); |
|  |  | Status s = tensorflow::Tensor::BuildTensor(type, shape, t.get()); |
|  |  | if (!s.ok()) return s; |
|  |  | bool success = false; |
|  |  |  |
|  |  | #define READER\_COPY(dt) \ |
| Expand Down | |  |

105 changes: 103 additions & 2 deletions

105
[tensorflow/core/util/tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770 "tensorflow/core/util/tensor_slice_reader_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/abcced051cb1bd8fb05046ac3b6023a7ebcc4578/tensorflow/core/util/tensor_slice_reader_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -13,15 +13,19 @@ See the License for the specific language governing permissions and |
|  |  | limitations under the License. |
|  |  | ==============================================================================\*/ |
|  |  |  |
|  |  | #include <utility> |
|  |  |  |
|  |  | #include "tensorflow/core/util/tensor\_slice\_reader.h" |
|  |  |  |
|  |  | #include <utility> |
|  |  | #include <vector> |
|  |  |  |
|  |  | #include "tensorflow/core/framework/types.h" |
|  |  | #include "tensorflow/core/framework/versions.pb.h" |
|  |  | #include "tensorflow/core/lib/core/status\_test\_util.h" |
|  |  | #include "tensorflow/core/lib/core/stringpiece.h" |
|  |  | #include "tensorflow/core/lib/io/iterator.h" |
|  |  | #include "tensorflow/core/lib/io/path.h" |
|  |  | #include "tensorflow/core/lib/io/table.h" |
|  |  | #include "tensorflow/core/lib/io/table\_builder.h" |
|  |  | #include "tensorflow/core/lib/strings/str\_util.h" |
|  |  | #include "tensorflow/core/lib/strings/strcat.h" |
|  |  | #include "tensorflow/core/platform/env.h" |
| Expand All | | @@ -30,6 +34,7 @@ limitations under the License. |
|  |  | #include "tensorflow/core/platform/test.h" |
|  |  | #include "tensorflow/core/platform/types.h" |
|  |  | #include "tensorflow/core/public/version.h" |
|  |  | #include "tensorflow/core/util/saved\_tensor\_slice.pb.h" |
|  |  | #include "tensorflow/core/util/saved\_tensor\_slice\_util.h" |
|  |  | #include "tensorflow/core/util/tensor\_slice\_reader\_cache.h" |
|  |  | #include "tensorflow/core/util/tensor\_slice\_writer.h" |
| Expand Down  Expand Up | | @@ -309,6 +314,102 @@ TEST\_SIMPLE\_INT(int16, int32) |
|  |  | TEST\_SIMPLE\_INT(int8, int32) |
|  |  | TEST\_SIMPLE\_INT(uint8, int32) |
|  |  |  |
|  |  | // Modifies the SavedTensorSlices messages in a checkpoint to allow creating |
|  |  | // malformed or unsupported checkpoints. |
|  |  | void MutateSavedTensorSlices( |
|  |  | const std::string& fname, |
|  |  | const std::function<std::string(SavedTensorSlices)>& mutator) { |
|  |  | table::Options options; |
|  |  | options.compression = table::kNoCompression; |
|  |  |  |
|  |  | // Read all entres from the table. |
|  |  | std::vector<std::pair<std::string, std::string>> entries; |
|  |  | { |
|  |  | std::unique\_ptr<RandomAccessFile> file; |
|  |  | TF\_CHECK\_OK(Env::Default()->NewRandomAccessFile(fname, &file)); |
|  |  | uint64 file\_size; |
|  |  | TF\_CHECK\_OK(Env::Default()->GetFileSize(fname, &file\_size)); |
|  |  | table::Table\* t; |
|  |  | TF\_CHECK\_OK(table::Table::Open(options, file.get(), file\_size, &t)); |
|  |  | std::unique\_ptr<table::Table> table(t); |
|  |  | std::unique\_ptr<table::Iterator> it(table->NewIterator()); |
|  |  | for (it->Seek(""); it->Valid(); it->Next()) { |
|  |  | entries.emplace\_back(it->key(), it->value()); |
|  |  | } |
|  |  | TF\_CHECK\_OK(it->status()); |
|  |  | } |
|  |  |  |
|  |  | // Rewrite the table, mutating each value. |
|  |  | { |
|  |  | std::unique\_ptr<WritableFile> file; |
|  |  | TF\_CHECK\_OK(Env::Default()->NewWritableFile(fname, &file)); |
|  |  | table::TableBuilder builder(options, file.get()); |
|  |  | for (const auto& entry : entries) { |
|  |  | SavedTensorSlices sts; |
|  |  | CHECK(sts.ParseFromString(entry.second)); |
|  |  | builder.Add(entry.first, mutator(std::move(sts))); |
|  |  | } |
|  |  | TF\_CHECK\_OK(builder.Finish()); |
|  |  | TF\_CHECK\_OK(file->Close()); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | TEST(TensorSliceReaderTest, MissingTensorType) { |
|  |  | const string fname = io::JoinPath(testing::TmpDir(), "invalid\_checkpoint"); |
|  |  | TensorSliceWriter writer(fname, CreateTableTensorSliceBuilder); |
|  |  | const int32 data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; |
|  |  | TensorShape shape({4, 5}); |
|  |  | TensorSlice slice = TensorSlice::ParseOrDie("0,2:-"); |
|  |  | TF\_CHECK\_OK(writer.Add("test", shape, slice, data)); |
|  |  | TF\_CHECK\_OK(writer.Finish()); |
|  |  |  |
|  |  | MutateSavedTensorSlices(fname, [](SavedTensorSlices sts) { |
|  |  | if (sts.has\_meta()) { |
|  |  | for (auto& tensor : \*sts.mutable\_meta()->mutable\_tensor()) { |
|  |  | tensor.clear\_type(); |
|  |  | } |
|  |  | } |
|  |  | return sts.SerializeAsString(); |
|  |  | }); |
|  |  |  |
|  |  | TensorSliceReader reader(fname, OpenTableTensorSliceReader); |
|  |  | TF\_CHECK\_OK(reader.status()); |
|  |  |  |
|  |  | // The tensor should be present, but loading it should fail due to the |
|  |  | // unset (invalid) type. |
|  |  | EXPECT\_TRUE(reader.HasTensor("test", nullptr, nullptr)); |
|  |  | std::unique\_ptr<Tensor> tensor; |
|  |  | EXPECT\_FALSE(reader.GetTensor("test", &tensor).ok()); |
|  |  | } |
|  |  |  |
|  |  | TEST(TensorSliceReaderTest, UnsupportedTensorType) { |
|  |  | const string fname = io::JoinPath(testing::TmpDir(), "int32\_ref\_checkpoint"); |
|  |  | TensorSliceWriter writer(fname, CreateTableTensorSliceBuilder); |
|  |  | const int32 data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; |
|  |  | TensorShape shape({4, 5}); |
|  |  | TensorSlice slice = TensorSlice::ParseOrDie("0,2:-"); |
|  |  | TF\_CHECK\_OK(writer.Add("test", shape, slice, data)); |
|  |  | TF\_CHECK\_OK(writer.Finish()); |
|  |  |  |
|  |  | MutateSavedTensorSlices(fname, [](SavedTensorSlices sts) { |
|  |  | if (sts.has\_meta()) { |
|  |  | for (auto& tensor : \*sts.mutable\_meta()->mutable\_tensor()) { |
|  |  | tensor.set\_type(DT\_INT32\_REF); |
|  |  | } |
|  |  | } |
|  |  | return sts.SerializeAsString(); |
|  |  | }); |
|  |  |  |
|  |  | TensorSliceReader reader(fname, OpenTableTensorSliceReader); |
|  |  | TF\_CHECK\_OK(reader.status()); |
|  |  |  |
|  |  | // The tensor should be present, but loading it should fail due to the |
|  |  | // unsupported type. |
|  |  | EXPECT\_TRUE(reader.HasTensor("test", nullptr, nullptr)); |
|  |  | std::unique\_ptr<Tensor> tensor; |
|  |  | EXPECT\_FALSE(reader.GetTensor("test", &tensor).ok()); |
|  |  | } |
|  |  |  |
|  |  | void CachedTensorSliceReaderTesterHelper( |
|  |  | const TensorSliceWriter::CreateBuilderFunction& create\_function, |
|  |  | const TensorSliceReader::OpenTableFunction& open\_function) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `abcced0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2Fabcced051cb1bd8fb05046ac3b6023a7ebcc4578) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_57abf8d9_20250114_214911.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F368af875869a204b4ac552b9ddda59f6a46a56ec)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F368af875869a204b4ac552b9ddda59f6a46a56ec)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

## Commit

[Permalink](/tensorflow/tensorflow/commit/368af875869a204b4ac552b9ddda59f6a46a56ec)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Avoid buffer overflow when loading tensors with insufficient data fro…

[Browse files](/tensorflow/tensorflow/tree/368af875869a204b4ac552b9ddda59f6a46a56ec)
Browse the repository at this point in the history

```
…m checkpoints.

`CopyDataFromTensorSliceToTensorSlice` does not (and cannot conveniently)
provide any bounds checking on its own, so the size is instead checked prior
to passing unvalidated data to that function.

PiperOrigin-RevId: 392971286
Change-Id: If2073b36d4d5eedd386329f56729395fd7effee1
```

* Loading branch information

[![@tensorflower-gardener](https://avatars.githubusercontent.com/u/17151892?s=40&v=4)](/tensorflower-gardener)

[tensorflower-gardener](/tensorflow/tensorflow/commits?author=tensorflower-gardener "View all commits by tensorflower-gardener")
committed
Aug 25, 2021

1 parent
[8ccde23](/tensorflow/tensorflow/commit/8ccde238a46ab23ff9e8a2bc096239383b749756)

commit 368af87

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**69 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tensorflow/core/util

  + tensorflow/core/util/saved\_tensor\_slice\_util.h
    [saved\_tensor\_slice\_util.h](#diff-ecd368b23eacebda17feb0f5bb8c25520452bb70f8df5fe1f0cc31155e46d551)
  + tensorflow/core/util/tensor\_slice\_reader.h
    [tensor\_slice\_reader.h](#diff-54cbc796748d034b6ae6d6a344745feaf41c311a300ac559c55ce612c4a1498d)
  + tensorflow/core/util/tensor\_slice\_reader\_test.cc
    [tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770)

## There are no files selected for viewing

26 changes: 26 additions & 0 deletions

26
[tensorflow/core/util/saved\_tensor\_slice\_util.h](#diff-ecd368b23eacebda17feb0f5bb8c25520452bb70f8df5fe1f0cc31155e46d551 "tensorflow/core/util/saved_tensor_slice_util.h")

Show comments

[View file](/tensorflow/tensorflow/blob/368af875869a204b4ac552b9ddda59f6a46a56ec/tensorflow/core/util/saved_tensor_slice_util.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -59,6 +59,9 @@ Status ParseShapeAndSlice(const string& shape\_and\_slice, TensorShape\* shape, |
|  |  | template <typename T> |
|  |  | struct SaveTypeTraits; |
|  |  |  |
|  |  | template <typename T> |
|  |  | int TensorProtoDataSize(const TensorProto& t); |
|  |  |  |
|  |  | template <typename T> |
|  |  | const typename SaveTypeTraits<T>::SavedType\* TensorProtoData( |
|  |  | const TensorProto& t); |
| Expand Down  Expand Up | | @@ -95,6 +98,10 @@ void Fill(T\* data, size\_t n, TensorProto\* t); |
|  |  | #define TENSOR\_PROTO\_EXTRACT\_TYPE(TYPE, FIELD, FTYPE) \ |
|  |  | TENSOR\_PROTO\_EXTRACT\_TYPE\_HELPER(TYPE, FIELD, FTYPE, FTYPE) \ |
|  |  | template <> \ |
|  |  | inline int TensorProtoDataSize<TYPE>(const TensorProto& t) { \ |
|  |  | return t.FIELD##\_val\_size(); \ |
|  |  | } \ |
|  |  | template <> \ |
|  |  | inline void Fill(const TYPE\* data, size\_t n, TensorProto\* t) { \ |
|  |  | typename protobuf::RepeatedField<FTYPE> copy(data, data + n); \ |
|  |  | t->mutable\_##FIELD##\_val()->Swap(&copy); \ |
| Expand All | | @@ -104,6 +111,10 @@ void Fill(T\* data, size\_t n, TensorProto\* t); |
|  |  | #define TENSOR\_PROTO\_EXTRACT\_TYPE\_COMPLEX(TYPE, FIELD, FTYPE) \ |
|  |  | TENSOR\_PROTO\_EXTRACT\_TYPE\_HELPER(TYPE, FIELD, FTYPE, TYPE) \ |
|  |  | template <> \ |
|  |  | inline int TensorProtoDataSize<TYPE>(const TensorProto& t) { \ |
|  |  | return t.FIELD##\_val\_size() / 2; \ |
|  |  | } \ |
|  |  | template <> \ |
|  |  | inline void Fill(const TYPE\* data, size\_t n, TensorProto\* t) { \ |
|  |  | const FTYPE\* sub = reinterpret\_cast<const FTYPE\*>(data); \ |
|  |  | typename protobuf::RepeatedField<FTYPE> copy(sub, sub + 2 \* n); \ |
| Expand Down  Expand Up | | @@ -136,6 +147,11 @@ TENSOR\_PROTO\_EXTRACT\_TYPE(quint16, int, int32); |
|  |  | template <> |
|  |  | struct SaveTypeTraits<qint32> : SaveTypeTraits<int32> {}; |
|  |  |  |
|  |  | template <> |
|  |  | inline int TensorProtoDataSize<qint32>(const TensorProto& t) { |
|  |  | return t.int\_val\_size(); |
|  |  | } |
|  |  |  |
|  |  | template <> |
|  |  | inline const int32\* TensorProtoData<qint32>(const TensorProto& t) { |
|  |  | static\_assert(SaveTypeTraits<qint32>::supported, |
| Expand All | | @@ -158,6 +174,11 @@ struct SaveTypeTraits<Eigen::half> { |
|  |  | typedef protobuf::RepeatedField<int32> RepeatedField; |
|  |  | }; |
|  |  |  |
|  |  | template <> |
|  |  | inline int TensorProtoDataSize<Eigen::half>(const TensorProto& t) { |
|  |  | return t.half\_val\_size(); |
|  |  | } |
|  |  |  |
|  |  | template <> |
|  |  | inline const int\* TensorProtoData<Eigen::half>(const TensorProto& t) { |
|  |  | return t.half\_val().data(); |
| Expand Down  Expand Up | | @@ -187,6 +208,11 @@ struct SaveTypeTraits<tstring> { |
|  |  | typedef protobuf::RepeatedPtrField<string> RepeatedField; |
|  |  | }; |
|  |  |  |
|  |  | template <> |
|  |  | inline int TensorProtoDataSize<tstring>(const TensorProto& t) { |
|  |  | return t.string\_val\_size(); |
|  |  | } |
|  |  |  |
|  |  | template <> |
|  |  | inline const string\* const\* TensorProtoData<tstring>(const TensorProto& t) { |
|  |  | static\_assert(SaveTypeTraits<tstring>::supported, |
| Expand Down | |  |

16 changes: 16 additions & 0 deletions

16
[tensorflow/core/util/tensor\_slice\_reader.h](#diff-54cbc796748d034b6ae6d6a344745feaf41c311a300ac559c55ce612c4a1498d "tensorflow/core/util/tensor_slice_reader.h")

Show comments

[View file](/tensorflow/tensorflow/blob/368af875869a204b4ac552b9ddda59f6a46a56ec/tensorflow/core/util/tensor_slice_reader.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -181,6 +181,22 @@ bool TensorSliceReader::CopySliceData(const string& name, |
|  |  | << slice\_s.DebugString() << ": computed key = " << key; |
|  |  | return false; |
|  |  | } |
|  |  | // Ensure the TensorSlice contains the expected amount of data. |
|  |  | TensorShape shp\_s; |
|  |  | Status s = slice\_s.SliceTensorShape(tss->shape(), &shp\_s); |
|  |  | if (!s.ok()) { |
|  |  | VLOG(1) << "Failed to slice tensor " << name << ", slice " |
|  |  | << slice\_s.DebugString() << ": " << s; |
|  |  | return false; |
|  |  | } |
|  |  | if (checkpoint::TensorProtoDataSize<T>(sts.data().data()) != |
|  |  | shp\_s.num\_elements()) { |
|  |  | VLOG(1) << "Tensor " << name << ", slice " << slice\_s.DebugString() |
|  |  | << " had an unexpected amount of data: expected = " |
|  |  | << shp\_s.num\_elements() << ", got = " |
|  |  | << checkpoint::TensorProtoDataSize<T>(sts.data().data()); |
|  |  | return false; |
|  |  | } |
|  |  | CopyDataFromTensorSliceToTensorSlice( |
|  |  | tss->shape(), slice\_s, slice, |
|  |  | checkpoint::TensorProtoData<T>(sts.data().data()), data); |
| Expand Down | |  |

27 changes: 27 additions & 0 deletions

27
[tensorflow/core/util/tensor\_slice\_reader\_test.cc](#diff-96c2ea56384c035f0bd6214d5f412a9f2ff811fadd20b1d959e120294114c770 "tensorflow/core/util/tensor_slice_reader_test.cc")

Show comments

[View file](/tensorflow/tensorflow/blob/368af875869a204b4ac552b9ddda59f6a46a56ec/tensorflow/core/util/tensor_slice_reader_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -459,6 +459,33 @@ TEST(TensorSliceReaderTest, InvalidTensorSlice) { |
|  |  | EXPECT\_FALSE(reader.status().ok()); |
|  |  | } |
|  |  |  |
|  |  | TEST(TensorSliceReaderTest, MissingTensorData) { |
|  |  | const string fname = |
|  |  | io::JoinPath(testing::TmpDir(), "missing\_data\_checkpoint"); |
|  |  | TensorSliceWriter writer(fname, CreateTableTensorSliceBuilder); |
|  |  | const int32 data[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}; |
|  |  | TF\_ASSERT\_OK(writer.Add("test", TensorShape({4, 5}), |
|  |  | TensorSlice::ParseOrDie("0,2:-"), data)); |
|  |  | TF\_ASSERT\_OK(writer.Finish()); |
|  |  |  |
|  |  | MutateSavedTensorSlices(fname, [&](SavedTensorSlices sts) { |
|  |  | if (sts.has\_data()) { |
|  |  | // Replace the data with only 4 elements. |
|  |  | Fill(data, 4, sts.mutable\_data()->mutable\_data()); |
|  |  | } |
|  |  | return sts.SerializeAsString(); |
|  |  | }); |
|  |  |  |
|  |  | TensorSliceReader reader(fname, OpenTableTensorSliceReader); |
|  |  | TF\_ASSERT\_OK(reader.status()); |
|  |  |  |
|  |  | // The tensor should be present, but loading it should fail due to the missing |
|  |  | // data. |
|  |  | EXPECT\_TRUE(reader.HasTensor("test", nullptr, nullptr)); |
|  |  | std::unique\_ptr<Tensor> tensor; |
|  |  | EXPECT\_FALSE(reader.GetTensor("test", &tensor).ok()); |
|  |  | } |
|  |  |  |
|  |  | void CachedTensorSliceReaderTesterHelper( |
|  |  | const TensorSliceWriter::CreateBuilderFunction& create\_function, |
|  |  | const TensorSliceReader::OpenTableFunction& open\_function) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `368af87`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fcommit%2F368af875869a204b4ac552b9ddda59f6a46a56ec) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_15f526e7_20250114_214918.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-7pxj-m4jf-r6h2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftensorflow%2Ftensorflow%2Fsecurity%2Fadvisories%2FGHSA-7pxj-m4jf-r6h2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tensorflow%2Ftensorflow)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tensorflow](/tensorflow)
/
**[tensorflow](/tensorflow/tensorflow)**
Public

* [Notifications](/login?return_to=%2Ftensorflow%2Ftensorflow) You must be signed in to change notification settings
* [Fork
  74.4k](/login?return_to=%2Ftensorflow%2Ftensorflow)
* [Star
   187k](/login?return_to=%2Ftensorflow%2Ftensorflow)

* [Code](/tensorflow/tensorflow)
* [Issues
  827](/tensorflow/tensorflow/issues)
* [Pull requests
  5k+](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects
  2](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

Additional navigation options

* [Code](/tensorflow/tensorflow)
* [Issues](/tensorflow/tensorflow/issues)
* [Pull requests](/tensorflow/tensorflow/pulls)
* [Actions](/tensorflow/tensorflow/actions)
* [Projects](/tensorflow/tensorflow/projects)
* [Security](/tensorflow/tensorflow/security)
* [Insights](/tensorflow/tensorflow/pulse)

# Missing validation during checkpoint loading

Moderate

[mihaimaruseac](/mihaimaruseac)
published
GHSA-7pxj-m4jf-r6h2
Nov 4, 2021

## Package

pip

tensorflow, tensorflow-cpu, tensorflow-gpu
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 2.7.0

## Patched versions

2.4.4, 2.5.2, 2.6.1

## Description

### Impact

An attacker can trigger undefined behavior, integer overflows, segfaults and `CHECK`-fail crashes if they can change saved checkpoints from outside of TensorFlow.

This is because the checkpoints loading infrastructure is missing validation for invalid file formats.

### Patches

We have patched the issue in GitHub commits [b619c6f865715ca3b15ef1842b5b95edbaa710ad](https://github.com/tensorflow/tensorflow/commit/b619c6f865715ca3b15ef1842b5b95edbaa710ad), [e8dc63704c88007ee4713076605c90188d66f3d2](https://github.com/tensorflow/tensorflow/commit/e8dc63704c88007ee4713076605c90188d66f3d2), [368af875869a204b4ac552b9ddda59f6a46a56ec](https://github.com/tensorflow/tensorflow/commit/368af875869a204b4ac552b9ddda59f6a46a56ec), and [abcced051cb1bd8fb05046ac3b6023a7ebcc4578](https://github.com/tensorflow/tensorflow/commit/abcced051cb1bd8fb05046ac3b6023a7ebcc4578).

These fixes will be included in TensorFlow 2.7.0. We will also cherrypick these commits on TensorFlow 2.6.1, TensorFlow 2.5.2, and TensorFlow 2.4.4, as these are also affected and still in supported range.

### For more information

Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

### Severity

Moderate

### CVE ID

CVE-2021-41203

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


