=== Content from medium.com_8a20f024_20250114_194806.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8175af676c3e&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40tomerp_77017%2Fexploiting-listary-searching-your-way-to-system-privileges-8175af676c3e&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40tomerp_77017%2Fexploiting-listary-searching-your-way-to-system-privileges-8175af676c3e&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# exploiting Listary: Searching your way to SYSTEM privileges

[![Tomer Peled](https://miro.medium.com/v2/resize:fill:88:88/1*GOFjb5W_nuSIIiZ_R5715w.jpeg)](/%40tomerp_77017?source=post_page---byline--8175af676c3e--------------------------------)

[Tomer Peled](/%40tomerp_77017?source=post_page---byline--8175af676c3e--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Fd42e0b5b0cd8&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40tomerp_77017%2Fexploiting-listary-searching-your-way-to-system-privileges-8175af676c3e&user=Tomer+Peled&userId=d42e0b5b0cd8&source=post_page-d42e0b5b0cd8--byline--8175af676c3e---------------------post_header-----------)

6 min read·Dec 9, 2021

--

Listen

Share

# Background:

While working on another research relating to DLL hijacking, I stumbled upon Listary. Listary is a known file-system search application used to index and quickly locate files.

![]()

First, I tried to find a DLL hijacking location. After restarting listary, Using Procmon with the appropriate filters, I could spot a few locations for hijacking from Admin->SYSTEM:

![]()![]()

After discovering these locations, I decided to search for ways to get admin privileges in order to capitalize on this hijacking.

# **Malicious update (MITM attack):**

By default, Listary will search for updates automatically

![]()

The Listary update process consists of the following steps:

1. Download the content of the following URL:

<http://listray.com/check-update> (HTTP communication!)

2. After downloading from the page (a simple html page with only a JSON string available publicly), the update process will parse the version number and the download URL from the json object without any validation!

3. The user will be prompted to download the new version of Listary from the parsed location

![]()

If an attacker has MITM capabilities, the attacker can manipulate the HTML response and plant a specially crafted JSON payload. The JSON payload can refer the user to download a malicious file instead of a legitimate update:

![]()![]()![]()

If the user that executed Listary has admin privileges, then the malicious update file can be configured to plant a malicious DLL in Listary’s folder that will be executed with SYSTEM privileges by using the above DLL hijacking location, Or just do other malicious actions with admin privileges…

Note that user would have to run the downloaded file, mistakenly treating it as a legitimate update file.

# UAC Bypass:

Let’s say you don’t have a MITM but gained a foothold on an endpoint that has Listary installed to gain high integrity you just have to use the built-in option Listary provides to gain admin privileges through it:

![]()

Listary will use its service to create a task that will execute listary’s client with highest possible privileges

![]()![]()![]()

If a medium integrity user tries to click the “run with highest” button in task scheduler a UAC window will appear or a password prompt will appear:

![]()![]()

The upside of using this option is its evasiveness because it’s a legitimate program using its components and the downside is as mentioned above the requirement of some sort if interactive session with the victim’s endpoint.

The downside here is that you need an interactive session on the victim or an AutoIt script (or other script that will simulate mouse movement) to enable this option but once you do just restart the machine and Listary will run with the highest possible privileges for the “infected” account

After bypassing the UAC, you can plant a malicious DLL in Listary’s directory and gain SYSTEM privileges.

# Named Pipes (Lateral Movement):

Pipes in OS’s are a way to allow inter process communication (IPC). By using pipes, one can direct a stream of data in his program to a waiting listener in another program.
There are two types of pipes in windows — named pipes and anonymous pipes.
Since Listary is using named pipes, we will focus on this type. Named pipes can be easily created by using the CreateNamedPipe WinApi call, specifying the pipe name in the format “\\\\.\\pipe\\mynamedpipe”

![]()

Named pipes can also be created using PowerShell in the following way:

![]()

Named pipes can be accessed like normal files on a computer and therefore can be accessed with the normal WinAPI calls to ReadFile and WriteFile. More importantly, since named pipes are designed for servers to parse user input and act on it, Microsoft has provided programmers the WinAPI ImpersonateNamedPipeClient () — This function will allow a server to assume the security identity (Security Token) of the client’s thread and execute commands as the client.

This command has the same functionality as RpcImpersonateClient () (which we will elaborate on in a future post).

This technique was used widely by attackers to duplicate and impersonate genuine programs and perform privilege escalation and lateral movement attacks (like meterpreter’s GetSystem).

This impersonation can be done using PowerShell like so[[7]](https://decoder.cloud/2019/03/06/windows-named-pipes-impersonation/):

![]()

Listary’s Service uses the named pipe \\.\pipe\Listary.ListaryService

![]()

Because of that and the fact that Listary starts with windows by default we can use the information above about ImpersonateNamedPipeClient() and open a named pipe with CreateNamedPipe() and specify “\\.\pipe\Listary.ListaryService” as the name for the pipe.

For this example, let’s assume the attacker is a local admin since he needs to have “`SeImpersonatePrivilege`” for this to work.

The attacker just needs to wait for a domain admin (or any other user) to login, and once the user logged in into the endpoint the attacker can steal his privileges for lateral movement.

This will work since Listary client is configured to run on startup by default and will try to connect to the pipe server using a misconfigured CreateFile call:

![]()

Notice that the security description is set to 0 and the flags are set to 0x40110000

Which translates to `FILE_FLAG_OVERLAPPED | FILE_ATTRIBUTE_VIRTUAL | FILE_FLAG_OPEN_NO_RECALL`no SQOS was specified therefore the default will be used which is

![]()

the attacker can leverage this connection as described to impersonate the Listary client’s thread.

This technique was addressed by Microsoft with the addition of security flags for CreateFile namely a programmer needs to specify the flags “`SECURITY_SQOS_PRESENT| SECURITY_IDENTIFICATION”` which will prevent impersonation or execution of code on behalf of the client [8][3]

![]()![]()

Conclusion:

Listary’s vulnerabilities present a problem for SOC/blue teams since they can be triggered as regular program activities.

In the best case; attackers can use Listary “only” for lateral movement but under the right circumstances’ attackers can use Listary for privilege escalation and remote code execution

Responsible disclosure:

29/08/2021 — vulnerabilities disclosed to Bopsoft/Listary team — No response

13/09/2021 — Vulnerabilities disclosed to MITRE — CVE numbers assigned CVE-2021–41065, CVE-2021–41066, CVE-2021–41067

19/09/2021 — Attempt to communicate with Bopsoft/Listary again — No response

09/12/2021 — Article published

References:

[1] <https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-createnamedpipea>

[2] <https://docs.microsoft.com/en-us/windows/win32/api/namedpipeapi/nf-namedpipeapi-impersonatenamedpipeclient>

[3] <https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/>

[4] <https://itm4n.github.io/windows-dll-hijacking-clarified/>

[5] <https://en.wikipedia.org/wiki/Man-in-the-middle_attack>

[6] <https://pentestlab.blog/2017/05/03/uac-bypass-task-scheduler/>

[7] <https://decoder.cloud/2019/03/06/windows-named-pipes-impersonation/>

[8] <https://docs.microsoft.com/en-us/archive/msdn-magazine/2004/november/protect-your-apps-and-user-info-with-defensive-coding-techniques>

[9] <https://docs.microsoft.com/en-us/windows/win32/secauthz/impersonation-levels>

--

--

[![Tomer Peled](https://miro.medium.com/v2/resize:fill:96:96/1*GOFjb5W_nuSIIiZ_R5715w.jpeg)](/%40tomerp_77017?source=post_page---post_author_info--8175af676c3e--------------------------------)[![Tomer Peled](https://miro.medium.com/v2/resize:fill:128:128/1*GOFjb5W_nuSIIiZ_R5715w.jpeg)](/%40tomerp_77017?source=post_page---post_author_info--8175af676c3e--------------------------------)Follow[## Written by Tomer Peled](/%40tomerp_77017?source=post_page---post_author_info--8175af676c3e--------------------------------)[12 Followers](/%40tomerp_77017/followers?source=post_page---post_author_info--8175af676c3e--------------------------------)·[2 Following](/%40tomerp_77017/following?source=post_page---post_author_info--8175af676c3e--------------------------------)

Security researcher at BugSec

Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----8175af676c3e--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----8175af676c3e--------------------------------)[About](/about?autoplay=1&source=post_page-----8175af676c3e--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----8175af676c3e--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----8175af676c3e--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----8175af676c3e--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8175af676c3e--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8175af676c3e--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----8175af676c3e--------------------------------)[Teams](/business?source=post_page-----8175af676c3e--------------------------------)



=== Content from www.listary.com_d6bb86b5_20250114_194807.html ===

[![](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/643e10451b7bb541e01adbbc_Vectors-Wrapper.svg)
Listary](/)

* [File Search](/file-search)
* [Download](/download)
* [Pro](/pro)
* [Blog](/blog)
* [Docs](http://help.listary.com)
* [Discussions](https://discussion.listary.com/)
* [Contact](/contact)
* Resources

  [Docs](https://help.listary.com)[Discussions](https://discussion.listary.com/)[Contact](/contact)
* [Free Download](/download-completion?version=stable)

# Bring Listary to your desktop

For personal use, you're welcome to use Listary for free, forever.

[Download for Windows](/download-completion?version=stable)
[V6.3.1.84 ï½ Last updated Nov 27, 2024](https://help.listary.com/changelog)Â ï½ Win 10 & 11

## Want new features sooner? Try Listary

# beta

[Learn more about latest Beta updates â](https://help.listary.com/changelog-beta)
[Download Listary Beta](/download-completion?version=beta)
[Last updated Dec 22, 2024](https://help.listary.com/changelog-beta) ï½ Win 10 & 11

## Older version for Windows 7 & XP

[Download Listary 5 Classic](/download-completion?version=old-v5)

## Portable version

Since the portable version does not have administrator privileges, it cannot automatically index files. You will need to manually add locations for indexing through the settings and also set the indexing frequency according to your needs.

[Download Listary 5 Portable](/download/ListaryPortable171014.zip)

# What's New for Listary V6.3?

![](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/656467a08651d7088ccfef2d_icon-file-search-window.svg)
## New: File Search Window

* ### Larger Search Window, More Search Results

  See more search results at a glance and view millions of files with smooth scrolling.

  ![Listary file search window](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/6565c025992f91b2ef0dc574_Listary-file-search-window-min.png)
* ### New Sidebar for Simplified Filtering

  Pinpoint your search with advanced filters: easily sort by file type, date modified, and more with just one click.

  ![Filter search results in Listary file search window](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/6565ed658e8fb02be12c8822_screenshot-filters.png)
* ### Seamless Connection from Launcher to File Search Window

  Switch seamlessly between the File Search Window and the launcher with the Ctrl-Ctrl shortcut.

  ![switch between Listary launcher and file search window with Ctrl-Ctrl hotkey](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/6565ed658e8fb02be12c882e_screenshot-switch.png)

![](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/65648b857c01b4c70f46fefd_icon-file-search-engine.svg)
## New File Search Engine

* ### Faster and More Stable File Search Engine

  New file search engine based on Rust, improving performance by **20%-100%**, while using less memory in most scenarios.

![](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/65648b857e4e076f113ed56a_icon-new-UI.svg)
## New Launcher UI

* ### UI Redesign: A Fresh, Windows 11-Inspired Look

  Enjoy a more intuitive interface that harmonizes with the modern desktop experience, enhancing your workflow with a touch of elegance.

  ![search files and apps using Listary's launcher](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/655f6daa30360d26544fd098_Listary-hero-screenshot.png)

[![](https://cdn.prod.website-files.com/643e09c9f19df8579c420d9f/643e10451b7bb541e01adbbc_Vectors-Wrapper.svg)
Listary](/)
Follow us ð
[Twitter](https://twitter.com/UseListary)

Get notified when we release new stuff! ð

ð Done! Thrilled to have you join us!

Oops! Something went wrong.

Â© 2010-2024 Bopsoft. All right reserved.

Get Started
[Free Download](/download)[Listary Pro](/pro)[Manage Devices](https://account.listary.com)

Listary
[Overview](/)[File Search](/file-search)[Everything VS Listary](/blog/best-file-search-tools-of-2024-everything-vs-listary)

Learn
[Help](https://help.listary.com)[Changelog](https://help.listary.com/changelog)

Community
[Discussions](https://discussion.listary.com/)
/[ä¸­æè®¨è®ºåº](https://discussion.listary.com/c/14-category/14)
[Blog](/blog)

Legal
[License Agreement](https://help.listary.com/license-agreement)[Privacy](https://help.listary.com/privacy)

Links
[gety.ai - AI-powered file search](https://www.gety.ai/)[Listary æä»¶æç´¢ - ä¸­æå®ç½](https://www.listary.net)


