=== Content from github.com_a620f03a_20250115_085446.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsparklemotion%2Fnokogiri%2Fcommit%2F5bf729ff3cc84709ee3c3248c981584088bf9f6d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsparklemotion%2Fnokogiri%2Fcommit%2F5bf729ff3cc84709ee3c3248c981584088bf9f6d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=sparklemotion%2Fnokogiri)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sparklemotion](/sparklemotion)
/
**[nokogiri](/sparklemotion/nokogiri)**
Public

* [Notifications](/login?return_to=%2Fsparklemotion%2Fnokogiri) You must be signed in to change notification settings
* [Fork
  905](/login?return_to=%2Fsparklemotion%2Fnokogiri)
* [Star
   6.2k](/login?return_to=%2Fsparklemotion%2Fnokogiri)

* [Code](/sparklemotion/nokogiri)
* [Issues
  63](/sparklemotion/nokogiri/issues)
* [Pull requests
  25](/sparklemotion/nokogiri/pulls)
* [Discussions](/sparklemotion/nokogiri/discussions)
* [Actions](/sparklemotion/nokogiri/actions)
* [Projects
  0](/sparklemotion/nokogiri/projects)
* [Wiki](/sparklemotion/nokogiri/wiki)
* [Security](/sparklemotion/nokogiri/security)
* [Insights](/sparklemotion/nokogiri/pulse)

Additional navigation options

* [Code](/sparklemotion/nokogiri)
* [Issues](/sparklemotion/nokogiri/issues)
* [Pull requests](/sparklemotion/nokogiri/pulls)
* [Discussions](/sparklemotion/nokogiri/discussions)
* [Actions](/sparklemotion/nokogiri/actions)
* [Projects](/sparklemotion/nokogiri/projects)
* [Wiki](/sparklemotion/nokogiri/wiki)
* [Security](/sparklemotion/nokogiri/security)
* [Insights](/sparklemotion/nokogiri/pulse)

## Commit

[Permalink](/sparklemotion/nokogiri/commit/5bf729ff3cc84709ee3c3248c981584088bf9f6d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#2328](https://github.com/sparklemotion/nokogiri/pull/2328) from sparklemotion/flavorjones-[GHSA-2rr5-8q3…](https://github.com/advisories/GHSA-2rr5-8q37-2w7h "GHSA-2rr5-8q37-2w7h")

[Browse files](/sparklemotion/nokogiri/tree/5bf729ff3cc84709ee3c3248c981584088bf9f6d)
Browse the repository at this point in the history

```
[…7-2w7h](https://github.com/advisories/GHSA-2rr5-8q37-2w7h "GHSA-2rr5-8q37-2w7h")_main

fix JRuby SAX parser entity handling
```

* Loading branch information

[![@flavorjones](https://avatars.githubusercontent.com/u/8207?s=40&v=4)](/flavorjones)

[flavorjones](/sparklemotion/nokogiri/commits?author=flavorjones "View all commits by flavorjones")
authored
Sep 26, 2021

2 parents
[04032e5](/sparklemotion/nokogiri/commit/04032e5196c5054b1da17edebb0d4b610a83d873)
+
[3828603](/sparklemotion/nokogiri/commit/382860304b2efbf837cb3fcbbe806c81c27bf6b1)

commit 5bf729f

 Show file tree

 Hide file tree

Showing
**12 changed files**
with
**804 additions**
and
**868 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* ext/java/nokogiri

  + ext/java/nokogiri/Html4SaxPushParser.java
    [Html4SaxPushParser.java](#diff-61027c8ceae2a5f38daa90ed373a2640ddaf246998a2be52c2eae1188649a798)
  + ext/java/nokogiri/XmlSaxParserContext.java
    [XmlSaxParserContext.java](#diff-775ba6caa3c3af9f1eac758058eb49bb15e3692111cffc9d0743c3ba57557ff5)
  + ext/java/nokogiri/XmlSaxPushParser.java
    [XmlSaxPushParser.java](#diff-94a20a7cf62cda5d68e45de3415465969d65d4852be40a2dd582f9c8d8e5be34)
  + internals

    - ext/java/nokogiri/internals/NokogiriEntityResolver.java
      [NokogiriEntityResolver.java](#diff-a9b55bb0a630de8c7d6305b7530bb4f946cd0fbc93a3158307f0d2f1f996a17a)
    - ext/java/nokogiri/internals/NokogiriErrorHandler.java
      [NokogiriErrorHandler.java](#diff-cf658fa5ab21278949e9412e0657885793599f95fbd269155f3beb3314654ea6)
    - ext/java/nokogiri/internals/NokogiriHandler.java
      [NokogiriHandler.java](#diff-30e6361e12967f6197f544ff51072fb8a2c669d31621a3d8c8877495a79412de)
    - ext/java/nokogiri/internals/NokogiriNonStrictErrorHandler.java
      [NokogiriNonStrictErrorHandler.java](#diff-28deb8a4ab0a945ef15a32a4484db7ef04b95777e6801cb27bcece43e0ea7435)
    - ext/java/nokogiri/internals/NokogiriNonStrictErrorHandler4NekoHtml.java
      [NokogiriNonStrictErrorHandler4NekoHtml.java](#diff-cafc4e0b9bf3962b2195893e8c4e362d82e23fd6ce670e2a1fb9cc6616bab68e)
    - ext/java/nokogiri/internals/NokogiriStrictErrorHandler.java
      [NokogiriStrictErrorHandler.java](#diff-a62e00fec48cf15c0adaaf08f7a2a497098f76d4b8e43f23e821ea1ce1e49900)
    - ext/java/nokogiri/internals/XmlDomParserContext.java
      [XmlDomParserContext.java](#diff-817219957a20dc69f88a3e79d0721adbfaa27fc12c7337327bbd0dab9843428f)
* test/xml/sax

  + test/xml/sax/test\_parser.rb
    [test\_parser.rb](#diff-06a2208533820bd5c42dbbc1af78c033abd864df8bb8529496d88aa41debc8c9)
  + test/xml/sax/test\_push\_parser.rb
    [test\_push\_parser.rb](#diff-788d0fa57c8f3da3a3d1b72c150d5af572fe1e45739910f70bc892e3fd01ee8d)

## There are no files selected for viewing

33 changes: 14 additions & 19 deletions

33
[ext/java/nokogiri/Html4SaxPushParser.java](#diff-61027c8ceae2a5f38daa90ed373a2640ddaf246998a2be52c2eae1188649a798 "ext/java/nokogiri/Html4SaxPushParser.java")

Show comments

[View file](/sparklemotion/nokogiri/blob/5bf729ff3cc84709ee3c3248c981584088bf9f6d/ext/java/nokogiri/Html4SaxPushParser.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,31 +1,26 @@ |
|  |  | package nokogiri; |
|  |  |  |
|  |  | import static nokogiri.XmlSaxPushParser.terminateExecution; |
|  |  | import static nokogiri.internals.NokogiriHelpers.getNokogiriClass; |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | import java.io.ByteArrayInputStream; |
|  |  | import java.io.InputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.util.concurrent.Callable; |
|  |  | import java.util.concurrent.ExecutionException; |
|  |  | import java.util.concurrent.ExecutorService; |
|  |  | import java.util.concurrent.Executors; |
|  |  | import java.util.concurrent.Future; |
|  |  | import java.util.concurrent.FutureTask; |
|  |  | import java.util.concurrent.ThreadFactory; |
|  |  |  |
|  |  | import nokogiri.internals.\*; |
|  |  |  |
|  |  | import nokogiri.internals.ClosedStreamException; |
|  |  | import nokogiri.internals.NokogiriBlockingQueueInputStream; |
|  |  | import nokogiri.internals.NokogiriHelpers; |
|  |  | import nokogiri.internals.ParserContext; |
|  |  | import org.jruby.Ruby; |
|  |  | import org.jruby.RubyClass; |
|  |  | import org.jruby.RubyObject; |
|  |  | import org.jruby.anno.JRubyClass; |
|  |  | import org.jruby.anno.JRubyMethod; |
|  |  | import org.jruby.exceptions.RaiseException; |
|  |  | import org.jruby.runtime.ThreadContext; |
|  |  | import org.jruby.runtime.builtin.IRubyObject; |
|  |  |  |
|  |  | import java.io.ByteArrayInputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.util.concurrent.\*; |
|  |  |  |
|  |  | import static nokogiri.XmlSaxPushParser.terminateExecution; |
|  |  | import static nokogiri.internals.NokogiriHelpers.getNokogiriClass; |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Class for Nokogiri::HTML4::SAX::PushParser |
|  |  | \* |
| Expand Down  Expand Up | | @@ -134,7 +129,7 @@ public class Html4SaxPushParser extends RubyObject |
|  |  |  |
|  |  | if (!options.recover && parserTask.getErrorCount() > errorCount0) { |
|  |  | terminateTask(context.runtime); |
|  |  | throw parserTask.getLastError(); |
|  |  | throw parserTask.getLastError().toThrowable(); |
|  |  | } |
|  |  |  |
|  |  | return this; |
| Expand Down | |  |

124 changes: 31 additions & 93 deletions

124
[ext/java/nokogiri/XmlSaxParserContext.java](#diff-775ba6caa3c3af9f1eac758058eb49bb15e3692111cffc9d0743c3ba57557ff5 "ext/java/nokogiri/XmlSaxParserContext.java")

Show comments

[View file](/sparklemotion/nokogiri/blob/5bf729ff3cc84709ee3c3248c981584088bf9f6d/ext/java/nokogiri/XmlSaxParserContext.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,33 +1,23 @@ |
|  |  | package nokogiri; |
|  |  |  |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  |  |
|  |  | import nokogiri.internals.\*; |
|  |  | import org.apache.xerces.parsers.AbstractSAXParser; |
|  |  | import org.jruby.Ruby; |
|  |  | import org.jruby.RubyClass; |
|  |  | import org.jruby.RubyFixnum; |
|  |  | import org.jruby.RubyModule; |
|  |  | import org.jruby.RubyObjectAdapter; |
|  |  | import org.jruby.anno.JRubyClass; |
|  |  | import org.jruby.anno.JRubyMethod; |
|  |  | import org.jruby.exceptions.RaiseException; |
|  |  | import org.jruby.javasupport.JavaEmbedUtils; |
|  |  | import org.jruby.runtime.Helpers; |
|  |  | import org.jruby.runtime.ThreadContext; |
|  |  | import org.jruby.runtime.builtin.IRubyObject; |
|  |  | import org.xml.sax.ContentHandler; |
|  |  | import org.xml.sax.ErrorHandler; |
|  |  | import org.xml.sax.SAXException; |
|  |  | import org.xml.sax.SAXNotRecognizedException; |
|  |  | import org.xml.sax.SAXNotSupportedException; |
|  |  | import org.xml.sax.SAXParseException; |
|  |  |  |
|  |  | import nokogiri.internals.NokogiriHandler; |
|  |  | import nokogiri.internals.NokogiriHelpers; |
|  |  | import nokogiri.internals.ParserContext; |
|  |  | import nokogiri.internals.XmlSaxParser; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  |  |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Base class for the SAX parsers. |
| Expand All | | @@ -51,6 +41,7 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | protected AbstractSAXParser parser; |
|  |  |  |
|  |  | protected NokogiriHandler handler; |
|  |  | protected NokogiriErrorHandler errorHandler; |
|  |  | private boolean replaceEntities = true; |
|  |  | private boolean recovery = false; |
|  |  |  |
| Expand Down  Expand Up | | @@ -168,31 +159,12 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | return (XmlSaxParserContext) NokogiriService.XML\_SAXPARSER\_CONTEXT\_ALLOCATOR.allocate(runtime, klazz); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Set a property of the underlying parser. |
|  |  | \*/ |
|  |  | protected void |
|  |  | setProperty(String key, Object val) |
|  |  | throws SAXNotRecognizedException, SAXNotSupportedException |
|  |  | { |
|  |  | parser.setProperty(key, val); |
|  |  | } |
|  |  |  |
|  |  | protected void |
|  |  | setContentHandler(ContentHandler handler) |
|  |  | { |
|  |  | parser.setContentHandler(handler); |
|  |  | } |
|  |  |  |
|  |  | protected void |
|  |  | setErrorHandler(ErrorHandler handler) |
|  |  | { |
|  |  | parser.setErrorHandler(handler); |
|  |  | } |
|  |  |  |
|  |  | public final NokogiriHandler |
|  |  | getNokogiriHandler() { return handler; } |
|  |  |  |
|  |  | public final NokogiriErrorHandler |
|  |  | getNokogiriErrorHandler() { return errorHandler; } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Perform any initialization prior to parsing with the handler |
|  |  | \* <code>handlerRuby</code>. Convenience hook for subclasses. |
| Expand Down  Expand Up | | @@ -223,6 +195,17 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | parser.parse(getInputSource()); |
|  |  | } |
|  |  |  |
|  |  | protected static Options |
|  |  | defaultParseOptions(ThreadContext context) |
|  |  | { |
|  |  | return new ParserContext.Options( |
|  |  | RubyFixnum.fix2long(Helpers.invoke(context, |
|  |  | ((RubyClass)context.getRuntime().getClassFromPath("Nokogiri::XML::ParseOptions")) |
|  |  | .getConstant("DEFAULT\_XML"), |
|  |  | "to\_i")) |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | @JRubyMethod |
|  |  | public IRubyObject |
|  |  | parse\_with(ThreadContext context, IRubyObject handlerRuby) |
| Expand All | | @@ -233,14 +216,19 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | throw runtime.newArgumentError("argument must respond\_to document"); |
|  |  | } |
|  |  |  |
|  |  | NokogiriHandler handler = this.handler = new NokogiriHandler(runtime, handlerRuby); |
|  |  | preParse(runtime, handlerRuby, handler); |
|  |  | /\* TODO: how should we pass in parse options? \*/ |
|  |  | ParserContext.Options options = defaultParseOptions(context); |
|  |  |  |
|  |  | errorHandler = new NokogiriStrictErrorHandler(runtime, options.noError, options.noWarning); |
|  |  | handler = new NokogiriHandler(runtime, handlerRuby, errorHandler); |
|  |  |  |
|  |  | setContentHandler(handler); |
|  |  | setErrorHandler(handler); |
|  |  | preParse(runtime, handlerRuby, handler); |
|  |  | parser.setContentHandler(handler); |
|  |  | parser.setErrorHandler(handler); |
|  |  | parser.setEntityResolver(new NokogiriEntityResolver(runtime, errorHandler, options)); |
|  |  |  |
|  |  | try { |
|  |  | setProperty("http://xml.org/sax/properties/lexical-handler", handler); |
|  |  | parser.setProperty("http://xml.org/sax/properties/lexical-handler", handler); |
|  |  | } catch (Exception ex) { |
|  |  | throw runtime.newRuntimeError("Problem while creating XML SAX Parser: " + ex.toString()); |
|  |  | } |
| Expand Down  Expand Up | | @@ -270,8 +258,6 @@ public class XmlSaxParserContext extends ParserContext |
|  |  |  |
|  |  | postParse(runtime, handlerRuby, handler); |
|  |  |  |
|  |  | //maybeTrimLeadingAndTrailingWhitespace(context, handlerRuby); |
|  |  |  |
|  |  | return runtime.getNil(); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -319,53 +305,6 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | return context.runtime.newBoolean(recovery); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* If the handler's document is a FragmentHandler, attempt to trim |
|  |  | \* leading and trailing whitespace. |
|  |  | \* |
|  |  | \* This is a bit hackish and depends heavily on the internals of |
|  |  | \* FragmentHandler. |
|  |  | \*/ |
|  |  | protected void |
|  |  | maybeTrimLeadingAndTrailingWhitespace(ThreadContext context, IRubyObject parser) |
|  |  | { |
|  |  | RubyObjectAdapter adapter = JavaEmbedUtils.newObjectAdapter(); |
|  |  | RubyModule mod = context.getRuntime().getClassFromPath("Nokogiri::XML::FragmentHandler"); |
|  |  |  |
|  |  | IRubyObject handler = adapter.getInstanceVariable(parser, "@document"); |
|  |  | if (handler == null || handler.isNil() || !adapter.isKindOf(handler, mod)) { |
|  |  | return; |
|  |  | } |
|  |  | IRubyObject stack = adapter.getInstanceVariable(handler, "@stack"); |
|  |  | if (stack == null || stack.isNil()) { |
|  |  | return; |
|  |  | } |
|  |  | // doc is finally a DocumentFragment whose nodes we can check |
|  |  | IRubyObject doc = adapter.callMethod(stack, "first"); |
|  |  | if (doc == null || doc.isNil()) { |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | IRubyObject children; |
|  |  |  |
|  |  | for (;;) { |
|  |  | children = adapter.callMethod(doc, "children"); |
|  |  | IRubyObject first = adapter.callMethod(children, "first"); |
|  |  | if (NokogiriHelpers.isBlank(first)) { adapter.callMethod(first, "unlink"); } |
|  |  | else { break; } |
|  |  | } |
|  |  |  |
|  |  | for (;;) { |
|  |  | children = adapter.callMethod(doc, "children"); |
|  |  | IRubyObject last = adapter.callMethod(children, "last"); |
|  |  | if (NokogiriHelpers.isBlank(last)) { adapter.callMethod(last, "unlink"); } |
|  |  | else { break; } |
|  |  | } |
|  |  |  |
|  |  | // While we have a document, normalize it. |
|  |  | ((XmlNode) doc).normalize(); |
|  |  | } |
|  |  |  |
|  |  | @JRubyMethod(name = "column") |
|  |  | public IRubyObject |
|  |  | column(ThreadContext context) |
| Expand All | | @@ -383,5 +322,4 @@ public class XmlSaxParserContext extends ParserContext |
|  |  | if (number == null) { return context.getRuntime().getNil(); } |
|  |  | return RubyFixnum.newFixnum(context.getRuntime(), number.longValue()); |
|  |  | } |
|  |  |  |
|  |  | } |

42 changes: 17 additions & 25 deletions

42
[ext/java/nokogiri/XmlSaxPushParser.java](#diff-94a20a7cf62cda5d68e45de3415465969d65d4852be40a2dd582f9c8d8e5be34 "ext/java/nokogiri/XmlSaxPushParser.java")

Show comments

[View file](/sparklemotion/nokogiri/blob/5bf729ff3cc84709ee3c3248c981584088bf9f6d/ext/java/nokogiri/XmlSaxPushParser.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,32 +1,24 @@ |
|  |  | package nokogiri; |
|  |  |  |
|  |  | import static nokogiri.internals.NokogiriHelpers.getNokogiriClass; |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | import java.io.ByteArrayInputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.util.concurrent.ExecutionException; |
|  |  | import java.util.concurrent.ExecutorService; |
|  |  | import java.util.concurrent.Executors; |
|  |  | import java.util.concurrent.Future; |
|  |  | import java.util.concurrent.FutureTask; |
|  |  | import java.util.concurrent.ThreadFactory; |
|  |  |  |
|  |  | import nokogiri.internals.\*; |
|  |  | import org.jruby.Ruby; |
|  |  | import org.jruby.RubyClass; |
|  |  | import org.jruby.RubyException; |
|  |  | import org.jruby.RubyObject; |
|  |  | import org.jruby.anno.JRubyClass; |
|  |  | import org.jruby.anno.JRubyMethod; |
|  |  | import org.jruby.exceptions.RaiseException; |
|  |  | import org.jruby.runtime.ThreadContext; |
|  |  | import org.jruby.runtime.builtin.IRubyObject; |
|  |  |  |
|  |  | import nokogiri.internals.ClosedStreamException; |
|  |  | import nokogiri.internals.NokogiriBlockingQueueInputStream; |
|  |  | import nokogiri.internals.NokogiriHandler; |
|  |  | import nokogiri.internals.NokogiriHelpers; |
|  |  | import nokogiri.internals.ParserContext; |
|  |  | import java.io.ByteArrayInputStream; |
|  |  | import java.io.IOException; |
|  |  | import java.io.InputStream; |
|  |  | import java.util.List; |
|  |  | import java.util.concurrent.\*; |
|  |  |  |
|  |  | import static nokogiri.internals.NokogiriHelpers.getNokogiriClass; |
|  |  | import static org.jruby.runtime.Helpers.invoke; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Class for Nokogiri::XML::SAX::PushParser |
| Expand Down  Expand Up | | @@ -159,7 +151,8 @@ public class XmlSaxPushParser extends RubyObject |
|  |  |  |
|  |  | if (!options.recover && parserTask.getErrorCount() > errorCount0) { |
|  |  | terminateTask(context.runtime); |
|  |  | throw ex = parserTask.getLastError(); |
|  |  | ex = parserTask.getLastError().toThrowable(); |
|  |  | throw ex; |
|  |  | } |
|  |  |  |
|  |  | return this; |
| Expand Down  Expand Up | | @@ -278,16 +271,15 @@ static class ParserTask extends ParserContext.ParserTask<XmlSaxParserContext> |
|  |  | getErrorCount() |
|  |  | { |
|  |  | // check for null because thread may not have started yet |
|  |  | if (parser.getNokogiriHandler() == null) { return 0; } |
|  |  | return parser.getNokogiriHandler().getErrorCount(); |
|  |  | if (parser.getNokogiriErrorHandler() == null) { return 0; } |
|  |  | return parser.getNokogiriErrorHandler().getErrors().size(); |
|  |  | } |
|  |  |  |
|  |  | synchronized final RaiseException |
|  |  | synchronized final RubyException |
|  |  | getLastError() |
|  |  | { |
|  |  | return parser.getNokogiriHandler().getLastError(); |
|  |  | List<RubyException> errors = parser.getNokogiriErrorHandler().getErrors(); |
|  |  | return errors.get(errors.size() - 1); |
|  |  | } |
|  |  |  |
|  |  | } |
|  |  |  |
|  |  | } |

2 changes: 1 addition & 1 deletion

2
[ext/java/nokogiri/internals/NokogiriEntityResolver.java](#diff-a9b55bb0a630de8c7d6305b7530bb4f946cd0fbc93a3158307f0d2f1f996a17a "ext/java/nokogiri/internals/NokogiriEntityResolver.java")

Show comments

[View file](/sparklemotion/nokogiri/blob/5bf729ff3cc84709ee3c3248c981584088bf9f6d/ext/java/nokogiri/internals/NokogiriEntityResolver.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -85,7 +85,7 @@ public class NokogiriEntityResolver implements EntityResolver2 |
|  |  | private void |
|  |  | addError(String errorMessage) |
|  |  | { |
|  |  | if (handler != null) { handler.errors.add(new Exception(errorMessage)); } |
|  |  | if (handler != null) { handler.addError(new Exception(errorMessage)); } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

37 changes: 29 additions & 8 deletions

37
[ext/java/nokogiri/internals/NokogiriErrorHandler.java](#diff-cf658fa5ab21278949e9412e0657885793599f95fbd269155f3beb3314654ea6 "ext/java/nokogiri/internals/NokogiriErrorHandler.java")

Show comments

[View file](/sparklemotion/nokogiri/blob/5bf729ff3cc84709ee3c3248c981584088bf9f6d/ext/java/nokogiri/internals/NokogiriErrorHandler.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,11 +1,15 @@ |
|  |  | package nokogiri.internals; |
|  |  |  |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.List; |
|  |  |  |
|  |  | import nokogiri.XmlSyntaxError; |
|  |  | import org.apache.xerces.xni.parser.XMLErrorHandler; |
|  |  | import org.jruby.Ruby; |
|  |  | import org.jruby.RubyException; |
|  |  | import org.jruby.exceptions.RaiseException; |
|  |  | import org.xml.sax.ErrorHandler; |
|  |  |  |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.List; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Super class of error handlers. |
|  |  | \* |
| Expand All | | @@ -17,23 +21,40 @@ |
|  |  | \*/ |
|  |  | public abstract class NokogiriErrorHandler implements ErrorHandler, XMLErrorHandler |
|  |  | { |
|  |  | protected final List<Exception> errors; |
|  |  | private final Ruby runtime; |
|  |  | protected final List<RubyException> errors; |
|  |  | protected boolean noerror; |
|  |  | protected boolean nowarning; |
|  |  |  |
|  |  | public |
|  |  | NokogiriErrorHandler(boolean noerror, boolean nowarning) |
|  |  | NokogiriErrorHandler(Ruby runtime, boolean noerror, boolean nowarning) |
|  |  | { |
|  |  | this.errors = new ArrayList<Exception>(4); |
|  |  | this.runtime = runtime; |
|  |  | this.errors = new ArrayList<RubyException>(4); |
|  |  | this.noerror = noerror; |
|  |  | this.nowarning = nowarning; |
|  |  | } |
|  |  |  |
|  |  | List<Exception> |
|  |  | public List<RubyException> |
|  |  | getErrors() { return errors; } |
|  |  |  |
|  |  | public void |
|  |  | addError(Exception ex) { errors.add(ex); } |
|  |  | addError(Exception ex) |
|  |  | { |
|  |  | addError(XmlSyntaxError.createXMLSyntaxError(runtime, ex)); |
|  |  | } |
|  |  |  |
|  |  | public void |
|  |  | addError(RubyException ex) |
|  |  | { |
|  |  | errors.add(ex); |
|  |  | } |
|  |  |  |
|  |  | public void |
|  |  | addError(RaiseException ex) |
|  |  | { |
|  |  | addError(ex.getException()); |
|  |  | } |
|  |  |  |
|  |  | protected boolean |
|  |  | usesNekoHtml(String domain) |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5bf729f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsparklemotion%2Fnokogiri%2Fcommit%2F5bf729ff3cc84709ee3c3248c981584088bf9f6d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_84842ebd_20250115_085447.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsparklemotion%2Fnokogiri%2Fsecurity%2Fadvisories%2FGHSA-2rr5-8q37-2w7h)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsparklemotion%2Fnokogiri%2Fsecurity%2Fadvisories%2FGHSA-2rr5-8q37-2w7h)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=sparklemotion%2Fnokogiri)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[sparklemotion](/sparklemotion)
/
**[nokogiri](/sparklemotion/nokogiri)**
Public

* [Notifications](/login?return_to=%2Fsparklemotion%2Fnokogiri) You must be signed in to change notification settings
* [Fork
  905](/login?return_to=%2Fsparklemotion%2Fnokogiri)
* [Star
   6.2k](/login?return_to=%2Fsparklemotion%2Fnokogiri)

* [Code](/sparklemotion/nokogiri)
* [Issues
  63](/sparklemotion/nokogiri/issues)
* [Pull requests
  25](/sparklemotion/nokogiri/pulls)
* [Discussions](/sparklemotion/nokogiri/discussions)
* [Actions](/sparklemotion/nokogiri/actions)
* [Projects
  0](/sparklemotion/nokogiri/projects)
* [Wiki](/sparklemotion/nokogiri/wiki)
* [Security](/sparklemotion/nokogiri/security)
* [Insights](/sparklemotion/nokogiri/pulse)

Additional navigation options

* [Code](/sparklemotion/nokogiri)
* [Issues](/sparklemotion/nokogiri/issues)
* [Pull requests](/sparklemotion/nokogiri/pulls)
* [Discussions](/sparklemotion/nokogiri/discussions)
* [Actions](/sparklemotion/nokogiri/actions)
* [Projects](/sparklemotion/nokogiri/projects)
* [Wiki](/sparklemotion/nokogiri/wiki)
* [Security](/sparklemotion/nokogiri/security)
* [Insights](/sparklemotion/nokogiri/pulse)

# Improper Restriction of XML External Entity Reference (XXE) in Nokogiri on JRuby

High

[flavorjones](/flavorjones)
published
GHSA-2rr5-8q37-2w7h
Sep 27, 2021

## Package

bundler

nokogiri
([RubyGems](/advisories?query=ecosystem%3Arubygems))

## Affected versions

<= 1.12.4

## Patched versions

>= 1.12.5

## Description

### Severity

The Nokogiri maintainers have evaluated this as [**High Severity** 7.5 (CVSS3.0)](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N/E:H/RL:O/RC:C/MAV:N/MAC:L) for JRuby users. (This security advisory does not apply to CRuby users.)

### Impact

In Nokogiri v1.12.4 and earlier, **on JRuby only**, the SAX parser resolves external entities by default.

Users of Nokogiri on JRuby who parse untrusted documents using any of these classes are affected:

* Nokogiri::XML::SAX::Parser
* Nokogiri::HTML4::SAX::Parser or its alias Nokogiri::HTML::SAX::Parser
* Nokogiri::XML::SAX::PushParser
* Nokogiri::HTML4::SAX::PushParser or its alias Nokogiri::HTML::SAX::PushParser

### Mitigation

JRuby users should upgrade to Nokogiri v1.12.5 or later. There are no workarounds available for v1.12.4 or earlier.

CRuby users are not affected.

### Credit

This vulnerability was reported by [Andrew Crewdson](https://hackerone.com/acrewdson?type=user).

### References

[CWE - CWE-611: Improper Restriction of XML External Entity Reference (4.5)](https://cwe.mitre.org/data/definitions/611.html)

### For more information

* [XML External Entity (XXE) Processing | OWASP](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing)
* [A4:2017-XML External Entities (XXE) | OWASP](https://owasp.org/www-project-top-ten/2017/A4_2017-XML_External_Entities_%28XXE%29)
* [XML External Entity Prevention - OWASP Cheat Sheet Series](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)

### Severity

High

### CVE ID

CVE-2021-41098

### Weaknesses

[CWE-611](/advisories?query=cwe%3A611)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


