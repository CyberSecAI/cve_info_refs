=== Content from github.com_7b56a5be_20250114_212713.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscrapy-plugins%2Fscrapy-splash%2Fcommit%2F2b253e57fe64ec575079c8cdc99fe2013502ea31)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscrapy-plugins%2Fscrapy-splash%2Fcommit%2F2b253e57fe64ec575079c8cdc99fe2013502ea31)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=scrapy-plugins%2Fscrapy-splash)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[scrapy-plugins](/scrapy-plugins)
/
**[scrapy-splash](/scrapy-plugins/scrapy-splash)**
Public

* [Notifications](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash) You must be signed in to change notification settings
* [Fork
  454](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash)
* [Star
   3.2k](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash)

* [Code](/scrapy-plugins/scrapy-splash)
* [Issues
  65](/scrapy-plugins/scrapy-splash/issues)
* [Pull requests
  16](/scrapy-plugins/scrapy-splash/pulls)
* [Actions](/scrapy-plugins/scrapy-splash/actions)
* [Projects
  0](/scrapy-plugins/scrapy-splash/projects)
* [Wiki](/scrapy-plugins/scrapy-splash/wiki)
* [Security](/scrapy-plugins/scrapy-splash/security)
* [Insights](/scrapy-plugins/scrapy-splash/pulse)

Additional navigation options

* [Code](/scrapy-plugins/scrapy-splash)
* [Issues](/scrapy-plugins/scrapy-splash/issues)
* [Pull requests](/scrapy-plugins/scrapy-splash/pulls)
* [Actions](/scrapy-plugins/scrapy-splash/actions)
* [Projects](/scrapy-plugins/scrapy-splash/projects)
* [Wiki](/scrapy-plugins/scrapy-splash/wiki)
* [Security](/scrapy-plugins/scrapy-splash/security)
* [Insights](/scrapy-plugins/scrapy-splash/pulse)

## Commit

[Permalink](/scrapy-plugins/scrapy-splash/commit/2b253e57fe64ec575079c8cdc99fe2013502ea31)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Implement SPLASH\_USER and SPLASH\_PASS

[Browse files](/scrapy-plugins/scrapy-splash/tree/2b253e57fe64ec575079c8cdc99fe2013502ea31)
Browse the repository at this point in the history

* Loading branch information

[![@Gallaecio](https://avatars.githubusercontent.com/u/705211?s=40&v=4)](/Gallaecio)

[Gallaecio](/scrapy-plugins/scrapy-splash/commits?author=Gallaecio "View all commits by Gallaecio")
authored
Oct 4, 2021

1 parent
[783c58d](/scrapy-plugins/scrapy-splash/commit/783c58d1c8754e9c2442190189a5dd09c658a669)

commit 2b253e5

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**547 additions**
and
**94 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGES.rst
  [CHANGES.rst](#diff-ff3c479edefad986d2fe6fe7ead575a46b086e3bbcf0ccc86d85efc4a4c63c79)
* README.rst
  [README.rst](#diff-7b3ed02bc73dc06b7db906cf97aa91dec2b2eb21f2d92bc5caa761df5bbc168f)
* example/scrashtest

  + example/scrashtest/settings.py
    [settings.py](#diff-43521aba22c52955599ef3486ad8ca9a7d69067485a265bde95c97d90339f995)
* scrapy\_splash

  + scrapy\_splash/middleware.py
    [middleware.py](#diff-fc30306197c4c507eb681fac81ec53903569dd2708ecc7029ae532d3f437bd52)
* tests

  + tests/conftest.py
    [conftest.py](#diff-e52e4ddd58b7ef887ab03c04116e676f6280b824ab7469d5d3080e5cba4f2128)
  + tests/resources.py
    [resources.py](#diff-fe4ce32c14ed9fa1a13446620c9a515548d4557f6d7450745730945bf3f84598)
  + tests/test\_integration.py
    [test\_integration.py](#diff-98bfe78f0e8d895dd454b5eef6f6485a80526776ad3b6525a14117029bd1eacb)
  + tests/test\_middleware.py
    [test\_middleware.py](#diff-d319080c452f8bf63a43eda499db0c36b519a06613cfab6d97dacaab811fd257)
  + tests/utils.py
    [utils.py](#diff-9e08e8c7769db7b58089fd7659d75ca96df40bb7b5d50299d3a30abd54da9ad6)

## There are no files selected for viewing

13 changes: 13 additions & 0 deletions

13
[CHANGES.rst](#diff-ff3c479edefad986d2fe6fe7ead575a46b086e3bbcf0ccc86d85efc4a4c63c79 "CHANGES.rst")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/CHANGES.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -4,6 +4,19 @@ Changes |
|  |  | 0.8.0 (2021-10-04) |
|  |  | ------------------ |
|  |  |  |
|  |  | \* \*\*Security bug fix:\*\* |
|  |  |  |
|  |  | If you use :ref:`HttpAuthMiddleware` (i.e. the ``http\_user`` and |
|  |  | ``http\_pass`` spider attributes) for Splash authentication, any non-Splash |
|  |  | request will expose your credentials to the request target. This includes |
|  |  | ``robots.txt`` requests sent by Scrapy when the ``ROBOTSTXT\_OBEY`` setting |
|  |  | is set to ``True``. |
|  |  |  |
|  |  | Use the new ``SPLASH\_USER`` and ``SPLASH\_PASS`` settings instead to set |
|  |  | your Splash authentication credentials safely. |
|  |  |  |
|  |  | .. \_HttpAuthMiddleware: http://doc.scrapy.org/en/latest/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpauth |
|  |  |  |
|  |  | \* Responses now expose the HTTP status code and headers from Splash as |
|  |  | ``response.splash\_response\_status`` and |
|  |  | ``response.splash\_response\_headers`` (#158) |
| Expand Down | |  |

25 changes: 22 additions & 3 deletions

25
[README.rst](#diff-7b3ed02bc73dc06b7db906cf97aa91dec2b2eb21f2d92bc5caa761df5bbc168f "README.rst")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/README.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -582,12 +582,31 @@ on Splash server and is not sent with each request (it requires Splash 2.1+):: |
|  |  | HTTP Basic Auth |
|  |  | =============== |
|  |  |  |
|  |  | If you need HTTP Basic Authentication to access Splash, use |
|  |  | Scrapy's HttpAuthMiddleware\_. |
|  |  | If you need to use HTTP Basic Authentication to access Splash, use the |
|  |  | ``SPLASH\_USER`` and ``SPLASH\_PASS`` optional settings:: |
|  |  |  |
|  |  | SPLASH\_USER = 'user' |
|  |  | SPLASH\_PASS = 'userpass' |
|  |  |  |
|  |  | Another option is ``meta['splash']['splash\_headers']``: it allows to set |
|  |  | custom headers which are sent to Splash server; add Authorization header |
|  |  | to ``splash\_headers`` if HttpAuthMiddleware doesn't fit for some reason. |
|  |  | to ``splash\_headers`` if you want to change credentials per-request:: |
|  |  |  |
|  |  | import scrapy |
|  |  | from w3lib.http import basic\_auth\_header |
|  |  |  |
|  |  | class MySpider(scrapy.Spider): |
|  |  | # ... |
|  |  | def start\_requests(self): |
|  |  | auth = basic\_auth\_header('user', 'userpass') |
|  |  | yield SplashRequest(url, self.parse, |
|  |  | splash\_headers={'Authorization': auth}) |
|  |  |  |
|  |  | \*\*WARNING:\*\* Don't use :ref:`HttpAuthMiddleware` |
|  |  | (i.e. ``http\_user`` / ``http\_pass`` spider attributes) for Splash |
|  |  | authentication: if you occasionally send a non-Splash request from your spider, |
|  |  | you may expose Splash credentials to a remote website, as HttpAuthMiddleware |
|  |  | sets credentials for all requests unconditionally. |
|  |  |  |
|  |  | .. \_HttpAuthMiddleware: http://doc.scrapy.org/en/latest/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpauth |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[example/scrashtest/settings.py](#diff-43521aba22c52955599ef3486ad8ca9a7d69067485a265bde95c97d90339f995 "example/scrashtest/settings.py")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/example/scrashtest/settings.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,3 +20,4 @@ |
|  |  | # SPLASH\_URL = 'http://192.168.59.103:8050/' |
|  |  | DUPEFILTER\_CLASS = 'scrapy\_splash.SplashAwareDupeFilter' |
|  |  | HTTPCACHE\_STORAGE = 'scrapy\_splash.SplashAwareFSCacheStorage' |
|  |  | ROBOTSTXT\_OBEY = True |

80 changes: 68 additions & 12 deletions

80
[scrapy\_splash/middleware.py](#diff-fc30306197c4c507eb681fac81ec53903569dd2708ecc7029ae532d3f437bd52 "scrapy_splash/middleware.py")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/scrapy_splash/middleware.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -10,11 +10,13 @@ |
|  |  | from six.moves.urllib.parse import urljoin |
|  |  | from six.moves.http\_cookiejar import CookieJar |
|  |  |  |
|  |  | from w3lib.http import basic\_auth\_header |
|  |  | import scrapy |
|  |  | from scrapy.exceptions import NotConfigured |
|  |  | from scrapy.exceptions import NotConfigured, IgnoreRequest |
|  |  | from scrapy.http.headers import Headers |
|  |  | from scrapy.http.response.text import TextResponse |
|  |  | from scrapy import signals |
|  |  | from scrapy.downloadermiddlewares.robotstxt import RobotsTxtMiddleware |
|  |  |  |
|  |  | from scrapy\_splash.responsetypes import responsetypes |
|  |  | from scrapy\_splash.cookies import jar\_to\_har, har\_to\_jar |
| Expand Down  Expand Up | | @@ -222,26 +224,34 @@ class SplashMiddleware(object): |
|  |  | retry\_498\_priority\_adjust = +50 |
|  |  | remote\_keys\_key = '\_splash\_remote\_keys' |
|  |  |  |
|  |  | def \_\_init\_\_(self, crawler, splash\_base\_url, slot\_policy, log\_400): |
|  |  | def \_\_init\_\_(self, crawler, splash\_base\_url, slot\_policy, log\_400, auth): |
|  |  | self.crawler = crawler |
|  |  | self.splash\_base\_url = splash\_base\_url |
|  |  | self.slot\_policy = slot\_policy |
|  |  | self.log\_400 = log\_400 |
|  |  | self.crawler.signals.connect(self.spider\_opened, signals.spider\_opened) |
|  |  | self.auth = auth |
|  |  |  |
|  |  | @classmethod |
|  |  | def from\_crawler(cls, crawler): |
|  |  | splash\_base\_url = crawler.settings.get('SPLASH\_URL', |
|  |  | cls.default\_splash\_url) |
|  |  | log\_400 = crawler.settings.getbool('SPLASH\_LOG\_400', True) |
|  |  | slot\_policy = crawler.settings.get('SPLASH\_SLOT\_POLICY', |
|  |  | cls.default\_policy) |
|  |  | s = crawler.settings |
|  |  | splash\_base\_url = s.get('SPLASH\_URL', cls.default\_splash\_url) |
|  |  | log\_400 = s.getbool('SPLASH\_LOG\_400', True) |
|  |  | slot\_policy = s.get('SPLASH\_SLOT\_POLICY', cls.default\_policy) |
|  |  | if slot\_policy not in SlotPolicy.\_known: |
|  |  | raise NotConfigured("Incorrect slot policy: %r" % slot\_policy) |
|  |  |  |
|  |  | return cls(crawler, splash\_base\_url, slot\_policy, log\_400) |
|  |  | splash\_user = s.get('SPLASH\_USER', '') |
|  |  | splash\_pass = s.get('SPLASH\_PASS', '') |
|  |  | auth = None |
|  |  | if splash\_user or splash\_pass: |
|  |  | auth = basic\_auth\_header(splash\_user, splash\_pass) |
|  |  | return cls(crawler, splash\_base\_url, slot\_policy, log\_400, auth) |
|  |  |  |
|  |  | def spider\_opened(self, spider): |
|  |  | if \_http\_auth\_enabled(spider): |
|  |  | replace\_downloader\_middleware(self.crawler, RobotsTxtMiddleware, |
|  |  | SafeRobotsTxtMiddleware) |
|  |  | if not hasattr(spider, 'state'): |
|  |  | spider.state = {} |
|  |  |  |
| Expand All | | @@ -260,21 +270,24 @@ def \_remote\_keys(self): |
|  |  | def process\_request(self, request, spider): |
|  |  | if 'splash' not in request.meta: |
|  |  | return |
|  |  | splash\_options = request.meta['splash'] |
|  |  |  |
|  |  | if request.method not in {'GET', 'POST'}: |
|  |  | logger.warning( |
|  |  | logger.error( |
|  |  | "Currently only GET and POST requests are supported by " |
|  |  | "SplashMiddleware; %(request)s will be handled without Splash", |
|  |  | "SplashMiddleware; %(request)s is dropped", |
|  |  | {'request': request}, |
|  |  | extra={'spider': spider} |
|  |  | ) |
|  |  | return request |
|  |  | self.crawler.stats.inc\_value('splash/dropped/method/{}'.format( |
|  |  | request.method)) |
|  |  | raise IgnoreRequest("SplashRequest doesn't support " |
|  |  | "HTTP {} method".format(request.method)) |
|  |  |  |
|  |  | if request.meta.get("\_splash\_processed"): |
|  |  | # don't process the same request more than once |
|  |  | return |
|  |  |  |
|  |  | splash\_options = request.meta['splash'] |
|  |  | request.meta['\_splash\_processed'] = True |
|  |  |  |
|  |  | slot\_policy = splash\_options.get('slot\_policy', self.slot\_policy) |
| Expand Down  Expand Up | | @@ -319,6 +332,10 @@ def process\_request(self, request, spider): |
|  |  | if not splash\_options.get('dont\_send\_headers'): |
|  |  | headers = scrapy\_headers\_to\_unicode\_dict(request.headers) |
|  |  | if headers: |
|  |  | # Headers set by HttpAuthMiddleware should be used for Splash, |
|  |  | # not for the remote website (backwards compatibility). |
|  |  | if \_http\_auth\_enabled(spider): |
|  |  | headers.pop('Authorization', None) |
|  |  | args.setdefault('headers', headers) |
|  |  |  |
|  |  | body = json.dumps(args, ensure\_ascii=False, sort\_keys=True, indent=4) |
| Expand Down  Expand Up | | @@ -353,6 +370,8 @@ def process\_request(self, request, spider): |
|  |  | splash\_url = urljoin(splash\_base\_url, endpoint) |
|  |  |  |
|  |  | headers = Headers({'Content-Type': 'application/json'}) |
|  |  | if self.auth is not None: |
|  |  | headers['Authorization'] = self.auth |
|  |  | headers.update(splash\_options.get('splash\_headers', {})) |
|  |  | new\_request = request.replace( |
|  |  | url=splash\_url, |
| Expand All | | @@ -361,6 +380,7 @@ def process\_request(self, request, spider): |
|  |  | headers=headers, |
|  |  | priority=request.priority + self.rescheduling\_priority\_adjust |
|  |  | ) |
|  |  | new\_request.meta['dont\_obey\_robotstxt'] = True |
|  |  | self.crawler.stats.inc\_value('splash/%s/request\_count' % endpoint) |
|  |  | return new\_request |
|  |  |  |
| Expand Down  Expand Up | | @@ -478,3 +498,39 @@ def \_get\_slot\_key(self, request\_or\_response): |
|  |  | return self.crawler.engine.downloader.\_get\_slot\_key( |
|  |  | request\_or\_response, None |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | class SafeRobotsTxtMiddleware(RobotsTxtMiddleware): |
|  |  | def process\_request(self, request, spider): |
|  |  | # disable robots.txt for Splash requests |
|  |  | if \_http\_auth\_enabled(spider) and 'splash' in request.meta: |
|  |  | return |
|  |  | return super(SafeRobotsTxtMiddleware, self).process\_request( |
|  |  | request, spider) |
|  |  |  |
|  |  |  |
|  |  | def \_http\_auth\_enabled(spider): |
|  |  | # FIXME: this function should always return False if HttpAuthMiddleware is |
|  |  | # not in a middleware list. |
|  |  | return getattr(spider, 'http\_user', '') or getattr(spider, 'http\_pass', '') |
|  |  |  |
|  |  |  |
|  |  | def replace\_downloader\_middleware(crawler, old\_cls, new\_cls): |
|  |  | """ Replace downloader middleware with another one """ |
|  |  | try: |
|  |  | new\_mw = new\_cls.from\_crawler(crawler) |
|  |  | except NotConfigured: |
|  |  | return |
|  |  |  |
|  |  | mw\_manager = crawler.engine.downloader.middleware |
|  |  | mw\_manager.middlewares = tuple([ |
|  |  | mw if mw.\_\_class\_\_ is not old\_cls else new\_mw |
|  |  | for mw in mw\_manager.middlewares |
|  |  | ]) |
|  |  | for method\_name, callbacks in mw\_manager.methods.items(): |
|  |  | for idx, meth in enumerate(callbacks): |
|  |  | method\_cls = meth.\_\_self\_\_.\_\_class\_\_ |
|  |  | if method\_cls is old\_cls: |
|  |  | new\_meth = getattr(new\_mw, method\_name) |
|  |  | # logger.debug("{} is replaced with {}".format(meth, new\_meth)) |
|  |  | callbacks[idx] = new\_meth |

13 changes: 10 additions & 3 deletions

13
[tests/conftest.py](#diff-e52e4ddd58b7ef887ab03c04116e676f6280b824ab7469d5d3080e5cba4f2128 "tests/conftest.py")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/tests/conftest.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,11 +1,12 @@ |
|  |  | import os |
|  |  |  |
|  |  | import pytest |
|  |  | from scrapy.settings import Settings |
|  |  | from .mockserver import MockServer |
|  |  | from .resources import SplashProtected |
|  |  |  |
|  |  |  |
|  |  | @pytest.fixture() |
|  |  | def settings(request): |
|  |  | def settings(): |
|  |  | """ Default scrapy-splash settings """ |
|  |  | s = dict( |
|  |  | # collect scraped items to .collected\_items attribute |
| Expand All | | @@ -28,6 +29,12 @@ def settings(request): |
|  |  | DUPEFILTER\_CLASS='scrapy\_splash.SplashAwareDupeFilter', |
|  |  | HTTPCACHE\_STORAGE='scrapy\_splash.SplashAwareFSCacheStorage', |
|  |  | ) |
|  |  | return Settings(s) |
|  |  | return s |
|  |  |  |
|  |  |  |
|  |  | @pytest.fixture() |
|  |  | def settings\_auth(settings): |
|  |  | with MockServer(SplashProtected) as s: |
|  |  | print("splash url:", s.root\_url) |
|  |  | settings['SPLASH\_URL'] = s.root\_url |
|  |  | yield settings |

108 changes: 108 additions & 0 deletions

108
[tests/resources.py](#diff-fe4ce32c14ed9fa1a13446620c9a515548d4557f6d7450745730945bf3f84598 "tests/resources.py")

Show comments

[View file](/scrapy-plugins/scrapy-splash/blob/2b253e57fe64ec575079c8cdc99fe2013502ea31/tests/resources.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,108 @@ |
|  |  | # -\*- coding: utf-8 -\*- |
|  |  | import os |
|  |  | from six.moves.urllib.parse import urlparse |
|  |  |  |
|  |  | from twisted.web.resource import Resource |
|  |  | from zope.interface import implementer |
|  |  | from twisted.web import resource, guard, proxy |
|  |  | from twisted.cred.portal import IRealm, Portal |
|  |  | from twisted.cred.checkers import InMemoryUsernamePasswordDatabaseDontUse |
|  |  |  |
|  |  | from scrapy\_splash.utils import to\_bytes |
|  |  |  |
|  |  |  |
|  |  | class HtmlResource(Resource): |
|  |  | isLeaf = True |
|  |  | content\_type = 'text/html' |
|  |  | html = '' |
|  |  | extra\_headers = {} |
|  |  | status\_code = 200 |
|  |  |  |
|  |  | def render\_GET(self, request): |
|  |  | request.setHeader(b'content-type', to\_bytes(self.content\_type)) |
|  |  | for name, value in self.extra\_headers.items(): |
|  |  | request.setHeader(to\_bytes(name), to\_bytes(value)) |
|  |  | request.setResponseCode(self.status\_code) |
|  |  | return to\_bytes(self.html) |
|  |  |  |
|  |  |  |
|  |  | class HelloWorld(HtmlResource): |
|  |  | html = """ |
|  |  | <html><body><script>document.write('hello world!');</script></body></html> |
|  |  | """ |
|  |  | extra\_headers = {'X-MyHeader': 'my value', 'Set-Cookie': 'sessionid=ABCD'} |
|  |  |  |
|  |  |  |
|  |  | class HelloWorldDisallowByRobots(HelloWorld): |
|  |  | """ Disallow itself via robots.txt """ |
|  |  | isLeaf = False |
|  |  |  |
|  |  | def getChild(self, name, request): |
|  |  | if name == b"robots.txt": |
|  |  | return self.RobotsTxt() |
|  |  | return self |
|  |  |  |
|  |  | class RobotsTxt(Resource): |
|  |  | isLeaf = True |
|  |  | def render\_GET(self, request): |
|  |  | return b'User-Agent: \*\nDisallow: /\n' |
|  |  |  |
|  |  |  |
|  |  | class HelloWorldDisallowAuth(HelloWorldDisallowByRobots): |
|  |  | """ Disallow itself via robots.txt if a request to robots.txt |
|  |  | contains basic auth header. """ |
|  |  | class RobotsTxt(HelloWorldDisallowByRobots.RobotsTxt): |
|  |  | def render\_GET(self, request): |
|  |  | if request.requestHeaders.hasHeader('Authorization'): |
|  |  | return super(HelloWorldDisallowAuth.RobotsTxt, self).render\_GET(request) |
|  |  | request.setResponseCode(404) |
|  |  | return b'' |
|  |  |  |
|  |  |  |
|  |  | class Http400Resource(HtmlResource): |
|  |  | status\_code = 400 |
|  |  | html = "Website returns HTTP 400 error" |
|  |  |  |
|  |  |  |
|  |  | class ManyCookies(Resource, object): |
|  |  | class SetMyCookie(HtmlResource): |
|  |  | html = "hello!" |
|  |  | extra\_headers = {'Set-Cookie': 'login=1'} |
|  |  |  |
|  |  | def \_\_init\_\_(self): |
|  |  | super(ManyCookies, self).\_\_init\_\_() |
|  |  | self.putChild(b'', HelloWorld()) |
|  |  | self.putChild(b'login', self.SetMyCookie()) |
|  |  |  |
|  |  |  |
|  |  | def splash\_proxy(): |
|  |  | splash\_url = os.environ.get('SPLASH\_URL') |
|  |  | p = urlparse(splash\_url) |
|  |  | return lambda: proxy.ReverseProxyResource(p.hostname, int(p.port), b'') |
|  |  |  |
|  |  |  |
|  |  | def password\_protected(resource\_cls, username, password): |
|  |  | # Sorry, but this is nuts. A zillion of classes, arbitrary |
|  |  | # unicode / bytes requirements at random places. Is there a simpler |
|  |  | # way to get HTTP Basic Auth working in Twisted? |
|  |  | @implementer(IRealm) |
|  |  | class SimpleRealm(object): |
|  |  | def requestAvatar(self, avatarId, mind, \*interfaces): |
|  |  | if resource.IResource in interfaces: |
|  |  | return resource.IResource, resource\_cls(), lambda: None |
|  |  | raise NotImplementedError() |
|  |  |  |
|  |  | creds = {username: password} |
|  |  | checkers = [InMemoryUsernamePasswordDatabaseDontUse(\*\*creds)] |
|  |  | return lambda: guard.HTTPAuthSessionWrapper( |
|  |  | Portal(SimpleRealm(), checkers), |
|  |  | [guard.BasicCredentialFactory(b'example.com')]) |
|  |  |  |
|  |  |  |
|  |  | HelloWorldProtected = password\_protected(HelloWorld, 'user', b'userpass') |
|  |  | HelloWorldProtected.\_\_name\_\_ = 'HelloWorldProtected' |
|  |  | HelloWorldProtected.\_\_module\_\_ = \_\_name\_\_ |
|  |  |  |
|  |  | SplashProtected = password\_protected(splash\_proxy(), 'user', b'userpass') |
|  |  | SplashProtected.\_\_name\_\_ = 'SplashProtected' |
|  |  | SplashProtected.\_\_module\_\_ = \_\_name\_\_ |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2b253e5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscrapy-plugins%2Fscrapy-splash%2Fcommit%2F2b253e57fe64ec575079c8cdc99fe2013502ea31) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3c3d52f8_20250114_212714.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscrapy-plugins%2Fscrapy-splash%2Fsecurity%2Fadvisories%2FGHSA-823f-cwm9-4g74)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscrapy-plugins%2Fscrapy-splash%2Fsecurity%2Fadvisories%2FGHSA-823f-cwm9-4g74)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=scrapy-plugins%2Fscrapy-splash)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[scrapy-plugins](/scrapy-plugins)
/
**[scrapy-splash](/scrapy-plugins/scrapy-splash)**
Public

* [Notifications](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash) You must be signed in to change notification settings
* [Fork
  454](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash)
* [Star
   3.2k](/login?return_to=%2Fscrapy-plugins%2Fscrapy-splash)

* [Code](/scrapy-plugins/scrapy-splash)
* [Issues
  65](/scrapy-plugins/scrapy-splash/issues)
* [Pull requests
  16](/scrapy-plugins/scrapy-splash/pulls)
* [Actions](/scrapy-plugins/scrapy-splash/actions)
* [Projects
  0](/scrapy-plugins/scrapy-splash/projects)
* [Wiki](/scrapy-plugins/scrapy-splash/wiki)
* [Security](/scrapy-plugins/scrapy-splash/security)
* [Insights](/scrapy-plugins/scrapy-splash/pulse)

Additional navigation options

* [Code](/scrapy-plugins/scrapy-splash)
* [Issues](/scrapy-plugins/scrapy-splash/issues)
* [Pull requests](/scrapy-plugins/scrapy-splash/pulls)
* [Actions](/scrapy-plugins/scrapy-splash/actions)
* [Projects](/scrapy-plugins/scrapy-splash/projects)
* [Wiki](/scrapy-plugins/scrapy-splash/wiki)
* [Security](/scrapy-plugins/scrapy-splash/security)
* [Insights](/scrapy-plugins/scrapy-splash/pulse)

# Splash authentication credentials potentially leaked to target websites

High

[Gallaecio](/Gallaecio)
published
GHSA-823f-cwm9-4g74
Oct 5, 2021

## Package

pip

scrapy-splash
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

< 0.8.0

## Patched versions

0.8.0

## Description

### Impact

If you use [`HttpAuthMiddleware`](http://doc.scrapy.org/en/latest/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpauth) (i.e. the `http_user` and `http_pass` spider attributes) for Splash authentication, any non-Splash request will expose your credentials to the request target. This includes `robots.txt` requests sent by Scrapy when the `ROBOTSTXT_OBEY` setting is set to `True`.

### Patches

Upgrade to scrapy-splash 0.8.0 and use the new `SPLASH_USER` and `SPLASH_PASS` settings instead to set your Splash authentication credentials safely.

### Workarounds

If you cannot upgrade, set your Splash request credentials on a per-request basis, [using the `splash_headers` request parameter](https://github.com/scrapy-plugins/scrapy-splash/tree/0.8.x#http-basic-auth), instead of defining them globally using the [`HttpAuthMiddleware`](http://doc.scrapy.org/en/latest/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpauth).

Alternatively, make sure all your requests go through Splash. That includes disabling the [robots.txt middleware](https://docs.scrapy.org/en/latest/topics/downloader-middleware.html#topics-dlmw-robots).

### For more information

If you have any questions or comments about this advisory:

* [Open an issue](https://github.com/scrapy-plugins/scrapy-splash/issues)
* Email us

### Severity

High

### CVE ID

CVE-2021-41124

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


