=== Content from github.com_5204e82a_20250114_190222.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspiffe%2Fspire%2Fsecurity%2Fadvisories%2FGHSA-q7gm-mjrg-44h9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fspiffe%2Fspire%2Fsecurity%2Fadvisories%2FGHSA-q7gm-mjrg-44h9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=spiffe%2Fspire)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[spiffe](/spiffe)
/
**[spire](/spiffe/spire)**
Public

* [Notifications](/login?return_to=%2Fspiffe%2Fspire) You must be signed in to change notification settings
* [Fork
  486](/login?return_to=%2Fspiffe%2Fspire)
* [Star
   1.8k](/login?return_to=%2Fspiffe%2Fspire)

* [Code](/spiffe/spire)
* [Issues
  145](/spiffe/spire/issues)
* [Pull requests
  20](/spiffe/spire/pulls)
* [Actions](/spiffe/spire/actions)
* [Projects
  1](/spiffe/spire/projects)
* [Wiki](/spiffe/spire/wiki)
* [Security](/spiffe/spire/security)
* [Insights](/spiffe/spire/pulse)

Additional navigation options

* [Code](/spiffe/spire)
* [Issues](/spiffe/spire/issues)
* [Pull requests](/spiffe/spire/pulls)
* [Actions](/spiffe/spire/actions)
* [Projects](/spiffe/spire/projects)
* [Wiki](/spiffe/spire/wiki)
* [Security](/spiffe/spire/security)
* [Insights](/spiffe/spire/pulse)

# Path Normalization issue in "aws\_iid" Node Attestor

Moderate

[azdagron](/azdagron)
published
GHSA-q7gm-mjrg-44h9
Mar 4, 2021

## Package

github.com/spiffe/spire/pkg/common/idutil
(SPIRE)

## Affected versions

<0.8.4, <0.9.4, <0.10.2, <0.11.3, <0.12.1

## Patched versions

0.11.3, 0.12.1

## Description

### Summary

In SPIRE before versions 0.8.5, 0.9.4, 0.10.2, 0.11.3 and 0.12.1, the "aws\_iid" Node Attestor improperly normalizes the path provided through the agent ID templating feature, which may allow the issuance of an arbitrary SPIFFE ID within the same trust domain, if the attacker controls the value of an EC2 tag prior to attestation, and the attestor is configured for agent ID templating where the tag value is the last element in the path. This issue has been fixed in SPIRE versions 0.11.3 and 0.12.1.

### What are the changes introduced by the patched versions?

The patched versions no longer apply path normalization when generating agent IDs in the `aws_iid`, `gcp_iit`, `x509pop` and `sshpop` node attestors.

The patched versions also include a patched k8s-workload-registrar, which no longer applies path normalization prior to registering SPIFFE IDs with SPIRE Server.

#### Further Behavioral Changes

The patched versions further introduce several safety checks to improve consistency of the normalization of SPIFFE IDs, which previously may have resulted in surprising behavior. These checks may be disabled through the use of the `allow_unsafe_ids` configurable - please see the Upgrade Considerations section below for more information.

SPIRE Server now rejects API requests containing non-normalized SPIFFE IDs, as well as API requests from callers presenting client certificates containing a non-normalized SPIFFE ID. Specifically, this means that all SPIFFE IDs must:

* Have a "spiffe" scheme.
* Have a lowercase host component.
* Have a path without a trailing slash (including `/`).
* Not include a path with empty, `.`, or `..` segments.
* Not include percent encoded ASCII characters.
* Not include a mix of percent-encoded and raw UTF-8 characters.

This includes the following APIs:

* Entry API
  + `BatchCreateEntry`
  + `BatchUpdateEntry`
* SVID API
  + `MintX509SVID`
  + `MintJWTSVID`
* Agent API
  + `CreateJoinToken`
* Legacy Registration API
  + `MintX509SVID`
  + `MintJWTSVID`
  + `CreateEntry`
  + `CreateEntryIfNotExists`
  + `UpdateEntry`

Agent ID normalization is also enforced with the patched releases. In addition to the normalization rules described above, patched releases will also reject IDs produced by node attestors that look like the SPIRE Server ID.

### Upgrade considerations

While the patch that closes the vulnerability is relatively small and targeted, the patched releases also ship with a number of behavioral changes intended to promote safety and avoid surprising behavior. These additional changes can be easily disabled through the use of the `allow_unsafe_ids` configurable (below). This section describes how to determine if your SPIRE deployment is affected by this behavioral change.

There is a small chance that registration entries with non-normalized SPIFFE IDs already exist in your SPIRE deployment (e.g. registration entries with SPIFFE IDs that include percent encoded ASCII). When a patched version of SPIRE Server starts, it will scan for such entries. If any are found, they will be logged at the Error level with the following message: `Ignoring entry with invalid [spiffeID, parentID]; this entry will be automatically deleted by a future release`. SPIRE Server will additionally emit a telemetry gauge indicating how many entries were ignored using the `entry.ignored` key. These ignored entries will not be honored by a patched SPIRE Server unless the `allow_unsafe_ids` configurable is set. Operators optimizing for availability may choose to upgrade a single SPIRE Server while blocking client traffic, such that the affected entries will be logged without affecting the workloads which they describe.

Finally, if you are using custom node attestors, please ensure that they generate normalized SPIFFE IDs (see Further Behavioral Changes above). Node attestations that result in non-normalized IDs will fail unless `allow_unsafe_ids` is set.

In the event that your deployment is adversely affected by the above changes, simply set the below configuration flag which has been introduced with the patched versions. This flag disables these new checks in their entirety, and leaves only the targeted vulnerability fix behind. Please be aware that this flag is already deprecated, and will be removed in the next major release. As a result, it is very important to correct any integration that may be relying on this behavior. To disable the new safety checks, please add the following to your patched SPIRE Server configuration:

```
server {
    ...
    allow_unsafe_ids = true
    ....
}

```

It is strongly advised that these checks be disabled if and only if your deployment is adversely affected by these behavioral changes, and setting the flag is necessary to continue with the operation of your deployment. Again, this flag will be removed in the next major release - please ensure that the situation requiring its use is corrected as soon as possible.

### Should I upgrade SPIRE?

All SPIRE users running affected supported versions are advised to upgrade to the corresponding patched version. If you are running an unsupported version of SPIRE, please upgrade to a supported version of SPIRE as soon as possible.

### Workarounds

Discontinue use of `aws_iid` agent ID templating, or ensure that EC2 tag values are not utilized in `aws_iid` agent ID templating.

If you have layered security controls on top of SPIRE Server API access (e.g. to implement a SPIFFE ID block list), ensure that all IDs are normalized prior to making a policy decision.

### References

* CVE: <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27099>

### Severity

Moderate

### CVE ID

CVE-2021-27099

### Weaknesses

[CWE-706](/advisories?query=cwe%3A706)

### Credits

* [![@c53robin](https://avatars.githubusercontent.com/u/66480952?s=40&v=4)](/c53robin)
  [c53robin](/c53robin)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


