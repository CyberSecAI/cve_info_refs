=== Content from rustsec.org_f5a1439c_20250114_210558.html ===


RUSTSEC-2021-0037: diesel: Fix a use-after-free bug in diesels Sqlite backend › RustSec Advisory Database

#

[About](/)
[Advisories](/advisories/)
[Report Vulnerabilities](/contributing.html)

[History](https://github.com/RustSec/advisory-db/commits/main/crates/diesel/RUSTSEC-2021-0037.md) ⋅
[Edit](https://github.com/RustSec/advisory-db/edit/main/crates/diesel/RUSTSEC-2021-0037.md) ⋅
[JSON (OSV)](https://api.osv.dev/v1/vulns/RUSTSEC-2021-0037)

# RUSTSEC-2021-0037

Fix a use-after-free bug in diesels Sqlite backend

Reported
March 5, 2021

Issued
March 5, 2021

(last modified: June 13, 2023)

Package
[diesel](/packages/diesel.html)
([crates.io](https://crates.io/crates/diesel))

Type
Vulnerability

Categories

* [memory-corruption](/categories/memory-corruption.html)

Keywords
[#use-after-free](/keywords/use-after-free.html)

Aliases

* [CVE-2021-28305](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28305)
* [GHSA-j8q9-5rp9-4mv9](https://github.com/advisories/GHSA-j8q9-5rp9-4mv9)

References

* <https://github.com/diesel-rs/diesel/pull/2663>

CVSS Score
9.8
CRITICAL

CVSS Details
Attack vectorNetwork
Attack complexityLow
Privileges requiredNone
User interactionNone
ScopeUnchanged
ConfidentialityHigh
IntegrityHigh
AvailabilityHigh

CVSS Vector
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H)
Patched

* `>=1.4.6`

Affected Functions
Version
`diesel::SqliteConnection::query_by_name`

* `<1.4.6`

### Description

We've misused `sqlite3_column_name`. The
[SQLite](https://www.sqlite.org/c3ref/column_name.html) documentation
states that the following:

> The returned string pointer is valid until either the prepared statement
> is destroyed by sqlite3\_finalize() or until the statement is automatically
> reprepared by the first call to sqlite3\_step() for a particular
> run or until the next call to sqlite3\_column\_name()
> or sqlite3\_column\_name16() on the same column.

As part of our `query_by_name` infrastructure we've first received all
field names for the prepared statement and stored them as string slices
for later use. After that we called `sqlite3_step()` for the first time,
which invalids the pointer and therefore the stored string slice.

Advisory available under [CC0-1.0](https://spdx.org/licenses/CC0-1.0.html)
license.


