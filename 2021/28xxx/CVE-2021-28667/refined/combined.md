=== Content from stackstorm.com_f629a521_20250114_214807.html ===

    [![](/wp/wp-content/themes/stackstorm/images/logo_lf_projects_horizontal.png)](https://linuxfoundation.org/projects)
[![StackStorm](/wp/wp-content/uploads/2016/10/StackStorm-logo228.png)](/)

[![StackStorm](/wp/wp-content/uploads/2016/10/StackStorm-logo228.png)](/)

* [Features](/features)
* [Community](/#community)
* [Docs](http://docs.stackstorm.com/)
* [Exchange](https://exchange.stackstorm.org/)
* [Blog](/blog)
* [Donate](/donate/)

# StackStorm v3.4.1 – Security fix – CVE-2021-28667

**Mar 16, 2021**

*by [Tomaz Muraus](https://www.github.com/Kami) and [@blag](https://github.com/blag)*

Today we are announcing StackStorm v3.4.1, a bug fix release which fixes a security issue which has been uncovered recently.

The issue affects anyone who is running StackStorm under Python 3 and doesn’t have a system locale / encoding which is used for StackStorm service processes (st2api, st2actionrunner, etc.) set to UTF-8. Under such conditions, if StackStorm receives a payload with unicode characters which also results in the payload being logged, StackStorm process would go into an infinite-loop trying to decode that payload. This would cause the affected service to have a high CPU utilization and also service log file to grow either until the process is killed or all the available disk space is exhausted (basically result in a DoS).

If you are running StackStorm under Python 3, you are strongly encouraged to upgrade to this release.

For more details, please see the sections below.

## Affected Installations / deployments

Any StackStorm installation which is using Python 3 and doesn’t have the system locale / encoding used for StackStorm services set to utf-8 is affected.

Until StackStorm v3.4.0 [which was released recently](/2021/03/04/v3-4-0-released/), StackStorm was still using Python 2.7 on most distros except RHEL / CentOS 8 and Ubuntu Bionic 18.04. StackStorm already used Python 3 on those operating systems.

It’s worth noting that nowadays that the system and processes locales are almost always set to utf-8, and when locales are either not being set, or set to C.ascii, is is usually a system misconfiguration.

## The bug

The actual bug and security vulnerability is located in the piece of code which is responsible for routing any data which is written to standard error (those are mostly just exception stack traces) to the logger method and logging this data under ERROR log level.

Under normal scenario when encountering unicode data and system / process locale (encoding) not being set to utf-8, trying to decode this utf-8 data to an ascii string would result in an exception because the character we are trying to decode is out of range for the current locale (which is usually ascii in such scenarios). That exception would then simply just be logged to the log file like any other.

Due to the bug in the code, under such scenario, the code would incorrectly try to decode this data in an infinite-loop instead of simply bailing out on first attempt trying to decode this data.

The bug was initially uncovered by one of the end to end tests, but at that time it was assumed it was just a flaky test and not an actual bug since we could not reproduce it on all operating systems, or during manual user testing for the 3.4.0 release.

A couple of days later, I was working on a different change when I encountered the same issue. After digging in a lot, I was able to track down and pinpoint the root cause.

One of the main reasons why the issue wasn’t detected faster was because of the nature of it – as mentioned above, these days it’s quite uncommon to have a system which is not configured with utf-8 locale.

## The fix

The fix includes modifying our custom logger method described above to decode the underlying byte string and removing any characters which are not in the ascii range before passing that data to the underlying log formatter method.

Now if this issue occurs, the process will simply just log an error / exception when trying to log unicode data when process encoding is not set to utf-8 (as it should have done out of the box).

Having said that, even though it will now work correctly under non-utf-8 encodings, you are still strongly recommended to set your system locale (and encoding for StackStorm services processes) to utf-8 to ensure a good experience when working with unicode data.

To do so, ensure that the encoding part of `LC_MESSAGES` or `LANG` in `/etc/locale.conf` is set to `UTF-8`. To set your locale for American English with `UTF-8`encoding, use this:

```
LANG=en_US.UTF-8
LC_MESSAGES=en_US.UTF-8
```

Or, for example, a German locale with American English log messages, you can use:

```
LANG=de_DE.UTF-8
LC_MESSAGES=en_US.UTF-8
```

For more information on locales, check the [documention on freedesktop.org](https://www.freedesktop.org/software/systemd/man/locale.conf.html).

On that note, we have also added a small change to the code which will print a warning on service startup in case the encoding for that service is not set to utf-8 as shown below.

```
WARNING [-] Detected a non utf-8 locale / encoding (fs encoding: ascii, default encoding: utf-8, locale: unable to retrieve locale: unknown locale: invalid). Using a non utf-8 locale while working with unicode data will result in exceptions and undefined behavior. You are strongly encouraged to configure all the StackStorm services to use utf-8 encoding (e.g. LANG=en_US.UTF-8).
```
## Conclusion

If you fall under affected deployments (you are running StackStorm under Python 3 and using locale / encoding other than utf-8), you are strongly encouraged to upgrade to v3.4.1.

If you are a researcher or user that discovers a security issue please reach out to moc.mrotskcatsnull@ytiruces (</security/>).

[Previous Post
StackStorm v3.4.0 Released](/2021/03/04/v3-4-0-released/)
[Next Post
StackStorm v3.5.0 Released](/2021/06/29/stackstorm-v3-5-0-released/)

[Documentation](http://docs.stackstorm.com/)

[GitHub](https://github.com/StackStorm)

[Community](/#community)

[Security](/security)

[Blog](/blog)

[Video Gallery](https://www.youtube.com/channel/UCColc5CuBJ8-1SnALnkDz8Q)

[Privacy Policy](/privacy-policy)

[Contact](/contact)

© 2021 StackStorm a Series of LF Projects, LLC. All rights reserved. For web site terms of use, trademark policy and other project policies please see <https://lfprojects.org/>.

For a list of trademarks of The Linux Foundation, please see our [Trademark Usage](https://www.linuxfoundation.org/trademark-usage) page. Linux is a registered trademark of Linus Torvalds. [Privacy Policy](https://www.linuxfoundation.org/privacy) and [Terms of Use](https://www.linuxfoundation.org/terms).

We use cookies for traffic analytics and ad and content personalization. By clicking on any of the content or interacting with any section of this website,
you are agreeing to this use of cookies in the manner described in our [Privacy Policy](/privacy-policy) close [x]
Privacy & Cookies Policy

Close

#### Privacy Overview

This website uses cookies to improve your experience while you navigate through the website. Out of these, the cookies that are categorized as necessary are stored on your browser as they are essential for the working of basic functionalities of the website. We also use third-party cookies that help us analyze and understand how you use this website. These cookies will be stored in your browser only with your consent. You also have the option to opt-out of these cookies. But opting out of some of these cookies may affect your browsing experience.

Necessary

Necessary

Always Enabled

Necessary cookies are absolutely essential for the website to function properly. This category only includes cookies that ensures basic functionalities and security features of the website. These cookies do not store any personal information.

Non-necessary

Non-necessary

Any cookies that may not be particularly necessary for the website to function and is used specifically to collect user personal data via analytics, ads, other embedded contents are termed as non-necessary cookies. It is mandatory to procure user consent prior to running these cookies on your website.

SAVE & ACCEPT


