=== Content from www.wordfence.com_2ef912ee_20250114_205857.html ===


![SQL Injection Vulnerability Patched in CleanTalk AntiSpam Featured Image](https://www.wordfence.com/wp-content/uploads/2021/05/SQL-Injection-Patched-Cleantalk.png)

[![](https://secure.gravatar.com/avatar/d46b866dba15e07748d03fe68187c62c?s=80&d=mm&r=g)Wordfence Author](https://www.wordfence.com/blog/author/wfauthor/)

May 3, 2021

# SQL Injection Vulnerability Patched in CleanTalk AntiSpam Plugin

On March 4, 2021, the Wordfence Threat Intelligence team initiated responsible disclosure for a Time-Based Blind SQL Injection vulnerability discovered in [Spam protection, AntiSpam, FireWall by CleanTalk](https://wordpress.org/plugins/cleantalk-spam-protect/), a WordPress plugin installed on over 100,000 sites. This vulnerability could be used to extract sensitive information from a site’s database, including user emails and password hashes, all without logging into the site.

We initially reached out to the plugin’s developer on March 4, 2021 and sent over the full disclosure on March 5, 2021. A patched version of the plugin, 5.153.4, was released on March 10, 2021.

Wordfence Premium users received firewall rules protecting against this vulnerability on March 4, 2021. Sites still running the free version of Wordfence received the same protection on April 3, 2021.

---

**Description:** Unauthenticated Time-Based Blind SQL Injection

**Affected Plugin:** Spam protection, AntiSpam, FireWall by CleanTalk

**Plugin Slug:** [cleantalk-spam-protect](https://wordpress.org/plugins/cleantalk-spam-protect/)

**Affected Versions:** < 5.153.4

**CVE ID:** CVE-2021-24295

**CVSS Score:** 7.5 (High)

**CVSS Vector:** [CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N)

**Fully Patched Version:** 5.153.4

The CleanTalk WordPress plugin has a number of uses, but one of its primary purposes is to protect sites against spam comments. Part of how it does this is by maintaining a blocklist and tracking the behavior of different IP addresses, including the user-agent string that browsers send to identify themselves.

Unfortunately, the `update_log` function in `lib/Cleantalk/ApbctWP/Firewall/SFW.php` which was used to insert records of these requests into the database failed to use a prepared SQL statement.

```
	public function update_log( $ip, $status ) {

		$id   = md5( $ip . $this->module_name );
		$time = time();

		$query = "INSERT INTO " . $this->db__table__logs . "
		SET
			id = '$id',
			ip = '$ip',
			status = '$status',
			all_entries = 1,
			blocked_entries = " . ( strpos( $status, 'DENY' ) !== false ? 1 : 0 ) . ",
			entries_timestamp = '" . $time . "',
			ua_name = '" . sanitize_text_field( Server::get('HTTP_USER_AGENT') ) . "'
		ON DUPLICATE KEY
		UPDATE
			status = '$status',
			all_entries = all_entries + 1,
			blocked_entries = blocked_entries" . ( strpos( $status, 'DENY' ) !== false ? ' + 1' : '' ) . ",
			entries_timestamp = '" . intval( $time ) . "',
			ua_name = '" . sanitize_text_field( Server::get('HTTP_USER_AGENT') ) . "'";

		$this->db->execute( $query );
	}
```

There were a number of features to the plugin code that made it more difficult to successfully perform a SQL injection attack.

By design, the `update_log` function should only have been executed a single time for each visitor IP address. However, it was possible to manipulate the cookies set by the plugin, sending an initial request to obtain a `ct_sfw_pass_key` cookie and then manually setting a separate `ct_sfw_passed` cookie and disallowing it from being reset.

Additionally, the vulnerable SQL query used `INSERT` rather than `SELECT`. Since data was not being inserted into a sensitive table, the `INSERT` query could not be used by an attacker to exploit the site by changing values in the database, and this also made it difficult to retrieve any sensitive data from the database.

Finally, the SQL statement used the `sanitize_text_field` function in an attempt to prevent SQL injection, and the User-Agent was included in the query within single quotes.

Despite these obstacles, we were able to craft a Proof of Concept capable of extracting data from anywhere in the database by sending requests containing SQL commands in the User-Agent request header. This exploit could be used by unauthenticated visitors to steal user email addresses, password hashes, and other sensitive information.

## Prepared Statements are Crucial

We were able to successfully exploit the vulnerability in CleanTalk via the [Time-Based Blind SQL Injection](https://www.wordfence.com/learn/how-to-prevent-sql-injection-attacks/) technique, which sends requests that “guess” at the content of a database table and instructs the database to delay the response or “sleep” if the guess is correct. For example, a request might ask the database if the first letter of the admin user’s email address starts with the letter “c”, and instruct it to delay the response by 5 seconds if this is true, and then try guessing the next letters in sequence. There are a number of other SQL injection techniques that can work around many forms of traditional input sanitization depending on the exact construction of the vulnerable query.

This is why it is essential to “prepare” any database queries before actually sending them to the database. Prepared statements isolate each query parameter and are by far the most effective defense against SQL Injection. Fortunately, WordPress offers an incredibly easy way to do this, by using the `$wpdb->prepare()` function. If you develop WordPress plugins, themes, or any other software that interacts with a database, regularly using  prepared statements will ensure your software will be far more secure.

## Timeline

**March 4, 2021** – Wordfence Threat Intelligence finishes researching a vulnerability in the CleanTalk plugin. We release firewall rules to Wordfence Premium customers and initiate contact with the plugin developers.

**March 5, 2021** – We send over the full disclosure to the plugin developers.

**March 10, 2021** – A patched version of the plugin is released.

**April 3, 2021** – Sites still using the free version of Wordfence receive protection against this vulnerability.

## Conclusion

In today’s post, we covered a SQL Injection vulnerability in the Spam protection, AntiSpam, FireWall by CleanTalk plugin which could be used to extract sensitive information from a site’s database and explained why using prepared statements is a critical best practice for plugin developers.

This vulnerability was patched in version 5.153.4, and we strongly recommend updating to the latest version of the plugin, 5.156 as of this writing, immediately.

[Wordfence Premium](https://www.wordfence.com/wordfence-signup/?promo_id=blog20210503&promo_name=get-premium&promo_creative=txt&promo_position=conclusion) users received firewall rules protecting against these vulnerabilities on March 4, 2021, while those still using the free version of Wordfence received the same protection on April 3, 2021.

If you know a friend or colleague who is using this plugin on their site, we highly recommend forwarding this advisory to them to help keep their sites protected as this vulnerability allows a breach of any confidential data stored in a site’s database.

*Special Thanks to Threat Analyst Chloe Chamberland for her instrumental role in developing the Proof of Concept exploit for this vulnerability.*

*This article was written by Ramuel Gall, a former Wordfence Senior Security Researcher.*

Search

### Trust Your Site to the Leader in WordPress Security

Wordfence includes an endpoint firewall, malware scanner, robust login security features, live traffic views, and more. Discover why over 5 million WordPress sites put their trust in Wordfence.

[Protect Your Site](/products/pricing/)

**Did you enjoy this post? Share it!**

[*Facebook*](http://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2021%2F05%2Fsql-injection-vulnerability-patched-in-cleantalk-antispam-plugin%2F)
[*Twitter*](https://twitter.com/share?url=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2021%2F05%2Fsql-injection-vulnerability-patched-in-cleantalk-antispam-plugin%2F&text=SQL%20Injection%20Vulnerability%20Patched%20in%20CleanTalk%20AntiSpam%20Plugin&via=wordfence)
[*LinkedIn*](https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.wordfence.com%2Fblog%2F2021%2F05%2Fsql-injection-vulnerability-patched-in-cleantalk-antispam-plugin%2F)

## Comments

No Comments

### Breaking WordPress Security Research in your inbox as it happens.

![Example of a news story](/img/footer-news-example.jpg)

This site uses cookies in accordance with our [Privacy Policy](/privacy-policy).

Cookie Settings
Accept All

## Cookie Options

For additional information on how this site uses cookies, please review our [Privacy Policy](/privacy-policy). The cookies used by this site are classified into the following categories and can be configured below.

### Strictly Necessary

These Cookies are necessary for the Sites and Services to work properly. They include any essential authentication and authorization cookies for the Services.

\* Cookies of this category are necessary for the site to function and cannot be disabled.

### Performance/Analytical

These Cookies allow us to collect certain information about how you navigate the Sites or utilize the Services running on your device. They help us understand which areas you use and what we can do to improve them.

### Targeting

These Cookies are used to deliver relevant information related to the Services to an identified machine or other device (not a named or otherwise identifiable person) which has previously been used to visit our Sites. Some of these types of Cookies on our Sites are operated by third parties with our permission and are used to identify advertising sources that are effectively driving customers to our Sites.

Cancel
Save



=== Content from wpscan.com_2cdd2b7e_20250114_205856.html ===


[Skip to content](#wp--skip-link--target)

* [Features](https://a8cteam5105.wordpress.com/features/)
* [Pricing](https://a8cteam5105.wordpress.com/pricing/)
* Solutions
  + [Status](https://status.wpscan.com/)
  + [API Details](/api)
  + [CLI Scanner](https://a8cteam5105.wordpress.com/wordpress-cli-scanner/)
* Vulnerabilities
  + [Themes](/themes)
  + [WordPress](/wordpresses)
  + [Plugins](/plugins)
  + [Stats](/statistics)
  + [Submit Vulnerabilities](/submit)
  + [Leaderboard](/leaderboard)
* Resources
  + [Blog](/blog)
  + [Enterprise Features](https://a8cteam5105.wordpress.com/enterprise-customers-features/)
  + [How to Install WPScan](https://a8cteam5105.wordpress.com/how-to-install-wpscan/)
  + [WPScan Glossary](/wpscan-glossary)
  + [2024 Website Threat Report](https://wpscan.com/2023-website-threat-report/)

Search

## WordPress Plugin Vulnerabilities

# Spam protection, AntiSpam, FireWall by CleanTalk < 5.153.4 - Unauthenticated Blind SQL Injection

### Description

It was possible to exploit an Unauthenticated Time-Based Blind SQL Injection vulnerability in the Spam protection, AntiSpam, FireWall by CleanTalk WordPress Plugin before 5.153.4. The update\_log function in lib/Cleantalk/ApbctWP/Firewall/SFW.php included a vulnerable query that could be injected via the User-Agent Header by manipulating the cookies set by the plugin, sending an initial request to obtain a ct\_sfw\_pass\_key cookie and then manually setting a separate ct\_sfw\_passed cookie and disallowing it from being reset.

### Affects Plugins

[![Plugin icon](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/plugin-icon.svg)

cleantalk-spam-protect](https://a8cteam5105.wordpress.com/plugin/cleantalk-spam-protect/)

![](https://s2.wp.com/wp-content/themes/a8c/wpscan/assets/img/checkmark-green-alt.svg)
Fixed in 5.153.4

### References

CVE
[CVE-2021-24295](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-24295)

URL
<https://www.wordfence.com/blog/2021/05/sql-injection-vulnerability-patched-in-cleantalk-antispam-plugin/>

URL
<https://blog.cleantalk.org/sql-injection-in-anti-spam-by-cleantalk-for-wordpress-prior-5-153-4/>

### Classification

Type
SQLI

OWASP top 10
[A1: Injection](https://www.owasp.org/index.php/Top_10-2017_A1-Injection)

CWE
[CWE-89](https://cwe.mitre.org/data/definitions/89.html)

CVSS
[7.5 (high)](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N)

### Miscellaneous

Original Researcher
Ramuel Gall

Submitter
Ramuel Gall

Submitter twitter
[ramuelgall](//twitter.com/ramuelgall)

Verified
Yes

WPVDB ID
[152171fc-888c-4275-a118-5a1e664ef28b](https://a8cteam5105.wordpress.com/vulnerability/152171fc-888c-4275-a118-5a1e664ef28b/)

### Timeline

Publicly Published
2021-05-03 (about 3 years ago)

Added
2021-05-03 (about 3 years ago)

Last Updated
2022-02-13 (about 2 years ago)

### Other

Published
Title

Published
2021-12-21
Title
[Asgaros Forum < 1.15.15 - Admin+ SQL Injection via forum\_id](https://a8cteam5105.wordpress.com/vulnerability/c60a3d40-449c-4c84-8d13-68c04267c1d7/)

Published
2014-08-01
Title
[Level Four Storefront - levelfourstorefront/getsortmanufacturers.php id Parameter SQL Injection](https://a8cteam5105.wordpress.com/vulnerability/61729569-fc94-470c-b11c-cfe18fe6898b/)

Published
2024-07-09
Title
[WpStickyBar <= 2.1.0 - Unauthenticated SQLi](https://a8cteam5105.wordpress.com/vulnerability/0b73f84c-611e-4681-b362-35e721478ba4/)

Published
2022-03-16
Title
[WP Block and Stop Bad Bots < 6.930 - Unauthenticated SQLi](https://a8cteam5105.wordpress.com/vulnerability/a0fbb79a-e160-49df-9cf2-18ab64ea66cb/)

Published
2024-04-11
Title
[Shopping Cart & eCommerce Store < 5.6.4 - Contributor+ SQL Injection](https://a8cteam5105.wordpress.com/vulnerability/c0b8b7bb-df40-4dae-a778-5148385e0305/)

![](https://wpscan.com/wp-content/uploads/2023/10/wpscan-logo-dark.png?w=246)

### Vulnerabilities

* [WordPress](/wordpresses)
* [Plugins](/plugins)
* [Themes](/themes)
* [Our Stats](https://a8cteam5105.wordpress.com/statistics/)
* [Submit vulnerabilities](https://a8cteam5105.wordpress.com/submit/)

#### About

* [How it works](/features)
* [Pricing](/pricing)
* [WordPress plugin](https://wordpress.org/plugins/wpscan/)
* [Blog](/blog)
* [Contact](/contact)

#### For Developers

* [Status](https://status.wpscan.com/)
* [API details](/api)
* [CLI scanner](/wordpress-cli-scanner)

#### Other

* [Privacy](https://automattic.com/privacy/)
* [Terms of service](/terms)
* [Submission terms](/submission-terms/)
* [Disclosure policy](/vulnerability-disclosure-policy)
* [Privacy Notice for California Users](https://automattic.com/privacy/#california-consumer-privacy-act-ccpa)

---

![](https://wpscan.com/wp-content/uploads/2023/08/frame-1323.png?w=48)

In partnership with [Jetpack](https://jetpack.com/)

* [GitHub](https://github.com/wpscanteam/wpscan/)
* [Twitter](https://twitter.com/_wpscan_)
* [Facebook](https://www.facebook.com/WPScan)

---

An

![](https://wpscan.com/wp-content/uploads/2023/08/autpmattic-logo.png?w=298)

endeavor

[Work With Us](https://automattic.com/work-with-us/)

[Press](https://automattic.com/press/)

* Subscribe
  Subscribed

  + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)

  Join 30,404 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
* Privacy
* + [![](https://wpscan.com/wp-content/uploads/2023/08/cropped-83c25-favicon.png?w=50) WPScan](https://wpscan.com)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fwpscan.com%252Fblog%252Funauthorized-plugin-installation-activation-in-hunk-companion%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://wpscan.com)
  + [View site in Reader](https://wordpress.com/read/feeds/156197069)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

![](https://pixel.wp.com/b.gif?v=noscript)

