=== Content from phabricator.wikimedia.org_5b09357f_20250115_102803.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT281043)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T281043
# Stored XSS in various SystemGifts-related special pages (e.g. Special:SystemGiftManager, Special:ViewSystemGifts) (CVE-2021-36130)Closed, Resolved[Public](/policy/explain/PHID-TASK-b3xsl4xdxktaob2ac6nm/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/281043/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/281043/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Protect as security issue](/wmf/escalate-task/281043/)
* [Award Token](/token/give/PHID-TASK-b3xsl4xdxktaob2ac6nm/)
* [Flag For Later](/flag/edit/PHID-TASK-b3xsl4xdxktaob2ac6nm/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Apr 24 2021, 7:11 PM2021-04-24 19:11:07 (UTC+0) |

Tags

* [Security](/tag/security/)
* [SocialProfile](/tag/socialprofile/) [(Backlog)](/project/board/326/)
* [Vuln-XSS](/tag/vuln-xss/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Social-Tools](/tag/social-tools/) [(SocialProfile)](/project/board/1009/)
Referenced Files

|  | [F34422610: T281043.patch](/F34422610) |
| --- | --- |
| Apr 24 2021, 8:11 PM2021-04-24 20:11:23 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Isarra](/p/Isarra/) |
| --- | --- |

|  | [lcawte](/p/lcawte/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

1. As a privileged user (one with the awardmanage user right) go to Special:SystemGiftManager and create a gift that has a title like "><script>alert('XSS')</script>
2. Hit the button on the page to have the award created
3. Note that the XSS gets executed right away (if at least one user matches the threshold you chose)...
4. ..and as a bonus, it gets spread everywhere, or at least to the profile pages of users who got the award (though not directly - it isn't executed on User:/User\_profile: page views, but upon clicking on the View all link in the user profile of a user who has more than 4 awards; e.g. **not** on User:Foo but definitely on Special:ViewSystemGifts? user=Foo)

Tangentially related bonus: the use of $this->msg( 'some message key' )->plain() in SocialProfile in general is more than likely 100% incorrect. (I accept the full responsibility for that, my fault.)

Though they are quite similar code-wise, UserGifts' Special:GiftManager and thus the user-to-user gifting functionality does **not** seem to be affected. Likewise, the Special:ViewGifts and Special:ViewGift special pages are fine and do not execute the XSS.

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [[SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](https://gerrit.wikimedia.org/r/c/692067) | [mediawiki/extensions/SocialProfile](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile) | [REL1\_36](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/REL1_36) | +142 -133 |
|  | [[SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](https://gerrit.wikimedia.org/r/c/692066) | [mediawiki/extensions/SocialProfile](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/REL1_35) | +145 -132 |
|  | [[SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](https://gerrit.wikimedia.org/r/c/692068) | [mediawiki/extensions/SocialProfile](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile) | [REL1\_31](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/REL1_31) | +141 -129 |
|  | [[SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](https://gerrit.wikimedia.org/r/c/691899) | [mediawiki/extensions/SocialProfile](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/master) | +142 -133 |
|  | [Add phan-taint-check plugin support to SocialProfile](https://gerrit.wikimedia.org/r/c/683037) | [mediawiki/extensions/SocialProfile](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/master) | +5 -2 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T281043)
# Related Objects

* Mentions

Mentioned In [rESPR96d347eb0764: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR96d347eb07646b0d0abc6ee91ce33de7e2963b3c)
[rESPR44b4f89caa78: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR44b4f89caa781ec8cfa3a864e65062d0d5fa4ecb)
[rESPR58d2420c0f72: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR58d2420c0f726cd469c638043ed66a4374b136f2)
[rESPRf05860c593fd: Add phan-taint-check plugin support to SocialProfile](/rESPRf05860c593fda050d6616b4d11a765c064ea3a13)
[T279733: Write and send supplementary release announcement for extensions and skins with security patches (1.31.15/1.35.3/1.36.1)](/T279733)
[T281196: Stored XSS in SportsTeams' Special:SportsTeamsManager & Special:UpdateFavoriteTeams (CVE-2021-36131)](/T281196)
### Event Timeline

[ashley](/p/ashley/) created this task.[Apr 24 2021, 7:11 PM2021-04-24 19:11:07 (UTC+0)](#7031449)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  路 [View Herald Transcript](/herald/transcript/4225338/)[Apr 24 2021, 7:11 PM2021-04-24 19:11:08 (UTC+0)](#7031459)[ashley](/p/ashley/) claimed this task.[Apr 24 2021, 7:13 PM2021-04-24 19:13:29 (UTC+0)](#7031460)[ashley](/p/ashley/) added projects: [SocialProfile](/tag/socialprofile/), [Vuln-XSS](/tag/vuln-xss/).[ashley](/p/ashley/) added a comment.[Apr 24 2021, 8:11 PM2021-04-24 20:11:23 (UTC+0)](#7031470)Comment Actions

T281043.patch23 KB[Download](https://phab.wmfusercontent.org/file/download/cszlgsia7ckabnwkglsp/PHID-FILE-bok6whtv53tmbbexyqtp/T281043.patch)

Proposed patch which fixes the issues in SystemGifts spotted with the malicious award name used as an example here, adjusts ->plain() to ->escaped(), ensures that LinkRenderer is passed raw text (->text()) instead of escaped to avoid double-escaping and removes parsing format from Message objects passed to OutputPage#setPageTitle because that method can be passed either a string or a Message object, and finally casts some things we definitely want to be ints as such (in SpecialSystemGiftManager.php).

[Reedy](/p/Reedy/) edited projects, added [SecTeam-Processed](/tag/secteam-processed/); removed [Security-Team](/tag/security-team/).[Apr 26 2021, 3:03 PM2021-04-26 15:03:51 (UTC+0)](#7034340)

[Legoktm](/p/Legoktm/) subscribed.[Apr 26 2021, 3:33 PM2021-04-26 15:33:55 (UTC+0)](#7034689)Comment Actions

I only reviewed the patch diff, not the rest of the code, I assume you used phan-taint-check to make sure there's no issues left?

```
			<input type="hidden" name="id" value="' . ( $gift['gift_id'] ?? '' ) . '" />
```

From SystemGiftManager, I'd prefer if there was an (int) cast (or intval()) just to make it obvious that gift\_id is safe to not have explicit escaping.

```
					<div class=\"ga-timestamp\">({$gift['timestamp']})</div>
```

From ViewSystemGift, I think this needs escaping.

[ashley](/p/ashley/) mentioned this in [T281196: Stored XSS in SportsTeams' Special:SportsTeamsManager & Special:UpdateFavoriteTeams (CVE-2021-36131)](/T281196).[Apr 26 2021, 10:07 PM2021-04-26 22:07:42 (UTC+0)](#7036105)[ashley](/p/ashley/) added a comment.[Apr 26 2021, 10:15 PM2021-04-26 22:15:43 (UTC+0)](#7036127)Comment Actions
> In [T281043#7034689](/T281043#7034689), [@Legoktm](/p/Legoktm/) wrote:
>
> I only reviewed the patch diff, not the rest of the code, I assume you used phan-taint-check to make sure there's no issues left?

Alas, SocialProfile does not yet to my knowledge run phan. (Just like how it doesn't support extension registration yet, or...)

> From SystemGiftManager, I'd prefer if there was an (int) cast (or intval()) just to make it obvious that gift\_id is safe to not have explicit escaping.

Agreed. Implemented locally.

> ```
> 					<div class=\"ga-timestamp\">({$gift['timestamp']})</div>
> ```
>
> From ViewSystemGift, I think this needs escaping.

As we discussed on IRC, the current (git master) implementation is indeed just a raw timestamp from the database which is barely "prettified", i.e. "2020-07-18 23:25:37"; but "23:25, 18 July 2020" is more human-friendly, so let's run that timestamp through Language#userTimeAndDate and thus also through htmlspecialchars. 

Again, thanks for the review & suggestions, very helpful!  Not only are we fixing obvious security issues (after ~14 years (!)) but also improving usability while it at. Yay!

[ashley](/p/ashley/) added a project: [Social-Tools](/tag/social-tools/).[Apr 27 2021, 5:11 PM2021-04-27 17:11:22 (UTC+0)](#7038984)[ashley](/p/ashley/) moved this task from [Backlog](/project/board/1009/) to [SocialProfile](/project/board/1009/) on the [Social-Tools](/tag/social-tools/) board.[sbassett](/p/sbassett/) mentioned this in [T279733: Write and send supplementary release announcement for extensions and skins with security patches (1.31.15/1.35.3/1.36.1)](/T279733).[Apr 27 2021, 6:05 PM2021-04-27 18:05:01 (UTC+0)](#7039307)[sbassett](/p/sbassett/) subscribed.[Apr 27 2021, 6:30 PM2021-04-27 18:30:43 (UTC+0)](#7039404)Comment Actions
> In [T281043#7036127](/T281043#7036127), [@ashley](/p/ashley/) wrote:
> > In [T281043#7034689](/T281043#7034689), [@Legoktm](/p/Legoktm/) wrote:
> >
> > I only reviewed the patch diff, not the rest of the code, I assume you used phan-taint-check to make sure there's no issues left?
>
> Alas, SocialProfile does not yet to my knowledge run phan. (Just like how it doesn't support extension registration yet, or...)

It looks like it's at least set up to use phan, as it has a [phan config](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/SocialProfile/%2B/refs/heads/master/.phan/config.php). Having the phan-taint-check plugin available only takes a couple more steps, as noted [within the documentation](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/tools/phan/SecurityCheckPlugin/%2B/refs/heads/master/README.md). I've created a change set to add it here, feel free to merge if you'd like:

<https://gerrit.wikimedia.org/r/683037>

A few notes:

1. You need [php-ast](https://pecl.php.net/package/ast) installed to run phan (and the plugin) locally, which should be as simple as pecl install ast in most cases.
2. composer seccheck-fast might emit a couple of warnings, but appears to work fine and generates a few issues, which may or may not be false positives.
3. I noticed that composer.lock was in SocialProfile's .gitignore - I think the best practice is to include this in the repo, if possible.
[sbassett](/p/sbassett/) mentioned this in [rESPRf05860c593fd: Add phan-taint-check plugin support to SocialProfile](/rESPRf05860c593fda050d6616b4d11a765c064ea3a13).[Apr 30 2021, 8:24 AM2021-04-30 08:24:52 (UTC+0)](#7048293)[ashley](/p/ashley/) mentioned this in [rESPR58d2420c0f72: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR58d2420c0f726cd469c638043ed66a4374b136f2).[May 16 2021, 7:29 AM2021-05-16 07:29:36 (UTC+0)](#7090761)[Legoktm](/p/Legoktm/) closed this task as Resolved.[May 16 2021, 8:36 PM2021-05-16 20:36:39 (UTC+0)](#7091336)[Legoktm](/p/Legoktm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-nq2eu35cyfbdypw/)" to "Public (No Login Required)".[Legoktm](/p/Legoktm/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-22yfmwwzz7rpa62/)" to "All Users".[gerritbot](/p/gerritbot/) added a comment.[May 16 2021, 11:05 PM2021-05-16 23:05:21 (UTC+0)](#7091426)Comment Actions

Change 692066 had a related patch set uploaded (by Southparkfan; author: Jack Phoenix):

[mediawiki/extensions/SocialProfile@REL1\_35] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

<https://gerrit.wikimedia.org/r/692066>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[May 16 2021, 11:05 PM2021-05-16 23:05:22 (UTC+0)](#7091427)[gerritbot](/p/gerritbot/) added a comment.[May 16 2021, 11:15 PM2021-05-16 23:15:25 (UTC+0)](#7091431)Comment Actions

Change 692067 had a related patch set uploaded (by Southparkfan; author: Jack Phoenix):

[mediawiki/extensions/SocialProfile@REL1\_36] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

<https://gerrit.wikimedia.org/r/692067>

[gerritbot](/p/gerritbot/) added a comment.[May 16 2021, 11:18 PM2021-05-16 23:18:33 (UTC+0)](#7091432)Comment Actions

Change 692068 had a related patch set uploaded (by Southparkfan; author: Jack Phoenix):

[mediawiki/extensions/SocialProfile@REL1\_31] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

<https://gerrit.wikimedia.org/r/692068>

[gerritbot](/p/gerritbot/) added a comment.[May 17 2021, 1:00 AM2021-05-17 01:00:30 (UTC+0)](#7091445)Comment Actions

Change 692068 **abandoned** by Jack Phoenix:

[mediawiki/extensions/SocialProfile@REL1\_31] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

Reason:

Per [[mw:Social tools/MediaWiki compatibility]], the non-master release branches were never supported for social tools, especially not something as old as 1.31. We may (read: probably have to) soon transition to supporting the latest Long-Term Support (LTS) release instead of latest stable, but in any case, let's not give people the false impression that these non-master branches would be usable or recommended to be used.

<https://gerrit.wikimedia.org/r/692068>

[sbassett](/p/sbassett/) renamed this task from Stored XSS in various SystemGifts-related special pages (e.g. Special:SystemGiftManager, Special:ViewSystemGifts) to Stored XSS in various SystemGifts-related special pages (e.g. Special:SystemGiftManager, Special:ViewSystemGifts) (CVE-2021-36130).[Jul 2 2021, 7:49 PM2021-07-02 19:49:11 (UTC+0)](#7194913)[gerritbot](/p/gerritbot/) added a comment.[Oct 8 2021, 11:41 PM2021-10-08 23:41:01 (UTC+0)](#7413943)Comment Actions

Change 692066 **merged** by jenkins-bot:

[mediawiki/extensions/SocialProfile@REL1\_35] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

<https://gerrit.wikimedia.org/r/692066>

[Southparkfan](/p/Southparkfan/) mentioned this in [rESPR44b4f89caa78: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR44b4f89caa781ec8cfa3a864e65062d0d5fa4ecb).[Oct 8 2021, 11:44 PM2021-10-08 23:44:31 (UTC+0)](#7413950)[gerritbot](/p/gerritbot/) added a comment.[Oct 8 2021, 11:57 PM2021-10-08 23:57:39 (UTC+0)](#7413969)Comment Actions

Change 692067 **merged** by jenkins-bot:

[mediawiki/extensions/SocialProfile@REL1\_36] [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages

<https://gerrit.wikimedia.org/r/692067>

[Southparkfan](/p/Southparkfan/) mentioned this in [rESPR96d347eb0764: [SECURITY] Fix XSS in various SystemGifts/UserGifts-related special pages](/rESPR96d347eb07646b0d0abc6ee91ce33de7e2963b3c).[Oct 8 2021, 11:59 PM2021-10-08 23:59:57 (UTC+0)](#7413970)[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Oct 9 2021, 12:10 AM2021-10-09 00:10:18 (UTC+0)](#7413997)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. 路 [Wikimedia Foundation](https://wikimediafoundation.org/) 路 [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) 路 [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) 路 [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) 路 [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) 路 [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) 路 [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) 路 [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from gerrit.wikimedia.org_10834d9f_20250115_102801.html ===



