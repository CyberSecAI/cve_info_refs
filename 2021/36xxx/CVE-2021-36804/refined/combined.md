=== Content from www.rapid7.com_80760dcc_20250114_182239.html ===


[![Rapid7 Home](/Areas/Docs/includes/img/r7-nav/Rapid7_logo.svg)](https://www.rapid7.com/)

* Platform
  + TECHNOLOGYThe Rapid7 Command PlatformAI-Powered Cybersecurity Platform[Explore](/platform/)
  + PLATFORM
  + [PlatformELITE TECHNOLOGY](/platform/)
  + [AI-EngineINTELLIGENT TOOLS](/info/ai-hub-page/)
  + [Rapid7 LabsTRUSTED INTELLIGENCE](/research/)
  + SOLUTIONS
  + [Managed Threat CompleteMANAGED XDR](/services/managed-detection-and-response-mdr/)
  + [Surface CommandATTACK SURFACE MANAGEMENT](/products/command/attack-surface-management-asm/)
  + [Exposure CommandEXPOSURE MANAGEMENT](/products/command/exposure-management/)
* [Products](/products/)
  + NEW!Exposure CommandTake Command of Your Attack Surface[Request Demo](/products/command/request-demo/)
  + DETECTION & RESPONSE
  + [Next-Gen SIEMINSIGHTIDR](/products/insightidr/)
  + [Threat IntelligenceTHREAT COMMAND](/products/threat-command/)
  + EXPOSURE MANAGEMENT
  + [Exposure ManagementEXPOSURE COMMAND](/products/command/exposure-management/)
  + [Attack Surface ManagementSURFACE COMMAND](/products/command/attack-surface-management-asm/)
  + [Vulnerability ManagementINSIGHTVM](/products/insightvm/)
  + [Cloud-Native Application ProtectionINSIGHTCLOUDSEC](/products/insightcloudsec/)
  + [Application Security TestingINSIGHTAPPSEC](/products/insightappsec/)
* [Services](/services/)
  + MXDRManaged Threat Complete24x7 MXDR to secure your extended ecosystem[Request Demo](/services/managed-detection-and-response-mdr/demo/)
  + DETECTION & RESPONSE
  + [Managed XDRMANAGED THREAT COMPLETE](/services/managed-detection-and-response-mdr/)
  + [Incident Response ServicesEXPERIENCING A BREACH?](/services/incident-response-customer-escalation/)
  + EXPOSURE MANAGEMENT
  + [Managed Vulnerability ManagementOPTIMIZED RISK ASSESSMENT](/services/managed-services/vulnerability-management/)
  + [Managed Application SecurityMANAGED DAST](/services/managed-services/managed-appsec/)
  + [Continuous Red TeamingVECTOR COMMAND](/services/continuous-red-team-service/)
  + [Penetration Testing ServicesTEST YOUR DEFENSES](/services/security-consulting/penetration-testing-services/)
* Resources
  + NEWThe 2024 Attack Intelligence ReportRead the latest research by Rapid7 Labs[READ NOW](/research/report/2024-attack-intelligence-report/)
  + STAY CURRENT
  + [About Rapid7 LabsMEET THE RESEARCH TEAM](/research/)
  + [Events & WebinarsCATCH US LIVE](/about/events-webcasts/)
  + [Resources LibraryDIVE INTO THE DETAILS](/resources/)
  + [The Rapid7 BlogSTAY UP-TO-DATE](/blog/)
  + [Exploit DatabaseSEARCH THOUSANDS OF CVES](/db/)
  + [Cybersecurity FundamentalsLEARN THE BASICS](/fundamentals/)
  + PRODUCT SUPPORT
  + [Contact SalesTALK TO AN EXPERT](/contact/)
  + [Customer Support PortalCONTACT SUPPORT](/for-customers/)
  + [Product IntegrationsCONNECT EVERYTHING](https://extensions.rapid7.com/)
  + [Product DocumentationPRODUCT AND SERVICES GUIDES](https://docs.rapid7.com/)
  + [Product Release NotesLATEST FEATURES](https://docs.rapid7.com/release-notes/)
  + [Interactive Product ToursTAKE TOUR](/product-tours/)
* [Company](/about/company/)
  + OVERVIEW
  + [About UsOUR STORY](/about/company/)
  + [LeadershipEXECUTIVE TEAM & BOARD](/about/leadership/)
  + [News & Press ReleasesTHE LATEST FROM OUR NEWSROOM](/about/news/)
  + [CareersJOIN RAPID7](https://careers.rapid7.com/)
  + [Our CustomersTheir Success Stories](/customers/)
  + [PartnersRapid7 Partner Ecosystem](/partners/)
  + [InvestorsInvestor Relations](https://investors.rapid7.com/)
  + COMMUNITY & CULTURE
  + [Social GoodOUR COMMITMENT & APPROACH](/about/social-good/)
  + [Rapid7 Cybersecurity FoundationBUILDING THE FUTURE](/about/rapid7-foundation/)
  + [Diversity, Equity & InclusionEMPOWERING PEOPLE](/about/diversity-equity-and-inclusion/)
  + [Open SourceSTRENGTHENING CYBERSECURITY](/open-source/)
  + [Public PolicyENGAGEMENT & ADVOCACY](/about/public-policy/)
  + [Boston BruinsOur Partnership](/about/rapid7-cybersecurity-partner-boston-bruins/)
* [Partners](/partners/)
* en
  + English
* [![](/Areas/Docs/includes/img/r7-nav/icon-lock.svg)¬†Sign In](https://insight.rapid7.com/saml/SSO)
[Blog](/blog/ "Blog")

* Select
  + [Vulnerability Management](/blog/tag/vulnerability-management/)
  + [MDR](/blog/tag/mdr-managed-detection-response/)
  + [Detection & Response](/blog/tag/detection-and-response/)
  + [Cloud Security](/blog/tag/cloud-security/)
  + [App Security](/blog/tag/application-security/)
  + [Metasploit](/blog/tag/metasploit/)
  + [All Topics](/blog/tags/)

[Start Trial](/trial/insight/)[![Rapid7 Home](/Areas/Docs/includes/img/r7-nav/Rapid7_logo.svg)](https://www.rapid7.com/)

* Platform
  + TECHNOLOGYThe Rapid7 Command PlatformAI-Powered Cybersecurity Platform[Explore](/platform/)
  + PLATFORM
  + [PlatformELITE TECHNOLOGY](/platform/)
  + [AI-EngineINTELLIGENT TOOLS](/info/ai-hub-page/)
  + [Rapid7 LabsTRUSTED INTELLIGENCE](/research/)
  + SOLUTIONS
  + [Managed Threat CompleteMANAGED XDR](/services/managed-detection-and-response-mdr/)
  + [Surface CommandATTACK SURFACE MANAGEMENT](/products/command/attack-surface-management-asm/)
  + [Exposure CommandEXPOSURE MANAGEMENT](/products/command/exposure-management/)
* [Products](/products/)
  + NEW!Exposure CommandTake Command of Your Attack Surface[Request Demo](/products/command/request-demo/)
  + DETECTION & RESPONSE
  + [Next-Gen SIEMINSIGHTIDR](/products/insightidr/)
  + [Threat IntelligenceTHREAT COMMAND](/products/threat-command/)
  + EXPOSURE MANAGEMENT
  + [Exposure ManagementEXPOSURE COMMAND](/products/command/exposure-management/)
  + [Attack Surface ManagementSURFACE COMMAND](/products/command/attack-surface-management-asm/)
  + [Vulnerability ManagementINSIGHTVM](/products/insightvm/)
  + [Cloud-Native Application ProtectionINSIGHTCLOUDSEC](/products/insightcloudsec/)
  + [Application Security TestingINSIGHTAPPSEC](/products/insightappsec/)
* [Services](/services/)
  + MXDRManaged Threat Complete24x7 MXDR to secure your extended ecosystem[Request Demo](/services/managed-detection-and-response-mdr/demo/)
  + DETECTION & RESPONSE
  + [Managed XDRMANAGED THREAT COMPLETE](/services/managed-detection-and-response-mdr/)
  + [Incident Response ServicesEXPERIENCING A BREACH?](/services/incident-response-customer-escalation/)
  + EXPOSURE MANAGEMENT
  + [Managed Vulnerability ManagementOPTIMIZED RISK ASSESSMENT](/services/managed-services/vulnerability-management/)
  + [Managed Application SecurityMANAGED DAST](/services/managed-services/managed-appsec/)
  + [Continuous Red TeamingVECTOR COMMAND](/services/continuous-red-team-service/)
  + [Penetration Testing ServicesTEST YOUR DEFENSES](/services/security-consulting/penetration-testing-services/)
* Resources
  + NEWThe 2024 Attack Intelligence ReportRead the latest research by Rapid7 Labs[READ NOW](/research/report/2024-attack-intelligence-report/)
  + STAY CURRENT
  + [About Rapid7 LabsMEET THE RESEARCH TEAM](/research/)
  + [Events & WebinarsCATCH US LIVE](/about/events-webcasts/)
  + [Resources LibraryDIVE INTO THE DETAILS](/resources/)
  + [The Rapid7 BlogSTAY UP-TO-DATE](/blog/)
  + [Exploit DatabaseSEARCH THOUSANDS OF CVES](/db/)
  + [Cybersecurity FundamentalsLEARN THE BASICS](/fundamentals/)
  + PRODUCT SUPPORT
  + [Contact SalesTALK TO AN EXPERT](/contact/)
  + [Customer Support PortalCONTACT SUPPORT](/for-customers/)
  + [Product IntegrationsCONNECT EVERYTHING](https://extensions.rapid7.com/)
  + [Product DocumentationPRODUCT AND SERVICES GUIDES](https://docs.rapid7.com/)
  + [Product Release NotesLATEST FEATURES](https://docs.rapid7.com/release-notes/)
  + [Interactive Product ToursTAKE TOUR](/product-tours/)
* [Company](/about/company/)
  + OVERVIEW
  + [About UsOUR STORY](/about/company/)
  + [LeadershipEXECUTIVE TEAM & BOARD](/about/leadership/)
  + [News & Press ReleasesTHE LATEST FROM OUR NEWSROOM](/about/news/)
  + [CareersJOIN RAPID7](https://careers.rapid7.com/)
  + [Our CustomersTheir Success Stories](/customers/)
  + [PartnersRapid7 Partner Ecosystem](/partners/)
  + [InvestorsInvestor Relations](https://investors.rapid7.com/)
  + COMMUNITY & CULTURE
  + [Social GoodOUR COMMITMENT & APPROACH](/about/social-good/)
  + [Rapid7 Cybersecurity FoundationBUILDING THE FUTURE](/about/rapid7-foundation/)
  + [Diversity, Equity & InclusionEMPOWERING PEOPLE](/about/diversity-equity-and-inclusion/)
  + [Open SourceSTRENGTHENING CYBERSECURITY](/open-source/)
  + [Public PolicyENGAGEMENT & ADVOCACY](/about/public-policy/)
  + [Boston BruinsOur Partnership](/about/rapid7-cybersecurity-partner-boston-bruins/)
* [Partners](/partners/)

* en
  + English
* [![](/Areas/Docs/includes/img/r7-nav/icon-lock.svg)Sign In](https://insight.rapid7.com/saml/SSO)
[![Rapid7 logo](/Areas/Docs/includes/img/r7-nav/Rapid7_logo-short.svg)](https://www.rapid7.com/)

* [Blog](/blog/ "Blog")
* [Vulnerability Management](/blog/tag/vulnerability-management/)
* [MDR](/blog/tag/mdr-managed-detection-response/)
* [Detection & Response](/blog/tag/detection-and-response/)
* [Cloud Security](/blog/tag/cloud-security/)
* [App Security](/blog/tag/application-security/)
* [Metasploit](/blog/tag/metasploit/)
* [All Topics](/blog/tags/)
[Start Trial](/trial/insight/)

# Multiple Open Source Web App Vulnerabilities Fixed

* Jul 27, 2021
* 13 min read
* [Tod Beardsley](/blog/author/tod-beardsley/)

*Last updated at Wed, 27 Dec 2023 15:04:09 GMT*

Today, Rapid7 is disclosing 9 vulnerabilities that affect three open-source projects: [EspoCRM](https://github.com/espocrm/espocrm), [Pimcore](https://github.com/pimcore/pimcore), and [Akaunting](https://github.com/akaunting/akaunting/). Right out of the gate, I'd like to give a special thanks to these 3 open-source project maintainers. While it's never great to learn of new vulnerabilities in your own product, all 3 project maintainers accepted, validated, and provided fixes for these vulnerabilities within **one day**, which is amazing when it comes to vulnerability disclosure. EspoCRM was notified on May 4, 2021 and patched source on May 5; Akaunting, on May 13 and turned it around on May 14; and Pimcore validated their vulnerabilities on April 29 after learning about them on April 28, 2021. Nice work, all around.

Now, I'm not sure why open source is just so much faster than the typical proprietary software vuln-patching pipeline, at least for the disclosures I've been involved in. It might be because, in open source, you're almost guaranteed to have your first communication with a hands-on-keyboard software engineer who is personally and emotionally invested in the software; whereas in proprietary land, first contact might be a lightly monitored support alias, staffed by a third-party provider. [Rapid7's vulnerability disclosure process](https://www.rapid7.com/security/disclosure/) assumes a minimum of 60 days for remediation of any vulnerability we report to a vendor, and I'd say about half the time, we're looking at more like 90 to 120 days from report to disclosure ‚Äî and, sometimes, we are left with the unhappy option of publishing without a fix in hand at all.

Of course, proprietary software occasionally offers fast turnaround times on validation and fixes to source, as well ([SonicWall](https://www.rapid7.com/blog/post/2021/06/23/cve-2021-20025-sonicwall-email-security-appliance-backdoor-credential/) comes to mind), and proprietary vendors often have very good reason to take their time with acknowledging, fixing, testing, and releasing fixes; but the fact remains that what's normal in open source communities ‚Äî hyperfast turnaround on fixing reported vulnerabilities ‚Äî is a rarity in proprietary software.

By the way, these aren't one- or two-person passion projects. All 3 of these projects have real users, real customers of their attendant support services and cloud-hosted versions, and are undoubtedly the core applications supporting thousands of small to medium businesses running today. This popularity is the reason why Trevor and Wiktor took a look at them in the first place; they suspected these small-to-medium business applications haven't seen a ton of attention from the eye of a penetration tester, and this blog post is a result of testing that hypothesis.

With that, I'll stop picking on proprietary software vendors in general and switch gears to take a look at the specific vulnerabilities in these specific projects.

## Common Vulnerability Classes

From this completely unscientific and statistically insignificant sampling of vulnerabilities, we can draw the deeply unsurprising conclusion that enterprise web applications tend to suffer from common web-application vulnerabilities. 3 are examples of persistent cross-site scripting (XSS), where a malicious user can plant a bit of browser-executable code in the application, which is designed to lie in wait and trigger when someone else comes along and loads that code, and 2 are SQL injection (SQLi) vulnerabilities, where the attacker uses the web application as a convoluted portal to issue direct commands to the backing database, usually to steal data or create powerful web-app users.

SQL injection used to be a nice way to get a command injection path to the underlying operating system, but that's something of a rarity these days. But, 1 issue disclosed here is a command injection issue, which we rate as the highest critical vulnerability of the bunch, since it can allow the attacker to commandeer the operating system and do things like use it as a beachhead into the rest of the network, install a cryptominer or ransomware, or perform other nefarious lower-level actions.

The remaining vulnerabilities are: a denial-of-service vulnerability, where the attacker can crash the whole application with a naughty HTTP request; an authentication bypass, where the attacker can move from one logical group to another without authorization; and a weak password-reset vulnerability, where the attacker can abuse the "I forgot my password" function to source a phishing email from the application to a registered user.

The table below provides the salient information about the 9 vulnerabilities being disclosed today. Note that every vulnerability listed here was promptly fixed by the vendor in the typical open-source manner. In short: if you use any of these applications in your business and keep up on your updates, you already have the fixes. The rest of this post details the individual findings by [Wiktor Sƒôdkowski](https://www.linkedin.com/in/wiktorsedkowski/) of Nokia and Trevor Christiansen of Rapid7, who worked together on this project and disclosed these issues through Rapid7's vulnerability disclosure process.

We're publishing these details today so other, similar web applications can be made aware of these vulnerability classes and take a look at their own codebases to make sure they're not making the same mistakes. Thanks, Wiktor and Trevor!

| CVE | Affected Project | CWE | Base CVSS | Status |
| --- | --- | --- | --- | --- |
| CVE-2021-3539 | EspoCRM v6.1.6 | CWE-79 (Persistent XSS) | 6.3 (Medium) | Fixed in version 6.1.7 |
| CVE-2021-31867 | Pimcore Customer Data Framework v3.0.0 | CWE-89 (SQL Injection) | 6.5 (Medium) | Fixed in v3.0.2 |
| CVE-2021-31869 | Pimcore AdminBundle v6.8.0 | CWE-89 (SQL Injection) | 6.5 (Medium) | Fixed in v6.9.4 |
| CVE-2021-36800 | Akaunting v2.1.12 | CWE-94 (Code injection) | 8.7 (High) | Fixed in Akaunting v2.1.13 |
| CVE-2021-36801 | Akaunting v2.1.12 | CWE-639 (Auth bypass) | 8.5 (High) | Fixed in Akaunting v2.1.13 |
| CVE-2021-36802 | Akaunting v2.1.12 | CWE-248 (Uncaught Exception DoS) | 6.5 (Medium) | Fixed in Akaunting v2.1.13 |
| CVE-2021-36803 | Akaunting v2.1.12 | CWE-79 (Persistent XSS) | 6.3 (Medium) | Fixed in Akaunting v2.1.13 |
| CVE-2021-36804 | Akaunting v2.1.12 | CWE-640 (Weak Password Reset) | 5.4 (Medium) | Fixed in Akaunting v2.1.13 |
| CVE-2021-36805 | Akaunting v2.1.12 | CWE-79 (Persistent XSS) | 5.2 (Medium) | Fixed in Akaunting v2.1.13 |

# EspoCRM v6.1.6 (1 issue)

EspoCRM is an open-source customer relationship management (CRM) application used in all sorts of industries, although it seems to enjoy special success in the real estate sector. More about EspoCRM can be found at the [vendor's website](https://www.espocrm.com/).

## CVE-2021-3539: EspoCRM Avatar Persistent XSS

Any user with default rights, which allows them to upload their own avatar, can abuse the API for this by providing executable Javascript code instead of an image. An example call to the API is detailed below:

```
PUT /api/v1/User/609108e6b123bb29d HTTP/1.1
Host: 10.0.0.10:8443
{redacted}
Content-Length: 43
Origin: https://10.0.0.10:8443
Connection: close
Referer: https://10.0.0.10:8443/
Cookie: {redacted}

{
"avatarId":"\" onerror=\"alert(0)\" "
}

```

This leads to rendering the avatar as:

![](https://lh4.googleusercontent.com/qtWSE1n5hDAxtoaYcVSG4DVJglzZXi5dzeLJdaLxjPcqH4n7MdpDppGyMsoIN0fLN3LxFUYaLB9FLiNbyxV6E37iA-aBo0ERhk9XgGD66YbKZFSi94DQluMDeIYx23yW1Q2j_mcr)

resulting in triggering the `onerror` event:

![](https://lh3.googleusercontent.com/Br_QcO102fIqXJOegCiQBlvpiNb8y2VrTBIupsk6-cupgpFBsqiSPRbAe0tVrxK9CPblwTYx4fIRWXPnOR1i8Aq57SUnxHfB52r4BlD9DbDUqcET2aLmselRzR6IojJYtopoYXac)

Because EspoCRM allows administrators to install arbitrary, custom extensions, an attacker can leverage this XSS to silently coerce an administrator (who views the attacker's avatar) to install a malicious extension, thus retaining permanent control of the web application, as seen in the screenshot below.

![](https://lh5.googleusercontent.com/wo_N00znwKdVFlzKGtrpQm5FeUD4c0KacOtoXVeDs0nn4KTf48tYoOQpgEb4xAFvos1KXtuqnMzigpldRwlAQHmWFbU0EQ_gswuqox4B1CZDxS-voTVoBeI2zuaOyfbNKKFkC4pX)
# Pimcore Customer Data Framework v3.0.0 (1 issue)

Pimcore CDF is a component of the Pimcore platform and is a CRM enterprise application. More about Pimcore CDF can be found at the [vendor's website](https://pimcore.com/en/customer-data-platform).

## CVE-2021-31867: Pimcore CDF 'SegmentAssignmentController.php' Blind SQL Injection

An SQL injection vulnerability exists in the Customer Management Framework Bundle, specifically in the SegmentAssignmentController.php component. The vulnerable code was introduced in commit 6fc8aff8f95fc168d173ef3b473760dd98d026c4 and is shown below.

```
php
public function inheritableSegments(Request $request)
{
$id = $request->get('id') ?? '';
$type = $request->get('type') ?? '';
/* @var $db Connection */
$db = $this->get(Connection::class);
$parentIdStatement = sprintf('SELECT `%s` FROM `%s` WHERE `%s` = "%s"', $type === 'object' ? 'o_parentId' : 'parentId', $type.'s', $type === 'object' ? 'o_id' : 'id', $id);
$parentId = $db->fetchOne($parentIdStatement);
$segments = $this->get(SegmentManagerInterface::class)->getSegmentsForElementId($parentId, $type);
$data = array_map([$this, 'dehydrateSegment'], array_filter($segments));
return $this->adminJson(['data' => array_values($data)]);
}

```

`$id` is retrieved from the request parameters and then placed directly into the SQL query through the use of `sprintf` and then executed (as long as `$type` is something other than `object`). This allows a malicious actor to inject the SQL query through the use of a single quote `‚Äô`.

This vulnerability can be thought of as a Boolean-based Blind SQL Injection, as an exploit is unable to pull out data from the database directly, but has to piece together the information through a series of True/False requests.

This image below shows a request that tests if the integer 1 equals 1:

![](https://lh6.googleusercontent.com/OCrQFVZNaH9N4CcQhd8xAEOiKaXHvo-gYWW2UO8DT6TeAbHlcMOA3XBT8AnntBU6v_BVSUDf4nIMypECUN6y6fACfYQpU4eRXXRs6CDTbmcvt45sfBcUvMuK0aTs7RJD-lAPafwi)

The response returns a `200 OK` along with the data that has an `id` of 137:

![](https://lh4.googleusercontent.com/yf-8MTL7XZ7fFlbNeqoZLk0SmXI_fnF_0a6WtHbGlnRhbznPtBjVZoJxbMVWeCTukTBIvDGQUfGSX3e_ge7vWMrdNoZPxpTD1JnE4XSGSTPy9cTAaFl-sj5Ks9VS65djBbzzjRg8)

This second request tests if the integer 1 is equal to 2:

![](https://lh4.googleusercontent.com/ZUMbm8TN6iLid-We5CsxPxY0CW8xdhDWp794WceFuknT1_8l5KiM6_oDuOGWgiPYwrOc-HfXzv_MbdB9L17yprSgeS0J_EY-LQ1I8d2ij5NM95EnoF4ZpetdA5jgHHNsHFPJNIdl)

This time, the response is a `500 Internal Server Error` along with a stack trace.

![](https://lh3.googleusercontent.com/Xj_MkzAPfSwpae4bskqy5-Mf2y4StjQlcTnr5nmDnPGKL1LUoEv1I_m1QQwZy0g4tRzCnJd89KxPxErUI2dGLWQpBkAblO0dDnVDH1cG0rlx7Zn7YJ2NSCI6hkvCp4ABOoB-NqaL)

Using these 2 queries, a malicious actor can automate the retrieval of information from the database. This last example shows a query to find the first character of the version from the database server.

![](https://lh5.googleusercontent.com/7z3q_gd1iXApNFCkqFZYU9rAB89Hg6wdO0Yq4M23VkJ0VRL3enPdPh_KYtoVP_ojGGWBG1SOP7Zv018w7jygs0RcPVj-JoXLc2ToYrwqiRGTjAF9njNgPyMe20oib7qo-kWPQKsI)
# Pimcore AdminBundle v6.8.0 (1 issue)

Pimcore AdminBundle is part of the core Pimcore platform, a Product Information Management (PIM) platform, which is closely related to the Enterprise Resource Planning (ERP) functions of a business. More about the Pimcore platform can be found at the [vendor's website](https://pimcore.com/en/platform).

## CVE-2021-31869: Pimcore AdminBundle 'specificID' SQL Injection

Requests sent to `/admin/object/grid-proxy` are handled by `Bundles/AdminBundle/Controller/Admin/DataObject/DataObjectController.php` file, starting on line 1568, as shown below:

![](https://lh6.googleusercontent.com/FI7pBVZ6Cm0oMbQr2BcEIhl5eDkJwstZOkHxQh1XWGOGbONbJvdeyqOgo5UVvFAiLMp5xu1P-YkTfv9W5bzA85Y2Metvhols9euMEqijW-V6in6-ckAjXT6c7rmMm3i9OqFMv9v8)

This file collects all the parameters (line 1586), then includes the parameters in a call to `prepareListingForGrid` shown below:

![](https://lh6.googleusercontent.com/BUIVz3yPjIfj5uBd17dLiYmPjG2so-M730lroVXojMkCi0rRDnMFUTAV0WLBz5pj14uLDDOsXjdIdJboqT_TpyDxAFeX6dtARk0lUUGIpDJkikw6Y_yQ0C4w9_cGid7k3Hk4Y0gQ)

`prepareListingForGrid` is found in the previously mentioned `Pimcore/Bundles/AdminBundle/Helper/GridHelperService.php` file and starts on line 489. This function builds the SQL query from the provided parameters. The parameter `specificID` is vulnerable to SQL injection, since the `specificId` parameter data is concatenated directly into the string and then added to the `$conditionFilters` array, as shown below:

![](https://lh4.googleusercontent.com/a9Wfw7bKp-hi2h3SecSqbdsIMsKV9X2TC3AFfBS9Cla8jaJrFwT1lESxrMds0-Rn1ZXHrFDtk0p6RJbvtrEfwwU4ItzuIwZr3tZYFVKcs2QydJg6nTcOO5YKozX6tz67rrmvRW7A)

A request to the `grid-proxy` url is shown below. In this query, the `specificId` field is set to `1+or+‚Äôa‚Äô=‚Äôa‚Äô`. The response shows a content-length of 7546.

GET /admin/object/grid-proxy/classId=BS&[other params]&specificId=1+or+'a'='a'&query=[other params] HTTP/1.1

![](https://lh3.googleusercontent.com/EyJwjx9j5DkKlvaVk3i1n0ag9Zg8DaanUg-qSz-9Zi2kR_Ai8voMSUQEl3meJIqPJGQ6T64EGfByq0WuzGUtkOKC3GMjht4Y8xhUK7tgdR1r3bAWC9_V8p9rQ2-jFVCN1zqK7jHy)

This next request sets the `specificId` parameter to `1+or‚Äôa‚Äô=‚Äôb‚Äô`. As shown in the following image, the response length is now 47, and no records were returned.

![](https://lh5.googleusercontent.com/-Wk66v8vjqZJEBtLQTJuMdiQU1oNBUtnybrm2Znq_2HAnJBuJKvksYYcCc6f0t4y5yEfo6qutXZsWUeJVgt57-ff7xCpo28tLTVQTIw9iHg_xAlfwhUxNSCJpDCfZqbPpSuzhvpU)

By combining these 2 requests, a malicious actor can programmatically return data from the database by testing each character and monitoring the response. The image below shows an example of this by requesting the database version and checking if the first character of the version is equal to 8.

![](https://lh5.googleusercontent.com/xksl3AvnkztjxufC46UnVZgSv7FhJmAy2GW-wW5_UvY7RDTfupy2gf4Lip-IjG4Y7bgoSDHuHOOB1Xr2K2kHp-JJ5NKPmSUh_Vw5QGew_1Dx6njJLi1nq5VWP6AXu3Ui13G1iuwV)
# Akaunting v2.1.12 (6 issues)

Akaunting is an enterprise accounting system, providing a variety of services related to the normal day-to-day business operations, notably in the retail sector, such as invoicing and expense tracking. More about Akaunting can be found at the [vendor's website](https://akaunting.com/).

## CVE-2021-36800: Akaunting OS Command Injection

The Akaunting application allows for PHP code sent to the application to be executed by the web server. This can lead to a shell directly on the host operating system. The vulnerability was introduced upon the creation of the `Money.php` file in the first commit, 1c01d2120941d99f758cf23be20fe5931bdd4a36. To exploit this vulnerability, the attacker must first be authenticated and already have permissions to add or modify sales invoices.

A POST sent to `/{company\_id}/sales/invoices/{invoice\_id}` with an `items[0][price]` that includes a PHP callable function is executed directly. The image below shows the post body, including a `items[0][price]` set to `phpinfo`. The response on the right shows the response, which includes the results from the application executing `phpinfo()`:

![](https://lh6.googleusercontent.com/erc_ipp3dTXiWCcwG4YcW_8C8ny_S5ASEEfkea2uZ9XjdQg3_hey6uLvlm_PQD3u2eElYDSwPXmIq_zz-CXlmatcWAZCa7DIKQEz2FKG7VpLSVw81IySCCSSjXmwaZ_SPeDfkCO_)

This is due to a lack of input sanitization in the Money.php middleware component. The following is the code responsible for the execution; as shown, it checks to see if what is received is callable and, if so, executes it.

```
protected function parseAmountFromCallable($amount)
{
if (!is_callable($amount)) {
return $amount;
}
return $amount();
}

```
## CVE-2021-36801: Akaunting Authentication Bypass in Company Selection

A user is able to change the company their account is associated with, allowing them to view/modify information from another company. This vulnerability was introduced in the first commit of the application. To exploit this vulnerability, the attacker must first be authenticated as any user.

The first image shows that the user `Test\_company\_1` is associated with the company named `My Company`:

![](https://lh6.googleusercontent.com/QrQfBgLUFxZBOHqM6yINMTJLyVfB02ix3GCKCbDIn6Wko6vXh-Ftvd0xc5iMKVRLa2W8O9q6Y2UmEq_7GDL6__uUHCZ_KE0fUy887tHg-0CREzvHtZs7VZARD_We0EfmHW1sbpE3)

While logged in as the user `Test\_company\_1` we click on `Profile` to change the user settings:

![](https://lh6.googleusercontent.com/tQ-lqyUwlhog8zFhJ_v0rRcEJEFZMkrCSG2UMeO0S-FkXjE3_TYH7T4iBkLLlXhbzIcrjKRZYxr0j9k0HlgJNDraPGShJ_EJvSaAbYnE4G_gx-aVhyA9_x9nqpcMdOHJiALDoYcp)

By clicking on the `Save` button and intercepting the request, we can modify the `companies[0]` field to the `id` of another company. The image below shows changing the company information from 1 to 2 while updating the profile information:

![](https://lh6.googleusercontent.com/7XxKxGynZxdFFlaX8vN4lbnKvPkWpNkHpM3ryWO_0QMkHvw1ggTEgVfgxekVbYIwTqigDHcLuwb8BOt7RxJrhbnnFybxIWAr2WJkvT0gwBnmR8cE5j5xNw6sQ-u93qhv9B0ZVHho)

Once done, viewing the dashboard shows that the associated company has been changed:

![](https://lh6.googleusercontent.com/QDD9Bnlg_wXcQeUQL30B9r9dPVh7PUDQNAWvuJu08WRMMYow1Qaa0MOGu_QULgZ3Rw3vMI5P4C2T4CkUE3y7Bm8KLMW0MzbEWumB_REEf8DxfVXWu3_BPXhmmSCTOxam6pKEILId)

## CVE-2021-36802: Akaunting DoS via User-Controlled 'locale' Variable

Any user can crash the Akaunting platform by supplying an invalid 'locale' variable as part of an otherwise well-formed HTTP POST request. This vulnerability was introduced in the first commit of the application. To exploit this vulnerability, the attacker must first be authenticated as any user.

The image below shows a post to `/2/settings/settings` with an invalid locale that is successfully processed without error:

![](https://lh3.googleusercontent.com/USyNdGYqfT8dMee1993ozzXHQ7V1EUcK_bbpCpXfmVHEPIiRadl2PsF4IpAINqamHZfqSLnj-fO-htOlebNOHe94RT-xzImsVA6zLXZAMAfqd_wUgFcn4LTmJKoRv2sgru2Gnl47)

Visiting any page will result in a 500 response:

![](https://lh4.googleusercontent.com/6EhHkxnsK6gBMQsD7IropQU8Nv3Qbc2a4nXS2EBQcsM1wGVyL57C3TXObqWpuxMVaQ9_d5GJNOX3DbyhMhxXLKUAfNucI11HfuV8nUx5TJ4B_9pgccpd9NYJHwRGE4ZPpvpaxFvU)
## CVE-2021-36803: Akaunting Avatar Persistent XSS

A user can inject HTML into the avatar upload process and trigger an XSS for anyone who views it, including high-privilege administrators of the application. This vulnerability was introduced in the first commit of the application. To exploit this vulnerability, the attacker must first be authenticated as any user.

The image below shows a post to `/{company\_id}/auth/users/{user\_id}` with HTML embedded in the image upload field:

![](https://lh6.googleusercontent.com/zilo7eBiWB-mId-tL_do-GedgGYbPqHrBvVmwNXTOSiVNWgiXusKA1zf8GTi3BEuT5n6yDfEV1w-ZnQ_N3seZa1jWfRWE66C5taxgLXpMnSKq4fOmcG92YrZuIt9Ukf1DqQBXmGT)

Example payload:
```

-----------------------------11088376342107705763341750165

Content-Disposition: form-data; name="picture"; filename="Screenshot\_2021-05-02\_05\_11\_16.png"

Content-Type: image/png

</pre><html><b>test</b><script>alert('xss')</script><pre>

```

The HTML is directly rendered on screen while accessing the avatar URL; e.g /{company\_id}/uploads/{upload\_id}:

![](https://lh5.googleusercontent.com/87ixGq_5DSvCsivAKVfNkM8s4DgttSAw7dNT7DBoYJKEFbVyrvwopvrb4gXZoAvQwsfCuG60ld3gSe515SI0bKrodgfC8mzn5XcB5jPTTOmmZ30mutkT01qquKYPPz_-6ZUdZViT)
## CVE-2021-36804: Akaunting Password Reset Relay

Setting the host header while sending a Post to `/auth/forgot` endpoint changes the link generated by the application. An attacker can send a password-reset request for an existing user and modify the host header to point to a web server they control. If the user clicks on the password reset URL, the attacker will receive the password-reset token and can then set the password to something the attacker knows. This vulnerability was introduced in the first commit of the application. To exploit this vulnerability, the attacker must first know or guess the email address of a valid user.

The image below shows a post to the /auth/forgot endpoint, with the Host set to example.com:

![](https://lh5.googleusercontent.com/s0sP6UNxDnNgpsP5hzYWrBMF997yZ_lu2QT7Wk4pUPEgaXZARnkT4ZrDGK-0MHKbm-8R1sNfEPVF2i55j0GnnOwTSV1YelElvnEtu_O0MMQcdPZ8thU_rTIZGsDcR9kPmrGpcBOp)

The email sent by the application directs the user to the example.com domain with the password reset token.

![](https://lh3.googleusercontent.com/ctsH9U1UEgP-8N6_lyig5RhzuWKyCLSwf8pK9FbtZNbIngnNE4YBzy3_PgjoSRwEC1FmwAV1yOKbVrXHVuEvB1O4B0lXkhxt_92c8cpqFHw83ReQAvJY-RgE7FzVXipZOd9Nb-2s)

Note that the root of this vulnerability is due to a design decision in the Laravel framework and how proxy headers are handled with respect to single instance and multi-tenant implementations. In other words, while CVE-2021-36804 is a (now fixed) vulnerability in Akaunting, other multi-tenant implementations involving Laravel should be aware that the default configuration of that framework is likely vulnerable to a similar issue. For more information on this design issue, please see Enlightn's [Host Injection Analyzer](https://www.laravel-enlightn.com/docs/security/host-injection-analyzer.html), Daniel Coulbourne's [tweet](https://twitter.com/DCoulbourne/status/1331317933675581442), and [PR 5477](https://github.com/laravel/laravel/pull/5477) in the Laravel GitHub repository.

## CVE-2021-36805: Akaunting Invoice Footer Persistent XSS

The Akaunting application allows for HTML to be written to the footer of a sales invoice and relies on its built-in ‚Äúfirewall‚Äù to prevent malicious code, such as XSS, from being accepted. The following example shows how specially crafted HTML code can bypass the filtering. This vulnerability was introduced in the first commit of the application. To exploit this vulnerability, the attacker must have the permissions to add or modify sales invoices.

A POST sent to `/{company\_id}/sales/invoices/{invoice\_id}` with a `footer` that includes the following HTML will execute the javascript:

Proof of concept payload:

```
POST /1/sales/invoices/201 HTTP/1.1
...
-----------------------------11766653461285783364827965738
Content-Disposition: form-data; name="footer"
'\"<img class="/>" onerror=alert("Vulnerable+to+XSS") src="b.png"
-----------------------------11766653461285783364827965738
‚Ä¶

```

The results of viewing the sales invoice:

![](https://lh5.googleusercontent.com/hxIIWKwYRBPPbrBZPGTt4DIZC8Rc4tBmQDIzgB_j_WB-MEEbSntFdp3VCmcuHqoEBG0_qjry1WYIiBqGcNQErd1eZLy1lRovuS7ObcIxRNve_cqiHGv9mRjIlDAyzgVXn3kzwn4i)

The payload bypasses the firewall restrictions because of the `>` placed in the class attribute. The image below shows how this string is not matched against the regex designed to prevent XSS:

![](https://lh4.googleusercontent.com/osRAdQXqMSqYVTYkUdCtVBShHaHmT_owJaSoxDpZ-NdENHzaYIWe7IHqK71ww_Lh8jqFCrDLSdmaEZLZmroLgApsrydTtHYYVA4h1D94YF1Ya6tLSJh2eXbs4tuAHE1Rh7VC_Wcj)
# Remediation

For all of these issues, updating to the latest versions of the affected applications will resolve them. If updating is difficult or impossible due to external factors or custom, local changes, users of these applications can limit their exposure by not presenting their production instances to the internet directly ‚Äî instead, expose them only to trusted internal networks with trusted insiders.

Alternatively, since these applications are open source, users can contact these projects directly for any help needed to backport a fix to their own running version. One way to discover the exact code changes is simply to look at the git diffs between the fixed version and the most immediately prior version, and the fixes should be fairly obvious to anyone familiar with the languages in which these applications are written. In general, fixing bugs is fairly straightforward once you know what the vulnerabilities are. Finding and proving out the bugs is the hard part, so thanks again to Wiktor and Trevor for their work here.

#### POST TAGS

* [Vulnerability Disclosure](/blog/tag/vulnerability-disclosure/ "Vulnerability Disclosure")
* [Open Source](/blog/tag/open-source-news/ "Open Source")

#### SHARING IS CARING

#### AUTHOR

[Tod Beardsley](/blog/author/tod-beardsley/ "Tod Beardsley")

Director of Research at Rapid7, contributing author of several Rapid7 research papers, CVE Board member, and Metasploit collaborator. https://infosec.exchange/@todb

[View Tod's Posts](/blog/author/tod-beardsley/)

![](https://blog.rapid7.com/content/images/2021/07/Data-Vulnerability2.jpg)

## Topics

* [Metasploit
  ¬†*(663)*](/blog/tag/metasploit/)
* [Vulnerability Management
  ¬†*(366)*](/blog/tag/vulnerability-management/)
* [Research
  ¬†*(243)*](/blog/tag/research/)
* [Detection and Response
  ¬†*(207)*](/blog/tag/detection-and-response/)
* [Vulnerability Disclosure
  ¬†*(150)*](/blog/tag/vulnerability-disclosure/)
* [Emergent Threat Response
  ¬†*(145)*](/blog/tag/emergent-threat-response/)
* [Cloud Security
  ¬†*(137)*](/blog/tag/cloud-security/)
* [Security Operations
  ¬†*(21)*](/blog/tag/secops/)

## Popular Tags

* [Metasploit](/blog/tag/metasploit/)
* [Metasploit Weekly Wrapup](/blog/tag/metasploit-weekly-wrapup/)
* [Vulnerability Management](/blog/tag/vulnerability-management/)
* [Research](/blog/tag/research/)
* [Detection and Response](/blog/tag/detection-and-response/)
* [Logentries](/blog/tag/logentries/)

## Related Posts

Lorex 2K Indoor Wi-Fi Security Camera: Multiple Vulnerabilities (FIXED)

[Read More](/blog/post/2024/12/03/lorex-2k-indoor-wi-fi-security-camera-multiple-vulnerabilities-fixed/)

Multiple Vulnerabilities in Wowza Streaming Engine (Fixed)

[Read More](/blog/post/2024/11/20/multiple-vulnerabilities-in-wowza-streaming-engine-fixed/)

CVE-2024-45195: Apache OFBiz Unauthenticated Remote Code Execution (Fixed)

[Read More](/blog/post/2024/09/05/cve-2024-45195-apache-ofbiz-unauthenticated-remote-code-execution-fixed/)

CVE-2024-6922: Automation Anywhere Automation 360 Server-Side Request Forgery

[Read More](/blog/post/2024/07/26/cve-2024-6922-automation-anywhere-automation-360-server-side-request-forgery/)

## Related Posts

[IoT

Lorex 2K Indoor Wi-Fi Security Camera: Multiple Vulnerabilities (FIXED)

Read Full Post](/blog/post/2024/12/03/lorex-2k-indoor-wi-fi-security-camera-multiple-vulnerabilities-fixed/)

[Vulnerability Disclosure

Multiple Vulnerabilities in Wowza Streaming Engine (Fixed)

Read Full Post](/blog/post/2024/11/20/multiple-vulnerabilities-in-wowza-streaming-engine-fixed/)

[Vulnerability Disclosure

CVE-2024-45195: Apache OFBiz Unauthenticated Remote Code Execution (Fixed)

Read Full Post](/blog/post/2024/09/05/cve-2024-45195-apache-ofbiz-unauthenticated-remote-code-execution-fixed/)

[Vulnerability Disclosure

CVE-2024-6922: Automation Anywhere Automation 360 Server-Side Request Forgery

Read Full Post](/blog/post/2024/07/26/cve-2024-6922-automation-anywhere-automation-360-server-side-request-forgery/)

[View All Posts](/blog/posts/)

Search

[BACK TO TOP
![](/includes/img/up-arrow-lightgray.png?width=1200)](#__)

[![Rapid7 logo](/includes/img/Rapid7_logo.svg?width=1200&quality=90)](/)
CUSTOMER SUPPORT
+1-866-390-8113 (Toll Free)
SALES SUPPORT
+1-866-772-7437 (Toll Free)
Need to report an Escalation or a Breach?
[Get Help](/services/incident-response-customer-escalation/)

SOLUTIONS
[The Command Platform](/platform/)
[Exposure Command](/products/command/exposure-management/)
[Managed Threat Complete](/services/managed-detection-and-response-mdr/)

SUPPORT & RESOURCES
[Product Support](https://www.rapid7.com/for-customers/)
[Resource Library](https://www.rapid7.com/resources/)
[Our Customers](https://www.rapid7.com/customers/)
[Events & Webcasts](https://www.rapid7.com/about/events-webcasts/)
[Training & Certification](https://www.rapid7.com/services/training-certification/)
[Cybersecurity Fundamentals](https://www.rapid7.com/fundamentals/)
[Vulnerability & Exploit Database](https://www.rapid7.com/db/)

ABOUT US
[Company](https://www.rapid7.com/about/company/)
[Diversity, Equity, and Inclusion](https://www.rapid7.com/about/diversity-equity-and-inclusion/)
[Leadership](https://www.rapid7.com/about/leadership/)
[News & Press Releases](https://www.rapid7.com/about/news/)
[Public Policy](https://www.rapid7.com/about/public-policy/)
[Open Source](https://www.rapid7.com/open-source/)
[Investors](https://investors.rapid7.com/overview/default.aspx)

CONNECT WITH US
[Contact](https://www.rapid7.com/contact/)
[Blog](https://www.rapid7.com/blog/)
[Support Login](https://insight.rapid7.com/login)
[Careers](https://careers.rapid7.com/careers-home)

¬© Rapid7
[Legal Terms](/legal/)
¬† | ¬† [Privacy Policy](/privacy-policy/)
¬† | ¬† [Export Notice](/export-notice/)
¬† | ¬† [Trust](/trust/)
¬† | ¬† Do Not Sell or Share My Personal Information
¬† | ¬† Cookie Preferences

Contact Us

## Submit your information and we will get in touch with you.

#### Thank you for contacting us.

##### We will be in touch shortly.

![Rapid7 logo](/includes/img/logo-black.png)

### General:

info@rapid7.com

### Sales:

+1-866-772-7437
sales@rapid7.com

### Support:

+1‚Äì866‚Äì390‚Äì8113 (toll free)
support@rapid7.com

### Incident Response:

1-844-727-4347

[More Contact Info](/contact/)

## Never miss a blog

Get the latest stories, expertise, and news about security today.

You‚Äôre almost done!
 Check your email to confirm your subscription.



=== Content from twitter.com_ccda5a6b_20250115_112302.html ===



=== Content from github.com_a3342509_20250115_112307.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flaravel%2Flaravel%2Fpull%2F5477)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flaravel%2Flaravel%2Fpull%2F5477)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=laravel%2Flaravel)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[laravel](/laravel)
/
**[laravel](/laravel/laravel)**
Public

* [Notifications](/login?return_to=%2Flaravel%2Flaravel) You must be signed in to change notification settings
* [Fork
  24.1k](/login?return_to=%2Flaravel%2Flaravel)
* [Star
   79.3k](/login?return_to=%2Flaravel%2Flaravel)

* [Code](/laravel/laravel)
* [Pull requests
  0](/laravel/laravel/pulls)
* [Actions](/laravel/laravel/actions)
* [Security](/laravel/laravel/security)
* [Insights](/laravel/laravel/pulse)

Additional navigation options

* [Code](/laravel/laravel)
* [Pull requests](/laravel/laravel/pulls)
* [Actions](/laravel/laravel/actions)
* [Security](/laravel/laravel/security)
* [Insights](/laravel/laravel/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Flaravel%2Flaravel%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Flaravel%2Flaravel%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# [8.x] Uncomment TrustHosts middleware to enable it by default #5477

 Merged

[taylorotwell](/taylorotwell)
merged 1 commit into
[laravel:8.x](/laravel/laravel/tree/8.x "laravel/laravel:8.x")
from
[DanielCoulbourne:enable-trust-hosts-middleware-by-default](/DanielCoulbourne/laravel/tree/enable-trust-hosts-middleware-by-default "DanielCoulbourne/laravel:enable-trust-hosts-middleware-by-default")

Nov 26, 2020

 Merged

# [[8.x] Uncomment TrustHosts middleware to enable it by default](#top) #5477

[taylorotwell](/taylorotwell)
merged 1 commit into
[laravel:8.x](/laravel/laravel/tree/8.x "laravel/laravel:8.x")
from
[DanielCoulbourne:enable-trust-hosts-middleware-by-default](/DanielCoulbourne/laravel/tree/enable-trust-hosts-middleware-by-default "DanielCoulbourne/laravel:enable-trust-hosts-middleware-by-default")

Nov 26, 2020

[Conversation
21](/laravel/laravel/pull/5477)
[Commits
1](/laravel/laravel/pull/5477/commits)
[Checks
0](/laravel/laravel/pull/5477/checks)
[Files changed](/laravel/laravel/pull/5477/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=60&v=4)](/DanielCoulbourne)

Copy link

Contributor

### @DanielCoulbourne **[DanielCoulbourne](/DanielCoulbourne)** commented [Nov 23, 2020](#issue-749106630)

We recently learned of a vulnerability in our app through our Bug Bounty program which allowed an attacker to change the host of a signed URL using the `X-Forwarded-Host` header. This allowed an attacker to generate a malicious password-reset email which, if the link was clicked, would send the user's password reset token to a website controlled by the hacker.

Enabling this middleware by default could close this vulnerability for many websites who may currently be exposed to this same vulnerability.

Sorry, something went wrong.

 üëç
15
 michaeldyrynda, inxilpro, davidbirkin, Mdhesari, duncanmcclean, egantz, harrygulliford, antimech, bakerkretzmar, ChrisSchwerdt, and 5 more reacted with thumbs up emoji

All reactions

* üëç
  15 reactions

[![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=40&v=4)](/DanielCoulbourne)

`[Uncomment TrustHosts middleware to enable it by default.](/laravel/laravel/pull/5477/commits/4f08298c94519ee7899af5fbc96484fd418e86d4 "Uncomment TrustHosts middleware to enable it by default.")`

`[4f08298](/laravel/laravel/pull/5477/commits/4f08298c94519ee7899af5fbc96484fd418e86d4)`

[![@driesvints](https://avatars.githubusercontent.com/u/594614?s=40&u=f96266e2d8ba83946fe5de16e7b40db002001159&v=4)](/driesvints)
[driesvints](/driesvints)
changed the title
~~Uncomment TrustHosts middleware to enable it by default.~~
[8.x] Uncomment TrustHosts middleware to enable it by default.
[Nov 23, 2020](#event-4029550330)

[![@GrahamCampbell](https://avatars.githubusercontent.com/u/2829600?s=80&u=38a7b734074d6f6d808c2a4f11a87814d94caf4a&v=4)](/GrahamCampbell)

Copy link

Member

### **[GrahamCampbell](/GrahamCampbell)** commented [Nov 24, 2020](#issuecomment-732513176) ‚Ä¢ edited Loading

| This is not included by default because it breaks multi-tenancy applications. It is also possible to mitigate this vulnerability by using secure nginx/apache/load balancer configuration that checks the `Host` header. I would argue this is the correct place to address this, not within the app code). One should configure servers to look at the host header, just like one should configure databases to have a password other than the default. That said, Laravel provides this out of convenience.  For example:  ``` $ curl https://styleci.io/ -H'Host: example.com' <html> <head><title>403 Forbidden</title></head> <body> <center><h1>403 Forbidden</h1></center> <hr><center>cloudflare</center> </body> </html>  ``` |
| --- |

 üëç
1
 DanielCoulbourne reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@CaddyDz](https://avatars.githubusercontent.com/u/13698160?s=80&u=bd80ebad309068f01587a9bb0bcee5beaaa677c5&v=4)](/CaddyDz)

Copy link

Contributor

### **[CaddyDz](/CaddyDz)** commented [Nov 24, 2020](#issuecomment-732755439)

| [@GrahamCampbell](https://github.com/GrahamCampbell) do you know if Laravel Forge adds this nginx config by default? |
| --- |

All reactions

Sorry, something went wrong.

[![@GrahamCampbell](https://avatars.githubusercontent.com/u/2829600?s=80&u=38a7b734074d6f6d808c2a4f11a87814d94caf4a&v=4)](/GrahamCampbell)

Copy link

Member

### **[GrahamCampbell](/GrahamCampbell)** commented [Nov 24, 2020](#issuecomment-732815489)

| I'm not sure. // cc [@jbrooksuk](https://github.com/jbrooksuk) |
| --- |

All reactions

Sorry, something went wrong.

[![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=80&u=8b44c0b2f4938e91d8dff0d9667c95f571358c86&v=4)](/taylorotwell)

Copy link

Member

### **[taylorotwell](/taylorotwell)** commented [Nov 24, 2020](#issuecomment-733008159)

| [@CaddyDz](https://github.com/CaddyDz) Forge is not vulnerable to this even when not using this middleware because Forge sites listen on a specific host. |
| --- |

 üëç
7
 CaddyDz, jbrooksuk, DanielCoulbourne, bomshteyn, egantz, edcs, and KiVeR reacted with thumbs up emoji

All reactions

* üëç
  7 reactions

Sorry, something went wrong.

[![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=80&u=7ce4c4612a5d5443878cf060fe7b89a3274a9a50&v=4)](/DanielCoulbourne)

Copy link

Contributor

Author

### **[DanielCoulbourne](/DanielCoulbourne)** commented [Nov 24, 2020](#issuecomment-733136931) ‚Ä¢ edited Loading

| To [@GrahamCampbell](https://github.com/GrahamCampbell) 's point:  This will break multi-tenancy apps which use custom domains (subdomains of the `APP_URL` are explicitly supported by the default `TrustHosts` middleware). This sort of multi-tenancy scenario is pretty niche, and I don't think it's a big ask to make people remove one Middleware for that very specialized use-case.  Conversely, this vulnerability would affect all Laravel sites behind reverse proxies unless they explicitly set the `X-Forwarded-Host` header. This is not documented anywhere in the Laravel docs (because Laravel has no docs on setting up reverse proxies) and is an incredibly easy trap to fall into. I think we should prefer security-by-default for users who don't know everything to convenience-by-default for people building very specialized use-cases.  Ultimately this comes down to priorities. I'm making a suggestion that we prioritize security for a large segment of users over convenience for a small segment of users. |
| --- |

 üëç
4
 lasseeee, Rattone, ankurk91, and rjmo reacted with thumbs up emoji

All reactions

* üëç
  4 reactions

Sorry, something went wrong.

[![@GrahamCampbell](https://avatars.githubusercontent.com/u/2829600?s=40&u=38a7b734074d6f6d808c2a4f11a87814d94caf4a&v=4)](/GrahamCampbell)
[GrahamCampbell](/GrahamCampbell)
changed the title
~~[8.x] Uncomment TrustHosts middleware to enable it by default.~~
[8.x] Uncomment TrustHosts middleware to enable it by default
[Nov 24, 2020](#event-4034375685)

[![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=80&u=7ce4c4612a5d5443878cf060fe7b89a3274a9a50&v=4)](/DanielCoulbourne)

Copy link

Contributor

Author

### **[DanielCoulbourne](/DanielCoulbourne)** commented [Nov 24, 2020](#issuecomment-733185337)

| I put together a quick demo of the vulnerability for anyone who is having a hard time envisioning it: <https://twitter.com/DCoulbourne/status/1331317933675581442> |
| --- |

 üëç
3
 egantz, kelcampus, and rjmo reacted with thumbs up emoji

All reactions

* üëç
  3 reactions

Sorry, something went wrong.

[![@NationwidePharma](https://avatars.githubusercontent.com/u/42869757?s=80&v=4)](/NationwidePharma)

Copy link

### **[NationwidePharma](/NationwidePharma)** commented [Nov 24, 2020](#issuecomment-733202263) via email

| Do the majority of users do reverse proxies? If so, that is news to me. Get Outlook for iOS<<https://aka.ms/o0ukef>> ‚Ä¶ \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ Justin Lawrence, M.S. Data Architect 1270 N. Loop 1604 East, STE 13, Suite 1306 SAN ANTONIO, TX 78232 210.778.5406 [www.nationwidepharmaceutical.com](http://www.nationwidepharmaceutical.com) bridging the gap between the government and healthcare industry one of the nation‚Äôs fastest-growing private companies for 2nd year in a row - Inc. 5000 From: Daniel Coulbourne <notifications@github.com> Sent: Tuesday, November 24, 2020 11:51:49 AM To: laravel/laravel <laravel@noreply.github.com> Cc: Subscribed <subscribed@noreply.github.com> Subject: Re: [laravel/laravel] [8.x] Uncomment TrustHosts middleware to enable it by default. ([#5477](https://github.com/laravel/laravel/pull/5477)) To [@GrahamCampbell](https://github.com/GrahamCampbell)<<https://github.com/GrahamCampbell>> 's point: This will break multi-tenancy apps which use custom domains (subdomains of the APP\_URL are explicitly supported by the default TrustHosts middleware). This sort of multi-tenancy scenario is pretty niche, and I don't think it's a big ask to make people remove one Middleware for that very specialized use-case. Conversely, this vulnerability would affect all Laravel sites behind reverse proxies unless they explicitly set the X-Forwarded-Host header. This is not documented anywhere in the Laravel docs (because Laravel has no docs on setting up reverse proxies) and is an incredibly easy trap to fall into. I think we should prefer security-by-default for users who don't know everything to convenience-by-default for people building very specialized use-cases. Ultimately this comes down to priorities. I'm making a suggestion that we prioritize security for a large segment of users over convenience for a small segment of users. ‚Äî You are receiving this because you are subscribed to this thread. Reply to this email directly, view it on GitHub<[#5477 (comment)](https://github.com/laravel/laravel/pull/5477#issuecomment-733136931)>, or unsubscribe<<https://github.com/notifications/unsubscribe-auth/AKHCH7IFBQUPE65REMDY3XTSRPXDLANCNFSM4T77EORA>>. |
| --- |

All reactions

Sorry, something went wrong.

[![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=80&u=7ce4c4612a5d5443878cf060fe7b89a3274a9a50&v=4)](/DanielCoulbourne)

Copy link

Contributor

Author

### **[DanielCoulbourne](/DanielCoulbourne)** commented [Nov 24, 2020](#issuecomment-733204903)

| Nowhere near the majority, but many. |
| --- |

All reactions

Sorry, something went wrong.

[![@NationwidePharma](https://avatars.githubusercontent.com/u/42869757?s=80&v=4)](/NationwidePharma)

Copy link

### **[NationwidePharma](/NationwidePharma)** commented [Nov 24, 2020](#issuecomment-733205839) via email

| Many thanks for raising awareness about this at the very least. Get Outlook for iOS<<https://aka.ms/o0ukef>> ‚Ä¶ \_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ Justin Lawrence, M.S. Data Architect 1270 N. Loop 1604 East, STE 13, Suite 1306 SAN ANTONIO, TX 78232 210.778.5406 [www.nationwidepharmaceutical.com](http://www.nationwidepharmaceutical.com) bridging the gap between the government and healthcare industry one of the nation‚Äôs fastest-growing private companies for 2nd year in a row - Inc. 5000 From: Daniel Coulbourne <notifications@github.com> Sent: Tuesday, November 24, 2020 2:06:46 PM To: laravel/laravel <laravel@noreply.github.com> Cc: Justin Lawrence, M.S. <justin@nwp-mail.com>; Comment <comment@noreply.github.com> Subject: Re: [laravel/laravel] [8.x] Uncomment TrustHosts middleware to enable it by default ([#5477](https://github.com/laravel/laravel/pull/5477)) Nowhere near the majority, but many. ‚Äî You are receiving this because you commented. Reply to this email directly, view it on GitHub<[#5477 (comment)](https://github.com/laravel/laravel/pull/5477#issuecomment-733204903)>, or unsubscribe<<https://github.com/notifications/unsubscribe-auth/AKHCH7NTSKWVJAMVMTMRJG3SRQG5NANCNFSM4T77EORA>>. |
| --- |

 üëç
1
 DanielCoulbourne reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@inxilpro](https://avatars.githubusercontent.com/u/21592?s=80&u=b3a4527d26452a185bc1c48119e7eb0fdd334e57&v=4)](/inxilpro)

Copy link

### **[inxilpro](/inxilpro)** commented [Nov 24, 2020](#issuecomment-733295244)

| Also, just to be clear, the primary concern isn't the `Host` header‚Äîit's when an `X-Forwarded-Host` header is sent through a valid trusted proxy.  Imagine a scenario where someone followed [one of the top Google search results for "nginx reverse proxy laravel"](https://laracasts.com/discuss/channels/laravel/configure-laravel-on-ubuntu-with-nginx-reverse-proxy-apache) which, like most other tutorials that I've looked at today, suggest the following directive:  ``` proxy_set_header X-Forwarded-For $remote_addr;  ```  Next, imagine they followed the [Laravel docs on TrustedProxies](https://laravel.com/docs/8.x/requests#configuring-trusted-proxies), adding their proxy server's IP address to the `$proxies` property of the middleware.  Given those two steps, they are now vulnerable to this exploit.  There are 3 possible fixes.  The first is to explicitly set all `X-Forwarded-*` headers at your reverse proxy. You can do this by adding these additional directives:  ``` proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header X-Forwarded-Host $host; proxy_set_header X-Forwarded-Port $server_port;  ```  The second fix is to set `TrustProxies::$headers` to `Request::HEADER_X_FORWARDED_FOR` which means that it will only trust the `X-Forwarded-For` header and discard the rest.  The third is to enable the default `TrustHosts` middleware, which ensures that only subdomains of the the `APP_URL` are trusted.  I agree with [@DanielCoulbourne](https://github.com/DanielCoulbourne) that enabling `TrustHosts` is probably the best default for 99% of users. If that's not going to happen, I think that setting `TrustProxies::$headers` to `Request::HEADER_X_FORWARDED_FOR` by default is probably another good option. |
| --- |

 üëç
5
 harrygulliford, DanielCoulbourne, K2ouMais, begnini, and trevorgehman reacted with thumbs up emoji

All reactions

* üëç
  5 reactions

Sorry, something went wrong.

[![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=40&u=8b44c0b2f4938e91d8dff0d9667c95f571358c86&v=4)](/taylorotwell)
[taylorotwell](/taylorotwell)
merged commit [`f6f772b`](/laravel/laravel/commit/f6f772ba5490de48d8a79747b39540afe61eed24)
into
laravel:8.x

[Nov 26, 2020](https://github.com/laravel/laravel/pull/5477#event-4042832435)

[![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=80&u=8b44c0b2f4938e91d8dff0d9667c95f571358c86&v=4)](/taylorotwell)

Copy link

Member

### **[taylorotwell](/taylorotwell)** commented [Nov 26, 2020](#issuecomment-734334131)

| I think I will go ahead with this. "Multi-tenant" applications are not as common as traditional applications and if someone is building one they can just comment out the middleware. |
| --- |

 üëç
7
 danielalvez91, DanielCoulbourne, bambamboole, johanrosenson, bakerkretzmar, lantis1008, and om3rcitak reacted with thumbs up emoji
 üòï
1
 ankurk91 reacted with confused emoji

All reactions

* üëç
  7 reactions
* üòï
  1 reaction

Sorry, something went wrong.

 [![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=40&u=7ce4c4612a5d5443878cf060fe7b89a3274a9a50&v=4)](/DanielCoulbourne)
[DanielCoulbourne](/DanielCoulbourne)
deleted the
enable-trust-hosts-middleware-by-default

branch
[November 29, 2020 10:25](#event-4048890211)

[![@patrickcarlohickman](https://avatars.githubusercontent.com/u/6036266?s=80&u=217720a0e296d30c7f7c291d6f4e8fc75ea2c515&v=4)](/patrickcarlohickman)

Copy link

### **[patrickcarlohickman](/patrickcarlohickman)** commented [Dec 8, 2020](#issuecomment-741123483)

| Just some additional context if anyone was curious.  This vulnerability was first fixed in 5.4.22, with this commit: [laravel/framework@cef1055](https://github.com/laravel/framework/commit/cef10551820530632a86fa6f1306fee95c5cac43).  Here is a Laravel News article related to it: <https://laravel-news.com/laravel-5-4-22-is-now-released-and-includes-a-security-fix>. This fix also broke domain-based multi-tenant applications, but it seems the security aspect won out.  It looks like the vulnerability was reintroduced in 6.18.7, with this commit: [laravel/framework@1eaaf6c](https://github.com/laravel/framework/commit/1eaaf6c59e8d614ae1991f2315cbccffa817e92c) ([PR32345](https://github.com/laravel/framework/pull/32345))  This seems like this is a nicer fix than the original one, though. Of course, this middleware didn't exist back then. |
| --- |

 üëç
5
 wilmanbarrios, inxilpro, ChrisSchwerdt, rdarcy1, and kelcampus reacted with thumbs up emoji

All reactions

* üëç
  5 reactions

Sorry, something went wrong.

[![@jbrooksuk](https://avatars.githubusercontent.com/u/246103?s=80&u=d418adfc506537db16e563261c9fd3349e0f774f&v=4)](/jbrooksuk)

Copy link

Member

### **[jbrooksuk](/jbrooksuk)** commented [Dec 10, 2020](#issuecomment-742460437)

| Just a note for Forge users deploying their applications to the `default` site; by default, your app will return `404 Not Found`. You have a few options to fix this:   1. Comment out the `TrustHosts` middleware. 2. Update your Environment so that `APP_URL` is set to the server's IP address. 3. Deploy your site to a (sub)domain. |
| --- |

 üëç
1
 fabianmuema reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@themsaid](https://avatars.githubusercontent.com/u/4332182?s=80&u=9500cf9efe0264e8a38f6d9b61748073fd915f85&v=4)](/themsaid)

Copy link

Member

### **[themsaid](/themsaid)** commented [Dec 10, 2020](#issuecomment-742468488) ‚Ä¢ edited Loading

| This also broke Vapor. Vanity domains stop working once you add a custom domain, and if you have multiple custom domains only one will work and the rest will not work.  If we're keeping this middleware uncommented we should make a major announcement about it so people on Forge & Vapor make sure they comment it. Or add a build step in vapor to comment that middleware before deploying. |
| --- |

All reactions

Sorry, something went wrong.

[![@inxilpro](https://avatars.githubusercontent.com/u/21592?s=80&u=b3a4527d26452a185bc1c48119e7eb0fdd334e57&v=4)](/inxilpro)

Copy link

### **[inxilpro](/inxilpro)** commented [Dec 10, 2020](#issuecomment-742478634)

| I do think that setting a new default for `TrustProxies::$headers` is another viable option. Maybe that's going to be a better solution that strikes the right balance. |
| --- |

 üëç
2
 paras-malhotra and trevorgehman reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=80&u=8b44c0b2f4938e91d8dff0d9667c95f571358c86&v=4)](/taylorotwell)

Copy link

Member

### **[taylorotwell](/taylorotwell)** commented [Dec 10, 2020](#issuecomment-742512988)

| Probably we have to revert this and let people opt-in to it like Symfony does. |
| --- |

All reactions

Sorry, something went wrong.

[![@Thiritin](https://avatars.githubusercontent.com/u/6755282?s=80&u=64f853d0a54cfdff87ed2ab81c09bc30e207bad9&v=4)](/Thiritin)

Copy link

### **[Thiritin](/Thiritin)** commented [Dec 10, 2020](#issuecomment-742534676)

| [@DanielCoulbourne](https://github.com/DanielCoulbourne) Just for clarification, normally a Man in the middle attack should be adverted by using a secure connection aka "https". Isn't a Site protected from this vulnerability or more perhaps the user if the site is fully secured with https? |
| --- |

All reactions

Sorry, something went wrong.

[![@michaeldyrynda](https://avatars.githubusercontent.com/u/558441?s=80&u=f848575bea38d57486f386d2e82231cea00549ca&v=4)](/michaeldyrynda)

Copy link

Contributor

### **[michaeldyrynda](/michaeldyrynda)** commented [Dec 10, 2020](#issuecomment-742545673)

| It's fairly common, I think, for load balancers to handle TLS offloading and communicate with application servers behind them over HTTP. |
| --- |

All reactions

Sorry, something went wrong.

[![@paras-malhotra](https://avatars.githubusercontent.com/u/16099046?s=80&u=47e8c67ca1f5b4f5483ad6f69d75b2f79449caaa&v=4)](/paras-malhotra)

Copy link

Contributor

### **[paras-malhotra](/paras-malhotra)** commented [Dec 10, 2020](#issuecomment-742561686)

| I think [@inxilpro](https://github.com/inxilpro)'s suggestion on the TrustProxies header might be the best way to go without breaking Forge. [@Thiritin](https://github.com/Thiritin) check out Daniel's [demo video](https://twitter.com/DCoulbourne/status/1331317933675581442). |
| --- |

All reactions

Sorry, something went wrong.

[![@inxilpro](https://avatars.githubusercontent.com/u/21592?s=80&u=b3a4527d26452a185bc1c48119e7eb0fdd334e57&v=4)](/inxilpro)

Copy link

### **[inxilpro](/inxilpro)** commented [Dec 10, 2020](#issuecomment-742572132)

| Just for clarification, normally a Man in the middle attack should be adverted by using a secure connection aka "https". Isn't a Site protected from this vulnerability or more perhaps the user if the site is fully secured with https?  It's not an HTTPS issue. The issue is that `TrustProxies` also trusts the `X-Forwarded-Host` header, which many proxies do not set by default. |
| --- |

All reactions

Sorry, something went wrong.

[![@inxilpro](https://avatars.githubusercontent.com/u/21592?s=80&u=b3a4527d26452a185bc1c48119e7eb0fdd334e57&v=4)](/inxilpro)

Copy link

### **[inxilpro](/inxilpro)** commented [Dec 10, 2020](#issuecomment-742574242)

| [@themsaid](https://github.com/themsaid) and [@jbrooksuk](https://github.com/jbrooksuk) ‚Äî Are you able to check what happens when you:   1. Disable the `TrustHosts` middleware 2. Update [`TrustProxies::$headers`](https://github.com/laravel/laravel/blob/03ecf00f7a4e14c049e41bb111430877313449b9/app/Http/Middleware/TrustProxies.php#L22) from `Request::HEADER_X_FORWARDED_ALL` to `Request::HEADER_X_FORWARDED_FOR`   Do those two changes address the issues with Vapor and Forge? |
| --- |

 üëç
1
 timmcleod reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[suyar](/suyar)
referenced
this pull request
[Dec 21, 2020](#ref-commit-b7cde8b)
[![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=40&u=8b44c0b2f4938e91d8dff0d9667c95f571358c86&v=4)](/taylorotwell)

`[comment trust hosts](/laravel/laravel/commit/b7cde8b495e183f386da63ff7792e0dea9cfcf56 "comment trust hosts")`

`[b7cde8b](/laravel/laravel/commit/b7cde8b495e183f386da63ff7792e0dea9cfcf56)`

[![@paras-malhotra](https://avatars.githubusercontent.com/u/16099046?s=40&u=47e8c67ca1f5b4f5483ad6f69d75b2f79449caaa&v=4)](/paras-malhotra)
[paras-malhotra](/paras-malhotra)
mentioned this pull request
[Mar 5, 2021](#ref-issue-823450542)

[[Question] Trusted hosts without trusted proxies is useless?
enlightn/enlightn#54](/enlightn/enlightn/issues/54)

Closed

[![@hackerESQ](https://avatars.githubusercontent.com/u/16628119?s=40&v=4)](/hackerESQ)
[hackerESQ](/hackerESQ)
mentioned this pull request
[Mar 11, 2021](#ref-issue-828756874)

[TrustHost middleware blocking Domain identification by default in Laravel 8.x
archtechx/tenancy#614](/archtechx/tenancy/issues/614)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Flaravel%2Flaravel%2Fpull%2F5477)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

12 participants

[![@DanielCoulbourne](https://avatars.githubusercontent.com/u/429010?s=52&v=4)](/DanielCoulbourne) [![@GrahamCampbell](https://avatars.githubusercontent.com/u/2829600?s=52&v=4)](/GrahamCampbell) [![@CaddyDz](https://avatars.githubusercontent.com/u/13698160?s=52&v=4)](/CaddyDz) [![@taylorotwell](https://avatars.githubusercontent.com/u/463230?s=52&v=4)](/taylorotwell) [![@NationwidePharma](https://avatars.githubusercontent.com/u/42869757?s=52&v=4)](/NationwidePharma) [![@inxilpro](https://avatars.githubusercontent.com/u/21592?s=52&v=4)](/inxilpro) [![@patrickcarlohickman](https://avatars.githubusercontent.com/u/6036266?s=52&v=4)](/patrickcarlohickman) [![@jbrooksuk](https://avatars.githubusercontent.com/u/246103?s=52&v=4)](/jbrooksuk) [![@themsaid](https://avatars.githubusercontent.com/u/4332182?s=52&v=4)](/themsaid) [![@Thiritin](https://avatars.githubusercontent.com/u/6755282?s=52&v=4)](/Thiritin) [![@michaeldyrynda](https://avatars.githubusercontent.com/u/558441?s=52&v=4)](/michaeldyrynda) [![@paras-malhotra](https://avatars.githubusercontent.com/u/16099046?s=52&v=4)](/paras-malhotra)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from www.laravel-enlightn.com_8ccfddff_20250115_112302.html ===

  [Enlightn](/docs/getting-started/installation.html)   [Home
  (opens new window)](https://www.laravel-enlightn.com)[Github
  (opens new window)](https://github.com/enlightn/enlightn)   [Home
  (opens new window)](https://www.laravel-enlightn.com)[Github
  (opens new window)](https://github.com/enlightn/enlightn)

* Getting Started

  + [Installation](/docs/getting-started/installation.html)
  + [Configuration](/docs/getting-started/configuration.html)
  + [Running Enlightn](/docs/getting-started/usage.html)
  + [Github Bot Integration](/docs/getting-started/github-bot.html)
  + [Web UI](/docs/getting-started/web-ui.html)
  + [Contribution Guide](/docs/getting-started/contribution-guide.html)
  + [Support](/docs/getting-started/support.html)
* [Performance Checks](/docs/performance/)
* [Security Checks](/docs/security/)
  + [App Debug Analyzer](/docs/security/app-debug-analyzer.html)
  + [App Debug Hide Analyzer](/docs/security/app-debug-hide-analyzer.html)
  + [App Key Analyzer](/docs/security/app-key-analyzer.html)
  + [Arbitrary File Upload AnalyzerPRO](/docs/security/arbitrary-file-upload-analyzer.html)
  + [Clickjacking AnalyzerPRO](/docs/security/clickjacking-analyzer.html)
  + [Column Name SQL Injection AnalyzerPRO](/docs/security/column-name-sql-injection-analyzer.html)
  + [Command Injection AnalyzerPRO](/docs/security/command-injection-analyzer.html)
  + [Cookie Domain AnalyzerPRO](/docs/security/cookie-domain-analyzer.html)
  + [CSRF Analyzer](/docs/security/csrf-analyzer.html)
  + [Debug Statement AnalyzerPRO](/docs/security/debug-statement-analyzer.html)
  + [Directory Traversal AnalyzerPRO](/docs/security/directory-traversal-analyzer.html)
  + [Encrypted Cookies Analyzer](/docs/security/encrypted-cookies-analyzer.html)
  + [Env Access Analyzer](/docs/security/env-access-analyzer.html)
  + [Eval AnalyzerPRO](/docs/security/eval-analyzer.html)
  + [Extract AnalyzerPRO](/docs/security/extract-analyzer.html)
  + [File Bomb Validation AnalyzerPRO](/docs/security/file-bomb-validation-analyzer.html)
  + [File Permissions Analyzer](/docs/security/file-permissions-analyzer.html)
  + [File Size Validation AnalyzerPRO](/docs/security/file-size-validation-analyzer.html)
  + [Fillable Foreign Key Analyzer](/docs/security/fillable-foreign-key-analyzer.html)
  + [Frontend Vulnerable Dependency Analyzer](/docs/security/frontend-vulnerable-dependency-analyzer.html)
  + [Hard Coded Credentials AnalyzerPRO](/docs/security/hard-coded-credentials-analyzer.html)
  + [Hashing Strength Analyzer](/docs/security/hashing-strength-analyzer.html)
  + [Horizon Security AnalyzerPRO](/docs/security/horizon-security-analyzer.html)
  + [Host Injection AnalyzerPRO](/docs/security/host-injection-analyzer.html)
  + [HSTS Header Analyzer](/docs/security/hsts-header-analyzer.html)
  + [HTTP Only Cookie Analyzer](/docs/security/http-only-cookie-analyzer.html)
  + [License Analyzer](/docs/security/license-analyzer.html)
  + [Login Throttling Analyzer](/docs/security/login-throttling-analyzer.html)
  + [Mass Assignment Analyzer](/docs/security/mass-assignment-analyzer.html)
  + [Mime Sniffing AnalyzerPRO](/docs/security/mime-sniffing-analyzer.html)
  + [Nova Security AnalyzerPRO](/docs/security/nova-security-analyzer.html)
  + [Object Injection AnalyzerPRO](/docs/security/object-injection-analyzer.html)
  + [Open Redirection AnalyzerPRO](/docs/security/open-redirection-analyzer.html)
  + [PHP Ini Analyzer](/docs/security/php-ini-analyzer.html)
  + [Raw SQL Injection AnalyzerPRO](/docs/security/raw-sql-injection-analyzer.html)
  + [Regex DOS AnalyzerPRO](/docs/security/regex-dos-analyzer.html)
  + [Same Site Cookie AnalyzerPRO](/docs/security/same-site-cookie-analyzer.html)
  + [Secure Cookie AnalyzerPRO](/docs/security/secure-cookie-analyzer.html)
  + [Session Timeout AnalyzerPRO](/docs/security/session-timeout-analyzer.html)
  + [SQL Injection AnalyzerPRO](/docs/security/sql-injection-analyzer.html)
  + [Stable Dependency Analyzer](/docs/security/stable-dependency-analyzer.html)
  + [Telescope Security AnalyzerPRO](/docs/security/telescope-security-analyzer.html)
  + [Unguarded Models Analyzer](/docs/security/unguarded-models-analyzer.html)
  + [Unrestricted File Upload AnalyzerPRO](/docs/security/unrestricted-file-upload-analyzer.html)
  + [Up To Date Dependency Analyzer](/docs/security/up-to-date-dependency-analyzer.html)
  + [Validation SQL Injection AnalyzerPRO](/docs/security/validation-sql-injection-analyzer.html)
  + [Vulnerable Dependency Analyzer](/docs/security/vulnerable-dependency-analyzer.html)
  + [Web Server Fingerprinting AnalyzerPRO](/docs/security/web-server-fingerprinting-analyzer.html)
  + [XSS Analyzer](/docs/security/xss-analyzer.html)
* [Reliability Checks](/docs/reliability/)

# [#](#host-injection-analyzer) Host Injection Analyzer PRO

| Category | Severity | Time To Fix |
| --- | --- | --- |
| üõ°Ô∏è Security | Major | 5 minutes |

**Class:** `Enlightn\EnlightnPro\Analyzers\Security\HostInjectionAnalyzer`

## [#](#introduction) Introduction

This analyzer ensures that your application is not vulnerable to host injection attacks. In this attack, the attacker can change the host of a signed URL using the `X-Forwarded-Host` or the `Host` header. This would allow an attacker to generate a malicious password reset email with a link to a website controlled by the attacker.

Host injection attacks can happen via either the `X-Forwarded-Host` header or the `Host` header:

1. If your application is behind a load balancer or reverse proxy and it does not set trusted hosts, it will be exposed to host injection attacks via the `X-Forwarded-Host` header. If you have already set the `X-Forwarded-Host` header at your reverse proxy level, you may ignore this analyzer.
2. If your web server configuration is insecure, it may allow host injection attacks via the `Host` Header. This may happen if you use server name wildcards or do not have catch-all server configurations to catch all requests with unrecognized Host headers.

[This video  (opens new window)](https://www.youtube.com/watch?v=KGTTlzZiihw) shows a live demo of the vulnerability. Note that password reset poisoning is just one of the possible attacks. Other attacks that arise from host header injection include web cache poisoning, bypassing authentication, SSRF and virtual host brute-forcing. You may learn more about this [here  (opens new window)](https://portswigger.net/web-security/host-header/exploiting).

## [#](#easy-way-to-confirm) Easy Way To Confirm

To confirm that this is an issue, you can use `curl` to fire the following two requests to your application:

```
curl https://myapp.com -H "Host: evil.com"
curl https://myapp.com -H "X-Forwarded-Host: evil.com"

```

If you see `evil.com` in any of the response headers (e.g. Location header) or in any of the response body URLs, then you're vulnerable.

## [#](#how-to-fix-host-header-injection) How To Fix Host Header Injection

To fix `Host` header injection attacks, you must have a secure web server configuration.

Make sure to configure a catch-all server block (Nginx) or VirtualHost (Apache) to catch all requests with unrecognized Host headers, specify non-wildcard server names and turn on the `UseCanonicalName` directive (for Apache).

In case you do not have control over your web server configuration, you may add the `TrustHosts` middleware to your global middleware.

If you use reverse proxy CDNs such as Cloudflare, they should automatically take care of this for you.

## [#](#how-to-fix-x-forwarded-host-header-injection) How To Fix X-Forwarded-Host Header Injection

### [#](#option-1-add-the-trusthosts-middleware) Option 1: Add the TrustHosts Middleware

Simply add the `TrustHosts` middleware to your global middleware as indicated below:

```
/**
 * The application's global HTTP middleware stack.
 *
 * These middleware are run during every request to your application.
 *
 * @var array
 */
protected $middleware = [
    \App\Http\Middleware\TrustHosts::class,
    \App\Http\Middleware\TrustProxies::class,
    \Fruitcake\Cors\HandleCors::class,
    \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
    \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
    \App\Http\Middleware\TrimStrings::class,
    \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
];

```
### [#](#option-2-whitelist-your-trustedproxy-headers) Option 2: Whitelist Your TrustedProxy Headers

By default, the `TrustProxies` middleware whitelists all headers including `X-Forwarded-Host`. You may specifically set the whitelist headers to only `X-Forwarded-For` in your `App\Http\Middleware\TrustProxies` class, so that even if the attacker sets the `X-Forwarded-Host` header, it will not be trusted by your application:

```
/**
 * The headers that should be used to detect proxies.
 *
 * @var int
 */
protected $headers = Request::HEADER_X_FORWARDED_FOR;

```
### [#](#option-3-explicitly-set-all-x-forwarded-headers-at-your-reverse-proxy) Option 3: Explicitly Set All X-Forwarded Headers At Your Reverse Proxy

You may also explicitly set all `X-Forwarded-*` headers at your reverse proxy so that they override any headers set by a possible attacker. To do this in Nginx, you can add the following directives:

```
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-Host $host;
proxy_set_header X-Forwarded-Port $server_port;

```
### [#](#option-4-replace-ip-address-at-your-application-web-server-s) Option 4: Replace IP Address At Your Application Web Server(s)

If you are using Nginx, you may replace the remote IP address directly from the X-Forwarded-For header, without the need to setup trusted proxies in Laravel:

```
real_ip_header X-Forwarded-For;

```

Make sure you set this at your application web server(s) and not at your load balancer/reverse proxy. This directive replaces the remote IP address with the `X-Forwarded-For` IP address that the web server receives from the load balancer/reverse proxy.

You may also add a `set_real_ip_from` directive so that it only trusts valid load balancers/reverse proxies:

```
set_real_ip_from 172.0.0.0/8;

```

The IP address CIDR added above should be replaced with that of your load balancers or reverse proxies (assuming they are in the same VPN). This may not be required if you have a firewall rule setup to only allow incoming traffic to your web server(s) from your load balancer/reverse proxy VPN.

After you add the directives above, remove both the `TrustProxies` and `TrustHosts` middleware.

WARNING

This analyzer currently only passes with Option 1 and 4. So, if you are solving the issue with Option 2 or 3, you may ignore this analyzer.

## [#](#skip-condition) Skip Condition

This analyzer is skipped if your application does not use trusted proxies.

## [#](#references) References

* [Host Injection Demo on A Laravel App  (opens new window)](https://www.youtube.com/watch?v=KGTTlzZiihw)
* [Laravel Documentation on Trusted Proxies  (opens new window)](https://laravel.com/docs/requests#configuring-trusted-proxies)
* [Discussion on Host Injection on the Laravel Repo  (opens new window)](https://github.com/laravel/laravel/pull/5477)
* [Introduction to Host Header Injection Attacks  (opens new window)](https://portswigger.net/web-security/host-header/exploiting)
* [Nginx Documentation on the Real IP Module  (opens new window)](http://nginx.org/en/docs/http/ngx_http_realip_module.html)
* [Nginx Documentation on the Proxy Module  (opens new window)](http://nginx.org/en/docs/http/ngx_http_proxy_module.html)

‚Üê
[Horizon Security Analyzer](/docs/security/horizon-security-analyzer.html) [HSTS Header Analyzer](/docs/security/hsts-header-analyzer.html)
‚Üí


