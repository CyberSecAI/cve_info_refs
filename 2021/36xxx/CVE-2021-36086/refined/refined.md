```
id: OSV-2021-536
summary: Heap-use-after-free in cil_reset_classpermission
details: |
  OSS-Fuzz report: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32177
   ```
   Crash type: Heap-use-after-free READ 8
   Crash state: cil_reset_classpermission cil_reset_classperms_set cil_reset_classperms_list
   ```
modified: '2022-04-13T03:04:42.350659Z'
published: '2021-03-19T00:01:12.719776Z'
references:
- type: REPORT
  url: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=32177
affected:
- package:
    name: selinux
    ecosystem: OSS-Fuzz
  ranges:
  - type: GIT
    repo: https://github.com/SELinuxProject/selinux
    events:
    - introduced: 0451adebdf153eee1f69914141311114a0130982
    - fixed: c49a8ea09501ad66e799ea41b8154b6770fec2c8
  versions:
  - '3.2'
  - 3.2-rc3
  - checkpolicy-3.2
  - checkpolicy-3.2-rc3
  - libselinux-3.2
  - libselinux-3.2-rc3
  - libsemanage-3.2
  - libsemanage-3.2-rc3
  - libsepol-3.2
  - libsepol-3.2-rc3
  - mcstrans-3.2
  - mcstrans-3.2-rc3
  - policycoreutils-3.2
  - policycoreutils-3.2-rc3
  - restorecond-3.2
  - restorecond-3.2-rc3
  - secilc-3.2
  - secilc-3.2-rc3
  - selinux-dbus-3.2
  - selinux-dbus-3.2-rc3
  - selinux-gui-3.2
  - selinux-gui-3.2-rc3
  - selinux-python-3.2
  - selinux-python-3.2-rc3
  - selinux-sandbox-3.2
  - selinux-sandbox-3.2-rc3
  - semodule-utils-3.2
  - semodule-utils-3.2-rc3
ecosystem_specific:
  severity: HIGH
```

```
libsepol/cil: cil_reset_classperms_set() should not reset classpermisâ€¦

In struct cil_classperms_set, the set field is a pointer to a
struct cil_classpermission which is looked up in the symbol table.
Since the cil_classperms_set does not create the cil_classpermission,
it should not reset it.

Set the set field to NULL instead of resetting the classpermission
that it points to.
```

- **Root cause of vulnerability:** A heap-use-after-free vulnerability exists in the `cil_reset_classpermission` function within SELinux's libsepol library. The `cil_reset_classperms_set` function incorrectly resets a `cil_classpermission` structure that it does not own. The set field of `cil_classperms_set` points to a `cil_classpermission` looked up in the symbol table. Because the `cil_classperms_set` does not create it, it should not reset it.
- **Weaknesses/vulnerabilities present:**  Heap-use-after-free. The `cil_reset_classperms_set` function was freeing memory that was not allocated by it, leading to a use-after-free condition when the freed memory was accessed later.
- **Impact of exploitation:** A heap-use-after-free can lead to a crash, and potentially to arbitrary code execution if an attacker can control the freed memory.
- **Attack vectors:** The vulnerability is triggered during the processing of a crafted SELinux policy. The specific steps to trigger this issue are detailed in the OSS-Fuzz report.
- **Required attacker capabilities/position:** An attacker would need to be able to supply a crafted SELinux policy to the system.