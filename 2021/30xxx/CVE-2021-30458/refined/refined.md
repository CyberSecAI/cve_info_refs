Based on the provided information, here's an analysis of CVE-2021-30458:

**Root Cause of Vulnerability:**

The vulnerability stems from how Parsoid handles HTML comments during tree building. Parsoid converts certain nodes into HTML comments with JSON-encoded values to prevent them from being "fostered" (moved in the DOM tree by the browser). However, if a user-supplied comment happens to contain valid JSON with a specific property (`@type`: "mw:...") used internally by Parsoid, it could be misinterpreted as a fostered node.

**Weaknesses/Vulnerabilities Present:**

*   **Insecure Comment Processing:** Parsoid did not properly sanitize or distinguish between its internal JSON-encoded comments and user-supplied comments, allowing for potential conflicts. Specifically, the code used the `@type` key in a way that could be spoofed with user-provided input.
*   **Meta Tag Injection:** An attacker could craft a malicious HTML comment that Parsoid would incorrectly interpret. This allowed injection of arbitrary `<meta>` tags into the generated HTML, which could potentially lead to XSS or other exploits.
*   **Bypass of Sanitization:** The injected tags were created after initial sanitization, bypassing those security mechanisms.

**Impact of Exploitation:**

*   **Meta Tag Injection:** The immediate impact was the ability to inject mostly arbitrary `<meta>` tags into the body of the HTML output. While not initially demonstrated as full XSS, this opens the possibility of further exploitation if a way to use these tags for malicious purposes could be found.
*   **Potential XSS:**  Although the initial exploit was not a straightforward XSS, it created a pathway for further exploitation that could potentially lead to XSS by carefully crafting injected meta tags.  The injected `<meta>` tags could, in theory, manipulate the behavior of a web browser.

**Attack Vectors:**

*   **Malicious HTML Comments:** An attacker would need to insert a specially crafted HTML comment containing JSON with a spoofed `@type` property within wikitext. This could be done via any standard method of modifying wiki content (e.g., editing a page or creating new content).
*   **REST API:** The vulnerability was demonstrated using the MediaWiki REST API, using a crafted POST request with the malicious comment in the `wikitext` parameter.

**Required Attacker Capabilities/Position:**

*   **Content Editing Permissions:** The attacker needs to have the ability to edit wikitext content on a MediaWiki instance, either through direct editing or creating new pages. This suggests that any user with appropriate permissions could potentially exploit this vulnerability.
*   **Knowledge of Parsoid's Internal JSON Structure:**  The attacker needs to know the structure of Parsoid's JSON used for fostered content in comments, specifically the "@type" property.

**Additional Details from the Phabricator Task:**

*   **Mitigation:**  The vulnerability was mitigated by changing the key used by Parsoid's internal comments from `@type` to `-type`, and encoding the comment using `WTUtils::encodeComment` to ensure that a user-provided comment could not collide with the internal key even if it was formatted to be similar to the internal one, because the hyphen character is encoded during the processing of user comments. This prevents user-controlled comments from being misinterpreted.
*   **Patching:** Patches were created for both Parsoid/PHP and Parsoid/JS, and deployed to the Wikimedia cluster.
*   **Security Release:**  The fix was included in security releases of MediaWiki (1.35.2) and Parsoid (0.12.2 and 0.11.1), ensuring widespread availability of the fix.
*   **Deployment:** The deployment of the fix was carried out rapidly using the standard procedure and tested on the `mwdebugs` servers before being deployed to the rest of the cluster.

**Summary of Changes:**

The vulnerability was fixed by:
1. Changing the key in Parsoid's internal JSON used in comments from `@type` to `-type` .
2. Ensuring that HTML comments are encoded using `WTUtils::encodeComment`, which ensures that the user-provided keys won't match internal ones.

The fix prevents user-supplied comments from being mistaken as Parsoid internal comments.

The Gentoo security advisory confirms that this vulnerability was addressed in MediaWiki 1.36.1 and later.