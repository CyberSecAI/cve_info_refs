=== Content from www.mediawiki.org_ef129e18_20250114_221120.html ===
[Jump to content](#bodyContent)

Main menu

Main menu
move to sidebar
hide

Navigation

* [Main page](/wiki/MediaWiki "Visit the main page [z]")
* [Get MediaWiki](/wiki/Download)
* [Get extensions](/wiki/Special%3AMyLanguage/Category%3AExtensions)
* [Tech blog](https://techblog.wikimedia.org/)
* [Contribute](/wiki/Special%3AMyLanguage/How_to_contribute)

Support

* [User help](/wiki/Special%3AMyLanguage/Help%3AContents "The place to find out")
* [FAQ](/wiki/Special%3AMyLanguage/Manual%3AFAQ)
* [Technical manual](/wiki/Special%3AMyLanguage/Manual%3AContents)
* [Support desk](/wiki/Project%3ASupport_desk)
* [Communication](/wiki/Special%3AMyLanguage/Communication)

Development

* [Developer portal](https://developer.wikimedia.org/)
* [Code statistics](/wiki/Development_statistics)

mediawiki.org

* [Community portal](/wiki/Project%3AHelp "About the project, what you can do, where to find things")
* [Recent changes](/wiki/Special%3ARecentChanges "A list of recent changes in the wiki [r]")
* [Translate content](/wiki/Special%3ALanguageStats)
* [Random page](/wiki/Special%3ARandom "Load a random page [x]")
* [Village pump](/wiki/Project%3AVillage_Pump)
* [Sandbox](/wiki/Project%3ASandbox)

In other languages

[Add links](https://www.wikidata.org/wiki/Special%3AEntityPage/Q21198544#sitelinks-wikipedia "Add interlanguage links")

[![](/static/images/icons/mediawikiwiki.svg)
![MediaWiki](/static/images/mobile/copyright/mediawikiwiki-wordmark.svg)](/wiki/MediaWiki)

[Search](/wiki/Special%3ASearch "Search MediaWiki [f]")

Search

* English

Appearance

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Parsoid "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Parsoid "You are encouraged to log in; however, it is not mandatory [o]")

Personal tools

* [Donate](https://donate.wikimedia.org/?wmf_source=donate&wmf_medium=sidebar&wmf_campaign=www.mediawiki.org&uselang=en)
* [Create account](/w/index.php?title=Special:CreateAccount&returnto=Parsoid "You are encouraged to create an account and log in; however, it is not mandatory")
* [Log in](/w/index.php?title=Special:UserLogin&returnto=Parsoid "You are encouraged to log in; however, it is not mandatory [o]")

Pages for logged out editors [learn more](/wiki/Help%3AIntroduction)

* [Contributions](/wiki/Special%3AMyContributions "A list of edits made from this IP address [y]")
* [Talk](/wiki/Special%3AMyTalk "Discussion about edits from this IP address [n]")

## Contents

move to sidebar
hide

* Beginning
* [1
  Technical details](#Technical_details)
* [2
  Usage](#Usage)
* [3
  Installation](#Installation)
* [4
  Development](#Development)

  Toggle Development subsection
  + [4.1
    Linking a developer checkout of Parsoid](#Linking_a_developer_checkout_of_Parsoid)
  + [4.2
    Running the tests](#Running_the_tests)
  + [4.3
    Converting simple wikitext](#Converting_simple_wikitext)
  + [4.4
    Debugging Parsoid (for developers)](#Debugging_Parsoid_(for_developers))
* [5
  Continuous Integration](#Continuous_Integration)
* [6
  Release build](#Release_build)
* [7
  Technical documents](#Technical_documents)

  Toggle Technical documents subsection
  + [7.1
    Links for Parsoid developers](#Links_for_Parsoid_developers)
  + [7.2
    Links for Parsoid deployers (to the Wikimedia cluster)](#Links_for_Parsoid_deployers_(to_the_Wikimedia_cluster))
* [8
  History](#History)
* [9
  See also](#See_also)
* [10
  External links](#External_links)
* [11
  Contact](#Contact)

Toggle the table of contents

# Parsoid

[Issue tracker](/wiki/Special%3AMyLanguage/Phabricator "Special:MyLanguage/Phabricator"): [**#parsoid**](https://phabricator.wikimedia.org/tag/parsoid/ "phab:tag/parsoid/")

* [Page](/wiki/Parsoid "View the content page [c]")
* [Discussion](/wiki/Talk%3AParsoid "Discussion about the content page [t]")

English

* [Read](/wiki/Parsoid)
* [Edit](/w/index.php?title=Parsoid&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Parsoid&action=history "Past revisions of this page [h]")

Tools

Tools
move to sidebar
hide

Actions

* [Read](/wiki/Parsoid)
* [Edit](/w/index.php?title=Parsoid&action=edit "Edit the source code of this page [e]")
* [View history](/w/index.php?title=Parsoid&action=history)

General

* [What links here](/wiki/Special%3AWhatLinksHere/Parsoid "A list of all wiki pages that link here [j]")
* [Related changes](/wiki/Special%3ARecentChangesLinked/Parsoid "Recent changes in pages linked from this page [k]")
* [Upload file](//commons.wikimedia.org/wiki/Special%3AUploadWizard "Upload files [u]")
* [Special pages](/wiki/Special%3ASpecialPages "A list of all special pages [q]")
* [Permanent link](/w/index.php?title=Parsoid&oldid=6958476 "Permanent link to this revision of this page")
* [Page information](/w/index.php?title=Parsoid&action=info "More information about this page")
* [Cite this page](/w/index.php?title=Special:CiteThisPage&page=Parsoid&id=6958476&wpFormIdentifier=titleform "Information on how to cite this page")
* [Get shortened URL](/w/index.php?title=Special:UrlShortener&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FParsoid)
* [Download QR code](/w/index.php?title=Special:QrCode&url=https%3A%2F%2Fwww.mediawiki.org%2Fwiki%2FParsoid)

Print/export

* [Create a book](/w/index.php?title=Special:Book&bookcmd=book_creator&referer=Parsoid)
* [Download as PDF](/w/index.php?title=Special:DownloadAsPdf&page=Parsoid&action=show-download-screen)
* [Printable version](/w/index.php?title=Parsoid&printable=yes "Printable version of this page [p]")

In other projects

* [Wikidata item](https://www.wikidata.org/wiki/Special%3AEntityPage/Q21198544 "Link to connected data repository item [g]")

Appearance
move to sidebar
hide

From mediawiki.org

[Translate this page](/w/index.php?title=Special:Translate&group=page-Parsoid&action=page&filter=&action_source=translate_page "Special:Translate")Languages:

* [Bahasa Indonesia](/wiki/Parsoid/id "Parsoid (7% translated)")
* [Deutsch](/wiki/Parsoid/de "Parsoid (29% translated)")
* English
* [Tiếng Việt](/wiki/Parsoid/vi "Parsoid (7% translated)")
* [Türkçe](/wiki/Parsoid/tr "Parsoid (2% translated)")
* [español](/wiki/Parsoid/es "Parsoid (28% translated)")
* [français](/wiki/Parsoid/fr "Parsoid (99% translated)")
* [italiano](/wiki/Parsoid/it "Parsoid/it (25% translated)")
* [magyar](/wiki/Parsoid/hu "Parsoid (9% translated)")
* [polski](/wiki/Parsoid/pl "Parsoid/pl (4% translated)")
* [português do Brasil](/wiki/Parsoid/pt-br "Parsoid (7% translated)")
* [čeština](/wiki/Parsoid/cs "Parsoid (14% translated)")
* [русский](/wiki/Parsoid/ru "Parsoid (10% translated)")
* [العربية](/wiki/Parsoid/ar "بارسويد (25% translated)")
* [中文](/wiki/Parsoid/zh "Parsoid (78% translated)")
* [日本語](/wiki/Parsoid/ja "Parsoid/ja (40% translated)")
* [閩南語 / Bân-lâm-gú](/wiki/Parsoid/nan "Parsoid (11% translated)")

| [Wikimedia Foundation projects](/wiki/Special%3AMyLanguage/Category%3AWMF_Projects "Special:MyLanguage/Category:WMF Projects") Parsoid     A bidirectional runtime wikitext parser. Converts back and forth between wikitext and HTML/XML DOM with RDFa.  | Group: | [Content Transform Team](/wiki/Content_Transform_Team "Content Transform Team") | | --- | --- | | Start: | 2011-10 | | Team members: | [Arlo Breault](/wiki/User%3AArlolra "User:Arlolra"), [C.Scott Ananian](/wiki/User%3ACscott "User:Cscott"), [Isabelle Hurbain-Palatin](/wiki/User%3AIHurbainPalatin_%28WMF%29 "User:IHurbainPalatin (WMF)"), [Mateus Santos](/wiki/User%3AMSantos_%28WMF%29 "User:MSantos (WMF)"), [Yiannis Giannelos](/wiki/User%3AJGiannelos_%28WMF%29 "User:JGiannelos (WMF)") | | Backlog: | [#parsoid](https://phabricator.wikimedia.org/tag/parsoid/ "phab:tag/parsoid/") | | Lead: | [Subramanya Sastry](/wiki/User%3ASSastry_%28WMF%29 "User:SSastry (WMF)") | | Management: | Sérgio Lopes | | Updates: | [mw:Parsoid/Releases](/wiki/Parsoid/Releases "Parsoid/Releases") | | Progress: | [mw:Parsoid/Deployments](/wiki/Parsoid/Deployments "Parsoid/Deployments") | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

[![](//upload.wikimedia.org/wikipedia/commons/thumb/2/2e/Parsoid_HTML-RDFa_content_model.svg/512px-Parsoid_HTML-RDFa_content_model.svg.png)](/wiki/File%3AParsoid_HTML-RDFa_content_model.svg)

Artist's impression of the Parsoid HTML5 + RDFa wiki runtime

*For the older version of Parsoid written in JavaScript (Node.js), see [Parsoid/JS](/wiki/Parsoid/JS "Parsoid/JS").*

**Parsoid** is a PHP library bundled with MediaWiki (1.35+) that is used for converting back and forth between [wikitext](/wiki/Special%3AMyLanguage/Wikitext "Special:MyLanguage/Wikitext") and HTML.
Eventually, the goal is to [fully replace](/wiki/Parsoid/Parser_Unification "Parsoid/Parser Unification") MediaWiki’s current native [Parser](/wiki/Manual%3AParser "Manual:Parser"). The legacy parser will still be supported in MediaWiki 1.43 (LTS).

## Technical details

[[edit](/w/index.php?title=Parsoid&action=edit&section=1 "Edit section: Technical details")]

Parsoid is an application which can translate back and forth between MediaWiki's [wikitext](/wiki/Special%3AMyLanguage/Wikitext "Special:MyLanguage/Wikitext") syntax and an equivalent HTML/RDFa document model with enhanced support for automated processing and rich editing.

It has been under development by a team at the Wikimedia Foundation since 2012.
It is currently used extensively by [VisualEditor](/wiki/Special%3AMyLanguage/VisualEditor "Special:MyLanguage/VisualEditor"), [Structured discussions](/wiki/Special%3AMyLanguage/Structured_discussions "Special:MyLanguage/Structured discussions"), [Content translation](/wiki/Special%3AMyLanguage/Content_translation "Special:MyLanguage/Content translation") and [other applications](/wiki/Special%3AMyLanguage/Parsoid/Users "Special:MyLanguage/Parsoid/Users").

Parsoid is intended to provide flawless back-and-forth conversion, i.e. to avoid information loss and also prevent "dirty diffs".

On Wikimedia wikis, for several applications, Parsoid is currently proxied behind [RESTBase](/wiki/Special%3AMyLanguage/RESTBase "Special:MyLanguage/RESTBase"), which stores the HTML translated by Parsoid.
It is expected that RESTBase [will eventually be replaced](https://phabricator.wikimedia.org/T250500 "phab:T250500") with a cache more tightly integrated with MediaWiki.

For more on the overall project, see [this blog post](https://blog.wikimedia.org/2013/03/04/parsoid-how-wikipedia-catches-up-with-the-web/) from March 2013.
To read about the HTML model being used, see [MediaWiki DOM spec](/wiki/Special%3AMyLanguage/Parsoid/MediaWiki_DOM_spec "Special:MyLanguage/Parsoid/MediaWiki DOM spec").

Parsoid was originally structured as a web service and written in JavaScript, making use of `Node.js`.
A [tech talk from February 2019](https://www.youtube.com/watch?v=lQGfuLP9MqA) ([slides](/wiki/File%3AThe_Long_And_Winding_Road_To_Making_Parsoid_The_Default_MediaWiki_Parser.pdf "File:The Long And Winding Road To Making Parsoid The Default MediaWiki Parser.pdf")) and [blog post](https://phabricator.wikimedia.org/phame/post/view/189/parsoid_in_php_or_there_and_back_again/ "phab:phame/post/view/189/parsoid in php or there and back again/") describes the process of [porting it to PHP](/wiki/Special%3AMyLanguage/Parsoid/PHP "Special:MyLanguage/Parsoid/PHP").
The Parsoid extension API is currently under active development; a [tech talk from August 2020](/wiki/Wikimedia_Technical_Talks#Episode_6:_Retargeting_extensions_to_work_with_Parsoid "Wikimedia Technical Talks") describes this work.

**GitHub Repository:** <https://github.com/wikimedia/parsoid>

## Usage

[[edit](/w/index.php?title=Parsoid&action=edit&section=2 "Edit section: Usage")]

* [Parsoid/Releases](/wiki/Special%3AMyLanguage/Parsoid/Releases "Special:MyLanguage/Parsoid/Releases") - List of releases made for Parsoid
* [Parsoid/API](/wiki/Special%3AMyLanguage/Parsoid/API "Special:MyLanguage/Parsoid/API") - for the web API
* [MediaWiki DOM spec](/wiki/Special%3AMyLanguage/Specs/HTML "Special:MyLanguage/Specs/HTML") - to make sense of the HTML that you get from the API, designed to be useful as a future storage format
* [Parsoid/LanguageConverter](/wiki/Special%3AMyLanguage/Parsoid/LanguageConverter "Special:MyLanguage/Parsoid/LanguageConverter") - notes on Parsoid's implementation of [LanguageConverter](/wiki/Special%3AMyLanguage/LanguageConverter "Special:MyLanguage/LanguageConverter")
* [Parsoid/Known differences with Core Parser output](/wiki/Special%3AMyLanguage/Parsoid/Known_differences_with_Core_Parser_output "Special:MyLanguage/Parsoid/Known differences with Core Parser output")

## Installation

[[edit](/w/index.php?title=Parsoid&action=edit&section=3 "Edit section: Installation")]

In **MediaWiki 1.35** *Parsoid/PHP* is included in the bundle and loaded automatically by Visual Editor.
No configuration necessary for MediaWiki 1.35 and later.

Parsoid exports an internal REST API which was historically used by RESTBase and not accessible outside the WMF internal cluster.
This is no longer required for Visual Editor or core read views, and the internal API is being deprecated and is planned for removal in MW 1.43.

Parsoid is nominally a composer library used by mediawiki core.
If you still require the internal API for some reason, you can explicitly load Parsoid "as an extension" by adding the following to LocalSettings.php:

```
wfLoadExtension( 'Parsoid', "$IP/vendor/wikimedia/parsoid/extension.json" );

```

Any remaining third-party users of the internal Parsoid API are strongly encouraged to migrate to the core REST HTML page endpoint which provides equivalent functionality.

## Development

[[edit](/w/index.php?title=Parsoid&action=edit&section=4 "Edit section: Development")]

Development happens in the [Parsoid Git repository](https://gerrit.wikimedia.org/g/mediawiki/services/parsoid "git:mediawiki/services/parsoid").
Code review happens in [Gerrit](https://gerrit.wikimedia.org/r/q/project%3Amediawiki/services/parsoid "gerrit:q/project:mediawiki/services/parsoid").
See [Gerrit/Getting started](/wiki/Special%3AMyLanguage/Gerrit/Getting_started "Special:MyLanguage/Gerrit/Getting started") to set up an account for yourself.

If you use the [MediaWiki-Vagrant](/wiki/Special%3AMyLanguage/MediaWiki-Vagrant "Special:MyLanguage/MediaWiki-Vagrant") development environment using a virtual machine, you can simply add the role `visualeditor` to it and it will set up a working Parsoid along with [Extension:VisualEditor](/wiki/Special%3AMyLanguage/Extension%3AVisualEditor "Special:MyLanguage/Extension:VisualEditor").
(This may have been broken by the switch to Parsoid/PHP: [T258940](https://phabricator.wikimedia.org/T258940 "phab:T258940"))

Note that the most-recently released version of Parsoid is written in PHP, and installation of [Parsoid/PHP](/wiki/Parsoid/PHP "Parsoid/PHP") is what is described below.
This is what you should use if you are running MediaWiki 1.35 or later.
Check [Parsoid/JS](/wiki/Parsoid/JS "Parsoid/JS") if you are running the old version of Parsoid written in JavaScript, and used for MW 1.34 and earlier.

### Linking a developer checkout of Parsoid

[[edit](/w/index.php?title=Parsoid&action=edit&section=5 "Edit section: Linking a developer checkout of Parsoid")]

In a standard MediaWiki installation, Parsoid is included from MediaWiki as a composer library, `wikimedia/parsoid`.

For development purposes you usually want to use a git checkout of Parsoid, and not the version bundled in MediaWiki core as a composer library.
The following lines added to [LocalSettings.php](/wiki/Special%3AMyLanguage/Manual%3ALocalSettings.php "Special:MyLanguage/Manual:LocalSettings.php") allow use of a git checkout of Parsoid (optionally), load the Parsoid REST API with [wfLoadExtension](/wiki/Special%3AMyLanguage/Manual%3AExtension_registration "Special:MyLanguage/Manual:Extension registration") (rather than using the version bundled in VisualEditor) and manually do the Parsoid configuration which is usually done by VisualEditor:

```
$parsoidInstallDir = 'vendor/wikimedia/parsoid'; # bundled copy
#$parsoidInstallDir = '/my/path/to/git/checkout/of/Parsoid';

// For developers: ensure Parsoid is executed from $parsoidInstallDir,
// (not the version included in mediawiki-core by default)
// Must occur *before* wfLoadExtension()
if ( $parsoidInstallDir !== 'vendor/wikimedia/parsoid' ) {
    function wfInterceptParsoidLoading( $className ) {
        // Only intercept Parsoid namespace classes
        if ( preg_match( '/(MW|Wikimedia\\\\)Parsoid\\\\/', $className ) ) {
           $fileName = Autoloader::find( $className );
           if ( $fileName !== null ) {
               require $fileName;
           }
        }
    }
    spl_autoload_register( 'wfInterceptParsoidLoading', true, true );
    // AutoLoader::registerNamespaces was added in MW 1.39
    AutoLoader::registerNamespaces( [
        // Keep this in sync with the "autoload" clause in
        // $parsoidInstallDir/composer.json
        'Wikimedia\\Parsoid\\' => "$parsoidInstallDir/src",
    ] );
}

wfLoadExtension( 'Parsoid', "$parsoidInstallDir/extension.json" );

# Manually configure Parsoid
$wgVisualEditorParsoidAutoConfig = false;
$wgParsoidSettings = [
    'useSelser' => true,
    'rtTestMode' => false,
    'linting' => false,
];
$wgVirtualRestConfig['modules']['parsoid'] = [
    // URL to the Parsoid instance.
    // If Parsoid is not running locally, you should change $wgServer to match the non-local host
    // While using Docker in macOS, you may need to replace $wgServer with http://host.docker.internal:8080
    // While using Docker in linux, you may need to replace $wgServer with http://172.17.0.1:8080
    'url' => $wgServer . $wgScriptPath . '/rest.php',
    // Parsoid "domain", see below (optional, rarely needed)
    // 'domain' => 'localhost',
];
unset( $parsoidInstallDir );

```

These lines are not necessary for most users of VisualEditor, who can use auto-configuration and the bundled Parsoid code included in MediaWiki 1.35 and VisualEditor, but they will be required for most developers.

If you're serving MediaWiki with Nginx, you'll need to also add something like this in your server block (Assuming your MediaWiki setup has its files residing in `/w/`):

```
location /w/rest.php/ {
    try_files $uri $uri/ /w/rest.php?$query_string;
}

```

To test proper configuration, visit `{$wgScriptPath}/rest.php/{$domain}/v3/page/html/Main%20Page` where `$domain` is the hostname in your `$wgCanonicalServer`.
(Note that production WMF servers do not expose the Parsoid REST API to the external network.)

### Running the tests

[[edit](/w/index.php?title=Parsoid&action=edit&section=6 "Edit section: Running the tests")]

To run all parser tests and mocha tests:

```
$ composer test

```

The parser tests have quite a few options now which can be listed using `php bin/parserTests.php --help`.

If you have the environment variable `MW_INSTALL_DIR` pointing to a configured MediaWiki installation, you can run some additional tests with:

```
$ composer phan-integrated

```

### Converting simple wikitext

[[edit](/w/index.php?title=Parsoid&action=edit&section=7 "Edit section: Converting simple wikitext")]

You can convert simple wikitext snippets from the command line using the `parse.php` script in the `bin/` directory:

```
echo '[Foo](/w/index.php?title=Foo&action=edit&redlink=1 "Foo (page does not exist)")' | php bin/parse.php

```

The parse script has a lot of options.
`php bin/parse.php --help` gives you information about this.

### Debugging Parsoid (for developers)

[[edit](/w/index.php?title=Parsoid&action=edit&section=8 "Edit section: Debugging Parsoid (for developers)")]

See [Parsoid/Debugging](/wiki/Special%3AMyLanguage/Parsoid/Debugging "Special:MyLanguage/Parsoid/Debugging") for debugging tips.

## Continuous Integration

[[edit](/w/index.php?title=Parsoid&action=edit&section=9 "Edit section: Continuous Integration")]

*As of October 2021*

Parsoid is always available as a library since it is a composer dependency of MediaWiki core. But two pieces are not enabled:

* Parsoid ServiceWiring
* Parsoid's external REST api

The test runner [Quibble](/wiki/Quibble "Quibble") would enable it if it detects `mediawiki/services/parsoid.git` has been cloned as part of the build.
In which case it:

* points the autoloader for `Wikimedia\Parsoid` to the cloned code (effectively replacing the version installed by composer)
* Load the extension `wfLoadExtension( 'Parsoid', '/path/to/cloned/repo' );`

The ServiceWiring should be enabled in MediaWiki starting with 1.38.

The REST API would theorically never get merged in MediaWiki: a) it has never been exposed to the public in production, it is an internal API used by RESTBase which is going away; b) it never has been security audited and c) it is redundant with the enterprise MediaWiki API.
The solution will be for VisualEditor to invoke Parsoid directly via the VisualEditor Action API which would save a round trip through the REST API.

Loading the extension is thus a hack which enables using interfaces subject to change and which we don't really want people to use yet.

For most purposes, parsoid should thus not be added as a CI dependency, the only exception as of October 2021 is the Disambiguator MediaWiki extension.

Loading parsoid as an extension let us run MediaWiki integration test jobs against `mediawiki/services/parsoid.git` (such as Quibble, apitesting) and ensure Parsoid and MediaWiki work together.

An extension may be able to write tests with Parsoid even when the repository has not been cloned.
Since it is a composer dependency of MediaWiki core the `MediaWiki\Parsoid` namespace is available, but the service wiring part is not (it is `extension/src` in the Parsoid repository and exposed as the `\MWParsoid` namespace).
The `ParsoidTestFileSuite.php` code would only run the parser tests if Parsoid has been loaded (which should be the default with MediaWiki 1.38).

For CI, Parsoid is tested against the tip of mediawiki, whereas mediawiki is tested with the composer dependency.
In case of a breaking change, the Parsoid change get merged first (which breaks its CI but not MediaWiki one) and MediaWiki get adjusted when Parsoid is updated.
It is thus a one way change.

## Release build

[[edit](/w/index.php?title=Parsoid&action=edit&section=10 "Edit section: Release build")]

For MediaWiki release builds, we have an integration of Parsoid ServiceWiring into VisualEditor in order to have VisualEditor work without further configuration (beside a `wfLoadExtension( 'VisualEditor' )`).
The release build also enables the REST API and hook everything us so that parsoid works out of the box.
This is done by copying a bit of parsoid code into VisualEditor which is not in the master branch of VisualEditor since that would be obsolete as soon as Parsoid is updated.
Instead the code is maintained in two places.

## Technical documents

[[edit](/w/index.php?title=Parsoid&action=edit&section=11 "Edit section: Technical documents")]

* [Parsoid/Internals](/wiki/Parsoid/Internals "Parsoid/Internals"): documentation about Parsoid internals with links to other details.
* [PHP Porting notes](/wiki/Special%3AMyLanguage/Parsing/Notes/Moving_Parsoid_Into_Core/Porting "Special:MyLanguage/Parsing/Notes/Moving Parsoid Into Core/Porting") and [help-wanted tasks](/wiki/Special%3AMyLanguage/Parsoid/PHP/Help_wanted "Special:MyLanguage/Parsoid/PHP/Help wanted")
* [Parsoid deployment agenda on Wikimedia cluster](/wiki/Parsoid/Deployments "Parsoid/Deployments") (code normally deployed every Monday and Wednesday between 1pm - 1:30pm PST)
* [Parsoid/Round-trip testing](/wiki/Parsoid/Round-trip_testing "Parsoid/Round-trip testing"): The round-trip testing setup we are using to test the wikitext -> HTML DOM -> wikitext round-trip on actual Wikipedia content.
* [Parsoid/Visual Diffs Testing](/wiki/Parsoid/Visual_Diffs_Testing "Parsoid/Visual Diffs Testing"): Info about visual diff testing for comparing Parsoid's html rendering with php parser's html rendering + a testreduce setup for doing mass visual diff tests.
* [Parsoid/limitations](/wiki/Parsoid/limitations "Parsoid/limitations"): Limitations in Parsoid, mainly contrived templating (ab)uses that don't matter in practice. Could be extended to be similar to [the preprocessor upgrade notes](https://meta.wikimedia.org/wiki/Special%3AMyLanguage/MNPP "meta:Special:MyLanguage/MNPP") (**Might need updating**)
* [Parsoid/Bibliography](/wiki/Parsoid/Bibliography "Parsoid/Bibliography"): Bibliography of related literature

### Links for Parsoid developers

[[edit](/w/index.php?title=Parsoid&action=edit&section=12 "Edit section: Links for Parsoid developers")]

* See [Parsoid/Debugging](/wiki/Parsoid/Debugging "Parsoid/Debugging") for debugging tips.
* [Upgrading or adding packages](/wiki/Parsoid/Upgrade_packages "Parsoid/Upgrade packages") to Parsoid
* [See these instructions](https://github.com/wikimedia/parsoid/blob/39ea4e49783b1f88326d6ebddd14e08bb39cb649/tools/sync-parserTests.js#L5-L34) for syncing Parsoid's copy of parser tests to/from core
* Parsoid has a limited [library interface](https://doc.wikimedia.org/Parsoid/master/#!/api/Parsoid) for invoking it programatically.
* [Tech Talk about Retargeting extensions to work with Parsoid](https://www.youtube.com/watch?v=lS1xPkERWCM)
* [So you want your extension to work with Parsoid](/wiki/Parsoid/So_you_want_your_extension_to_work_with_Parsoid "Parsoid/So you want your extension to work with Parsoid")
* [Parsoid HTML Specification Versioning](/wiki/Parsoid/Parsoid_HTML_Specification_Versioning "Parsoid/Parsoid HTML Specification Versioning")
* [So you are going to change Parsoid output](/wiki/Parsoid/So_you_are_going_to_change_Parsoid_output "Parsoid/So you are going to change Parsoid output")

### Links for Parsoid deployers (to the Wikimedia cluster)

[[edit](/w/index.php?title=Parsoid&action=edit&section=13 "Edit section: Links for Parsoid deployers (to the Wikimedia cluster)")]

* [Parsoid/Deployments](/wiki/Parsoid/Deployments "Parsoid/Deployments")
* [RT testing commits](https://parsoid-rt-tests.wikimedia.org/commits) (useful to check regressions and fixes)
* [Deployment instructions for Parsoid](https://wikitech.wikimedia.org/wiki/Parsoid#Deploying_changes "labsconsole:Parsoid")
* [Kibana dashboard](https://logstash.wikimedia.org/app/kibana#/dashboard/parsoid)
* [Grafana dashboard for wt2html metrics](https://grafana.wikimedia.org/d/TCWoeymIk/parsoid-timing-wt2html-entry)
* [Grafana dashboard for html2wt metrics](https://grafana.wikimedia.org/d/jmaNtVMIz/parsoid-timing-html2wt-entry)
* [Prometheus breakdown for the Parsoid cluster on eqiad](https://grafana.wikimedia.org/d/000000607/cluster-overview?orgId=1&from=now-24h&to=now&var-datasource=eqiad%20prometheus%2Fops&var-cluster=parsoid&var-instance=All&var-site=eqiad)
* [Prometheus breakdown for the Parsoid cluster on codfw](https://grafana.wikimedia.org/d/000000607/cluster-overview?orgId=1&from=now-24h&to=now&var-datasource=codfw%20prometheus%2Fops&var-cluster=parsoid&var-instance=All&var-site=codfw)
* [Jenkins Job Builder docs](/wiki/CI/JJB "CI/JJB") for updating jenkins jobs

## History

[[edit](/w/index.php?title=Parsoid&action=edit&section=14 "Edit section: History")]

The original application was written in JavaScript (using Node.js) and started running on the Wikimedia cluster in December 2012.
In 2019, Parsoid was ported to PHP, and the PHP version replaced the JS version on the Wikimedia cluster in December 2019.
Parsoid [is being integrated into core MediaWiki](/wiki/Special%3AMyLanguage/Parsing/Parser_Unification "Special:MyLanguage/Parsing/Parser Unification"), with the goal of eventually replacing MediaWiki's current native parser.
In early 2024, Parsoid began to be used on some production wikis of the Wikimedia Foundation as the default parser for read views.

Parsoid (the PHP version) has been [natively bundled](/wiki/Special%3AMyLanguage/Parsoid/PHP "Special:MyLanguage/Parsoid/PHP") with MediaWiki since version 1.35, released in September 2020.
For non-Wikimedia installations, Parsoid/JS was supported until the end-of-life of MediaWiki 1.31 (LTS) in [September 2021](/wiki/Special%3AMyLanguage/Version_lifecycle "Special:MyLanguage/Version lifecycle").

The legacy parser will still be supported in MediaWiki 1.43 (LTS).

## See also

[[edit](/w/index.php?title=Parsoid&action=edit&section=15 "Edit section: See also")]

* [API](https://en.wikipedia.org/wiki/en%3AAPI "w:en:API")
* [RESTBase](/wiki/Special%3AMyLanguage/RESTBase "Special:MyLanguage/RESTBase"): a caching / storing API proxy for page HTML translated by Parsoid
* Quarterly review meetings of the Parsoid team: [April 2015](https://meta.wikimedia.org/wiki/WMF_Metrics_and_activities_meetings/Quarterly_reviews/Parsoid%2C_Services%2C_MW_Core%2C_Ops%2C_RelEng%2C_MM%2C_Labs_and_ECT%2C_April_2015 "m:WMF Metrics and activities meetings/Quarterly reviews/Parsoid, Services, MW Core, Ops, RelEng, MM, Labs and ECT, April 2015"), [January 2015](https://meta.wikimedia.org/wiki/WMF_Metrics_and_activities_meetings/Quarterly_reviews/Services/January_2015 "m:WMF Metrics and activities meetings/Quarterly reviews/Services/January 2015") ([earlier](https://meta.wikimedia.org/wiki/WMF_Metrics_and_activities_meetings/Quarterly_reviews "m:WMF Metrics and activities meetings/Quarterly reviews"))
* [Parser 2011/Parser plan](/wiki/Parser_2011/Parser_plan "Parser 2011/Parser plan"): Early (now relatively old) design ideas and issues
* [Special:PrefixIndex/Parsoid/](/wiki/Special%3APrefixIndex/Parsoid/ "Special:PrefixIndex/Parsoid/"): Parsoid-related pages on this wiki
* [Extension:ParsoidBatchAPI](/wiki/Extension%3AParsoidBatchAPI "Extension:ParsoidBatchAPI") (archived)
* [parsoid-jsapi](https://github.com/wikimedia/parsoid-jsapi): a high-level interface for extraction and transformation of wikitext, similar to the [mwparserfromhell](https://github.com/earwig/mwparserfromhell) API.
* [Alternative parsers](/wiki/Special%3AMyLanguage/Alternative_parsers "Special:MyLanguage/Alternative parsers")
* [Parsoid/Parser Unification](/wiki/Parsoid/Parser_Unification "Parsoid/Parser Unification")

## External links

[[edit](/w/index.php?title=Parsoid&action=edit&section=16 "Edit section: External links")]

* [Source code](https://gerrit.wikimedia.org/g/mediawiki/services/parsoid/ "git:mediawiki/services/parsoid/") ([GitHub mirror](https://github.com/wikimedia/parsoid/))
* [JS Documentation](https://doc.wikimedia.org/Parsoid/master/) (old version of Parsoid)
* [PHP Documentation](https://doc.wikimedia.org/Parsoid-PHP/master/)
* [*Parsoid* on the Wikimedia Commons](https://commons.wikimedia.org/wiki/Category%3AParsoid "commons:Category:Parsoid")

## Contact

[[edit](/w/index.php?title=Parsoid&action=edit&section=17 "Edit section: Contact")]

If you need help or have questions/feedback, you can contact us in #mediawiki-parsoid [connect](https://web.libera.chat/?channel=#mediawiki-parsoid) or [**the wikitext-l mailing list**](https://lists.wikimedia.org/mailman/listinfo/wikitext-l).
If all that fails, you can also contact us by email at `content-transform-team` at the `wikimedia.org` domain.

|  | Parsoid is maintained by **the [Content Transform Team](/wiki/Content_Transform_Team "Content Transform Team")**. Get help:   * #mediawiki-parsoid [connect](https://web.libera.chat/?channel=#mediawiki-parsoid) ← Live chat ([IRC](/wiki/Special%3AMyLanguage/MediaWiki_on_IRC "Special:MyLanguage/MediaWiki on IRC")) * [wikitext-l](https://lists.wikimedia.org/mailman/listinfo/wikitext-l) ← [Mailing list](/wiki/Special%3AMyLanguage/Mailing_lists "Special:MyLanguage/Mailing lists") * [Talk:Parsoid](/wiki/Talk%3AParsoid "Talk:Parsoid") ← [Talk page](/wiki/Special%3AMyLanguage/Help%3ATalk_pages "Special:MyLanguage/Help:Talk pages") * [parsoid](https://phabricator.wikimedia.org/tag/parsoid "phab:tag/parsoid") ([add task](https://phabricator.wikimedia.org/maniphest/task/edit/form/1/?tags=parsoid)) ← [Phabricator](/wiki/Special%3AMyLanguage/Phabricator "Special:MyLanguage/Phabricator") project page |
| --- | --- |

![](https://login.wikimedia.org/wiki/Special:CentralAutoLogin/start?useformat=desktop&type=1x1&usesul3=0)
Retrieved from "<https://www.mediawiki.org/w/index.php?title=Parsoid&oldid=6958476>"
[Categories](/wiki/Special%3ACategories "Special:Categories"):

* [WMF Projects](/wiki/Category%3AWMF_Projects "Category:WMF Projects")
* [MediaWiki development](/wiki/Category%3AMediaWiki_development "Category:MediaWiki development")
* [Parser](/wiki/Category%3AParser "Category:Parser")
* [Parsoid](/wiki/Category%3AParsoid "Category:Parsoid")
* [Wikitext](/wiki/Category%3AWikitext "Category:Wikitext")
* [Development notes](/wiki/Category%3ADevelopment_notes "Category:Development notes")
* [Used on Wikimedia](/wiki/Category%3AUsed_on_Wikimedia "Category:Used on Wikimedia")
* [VisualEditor](/wiki/Category%3AVisualEditor "Category:VisualEditor")
* [Libraries](/wiki/Category%3ALibraries "Category:Libraries")
Hidden categories:

* [WMF Projects 2011q4](/wiki/Category%3AWMF_Projects_2011q4 "Category:WMF Projects 2011q4")
* [WMF Projects 2012q1](/wiki/Category%3AWMF_Projects_2012q1 "Category:WMF Projects 2012q1")
* [WMF Projects 2012q2](/wiki/Category%3AWMF_Projects_2012q2 "Category:WMF Projects 2012q2")
* [WMF Projects 2012q3](/wiki/Category%3AWMF_Projects_2012q3 "Category:WMF Projects 2012q3")
* [WMF Projects 2012q4](/wiki/Category%3AWMF_Projects_2012q4 "Category:WMF Projects 2012q4")
* [WMF Projects 2013q1](/wiki/Category%3AWMF_Projects_2013q1 "Category:WMF Projects 2013q1")
* [WMF Projects 2013q2](/wiki/Category%3AWMF_Projects_2013q2 "Category:WMF Projects 2013q2")
* [WMF Projects 2013q3](/wiki/Category%3AWMF_Projects_2013q3 "Category:WMF Projects 2013q3")
* [WMF Projects 2013q4](/wiki/Category%3AWMF_Projects_2013q4 "Category:WMF Projects 2013q4")
* [WMF Projects 2014q1](/wiki/Category%3AWMF_Projects_2014q1 "Category:WMF Projects 2014q1")
* [WMF Projects 2014q2](/wiki/Category%3AWMF_Projects_2014q2 "Category:WMF Projects 2014q2")
* [WMF Projects 2014q3](/wiki/Category%3AWMF_Projects_2014q3 "Category:WMF Projects 2014q3")
* [WMF Projects 2014q4](/wiki/Category%3AWMF_Projects_2014q4 "Category:WMF Projects 2014q4")
* [WMF Projects 2015q1](/wiki/Category%3AWMF_Projects_2015q1 "Category:WMF Projects 2015q1")
* [WMF Projects 2015q2](/wiki/Category%3AWMF_Projects_2015q2 "Category:WMF Projects 2015q2")
* [WMF Projects 2015q3](/wiki/Category%3AWMF_Projects_2015q3 "Category:WMF Projects 2015q3")
* [WMF Projects 2015q4](/wiki/Category%3AWMF_Projects_2015q4 "Category:WMF Projects 2015q4")
* [WMF Projects 2016q1](/wiki/Category%3AWMF_Projects_2016q1 "Category:WMF Projects 2016q1")
* [WMF Projects 2016q2](/wiki/Category%3AWMF_Projects_2016q2 "Category:WMF Projects 2016q2")
* [WMF Projects 2016q3](/wiki/Category%3AWMF_Projects_2016q3 "Category:WMF Projects 2016q3")
* [WMF Projects 2016q4](/wiki/Category%3AWMF_Projects_2016q4 "Category:WMF Projects 2016q4")
* [WMF Projects 2017q1](/wiki/Category%3AWMF_Projects_2017q1 "Category:WMF Projects 2017q1")
* [WMF Projects 2017q2](/wiki/Category%3AWMF_Projects_2017q2 "Category:WMF Projects 2017q2")
* [WMF Projects 2017q3](/wiki/Category%3AWMF_Projects_2017q3 "Category:WMF Projects 2017q3")
* [WMF Projects 2017q4](/wiki/Category%3AWMF_Projects_2017q4 "Category:WMF Projects 2017q4")
* [WMF Projects 2018q1](/wiki/Category%3AWMF_Projects_2018q1 "Category:WMF Projects 2018q1")
* [WMF Projects 2018q2](/wiki/Category%3AWMF_Projects_2018q2 "Category:WMF Projects 2018q2")
* [WMF Projects 2018q3](/wiki/Category%3AWMF_Projects_2018q3 "Category:WMF Projects 2018q3")
* [WMF Projects 2018q4](/wiki/Category%3AWMF_Projects_2018q4 "Category:WMF Projects 2018q4")
* [WMF Projects 2019q1](/wiki/Category%3AWMF_Projects_2019q1 "Category:WMF Projects 2019q1")
* [WMF Projects 2019q2](/wiki/Category%3AWMF_Projects_2019q2 "Category:WMF Projects 2019q2")
* [WMF Projects 2019q3](/wiki/Category%3AWMF_Projects_2019q3 "Category:WMF Projects 2019q3")
* [WMF Projects 2019q4](/wiki/Category%3AWMF_Projects_2019q4 "Category:WMF Projects 2019q4")
* [WMF Projects 2020q1](/wiki/Category%3AWMF_Projects_2020q1 "Category:WMF Projects 2020q1")
* [WMF Projects 2020q2](/wiki/Category%3AWMF_Projects_2020q2 "Category:WMF Projects 2020q2")
* [WMF Projects 2020q3](/wiki/Category%3AWMF_Projects_2020q3 "Category:WMF Projects 2020q3")
* [WMF Projects 2020q4](/wiki/Category%3AWMF_Projects_2020q4 "Category:WMF Projects 2020q4")
* [WMF Projects 2021q1](/wiki/Category%3AWMF_Projects_2021q1 "Category:WMF Projects 2021q1")
* [WMF Projects 2021q2](/wiki/Category%3AWMF_Projects_2021q2 "Category:WMF Projects 2021q2")
* [WMF Projects 2021q3](/wiki/Category%3AWMF_Projects_2021q3 "Category:WMF Projects 2021q3")
* [WMF Projects 2021q4](/wiki/Category%3AWMF_Projects_2021q4 "Category:WMF Projects 2021q4")
* [WMF Projects 2022q1](/wiki/Category%3AWMF_Projects_2022q1 "Category:WMF Projects 2022q1")
* [WMF Projects 2022q2](/wiki/Category%3AWMF_Projects_2022q2 "Category:WMF Projects 2022q2")
* [WMF Projects 2022q3](/wiki/Category%3AWMF_Projects_2022q3 "Category:WMF Projects 2022q3")
* [WMF Projects 2022q4](/wiki/Category%3AWMF_Projects_2022q4 "Category:WMF Projects 2022q4")
* [WMF Projects 2023q1](/wiki/Category%3AWMF_Projects_2023q1 "Category:WMF Projects 2023q1")
* [WMF Projects 2023q2](/wiki/Category%3AWMF_Projects_2023q2 "Category:WMF Projects 2023q2")
* [WMF Projects 2023q3](/wiki/Category%3AWMF_Projects_2023q3 "Category:WMF Projects 2023q3")
* [WMF Projects 2023q4](/wiki/Category%3AWMF_Projects_2023q4 "Category:WMF Projects 2023q4")
* [WMF Projects 2024q1](/wiki/Category%3AWMF_Projects_2024q1 "Category:WMF Projects 2024q1")
* [WMF Projects 2024q2](/wiki/Category%3AWMF_Projects_2024q2 "Category:WMF Projects 2024q2")
* [WMF Projects 2024q3](/wiki/Category%3AWMF_Projects_2024q3 "Category:WMF Projects 2024q3")
* [WMF Projects 2024q4](/wiki/Category%3AWMF_Projects_2024q4 "Category:WMF Projects 2024q4")
* [WMF Projects 2025q1](/wiki/Category%3AWMF_Projects_2025q1 "Category:WMF Projects 2025q1")

* This page was last edited on 7 January 2025, at 05:27.
* Text is available under the [Creative Commons Attribution-ShareAlike License](https://creativecommons.org/licenses/by-sa/4.0/deed.en); additional terms may apply. Text in [the Help: namespace](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Help%3AContents) is available under the [Creative Commons CC0 License](https://creativecommons.org/publicdomain/zero/1.0/).
  By using this site, you agree to the [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use) and [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy).

* [Privacy policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3APrivacy_policy)
* [About mediawiki.org](/wiki/Project%3AAbout)
* [Disclaimers](/wiki/Project%3AGeneral_disclaimer)
* [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct)
* [Developers](https://developer.wikimedia.org)
* [Statistics](https://stats.wikimedia.org/#/www.mediawiki.org)
* [Cookie statement](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ACookie_statement)
* [Mobile view](//m.mediawiki.org/w/index.php?title=Parsoid&mobileaction=toggle_view_mobile)

* [![Wikimedia Foundation](/static/images/footer/wikimedia-button.svg)](https://wikimediafoundation.org/)
* [![Powered by MediaWiki](/w/resources/assets/poweredby_mediawiki.svg)](https://www.mediawiki.org/)



=== Content from phabricator.wikimedia.org_9f9491ca_20250114_221119.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT279451)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T279451
# CVE-2021-30458: Parsoid comment fostering allows for inserting mostly arbitrary <meta> tagsClosed, Resolved[Public](/policy/explain/PHID-TASK-xadga7kainvpsnbi7rxz/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/279451/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/279451/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-xadga7kainvpsnbi7rxz/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-xadga7kainvpsnbi7rxz/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Protect as security issue](/wmf/escalate-task/279451/)
* [Award Token](/token/give/PHID-TASK-xadga7kainvpsnbi7rxz/)
* [Flag For Later](/flag/edit/PHID-TASK-xadga7kainvpsnbi7rxz/)

Assigned To

|  | [Arlolra](/p/Arlolra/) |
| --- | --- |

Authored By

|  | [Arlolra](/p/Arlolra/) |
| --- | --- |
| Apr 6 2021, 4:44 PM2021-04-06 16:44:18 (UTC+0) |

Tags

* [Parsoid](/tag/parsoid/) [(Bugs & Crashers)](/project/board/487/)
* [Security](/tag/security/)
* [Security-Team](/tag/security-team/) [(Incoming)](/project/board/1179/)
* [Vuln-XSS](/tag/vuln-xss/)
Referenced Files

|  | [F34280891: 0001-Use-a-protected-key-to-distinguish-comments-internal.patch](/F34280891) |
| --- | --- |
| Apr 7 2021, 10:54 PM2021-04-07 22:54:54 (UTC+0) |

|  | [F34279096: 0001-SECURITY-Use-a-protected-key-to-distinguish-comments.patch](/F34279096) |
| --- | --- |
| Apr 7 2021, 8:46 PM2021-04-07 20:46:02 (UTC+0) |

|  | [F34279029: 0001-Use-a-protected-key-to-distinguish-comments-internal.patch](/F34279029) |
| --- | --- |
| Apr 7 2021, 8:37 PM2021-04-07 20:37:45 (UTC+0) |

|  | [F34278463: 0001-Use-a-protected-key-to-distinguish-comments-internal.patch](/F34278463) |
| --- | --- |
| Apr 7 2021, 7:16 PM2021-04-07 19:16:51 (UTC+0) |

|  | [F34278195: 0001-Use-a-protected-key-to-distinguish-comments-internal.patch](/F34278195) |
| --- | --- |
| Apr 7 2021, 7:05 PM2021-04-07 19:05:46 (UTC+0) |

|  | [F34277806: foo.patch](/F34277806) |
| --- | --- |
| Apr 7 2021, 6:42 PM2021-04-07 18:42:57 (UTC+0) |

|  | [F34275955: 0001-Use-a-protected-key-to-distinguish-comments-internal.patch](/F34275955) |
| --- | --- |
| Apr 7 2021, 4:28 PM2021-04-07 16:28:39 (UTC+0) |

|  | [F34274580: 0001-WIP-Remove-option-to-tunnelFosteredContent.patch](/F34274580) |
| --- | --- |
| Apr 7 2021, 1:33 PM2021-04-07 13:33:24 (UTC+0) |

[View All 9 Files](/file/ui/curtain/list/PHID-TASK-xadga7kainvpsnbi7rxz/)Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [Arlolra](/p/Arlolra/) |
| --- | --- |

|  | [cscott](/p/cscott/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [Reedy](/p/Reedy/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

|  | [ssastry](/p/ssastry/) |
| --- | --- |

# Description

While treebuilding, Parsoid converts some nodes to html comments with json encoded values to try to prevent them from being fostered. However, other comments on the page, present in the input, may contain valid json (see [T279182](/T279182)). If that json happened to have the expected property ("@type": "mw:..."), we might run into some trouble. For a similar reason, the tokenizer already protects data attributes on dom nodes from similar conflicts with data-mw/data-parsoid/etc

See WTUtils::fosterCommentData / WTUtils::reinsertFosterableContent

Introduced in [0d6c4aaf4e3621d576c7a15a84b243af71af793b](https://gerrit.wikimedia.org/g/mediawiki/extensions/Parsoid/%2B/0d6c4aaf4e3621d576c7a15a84b243af71af793b) (all released Parsoid versions).

# Details

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [Update Parsoid to 0.12.2](https://gerrit.wikimedia.org/r/c/677986) | [mediawiki/vendor](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/vendor) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/vendor/%2B/REL1_35) | +66 -125 |
|  | [Bump wikimedia/parsoid to 0.13.0-a32](https://gerrit.wikimedia.org/r/c/677983) | [mediawiki/vendor](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/vendor) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/vendor/%2B/master) | +49 -72 |
|  | [Use a protected key to distinguish comments internal to Parsoid](https://gerrit.wikimedia.org/r/c/677954) | [mediawiki/services/parsoid](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/services/parsoid) | [REL1\_35](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/services/parsoid/%2B/REL1_35) | +16 -2 |
|  | [Use a protected key to distinguish comments internal to Parsoid](https://gerrit.wikimedia.org/r/c/677979) | [mediawiki/services/parsoid](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/services/parsoid) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/services/parsoid/%2B/master) | +12 -2 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T279451)
# Related ObjectsSearch...

* Task Graph
* Mentions

|  |  | Status | Subtype | Assigned | Task |
| --- | --- | --- | --- | --- | --- |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T270458 [Release MediaWiki 1.31.13/1.35.2](/T270458) |
|  |  | Resolved |  | [Reedy](/p/Reedy/) | T270459 [Tracking bug for MediaWiki 1.31.13/1.35.2](/T270459) |
|  |  | Resolved | Security | [Arlolra](/p/Arlolra/) | T279451 [CVE-2021-30458: Parsoid comment fostering allows for inserting mostly arbitrary <meta> tags](/T279451) |

Mentioned In [T277800: Argument 1 passed to Wikimedia\Parsoid\Html2Wt\WikitextSerializer::stripUnnecessaryHeadingNowikis() must be of the type string, null given, called in /srv/mediawiki/php-1.36.0-wmf.34/vendor/wikimedia/parsoid/src/Html2Wt/WikitextSerializer.php on line 1647](/T277800)
[T270459: Tracking bug for MediaWiki 1.31.13/1.35.2](/T270459)
[F34274580: 0001-WIP-Remove-option-to-tunnelFosteredContent.patch](/F34274580) Mentioned Here [T270458: Release MediaWiki 1.31.13/1.35.2](/T270458)
[T270466: Write and send supplementary release announcement for extensions and skins with security patches (1.31.13/1.35.2)](/T270466)
[T279182: PHP Notice: Undefined property: stdClass::$@type](/T279182)
[T279184: PHP Notice: Undefined property: stdClass::$dsr](/T279184)
### Event Timeline

[Arlolra](/p/Arlolra/) created this task.[Apr 6 2021, 4:44 PM2021-04-06 16:44:18 (UTC+0)](#6976991)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/4191314/)[Apr 6 2021, 4:44 PM2021-04-06 16:44:18 (UTC+0)](#6977003)[Arlolra](/p/Arlolra/) triaged this task as Low priority.[Apr 6 2021, 4:44 PM2021-04-06 16:44:33 (UTC+0)](#6977005)[Arlolra](/p/Arlolra/) moved this task from [Needs Triage](/project/board/487/) to [Bugs & Crashers](/project/board/487/) on the [Parsoid](/tag/parsoid/) board.[Arlolra](/p/Arlolra/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-aqwgqh372zwy7o6/)

[Legoktm](/p/Legoktm/) raised the priority of this task from Low to Needs Triage.[Apr 6 2021, 7:28 PM2021-04-06 19:28:26 (UTC+0)](#6977734)[Legoktm](/p/Legoktm/) set Security to Software security bug.[Legoktm](/p/Legoktm/) added projects: [Security](/tag/security/), [Security-Team](/tag/security-team/).[Legoktm](/p/Legoktm/) changed the visibility from "Public (No Login Required)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-gdbbtbv2mxjvefz/)".[Legoktm](/p/Legoktm/) changed the subtype of this task from "Task" to "Security Issue".[Legoktm](/p/Legoktm/) added a project: [Vuln-XSS](/tag/vuln-xss/).[Legoktm](/p/Legoktm/) subscribed.Comment Actions

[@Arlolra](/p/Arlolra/) said this might be exploitable as an XSS since it runs post-sanitization.

[Legoktm](/p/Legoktm/) added a comment.[Apr 6 2021, 8:10 PM2021-04-06 20:10:55 (UTC+0)](#6977869)Comment Actions

So it seems like you can only create <meta> tags that will end up in the body.

First tried: <!--{"@type":"mw:pwnd", "attrs": [["http-equiv", "refresh"],["content","1;url=https://example.org/"]]}-->, but Parsoid drops http-equiv because of the dash.

Then tried setting a referrer policy and ended up with <meta name="referrer" content="unsafe&amp;#x2D;URL" id="mwAg"/> because the dash again gets encoded.

I was able to create <meta property="og:title" content="some vandalism" id="mwAg"/> but haven't checked whether the OpenGraph spec allows those tags in the body.

So you can definitely inject mostly-arbitrary <meta> tags into generated HTML, just need to find a tag that does nefarious things to make it exploitable...

For testing:

```
curl -X POST "https://en.wikipedia.org/api/rest_v1/transform/wikitext/to/html" -H  "accept: text/html; charset=utf-8; profile="https://www.mediawiki.org/wiki/Specs/HTML/2.1.0"" -H  "Content-Type: multipart/form-data" -F 'wikitext=<!--{"@type":"mw:pwnd", "attrs": [["property", "og:title"],["content","some vandalism"]]}-->'
```
[Arlolra](/p/Arlolra/) added a comment.[Apr 6 2021, 8:15 PM2021-04-06 20:15:36 (UTC+0)](#6977887)Comment Actions
> but Parsoid drops http-equiv because of the dash.

The contents of the comment will be encoded with WTUtils::encodeComment

[Legoktm](/p/Legoktm/) added subscribers: [ssastry](/p/ssastry/), [cscott](/p/cscott/).[Apr 6 2021, 8:19 PM2021-04-06 20:19:36 (UTC+0)](#6977903)[ssastry](/p/ssastry/) added a comment.[Apr 6 2021, 8:25 PM2021-04-06 20:25:07 (UTC+0)](#6977914)Comment Actions

Maybe worth hiding [https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/+/677297/1#message-b9eae79b4f5b009c0aea6c24a01df33204c41406](https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/%2B/677297/1#message-b9eae79b4f5b009c0aea6c24a01df33204c41406) and arlo's followup comments? Or does it just draw more attention to this?

[sbassett](/p/sbassett/) subscribed.Edited · [Apr 6 2021, 8:39 PM2021-04-06 20:39:55 (UTC+0)](#6977973)Comment Actions
> In [T279451#6977914](/T279451#6977914), [@ssastry](/p/ssastry/) wrote:
>
> Maybe worth hiding [https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/+/677297/1#message-b9eae79b4f5b009c0aea6c24a01df33204c41406](https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/%2B/677297/1#message-b9eae79b4f5b009c0aea6c24a01df33204c41406) and arlo's followup comments? Or does it just draw more attention to this?

I conferred with some other [Security-Team](/tag/security-team/) members and we believe the disclosure within the gerrit comments is likely **low-risk**, especially since this bug is now protected.

[Arlolra](/p/Arlolra/) claimed this task.[Apr 6 2021, 8:51 PM2021-04-06 20:51:08 (UTC+0)](#6978019)[ssastry](/p/ssastry/) added a comment.[Apr 6 2021, 9:18 PM2021-04-06 21:18:51 (UTC+0)](#6978152)Comment Actions

Just so we track it all in one place, couple of notes. Besides a production deploy, we'll need to do the following as well.

1. Issue a Parsoid/JS security release (nodejs v10 is EOL April 2021, but Parsoid/JS is technically not EOL till MW 1.31 LTS goes EOL). So, we need to do a security release on top of the 0.11.0 deb package.
2. Issue a security release for MW 1.35 (parsoid/php).
[Arlolra](/p/Arlolra/) added a comment.[Apr 6 2021, 9:29 PM2021-04-06 21:29:36 (UTC+0)](#6978169)Comment Actions

0001-WIP-Prevent-comments-that-might-be-confused-as-Parso.patch4 KB[Download](https://phab.wmfusercontent.org/file/download/yzm25irlmj32suxfc45u/PHID-FILE-ifag2z3uiaqkj7vx3cvz/0001-WIP-Prevent-comments-that-might-be-confused-as-Parso.patch)

[ssastry](/p/ssastry/) added a comment.Edited · [Apr 6 2021, 9:47 PM2021-04-06 21:47:02 (UTC+0)](#6978200)Comment Actions

Thanks! I know this is a WIP start, but instead of throwing an exception, dirty the comment (which will show up as a one-off dirty diff on edits, but it is probably okay), with some prefix (even reuse the data-x prefix if you want). As a later fix, we can try to prevent the dirty-diff. Throwing an exception will probably return a http 500 / 403 / ... right? In this case, we can just bypass the spoofing and render everything else just fine.

[Arlolra](/p/Arlolra/) added a comment.[Apr 6 2021, 9:56 PM2021-04-06 21:56:54 (UTC+0)](#6978228)Comment Actions
> dirty the comment (which will show up as a one-off dirty diff on edits, but it is probably okay), with some prefix (even reuse the data-x prefix if you want)

It was my understanding that we can't change the comment length, less we mess up dsr computation (see WTUtils::decodedCommentLength() et al). We could do something like s/@type/@hype/ though, which I thought was meh.

Is there a benefit to throwing an exception and being notified of attempts at abuse? Whether intentional or not.

[ssastry](/p/ssastry/) added a comment.[Apr 6 2021, 10:02 PM2021-04-06 22:02:53 (UTC+0)](#6978238)Comment Actions
> In [T279451#6978228](/T279451#6978228), [@Arlolra](/p/Arlolra/) wrote:
> > dirty the comment (which will show up as a one-off dirty diff on edits, but it is probably okay), with some prefix (even reuse the data-x prefix if you want)
>
> It was my understanding that we can't change the comment length, less we mess up dsr computation (see WTUtils::decodedCommentLength() et al). We could do something like s/@type/@hype/ though, which I thought was meh.

True reg. DSR. So, yes, maybe 's/@type/abuse/'? or some such.

> Is there a benefit to throwing an exception and being notified of attempts at abuse? Whether intentional or not.

That is a good thought about being notified. You can still log an entry in logstash that will flag it for review without blocking a render.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 12:57 PM2021-04-07 12:57:53 (UTC+0)](#6979972)Comment Actions

[@cscott](/p/cscott/)'s suggestion is that since the comments coming from source get encoded, we can change the key the trick is using to something not found after the encoding so we'd never have a conflict, rather than munging the comment values and creating diffs.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 1:33 PM2021-04-07 13:33:24 (UTC+0)](#6980047)Comment Actions

New patch implements the suggestion from [T279451#6979972](/T279451#6979972)

0001-WIP-Remove-option-to-tunnelFosteredContent.patch8 KB[Download](https://phab.wmfusercontent.org/file/download/hpecnpmgmh3nbufh5n37/PHID-FILE-4scuxqzsbbduij5rdav7/0001-WIP-Remove-option-to-tunnelFosteredContent.patch)

The switch from s/@type/-type/ is obscured in this slightly larger, related change.

[Arlolra](/p/Arlolra/) mentioned this in [F34274580: 0001-WIP-Remove-option-to-tunnelFosteredContent.patch](/F34274580).[Apr 7 2021, 2:29 PM2021-04-07 14:29:10 (UTC+0)](#6980241)[Reedy](/p/Reedy/) subscribed.[Apr 7 2021, 2:39 PM2021-04-07 14:39:45 (UTC+0)](#6980279)[cscott](/p/cscott/) added a comment.Edited · [Apr 7 2021, 3:40 PM2021-04-07 15:40:56 (UTC+0)](#6980614)Comment Actions

That second patch looks good to me. Confirmed by reading WTUtils::encodeComment that [->&] in wikitext will be entity-encoded in the HTML comment value, so any attempt to write -type in wikitext will appear in HTML as &#x2D;type, which JSON decoding will interpret literally (not entity-decoded) and therefore user-generated content should not be able to masquerade as a fostered element. Note that since we don't encoding the comment containing the fostered content (this isn't changed with your patch, it's a pre-existing bug), it's possible the internal DOM will contain unserializable HTML -- that is, fostered content could contain a --> in such a way that the internal HTML comment in DOM also contains the string --> which would break the comment if the DOM was deserialized and reserialized. I \*think\* that's okay, but it makes me a little nervous -- HTML content can get embedded in data-mw for captions, etc. We need to be sure that any "fostered content" comments are dealt with before that serialization into data-mw occurs. I'd be a little more comfortable if we always encodeCommented the \*value\* of the -type key, which would ensure that --> could never appear and break the comment.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 4:09 PM2021-04-07 16:09:08 (UTC+0)](#6980796)Comment Actions
> this isn't changed with your patch, it's a pre-existing bug

It's by design. The lifetime of these comments is that they're created during treebuilding and then in the first pass on the dom (preparedom) they are converted back to meta tags.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 4:25 PM2021-04-07 16:25:54 (UTC+0)](#6980888)Comment Actions

The treebuilder doesn't emit the dom until it has been "prepared",

<https://github.com/wikimedia/parsoid/blob/master/src/Wt2Html/HTML5TreeBuilder.php#L161-L176>

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 4:28 PM2021-04-07 16:28:39 (UTC+0)](#6980914)Comment Actions

I broke removing the tunnelling option out into a separate patch,

[https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/+/677592](https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/%2B/677592)

And the patch is now pared down to,

0001-Use-a-protected-key-to-distinguish-comments-internal.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/dnmma6pevklo3tg46dyr/PHID-FILE-6zbjv2untgtycxiea6jx/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

[ssastry](/p/ssastry/) added a comment.[Apr 7 2021, 4:32 PM2021-04-07 16:32:19 (UTC+0)](#6980924)Comment Actions

+1 from me.

[ssastry](/p/ssastry/) added a comment.Edited · [Apr 7 2021, 5:04 PM2021-04-07 17:04:08 (UTC+0)](#6981071)Comment Actions

[@cscott](/p/cscott/), are you a +1 on that patch as well? I assume yes based on [T279451#6980614](/T279451#6980614) but an explicit nod for the latest version would be helpful.

So, how do we want (a) roll this out into production (b) get this into the security release planned for release this week (c) get this into a parsoid/js security release?

[@Reedy](/p/Reedy/), [@sbassett](/p/sbassett/) your input would be helpful here for (a) and (b) especially.

[sbassett](/p/sbassett/) added a comment.Edited · [Apr 7 2021, 5:43 PM2021-04-07 17:43:26 (UTC+0)](#6981159)Comment Actions
> In [T279451#6981071](/T279451#6981071), [@ssastry](/p/ssastry/) wrote:
>
> So, how do we want (a) roll this out into production (b) get this into the security release planned for release this week (c) get this into a parsoid/js security release?
>
> [@Reedy](/p/Reedy/), [@sbassett](/p/sbassett/) your input would be helpful here for (a) and (b) especially.

For (a), I'm not familiar with the services/parsoid production deployment process, but security patch deployments should likely follow [our current mediawiki core/ext/skins security patch deployment process](https://wikitech.wikimedia.org/wiki/How_to_deploy_code#Security_patches). To wit: upload the patch to the relevant deployment server, apply the patch to a staging repo via git am, test on the mwdebugs if possible and then deploy affected files and watch the logs.

For (b), I believe the proper security release (for core and bundled extensions, tracked at [T270458](/T270458)) is due out tomorrow, April 8th, 2021. I'd defer to [@Reedy](/p/Reedy/) on how difficult it might be to include this issue within that release at this point. We could alternatively include this issue with the supplemental announcement I usually put together for non-core, non-production, non-bundled extensions, skins, etc: [T270466](/T270466), likely due to be released early next week. A completely separate announcement could also be made, though I'd personally prefer to avoid that option if possible.

[Legoktm](/p/Legoktm/) added a comment.[Apr 7 2021, 5:57 PM2021-04-07 17:57:18 (UTC+0)](#6981178)Comment Actions
> In [T279451#6981159](/T279451#6981159), [@sbassett](/p/sbassett/) wrote:
> > In [T279451#6981071](/T279451#6981071), [@ssastry](/p/ssastry/) wrote:
> >
> > So, how do we want (a) roll this out into production (b) get this into the security release planned for release this week (c) get this into a parsoid/js security release?
> >
> > [@Reedy](/p/Reedy/), [@sbassett](/p/sbassett/) your input would be helpful here for (a) and (b) especially.
>
> For (a), I'm not familiar with the services/parsoid production deployment process, but security patch deployments should likely follow [our current mediawiki core/ext/skins security patch deployment process](https://wikitech.wikimedia.org/wiki/How_to_deploy_code#Security_patches). To wit: upload the patch to the relevant deployment server, apply the patch to a staging repo via git am, test on the mwdebugs if possible and then deploy affected files and watch the logs.

Specifically parsoid is deployed via mediawiki/vendor, so the patch should be made against that repository.

> For (b), I believe the proper security release (for core and bundled extensions, tracked at [T270458](/T270458)) is due out tomorrow, April 8th, 2021. I'd defer to [@Reedy](/p/Reedy/) on how difficult it might be to include this issue within that release at this point.

Parsoid is bundled in the tarball via mediawiki/vendor, so the fix should go in the normal tarball release. It's a little tricky because we also need to push a new composer release/bump the version in composer.json for people installing Parsoid that way. If we're OK with it (given this seems to be a difficult to maliciously exploit XSS), I think we do the Parsoid composer release an hourish before the tarball release, bump mediawiki/vendor publicly for master and REL1\_35. Alternatively, we use a patch for mediawiki/vendor, ship that in the tarball and in git, and then do the Parsoid release after all the security stuff is over.

> We could alternatively include this issue with the supplemental announcement I usually put together for non-core, non-production, non-bundled extensions, skins, etc: [T270466](/T270466), likely due to be released early next week. A completely separate announcement could also be made, though I'd personally prefer to avoid that option if possible.

This probably makes sense for Parsoid/JS if we're OK with a gap in between the disclosure with Parsoid/PHP and the fix in Parsoid/JS.

[cscott](/p/cscott/) added a comment.[Apr 7 2021, 6:37 PM2021-04-07 18:37:41 (UTC+0)](#6981267)Comment Actions

Can we add a line to force $decode = false in WTUtils::reinsertFosterableContent ? I know it's not strictly necessary, since it is set to false in the one place that method is called, but it would be a bit of belt-and-suspenders. I'm +1. I assume there was an explicit discussion w/r/t not being subtle about the disclosure? The latest patch draws a big arrow pointed at the vulnerability. On the other hand, the main exploit path for <meta> tags seems to be http-equiv, and we're protected from that route by the same wikitext comment encoding mechanism.

[cscott](/p/cscott/) added a comment.[Apr 7 2021, 6:42 PM2021-04-07 18:42:57 (UTC+0)](#6981276)Comment Actions

And just for completeness, this is actually the line which protects -type:

foo.patch564 B[Download](https://phab.wmfusercontent.org/file/download/kqv7vklhtjjylbtb2c5m/PHID-FILE-267tyll4ffchsqj4zcye/foo.patch)

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 7:00 PM2021-04-07 19:00:28 (UTC+0)](#6981308)Comment Actions
> Can we add a line to force $decode = false in WTUtils::reinsertFosterableContent ? I know it's not strictly necessary, since it is set to false in the one place that method is called, but it would be a bit of belt-and-suspenders.

This patch that's already been merged removes decoding in that function altogether,

[https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/+/677592/1/src/Utils/WTUtils.php](https://gerrit.wikimedia.org/r/c/mediawiki/services/parsoid/%2B/677592/1/src/Utils/WTUtils.php)

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 7:05 PM2021-04-07 19:05:46 (UTC+0)](#6981314)Comment Actions
> And just for completeness, this is actually the line which protects -type:

Ok, added to the patch

0001-Use-a-protected-key-to-distinguish-comments-internal.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/bvqjwsvffrxzxm3qzbyd/PHID-FILE-rcfklnwg4wlicihfggko/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

[cscott](/p/cscott/) added a comment.[Apr 7 2021, 7:09 PM2021-04-07 19:09:10 (UTC+0)](#6981320)Comment Actions

Ok, sorry, I was a bit behind. So yes, I'm +1 to the latest patch, and my understanding is that we're going to (a) merge it in master, (b) cherry-pick that change to REL1\_35 and thereby include it in the upcoming security release, (c) possibly cherry-pick the patch to wmf.37 and SWAT it, and (d) port this patch to Parsoid/JS and do a release bump of the NPM package as well. Yes?

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 7:16 PM2021-04-07 19:16:51 (UTC+0)](#6981342)Comment Actions

I've added links back to this task in the php comments in this version, in case we don't remember what those warnings are talking about,

0001-Use-a-protected-key-to-distinguish-comments-internal.patch2 KB[Download](https://phab.wmfusercontent.org/file/download/tthe23rpnowtdfplshjs/PHID-FILE-oosjinkoymotmdpihcmd/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

We can add the $decode = false; to the backport patch for REL1\_35 when that's created. I'm going to work on the Parsoid/JS patch next.

[cscott](/p/cscott/) added a comment.Edited · [Apr 7 2021, 7:39 PM2021-04-07 19:39:20 (UTC+0)](#6981523)Comment Actions

[@Arlolra](/p/Arlolra/) can you work with [@Legoktm](/p/Legoktm/) to get this applied ASAP in production?

@subbu and I are going to work out a schedule with [@Reedy](/p/Reedy/) for tomorrow's security release. Assuming this is fixed in production before tomorrow, I'll upload the patch to Parsoid master and then cherry pick to Parsoid's REL1\_35 branch \*no sooner than\* an hour or so before the security release and tag v0.12.2 on composer for [@Reedy](/p/Reedy/) to use. I'll also tag v0.13.0-a32 at the same time and make a mediawiki-vendor patch which we'll merge tomorrow. @subbu's going to rt test that overnight. That will also be our "weekly" release for next week, since Friday and Monday are holidays.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 8:37 PM2021-04-07 20:37:45 (UTC+0)](#6981752)Comment Actions
> We can add the $decode = false; to the backport patch for REL1\_35 when that's created.

Here's a patch against REL1\_35 with that extra protection included,

0001-Use-a-protected-key-to-distinguish-comments-internal.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/l3kpzqyjen5dvbqpi3hp/PHID-FILE-kviz3d7lwix455qdyc4i/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 8:45 PM2021-04-07 20:45:19 (UTC+0)](#6981757)Comment Actions
> Here's a patch against REL1\_35 with that extra protection included,

[@Legoktm](/p/Legoktm/) points out that this will apply cleaner to production right now, since we haven't deployed [T279451#6981308](/T279451#6981308) yet, so that's what we're going with

[Legoktm](/p/Legoktm/) added a comment.[Apr 7 2021, 8:46 PM2021-04-07 20:46:02 (UTC+0)](#6981758)Comment Actions
> In [T279451#6981752](/T279451#6981752), [@Arlolra](/p/Arlolra/) wrote:
> > We can add the $decode = false; to the backport patch for REL1\_35 when that's created.
>
> Here's a patch against REL1\_35 with that extra protection included,
>
> 0001-Use-a-protected-key-to-distinguish-comments-internal.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/l3kpzqyjen5dvbqpi3hp/PHID-FILE-kviz3d7lwix455qdyc4i/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

I applied this against mediawiki/vendor wmf/php-1.36.0-wmf.38:

```
patching file src/Utils/WTUtils.php
Hunk #1 succeeded at 725 (offset 25 lines).
Hunk #2 succeeded at 791 (offset 25 lines).
Hunk #3 succeeded at 814 with fuzz 2 (offset 26 lines).
patching file src/Wt2Html/Grammar.pegphp
Hunk #1 succeeded at 677 (offset 20 lines).
patching file src/Wt2Html/Grammar.php
Hunk #1 succeeded at 562 with fuzz 2 (offset 25 lines).
```

Please verify this patch looks good (also prefixed patch with [SECURITY]):

0001-SECURITY-Use-a-protected-key-to-distinguish-comments.patch3 KB[Download](https://phab.wmfusercontent.org/file/download/x7u4zc3tndzr26jdl7dj/PHID-FILE-tipslem34empws2oriy4/0001-SECURITY-Use-a-protected-key-to-distinguish-comments.patch)

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 8:52 PM2021-04-07 20:52:32 (UTC+0)](#6981778)Comment Actions
> Please verify this patch looks good (also prefixed patch with [SECURITY]):

LGTM

[Legoktm](/p/Legoktm/) added a comment.[Apr 7 2021, 10:11 PM2021-04-07 22:11:30 (UTC+0)](#6982066)Comment Actions

Deployed it to wmf.37 and wmf.38 with Arlo's assistance. Before syncing it to the full cluster I pulled it to just wtp1025 and then ran curl tests against it:

```
$ curl -H 'Host: test.wikipedia.org' "http://wtp1025.eqiad.wmnet/w/rest.php/test.wikipedia.org/v3/transform/wikitext/to/html" -X POST -H  "accept: text/html; charset=utf-8; profile="https://www.mediawiki.org/wiki/Specs/HTML/2.1.0"" -H  "Content-Type: multipart/form-data" -F wikitext='\<!--{"@type":"mw:pwnd", "attrs": [["property", "og:title"],["content","some vandalism"]]}-->'
<!--{"@type":"mw:pwnd", "attrs": [["property", "og:title"],["content","some vandalism"]]}-->
$ curl -H 'Host: test.wikipedia.org' "http://wtp1025.eqiad.wmnet/w/rest.php/test.wikipedia.org/v3/transform/wikitext/to/html" -X POST -H  "accept: text/html; charset=utf-8; profile="https://www.mediawiki.org/wiki/Specs/HTML/2.1.0"" -H  "Content-Type: multipart/form-data" -F wikitext='\<!--{"-type":"mw:pwnd", "attrs": [["property", "og:title"],["content","some vandalism"]]}-->'
<!--{"&#x2D;type":"mw:pwnd", "attrs": [["property", "og:title"],["content","some vandalism"]]}-->
```

And then tried against wtp1026, which did not yet have the code and could exploit it and generate a <meta> tag. It should be deployed everywhere now.

[Arlolra](/p/Arlolra/) added a comment.[Apr 7 2021, 10:54 PM2021-04-07 22:54:54 (UTC+0)](#6982197)Comment Actions
> I'm going to work on the Parsoid/JS patch next.

Here's a Parsoid/JS patch against v0.11.0

0001-Use-a-protected-key-to-distinguish-comments-internal.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/in4a6ixnnhwm2xyu5gpi/PHID-FILE-6rbat7yryjzet4ldnyns/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

[Legoktm](/p/Legoktm/) renamed this task from Protect against comments conflicting with the foster comment strategy to Parsoid comment fostering allows for inserting mostly arbitrary <meta> tags.[Apr 7 2021, 11:06 PM2021-04-07 23:06:54 (UTC+0)](#6982226)[Legoktm](/p/Legoktm/) triaged this task as High priority.[Legoktm](/p/Legoktm/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-kfxdxrzenxcx4s4/)[Legoktm](/p/Legoktm/) added a parent task: [T270459: Tracking bug for MediaWiki 1.31.13/1.35.2](/T270459).[Legoktm](/p/Legoktm/) mentioned this in [T270459: Tracking bug for MediaWiki 1.31.13/1.35.2](/T270459).[Apr 7 2021, 11:12 PM2021-04-07 23:12:53 (UTC+0)](#6982266)[ssastry](/p/ssastry/) added a comment.[Apr 7 2021, 11:19 PM2021-04-07 23:19:22 (UTC+0)](#6982280)Comment Actions
> In [T279451#6982197](/T279451#6982197), [@Arlolra](/p/Arlolra/) wrote:
> > I'm going to work on the Parsoid/JS patch next.
>
> Here's a Parsoid/JS patch against v0.11.0
>
> 0001-Use-a-protected-key-to-distinguish-comments-internal.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/in4a6ixnnhwm2xyu5gpi/PHID-FILE-6rbat7yryjzet4ldnyns/0001-Use-a-protected-key-to-distinguish-comments-internal.patch)

+1 .. Are you preparing a deb or do you want me to?

[Legoktm](/p/Legoktm/) renamed this task from Parsoid comment fostering allows for inserting mostly arbitrary <meta> tags to CVE-2021-30458: Parsoid comment fostering allows for inserting mostly arbitrary <meta> tags.[Apr 8 2021, 3:07 AM2021-04-08 03:07:04 (UTC+0)](#6982416)[Reedy](/p/Reedy/) added a subscriber: [gerritbot](/p/gerritbot/).[Apr 8 2021, 7:11 PM2021-04-08 19:11:18 (UTC+0)](#6985369)[Reedy](/p/Reedy/) closed this task as Resolved.[Apr 8 2021, 9:25 PM2021-04-08 21:25:12 (UTC+0)](#6985810)[Reedy](/p/Reedy/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-cpbjzm6bgvdu5vn/)" to "Public (No Login Required)".

[Legoktm](/p/Legoktm/) added a comment.[Apr 8 2021, 9:43 PM2021-04-08 21:43:22 (UTC+0)](#6985885)Comment Actions

For reference, a 0.11.1 deb was released on releases.wikimedia.org and on npm: <https://www.npmjs.com/package/parsoid>

I also submitted this for the PHP security-advisories database: <https://github.com/FriendsOfPHP/security-advisories/pull/549>

[ssastry](/p/ssastry/) added a comment.[Apr 8 2021, 9:45 PM2021-04-08 21:45:03 (UTC+0)](#6985904)Comment Actions

Also, see <https://www.mediawiki.org/wiki/Parsoid/Releases#0.12.2,_0.11.1_(released_Apr_8,_2021)> if you are using an older version of Parsoid/JS.

[cscott](/p/cscott/) mentioned this in [T277800: Argument 1 passed to Wikimedia\Parsoid\Html2Wt\WikitextSerializer::stripUnnecessaryHeadingNowikis() must be of the type string, null given, called in /srv/mediawiki/php-1.36.0-wmf.34/vendor/wikimedia/parsoid/src/Html2Wt/WikitextSerializer.php on line 1647](/T277800).[Apr 13 2021, 4:08 PM2021-04-13 16:08:54 (UTC+0)](#6995132)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

=== Content from security.gentoo.org_8cf85a09_20250114_221120.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# MediaWiki: Multiple vulnerabilities — GLSA **202107-40**

Multiple vulnerabilities have been found in MediaWiki, the worst of
which could result in a Denial of Service condition.

### Affected packages

| Package | **www-apps/mediawiki** on all architectures |
| --- | --- |
| Affected versions | < **1.36.1** |
| Unaffected versions | >= **1.36.1** |

### Background

MediaWiki is a collaborative editing software used by large projects
such as Wikipedia.

### Description

Multiple vulnerabilities have been discovered in MediaWiki. Please
review the CVE identifiers referenced below for details.

### Impact

Please review the referenced CVE identifiers for details.

### Workaround

There is no known workaround at this time.

### Resolution

All MediaWiki users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-apps/mediawiki-1.36.1"

```
### References

* [CVE-2021-30152](https://nvd.nist.gov/vuln/detail/CVE-2021-30152)
* [CVE-2021-30154](https://nvd.nist.gov/vuln/detail/CVE-2021-30154)
* [CVE-2021-30155](https://nvd.nist.gov/vuln/detail/CVE-2021-30155)
* [CVE-2021-30157](https://nvd.nist.gov/vuln/detail/CVE-2021-30157)
* [CVE-2021-30158](https://nvd.nist.gov/vuln/detail/CVE-2021-30158)
* [CVE-2021-30159](https://nvd.nist.gov/vuln/detail/CVE-2021-30159)
* [CVE-2021-30458](https://nvd.nist.gov/vuln/detail/CVE-2021-30458)
* [CVE-2021-35197](https://nvd.nist.gov/vuln/detail/CVE-2021-35197)

**Release date**

July 17, 2021

**Latest revision**

July 17, 2021: 1

**Severity**

low

**Exploitable**

remote

**Bugzilla entries**

* [780654](https://bugs.gentoo.org/show_bug.cgi?id=780654)
* [797661](https://bugs.gentoo.org/show_bug.cgi?id=797661)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**


