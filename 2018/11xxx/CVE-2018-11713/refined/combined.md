=== Content from security.gentoo.org_3a36c01d_20250124_170440.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# WebkitGTK+: Multiple vulnerabilities — GLSA **201808-04**

Multiple vulnerabilities have been found in WebKitGTK+, the worst
of which may lead to arbitrary code execution.

### Affected packages

| Package | **net-libs/webkit-gtk** on all architectures |
| --- | --- |
| Affected versions | < **2.20.4** |
| Unaffected versions | >= **2.20.4** |

### Background

WebKitGTK+ is a full-featured port of the WebKit rendering engine,
suitable for projects requiring any kind of web integration, from hybrid
HTML/CSS applications to full-fledged web browsers.

### Description

Multiple vulnerabilities have been discovered in WebKitGTK+. Please
review the referenced CVE identifiers for details.

### Impact

A remote attacker could execute arbitrary commands or cause a denial of
service condition via a maliciously crafted web content.

### Workaround

There is no known workaround at this time.

### Resolution

All WebkitGTK+ users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=net-libs/webkit-gtk-2.20.4"

```
### References

* [CVE-2018-11646](https://nvd.nist.gov/vuln/detail/CVE-2018-11646)
* [CVE-2018-11712](https://nvd.nist.gov/vuln/detail/CVE-2018-11712)
* [CVE-2018-11713](https://nvd.nist.gov/vuln/detail/CVE-2018-11713)
* [CVE-2018-12293](https://nvd.nist.gov/vuln/detail/CVE-2018-12293)
* [CVE-2018-12294](https://nvd.nist.gov/vuln/detail/CVE-2018-12294)
* [CVE-2018-4101](https://nvd.nist.gov/vuln/detail/CVE-2018-4101)
* [CVE-2018-4113](https://nvd.nist.gov/vuln/detail/CVE-2018-4113)
* [CVE-2018-4114](https://nvd.nist.gov/vuln/detail/CVE-2018-4114)
* [CVE-2018-4117](https://nvd.nist.gov/vuln/detail/CVE-2018-4117)
* [CVE-2018-4118](https://nvd.nist.gov/vuln/detail/CVE-2018-4118)
* [CVE-2018-4119](https://nvd.nist.gov/vuln/detail/CVE-2018-4119)
* [CVE-2018-4120](https://nvd.nist.gov/vuln/detail/CVE-2018-4120)
* [CVE-2018-4121](https://nvd.nist.gov/vuln/detail/CVE-2018-4121)
* [CVE-2018-4122](https://nvd.nist.gov/vuln/detail/CVE-2018-4122)
* [CVE-2018-4125](https://nvd.nist.gov/vuln/detail/CVE-2018-4125)
* [CVE-2018-4127](https://nvd.nist.gov/vuln/detail/CVE-2018-4127)
* [CVE-2018-4128](https://nvd.nist.gov/vuln/detail/CVE-2018-4128)
* [CVE-2018-4129](https://nvd.nist.gov/vuln/detail/CVE-2018-4129)
* [CVE-2018-4133](https://nvd.nist.gov/vuln/detail/CVE-2018-4133)
* [CVE-2018-4146](https://nvd.nist.gov/vuln/detail/CVE-2018-4146)
* [CVE-2018-4162](https://nvd.nist.gov/vuln/detail/CVE-2018-4162)
* [CVE-2018-4163](https://nvd.nist.gov/vuln/detail/CVE-2018-4163)
* [CVE-2018-4165](https://nvd.nist.gov/vuln/detail/CVE-2018-4165)
* [CVE-2018-4190](https://nvd.nist.gov/vuln/detail/CVE-2018-4190)
* [CVE-2018-4192](https://nvd.nist.gov/vuln/detail/CVE-2018-4192)
* [CVE-2018-4199](https://nvd.nist.gov/vuln/detail/CVE-2018-4199)
* [CVE-2018-4200](https://nvd.nist.gov/vuln/detail/CVE-2018-4200)
* [CVE-2018-4201](https://nvd.nist.gov/vuln/detail/CVE-2018-4201)
* [CVE-2018-4204](https://nvd.nist.gov/vuln/detail/CVE-2018-4204)
* [CVE-2018-4214](https://nvd.nist.gov/vuln/detail/CVE-2018-4214)
* [CVE-2018-4218](https://nvd.nist.gov/vuln/detail/CVE-2018-4218)
* [CVE-2018-4222](https://nvd.nist.gov/vuln/detail/CVE-2018-4222)
* [CVE-2018-4232](https://nvd.nist.gov/vuln/detail/CVE-2018-4232)
* [CVE-2018-4233](https://nvd.nist.gov/vuln/detail/CVE-2018-4233)
* [CVE-2018-4261](https://nvd.nist.gov/vuln/detail/CVE-2018-4261)
* [CVE-2018-4262](https://nvd.nist.gov/vuln/detail/CVE-2018-4262)
* [CVE-2018-4263](https://nvd.nist.gov/vuln/detail/CVE-2018-4263)
* [CVE-2018-4264](https://nvd.nist.gov/vuln/detail/CVE-2018-4264)
* [CVE-2018-4265](https://nvd.nist.gov/vuln/detail/CVE-2018-4265)
* [CVE-2018-4266](https://nvd.nist.gov/vuln/detail/CVE-2018-4266)
* [CVE-2018-4267](https://nvd.nist.gov/vuln/detail/CVE-2018-4267)
* [CVE-2018-4270](https://nvd.nist.gov/vuln/detail/CVE-2018-4270)
* [CVE-2018-4272](https://nvd.nist.gov/vuln/detail/CVE-2018-4272)
* [CVE-2018-4273](https://nvd.nist.gov/vuln/detail/CVE-2018-4273)
* [CVE-2018-4278](https://nvd.nist.gov/vuln/detail/CVE-2018-4278)
* [CVE-2018-4284](https://nvd.nist.gov/vuln/detail/CVE-2018-4284)
* [WebKitGTK+
  Security Advisory WSA-2018-0003](https://webkitgtk.org/security/WSA-2018-0003.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0004](https://webkitgtk.org/security/WSA-2018-0004.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0005](https://webkitgtk.org/security/WSA-2018-0005.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0006](https://webkitgtk.org/security/WSA-2018-0006.html)

**Release date**

August 22, 2018

**Latest revision**

August 22, 2018: 1

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [652820](https://bugs.gentoo.org/show_bug.cgi?id=652820)
* [658168](https://bugs.gentoo.org/show_bug.cgi?id=658168)
* [662974](https://bugs.gentoo.org/show_bug.cgi?id=662974)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from trac.webkit.org_e6804801_20250124_170443.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/228087/webkit "Changeset 228087")
* [Next Changeset](/changeset/228089/webkit "Changeset 228089") →

---

# Changeset 228088 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Feb 5, 2018, 1:02:24 AM
([7 years](/timeline?from=2018-02-05T01%3A02%3A24-08%3A00&precision=second "See timeline at Feb 5, 2018, 1:02:24 AM") ago)
Author:
Carlos Garcia Campos
Message:

[SOUP] WebSockets must use system proxy settings

[​https://bugs.webkit.org/show\_bug.cgi?id=126384](https://bugs.webkit.org/show_bug.cgi?id=126384)

Reviewed by Michael Catanzaro.

Source/WebCore:

Use soup\_session\_connect\_async() when available to create the WebSockets connection instead of GSocketClient

directly.

* platform/network/soup/SocketStreamHandleImpl.h:
* platform/network/soup/SocketStreamHandleImplSoup.cpp:

(WebCore::wssSocketClientEventCallback):

(WebCore::SocketStreamHandleImpl::create):

(WebCore::SocketStreamHandleImpl::connected):

(WebCore::SocketStreamHandleImpl::connectedCallback):

(WebCore::SocketStreamHandleImpl::platformClose):

Tools:

Check also WebSockets in /webkit2/WebKitWebContext/proxy.

* TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp:

(ProxyTest::webSocketProxyServerCallback):

(ProxyTest::ProxyTest):

(ProxyTest::webSocketConnected):

(ProxyTest::createWebSocketAndWaitUntilConnected):

(webSocketServerCallback):

(testWebContextProxySettings):

* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:

(WebKitTestServer::~WebKitTestServer):

(WebKitTestServer::addWebSocketHandler):

(WebKitTestServer::removeWebSocketHandler):

(WebKitTestServer::getWebSocketURIForPath const):

(WebKitTestServer::getURIForPath const):

* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h:

(WebKitTestServer::baseURI const):

(WebKitTestServer::baseWebSocketURI const):

Location:
[trunk](/browser/webkit/trunk?rev=228088)
Files:

7 edited

* [Source/WebCore/ChangeLog](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=228088 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=228088 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088 "Show entry in browser")
  (modified)
  ([7 diffs](#file2 "Show differences"))
* [Tools/ChangeLog](/browser/webkit/trunk/Tools/ChangeLog?rev=228088 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088 "Show entry in browser")
  (modified)
  ([6 diffs](#file4 "Show differences"))
* [Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=228088 "Show entry in browser")
  (modified)
  ([3 diffs](#file5 "Show differences"))
* [Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h?rev=228088 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/Source/WebCore/ChangeLog](/changeset/228088/webkit/trunk/Source/WebCore/ChangeLog "Show the changeset 228088 restricted to trunk/Source/WebCore/ChangeLog")

  | [r228086](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=228086#L1 "Show revision 228086 of this file in browser") | [r228088](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=228088#L1 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2018-02-05  Carlos Garcia Campos  <cgarcia@igalia.com> |
  |  | 2 |  |
  |  | 3 | [SOUP] WebSockets must use system proxy settings |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=126384 |
  |  | 5 |  |
  |  | 6 | Reviewed by Michael Catanzaro. |
  |  | 7 |  |
  |  | 8 | Use soup\_session\_connect\_async() when available to create the WebSockets connection instead of GSocketClient |
  |  | 9 | directly. |
  |  | 10 |  |
  |  | 11 | \* platform/network/soup/SocketStreamHandleImpl.h: |
  |  | 12 | \* platform/network/soup/SocketStreamHandleImplSoup.cpp: |
  |  | 13 | (WebCore::wssSocketClientEventCallback): |
  |  | 14 | (WebCore::SocketStreamHandleImpl::create): |
  |  | 15 | (WebCore::SocketStreamHandleImpl::connected): |
  |  | 16 | (WebCore::SocketStreamHandleImpl::connectedCallback): |
  |  | 17 | (WebCore::SocketStreamHandleImpl::platformClose): |
  |  | 18 |  |
  | 1 | 19 | 2018-02-05  Carlos Garcia Campos  <cgarcia@igalia.com> |
  | 2 | 20 |  |
* ## [trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h](/changeset/228088/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h "Show the changeset 228088 restricted to trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h")

  | [r220887](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=220887#L49 "Show revision 220887 of this file in browser") | [r228088](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=228088#L49 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  | 49 | 49 | public: |
  | 50 | 50 | static Ref<SocketStreamHandleImpl> create(const URL&, SocketStreamHandleClient&, PAL::SessionID, const String&, SourceApplicationAuditToken&&); |
  | 51 |  | ~~static Ref<SocketStreamHandle> create(GSocketConnection\*, SocketStreamHandleClient&);~~ |
  | 52 |  |  |
  | 53 | 51 | virtual ~SocketStreamHandleImpl(); |
  | 54 | 52 |  |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=220887#L65) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=228088#L63) |  |
  | 65 | 63 | void stopWaitingForSocketWritability(); |
  | 66 | 64 |  |
  | 67 |  | static void connectedCallback(G~~SocketClien~~t\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
  |  | 65 | static void connectedCallback(GObject\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
  | 68 | 66 | static void readReadyCallback(GInputStream\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
  | 69 | 67 | static gboolean writeReadyCallback(GPollableOutputStream\*, SocketStreamHandleImpl\*); |
  | 70 | 68 |  |
  | 71 |  | void connected(GRefPtr<G~~SocketConnection~~>&&); |
  |  | 69 | void connected(GRefPtr<GIOStream>&&); |
  | 72 | 70 | void readBytes(gssize); |
  | 73 | 71 | void didFail(SocketStreamError&&); |
  | 74 | 72 | void writeReady(); |
  | 75 | 73 |  |
  | 76 |  | GRefPtr<G~~SocketConnection> m\_socketConnection~~; |
  |  | 74 | GRefPtr<GIOStream> m\_stream; |
  | 77 | 75 | GRefPtr<GInputStream> m\_inputStream; |
  | 78 | 76 | GRefPtr<GPollableOutputStream> m\_outputStream; |
* ## [trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp](/changeset/228088/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp "Show the changeset 228088 restricted to trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp")

  | [r223720](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L56 "Show revision 223720 of this file in browser") | [r228088](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L56 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  | 56 | 56 | } |
  | 57 | 57 |  |
  |  | 58 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 59 | static void wssSocketClientEventCallback(SoupSession\*, GSocketClientEvent event, GIOStream\* connection) |
  |  | 60 | { |
  |  | 61 | if (event != G\_SOCKET\_CLIENT\_TLS\_HANDSHAKING) |
  |  | 62 | return; |
  |  | 63 |  |
  |  | 64 | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(wssConnectionAcceptCertificateCallback), nullptr); |
  |  | 65 | } |
  |  | 66 | #else |
  | 58 | 67 | static void wssSocketClientEventCallback(GSocketClient\*, GSocketClientEvent event, GSocketConnectable\*, GIOStream\* connection) |
  | 59 | 68 | { |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L63) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L72) |  |
  | 63 | 72 | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(wssConnectionAcceptCertificateCallback), nullptr); |
  | 64 | 73 | } |
  | 65 |  |  |
  | 66 |  | Ref<SocketStreamHandleImpl> SocketStreamHandleImpl::create(const URL& url, SocketStreamHandleClient& client, PAL::SessionID, const String&, SourceApplicationAuditToken&&) |
  |  | 74 | #endif |
  |  | 75 |  |
  |  | 76 | Ref<SocketStreamHandleImpl> SocketStreamHandleImpl::create(const URL& url, SocketStreamHandleClient& client, PAL::SessionID sessionID, const String&, SourceApplicationAuditToken&&) |
  | 67 | 77 | { |
  | 68 | 78 | Ref<SocketStreamHandleImpl> socket = adoptRef(\*new SocketStreamHandleImpl(url, client)); |
  | 69 | 79 |  |
  |  | 80 | // FIXME: Using DeprecatedGlobalSettings from here is a layering violation. |
  |  | 81 | bool allowsAnySSLCertificate = url.protocolIs("wss") && DeprecatedGlobalSettings::allowsAnySSLCertificate(); |
  |  | 82 |  |
  |  | 83 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 84 | auto\* networkStorageSession = NetworkStorageSession::storageSession(sessionID); |
  |  | 85 | if (!networkStorageSession) |
  |  | 86 | return socket; |
  |  | 87 |  |
  |  | 88 | auto uri = url.createSoupURI(); |
  |  | 89 | Ref<SocketStreamHandle> protectedSocketStreamHandle = socket.copyRef(); |
  |  | 90 | soup\_session\_connect\_async(networkStorageSession->getOrCreateSoupNetworkSession().soupSession(), uri.get(), socket->m\_cancellable.get(), |
  |  | 91 | allowsAnySSLCertificate ? reinterpret\_cast<SoupSessionConnectProgressCallback>(wssSocketClientEventCallback) : nullptr, |
  |  | 92 | reinterpret\_cast<GAsyncReadyCallback>(connectedCallback), &protectedSocketStreamHandle.leakRef()); |
  |  | 93 | #else |
  |  | 94 | UNUSED\_PARAM(sessionID); |
  | 70 | 95 | unsigned port = url.port() ? url.port().value() : (url.protocolIs("wss") ? 443 : 80); |
  | 71 | 96 | GRefPtr<GSocketClient> socketClient = adoptGRef(g\_socket\_client\_new()); |
  | 72 | 97 | if (url.protocolIs("wss")) { |
  | 73 | 98 | g\_socket\_client\_set\_tls(socketClient.get(), TRUE); |
  | 74 |  | // FIXME: Using DeprecatedGlobalSettings from here is a layering violation. |
  | 75 |  | if (DeprecatedGlobalSettings::allowsAnySSLCertificate()) |
  |  | 99 | if (allowsAnySSLCertificate) |
  | 76 | 100 | g\_signal\_connect(socketClient.get(), "event", G\_CALLBACK(wssSocketClientEventCallback), nullptr); |
  | 77 | 101 | } |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L79) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L103) |  |
  | 79 | 103 | g\_socket\_client\_connect\_to\_host\_async(socketClient.get(), url.host().utf8().data(), port, socket->m\_cancellable.get(), |
  | 80 | 104 | reinterpret\_cast<GAsyncReadyCallback>(connectedCallback), &protectedSocketStreamHandle.leakRef()); |
  |  | 105 | #endif |
  |  | 106 |  |
  | 81 | 107 | return socket; |
  | 82 |  | ~~}~~ |
  | 83 |  |  |
  | 84 |  | ~~Ref<SocketStreamHandle> SocketStreamHandleImpl::create(GSocketConnection\* socketConnection, SocketStreamHandleClient& client)~~ |
  | 85 |  | ~~{~~ |
  | 86 |  | ~~Ref<SocketStreamHandleImpl> socket = adoptRef(\*new SocketStreamHandleImpl(URL(), client));~~ |
  | 87 |  |  |
  | 88 |  | ~~GRefPtr<GSocketConnection> connection = socketConnection;~~ |
  | 89 |  | ~~socket->connected(WTFMove(connection));~~ |
  | 90 |  | ~~return WTFMove(socket);~~ |
  | 91 | 108 | } |
  | 92 | 109 |  |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L103) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L120) |  |
  | 103 | 120 | } |
  | 104 | 121 |  |
  | 105 |  | void SocketStreamHandleImpl::connected(GRefPtr<G~~SocketConnection>&& socketConnection~~) |
  | 106 |  | { |
  | 107 |  | m\_s~~ocketConnection = WTFMove(socketConnection~~); |
  | 108 |  | m\_outputStream = G\_POLLABLE\_OUTPUT\_STREAM(g\_io\_stream\_get\_output\_stream(~~G\_IO\_STREAM(m\_socketConnection.get()~~))); |
  | 109 |  | m\_inputStream = g\_io\_stream\_get\_input\_stream(~~G\_IO\_STREAM(m\_socketConnection.get()~~)); |
  |  | 122 | void SocketStreamHandleImpl::connected(GRefPtr<GIOStream>&& stream) |
  |  | 123 | { |
  |  | 124 | m\_stream = WTFMove(stream); |
  |  | 125 | m\_outputStream = G\_POLLABLE\_OUTPUT\_STREAM(g\_io\_stream\_get\_output\_stream(m\_stream.get())); |
  |  | 126 | m\_inputStream = g\_io\_stream\_get\_input\_stream(m\_stream.get()); |
  | 110 | 127 | m\_readBuffer = std::make\_unique<char[]>(READ\_BUFFER\_SIZE); |
  | 111 | 128 |  |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L118) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L135) |  |
  | 118 | 135 | } |
  | 119 | 136 |  |
  | 120 |  | void SocketStreamHandleImpl::connectedCallback(G~~SocketClient\* clien~~t, GAsyncResult\* result, SocketStreamHandleImpl\* handle) |
  |  | 137 | void SocketStreamHandleImpl::connectedCallback(GObject\* object, GAsyncResult\* result, SocketStreamHandleImpl\* handle) |
  | 121 | 138 | { |
  | 122 | 139 | RefPtr<SocketStreamHandle> protectedThis = adoptRef(handle); |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L124) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L141) |  |
  | 124 | 141 | // Always finish the connection, even if this SocketStreamHandle was cancelled earlier. |
  | 125 | 142 | GUniqueOutPtr<GError> error; |
  | 126 |  | GRefPtr<GSocketConnection> socketConnection = adoptGRef(g\_socket\_client\_connect\_to\_host\_finish(client, result, &error.outPtr())); |
  |  | 143 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 144 | GRefPtr<GIOStream> stream = adoptGRef(soup\_session\_connect\_finish(SOUP\_SESSION(object), result, &error.outPtr())); |
  |  | 145 | #else |
  |  | 146 | GRefPtr<GIOStream> stream = adoptGRef(G\_IO\_STREAM(g\_socket\_client\_connect\_to\_host\_finish(G\_SOCKET\_CLIENT(object), result, &error.outPtr()))); |
  |  | 147 | #endif |
  | 127 | 148 |  |
  | 128 | 149 | // The SocketStreamHandle has been cancelled, so just close the connection, ignoring errors. |
  | 129 | 150 | if (g\_cancellable\_is\_cancelled(handle->m\_cancellable.get())) { |
  | 130 |  | if (s~~ocketConnection~~) |
  | 131 |  | g\_io\_stream\_close(~~G\_IO\_STREAM(socketConnection.get()~~), nullptr, nullptr); |
  |  | 151 | if (stream) |
  |  | 152 | g\_io\_stream\_close(stream.get(), nullptr, nullptr); |
  | 132 | 153 | return; |
  | 133 | 154 | } |
  | 134 | 155 |  |
  | 135 | 156 | if (error) |
  | 136 |  | handle->didFail(SocketStreamError(error->code, ~~String()~~, error->message)); |
  |  | 157 | handle->didFail(SocketStreamError(error->code, { }, error->message)); |
  | 137 | 158 | else |
  | 138 |  | handle->connected(WTFMove(s~~ocketConnection~~)); |
  |  | 159 | handle->connected(WTFMove(stream)); |
  | 139 | 160 | } |
  | 140 | 161 |  |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=223720#L226) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=228088#L247) |  |
  | 226 | 247 | stopWaitingForSocketWritability(); |
  | 227 | 248 |  |
  | 228 |  | if (m\_s~~ocketConnection~~) { |
  |  | 249 | if (m\_stream) { |
  | 229 | 250 | GUniqueOutPtr<GError> error; |
  | 230 |  | g\_io\_stream\_close(~~G\_IO\_STREAM(m\_socketConnection.get()~~), nullptr, &error.outPtr()); |
  |  | 251 | g\_io\_stream\_close(m\_stream.get(), nullptr, &error.outPtr()); |
  | 231 | 252 | if (error) |
  | 232 |  | didFail(SocketStreamError(error->code, ~~String()~~, error->message)); |
  | 233 |  | m\_s~~ocketConnection~~ = nullptr; |
  |  | 253 | didFail(SocketStreamError(error->code, { }, error->message)); |
  |  | 254 | m\_stream = nullptr; |
  | 234 | 255 | } |
  | 235 | 256 |  |
* ## [trunk/Tools/ChangeLog](/changeset/228088/webkit/trunk/Tools/ChangeLog "Show the changeset 228088 restricted to trunk/Tools/ChangeLog")

  | [r228086](/browser/webkit/trunk/Tools/ChangeLog?rev=228086#L1 "Show revision 228086 of this file in browser") | [r228088](/browser/webkit/trunk/Tools/ChangeLog?rev=228088#L1 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2018-02-05  Carlos Garcia Campos  <cgarcia@igalia.com> |
  |  | 2 |  |
  |  | 3 | [SOUP] WebSockets must use system proxy settings |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=126384 |
  |  | 5 |  |
  |  | 6 | Reviewed by Michael Catanzaro. |
  |  | 7 |  |
  |  | 8 | Check also WebSockets in /webkit2/WebKitWebContext/proxy. |
  |  | 9 |  |
  |  | 10 | \* TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp: |
  |  | 11 | (ProxyTest::webSocketProxyServerCallback): |
  |  | 12 | (ProxyTest::ProxyTest): |
  |  | 13 | (ProxyTest::webSocketConnected): |
  |  | 14 | (ProxyTest::createWebSocketAndWaitUntilConnected): |
  |  | 15 | (webSocketServerCallback): |
  |  | 16 | (testWebContextProxySettings): |
  |  | 17 | \* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp: |
  |  | 18 | (WebKitTestServer::~WebKitTestServer): |
  |  | 19 | (WebKitTestServer::addWebSocketHandler): |
  |  | 20 | (WebKitTestServer::removeWebSocketHandler): |
  |  | 21 | (WebKitTestServer::getWebSocketURIForPath const): |
  |  | 22 | (WebKitTestServer::getURIForPath const): |
  |  | 23 | \* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h: |
  |  | 24 | (WebKitTestServer::baseURI const): |
  |  | 25 | (WebKitTestServer::baseWebSocketURI const): |
  |  | 26 |  |
  | 1 | 27 | 2018-02-05  Carlos Garcia Campos  <cgarcia@igalia.com> |
  | 2 | 28 |  |
* ## [trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp](/changeset/228088/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp "Show the changeset 228088 restricted to trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp")

  | [r225045](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L654 "Show revision 225045 of this file in browser") | [r228088](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L654 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  | 654 | 654 | MAKE\_GLIB\_TEST\_FIXTURE(ProxyTest); |
  | 655 | 655 |  |
  |  | 656 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 657 | enum class WebSocketServerType { |
  |  | 658 | Unknown, |
  |  | 659 | NoProxy, |
  |  | 660 | Proxy |
  |  | 661 | }; |
  |  | 662 |  |
  |  | 663 | static void webSocketProxyServerCallback(SoupServer\*, SoupWebsocketConnection\*, const char\* path, SoupClientContext\*, gpointer userData) |
  |  | 664 | { |
  |  | 665 | static\_cast<ProxyTest\*>(userData)->webSocketConnected(ProxyTest::WebSocketServerType::Proxy); |
  |  | 666 | } |
  |  | 667 | #endif |
  |  | 668 |  |
  | 656 | 669 | ProxyTest() |
  | 657 | 670 | { |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L663) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L676) |  |
  | 663 | 676 | m\_proxyServer.run(serverCallback); |
  | 664 | 677 | g\_assert(m\_proxyServer.baseURI()); |
  |  | 678 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 679 | m\_proxyServer.addWebSocketHandler(webSocketProxyServerCallback, this); |
  |  | 680 | g\_assert(m\_proxyServer.baseWebSocketURI()); |
  |  | 681 | #endif |
  | 665 | 682 | } |
  | 666 | 683 |  |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L680) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L697) |  |
  | 680 | 697 | } |
  | 681 | 698 |  |
  |  | 699 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 700 | void webSocketConnected(WebSocketServerType serverType) |
  |  | 701 | { |
  |  | 702 | m\_webSocketRequestReceived = serverType; |
  |  | 703 | quitMainLoop(); |
  |  | 704 | } |
  |  | 705 |  |
  |  | 706 | WebSocketServerType createWebSocketAndWaitUntilConnected() |
  |  | 707 | { |
  |  | 708 | m\_webSocketRequestReceived = WebSocketServerType::Unknown; |
  |  | 709 | GUniquePtr<char> createWebSocket(g\_strdup\_printf("var ws = new WebSocket('%s');", kServer->getWebSocketURIForPath("/foo").data())); |
  |  | 710 | webkit\_web\_view\_run\_javascript(m\_webView, createWebSocket.get(), nullptr, nullptr, nullptr); |
  |  | 711 | g\_main\_loop\_run(m\_mainLoop); |
  |  | 712 | return m\_webSocketRequestReceived; |
  |  | 713 | } |
  |  | 714 | #endif |
  |  | 715 |  |
  | 682 | 716 | WebKitTestServer m\_proxyServer; |
  |  | 717 |  |
  |  | 718 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 719 | WebSocketServerType m\_webSocketRequestReceived { WebSocketServerType::Unknown }; |
  |  | 720 | #endif |
  | 683 | 721 | }; |
  |  | 722 |  |
  |  | 723 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 724 | static void webSocketServerCallback(SoupServer\*, SoupWebsocketConnection\*, const char\*, SoupClientContext\*, gpointer userData) |
  |  | 725 | { |
  |  | 726 | static\_cast<ProxyTest\*>(userData)->webSocketConnected(ProxyTest::WebSocketServerType::NoProxy); |
  |  | 727 | } |
  |  | 728 | #endif |
  | 684 | 729 |  |
  | 685 | 730 | static void ephemeralViewloadChanged(WebKitWebView\* webView, WebKitLoadEvent loadEvent, WebViewTest\* test) |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L697) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L742) |  |
  | 697 | 742 | auto mainResourceData = test->loadURIAndGetMainResourceData(kServer->getURIForPath("/echoPort").data()); |
  | 698 | 743 | ASSERT\_CMP\_CSTRING(mainResourceData, ==, serverPortAsString.get()); |
  |  | 744 |  |
  |  | 745 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 746 | // WebSocket requests should also be received by kServer. |
  |  | 747 | kServer->addWebSocketHandler(webSocketServerCallback, test); |
  |  | 748 | auto serverType = test->createWebSocketAndWaitUntilConnected(); |
  |  | 749 | g\_assert(serverType == ProxyTest::WebSocketServerType::NoProxy); |
  |  | 750 | #endif |
  | 699 | 751 |  |
  | 700 | 752 | // Set default proxy URI to point to proxyServer. Requests to kServer should be received by proxyServer instead. |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L706) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L758) |  |
  | 706 | 758 | ASSERT\_CMP\_CSTRING(mainResourceData, ==, proxyServerPortAsString.get()); |
  | 707 | 759 | webkit\_network\_proxy\_settings\_free(settings); |
  |  | 760 |  |
  |  | 761 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 762 | // WebSocket requests should also be received by proxyServer. |
  |  | 763 | serverType = test->createWebSocketAndWaitUntilConnected(); |
  |  | 764 | g\_assert(serverType == ProxyTest::WebSocketServerType::Proxy); |
  |  | 765 | #endif |
  | 708 | 766 |  |
  | 709 | 767 | // Proxy settings also affect ephemeral web views. |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=225045#L767) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp?rev=228088#L825) |  |
  | 767 | 825 | mainResourceData = test->loadURIAndGetMainResourceData(kServer->getURIForPath("/echoPort").data()); |
  | 768 | 826 | ASSERT\_CMP\_CSTRING(mainResourceData, ==, serverPortAsString.get()); |
  |  | 827 |  |
  |  | 828 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  |  | 829 | kServer->removeWebSocketHandler(); |
  |  | 830 | #endif |
  | 769 | 831 | } |
  | 770 | 832 |  |
* ## [trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp](/changeset/228088/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp "Show the changeset 228088 restricted to trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp")

  | [r218685](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=218685#L54 "Show revision 218685 of this file in browser") | [r228088](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=228088#L54 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  | 54 | 54 | { |
  | 55 | 55 | soup\_uri\_free(m\_baseURI); |
  |  | 56 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 57 | if (m\_baseWebSocketURI) |
  |  | 58 | soup\_uri\_free(m\_baseWebSocketURI); |
  |  | 59 | #endif |
  | 56 | 60 | } |
  | 57 | 61 |  |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=218685#L69) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=228088#L73) |  |
  | 69 | 73 | } |
  | 70 | 74 |  |
  | 71 |  | CString WebKitTestServer::getURIForPath(const char\* path) |
  |  | 75 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 76 | void WebKitTestServer::addWebSocketHandler(SoupServerWebsocketCallback callback, gpointer userData) |
  |  | 77 | { |
  |  | 78 | m\_baseWebSocketURI = soup\_uri\_new\_with\_base(m\_baseURI, "/websocket/"); |
  |  | 79 | m\_baseWebSocketURI->scheme = m\_baseWebSocketURI->scheme == SOUP\_URI\_SCHEME\_HTTP ? SOUP\_URI\_SCHEME\_WS : SOUP\_URI\_SCHEME\_WSS; |
  |  | 80 |  |
  |  | 81 | if (m\_queue) { |
  |  | 82 | m\_queue->dispatch([this, callback, userData] { |
  |  | 83 | soup\_server\_add\_websocket\_handler(m\_soupServer.get(), "/websocket", nullptr, nullptr, callback, userData, nullptr); |
  |  | 84 | }); |
  |  | 85 | } else |
  |  | 86 | soup\_server\_add\_websocket\_handler(m\_soupServer.get(), "/websocket", nullptr, nullptr, callback, userData, nullptr); |
  |  | 87 | } |
  |  | 88 |  |
  |  | 89 | void WebKitTestServer::removeWebSocketHandler() |
  |  | 90 | { |
  |  | 91 | soup\_uri\_free(m\_baseWebSocketURI); |
  |  | 92 | m\_baseWebSocketURI = nullptr; |
  |  | 93 |  |
  |  | 94 | if (m\_queue) { |
  |  | 95 | m\_queue->dispatch([this] { |
  |  | 96 | soup\_server\_remove\_handler(m\_soupServer.get(), "/websocket"); |
  |  | 97 | }); |
  |  | 98 | } else |
  |  | 99 | soup\_server\_remove\_handler(m\_soupServer.get(), "/websocket"); |
  |  | 100 | } |
  |  | 101 |  |
  |  | 102 | CString WebKitTestServer::getWebSocketURIForPath(const char\* path) const |
  |  | 103 | { |
  |  | 104 | g\_assert(m\_baseWebSocketURI); |
  |  | 105 | g\_assert(path && \*path == '/'); |
  |  | 106 | SoupURI\* uri = soup\_uri\_new\_with\_base(m\_baseWebSocketURI, path + 1); // Ignore the leading slash. |
  |  | 107 | GUniquePtr<gchar> uriString(soup\_uri\_to\_string(uri, FALSE)); |
  |  | 108 | soup\_uri\_free(uri); |
  |  | 109 | return uriString.get(); |
  |  | 110 | } |
  |  | 111 | #endif // SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 112 |  |
  |  | 113 | CString WebKitTestServer::getURIForPath(const char\* path) const |
  | 72 | 114 | { |
  | 73 | 115 | SoupURI\* uri = soup\_uri\_new\_with\_base(m\_baseURI, path); |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=218685#L76) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp?rev=228088#L118) |  |
  | 76 | 118 | return uriString.get(); |
  | 77 | 119 | } |
  | 78 |  |  |
* ## [trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h](/changeset/228088/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h "Show the changeset 228088 restricted to trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h")

  | [r218685](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h?rev=218685#L37 "Show revision 218685 of this file in browser") | [r228088](/browser/webkit/trunk/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h?rev=228088#L37 "Show revision 228088 of this file in browser") |  |
  | --- | --- | --- |
  | 37 | 37 | virtual ~WebKitTestServer(); |
  | 38 | 38 |  |
  | 39 |  | SoupURI\* baseURI() { return m\_baseURI; } |
  |  | 39 | SoupURI\* baseURI() const { return m\_baseURI; } |
  |  | 40 | CString getURIForPath(const char\* path) const; |
  |  | 41 | void run(SoupServerCallback); |
  | 40 | 42 |  |
  | 41 |  | CString getURIForPath(const char\* path); |
  | 42 |  | void run(SoupServerCallback); |
  |  | 43 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 44 | void addWebSocketHandler(SoupServerWebsocketCallback, gpointer userData); |
  |  | 45 | void removeWebSocketHandler(); |
  |  | 46 | SoupURI\* baseWebSocketURI() const { return m\_baseWebSocketURI; } |
  |  | 47 | CString getWebSocketURIForPath(const char\* path) const; |
  |  | 48 | #endif |
  | 43 | 49 |  |
  | 44 | 50 | private: |
  | 45 | 51 | GRefPtr<SoupServer> m\_soupServer; |
  | 46 |  | SoupURI\* m\_baseURI; |
  |  | 52 | SoupURI\* m\_baseURI { nullptr }; |
  |  | 53 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 54 | SoupURI\* m\_baseWebSocketURI { nullptr }; |
  |  | 55 | #endif |
  | 47 | 56 | RefPtr<WorkQueue> m\_queue; |
  | 48 | 57 | }; |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=228088)
* [Zip Archive](?format=zip&new=228088)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.webkit.org_d275299b_20250126_022845.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=126384&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[126384](show_bug.cgi?id=126384)

CVE-2018-11713
[SOUP] WebSockets must use system proxy settings
```
https://bugs.webkit.org/show_bug.cgi?id=126384
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
[SOUP] WebSockets must use system proxy settings

Dirkjan Ochtman

[Reported](show_bug.cgi?id=126384#c0)
2014-01-02 08:11:22 PST

Currently, it doesn't appear like WebSockets will work with proxies. I'd like to fix that.

| Attachments | | |
| --- | --- | --- |
| [**Use new libsoup function to get a proxied GIOStream**](attachment.cgi?id=220225 "View the content of the attachment") (7.26 KB, patch)  [2014-01-02 08:19 PST](#attach_220225 "Go to the comment associated with the attachment"), Dirkjan Ochtman | *no flags* | [Details](attachment.cgi?id=220225&action=edit)[Formatted Diff](attachment.cgi?id=220225&action=prettypatch)[Diff](attachment.cgi?id=220225&action=diff) |
| [**Use new libsoup function to get a proxied GIOStream**](attachment.cgi?id=220284 "View the content of the attachment") (6.24 KB, patch)  [2014-01-02 23:50 PST](#attach_220284 "Go to the comment associated with the attachment"), Dirkjan Ochtman | *no flags* | [Details](attachment.cgi?id=220284&action=edit)[Formatted Diff](attachment.cgi?id=220284&action=prettypatch)[Diff](attachment.cgi?id=220284&action=diff) |
| [**Version of the patch that applies to recent WebKit SVN**](attachment.cgi?id=220303 "View the content of the attachment") (6.16 KB, patch)  [2014-01-03 07:46 PST](#attach_220303 "Go to the comment associated with the attachment"), Dirkjan Ochtman | *no flags* | [Details](attachment.cgi?id=220303&action=edit)[Formatted Diff](attachment.cgi?id=220303&action=prettypatch)[Diff](attachment.cgi?id=220303&action=diff) |
| [**WebKit patches for libsoup WebSockets over proxy**](attachment.cgi?id=327158 "View the content of the attachment") (9.77 KB, text/plain)  [2017-11-17 02:30 PST](#attach_327158 "Go to the comment associated with the attachment"), Dirkjan Ochtman | *no flags* | [Details](attachment.cgi?id=327158&action=edit) |
| [**libsoup patches for libsoup WebSockets over proxy**](attachment.cgi?id=327159 "View the content of the attachment") (22.47 KB, text/plain)  [2017-11-17 02:31 PST](#attach_327159 "Go to the comment associated with the attachment"), Dirkjan Ochtman | *no flags* | [Details](attachment.cgi?id=327159&action=edit) |
| [**Patch**](attachment.cgi?id=330537 "View the content of the attachment") (9.89 KB, patch)  [2018-01-05 00:15 PST](#attach_330537 "Go to the comment associated with the attachment"), Carlos Garcia Campos | *no flags* | [Details](attachment.cgi?id=330537&action=edit)[Formatted Diff](attachment.cgi?id=330537&action=prettypatch)[Diff](attachment.cgi?id=330537&action=diff) |
| [**Patch with unit tests**](attachment.cgi?id=330682 "View the content of the attachment") (19.50 KB, patch)  [2018-01-08 04:28 PST](#attach_330682 "Go to the comment associated with the attachment"), Carlos Garcia Campos | mcatanzaro: review+ | [Details](attachment.cgi?id=330682&action=edit)[Formatted Diff](attachment.cgi?id=330682&action=prettypatch)[Diff](attachment.cgi?id=330682&action=diff) |
| [Show Obsolete](#a0) (3) [View All](attachment.cgi?bugid=126384&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=126384&action=enter) *proposed patch, testcase, etc.* | | |

Dirkjan Ochtman

[Comment 1](show_bug.cgi?id=126384#c1)
2014-01-02 08:19:01 PST

Created [attachment 220225](attachment.cgi?id=220225&action=diff "Use new libsoup function to get a proxied GIOStream") [[details]](attachment.cgi?id=220225&action=edit "Use new libsoup function to get a proxied GIOStream")
Use new libsoup function to get a proxied GIOStream
Here's a WIP patch. I'd like for this to get a preliminary review. It probably doesn't apply cleanly to current HEAD, but I'd like to gather some comments on the design.
The patch relies on a new function in libsoup. That work is being tracked in <https://bugzilla.gnome.org/show_bug.cgi?id=721343>. I was advised there that extracting a GIOStream from libsoup made the most sense, which is why I also replaced the GSocketConnection in SocketStreamHandle by a GIOStream. I'm aware of the changes from [bug 88094](show_bug.cgi?id=88094 "RESOLVED FIXED - Web Inspector: Add a WebInspectorServer on Linux using the GSocket API for the GTK port"), so I'm also wondering how that would make sense to integrate.

Carlos Garcia Campos

[Comment 2](show_bug.cgi?id=126384#c2)
2014-01-02 08:59:18 PST

(In reply to [comment #1](show_bug.cgi?id=126384#c1))
> Created an attachment (id=220225) [details]
> Use new libsoup function to get a proxied GIOStream
This looks like a libsoup patch, you should use the GNOME bugzilla instead.
> Here's a WIP patch. I'd like for this to get a preliminary review. It probably doesn't apply cleanly to current HEAD, but I'd like to gather some comments on the design.
It's ok to submit WIP patches to bugzilla for early reviews, but do not set the r? flag in such case.
> The patch relies on a new function in libsoup. That work is being tracked in <https://bugzilla.gnome.org/show_bug.cgi?id=721343>. I was advised there that extracting a GIOStream from libsoup made the most sense, which is why I also replaced the GSocketConnection in SocketStreamHandle by a GIOStream. I'm aware of the changes from [bug 88094](show_bug.cgi?id=88094 "RESOLVED FIXED - Web Inspector: Add a WebInspectorServer on Linux using the GSocket API for the GTK port"), so I'm also wondering how that would make sense to integrate.
hmm, I think you submitted the libsoup patch here instead by mistake :-)

Dirkjan Ochtman

[Comment 3](show_bug.cgi?id=126384#c3)
2014-01-02 23:50:43 PST

Created [attachment 220284](attachment.cgi?id=220284&action=diff "Use new libsoup function to get a proxied GIOStream") [[details]](attachment.cgi?id=220284&action=edit "Use new libsoup function to get a proxied GIOStream")
Use new libsoup function to get a proxied GIOStream

Dirkjan Ochtman

[Comment 4](show_bug.cgi?id=126384#c4)
2014-01-02 23:51:30 PST

(In reply to [comment #2](show_bug.cgi?id=126384#c2))
> This looks like a libsoup patch, you should use the GNOME bugzilla instead.
Doh! You're right, of course. I've now attached the correct patch.
> It's ok to submit WIP patches to bugzilla for early reviews, but do not set the r? flag in such case.
Okay, sorry about that!

Martin Robinson

[Comment 5](show_bug.cgi?id=126384#c5)
2014-01-03 06:40:38 PST

Comment on [attachment 220284](attachment.cgi?id=220284&action=diff "Use new libsoup function to get a proxied GIOStream") [[details]](attachment.cgi?id=220284&action=edit "Use new libsoup function to get a proxied GIOStream")
Use new libsoup function to get a proxied GIOStream
View in context: <https://bugs.webkit.org/attachment.cgi?id=220284&action=review>
> WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:-94
> - if (url.protocolIs("wss"))
> - g\_socket\_client\_set\_tls(socketClient.get(), TRUE);
Why are you removing this code? Doesn't this break secure web sockets?
> WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:94
> + soup\_session\_proxy\_connect(session, uri, connectedCallback, m\_id);
Is this the only change related to proxy support?
> WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:238
> -static void connectedCallback(GSocketClient\* client, GAsyncResult\* result, void\* id)
> +static void connectedCallback(GIOStream \*iostream, GError \*error, void\* id)
Is the GIOStream here actually a GSocketClient? If so, perhaps it would make more sense to cast it and avoid the rest of your changes.

Dirkjan Ochtman

[Comment 6](show_bug.cgi?id=126384#c6)
2014-01-03 06:51:36 PST

(In reply to [comment #5](show_bug.cgi?id=126384#c5))
> (From update of [attachment 220284](attachment.cgi?id=220284&action=diff "Use new libsoup function to get a proxied GIOStream") [[details]](attachment.cgi?id=220284&action=edit "Use new libsoup function to get a proxied GIOStream"))
> View in context: <https://bugs.webkit.org/attachment.cgi?id=220284&action=review>
>
> > WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:-94
> > - if (url.protocolIs("wss"))
> > - g\_socket\_client\_set\_tls(socketClient.get(), TRUE);
>
> Why are you removing this code? Doesn't this break secure web sockets?
I doesn't seem to in my testing. Before my patch, SocketStreamHandles rely on the pretty low-level GSocketClient API. By using more libsoup infrastructure, this kind of thing is handled for us. In this case, I think (but have not verified) that libsoup can figure out from the URL that TLS support is required.
>
> > WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:94
> > + soup\_session\_proxy\_connect(session, uri, connectedCallback, m\_id);
>
> Is this the only change related to proxy support?
Yes, this is the core of the motivating change.
> > WebCore/platform/network/soup/SocketStreamHandleSoup.cpp:238
> > -static void connectedCallback(GSocketClient\* client, GAsyncResult\* result, void\* id)
> > +static void connectedCallback(GIOStream \*iostream, GError \*error, void\* id)
>
> Is the GIOStream here actually a GSocketClient? If so, perhaps it would make more sense to cast it and avoid the rest of your changes.
Probably! IIRC danw suggested the use of GIOStream in the soup\_session\_proxy\_connect() API. It seems to me like maybe GSocketConnection makes more sense there. If not, then casting on the WebKit side would be fine as far as I'm concerned.

Dan Winship

[Comment 7](show_bug.cgi?id=126384#c7)
2014-01-03 07:02:54 PST

(In reply to [comment #5](show_bug.cgi?id=126384#c5))
> Is the GIOStream here actually a GSocketClient? If so, perhaps it would make more sense to cast it and avoid the rest of your changes.
You mean "actually a GSocketConnection". And yes, it is, but the point of returning a GIOStream rather than a GSocketConnection is that you mostly don't care that it's a GSocketConnection specifically. ie, in the current code, every single place in SocketStreamHandleSoup that uses it casts it to a GIOStream first. So it makes more sense to just have it be an iostream.

Dirkjan Ochtman

[Comment 8](show_bug.cgi?id=126384#c8)
2014-01-03 07:46:00 PST

Created [attachment 220303](attachment.cgi?id=220303&action=diff "Version of the patch that applies to recent WebKit SVN") [[details]](attachment.cgi?id=220303&action=edit "Version of the patch that applies to recent WebKit SVN")
Version of the patch that applies to recent WebKit SVN

Silvia Pfeiffer

[Comment 9](show_bug.cgi?id=126384#c9)
2017-08-09 05:41:49 PDT

Corporate networks often have machines behind a Web proxy. Is this bug going to get addressed, so websockets can be used in corporate networks? I'm particularly curious because WebRTC is about to be released in WebKit/Safari and many WebRTC applications use a websocket signalling server.

Carlos Alberto Lopez Perez

[Comment 10](show_bug.cgi?id=126384#c10)
2017-08-09 06:13:19 PDT

(In reply to Silvia Pfeiffer from [comment #9](show_bug.cgi?id=126384#c9))
> Corporate networks often have machines behind a Web proxy. Is this bug going
> to get addressed, so websockets can be used in corporate networks? I'm
> particularly curious because WebRTC is about to be released in WebKit/Safari
> and many WebRTC applications use a websocket signalling server.
The Mac or iOS ports of WebKit (the ones used in Safari) don't use the soup backend for network access. So this bug doesn't affect them.
The libsoup network backend is only used by the GTK+ and WPE ports of WebKit, and WebRTC support on this ports is still a WIP.

Michael Catanzaro

[Comment 11](show_bug.cgi?id=126384#c11)
2017-08-09 08:23:11 PDT

Oh wow, if WebKit's implementation of WebSockets does not respect GNOME's proxy settings, that's very bad. These kinds of bugs are what get people arrested or killed.
Dirkjan, are you still watching your bugmail? Do you know what the status of this is?

Michael Catanzaro

[Comment 12](show_bug.cgi?id=126384#c12)
2017-08-09 08:24:48 PDT

I've also considered if maybe we should be using libsoup's implementation of WebSockets rather than WebKit's implementation. I always assumed that WebKit's implementation was likely to have fewer bugs. Silly me.

Carlos Alberto Lopez Perez

[Comment 13](show_bug.cgi?id=126384#c13)
2017-08-09 09:48:49 PDT

(In reply to Michael Catanzaro from [comment #12](show_bug.cgi?id=126384#c12))
> I've also considered if maybe we should be using libsoup's implementation of
> WebSockets rather than WebKit's implementation. I always assumed that
> WebKit's implementation was likely to have fewer bugs. Silly me.
Do you know something about the quality of the libsoup WebSocket implementation and/or about any project that uses it?
Keep in mind \_any\_ implementation is going to have bugs.

Dan Winship

[Comment 14](show_bug.cgi?id=126384#c14)
2017-08-09 11:02:23 PDT

(In reply to Carlos Alberto Lopez Perez from [comment #13](show_bug.cgi?id=126384#c13))
> (In reply to Michael Catanzaro from [comment #12](show_bug.cgi?id=126384#c12))
> > I've also considered if maybe we should be using libsoup's implementation of
> > WebSockets rather than WebKit's implementation. I always assumed that
> > WebKit's implementation was likely to have fewer bugs. Silly me.
(Of course, this bug predates libsoup's WebSockets implementation.)
> Do you know something about the quality of the libsoup WebSocket
> implementation and/or about any project that uses it?
> Keep in mind \_any\_ implementation is going to have bugs.
The actual WebSockets implementation isn't all that complicated. The code for letting SoupSession make a (possibly-proxied) connection to a server, and then stealing that GIOStream from SoupSession to use as a websockets connection is kind of tricky, but of course, that's exactly the code that the patch here makes use of, so you'd be using it either way. (Well, the patch here is written against Dirkjan's original proposal that isn't quite how things eventually got implemented, but it would be similar.)
Anyway, a handful of people are using libsoup's websockets code now, (and it was originally based on cockpit's code that had been in use for a few years before that). And I assume WebKit has some WebSockets tests anyway that would validate that it was good enough for WebKit purposes?

Carlos Garcia Campos

[Comment 15](show_bug.cgi?id=126384#c15)
2017-08-10 04:14:10 PDT

(In reply to Dan Winship from [comment #14](show_bug.cgi?id=126384#c14))
> (In reply to Carlos Alberto Lopez Perez from [comment #13](show_bug.cgi?id=126384#c13))
> > (In reply to Michael Catanzaro from [comment #12](show_bug.cgi?id=126384#c12))
> > > I've also considered if maybe we should be using libsoup's implementation of
> > > WebSockets rather than WebKit's implementation. I always assumed that
> > > WebKit's implementation was likely to have fewer bugs. Silly me.
>
> (Of course, this bug predates libsoup's WebSockets implementation.)
Yes, that's why we don't use the libsoup one, not because it's more or less buggy, we always prefer to use libsoup (well, except in the case of the disk cache, because the webkit implementation is much better and shared with all other ports).
> > Do you know something about the quality of the libsoup WebSocket
> > implementation and/or about any project that uses it?
> > Keep in mind \_any\_ implementation is going to have bugs.
>
> The actual WebSockets implementation isn't all that complicated. The code
> for letting SoupSession make a (possibly-proxied) connection to a server,
> and then stealing that GIOStream from SoupSession to use as a websockets
> connection is kind of tricky, but of course, that's exactly the code that
> the patch here makes use of, so you'd be using it either way. (Well, the
> patch here is written against Dirkjan's original proposal that isn't quite
> how things eventually got implemented, but it would be similar.)
>
> Anyway, a handful of people are using libsoup's websockets code now, (and it
> was originally based on cockpit's code that had been in use for a few years
> before that). And I assume WebKit has some WebSockets tests anyway that
> would validate that it was good enough for WebKit purposes?
WebSockets were added to libsoup in 2.50, IIRC, and we depend on 2.40, so we still need to fix our implementation. Then we can use libsoup, but we will have to use ifdefs.

Dirkjan Ochtman

[Comment 16](show_bug.cgi?id=126384#c16)
2017-08-10 04:29:29 PDT

Michael: yeah, I'm still reading my bug mail.
We've had this working in our internal WebKit fork, based on an also-forked libsoup pinned to somewhere 2.45ish. If there's interest I can try to dig out our patches.

Michael Catanzaro

[Comment 17](show_bug.cgi?id=126384#c17)
2017-08-10 08:19:36 PDT

Yes we're definitely interested, thanks.

Dirkjan Ochtman

[Comment 18](show_bug.cgi?id=126384#c18)
2017-11-17 02:30:46 PST

Created [attachment 327158](attachment.cgi?id=327158 "WebKit patches for libsoup WebSockets over proxy") [[details]](attachment.cgi?id=327158&action=edit "WebKit patches for libsoup WebSockets over proxy")
WebKit patches for libsoup WebSockets over proxy

Dirkjan Ochtman

[Comment 19](show_bug.cgi?id=126384#c19)
2017-11-17 02:31:11 PST

Created [attachment 327159](attachment.cgi?id=327159 "libsoup patches for libsoup WebSockets over proxy") [[details]](attachment.cgi?id=327159&action=edit "libsoup patches for libsoup WebSockets over proxy")
libsoup patches for libsoup WebSockets over proxy

Dirkjan Ochtman

[Comment 20](show_bug.cgi?id=126384#c20)
2017-11-17 02:31:58 PST

I made a quick attempt at extracting the relevant patches from our libsoup and WebKit repositories. Hope this helps. If you have questions or something seems missing, let me know and I can have another look.

Claudio Saavedra

[Comment 21](show_bug.cgi?id=126384#c21)
2017-11-20 07:11:43 PST

Would you mind submitting the libsoup patches to GNOME bugzilla? Please use separate bug reports if they tackle different issues, as it seems to be the case, then we can see about getting them reviewed and in.

Dirkjan Ochtman

[Comment 22](show_bug.cgi?id=126384#c22)
2017-11-20 11:03:14 PST

See also the libsoup bug mentioned in [comment 1](show_bug.cgi?id=126384#c1). I have no further desire to chase these issues, so I'll leave any new work in creating libsoup bugs to others.

Carlos Garcia Campos

[Comment 23](show_bug.cgi?id=126384#c23)
2018-01-03 04:45:26 PST

If we need new libsoup API in both cases, then I think it's better to keep current impl for older soup versions and use soup web sockets for newer versions then.

Carlos Garcia Campos

[Comment 24](show_bug.cgi?id=126384#c24)
2018-01-04 01:06:12 PST

I've looked at this and we can't really use the libsoup websockets API, because WebKit already implements websockets protocol, the only platform specific part is creating a network connection to send and receive data from. That's lower level than the libsoup websockets API. We can't use soup\_session\_steal\_connection() either, because you are expected to steal the connection when upgrading the protocol once 101 response is returned from the server. However, we need the connection before to properly send the upgrade message. So, we indeed need new API in libsoup to create a connection using ssl and proxy as with any other HTTP connection, but returning the GIOStream for the socket \*before\* any data is sent.

Carlos Garcia Campos

[Comment 25](show_bug.cgi?id=126384#c25)
2018-01-04 01:07:18 PST

Dirkjan, why do you need to force the tunneling in libsoup when creating a connection for the websockets?

Carlos Garcia Campos

[Comment 26](show_bug.cgi?id=126384#c26)
2018-01-05 00:15:53 PST

Created [attachment 330537](attachment.cgi?id=330537&action=diff "Patch") [[details]](attachment.cgi?id=330537&action=edit "Patch")
Patch

Michael Catanzaro

[Comment 27](show_bug.cgi?id=126384#c27)
2018-01-05 12:49:20 PST

Comment on [attachment 330537](attachment.cgi?id=330537&action=diff "Patch") [[details]](attachment.cgi?id=330537&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=330537&action=review>
Thanks for fixing this exceptionally serious issue.
We definitely need to request a CVE. I can handle that.
How hard would it be to extend testWebContextProxySettings in TestWebKitWebContext.cpp to test this?
> Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp:58
> +#if SOUP\_CHECK\_VERSION(2, 61, 2)
I see a few different options here:
(a) We could stick with what you implemented. But I suggest we do not allow web socket connections to ignore proxy settings under any circumstances, certainly not just because libsoup is too old.
(b) We could ignore our usual dependency policy and require newer libsoup. This would be justified by the severity of this issue. We'd have to send a notice and apology to distributors-list and inform them of the need to update libsoup. Debian would probably refuse. Not great.
(c) We could disable WebSocket support if libsoup is not new enough. This will break loads of websites.
(d) We could disable WebSocket support if libsoup is not new enough \*and\* a system proxy is configured. Websites only break if a proxy is configured.
(d) seems like the best approach to me. What do you think? If we go with (a) or (b) or (c), then we'll certainly need to be backport your new API to libsoup 2.60. But I'm OK with temporarily breaking web sockets for proxy users, so we wouldn't need to do that if we take approach (d).

Carlos Garcia Campos

[Comment 28](show_bug.cgi?id=126384#c28)
2018-01-08 04:28:46 PST

Created [attachment 330682](attachment.cgi?id=330682&action=diff "Patch with unit tests") [[details]](attachment.cgi?id=330682&action=edit "Patch with unit tests")
Patch with unit tests

Carlos Garcia Campos

[Comment 29](show_bug.cgi?id=126384#c29)
2018-01-08 04:30:45 PST

(In reply to Michael Catanzaro from [comment #27](show_bug.cgi?id=126384#c27))
> Comment on [attachment 330537](attachment.cgi?id=330537&action=diff "Patch") [[details]](attachment.cgi?id=330537&action=edit "Patch")
> Patch
>
> View in context:
> <https://bugs.webkit.org/attachment.cgi?id=330537&action=review>
>
> Thanks for fixing this exceptionally serious issue.
>
> We definitely need to request a CVE. I can handle that.
>
> How hard would it be to extend testWebContextProxySettings in
> TestWebKitWebContext.cpp to test this?
>
> > Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp:58
> > +#if SOUP\_CHECK\_VERSION(2, 61, 2)
>
> I see a few different options here:
>
> (a) We could stick with what you implemented. But I suggest we do not allow
> web socket connections to ignore proxy settings under any circumstances,
> certainly not just because libsoup is too old.
> (b) We could ignore our usual dependency policy and require newer libsoup.
> This would be justified by the severity of this issue. We'd have to send a
> notice and apology to distributors-list and inform them of the need to
> update libsoup. Debian would probably refuse. Not great.
> (c) We could disable WebSocket support if libsoup is not new enough. This
> will break loads of websites.
> (d) We could disable WebSocket support if libsoup is not new enough \*and\* a
> system proxy is configured. Websites only break if a proxy is configured.
>
> (d) seems like the best approach to me. What do you think? If we go with (a)
> or (b) or (c), then we'll certainly need to be backport your new API to
> libsoup 2.60. But I'm OK with temporarily breaking web sockets for proxy
> users, so we wouldn't need to do that if we take approach (d).
I don't think we should backport any new API to libsoup stable branches. I'm not sure it's possible to do d) either, there might be proxy settings that are acceptable, for example if the websockets host used is blacklisted, or if only https proxy is used. We would need to check the actual proxy settings to decide whether to allow the websocket connection or not.

Michael Catanzaro

[Comment 30](show_bug.cgi?id=126384#c30)
2018-01-08 09:00:58 PST

(In reply to Carlos Garcia Campos from [comment #29](show_bug.cgi?id=126384#c29))
> I don't think we should backport any new API to libsoup stable branches. I'm
> not sure it's possible to do d) either, there might be proxy settings that
> are acceptable,
We should fail safe: assume that if the user has set a proxy, no WebSockets connection should ever be attempted.
> for example if the websockets host used is blacklisted,
OK, in that case it really would be safe, but that seems like a very unlikely configuration. Since this is only a fallback codepath, I would not worry about this unlikely case at all.
> or
> if only https proxy is used.
Another odd case... in that case, wss sockets should still use the https proxy settings, but I guess it's not very much of a privacy issue if no http proxy is set. I suppose it would make sense to block use of ws WebSockets only when an http proxy is set, and to block wss WebSockets only when an https proxy is set.
> We would need to check the actual proxy
> settings to decide whether to allow the websocket connection or not.
We certainly need to check the proxy settings, but I don't think it's important to do as thorough checks as you propose. The question is: how hard is it to check the proxy settings from WebCore/platform? We really should.

Michael Catanzaro

[Comment 31](show_bug.cgi?id=126384#c31)
2018-01-08 09:19:41 PST

Comment on [attachment 330682](attachment.cgi?id=330682&action=diff "Patch with unit tests") [[details]](attachment.cgi?id=330682&action=edit "Patch with unit tests")
Patch with unit tests
View in context: <https://bugs.webkit.org/attachment.cgi?id=330682&action=review>
r=me because I can't find any problems with the code, and I like the new test. But I'm still concerned about not blocking WebSocket connections when a proxy is in use in the fallback codepath.
> Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp:700
> + void webSockedConnected(WebSocketServerType serverType)
webSocketConnected
> Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:56
> +#if SOUP\_CHECK\_VERSION(2, 50, 0)
Why do we switch to (2, 50, 0) here? What requires libsoup 2.50.0?
> Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:117
> + soup\_uri\_free(uri);
Why are you not able to use GUniquePtr<SoupURI>?
> Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h:55
> + SoupURI\* m\_baseURI { nullptr };
> +#if SOUP\_CHECK\_VERSION(2, 50, 0)
> + SoupURI\* m\_baseWebSocketURI { nullptr };
> +#endif
I'd convert these to use GUniquePtr.

Carlos Garcia Campos

[Comment 32](show_bug.cgi?id=126384#c32)
2018-01-09 00:26:51 PST

(In reply to Michael Catanzaro from [comment #31](show_bug.cgi?id=126384#c31))
> Comment on [attachment 330682](attachment.cgi?id=330682&action=diff "Patch with unit tests") [[details]](attachment.cgi?id=330682&action=edit "Patch with unit tests")
> Patch with unit tests
>
> View in context:
> <https://bugs.webkit.org/attachment.cgi?id=330682&action=review>
>
> r=me because I can't find any problems with the code, and I like the new
> test. But I'm still concerned about not blocking WebSocket connections when
> a proxy is in use in the fallback codepath.
>
> > Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp:700
> > + void webSockedConnected(WebSocketServerType serverType)
>
> webSocketConnected
Oops.
> > Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:56
> > +#if SOUP\_CHECK\_VERSION(2, 50, 0)
>
> Why do we switch to (2, 50, 0) here? What requires libsoup 2.50.0?
Because this is generic code, not specific to the web sockets over proxy tests, even if it's only used by that test ATM. WebSockets API used in WebKitTestServer was added in libsoup 2.50
> > Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:117
> > + soup\_uri\_free(uri);
>
> Why are you not able to use GUniquePtr<SoupURI>?
Because the unit tests don't use WebCore, only the public API and WTF. Soup smart pointers are defined in WebCore, because WTF doesn't depend on soup.
> > Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h:55
> > + SoupURI\* m\_baseURI { nullptr };
> > +#if SOUP\_CHECK\_VERSION(2, 50, 0)
> > + SoupURI\* m\_baseWebSocketURI { nullptr };
> > +#endif
>
> I'd convert these to use GUniquePtr.
It's not possible.

Carlos Garcia Campos

[Comment 33](show_bug.cgi?id=126384#c33)
2018-01-09 08:50:02 PST

libsoup 2.61.2 has been released so I'll have to update the ifdefs.

Carlos Garcia Campos

[Comment 34](show_bug.cgi?id=126384#c34)
2018-02-05 01:02:35 PST

Committed [r228088](https://commits.webkit.org/r228088): <<https://trac.webkit.org/changeset/228088>>

Note
You need to
[log in](show_bug.cgi?id=126384&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P1

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Critical

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 528+ (Nightly build) |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |WebKitGTK

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Nobody

Reported

2014-01-02 08:11 PST

Modified

2018-06-04 08:09 PDT
[History](show_activity.cgi?id=126384)

CC List

9
users
Show

bugs-noreply
cgarcia
clopez
csaavedra
danw
gustavo
mcatanzaro
silviapf
svillar

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

* <https://bugzilla.gnome.org/show_bug.cgi?id=792212>
* [CVE-2018-11712](show_bug.cgi?id=184804 "RESOLVED FIXED - REGRESSION(r228088): [SOUP] Certificate verification no longer performed for secure WebSocket connections")

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |CVE-2018-11713

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=126384)
* [XML](show_bug.cgi?ctype=xml&id=126384)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=126384)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)


