=== Content from security.gentoo.org_3a36c01d_20250125_193757.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# WebkitGTK+: Multiple vulnerabilities — GLSA **201808-04**

Multiple vulnerabilities have been found in WebKitGTK+, the worst
of which may lead to arbitrary code execution.

### Affected packages

| Package | **net-libs/webkit-gtk** on all architectures |
| --- | --- |
| Affected versions | < **2.20.4** |
| Unaffected versions | >= **2.20.4** |

### Background

WebKitGTK+ is a full-featured port of the WebKit rendering engine,
suitable for projects requiring any kind of web integration, from hybrid
HTML/CSS applications to full-fledged web browsers.

### Description

Multiple vulnerabilities have been discovered in WebKitGTK+. Please
review the referenced CVE identifiers for details.

### Impact

A remote attacker could execute arbitrary commands or cause a denial of
service condition via a maliciously crafted web content.

### Workaround

There is no known workaround at this time.

### Resolution

All WebkitGTK+ users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=net-libs/webkit-gtk-2.20.4"

```
### References

* [CVE-2018-11646](https://nvd.nist.gov/vuln/detail/CVE-2018-11646)
* [CVE-2018-11712](https://nvd.nist.gov/vuln/detail/CVE-2018-11712)
* [CVE-2018-11713](https://nvd.nist.gov/vuln/detail/CVE-2018-11713)
* [CVE-2018-12293](https://nvd.nist.gov/vuln/detail/CVE-2018-12293)
* [CVE-2018-12294](https://nvd.nist.gov/vuln/detail/CVE-2018-12294)
* [CVE-2018-4101](https://nvd.nist.gov/vuln/detail/CVE-2018-4101)
* [CVE-2018-4113](https://nvd.nist.gov/vuln/detail/CVE-2018-4113)
* [CVE-2018-4114](https://nvd.nist.gov/vuln/detail/CVE-2018-4114)
* [CVE-2018-4117](https://nvd.nist.gov/vuln/detail/CVE-2018-4117)
* [CVE-2018-4118](https://nvd.nist.gov/vuln/detail/CVE-2018-4118)
* [CVE-2018-4119](https://nvd.nist.gov/vuln/detail/CVE-2018-4119)
* [CVE-2018-4120](https://nvd.nist.gov/vuln/detail/CVE-2018-4120)
* [CVE-2018-4121](https://nvd.nist.gov/vuln/detail/CVE-2018-4121)
* [CVE-2018-4122](https://nvd.nist.gov/vuln/detail/CVE-2018-4122)
* [CVE-2018-4125](https://nvd.nist.gov/vuln/detail/CVE-2018-4125)
* [CVE-2018-4127](https://nvd.nist.gov/vuln/detail/CVE-2018-4127)
* [CVE-2018-4128](https://nvd.nist.gov/vuln/detail/CVE-2018-4128)
* [CVE-2018-4129](https://nvd.nist.gov/vuln/detail/CVE-2018-4129)
* [CVE-2018-4133](https://nvd.nist.gov/vuln/detail/CVE-2018-4133)
* [CVE-2018-4146](https://nvd.nist.gov/vuln/detail/CVE-2018-4146)
* [CVE-2018-4162](https://nvd.nist.gov/vuln/detail/CVE-2018-4162)
* [CVE-2018-4163](https://nvd.nist.gov/vuln/detail/CVE-2018-4163)
* [CVE-2018-4165](https://nvd.nist.gov/vuln/detail/CVE-2018-4165)
* [CVE-2018-4190](https://nvd.nist.gov/vuln/detail/CVE-2018-4190)
* [CVE-2018-4192](https://nvd.nist.gov/vuln/detail/CVE-2018-4192)
* [CVE-2018-4199](https://nvd.nist.gov/vuln/detail/CVE-2018-4199)
* [CVE-2018-4200](https://nvd.nist.gov/vuln/detail/CVE-2018-4200)
* [CVE-2018-4201](https://nvd.nist.gov/vuln/detail/CVE-2018-4201)
* [CVE-2018-4204](https://nvd.nist.gov/vuln/detail/CVE-2018-4204)
* [CVE-2018-4214](https://nvd.nist.gov/vuln/detail/CVE-2018-4214)
* [CVE-2018-4218](https://nvd.nist.gov/vuln/detail/CVE-2018-4218)
* [CVE-2018-4222](https://nvd.nist.gov/vuln/detail/CVE-2018-4222)
* [CVE-2018-4232](https://nvd.nist.gov/vuln/detail/CVE-2018-4232)
* [CVE-2018-4233](https://nvd.nist.gov/vuln/detail/CVE-2018-4233)
* [CVE-2018-4261](https://nvd.nist.gov/vuln/detail/CVE-2018-4261)
* [CVE-2018-4262](https://nvd.nist.gov/vuln/detail/CVE-2018-4262)
* [CVE-2018-4263](https://nvd.nist.gov/vuln/detail/CVE-2018-4263)
* [CVE-2018-4264](https://nvd.nist.gov/vuln/detail/CVE-2018-4264)
* [CVE-2018-4265](https://nvd.nist.gov/vuln/detail/CVE-2018-4265)
* [CVE-2018-4266](https://nvd.nist.gov/vuln/detail/CVE-2018-4266)
* [CVE-2018-4267](https://nvd.nist.gov/vuln/detail/CVE-2018-4267)
* [CVE-2018-4270](https://nvd.nist.gov/vuln/detail/CVE-2018-4270)
* [CVE-2018-4272](https://nvd.nist.gov/vuln/detail/CVE-2018-4272)
* [CVE-2018-4273](https://nvd.nist.gov/vuln/detail/CVE-2018-4273)
* [CVE-2018-4278](https://nvd.nist.gov/vuln/detail/CVE-2018-4278)
* [CVE-2018-4284](https://nvd.nist.gov/vuln/detail/CVE-2018-4284)
* [WebKitGTK+
  Security Advisory WSA-2018-0003](https://webkitgtk.org/security/WSA-2018-0003.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0004](https://webkitgtk.org/security/WSA-2018-0004.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0005](https://webkitgtk.org/security/WSA-2018-0005.html)
* [WebKitGTK+
  Security Advisory WSA-2018-0006](https://webkitgtk.org/security/WSA-2018-0006.html)

**Release date**

August 22, 2018

**Latest revision**

August 22, 2018: 1

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [652820](https://bugs.gentoo.org/show_bug.cgi?id=652820)
* [658168](https://bugs.gentoo.org/show_bug.cgi?id=658168)
* [662974](https://bugs.gentoo.org/show_bug.cgi?id=662974)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from commits.webkit.org_b9f2e410_20250126_112424.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWebKit%2FWebKit%2Fcommit%2F8693647417d99e91b348b79abcb488acd432c565)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWebKit%2FWebKit%2Fcommit%2F8693647417d99e91b348b79abcb488acd432c565)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=WebKit%2FWebKit)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[WebKit](/WebKit)
/
**[WebKit](/WebKit/WebKit)**
Public

* [Notifications](/login?return_to=%2FWebKit%2FWebKit) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2FWebKit%2FWebKit)
* [Star
   8.3k](/login?return_to=%2FWebKit%2FWebKit)

* [Code](/WebKit/WebKit)
* [Pull requests
  1.2k](/WebKit/WebKit/pulls)
* [Actions](/WebKit/WebKit/actions)
* [Wiki](/WebKit/WebKit/wiki)
* [Security](/WebKit/WebKit/security)
* [Insights](/WebKit/WebKit/pulse)

Additional navigation options

* [Code](/WebKit/WebKit)
* [Pull requests](/WebKit/WebKit/pulls)
* [Actions](/WebKit/WebKit/actions)
* [Wiki](/WebKit/WebKit/wiki)
* [Security](/WebKit/WebKit/security)
* [Insights](/WebKit/WebKit/pulse)

## Commit

[Permalink](/WebKit/WebKit/commit/8693647417d99e91b348b79abcb488acd432c565)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[SOUP] WebSockets must use system proxy settings

[Browse files](/WebKit/WebKit/tree/8693647417d99e91b348b79abcb488acd432c565)
Browse the repository at this point in the history

```
<https://bugs.webkit.org/show_bug.cgi?id=126384>

Reviewed by Michael Catanzaro.

Source/WebCore:

Use soup_session_connect_async() when available to create the WebSockets connection instead of GSocketClient
directly.

* platform/network/soup/SocketStreamHandleImpl.h:
* platform/network/soup/SocketStreamHandleImplSoup.cpp:
(WebCore::wssSocketClientEventCallback):
(WebCore::SocketStreamHandleImpl::create):
(WebCore::SocketStreamHandleImpl::connected):
(WebCore::SocketStreamHandleImpl::connectedCallback):
(WebCore::SocketStreamHandleImpl::platformClose):

Tools:

Check also WebSockets in /webkit2/WebKitWebContext/proxy.

* TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp:
(ProxyTest::webSocketProxyServerCallback):
(ProxyTest::ProxyTest):
(ProxyTest::webSocketConnected):
(ProxyTest::createWebSocketAndWaitUntilConnected):
(webSocketServerCallback):
(testWebContextProxySettings):
* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp:
(WebKitTestServer::~WebKitTestServer):
(WebKitTestServer::addWebSocketHandler):
(WebKitTestServer::removeWebSocketHandler):
(WebKitTestServer::getWebSocketURIForPath const):
(WebKitTestServer::getURIForPath const):
* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h:
(WebKitTestServer::baseURI const):
(WebKitTestServer::baseWebSocketURI const):

Canonical link: [https://commits.webkit.org/198272@main](https://commits.webkit.org/198272%40main)
git-svn-id: [https://svn.webkit.org/repository/webkit/trunk@228088](https://svn.webkit.org/repository/webkit/trunk%40228088) 268f45cc-cd09-0410-ab3c-d52691b4dbfc
```

* Loading branch information

[![@carlosgcampos](https://avatars.githubusercontent.com/u/5434964?s=40&v=4)](/carlosgcampos)

[carlosgcampos](/WebKit/WebKit/commits?author=carlosgcampos "View all commits by carlosgcampos")
committed
Feb 5, 2018

1 parent
[8166ca9](/WebKit/WebKit/commit/8166ca9a2ce4491fccdce072321063eca2ce690a)

commit 8693647

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**212 additions**
and
**37 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Source/WebCore

  + Source/WebCore/ChangeLog
    [ChangeLog](#diff-9fb71b6fa7156160059b0216d05933e621d422df2b20f72ad7399eb946b8ba04)
  + platform/network/soup

    - Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h
      [SocketStreamHandleImpl.h](#diff-16ca8aa825cc20927a57976752cd06ad783df141b97b218ea1b78b88aee211d2)
    - Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp
      [SocketStreamHandleImplSoup.cpp](#diff-4a8339ac33cf2d0ed2a9a2d5c625842c733165121806560b6e91284e99eda119)
* Tools

  + Tools/ChangeLog
    [ChangeLog](#diff-52b760e714d9159c5ac05eaee1055c44df68cee453c98b72778d2bff840402cc)
  + TestWebKitAPI

    - Tests/WebKitGLib

      * Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp
        [TestWebKitWebContext.cpp](#diff-70e0772d9c7f80f6b88fe719f158fb83e6f48f9cb8e3e1d24bbccb8f6c33bd15)
    - glib/WebKitGLib

      * Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp
        [WebKitTestServer.cpp](#diff-df350c82f0d347974ce52413171e94c8fe969fcadab792c8f6158ffb9f211b2e)
      * Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h
        [WebKitTestServer.h](#diff-c859a2fe68959e812144e2c16ee7d1a15af395f2887be2de81c7a2f5d8c4591c)

## There are no files selected for viewing

18 changes: 18 additions & 0 deletions

18
[Source/WebCore/ChangeLog](#diff-9fb71b6fa7156160059b0216d05933e621d422df2b20f72ad7399eb946b8ba04 "Source/WebCore/ChangeLog")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Source/WebCore/ChangeLog)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,21 @@ |
|  |  | 2018-02-05 Carlos Garcia Campos <cgarcia@igalia.com> |
|  |  |  |
|  |  | [SOUP] WebSockets must use system proxy settings |
|  |  | https://bugs.webkit.org/show\_bug.cgi?id=126384 |
|  |  |  |
|  |  | Reviewed by Michael Catanzaro. |
|  |  |  |
|  |  | Use soup\_session\_connect\_async() when available to create the WebSockets connection instead of GSocketClient |
|  |  | directly. |
|  |  |  |
|  |  | \* platform/network/soup/SocketStreamHandleImpl.h: |
|  |  | \* platform/network/soup/SocketStreamHandleImplSoup.cpp: |
|  |  | (WebCore::wssSocketClientEventCallback): |
|  |  | (WebCore::SocketStreamHandleImpl::create): |
|  |  | (WebCore::SocketStreamHandleImpl::connected): |
|  |  | (WebCore::SocketStreamHandleImpl::connectedCallback): |
|  |  | (WebCore::SocketStreamHandleImpl::platformClose): |
|  |  |  |
|  |  | 2018-02-05 Carlos Garcia Campos <cgarcia@igalia.com> |
|  |  |  |
|  |  | Add a way to check if a host is an IP address |
| Expand Down | |  |

8 changes: 3 additions & 5 deletions

8
[Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h](#diff-16ca8aa825cc20927a57976752cd06ad783df141b97b218ea1b78b88aee211d2 "Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -48,8 +48,6 @@ class SocketStreamHandleClient; |
|  |  | class SocketStreamHandleImpl final : public SocketStreamHandle { |
|  |  | public: |
|  |  | static Ref<SocketStreamHandleImpl> create(const URL&, SocketStreamHandleClient&, PAL::SessionID, const String&, SourceApplicationAuditToken&&); |
|  |  | static Ref<SocketStreamHandle> create(GSocketConnection\*, SocketStreamHandleClient&); |
|  |  |  |
|  |  | virtual ~SocketStreamHandleImpl(); |
|  |  |  |
|  |  | void platformSend(const char\* data, size\_t length, Function<void(bool)>&&) final; |
| Expand All | | @@ -64,16 +62,16 @@ class SocketStreamHandleImpl final : public SocketStreamHandle { |
|  |  | void beginWaitingForSocketWritability(); |
|  |  | void stopWaitingForSocketWritability(); |
|  |  |  |
|  |  | static void connectedCallback(GSocketClient\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
|  |  | static void connectedCallback(GObject\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
|  |  | static void readReadyCallback(GInputStream\*, GAsyncResult\*, SocketStreamHandleImpl\*); |
|  |  | static gboolean writeReadyCallback(GPollableOutputStream\*, SocketStreamHandleImpl\*); |
|  |  |  |
|  |  | void connected(GRefPtr<GSocketConnection>&&); |
|  |  | void connected(GRefPtr<GIOStream>&&); |
|  |  | void readBytes(gssize); |
|  |  | void didFail(SocketStreamError&&); |
|  |  | void writeReady(); |
|  |  |  |
|  |  | GRefPtr<GSocketConnection> m\_socketConnection; |
|  |  | GRefPtr<GIOStream> m\_stream; |
|  |  | GRefPtr<GInputStream> m\_inputStream; |
|  |  | GRefPtr<GPollableOutputStream> m\_outputStream; |
|  |  | GRefPtr<GSource> m\_writeReadySource; |
| Expand Down | |  |

73 changes: 47 additions & 26 deletions

73
[Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp](#diff-4a8339ac33cf2d0ed2a9a2d5c625842c733165121806560b6e91284e99eda119 "Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -55,39 +55,56 @@ static gboolean wssConnectionAcceptCertificateCallback(GTlsConnection\*, GTlsCert |
|  |  | return TRUE; |
|  |  | } |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | static void wssSocketClientEventCallback(SoupSession\*, GSocketClientEvent event, GIOStream\* connection) |
|  |  | { |
|  |  | if (event != G\_SOCKET\_CLIENT\_TLS\_HANDSHAKING) |
|  |  | return; |
|  |  |  |
|  |  | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(wssConnectionAcceptCertificateCallback), nullptr); |
|  |  | } |
|  |  | #else |
|  |  | static void wssSocketClientEventCallback(GSocketClient\*, GSocketClientEvent event, GSocketConnectable\*, GIOStream\* connection) |
|  |  | { |
|  |  | if (event != G\_SOCKET\_CLIENT\_TLS\_HANDSHAKING) |
|  |  | return; |
|  |  |  |
|  |  | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(wssConnectionAcceptCertificateCallback), nullptr); |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | Ref<SocketStreamHandleImpl> SocketStreamHandleImpl::create(const URL& url, SocketStreamHandleClient& client, PAL::SessionID, const String&, SourceApplicationAuditToken&&) |
|  |  | Ref<SocketStreamHandleImpl> SocketStreamHandleImpl::create(const URL& url, SocketStreamHandleClient& client, PAL::SessionID sessionID, const String&, SourceApplicationAuditToken&&) |
|  |  | { |
|  |  | Ref<SocketStreamHandleImpl> socket = adoptRef(\*new SocketStreamHandleImpl(url, client)); |
|  |  |  |
|  |  | // FIXME: Using DeprecatedGlobalSettings from here is a layering violation. |
|  |  | bool allowsAnySSLCertificate = url.protocolIs("wss") && DeprecatedGlobalSettings::allowsAnySSLCertificate(); |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | auto\* networkStorageSession = NetworkStorageSession::storageSession(sessionID); |
|  |  | if (!networkStorageSession) |
|  |  | return socket; |
|  |  |  |
|  |  | auto uri = url.createSoupURI(); |
|  |  | Ref<SocketStreamHandle> protectedSocketStreamHandle = socket.copyRef(); |
|  |  | soup\_session\_connect\_async(networkStorageSession->getOrCreateSoupNetworkSession().soupSession(), uri.get(), socket->m\_cancellable.get(), |
|  |  | allowsAnySSLCertificate ? reinterpret\_cast<SoupSessionConnectProgressCallback>(wssSocketClientEventCallback) : nullptr, |
|  |  | reinterpret\_cast<GAsyncReadyCallback>(connectedCallback), &protectedSocketStreamHandle.leakRef()); |
|  |  | #else |
|  |  | UNUSED\_PARAM(sessionID); |
|  |  | unsigned port = url.port() ? url.port().value() : (url.protocolIs("wss") ? 443 : 80); |
|  |  | GRefPtr<GSocketClient> socketClient = adoptGRef(g\_socket\_client\_new()); |
|  |  | if (url.protocolIs("wss")) { |
|  |  | g\_socket\_client\_set\_tls(socketClient.get(), TRUE); |
|  |  | // FIXME: Using DeprecatedGlobalSettings from here is a layering violation. |
|  |  | if (DeprecatedGlobalSettings::allowsAnySSLCertificate()) |
|  |  | if (allowsAnySSLCertificate) |
|  |  | g\_signal\_connect(socketClient.get(), "event", G\_CALLBACK(wssSocketClientEventCallback), nullptr); |
|  |  | } |
|  |  | Ref<SocketStreamHandle> protectedSocketStreamHandle = socket.copyRef(); |
|  |  | g\_socket\_client\_connect\_to\_host\_async(socketClient.get(), url.host().utf8().data(), port, socket->m\_cancellable.get(), |
|  |  | reinterpret\_cast<GAsyncReadyCallback>(connectedCallback), &protectedSocketStreamHandle.leakRef()); |
|  |  | return socket; |
|  |  | } |
|  |  |  |
|  |  | Ref<SocketStreamHandle> SocketStreamHandleImpl::create(GSocketConnection\* socketConnection, SocketStreamHandleClient& client) |
|  |  | { |
|  |  | Ref<SocketStreamHandleImpl> socket = adoptRef(\*new SocketStreamHandleImpl(URL(), client)); |
|  |  | #endif |
|  |  |  |
|  |  | GRefPtr<GSocketConnection> connection = socketConnection; |
|  |  | socket->connected(WTFMove(connection)); |
|  |  | return WTFMove(socket); |
|  |  | return socket; |
|  |  | } |
|  |  |  |
|  |  | SocketStreamHandleImpl::SocketStreamHandleImpl(const URL& url, SocketStreamHandleClient& client) |
| Expand All | | @@ -102,11 +119,11 @@ SocketStreamHandleImpl::~SocketStreamHandleImpl() |
|  |  | LOG(Network, "SocketStreamHandle %p delete", this); |
|  |  | } |
|  |  |  |
|  |  | void SocketStreamHandleImpl::connected(GRefPtr<GSocketConnection>&& socketConnection) |
|  |  | void SocketStreamHandleImpl::connected(GRefPtr<GIOStream>&& stream) |
|  |  | { |
|  |  | m\_socketConnection = WTFMove(socketConnection); |
|  |  | m\_outputStream = G\_POLLABLE\_OUTPUT\_STREAM(g\_io\_stream\_get\_output\_stream(G\_IO\_STREAM(m\_socketConnection.get()))); |
|  |  | m\_inputStream = g\_io\_stream\_get\_input\_stream(G\_IO\_STREAM(m\_socketConnection.get())); |
|  |  | m\_stream = WTFMove(stream); |
|  |  | m\_outputStream = G\_POLLABLE\_OUTPUT\_STREAM(g\_io\_stream\_get\_output\_stream(m\_stream.get())); |
|  |  | m\_inputStream = g\_io\_stream\_get\_input\_stream(m\_stream.get()); |
|  |  | m\_readBuffer = std::make\_unique<char[]>(READ\_BUFFER\_SIZE); |
|  |  |  |
|  |  | RefPtr<SocketStreamHandleImpl> protectedThis(this); |
| Expand All | | @@ -117,25 +134,29 @@ void SocketStreamHandleImpl::connected(GRefPtr<GSocketConnection>&& socketConnec |
|  |  | m\_client.didOpenSocketStream(\*this); |
|  |  | } |
|  |  |  |
|  |  | void SocketStreamHandleImpl::connectedCallback(GSocketClient\* client, GAsyncResult\* result, SocketStreamHandleImpl\* handle) |
|  |  | void SocketStreamHandleImpl::connectedCallback(GObject\* object, GAsyncResult\* result, SocketStreamHandleImpl\* handle) |
|  |  | { |
|  |  | RefPtr<SocketStreamHandle> protectedThis = adoptRef(handle); |
|  |  |  |
|  |  | // Always finish the connection, even if this SocketStreamHandle was cancelled earlier. |
|  |  | GUniqueOutPtr<GError> error; |
|  |  | GRefPtr<GSocketConnection> socketConnection = adoptGRef(g\_socket\_client\_connect\_to\_host\_finish(client, result, &error.outPtr())); |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | GRefPtr<GIOStream> stream = adoptGRef(soup\_session\_connect\_finish(SOUP\_SESSION(object), result, &error.outPtr())); |
|  |  | #else |
|  |  | GRefPtr<GIOStream> stream = adoptGRef(G\_IO\_STREAM(g\_socket\_client\_connect\_to\_host\_finish(G\_SOCKET\_CLIENT(object), result, &error.outPtr()))); |
|  |  | #endif |
|  |  |  |
|  |  | // The SocketStreamHandle has been cancelled, so just close the connection, ignoring errors. |
|  |  | if (g\_cancellable\_is\_cancelled(handle->m\_cancellable.get())) { |
|  |  | if (socketConnection) |
|  |  | g\_io\_stream\_close(G\_IO\_STREAM(socketConnection.get()), nullptr, nullptr); |
|  |  | if (stream) |
|  |  | g\_io\_stream\_close(stream.get(), nullptr, nullptr); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | if (error) |
|  |  | handle->didFail(SocketStreamError(error->code, String(), error->message)); |
|  |  | handle->didFail(SocketStreamError(error->code, { }, error->message)); |
|  |  | else |
|  |  | handle->connected(WTFMove(socketConnection)); |
|  |  | handle->connected(WTFMove(stream)); |
|  |  | } |
|  |  |  |
|  |  | void SocketStreamHandleImpl::readBytes(gssize bytesRead) |
| Expand Down  Expand Up | | @@ -225,12 +246,12 @@ void SocketStreamHandleImpl::platformClose() |
|  |  | g\_cancellable\_cancel(m\_cancellable.get()); |
|  |  | stopWaitingForSocketWritability(); |
|  |  |  |
|  |  | if (m\_socketConnection) { |
|  |  | if (m\_stream) { |
|  |  | GUniqueOutPtr<GError> error; |
|  |  | g\_io\_stream\_close(G\_IO\_STREAM(m\_socketConnection.get()), nullptr, &error.outPtr()); |
|  |  | g\_io\_stream\_close(m\_stream.get(), nullptr, &error.outPtr()); |
|  |  | if (error) |
|  |  | didFail(SocketStreamError(error->code, String(), error->message)); |
|  |  | m\_socketConnection = nullptr; |
|  |  | didFail(SocketStreamError(error->code, { }, error->message)); |
|  |  | m\_stream = nullptr; |
|  |  | } |
|  |  |  |
|  |  | m\_outputStream = nullptr; |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Tools/ChangeLog](#diff-52b760e714d9159c5ac05eaee1055c44df68cee453c98b72778d2bff840402cc "Tools/ChangeLog")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Tools/ChangeLog)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,29 @@ |
|  |  | 2018-02-05 Carlos Garcia Campos <cgarcia@igalia.com> |
|  |  |  |
|  |  | [SOUP] WebSockets must use system proxy settings |
|  |  | https://bugs.webkit.org/show\_bug.cgi?id=126384 |
|  |  |  |
|  |  | Reviewed by Michael Catanzaro. |
|  |  |  |
|  |  | Check also WebSockets in /webkit2/WebKitWebContext/proxy. |
|  |  |  |
|  |  | \* TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp: |
|  |  | (ProxyTest::webSocketProxyServerCallback): |
|  |  | (ProxyTest::ProxyTest): |
|  |  | (ProxyTest::webSocketConnected): |
|  |  | (ProxyTest::createWebSocketAndWaitUntilConnected): |
|  |  | (webSocketServerCallback): |
|  |  | (testWebContextProxySettings): |
|  |  | \* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp: |
|  |  | (WebKitTestServer::~WebKitTestServer): |
|  |  | (WebKitTestServer::addWebSocketHandler): |
|  |  | (WebKitTestServer::removeWebSocketHandler): |
|  |  | (WebKitTestServer::getWebSocketURIForPath const): |
|  |  | (WebKitTestServer::getURIForPath const): |
|  |  | \* TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.h: |
|  |  | (WebKitTestServer::baseURI const): |
|  |  | (WebKitTestServer::baseWebSocketURI const): |
|  |  |  |
|  |  | 2018-02-05 Carlos Garcia Campos <cgarcia@igalia.com> |
|  |  |  |
|  |  | Add a way to check if a host is an IP address |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp](#diff-70e0772d9c7f80f6b88fe719f158fb83e6f48f9cb8e3e1d24bbccb8f6c33bd15 "Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Tools/TestWebKitAPI/Tests/WebKitGLib/TestWebKitWebContext.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -653,6 +653,19 @@ class ProxyTest : public WebViewTest { |
|  |  | public: |
|  |  | MAKE\_GLIB\_TEST\_FIXTURE(ProxyTest); |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | enum class WebSocketServerType { |
|  |  | Unknown, |
|  |  | NoProxy, |
|  |  | Proxy |
|  |  | }; |
|  |  |  |
|  |  | static void webSocketProxyServerCallback(SoupServer\*, SoupWebsocketConnection\*, const char\* path, SoupClientContext\*, gpointer userData) |
|  |  | { |
|  |  | static\_cast<ProxyTest\*>(userData)->webSocketConnected(ProxyTest::WebSocketServerType::Proxy); |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | ProxyTest() |
|  |  | { |
|  |  | // This "proxy server" is actually just a different instance of the main |
| Expand All | | @@ -662,6 +675,10 @@ class ProxyTest : public WebViewTest { |
|  |  | // work, not whether we can write a soup proxy server. |
|  |  | m\_proxyServer.run(serverCallback); |
|  |  | g\_assert(m\_proxyServer.baseURI()); |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | m\_proxyServer.addWebSocketHandler(webSocketProxyServerCallback, this); |
|  |  | g\_assert(m\_proxyServer.baseWebSocketURI()); |
|  |  | #endif |
|  |  | } |
|  |  |  |
|  |  | CString loadURIAndGetMainResourceData(const char\* uri) |
| Expand All | | @@ -679,9 +696,37 @@ class ProxyTest : public WebViewTest { |
|  |  | return port; |
|  |  | } |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | void webSocketConnected(WebSocketServerType serverType) |
|  |  | { |
|  |  | m\_webSocketRequestReceived = serverType; |
|  |  | quitMainLoop(); |
|  |  | } |
|  |  |  |
|  |  | WebSocketServerType createWebSocketAndWaitUntilConnected() |
|  |  | { |
|  |  | m\_webSocketRequestReceived = WebSocketServerType::Unknown; |
|  |  | GUniquePtr<char> createWebSocket(g\_strdup\_printf("var ws = new WebSocket('%s');", kServer->getWebSocketURIForPath("/foo").data())); |
|  |  | webkit\_web\_view\_run\_javascript(m\_webView, createWebSocket.get(), nullptr, nullptr, nullptr); |
|  |  | g\_main\_loop\_run(m\_mainLoop); |
|  |  | return m\_webSocketRequestReceived; |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | WebKitTestServer m\_proxyServer; |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | WebSocketServerType m\_webSocketRequestReceived { WebSocketServerType::Unknown }; |
|  |  | #endif |
|  |  | }; |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | static void webSocketServerCallback(SoupServer\*, SoupWebsocketConnection\*, const char\*, SoupClientContext\*, gpointer userData) |
|  |  | { |
|  |  | static\_cast<ProxyTest\*>(userData)->webSocketConnected(ProxyTest::WebSocketServerType::NoProxy); |
|  |  | } |
|  |  | #endif |
|  |  |  |
|  |  | static void ephemeralViewloadChanged(WebKitWebView\* webView, WebKitLoadEvent loadEvent, WebViewTest\* test) |
|  |  | { |
|  |  | if (loadEvent != WEBKIT\_LOAD\_FINISHED) |
| Expand All | | @@ -697,6 +742,13 @@ static void testWebContextProxySettings(ProxyTest\* test, gconstpointer) |
|  |  | auto mainResourceData = test->loadURIAndGetMainResourceData(kServer->getURIForPath("/echoPort").data()); |
|  |  | ASSERT\_CMP\_CSTRING(mainResourceData, ==, serverPortAsString.get()); |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | // WebSocket requests should also be received by kServer. |
|  |  | kServer->addWebSocketHandler(webSocketServerCallback, test); |
|  |  | auto serverType = test->createWebSocketAndWaitUntilConnected(); |
|  |  | g\_assert(serverType == ProxyTest::WebSocketServerType::NoProxy); |
|  |  | #endif |
|  |  |  |
|  |  | // Set default proxy URI to point to proxyServer. Requests to kServer should be received by proxyServer instead. |
|  |  | GUniquePtr<char> proxyURI(soup\_uri\_to\_string(test->m\_proxyServer.baseURI(), FALSE)); |
|  |  | WebKitNetworkProxySettings\* settings = webkit\_network\_proxy\_settings\_new(proxyURI.get(), nullptr); |
| Expand All | | @@ -706,6 +758,12 @@ static void testWebContextProxySettings(ProxyTest\* test, gconstpointer) |
|  |  | ASSERT\_CMP\_CSTRING(mainResourceData, ==, proxyServerPortAsString.get()); |
|  |  | webkit\_network\_proxy\_settings\_free(settings); |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | // WebSocket requests should also be received by proxyServer. |
|  |  | serverType = test->createWebSocketAndWaitUntilConnected(); |
|  |  | g\_assert(serverType == ProxyTest::WebSocketServerType::Proxy); |
|  |  | #endif |
|  |  |  |
|  |  | // Proxy settings also affect ephemeral web views. |
|  |  | auto webView = Test::adoptView(g\_object\_new(WEBKIT\_TYPE\_WEB\_VIEW, |
|  |  | #if PLATFORM(WPE) |
| Expand Down  Expand Up | | @@ -766,6 +824,10 @@ static void testWebContextProxySettings(ProxyTest\* test, gconstpointer) |
|  |  | webkit\_web\_context\_set\_network\_proxy\_settings(test->m\_webContext.get(), WEBKIT\_NETWORK\_PROXY\_MODE\_DEFAULT, nullptr); |
|  |  | mainResourceData = test->loadURIAndGetMainResourceData(kServer->getURIForPath("/echoPort").data()); |
|  |  | ASSERT\_CMP\_CSTRING(mainResourceData, ==, serverPortAsString.get()); |
|  |  |  |
|  |  | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
|  |  | kServer->removeWebSocketHandler(); |
|  |  | #endif |
|  |  | } |
|  |  |  |
|  |  | void beforeAll() |
| Expand Down | |  |

45 changes: 43 additions & 2 deletions

45
[Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp](#diff-df350c82f0d347974ce52413171e94c8fe969fcadab792c8f6158ffb9f211b2e "Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp")

Show comments

[View file](/WebKit/WebKit/blob/8693647417d99e91b348b79abcb488acd432c565/Tools/TestWebKitAPI/glib/WebKitGLib/WebKitTestServer.cpp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -53,6 +53,10 @@ WebKitTestServer::WebKitTestServer(ServerOptions options) |
|  |  | WebKitTestServer::~WebKitTestServer() |
|  |  | { |
|  |  | soup\_uri\_free(m\_baseURI); |
|  |  | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
|  |  | if (m\_baseWebSocketURI) |
|  |  | soup\_uri\_free(m\_baseWebSocketURI); |
|  |  | #endif |
|  |  | } |
|  |  |  |
|  |  | void WebKitTestServer::run(SoupServerCallback serverCallback) |
| Expand All | | @@ -68,11 +72,48 @@ void WebKitTestServer::run(SoupServerCallback serverCallback) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | CString WebKitTestServer::getURIForPath(const char\* path) |
|  |  | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
|  |  | void WebKitTestServer::addWebSocketHandler(SoupServerWebsocketCallback callback, gpointer userData) |
|  |  | { |
|  |  | SoupURI\* uri = soup\_uri\_new\_with\_base(m\_baseURI, path); |
|  |  | m\_baseWebSocketURI = soup\_uri\_new\_with\_base(m\_baseURI, "/websocket/"); |
|  |  | m\_baseWebSocketURI->scheme = m\_baseWebSocketURI->scheme == SOUP\_URI\_SCHEME\_HTTP ? SOUP\_URI\_SCHEME\_WS : SOUP\_URI\_SCHEME\_WSS; |
|  |  |  |
|  |  | if (m\_queue) { |
|  |  | m\_queue->dispatch([this, callback, userData] { |
|  |  | soup\_server\_add\_websocket\_handler(m\_soupServer.get(), "/websocket", nullptr, nullptr, callback, userData, nullptr); |
|  |  | }); |
|  |  | } else |
|  |  | soup\_server\_add\_websocket\_handler(m\_soupServer.get(), "/websocket", nullptr, nullptr, callback, userData, nullptr); |
|  |  | } |
|  |  |  |
|  |  | void WebKitTestServer::removeWebSocketHandler() |
|  |  | { |
|  |  | soup\_uri\_free(m\_baseWebSocketURI); |
|  |  | m\_baseWebSocketURI = nullptr; |
|  |  |  |
|  |  | if (m\_queue) { |
|  |  | m\_queue->dispatch([this] { |
|  |  | soup\_server\_remove\_handler(m\_soupServer.get(), "/websocket"); |
|  |  | }); |
|  |  | } else |
|  |  | soup\_server\_remove\_handler(m\_soupServer.get(), "/websocket"); |
|  |  | } |
|  |  |  |
|  |  | CString WebKitTestServer::getWebSocketURIForPath(const char\* path) const |
|  |  | { |
|  |  | g\_assert(m\_baseWebSocketURI); |
|  |  | g\_assert(path && \*path == '/'); |
|  |  | SoupURI\* uri = soup\_uri\_new\_with\_base(m\_baseWebSocketURI, path + 1); // Ignore the leading slash. |
|  |  | GUniquePtr<gchar> uriString(soup\_uri\_to\_string(uri, FALSE)); |
|  |  | soup\_uri\_free(uri); |
|  |  | return uriString.get(); |
|  |  | } |
|  |  | #endif // SOUP\_CHECK\_VERSION(2, 50, 0) |
|  |  |  |
|  |  | CString WebKitTestServer::getURIForPath(const char\* path) const |
|  |  | { |
|  |  | SoupURI\* uri = soup\_uri\_new\_with\_base(m\_baseURI, path); |
|  |  | GUniquePtr<gchar> uriString(soup\_uri\_to\_string(uri, FALSE)); |
|  |  | soup\_uri\_free(uri); |
|  |  | return uriString.get(); |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8693647`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FWebKit%2FWebKit%2Fcommit%2F8693647417d99e91b348b79abcb488acd432c565) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.webkit.org_de38fc24_20250126_112426.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=184804&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[184804](show_bug.cgi?id=184804)

CVE-2018-11712
REGRESSION([r228088](https://commits.webkit.org/r228088)): [SOUP] Certificate verification no longer performed for secure WebSocket connections
```
https://bugs.webkit.org/show_bug.cgi?id=184804
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
REGRESSION(r228088): [SOUP] Certificate verification no longer performed for ...

Michael Catanzaro

[Reported](show_bug.cgi?id=184804#c0)
2018-04-19 20:00:01 PDT

[r228088](https://commits.webkit.org/r228088) changes SocketStreamHandleImplSoup to use the new soup\_session\_connection\_async() API, which Carlos had just created for use by SocketStreamHandleImplSoup in [bug #126384](show_bug.cgi?id=126384 "RESOLVED FIXED - [SOUP] WebSockets must use system proxy settings"). Problem is this turned off certificate verification, since we disable SOUP\_SESSION\_SSL\_STRICT.
For normal connections, we work around this using SoupMessage (see [bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED") for why that is not quite right), but there is no possibility of doing that with soup\_session\_connect\_async(). It's impossible to fix without changes in libsoup. We need to either (a) change soup\_session\_connect\_async() to somehow force ssl-strict on the SoupConnection and SoupSocket it creates, or (b) add API for getting the SoupSocket so WebKit can force it on manually. I even tried finding some way to block the accept-certificate handler that SoupSocket is using to accept the certificate, since we want to reimplement that, but that would be a nasty hack and I don't think it's possible anyway.
We should probably add some generic API in libsoup to wrap accept-certificate, so it would be useful for [bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED") as well. But I'm not quite sure what it would look like. A SoupMessage API seems the most natural, but that's insufficient because SoupMessage is not exposed at all by soup\_session\_connect\_async(). A SoupSession API seems easiest, I guess. Thoughts?
Here is a WIP patch with a testcase. The test found some other longstanding problems here, too: we were ignoring the TLS error policy set by webkit\_web\_context\_set\_tls\_errors\_policy(), and ignoring any overrides set with webkit\_web\_context\_allow\_tls\_certificate\_for\_host(). These aren't security problems, though, since they only ever caused the connection to fail when it shouldn't have. Anyway, it was because we were instead checking an insane DeprecatedGlobalSettings::allowsAnySSLCertificate setting, which is used exclusively for web sockets. This patch solves this issue and renames all of its uses in Source/ to indicate it's used only for testing (and a couple service worker functions too!). I didn't change its usage in LayoutTests, though.

| Attachments | | |
| --- | --- | --- |
| [**Patch**](attachment.cgi?id=338389 "View the content of the attachment") (49.57 KB, patch)  [2018-04-19 20:09 PDT](#attach_338389 "Go to the comment associated with the attachment"), Michael Catanzaro | *no flags* | [Details](attachment.cgi?id=338389&action=edit)[Formatted Diff](attachment.cgi?id=338389&action=prettypatch)[Diff](attachment.cgi?id=338389&action=diff) |
| [**Simpler patch**](attachment.cgi?id=338404 "View the content of the attachment") (12.12 KB, patch)  [2018-04-20 03:05 PDT](#attach_338404 "Go to the comment associated with the attachment"), Carlos Garcia Campos | mcatanzaro: review+ | [Details](attachment.cgi?id=338404&action=edit)[Formatted Diff](attachment.cgi?id=338404&action=prettypatch)[Diff](attachment.cgi?id=338404&action=diff) |
| [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=184804&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=184804&action=enter) *proposed patch, testcase, etc.* | | |

Radar WebKit Bug Importer

[Comment 1](show_bug.cgi?id=184804#c1)
2018-04-19 20:00:17 PDT

<rdar://problem/39585887>

Michael Catanzaro

[Comment 2](show_bug.cgi?id=184804#c2)
2018-04-19 20:09:41 PDT

Created [attachment 338389](attachment.cgi?id=338389&action=diff "Patch") [[details]](attachment.cgi?id=338389&action=edit "Patch")
Patch

Michael Catanzaro

[Comment 3](show_bug.cgi?id=184804#c3)
2018-04-19 20:10:34 PDT

Comment on [attachment 338389](attachment.cgi?id=338389&action=diff "Patch") [[details]](attachment.cgi?id=338389&action=edit "Patch")
Patch
(It's not ready for review, because it doesn't fix the bug. Necessary, not sufficient.)

Michael Catanzaro

[Comment 4](show_bug.cgi?id=184804#c4)
2018-04-19 20:23:43 PDT

Comment on [attachment 338389](attachment.cgi?id=338389&action=diff "Patch") [[details]](attachment.cgi?id=338389&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=338389&action=review>
> Source/WebCore/testing/InternalSettings.cpp:-844
> -#if USE(SOUP)
> - SoupNetworkSession::setShouldIgnoreTLSErrors(allowsAnyCertificate);
> -#endif
(If it breaks layout tests, this would probably be why.)

Carlos Garcia Campos

[Comment 5](show_bug.cgi?id=184804#c5)
2018-04-20 03:01:58 PDT

Comment on [attachment 338389](attachment.cgi?id=338389&action=diff "Patch") [[details]](attachment.cgi?id=338389&action=edit "Patch")
Patch
There's too much noise in this patch to be a security fix, note that I'll have to backport it to 2.20 branch. So, I would simply fix the bug here, and then do the renames, cleanups and update jhbuild in follow up patches.

Carlos Garcia Campos

[Comment 6](show_bug.cgi?id=184804#c6)
2018-04-20 03:05:00 PDT

Created [attachment 338404](attachment.cgi?id=338404&action=diff "Simpler patch") [[details]](attachment.cgi?id=338404&action=edit "Simpler patch")
Simpler patch
This patch fixes the bug if applied on top of patch attached to [bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED"). I've fixed the bug and copied the test case added by Michael in the previous patch. I also updated the test to move the asserts from the fixture to the test and simplify it a bit.

Carlos Garcia Campos

[Comment 7](show_bug.cgi?id=184804#c7)
2018-04-20 03:29:53 PDT

Michael, if you are going to bump libsoup version in jhbuild, remember to include a patch for this commit:
<https://git.gnome.org/browse/libsoup/commit/?id=e8995d4e1d5cf984cf10327c59808976425b2f9c>

Michael Catanzaro

[Comment 8](show_bug.cgi?id=184804#c8)
2018-04-20 08:51:38 PDT

Comment on [attachment 338404](attachment.cgi?id=338404&action=diff "Simpler patch") [[details]](attachment.cgi?id=338404&action=edit "Simpler patch")
Simpler patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=338404&action=review>
I see you simplified several aspects of my code. Excellent!
I'll create another bug to deal with the insane testing setting.
> Source/WebCore/ChangeLog:3
> + REGRESSION([r228088](https://commits.webkit.org/r228088)): [SOUP] Check TLS errors for WebSockets right after TLS handshacking event
handshaking
> Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp:92
> + reinterpret\_cast<SoupSessionConnectProgressCallback>(connectProgressCallback),
I would change the ternary condition to url.protocolIs("wss") instead of removing it entirely, to avoid the unnecessary progress callbacks otherwise.
> Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp:348
> + DidReachServer = 1 << 0,
This flag is misnamed. Of course the request will always reach the server, because the client won't be able to check for TLS errors if the server has not sent it anything. Rename it, perhaps: "DidServerCompleteHandshake"

Michael Catanzaro

[Comment 9](show_bug.cgi?id=184804#c9)
2018-04-20 08:53:49 PDT

I'm going to request a CVE for this one.
[Bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED") is really minor since we don't support TLS 1.3 or fast open, so that doesn't need a CVE.

Carlos Garcia Campos

[Comment 10](show_bug.cgi?id=184804#c10)
2018-04-20 23:36:26 PDT

Committed [r230886](https://commits.webkit.org/r230886): <<https://trac.webkit.org/changeset/230886>>

Michael Catanzaro

[Comment 11](show_bug.cgi?id=184804#c11)
2018-06-03 07:56:03 PDT

(In reply to Michael Catanzaro from [comment #9](show_bug.cgi?id=184804#c9))
> [Bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED") is really minor since we don't support TLS 1.3 or fast open, so
> that doesn't need a CVE.
But note this fix depends on that one.

Michael Catanzaro

[Comment 12](show_bug.cgi?id=184804#c12)
2018-06-03 08:12:39 PDT

(In reply to Michael Catanzaro from [comment #9](show_bug.cgi?id=184804#c9))
> I'm going to request a CVE for this one.
>
> [Bug #184480](show_bug.cgi?id=184480 "RESOLVED FIXED") is really minor since we don't support TLS 1.3 or fast open, so
> that doesn't need a CVE.
It's been six weeks without a response from the DWF project. I've asked them to not issue the CVE after all, and requested one from Debian instead. Hopefully we don't wind up with a duplicate.

Michael Catanzaro

[Comment 13](show_bug.cgi?id=184804#c13)
2018-06-04 08:06:08 PDT

And MITRE responds in one day... phenomenal, really.
I don't understand what DWF is trying to accomplish, they are just getting in the way.

Michael Catanzaro

[Comment 14](show_bug.cgi?id=184804#c14)
2018-06-04 08:08:00 PDT

(In reply to Michael Catanzaro from [comment #13](show_bug.cgi?id=184804#c13))
> And MITRE responds in one day... phenomenal, really.
Oh yeah, Debian directed me to apply from MITRE.

Note
You need to
[log in](show_bug.cgi?id=184804&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Normal

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | WebKit Nightly Build |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |PC

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Linux

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |Security

 [Component](describecomponents.cgi?product=Security "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |Security

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |WebKit Security Group

Reported

2018-04-19 20:00 PDT

Modified

2018-06-04 08:09 PDT
[History](show_activity.cgi?id=184804)

CC List

7
users
Show

bfulgham
cgarcia
csaavedra
mcatanzaro
product-security
svillar
webkit-bug-importer

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |InRadar

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

[184480](show_bug.cgi?id=184480 "RESOLVED FIXED")

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

Dependencies
[tree](showdependencytree.cgi?id=184804&hide_resolved=1)[graph](showdependencygraph.cgi?id=184804)

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

* [CVE-2018-11713](show_bug.cgi?id=126384 "RESOLVED FIXED - [SOUP] WebSockets must use system proxy settings")
* [184480](show_bug.cgi?id=184480 "RESOLVED FIXED")
* [184821](show_bug.cgi?id=184821 "NEW - Deal with DeprecatedGlobalSettings::allowsAnySSLCertificate and WebProcessPool::allowsAnySSLCertificateForServiceWorker")

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |CVE-2018-11712

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=184804)
* [XML](show_bug.cgi?ctype=xml&id=184804)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=184804)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)



=== Content from trac.webkit.org_2350fdbb_20250125_193808.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/230885/webkit "Changeset 230885")
* [Next Changeset](/changeset/230887/webkit "Changeset 230887") →

---

# Changeset 230886 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Apr 20, 2018, 11:36:12 PM
([7 years](/timeline?from=2018-04-20T23%3A36%3A12-07%3A00&precision=second "See timeline at Apr 20, 2018, 11:36:12 PM") ago)
Author:
Carlos Garcia Campos
Message:

REGRESSION([r228088](/changeset/228088/webkit "[SOUP] WebSockets must use system proxy settings ...")): [SOUP] Check TLS errors for WebSockets on GTlsConnection::accept-certificate

[​https://bugs.webkit.org/show\_bug.cgi?id=184804](https://bugs.webkit.org/show_bug.cgi?id=184804)

Source/WebCore:

Reviewed by Michael Catanzaro.

* platform/network/soup/SocketStreamHandleImpl.h: Add a public url getter.
* platform/network/soup/SocketStreamHandleImplSoup.cpp:

(WebCore::acceptCertificateCallback): Call SoupNetworkSession::checkTLSErrors() to decide whether to accept the

certificate or not.

(WebCore::connectProgressCallback): Receive the SocketStreamHandle and pass it to acceptCertificateCallback callback.

(WebCore::socketClientEventCallback): Ditto.

(WebCore::SocketStreamHandleImpl::create): Always connect to network events.

(WebCore::wssConnectionAcceptCertificateCallback): Deleted.

(WebCore::wssSocketClientEventCallback): Deleted.

Tools:

Patch by Michael Catanzaro <Michael Catanzaro> on 2018-04-20

Reviewed by Carlos Garcia Campos.

* TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp:

(WebSocketTest::WebSocketTest):

(WebSocketTest::~WebSocketTest):

(WebSocketTest::serverWebSocketCallback):

(WebSocketTest::webSocketTestResultCallback):

(WebSocketTest::connectToServerAndWaitForEvents):

(testWebSocketTLSErrors):

(beforeAll):

Location:
[trunk](/browser/webkit/trunk?rev=230886)
Files:

5 edited

* [Source/WebCore/ChangeLog](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=230886 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=230886 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230886 "Show entry in browser")
  (modified)
  ([4 diffs](#file2 "Show differences"))
* [Tools/ChangeLog](/browser/webkit/trunk/Tools/ChangeLog?rev=230886 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp?rev=230886 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/Source/WebCore/ChangeLog](/changeset/230886/webkit/trunk/Source/WebCore/ChangeLog "Show the changeset 230886 restricted to trunk/Source/WebCore/ChangeLog")

  | [r230885](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=230885#L1 "Show revision 230885 of this file in browser") | [r230886](/browser/webkit/trunk/Source/WebCore/ChangeLog?rev=230886#L1 "Show revision 230886 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2018-04-20  Carlos Garcia Campos  <cgarcia@igalia.com> |
  |  | 2 |  |
  |  | 3 | REGRESSION(r228088): [SOUP] Check TLS errors for WebSockets on GTlsConnection::accept-certificate |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=184804 |
  |  | 5 |  |
  |  | 6 | Reviewed by Michael Catanzaro. |
  |  | 7 |  |
  |  | 8 | \* platform/network/soup/SocketStreamHandleImpl.h: Add a public url getter. |
  |  | 9 | \* platform/network/soup/SocketStreamHandleImplSoup.cpp: |
  |  | 10 | (WebCore::acceptCertificateCallback): Call SoupNetworkSession::checkTLSErrors() to decide whether to accept the |
  |  | 11 | certificate or not. |
  |  | 12 | (WebCore::connectProgressCallback): Receive the SocketStreamHandle and pass it to acceptCertificateCallback callback. |
  |  | 13 | (WebCore::socketClientEventCallback): Ditto. |
  |  | 14 | (WebCore::SocketStreamHandleImpl::create): Always connect to network events. |
  |  | 15 | (WebCore::wssConnectionAcceptCertificateCallback): Deleted. |
  |  | 16 | (WebCore::wssSocketClientEventCallback): Deleted. |
  |  | 17 |  |
  | 1 | 18 | 2018-04-20  Carlos Garcia Campos  <cgarcia@igalia.com> |
  | 2 | 19 |  |
* ## [trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h](/changeset/230886/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h "Show the changeset 230886 restricted to trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h")

  | [r230875](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=230875#L52 "Show revision 230875 of this file in browser") | [r230886](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImpl.h?rev=230886#L52 "Show revision 230886 of this file in browser") |  |
  | --- | --- | --- |
  | 52 | 52 | virtual ~SocketStreamHandleImpl(); |
  | 53 | 53 |  |
  |  | 54 | const URL& url() const { return m\_url; } |
  |  | 55 |  |
  | 54 | 56 | void platformSend(const uint8\_t\* data, size\_t length, Function<void(bool)>&&) final; |
  | 55 | 57 | void platformSendHandshake(const uint8\_t\* data, size\_t length, const std::optional<CookieRequestHeaderFieldProxy>&, Function<void(bool, bool)>&&) final; |
* ## [trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp](/changeset/230886/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp "Show the changeset 230886 restricted to trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp")

  | [r230875](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230875#L51 "Show revision 230875 of this file in browser") | [r230886](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230886#L51 "Show revision 230886 of this file in browser") |  |
  | --- | --- | --- |
  | 51 | 51 | namespace WebCore { |
  | 52 | 52 |  |
  | 53 |  | static gboolean wssConnectionAcceptCertificateCallback(GTlsConnection\*, GTlsCertificate\*, GTlsCertificateFlags) |
  | 54 |  | { |
  | 55 |  | return TRUE; |
  |  | 53 | static gboolean acceptCertificateCallback(GTlsConnection\*, GTlsCertificate\* certificate, GTlsCertificateFlags errors, SocketStreamHandleImpl\* handle) |
  |  | 54 | { |
  |  | 55 | // FIXME: Using DeprecatedGlobalSettings from here is a layering violation. |
  |  | 56 | if (DeprecatedGlobalSettings::allowsAnySSLCertificate()) |
  |  | 57 | return TRUE; |
  |  | 58 |  |
  |  | 59 | return !SoupNetworkSession::checkTLSErrors(handle->url(), certificate, errors); |
  | 56 | 60 | } |
  | 57 | 61 |  |
  | 58 | 62 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  | 59 |  | static void ~~wssSocketClientEventCallback(SoupSession\*, GSocketClientEvent event, GIOStream\* connection~~) |
  |  | 63 | static void connectProgressCallback(SoupSession\*, GSocketClientEvent event, GIOStream\* connection, SocketStreamHandleImpl\* handle) |
  | 60 | 64 | { |
  | 61 | 65 | if (event != G\_SOCKET\_CLIENT\_TLS\_HANDSHAKING) |
  | 62 | 66 | return; |
  | 63 | 67 |  |
  | 64 |  | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(~~wssConnectionAcceptCertificateCallback), nullptr~~); |
  |  | 68 | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(acceptCertificateCallback), handle); |
  | 65 | 69 | } |
  | 66 | 70 | #else |
  | 67 |  | static void ~~wssSocketClientEventCallback(GSocketClient\*, GSocketClientEvent event, GSocketConnectable\*, GIOStream\* connection~~) |
  |  | 71 | static void socketClientEventCallback(GSocketClient\*, GSocketClientEvent event, GSocketConnectable\*, GIOStream\* connection, SocketStreamHandleImpl\* handle) |
  | 68 | 72 | { |
  | 69 | 73 | if (event != G\_SOCKET\_CLIENT\_TLS\_HANDSHAKING) |
  | 70 | 74 | return; |
  | 71 | 75 |  |
  | 72 |  | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(~~wssConnectionAcceptCertificateCallback), nullptr~~); |
  |  | 76 | g\_signal\_connect(connection, "accept-certificate", G\_CALLBACK(acceptCertificateCallback), handle); |
  | 73 | 77 | } |
  | 74 | 78 | #endif |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230875#L77) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230886#L81) |  |
  | 77 | 81 | { |
  | 78 | 82 | Ref<SocketStreamHandleImpl> socket = adoptRef(\*new SocketStreamHandleImpl(url, client)); |
  | 79 |  |  |
  | 80 |  | ~~// FIXME: Using DeprecatedGlobalSettings from here is a layering violation.~~ |
  | 81 |  | ~~bool allowsAnySSLCertificate = url.protocolIs("wss") && DeprecatedGlobalSettings::allowsAnySSLCertificate();~~ |
  | 82 | 83 |  |
  | 83 | 84 | #if SOUP\_CHECK\_VERSION(2, 61, 90) |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230875#L89) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230886#L90) |  |
  | 89 | 90 | Ref<SocketStreamHandle> protectedSocketStreamHandle = socket.copyRef(); |
  | 90 | 91 | soup\_session\_connect\_async(networkStorageSession->getOrCreateSoupNetworkSession().soupSession(), uri.get(), socket->m\_cancellable.get(), |
  | 91 |  | ~~allowsAnySSLCertificate ? reinterpret\_cast<SoupSessionConnectProgressCallback>(wssSocketClientEvent~~Callback) : nullptr, |
  |  | 92 | url.protocolIs("wss") ? reinterpret\_cast<SoupSessionConnectProgressCallback>(connectProgressCallback) : nullptr, |
  | 92 | 93 | reinterpret\_cast<GAsyncReadyCallback>(connectedCallback), &protectedSocketStreamHandle.leakRef()); |
  | 93 | 94 | #else |
  | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230875#L97) | […](/browser/webkit/trunk/Source/WebCore/platform/network/soup/SocketStreamHandleImplSoup.cpp?rev=230886#L98) |  |
  | 97 | 98 | if (url.protocolIs("wss")) { |
  | 98 | 99 | g\_socket\_client\_set\_tls(socketClient.get(), TRUE); |
  | 99 |  | if (allowsAnySSLCertificate) |
  | 100 |  | g\_signal\_connect(socketClient.get(), "event", G\_CALLBACK(wssSocketClientEventCallback), nullptr); |
  |  | 100 | g\_signal\_connect(socketClient.get(), "event", G\_CALLBACK(socketClientEventCallback), socket.ptr()); |
  | 101 | 101 | } |
  | 102 | 102 | Ref<SocketStreamHandle> protectedSocketStreamHandle = socket.copyRef(); |
* ## [trunk/Tools/ChangeLog](/changeset/230886/webkit/trunk/Tools/ChangeLog "Show the changeset 230886 restricted to trunk/Tools/ChangeLog")

  | [r230883](/browser/webkit/trunk/Tools/ChangeLog?rev=230883#L1 "Show revision 230883 of this file in browser") | [r230886](/browser/webkit/trunk/Tools/ChangeLog?rev=230886#L1 "Show revision 230886 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2018-04-20  Michael Catanzaro  <mcatanzaro@igalia.com> |
  |  | 2 |  |
  |  | 3 | REGRESSION(r228088): [SOUP] Check TLS errors for WebSockets on GTlsConnection::accept-certificate |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=184804 |
  |  | 5 |  |
  |  | 6 | Reviewed by Carlos Garcia Campos. |
  |  | 7 |  |
  |  | 8 | \* TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp: |
  |  | 9 | (WebSocketTest::WebSocketTest): |
  |  | 10 | (WebSocketTest::~WebSocketTest): |
  |  | 11 | (WebSocketTest::serverWebSocketCallback): |
  |  | 12 | (WebSocketTest::webSocketTestResultCallback): |
  |  | 13 | (WebSocketTest::connectToServerAndWaitForEvents): |
  |  | 14 | (testWebSocketTLSErrors): |
  |  | 15 | (beforeAll): |
  |  | 16 |  |
  | 1 | 17 | 2018-04-20  Chris Dumez  <cdumez@apple.com> |
  | 2 | 18 |  |
* ## [trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp](/changeset/230886/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp "Show the changeset 230886 restricted to trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp")

  | [r218686](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp?rev=218686#L339 "Show revision 218686 of this file in browser") | [r230886](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp?rev=230886#L339 "Show revision 230886 of this file in browser") |  |
  | --- | --- | --- |
  | 339 | 339 | } |
  | 340 | 340 |  |
  |  | 341 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 342 | class WebSocketTest : public WebViewTest { |
  |  | 343 | public: |
  |  | 344 | MAKE\_GLIB\_TEST\_FIXTURE(WebSocketTest); |
  |  | 345 |  |
  |  | 346 | enum EventFlags { |
  |  | 347 | None = 0, |
  |  | 348 | DidServerCompleteHandshake = 1 << 0, |
  |  | 349 | DidOpen = 1 << 1, |
  |  | 350 | DidClose = 1 << 2 |
  |  | 351 | }; |
  |  | 352 |  |
  |  | 353 | WebSocketTest() |
  |  | 354 | { |
  |  | 355 | webkit\_user\_content\_manager\_register\_script\_message\_handler(m\_userContentManager.get(), "event"); |
  |  | 356 | g\_signal\_connect(m\_userContentManager.get(), "script-message-received::event", G\_CALLBACK(webSocketTestResultCallback), this); |
  |  | 357 | } |
  |  | 358 |  |
  |  | 359 | virtual ~WebSocketTest() |
  |  | 360 | { |
  |  | 361 | webkit\_user\_content\_manager\_unregister\_script\_message\_handler(m\_userContentManager.get(), "event"); |
  |  | 362 | g\_signal\_handlers\_disconnect\_by\_data(m\_userContentManager.get(), this); |
  |  | 363 | } |
  |  | 364 |  |
  |  | 365 | static constexpr const char\* webSocketTestJSFormat = |
  |  | 366 | "var socket = new WebSocket('%s');" |
  |  | 367 | "socket.addEventListener('open', onOpen);" |
  |  | 368 | "socket.addEventListener('close', onClose);" |
  |  | 369 | "function onOpen() {" |
  |  | 370 | "    window.webkit.messageHandlers.event.postMessage('open');" |
  |  | 371 | "    socket.removeEventListener('close', onClose);" |
  |  | 372 | "}" |
  |  | 373 | "function onClose() {" |
  |  | 374 | "    window.webkit.messageHandlers.event.postMessage('close');" |
  |  | 375 | "    socket.removeEventListener('open', onOpen);" |
  |  | 376 | "}"; |
  |  | 377 |  |
  |  | 378 | static void serverWebSocketCallback(SoupServer\*, SoupWebsocketConnection\*, const char\*, SoupClientContext\*, gpointer userData) |
  |  | 379 | { |
  |  | 380 | static\_cast<WebSocketTest\*>(userData)->m\_events |= WebSocketTest::EventFlags::DidServerCompleteHandshake; |
  |  | 381 | } |
  |  | 382 |  |
  |  | 383 | static void webSocketTestResultCallback(WebKitUserContentManager\*, WebKitJavascriptResult\* javascriptResult, WebSocketTest\* test) |
  |  | 384 | { |
  |  | 385 | GUniquePtr<char> event(WebViewTest::javascriptResultToCString(javascriptResult)); |
  |  | 386 | if (!g\_strcmp0(event.get(), "open")) |
  |  | 387 | test->m\_events |= WebSocketTest::EventFlags::DidOpen; |
  |  | 388 | else if (!g\_strcmp0(event.get(), "close")) |
  |  | 389 | test->m\_events |= WebSocketTest::EventFlags::DidClose; |
  |  | 390 | else |
  |  | 391 | g\_assert\_not\_reached(); |
  |  | 392 | test->quitMainLoop(); |
  |  | 393 | } |
  |  | 394 |  |
  |  | 395 | unsigned connectToServerAndWaitForEvents(WebKitTestServer\* server) |
  |  | 396 | { |
  |  | 397 | m\_events = 0; |
  |  | 398 |  |
  |  | 399 | server->addWebSocketHandler(serverWebSocketCallback, this); |
  |  | 400 | GUniquePtr<char> createWebSocketJS(g\_strdup\_printf(webSocketTestJSFormat, server->getWebSocketURIForPath("/foo").data())); |
  |  | 401 | webkit\_web\_view\_run\_javascript(m\_webView, createWebSocketJS.get(), nullptr, nullptr, nullptr); |
  |  | 402 | g\_main\_loop\_run(m\_mainLoop); |
  |  | 403 | server->removeWebSocketHandler(); |
  |  | 404 |  |
  |  | 405 | return m\_events; |
  |  | 406 | } |
  |  | 407 |  |
  |  | 408 | unsigned m\_events { 0 }; |
  |  | 409 | }; |
  |  | 410 |  |
  |  | 411 | static void testWebSocketTLSErrors(WebSocketTest\* test, gconstpointer) |
  |  | 412 | { |
  |  | 413 | WebKitWebContext\* context = webkit\_web\_view\_get\_context(test->m\_webView); |
  |  | 414 | WebKitTLSErrorsPolicy originalPolicy = webkit\_web\_context\_get\_tls\_errors\_policy(context); |
  |  | 415 | webkit\_web\_context\_set\_tls\_errors\_policy(context, WEBKIT\_TLS\_ERRORS\_POLICY\_FAIL); |
  |  | 416 |  |
  |  | 417 | // First, check that insecure ws:// web sockets work fine. |
  |  | 418 | unsigned events = test->connectToServerAndWaitForEvents(kHttpServer); |
  |  | 419 | g\_assert\_true(events); |
  |  | 420 | g\_assert\_true(events & WebSocketTest::EventFlags::DidServerCompleteHandshake); |
  |  | 421 | g\_assert\_true(events & WebSocketTest::EventFlags::DidOpen); |
  |  | 422 | g\_assert\_false(events & WebSocketTest::EventFlags::DidClose); |
  |  | 423 |  |
  |  | 424 | // Try again using wss:// this time. It should be blocked because the |
  |  | 425 | // server certificate is self-signed. |
  |  | 426 | events = test->connectToServerAndWaitForEvents(kHttpsServer); |
  |  | 427 | g\_assert\_true(events); |
  |  | 428 | g\_assert\_false(events & WebSocketTest::EventFlags::DidServerCompleteHandshake); |
  |  | 429 | g\_assert\_false(events & WebSocketTest::EventFlags::DidOpen); |
  |  | 430 | g\_assert\_true(events & WebSocketTest::EventFlags::DidClose); |
  |  | 431 |  |
  |  | 432 | // Now try wss:// again, this time ignoring TLS errors. |
  |  | 433 | webkit\_web\_context\_set\_tls\_errors\_policy(context, WEBKIT\_TLS\_ERRORS\_POLICY\_IGNORE); |
  |  | 434 | events = test->connectToServerAndWaitForEvents(kHttpsServer); |
  |  | 435 | g\_assert\_true(events & WebSocketTest::EventFlags::DidServerCompleteHandshake); |
  |  | 436 | g\_assert\_true(events & WebSocketTest::EventFlags::DidOpen); |
  |  | 437 | g\_assert\_false(events & WebSocketTest::EventFlags::DidClose); |
  |  | 438 |  |
  |  | 439 | webkit\_web\_context\_set\_tls\_errors\_policy(context, originalPolicy); |
  |  | 440 | } |
  |  | 441 | #endif |
  |  | 442 |  |
  | 341 | 443 | static void httpsServerCallback(SoupServer\* server, SoupMessage\* message, const char\* path, GHashTable\*, SoupClientContext\*, gpointer) |
  | 342 | 444 | { |
  | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp?rev=218686#L425) | […](/browser/webkit/trunk/Tools/TestWebKitAPI/Tests/WebKitGLib/TestSSL.cpp?rev=230886#L527) |  |
  | 425 | 527 | TLSSubresourceTest::add("WebKitWebView", "tls-subresource", testSubresourceLoadFailedWithTLSErrors); |
  | 426 | 528 | TLSErrorsTest::add("WebKitWebView", "load-failed-with-tls-errors", testLoadFailedWithTLSErrors); |
  |  | 529 | #if SOUP\_CHECK\_VERSION(2, 50, 0) |
  |  | 530 | WebSocketTest::add("WebKitWebView", "web-socket-tls-errors", testWebSocketTLSErrors); |
  |  | 531 | #endif |
  | 427 | 532 | } |
  | 428 | 533 |  |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=230886)
* [Zip Archive](?format=zip&new=230886)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)


