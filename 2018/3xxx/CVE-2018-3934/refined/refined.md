- **Root cause of vulnerability:** The vulnerability stems from the improper implementation of nonce handling in the Yi Home Camera's firmware update functionality. The camera uses a nonce and its HMAC-SHA1 hash for authentication, but the list of previously used nonces is stored per connection (TNP\_Session) and is cleared upon session termination. This allows for replay attacks because the nonce is not checked against a persistent list.
- **Weaknesses/vulnerabilities present:**
    -   **Nonce reuse:** The primary weakness is the reuse of nonces due to the lack of a persistent nonce history. The list of valid nonces is cleared after each TNP\_Session ends, allowing an attacker to replay previously valid nonces.
    -   **Inadequate session management:** The per-connection nonce storage mechanism, which is cleared after the session, enables the vulnerability.
    -   **Lack of persistent nonce storage:** The device does not maintain a persistent record of used nonces, therefore, they can be reused once the relevant session has ended.
- **Impact of exploitation:** An attacker can bypass authentication by replaying previously valid nonces. This would allow them to execute arbitrary code or manipulate settings on the device. The exploit could lead to full control over the camera.
- **Attack vectors:**
    -   **Network Sniffing:** An attacker needs to sniff network traffic to obtain a valid nonce and the corresponding HMAC-SHA1 hash.
    -   **Packet Injection:** The attacker then sends crafted UDP packets with the replayed nonce to bypass authentication.
- **Required attacker capabilities/position:**
    -   **Network Access:** The attacker must be on the same network as the vulnerable camera or be able to intercept network traffic between the camera and the Yi Home app.
    -   **Packet Sniffing/Injection:** The attacker must have the ability to capture and manipulate network packets.
    -   **Knowledge of Protocol:**  Understanding of the TNP protocol and the structure of packets, especially the  `MSG_RCV_DRW` opcode and its sub-structure is required.