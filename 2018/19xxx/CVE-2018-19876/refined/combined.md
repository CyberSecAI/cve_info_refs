=== Content from bugs.webkit.org_2ee70ced_20250124_131049.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=191595&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
MOVED
[191595](show_bug.cgi?id=191595)

[FreeType] Problem under WebCore::FontPlatformData::FontPlatformData
```
https://bugs.webkit.org/show_bug.cgi?id=191595
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
[FreeType] Problem under WebCore::FontPlatformData::FontPlatformData

Michael Catanzaro

[Reported](show_bug.cgi?id=191595#c0)
2018-11-13 13:17:02 PST

Created [attachment 354692](attachment.cgi?id=354692 "Full backtrace") [[details]](attachment.cgi?id=354692&action=edit "Full backtrace")
Full backtrace
Reproducer: <https://thepointsguy.com/2017/09/experience-only-on-virgin-america/>
Full backtrace attached. Truncated backtrace:
#0 \_\_GI\_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1 0x00007fee8eade515 in \_\_GI\_abort () at abort.c:79
#2 0x00007fee8eb354c8 in \_\_libc\_message (action=action@entry=do\_abort,
fmt=fmt@entry=0x7fee8ec3e1fb "%s\n") at ../sysdeps/posix/libc\_fatal.c:181
#3 0x00007fee8eb3b8da in malloc\_printerr (str=str@entry=0x7fee8ec3c402 "free(): invalid pointer")
at malloc.c:5350
#4 0x00007fee8eb3d06c in \_int\_free (av=<optimized out>, p=<optimized out>, have\_lock=<optimized out>)
at malloc.c:4157
#5 0x00007fee8fedd993 in cairo\_ft\_apply\_variations (face=face@entry=0x7fed3aba7100,
scaled\_font=<optimized out>, scaled\_font=<optimized out>) at ../../src/cairo-ft-font.c:2396
#6 0x00007fee8fee0a7f in cairo\_ft\_scaled\_font\_lock\_face (
abstract\_font=abstract\_font@entry=0x55c6020ea1b0) at ../../src/cairo-ft-font.c:3859
#7 0x00007fee95085334 in WebCore::CairoFtFaceLocker::CairoFtFaceLocker (scaledFont=0x55c6020ea1b0,
this=<synthetic pointer>) at ../Source/WebCore/platform/graphics/cairo/CairoUtilities.h:55
#8 WebCore::FontPlatformData::FontPlatformData (this=0x7ffc53bd7d30, fontFace=<optimized out>,
description=..., bold=<optimized out>, italic=<optimized out>)
at ../Source/WebCore/platform/graphics/freetype/FontPlatformDataFreeType.cpp:168
#9 0x00007fee95084873 in WebCore::FontCustomPlatformData::fontPlatformData (this=<optimized out>,
description=..., bold=<optimized out>, italic=<optimized out>)
at ../Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp:61
#10 0x00007fee949767f4 in WebCore::CachedFont::platformDataFromCustomData (fontCustomPlatformData=...,
fontDescription=..., bold=<optimized out>, italic=<optimized out>, fontFaceFeatures=...,
fontFaceVariantSettings=..., fontFaceCapabilities=...)
at ../Source/WebCore/loader/cache/CachedFont.cpp:150

| Attachments | | |
| --- | --- | --- |
| [**Full backtrace**](attachment.cgi?id=354692 "View the content of the attachment") (179.40 KB, text/plain)  [2018-11-13 13:17 PST](#attach_354692 "Go to the comment associated with the attachment"), Michael Catanzaro | *no flags* | [Details](attachment.cgi?id=354692&action=edit) |
| [**Patch**](attachment.cgi?id=355346 "View the content of the attachment") (3.08 KB, patch)  [2018-11-20 08:19 PST](#attach_355346 "Go to the comment associated with the attachment"), Michael Catanzaro | *no flags* | [Details](attachment.cgi?id=355346&action=edit)[Formatted Diff](attachment.cgi?id=355346&action=prettypatch)[Diff](attachment.cgi?id=355346&action=diff) |
| [**Patch**](attachment.cgi?id=355376 "View the content of the attachment") (2.00 KB, patch)  [2018-11-20 18:45 PST](#attach_355376 "Go to the comment associated with the attachment"), Michael Catanzaro | ews-watchlist: commit-queue- | [Details](attachment.cgi?id=355376&action=edit)[Formatted Diff](attachment.cgi?id=355376&action=prettypatch)[Diff](attachment.cgi?id=355376&action=diff) |
| [**Archive of layout-test-results from ews206 for win-future**](attachment.cgi?id=355380 "View the content of the attachment") (12.80 MB, application/zip)  [2018-11-20 20:41 PST](#attach_355380 "Go to the comment associated with the attachment"), EWS Watchlist | *no flags* | [Details](attachment.cgi?id=355380&action=edit) |
| [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=191595&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=191595&action=enter) *proposed patch, testcase, etc.* | | |

Michael Catanzaro

[Comment 1](show_bug.cgi?id=191595#c1)
2018-11-13 13:17:23 PST

(This is with 2.22.3)

Carlos Garcia Campos

[Comment 2](show_bug.cgi?id=191595#c2)
2018-11-19 02:24:32 PST

I can't reproduce this.

Carlos Garcia Campos

[Comment 3](show_bug.cgi?id=191595#c3)
2018-11-19 03:40:38 PST

Looking at the bt, I think the problem is that cairo is trying to free a FT\_MM\_Var with free when using freetype 2.9. I can't reproduce it because i have freetype 2.8.1.

Carlos Garcia Campos

[Comment 4](show_bug.cgi?id=191595#c4)
2018-11-19 03:41:22 PST

See <https://gitlab.freedesktop.org/cairo/cairo/merge_requests/5>

Michael Catanzaro

[Comment 5](show_bug.cgi?id=191595#c5)
2018-11-19 08:08:17 PST

Thanks

Michael Catanzaro

[Comment 6](show_bug.cgi?id=191595#c6)
2018-11-20 07:35:29 PST

Reopening

Michael Catanzaro

[Comment 7](show_bug.cgi?id=191595#c7)
2018-11-20 07:41:56 PST

Closing again. :)

Michael Catanzaro

[Comment 8](show_bug.cgi?id=191595#c8)
2018-11-20 07:42:25 PST

Actually let's use this bug to workaround the issue based on cairo version.

Michael Catanzaro

[Comment 9](show_bug.cgi?id=191595#c9)
2018-11-20 08:19:28 PST

Created [attachment 355346](attachment.cgi?id=355346&action=diff "Patch") [[details]](attachment.cgi?id=355346&action=edit "Patch")
Patch

Adrian Perez

[Comment 10](show_bug.cgi?id=191595#c10)
2018-11-20 12:24:47 PST

Comment on [attachment 355346](attachment.cgi?id=355346&action=diff "Patch") [[details]](attachment.cgi?id=355346&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=355346&action=review>
There are some changes needed in this patch, please take a look.
> Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp:71
> + if (version >= CAIRO\_VERSION\_ENCODE(1, 15, 0) && version < CAIRO\_VERSION\_ENCODE(1, 16, 1)) {
If I understand correctly, we want to \*avoid\* using fastMalloc() and friends
for Cairo 1.16.0, but here the code is \*enabling\* their usage for Cairo
versions between [1.15.0, 1.16.1) — which goes against the comment above.
I think here the condition should be reversed:
if (version < CAIRO\_VERSION\_ENCODE(1, 16, 0) && version >= CAIRO\_VERSION\_ENCODE(1, 16, 1))
This way the custom memory allocator is set for every version except the ones
in the range [1.16.0, 1.16.1).
> Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp:91
> }
When “FT\_New\_Library” is not being used, FreeType is not being initialized
at all! You will want to initialize the library using “FT\_Init\_FreeType()”
in an else branch. The following is missing:
else {
if (FT\_Init\_FreeType(&library))
return false;
}
> Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp:93
> FT\_Add\_Default\_Modules(library);
You will want to move this call to “FT\_Add\_Default\_Modules()” above, right
after using “FT\_New\_Library()”. It is not needed to call this when using
“FT\_Init\_FreeType()” because it's called implicitly in that case.

Michael Catanzaro

[Comment 11](show_bug.cgi?id=191595#c11)
2018-11-20 15:30:26 PST

Comment on [attachment 355346](attachment.cgi?id=355346&action=diff "Patch") [[details]](attachment.cgi?id=355346&action=edit "Patch")
Patch
Good catches, it's a disaster. Let me try again.

Michael Catanzaro

[Comment 12](show_bug.cgi?id=191595#c12)
2018-11-20 18:45:19 PST

Created [attachment 355376](attachment.cgi?id=355376&action=diff "Patch") [[details]](attachment.cgi?id=355376&action=edit "Patch")
Patch

Michael Catanzaro

[Comment 13](show_bug.cgi?id=191595#c13)
2018-11-20 18:47:36 PST

Here's a fixed patch for unofficial review. We might as well just commit this to stable and not pollute trunk with it.

EWS Watchlist

[Comment 14](show_bug.cgi?id=191595#c14)
2018-11-20 20:41:06 PST

Comment on [attachment 355376](attachment.cgi?id=355376&action=diff "Patch") [[details]](attachment.cgi?id=355376&action=edit "Patch")
Patch
[Attachment 355376](attachment.cgi?id=355376&action=diff "Patch") [[details]](attachment.cgi?id=355376&action=edit "Patch") did not pass win-ews (win):
Output: <https://webkit-queues.webkit.org/results/10094493>
New failing tests:
webanimations/leak-document-with-web-animation.html

EWS Watchlist

[Comment 15](show_bug.cgi?id=191595#c15)
2018-11-20 20:41:17 PST

Created [attachment 355380](attachment.cgi?id=355380 "Archive of layout-test-results from ews206 for win-future") [[details]](attachment.cgi?id=355380&action=edit "Archive of layout-test-results from ews206 for win-future")
Archive of layout-test-results from ews206 for win-future
The attached test failures were seen while running run-webkit-tests on the win-ews.
Bot: ews206 Port: win-future Platform: CYGWIN\_NT-6.1-2.9.0-0.318-5-3-x86\_64-64bit

Carlos Garcia Campos

[Comment 16](show_bug.cgi?id=191595#c16)
2018-11-21 01:14:26 PST

Comment on [attachment 355376](attachment.cgi?id=355376&action=diff "Patch") [[details]](attachment.cgi?id=355376&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=355376&action=review>
> Source/WebCore/platform/graphics/freetype/FontCustomPlatformDataFreeType.cpp:71
> + // Workaround crash in cairo 1.16.0. See [https://webkit.org/b/191595](show_bug.cgi?id=191595 "RESOLVED MOVED - [FreeType] Problem under WebCore::FontPlatformData::FontPlatformData").
> + int version = cairo\_version();
> + if (version >= CAIRO\_VERSION\_ENCODE(1, 15, 0) && version < CAIRO\_VERSION\_ENCODE(1, 16, 1)) {
This is only broken if freetype version is >= 2.9

Michael Catanzaro

[Comment 17](show_bug.cgi?id=191595#c17)
2018-11-21 04:31:36 PST

Are you sure? I can't reproduce the crash anymore either: that doesn't mean it's not a security problem. FT\_Get\_MM\_Var was added in 2004 and I can see it's been using FT\_ALLOC (in TT\_Get\_MM\_Var) since then, so my guess is it has never been tested with custom allocators and the first cairo version to use it (1.16) is the first bad version.

Carlos Garcia Campos

[Comment 18](show_bug.cgi?id=191595#c18)
2018-11-21 06:12:45 PST

Yes, I guess previous versions of freetype used malloc directly, the docs said you had to free it with free (not with FC functions). It doesn't crash for me with current cairo.

Michael Catanzaro

[Comment 19](show_bug.cgi?id=191595#c19)
2018-11-21 08:32:52 PST

(In reply to Carlos Garcia Campos from [comment #18](show_bug.cgi?id=191595#c18))
> Yes, I guess previous versions of freetype used malloc directly, the docs
> said you had to free it with free (not with FC functions).
I think the docs were wrong and there was no safe way to use it before.
> It doesn't crash for me with current cairo.
Me either, that's just luck I think.

Michael Catanzaro

[Comment 20](show_bug.cgi?id=191595#c20)
2018-11-21 08:52:39 PST

Committed workaround to 2.22 branch only. This should be fixed in cairo long before 2.24 and we don't have to argue about whether to check the freetype version or not if it's only on 2.22. :)

Miguel Gomez

[Comment 21](show_bug.cgi?id=191595#c21)
2020-03-17 01:55:41 PDT

This hasn't been fixed in cairo, and it's affecting 2.26 and 2.28 as well. Maybe we should add this workaround there too?

Michael Catanzaro

[Comment 22](show_bug.cgi?id=191595#c22)
2020-03-17 10:04:04 PDT

<https://gitlab.freedesktop.org/cairo/cairo/-/merge_requests/5> is merged...?

Miguel Gomez

[Comment 23](show_bug.cgi?id=191595#c23)
2020-03-18 01:30:58 PDT

(In reply to Michael Catanzaro from [comment #22](show_bug.cgi?id=191595#c22))
> <https://gitlab.freedesktop.org/cairo/cairo/-/merge_requests/5> is merged...?
But there hasn't been any new release that includes the fix (other than the 1.17.2 snapshot), or am I wrong?

Michael Catanzaro

[Comment 24](show_bug.cgi?id=191595#c24)
2020-03-18 07:14:20 PDT

Ugh, you're right. I didn't realize it was a snapshot release. :(
It's not WebKit's responsibility to work around cairo vulnerabilities forever. We could report a CVE against cairo to get them to fix it. It's a double free that can be triggered by remote web content, right? (Do you have an updated reproducer? Something that works today? My original reproducer doesn't work anymore.) Anyway, that's the recipe for a remote code execution CVE. Good way to magically attract attention to an issue. Should have done that way back when the issue was originally reported, but oh well....

Michael Catanzaro

[Comment 25](show_bug.cgi?id=191595#c25)
2020-03-18 07:21:59 PDT

Well, it's an invalid free, not a double free, but all the same applies.

Carlos Alberto Lopez Perez

[Comment 26](show_bug.cgi?id=191595#c26)
2020-03-18 08:43:54 PDT

(In reply to Michael Catanzaro from [comment #24](show_bug.cgi?id=191595#c24))
> Ugh, you're right. I didn't realize it was a snapshot release. :(
>
> It's not WebKit's responsibility to work around cairo vulnerabilities
> forever. We could report a CVE against cairo to get them to fix it. It's a
> double free that can be triggered by remote web content, right? (Do you have
> an updated reproducer? Something that works today? My original reproducer
> doesn't work anymore.) Anyway, that's the recipe for a remote code execution
> CVE. Good way to magically attract attention to an issue. Should have done
> that way back when the issue was originally reported, but oh well....
But you already asked for one? you comment about CVE-2018-19876 on <https://gitlab.freedesktop.org/cairo/cairo/-/merge_requests/5>

Michael Catanzaro

[Comment 27](show_bug.cgi?id=191595#c27)
2020-03-18 09:23:52 PDT

Ah cool, so I actually did the right thing for a change. :D

Michael Catanzaro

[Comment 28](show_bug.cgi?id=191595#c28)
2020-03-18 09:35:04 PDT

(In reply to Michael Catanzaro from [comment #20](show_bug.cgi?id=191595#c20))
> Committed workaround to 2.22 branch only. This should be fixed in cairo long
> before 2.24 and we don't have to argue about whether to check the freetype
> version or not if it's only on 2.22. :)
BTW: if you ever need concrete proof that I am a fool, this is it right here, forever enshrined in Bugzilla. ;)

Michael Catanzaro

[Comment 29](show_bug.cgi?id=191595#c29)
2020-03-18 12:21:41 PDT

(In reply to Michael Catanzaro from [comment #24](show_bug.cgi?id=191595#c24))
> (Do you have
> an updated reproducer? Something that works today? My original reproducer
> doesn't work anymore.)
Miguel, did you find a layout test that was hitting this? Or just general web browsing...?

Miguel Gomez

[Comment 30](show_bug.cgi?id=191595#c30)
2020-03-19 02:14:52 PDT

(In reply to Michael Catanzaro from [comment #29](show_bug.cgi?id=191595#c29))
> (In reply to Michael Catanzaro from [comment #24](show_bug.cgi?id=191595#c24))
> > (Do you have
> > an updated reproducer? Something that works today? My original reproducer
> > doesn't work anymore.)
>
> Miguel, did you find a layout test that was hitting this? Or just general
> web browsing...?
I hit it when browsing a client's test page, both testing 2.26 and 2.28, but I'm afraid I cannot share the link :(

Note
You need to
[log in](show_bug.cgi?id=191595&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |MOVED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Normal

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | WebKit Nightly Build |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |PC

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Linux

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |WebKitGTK

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Michael Catanzaro

Reported

2018-11-13 13:17 PST

Modified

2020-03-19 02:14 PDT
[History](show_activity.cgi?id=191595)

CC List

8
users
Show

aperez
bugs-noreply
cgarcia
clopez
ews-watchlist
magomez
mcatanzaro
mmaxfield

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |
None

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=191595)
* [XML](show_bug.cgi?ctype=xml&id=191595)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=191595)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)



=== Content from gitlab.freedesktop.org_7e7fa739_20250124_131054.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Register](/users/sign_up)

## Admin message

Due to an influx of spam, we have had to impose restrictions on new accounts. Please see [this wiki page](https://gitlab.freedesktop.org/freedesktop/freedesktop/-/wikis/home) for instructions on how to get full permissions. Sorry for the inconvenience.

# ft: Use FT\_Done\_MM\_Var instead of free when available in cairo\_ft\_apply\_variations

Code

* Review changes
* Check out branch
* ---
* Download
* [Patches](/cairo/cairo/-/merge_requests/5.patch)
* [Plain diff](/cairo/cairo/-/merge_requests/5.diff)

[Carlos Garcia Campos](/carlosgc) requested to merge  [carlosgc/cairo:ft-crash](/carlosgc/cairo/-/tree/ft-crash "carlosgc/cairo:ft-crash")
 into [master](/cairo/cairo/-/tree/master "master") Nov 19, 2018

* [Overview
  20](/cairo/cairo/-/merge_requests/5)
* [Commits
  1](/cairo/cairo/-/merge_requests/5/commits)
* [Pipelines
  1](/cairo/cairo/-/merge_requests/5/pipelines)
* [Changes
  1](/cairo/cairo/-/merge_requests/5/diffs)

Expand

Fixes a crash when using freetype >= 2.9

## Merge request reports

Assignee
Loading

Reviewers
Loading

Request review fromRequest review fromLoading

Time tracking
Loading

Loading



=== Content from gitlab.freedesktop.org_cc7c3725_20250126_011653.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Register](/users/sign_up)

## Admin message

Due to an influx of spam, we have had to impose restrictions on new accounts. Please see [this wiki page](https://gitlab.freedesktop.org/freedesktop/freedesktop/-/wikis/home) for instructions on how to get full permissions. Sorry for the inconvenience.

# ft: Use FT\_Done\_MM\_Var instead of free when available in cairo\_ft\_apply\_variations

Code

* Review changes
* Check out branch
* ---
* Download
* [Patches](/cairo/cairo/-/merge_requests/5.patch)
* [Plain diff](/cairo/cairo/-/merge_requests/5.diff)

[Carlos Garcia Campos](/carlosgc) requested to merge  [carlosgc/cairo:ft-crash](/carlosgc/cairo/-/tree/ft-crash "carlosgc/cairo:ft-crash")
 into [master](/cairo/cairo/-/tree/master "master") Nov 19, 2018

* [Overview
  20](/cairo/cairo/-/merge_requests/5)
* [Commits
  1](/cairo/cairo/-/merge_requests/5/commits)
* [Pipelines
  1](/cairo/cairo/-/merge_requests/5/pipelines)
* [Changes
  1](/cairo/cairo/-/merge_requests/5/diffs)

Expand

Fixes a crash when using freetype >= 2.9

## Merge request reports

Assignee
Loading

Reviewers
Loading

Request review fromRequest review fromLoading

Time tracking
Loading

Loading


