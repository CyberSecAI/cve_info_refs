=== Content from github.com_72be1d94_20250125_161137.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fpull%2F2015)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fpull%2F2015)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=caddyserver%2Fcaddy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[caddyserver](/caddyserver)
/
**[caddy](/caddyserver/caddy)**
Public

* [Notifications](/login?return_to=%2Fcaddyserver%2Fcaddy) You must be signed in to change notification settings
* [Fork
  4.2k](/login?return_to=%2Fcaddyserver%2Fcaddy)
* [Star
   60.9k](/login?return_to=%2Fcaddyserver%2Fcaddy)

* [Code](/caddyserver/caddy)
* [Issues
  123](/caddyserver/caddy/issues)
* [Pull requests
  28](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

Additional navigation options

* [Code](/caddyserver/caddy)
* [Issues](/caddyserver/caddy/issues)
* [Pull requests](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fcaddyserver%2Fcaddy%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fcaddyserver%2Fcaddy%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# tls: Restructure and improve certificate management #2015

 Merged

[mholt](/mholt)
merged 10 commits into
[master](/caddyserver/caddy/tree/master "caddyserver/caddy:master")
from
[cert-cache](/caddyserver/caddy/tree/cert-cache "caddyserver/caddy:cert-cache")

Feb 16, 2018

 Merged

# [tls: Restructure and improve certificate management](#top) #2015

[mholt](/mholt)
merged 10 commits into
[master](/caddyserver/caddy/tree/master "caddyserver/caddy:master")
from
[cert-cache](/caddyserver/caddy/tree/cert-cache "caddyserver/caddy:cert-cache")

Feb 16, 2018

[Conversation
43](/caddyserver/caddy/pull/2015)
[Commits
10](/caddyserver/caddy/pull/2015/commits)
[Checks
0](/caddyserver/caddy/pull/2015/checks)
[Files changed](/caddyserver/caddy/pull/2015/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![mholt](https://avatars.githubusercontent.com/u/1128849?s=60&v=4)](/mholt)

Copy link

Member

### @mholt **[mholt](/mholt)** commented [Feb 4, 2018](#issue-294179160) • edited Loading

**Please help test and review this PR!**

### 1. What does this change do, exactly?

Most of the changes are internal to the code, but there are bug fixes and a couple minor breaking changes for server type plugins that use the `caddytls` package.

* Expose the list of Caddy instances through caddy.Instances()
* Added arbitrary storage to caddy.Instance
* The cache of loaded certificates is no longer global; now scoped

  per-instance, meaning upon reload (like SIGUSR1) the old cert cache

  will be discarded entirely, whereas before, aggressively reloading

  config that added and removed lots of sites would cause unnecessary

  build-up in the cache over time.
* Key certificates in the cache by their SHA-256 hash instead of

  by their names. This means certificates will not be duplicated in

  memory (within each instance), making Caddy much more memory-efficient

  for large-scale deployments with thousands of sites sharing certs.
* Perform name-to-certificate lookups scoped per caddytls.Config instead

  of a single global lookup. This prevents certificates from stepping on

  each other when they overlap in their names.
* Do not allow TLS configurations keyed by the same hostname to be

  different; this now throws an error.
* Updated relevant tests, with a stark awareness that more tests are

  needed.
* Change the NewContext function signature to include an \*Instance.
* Strongly recommend (basically require) use of caddytls.NewConfig()

  to create a new \*caddytls.Config, to ensure pointers to the instance

  certificate cache are initialized properly.
* Update the TLS-SNI challenge solver (even though TLS-SNI is disabled

  currently on the CA side). Store temporary challenge cert in instance

  cache, but do so directly by the ACME challenge name, not the hash.

  Modified the getCertificate function to check the cache directly for

  a name match if one isn't found otherwise. This will allow any

  caddytls.Config to be able to help solve a TLS-SNI challenge, with one

  extra side-effect that might actually be kind of interesting (and

  useless): clients could send a certificate's hash as the SNI and

  Caddy would be able to serve that certificate for the handshake.
* Do not attempt to match a "default" (random) certificate when SNI

  is present but unrecognized; return no certificate so a TLS alert

  happens instead.
* Store an Instance in the list of instances even while the instance

  is still starting up (this allows access to the cert cache for

  performing renewals at startup, etc). Will be removed from list again

  if instance startup fails.
* Laid groundwork for ACMEv2 and Let's Encrypt wildcard support.

Server type plugins will need to be updated slightly to accommodate

minor adjustments to their API (like passing in an Instance). This

commit includes the changes for the HTTP server.

Certain Caddyfile configurations might error out with this change, if

they configured different TLS settings for the same hostname.

This change trades some complexity for other complexity, but ultimately

this new complexity is more correct and robust than earlier logic.

### 2. Please link to the relevant issues.

Fixes [#1991](https://github.com/caddyserver/caddy/issues/1991)

Fixes [#1994](https://github.com/caddyserver/caddy/issues/1994)

Fixes [#1303](https://github.com/caddyserver/caddy/issues/1303)

### 3. Which documentation changes (if any) need to be made because of this PR?

The `tls` directive page will definitely need updating. TLS configurations for equal hostnames cannot be different. Any description about how certificates are stored internally might need to change.

OH, and something I forgot on the original commit message: Caddy can now better support being used in conjunction with other Caddy instances that share the same certificate storage. In other words, if you have multiple instances all using the same $CADDYPATH, that's been a bad idea because they will all try to manage the certificates themselves (keep them renewed, etc, which runs you into rate limits fast). Now, Caddy will attempt to check if the certificate in storage still needs to be renewed just before it fires off a renewal. So if you stagger Caddy deployments by more time than it takes to complete an ACME challenge (usually just a few seconds, but if you use DNS challenge maybe minutes or more), they might play better together in an acceptable way, for small-medium scale use cases. I wouldn't rely on this for high-volume deployments (like, hundreds or thousands of instances sharing the same certificate storage and all trying to manage them) but I bet it'll be better for dozens of Caddy instances!

\*\* **UPDATE** \*\*: The latest changes I pushed to this branch now eliminate the need to stagger the timing of running each Caddy instance. If multiple Caddy instances (even thousands) share the same certificate storage on disk, they will coordinate renewals and not step on each others' toes. It just requires using the DNS challenge when behind a load balancer. However, testing this is a little tricky, so we'll have to see how it goes. It's an advanced use case, so I'm not expecting many people to be benefitted by it, but I hope they will let us know how it goes!

### 4. Checklist

* I have written tests and verified that they fail without my change
* I have squashed any insignificant commits
* This change has comments for package types, values, functions, and non-obvious lines of code
* I am willing to help maintain this change if there are issues with it later

/cc [@pieterlouw](https://github.com/pieterlouw) and [@miekg](https://github.com/miekg) -- I'll be getting in touch with you soon with more details for what this means about your server type plugins. I can probably submit a PR to caddy-net, and I'm not sure that CoreDNS will have to change much except a line where `NewContext()` is invoked.

Sorry, something went wrong.

 ❤️
4
 lbguilherme, elcore, francislavoie, and kalmi reacted with heart emoji

All reactions

* ❤️
  4 reactions

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: Restructure and improve certificate management](/caddyserver/caddy/pull/2015/commits/fc2ff9155cc53393ac29885f6de83ed87093b274 "tls: Restructure and improve certificate management

- Expose the list of Caddy instances through caddy.Instances()

- Added arbitrary storage to caddy.Instance

- The cache of loaded certificates is no longer global; now scoped
  per-instance, meaning upon reload (like SIGUSR1) the old cert cache
  will be discarded entirely, whereas before, aggressively reloading
  config that added and removed lots of sites would cause unnecessary
  build-up in the cache over time.

- Key certificates in the cache by their SHA-256 hash instead of
  by their names. This means certificates will not be duplicated in
  memory (within each instance), making Caddy much more memory-efficient
  for large-scale deployments with thousands of sites sharing certs.

- Perform name-to-certificate lookups scoped per caddytls.Config instead
  of a single global lookup. This prevents certificates from stepping on
  each other when they overlap in their names.

- Do not allow TLS configurations keyed by the same hostname to be
  different; this now throws an error.

- Updated relevant tests, with a stark awareness that more tests are
  needed.

- Change the NewContext function signature to include an *Instance.

- Strongly recommend (basically require) use of caddytls.NewConfig()
  to create a new *caddytls.Config, to ensure pointers to the instance
  certificate cache are initialized properly.

- Update the TLS-SNI challenge solver (even though TLS-SNI is disabled
  currently on the CA side). Store temporary challenge cert in instance
  cache, but do so directly by the ACME challenge name, not the hash.
  Modified the getCertificate function to check the cache directly for
  a name match if one isn't found otherwise. This will allow any
  caddytls.Config to be able to help solve a TLS-SNI challenge, with one
  extra side-effect that might actually be kind of interesting (and
  useless): clients could send a certificate's hash as the SNI and
  Caddy would be able to serve that certificate for the handshake.

- Do not attempt to match a \"default\" (random) certificate when SNI
  is present but unrecognized; return no certificate so a TLS alert
  happens instead.

- Store an Instance in the list of instances even while the instance
  is still starting up (this allows access to the cert cache for
  performing renewals at startup, etc). Will be removed from list again
  if instance startup fails.

- Laid groundwork for ACMEv2 and Let's Encrypt wildcard support.

Server type plugins will need to be updated slightly to accommodate
minor adjustments to their API (like passing in an Instance). This
commit includes the changes for the HTTP server.

Certain Caddyfile configurations might error out with this change, if
they configured different TLS settings for the same hostname.

This change trades some complexity for other complexity, but ultimately
this new complexity is more correct and robust than earlier logic.

Fixes #1991
Fixes #1994
Fixes #1303")`
 …

`[fc2ff91](/caddyserver/caddy/pull/2015/commits/fc2ff9155cc53393ac29885f6de83ed87093b274)`

```
- Expose the list of Caddy instances through caddy.Instances()

- Added arbitrary storage to caddy.Instance

- The cache of loaded certificates is no longer global; now scoped
  per-instance, meaning upon reload (like SIGUSR1) the old cert cache
  will be discarded entirely, whereas before, aggressively reloading
  config that added and removed lots of sites would cause unnecessary
  build-up in the cache over time.

- Key certificates in the cache by their SHA-256 hash instead of
  by their names. This means certificates will not be duplicated in
  memory (within each instance), making Caddy much more memory-efficient
  for large-scale deployments with thousands of sites sharing certs.

- Perform name-to-certificate lookups scoped per caddytls.Config instead
  of a single global lookup. This prevents certificates from stepping on
  each other when they overlap in their names.

- Do not allow TLS configurations keyed by the same hostname to be
  different; this now throws an error.

- Updated relevant tests, with a stark awareness that more tests are
  needed.

- Change the NewContext function signature to include an *Instance.

- Strongly recommend (basically require) use of caddytls.NewConfig()
  to create a new *caddytls.Config, to ensure pointers to the instance
  certificate cache are initialized properly.

- Update the TLS-SNI challenge solver (even though TLS-SNI is disabled
  currently on the CA side). Store temporary challenge cert in instance
  cache, but do so directly by the ACME challenge name, not the hash.
  Modified the getCertificate function to check the cache directly for
  a name match if one isn't found otherwise. This will allow any
  caddytls.Config to be able to help solve a TLS-SNI challenge, with one
  extra side-effect that might actually be kind of interesting (and
  useless): clients could send a certificate's hash as the SNI and
  Caddy would be able to serve that certificate for the handshake.

- Do not attempt to match a "default" (random) certificate when SNI
  is present but unrecognized; return no certificate so a TLS alert
  happens instead.

- Store an Instance in the list of instances even while the instance
  is still starting up (this allows access to the cert cache for
  performing renewals at startup, etc). Will be removed from list again
  if instance startup fails.

- Laid groundwork for ACMEv2 and Let's Encrypt wildcard support.

Server type plugins will need to be updated slightly to accommodate
minor adjustments to their API (like passing in an Instance). This
commit includes the changes for the HTTP server.

Certain Caddyfile configurations might error out with this change, if
they configured different TLS settings for the same hostname.

This change trades some complexity for other complexity, but ultimately
this new complexity is more correct and robust than earlier logic.

Fixes [#1991](https://github.com/caddyserver/caddy/issues/1991)
Fixes [#1994](https://github.com/caddyserver/caddy/issues/1994)
Fixes [#1303](https://github.com/caddyserver/caddy/issues/1303)
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
added
the
[under review 🧐](/caddyserver/caddy/labels/under%20review%20%3Amonocle_face%3A)
Review is pending before merging
label
[Feb 4, 2018](#event-1456747677)

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
added this to the [0.10.11](/caddyserver/caddy/milestone/15) milestone
[Feb 4, 2018](#event-1456747679)

 [![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
requested review from
[FiloSottile](/FiloSottile) and
[elcore](/elcore)
[February 4, 2018 08:09](#event-1456747680)

[![@francislavoie](https://avatars.githubusercontent.com/u/2111701?s=80&u=c81a19fee32a28ddd82b404636e10049fa317dfe&v=4)](/francislavoie)

Copy link

Member

### **[francislavoie](/francislavoie)** commented [Feb 4, 2018](#issuecomment-362926154)

| I had a few questions/ideas as to what this means for Caddy in the future. I'm not really reviewing the code, so I'm sorry if I'm asking things that are painfully obvious by looking at the code.  * Added arbitrary storage to caddy.Instance  This means we'll now have support for plugins adding their own storage drivers, correct? E.g. Consul (see [#1918](https://github.com/caddyserver/caddy/issues/1918)) - for situations where Caddy is a load balancer, there needs to be a way to ensure instances don't conflict with eachother when attempting to renew. Which brings me to my next question:  Caddy can now better support being used in conjunction with other Caddy instances that share the same certificate storage. In other words, if you have multiple instances all using the same $CADDYPATH, that's been a bad idea because they will all try to manage the certificates themselves (keep them renewed, etc, which runs you into rate limits fast). Now, Caddy will attempt to check if the certificate in storage still needs to be renewed just before it fires off a renewal. So if you stagger Caddy deployments by more time than it takes to complete an ACME challenge (usually just a few seconds, but if you use DNS challenge maybe minutes or more), they might play better together in an acceptable way, for small-medium scale use cases. I wouldn't rely on this for high-volume deployments (like, hundreds or thousands of instances sharing the same certificate storage and all trying to manage them) but I bet it'll be better for dozens of Caddy instances!  So this is kinda part two of the requirements in [#1918](https://github.com/caddyserver/caddy/issues/1918), locking. This PR doesn't implement locking for renewals, based on your description, right? For that usecase you described, it sounds like a lock file would be ideal (that could contain a timestamp as well to indicate the last time renewal was attempted) to alert other instances that renewal is already happening, and those other instances could give up. Maybe that's out of scope for this PR though. A lock interface would help for implementing Consul or other storage drivers.  * The cache of loaded certificates is no longer global; now scoped   per-instance  Maybe I'm getting confused by the terminology here, but does `instance` here mean individual running instances of Caddy or does it mean something smaller/internal (like an instance per site)? If the former, my understanding is that the old behaviour was a single cache for every instance running on the same machine? If the later, then was the old behaviour that each instance had its own cache (this seems like the ideal goal, so I'm leaning towards the former being the meaning)?  I ask that, because:  * Expose the list of Caddy instances through caddy.Instances()  So does each running instance now know about the other instances on the same machine? If so, neat!  The tls directive page will definitely need updating. TLS configurations for equal hostnames cannot be different. Any description about how certificates are stored internally might need to change.  This sounds like a pretty good case for recommending using the new snippet syntax ([#1921](https://github.com/caddyserver/caddy/pull/1921)) to avoid duplicated TLS blocks. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 4, 2018](#issuecomment-362927344)

| [@francislavoie](https://github.com/francislavoie) Great thoughts, let me respond to each one:  This means we'll now have support for plugins adding their own storage drivers, correct? E.g. Consul (see [#1918](https://github.com/caddyserver/caddy/issues/1918)) - for situations where Caddy is a load balancer, there needs to be a way to ensure instances don't conflict with eachother when attempting to renew  No, sorry for the confusion. This storage is simply a `map[interface{}]interface{}` that allows plugins to store things scoped to an Instance, instead of globally. This makes for better correctness and efficiency with regards to reloads (SIGUSR1, etc). Our certificate cache is stored in Instance storage instead of globals now. This is not the same as TLS storage, which I'm still thinking of how to develop it fully.  So this is kinda part two of the requirements in [#1918](https://github.com/caddyserver/caddy/issues/1918), locking. This PR doesn't implement locking for renewals, based on your description, right? For that usecase you described, it sounds like a lock file would be ideal (that could contain a timestamp as well to indicate the last time renewal was attempted) to alert other instances that renewal is already happening, and those other instances could give up. Maybe that's out of scope for this PR though. A lock interface would help for implementing Consul or other storage drivers.  Right: this PR does not totally solve the issue of shared, managed certificates among multiple Caddy instances. However, it should make any problem virtually go away as long as the instances are staggered in their execution by a few seconds to a few minutes, and as long as there aren't too many of them (hundreds or more might be too many to be safe). The TLS storage stuff I am working on in my head should introduce locking and do it properly, but those will be plugins. This solution is baked right into Caddy and should "just work" for the vast majority of people who need something like it.  Maybe I'm getting confused by the terminology here, but does instance here mean individual running instances of Caddy or does it mean something smaller/internal (like an instance per site)? If the former, my understanding is that the old behaviour was a single cache for every instance running on the same machine? If the later, then was the old behaviour that each instance had its own cache (this seems like the ideal goal, so I'm leaning towards the former being the meaning)?  Each Caddy process instantiates a literal `*Instance` value which holds all the "servers" it is running. A single Caddy process can run more than 1 instance, for example momentarily during graceful reloads, or if being used as a library. This is uncommon but still possible, and scoping things to an Instance helps us avoid global variables and keep things more correct and efficient. Before, there was a single certificate cache for the whole PROCESS, meaning reloading the config and changing sites didn't always flush the certificate cache properly. Now, each Instance value has its own cache, so a reload will just dispose of the old cache.  So does each running instance now know about the other instances on the same machine? If so, neat!  In the same process, yes. If they have to know about them, they can. The updated certificate maintenance routines run one-per-process and have to iterate the list of Instances in order to access their individual certificate caches. Then they iterate the list of certificates and perform renewals, etc.  This sounds like a pretty good case for recommending using the new snippet syntax ([#1921](https://github.com/caddyserver/caddy/pull/1921)) to avoid duplicated TLS blocks.  Good point.  Thanks for your comments! I hope this makes a little more sense! |
| --- |

All reactions

Sorry, something went wrong.

[![@francislavoie](https://avatars.githubusercontent.com/u/2111701?s=80&u=c81a19fee32a28ddd82b404636e10049fa317dfe&v=4)](/francislavoie)

Copy link

Member

### **[francislavoie](/francislavoie)** commented [Feb 4, 2018](#issuecomment-362928276)

| Ah, yeah that helps. I got a little excited that this would cover [#1918](https://github.com/caddyserver/caddy/issues/1918) because there's a few scenarios I ran into that it would really help with, i.e. load balancing your load balancers, or having certs managed by the underlying instances that are being load balanced. That's currently not possible with Caddy because they don't share certs - if one renews, the other won't know about it unless they share the same filesystem. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
mentioned this pull request
[Feb 4, 2018](#ref-issue-294130940)

[Upcoming change in Caddy will require a change in caddy-net
pieterlouw/caddy-net#5](/pieterlouw/caddy-net/issues/5)

Closed

[![elcore](https://avatars.githubusercontent.com/u/15967995?s=60&v=4)](/elcore)

**[elcore](/elcore)**
approved these changes
[Feb 9, 2018](#pullrequestreview-95412684)

 [View reviewed changes](/caddyserver/caddy/pull/2015/files/fc2ff9155cc53393ac29885f6de83ed87093b274)

Copy link

Collaborator

### @elcore **[elcore](/elcore)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Without further ado, I will approve this PR.

It is well written and documented!!

Have a wonderful day :)

Sorry, something went wrong.

All reactions

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
removed
the
[under review 🧐](/caddyserver/caddy/labels/under%20review%20%3Amonocle_face%3A)
Review is pending before merging
label
[Feb 10, 2018](#event-1468064359)

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
mentioned this pull request
[Feb 13, 2018](#ref-issue-296610173)

[Feature request: randomize TLS Let's Encrypt renewal logic
#2022](/caddyserver/caddy/issues/2022)

Closed

[![@nodesocket](https://avatars.githubusercontent.com/u/523312?s=80&u=5243a2f98a9bf73d39cb9198f19a25a42ae918f4&v=4)](/nodesocket)

Copy link

### **[nodesocket](/nodesocket)** commented [Feb 13, 2018](#issuecomment-365166787) • edited Loading

| a lock file would be ideal (that could contain a timestamp as well to indicate the last time renewal was attempted) to alert other instances that renewal is already happening, and those other instances could give up.  👍  That also means that incoming requests would be blocked until the TLS renew lock is removed right? |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 13, 2018](#issuecomment-365168411) • edited Loading

| [@nodesocket](https://github.com/nodesocket)  a lock file would be ideal (that could contain a timestamp as well to indicate the last time renewal was attempted) to alert other instances that renewal is already happening, and those other instances could give up.  👍 That also means that incoming requests would be blocked until the TLS renew lock is removed right?  I wouldn't go too far with the quoted suggestion (no offense Francis, ha) -- what we'd rather have is a truly atomic "create-file-if-not-exists" operation, provided by the OS. Right now, Caddy does not utilize any such features, which is why cert management, even with this PR, is not truly synchronized.  And no, incoming requests are NOT blocked while certificate maintenance happens. Maintenance happens in the background and is entirely non-blocking after Caddy starts up. |
| --- |

All reactions

Sorry, something went wrong.

 [mholt](/mholt)
added 3 commits
[February 13, 2018 13:23](#commits-pushed-0802871)

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: Synchronize renewals between Caddy instances sharing file storage](/caddyserver/caddy/pull/2015/commits/08028714b57540a46209b6ab094c0a9cc103830f "tls: Synchronize renewals between Caddy instances sharing file storage

Also introduce caddy.OnProcessExit which is a list of functions that
run before exiting the process cleanly; these do not count as shutdown
callbacks, so they do not return errors and must execute quickly.")`
 …

`[0802871](/caddyserver/caddy/pull/2015/commits/08028714b57540a46209b6ab094c0a9cc103830f)`

```
Also introduce caddy.OnProcessExit which is a list of functions that
run before exiting the process cleanly; these do not count as shutdown
callbacks, so they do not return errors and must execute quickly.
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[Merge branch 'master' into cert-cache](/caddyserver/caddy/pull/2015/commits/f26447e2fb4111c9628adbbbc2c85d919d63004b "Merge branch 'master' into cert-cache

# Conflicts:
#	sigtrap_posix.go")`
 …

`[f26447e](/caddyserver/caddy/pull/2015/commits/f26447e2fb4111c9628adbbbc2c85d919d63004b)`

```
# Conflicts:
#	sigtrap_posix.go
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[sigtrap: Ensure cleanup actions happen before too many things go wrong](/caddyserver/caddy/pull/2015/commits/4b2e22289d9c7423eea2f9b44430bfefed074d8f "sigtrap: Ensure cleanup actions happen before too many things go wrong")`

`[4b2e222](/caddyserver/caddy/pull/2015/commits/4b2e22289d9c7423eea2f9b44430bfefed074d8f)`

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 13, 2018](#issuecomment-365393967) • edited Loading

| [@nodesocket](https://github.com/nodesocket) I just pushed some changes which make Caddy synchronize its renewals using the file system, so multiple instances can run at the same time and safely coordinate renewals. You won't have to stagger the execution of Caddy processes anymore, and this should scale well to thousands of instances. Would you please test this and report back?  (NOTE: Use the DNS challenge when behind a load balancer.) |
| --- |

 🎉
1
 francislavoie reacted with hooray emoji

All reactions

* 🎉
  1 reaction

Sorry, something went wrong.

[![@nodesocket](https://avatars.githubusercontent.com/u/523312?s=80&u=5243a2f98a9bf73d39cb9198f19a25a42ae918f4&v=4)](/nodesocket)

Copy link

### **[nodesocket](/nodesocket)** commented [Feb 13, 2018](#issuecomment-365395050) • edited Loading

| [@mholt](https://github.com/mholt) thanks for this. Awesome. Can you give a brief overview of how it works? I assume still need to use a shared file system like NFS *(Amazon Elastic File System)* correct? This is not doing any rsync magic is it? |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 13, 2018](#issuecomment-365396242) • edited Loading

| [@nodesocket](https://github.com/nodesocket) It should "just work" - yes, it'll use the file system. No rsync; the .caddy folder (well, $CADDYPATH) must be locally mounted. This design may not be 100% perfect -- I'm guessing more like 99.5% or thereabouts, assuming there are no implementation bugs (ha!) -- but it doesn't need to be perfect, since rate limits have a little bit of tolerance.  By the way, if your company is relying on Caddy, I highly suggest ordering [extended support](https://caddyserver.com/products/support). If you encounter any bugs, it'll ensure a quicker resolution for your business. 👍 |
| --- |

 ❤️
1
 lbguilherme reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@nodesocket](https://avatars.githubusercontent.com/u/523312?s=80&u=5243a2f98a9bf73d39cb9198f19a25a42ae918f4&v=4)](/nodesocket)

Copy link

### **[nodesocket](/nodesocket)** commented [Feb 13, 2018](#issuecomment-365446486)

| [@mholt](https://github.com/mholt) can you provide instructions on how to build this? I assume I need to compile myself? |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 14, 2018](#issuecomment-365448955)

| [@nodesocket](https://github.com/nodesocket)  can you provide instructions on how to build this? I assume I need to compile myself?  Yes :) Just like you've been building it up to now, except on this branch instead of master. (If you haven't been building from source, then you should get a commercial license if you haven't already.)  The build instructions are [in the README](https://github.com/mholt/caddy#build) -- just switch to this branch. |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 14, 2018](#issuecomment-365697659) • edited Loading

| Did some testing between this branch and master, with the following caddyfile  ```     subdomain.host.com:443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start "t={when_unix}000"       }       tls /star-subdomain-host-cert/tls.crt /star-subdomain-host-cert/tls.key     }     *.subdomain.host.com:443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start "t={when_unix}000"       }       tls /star-subdomain-host-cert/tls.crt /star-subdomain-host-cert/tls.key     }     :443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 10         storage mysql       }     }     :80 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 10         storage mysql       }     }  ```  I find that when I visit `subdomain.host.com` I get cert a let's encrypt certificate. On master this serves the certificate that I've provided. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 14, 2018](#issuecomment-365699381) • edited Loading

| [@dschwar](https://github.com/dschwar) Thanks for trying it out! What's the `storage mysql` thing you have going on? That seems custom. Please try again without modifications so I can work on reproducing the issue. That will be helpful so we can be sure we're working with the same code base! |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 14, 2018](#issuecomment-365709539)

| After removing the mysql plugin, I tested master vs your branch. On master it loads the provided cert of `subdomain.host.com`, on this branch. it looks like it's attempting to get a LE cert, but fails. I probably don't have the filesystem configured properly though.  ``` 2018/02/14 18:52:18 [INFO] Obtaining new certificate for subdomain.host.com 2018/02/14 18:52:19 [INFO] acme: Registering account for email@host.com 2018/02/14 18:52:20 http: TLS handshake error from 10.111.0.2:15721: open /root/.caddy/acme/acme-v01.api.letsencrypt.org/sites/subdomain.host.com/subdomain.host.com.crt.lock: no such file or directory  ```  The weird thing is, if I browse a site like `secondary.subdomain.host.com`, then subsequent requests to `subdomain.host.com` will be served using the provided cert. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 14, 2018](#issuecomment-365712180)

| Thanks for giving it another go! We're getting closer.  First thing -- *and you should do this immediately* -- use the Let's Encrypt [staging endpoint](https://letsencrypt.org/docs/staging-environment/) for testing! Set it [with the `-ca` flag](https://caddyserver.com/docs/cli#ca). Or you may hit rate limits.  Are you running caddy as the same user as who owns that directory, etc? Also, is this subdomain new (i.e. does the containing folder listed in the error message already exist on disk)? |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 14, 2018](#issuecomment-365715114)

| Are you running caddy as the same user as who owns that directory, etc?  Yup  ``` ~/.caddy/acme/acme-v01.api.letsencrypt.org # ls -la total 12 drwx------    3 root     root          4096 Feb 14 18:52 . drwx------    3 root     root          4096 Feb 14 18:52 .. drwx------    3 root     root          4096 Feb 14 18:52 users ~/.caddy/acme/acme-v01.api.letsencrypt.org # whoami root ~/.caddy/acme/acme-v01.api.letsencrypt.org # ps aux PID   USER     TIME   COMMAND     1 root       0:00 /usr/bin/caddy --conf /caddy/Caddyfile --log stdout --email email@host.com --host subdomain.host.com  ```  Also, is this subdomain new (i.e. does the containing folder listed in the error message already exist on disk)?  The containing folder doesn't exist (see output pasted above). Should caddy be trying to provision a LE cert for `subdomain.host.com` since that cert is part of the `tls /star-subdomain-host-cert/tls.crt /star-subdomain-host-cert/tls.key`? |
| --- |

 👍
1
 mholt reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 14, 2018](#issuecomment-365721657)

| Now we're getting somewhere. So there's 2 things going on: opening a lock file where the parent dir doesn't exist, and the subdomain thing. I'm looking into it... |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 14, 2018](#issuecomment-365731339)

| [@dschwar](https://github.com/dschwar) PS. If you want to help dive into the code and help debug it (since I have to work to reproduce it) -- specifically help with the problem of serving the wrong certificate -- I would really appreciate it. And it would help us get it fixed sooner. You'd want to look in `caddytls/handshake.go` -- probably putting some prints in some of the getConfig or getCertificate functions should help! |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: Ensure parent dir exists before creating lock file](/caddyserver/caddy/pull/2015/commits/ef585ed810a6913e7174c19ed383ddba9c3949ed "tls: Ensure parent dir exists before creating lock file")`

`[ef585ed](/caddyserver/caddy/pull/2015/commits/ef585ed810a6913e7174c19ed383ddba9c3949ed)`

7 hidden items

Load more…

[![@nodesocket](https://avatars.githubusercontent.com/u/523312?s=80&u=5243a2f98a9bf73d39cb9198f19a25a42ae918f4&v=4)](/nodesocket)

Copy link

### **[nodesocket](/nodesocket)** commented [Feb 15, 2018](#issuecomment-365827130)

| [@mholt](https://github.com/mholt) Let's Encrypt staging is still timing-out for me. I can't believe others are not encountering this after 4+ hours. Just curious, are you testing from AWS EC2 instances? I am. |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365827365)

| [@dschwar](https://github.com/dschwar) Thanks; I'm wondering, though, how [WARNING] TLS disabled for <http://subdomain.host.com> made its way into there from your Caddyfile. And also that there is a TLSConfig for "subdomain.host.com" at the same time. This isn't a behavior I'm observing...  This seems to happen because I have the command line `-host` arg set to `subdomain.host.com`.  I tried removing the `-host` command line arg, which gives me the log `[WARNING] TLS disabled for http://` and then `subdomain.host.com` is served using the appropriate provided certificate, but Let's Encrypt no longer provisions.  So I tried changing the `-host` arg to `https://subdomain.host.com` and now I get `WARNING] TLS disabled for http://https://subdomin.host.com` |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365828703)

| [@nodesocket](https://github.com/nodesocket)  Let's Encrypt staging is still timing-out for me. I can't believe others are not encountering this after 4+ hours. Just curious, are you testing from AWS EC2 instances? I am.  Nope, not using EC2. Thanks for commenting on their forums -- hopefully they'll find it soon. Not many people use staging except client developers I think.  [@dschwar](https://github.com/dschwar) -- okay, I think what you'll need to do is simplify your config down to bare-bones. Run caddy without any extra command line args (except to set the staging endpoint!) and then run Caddy again with a simple Caddyfile. I can help debug it but only if I have all the information: how Caddy was run, what env variables are set, the Caddyfile, log output, requests that are made, etc -- all unredacted and unmodified. Otherwise, I can only give you tips to help you debug it on your end.  (The `-host` flag, [per the docs](https://caddyserver.com/docs/cli#host) specifies a default host to listen on; so if the hostname defined in the Caddyfile is empty, it will be filled in with `-host`. And `https://...` is not a host, of course. Remember, Caddy is very easy to use, but has enough power that you can easily shoot yourself in the foot. Unlike other web servers, with Caddy, you'll want to trim back the config when things start getting complicated.) |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365831518) via email

| [@mholt](https://github.com/mholt) I can test this tomorrow but my current hypothesis is that if the ‘-host’ flag is supplied and there is a Caddyfile with a supplied tls cert for that host and a wildcard on-demand config, then when you visit the host, it will choose to generate an on demand cert. …  On Feb 15, 2018, at 12:23 AM, Matt Holt \*\*\*@\*\*\*.\*\*\*> wrote: [@nodesocket](https://github.com/nodesocket) Let's Encrypt staging is still timing-out for me. I can't believe others are not encountering this after 4+ hours. Just curious, are you testing from AWS EC2 instances? I am. Nope, not using EC2. Thanks for commenting on their forums -- hopefully they'll find it soon. Not many people use staging except client developers I think. [@dschwar](https://github.com/dschwar) -- okay, I think what you'll need to do is simplify your config down to bare-bones. Run caddy without any extra command line args (except to set the staging endpoint!) and then run Caddy again with a simple Caddyfile. I can help debug it but only if I have all the information: how Caddy was run, what env variables are set, the Caddyfile, log output, requests that are made, etc -- all unredacted and unmodified. Otherwise, I can only give you tips to help you debug it on your end. (The -host flag, per the docs specifies a default host to listen on; so if the hostname defined in the Caddyfile is empty, it will be filled in with -host. And https://... is not a host, of course. Remember, Caddy is very easy to use, but has enough power that you can easily shoot yourself in the foot. Unlike other web servers, with Caddy, you'll want to trim back the config when things start getting complicated.) — You are receiving this because you were mentioned. Reply to this email directly, view it on GitHub, or mute the thread. |
| --- |

 👍
1
 mholt reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365832234)

| [@dschwar](https://github.com/dschwar) Ahhhh, wait, it's only generating the certificate on-demand (i.e. not at startup)? Is `subdomain.host.com` that you visit in your browser the exact same one as the first site in your Caddyfile, `subdomain.host.com:443`? If so, then what you found may not be a bug with the TLS changes. If you set `-host subdomain.host.com` and then define a site in the Caddyfile with an empty hostname (`:443` for example) then that site is assigned a default hostname of `subdomain.host.com` according to your flag. Thus there is a duplicate site name and that should be caught at startup. Let me know what you think. |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365834133) via email

| [@dschwar](https://github.com/dschwar) Ahhhh, wait, it's only generating the certificate on-demand (i.e. not at startup)? Yup, only on demand. Should have mentioned that earlier, sorry.  Is subdomain.host.com that you visit in your browser the exact same one as the first site in your Caddyfile, subdomain.host.com:443? Yup. When redacting, I made sure everything matches up and is in the same form.  hostname (:443 for example) I thought a :443 would give me a wildcard host? So that I can generate certs for any domain that points at my server (hence why I redact, don’t want spam) …  On Feb 15, 2018, at 12:51 AM, Matt Holt \*\*\*@\*\*\*.\*\*\*> wrote: [@dschwar](https://github.com/dschwar) Ahhhh, wait, it's only generating the certificate on-demand (i.e. not at startup)? Is subdomain.host.com that you visit in your browser the exact same one as the first site in your Caddyfile, subdomain.host.com:443? If so, then what you found may not be a bug with the TLS changes. If you set -host subdomain.host.com and then define a site in the Caddyfile with an empty hostname (:443 for example) then that site is assigned a default hostname of subdomain.host.com according to your flag. Thus there is a duplicate site name and that should be caught at startup. Let me know what you think. — You are receiving this because you were mentioned. Reply to this email directly, view it on GitHub, or mute the thread. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365835843) • edited Loading

| [@dschwar](https://github.com/dschwar) Thanks for clarifying.  I thought a :443 would give me a wildcard host? So that I can generate certs for any domain that points at my server  Well, the `-host` flag sets the host when it is missing for site configurations. Generally, `-host` is used without a Caddyfile to even more quickly get a simple site up and running. The `-host` flag *can* be used in conjunction with one in some cases for convenience, but your case is not one of them.  (hence why I redact, don’t want spam)  Won't matter -- all hostnames with Let's Encrypt certificates go to public CT logs anyway. In fact, soon all certificates will need to be submitted to CT.  Anyway, I'm thinking of making your situation a "collision" at startup, because otherwise it's not obvious. In other words, using `-host subdomain.host.com` and with sites `subdomain.host.com` and `:443` in your Caddyfile should be an error because the second site is indistinguishable from the first. Sound good? |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[httpserver: Raise error when adjusted site addresses clash at startup](/caddyserver/caddy/pull/2015/commits/be96cc0e656de2cac5913508f1dfab79872bfd7e "httpserver: Raise error when adjusted site addresses clash at startup

See discussion on #2015 for how this situation was discovered. For a
Caddyfile like this:

	localhost {
		...
	}
	:2015 {
		...
	}

Running Caddy like this:

	caddy -host localhost

Produces two sites both defined as `localhost:2015` because the flag
changes the default host value to be `localhost`. This should be an
error since the sites are not distinct and it is confusing. It can also
cause issues with TLS handshakes loading the wrong cert, as the linked
discussion shows.")`
 …

`[be96cc0](/caddyserver/caddy/pull/2015/commits/be96cc0e656de2cac5913508f1dfab79872bfd7e)`

```
See discussion on [#2015](https://github.com/caddyserver/caddy/pull/2015) for how this situation was discovered. For a
Caddyfile like this:

	localhost {
		...
	}
	:2015 {
		...
	}

Running Caddy like this:

	caddy -host localhost

Produces two sites both defined as `localhost:2015` because the flag
changes the default host value to be `localhost`. This should be an
error since the sites are not distinct and it is confusing. It can also
cause issues with TLS handshakes loading the wrong cert, as the linked
discussion shows.
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365842207)

| [@dschwar](https://github.com/dschwar) I've pushed that fix to this branch; feel free to try it out and let me know. You should now get an error when you try to start Caddy with the configuration you had. The reason you were getting the wrong certificate is because Caddy couldn't disambiguate between the two site configurations because of your `-host` flag: the sites weren't distinct, even though they had different configurations. So now we prevent this case, by raising an error at startup. |
| --- |

All reactions

Sorry, something went wrong.

[![@pieterlouw](https://avatars.githubusercontent.com/u/4508077?s=40&v=4)](/pieterlouw)
[pieterlouw](/pieterlouw)
mentioned this pull request
[Feb 15, 2018](#ref-issue-294579675)

[TLS support is broken
pieterlouw/caddy-net#6](/pieterlouw/caddy-net/issues/6)

Closed

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365955433)

| [@dschwar](https://github.com/dschwar) I've pushed that fix to this branch; feel free to try it out and let me know. You should now get an error when you try to start Caddy with the configuration you had. The reason you were getting the wrong certificate is because Caddy couldn't disambiguate between the two site configurations because of your -host flag: the sites weren't distinct, even though they had different configurations. So now we prevent this case, by raising an error at startup.  I think I'm missing something now. I've removed the `-host subdomain.host.com` arg and now when I visit `www.davesdomain.com` which CNAME's to `subdomain.host.com`, Chrome gives me a `This site can’t provide a secure connection`  and the logs show  ``` 2018/02/15 14:49:29 [INFO] Successfully loaded TLS assets from /star-subdomain-hostcom-cert/tls.crt and /star-subdomain-hostcom-cert/tls.key 2018/02/15 14:49:29 [INFO] Successfully loaded TLS assets from /star-subdomain-hostcom-cert/tls.crt and /star-subdomain-hostcom-cert/tls.key Activating privacy features... done. 2018/02/15 14:49:29 [WARNING] TLS disabled for http:// https://subdomain.host.com 2018/02/15 14:49:29 https://subdomain.host.com https://*.subdomain.host.com 2018/02/15 14:49:29 https://*.subdomain.host.com https:// 2018/02/15 14:49:29 https:// http:// 2018/02/15 14:49:29 http:// 2018/02/15 14:52:30 [INFO] getCertificate for name: www.davesdomain.com (map[string]string) (len=2) {  (string) (len=32) "*.subdomain.host.com": (string) (len=64) "41z9d420f85af211afdsfsdgdsfhfghfgdhjghjghfkhjkjhkjhgkjhgkjhgc122b7",  (string) (len=30) "subdomain.host.com": (string) (len=64) "41z9d420f85af211afdsfsdgdsfhfghfgdhjghjghfkhjkjhkjhgkjhgkjhgc122b7" } 2018/02/15 14:52:30 [INFO] onDemand: false, loadIfNecessary: true, obtainIfNecessary: true 2018/02/15 14:52:30 http: TLS handshake error from 10.234.0.25:23064: no certificate available for www.davesdomain.com  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365958458)

| [@dschwar](https://github.com/dschwar) Thanks, I think I'm finally onto a fix. Just a hunch, can you verify that replacing the site named `:443` in your Caddyfile with `*:443` acts different? |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365965153)

| Just a hunch, can you verify that replacing the site named :443 in your Caddyfile with \*:443 acts different?  Seems to do the same thing |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: Try empty name if no matches for getting config during handshake](/caddyserver/caddy/pull/2015/commits/896dc6bc690bce51884bd43da91180882ce90cab "tls: Try empty name if no matches for getting config during handshake

See discussion on #2015; the initial change had removed this check, and
I can't remember why I removed it or if it was accidental. Anyway, it's
back now.")`
 …

`[896dc6b](/caddyserver/caddy/pull/2015/commits/896dc6bc690bce51884bd43da91180882ce90cab)`

```
See discussion on [#2015](https://github.com/caddyserver/caddy/pull/2015); the initial change had removed this check, and
I can't remember why I removed it or if it was accidental. Anyway, it's
back now.
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365968618)

| [@dschwar](https://github.com/dschwar) Hmm well that's discouraging. Are you sure? If you could pull the latest and try again -- with and without the `*`, that would be good. I was able to reproduce what I think is the issue, in that it was getting the wrong config for the name. If you could try it after pulling my latest commit, then let me know, that would be great! |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365974295) • edited Loading

| It works!  without the `*`  Caddyfile  ```     subdomain.host.com:443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls /star-subdomain-hostcom-cert/tls.crt /star-subdomain-hostcom-cert/tls.key     }     *.subdomain.host.com:443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls /star-subdomain-hostcom-cert/tls.crt /star-subdomain-hostcom-cert/tls.key     }     :443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 5000       }     }     :80 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 5000       }     }  ```  Thanks so much 🎉 |
| --- |

 🎉
1
 mholt reacted with hooray emoji

All reactions

* 🎉
  1 reaction

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365974952)

| [@dschwar](https://github.com/dschwar) Great!! It should work with the `*` as well.  I'll merge this PR as Go 1.10 is released, unless someone speaks up with another bug report before then. |
| --- |

All reactions

Sorry, something went wrong.

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-365978586)

| It should work with the \* as well.  Testing that (for fun), when you say it should with `*`, do you mean  ```     *:443 {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 5000       }     }  ```  or  ```     * {       proxy / web:8000 {         transparent         header_upstream X-Request-Start-Edge {>X-Request-Start}         header_upstream X-Request-Start "t={when_unix}000"       }       tls {         max_certs 5000       }     }  ```  I just attempted the first one and it doesn't work for me. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 15, 2018](#issuecomment-365987235)

| The first one. That should work, (it works for me), so if you want to investigate feel free! |
| --- |

All reactions

Sorry, something went wrong.

[![@tobya](https://avatars.githubusercontent.com/u/325502?s=40&v=4)](/tobya)

`[Merge branch 'master' into cert-cache](/caddyserver/caddy/pull/2015/commits/4704a56a1789c72b2b42c6107da4c9d64d8d716d "Merge branch 'master' into cert-cache")`

`[4704a56](/caddyserver/caddy/pull/2015/commits/4704a56a1789c72b2b42c6107da4c9d64d8d716d)`

[![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=80&v=4)](/dschwar)

Copy link

### **[dschwar](/dschwar)** commented [Feb 15, 2018](#issuecomment-366057855)

| The first one. That should work, (it works for me), so if you want to investigate feel free!  It seems to work if I remove the `subdomain.host.com:443` and `*.subdomain.host.com:443` from my Caddyfile, the resulting Caddyfile becomes  ``` *:443 {   proxy / web:8000 {     transparent     header_upstream X-Request-Start-Edge {>X-Request-Start}     header_upstream X-Request-Start "t={when_unix}000"   }   tls {     max_certs 5000   } } *:80 {   proxy / web:8000 {     transparent     header_upstream X-Request-Start-Edge {>X-Request-Start}     header_upstream X-Request-Start "t={when_unix}000"   }   tls {     max_certs 5000   } }  ```  with the command line args `["--conf", "/caddy/Caddyfile", "--log", "stdout", "--email", "myemail@host.com", "--ca", "https://acme-staging.api.letsencrypt.org/directory"]` |
| --- |

All reactions

Sorry, something went wrong.

 [mholt](/mholt)
added 2 commits
[February 16, 2018 12:05](#commits-pushed-8db80c4)

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: Fix HTTP->HTTPS redirects and HTTP challenge when using custom port](/caddyserver/caddy/pull/2015/commits/8db80c4a88e53c9b710dc7753fd2561fa974ffb2 "tls: Fix HTTP->HTTPS redirects and HTTP challenge when using custom port")`

`[8db80c4](/caddyserver/caddy/pull/2015/commits/8db80c4a88e53c9b710dc7753fd2561fa974ffb2)`

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&v=4)](/mholt)

`[tls: In HTTP->HTTPS redirects, preserve redir port in some circumstances](/caddyserver/caddy/pull/2015/commits/a03eba6fbc2770ef6bbe7defa184ec4a6817f0c2 "tls: In HTTP->HTTPS redirects, preserve redir port in some circumstances

Only strip the port from the Location URL value if the port is NOT the
HTTPSPort (before, we compared against DefaultHTTPSPort instead of
HTTPSPort). The HTTPSPort can be changed, but is done so for port
forwarding, since in reality you can't 'change' the standard HTTPS port,
you can only forward it.")`
 …

`[a03eba6](/caddyserver/caddy/pull/2015/commits/a03eba6fbc2770ef6bbe7defa184ec4a6817f0c2)`

```
Only strip the port from the Location URL value if the port is NOT the
HTTPSPort (before, we compared against DefaultHTTPSPort instead of
HTTPSPort). The HTTPSPort can be changed, but is done so for port
forwarding, since in reality you can't 'change' the standard HTTPS port,
you can only forward it.
```

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=80&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)

Copy link

Member

Author

### **[mholt](/mholt)** commented [Feb 16, 2018](#issuecomment-366337178) • edited Loading

| [@dschwar](https://github.com/dschwar) Ah, you know what, I'm sorry -- that is correct and expected behavior; I was wrong before. Wildcard characters (`*`) only match a single domain label (e.g. `sub.domain.com` cannot be matched by `*` but or even `*.*` but can be matched by `*.*.*`), as per the RFC related to wildcard SSL certificates.  So actually I think that remaining "bug" is a non-issue. (PS. You can't serve tls on port 80 with Caddy, so you can remove that from your configuration.) However, the investigation led me to fix what I think was some logical inconsistencies in the code, so it was all good. I'm gonna merge this real soon. Probably today. |
| --- |

All reactions

Sorry, something went wrong.

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
mentioned this pull request
[Feb 16, 2018](#ref-issue-265203973)

[Consul KV and Vault for TLS certificate storage
#1918](/caddyserver/caddy/issues/1918)

Closed

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
merged commit [`986d4ff`](/caddyserver/caddy/commit/986d4ffe3de32dcb81d334d603a2f0f1d460eb2f)
into
master

[Feb 16, 2018](https://github.com/caddyserver/caddy/pull/2015#event-1478564157)

 [![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
deleted the
cert-cache

branch
[February 16, 2018 19:49](#event-1478568519)

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
mentioned this pull request
[Feb 22, 2018](#ref-issue-299364091)

[onevent bug: need to deregister previous hooks after graceful restart
#2044](/caddyserver/caddy/issues/2044)

Closed

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=40&u=f5cb951b9d7eb2940bd90e879b7a8f3b427b1656&v=4)](/mholt)
[mholt](/mholt)
mentioned this pull request
[Nov 12, 2018](#ref-pullrequest-379926039)

[caddytls: Raise TLS alert if no certificate matches SAN (closes #1303)
#2339](/caddyserver/caddy/pull/2339)
 Merged

[![@tatianab](https://avatars.githubusercontent.com/u/6238967?s=40&v=4)](/tatianab)
[tatianab](/tatianab)
mentioned this pull request
[Nov 8, 2023](#ref-issue-1984467287)

[x/vulndb: potential Go vuln in github.com/mholt/caddy: CVE-2018-19148
golang/vulndb#2217](/golang/vulndb/issues/2217)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fpull%2F2015)

Reviewers

[![@elcore](https://avatars.githubusercontent.com/u/15967995?s=40&v=4)](/elcore) [elcore](/elcore)

elcore approved these changes

[![@FiloSottile](https://avatars.githubusercontent.com/u/1225294?s=40&v=4)](/FiloSottile) [FiloSottile](/FiloSottile)

 Awaiting requested review from FiloSottile

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

 [**0.10.11**](/caddyserver/caddy/milestone/15 "0.10.11")

Development

Successfully merging this pull request may close these issues.

 [old certificate is used after switching to on-demand let's encrypt](https://github.com/caddyserver/caddy/issues/1994)

 [Wrong certificate when mixing on-demand and manual TLS](https://github.com/caddyserver/caddy/issues/1991)

 [Caddy serves wrong SSL cert for site that is not served on HTTPS port](https://github.com/caddyserver/caddy/issues/1303)

6 participants

[![@mholt](https://avatars.githubusercontent.com/u/1128849?s=52&v=4)](/mholt) [![@francislavoie](https://avatars.githubusercontent.com/u/2111701?s=52&v=4)](/francislavoie) [![@nodesocket](https://avatars.githubusercontent.com/u/523312?s=52&v=4)](/nodesocket) [![@dschwar](https://avatars.githubusercontent.com/u/17007475?s=52&v=4)](/dschwar) [![@elcore](https://avatars.githubusercontent.com/u/15967995?s=52&v=4)](/elcore) [![@tobya](https://avatars.githubusercontent.com/u/325502?s=52&v=4)](/tobya)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b5260094_20250125_161133.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fissues%2F1303)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fissues%2F1303)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=caddyserver%2Fcaddy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[caddyserver](/caddyserver)
/
**[caddy](/caddyserver/caddy)**
Public

* [Notifications](/login?return_to=%2Fcaddyserver%2Fcaddy) You must be signed in to change notification settings
* [Fork
  4.2k](/login?return_to=%2Fcaddyserver%2Fcaddy)
* [Star
   60.9k](/login?return_to=%2Fcaddyserver%2Fcaddy)

* [Code](/caddyserver/caddy)
* [Issues
  123](/caddyserver/caddy/issues)
* [Pull requests
  28](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

Additional navigation options

* [Code](/caddyserver/caddy)
* [Issues](/caddyserver/caddy/issues)
* [Pull requests](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

# Caddy serves wrong SSL cert for site that is not served on HTTPS port #1303

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosed[#2015](https://github.com/caddyserver/caddy/pull/2015)Closed[Caddy serves wrong SSL cert for site that is not served on HTTPS port](#top)#1303[#2015](https://github.com/caddyserver/caddy/pull/2015)Copy linkLabels[discussion 💬The right solution needs to be found](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22discussion%20%3Aspeech_balloon%3A%22)The right solution needs to be found[feature ⚙️New feature or request](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22feature%20%3Agear%3A%22)New feature or request[![@mxlje](https://avatars.githubusercontent.com/u/1345545?u=883bf0aa77d6c504a13d588281d2d0206c108df4&v=4&size=80)](/mxlje)
## Description

[![@mxlje](https://avatars.githubusercontent.com/u/1345545?u=883bf0aa77d6c504a13d588281d2d0206c108df4&v=4&size=48)](/mxlje)[mxlje](https://github.com/mxlje)opened [on Dec 19, 2016](https://github.com/caddyserver/caddy/issues/1303#issue-196372904)
### 1. What version of Caddy are you running (`caddy -version`)?

```
Caddy 0.9.3

```
### 2. What are you trying to do?

I want to have multiple virtual hosts, some http**s**, some http only. I want the http only hosts to not respond to http**s** requests with a wrong certificate.

### 3. What is your entire Caddyfile?

```
https://foo.example.com {
  tls self_signed
  root /html/foo
}

http://bar.example.com {
  tls off
  root /html/bar
}

```
### 4. How did you run Caddy (give the full command and describe the execution environment)?

I created the reproducible example from above on my Mac (`10.11.6`) but I am having this problem in production on `Ubuntu 16.04.1 LTS`  so I don’t think it is OS related. The working directory contains the `Caddyfile` from above.

```
$ sudo caddy

```
### 5. What did you expect to see?

Caddy starts fine and serves both vhosts, one with https and the other with http. I expect Caddy to **not respond at all** when I try to access `https://bar.example.com` as that virtual hosts is explicitly configured as http, not http**s**.

### 6. What did you see instead (give full error messages and/or log)?

When accessing `https://bar.example.com` (the host which is explicitly http), Caddy sends the cert for `foo.example.com`, which results in an SSL error. (I know that in this example it always results in an error because the cert is self signed, but in production this would serve a trusted cert from Let’s Encrypt).

When ignoring the warning, Caddy responds with `No such site at :443`. While this is technically correct, Caddy should not accept the connection in the first place.

In addition to the SSL error, this also **leaks information** about at least one other site (the one Caddy takes the certificate from) that is set up on the host.

### 7. How can someone who is starting from scratch reproduce this behavior as minimally as possible?

1. Use the `Caddyfile` from step 3.
2. Update the `root` directive so that Caddy finds some files to serve
3. Edit your `/etc/hosts` to include the following
4. Start Caddy as described in step 4.

```
# /etc/hosts
127.0.0.1 foo.example.com
127.0.0.1 bar.example.com

```

---

Thanks so much for any responses. I’m sorry if there is already an issue for this or if this is a known bug, I couldn’t find anything related to this.

## Metadata

### Assignees

No one assigned

### Labels

[discussion 💬The right solution needs to be found](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22discussion%20%3Aspeech_balloon%3A%22)The right solution needs to be found[feature ⚙️New feature or request](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22feature%20%3Agear%3A%22)New feature or request
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_09e9015c_20250125_161135.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fissues%2F2334)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcaddyserver%2Fcaddy%2Fissues%2F2334)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=caddyserver%2Fcaddy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[caddyserver](/caddyserver)
/
**[caddy](/caddyserver/caddy)**
Public

* [Notifications](/login?return_to=%2Fcaddyserver%2Fcaddy) You must be signed in to change notification settings
* [Fork
  4.2k](/login?return_to=%2Fcaddyserver%2Fcaddy)
* [Star
   60.9k](/login?return_to=%2Fcaddyserver%2Fcaddy)

* [Code](/caddyserver/caddy)
* [Issues
  123](/caddyserver/caddy/issues)
* [Pull requests
  28](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

Additional navigation options

* [Code](/caddyserver/caddy)
* [Issues](/caddyserver/caddy/issues)
* [Pull requests](/caddyserver/caddy/pulls)
* [Actions](/caddyserver/caddy/actions)
* [Security](/caddyserver/caddy/security)
* [Insights](/caddyserver/caddy/pulse)

# Problem with the way Caddy serves multiple certificates #2334

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Problem with the way Caddy serves multiple certificates](#top)#2334Copy linkLabels[invalid ❓This doesn't seem right](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22invalid%20%3Aquestion%3A%22)This doesn't seem right[![@ghost](https://github.com/ghost.png?size=80)](/ghost)
## Description

[![@ghost](https://github.com/ghost.png?size=48)](/ghost)[ghost](/ghost)opened [on Nov 5, 2018](https://github.com/caddyserver/caddy/issues/2334#issue-377287082)
### 1. What version of Caddy are you using (`caddy -version`)?

Caddy 0.11.0 (+22dfb14 Sun Nov 04 19:32:32 UTC 2018) (unofficial)

### 2. What are you trying to do?

I'm trying to fetch a certificate from my domain app01.domain.tld by using the following shell script.

```
#!/bin/bash
#
# usage: sh script.sh app01.domain.tld 443
#
REMHOST=$1
REMPORT=${2:-443}

echo |\
openssl s_client -connect ${REMHOST}:${REMPORT} 2>&1 |\
sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'

```
### 3. What is your entire Caddyfile?

```
(ecc-tls) {

   tls {
       dns gandiv5
       ciphers ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-WITH-CHACHA20-POLY1305
       key_type p256
       must_staple
    }
}

app01.domain.tld {

   import ecc-tls
}

app02.domain.tld {

   import ecc-tls
}

app03.domain.tld {

   import ecc-tls
}

```
### 4. How did you run Caddy (give the full command and describe the execution environment)?

```
caddy -agree -http2 -quic -log /opt/caddy/log -root /opt/caddy/webroot -conf /opt/caddy/Caddyfile

```

I'm running Caddy on Debian 9.5 (stretch).

### 5. Please paste any relevant HTTP request(s) here.

N/A

### 6. What did you expect to see?

The certificate of app01.domain.tld.

### 7. What did you see instead (give full error messages and/or log)?

The certificate of either app01, app02 or app03.domain.tld. The certificate changes each time you run the shell script.

### 8. How can someone who is starting from scratch reproduce the bug as minimally as possible?

1. Install Caddy.
2. Set up three or more subdomains on your own domain.
3. Copy my Caddyfile and adjust it as needed to fetch a certificate for each subdomain.
4. Use the provided shell script to fetch the certificate of one of the subdomains.

This issue does not affect sites which are not served with Caddy. To verify this, run the same shell script on such a domain and observe that the certificate in the output is the same every time you run it and that it is the correct one for the domain.

The practical relevance of this problem is that the remote control software MeshCentral cannot fetch the correct certificate from a subdomain that is served with Caddy because it [receives a different certificate](https://github.com/Ylianst/MeshCentral/issues/30#issuecomment-435291069) each time it tries to fetch it.

## Metadata

### Assignees

No one assigned

### Labels

[invalid ❓This doesn't seem right](https://github.com/caddyserver/caddy/issues?q=state%3Aopen%20label%3A%22invalid%20%3Aquestion%3A%22)This doesn't seem right
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


