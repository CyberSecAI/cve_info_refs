=== Content from bugzilla.nasm.us_d02f9c71_20250125_101743.html ===


Bugzilla – Bug 3392531
There is a heap-use-after-free at asm/preproc.c:5055(function:pp\_getline) in nasm2.14rc16 that will cause dos attack.
Last modified: 2020-12-31 05:48:37 PST

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/en/html/using/understanding.html)
* |
  [Log In](show_bug.cgi?id=3392531&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3392531&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

Self-registration is disabled due to spam issue (mail gorcunov@gmail.com or hpa@zytor.com to create an account)

[**Bug 3392531**](show_bug.cgi?id=3392531)
- There is a heap-use-after-free at asm/preproc.c:5055(function:pp\_getline) in nasm2.14rc16 that will cause dos attack.

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
There is a heap-use-after-free at asm/preproc.c:5055(function:pp\_getline) in ...

| | [Status](page.cgi?id=fields.html#bug_status): | CLOSED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | NASM | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=NASM "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Assembler ([show other bugs](buglist.cgi?component=Assembler&product=NASM&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.14.xx | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Importance](page.cgi?id=fields.html#importance): | Medium blocker | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | nobody | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | |  | | | Duplicates (1): | [3392716](show_bug.cgi?id=3392716 "CLOSED DUPLICATE - A heap-use-after-free in preproc.c:6853:52 can cause Segmentation fault")  ([view as bug list](buglist.cgi?bug_id=3392716)) | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2018-11-18 17:29 PST by ganshuitao | | --- | --- | | Modified: | 2020-12-31 05:48 PST ([History](show_activity.cgi?id=3392531)) | | CC List: | 6 users (show)  gorcunov hpa nasm-bugs sakib.sajal seviezhou sgayou | |  | | | [Obtained from:](page.cgi?id=fields.html#cf_build "Please indicate where you obtained and/or built your version of NASM.") | Binary from nasm.us | | [Generated by:](page.cgi?id=fields.html#cf_robot "Was this bug report generated by an automatic tool, such as a memory leak detector or fuzzer, *without* including a human validation description or analysis of the problem?") | --- | | [Bug category:](page.cgi?id=fields.html#cf_category "The general category of this bug oor request.") |  | | [Breaks existing code:](page.cgi?id=fields.html#cf_breaks "This bug report breaks existing code in production or under development.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Trigger by"./nasm -f bin POC8 -o xxx"**](attachment.cgi?id=411690 "View the content of the attachment") (366 bytes, text/plain)  [2018-11-18 17:29 PST](#attach_411690 "Go to the comment associated with the attachment"), ganshuitao | [Details](attachment.cgi?id=411690&action=edit) | | [Add an attachment](attachment.cgi?bugid=3392531&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3392531&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3392531#c0)  ganshuitao    2018-11-18 17:29:45 PST  ``` Created [attachment 411690](attachment.cgi?id=411690 "Trigger by\"./nasm -f bin POC8 -o xxx\"") [[details]](attachment.cgi?id=411690&action=edit "Trigger by\"./nasm -f bin POC8 -o xxx\"") Trigger by"./nasm -f bin POC8 -o xxx"  version:nasm2.14rc16 Summary:   There is a heap-use-after-free at asm/preproc.c:5055(function:pp_getline) in nasm2.14rc16 that will cause dos attack.   Description:  The ubsan debug is as follows:  $./nasm -f bin POC8 -o xxx  ================================================================= ================================================================= ==113343==ERROR: AddressSanitizer: heap-use-after-free on address 0x60f00000d430 at pc 0x00000044769e bp 0x7ffe333a6c90 sp 0x7ffe333a6c80 READ of size 8 at 0x60f00000d430 thread T0     #0 0x44769d in pp_getline asm/preproc.c:5055     #1 0x40d791 in assemble_file asm/nasm.c:1442     #2 0x40640d in main asm/nasm.c:573     #3 0x7feb98dbea3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x20a3f)     #4 0x4072f8 in _start (/home/company/real_sanitize/poc_check/nasm/nasm_new_addr+0x4072f8)  0x60f00000d430 is located 16 bytes inside of 176-byte region [0x60f00000d420,0x60f00000d4d0) freed by thread T0 here:     #0 0x7feb992006aa in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x986aa)     #1 0x443fa0 in free_mmacro asm/preproc.c:630     #2 0x443fa0 in do_directive asm/preproc.c:2957  previously allocated by thread T0 here:     #0 0x7feb99200b49 in __interceptor_calloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x98b49)     #1 0x40e4e0 in nasm_zalloc nasmlib/malloc.c:69     #2 0x4bd707  (/home/company/real_sanitize/poc_check/nasm/nasm_new_addr+0x4bd707)  SUMMARY: AddressSanitizer: heap-use-after-free asm/preproc.c:5055 pp_getline Shadow bytes around the buggy address:   0x0c1e7fff9a30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c1e7fff9a40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c1e7fff9a50: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c1e7fff9a60: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c1e7fff9a70: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa =>0x0c1e7fff9a80: fa fa fa fa fd fd[fd]fd fd fd fd fd fd fd fd fd   0x0c1e7fff9a90: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa   0x0c1e7fff9aa0: fa fa 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c1e7fff9ab0: 00 00 00 00 00 00 00 00 fa fa fa fa fa fa fa fa   0x0c1e7fff9ac0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c1e7fff9ad0: 00 00 00 00 00 00 fa fa fa fa fa fa fa fa 00 00 Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Heap right redzone:      fb   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack partial redzone:   f4   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe ==113343==ABORTING ```  [Comment 1](show_bug.cgi?id=3392531#c1)  sgayou    2019-01-31 15:21:50 PST  ``` Believe I reduced this to:  ``` %macro a %unmacro a %endmacro %eunmacro a ```  Returning early (false) in parse_mmacro_spec here:  ```      error(ERR_NONFATAL, "`%s' expects a parameter count", directive);         return false; ```  seems to prevent the UAF. Stopped investigating at that point, was just trying to prove to myself this was different than another very similar CVE. ```  [Comment 2](show_bug.cgi?id=3392531#c2)  Sakib Sajal    2019-07-12 09:37:50 PDT  ``` Hi, i looked into the git repo and did not find any commits relating to fixing this issue. Is this still a valid defect? I'm willing to test any changes and integrating it to the yocto project.  Thanks in advance. ```  [Comment 3](show_bug.cgi?id=3392531#c3)  Cyrill Gorcunov    2020-12-31 05:47:56 PST  ``` Fixed by f95c7e983c00d6b9f46fde7c702c0e5351b7dffa ```  [Comment 4](show_bug.cgi?id=3392531#c4)  Cyrill Gorcunov    2020-12-31 05:48:37 PST  ``` *** [Bug 3392716](show_bug.cgi?id=3392716 "CLOSED DUPLICATE - A heap-use-after-free in preproc.c:6853:52 can cause Segmentation fault") has been marked as a duplicate of this bug. *** ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3392531)
* - [XML](show_bug.cgi?ctype=xml&id=3392531)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3392531)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/en/html/using/understanding.html)
  + |
    [Log In](show_bug.cgi?id=3392531&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3392531&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


