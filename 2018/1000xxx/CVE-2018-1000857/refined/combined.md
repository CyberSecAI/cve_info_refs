=== Content from lists.mindrot.org_35eb14e6_20250126_071824.html ===

# Log ssh sessions using open source tools

**halfdog**
me at halfdog.net

*Fri Nov 23 01:38:25 AEDT 2018*

* Previous message (by thread): [Log ssh sessions using open source tools](037378.html)
* Next message (by thread): [[PATCH] Fix configure check for EVP\_CIPHER\_CTX\_set\_iv](037322.html)
* **Messages sorted by:**
  [[ date ]](date.html#37379)
  [[ thread ]](thread.html#37379)
  [[ subject ]](subject.html#37379)
  [[ author ]](author.html#37379)

---

```
Hello,

Konrad Bucheli writes:
> Hi,
>
> Did you check out log-user-session [1]? It can be used to record
> the output of ssh shell sessions in a tamper-prof way. And
> it is open source.
> ...
> [1] <https://github.com/open-ch/log-user-session>

Well, using a SUID-binary in that way partially eliminates the
benefits of tamper-proof logging by increasing the attack surface,
e.g. by allowing each user to create arbitrary files using directory
traversal and symlink attacks, e.g. by calling

SSH_CLIENT="169.254.0.1/../../../../tmp/ 1234 22" /usr/local/bin/log-user-session 'echo "* * * * * root /usr/bin/touch /dead.txt"'

to start the directory traversal and lead to the problematic open
missing O_NOFOLLOW

5885  openat(AT_FDCWD, "/var/log/user-session/localhost-build-20181122-140817-169.254.0.1/../../../../tmp/-5883.log", O_WRONLY|O_CREAT|O_APPEND, 0400) = 3

Without symlink protection, linking the "-[guessable pid].log" file
to "/etc/cron.d/dead" will give you root easily. Even with protection,
something should be possible ...

I am currently also writing a tool for a similar reason. To be
really tamper-proof, my solution is preloaded into SSH to intercept
the encryption master key for each session, sends it to a daemon,
that will use a public key to encrypt it and offload it to another
machine. Together with the full-packet-captures of all SSH connections
done by the network infrastructure, I would hope for a tamper-proof
but still secure solution BUT (ha, ha, ha) - it is not ready yet.

Best regards,
hd

> Am 03.11.18 um 18:08 schrieb Kaushal Shriyan:
>> Hi,
>>
>> Are there any open source tools to keep track of ssh sessions?
>> For example, if a specific user is ssh logging to remote server
>> and what commands or scripts are being run. Basically, i need
>> to log all users sessions.
>>
>> Thanks in Advance and i look forward to hearing from you.
>>
>> Best Regards,
>>
>> Kaushal _______________________________________________
>> openssh-unix-dev mailing list [openssh-unix-dev at mindrot.org](https://lists.mindrot.org/mailman/listinfo/openssh-unix-dev)
>> <https://lists.mindrot.org/mailman/listinfo/openssh-unix-dev?mc_phishing_protection_id=45427-bfetfluuab2o0p3j90ng>
>>
>
> -- konrad bucheli principal systems engineer
>
> open systems ag raeffelstrasse 29 ch-8045 zurich
>
> t: +41 58 100 10 10 f: +41 58 100 10 11 [kb at open.ch](https://lists.mindrot.org/mailman/listinfo/openssh-unix-dev)
>
> <http://www.open.ch>

```

---

* Previous message (by thread): [Log ssh sessions using open source tools](037378.html)
* Next message (by thread): [[PATCH] Fix configure check for EVP\_CIPHER\_CTX\_set\_iv](037322.html)
* **Messages sorted by:**
  [[ date ]](date.html#37379)
  [[ thread ]](thread.html#37379)
  [[ subject ]](subject.html#37379)
  [[ author ]](author.html#37379)

---

[More information about the openssh-unix-dev
mailing list](https://lists.mindrot.org/mailman/listinfo/openssh-unix-dev)



=== Content from www.halfdog.net_b79b5134_20250125_073758.html ===

[www.halfdog.net](/) /
[Security](/Security/) /
[2018](/Security/2018/) / LogUserSessionLocalRootPrivilegeEscalation /

Share via
[f](https://www.facebook.com/sharer.php?u=http%3A%2F%2Fwww.halfdog.net%2FSecurity%2F2018%2FLogUserSessionLocalRootPrivilegeEscalation%2F&t=log-user-session%20privilege%20escalation "facebook")
[g+](https://plus.google.com/share?url=https://www.halfdog.net/Security/2018/LogUserSessionLocalRootPrivilegeEscalation/ "google+")
# Introduction

The *log-user-session* is intended to provide tamper-proof
logging of SSH commands. Therefore it has to be installed as
SUID-executable to write one logfile per session to a trusted
location. It is invoked by acting as an login shell for each
user and intercepts all shell traffic for auditing purposes.

## Problem description:

The program uses the *SSH\_CLIENT*
environment variable, usually set by the SSH server to extract
the remote host name and use it to derive the name of the logfile.
An unprivileged user may invoke *log-user-session* with
a crafted environment variable to create files at arbitrary
locations with user-supplied content.

Vulnerable code from [log-user-session.c (3b535f4a3ccbb9f9908afe6fbf70fe63dacb8f11)](https://github.com/open-ch/log-user-session/blob/3b535f4a3ccbb9f9908afe6fbf70fe63dacb8f11/src/log-user-session.c):

# Environment variable is split copied without sanitation:
void process\_options(int argc, char \*\*argv) {
...
/\* client host \*/
char \*ssh\_client = getenv("SSH\_CLIENT");
if (ssh\_client && 0 != strcmp("(null)",ssh\_client)) {
int i;
for (i = 0; ssh\_client[i] && !isspace(ssh\_client[i]); i++);
opt\_client = strndup(ssh\_client, i);
# The unsanitized opt\_client name is appended to the logfile name string:
char \*prepare\_log\_file\_name(const char \*template) {
...
/\* add client host \*/
else if ('c' == \*pos\_t) {
if (opt\_client) {
int r = snprintf(pos\_l, remaining, "%s", opt\_client);
if (r >= remaining) break;
while('\0' != \*pos\_l) pos\_l++;
}
...
opt\_logfile = prepare\_log\_file\_name(DEFAULT\_LOG\_FILE);
# ... and used to create directories, open the file. The later
# is done without using O\_EXCL or O\_NOFOLLOW.
int prepare\_log\_file(const char \*log\_file, const char \*original\_command) {
char\* dir = dirname(strdup(log\_file));
print\_config\_file\_warning(CONFIG\_FILE, dir);
prepare\_dir(dir);
free(dir);
int fd\_log = open(log\_file, O\_WRONLY|O\_APPEND|O\_CREAT, S\_IRUSR);

All versions up to 0.7 are vulnerable.

# Methods

The tool <LogMore> demonstrates various
escalation approaches, depending on the hardening state of the
machine. Escalation will work immediately on systems without
symlink protection, libc missing \_\_libc\_enable\_secure, unprivileged
USERNS clone and will always work after initramfs update and
reboot.

# Results, Discussion

# Timeline

* 20181122: Discovery, report at [Openssh Mailing list (author involved)](https://lists.mindrot.org/pipermail/openssh-unix-dev/2018-November/037379.html)
* 20181220: [CVE-2018-1000857](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000857) published
# Material, References

* log-user-session: <https://github.com/open-ch/log-user-session/>
* [CVE-2018-1000857](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000857)
* LogMore: Python escalation PoC <LogMore>

Last modified 20181220
Contact e-mail: me (%) halfdog.net



=== Content from github.com_8f75476b_20250126_071824.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen-ch%2Flog-user-session%2F)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopen-ch%2Flog-user-session%2F)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=open-ch%2Flog-user-session)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[open-ch](/open-ch)
/
**[log-user-session](/open-ch/log-user-session)**
Public

* [Notifications](/login?return_to=%2Fopen-ch%2Flog-user-session) You must be signed in to change notification settings
* [Fork
  19](/login?return_to=%2Fopen-ch%2Flog-user-session)
* [Star
   79](/login?return_to=%2Fopen-ch%2Flog-user-session)

SSH session auditing

### License

[MIT license](/open-ch/log-user-session/blob/develop/COPYING)

[79
stars](/open-ch/log-user-session/stargazers) [19
forks](/open-ch/log-user-session/forks) [Branches](/open-ch/log-user-session/branches) [Tags](/open-ch/log-user-session/tags) [Activity](/open-ch/log-user-session/activity)
 [Star](/login?return_to=%2Fopen-ch%2Flog-user-session)

 [Notifications](/login?return_to=%2Fopen-ch%2Flog-user-session) You must be signed in to change notification settings

* [Code](/open-ch/log-user-session)
* [Issues
  7](/open-ch/log-user-session/issues)
* [Pull requests
  1](/open-ch/log-user-session/pulls)
* [Actions](/open-ch/log-user-session/actions)
* [Security](/open-ch/log-user-session/security)
* [Insights](/open-ch/log-user-session/pulse)

Additional navigation options

* [Code](/open-ch/log-user-session)
* [Issues](/open-ch/log-user-session/issues)
* [Pull requests](/open-ch/log-user-session/pulls)
* [Actions](/open-ch/log-user-session/actions)
* [Security](/open-ch/log-user-session/security)
* [Insights](/open-ch/log-user-session/pulse)

# open-ch/log-user-session

    develop[Branches](/open-ch/log-user-session/branches)[Tags](/open-ch/log-user-session/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[52 Commits](/open-ch/log-user-session/commits/develop/) | | |
| [.github](/open-ch/log-user-session/tree/develop/.github ".github") | | [.github](/open-ch/log-user-session/tree/develop/.github ".github") |  |  |
| [doc](/open-ch/log-user-session/tree/develop/doc "doc") | | [doc](/open-ch/log-user-session/tree/develop/doc "doc") |  |  |
| [src](/open-ch/log-user-session/tree/develop/src "src") | | [src](/open-ch/log-user-session/tree/develop/src "src") |  |  |
| [.gitignore](/open-ch/log-user-session/blob/develop/.gitignore ".gitignore") | | [.gitignore](/open-ch/log-user-session/blob/develop/.gitignore ".gitignore") |  |  |
| [AUTHORS](/open-ch/log-user-session/blob/develop/AUTHORS "AUTHORS") | | [AUTHORS](/open-ch/log-user-session/blob/develop/AUTHORS "AUTHORS") |  |  |
| [COPYING](/open-ch/log-user-session/blob/develop/COPYING "COPYING") | | [COPYING](/open-ch/log-user-session/blob/develop/COPYING "COPYING") |  |  |
| [ChangeLog](/open-ch/log-user-session/blob/develop/ChangeLog "ChangeLog") | | [ChangeLog](/open-ch/log-user-session/blob/develop/ChangeLog "ChangeLog") |  |  |
| [INSTALL](/open-ch/log-user-session/blob/develop/INSTALL "INSTALL") | | [INSTALL](/open-ch/log-user-session/blob/develop/INSTALL "INSTALL") |  |  |
| [Makefile.am](/open-ch/log-user-session/blob/develop/Makefile.am "Makefile.am") | | [Makefile.am](/open-ch/log-user-session/blob/develop/Makefile.am "Makefile.am") |  |  |
| [NEWS](/open-ch/log-user-session/blob/develop/NEWS "NEWS") | | [NEWS](/open-ch/log-user-session/blob/develop/NEWS "NEWS") |  |  |
| [README](/open-ch/log-user-session/blob/develop/README "README") | | [README](/open-ch/log-user-session/blob/develop/README "README") |  |  |
| [autoclean.sh](/open-ch/log-user-session/blob/develop/autoclean.sh "autoclean.sh") | | [autoclean.sh](/open-ch/log-user-session/blob/develop/autoclean.sh "autoclean.sh") |  |  |
| [autogen.sh](/open-ch/log-user-session/blob/develop/autogen.sh "autogen.sh") | | [autogen.sh](/open-ch/log-user-session/blob/develop/autogen.sh "autogen.sh") |  |  |
| [configure.ac](/open-ch/log-user-session/blob/develop/configure.ac "configure.ac") | | [configure.ac](/open-ch/log-user-session/blob/develop/configure.ac "configure.ac") |  |  |
| View all files | | |

## Repository files navigation

* README
* License
```
log-user-session README
-----------------------
log-user-session is a program to store the content of a shell session (e.g via
ssh) e.g. for auditing purposes. The tool is intended to be started by the ssh
server daemon. The log is tamper-proof for non-root users.

Current maintainer:
   Konrad Bucheli <kb@open.ch>

Website:
   <https://github.com/open-ch/log-user-session>

Dependencies
-------------
A C compiler and `make` must be installed prior to installation. You need also
`autoconf` if you get the source code not via official release tarball (e.g.
via git or via automatic generated github source tarballs).
On a Debian-based Linux distribution, they can be installed like this:

    sudo apt-get install autoconf gcc make

Installation
------------
If you want to install log-user-session from source, proceed as follows:

1. Run `[ -f ./configure ] || ./autogen.sh` to generate the `configure` file if
   it is not ready yet

2. Run `./configure`. You might first review any options with
   `./configure --help`. The defaults are likely fine.

3. Run `make`

4. Run `sudo make install`

5. Have a look at `man log-user-session` for usage help.

6. Create the configuration file /etc/log-user-session.conf and integrate the
   tool into your sshd configuration.

Supported Platforms
-------------------
This tool has been so far only tested on Linux.

Credits
-------
Konrad Bucheli (kb@open.ch)

```

## About

SSH session auditing

### Resources

[Readme](#readme-ov-file)
### License

[MIT license](#MIT-1-ov-file)

[Activity](/open-ch/log-user-session/activity)
[Custom properties](/open-ch/log-user-session/custom-properties)
### Stars

[**79**
stars](/open-ch/log-user-session/stargazers)
### Watchers

[**50**
watching](/open-ch/log-user-session/watchers)
### Forks

[**19**
forks](/open-ch/log-user-session/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fopen-ch%2Flog-user-session&report=open-ch+%28user%29)

## [Releases 10](/open-ch/log-user-session/releases)

[Release 1.0
Latest

Oct 16, 2020](/open-ch/log-user-session/releases/tag/1.0)
[+ 9 releases](/open-ch/log-user-session/releases)

## [Packages 0](/orgs/open-ch/packages?repo_name=log-user-session)

No packages published

## [Contributors 3](/open-ch/log-user-session/graphs/contributors)

* [![@nimdanitro](https://avatars.githubusercontent.com/u/894002?s=64&v=4)](https://github.com/nimdanitro)
  [**nimdanitro**
  Dani Aschwanden](https://github.com/nimdanitro)
* [![@Huuancao](https://avatars.githubusercontent.com/u/5472246?s=64&v=4)](https://github.com/Huuancao)
  [**Huuancao**
  Huu-Ân Cao](https://github.com/Huuancao)
* [![@markstos](https://avatars.githubusercontent.com/u/25829?s=64&v=4)](https://github.com/markstos)
  [**markstos**
  Mark Stosberg](https://github.com/markstos)

## Languages

* [C
  96.9%](/open-ch/log-user-session/search?l=c)
* [M4
  1.5%](/open-ch/log-user-session/search?l=m4)
* [Shell
  1.1%](/open-ch/log-user-session/search?l=shell)
* [Makefile
  0.5%](/open-ch/log-user-session/search?l=makefile)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


