=== Content from justi.cz_f60a7e14_20250125_124704.html ===

[Max Justicz](/)

# Remote Code Execution in Alpine Linux

Sep 13, 2018

tl;dr I found several bugs in `apk`, the default package manager for Alpine Linux. Alpine is a really lightweight distro that is [very commonly used with Docker.](https://github.com/search?l=Dockerfile&q=alpine+%22apk+add%22&type=Code) The worst of these bugs, the subject of this blog post, allows a network man-in-the-middle (or a malicious package mirror) to execute arbitrary code on the user’s machine. This is especially bad because packages aren’t served over TLS when using the default repositories. This bug [has been fixed](https://github.com/alpinelinux/apk-tools/commit/6484ed9849f03971eb48ee1fdc21a2f128247eb1) and the [Alpine base images have been updated](https://github.com/docker-library/official-images/pull/4834) – you may want to rebuild your Alpine-derived images!

After gaining code execution, I figured out a cool way to make the original `apk` process exit with a 0 exit code (without needing the `SYS_PTRACE` capability) by writing to `/proc/<pid>/mem`. The result is that a `Dockerfile` that installs packages with `apk` can be exploited and still build successfully.

Here’s a clip of me exploiting a Docker container based on Alpine as a network man-in-the-middle:

## Vulnerability

### Arbitrary file creation leading to RCE

Alpine packages are distributed as `.apk` files, which are actually just gzipped `tar` files. When `apk` is pulling packages, it extracts them into `/` before checking that the hash matches what the signed manifest says it should be. Well, kind of – while extracting the archive, each file name and hardlink target is suffixed with `.apk-new`. Later, when `apk` realizes that the hash of the downloaded package is incorrect, it tries to unlink all of the extracted files and directories.

Persistent arbitrary file writes can be easily turned into code execution because of `apk`’s “commit hooks” feature. If we can figure out a way to extract a file into `/etc/apk/commit_hooks.d/` and have it stay there after the cleanup process, it will be executed before `apk` exits.

With control of the tar file being downloaded, we can create a persistent “commit hook” like this:

1. Create a folder at `/etc/apk/commit_hooks.d/`, which doesn’t exist by default. Extracted folders are not suffixed with `.apk-new`.
2. Create a symlink to `/etc/apk/commit_hooks.d/x` named anything – say, `link`. This gets expanded to be called `link.apk-new` but still points to `/etc/apk/commit_hooks.d/x`.
3. Create a regular file named `link` (which will also be expanded to `link.apk-new`). This will write through the symlink and create a file at `/etc/apk/commit_hooks.d/x`.
4. When `apk` realizes that the package’s hash doesn’t match the signed index, it will first unlink `link.apk-new` – but `/etc/apk/commit_hooks.d/x` will persist! It will then fail to unlink `/etc/apk/commit_hooks.d/` with `ENOTEMPTY` because the directory now contains our payload.

### Fixing the exit code

Now that we have arbitrary code running on the client before `apk` has exited, it is important that we figure out a way to make the `apk` process exit gracefully. If using `apk` in a `Dockerfile` build step, the step will fail if `apk` returns a nonzero exit code.

If we do nothing, `apk` will return an exit code equal to the number of packages it has failed to install, which is now at least one (amusingly, this value can overflow – if the `number of errors % 256 == 0`, the process will return with exit code 0 and the build will succeed. [This was fixed here.](https://github.com/alpinelinux/apk-tools/commit/7b654e125461b00bc26e52b25e6a7be3a32c11b9)).

My first attempt was to use `gdb` to attach to the process and just call `exit(0)`. Unfortunately, Docker containers don’t have the `SYS_PTRACE` capability by default and so we can’t do this. Since we’re `root`, however, we can read and write `/proc/<pid>/mem` for the `apk` process:

```
import subprocess
import re

pid = int(subprocess.check_output(["pidof", "apk"]))

print("\033[92mapk pid is {}\033[0m".format(pid))

maps_file = open("/proc/{}/maps".format(pid), 'r')
mem_file = open("/proc/{}/mem".format(pid), 'w', 0)

print("\033[92mEverything is fine! Please move along...\033[0m")

NOP = "90".decode("hex")

# xor rdi, rdi ; mov eax, 0x3c ; syscall
shellcode = "4831ffb83c0000000f05".decode("hex")

# based on https://unix.stackexchange.com/a/6302
for line in maps_file.readlines():
    m = re.match(r'([0-9A-Fa-f]+)-([0-9A-Fa-f]+) ([-r])', line)
    start = int(m.group(1), 16)
    end = int(m.group(2), 16)

    if "apk" in line and "r-xp" in line:
        mem_file.seek(start)
        nops_len = end - start - len(shellcode)
        mem_file.write(NOP * nops_len)
        mem_file.write(shellcode)

maps_file.close()
mem_file.close()
```

So we:

1. Find the `pid` of the `apk` process using `pidof`
2. Find the process’s executable memory using `/proc/<pid>/maps`, and
3. Write shellcode that will ultimately `exit(0)` directly into memory. It was really surprising to me that this worked! I was expecting the write to fail.

When `apk` resumes execution after our commit hook exits, it will run our shellcode.

### Conclusion

If you use Alpine Linux in a production environment, you should 1. rebuild your images and 2. consider [donating what you can to the developers.](https://wiki.alpinelinux.org/wiki/Alpine_Linux%3ADevelopers) It seems like `apk` has [one main developer](https://github.com/fabled) who fixed this bug in less than a week. The [lead maintainer of Alpine](https://github.com/ncopa) cut a [new release](https://alpinelinux.org/posts/Alpine-3.8.1-released.html) shortly thereafter.

### Shameless plug

There are probably hundreds of organizations using Alpine Linux in production environments that could have been affected by this bug. Some of those organizations almost certainly have bug bounty programs that would pay generously if a similar bug had been written by one of their own developers. If the goal of a bug bounty program is to help secure an organization, shouldn’t critical bugs in dependencies qualify to some extent?

This is why I launched [BountyGraph](https://bountygraph.com/) last month. BountyGraph provides a mechanism to crowdfund bug bounty programs for important dependencies. I hope you’ll [check it out!](https://bountygraph.com/)

## Contact

* Max Justicz
* max@justi.cz
* [mastodon.mit.edu/@maxj](https://mastodon.mit.edu/%40maxj)

Will I abandon this blog after only a few posts? Stay tuned and find out!



=== Content from alpinelinux.org_829e991f_20250125_124703.html ===

[![](/alpinelinux-logo.svg)](/)

* [About](/about/)
* [Downloads](/downloads/)
* [Releases](/releases/)
* [Community](/community/)
* [Sponsors](/sponsors/)

* [docs](https://docs.alpinelinux.org)
* [wiki](https://wiki.alpinelinux.org)
* [git](https://gitlab.alpinelinux.org)
* [issues](https://gitlab.alpinelinux.org/alpine/aports/-/issues)
* [packages](https://pkgs.alpinelinux.org)
* [mirrors](https://mirrors.alpinelinux.org)
* [security](https://security.alpinelinux.org)

# Small. Simple. Secure.

### Alpine Linux is a security-oriented, lightweight Linux distribution based on musl libc and busybox.

2018-09-11
# Alpine Linux 3.8.1 released

The Alpine Linux project is pleased to announce the immediate
availability of version 3.8.1 of its Alpine Linux operating system.

This is a bugfix release of the v3.8 stable branch, based on
linux-4.14.69 kernels and it contains bugfixes. It contains an important
security update for apk-tools which [fixes](https://git.alpinelinux.org/cgit/apk-tools/commit/?id=6484ed9849f03971eb48ee1fdc21a2f128247eb1) a potential remote execution. A CVE is pending.

The full lists of changes can be found in the [git
log](http://git.alpinelinux.org/cgit/aports/log/?h=v3.8.1) and [bug
tracker](http://bugs.alpinelinux.org/versions/126).

## Git Shortlog

```

AndrÃ© Klitzing (1):
      main/py-sphinx_rtd_theme: upgrade to 0.4.0

Andy Postnikov (12):
      community/php7: security upgrade to 7.2.8
      community/php5: security upgrade to 5.6.37
      community/php7: fix include_path setting, use https url and source
      community/php7-apcu: add missing file, use https url and source
      community/php7-xdebug: upgrade to 2.6.1 and use https
      main/postgresql: security upgrade to 10.5
      main/redis: upgrade to 4.0.11
      community/php7: add missing secfixes
      community/php5: add missing secfixes
      main/apache2: security upgrade to 2.4.34
      community/php7-event: new package backport
      main/ghostscript: security upgrade to 9.24

Bernhard J. M. Gruen (1):
      community/docker: upgrade to 18.06.1, added openrc sub-package

Carlo Landmeter (3):
      community/py-requests-toolbelt: new aport
      community/certbot: add py-requests-toolbelt to deps
      main/clamav: upgrade to 0.100.1 (CVE-2017-16932,CVE-2018-0360,CVE-2018-0361)

Fabian Affolter (1):
      main/myrepos: upgrade to 1.20180726

Jake Buchholz (1):
      main/linux-vanilla: build NVMe modules for x86* virt flavor

Jakub Jirutka (12):
      community/py-atomicwrites: new aport
      community/pytest: DRY abuild
      community/pytest: fix missing dependency py-atomicwrites
      community/pytest: upgrade to 3.6.2
      main/opensmtpd: fix segfault in crypt_checkpass
      main/dovecot: fix init script to not print irrelevant error
      community/rspamd: fix broken rspamd.conf
      community/roundcubemail: fix missing JS libs
      main/redis: create /run/redis if OpenRC is not present
      main/lxc: fix CVE-2018-6556
      main/ruby-bundler: fix missing dependency on ruby-etc
      community/git-lfs: fix post-install, don't install lfs in local repo

Jean-Louis Fuchs (3):
      main/py2-monotonic: new aport
      main/py2-fasteners: new aport
      main/duplicity: fix dependencies and add check

Kaarle Ritvanen (1):
      main/strongswan: fix libressl compatibility

Leonardo Arena (6):
      community/nextcloud: upgrade to 13.0.5
      main/kamailio: upgrade to 5.1.4
      main/ldb: security upgrade to 1.3.5 (CVE-2018-1140)
      main/samba: security upgrade to 4.8.4
      community/zabbix: upgrade to 3.4.13
      community/nextcloud: upgrade to 13.0.6

Natanael Copa (93):
      main/razor: rebuild against new perl
      community/firefox-esr: security upgrade to 52.8.1 (CVE-2018-6126)
      community/gst-libav: enable on armhf
      community/phpmyadmin: security upgrade to 4.8.2 (CVE-2018-12581,CVE-2018-12613)
      community/yelp-xsl: upgrade to 3.28.0
      main/varnish: fix stack overflow in waiter epoll
      main/busybox: fix deinstall script for busybox-extras
      main/znc: security upgrade to 1.7.1 (CVE-2018-14055,CVE-2018-14056)
      main/mqtt-exec: backport password auth support
      main/lame: fix secfixes comment
      main/libxfont: fix secfixes comment
      main/mutt: security upgrade to 1.10.1
      main/zip: add unzip to depends
      main/libvorbis: security fix for CVE-2018-10392
      community/xapian-core: security upgrade to 1.4.7 (CVE-2018-0499)
      community/wireshark: upgrade to 2.4.8
      main/fuse: security upgrade to 2.9.8 (CVE-2018-10906)
      main/dhcpcd: upgrade to 7.0.7
      main/tiff: various security fixes
      main/kamailio: add secfixes comment
      main/cgit: fix CVE-2018-14912
      main/cgit: fix secfixes comment
      community/chromium: upgrade to 66.0.3359.181
      community/chromium: upgrade to 68.0.3440.75
      main/py-django: security upgrade to 1.11.15 (CVE-2018-14574)
      main/p7zip: security fixes (CVE-2018-5996, CVE-2018-10115)
      community/mbedtls: security upgrade to 2.7.5 (CVE-2018-0497,CVE-2018-0498)
      main/python2: split out wininst*.exe
      main/apk-tools: don't update index on delete
      main/apk-tools: backport fix for --no-network
      main/ncurses: upgrade to 6.1_p20180818
      main/wpa_supplicant: security fix (CVE-2018-14526)
      main/wpa_supplicant: bump pkgrel
      main/krb5: security upgrade to 1.15.3 (CVE-2017-15088,CVE-2018-5709,CVE-2018-5710)
      main/unzip: fix various CVEs
      community/mongodb: upgrade to 3.6.7
      main/openssh: backport security fix (CVE-2018-15473)
      main/myrepos: add secfixes comment
      main/perl-io-socket-inet6: move from community due to amavisd-new
      main/amavisd-new: fix dependency for inet6
      main/libmspack: security upgrade to 0.7.1alpha
      community/zutils: security fix (CVE-2018-1000637)
      main/python3: security upgrade to 3.6.6 (CVE-2018-1060,CVE-2018-1061)
      main/python3: add secfixes comment
      community/firefox-esr: upgrade to 52.9.0
      main/libetpan: fix user cert
      main/postgrey: fix depends and add test
      community/ffmpeg: security upgrade to 3.4.4
      main/ffmpeg: trigger rebuild
      main/dovecot: upgrade to 2.3.2.1
      main/grub: fix install on xfs
      main/pingu: create piddir on service start
      main/xen: backport various security fixes
      community/kodi: fix sound with new ffmpeg
      main/ncurses: add /lib/terminfo to terminfo dirs
      main/xen: clean up checksums
      main/nginx: fix permissions of /var/tmp
      main/bind: security upgrade to 9.12.2_p1 (CVE-2018-5740)
      main/bind: add secfixes comment
      main/dropbear: backport security fix (CVE-2018-15599)
      main/curl: security upgrade to 7.61.1 (CVE-2018-14618)
      community/wireshark: security upgrade to 2.4.9
      community/phpmyadmin: security upgrade to 4.8.3 (CVE-2018-15605)
      main/linux-rpi: upgrade to 4.14.54
      main/linux-rpi: upgrade to 4.14.55
      main/linux-rpi: upgrade to 4.14.57
      main/linux-rpi: upgrade to 4.14.59
      main/linux-rpi: upgrade to 4.14.60
      main/linux-rpi: upgrade to 4.14.61
      main/linux-rpi: upgrade to 4.14.62
      main/linux-rpi: upgrade to 4.14.66
      main/linux-rpi: upgrade to 4.14.67
      main/linux-rpi: upgrade to 4.14.69
      main/linux-vanilla: upgrade to 4.14.54
      main/linux-vanilla: upgrade to 4.14.55
      main/linux-vanilla: upgrade to 4.14.57
      main/linux-vanilla: fix config for aarch64
      main/linux-vanilla: upgrade to 4.14.59
      main/linux-vanilla: upgrade to 4.14.60
      main/linux-vanilla: upgrade to 4.14.61
      main/linux-vanilla: upgrade to 4.14.62
      main/linux-vanilla: upgrade to 4.14.65
      main/linux-vanilla: upgrade to 4.14.66
      main/linux-vanilla: upgrade to 4.14.67
      main/linux-vanilla: upgrade to 4.14.69
      community/virtualbox-guest-modules-vanilla: rebuild against kernel 4.14.69-r0
      main/dahdi-linux-vanilla: rebuild against kernel 4.14.69-r0
      main/devicemaster-linux-vanilla: rebuild against kernel 4.14.69-r0
      main/drbd9-vanilla: rebuild against kernel 4.14.69-r0
      main/spl-vanilla: rebuild against kernel 4.14.69-r0
      main/xtables-addons-vanilla: rebuild against kernel 4.14.69-r0
      main/zfs-vanilla: rebuild against kernel 4.14.69-r0
      ==== release 3.8.1 ====

SÃ¶ren Tempel (1):
      main/apk-tools: fix `apk list -i` segfault

Ted Trask (2):
      main/acf-alpine-baselayout: upgrade to 0.13.2
      main/mini_httpd: Fix cgi bug breaking ACF logon

Tim Brust (1):
      main/nodejs: security upgrade to 8.11.4

Timo TerÃ¤s (3):
      main/asterisk: security upgrade to 15.5.0
      main/openssl: cherry-pick fix for CVE-2018-0737
      main/apk-tools: security upgrade to 2.10.1

William Pitcock (1):
      main/pkgconf: upgrade to 1.5.3 (security fix, CVE pending)

Wojciech GÃ³rski (1):
      main/openvpn: fix init script

nervo (1):
      main/dropbear: disable wtmp and lastlog support

prspkt (3):
      main/curl: upgrade to 7.61.0, add secfixes comment
      main/libgit2: security upgrade to 0.27.3
      main/mupdf: upgrade to 1.13.0

tcely (1):
      main/gnupg1: security upgrade to 1.4.23 (CVE-2017-7526)

```

© Copyright 2024 Alpine Linux Development Team all rights reserved | [Privacy Policy](/privacy-policy.html)



=== Content from git.alpinelinux.org_c511838f_20250125_124704.html ===


| [cgit logo](/) | [index](/) : [apk-tools](/apk-tools/) | 2.0-stable 2.1-stable 2.10-stable 2.12-stable 2.14-stable 2.6-stable 2.7-stable 2.8-stable master tt-filesize tt-repositories-format v3.0-wip |
| --- | --- | --- |
| Alpine package manager | git |

| [about](/apk-tools/about/)[summary](/apk-tools/)[refs](/apk-tools/refs/)[log](/apk-tools/log/)[tree](/apk-tools/tree/)[commit](/apk-tools/commit/)[diff](/apk-tools/diff/)[stats](/apk-tools/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Timo Teräs <timo.teras@iki.fi> | 2025-01-24 16:16:48 +0200 |
| --- | --- | --- |
| committer | Timo Teräs <timo.teras@iki.fi> | 2025-01-24 16:16:48 +0200 |
| commit | [00522cd60e18c39f4701eea56ea1c777d6f33a45](/apk-tools/commit/?id=00522cd60e18c39f4701eea56ea1c777d6f33a45) ([patch](/apk-tools/patch/?id=00522cd60e18c39f4701eea56ea1c777d6f33a45)) | |
| tree | [8e2eab92d7a616a2e2ab6fc7ee69dc038d4c3a31](/apk-tools/tree/) | |
| parent | [d345a9aa6d25045256390a57350eb716560615be](/apk-tools/commit/?id=d345a9aa6d25045256390a57350eb716560615be) ([diff](/apk-tools/diff/?id2=d345a9aa6d25045256390a57350eb716560615be)) | |

apk: introduce and use APK\_OPTVAL\_\* macros[HEAD](/apk-tools/commit/?id=00522cd60e18c39f4701eea56ea1c777d6f33a45)[master](/apk-tools/log/)This makes the group id and option id packing to option.val
more readable.
[Diffstat](/apk-tools/diff/)

| -rw-r--r-- | [src/apk.c](/apk-tools/diff/src/apk.c) | 27 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 11 deletions

| diff --git a/src/apk.c b/src/apk.cindex bc2e94b..5aa34ae 100644--- a/[src/apk.c](/apk-tools/tree/src/apk.c?id=d345a9aa6d25045256390a57350eb716560615be)+++ b/[src/apk.c](/apk-tools/tree/src/apk.c?id=00522cd60e18c39f4701eea56ea1c777d6f33a45)@@ -341,6 +341,11 @@ static struct apk\_applet \*deduce\_applet(int argc, char \*\*argv) return NULL; } +// Pack and unpack group and option id into one integer (struct option.val)+#define APK\_OPTVAL\_PACK(group\_id, option\_id) ((group\_id << 10) + option\_id)+#define APK\_OPTVAL\_GROUPID(optval) ((optval) >> 10)+#define APK\_OPTVAL\_OPTIONID(optval) ((optval) & 0x3ff)+ struct apk\_options { struct option options[80]; unsigned short short\_option\_val[64];@@ -350,14 +355,14 @@ struct apk\_options {  static void add\_options(struct apk\_options \*opts, const char \*desc, int group\_id) {- unsigned short option\_id = group\_id << 10;+ unsigned short option\_id = 0; int num\_short;  for (const char \*d = desc; \*d; d += strlen(d) + 1, option\_id++) { struct option \*opt = &opts->options[opts->num\_opts++]; assert(opts->num\_opts < ARRAY\_SIZE(opts->options)); - opt->val = option\_id;+ opt->val = APK\_OPTVAL\_PACK(group\_id, option\_id); opt->flag = 0; opt->has\_arg = no\_argument; if ((unsigned char)\*d == 0xaf) {@@ -370,7 +375,7 @@ static void add\_options(struct apk\_options \*opts, const char \*desc, int group\_id for (; num\_short > 0; num\_short--) { unsigned char ch = \*(unsigned char \*)d; assert(ch >= 64 && ch < 128);- opts->short\_option\_val[ch-64] = option\_id;+ opts->short\_option\_val[ch-64] = opt->val; opts->short\_options[opts->num\_sopts++] = \*d++; if (opt->has\_arg != no\_argument) opts->short\_options[opts->num\_sopts++] = ':';@@ -442,8 +447,8 @@ static int load\_config(struct apk\_ctx \*ac, struct apk\_options \*opts) str = apk\_balloc\_cstr(&ac->ba, value); break; }- assert((opt->val >> 10) == 1);- if (r == -1) r = optgroup\_global\_parse(ac, opt->val&0x3ff, str);+ assert(APK\_OPTVAL\_GROUPID(opt->val) == 1);+ if (r == -1) r = optgroup\_global\_parse(ac, APK\_OPTVAL\_OPTIONID(opt->val), str); break; } switch (r) {@@ -486,12 +491,12 @@ static int parse\_options(int argc, char \*\*argv, struct apk\_applet \*applet, void  while ((p = getopt\_long(argc, argv, opts.short\_options, opts.options, NULL)) != -1) { if (p >= 64 && p < 128) p = opts.short\_option\_val[p - 64];- switch (p >> 10) {- case 1: r = optgroup\_global\_parse(ac, p&0x3ff, optarg); break;- case 2: r = optgroup\_commit\_parse(ac, p&0x3ff, optarg); break;- case 3: r = optgroup\_source\_parse(ac, p&0x3ff, optarg); break;- case 4: r = optgroup\_generation\_parse(ac, p&0x3ff, optarg); break;- case 15: r = applet->parse(ctx, ac, p&0x3ff, optarg); break;+ switch (APK\_OPTVAL\_GROUPID(p)) {+ case 1: r = optgroup\_global\_parse(ac, APK\_OPTVAL\_OPTIONID(p), optarg); break;+ case 2: r = optgroup\_commit\_parse(ac, APK\_OPTVAL\_OPTIONID(p), optarg); break;+ case 3: r = optgroup\_source\_parse(ac, APK\_OPTVAL\_OPTIONID(p), optarg); break;+ case 4: r = optgroup\_generation\_parse(ac, APK\_OPTVAL\_OPTIONID(p), optarg); break;+ case 15: r = applet->parse(ctx, ac, APK\_OPTVAL\_OPTIONID(p), optarg); break; default: r = -EINVAL; } if (r == -EINVAL || r == -ENOTSUP) return usage(out, applet); |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.41.0](https://git-scm.com/)) at 2025-01-25 12:47:03 +0000


