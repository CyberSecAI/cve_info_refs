=== Content from github.com_446e3083_20250124_161937.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftopydo%2Ftopydo%2Fblob%2Fmaster%2Ftopydo%2Flib%2FListFormat.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftopydo%2Ftopydo%2Fblob%2Fmaster%2Ftopydo%2Flib%2FListFormat.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=topydo%2Ftopydo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[topydo](/topydo)
/
**[topydo](/topydo/topydo)**
Public

* [Notifications](/login?return_to=%2Ftopydo%2Ftopydo) You must be signed in to change notification settings
* [Fork
  93](/login?return_to=%2Ftopydo%2Ftopydo)
* [Star
   810](/login?return_to=%2Ftopydo%2Ftopydo)

* [Code](/topydo/topydo)
* [Issues
  69](/topydo/topydo/issues)
* [Pull requests
  4](/topydo/topydo/pulls)
* [Actions](/topydo/topydo/actions)
* [Security](/topydo/topydo/security)
* [Insights](/topydo/topydo/pulse)

Additional navigation options

* [Code](/topydo/topydo)
* [Issues](/topydo/topydo/issues)
* [Pull requests](/topydo/topydo/pulls)
* [Actions](/topydo/topydo/actions)
* [Security](/topydo/topydo/security)
* [Insights](/topydo/topydo/pulse)

## Files

 master
## Breadcrumbs

1. [topydo](/topydo/topydo/tree/master)
2. /[topydo](/topydo/topydo/tree/master/topydo)
3. /[lib](/topydo/topydo/tree/master/topydo/lib)
/
# ListFormat.py

Copy path Blame  Blame
## Latest commit

## History

[History](/topydo/topydo/commits/master/topydo/lib/ListFormat.py)307 lines (237 loc) · 10.7 KB master
## Breadcrumbs

1. [topydo](/topydo/topydo/tree/master)
2. /[topydo](/topydo/topydo/tree/master/topydo)
3. /[lib](/topydo/topydo/tree/master/topydo/lib)
/
# ListFormat.py

Top
## File metadata and controls

* Code
* Blame

307 lines (237 loc) · 10.7 KB[Raw](https://github.com/topydo/topydo/raw/refs/heads/master/topydo/lib/ListFormat.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307# Topydo - A todo.txt client written in Python.# Copyright (C) 2014 - 2015 Bram Schoenmakers <bram@topydo.org>## This program is free software: you can redistribute it and/or modify# it under the terms of the GNU General Public License as published by# the Free Software Foundation, either version 3 of the License, or# (at your option) any later version.## This program is distributed in the hope that it will be useful,# but WITHOUT ANY WARRANTY; without even the implied warranty of# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the# GNU General Public License for more details.## You should have received a copy of the GNU General Public License# along with this program. If not, see <http://www.gnu.org/licenses/>.
""" Utilities for formatting output with "list\_format" option."""
import re
import arrow
from topydo.lib.Config import configfrom topydo.lib.ProgressColor import progress\_colorfrom topydo.lib.Utils import escape\_ansi, get\_terminal\_size, humanize\_date
MAIN\_PATTERN = (r'^({{(?P<before>.+?)}})?' r'(?P<placeholder>{ph}|\[{ph}\])' r'({{(?P<after>.+?)}})?' r'(?P<whitespace> \*)')
def \_columns(): """ Returns the number of columns of the terminal. """ return get\_terminal\_size().columns
def \_filler(p\_str, p\_len): """ Returns p\_str preceded by additional spaces if p\_str is shorter than p\_len. """ to\_fill = p\_len - len(p\_str) return to\_fill\*' ' + p\_str
def humanize\_dates(p\_due=None, p\_start=None, p\_creation=None): """ Returns string with humanized versions of p\_due, p\_start and p\_creation. Examples: - all dates: "16 days ago, due in a month, started 2 days ago" - p\_due and p\_start: "due in a month, started 2 days ago" - p\_creation and p\_due: "16 days ago, due in a month" """ dates\_list = [] if p\_creation: dates\_list.append(humanize\_date(p\_creation)) if p\_due: dates\_list.append('due ' + humanize\_date(p\_due)) if p\_start: now = arrow.now().date() dates\_list.append('{} {}'.format( 'started' if p\_start <= now else 'starts', humanize\_date(p\_start) ))
 return ', '.join(dates\_list)
def \_strip\_placeholder\_braces(p\_matchobj): """ Returns string with conditional braces around placeholder stripped and percent sign glued into placeholder character.
 Returned string is composed from 'start', 'before', 'placeholder', 'after', 'whitespace', and 'end' match-groups of p\_matchobj. Conditional braces are stripped from 'before' and 'after' groups. 'whitespace', 'start', and 'end' groups are preserved without any change.
 Using this function as an 'repl' argument in re.sub it is possible to turn: %{(}B{)} into: (%B) """ before = p\_matchobj.group('before') or '' placeholder = p\_matchobj.group('placeholder') after = p\_matchobj.group('after') or '' whitespace = p\_matchobj.group('whitespace') or ''
 return before + '%' + placeholder + after + whitespace
def \_unescape\_percent\_sign(p\_str): """ Strips backslashes from escaped percent signs in p\_str. """ unescaped\_str = re.sub(r'\\%', '%', p\_str)
 return unescaped\_str
def \_remove\_redundant\_spaces(p\_str): """ Removes spaces surrunding <TAB> character (\t) from p\_str. """ clean\_str = re.sub(' \*\t \*', '\t', p\_str)
 return clean\_str
def \_truncate(p\_str, p\_repl): """ Returns p\_str with truncated and ended with '...' version of p\_repl.
 Place of the truncation is calculated depending on p\_max\_width. """ # 4 is for '...' and an extra space at the end text\_lim = \_columns() - len(escape\_ansi(p\_str)) - 4 truncated\_str = re.sub(re.escape(p\_repl), p\_repl[:text\_lim] + '...', p\_str)
 return truncated\_str
def \_right\_align(p\_str): """ Returns p\_str with content after <TAB> character aligned right.
 Right alignment is done using proper number of spaces calculated from 'line\_width' attribute. """ to\_fill = \_columns() - len(escape\_ansi(p\_str))
 if to\_fill > 0: p\_str = re.sub('\t', ' '\*to\_fill, p\_str) else: p\_str = re.sub('\t', ' ', p\_str)
 return p\_str
def color\_block(p\_todo): return '{} {}'.format( progress\_color(p\_todo).as\_ansi(p\_background=True), config().priority\_color(p\_todo.priority()).as\_ansi(), )
class ListFormatError(Exception): pass
class ListFormatParser(object): """ Parser of format string. """ def \_\_init\_\_(self, p\_todolist, p\_format=None): self.format\_string = re.sub(r'\\t', '\t', p\_format or config().list\_format()) self.todolist = p\_todolist self.one\_line = False self.placeholders = { # absolute creation date 'c': lambda t: t.creation\_date().isoformat() if t.creation\_date() else '',
 # relative creation date 'C': lambda t: humanize\_date(t.creation\_date()) if t.creation\_date() else '',
 # absolute due date 'd': lambda t: t.due\_date().isoformat() if t.due\_date() else '',
 # relative due date 'D': lambda t: humanize\_date(t.due\_date()) if t.due\_date() else '',
 # relative dates: due, start 'h': lambda t: humanize\_dates(t.due\_date(), t.start\_date()),
 # relative dates in form: creation, due, start 'H': lambda t: humanize\_dates(t.due\_date(), t.start\_date(), t.creation\_date()),
 # todo ID 'i': lambda t: str(self.todolist.number(t)),
 # todo ID, padded with spaces 'I': lambda t: \_filler(str(self.todolist.number(t)), self.todolist.max\_id\_length()),
 # list of tags (spaces) without hidden ones and due: and t: 'k': lambda t: ' '.join([u'{}:{}'.format(tag, value) for tag, value in sorted(t.tags()) if tag not in config().hidden\_tags() + [config().tag\_start(), config().tag\_due()]]),
 # list of all tags (spaces) 'K': lambda t: ' '.join([u'{}:{}'.format(tag, value) for tag, value in sorted(t.tags())]),
 # line number 'n': lambda t: str(self.todolist.linenumber(t)),
 # line number, padded with spaces 'N': lambda t: \_filler(str(self.todolist.linenumber(t)), self.todolist.max\_id\_length()),
 # priority 'p': lambda t: t.priority() if t.priority() else '',
 # priority (or placeholder space) 'P': lambda t: t.priority() if t.priority() else ' ',
 # raw text 'r': lambda t: t.source(),
 # text 's': lambda t: t.text(),
 # text (truncated if necessary) 'S': lambda t: t.text(),
 # absolute start date 't': lambda t: t.start\_date().isoformat() if t.start\_date() else '',
 # relative start date 'T': lambda t: humanize\_date(t.start\_date()) if t.start\_date() else '',
 # unique text ID 'u': self.todolist.uid if self.todolist else lambda \_ : '',
 # unique text ID, padded with spaces 'U': lambda t: \_filler(self.todolist.uid(t), self.todolist.max\_id\_length()),
 # absolute completion date 'x': lambda t: 'x ' + t.completion\_date().isoformat() if t.is\_completed() else '',
 # relative completion date 'X': lambda t: 'x ' + humanize\_date(t.completion\_date()) if t.is\_completed() else '',
 'z': lambda t: color\_block(t) if config().colors() else ' ', } self.format\_list = self.\_preprocess\_format()
 def \_preprocess\_format(self): """ Preprocess the format\_string attribute.
 Splits the format string on each placeholder and returns a list of tuples containing substring, placeholder name, and function retrieving content for placeholder (getter).
 Relevant placeholder functions (getters) are taken from 'placeholders' attribute which is a dict. If no matching placeholder is found in 'placeholders' getter is set to None. Getter and placeholder are also always set to None in first element of the returned list, because it never contain a real placeholder (read re.split documentation for further information). """ format\_split = re.split(r'(?<!\\)%', self.format\_string) preprocessed\_format = []
 for idx, substr in enumerate(format\_split): if idx == 0: getter = None placeholder = None else: pattern = MAIN\_PATTERN.format(ph=r'\S') try: placeholder = re.match(pattern, substr).group('placeholder').strip('[]') except AttributeError: placeholder = None
 if placeholder == 'S': self.one\_line = True
 try: getter = self.placeholders[placeholder] except KeyError: getter = None substr = re.sub(pattern, '', substr)
 format\_elem = (substr, placeholder, getter) preprocessed\_format.append(format\_elem)
 return preprocessed\_format
 def parse(self, p\_todo): """ Returns fully parsed string from 'format\_string' attribute with all placeholders properly substituted by content obtained from p\_todo.
 It uses preprocessed form of 'format\_string' (result of ListFormatParser.\_preprocess\_format) stored in 'format\_list' attribute. """ parsed\_list = [] repl\_trunc = None
 for substr, placeholder, getter in self.format\_list: repl = getter(p\_todo) if getter else '' pattern = MAIN\_PATTERN.format(ph=placeholder)
 if placeholder == 'S': repl\_trunc = repl
 try: if repl == '': substr = re.sub(pattern, '', substr) else: substr = re.sub(pattern, \_strip\_placeholder\_braces, substr) substr = re.sub(r'(?<!\\)%({ph}|\[{ph}\])'.format(ph=placeholder), repl, substr) except re.error: raise ListFormatError
 parsed\_list.append(substr)
 parsed\_str = \_unescape\_percent\_sign(''.join(parsed\_list)) parsed\_str = \_remove\_redundant\_spaces(parsed\_str)
 if self.one\_line and len(escape\_ansi(parsed\_str)) >= \_columns(): parsed\_str = \_truncate(parsed\_str, repl\_trunc)
 if re.search('.\*\t', parsed\_str): parsed\_str = \_right\_align(parsed\_str)
 return parsed\_str.rstrip()

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4e1bd1cd_20250124_161938.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftopydo%2Ftopydo%2Fissues%2F240)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftopydo%2Ftopydo%2Fissues%2F240)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=topydo%2Ftopydo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[topydo](/topydo)
/
**[topydo](/topydo/topydo)**
Public

* [Notifications](/login?return_to=%2Ftopydo%2Ftopydo) You must be signed in to change notification settings
* [Fork
  93](/login?return_to=%2Ftopydo%2Ftopydo)
* [Star
   810](/login?return_to=%2Ftopydo%2Ftopydo)

* [Code](/topydo/topydo)
* [Issues
  69](/topydo/topydo/issues)
* [Pull requests
  4](/topydo/topydo/pulls)
* [Actions](/topydo/topydo/actions)
* [Security](/topydo/topydo/security)
* [Insights](/topydo/topydo/pulse)

Additional navigation options

* [Code](/topydo/topydo)
* [Issues](/topydo/topydo/issues)
* [Pull requests](/topydo/topydo/pulls)
* [Actions](/topydo/topydo/actions)
* [Security](/topydo/topydo/security)
* [Insights](/topydo/topydo/pulse)

# Unexpected behaviour of topydo when tasks contain backslashes #240

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkOpenOpen[Unexpected behaviour of topydo when tasks contain backslashes](#top)#240Copy linkLabels[bug](https://github.com/topydo/topydo/issues?q=state%3Aopen%20label%3A%22bug%22)[![@Ekleog](https://avatars.githubusercontent.com/u/411447?u=abe29710a24d406b8a2b0ab239f2657ab0a0df23&v=4&size=80)](/Ekleog)
## Description

[![@Ekleog](https://avatars.githubusercontent.com/u/411447?u=abe29710a24d406b8a2b0ab239f2657ab0a0df23&v=4&size=48)](/Ekleog)[Ekleog](https://github.com/Ekleog)opened [on May 13, 2018](https://github.com/topydo/topydo/issues/240#issue-322561348)

`topydo` passes TODO texts as the `repl` argument of `re.sub` unchanged at topydo/lib/ListFormat.py:291.

If an issue contains a backslash, it is thus interpreted as an escape: an issue containing `foo \t bar` will output only `foo`.

This can also lead to crashing `topydo`: `foo \g<t> bar` will trigger a crash

This, finally, also means that the TODO task can output whatever bytes it wants to the terminal without any check from topydo, thus potentially opening way to exploiting a flaw in the terminal's escape code handling from an untrusted todo.txt files (eg. automatically generated from untrusted sources, like code). (the attack path here looks rather narrow to me, though):

`foo \046 bar` outputs `foo & bar`

`foo \033[5m bar` makes `bar` blink

`\033[1A you didn't see this` erases the previous TODO on the list (in `topydo ls` output) and replaces it by “you didn't see this”

etc.

## Metadata

### Assignees

No one assigned

### Labels

[bug](https://github.com/topydo/topydo/issues?q=state%3Aopen%20label%3A%22bug%22)
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


