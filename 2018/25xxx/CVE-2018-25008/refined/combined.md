=== Content from github.com_ce8bc038_20250124_121023.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F52031)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F52031)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  685](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  9](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Frust-lang%2Frust%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Strenghten synchronization in `Arc::is_unique` #52031

 Merged

[bors](/bors)
merged 1 commit into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[RalfJung:arc](/RalfJung/rust/tree/arc "RalfJung/rust:arc")

Jul 6, 2018

 Merged

# [Strenghten synchronization in `Arc::is_unique`](#top) #52031

[bors](/bors)
merged 1 commit into
[rust-lang:master](/rust-lang/rust/tree/master "rust-lang/rust:master")
from
[RalfJung:arc](/RalfJung/rust/tree/arc "RalfJung/rust:arc")

Jul 6, 2018

[Conversation
3](/rust-lang/rust/pull/52031)
[Commits
1](/rust-lang/rust/pull/52031/commits)
[Checks
0](/rust-lang/rust/pull/52031/checks)
[Files changed](/rust-lang/rust/pull/52031/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![RalfJung](https://avatars.githubusercontent.com/u/330628?s=60&v=4)](/RalfJung)

Copy link

Member

### @RalfJung **[RalfJung](/RalfJung)** commented [Jul 3, 2018](#issue-338041469)

Previously, `is_unique` would not synchronize at all with a `drop` that returned

early because it was not the last reference, leading to a data race.

Fixes [#51780](https://github.com/rust-lang/rust/issues/51780)

Unfortunately I have no idea how to add a test for this.

Cc [@jhjourdan](https://github.com/jhjourdan)

Sorry, something went wrong.

 üëç
3
 bjorn3, 0x7CFE, and hcpl reacted with thumbs up emoji

All reactions

* üëç
  3 reactions

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=40&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)
[rust-highfive](/rust-highfive)
assigned [sfackler](/sfackler)
[Jul 3, 2018](#event-1714938276)

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=80&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)

Copy link

Collaborator

### **[rust-highfive](/rust-highfive)** commented [Jul 3, 2018](#issuecomment-402280794)

| r? [@sfackler](https://github.com/sfackler)  (rust\_highfive has picked a reviewer for you, use r? to override) |
| --- |

All reactions

Sorry, something went wrong.

[![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=40&u=ac9407540fb10c9a2c6ed7b85e0f3e5bff83d5d6&v=4)](/rust-highfive)
[rust-highfive](/rust-highfive)
added
the
[S-waiting-on-review](/rust-lang/rust/labels/S-waiting-on-review)
Status: Awaiting review from the assignee but also interested parties.
label
[Jul 3, 2018](#event-1714938565)

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&v=4)](/RalfJung)

`[Strenghten synchronization in Arc::is_unique](/rust-lang/rust/pull/52031/commits/f96c2468695911222ba7557ce04af0dd8fbb6df2 "Strenghten synchronization in `Arc::is_unique`

Previously, `is_unique` would not synchronize at all with a `drop` that returned
early because it was not the last reference, leading to a data race.

Fixes #51780")`
 ‚Ä¶

`[f96c246](/rust-lang/rust/pull/52031/commits/f96c2468695911222ba7557ce04af0dd8fbb6df2)`

```
Previously, `is_unique` would not synchronize at all with a `drop` that returned
early because it was not the last reference, leading to a data race.

Fixes [rust-lang#51780](https://github.com/rust-lang/rust/issues/51780)
```

 [![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)
[RalfJung](/RalfJung)
[force-pushed](/rust-lang/rust/compare/562dde6bf739d4e724ebb73519f2ddc75af3b635..f96c2468695911222ba7557ce04af0dd8fbb6df2)
the
arc

branch
from
[`562dde6`](/rust-lang/rust/commit/562dde6bf739d4e724ebb73519f2ddc75af3b635) to
[`f96c246`](/rust-lang/rust/commit/f96c2468695911222ba7557ce04af0dd8fbb6df2)  [Compare](/rust-lang/rust/compare/562dde6bf739d4e724ebb73519f2ddc75af3b635..f96c2468695911222ba7557ce04af0dd8fbb6df2)
[July 3, 2018 20:33](#event-1714960508)

[![@sfackler](https://avatars.githubusercontent.com/u/1455697?s=80&u=5bfef1ae0a9acc2307df7e4f5697dc03c2238eda&v=4)](/sfackler)

Copy link

Member

### **[sfackler](/sfackler)** commented [Jul 4, 2018](#issuecomment-402527775)

| [@bors](https://github.com/bors) r+ |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=80&v=4)](/bors)

Copy link

Contributor

### **[bors](/bors)** commented [Jul 4, 2018](#issuecomment-402527777)

| üìå Commit [f96c246](https://github.com/rust-lang/rust/commit/f96c2468695911222ba7557ce04af0dd8fbb6df2) has been approved by `sfackler` |
| --- |

All reactions

Sorry, something went wrong.

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)
[bors](/bors)
added
[S-waiting-on-bors](/rust-lang/rust/labels/S-waiting-on-bors)
Status: Waiting on bors to run and complete tests. Bors will change the label on completion.
and removed
[S-waiting-on-review](/rust-lang/rust/labels/S-waiting-on-review)
Status: Awaiting review from the assignee but also interested parties.
labels
[Jul 4, 2018](#event-1716710390)

[![@kennytm](https://avatars.githubusercontent.com/u/103023?s=40&v=4)](/kennytm)
[kennytm](/kennytm)
mentioned this pull request
[Jul 5, 2018](#ref-pullrequest-338753937)

[Rollup of 14 pull requests
#52088](/rust-lang/rust/pull/52088)
 Merged

[kennytm](/kennytm)
added a commit
to kennytm/rust
that referenced
this pull request
[Jul 6, 2018](#ref-commit-b87b22e)
[![@kennytm](https://avatars.githubusercontent.com/u/103023?s=40&v=4)](/kennytm)

`[Rollup merge of](/kennytm/rust/commit/b87b22e53caa405ac318c8b4c70d89fd6ffd0be8 "Rollup merge of #52031 - RalfJung:arc, r=sfackler

Strenghten synchronization in `Arc::is_unique`

Previously, `is_unique` would not synchronize at all with a `drop` that returned
early because it was not the last reference, leading to a data race.

Fixes #51780

Unfortunately I have no idea how to add a test for this.

Cc @jhjourdan") [rust-lang#52031](https://github.com/rust-lang/rust/pull/52031) [- RalfJung:arc, r=sfackler](/kennytm/rust/commit/b87b22e53caa405ac318c8b4c70d89fd6ffd0be8 "Rollup merge of #52031 - RalfJung:arc, r=sfackler

Strenghten synchronization in `Arc::is_unique`

Previously, `is_unique` would not synchronize at all with a `drop` that returned
early because it was not the last reference, leading to a data race.

Fixes #51780

Unfortunately I have no idea how to add a test for this.

Cc @jhjourdan")`
‚Ä¶

`[b87b22e](/kennytm/rust/commit/b87b22e53caa405ac318c8b4c70d89fd6ffd0be8)`

```
Strenghten synchronization in `Arc::is_unique`

Previously, `is_unique` would not synchronize at all with a `drop` that returned
early because it was not the last reference, leading to a data race.

Fixes [rust-lang#51780](https://github.com/rust-lang/rust/issues/51780)

Unfortunately I have no idea how to add a test for this.

Cc [@jhjourdan](https://github.com/jhjourdan)
```

[bors](/bors)
added a commit
that referenced
this pull request
[Jul 6, 2018](#ref-commit-bff0090)
[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)

`[Auto merge of](/rust-lang/rust/commit/bff009016b8a91485a4be7fee9aad946d59f47f0 "Auto merge of #52088 - kennytm:rollup, r=kennytm

Rollup of 14 pull requests

Successful merges:

 - #51619 (rust: add initial changes to support powerpc64le musl)
 - #51793 (Fix variant background color on hover in search results)
 - #52005 (Update LLVM to bring in a wasm codegen fix)
 - #52016 (Deduplicate error reports for statics)
 - #52019 ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - #52030 (Any docs preposition change)
 - #52031 (Strenghten synchronization in `Arc::is_unique`)
 - #52033 ([Gardening] Update outdated comments: ByVal -> Scalar)
 - #52052 (Make verbose --version show if parallel queries are supported.)
 - #52055 (Include VS 2017 in error message.)
 - #52063 (Add a link to the rustc docs)
 - #52073 (Add a punch card to weird expressions test)
 - #52080 (Improve dependency deduplication diagnostics)
 - #51953 (enable Atomic*.{load,store} for ARMv6-M / MSP430)

Failed merges:") [#52088](https://github.com/rust-lang/rust/pull/52088) [- kennytm:rollup, r=kennytm](/rust-lang/rust/commit/bff009016b8a91485a4be7fee9aad946d59f47f0 "Auto merge of #52088 - kennytm:rollup, r=kennytm

Rollup of 14 pull requests

Successful merges:

 - #51619 (rust: add initial changes to support powerpc64le musl)
 - #51793 (Fix variant background color on hover in search results)
 - #52005 (Update LLVM to bring in a wasm codegen fix)
 - #52016 (Deduplicate error reports for statics)
 - #52019 ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - #52030 (Any docs preposition change)
 - #52031 (Strenghten synchronization in `Arc::is_unique`)
 - #52033 ([Gardening] Update outdated comments: ByVal -> Scalar)
 - #52052 (Make verbose --version show if parallel queries are supported.)
 - #52055 (Include VS 2017 in error message.)
 - #52063 (Add a link to the rustc docs)
 - #52073 (Add a punch card to weird expressions test)
 - #52080 (Improve dependency deduplication diagnostics)
 - #51953 (enable Atomic*.{load,store} for ARMv6-M / MSP430)

Failed merges:")`
‚Ä¶

`[bff0090](/rust-lang/rust/commit/bff009016b8a91485a4be7fee9aad946d59f47f0)`

```
Rollup of 14 pull requests

Successful merges:

 - [#51619](https://github.com/rust-lang/rust/pull/51619) (rust: add initial changes to support powerpc64le musl)
 - [#51793](https://github.com/rust-lang/rust/pull/51793) (Fix variant background color on hover in search results)
 - [#52005](https://github.com/rust-lang/rust/pull/52005) (Update LLVM to bring in a wasm codegen fix)
 - [#52016](https://github.com/rust-lang/rust/pull/52016) (Deduplicate error reports for statics)
 - [#52019](https://github.com/rust-lang/rust/pull/52019) ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - [#52030](https://github.com/rust-lang/rust/pull/52030) (Any docs preposition change)
 - [#52031](https://github.com/rust-lang/rust/pull/52031) (Strenghten synchronization in `Arc::is_unique`)
 - [#52033](https://github.com/rust-lang/rust/pull/52033) ([Gardening] Update outdated comments: ByVal -> Scalar)
 - [#52052](https://github.com/rust-lang/rust/pull/52052) (Make verbose --version show if parallel queries are supported.)
 - [#52055](https://github.com/rust-lang/rust/pull/52055) (Include VS 2017 in error message.)
 - [#52063](https://github.com/rust-lang/rust/pull/52063) (Add a link to the rustc docs)
 - [#52073](https://github.com/rust-lang/rust/pull/52073) (Add a punch card to weird expressions test)
 - [#52080](https://github.com/rust-lang/rust/pull/52080) (Improve dependency deduplication diagnostics)
 - [#51953](https://github.com/rust-lang/rust/pull/51953) (enable Atomic*.{load,store} for ARMv6-M / MSP430)

Failed merges:
```

[bors](/bors)
added a commit
that referenced
this pull request
[Jul 6, 2018](#ref-commit-4d9fa23)
[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)

`[Auto merge of](/rust-lang/rust/commit/4d9fa2326e184314749ccf79203f5ecc35e6225c "Auto merge of #52088 - kennytm:rollup, r=kennytm

Rollup of 14 pull requests

Successful merges:

 - #51619 (rust: add initial changes to support powerpc64le musl)
 - #51793 (Fix variant background color on hover in search results)
 - #52005 (Update LLVM to bring in a wasm codegen fix)
 - #52016 (Deduplicate error reports for statics)
 - #52019 ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - #52030 (Any docs preposition change)
 - #52031 (Strenghten synchronization in `Arc::is_unique`)
 - #52033 ([Gardening] Update outdated comments: ByVal -> Scalar)
 - #52055 (Include VS 2017 in error message.)
 - #52063 (Add a link to the rustc docs)
 - #52073 (Add a punch card to weird expressions test)
 - #52080 (Improve dependency deduplication diagnostics)
 - #52093 (rustc: Update tracking issue for wasm_import_module)
 - #52096 (Fix typo in cell.rs)

Failed merges:") [#52088](https://github.com/rust-lang/rust/pull/52088) [- kennytm:rollup, r=kennytm](/rust-lang/rust/commit/4d9fa2326e184314749ccf79203f5ecc35e6225c "Auto merge of #52088 - kennytm:rollup, r=kennytm

Rollup of 14 pull requests

Successful merges:

 - #51619 (rust: add initial changes to support powerpc64le musl)
 - #51793 (Fix variant background color on hover in search results)
 - #52005 (Update LLVM to bring in a wasm codegen fix)
 - #52016 (Deduplicate error reports for statics)
 - #52019 ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - #52030 (Any docs preposition change)
 - #52031 (Strenghten synchronization in `Arc::is_unique`)
 - #52033 ([Gardening] Update outdated comments: ByVal -> Scalar)
 - #52055 (Include VS 2017 in error message.)
 - #52063 (Add a link to the rustc docs)
 - #52073 (Add a punch card to weird expressions test)
 - #52080 (Improve dependency deduplication diagnostics)
 - #52093 (rustc: Update tracking issue for wasm_import_module)
 - #52096 (Fix typo in cell.rs)

Failed merges:")`
‚Ä¶

`[4d9fa23](/rust-lang/rust/commit/4d9fa2326e184314749ccf79203f5ecc35e6225c)`

```
Rollup of 14 pull requests

Successful merges:

 - [#51619](https://github.com/rust-lang/rust/pull/51619) (rust: add initial changes to support powerpc64le musl)
 - [#51793](https://github.com/rust-lang/rust/pull/51793) (Fix variant background color on hover in search results)
 - [#52005](https://github.com/rust-lang/rust/pull/52005) (Update LLVM to bring in a wasm codegen fix)
 - [#52016](https://github.com/rust-lang/rust/pull/52016) (Deduplicate error reports for statics)
 - [#52019](https://github.com/rust-lang/rust/pull/52019) ([cross-lang-lto] Allow the linker to choose the LTO-plugin (which is useful when using LLD))
 - [#52030](https://github.com/rust-lang/rust/pull/52030) (Any docs preposition change)
 - [#52031](https://github.com/rust-lang/rust/pull/52031) (Strenghten synchronization in `Arc::is_unique`)
 - [#52033](https://github.com/rust-lang/rust/pull/52033) ([Gardening] Update outdated comments: ByVal -> Scalar)
 - [#52055](https://github.com/rust-lang/rust/pull/52055) (Include VS 2017 in error message.)
 - [#52063](https://github.com/rust-lang/rust/pull/52063) (Add a link to the rustc docs)
 - [#52073](https://github.com/rust-lang/rust/pull/52073) (Add a punch card to weird expressions test)
 - [#52080](https://github.com/rust-lang/rust/pull/52080) (Improve dependency deduplication diagnostics)
 - [#52093](https://github.com/rust-lang/rust/pull/52093) (rustc: Update tracking issue for wasm_import_module)
 - [#52096](https://github.com/rust-lang/rust/pull/52096) (Fix typo in cell.rs)

Failed merges:
```

[![@bors](https://avatars.githubusercontent.com/u/3372342?s=40&v=4)](/bors)
[bors](/bors)
merged commit [`f96c246`](/rust-lang/rust/commit/f96c2468695911222ba7557ce04af0dd8fbb6df2)
into
rust-lang:master

[Jul 6, 2018](https://github.com/rust-lang/rust/pull/52031#event-1719814243)

 [![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=40&u=562ead6e5c8da9a02015f73a9aefdb6c82d4e2cf&v=4)](/RalfJung)
[RalfJung](/RalfJung)
deleted the
arc

branch
[July 10, 2018 09:03](#event-1724990589)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fpull%2F52031)

Reviewers

No reviews

Assignees

[![@sfackler](https://avatars.githubusercontent.com/u/1455697?s=40&v=4)](/sfackler) [sfackler](/sfackler)

Labels

[S-waiting-on-bors](/rust-lang/rust/labels/S-waiting-on-bors)
Status: Waiting on bors to run and complete tests. Bors will change the label on completion.

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@RalfJung](https://avatars.githubusercontent.com/u/330628?s=52&v=4)](/RalfJung) [![@rust-highfive](https://avatars.githubusercontent.com/u/7378925?s=52&v=4)](/rust-highfive) [![@sfackler](https://avatars.githubusercontent.com/u/1455697?s=52&v=4)](/sfackler) [![@bors](https://avatars.githubusercontent.com/u/3372342?s=52&v=4)](/bors)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_42b70441_20250124_121022.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F51780)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F51780)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=rust-lang%2Frust)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[rust](/rust-lang/rust)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Frust) You must be signed in to change notification settings
* [Fork
  13k](/login?return_to=%2Frust-lang%2Frust)
* [Star
   101k](/login?return_to=%2Frust-lang%2Frust)

* [Code](/rust-lang/rust)
* [Issues
  5k+](/rust-lang/rust/issues)
* [Pull requests
  685](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects
  8](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

Additional navigation options

* [Code](/rust-lang/rust)
* [Issues](/rust-lang/rust/issues)
* [Pull requests](/rust-lang/rust/pulls)
* [Actions](/rust-lang/rust/actions)
* [Projects](/rust-lang/rust/projects)
* [Security](/rust-lang/rust/security)
* [Insights](/rust-lang/rust/pulse)

# Insufficient synchronization in `Arc::get_mut`¬†#51780

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Insufficient synchronization in `Arc::get_mut`](#top)#51780Copy linkLabels[C-bugCategory: This is a bug.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22C-bug%22)Category: This is a bug.[I-unsoundIssue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22I-unsound%22)Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness[T-libs-apiRelevant to the library API team, which will review and decide on the PR/issue.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22T-libs-api%22)Relevant to the library API team, which will review and decide on the PR/issue.[![@jhjourdan](https://avatars.githubusercontent.com/u/1917144?v=4&size=80)](/jhjourdan)
## Description

[![@jhjourdan](https://avatars.githubusercontent.com/u/1917144?v=4&size=48)](/jhjourdan)[jhjourdan](https://github.com/jhjourdan)opened [on Jun 25, 2018](https://github.com/rust-lang/rust/issues/51780#issue-335463751)

Consider the following Rust code:

```
extern crate rayon;

use std::sync::{Arc, Mutex};
use std::mem;
use rayon::join;

fn main() {
    let a1 = Arc::new(Mutex::new(0));
    let mut a2 = &mut a1.clone();
    join(
        || {
            { let mut guard = a1.lock().unwrap();
              *guard += 1;
              mem::forget(guard); }
            drop(a1);
        },
        || {
            loop {
                match Arc::get_mut(&mut a2) {
                    None => (),
                    Some(m) =>
                    { *m.get_mut().unwrap() += 1;
                      return; }
                }
            }
        }
    );
}
```

The first thread acquires the lock, modifies the variable, and then drop its Arc *without unlocking* (that's the point of the `mem::forget`).

The second thread waits until the first thread decrements the count by dropping its Arc, and then uses `get_mut` to access the content *without taking the lock* (at that time, the mutex is still locked).

My claim is that there is a race between the two accesses of the content of the mutex. The only reason the two accesses would be in a happens-before relationship would be that `Arc::drop` and `Arc::get_mut` would establish this happens-before relationship. However, even though `Arc::drop` does use a release write, `Arc::get_mut` only uses a relaxed read of the strong counter (via `is_unique`).

The fix is to use an acquire read in `is_unique`. I do not expect significant performance penalty here, since `is_unique` already contains several release-acquire accesses (of the weak count).

CC [@RalfJung](https://github.com/RalfJung)

**EDIT**

As [@RalfJung](https://github.com/RalfJung) noted, we do not actually need leaking memory to exploit this bug (hence this is not another instance of Leakpocalypse). The following piece of code exhibit the same problem:

```
extern crate rayon;

use std::sync::Arc;
use rayon::join;

fn main() {
    let a1 = Arc::new(0);
    let mut a2 = a1.clone();
    join(
        || {
            let _ : u32 = *a1;
            drop(a1);
        },
        || {
            loop {
                match Arc::get_mut(&mut a2) {
                    None => {}
                    Some(m) => {
                        *m = 1u32;
                        return;
                    }
                }
            }
        }
    );
}
```
‚ù§Ô∏è27
## Metadata

### Assignees

No one assigned

### Labels

[C-bugCategory: This is a bug.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22C-bug%22)Category: This is a bug.[I-unsoundIssue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22I-unsound%22)Issue: A soundness hole (worst kind of bug), see: https://en.wikipedia.org/wiki/Soundness[T-libs-apiRelevant to the library API team, which will review and decide on the PR/issue.](https://github.com/rust-lang/rust/issues?q=state%3Aopen%20label%3A%22T-libs-api%22)Relevant to the library API team, which will review and decide on the PR/issue.
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


