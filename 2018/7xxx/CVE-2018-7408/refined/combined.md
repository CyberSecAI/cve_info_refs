=== Content from blog.npmjs.org_0783e9ab_20250125_160754.html ===


[npm Blog (Archive)](/)

[npmjs.com](https://npmjs.com/)
[Status](https://status.npmjs.com/)
[Support](https://npmjs.com/support/)

The npm blog has been discontinued.

Updates from the npm team are now published on the
[GitHub Blog](https://github.blog/) and
the [GitHub
Changelog](https://github.blog/changelog/).

# v5.7.1

This release reverts a patch that could cause some ownership changes on system files when running from some directories when also using `sudo`. üò≤

Thankfully, it only affected users running `npm@next`, which is part of our staggered release system, which we use to prevent issues like this from going out into the wider world before we can catch them. Users on `latest` would have never seen this!

The original patch was added to increase consistency and reliability of methods npm uses to avoid writing files as `root` in places it shouldn‚Äôt, but the change was applied in places that should have used regular mkdirp`. This release reverts that patch.

\* [`74e149da6`](<https://github.com/npm/npm/commit/74e149da6efe6ed89477faa81fef08eee7999ad0>) [`#19883`](<https://github.com/npm/npm/issue/19883>) Revert ‚Äú\*: Switch from mkdirp to correctMkdir to preserve perms and owners‚Äù This reverts commit [`94227e15`](<https://github.com/npm/npm/commit/94227e15eeced836b3d7b3d2b5e5cc41d4959cff>). ([@zkat](<https://github.com/zkat>))

 February 22nd, 2018 9:53am
@maybekatz
[angryorangewebsite](/tagged/angryorangewebsite)
[peoplegotmad](/tagged/peoplegotmad)
[stopusingprereleaseswithsudo](/tagged/stopusingprereleaseswithsudo)
[clihotfix](/tagged/clihotfix)
[wegotubb](/tagged/wegotubb)
[literallykilledgithub](/tagged/literallykilledgithub)



=== Content from github.com_d97b554d_20250125_160758.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpm%2Fnpm%2Fissues%2F19883)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpm%2Fnpm%2Fissues%2F19883)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=npm%2Fnpm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Aug 11, 2022. It is now read-only.

[npm](/npm)
/
**[npm](/npm/npm)**
Public archive

* [Notifications](/login?return_to=%2Fnpm%2Fnpm) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fnpm%2Fnpm)
* [Star
   17.5k](/login?return_to=%2Fnpm%2Fnpm)

* [Code](/npm/npm)
* [Issues
  2.2k](/npm/npm/issues)
* [Pull requests
  0](/npm/npm/pulls)
* [Actions](/npm/npm/actions)
* [Security](/npm/npm/security)
* [Insights](/npm/npm/pulse)

Additional navigation options

* [Code](/npm/npm)
* [Issues](/npm/npm/issues)
* [Pull requests](/npm/npm/pulls)
* [Actions](/npm/npm/actions)
* [Security](/npm/npm/security)
* [Insights](/npm/npm/pulse)

This repository has been archived by the owner on Aug 11, 2022. It is now read-only.

# Critical Linux filesystem permissions are being changed by latest version¬†#19883

[Jump to bottom](#comment-composer-heading)Copy link[Jump to bottom](#comment-composer-heading)Copy linkClosed[#19889](https://github.com/npm/npm/pull/19889)Closed[Critical Linux filesystem permissions are being changed by latest version](#top)#19883[#19889](https://github.com/npm/npm/pull/19889)Copy link[![@Crunkle](https://avatars.githubusercontent.com/u/1208758?u=3f9f59426b318db1722486851c8579495c01c5a1&v=4&size=80)](/Crunkle)
## Description

[![@Crunkle](https://avatars.githubusercontent.com/u/1208758?u=3f9f59426b318db1722486851c8579495c01c5a1&v=4&size=48)](/Crunkle)[Crunkle](https://github.com/Crunkle)opened [on Feb 22, 2018](https://github.com/npm/npm/issues/19883#issue-299211682)
#### I'm opening this issue because:

* npm is crashing.
* npm is producing an incorrect install.
* npm is doing something I don't understand.
* Other (*see below for feature requests*):

#### What's going wrong?

This issue has been happening ever since 5.7.0 was released a few hours ago. It seems to have completely broken my filesystem permissions and caused me to have to manually fix the permissions of critical files and folders. I believe that it is related to the commit [94227e1](https://github.com/npm/npm/commit/94227e15eeced836b3d7b3d2b5e5cc41d4959cff) which is traversing and running `chown` on the wrong, often critical, filesystem files and folders.

By running `sudo npm` under a non-root user (root users do not have the same effect), filesystem permissions are being heavily modified. For example, if I run `sudo npm --help` or `sudo npm update -g`, both commands cause my filesystem to change ownership of directories such as `/etc`, `/usr`, `/boot`, and other directories needed for running the system. It appears that the ownership is recursively changed to the user currently running npm.

I found that a selection of directories in `/` were owned by a non-root user after running `sudo npm` and many binaries in `/usr/bin` stopped working as their permissions were changed. People experiencing this bug will likely have to fully reinstall their system due to this update.

`npm update -g` as `root`:

No output, all packages up to date. Likely still causes a `chown` to be run silently to `root:root`.

`drwxr-xr-x 10 root root 129 Feb 22 03:39 /usr`

Then doing a `su jared` (a non-root user):

`sudo npm update -g` as `jared`:

Sometimes `EACCES` or `EPERM` output, almost always corrupts the filesystem.

`drwxr-xr-x 10 jared jared 129 Feb 22 03:39 /usr`

The `/usr` directory has been claimed by `npm` and ownership was set to `jared:jared` as shown above. This same thing happens with other directories seemingly at random whilst being traversed.

If you do not give it `sudo` permissions and just run `npm` alone, you can see it is attempting to traverse my `/boot` ownership and crashes when it fails (if given `sudo`, it will say `chown` instead of `scandir` and output an `EACCES` instead):

> Error: EPERM: operation not permitted, scandir '/boot/initramfs-linux-fallback.img'
>
> TypeError: Cannot read property 'get' of undefined
>
> ...

> Error: EACCES: operation not permitted, chown '/boot/initramfs-linux-fallback.img'
>
> TypeError: Cannot read property 'get' of undefined
>
> ...

It is very dangerous to run the latest version under `sudo` and I have a feeling it isn't just me getting these results.

#### How can the CLI team reproduce the problem?

I am personally using Arch Linux with the latest `npm` package, installed as the `root` user via:

`pacman -Sy npm nodejs`

`npm install -g npm`

`npm install -g semver`

Ensure that your npm is on version 5.7.0 then, as a non-root user, with `sudo` prefix:

`sudo npm --help`

You will find that it fails, sometimes with no warnings and sometimes with an `EACCES` as it is unable to `chown` the files in `/boot` or read-only directories. No log files are generated on my system as it throws an output in console.

This was *not* occurring on my system before the most recent update and using 5.6.0 resolves the issue entirely.

### Supporting Information:

* `npm -v` prints: `5.7.0`
* `node -v` prints: `9.5.0`
* `npm config get registry` prints: `https://registry.npmjs.org/`
* Windows, OS X/macOS, or Linux?: Arch Linux (latest base)
* Network issues:
  + Geographic location where npm was run: UK
  + I use a proxy to connect to the npm registry.
  + I use a proxy to connect to the web.
  + I use a proxy when downloading Git repos.
  + I access the npm registry via a VPN
  + I don't use a proxy, but have limited or unreliable internet access.
* Container:
  + I develop using Vagrant on Windows.
  + I develop using Vagrant on OS X or Linux.
  + I develop / deploy using Docker.
  + I deploy to a PaaS (Triton, Heroku).
üëç88üëé3üòÑ85üéâ107üòï61‚ù§Ô∏è20
## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_ed49a50f_20250125_160757.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpm%2Fnpm%2Fcommit%2F74e149da6efe6ed89477faa81fef08eee7999ad0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpm%2Fnpm%2Fcommit%2F74e149da6efe6ed89477faa81fef08eee7999ad0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=npm%2Fnpm)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Aug 11, 2022. It is now read-only.

[npm](/npm)
/
**[npm](/npm/npm)**
Public archive

* [Notifications](/login?return_to=%2Fnpm%2Fnpm) You must be signed in to change notification settings
* [Fork
  3k](/login?return_to=%2Fnpm%2Fnpm)
* [Star
   17.5k](/login?return_to=%2Fnpm%2Fnpm)

* [Code](/npm/npm)
* [Issues
  2.2k](/npm/npm/issues)
* [Pull requests
  0](/npm/npm/pulls)
* [Actions](/npm/npm/actions)
* [Security](/npm/npm/security)
* [Insights](/npm/npm/pulse)

Additional navigation options

* [Code](/npm/npm)
* [Issues](/npm/npm/issues)
* [Pull requests](/npm/npm/pulls)
* [Actions](/npm/npm/actions)
* [Security](/npm/npm/security)
* [Insights](/npm/npm/pulse)

## Commit

[Permalink](/npm/npm/commit/74e149da6efe6ed89477faa81fef08eee7999ad0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Revert "\*: Switch from mkdirp to correctMkdir to preserve perms and o‚Ä¶

[Browse files](/npm/npm/tree/74e149da6efe6ed89477faa81fef08eee7999ad0)
Browse the repository at this point in the history

```
‚Ä¶wners"

This reverts commit [94227e1](https://github.com/npm/npm/commit/94227e15eeced836b3d7b3d2b5e5cc41d4959cff).

Fixes: [#19883](https://github.com/npm/npm/issues/19883)
```

* Loading branch information

[![@zkat](https://avatars.githubusercontent.com/u/17535?s=40&v=4)](/zkat)

[zkat](/npm/npm/commits?author=zkat "View all commits by zkat")
committed
Feb 22, 2018

1 parent
[d3095ff](/npm/npm/commit/d3095ff20b8ea01e7fbf93a4a697a04fea77d8e6)

commit 74e149d

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**28 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* lib

  + config

    - lib/config/core.js
      [core.js](#diff-d1a223f8cbf3caa71cbfe90108701ffc97b04143394ffadaff351263b52f3c07)
    - lib/config/set-user.js
      [set-user.js](#diff-ade2a51d2efc5b7c1c0672782dbf7e89d8352196dc28851a023ec2a56d5c170a)
  + lib/install.js
    [install.js](#diff-a021b62b61739461595e009ed3d8524495144ddba458d99f1eba19e2a2be7b74)
  + install/action

    - lib/install/action/extract.js
      [extract.js](#diff-6e78e48f104b07c9efae96bf45f131e0511283fcb5859922ef6d30510b85b551)
    - lib/install/action/finalize.js
      [finalize.js](#diff-4cf154209a0bdb9586a6f3d33d29a7dfedb5e76167fbc689db1b2b5942bcb7a0)
    - lib/install/action/move.js
      [move.js](#diff-a88d3f2b6be1b1114d52f9bdd7efb982e6843a36663b5b32ff0941650187d865)
    - lib/install/action/remove.js
      [remove.js](#diff-475a613f47028424b9b05a390505779468abe9a7f07a8d0cf7f27867397f637e)
  + utils

    - completion

      * lib/utils/completion/file-completion.js
        [file-completion.js](#diff-703a68e1dd8a923fee45e4be71b39002a649bf973016ab485e7401aba411ac40)
    - lib/utils/correct-mkdir.js
      [correct-mkdir.js](#diff-fc9738d82fa9a0efc9e3754c82024f075b4006589bbc6d30dd091e10a35d0a60)

## There are no files selected for viewing

8 changes: 4 additions & 4 deletions

8
[lib/config/core.js](#diff-d1a223f8cbf3caa71cbfe90108701ffc97b04143394ffadaff351263b52f3c07 "lib/config/core.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/config/core.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,7 +8,7 @@ var path = require('path') |
|  |  | var nopt = require('nopt') |
|  |  | var ini = require('ini') |
|  |  | var Umask = configDefs.Umask |
|  |  | var correctMkdir = require('../utils/correct-mkdir.js') |
|  |  | var mkdirp = require('mkdirp') |
|  |  | var umask = require('../utils/umask') |
|  |  | var isWindows = require('../utils/is-windows.js') |
|  |  |  |
| Expand Down  Expand Up | | @@ -153,7 +153,7 @@ function load\_ (builtin, rc, cli, cb) { |
|  |  | // annoying humans and their expectations! |
|  |  | if (conf.get('prefix')) { |
|  |  | var etc = path.resolve(conf.get('prefix'), 'etc') |
|  |  | correctMkdir(etc, function () { |
|  |  | mkdirp(etc, function () { |
|  |  | defaults.globalconfig = path.resolve(etc, 'npmrc') |
|  |  | defaults.globalignorefile = path.resolve(etc, 'npmignore') |
|  |  | afterUserContinuation() |
| Expand Down  Expand Up | | @@ -235,7 +235,7 @@ Conf.prototype.loadExtras = function (cb) { |
|  |  | this.loadUid(function (er) { |
|  |  | if (er) return cb(er) |
|  |  | // Without prefix, nothing will ever work |
|  |  | correctMkdir(this.prefix, cb) |
|  |  | mkdirp(this.prefix, cb) |
|  |  | }.bind(this)) |
|  |  | }.bind(this)) |
|  |  | } |
| Expand Down  Expand Up | | @@ -292,7 +292,7 @@ Conf.prototype.save = function (where, cb) { |
|  |  | done(null) |
|  |  | }) |
|  |  | } else { |
|  |  | correctMkdir(path.dirname(target.path), function (er) { |
|  |  | mkdirp(path.dirname(target.path), function (er) { |
|  |  | if (er) return then(er) |
|  |  | fs.writeFile(target.path, data, 'utf8', function (er) { |
|  |  | if (er) return then(er) |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[lib/config/set-user.js](#diff-ade2a51d2efc5b7c1c0672782dbf7e89d8352196dc28851a023ec2a56d5c170a "lib/config/set-user.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/config/set-user.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,7 +3,7 @@ module.exports = setUser |
|  |  | var assert = require('assert') |
|  |  | var path = require('path') |
|  |  | var fs = require('fs') |
|  |  | var correctMkdir = require('../utils/correct-mkdir.js') |
|  |  | var mkdirp = require('mkdirp') |
|  |  |  |
|  |  | function setUser (cb) { |
|  |  | var defaultConf = this.root |
| Expand All | | @@ -19,7 +19,7 @@ function setUser (cb) { |
|  |  | } |
|  |  |  |
|  |  | var prefix = path.resolve(this.get('prefix')) |
|  |  | correctMkdir(prefix, function (er) { |
|  |  | mkdirp(prefix, function (er) { |
|  |  | if (er) return cb(er) |
|  |  | fs.stat(prefix, function (er, st) { |
|  |  | defaultConf.user = st && st.uid |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[lib/install.js](#diff-a021b62b61739461595e009ed3d8524495144ddba458d99f1eba19e2a2be7b74 "lib/install.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/install.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -102,7 +102,7 @@ var readPackageJson = require('read-package-json') |
|  |  | var chain = require('slide').chain |
|  |  | var asyncMap = require('slide').asyncMap |
|  |  | var archy = require('archy') |
|  |  | var correctMkdir = require('./utils/correct-mkdir.js') |
|  |  | var mkdirp = require('mkdirp') |
|  |  | var rimraf = require('rimraf') |
|  |  | var iferr = require('iferr') |
|  |  | var validate = require('aproba') |
| Expand Down  Expand Up | | @@ -648,7 +648,7 @@ Installer.prototype.readGlobalPackageData = function (cb) { |
|  |  | log.silly('install', 'readGlobalPackageData') |
|  |  | var self = this |
|  |  | this.loadArgMetadata(iferr(cb, function () { |
|  |  | correctMkdir(self.where, iferr(cb, function () { |
|  |  | mkdirp(self.where, iferr(cb, function () { |
|  |  | var pkgs = {} |
|  |  | self.args.forEach(function (pkg) { |
|  |  | pkgs[pkg.name] = true |
| Expand All | | @@ -665,7 +665,7 @@ Installer.prototype.readLocalPackageData = function (cb) { |
|  |  | validate('F', arguments) |
|  |  | log.silly('install', 'readLocalPackageData') |
|  |  | var self = this |
|  |  | correctMkdir(this.where, iferr(cb, function () { |
|  |  | mkdirp(this.where, iferr(cb, function () { |
|  |  | readPackageTree(self.where, iferr(cb, function (currentTree) { |
|  |  | self.currentTree = currentTree |
|  |  | self.currentTree.warnings = [] |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[lib/install/action/extract.js](#diff-6e78e48f104b07c9efae96bf45f131e0511283fcb5859922ef6d30510b85b551 "lib/install/action/extract.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/install/action/extract.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,7 +4,7 @@ const BB = require('bluebird') |
|  |  |  |
|  |  | const stat = BB.promisify(require('graceful-fs').stat) |
|  |  | const gentlyRm = BB.promisify(require('../../utils/gently-rm.js')) |
|  |  | const correctMkdir = BB.promisify(require('../../utils/correct-mkdir')) |
|  |  | const mkdirp = BB.promisify(require('mkdirp')) |
|  |  | const moduleStagingPath = require('../module-staging-path.js') |
|  |  | const move = require('../../utils/move.js') |
|  |  | const npa = require('npm-package-arg') |
| Expand Down  Expand Up | | @@ -127,7 +127,7 @@ function stageBundledModule (bundler, child, staging, parentPath) { |
|  |  | function finishModule (bundler, child, stageTo, stageFrom) { |
|  |  | // If we were the one's who bundled this module‚Ä¶ |
|  |  | if (child.fromBundle === bundler) { |
|  |  | return correctMkdir(path.dirname(stageTo)).then(() => { |
|  |  | return mkdirp(path.dirname(stageTo)).then(() => { |
|  |  | return move(stageFrom, stageTo) |
|  |  | }) |
|  |  | } else { |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[lib/install/action/finalize.js](#diff-4cf154209a0bdb9586a6f3d33d29a7dfedb5e76167fbc689db1b2b5942bcb7a0 "lib/install/action/finalize.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/install/action/finalize.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,6 +3,7 @@ const path = require('path') |
|  |  | const fs = require('graceful-fs') |
|  |  | const Bluebird = require('bluebird') |
|  |  | const rimraf = Bluebird.promisify(require('rimraf')) |
|  |  | const mkdirp = Bluebird.promisify(require('mkdirp')) |
|  |  | const lstat = Bluebird.promisify(fs.lstat) |
|  |  | const readdir = Bluebird.promisify(fs.readdir) |
|  |  | const symlink = Bluebird.promisify(fs.symlink) |
| Expand All | | @@ -13,7 +14,6 @@ const moveOpts = {fs: fs, Promise: Bluebird, maxConcurrency: 4} |
|  |  | const getRequested = require('../get-requested.js') |
|  |  | const log = require('npmlog') |
|  |  | const packageId = require('../../utils/package-id.js') |
|  |  | const correctMkdir = Bluebird.promisify(require('../../utils/correct-mkdir.js')) |
|  |  |  |
|  |  | module.exports = function (staging, pkg, log) { |
|  |  | log.silly('finalize', pkg.realpath) |
| Expand Down  Expand Up | | @@ -48,7 +48,7 @@ module.exports = function (staging, pkg, log) { |
|  |  | } |
|  |  |  |
|  |  | function makeParentPath (dir) { |
|  |  | return correctMkdir(path.dirname(dir)) |
|  |  | return mkdirp(path.dirname(dir)) |
|  |  | } |
|  |  |  |
|  |  | function moveStagingToDestination () { |
| Expand Down  Expand Up | | @@ -81,7 +81,7 @@ module.exports = function (staging, pkg, log) { |
|  |  | if (!movedDestAway) return |
|  |  | return readdir(path.join(delpath, 'node\_modules')).catch(() => []).then((modules) => { |
|  |  | if (!modules.length) return |
|  |  | return correctMkdir(path.join(pkg.realpath, 'node\_modules')).then(() => Bluebird.map(modules, (file) => { |
|  |  | return mkdirp(path.join(pkg.realpath, 'node\_modules')).then(() => Bluebird.map(modules, (file) => { |
|  |  | const from = path.join(delpath, 'node\_modules', file) |
|  |  | const to = path.join(pkg.realpath, 'node\_modules', file) |
|  |  | return move(from, to, moveOpts) |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[lib/install/action/move.js](#diff-a88d3f2b6be1b1114d52f9bdd7efb982e6843a36663b5b32ff0941650187d865 "lib/install/action/move.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/install/action/move.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,7 +4,7 @@ var path = require('path') |
|  |  | var chain = require('slide').chain |
|  |  | var iferr = require('iferr') |
|  |  | var rimraf = require('rimraf') |
|  |  | var correctMkdir = require('../../utils/correct-mkdir') |
|  |  | var mkdirp = require('mkdirp') |
|  |  | var rmStuff = require('../../unbuild.js').rmStuff |
|  |  | var lifecycle = require('../../utils/lifecycle.js') |
|  |  | var move = require('../../utils/move.js') |
| Expand Down  Expand Up | | @@ -67,7 +67,7 @@ function moveModuleOnly (from, to, log, done) { |
|  |  | function makeDestination (next) { |
|  |  | return function () { |
|  |  | log.silly('move', 'make sure destination parent exists', path.resolve(to, '..')) |
|  |  | correctMkdir(path.resolve(to, '..'), iferr(done, moveNodeModules(next))) |
|  |  | mkdirp(path.resolve(to, '..'), iferr(done, moveNodeModules(next))) |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand All | | @@ -87,7 +87,7 @@ function moveModuleOnly (from, to, log, done) { |
|  |  |  |
|  |  | function moveNodeModulesBack (next) { |
|  |  | return function () { |
|  |  | correctMkdir(from, iferr(done, function () { |
|  |  | mkdirp(from, iferr(done, function () { |
|  |  | log.silly('move', 'put source node\_modules back', fromModules) |
|  |  | move(tempFromModules, fromModules).then(next, done) |
|  |  | })) |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[lib/install/action/remove.js](#diff-475a613f47028424b9b05a390505779468abe9a7f07a8d0cf7f27867397f637e "lib/install/action/remove.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/install/action/remove.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,7 +3,7 @@ var path = require('path') |
|  |  | var fs = require('graceful-fs') |
|  |  | var rimraf = require('rimraf') |
|  |  | var asyncMap = require('slide').asyncMap |
|  |  | var correctMkdir = require('../../utils/correct-mkdir') |
|  |  | var mkdirp = require('mkdirp') |
|  |  | var npm = require('../../npm.js') |
|  |  | var andIgnoreErrors = require('../and-ignore-errors.js') |
|  |  | var move = require('../../utils/move.js') |
| Expand Down  Expand Up | | @@ -52,7 +52,7 @@ function removeDir (pkg, log, next) { |
|  |  | function makeTarget (readdirEr, files) { |
|  |  | if (readdirEr) return cleanup() |
|  |  | if (!files.length) return cleanup() |
|  |  | correctMkdir(path.join(pkg.path, 'node\_modules'), function (mkdirEr) { moveModules(mkdirEr, files) }) |
|  |  | mkdirp(path.join(pkg.path, 'node\_modules'), function (mkdirEr) { moveModules(mkdirEr, files) }) |
|  |  | } |
|  |  |  |
|  |  | function moveModules (mkdirEr, files) { |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[lib/utils/completion/file-completion.js](#diff-703a68e1dd8a923fee45e4be71b39002a649bf973016ab485e7401aba411ac40 "lib/utils/completion/file-completion.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/utils/completion/file-completion.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,14 +1,14 @@ |
|  |  | module.exports = fileCompletion |
|  |  |  |
|  |  | var correctMkdir = require('../correct-mkdir.js') |
|  |  | var mkdir = require('mkdirp') |
|  |  | var glob = require('glob') |
|  |  |  |
|  |  | function fileCompletion (root, req, depth, cb) { |
|  |  | if (typeof cb !== 'function') { |
|  |  | cb = depth |
|  |  | depth = Infinity |
|  |  | } |
|  |  | correctMkdir(root, function (er) { |
|  |  | mkdir(root, function (er) { |
|  |  | if (er) return cb(er) |
|  |  |  |
|  |  | // can be either exactly the req, or a descendent |
| Expand Down | |  |

14 changes: 7 additions & 7 deletions

14
[lib/utils/correct-mkdir.js](#diff-fc9738d82fa9a0efc9e3754c82024f075b4006589bbc6d30dd091e10a35d0a60 "lib/utils/correct-mkdir.js")

Show comments

[View file](/npm/npm/blob/74e149da6efe6ed89477faa81fef08eee7999ad0/lib/utils/correct-mkdir.js)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,21 +6,21 @@ var log = require('npmlog') |
|  |  | var mkdirp = require('mkdirp') |
|  |  |  |
|  |  | // memoize the directories created by this step |
|  |  | var stats = {} |
|  |  | var effectiveOwner |
|  |  | module.exports = function correctMkdir (path, cb) { |
|  |  | cb = dezalgo(cb) |
|  |  | cb = inflight('correctMkdir:' + path, cb) |
|  |  | if (!cb) { |
|  |  | return log.silly('correctMkdir', path, 'correctMkdir already in flight; waiting') |
|  |  | return log.verbose('correctMkdir', path, 'correctMkdir already in flight; waiting') |
|  |  | } else { |
|  |  | log.silly('correctMkdir', path, 'correctMkdir not in flight; initializing') |
|  |  | log.verbose('correctMkdir', path, 'correctMkdir not in flight; initializing') |
|  |  | } |
|  |  | var stats = {} |
|  |  |  |
|  |  | if (stats[path]) return cb(null, stats[path]) |
|  |  |  |
|  |  | fs.stat(path, function (er, st) { |
|  |  | if (er) return makeDirectory(path, stats, cb) |
|  |  | if (er) return makeDirectory(path, cb) |
|  |  |  |
|  |  | if (!st.isDirectory()) { |
|  |  | log.error('correctMkdir', 'invalid dir %s', path) |
| Expand Down  Expand Up | | @@ -60,12 +60,12 @@ function calculateOwner () { |
|  |  | return effectiveOwner |
|  |  | } |
|  |  |  |
|  |  | function makeDirectory (path, stats, cb) { |
|  |  | function makeDirectory (path, cb) { |
|  |  | cb = inflight('makeDirectory:' + path, cb) |
|  |  | if (!cb) { |
|  |  | return log.silly('makeDirectory', path, 'creation already in flight; waiting') |
|  |  | return log.verbose('makeDirectory', path, 'creation already in flight; waiting') |
|  |  | } else { |
|  |  | log.silly('makeDirectory', path, 'creation not in flight; initializing') |
|  |  | log.verbose('makeDirectory', path, 'creation not in flight; initializing') |
|  |  | } |
|  |  |  |
|  |  | var owner = calculateOwner() |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 2 comments on commit `74e149d`

[![@ggoomggoo](https://avatars.githubusercontent.com/u/14948725?s=80&v=4)](/ggoomggoo)

Copy link

### @ggoomggoo **[ggoomggoo](/ggoomggoo)** commented on `[74e149d](/npm/npm/commit/74e149da6efe6ed89477faa81fef08eee7999ad0)` [Feb 23, 2018](#commitcomment-27731784)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

üëç

Sorry, something went wrong.

All reactions

[![@codeWonderland](https://avatars.githubusercontent.com/u/22084929?s=80&v=4)](/codeWonderland)

Copy link

### @codeWonderland **[codeWonderland](/codeWonderland)** commented on `[74e149d](/npm/npm/commit/74e149da6efe6ed89477faa81fef08eee7999ad0)` [Feb 23, 2018](#commitcomment-27739449)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you üôèüèª

Sorry, something went wrong.

All reactions

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnpm%2Fnpm%2Fcommit%2F74e149da6efe6ed89477faa81fef08eee7999ad0) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


