- **Root cause of vulnerability**: The vulnerability stems from a key confusion issue in XMLSecLibs, where an `XMLSecurityKey` object can be instantiated with a specific algorithm but loaded with key material that doesn't correspond to that algorithm. This is coupled with the fact that the API provides common methods regardless of the algorithm that may return different values depending on the underlying backend used. Specifically, a public key can be used as a secret key when using the HMAC_SHA1 algorithm.
- **Weaknesses/vulnerabilities present**:
    - **Key confusion**: The `XMLSecurityKey` object doesn't enforce key type matching the algorithm, leading to the possibility of loading the wrong key type for a given algorithm.
    - **Missing Algorithm Check**: Lack of proper checking on key types used by different algorithms.
    - **Insecure Signature Validation**: `SAML2\HTTPRedirect::validateSignature()` did not verify the value returned by `XMLSecurityKey::verifySignature()` correctly, allowing HMAC-SHA1 to accept a public key.
    - **Lack of algorithm whitelisting**: `SAML2\Utils::castKey()` did not restrict the algorithms that could be used to create a key.
- **Impact of exploitation**:
    - **As a Service Provider (SP)**: An attacker can forge SAML assertions using the public key of an Identity Provider (IdP) as a secret HMAC key. This allows them to impersonate any user with any attributes, change subject or add/remove attributes and gain access to the SP.
    - **As an Identity Provider (IdP)**: An attacker can potentially impersonate a Service Provider (SP) to initiate a login or logout request, which has less impact but is still a security concern.
- **Attack vectors**: The primary attack vector is through the HTTP-Redirect binding where the attacker provides a crafted SAML message with a signature generated using the public key of the SAML2 entity as the secret key for the HMAC\_SHA1 algorithm.
- **Required attacker capabilities/position**:
    - The attacker needs to know the public key of the targeted Identity Provider.
    - The attacker needs the ability to send a crafted SAML message to a SimpleSAMLphp instance using the HTTP-Redirect binding.
    - No special privileges on the server are required, just network access.