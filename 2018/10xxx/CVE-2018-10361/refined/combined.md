=== Content from www.openwall.com_6768d1af_20250126_000224.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](4) [[thread-next>]](4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <200975c0f23706ce513744052225ea7dc9842206.camel@suse.com>
Date: Tue, 9 Jul 2019 13:58:37 +0000
From: Malte Kraus <malte.kraus@...e.com>
To: "oss-security@...ts.openwall.com" <oss-security@...ts.openwall.com>
Subject: Privileged File Access from Desktop Applications

With Wayland, it's no longer supported to run graphical applications as
root. The big desktop environments want to allow users to edit and
manage files through graphical applications (mostly text editors and
file managers). They have therefore implemented D-Bus services to
perform file I/O as root, authenticated through polkit.

We have reviewed various of these:
     a) a specialized D-Bus service for ktexteditor, the framework
        component powering the Kate editor
     b) gvfs-admin, which allows all gtk-enabled applications to access
        files as root
     c) the kauth helper for ioslave, which allows KDE applications to
        access files as root

As privileged file I/O is notoriously hard to get right, we found some
concrete security issues in them [1] [2], which the projects were glad
to fix. However, we believe there also some deeper design design
choices that also merit further discussion.

None of the solutions actually provided the user with the accessed path
or file operation in the polkit auth prompt. Users are confronted with
an unspecific request for privileges that they can only allow or deny
without knowing what exactly they are allowing. (This is unfortunately
a common theme, e.g. on KDE the framework is still missing support for
parameterizing polkit prompts.)

There's also a conceptual risk with the generic backends for file I/O:
unwitting applications that were written expecting to be run from an
unprivileged context can end up performing privileged file I/O
operations when supplied with such a URI/path. As a result, even when
the framework correctly implements all API guarantees for these
backends, applications are likely to be too careless with their
framework calls, resulting in situations where e.g. symlink attacks can
be performed. Of course due to the authentication requirements, user
interaction is involved in any such situation.

Another matter with gvfs-admin for example is what the desired
behaviour is when files are copied or moved between the 'normal' file
system and the virtual privileged file system - these operations are no
longer symmetric like they are traditionally: A rename(2) call is
either performed as root or not. But with a move of a file from file://
(unprivileged) to admin:// (privileged), there are two different
privilege levels involved. Since there is no equivalent to this
situation in the UNIX file system semantics, it is unclear who should
own the resulting file and what permissions it should have. Should file
ownership be preserved? Should the file be owned by root? If an
existing file is replaced, maybe the ownership and permissions of that
file should be preserved? How does a setgid bit on a directory affect
all this? What about higher-level flags in the framework like
G_FILE_COPY_ALL_METADATA and G_FILE_COPY_TARGET_DEFAULT_PERMS?

It's all quite underspecified, and we have the impression these
questions weren't fully thought through before the feature shipped.
Similar questions arise with the two KDE solutions, and some of the
bugs probably arose exactly because these questions are not answered
yet.

Best regards
Malte Kraus, Matthias Gerstner

[1] CVE-2018-10361 <https://seclists.org/oss-sec/2018/q2/65>
[2] CVE-2019-12447, CVE-2019-12448, CVE-2019-12449

--
Malte Kraus <malte.kraus@...e.com>
Security Engineer
PGP Key: 8AFC 3C58 6880 2DDD 4792  C3C2 FDBD 2984 D4C3 C2F0
SUSE Linux GmbH, GF: Felix Imendörffer, Mary Higgins, Sri Rasiah, HRB
21284 (AG Nürnberg)

Download attachment "[signature.asc](3/1)" of type "application/pgp-signature" (489 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from idp-portal.suse.com_6b95d262_20250126_125734.html ===

## UCS

# Welcome to Univention Corporate Server

## JavaScript required

A browser with JavaScript enabled is required in order to use this service.

When using Internet Explorer, please check your security settings and add this address to your trusted sites.



=== Content from www.openwall.com_0efe57cd_20250126_000223.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](../../../2018/04/23/3) [[next>]](2) [[thread-next>]](../../../2018/04/25/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20180424111109.oigpkbl5nqcxqmvw@f195.suse.de>
Date: Tue, 24 Apr 2018 13:11:09 +0200
From: Matthias Gerstner <mgerstner@...e.de>
To: oss-security@...ts.openwall.com
Subject: ktexteditor / Kate local privilege escalation

Hello list,

following is a report about a local privilege escalation I found in
ktexteditor. I just informed upstream about it and will obtain a CVE
soon.

ktexteditor (<https://api.kde.org/frameworks/ktexteditor/html/>) provides
a text editor component for KDE applications. It is, for example, used
in the "kate" text editor program.

One of ktexteditor's features is support to write files owned by root or
other users after entering the root password via polkit authentication.
The authentication part is handled via the "kauth" framework. The actual
work of saving files on behalf of the authenticated user is performed by
a small program named "kauth_ktexteditor_helper". The related code is
found in the upstream repository in the following source files:

src/buffer/katesecuretextbuffer_p.h
src/buffer/katesecuretextbuffer.cpp

The logic for saving the file goes roughly as follows:

- the caller provides source and target file paths, a sha512 digest of
  the source file content and (optionally) the target file owner and
  group IDs.
- the helper tries to open a temporary file in the directory containing
  the target file, reads chunk from the source file and writes them to
  the target file, recalculating the sha512 digest on the way.
- in the end, if the digest matches, the temporary file will be
  rename()'d for replacing the target file path with the new file
  content.

For temporary file handling the qt5 core library facilities are employed
and the following source code lines are the important ones:

```
    // We will first generate temporary filename and then use it relatively to prevent an attacker
    // to trick us to write contents to a different file by changing underlying directory.
    QTemporaryFile tempFile(targetFileName);
    if (!tempFile.open()) {
        return false;
    }
    tempFile.close();
    QString tempFileName = QFileInfo(tempFile).fileName();
    tempFile.setFileName(tempFileName);
    if (!readFile.open(QIODevice::ReadOnly) || !tempFile.open()) {
        return false;
    }
```

This code results in the following system call sequence:

```
    openat(AT_FDCWD, "/etc", O_RDWR|O_CLOEXEC|O_TMPFILE, 0600) = 11
    lseek(11, 0, SEEK_SET)      = 0
    linkat(AT_FDCWD, "/proc/self/fd/11", AT_FDCWD, "/etc/fstab.hdRIFU",
    	AT_SYMLINK_FOLLOW) = 0
    close(11) = 0
    [...]
    openat(AT_FDCWD, "fstab.hdRIFU", O_RDWR|O_CREAT|O_CLOEXEC, 0666) = 12
```

So while the code author(s) have been seemingly aware that temporary
file handling needs to be done carefully they somehow still broke it in
the end which we can see from the system calls. The initially unnamed
temporary file is linked, the associated file descriptor closed and the
now named temporary file is reopened with the `O_CREAT` flag. On file
systems that don't support O_TMPFILE the vulnerability is also existing,
the code will fall back to named files right away.

As it turns out this situation can be exploited in scenarios like the
following:

A user running "kate" wants to edit and save a file in a directory that
is owned by another unprivileged user. Such directories exist for
various software e.g. in /var/lib or in /etc. The user enters root
credentials to perform the privileged save operation.

The other unprivileged user can now perform a symlink attack on the
temporary file being opened by the "kauth_ktexteditor_helper" and
achieve various effects:

- creation of new files in arbitrary file system locations.
- corruption of arbitrary existing files (because the helper will write
  the source file content into the symlinked file).
- taking ownership of arbitrary files (because the helper will perform
  an fchown() call on the symlinked file), thereby facilitating local
  root privilege escalation.

The attached proof of concept code succeeds in gaining ownership of
/etc/shadow in the described situation. Exploiting the race condition
does not work very reliably, because the window of opportunity is very
small. Some more advanced exploit code might improve the chances.

The API of the QTemporaryFile class has some non-obvious semantics. The
close() method does not really close the underlying file descriptor. The
setFileName() function, however, does. I am not clear what the original
intentions of the code above being this way might have been. As far as I
can tell the attached patch fixes the race condition detailed in this
report without breaking anything.

The vulnerable code is already found in upstream commit
f7a9573d973e6ef0cd6f2c419290c0c7e46381b7 and therefore ktexteditor
starting from version 5.34.0 can be considered vulnerable.

Cheers

Matthias

--
Matthias Gerstner <matthias.gerstner@...e.de>
Dipl.-Wirtsch.-Inf. (FH), Security Engineer
<https://www.suse.com/security>
Telefon: +49 911 740 53 290
GPG Key ID: 0x14C405C971923553

SUSE Linux GmbH
GF: Felix Imendörffer, Jane Smithard, Graham Norton
HRB 21284 (AG Nuernberg)

View attachment "[ktexteditor_tmpfile_fix.patch](1/1)" of type "text/x-patch" (960 bytes)

View attachment "[kattack.cpp](1/2)" of type "text/x-c" (9065 bytes)

Download attachment "[signature.asc](1/3)" of type "application/pgp-signature" (820 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from bugzilla.suse.com_8dfcc8d2_20250126_000226.html ===


| Bugzilla – Bug 1033055 | AUDIT-STALE: CVE-2018-10361: ktexteditor: new DBus service | Last modified: 2022-07-11 08:59:44 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1033055)
* |
  [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

[**Bug 1033055**](show_bug.cgi?id=1033055)
(CVE-2018-10361)
- AUDIT-STALE: CVE-2018-10361: ktexteditor: new DBus service

[Summary:](page.cgi?id=glossary.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
AUDIT-STALE: CVE-2018-10361: ktexteditor: new DBus service

| | [Status](page.cgi?id=status_resolution_matrix.html): | REOPENED | | --- | --- | |  | | | [Alias:](page.cgi?id=glossary.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2018-10361 | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | SUSE Security Incidents | | [Classification:](page.cgi?id=glossary.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Novell Products | | [Component:](describecomponents.cgi?product=SUSE Security Incidents "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Audits ([show other bugs](buglist.cgi?component=Audits&product=SUSE%20Security%20Incidents&bug_status=__open__)) | | [Version:](page.cgi?id=glossary.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=glossary.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Other All | |  | | | [Priority](page.cgi?id=glossary.html#priority): | P4 - Low **Severity**: Minor | | [Target Milestone:](page.cgi?id=glossary.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | unspecified | | [Assignee:](page.cgi?id=glossary.html#assigned_to "The person in charge of resolving the bug.") | Luca Beltrame | | [QA Contact:](page.cgi?id=glossary.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") | Security Team bot | |  | | | [URL:](page.cgi?id=glossary.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=glossary.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") | CVSSv2:NVD:CVE-2018-10361:7.2:(AV:L/... | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=glossary.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1147035](show_bug.cgi?id=1147035 "NEW - AUDIT-FIND: ktexteditor: add the path name to be written to, to the polkit authentication message") [1147038](show_bug.cgi?id=1147038 "NEW - AUDIT-FIND: ktexteditor: defined and safe selection of target file mode and ownership") [1147041](show_bug.cgi?id=1147041 "NEW - AUDIT-FIND: ktexteditor: reject anything except regular files") [1147043](show_bug.cgi?id=1147043 "NEW - AUDIT-FIND: ktexteditor: safely handle target directories not owned by root") [1147045](show_bug.cgi?id=1147045 "NEW - AUDIT-FIND: ktexteditor: introduce a file system restriction") | | [Blocks:](page.cgi?id=glossary.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | Show dependency [tree](showdependencytree.cgi?id=1033055&hide_resolved=1) / [graph](showdependencygraph.cgi?id=1033055) | |  | | Reported: | 2017-04-08 09:02 UTC by Luca Beltrame | | --- | --- | | Modified: | 2022-07-11 08:59 UTC ([History](show_activity.cgi?id=1033055)) | | CC List: | 12 users (show)  andrius-suse fabian forgotten\_sM9JzehKpy fvogt geisserml KOT040188 marius.kittler mati865 matthias.gerstner meissner mustafa1024m nate | |  | | | [See Also:](page.cgi?id=glossary.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Found By:](page.cgi?id=glossary.html#cf_foundby "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Services Priority:](page.cgi?id=glossary.html#cf_nts_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Business Priority:](page.cgi?id=glossary.html#cf_biz_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Blocker:](page.cgi?id=glossary.html#cf_blocker "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Marketing QA Status:](page.cgi?id=glossary.html#cf_marketing_qa_status "A custom Drop Down field in this installation of Bugzilla.") | --- | | [IT Deployment:](page.cgi?id=glossary.html#cf_it_deployment "A custom Drop Down field in this installation of Bugzilla.") | --- | |  | |  * [Clone This Bug](enter_bug.cgi?cloned_bug_id=1033055) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [Add an attachment](attachment.cgi?bugid=1033055&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=1033055&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1033055#c0)  Luca Beltrame   2017-04-08 09:02:24 UTC  ``` ktexteditor, part of the new KDE Frameworks 5.33 (to be submitted soon to Tumbleweed) provides a new DBus service and policy to allow prompting the user to provide authorization and elevate their privileges (if authorization is successful) to write to files that are not writable from root.  Package: [https://build.opensuse.org/package/show/KDE:Unstable:Frameworks/ktexteditor](https://build.opensuse.org/package/show/KDE%3AUnstable%3AFrameworks/ktexteditor)  This package uses the KAuth framework. For a discussion on a similar package that has been reviewed, see <http://bugzilla.suse.com/show_bug.cgi?id=1019748>  rpmlint data on the files:  unauthorized-service /usr/share/dbus-1/system-services/org.kde.ktexteditor.katetextbuffer.service ktexteditor.x86_64: W: suse-dbus-unauthorized-service /etc/dbus-1/system.d/org.kde.ktexteditor.katetextbuffer.conf The package installs a DBUS system service file. If the package is intended for inclusion in any SUSE product please open a bug report to request review of the service by the security team.  ktexteditor.x86_64: I: polkit-untracked-privilege org.kde.ktexteditor.katetextbuffer.savefile (??:no:auth_admin_keep) The privilege is not listed in /etc/polkit-default-privs.* which makes it harder for admins to find. If the package is intended for inclusion in any SUSE product please open a bug report to request review of the package by the security team  ktexteditor.x86_64: I: polkit-cant-acquire-privilege org.kde.ktexteditor.katetextbuffer.savefile (??:no:auth_admin_keep) Usability can be improved by allowing users to acquire privileges via authentication. Use e.g. 'auth_admin' instead of 'no' and make sure to define 'allow_any'. This is an issue only if the privilege is not listed in /etc /polkit-default-privs.* ``` [Comment 1](show_bug.cgi?id=1033055#c1)  Andreas Stieger   2017-04-10 07:13:31 UTC  ``` <https://cgit.kde.org/ktexteditor.git/> git://anongit.kde.org/ktexteditor.git  <https://github.com/KDE/ktexteditor> <https://github.com/KDE/ktexteditor/releases/tag/v5.33.0> ``` [Comment 2](show_bug.cgi?id=1033055#c2)  Sebastian Krahmer   2017-04-10 13:51:27 UTC  ``` This is an abuse of the privileged DBUS functionality.  Privileged DBUS+polkit was made to offer semi-administration tasks like setting system time or TZ to GUI users who are in possession of their own system. It was not made to emulate "sudo mv" command for text editors.  To maintain a sane and healthy state of or DBUS services, this feature wont be white listed and thus the package cant be integrated.  The KDE project should offer ktexteditor build-flags that allow for disabling such insane functionality.  -> WONTFIX ``` [Comment 3](show_bug.cgi?id=1033055#c3)  Luca Beltrame   2017-04-10 13:54:26 UTC  ``` Thanks for the comment: rather than preventing the integration, we'll disable that functionality so that it won't be used in the openSUSE packages. ``` [Comment 4](show_bug.cgi?id=1033055#c4)  Mustafa Muhammad   2017-07-01 18:07:06 UTC  ``` I think this was implemented so that users can edit system files in wayland sessions (where you can't run GUI apps as root), this is probably the most sane way (without using the terminal). I saw from discussions on Fedora bugzilla that on wayland you can't start GUI apps as root, so you open them as normal apps and when trying something that needs permission, it pops up an authentication dialog, the case was about gparted. ``` [Comment 5](show_bug.cgi?id=1033055#c5)  Andrius Štikonas   2017-11-06 18:31:10 UTC  ``` Can we please have some proper arguments?  If you claim that it is not to emulate "sudo mv" than please provide sources. Then we can properly discuss and find the best solutions. Otherwise, how are we supposed to respond to "abuse, insane, wontfix".  In my oppinion a good place to start for discussion is  <https://www.freedesktop.org/software/polkit/docs/latest/polkit-apps.html>  Here they list DO's and DON'T with polkit. Last 3 of those DON'Ts are not relevant to this discussion. The first DON'T mostly talks about developer tools and command line applications. Clearly not relevant again. Finally, they say don't use polkit when there is no reason to decline the action. Again, that's not the case here.  So I don't see any reason how this is abuse of polkit. At least polkit developers don't seem to consider this abuse.  On the other hand running X applications as root is extremely insecure and attack surface is much larger. Huge codebases such as Qt or GTK, XCB/Xlib, xkbcommon run as root and almost surely there will be some root exploit. ``` [Comment 6](show_bug.cgi?id=1033055#c6)  Fabian Vogt   2017-12-02 11:00:25 UTC  ``` Reopening this bug to hopefully get a proper answer. ``` [Comment 7](show_bug.cgi?id=1033055#c7)  Matthias Gerstner   2018-03-14 16:09:07 UTC  ``` krahmer is no longer around to discuss this.  I apologize for some of the cross language he used in [comment 2](show_bug.cgi?id=1033055#c2). He just was really enraged with the sheer tought of this approach.  I think the main issue here is that such an interface is not tailored towards a specific functionality of the program (which is the usual use case of polkit), but opens a really large door to write files anywhere.  Any weakness in the implementation of the service or the involved frameworks would wreak havoc, security wise.  For example, Sebastian found a general root exploit in the kauth framework:      <http://www.openwall.com/lists/oss-security/2017/05/10/3>  Kauth is also used by ktexteditor, according to [comment 0](show_bug.cgi?id=1033055#c0). Therefore, would we have whitelisted this D-Bus service and associated polkit actions by then, there would have been a severe security issue in related openSUSE installations. Not even "auth_admin" restriction would have helped to prevent this.  So this shows that these are not just theoretical concerns.  Please accept security team's decision not to whitelist this particular service. Closing this bug again as WONTFIX. ``` [Comment 8](show_bug.cgi?id=1033055#c8)  Fabian Vogt   2018-03-14 16:18:13 UTC  ``` (In reply to Matthias Gerstner from [comment #7](show_bug.cgi?id=1033055#c7)) > krahmer is no longer around to discuss this. >  > I apologize for some of the cross language he used in [comment 2](show_bug.cgi?id=1033055#c2). He just was > really enraged with the sheer tought of this approach. >  > I think the main issue here is that such an interface is not tailored towards > a specific functionality of the program (which is the usual use case of > polkit), but opens a really large door to write files anywhere. >  > Any weakness in the implementation of the service or the involved frameworks > would wreak havoc, security wise.  Of course. Break sudo and you get root. Is that a reason not to enable sudo?  > For example, Sebastian found a general root exploit in the kauth framework: >  >     <http://www.openwall.com/lists/oss-security/2017/05/10/3> >  > Kauth is also used by ktexteditor, according to [comment 0](show_bug.cgi?id=1033055#c0). Therefore, would > we > have whitelisted this D-Bus service and associated polkit actions by then, > there would have been a severe security issue in related openSUSE > installations. Not even "auth_admin" restriction would have helped to prevent > this.  That was already the case and got fixed, which means this is not relevant anymore.  > So this shows that these are not just theoretical concerns.  Obviously not. kauth is an abstraction over polkit, which basically means that any bug in kauth is equal to a bug in polkit. Any bug in polkit would also have the same issue and consequences. Why is polkit enabled in openSUSE then, if any bug would cause security issues?  With NetworkManager, you can currently read arbitrary files as any user, by specifying a file as secret Why is that not fixed yet? Please answer that before you play the "we only whitelist known secure services" card.  > Please accept security team's decision not to whitelist this particular > service.  Sorry, no.  All we ask for is functionality equivalent to "sudo install" over polkit. You can already do that with sudo, so why not with polkit? ``` [Comment 9](show_bug.cgi?id=1033055#c9)  Fabian Vogt   2018-03-14 16:20:55 UTC  ``` (In reply to Fabian Vogt from [comment #8](show_bug.cgi?id=1033055#c8)) > With NetworkManager, you can currently read arbitrary files as any user, by > specifying a file as secret  Sorry, I forgot to add the reference here. It's [bug 738073](show_bug.cgi?id=738073 "NEW - VUL-2: CVE-2012-1096: NetworkManager: Arbitrary file access/information leak"). ``` [Comment 10](show_bug.cgi?id=1033055#c10)  Matthias Gerstner   2018-03-14 16:48:50 UTC  ``` (In reply to fvogt@suse.com from [comment #8](show_bug.cgi?id=1033055#c8)) > That was already the case and got fixed, which means this is not relevant > anymore.  For us it is relevant, because it shows the sensibility of the involved software. And if we would not have looked into it, we would not even know.  > Obviously not. kauth is an abstraction over polkit, which basically means that > any bug in kauth is equal to a bug in polkit. Any bug in polkit would also have > the same issue and consequences.  I don't think so. When kauth is used for a more specialized polkit action like activating power saving features of the CPU then the outcome is less severe than when you can write arbitrary files.  > Why is polkit enabled in openSUSE then, if any bug would cause security > issues?  We are not only concerned with the frameworks themselves, but with the actions they allow. And this is what this bug is about: allowing unusually broad actions in a complex software stack.  > With NetworkManager, you can currently read arbitrary files as any user, by > specifying a file as secret > Why is that not fixed yet? Please answer that before you play the "we only > whitelist known secure services" card.  I know about this issue and as it happens I just recently opened a bug upstream for it. We are very unhappy about the situation but as upstream pointed out they don't have a quick solution for it. If you have a good idea and can help out with the situation we would be happy.  The package is already in openSUSE and in widespread use. So we don't want to ruin everybody's time by removing it. It just shows how difficult security decisions are sometimes. Now imagine something similar would happen to ktexteditor.  > All we ask for is functionality equivalent to "sudo install" over polkit. > You can already do that with sudo, so why not with polkit?  Because with sudo, you don't need to make sure that the "install" program is also securely implemented. You just have to look at sudo. With polkit it's different. Otherwise we wouldn't be having these polkit rule audits at all. ``` [Comment 11](show_bug.cgi?id=1033055#c11)  Matthias Gerstner   2018-03-16 14:39:52 UTC  ``` I talked to Fabian about this and we agreed on the following:  - I will review the ktexteditor interface carefully. As of high workload this   will take a while. - If all looks good we will whitelist this polkit action with auth_admin (not   with keep) ``` [Comment 12](show_bug.cgi?id=1033055#c12)  Luca Beltrame   2018-03-16 14:51:43 UTC  ``` Thanks a lot. Currently the feature is hard-disabled in our packages, so even if the review takes time, it won't be a major problem. ``` [Comment 13](show_bug.cgi?id=1033055#c13)  Matthias Gerstner   2018-04-24 11:44:58 UTC  ``` Hey guys,  so I now took the time to look into the katetextbuffer service (actually a helper called 'kauth_ktexteditor_helper'). Brace yourselves: This is gonna be a pretty long one ;-).  The KDE approach to polkit does not make it too easy to work with it: The D-Bus interface cannot be enumerated (no introspection possible) and the data structures moved around are serialized Qt datatypes in this case. Still I managed somehow to play around with it.  For better understanding here comes a quick explanation of how the interface works:  - The katetextbuffer service only provides a single D-Bus method   savefile(sourceFile, targetFile, checksum, ownerId, groupId). - The client (in this case the 'kate' editor) triggers the D-Bus method   whenever opening a target file for writing fails, to retry with elevated   privileges. It writes the current editor content into a temporary file and   also calculates a sha512 digest of the content. If the target file already   exists and is stat()'able by 'kate' then it also specifies the new target   file owner and group ID. - The kauth_ktexteditor_helper will be triggered and first of all it will ask   for administrator authentication (according to polkit configuration). Then   the actual operation happens: It copies the source file provided by 'kate'   into a temporary file in the target directory and recalculates the sha512   digest sum. If the sum matches then this now root owned temporary file will be   rename()'d to overwrite the actual target file. New file owner and group will   also be applied.  Let's start with what works well with this approach:  - It uses the kauth framework and - considering there are no other security   issues like Sebastian found back then - the administrator authentication   should work out well. Thus only somebody who knows the root password can   trigger the logic at all. - The introduction of the sha512 digest makes sure that the temporary   sourceFile provided by "kate" really contains the same data that "kate" had   in mind when it triggered and authenticated the D-Bus call.  Now for the things that don't work so well:  - The code currently contains a local privilege escalation in some   circumstances. I will publish more information and a PoC about this shortly. - The polkit authentication message always is just "Root privileges are needed   to save this document". I think this is bad from usability and security   perspective. As is documented in       <https://www.freedesktop.org/software/polkit/docs/0.105/eggdbus-interface-org.freedesktop.PolicyKit1.Authority.html#eggdbus-method-org.freedesktop.PolicyKit1.Authority.CheckAuthorization>   placeholders can be used in the authentication messages like   "$(target_file)". This would allow for a message like "Root privileges are   needed to write to $(target_file)". Then the user has more knowledge   about what is about to happen. I don't know if this is possible from within   the kauth infrastructure, but I sure hope so. - I don't think the savefile() interface is well specified yet. Why can the   client code choose the target file owner and group? The service code can   determine the to-be-replaced file's owner and group just as well and   this probably involves less race conditions than when the client does.    On the other hand, if a new file is created by way of savefile(), then the   supplied owner and group ID are ignored, and the file is always owned by   root:root and world readable (mode 0644). So what if an executable file   should be created? What if a user wants to create a secret file   that should not be readable by anyone? This is not possible and the user   may not even realise this.    Similarly extended attributes or ACLs of target files will be discarded   (quite exotic, but still should be thought about). - The client side code also triggers the savefile() API when the file to be   written is owned by the user itself but read-only. This is an unnecessary   authentication and an unnecessary privilege escalation. - The service code does not perform any checks on source or target file types.   For example I can overwrite a device file like /dev/ttyS0. Kate will only   warn that the target file exists. Afterwards I no longer have a serial   device but some text file in /dev/ttyS0 containing my text buffer. A user   error here could lead to a broken system (of course this can also happen   with other root owned files like /etc/passwd and alike).    Even worse for source files: The service can be asked to copy data from   /dev/zero or some FIFO device causing DoS and high file system usage. This   does not work from within kate but the D-Bus interface supports it   basically. - The service does always perform a chdir() to the target file directory to   operate from within the target directory only. The CWD is never reset in the   code. Although the service does not run for long (it shuts down after a   couple of seconds idle time), the state of the service is permanently   changed for the course of its lifetime. This is even more interesting,   because: - The service performs no path normalization on source and target file paths.   Only the client side code does this at the moment. This allows to pass   symlinks, relative paths and paths with relative path components. They will   always be happily handled by the service. The relative paths will then also   be evaluated according to the current CWD of the service. - The service does not check the target file system type. This way it can   operate on pseudo file systems or network file systems, which might not be a   good idea.  I recommend the following improvements in the logic of kauth_ktexteditor_helper:  - add the path name to be written to, to the polkit authentication message. - either the client specifies the complete target file mode, or the service   doesn't allow creation of new files but only overwriting of existing ones.   In the latter case reapplying the existing mode/owner/group in a safe   way. - avoid triggering the savefile() API for files that are owned by the user but   read only. - check source and target file types and reject anything except regular files.   symlinks should not be followed or replaced. - chdir back to "/" after the work is done. - reject relative paths. - if the target path directory is not owned by root then eiter reject it, or   drop privileges temporarily to the owner of the directory. - implement at least a supported target file system blacklist, or even better   a whitelist.  For whitelisting this service I would at least like to see the improved authentication message, avoiding the privilege escalation for read-only files and the bugfix for the local root vulnerability I am about to publish.  Overall I don't have a very good feeling about this feature. Operating in the file system on behalf of another user as root is a very difficult task to get right. The file system situation is ever getting more complicated and these days we can also have things like the overlayfs or namespaces. Of course, a best effort approach to improve usability is justified.  The usability needs to be delivered, though. And I think a couple of the points I raised above show that the current service implementation does not support the user very much in avoiding bad things or making transparent what is happening.  Even though it sounds like a lot of work I think when somebody gives the code some love it is not too much effort. What do you think about it? ``` [Comment 14](show_bug.cgi?id=1033055#c14)  Matthias Gerstner   2018-04-24 11:48:07 UTC  ``` Here is the oss-sec posting I just made about a possible local privilege escalation in ktexteditor:  <http://seclists.org/oss-sec/2018/q2/65>  Basically there is an opportunity to gain root privileges if a user writes via Kate into a directory owned by another unprivileged user. I already contacted upstream and sent them the patch. ``` [Comment 15](show_bug.cgi?id=1033055#c15)  Luca Beltrame   2018-04-24 12:08:23 UTC  ``` Wow, thanks a bunch for the analysis! I will still need to digest it fully, but I agree that we should push upstream for some of these changes (including the fix for the local privilege escalation, of course).  I'll start poking people upstream about the whole matter. ``` [Comment 16](show_bug.cgi?id=1033055#c16)  Marcus Meissner   2018-04-26 12:34:56 UTC  ``` CVE-2018-10361 I think ``` [Comment 17](show_bug.cgi?id=1033055#c17)  Matthias Gerstner   2018-05-03 09:22:06 UTC  ``` Upstream discussion about the CVE is currently happening in <https://phabricator.kde.org/D12513#257628>. ``` [Comment 18](show_bug.cgi?id=1033055#c18)  Matthias Gerstner   2018-06-04 13:19:00 UTC  ``` Hi Luca,  I am assigning back this bug to you since there is at the moment nothing left to do from my side. As I understand upstream is implementing a privilege drop now in case the target file is not owned by root. This is better. But there is still some disagreement on details. I have the feeling someone is missing here who has the skill and is willing to invest the effort to make this code more robust and trustworthy.  As I pointed out it [comment 13](show_bug.cgi?id=1033055#c13) there isn't too much missing to make a whitelisting feasible. Please reassign the bug to me once there is some progress and a new version available.  Thank you. ``` [Comment 19](show_bug.cgi?id=1033055#c19)  Luca Beltrame   2018-06-04 13:51:40 UTC  ``` Hello Matthias,  although you didn't see much activity in the actual revision, someone is actually taking (baby) steps in also fixing some of the issues you have pointed out lower in the stack.  So yes, it's going slowly, but there is progress.   Also, aside from the issues you already raised: would "auth_admin" instead of "auth_admin_keep" still require a review?   I'm asking due to <https://bugzilla.opensuse.org/show_bug.cgi?id=1073214>, which handled a similar case in gvfs. Sorry to add you to CC again after the assignment change, but I'd like to have your input on this. ``` [Comment 20](show_bug.cgi?id=1033055#c20)  Matthias Gerstner   2018-06-04 16:38:06 UTC  ``` (In reply to lbeltrame@kde.org from [comment #19](show_bug.cgi?id=1033055#c19)) > although you didn't see much activity in the actual revision, someone is > actually taking (baby) steps in also fixing some of the issues you have > pointed out lower in the stack.  That is good to hear!  > Also, aside from the issues you already raised: would "auth_admin" instead > of "auth_admin_keep" still require a review?  >  > I'm asking due to <https://bugzilla.opensuse.org/show_bug.cgi?id=1073214>, > which handled a similar case in gvfs. Sorry to add you to CC again after the > assignment change, but I'd like to have your input on this.  Unfortunately no, this wouldn't change much in the context of ktexteditor. Even if the admin password is always required, the basic problem remains the same, namely that the implementation of the file save operation is not robust.  The caching of the authentication is another topic. Even if a file is only saved once, there is a time window within with arbitrary files can be written as root without further authentication. Of course this requires an already compromised system and other tools like sudo allow the same. So I'm not going to argue. ``` [Comment 21](show_bug.cgi?id=1033055#c21)  Forgotten User \_1rt-k-Q-9   2018-06-07 22:45:02 UTC  ``` Fix landed in upstream: [https://phabricator.kde.org/R39:c81af5aa1d4f6e0f8c44b2e85ca007ba2a1e4590](https://phabricator.kde.org/R39%3Ac81af5aa1d4f6e0f8c44b2e85ca007ba2a1e4590) ``` [Comment 22](show_bug.cgi?id=1033055#c22)  Matthias Gerstner   2019-02-05 11:38:07 UTC  ``` What is the current state of ktexteditor in Factory regarding this D-Bus API? Is there anything left to do in this bug or can we otherwise close it?  In [bug 1062040](show_bug.cgi?id=1062040 "REOPENED - AUDIT-STALE: kio: general purpose file system helper using D-Bus and Polkit") we have some recent activity. I have been asked to review new code in kauth/kio that deals with a much broader "let's do file system stuff as root via D-Bus" API. The current state of affairs regarding this implementation is still not good. Still racy system calls are used and symlinks aren't protected against.  I'm not sure whether a generalized file system service is a good idea. The security of file system operations often depends on the application context. So while having a single place to implement file system operations is basically a good idea, there might be some information missing in such a central service. In any case the D-Bus interface would need to be very well thought out which also isn't currently the case (e.g. mkdir implicitly applies mode 0777 minus the umask of the D-Bus service). When thinking about polkit then I'd rather like to see specialized polkit actions for file system operations like we have here in this bug for ktexteditor. The generalized kauth/kio approach will probably lead to general polkit actions (unless there isn't special care taken of). When general polkit actions are used then it will end up with something like "renaming files for locally logged in users is always allowed" independently of the application context. ``` [Comment 23](show_bug.cgi?id=1033055#c23)  Luca Beltrame   2019-02-05 11:49:24 UTC  ``` The CVE was fixed, but currently it is still disabled. I'd rather enable it, barring any objections, of course, to prevent carrying a patch until the heat death of the universe. ``` [Comment 24](show_bug.cgi?id=1033055#c24)  Fabian Vogt   2019-02-05 14:19:01 UTC  ``` > I'm not sure whether a generalized file system service is a good idea. The security of file system operations often depends on the application context. So while having a single place to implement file system operations is basically a good idea, there might be some information missing in such a central service. In any case the D-Bus interface would need to be very well thought out which also isn't currently the case (e.g. mkdir implicitly applies mode 0777 minus the umask of the D-Bus service). When thinking about polkit then I'd rather like to see specialized polkit actions for file system operations like we have here in this bug for ktexteditor. The generalized kauth/kio approach will probably lead to general polkit actions (unless there isn't special care taken of). When general polkit actions are used then it will end up with something like "renaming files for locally logged in users is always allowed" independently of the application context.  Apparently this is fine for the GFVS admin:// backend though, which does the same and was whitelisted a while ago. ``` [Comment 25](show_bug.cgi?id=1033055#c25)  Matthias Gerstner   2019-02-07 12:09:49 UTC  ``` (In reply to lbeltrame@kde.org from [comment #23](show_bug.cgi?id=1033055#c23)) > The CVE was fixed, but currently it is still disabled. I'd rather enable it, > barring any objections, of course, to prevent carrying a patch until the heat > death of the universe.  I have looked into the current implementation and some of my recommendations from [comment 13](show_bug.cgi?id=1033055#c13) still seem to be missing. I will do a few tests during runtime. Maybe I can offer some patches to upstream to improve things. Then we can whitelist this action. ``` [Comment 26](show_bug.cgi?id=1033055#c26)  Matthias Gerstner   2019-02-14 14:08:51 UTC  ``` So I invested quite some effort over the last days to come up with improvements to the current ktexteditor code. This all turns out to be more difficult than expected. The involved Qt APIs are insufficient for security oriented programming that is required in this case. The documentation is often also lacking so a lot of digging and guessing has to be done. Also some of the involved KDE frameworks don't offer the full spectrum of features required e.g. from polkit. To top it off I find the workflow of the KDE upstream Phabricator instance difficult to digest, but there's a chance I'm just too stupid for it.  So let's again take a look at the things that need to be done here:  1) add the path name to be written to, to the polkit authentication message. 2) either the client specifies the complete target file mode, or the service   doesn't allow creation of new files but only overwriting of existing ones.   In the latter case reapplying the existing mode/owner/group in a safe   way. 3) avoid triggering the savefile() API for files that are owned by the user but   read only i.e. don't escalate privileges when there's no reason to. 4) check source and target file types and reject anything except regular files.   symlinks should not be followed or replaced. No relative paths should be   accepted. All of this needs to be verified on the service side. 5) chdir back to "/" after the work is done. 6) if the target path directory is not owned by root then eiter reject it, or   drop privileges temporarily to the owner of the directory. 7) implement at least a supported target file system blacklist, or even better   a whitelist.  This is the current status and my assessment of these items:  1) The stack of KDE framework components that is involved with polkit and   kauth doesn't support specification of the so called "polkit details" that   are necessary to provide runtime generated information for authentication   messages:     - In kauth the ActionData class has a `setDetails(const QString&)`       function, but the details member is then never used for anything. Also a       string is not the right data type here, a map is required.     - Kauth uses the library polkit-qt-1, a KDE C++ wrapper around the C based       polkit library. This wrapper does not support specification of the       details. This is where I started with a first change that is now in       review in the upstream KDE phabricator [1]     - For full support of polkit details, the Kauth helper binary interface       will need to be extended, because the polkit details must only be passed       from the trusted root owned service, never directly by an unprivileged       client to prevent authentication message spoofing.    Making these changes will be quite some benefit for the usability of KDE   polkit based applications, but it will be quite some effort to pull this   through. Help is welcome.  2) After thinking a while about this I've come to the following conclusions:      - these file system operations as root are only ever safe when they       require root authentication. So the parameters passed from the client       can be considered kind of trusted. The service can't determine in a       generic way anyways whether an operation is safe or not.      - Since the service doesn't know the context, the client application needs       to determine the correct file metadata. It turns out that even on the       client side, for the case of a text editor, this cannot be generically       determined in a safe way. Therefore the *human user* has to be asked for       the correct settings.        For example currently the D-Bus service creates new files always as       root:root mode 0644, i.e. world-readable. This can result in an       information leak. A good example would be creation of a new WiFi       configuration in /etc/wpa_supplicant which is a world-readable directory       containing private files that may contain WiFi credentials.        A user creating such a file might not be aware at all about the resulting       file permissions. Therefore the client side needs to ask the user for the       permissions to use. Implementing such a dialog is beyond what I can       provide with the resources I have, so somebody needs to help.  3) I started working on this item by first refactoring the existing savefile()   function [2] and then adding some logic that causes the privilege escalation   only to happen when there actually is a permissions problem (EPERM) and the   target file cannot be removed (read-only file owned by the user himself).   The second part is not yet in review, because I'm not sure how to add a   stack of patches to Phabricator.  4) Shouldn't be too hard to achieve on the service side. First I want the   other changes to come through, however.  5) This was seemingly already fixed by way of fixing the CVE-2018-10361. No   more chdir() happens at all.  6) This requires well thought out code. Rejecting it would be the safest and   simplest way. I will have a look once the other stuff is through.  7) A whitelist for file systems is difficult to maintain when new ones are   coming up etc. But at least a blacklist for e.g. PROCFS and SYSFS should be   put into place.  [1]: <https://phabricator.kde.org/D18845> [2]: <https://phabricator.kde.org/D19001> ``` [Comment 27](show_bug.cgi?id=1033055#c27)  Luca Beltrame   2019-02-14 14:25:23 UTC  ``` Many thanks for the thorough investigation. I have created a developer task upstream (<https://phabricator.kde.org/T10480>) to make more people aware upstream (and who could possibly bring help). ``` [Comment 28](show_bug.cgi?id=1033055#c28)  Matthias Gerstner   2019-03-29 10:02:46 UTC  ``` By now the first round of changes I submitted have been accepted. Item 3) is fixed. For 1) I've extended the libpolkit-qt1 API. Next step will be to improve the daemon implementation (items 2), 4) - 7)).  For item 1) the kauth framework needs to be extended which will be not that easy. I'm willing to accept ktexteditor without 1) being in place but the other stuff is required. We will also need to get the upstream changes into our OBS packages (at least as patches when there are no upstream releases available).  Security team currently has a high load so it'll be a bit before I can continue working on this. ``` [Comment 29](show_bug.cgi?id=1033055#c29)  Luca Beltrame   2019-03-29 11:14:30 UTC  ``` Thanks a lot for the report. Once the time comes, we will make sure to put whatever is needed in our packages (unless there will be already an upstream version with the needed changes). ``` [Comment 30](show_bug.cgi?id=1033055#c30)  Fabian Vogt   2019-08-21 14:03:27 UTC  ``` (In reply to Luca Beltrame from [comment #29](show_bug.cgi?id=1033055#c29)) > Thanks a lot for the report. Once the time comes, we will make sure to put > whatever is needed in our packages (unless there will be already an upstream > version with the needed changes).  I think everything is in Tumbleweed meanwhile, auth_admin_keep got replaced with just auth_admin. So please have another look and whitelist if ok. ``` [Comment 31](show_bug.cgi?id=1033055#c31)  Matthias Gerstner   2019-08-22 11:46:49 UTC  ``` (In reply to fvogt@suse.com from [comment #30](show_bug.cgi?id=1033055#c30)) > I think everything is in Tumbleweed meanwhile, auth_admin_keep got replaced > with just auth_admin. So please have another look and whitelist if ok.  I just looked into the upstream repo and regarding the text buffer client and service side implementation nothing changed since February / a year ago. A bit more supposedly happened regarding 1) support for displaying formatted polkit messages in the framework components but it isn't used yet by ktexteditor. I wanted to address 2) but didn't find the time yet and the case is complicated wrt backwards compatibility. 6) and 7) are most probably also still not addressed. ``` [Comment 32](show_bug.cgi?id=1033055#c32)  Matthias Gerstner   2019-08-23 09:29:40 UTC  ``` I'm changing this bug to a tracker bug and will split off separate bugs for the things that still need to be done according to our new audit bug lifecycle model [1]. This should make it more clear what's still left to do and what not.  [1]: [https://en.opensuse.org/openSUSE:Package_security_guidelines#Audit_Bug_Lifecycle](https://en.opensuse.org/openSUSE%3APackage_security_guidelines#Audit_Bug_Lifecycle) ``` [Comment 33](show_bug.cgi?id=1033055#c33)  Вадим Котов   2021-02-14 17:37:00 UTC  ``` If kate had a bad implementation of saving files with elevated privileges and asking for a password, then you need to offer your own implementation. But why just remove the already working and convenient functionality ?????? This is terrible and despicable. ``` [Comment 34](show_bug.cgi?id=1033055#c34)  Andrius Štikonas   2021-02-14 17:47:56 UTC  ``` (In reply to Вадим Котов from [comment #33](show_bug.cgi?id=1033055#c33)) > If kate had a bad implementation of saving files with elevated privileges > and asking for a password, then you need to offer your own implementation. > But why just remove the already working and convenient functionality ?????? > This is terrible and despicable.  I would avoid using such strong language in the bugs. Nobody is obliged to offer anything, most people work on FOSS as volunteers. But each distribution is free to have their own policies. And if you don't like that you can always either pick distro that does things your way. ``` [Comment 35](show_bug.cgi?id=1033055#c35)  Ma Ge   2022-06-30 10:22:49 UTC  ``` I find the decision to disable PolKit for Kate in openSUSE quite confusing, and am not aware of a single other distribution that would do the same. Has the security situation of Kate+PolicyKit changed since this was last reviewed?  I'd like to echo what Andrius Štikonas has mentioned: > On the other hand running X applications as root is extremely insecure and attack surface is much larger. Huge codebases such as Qt or GTK, XCB/Xlib, xkbcommon run as root and almost surely there will be some root exploit.  I concur, that's precisely why KDE developers have done the work to make their apps in question use PolicyKit. Integrating KIO with PolicyKit seems to be close to finished, too. Nit-picking minor security details of PolicyKit seems awkward compared to the risks imposed by running a GUI app as root, which is ultimately what users will be doing if you disable an app's PolicyKit integration. ``` [Comment 36](show_bug.cgi?id=1033055#c36)  Matthias Gerstner   2022-07-05 08:23:35 UTC  ``` (In reply to geisserml@gmail.com from [comment #35](show_bug.cgi?id=1033055#c35)) > I find the decision to disable PolKit for Kate in openSUSE quite confusing, > and am not aware of a single other distribution that would do the same.  I can understand the confusion on the end user side. I suspect indeed that SUSE is the only distribution that does not enable that. Probably because it is also the only distribution that performs reviews and enforces restrictions of sensitive interfaces of this kind.  > Has the security situation of Kate+PolicyKit changed since this was last > reviewed?  I am not aware of that. The bugs this bug depends on have not been updated with new information. And these bugs represent what we would like to see improved.  Polkit (not PolicyKit, it was called that a decade ago) is not really to blame here (although it has its limitations).  > I'd like to echo what Andrius Štikonas has mentioned: > > On the other hand running X applications as root is extremely insecure and attack surface is much larger. Huge codebases such as Qt or GTK, XCB/Xlib, xkbcommon run as root and almost surely there will be some root exploit.  I agree with that. An experienced user hopefully will not take that approach but use command line editing instead. Other users might take the running GUI as root route though.  None in our team is against using Polkit and it is generally a better approach, but we would like to see it carefully implemented.  > I concur, that's precisely why KDE developers have done the work to make > their apps in question use PolicyKit.  Yes it's a good thing, only that the remaining issues are not addressed.  > Integrating KIO with PolicyKit seems to be close to finished, too.  I don't know about the progress, I have been involved in reviewing this change request over time but the overarching questions about that even larger and more generic interface in KIO are still unanswered. Authenticating and executing elementary file system operations via a D-Bus service is not really what D-Bus and Polkit have been designed for. Due to the missing context about what the purpose of the file system operations are it is easy to mess things up. Even worse than this more specific ktexteditor feature. And due to its generic nature this simplified "lets do things as root" interface is likely to spread in KDE applications to a degree that becomes hard to control.  > Nit-picking minor security details of PolicyKit seems awkward compared to > the risks imposed by running a GUI app as root, which is ultimately what > users will be doing if you disable an app's PolicyKit integration.  I personally don't see all of them as minor, especially the lacking transparency in the authentication message is a pretty major lack in the user interface.  The ideal solution would be that the remaining issues get addressed but I don't know what we can do to get that to happen, except doing it ourselves, which I even did in parts, some years ago, but my resources are limited, too. ``` [Comment 37](show_bug.cgi?id=1033055#c37)  Ma Ge   2022-07-05 09:08:37 UTC  ``` > I personally don't see all of them as minor, especially the lacking > transparency in the authentication message is a pretty major lack in the user > interface.  Thanks for the reply. Re-reading the thread more carefully, noticing that a lot of time has been invested in this review and that two security vulnerabilities were found, I think I can now better understand the decision and agree that it's not just about details.  > And due to its generic nature this simplified "lets do things as root"  > interface is likely to spread in KDE applications to a degree that becomes > hard to control.  What are you planning to do in case this happens?  > I agree with that. An experienced user hopefully will not take that approach > but use command line editing instead. Other users might take the running > GUI as root route though.  As far as I'm aware, opensuse currently offers a desktop file to run dolphin as root, and the YaST GUI appears to be root-only, too. It looks like this insecure practise is downright suggested to the user? ``` [Comment 38](show_bug.cgi?id=1033055#c38)  Matthias Gerstner   2022-07-07 09:51:11 UTC  ``` (In reply to geisserml@gmail.com from [comment #37](show_bug.cgi?id=1033055#c37)) > > And due to its generic nature this simplified "lets do things as root"  > > interface is likely to spread in KDE applications to a degree that becomes > > hard to control. >  > What are you planning to do in case this happens?  There is only so much we can do. If all of KDE will be doing things as root on steroids and all other distros accept that then we'll probably be obliged to live with that.  > As far as I'm aware, opensuse currently offers a desktop file to run dolphin > as root, and the YaST GUI appears to be root-only, too. It looks like this > insecure practise is downright suggested to the user?  There are probably a ton of these cases you can find. For a plethora of reasons, some historical, some where user needs are more important than best practices and so on.  Therefore I can understand that sometimes our security policies may look arbitrary from the outside, because not every package and every line of code is under review and not every review is done by the same people and under the same circumstances.  Still I believe in this instance about ktexteditor it would be well possible to reach a good solution if a person with the right mind and skill set approaches the few issues left. ``` [Comment 39](show_bug.cgi?id=1033055#c39)  Ma Ge   2022-07-07 14:51:00 UTC  ``` > There are probably a ton of these cases you can find. For a plethora of > reasons, some historical, some where user needs are more important than > best practices and so on.  I guess it's mostly for historical reasons or for development convenience? For in theory it appears possible that all higher-level applications should run as normal user and only perform lower-level operations as root, while fulfilling user needs equally. ``` [Comment 40](show_bug.cgi?id=1033055#c40)  Matthias Gerstner   2022-07-11 08:59:44 UTC  ``` (In reply to geisserml@gmail.com from [comment #39](show_bug.cgi?id=1033055#c39)) > I guess it's mostly for historical reasons or for development convenience? > For in theory it appears possible that all higher-level applications should > run as normal user and only perform lower-level operations as root, while > fulfilling user needs equally.  Historical reasons are certainly a big part of it. D-Bus services and Polkit for privilege separation are a thing that is mainstream only for roughly a decade or so. And some developers still don't want to use it.  The other aspect is probably the effort. Polkit integration is not straight forward. And the ideal setup of a separate D-Bus daemon running as root that performs privileged operations requires quite some design and introduction of interfaces etc. That is likely also the main driver behind general purpose layers like KIO to make it easy in arbitrary applications to issue privileged operations.  This kind of abstraction layer has its downsides, too, as I already pointed out at various times, mostly the lack of understanding the specific authentication situation and the specific operation that is going on, providing a good user interface for it and so on. ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=1033055)
* - [XML](show_bug.cgi?ctype=xml&id=1033055)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=1033055)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1033055)
  + |
    [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

+ Legal:
+ [openSUSE](http://en.opensuse.org/Terms_of_site)
+ [SUSE](https://www.suse.com/company/legal/)



=== Content from phabricator.kde.org_a9422749_20250126_125734.html ===
[HomePhabricator](/)

* Search

[Log In](/auth/start/?next=%2FD12513) [Differential](/differential/)  D12513
# CVE-2018-10361: privilege escalationClosed[Public](/policy/explain/PHID-DREV-nauhr5ktsawr7bfddgad/view/)Actions

Authored by **[cullmann](/p/cullmann/)** on Apr 25 2018, 10:06 AM.

* [Edit Revision](/differential/revision/edit/12513/)
* [Update Diff](/differential/revision/update/12513/)
* [Download Raw Diff](/D12513?download=true)
* Edit Related Revisions...
* [Edit Parent Revisions](/search/rel/revision.has-parent/PHID-DREV-nauhr5ktsawr7bfddgad/)
* [Edit Child Revisions](/search/rel/revision.has-child/PHID-DREV-nauhr5ktsawr7bfddgad/)
* Edit Related Objects...
* [Edit Commits](/search/rel/revision.has-commit/PHID-DREV-nauhr5ktsawr7bfddgad/)
* [Edit Tasks](/search/rel/revision.has-task/PHID-DREV-nauhr5ktsawr7bfddgad/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-DREV-nauhr5ktsawr7bfddgad/)
* [Award Token](/token/give/PHID-DREV-nauhr5ktsawr7bfddgad/)
* [Flag For Later](/flag/edit/PHID-DREV-nauhr5ktsawr7bfddgad/)

Tags

* [Kate](/tag/kate/)
* [Frameworks](/tag/frameworks/)
Subscribers[acooligan](/p/acooligan/), [kwrite-devel](/p/kwrite-devel/), [kde-frameworks-devel](/p/kde-frameworks-devel/) and [5 others](/subscriptions/list/PHID-DREV-nauhr5ktsawr7bfddgad/)
# Details

Reviewers

| [dfaure](/p/dfaure/) |  |
| --- | --- |
| [maximilianocuria](/p/maximilianocuria/) |  |

Commits [R39:c81af5aa1d4f: CVE-2018-10361: privilege escalation](/R39%3Ac81af5aa1d4f6e0f8c44b2e85ca007ba2a1e4590) Summary

See <http://www.openwall.com/lists/oss-security/2018/04/24/1>

BUG: 393493

# Diff Detail

Repository [R39 KTextEditor](/source/ktexteditor/) Lint

| Automatic diff as part of commit; lint not applicable. |  |
| --- | --- |

Unit

| Automatic diff as part of commit; unit tests not applicable. |  |
| --- | --- |

[maximilianocuria](/p/maximilianocuria/) created this revision.[Apr 25 2018, 10:06 AM](#253500)Restricted Application added projects: [Kate](/tag/kate/), [Frameworks](/tag/frameworks/).  · [View Herald Transcript](/herald/transcript/403313/)[Apr 25 2018, 10:06 AM](#253504)Restricted Application added a subscriber: [Frameworks](/tag/frameworks/).  · [View Herald Transcript](/herald/transcript/403313/)[maximilianocuria](/p/maximilianocuria/) requested review of this revision.[Apr 25 2018, 10:06 AM](#253506)[maximilianocuria](/p/maximilianocuria/) edited the summary of this revision. [(Show Details)](/transactions/detail/PHID-XACT-DREV-2ldfijdcvoraj6b/)[Apr 25 2018, 10:08 AM](#253507)[cullmann](/p/cullmann/) commandeered this revision.[Apr 25 2018, 10:09 AM](#253509)[cullmann](/p/cullmann/) added a reviewer: [maximilianocuria](/p/maximilianocuria/).[cullmann](/p/cullmann/) added a subscriber: [cullmann](/p/cullmann/).Comment Actions

Hi, I propose this variant, that should remove all issues report.

[cullmann](/p/cullmann/) updated this revision to [Diff 33057](/differential/diff/33057/).[Apr 25 2018, 10:11 AM](#253512)Comment Actions

Should solve all reported issues.

[cullmann](/p/cullmann/) added a reviewer: [dfaure](/p/dfaure/).[Apr 25 2018, 10:14 AM](#253514)Comment Actions

The only thing that is unclear:

Shall we use the target dir for the tempfile with

QTemporaryFile tempFile(targetFileInfo.absolutePath() + QStringLiteral("/secureXXXXXX"));

or shall we keep in in the normal tempdir? That would make atomic rename "unlikely" to work.

[maximilianocuria](/p/maximilianocuria/) added a comment.[Apr 25 2018, 10:22 AM](#253516)Comment Actions

Why dropping syncToDisk? Why is that related to the current issue?

[cullmann](/p/cullmann/) added a comment.[Apr 25 2018, 10:30 AM](#253517)Comment Actions
> Why dropping syncToDisk? Why is that related to the current issue?

Because it always just worked on a invalid file handle.

QFile(targetFile).handle()

That is just wrong.

One can add it to an other place fixed later if one really needs it.

[fvogt](/p/fvogt/) added a subscriber: [fvogt](/p/fvogt/).[Apr 25 2018, 11:00 AM](#253537)Comment Actions

There's a typo in the title, it should be "privilege escalation".

[maximilianocuria](/p/maximilianocuria/) retitled this revision from CVE-2018-10361: privelege escalation to CVE-2018-10361: privilege escalation.[Apr 25 2018, 11:42 AM](#253544)Comment Actions
> In [D12513#253537](/D12513#253537), [@fvogt](/p/fvogt/) wrote:
>
> There's a typo in the title, it should be "privilege escalation".

Done

[maximilianocuria](/p/maximilianocuria/) accepted this revision.[Apr 25 2018, 11:57 AM](#253556)This revision is now accepted and ready to land.[Apr 25 2018, 11:57 AM](#253557)[maximilianocuria](/p/maximilianocuria/) added a comment.[Apr 25 2018, 12:00 PM](#253562)Comment Actions

Mmh, the accept revision doesn't work as a +1, does it?

I was intending to say +1/thumbs up, but I would still prefer somebody else to review this. After all, I sent forwarded the original patch, clearly I want this to land, but it's up the frameworks/ktexteditor developers/maintainers to decide.

[maximilianocuria](/p/maximilianocuria/) resigned from this revision.[Apr 25 2018, 12:07 PM](#253563)This revision now requires review to proceed.[Apr 25 2018, 12:07 PM](#253564)[cullmann](/p/cullmann/) added a comment.[Apr 25 2018, 12:09 PM](#253566)Comment Actions

I will ask the openSUSE engineer Matthias Gerstner for feedback before landing this.

[ngraham](/p/ngraham/) added a subscriber: [ngraham](/p/ngraham/).[Apr 25 2018, 1:04 PM](#253590)[aacid](/p/aacid/) added a subscriber: [aacid](/p/aacid/).[Apr 25 2018, 8:23 PM](#253883)Comment Actions

Any reason you guys decided to not involve security@kde.org ?

[cullmann](/p/cullmann/) added a comment.[Apr 26 2018, 4:44 AM](#254018)Comment Actions
> Any reason you guys decided to not involve security@kde.org ?

I think we all forgot to do that, without any real reason, I drop that address a mail now, thanks for the hint!

[mgerstner](/p/mgerstner/) added a subscriber: [mgerstner](/p/mgerstner/).Edited · [Apr 27 2018, 2:20 PM](#254813)Comment Actions

Hi,

I am the guy that came up with the initial security report. I contacted

*cullman* about the issue and we've exchanged a couple of emails about how

to improve the code.

He asked me about what approach would be better: Setting up the temporary file

in $TMPDIR and potentially lose the atomic rename() possibility or keeping the

approach of creating the temporary file in the target directory.

We agreed upon that I add my thoughts here in this Phabricator entry for

public discussion.

The issue I reported was caused by reopening the temporary file which was

probably caused by a misunderstanding of the QTemporaryFile API. The new code

discussed so far should fix this issue and thus the exploit I published.

Apart from this I don't think it matters much if the temporary file is kept in

$TMPDIR or in the target directory. If the target directory is owned by a

non-root user then there is always room for shenanigans by the unprivileged

user. Therefore I would stick to the approach of keeping the temporary file in

the target directory and additionally to the following:

* enter the target directory via chdir()
* check if the owner and group of the directory:
  + if owned by root:root, good to go
  + otherwise either reject the operation (simple) or do a temporary privdrop to the owner/group of the directory including drop of supplementary groups (complex).
* create the tmpfile in the target dir and do the renameat() using only AT\_FDCWD
* restore privileges, if necessary

The tricky thing is doing the privdrop, which is probably not covered by the

Qt core library. The good thing about it is that with doing this the kernel

takes over worrying about permission handling, which it is good at.

[aacid](/p/aacid/) added a comment.[May 1 2018, 11:05 PM](#256845)Comment Actions

Next time please use arc to upload patches, so that instead of those ugly "Context not available." we get nice links to see more code :)

[@mgerstner](/p/mgerstner/) I don't really understand why we need the chdir, renameat, etc.

Dropping privileges to the minimum needed should be enough, shouldn't it?

I mean at that point the only thing that can happen is that some user breaks files he can write to anyway, so why should we take extra precautions from that point on?

[mgerstner](/p/mgerstner/) added a comment.Edited · [May 3 2018, 9:21 AM](#257628)Comment Actions
> In [D12513#256845](/D12513#256845), [@aacid](/p/aacid/) wrote:
>
> [@mgerstner](/p/mgerstner/) I don't really understand why we need the chdir, renameat, etc.
>
> Dropping privileges to the minimum needed should be enough, shouldn't it?
>
> I mean at that point the only thing that can happen is that some user breaks files he can write to anyway, so why should we take extra precautions from that point on?

Strictly speaking the renameat() in the target CWD is not necessary when the privdrop is in place. But the approach is mostly implemented already at the moment and it works reasonably well (given the temporary file is not unnecessarily reopened like it was the case). You have to decide how and where to create the temporary file and this is one valid approach that has the charme of supporting the atomic renameat(). Once the target directory has been entered all directory traversal questions are out of the way.

If you choose a different approach then you will have to open the target file explicitly, which raises other questions like how to safely replace symlinks. Of course such an approach can also be implemented safely. In any case a prudent handling of the temporary file handling improves trust in and robustness of the code and provides additional barriers should errors slip in in the future by way of refactoring or extending the code.

While this discussion here focuses on the CVE at hand, we have a broader discussion about the savefile() feature in an [openSUSE review bug](https://bugzilla.suse.com/show_bug.cgi?id=1033055#c13). I think the overall implementation can use some extra security checks and usability improvements.

[aacid](/p/aacid/) added a comment.[May 5 2018, 7:34 PM](#258565)Comment Actions
> In [D12513#257628](/D12513#257628), [@mgerstner](/p/mgerstner/) wrote:
>
> If you choose a different approach then you will have to open the target file explicitly, which raises other questions like how to safely replace symlinks. Of course such an approach can also be implemented safely. In any case a prudent handling of the temporary file handling improves trust in and robustness of the code and provides additional barriers should errors slip in in the future by way of refactoring or extending the code.

Honestly i don't understand why i have to care about anything.

If we drop privileges, it's just some code running with regular user level privileges, why are symlinks a problem?

Because some malicious code can create symlinks that make the code write to file X when we wanted to write to file Y?

Sure that's bad, but if you have in your system something that can create such symlink, it already has user level privileges, so it can already write to file X or file Y itself, without "exploiting" kate to do it.

Or am I missing something?

[mgerstner](/p/mgerstner/) added a comment.[May 9 2018, 11:51 AM](#260028)Comment Actions
> In [D12513#258565](/D12513#258565), [@aacid](/p/aacid/) wrote:

> Honestly i don't understand why i have to care about anything.
>
> If we drop privileges, it's just some code running with regular user level
>
> privileges, why are symlinks a problem?

Well for one, if the target directory is owned by root, then you will be

dropping privileges to root i.e. you won't drop privileges at all.

The owners of the directory and the target file may differ. Another case might

be that target directory and file are owned by root, but one of the upper

directories is owned by a non-root user. Maybe it is a root-owned directory

that is only temporary in nature and a race condition is involved i.e. it gets

deleted before the actual file operations begin.

It would be uncommon but we never now what the situation might be. The feature

seems targeted towards users that have no big technical insight. So strange

situations can be expected. IMO prudence is the better part of valor here.

Restricted Application edited subscribers, added: [kde-frameworks-devel](/p/kde-frameworks-devel/), [kwrite-devel](/p/kwrite-devel/); removed: [Frameworks](/tag/frameworks/).  · [View Herald Transcript](/herald/transcript/410565/)[May 9 2018, 11:51 AM](#260029)[aacid](/p/aacid/) added a comment.[May 9 2018, 10:01 PM](#260384)Comment Actions

I meant dropping privileges to the user that is running the ktexteditor program, not to the user that owns the target directory, but now that i think about it that's pretty stupid since otherwise we wouldn't be needing root :D

I'll try to go over this with a fresh mind again

[cullmann](/p/cullmann/) added a comment.[May 27 2018, 5:28 PM](#269208)Comment Actions
## > What should we do with this?

[aacid](/p/aacid/) added a comment.[May 28 2018, 9:43 PM](#269889)Comment Actions

I think it was agreed this is an improvement, so i'm going to suggest we commit it.

I'm definitely very short on time to spend here because someone added poppler to oss-fuzz and i've a pile of files that are crashing / causing bad behaviour on poppler to care for.

Once this is in, we should open a bug/phabricator task/wathever with what is missing and the recommendations to fix it.

Also not sure if useful but since kio is getting support for writting to "root owned" files we should investigate if maybe we can just simply drop this code altogether?

[acooligan](/p/acooligan/) added a subscriber: [acooligan](/p/acooligan/).[Jun 7 2018, 2:09 PM](#275362)Comment Actions
> In [D12513#269889](/D12513#269889), [@aacid](/p/aacid/) wrote:
>
> Also not sure if useful but since kio is getting support for writting to "root owned" files we should investigate if maybe we can just simply drop this code altogether?

As KIO has its own similar issues and it's not ready yet, can you merge this one? More than a month passed since vulnerabilities were reported, fix posted here and we're still in limbo.

[cullmann](/p/cullmann/) added a comment.[Jun 7 2018, 2:10 PM](#275364)Comment Actions

I can push that change, if OK.

This revision was not accepted when it landed; it landed in state Needs Review.[Jun 7 2018, 2:13 PM](#275365)Closed by commit [R39:c81af5aa1d4f: CVE-2018-10361: privilege escalation](/R39%3Ac81af5aa1d4f6e0f8c44b2e85ca007ba2a1e4590) (authored by [cullmann](/p/cullmann/)).  · [Explain Why](/differential/revision/closedetails/PHID-XACT-DREV-qpwagnfrbsjgrep/)This revision was automatically updated to reflect the committed changes.[cullmann](/p/cullmann/) added a comment.[Jun 7 2018, 2:13 PM](#275368)Comment Actions

I followed the "I think it was agreed this is an improvement, so i'm going to suggest we commit it." comment from above.

In any case, it is an improvement to the old situation.

# Revision Contents[Changeset List](/differential/diff/35772/changesets/)

* Files
* History
* Commits

|  |  |  | Path | Packages |
| --- | --- | --- | --- | --- |
| M |  |  | [src/buffer/katesecuretextbuffer.cpp](#change-RLigABZE06rC) (99 lines) |  |
| M |  |  | [src/buffer/katesecuretextbuffer\_p.h](#change-bfK45NdxKiRU) (4 lines) |  |

| Diff | ID | Base | Description | Created | Lint | Unit |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Base |  |  | Base |  |  |  |  |  |
| Diff 1 | [33054](/D12513?id=33054) | [64da04a](/R39%3A64da04a881ba571c88f530de0fdcbd80c3bc03d6) |  | Apr 25 2018, 10:06 AM | ★ | ★ |  |  |
| Diff 2 | [33057](/D12513?id=33057) |  |  | Apr 25 2018, 10:09 AM | ★ | ★ |  |  |
| Diff 3 | [35772](/D12513?id=35772) | [e6f87dd](/R39%3Ae6f87dd570082eb7f636b92f6ca88d85763ae687) | R39:c81af5aa1d4f6e0f8c44b2e85ca007ba2a1e4590 | Jun 7 2018, 2:12 PM | ★ | ★ |  |  |

Whitespace Changes:Ignore AllIgnore MostIgnore TrailingShow AllShow Diff
# Diff 35772

View Options
# src/buffer/katesecuretextbuffer.cpp

Loading...View Options
# src/buffer/katesecuretextbuffer\_p.h

Loading...[Log In to Comment](/login/?next=)

=== Content from seclists.org_df84f121_20250126_125734.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![oss-sec logo](/images/oss-sec-logo.png)](/oss-sec/)
## [oss-sec](/oss-sec/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](64)
[By Date](date.html#65)
[![Next](/images/right-icon-16x16.png)](66)

[![Previous](/images/left-icon-16x16.png)](64)
[By Thread](index.html#65)
[![Next](/images/right-icon-16x16.png)](69)

![](/shared/images/nst-icons.svg#search)

# ktexteditor / Kate local privilege escalation

---

*From*: Matthias Gerstner <mgerstner () suse de>

*Date*: Tue, 24 Apr 2018 13:11:09 +0200

---

```
Hello list,

following is a report about a local privilege escalation I found in
ktexteditor. I just informed upstream about it and will obtain a CVE
soon.

ktexteditor (<https://api.kde.org/frameworks/ktexteditor/html/>) provides
a text editor component for KDE applications. It is, for example, used
in the "kate" text editor program.

One of ktexteditor's features is support to write files owned by root or
other users after entering the root password via polkit authentication.
The authentication part is handled via the "kauth" framework. The actual
work of saving files on behalf of the authenticated user is performed by
a small program named "kauth_ktexteditor_helper". The related code is
found in the upstream repository in the following source files:

src/buffer/katesecuretextbuffer_p.h
src/buffer/katesecuretextbuffer.cpp

The logic for saving the file goes roughly as follows:

- the caller provides source and target file paths, a sha512 digest of
  the source file content and (optionally) the target file owner and
  group IDs.
- the helper tries to open a temporary file in the directory containing
  the target file, reads chunk from the source file and writes them to
  the target file, recalculating the sha512 digest on the way.
- in the end, if the digest matches, the temporary file will be
  rename()'d for replacing the target file path with the new file
  content.

For temporary file handling the qt5 core library facilities are employed
and the following source code lines are the important ones:

```
    // We will first generate temporary filename and then use it relatively to prevent an attacker
    // to trick us to write contents to a different file by changing underlying directory.
    QTemporaryFile tempFile(targetFileName);
    if (!tempFile.open()) {
        return false;
    }
    tempFile.close();
    QString tempFileName = QFileInfo(tempFile).fileName();
    tempFile.setFileName(tempFileName);
    if (!readFile.open(QIODevice::ReadOnly) || !tempFile.open()) {
        return false;
    }
```

This code results in the following system call sequence:

```
    openat(AT_FDCWD, "/etc", O_RDWR|O_CLOEXEC|O_TMPFILE, 0600) = 11
    lseek(11, 0, SEEK_SET)      = 0
    linkat(AT_FDCWD, "/proc/self/fd/11", AT_FDCWD, "/etc/fstab.hdRIFU",
        AT_SYMLINK_FOLLOW) = 0
    close(11) = 0
    [...]
    openat(AT_FDCWD, "fstab.hdRIFU", O_RDWR|O_CREAT|O_CLOEXEC, 0666) = 12
```

So while the code author(s) have been seemingly aware that temporary
file handling needs to be done carefully they somehow still broke it in
the end which we can see from the system calls. The initially unnamed
temporary file is linked, the associated file descriptor closed and the
now named temporary file is reopened with the `O_CREAT` flag. On file
systems that don't support O_TMPFILE the vulnerability is also existing,
the code will fall back to named files right away.

As it turns out this situation can be exploited in scenarios like the
following:

A user running "kate" wants to edit and save a file in a directory that
is owned by another unprivileged user. Such directories exist for
various software e.g. in /var/lib or in /etc. The user enters root
credentials to perform the privileged save operation.

The other unprivileged user can now perform a symlink attack on the
temporary file being opened by the "kauth_ktexteditor_helper" and
achieve various effects:

- creation of new files in arbitrary file system locations.
- corruption of arbitrary existing files (because the helper will write
  the source file content into the symlinked file).
- taking ownership of arbitrary files (because the helper will perform
  an fchown() call on the symlinked file), thereby facilitating local
  root privilege escalation.

The attached proof of concept code succeeds in gaining ownership of
/etc/shadow in the described situation. Exploiting the race condition
does not work very reliably, because the window of opportunity is very
small. Some more advanced exploit code might improve the chances.

The API of the QTemporaryFile class has some non-obvious semantics. The
close() method does not really close the underlying file descriptor. The
setFileName() function, however, does. I am not clear what the original
intentions of the code above being this way might have been. As far as I
can tell the attached patch fixes the race condition detailed in this
report without breaking anything.

The vulnerable code is already found in upstream commit
f7a9573d973e6ef0cd6f2c419290c0c7e46381b7 and therefore ktexteditor
starting from version 5.34.0 can be considered vulnerable.

Cheers

Matthias

--
Matthias Gerstner <matthias.gerstner () suse de>
Dipl.-Wirtsch.-Inf. (FH), Security Engineer
<https://www.suse.com/security>
Telefon: +49 911 740 53 290
GPG Key ID: 0x14C405C971923553

SUSE Linux GmbH
GF: Felix Imendörffer, Jane Smithard, Graham Norton
HRB 21284 (AG Nuernberg)

```

**Attachment:
[ktexteditor\_tmpfile\_fix.patch](att-65/ktexteditor_tmpfile_fix.patch)**

*Description:*

**Attachment:
[kattack.cpp](att-65/kattack_cpp.bin)**

*Description:*

**Attachment:
[signature.asc](att-65/signature_asc.bin)**

*Description:* Digital signature

---

[![Previous](/images/left-icon-16x16.png)](64)
[By Date](date.html#65)
[![Next](/images/right-icon-16x16.png)](66)

[![Previous](/images/left-icon-16x16.png)](64)
[By Thread](index.html#65)
[![Next](/images/right-icon-16x16.png)](69)

### Current thread:

* **ktexteditor / Kate local privilege escalation** *Matthias Gerstner (Apr 24)*
  + [Re: ktexteditor / Kate local privilege escalation (CVE-2018-10361)](69) *Matthias Gerstner (Apr 25)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")


