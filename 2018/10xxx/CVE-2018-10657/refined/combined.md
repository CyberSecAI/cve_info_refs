=== Content from github.com_1abc5520_20250125_132957.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2F33f469ba19586bbafa0cf2c7d7c35463bdab87eb)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2F33f469ba19586bbafa0cf2c7d7c35463bdab87eb)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=matrix-org%2Fsynapse)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Apr 26, 2024. It is now read-only.

[matrix-org](/matrix-org)
/
**[synapse](/matrix-org/synapse)**
Public archive

* [Notifications](/login?return_to=%2Fmatrix-org%2Fsynapse) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Fmatrix-org%2Fsynapse)
* [Star
   11.9k](/login?return_to=%2Fmatrix-org%2Fsynapse)

* [Code](/matrix-org/synapse)
* [Issues
  1.5k](/matrix-org/synapse/issues)
* [Pull requests
  64](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects
  0](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

Additional navigation options

* [Code](/matrix-org/synapse)
* [Issues](/matrix-org/synapse/issues)
* [Pull requests](/matrix-org/synapse/pulls)
* [Actions](/matrix-org/synapse/actions)
* [Projects](/matrix-org/synapse/projects)
* [Wiki](/matrix-org/synapse/wiki)
* [Security](/matrix-org/synapse/security)
* [Insights](/matrix-org/synapse/pulse)

## Commit

[Permalink](/matrix-org/synapse/commit/33f469ba19586bbafa0cf2c7d7c35463bdab87eb)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Apply some limits to depth to counter abuse

[Browse files](/matrix-org/synapse/tree/33f469ba19586bbafa0cf2c7d7c35463bdab87eb)
Browse the repository at this point in the history

```
* When creating a new event, cap its depth to 2^63 - 1
* When receiving events, reject any without a sensible depth

As per <https://docs.google.com/document/d/1I3fi2S-XnpO45qrpCsowZv8P8dHcNZ4fsBsbOW7KABI>
```

* Loading branch information

[![@richvdh](https://avatars.githubusercontent.com/u/1389908?s=40&v=4)](/richvdh)

[richvdh](/matrix-org/synapse/commits?author=richvdh "View all commits by richvdh")
committed
May 1, 2018

1 parent
[28dd536](/matrix-org/synapse/commit/28dd536e80167677ce45bd8eeee95c6ff6eff66f)

commit 33f469b

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**26 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* synapse

  + api

    - synapse/api/constants.py
      [constants.py](#diff-32e0f096397b0e3545054c51c42b5be4f0db953083b60d76a047cb1618f6b877)
  + federation

    - synapse/federation/federation\_base.py
      [federation\_base.py](#diff-9a3aa1c5fb3b4f7d3e7f4b3888264d3cf5044a5a9d622a1051f1ce866bf08968)
  + handlers

    - synapse/handlers/message.py
      [message.py](#diff-3d4a81fcc5b115c649ae67aaba0dd4dd0c5827bb001dfcb90b00ffb1605d518e)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[synapse/api/constants.py](#diff-32e0f096397b0e3545054c51c42b5be4f0db953083b60d76a047cb1618f6b877 "synapse/api/constants.py")

Show comments

[View file](/matrix-org/synapse/blob/33f469ba19586bbafa0cf2c7d7c35463bdab87eb/synapse/api/constants.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,6 +16,9 @@ |
|  |  |  |
|  |  | """Contains constants from the specification.""" |
|  |  |  |
|  |  | # the "depth" field on events is limited to 2\*\*63 - 1 |
|  |  | MAX\_DEPTH = 2\*\*63 - 1 |
|  |  |  |
|  |  |  |
|  |  | class Membership(object): |
|  |  |  |
| Expand Down | |  |

21 changes: 18 additions & 3 deletions

21
[synapse/federation/federation\_base.py](#diff-9a3aa1c5fb3b4f7d3e7f4b3888264d3cf5044a5a9d622a1051f1ce866bf08968 "synapse/federation/federation_base.py")

Show comments

[View file](/matrix-org/synapse/blob/33f469ba19586bbafa0cf2c7d7c35463bdab87eb/synapse/federation/federation_base.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,7 +14,10 @@ |
|  |  | # limitations under the License. |
|  |  | import logging |
|  |  |  |
|  |  | from synapse.api.errors import SynapseError |
|  |  | import six |
|  |  |  |
|  |  | from synapse.api.constants import MAX\_DEPTH |
|  |  | from synapse.api.errors import SynapseError, Codes |
|  |  | from synapse.crypto.event\_signing import check\_event\_content\_hash |
|  |  | from synapse.events import FrozenEvent |
|  |  | from synapse.events.utils import prune\_event |
| Expand Down  Expand Up | | @@ -190,11 +193,23 @@ def event\_from\_pdu\_json(pdu\_json, outlier=False): |
|  |  | FrozenEvent |
|  |  |  |
|  |  | Raises: |
|  |  | SynapseError: if the pdu is missing required fields |
|  |  | SynapseError: if the pdu is missing required fields or is otherwise |
|  |  | not a valid matrix event |
|  |  | """ |
|  |  | # we could probably enforce a bunch of other fields here (room\_id, sender, |
|  |  | # origin, etc etc) |
|  |  | assert\_params\_in\_request(pdu\_json, ('event\_id', 'type')) |
|  |  | assert\_params\_in\_request(pdu\_json, ('event\_id', 'type', 'depth')) |
|  |  |  |
|  |  | depth = pdu\_json['depth'] |
|  |  | if not isinstance(depth, six.integer\_types): |
|  |  | raise SynapseError(400, "Depth %r not an intger" % (depth, ), |
|  |  | Codes.BAD\_JSON) |
|  |  |  |
|  |  | if depth < 0: |
|  |  | raise SynapseError(400, "Depth too small", Codes.BAD\_JSON) |
|  |  | elif depth > MAX\_DEPTH: |
|  |  | raise SynapseError(400, "Depth too large", Codes.BAD\_JSON) |
|  |  |  |
|  |  | event = FrozenEvent( |
|  |  | pdu\_json |
|  |  | ) |
| Expand Down | |  |

6 changes: 5 additions & 1 deletion

6
[synapse/handlers/message.py](#diff-3d4a81fcc5b115c649ae67aaba0dd4dd0c5827bb001dfcb90b00ffb1605d518e "synapse/handlers/message.py")

Show comments

[View file](/matrix-org/synapse/blob/33f469ba19586bbafa0cf2c7d7c35463bdab87eb/synapse/handlers/message.py)
Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,7 +16,7 @@ |
|  |  | from twisted.internet import defer, reactor |
|  |  | from twisted.python.failure import Failure |
|  |  |  |
|  |  | from synapse.api.constants import EventTypes, Membership |
|  |  | from synapse.api.constants import EventTypes, Membership, MAX\_DEPTH |
|  |  | from synapse.api.errors import AuthError, Codes, SynapseError |
|  |  | from synapse.crypto.event\_signing import add\_hashes\_and\_signatures |
|  |  | from synapse.events.utils import serialize\_event |
| Expand Down  Expand Up | | @@ -624,6 +624,10 @@ def create\_new\_client\_event(self, builder, requester=None, |
|  |  |  |
|  |  | if prev\_events\_and\_hashes: |
|  |  | depth = max([d for \_, \_, d in prev\_events\_and\_hashes]) + 1 |
|  |  | # we cap depth of generated events, to ensure that they are not |
|  |  | # rejected by other servers (and so that they can be persisted in |
|  |  | # the db) |
|  |  | depth = min(depth, MAX\_DEPTH) |
|  |  | else: |
|  |  | depth = 1 |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `33f469b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmatrix-org%2Fsynapse%2Fcommit%2F33f469ba19586bbafa0cf2c7d7c35463bdab87eb) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from matrix.org_c27edc6d_20250125_132958.html ===

[![Matrix logo](/images/matrix-logo-white.svg)](/)

î˜‚

[Spec](https://spec.matrix.org)

Foundation

[About Matrix](/foundation/about/)
[Governing Board Elections 2024](/foundation/governing-board-elections/)

[Blog](/blog/)
[Docs](/docs/)

Ecosystem

[Clients](/ecosystem/clients/)
[Bridges](/ecosystem/bridges/)
[Servers](/ecosystem/servers/)
[Integrations](/ecosystem/integrations/)
[SDKs](/ecosystem/sdks/)
[Hosting](/ecosystem/hosting/)

[Donate](/support)
[Try Matrix](/try-matrix/)

# SECURITY UPDATE: Synapse 0.28.1

01.05.2018 00:00
â€”
[Tech](/category/tech)
â€”
[Matthew Hodgson](/author/matthew-hodgson)

Hi all,

Many people will have noticed disruption in #matrix:matrix.org and #matrix-dev:matrix.orgÂ on Sunday, when a validation bug in Synapse was exploited which allowed a malicious event to be inserted into the room with 'depth' value that made the rooms temporarily unusable. Whilst a transient workaroundÂ was found at the time (thanks to /dev/ponies, kythyria and Po Shamil for the workaround andÂ to Half-Shot for working on a proposed fix), we're doing an urgent release of Synapse 0.28.1 to provide a temporary solution which will mitigate the attack across all rooms in upgraded servers and un-break affected ones.Â  Meanwhile we have a full long-term fix on the horizon (hopefully) later this week.

**This vulnerability has already been exploited in the wild; please upgrade as soon as possible.**

Synapse 0.28.1 is available fromÂ <https://github.com/matrix-org/synapse/releases/tag/v0.28.1>Â as normal.

The 'depth' parameter is used primarily as a way for servers to signal the intended cosmetic order of their events within a room (particularly when the room's message graph has gaps in it due to the server being offline, or due to users backfilling old disconnected chunks of conversation). This means that affected rooms may experience message ordering problems until a full long-term fix is provided, which we're working on currently (and tentatively involves no longer trusting 'depth' information from servers).Â  For full details you can see the proposal documents for the [temporary fix in 0.28.1](https://docs.google.com/document/d/1I3fi2S-XnpO45qrpCsowZv8P8dHcNZ4fsBsbOW7KABI/edit) and the options for the[imminent long-term fix](https://docs.google.com/document/d/16ofbjluy8ZKYL6nt7WLHG4GqSodJUWLUxHhI6xPEjr4/edit).

We'd like to acknowledge jzk for identifying the vulnerability, and Max Dor for providing feedback on the fixes.

As a general reminder, Synapse is still beta (as is the Matrix spec) and the federation API particularly is still being debugged and refined and is pre-r0.0.0.Â For the benefit of the whole community, please disclose vulnerabilities and exploits responsibly by emailing security@ or DMing someone from +matrix:matrix.org. Thanks.

## [ðŸ”—](#changes-in-synapse-v0-28-1-2018-05-01)Changes in synapse v0.28.1 (2018-05-01)

**SECURITY UPDATE**

* Clamp the allowed values of event depth received over federation to be [0, 2^63 - 1]. This mitigates an attack where malicious events injected with depth = 2^63 - 1 render rooms unusable. Depth is used to determine the cosmetic ordering of events within a room, and so the ordering of events in such a room will default to using stream\_ordering rather than depth (topological\_ordering). This is a temporary solution to mitigate abuse in the wild, whilst a long solution is being implemented to improve how the depth parameter is used.Full details atÂ <https://docs.google.com/document/d/1I3fi2S-XnpO45qrpCsowZv8P8dHcNZ4fsBsbOW7KABI>
* Pin Twisted to <18.4 until we stop using the private \_OpenSSLECCurve API.

## The Foundation needs you

The Matrix.org Foundation is a non-profit and only relies
on donations to operate. Its core mission is to maintain
the Matrix Specification, but it does much more than that.

It maintains the matrix.org homeserver and hosts several
bridges for free. It fights for our collective rights to
digital privacy and dignity.

[Support us](/support)

### Post Contents

* [Changes in synapse v0.28.1 (2018-05-01)](https://matrix.org/blog/2018/05/01/security-update-synapse-0-28-1/#changes-in-synapse-v0-28-1-2018-05-01)

[Donate](/support)
[Shop](https://shop.matrix.org)
[Security Disclosure Policy](/security-disclosure-policy)
[Security Hall of Fame](/security-hall-of-fame)
[Code of Conduct](/legal/code-of-conduct)
[Legal](/legal)
[Contact](/contact)
[Site Source](https://github.com/matrix-org/matrix.org/)

[![GitHub](/assets/github.svg)](https://github.com/matrix-org)
[![GitLab](/assets/gitlab.svg)](https://gitlab.matrix.org/)
[![Mastodon](/assets/mastodon.svg)](https://mastodon.matrix.org/%40matrix)
[![Twitter](/assets/twitter.svg)](https://twitter.com/matrixdotorg)
[![YouTube](/assets/youtube.svg)](https://www.youtube.com/channel/UCVFkW-chclhuyYRbmmfwt6w)
[![RSS](/assets/rss.svg)](/atom.xml)

[Copyright Notice](/legal/copyright-notice)


