The provided content relates to CVE-2018-16528.

**Root cause of vulnerability:** The MQTT agent and Greengrass Discovery (GGD) modules misuse the mbedTLS API, specifically by using the same mbedTLS context after a failed TLS handshake, leading to a corrupted context.

**Weaknesses/vulnerabilities present:**
- Improper handling of mbedTLS context after a failed handshake.
- Using a potentially corrupted mbedTLS context for subsequent operations (reading data).

**Impact of exploitation:**
- Remote code execution.

**Attack vectors:**
- Network-based attacks by sending malicious TLS traffic that causes the handshake to fail.

**Required attacker capabilities/position:**
- Ability to send network packets to the target device running vulnerable FreeRTOS versions.
- No specific user interaction is required.

**Technical details:**

The vulnerability lies within the `prvSetupConnection` function used by the MQTT agent and GGD modules, specifically:

1. A TLS connection is initialized using the mbedTLS library via `TLS_Connect`.
2. If the TLS handshake fails, `SOCKETS_Connect` returns an error.
3. The code calls `prvGracefulSocketClose` to clean up and close the socket.
4. `prvGracefulSocketClose` calls `SOCKETS_Recv`, which in turn calls `TLS_Recv`, which wraps the `mbedtls_ssl_read`. This step attempts to use the same mbedTLS context ( `pCtx->mbedSslCtx` ) that might have been corrupted during the failed handshake.

The vulnerability arises because the mbedTLS API warns that a context can be left in a corrupted state if the handshake fails. The code in FreeRTOS does not create a new context or take appropriate steps after a failure, leading to potential vulnerabilities.