=== Content from lists.debian.org_5c55de79_20250125_205806.html ===


---

[[Date Prev](msg00016.html)][[Date Next](msg00018.html)]
[[Thread Prev](msg00016.html)][[Thread Next](msg00018.html)]
[[Date Index](maillist.html#00017)]
[[Thread Index](threads.html#00017)]

# [SECURITY] [DLA 1715-1] linux-4.9 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 1715-1] linux-4.9 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Fri, 15 Mar 2019 22:45:15 +0000
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/4e418020e07569ef54a90afa3ffa8c0d6f28de24.camel%40debian.org)Â [4e418020e07569ef54a90afa3ffa8c0d6f28de24.camel@debian.org](msg00017.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux-4.9
Version        : 4.9.144-3.1~deb8u1
CVE ID         : CVE-2017-18249 CVE-2018-1128 CVE-2018-1129 CVE-2018-3639
                 CVE-2018-5391 CVE-2018-5848 CVE-2018-6554 CVE-2018-12896
                 CVE-2018-13053 CVE-2018-13096 CVE-2018-13097 CVE-2018-13100
                 CVE-2018-13406 CVE-2018-14610 CVE-2018-14611 CVE-2018-14612
                 CVE-2018-14613 CVE-2018-14614 CVE-2018-14616 CVE-2018-15471
                 CVE-2018-16862 CVE-2018-17972 CVE-2018-18281 CVE-2018-18690
                 CVE-2018-18710 CVE-2018-19407
Debian Bug     : 890034 896911 907581 915229 915231

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2017-18249

    A race condition was discovered in the disk space allocator of
    F2FS. A user with access to an F2FS volume could use this to cause
    a denial of service or other security impact.

CVE-2018-1128, CVE-2018-1129

    The cephx authentication protocol used by Ceph was susceptible to
    replay attacks, and calculated signatures incorrectly. These
    vulnerabilities in the server required changes to authentication
    that are incompatible with existing clients. The kernel's client
    code has now been updated to be compatible with the fixed server.

CVE-2018-3639 (SSB)

    Multiple researchers have discovered that Speculative Store Bypass
    (SSB), a feature implemented in many processors, could be used to
    read sensitive information from another context. In particular,
    code in a software sandbox may be able to read sensitive
    information from outside the sandbox. This issue is also known as
    Spectre variant 4.

    This update adds a further mitigation for this issue in the eBPF
    (Extended Berkeley Packet Filter) implementation.

CVE-2018-5391 (FragmentSmack)

    Juha-Matti Tilli discovered a flaw in the way the Linux kernel
    handled reassembly of fragmented IPv4 and IPv6 packets. A remote
    attacker can take advantage of this flaw to trigger time and
    calculation expensive fragment reassembly algorithms by sending
    specially crafted packets, leading to remote denial of service.

    This was previously mitigated by reducing the default limits on
    memory usage for incomplete fragmented packets. This update
    replaces that mitigation with a more complete fix.

CVE-2018-5848

    The wil6210 wifi driver did not properly validate lengths in scan
    and connection requests, leading to a possible buffer overflow.
    On systems using this driver, a local user with the CAP_NET_ADMIN
    capability could use this for denial of service (memory corruption
    or crash) or potentially for privilege escalation.

CVE-2018-12896, CVE-2018-13053

    Team OWL337 reported possible integer overflows in the POSIX
    timer implementation. These might have some security impact.

CVE-2018-13096, CVE-2018-13097, CVE-2018-13100, CVE-2018-14614,
CVE-2018-14616

    Wen Xu from SSLab at Gatech reported that crafted F2FS volumes
    could trigger a crash (BUG, Oops, or division by zero) and/or
    out-of-bounds memory access. An attacker able to mount such a
    volume could use this to cause a denial of service or possibly for
    privilege escalation.

CVE-2018-13406

    Dr Silvio Cesare of InfoSect reported a potential integer overflow
    in the uvesafb driver. A user with permission to access such a
    device might be able to use this for denial of service or
    privilege escalation.

CVE-2018-14610, CVE-2018-14611, CVE-2018-14612, CVE-2018-14613

    Wen Xu from SSLab at Gatech reported that crafted Btrfs volumes
    could trigger a crash (Oops) and/or out-of-bounds memory access.
    An attacker able to mount such a volume could use this to cause a
    denial of service or possibly for privilege escalation.

CVE-2018-15471 ((XSA-270)

    Felix Wilhelm of Google Project Zero discovered a flaw in the hash
    handling of the xen-netback Linux kernel module. A malicious or
    buggy frontend may cause the (usually privileged) backend to make
    out of bounds memory accesses, potentially resulting in privilege
    escalation, denial of service, or information leaks.

    <https://xenbits.xen.org/xsa/advisory-270.html>

CVE-2018-16862

    Vasily Averin and Pavel Tikhomirov from Virtuozzo Kernel Team
    discovered that the cleancache memory management feature did not
    invalidate cached data for deleted files. On Xen guests using the
    tmem driver, local users could potentially read data from other
    users' deleted files if they were able to create new files on the
    same volume.

CVE-2018-17972

    Jann Horn reported that the /proc/*/stack files in procfs leaked
    sensitive data from the kernel. These files are now only readable
    by users with the CAP_SYS_ADMIN capability (usually only root)

CVE-2018-18281

    Jann Horn reported a race condition in the virtual memory manager
    that can result in a process briefly having access to memory after
    it is freed and reallocated. A local user could possibly exploit
    this for denial of service (memory corruption) or for privilege
    escalation.

CVE-2018-18690

    Kanda Motohiro reported that XFS did not correctly handle some
    xattr (extended attribute) writes that require changing the disk
    format of the xattr. A user with access to an XFS volume could use
    this for denial of service.

CVE-2018-18710

    It was discovered that the cdrom driver does not correctly
    validate the parameter to the CDROM_SELECT_DISC ioctl. A user with
    access to a cdrom device could use this to read sensitive
    information from the kernel or to cause a denial of service
    (crash).

CVE-2018-19407

    Wei Wu reported a potential crash (Oops) in the KVM implementation
    for x86 processors. A user with access to /dev/kvm could use this
    for denial of service.

For Debian 8 "Jessie", these problems have been fixed in version
4.9.144-3.1~deb8u1.  This version also includes fixes for Debian bugs
#890034, #896911, #907581, #915229, and #915231; and other fixes
included in upstream stable updates.

We recommend that you upgrade your linux-4.9 packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams

```

**Attachment:
[signature.asc](pgpBdxOYtpI06.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from git.kernel.org_f1b57e2a_20250125_205746.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kees Cook <keescook@chromium.org> | 2018-05-11 18:24:12 +1000 |
| --- | --- | --- |
| committer | Kees Cook <keescook@chromium.org> | 2018-06-12 16:19:22 -0700 |
| commit | [9f645bcc566a1e9f921bdae7528a01ced5bc3713](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)) | |
| tree | [6a89ba3f5af7cb4c8415a8dd2589146b3018bed7](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713) | |
| parent | [353748a359f1821ee934afc579cf04572406b420](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=353748a359f1821ee934afc579cf04572406b420) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713&id2=353748a359f1821ee934afc579cf04572406b420)) | |
| download | [linux-9f645bcc566a1e9f921bdae7528a01ced5bc3713.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-9f645bcc566a1e9f921bdae7528a01ced5bc3713.tar.gz) | |

video: uvesafb: Fix integer overflow in allocationcmap->len can get close to INT\_MAX/2, allowing for an integer overflow in
allocation. This uses kmalloc\_array() instead to catch the condition.
Reported-by: Dr Silvio Cesare of InfoSect <silvio.cesare@gmail.com>
Fixes: 8bdb3a2d7df48 ("uvesafb: the driver core")
Cc: stable@vger.kernel.org
Signed-off-by: Kees Cook <keescook@chromium.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)

| -rw-r--r-- | [drivers/video/fbdev/uvesafb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/video/fbdev/uvesafb.c?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/video/fbdev/uvesafb.c b/drivers/video/fbdev/uvesafb.cindex 73676eb0244a7b..c592ca513115c0 100644--- a/[drivers/video/fbdev/uvesafb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/video/fbdev/uvesafb.c?id=353748a359f1821ee934afc579cf04572406b420)+++ b/[drivers/video/fbdev/uvesafb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/video/fbdev/uvesafb.c?id=9f645bcc566a1e9f921bdae7528a01ced5bc3713)@@ -1044,7 +1044,8 @@ static int uvesafb\_setcmap(struct fb\_cmap \*cmap, struct fb\_info \*info) info->cmap.len || cmap->start < info->cmap.start) return -EINVAL; - entries = kmalloc(sizeof(\*entries) \* cmap->len, GFP\_KERNEL);+ entries = kmalloc\_array(cmap->len, sizeof(\*entries),+ GFP\_KERNEL); if (!entries) return -ENOMEM; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 20:56:23 +0000



=== Content from usn.ubuntu.com_6b3de2d2_20250125_205807.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3752-1: Linux kernel vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 18.04 ESM](/security/notices?release=bionic)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-gcp](/security/cves?package=linux-gcp) - Linux kernel for Google Cloud Platform (GCP) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2

## Details

It was discovered that, when attempting to handle an out-of-memory

situation, a null pointer dereference could be triggered in the Linux

kernel in some circumstances. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2018-1000200](/security/CVE-2018-1000200))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate xattr information. An attacker could use

this to construct a malicious xfs image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10840](/security/CVE-2018-10840))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

Jann Horn discovered that the Linux kernel's implementation of random seed

data reported that it was in a ready state before it had gathered

sufficient entropy. An attacker could use this to expose sensitive

information. ([CVE-2018-1108](/security/CVE-2018-1108))

It was discovered that the procfs filesystem did not properly handle

processes mapping some memory elements onto files. A local attacker could

use this to block utilities that examine the procfs filesystem to report

operating system state, such as ps(1). ([CVE-2018-1120](/security/CVE-2018-1120))

Jann Horn discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep xattr information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11412](/security/CVE-2018-11412))

Piotr Gabriel Kosinski and Daniel Shapira discovered a stack-based buffer

overflow in the CDROM driver implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11506](/security/CVE-2018-11506))

Shankara Pailoor discovered that a race condition existed in the socket

handling code in the Linux kernel. A local attacker could use this to cause

a denial of service (system crash). ([CVE-2018-12232](/security/CVE-2018-12232))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Felix Wilhelm discovered that the KVM implementation in the Linux kernel

did not properly perform permission checks in some situations when nested

virtualization is used. An attacker in a guest VM could possibly use this

to escape into an outer VM or the host OS. ([CVE-2018-12904](/security/CVE-2018-12904))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Jakub Jirasek discovered that multiple use-after-free errors existed in the

USB/IP implementation in the Linux kernel. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5814](/security/CVE-2018-5814))

It was discovered that a race condition existed in the ARM Advanced

Microcontroller Bus Architecture (AMBA) driver in the Linux kernel that

could result in a double free. A local attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-9415](/security/CVE-2018-9415))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 18.04

* [linux-image-4.15.0-1020-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.15.0-1020.20](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.15.0-1020.20)
* [linux-image-4.15.0-1020-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.15.0-1020.20](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.15.0-1020.20)
* [linux-image-4.15.0-1021-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.15.0-1021.23](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.15.0-1021.23)
* [linux-image-4.15.0-33-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.15.0-33.36](https://launchpad.net/ubuntu/%2Bsource/linux/4.15.0-33.36)
* [linux-image-4.15.0-33-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.15.0-33.36](https://launchpad.net/ubuntu/%2Bsource/linux/4.15.0-33.36)
* [linux-image-4.15.0-33-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.15.0-33.36](https://launchpad.net/ubuntu/%2Bsource/linux/4.15.0-33.36)
* [linux-image-4.15.0-33-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.15.0-33.36](https://launchpad.net/ubuntu/%2Bsource/linux/4.15.0-33.36)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2018-1000200](/security/CVE-2018-1000200)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10840](/security/CVE-2018-10840)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-1108](/security/CVE-2018-1108)
* [CVE-2018-1120](/security/CVE-2018-1120)
* [CVE-2018-11412](/security/CVE-2018-11412)
* [CVE-2018-11506](/security/CVE-2018-11506)
* [CVE-2018-12232](/security/CVE-2018-12232)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-12904](/security/CVE-2018-12904)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)
* [CVE-2018-5814](/security/CVE-2018-5814)
* [CVE-2018-9415](/security/CVE-2018-9415)

## Related notices

* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-3](/security/notices/USN-3752-3)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3910-2](/security/notices/USN-3910-2)
* [USN-3910-1](/security/notices/USN-3910-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from github.com_2bfd8b69_20250125_205805.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9f645bcc566a1e9f921bdae7528a01ced5bc3713)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9f645bcc566a1e9f921bdae7528a01ced5bc3713)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/9f645bcc566a1e9f921bdae7528a01ced5bc3713)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

video: uvesafb: Fix integer overflow in allocation

[Browse files](/torvalds/linux/tree/9f645bcc566a1e9f921bdae7528a01ced5bc3713)
Browse the repository at this point in the history

```
cmap->len can get close to INT_MAX/2, allowing for an integer overflow in
allocation. This uses kmalloc_array() instead to catch the condition.

Reported-by: Dr Silvio Cesare of InfoSect <silvio.cesare@gmail.com>
Fixes: [8bdb3a2](https://github.com/torvalds/linux/commit/8bdb3a2d7df48b861972c4bfb58490853a228f51) ("uvesafb: the driver core")
Cc: stable@vger.kernel.org
Signed-off-by: Kees Cook <keescook@chromium.org>
```

* Loading branch information

[![@kees](https://avatars.githubusercontent.com/u/1110841?s=40&v=4)](/kees)

[kees](/torvalds/linux/commits?author=kees "View all commits by kees")
committed
Jun 12, 2018

1 parent
[353748a](/torvalds/linux/commit/353748a359f1821ee934afc579cf04572406b420)

commit 9f645bc

Showing
**1 changed file**
with
**2 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[drivers/video/fbdev/uvesafb.c](#diff-586e31943f98cd76d17bc8db879e5cbd11abd17431c1bd8e43778c53b795b1b6 "drivers/video/fbdev/uvesafb.c")

Show comments

[View file](/torvalds/linux/blob/9f645bcc566a1e9f921bdae7528a01ced5bc3713/drivers/video/fbdev/uvesafb.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1044,7 +1044,8 @@ static int uvesafb\_setcmap(struct fb\_cmap \*cmap, struct fb\_info \*info) |
|  |  | info->cmap.len || cmap->start < info->cmap.start) |
|  |  | return -EINVAL; |
|  |  |  |
|  |  | entries = kmalloc(sizeof(\*entries) \* cmap->len, GFP\_KERNEL); |
|  |  | entries = kmalloc\_array(cmap->len, sizeof(\*entries), |
|  |  | GFP\_KERNEL); |
|  |  | if (!entries) |
|  |  | return -ENOMEM; |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9f645bc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F9f645bcc566a1e9f921bdae7528a01ced5bc3713) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from usn.ubuntu.com_ad850d84_20250125_205808.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3752-2: Linux kernel (HWE) vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux-hwe](/security/cves?package=linux-hwe) - Linux hardware enablement (HWE) kernel

## Details

USN-3752-1 fixed vulnerabilities in the Linux kernel for Ubuntu 18.04

LTS. This update provides the corresponding updates for the Linux

Hardware Enablement (HWE) kernel from Ubuntu 18.04 LTS for Ubuntu

16.04 LTS.

It was discovered that, when attempting to handle an out-of-memory

situation, a null pointer dereference could be triggered in the Linux

kernel in some circumstances. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2018-1000200](/security/CVE-2018-1000200))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate xattr information. An attacker could use

this to construct a malicious xfs image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10840](/security/CVE-2018-10840))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

Jann Horn discovered that the Linux kernel's implementation of random seed

data reported that it was in a ready state before it had gathered

sufficient entropy. An attacker could use this to expose sensitive

information. ([CVE-2018-1108](/security/CVE-2018-1108))

It was discovered that the procfs filesystem did not properly handle

processes mapping some memory elements onto files. A local attacker could

use this to block utilities that examine the procfs filesystem to report

operating system state, such as ps(1). ([CVE-2018-1120](/security/CVE-2018-1120))

Jann Horn discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep xattr information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11412](/security/CVE-2018-11412))

Piotr Gabriel Kosinski and Daniel Shapira discovered a stack-based buffer

overflow in the CDROM driver implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11506](/security/CVE-2018-11506))

Shankara Pailoor discovered that a race condition existed in the socket

handling code in the Linux kernel. A local attacker could use this to cause

a denial of service (system crash). ([CVE-2018-12232](/security/CVE-2018-12232))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Felix Wilhelm discovered that the KVM implementation in the Linux kernel

did not properly perform permission checks in some situations when nested

virtualization is used. An attacker in a guest VM could possibly use this

to escape into an outer VM or the host OS. ([CVE-2018-12904](/security/CVE-2018-12904))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Jakub Jirasek discovered that multiple use-after-free errors existed in the

USB/IP implementation in the Linux kernel. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5814](/security/CVE-2018-5814))

It was discovered that a race condition existed in the ARM Advanced

Microcontroller Bus Architecture (AMBA) driver in the Linux kernel that

could result in a double free. A local attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-9415](/security/CVE-2018-9415))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.15.0-33-generic](https://launchpad.net/ubuntu/%2Bsource/linux-hwe)
  -
  [4.15.0-33.36~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-hwe/4.15.0-33.36~16.04.1)
* [linux-image-4.15.0-33-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-hwe)
  -
  [4.15.0-33.36~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-hwe/4.15.0-33.36~16.04.1)
* [linux-image-4.15.0-33-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-hwe)
  -
  [4.15.0-33.36~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-hwe/4.15.0-33.36~16.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2018-1000200](/security/CVE-2018-1000200)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10840](/security/CVE-2018-10840)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-1108](/security/CVE-2018-1108)
* [CVE-2018-1120](/security/CVE-2018-1120)
* [CVE-2018-11412](/security/CVE-2018-11412)
* [CVE-2018-11506](/security/CVE-2018-11506)
* [CVE-2018-12232](/security/CVE-2018-12232)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-12904](/security/CVE-2018-12904)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)
* [CVE-2018-5814](/security/CVE-2018-5814)
* [CVE-2018-9415](/security/CVE-2018-9415)

## Related notices

* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3910-2](/security/notices/USN-3910-2)
* [USN-3910-1](/security/notices/USN-3910-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from usn.ubuntu.com_37a1a987_20250125_205814.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3754-1: Linux kernel vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel

## Details

Ralf Spenneberg discovered that the ext4 implementation in the Linux kernel

did not properly validate meta block groups. An attacker with physical

access could use this to specially craft an ext4 image that causes a denial

of service (system crash). ([CVE-2016-10208](/security/CVE-2016-10208))

It was discovered that an information disclosure vulnerability existed in

the ACPI implementation of the Linux kernel. A local attacker could use

this to expose sensitive information (kernel memory addresses).

([CVE-2017-11472](/security/CVE-2017-11472))

It was discovered that a buffer overflow existed in the ACPI table parsing

implementation in the Linux kernel. A local attacker could use this to

construct a malicious ACPI table that, when loaded, caused a denial of

service (system crash) or possibly execute arbitrary code.

([CVE-2017-11473](/security/CVE-2017-11473))

It was discovered that the generic SCSI driver in the Linux kernel did not

properly initialize data returned to user space in some situations. A local

attacker could use this to expose sensitive information (kernel memory).

([CVE-2017-14991](/security/CVE-2017-14991))

It was discovered that a race condition existed in the packet fanout

implementation in the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-15649](/security/CVE-2017-15649))

Andrey Konovalov discovered that the Ultra Wide Band driver in the Linux

kernel did not properly check for an error condition. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16526](/security/CVE-2017-16526))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel

contained a use-after-free vulnerability. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16527](/security/CVE-2017-16527))

Andrey Konovalov discovered that the ALSA subsystem in the Linux kernel did

not properly validate USB audio buffer descriptors. A physically proximate

attacker could use this cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2017-16529](/security/CVE-2017-16529))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB interface association descriptors. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16531](/security/CVE-2017-16531))

Andrey Konovalov discovered that the usbtest device driver in the Linux

kernel did not properly validate endpoint metadata. A physically proximate

attacker could use this to cause a denial of service (system crash).

([CVE-2017-16532](/security/CVE-2017-16532))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB HID descriptors. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16533](/security/CVE-2017-16533))

Andrey Konovalov discovered that the USB subsystem in the Linux kernel did

not properly validate USB BOS metadata. A physically proximate attacker

could use this to cause a denial of service (system crash).

([CVE-2017-16535](/security/CVE-2017-16535))

Andrey Konovalov discovered that the Conexant cx231xx USB video capture

driver in the Linux kernel did not properly validate interface descriptors.

A physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16536](/security/CVE-2017-16536))

Andrey Konovalov discovered that the SoundGraph iMON USB driver in the

Linux kernel did not properly validate device metadata. A physically

proximate attacker could use this to cause a denial of service (system

crash). ([CVE-2017-16537](/security/CVE-2017-16537))

It was discovered that the DM04/QQBOX USB driver in the Linux kernel did

not properly handle device attachment and warm-start. A physically

proximate attacker could use this to cause a denial of service (system

crash) or possibly execute arbitrary code. ([CVE-2017-16538](/security/CVE-2017-16538))

Andrey Konovalov discovered an out-of-bounds read in the GTCO digitizer USB

driver for the Linux kernel. A physically proximate attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-16643](/security/CVE-2017-16643))

Andrey Konovalov discovered that the video4linux driver for Hauppauge HD

PVR USB devices in the Linux kernel did not properly handle some error

conditions. A physically proximate attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2017-16644](/security/CVE-2017-16644))

Andrey Konovalov discovered that the IMS Passenger Control Unit USB driver

in the Linux kernel did not properly validate device descriptors. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-16645](/security/CVE-2017-16645))

Andrey Konovalov discovered that the QMI WWAN USB driver did not properly

validate device descriptors. A physically proximate attacker could use this

to cause a denial of service (system crash). ([CVE-2017-16650](/security/CVE-2017-16650))

It was discovered that the USB Virtual Host Controller Interface (VHCI)

driver in the Linux kernel contained an information disclosure

vulnerability. A physically proximate attacker could use this to expose

sensitive information (kernel memory). ([CVE-2017-16911](/security/CVE-2017-16911))

It was discovered that the USB over IP implementation in the Linux kernel

did not validate endpoint numbers. A remote attacker could use this to

cause a denial of service (system crash). ([CVE-2017-16912](/security/CVE-2017-16912))

It was discovered that the USB over IP implementation in the Linux kernel

did not properly validate CMD\_SUBMIT packets. A remote attacker could use

this to cause a denial of service (excessive memory consumption).

([CVE-2017-16913](/security/CVE-2017-16913))

It was discovered that the USB over IP implementation in the Linux kernel

contained a NULL pointer dereference error. A remote attacker could use

this to cause a denial of service (system crash). ([CVE-2017-16914](/security/CVE-2017-16914))

It was discovered that the core USB subsystem in the Linux kernel did not

validate the number of configurations and interfaces in a device. A

physically proximate attacker could use this to cause a denial of service

(system crash). ([CVE-2017-17558](/security/CVE-2017-17558))

It was discovered that an integer overflow existed in the perf subsystem of

the Linux kernel. A local attacker could use this to cause a denial of

service (system crash). ([CVE-2017-18255](/security/CVE-2017-18255))

It was discovered that the keyring subsystem in the Linux kernel did not

properly prevent a user from creating keyrings for other users. A local

attacker could use this cause a denial of service or expose sensitive

information. ([CVE-2017-18270](/security/CVE-2017-18270))

Andy Lutomirski and Willy Tarreau discovered that the KVM implementation in

the Linux kernel did not properly emulate instructions on the SS segment

register. A local attacker in a guest virtual machine could use this to

cause a denial of service (guest OS crash) or possibly gain administrative

privileges in the guest OS. ([CVE-2017-2583](/security/CVE-2017-2583))

Dmitry Vyukov discovered that the KVM implementation in the Linux kernel

improperly emulated certain instructions. A local attacker could use this

to obtain sensitive information (kernel memory). ([CVE-2017-2584](/security/CVE-2017-2584))

It was discovered that the KLSI KL5KUSB105 serial-to-USB device driver in

the Linux kernel did not properly initialize memory related to logging. A

local attacker could use this to expose sensitive information (kernel

memory). ([CVE-2017-5549](/security/CVE-2017-5549))

Andrey Konovalov discovered an out-of-bounds access in the IPv6 Generic

Routing Encapsulation (GRE) tunneling implementation in the Linux kernel.

An attacker could use this to possibly expose sensitive information.

([CVE-2017-5897](/security/CVE-2017-5897))

Andrey Konovalov discovered that the LLC subsytem in the Linux kernel did

not properly set up a destructor in certain situations. A local attacker

could use this to cause a denial of service (system crash). ([CVE-2017-6345](/security/CVE-2017-6345))

Dmitry Vyukov discovered race conditions in the Infrared (IrDA) subsystem

in the Linux kernel. A local attacker could use this to cause a denial of

service (deadlock). ([CVE-2017-6348](/security/CVE-2017-6348))

Andy Lutomirski discovered that the KVM implementation in the Linux kernel

was vulnerable to a debug exception error when single-stepping through a

syscall. A local attacker in a non-Linux guest vm could possibly use this

to gain administrative privileges in the guest vm. ([CVE-2017-7518](/security/CVE-2017-7518))

Tuomas HaanpÃ¤Ã¤ and Ari Kauppi discovered that the NFSv2 and NFSv3 server

implementations in the Linux kernel did not properly handle certain long

RPC replies. A remote attacker could use this to cause a denial of service

(system crash). ([CVE-2017-7645](/security/CVE-2017-7645))

Pengfei Wang discovered that a race condition existed in the NXP SAA7164 TV

Decoder driver for the Linux kernel. A local attacker could use this to

cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2017-8831](/security/CVE-2017-8831))

Pengfei Wang discovered that the Turtle Beach MultiSound audio device

driver in the Linux kernel contained race conditions when fetching from the

ring-buffer. A local attacker could use this to cause a denial of service

(infinite loop). ([CVE-2017-9984](/security/CVE-2017-9984), [CVE-2017-9985](/security/CVE-2017-9985))

It was discovered that the wait4() system call in the Linux kernel did not

properly validate its arguments in some situations. A local attacker could

possibly use this to cause a denial of service. ([CVE-2018-10087](/security/CVE-2018-10087))

It was discovered that the kill() system call implementation in the Linux

kernel did not properly validate its arguments in some situations. A local

attacker could possibly use this to cause a denial of service.

([CVE-2018-10124](/security/CVE-2018-10124))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Zhong Jiang discovered that a use-after-free vulnerability existed in the

NUMA memory policy implementation in the Linux kernel. A local attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2018-10675](/security/CVE-2018-10675))

Wen Xu discovered that a buffer overflow existed in the ext4 filesystem

implementation in the Linux kernel. An attacker could use this to construct

a malicious ext4 image that, when mounted, could cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2018-10877](/security/CVE-2018-10877))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused

a denial of service (system crash) when mounted. ([CVE-2018-1092](/security/CVE-2018-1092))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

It was discovered that the cdrom driver in the Linux kernel contained an

incorrect bounds check. A local attacker could use this to expose sensitive

information (kernel memory). ([CVE-2018-10940](/security/CVE-2018-10940))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Daniel Jiang discovered that a race condition existed in the ipv4 ping

socket implementation in the Linux kernel. A local privileged attacker

could use this to cause a denial of service (system crash). ([CVE-2017-2671](/security/CVE-2017-2671))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

It was discovered that a memory leak existed in the Serial Attached SCSI

(SAS) implementation in the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (memory exhaustion).

([CVE-2018-10021](/security/CVE-2018-10021))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-3.13.0-157-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)
* [linux-image-3.13.0-157-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [3.13.0-157.207](https://launchpad.net/ubuntu/%2Bsource/linux/3.13.0-157.207)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2016-10208](/security/CVE-2016-10208)
* [CVE-2017-11472](/security/CVE-2017-11472)
* [CVE-2017-11473](/security/CVE-2017-11473)
* [CVE-2017-14991](/security/CVE-2017-14991)
* [CVE-2017-15649](/security/CVE-2017-15649)
* [CVE-2017-16526](/security/CVE-2017-16526)
* [CVE-2017-16527](/security/CVE-2017-16527)
* [CVE-2017-16529](/security/CVE-2017-16529)
* [CVE-2017-16531](/security/CVE-2017-16531)
* [CVE-2017-16532](/security/CVE-2017-16532)
* [CVE-2017-16533](/security/CVE-2017-16533)
* [CVE-2017-16535](/security/CVE-2017-16535)
* [CVE-2017-16536](/security/CVE-2017-16536)
* [CVE-2017-16537](/security/CVE-2017-16537)
* [CVE-2017-16538](/security/CVE-2017-16538)
* [CVE-2017-16643](/security/CVE-2017-16643)
* [CVE-2017-16644](/security/CVE-2017-16644)
* [CVE-2017-16645](/security/CVE-2017-16645)
* [CVE-2017-16650](/security/CVE-2017-16650)
* [CVE-2017-16911](/security/CVE-2017-16911)
* [CVE-2017-16912](/security/CVE-2017-16912)
* [CVE-2017-16913](/security/CVE-2017-16913)
* [CVE-2017-16914](/security/CVE-2017-16914)
* [CVE-2017-17558](/security/CVE-2017-17558)
* [CVE-2017-18255](/security/CVE-2017-18255)
* [CVE-2017-18270](/security/CVE-2017-18270)
* [CVE-2017-2583](/security/CVE-2017-2583)
* [CVE-2017-2584](/security/CVE-2017-2584)
* [CVE-2017-2671](/security/CVE-2017-2671)
* [CVE-2017-5549](/security/CVE-2017-5549)
* [CVE-2017-5897](/security/CVE-2017-5897)
* [CVE-2017-6345](/security/CVE-2017-6345)
* [CVE-2017-6348](/security/CVE-2017-6348)
* [CVE-2017-7518](/security/CVE-2017-7518)
* [CVE-2017-7645](/security/CVE-2017-7645)
* [CVE-2017-8831](/security/CVE-2017-8831)
* [CVE-2017-9984](/security/CVE-2017-9984)
* [CVE-2017-9985](/security/CVE-2017-9985)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10021](/security/CVE-2018-10021)
* [CVE-2018-10087](/security/CVE-2018-10087)
* [CVE-2018-10124](/security/CVE-2018-10124)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10675](/security/CVE-2018-10675)
* [CVE-2018-10877](/security/CVE-2018-10877)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1092](/security/CVE-2018-1092)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-10940](/security/CVE-2018-10940)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)

## Related notices

* [USN-3361-1](/security/notices/USN-3361-1)
* [USN-3234-2](/security/notices/USN-3234-2)
* [USN-3234-1](/security/notices/USN-3234-1)
* [USN-3619-2](/security/notices/USN-3619-2)
* [USN-3619-1](/security/notices/USN-3619-1)
* [USN-3469-1](/security/notices/USN-3469-1)
* [USN-3469-2](/security/notices/USN-3469-2)
* [USN-3487-1](/security/notices/USN-3487-1)
* [USN-3485-1](/security/notices/USN-3485-1)
* [USN-3485-3](/security/notices/USN-3485-3)
* [USN-3485-2](/security/notices/USN-3485-2)
* [USN-3617-1](/security/notices/USN-3617-1)
* [USN-3617-3](/security/notices/USN-3617-3)
* [USN-3617-2](/security/notices/USN-3617-2)
* [USN-3507-1](/security/notices/USN-3507-1)
* [USN-3631-2](/security/notices/USN-3631-2)
* [USN-3631-1](/security/notices/USN-3631-1)
* [USN-3509-1](/security/notices/USN-3509-1)
* [USN-3509-2](/security/notices/USN-3509-2)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3208-1](/security/notices/USN-3208-1)
* [USN-3208-2](/security/notices/USN-3208-2)
* [USN-3314-1](/security/notices/USN-3314-1)
* [USN-3312-2](/security/notices/USN-3312-2)
* [USN-3312-1](/security/notices/USN-3312-1)
* [USN-3265-1](/security/notices/USN-3265-1)
* [USN-3265-2](/security/notices/USN-3265-2)
* [USN-3420-1](/security/notices/USN-3420-1)
* [USN-3420-2](/security/notices/USN-3420-2)
* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)
* [USN-3678-4](/security/notices/USN-3678-4)
* [USN-3678-3](/security/notices/USN-3678-3)
* [USN-3678-1](/security/notices/USN-3678-1)
* [USN-3678-2](/security/notices/USN-3678-2)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3871-4](/security/notices/USN-3871-4)
* [USN-3871-1](/security/notices/USN-3871-1)
* [USN-3871-5](/security/notices/USN-3871-5)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3871-3](/security/notices/USN-3871-3)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3677-1](/security/notices/USN-3677-1)
* [USN-3677-2](/security/notices/USN-3677-2)
* [USN-3695-2](/security/notices/USN-3695-2)
* [USN-3695-1](/security/notices/USN-3695-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from usn.ubuntu.com_fb7a5ea9_20250125_205811.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3753-1: Linux kernel vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Snapdragon processors

## Details

It was discovered that the generic SCSI driver in the Linux kernel did not

properly enforce permissions on kernel memory access. A local attacker

could use this to expose sensitive information or possibly elevate

privileges. ([CVE-2017-13168](/security/CVE-2017-13168))

Wen Xu discovered that a use-after-free vulnerability existed in the ext4

filesystem implementation in the Linux kernel. An attacker could use this

to construct a malicious ext4 image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10876](/security/CVE-2018-10876), [CVE-2018-10879](/security/CVE-2018-10879))

Wen Xu discovered that a buffer overflow existed in the ext4 filesystem

implementation in the Linux kernel. An attacker could use this to construct

a malicious ext4 image that, when mounted, could cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2018-10877](/security/CVE-2018-10877))

Wen Xu discovered that an out-of-bounds write vulnerability existed in the

ext4 filesystem implementation in the Linux kernel. An attacker could use

this to construct a malicious ext4 image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10878](/security/CVE-2018-10878), [CVE-2018-10882](/security/CVE-2018-10882))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1032-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.4.0-1032.38](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.4.0-1032.38)
* [linux-image-4.4.0-1066-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1066.76](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1066.76)
* [linux-image-4.4.0-1095-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1095.103](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1095.103)
* [linux-image-4.4.0-1099-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.4.0-1099.104](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.4.0-1099.104)
* [linux-image-4.4.0-134-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)
* [linux-image-4.4.0-134-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-134.160](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-134.160)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-13168](/security/CVE-2017-13168)
* [CVE-2018-10876](/security/CVE-2018-10876)
* [CVE-2018-10877](/security/CVE-2018-10877)
* [CVE-2018-10878](/security/CVE-2018-10878)
* [CVE-2018-10879](/security/CVE-2018-10879)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-10882](/security/CVE-2018-10882)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)

## Related notices

* [USN-3820-3](/security/notices/USN-3820-3)
* [USN-3820-2](/security/notices/USN-3820-2)
* [USN-3820-1](/security/notices/USN-3820-1)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3871-4](/security/notices/USN-3871-4)
* [USN-3871-1](/security/notices/USN-3871-1)
* [USN-3871-5](/security/notices/USN-3871-5)
* [USN-3871-3](/security/notices/USN-3871-3)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from usn.ubuntu.com_a069f187_20250125_205810.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3752-3: Linux kernel (Azure, GCP, OEM) vulnerabilities

28 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 18.04 ESM](/security/notices?release=bionic)
* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux-azure](/security/cves?package=linux-azure) - Linux kernel for Microsoft Azure Cloud systems
* [linux-gcp](/security/cves?package=linux-gcp) - Linux kernel for Google Cloud Platform (GCP) systems
* [linux-oem](/security/cves?package=linux-oem) - Linux kernel for OEM processors

## Details

It was discovered that, when attempting to handle an out-of-memory

situation, a null pointer dereference could be triggered in the Linux

kernel in some circumstances. A local attacker could use this to cause a

denial of service (system crash). ([CVE-2018-1000200](/security/CVE-2018-1000200))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate meta-data information. An attacker could

use this to construct a malicious xfs image that, when mounted, could cause

a denial of service (system crash). ([CVE-2018-10323](/security/CVE-2018-10323))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly validate xattr information. An attacker could use

this to construct a malicious xfs image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10840](/security/CVE-2018-10840))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly handle corrupted meta data in some situations. An

attacker could use this to specially craft an ext4 filesystem that caused a

denial of service (system crash) when mounted. ([CVE-2018-1093](/security/CVE-2018-1093))

Jann Horn discovered that the Linux kernel's implementation of random seed

data reported that it was in a ready state before it had gathered

sufficient entropy. An attacker could use this to expose sensitive

information. ([CVE-2018-1108](/security/CVE-2018-1108))

It was discovered that the procfs filesystem did not properly handle

processes mapping some memory elements onto files. A local attacker could

use this to block utilities that examine the procfs filesystem to report

operating system state, such as ps(1). ([CVE-2018-1120](/security/CVE-2018-1120))

Jann Horn discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep xattr information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11412](/security/CVE-2018-11412))

Piotr Gabriel Kosinski and Daniel Shapira discovered a stack-based buffer

overflow in the CDROM driver implementation of the Linux kernel. A local

attacker could use this to cause a denial of service (system crash) or

possibly execute arbitrary code. ([CVE-2018-11506](/security/CVE-2018-11506))

Shankara Pailoor discovered that a race condition existed in the socket

handling code in the Linux kernel. A local attacker could use this to cause

a denial of service (system crash). ([CVE-2018-12232](/security/CVE-2018-12232))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Felix Wilhelm discovered that the KVM implementation in the Linux kernel

did not properly perform permission checks in some situations when nested

virtualization is used. An attacker in a guest VM could possibly use this

to escape into an outer VM or the host OS. ([CVE-2018-12904](/security/CVE-2018-12904))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

Jakub Jirasek discovered that multiple use-after-free errors existed in the

USB/IP implementation in the Linux kernel. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-5814](/security/CVE-2018-5814))

It was discovered that a race condition existed in the ARM Advanced

Microcontroller Bus Architecture (AMBA) driver in the Linux kernel that

could result in a double free. A local attacker could use this to cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-9415](/security/CVE-2018-9415))

It was discovered that an information leak existed in the generic SCSI

driver in the Linux kernel. A local attacker could use this to expose

sensitive information (kernel memory). ([CVE-2018-1000204](/security/CVE-2018-1000204))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 18.04

##### Ubuntu 16.04

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2018-1000200](/security/CVE-2018-1000200)
* [CVE-2018-1000204](/security/CVE-2018-1000204)
* [CVE-2018-10323](/security/CVE-2018-10323)
* [CVE-2018-10840](/security/CVE-2018-10840)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-1093](/security/CVE-2018-1093)
* [CVE-2018-1108](/security/CVE-2018-1108)
* [CVE-2018-1120](/security/CVE-2018-1120)
* [CVE-2018-11412](/security/CVE-2018-11412)
* [CVE-2018-11506](/security/CVE-2018-11506)
* [CVE-2018-12232](/security/CVE-2018-12232)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-12904](/security/CVE-2018-12904)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)
* [CVE-2018-5814](/security/CVE-2018-5814)
* [CVE-2018-9415](/security/CVE-2018-9415)

## Related notices

* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3696-2](/security/notices/USN-3696-2)
* [USN-3696-1](/security/notices/USN-3696-1)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-4486-1](/security/notices/USN-4486-1)
* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3753-2](/security/notices/USN-3753-2)
* [USN-3676-1](/security/notices/USN-3676-1)
* [USN-3676-2](/security/notices/USN-3676-2)
* [USN-3910-2](/security/notices/USN-3910-2)
* [USN-3910-1](/security/notices/USN-3910-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from usn.ubuntu.com_61b3d872_20250125_205813.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3753-2: Linux kernel (Xenial HWE) vulnerabilities

24 August 2018

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty

## Details

USN-3753-1 fixed vulnerabilities in the Linux kernel for Ubuntu 16.04

LTS. This update provides the corresponding updates for the Linux

Hardware Enablement (HWE) kernel from Ubuntu 16.04 LTS for Ubuntu

14.04 LTS.

It was discovered that the generic SCSI driver in the Linux kernel did not

properly enforce permissions on kernel memory access. A local attacker

could use this to expose sensitive information or possibly elevate

privileges. ([CVE-2017-13168](/security/CVE-2017-13168))

Wen Xu discovered that a use-after-free vulnerability existed in the ext4

filesystem implementation in the Linux kernel. An attacker could use this

to construct a malicious ext4 image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10876](/security/CVE-2018-10876), [CVE-2018-10879](/security/CVE-2018-10879))

Wen Xu discovered that a buffer overflow existed in the ext4 filesystem

implementation in the Linux kernel. An attacker could use this to construct

a malicious ext4 image that, when mounted, could cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2018-10877](/security/CVE-2018-10877))

Wen Xu discovered that an out-of-bounds write vulnerability existed in the

ext4 filesystem implementation in the Linux kernel. An attacker could use

this to construct a malicious ext4 image that, when mounted, could cause a

denial of service (system crash) or possibly execute arbitrary code.

([CVE-2018-10878](/security/CVE-2018-10878), [CVE-2018-10882](/security/CVE-2018-10882))

Wen Xu discovered that the ext4 filesystem implementation in the Linux

kernel did not properly keep meta-data information consistent in some

situations. An attacker could use this to construct a malicious ext4 image

that, when mounted, could cause a denial of service (system crash).

([CVE-2018-10881](/security/CVE-2018-10881))

Shankara Pailoor discovered that the JFS filesystem implementation in the

Linux kernel contained a buffer overflow when handling extended attributes.

A local attacker could use this to cause a denial of service (system crash)

or possibly execute arbitrary code. ([CVE-2018-12233](/security/CVE-2018-12233))

Wen Xu discovered that the XFS filesystem implementation in the Linux

kernel did not properly handle an error condition with a corrupted xfs

image. An attacker could use this to construct a malicious xfs image that,

when mounted, could cause a denial of service (system crash).

([CVE-2018-13094](/security/CVE-2018-13094))

It was discovered that the Linux kernel did not properly handle setgid file

creation when performed by a non-member of the group. A local attacker

could use this to gain elevated privileges. ([CVE-2018-13405](/security/CVE-2018-13405))

Silvio Cesare discovered that the generic VESA frame buffer driver in the

Linux kernel contained an integer overflow. A local attacker could use this

to cause a denial of service (system crash) or possibly execute arbitrary

code. ([CVE-2018-13406](/security/CVE-2018-13406))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-4.4.0-1028-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1028.31](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1028.31)
* [linux-image-4.4.0-134-generic](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)
* [linux-image-4.4.0-134-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-134.160~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-134.160~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2017-13168](/security/CVE-2017-13168)
* [CVE-2018-10876](/security/CVE-2018-10876)
* [CVE-2018-10877](/security/CVE-2018-10877)
* [CVE-2018-10878](/security/CVE-2018-10878)
* [CVE-2018-10879](/security/CVE-2018-10879)
* [CVE-2018-10881](/security/CVE-2018-10881)
* [CVE-2018-10882](/security/CVE-2018-10882)
* [CVE-2018-12233](/security/CVE-2018-12233)
* [CVE-2018-13094](/security/CVE-2018-13094)
* [CVE-2018-13405](/security/CVE-2018-13405)
* [CVE-2018-13406](/security/CVE-2018-13406)

## Related notices

* [USN-3753-1](/security/notices/USN-3753-1)
* [USN-3820-3](/security/notices/USN-3820-3)
* [USN-3820-2](/security/notices/USN-3820-2)
* [USN-3820-1](/security/notices/USN-3820-1)
* [USN-3822-2](/security/notices/USN-3822-2)
* [USN-3822-1](/security/notices/USN-3822-1)
* [USN-3871-4](/security/notices/USN-3871-4)
* [USN-3871-1](/security/notices/USN-3871-1)
* [USN-3871-5](/security/notices/USN-3871-5)
* [USN-3871-3](/security/notices/USN-3871-3)
* [USN-3754-1](/security/notices/USN-3754-1)
* [USN-3752-2](/security/notices/USN-3752-2)
* [USN-3752-1](/security/notices/USN-3752-1)
* [USN-3752-3](/security/notices/USN-3752-3)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

Â© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from cdn.kernel.org_2a771bec_20250125_205804.html ===
commit bdeb8f5efe9013844a20585b6a86ceff672d9d33
Author: Greg Kroah-Hartman
Date: Tue Jul 3 11:27:13 2018 +0200
Linux 4.17.4
commit a61b352a7c23191108ae0c747a170f6bce5b154a
Author: Wenwen Wang
Date: Tue May 8 08:50:28 2018 -0500
virt: vbox: Only copy\_from\_user the request-header once
commit bd23a7269834dc7c1f93e83535d16ebc44b75eba upstream.
In vbg\_misc\_device\_ioctl(), the header of the ioctl argument is copied from
the userspace pointer 'arg' and saved to the kernel object 'hdr'. Then the
'version', 'size\_in', and 'size\_out' fields of 'hdr' are verified.
Before this commit, after the checks a buffer for the entire request would
be allocated and then all data including the verified header would be
copied from the userspace 'arg' pointer again.
Given that the 'arg' pointer resides in userspace, a malicious userspace
process can race to change the data pointed to by 'arg' between the two
copies. By doing so, the user can bypass the verifications on the ioctl
argument.
This commit fixes this by using the already checked copy of the header
to fill the header part of the allocated buffer and only copying the
remainder of the data from userspace.
Signed-off-by: Wenwen Wang
Reviewed-by: Hans de Goede
Cc: Justin Forbes
Signed-off-by: Greg Kroah-Hartman
commit c91aad666676e5e5055a5427815a18f0d3fa6661
Author: Mike Snitzer
Date: Tue Jun 26 12:04:23 2018 -0400
dm thin: handle running out of data space vs concurrent discard
commit a685557fbbc3122ed11e8ad3fa63a11ebc5de8c3 upstream.
Discards issued to a DM thin device can complete to userspace (via
fstrim) \_before\_ the metadata changes associated with the discards is
reflected in the thinp superblock (e.g. free blocks). As such, if a
user constructs a test that loops repeatedly over these steps, block
allocation can fail due to discards not having completed yet:
1) fill thin device via filesystem file
2) remove file
3) fstrim
From initial report, here:
https://www.redhat.com/archives/dm-devel/2018-April/msg00022.html
"The root cause of this issue is that dm-thin will first remove
mapping and increase corresponding blocks' reference count to prevent
them from being reused before DISCARD bios get processed by the
underlying layers. However. increasing blocks' reference count could
also increase the nr\_allocated\_this\_transaction in struct sm\_disk
which makes smd->old\_ll.nr\_allocated +
smd->nr\_allocated\_this\_transaction bigger than smd->old\_ll.nr\_blocks.
In this case, alloc\_data\_block() will never commit metadata to reset
the begin pointer of struct sm\_disk, because sm\_disk\_get\_nr\_free()
always return an underflow value."
While there is room for improvement to the space-map accounting that
thinp is making use of: the reality is this test is inherently racey and
will result in the previous iteration's fstrim's discard(s) completing
vs concurrent block allocation, via dd, in the next iteration of the
loop.
No amount of space map accounting improvements will be able to allow
user's to use a block before a discard of that block has completed.
So the best we can really do is allow DM thinp to gracefully handle such
aggressive use of all the pool's data by degrading the pool into
out-of-data-space (OODS) mode. We \_should\_ get that behaviour already
(if space map accounting didn't falsely cause alloc\_data\_block() to
believe free space was available).. but short of that we handle the
current reality that dm\_pool\_alloc\_data\_block() can return -ENOSPC.
Reported-by: Dennis Yang
Cc: stable@vger.kernel.org
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit 5b9fbf51d472837a8629483772337c1e2c27d499
Author: Bart Van Assche
Date: Fri Jun 22 08:09:11 2018 -0700
dm zoned: avoid triggering reclaim from inside dmz\_map()
commit 2d0b2d64d325e22939d9db3ba784f1236459ed98 upstream.
This patch avoids that lockdep reports the following:
======================================================
WARNING: possible circular locking dependency detected
4.18.0-rc1 #62 Not tainted
------------------------------------------------------
kswapd0/84 is trying to acquire lock:
00000000c313516d (&xfs\_nondir\_ilock\_class){++++}, at: xfs\_free\_eofblocks+0xa2/0x1e0
but task is already holding lock:
00000000591c83ae (fs\_reclaim){+.+.}, at: \_\_fs\_reclaim\_acquire+0x5/0x30
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #2 (fs\_reclaim){+.+.}:
kmem\_cache\_alloc+0x2c/0x2b0
radix\_tree\_node\_alloc.constprop.19+0x3d/0xc0
\_\_radix\_tree\_create+0x161/0x1c0
\_\_radix\_tree\_insert+0x45/0x210
dmz\_map+0x245/0x2d0 [dm\_zoned]
\_\_map\_bio+0x40/0x260
\_\_split\_and\_process\_non\_flush+0x116/0x220
\_\_split\_and\_process\_bio+0x81/0x180
\_\_dm\_make\_request.isra.32+0x5a/0x100
generic\_make\_request+0x36e/0x690
submit\_bio+0x6c/0x140
mpage\_readpages+0x19e/0x1f0
read\_pages+0x6d/0x1b0
\_\_do\_page\_cache\_readahead+0x21b/0x2d0
force\_page\_cache\_readahead+0xc4/0x100
generic\_file\_read\_iter+0x7c6/0xd20
\_\_vfs\_read+0x102/0x180
vfs\_read+0x9b/0x140
ksys\_read+0x55/0xc0
do\_syscall\_64+0x5a/0x1f0
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
-> #1 (&dmz->chunk\_lock){+.+.}:
dmz\_map+0x133/0x2d0 [dm\_zoned]
\_\_map\_bio+0x40/0x260
\_\_split\_and\_process\_non\_flush+0x116/0x220
\_\_split\_and\_process\_bio+0x81/0x180
\_\_dm\_make\_request.isra.32+0x5a/0x100
generic\_make\_request+0x36e/0x690
submit\_bio+0x6c/0x140
\_xfs\_buf\_ioapply+0x31c/0x590
xfs\_buf\_submit\_wait+0x73/0x520
xfs\_buf\_read\_map+0x134/0x2f0
xfs\_trans\_read\_buf\_map+0xc3/0x580
xfs\_read\_agf+0xa5/0x1e0
xfs\_alloc\_read\_agf+0x59/0x2b0
xfs\_alloc\_pagf\_init+0x27/0x60
xfs\_bmap\_longest\_free\_extent+0x43/0xb0
xfs\_bmap\_btalloc\_nullfb+0x7f/0xf0
xfs\_bmap\_btalloc+0x428/0x7c0
xfs\_bmapi\_write+0x598/0xcc0
xfs\_iomap\_write\_allocate+0x15a/0x330
xfs\_map\_blocks+0x1cf/0x3f0
xfs\_do\_writepage+0x15f/0x7b0
write\_cache\_pages+0x1ca/0x540
xfs\_vm\_writepages+0x65/0xa0
do\_writepages+0x48/0xf0
\_\_writeback\_single\_inode+0x58/0x730
writeback\_sb\_inodes+0x249/0x5c0
wb\_writeback+0x11e/0x550
wb\_workfn+0xa3/0x670
process\_one\_work+0x228/0x670
worker\_thread+0x3c/0x390
kthread+0x11c/0x140
ret\_from\_fork+0x3a/0x50
-> #0 (&xfs\_nondir\_ilock\_class){++++}:
down\_read\_nested+0x43/0x70
xfs\_free\_eofblocks+0xa2/0x1e0
xfs\_fs\_destroy\_inode+0xac/0x270
dispose\_list+0x51/0x80
prune\_icache\_sb+0x52/0x70
super\_cache\_scan+0x127/0x1a0
shrink\_slab.part.47+0x1bd/0x590
shrink\_node+0x3b5/0x470
balance\_pgdat+0x158/0x3b0
kswapd+0x1ba/0x600
kthread+0x11c/0x140
ret\_from\_fork+0x3a/0x50
other info that might help us debug this:
Chain exists of:
&xfs\_nondir\_ilock\_class --> &dmz->chunk\_lock --> fs\_reclaim
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(fs\_reclaim);
lock(&dmz->chunk\_lock);
lock(fs\_reclaim);
lock(&xfs\_nondir\_ilock\_class);
commit c1a1ba3a0ed42777b6aaa3872c91fcd7ccdc4642
Author: Kirill A. Shutemov
Date: Mon Jun 25 15:08:52 2018 +0300
x86/efi: Fix efi\_call\_phys\_epilog() with CONFIG\_X86\_5LEVEL=y
commit cfe19577047e74cdac5826adbdc2337d8437f8fb upstream.
Open-coded page table entry checks don't work correctly when we fold the
page table level at runtime.
pgd\_present() on 4-level paging machine always returns true, but
open-coded version of the check may return false-negative result and
we silently skip the rest of the loop body in efi\_call\_phys\_epilog().
Replace open-coded checks with proper helpers.
Signed-off-by: Kirill A. Shutemov
Acked-by: Ard Biesheuvel
Cc: Andrey Ryabinin
Cc: Baoquan He
Cc: Linus Torvalds
Cc: Matt Fleming
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org # v4.12+
Fixes: 94133e46a0f5 ("x86/efi: Correct EFI identity mapping under 'efi=old\_map' when KASLR is enabled")
Link: http://lkml.kernel.org/r/20180625120852.18300-1-kirill.shutemov@linux.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 79dba4a16878ef2f2c572bf9c32486342e74ab02
Author: Andy Lutomirski
Date: Tue Jun 26 22:45:52 2018 -0700
x86/entry/64/compat: Fix "x86/entry/64/compat: Preserve r8-r11 in int $0x80"
commit 22cd978e598618e82c3c3348d2069184f6884182 upstream.
Commit:
8bb2610bc496 ("x86/entry/64/compat: Preserve r8-r11 in int $0x80")
was busted: my original patch had a minor conflict with
some of the nospec changes, but "git apply" is very clever
and silently accepted the patch by making the same changes
to a different function in the same file. There was obviously
a huge offset, but "git apply" for some reason doesn't feel
any need to say so.
Move the changes to the correct function. Now the
test\_syscall\_vdso\_32 selftests passes.
If anyone cares to observe the original problem, try applying the
patch at:
https://lore.kernel.org/lkml/d4c4d9985fbe64f8c9e19291886453914b48caee.1523975710.git.luto@kernel.org/raw
to the kernel at 316d097c4cd4e7f2ef50c40cff2db266593c4ec4:
- "git am" and "git apply" accept the patch without any complaints at all
- "patch -p1" at least prints out a message about the huge offset.
Reported-by: zhijianx.li@intel.com
Signed-off-by: Andy Lutomirski
Cc: Arjan van de Ven
Cc: Borislav Petkov
Cc: Dan Williams
Cc: Dave Hansen
Cc: David Woodhouse
Cc: Greg Kroah-Hartman
Cc: Josh Poimboeuf
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org #v4.17+
Fixes: 8bb2610bc496 ("x86/entry/64/compat: Preserve r8-r11 in int $0x80")
Link: http://lkml.kernel.org/r/6012b922485401bc42676e804171ded262fc2ef2.1530078306.git.luto@kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 05e3000bb32e23939e91b57d8aadd2b14a7c4f87
Author: Jann Horn
Date: Thu Jun 28 20:39:54 2018 -0400
selinux: move user accesses in selinuxfs out of locked regions
commit 0da74120c5341389b97c4ee27487a97224999ee1 upstream.
If a user is accessing a file in selinuxfs with a pointer to a userspace
buffer that is backed by e.g. a userfaultfd, the userspace access can
stall indefinitely, which can block fsi->mutex if it is held.
For sel\_read\_policy(), remove the locking, since this method doesn't seem
to access anything that requires locking.
For sel\_read\_bool(), move the user access below the locked region.
For sel\_write\_bool() and sel\_commit\_bools\_write(), move the user access
up above the locked region.
Cc: stable@vger.kernel.org
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Jann Horn
Acked-by: Stephen Smalley
[PM: removed an unused variable in sel\_read\_policy()]
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 54428453efda4c1c35ca75a0a5aa170de87ff1b0
Author: Naoya Horiguchi
Date: Wed Jun 27 23:26:13 2018 -0700
x86/e820: put !E820\_TYPE\_RAM regions into memblock.reserved
commit 124049decbb121ec32742c94fb5d9d6bed8f24d8 upstream.
There is a kernel panic that is triggered when reading /proc/kpageflags
on the kernel booted with kernel parameter 'memmap=nn[KMG]!ss[KMG]':
BUG: unable to handle kernel paging request at fffffffffffffffe
PGD 9b20e067 P4D 9b20e067 PUD 9b210067 PMD 0
Oops: 0000 [#1] SMP PTI
CPU: 2 PID: 1728 Comm: page-types Not tainted 4.17.0-rc6-mm1-v4.17-rc6-180605-0816-00236-g2dfb086ef02c+ #160
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.11.0-2.fc28 04/01/2014
RIP: 0010:stable\_page\_flags+0x27/0x3c0
Code: 00 00 00 0f 1f 44 00 00 48 85 ff 0f 84 a0 03 00 00 41 54 55 49 89 fc 53 48 8b 57 08 48 8b 2f 48 8d 42 ff 83 e2 01 48 0f 44 c7 <48> 8b 00 f6 c4 01 0f 84 10 03 00 00 31 db 49 8b 54 24 08 4c 89 e7
RSP: 0018:ffffbbd44111fde0 EFLAGS: 00010202
RAX: fffffffffffffffe RBX: 00007fffffffeff9 RCX: 0000000000000000
RDX: 0000000000000001 RSI: 0000000000000202 RDI: ffffed1182fff5c0
RBP: ffffffffffffffff R08: 0000000000000001 R09: 0000000000000001
R10: ffffbbd44111fed8 R11: 0000000000000000 R12: ffffed1182fff5c0
R13: 00000000000bffd7 R14: 0000000002fff5c0 R15: ffffbbd44111ff10
FS: 00007efc4335a500(0000) GS:ffff93a5bfc00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: fffffffffffffffe CR3: 00000000b2a58000 CR4: 00000000001406e0
Call Trace:
kpageflags\_read+0xc7/0x120
proc\_reg\_read+0x3c/0x60
\_\_vfs\_read+0x36/0x170
vfs\_read+0x89/0x130
ksys\_pread64+0x71/0x90
do\_syscall\_64+0x5b/0x160
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
RIP: 0033:0x7efc42e75e23
Code: 09 00 ba 9f 01 00 00 e8 ab 81 f4 ff 66 2e 0f 1f 84 00 00 00 00 00 90 83 3d 29 0a 2d 00 00 75 13 49 89 ca b8 11 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 34 c3 48 83 ec 08 e8 db d3 01 00 48 89 04 24
According to kernel bisection, this problem became visible due to commit
f7f99100d8d9 ("mm: stop zeroing memory during allocation in vmemmap")
which changes how struct pages are initialized.
Memblock layout affects the pfn ranges covered by node/zone. Consider
that we have a VM with 2 NUMA nodes and each node has 4GB memory, and
the default (no memmap= given) memblock layout is like below:
MEMBLOCK configuration:
memory size = 0x00000001fff75c00 reserved size = 0x000000000300c000
memory.cnt = 0x4
memory[0x0] [0x0000000000001000-0x000000000009efff], 0x000000000009e000 bytes on node 0 flags: 0x0
memory[0x1] [0x0000000000100000-0x00000000bffd6fff], 0x00000000bfed7000 bytes on node 0 flags: 0x0
memory[0x2] [0x0000000100000000-0x000000013fffffff], 0x0000000040000000 bytes on node 0 flags: 0x0
memory[0x3] [0x0000000140000000-0x000000023fffffff], 0x0000000100000000 bytes on node 1 flags: 0x0
...
If you give memmap=1G!4G (so it just covers memory[0x2]),
the range [0x100000000-0x13fffffff] is gone:
MEMBLOCK configuration:
memory size = 0x00000001bff75c00 reserved size = 0x000000000300c000
memory.cnt = 0x3
memory[0x0] [0x0000000000001000-0x000000000009efff], 0x000000000009e000 bytes on node 0 flags: 0x0
memory[0x1] [0x0000000000100000-0x00000000bffd6fff], 0x00000000bfed7000 bytes on node 0 flags: 0x0
memory[0x2] [0x0000000140000000-0x000000023fffffff], 0x0000000100000000 bytes on node 1 flags: 0x0
...
This causes shrinking node 0's pfn range because it is calculated by the
address range of memblock.memory. So some of struct pages in the gap
range are left uninitialized.
We have a function zero\_resv\_unavail() which does zeroing the struct pages
within the reserved unavailable range (i.e. memblock.memory &&
!memblock.reserved). This patch utilizes it to cover all unavailable
ranges by putting them into memblock.reserved.
Link: http://lkml.kernel.org/r/20180615072947.GB23273@hori1.linux.bs1.fc.nec.co.jp
Fixes: f7f99100d8d9 ("mm: stop zeroing memory during allocation in vmemmap")
Signed-off-by: Naoya Horiguchi
Tested-by: Oscar Salvador
Tested-by: "Herton R. Krzesinski"
Acked-by: Michal Hocko
Reviewed-by: Pavel Tatashin
Cc: Steven Sistare
Cc: Daniel Jordan
Cc: Matthew Wilcox
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ee23f3bd9d4022dc60b7764c83c7a95a26e52db1
Author: Bart Van Assche
Date: Wed Jun 27 12:55:18 2018 -0700
block: Fix cloning of requests with a special payload
commit 297ba57dcdec7ea37e702bcf1a577ac32a034e21 upstream.
This patch avoids that removing a path controlled by the dm-mpath driver
while mkfs is running triggers the following kernel bug:
kernel BUG at block/blk-core.c:3347!
invalid opcode: 0000 [#1] PREEMPT SMP KASAN
CPU: 20 PID: 24369 Comm: mkfs.ext4 Not tainted 4.18.0-rc1-dbg+ #2
RIP: 0010:blk\_end\_request\_all+0x68/0x70
Call Trace:
dm\_softirq\_done+0x326/0x3d0 [dm\_mod]
blk\_done\_softirq+0x19b/0x1e0
\_\_do\_softirq+0x128/0x60d
irq\_exit+0x100/0x110
smp\_call\_function\_single\_interrupt+0x90/0x330
call\_function\_single\_interrupt+0xf/0x20

Fixes: f9d03f96b988 ("block: improve handling of the magic discard payload")
Reviewed-by: Ming Lei
Reviewed-by: Christoph Hellwig
Acked-by: Mike Snitzer
Signed-off-by: Bart Van Assche
Cc: Hannes Reinecke
Cc: Johannes Thumshirn
Cc:
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 4ef7273f59162ce7e5ada3d2729eb2b6a2557557
Author: Keith Busch
Date: Tue Jun 26 09:14:58 2018 -0600
block: Fix transfer when chunk sectors exceeds max
commit 15bfd21fbc5d35834b9ea383dc458a1f0c9e3434 upstream.
A device may have boundary restrictions where the number of sectors
between boundaries exceeds its max transfer size. In this case, we need
to cap the max size to the smaller of the two limits.
Reported-by: Jitendra Bhivare
Tested-by: Jitendra Bhivare
Cc:
Reviewed-by: Martin K. Petersen
Signed-off-by: Keith Busch
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 81f318e259d17b6443003ca1b05c858786a4c113
Author: Ross Zwisler
Date: Tue Jun 26 16:30:39 2018 -0600
pmem: only set QUEUE\_FLAG\_DAX for fsdax mode
commit 4557641b4c7046625c026fb809c47ef0d43ae595 upstream.
QUEUE\_FLAG\_DAX is an indication that a given block device supports
filesystem DAX and should not be set for PMEM namespaces which are in "raw"
mode. These namespaces lack struct page and are prevented from
participating in filesystem DAX as of commit 569d0365f571 ("dax: require
'struct page' by default for filesystem dax").
Signed-off-by: Ross Zwisler
Suggested-by: Mike Snitzer
Fixes: 569d0365f571 ("dax: require 'struct page' by default for filesystem dax")
Cc: stable@vger.kernel.org
Acked-by: Dan Williams
Reviewed-by: Toshi Kani
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit ec43a73489c595386df9733b5bfcfa16494190fa
Author: Mike Snitzer
Date: Fri Jun 15 09:35:33 2018 -0400
dm: use bio\_split() when splitting out the already processed bio
commit f21c601a2bb319ec19eb4562eadc7797d90fd90e upstream.
Use of bio\_clone\_bioset() is inefficient if there is no need to clone
the original bio's bio\_vec array. Best to use the bio\_clone\_fast()
variant. Also, just using bio\_advance() is only part of what is needed
to properly setup the clone -- it doesn't account for the various
bio\_integrity() related work that also needs to be performed (see
bio\_split).
Address both of these issues by switching from bio\_clone\_bioset() to
bio\_split().
Fixes: 18a25da8 ("dm: ensure bio submission follows a depth-first tree walk")
Cc: stable@vger.kernel.org # 4.15+, requires removal of '&' before md->queue->bio\_split
Reported-by: Christoph Hellwig
Reviewed-by: NeilBrown
Signed-off-by: Mike Snitzer
Signed-off-by: Greg Kroah-Hartman
commit b26c9f36874860dc18b4aaa311fa70438a82938a
Author: Jason A. Donenfeld
Date: Wed Jun 27 23:26:20 2018 -0700
kasan: depend on CONFIG\_SLUB\_DEBUG
commit dd275caf4a0d9b219fffe49288b6cc33cd564312 upstream.
KASAN depends on having access to some of the accounting that SLUB\_DEBUG
does; without it, there are immediate crashes [1]. So, the natural
thing to do is to make KASAN select SLUB\_DEBUG.
[1] http://lkml.kernel.org/r/CAHmME9rtoPwxUSnktxzKso14iuVCWT7BE\_-\_8PAC=pGw1iJnQg@mail.gmail.com
Link: http://lkml.kernel.org/r/20180622154623.25388-1-Jason@zx2c4.com
Fixes: f9e13c0a5a33 ("slab, slub: skip unnecessary kasan\_cache\_shutdown()")
Signed-off-by: Jason A. Donenfeld
Acked-by: Michal Hocko
Reviewed-by: Shakeel Butt
Acked-by: Christoph Lameter
Cc: Shakeel Butt
Cc: David Rientjes
Cc: Pekka Enberg
Cc: Joonsoo Kim
Cc: Andrey Ryabinin
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 916c0db51d3a3b2778a0b8daf1f2260258729ce9
Author: Mikulas Patocka
Date: Wed Jun 27 23:26:09 2018 -0700
slub: fix failure when we delete and create a slab cache
commit d50d82faa0c964e31f7a946ba8aba7c715ca7ab0 upstream.
In kernel 4.17 I removed some code from dm-bufio that did slab cache
merging (commit 21bb13276768: "dm bufio: remove code that merges slab
caches") - both slab and slub support merging caches with identical
attributes, so dm-bufio now just calls kmem\_cache\_create and relies on
implicit merging.
This uncovered a bug in the slub subsystem - if we delete a cache and
immediatelly create another cache with the same attributes, it fails
because of duplicate filename in /sys/kernel/slab/. The slub subsystem
offloads freeing the cache to a workqueue - and if we create the new
cache before the workqueue runs, it complains because of duplicate
filename in sysfs.
This patch fixes the bug by moving the call of kobject\_del from
sysfs\_slab\_remove\_workfn to shutdown\_cache. kobject\_del must be called
while we hold slab\_mutex - so that the sysfs entry is deleted before a
cache with the same attributes could be created.
Running device-mapper-test-suite with:
dmtest run --suite thin-provisioning -n /commit\_failure\_causes\_fallback/
triggered:
Buffer I/O error on dev dm-0, logical block 1572848, async page read
device-mapper: thin: 253:1: metadata operation 'dm\_pool\_alloc\_data\_block' failed: error = -5
device-mapper: thin: 253:1: aborting current metadata transaction
sysfs: cannot create duplicate filename '/kernel/slab/:a-0000144'
CPU: 2 PID: 1037 Comm: kworker/u48:1 Not tainted 4.17.0.snitm+ #25
Hardware name: Supermicro SYS-1029P-WTR/X11DDW-L, BIOS 2.0a 12/06/2017
Workqueue: dm-thin do\_worker [dm\_thin\_pool]
Call Trace:
dump\_stack+0x5a/0x73
sysfs\_warn\_dup+0x58/0x70
sysfs\_create\_dir\_ns+0x77/0x80
kobject\_add\_internal+0xba/0x2e0
kobject\_init\_and\_add+0x70/0xb0
sysfs\_slab\_add+0xb1/0x250
\_\_kmem\_cache\_create+0x116/0x150
create\_cache+0xd9/0x1f0
kmem\_cache\_create\_usercopy+0x1c1/0x250
kmem\_cache\_create+0x18/0x20
dm\_bufio\_client\_create+0x1ae/0x410 [dm\_bufio]
dm\_block\_manager\_create+0x5e/0x90 [dm\_persistent\_data]
\_\_create\_persistent\_data\_objects+0x38/0x940 [dm\_thin\_pool]
dm\_pool\_abort\_metadata+0x64/0x90 [dm\_thin\_pool]
metadata\_operation\_failed+0x59/0x100 [dm\_thin\_pool]
alloc\_data\_block.isra.53+0x86/0x180 [dm\_thin\_pool]
process\_cell+0x2a3/0x550 [dm\_thin\_pool]
do\_worker+0x28d/0x8f0 [dm\_thin\_pool]
process\_one\_work+0x171/0x370
worker\_thread+0x49/0x3f0
kthread+0xf8/0x130
ret\_from\_fork+0x35/0x40
kobject\_add\_internal failed for :a-0000144 with -EEXIST, don't try to register things with the same name in the same directory.
kmem\_cache\_create(dm\_bufio\_buffer-16) failed with error -17
Link: http://lkml.kernel.org/r/alpine.LRH.2.02.1806151817130.6333@file01.intranet.prod.int.rdu2.redhat.com
Signed-off-by: Mikulas Patocka
Reported-by: Mike Snitzer
Tested-by: Mike Snitzer
Cc: Christoph Lameter
Cc: Pekka Enberg
Cc: David Rientjes
Cc: Joonsoo Kim
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 323252c83194268cadefc2c0ea55827bf4dd04b8
Author: Wolfram Sang
Date: Sat Jun 16 21:56:36 2018 +0900
i2c: gpio: initialize SCL to HIGH again
commit 12b731dd46d9ee646318e6e9dc587314a3908a46 upstream.
It seems that during the conversion from gpio\* to gpiod\*, the initial
state of SCL was wrongly switched to LOW. Fix it to be HIGH again.
Fixes: 7bb75029ef34 ("i2c: gpio: Enforce open drain through gpiolib")
Signed-off-by: Wolfram Sang
Tested-by: Geert Uytterhoeven
Reviewed-by: Linus Walleij
Signed-off-by: Wolfram Sang
Cc: stable@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 97be42058b2470ebd998bde1b1baa0226406d2cb
Author: Wolfram Sang
Date: Sat Jun 16 22:37:56 2018 +0900
Revert "i2c: algo-bit: init the bus to a known state"
commit 2a2c8ee2d72c4f1ba0f7fbb02dc74f971df0f934 upstream.
This reverts commit 3e5f06bed72fe72166a6778f630241a893f67799. As per
bugzilla #200045, this caused a regression. I don't really see a way to
fix it without having the hardware. So, revert the patch and I will fix
the issue I was seeing originally in the i2c-gpio driver itself. I
couldn't find new users of this algorithm since, so there should be no
one depending on the new behaviour.
Reported-by: Sergey Larin
Fixes: 3e5f06bed72f ("i2c: algo-bit: init the bus to a known state")
Signed-off-by: Wolfram Sang
Acked-by: Alex Deucher
Tested-by: Sergey Larin
Signed-off-by: Wolfram Sang
Cc: stable@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 11a74cf5d322b899c95a1544e4ed85b5712babc1
Author: Hui Wang
Date: Mon Jun 25 14:40:56 2018 +0800
ALSA: hda/realtek - Fix the problem of two front mics on more machines
commit e41fc8c5bd41b96bfae5ce4c66bee6edabc932e8 upstream.
We have 3 more Lenovo machines, they all have 2 front mics on them,
so they need the fixup to change the location for one of two mics.
Among these 3 Lenovo machines, one of them has the same pin cfg as the
machine with subid 0x17aa3138, so use the pin cfg table to apply fixup
for them. The rest machines don't share the same pin cfg, so far use
the subid to apply fixup for them.
Fixes: a3dafb2200bf ("ALSA: hda/realtek - adjust the location of one mic")
Cc:
Signed-off-by: Hui Wang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8e1b02d7deea578f92d76b84e3e2448d9264cde2
Author: Takashi Iwai
Date: Fri Jun 22 12:17:45 2018 +0200
ALSA: hda/realtek - Add a quirk for FSC ESPRIMO U9210
commit 275ec0cb946cb75ac8977f662e608fce92f8b8a8 upstream.
Fujitsu Seimens ESPRIMO Mobile U9210 requires the same fixup as H270
for the correct pin configs.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=200107
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit d80af7bcfeaed2571981b32af6546e5d209aa7ae
Author: Takashi Iwai
Date: Wed Jun 13 12:43:10 2018 +0200
ALSA: hda/realtek - Fix pop noise on Lenovo P50 & co
commit d5a6cabf02210b896a60eee7c04c670ee9ba6dca upstream.
Some Lenovo laptops, e.g. Lenovo P50, showed the pop noise at resume
or runtime resume. It turned out to be reduced by applying
alc\_no\_shutup() just like TPT440 quirk does.
Since there are many Lenovo models showing the same behavior, put this
workaround in ALC269\_FIXUP\_THINKPAD\_ACPI entry so that it's applied
commonly to all such Lenovo machines.
Reported-by: Hans de Goede
Tested-by: Benjamin Berg
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c67ba634935525c9014e777f53224cd6f09a50e9
Author: Takashi Iwai
Date: Thu Jun 21 13:33:53 2018 +0200
ALSA: hda - Force to link down at runtime suspend on ATI/AMD HDMI
commit 57cb54e53bddb59f5f542ddd4b0bfe005d31a8d5 upstream.
Henning KÃ¼hn reported that the discrete AMD GPU on his hybrid graphics
laptop no longer runtime-suspends due to the recent commit
07f4f97d7b4b ("vga\_switcheroo: Use device link for HDA controller").
The root cause is that the HDMI codec on AMD GPU doesn't support
CLKSTOP and EPSS, which are currently mandatory for powering down the
HD-audio link at runtime suspend. Because the HD-audio link is still
up, HD-audio controller driver blocks the transition to D3.
For addressing the regression, this patch adds a new flag to indicate
the forced link-down, and sets it for AMD HDMI codecs appropriately
in the codec driver.
Fixes: 07f4f97d7b4b ("vga\_switcheroo: Use device link for HDA controller")
Bugzilla: https://bugs.freedesktop.org/show\_bug.cgi?id=106957
Reported-by: Lukas Wunner
Reported-and-tested-by: Henning KÃ¼hn
Cc:  # v4.17+
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b859775275b139167abf462890918ee2fd9559be
Author: Takashi Iwai
Date: Mon Jun 25 11:09:11 2018 +0200
ALSA: timer: Fix UBSAN warning at SNDRV\_TIMER\_IOCTL\_NEXT\_DEVICE ioctl
commit b41f794f284966fd6ec634111e3b40d241389f96 upstream.
The kernel may spew a WARNING about UBSAN undefined behavior at
handling ALSA timer ioctl SNDRV\_TIMER\_IOCTL\_NEXT\_DEVICE:
UBSAN: Undefined behaviour in sound/core/timer.c:1524:19
signed integer overflow:
2147483647 + 1 cannot be represented in type 'int'
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x122/0x1c8 lib/dump\_stack.c:113
ubsan\_epilogue+0x12/0x86 lib/ubsan.c:159
handle\_overflow+0x1c2/0x21f lib/ubsan.c:190
\_\_ubsan\_handle\_add\_overflow+0x2a/0x31 lib/ubsan.c:198
snd\_timer\_user\_next\_device sound/core/timer.c:1524 [inline]
\_\_snd\_timer\_user\_ioctl+0x204d/0x2520 sound/core/timer.c:1939
snd\_timer\_user\_ioctl+0x67/0x95 sound/core/timer.c:1994
....
It happens only when a value with INT\_MAX is passed, as we're
incrementing it unconditionally. So the fix is trivial, check the
value with INT\_MAX. Although the bug itself is fairly harmless, it's
better to fix it so that fuzzers won't hit this again later.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=200213
Reported-and-tested-by: Team OWL337
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 72e144aa92eca0253f72c5266eeb74d097e5359a
Author: ???
Date: Thu Jun 21 17:15:32 2018 -0700
Input: elantech - fix V4 report decoding for module with middle key
commit e0ae2519ca004a628fa55aeef969c37edce522d3 upstream.
Some touchpad has middle key and it will be indicated in bit 2 of packet[0].
We need to fix V4 formation's byte mask to prevent error decoding.
Signed-off-by: KT Liao
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit ff27b6b3a40bef8fcbfd29d8b6c624a943aa5f48
Author: Aaron Ma
Date: Thu Jun 21 17:14:01 2018 -0700
Input: elantech - enable middle button of touchpads on ThinkPad P52
commit 24bb555e6e46d96e2a954aa0295029a81cc9bbaa upstream.
PNPID is better way to identify the type of touchpads.
Enable middle button support on 2 types of touchpads on Lenovo P52.
Cc: stable@vger.kernel.org
Signed-off-by: Aaron Ma
Reviewed-by: Benjamin Tissoires
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit f1f3d22d65f1e657826f5515b6b6b38728082d9a
Author: Ben Hutchings
Date: Tue Jun 19 11:17:32 2018 -0700
Input: elan\_i2c\_smbus - fix more potential stack buffer overflows
commit 50fc7b61959af4b95fafce7fe5dd565199e0b61a upstream.
Commit 40f7090bb1b4 ("Input: elan\_i2c\_smbus - fix corrupted stack")
fixed most of the functions using i2c\_smbus\_read\_block\_data() to
allocate a buffer with the maximum block size. However three
functions were left unchanged:
\* In elan\_smbus\_initialize(), increase the buffer size in the same
way.
\* In elan\_smbus\_calibrate\_result(), the buffer is provided by the
caller (calibrate\_store()), so introduce a bounce buffer. Also
name the result buffer size.
\* In elan\_smbus\_get\_report(), the buffer is provided by the caller
but happens to be the right length. Add a compile-time assertion
to ensure this remains the case.
Cc:  # 3.19+
Signed-off-by: Ben Hutchings
Reviewed-by: Benjamin Tissoires
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 76ce7a5e1b0e606a75531df05117459a6be67ba1
Author: Dmitry Torokhov
Date: Mon Jun 25 12:02:40 2018 -0700
Input: psmouse - fix button reporting for basic protocols
commit 03ae3a9caf4a59edd32b65c89c375a98ce3ea1ef upstream.
The commit ba667650c568 ("Input: psmouse - clean up code") was pretty
brain-dead and broke extra buttons reporting for variety of PS/2 mice:
Genius, Thinkmouse and Intellimouse Explorer. We need to actually inspect
the data coming from the device when reporting events.
Fixes: ba667650c568 ("Input: psmouse - clean up code")
Reported-by: Jiri Slaby
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 9be75ae5a70f24905a17cfc345f3ee310f7ce415
Author: Enno Boland
Date: Tue Jun 19 11:55:33 2018 -0700
Input: xpad - fix GPD Win 2 controller name
commit dd6bee81c942c0ea01030da9356026afb88f9d18 upstream.
This fixes using the controller with SDL2.
SDL2 has a naive algorithm to apply the correct settings to a controller.
For X-Box compatible controllers it expects that the controller name
contains a variation of a 'XBOX'-string.
This patch changes the identifier to contain "X-Box" as substring. Tested
with Steam and C-Dogs-SDL which both detect the controller properly after
adding this patch.
Fixes: c1ba08390a8b ("Input: xpad - add GPD Win 2 Controller USB IDs")
Cc: stable@vger.kernel.org
Signed-off-by: Enno Boland
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 238e2637c64123aadb7ab6c1095ad23593b65e3f
Author: Jan Kara
Date: Wed Jun 13 12:09:22 2018 +0200
udf: Detect incorrect directory size
commit fa65653e575fbd958bdf5fb9c4a71a324e39510d upstream.
Detect when a directory entry is (possibly partially) beyond directory
size and return EIO in that case since it means the filesystem is
corrupted. Otherwise directory operations can further corrupt the
directory and possibly also oops the kernel.
CC: Anatoly Trosinenko
CC: stable@vger.kernel.org
Reported-and-tested-by: Anatoly Trosinenko
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit 0c42dc46c56b0296dee0f74b93add8c9d3178de4
Author: Bartosz Golaszewski
Date: Tue Jun 19 14:44:00 2018 +0200
net: ethernet: fix suspend/resume in davinci\_emac
commit dc45519eb181b5687ac8382361a8aa085acd1fe1 upstream.
This patch reverts commit 3243ff2a05ec ("net: ethernet: davinci\_emac:
Deduplicate bus\_find\_device() by name matching") and adds a comment
which should stop anyone from reintroducing the same "fix" in the future.
We can't use bus\_find\_device\_by\_name() here because the device name is
not guaranteed to be 'davinci\_mdio'. On some systems it can be
'davinci\_mdio.0' so we need to use strncmp() against the first part of
the string to correctly match it.
Fixes: 3243ff2a05ec ("net: ethernet: davinci\_emac: Deduplicate bus\_find\_device() by name matching")
Cc: stable@vger.kernel.org
Signed-off-by: Bartosz Golaszewski
Acked-by: Lukas Wunner
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4570dfd99181be7bd74b81442051eb8ac925fa2e
Author: Boris Ostrovsky
Date: Thu Jun 21 13:29:44 2018 -0400
xen: Remove unnecessary BUG\_ON from \_\_unbind\_from\_irq()
commit eef04c7b3786ff0c9cb1019278b6c6c2ea0ad4ff upstream.
Commit 910f8befdf5b ("xen/pirq: fix error path cleanup when binding
MSIs") fixed a couple of errors in error cleanup path of
xen\_bind\_pirq\_msi\_to\_irq(). This cleanup allowed a call to
\_\_unbind\_from\_irq() with an unbound irq, which would result in
triggering the BUG\_ON there.
Since there is really no reason for the BUG\_ON (xen\_free\_irq() can
operate on unbound irqs) we can remove it.
Reported-by: Ben Hutchings
Signed-off-by: Boris Ostrovsky
Cc: stable@vger.kernel.org
Reviewed-by: Juergen Gross
Signed-off-by: Juergen Gross
Signed-off-by: Greg Kroah-Hartman
commit a6974c2f8e8b6f29ba3bcdb508ace850a26823fc
Author: Steven Rostedt (VMware)
Date: Thu Jun 21 13:20:53 2018 -0400
tracing: Check for no filter when processing event filters
commit 70303420b5721c38998cf987e6b7d30cc62d4ff1 upstream.
The syzkaller detected a out-of-bounds issue with the events filter code,
specifically here:
prog[N].pred = NULL; /\* #13 \*/
prog[N].target = 1; /\* TRUE \*/
prog[N+1].pred = NULL;
prog[N+1].target = 0; /\* FALSE \*/
-> prog[N-1].target = N;
prog[N-1].when\_to\_branch = false;
As that's the first reference to a "N-1" index, it appears that the code got
here with N = 0, which means the filter parser found no filter to parse
(which shouldn't ever happen, but apparently it did).
Add a new error to the parsing code that will check to make sure that N is
not zero before going into this part of the code. If N = 0, then -EINVAL is
returned, and a error message is added to the filter.
Cc: stable@vger.kernel.org
Fixes: 80765597bc587 ("tracing: Rewrite filter logic to be simpler and faster")
Reported-by: air icy
bugzilla url: https://bugzilla.kernel.org/show\_bug.cgi?id=200019
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 63905eb7045cf66ad5dd3e4cdadcfea564489bee
Author: Dan Williams
Date: Thu Jun 14 15:26:24 2018 -0700
mm: fix devmem\_is\_allowed() for sub-page System RAM intersections
commit 2bdce74412c249ac01dfe36b6b0043ffd7a5361e upstream.
Hussam reports:
I was poking around and for no real reason, I did cat /dev/mem and
strings /dev/mem. Then I saw the following warning in dmesg. I saved it
and rebooted immediately.
memremap attempted on mixed range 0x000000000009c000 size: 0x1000
------------[ cut here ]------------
WARNING: CPU: 0 PID: 11810 at kernel/memremap.c:98 memremap+0x104/0x170
[..]
Call Trace:
xlate\_dev\_mem\_ptr+0x25/0x40
read\_mem+0x89/0x1a0
\_\_vfs\_read+0x36/0x170
The memremap() implementation checks for attempts to remap System RAM
with MEMREMAP\_WB and instead redirects those mapping attempts to the
linear map. However, that only works if the physical address range
being remapped is page aligned. In low memory we have situations like
the following:
00000000-00000fff : Reserved
00001000-0009fbff : System RAM
0009fc00-0009ffff : Reserved
...where System RAM intersects Reserved ranges on a sub-page page
granularity.
Given that devmem\_is\_allowed() special cases any attempt to map System
RAM in the first 1MB of memory, replace page\_is\_ram() with the more
precise region\_intersects() to trap attempts to map disallowed ranges.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=199999
Link: http://lkml.kernel.org/r/152856436164.18127.2847888121707136898.stgit@dwillia2-desk3.amr.corp.intel.com
Fixes: 92281dee825f ("arch: introduce memremap()")
Signed-off-by: Dan Williams
Reported-by: Hussam Al-Tayeb
Tested-by: Hussam Al-Tayeb
Cc: Christoph Hellwig
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3d2d9f7df18a1afa9fa94cc75a6bae2cef4dad9e
Author: Jia He
Date: Thu Jun 14 15:26:14 2018 -0700
mm/ksm.c: ignore STABLE\_FLAG of rmap\_item->address in rmap\_walk\_ksm()
commit 1105a2fc022f3c7482e32faf516e8bc44095f778 upstream.
In our armv8a server(QDF2400), I noticed lots of WARN\_ON caused by
PAGE\_SIZE unaligned for rmap\_item->address under memory pressure
tests(start 20 guests and run memhog in the host).
WARNING: CPU: 4 PID: 4641 at virt/kvm/arm/mmu.c:1826 kvm\_age\_hva\_handler+0xc0/0xc8
CPU: 4 PID: 4641 Comm: memhog Tainted: G W 4.17.0-rc3+ #8
Call trace:
kvm\_age\_hva\_handler+0xc0/0xc8
handle\_hva\_to\_gpa+0xa8/0xe0
kvm\_age\_hva+0x4c/0xe8
kvm\_mmu\_notifier\_clear\_flush\_young+0x54/0x98
\_\_mmu\_notifier\_clear\_flush\_young+0x6c/0xa0
page\_referenced\_one+0x154/0x1d8
rmap\_walk\_ksm+0x12c/0x1d0
rmap\_walk+0x94/0xa0
page\_referenced+0x194/0x1b0
shrink\_page\_list+0x674/0xc28
shrink\_inactive\_list+0x26c/0x5b8
shrink\_node\_memcg+0x35c/0x620
shrink\_node+0x100/0x430
do\_try\_to\_free\_pages+0xe0/0x3a8
try\_to\_free\_pages+0xe4/0x230
\_\_alloc\_pages\_nodemask+0x564/0xdc0
alloc\_pages\_vma+0x90/0x228
do\_anonymous\_page+0xc8/0x4d0
\_\_handle\_mm\_fault+0x4a0/0x508
handle\_mm\_fault+0xf8/0x1b0
do\_page\_fault+0x218/0x4b8
do\_translation\_fault+0x90/0xa0
do\_mem\_abort+0x68/0xf0
el0\_da+0x24/0x28
In rmap\_walk\_ksm, the rmap\_item->address might still have the
STABLE\_FLAG, then the start and end in handle\_hva\_to\_gpa might not be
PAGE\_SIZE aligned. Thus it will cause exceptions in handle\_hva\_to\_gpa
on arm64.
This patch fixes it by ignoring (not removing) the low bits of address
when doing rmap\_walk\_ksm.
IMO, it should be backported to stable tree. the storm of WARN\_ONs is
very easy for me to reproduce. More than that, I watched a panic (not
reproducible) as follows:
page:ffff7fe003742d80 count:-4871 mapcount:-2126053375 mapping: (null) index:0x0
flags: 0x1fffc00000000000()
raw: 1fffc00000000000 0000000000000000 0000000000000000 ffffecf981470000
raw: dead000000000100 dead000000000200 ffff8017c001c000 0000000000000000
page dumped because: nonzero \_refcount
CPU: 29 PID: 18323 Comm: qemu-kvm Tainted: G W 4.14.15-5.hxt.aarch64 #1
Hardware name:
Call trace:
dump\_backtrace+0x0/0x22c
show\_stack+0x24/0x2c
dump\_stack+0x8c/0xb0
bad\_page+0xf4/0x154
free\_pages\_check\_bad+0x90/0x9c
free\_pcppages\_bulk+0x464/0x518
free\_hot\_cold\_page+0x22c/0x300
\_\_put\_page+0x54/0x60
unmap\_stage2\_range+0x170/0x2b4
kvm\_unmap\_hva\_handler+0x30/0x40
handle\_hva\_to\_gpa+0xb0/0xec
kvm\_unmap\_hva\_range+0x5c/0xd0
I even injected a fault on purpose in kvm\_unmap\_hva\_range by seting
size=size-0x200, the call trace is similar as above. So I thought the
panic is similarly caused by the root cause of WARN\_ON.
Andrea said:
: It looks a straightforward safe fix, on x86 hva\_to\_gfn\_memslot would
: zap those bits and hide the misalignment caused by the low metadata
: bits being erroneously left set in the address, but the arm code
: notices when that's the last page in the memslot and the hva\_end is
: getting aligned and the size is below one page.
:
: I think the problem triggers in the addr += PAGE\_SIZE of
: unmap\_stage2\_ptes that never matches end because end is aligned but
: addr is not.
:
: } while (pte++, addr += PAGE\_SIZE, addr != end);
:
: x86 again only works on hva\_start/hva\_end after converting it to
: gfn\_start/end and that being in pfn units the bits are zapped before
: they risk to cause trouble.
Jia He said:
: I've tested by myself in arm64 server (QDF2400,46 cpus,96G mem) Without
: this patch, the WARN\_ON is very easy for reproducing. After this patch, I
: have run the same benchmarch for a whole day without any WARN\_ONs
Link: http://lkml.kernel.org/r/1525403506-6750-1-git-send-email-hejianet@gmail.com
Signed-off-by: Jia He
Reviewed-by: Andrea Arcangeli
Tested-by: Jia He
Cc: Suzuki K Poulose
Cc: Minchan Kim
Cc: Claudio Imbrenda
Cc: Arvind Yadav
Cc: Mike Rapoport
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 5319f5be7d2d627bb59435ebcc8f630cb0ccfc7a
Author: Dongsheng Yang
Date: Mon Jun 4 06:24:37 2018 -0400
rbd: flush rbd\_dev->watch\_dwork after watch is unregistered
commit 23edca864951250af845a11da86bb3ea63522ed2 upstream.
There is a problem if we are going to unmap a rbd device and the
watch\_dwork is going to queue delayed work for watch:
unmap Thread watch Thread timer
do\_rbd\_remove
cancel\_tasks\_sync(rbd\_dev)
queue\_delayed\_work for watch
destroy\_workqueue(rbd\_dev->task\_wq)
drain\_workqueue(wq)
destroy other resources in wq
call\_timer\_fn
\_\_queue\_work()
Then the delayed work escape the cancel\_tasks\_sync() and
destroy\_workqueue() and we will get an user-after-free call trace:
BUG: unable to handle kernel NULL pointer dereference at 0000000000000000
PGD 0 P4D 0
Oops: 0000 [#1] SMP PTI
Modules linked in:
CPU: 7 PID: 0 Comm: swapper/7 Tainted: G OE 4.17.0-rc6+ #13
Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011
RIP: 0010:\_\_queue\_work+0x6a/0x3b0
RSP: 0018:ffff9427df1c3e90 EFLAGS: 00010086
RAX: ffff9427deca8400 RBX: 0000000000000000 RCX: 0000000000000000
RDX: ffff9427deca8400 RSI: ffff9427df1c3e50 RDI: 0000000000000000
RBP: ffff942783e39e00 R08: ffff9427deca8400 R09: ffff9427df1c3f00
R10: 0000000000000004 R11: 0000000000000005 R12: ffff9427cfb85970
R13: 0000000000002000 R14: 000000000001eca0 R15: 0000000000000007
FS: 0000000000000000(0000) GS:ffff9427df1c0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000004c900a005 CR4: 00000000000206e0
Call Trace:
? \_\_queue\_work+0x3b0/0x3b0
call\_timer\_fn+0x2d/0x130
run\_timer\_softirq+0x16e/0x430
? tick\_sched\_timer+0x37/0x70
\_\_do\_softirq+0xd2/0x280
irq\_exit+0xd5/0xe0
smp\_apic\_timer\_interrupt+0x6c/0x130
apic\_timer\_interrupt+0xf/0x20
[ Move rbd\_dev->watch\_dwork cancellation so that rbd\_reregister\_watch()
either bails out early because the watch is UNREGISTERED at that point
or just gets cancelled. ]
Cc: stable@vger.kernel.org
Fixes: 99d1694310df ("rbd: retry watch re-registration periodically")
Signed-off-by: Dongsheng Yang
Reviewed-by: Ilya Dryomov
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 9adcde2d676017a5c62de060c70d1ca71a925990
Author: Hans de Goede
Date: Thu Apr 26 14:10:23 2018 +0200
pwm: lpss: platform: Save/restore the ctrl register over a suspend/resume
commit 1d375b58c12f08d8570b30b865def4734517f04f upstream.
On some devices the contents of the ctrl register get lost over a
suspend/resume and the PWM comes back up disabled after the resume.
This is seen on some Bay Trail devices with the PWM in ACPI enumerated
mode, so it shows up as a platform device instead of a PCI device.
If we still think it is enabled and then try to change the duty-cycle
after this, we end up with a "PWM\_SW\_UPDATE was not cleared" error and
the PWM is stuck in that state from then on.
This commit adds suspend and resume pm callbacks to the pwm-lpss-platform
code, which save/restore the ctrl register over a suspend/resume, fixing
this.
Note that:
1) There is no need to do this over a runtime suspend, since we
only runtime suspend when disabled and then we properly set the enable
bit and reprogram the timings when we re-enable the PWM.
2) This may be happening on more systems then we realize, but has been
covered up sofar by a bug in the acpi-lpss.c code which was save/restoring
the regular device registers instead of the lpss private registers due to
lpss\_device\_desc.prv\_offset not being set. This is fixed by a later patch
in this series.
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede
Reviewed-by: Andy Shevchenko
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit 9aa355d1961b5f6c0c9305ae8b4a83ca5467093d
Author: Alexandr Savca
Date: Thu Jun 21 17:12:54 2018 -0700
Input: elan\_i2c - add ELAN0618 (Lenovo v330 15IKB) ACPI ID
commit 8938fc7b8fe9ccfa11751ead502a8d385b607967 upstream.
Add ELAN0618 to the list of supported touchpads; this ID is used in
Lenovo v330 15IKB devices.
Signed-off-by: Alexandr Savca
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 13b08caad6c188945eb7052b2dd647234556792f
Author: Hans de Goede
Date: Tue Jun 5 09:34:22 2018 -0700
Input: silead - add MSSL0002 ACPI HID
commit fc573af632b44f355f8fa15ab505f5593368078d upstream.
The Silead touchscreen on the Chuwi Vi8 tablet uses MSSL0002 as ACPI HID,
rather then the usual MSSL1680 id.
Signed-off-by: Hans de Goede
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 180e733e21f3b17ac370997dfdf92acb1e623231
Author: Hans de Goede
Date: Thu Apr 26 14:10:24 2018 +0200
ACPI / LPSS: Add missing prv\_offset setting for byt/cht PWM devices
commit fdcb613d49321b5bf5d5a1bd0fba8e7c241dcc70 upstream.
The LPSS PWM device on on Bay Trail and Cherry Trail devices has a set
of private registers at offset 0x800, the current lpss\_device\_desc for
them already sets the LPSS\_SAVE\_CTX flag to have these saved/restored
over device-suspend, but the current lpss\_device\_desc was not setting
the prv\_offset field, leading to the regular device registers getting
saved/restored instead.
This is causing the PWM controller to no longer work, resulting in a black
screen, after a suspend/resume on systems where the firmware clears the
APB clock and reset bits at offset 0x804.
This commit fixes this by properly setting prv\_offset to 0x800 for
the PWM devices.
Cc: stable@vger.kernel.org
Fixes: e1c748179754 ("ACPI / LPSS: Add Intel BayTrail ACPI mode PWM")
Fixes: 1bfbd8eb8a7f ("ACPI / LPSS: Add ACPI IDs for Intel Braswell")
Signed-off-by: Hans de Goede
Acked-by: Rafael J . Wysocki
Signed-off-by: Thierry Reding
Signed-off-by: Greg Kroah-Hartman
commit ac6992286f1bb8fe86b2a924849f922edabed4ab
Author: Kees Cook
Date: Fri May 11 18:24:12 2018 +1000
video: uvesafb: Fix integer overflow in allocation
commit 9f645bcc566a1e9f921bdae7528a01ced5bc3713 upstream.
cmap->len can get close to INT\_MAX/2, allowing for an integer overflow in
allocation. This uses kmalloc\_array() instead to catch the condition.
Reported-by: Dr Silvio Cesare of InfoSect
Fixes: 8bdb3a2d7df48 ("uvesafb: the driver core")
Cc: stable@vger.kernel.org
Signed-off-by: Kees Cook
Signed-off-by: Greg Kroah-Hartman
commit 11de37bbc39c7836b119e95ea7bdd1202c0cf733
Author: Trond Myklebust
Date: Sat Jun 9 12:50:50 2018 -0400
NFSv4: Fix a typo in nfs41\_sequence\_process
commit 995891006ccbb73c0c9c3923cf9d25c4d07ec16b upstream.
We want to compare the slot\_id to the highest slot number advertised by the
server.
Fixes: 3be0f80b5fe9c ("NFSv4.1: Fix up replays of interrupted requests")
Cc: stable@vger.kernel.org # 4.15+
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 5819c04fb70862a0a72111d95e0204f37cf5ecc0
Author: Trond Myklebust
Date: Sat Jun 9 12:43:06 2018 -0400
NFSv4: Revert commit 5f83d86cf531d ("NFSv4.x: Fix wraparound issues..")
commit fc40724fc6731d90cc7fb6d62d66135f85a33dd2 upstream.
The correct behaviour for NFSv4 sequence IDs is to wrap around
to the value 0 after 0xffffffff.
See https://tools.ietf.org/html/rfc5661#section-2.10.6.1
Fixes: 5f83d86cf531d ("NFSv4.x: Fix wraparound issues when validing...")
Cc: stable@vger.kernel.org # 4.6+
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 4c530c3b34fb53ab7293f04cb2b36f7ebb04e127
Author: Dave Wysochanski
Date: Tue May 29 17:47:30 2018 -0400
NFSv4: Fix possible 1-byte stack overflow in nfs\_idmap\_read\_and\_verify\_message
commit d68894800ec5712d7ddf042356f11e36f87d7f78 upstream.
In nfs\_idmap\_read\_and\_verify\_message there is an incorrect sprintf '%d'
that converts the \_\_u32 'im\_id' from struct idmap\_msg to 'id\_str', which
is a stack char array variable of length NFS\_UINT\_MAXLEN == 11.
If a uid or gid value is > 2147483647 = 0x7fffffff, the conversion
overflows into a negative value, for example:
crash> p (unsigned) (0x80000000)
$1 = 2147483648
crash> p (signed) (0x80000000)
$2 = -2147483648
The '-' sign is written to the buffer and this causes a 1 byte overflow
when the NULL byte is written, which corrupts kernel stack memory. If
CONFIG\_CC\_STACKPROTECTOR\_STRONG is set we see a stack-protector panic:
[11558053.616565] Kernel panic - not syncing: stack-protector: Kernel stack is corrupted in: ffffffffa05b8a8c
[11558053.639063] CPU: 6 PID: 9423 Comm: rpc.idmapd Tainted: G W ------------ T 3.10.0-514.el7.x86\_64 #1
[11558053.641990] Hardware name: Red Hat OpenStack Compute, BIOS 1.10.2-3.el7\_4.1 04/01/2014
[11558053.644462] ffffffff818c7bc0 00000000b1f3aec1 ffff880de0f9bd48 ffffffff81685eac
[11558053.646430] ffff880de0f9bdc8 ffffffff8167f2b3 ffffffff00000010 ffff880de0f9bdd8
[11558053.648313] ffff880de0f9bd78 00000000b1f3aec1 ffffffff811dcb03 ffffffffa05b8a8c
[11558053.650107] Call Trace:
[11558053.651347] [] dump\_stack+0x19/0x1b
[11558053.653013] [] panic+0xe3/0x1f2
[11558053.666240] [] ? kfree+0x103/0x140
[11558053.682589] [] ? idmap\_pipe\_downcall+0x1cc/0x1e0 [nfsv4]
[11558053.689710] [] \_\_stack\_chk\_fail+0x1b/0x30
[11558053.691619] [] idmap\_pipe\_downcall+0x1cc/0x1e0 [nfsv4]
[11558053.693867] [] rpc\_pipe\_write+0x56/0x70 [sunrpc]
[11558053.695763] [] vfs\_write+0xbd/0x1e0
[11558053.702236] [] ? task\_work\_run+0xac/0xe0
[11558053.704215] [] SyS\_write+0x7f/0xe0
[11558053.709674] [] system\_call\_fastpath+0x16/0x1b
Fix this by calling the internally defined nfs\_map\_numeric\_to\_string()
function which properly uses '%u' to convert this \_\_u32. For consistency,
also replace the one other place where snprintf is called.
Signed-off-by: Dave Wysochanski
Reported-by: Stephen Johnston
Fixes: cf4ab538f1516 ("NFSv4: Fix the string length returned by the idmapper")
Cc: stable@vger.kernel.org # v3.4+
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 2547b0da6c6990f0bd64dbfb503da003c9788151
Author: Scott Mayhew
Date: Mon May 7 09:01:08 2018 -0400
nfsd: restrict rd\_maxcount to svc\_max\_payload in nfsd\_encode\_readdir
commit 9c2ece6ef67e9d376f32823086169b489c422ed0 upstream.
nfsd4\_readdir\_rsize restricts rd\_maxcount to svc\_max\_payload when
estimating the size of the readdir reply, but nfsd\_encode\_readdir
restricts it to INT\_MAX when encoding the reply. This can result in log
messages like "kernel: RPC request reserved 32896 but used 1049444".
Restrict rd\_dircount similarly (no reason it should be larger than
svc\_max\_payload).
Signed-off-by: Scott Mayhew
Cc: stable@vger.kernel.org
Signed-off-by: J. Bruce Fields
Signed-off-by: Greg Kroah-Hartman
commit 96f53ceaaf95b3f3e08e7aaf53454d260047f4f2
Author: Mauro Carvalho Chehab
Date: Thu Apr 5 05:30:52 2018 -0400
media: dvb\_frontend: fix locking issues at dvb\_frontend\_get\_event()
commit 76d81243a487c09619822ef8e7201a756e58a87d upstream.
As warned by smatch:
drivers/media/dvb-core/dvb\_frontend.c:314 dvb\_frontend\_get\_event() warn: inconsistent returns 'sem:&fepriv->sem'.
Locked on: line 288
line 295
line 306
line 314
Unlocked on: line 303
The lock implementation for get event is wrong, as, if an
interrupt occurs, down\_interruptible() will fail, and the
routine will call up() twice when userspace calls the ioctl
again.
The bad code is there since when Linux migrated to git, in
2005.
Cc: stable@vger.kernel.org
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit e53d0ed7a0a0b70b4962029a8f428689466dcdbd
Author: Sean Young
Date: Sun Apr 8 06:36:40 2018 -0400
media: rc: mce\_kbd decoder: fix stuck keys
commit 63039c29f7a4ce8a8bd165173840543c0098d7b0 upstream.
The MCE Remote sends a 0 scancode when keys are released. If this is not
received or decoded, then keys can get "stuck"; the keyup event is not
sent since the input\_sync() is missing from the timeout handler.
Cc: stable@vger.kernel.org
Signed-off-by: Sean Young
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit a4655bea3bfc278adf3ef62a6222ecc088f1e82d
Author: Kai-Heng Feng
Date: Mon Mar 26 02:06:16 2018 -0400
media: cx231xx: Add support for AverMedia DVD EZMaker 7
commit 29e61d6ef061b012d320327af7dbb3990e75be45 upstream.
User reports AverMedia DVD EZMaker 7 can be driven by VIDEO\_GRABBER.
Add the device to the id\_table to make it work.
BugLink: https://bugs.launchpad.net/bugs/1620762
Cc: stable@vger.kernel.org
Signed-off-by: Kai-Heng Feng
Signed-off-by: Hans Verkuil
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 5b7d2179f02201e08e5dd31c9555eadc83bf9db2
Author: Mauro Carvalho Chehab
Date: Wed Apr 11 11:47:32 2018 -0400
media: v4l2-compat-ioctl32: prevent go past max size
commit ea72fbf588ac9c017224dcdaa2019ff52ca56fee upstream.
As warned by smatch:
drivers/media/v4l2-core/v4l2-compat-ioctl32.c:879 put\_v4l2\_ext\_controls32() warn: check for integer overflow 'count'
The access\_ok() logic should check for too big arrays too.
Cc: stable@vger.kernel.org
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit dfa8b39ec33070ee3a47bc39184928cf301a54bc
Author: Brad Love
Date: Thu May 3 17:20:10 2018 -0400
media: cx231xx: Ignore an i2c mux adapter
commit 13a257f8d5a530bd2aa004a067ba1f2b8f5ef76d upstream.
Hauppauge 935C cannot communicate with the si2157
when using the mux adapter returned by the si2168,
so disable it to fix the device.
Signed-off-by: Brad Love
Cc: stable@vger.kernel.org
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit eb57d10156933047079a9543f10b028665bb62c4
Author: ming\_qian
Date: Tue May 8 22:13:08 2018 -0400
media: uvcvideo: Support realtek's UVC 1.5 device
commit f620d1d7afc7db57ab59f35000752840c91f67e7 upstream.
media: uvcvideo: Support UVC 1.5 video probe & commit controls
The length of UVC 1.5 video control is 48, and it is 34 for UVC 1.1.
Change it to 48 for UVC 1.5 device, and the UVC 1.5 device can be
recognized.
More changes to the driver are needed for full UVC 1.5 compatibility.
However, at least the UVC 1.5 Realtek RTS5847/RTS5852 cameras have been
reported to work well.
[laurent.pinchart@ideasonboard.com: Factor out code to helper function, update size checks]
Cc: stable@vger.kernel.org
Signed-off-by: ming\_qian
Signed-off-by: Laurent Pinchart
Tested-by: Kai-Heng Feng
Tested-by: Ana Guerrero Lopez
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 6bf7b1f6acf2b56301e830ee80faa7505398d12d
Author: Kieran Bingham
Date: Fri May 18 16:41:54 2018 -0400
media: vsp1: Release buffers for each video node
commit 83967993f2320575c0ab27a80bf1d7535909c2f4 upstream.
Commit 372b2b0399fc ("media: v4l: vsp1: Release buffers in
start\_streaming error path") introduced a helper to clean up buffers on
error paths, but inadvertently changed the code such that only the
output WPF buffers were cleaned, rather than the video node being
operated on.
Since then vsp1\_video\_cleanup\_pipeline() has grown to perform both video
node cleanup, as well as pipeline cleanup. Split the implementation into
two distinct functions that perform the required work, so that each
video node can release its buffers correctly on streamoff. The pipe
cleanup that was performed in the vsp1\_video\_stop\_streaming() (releasing
the pipe->dl) is moved to the function for clarity.
Fixes: 372b2b0399fc ("media: v4l: vsp1: Release buffers in start\_streaming error path")
Cc: stable@vger.kernel.org # v4.14+
Signed-off-by: Kieran Bingham
Signed-off-by: Laurent Pinchart
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit a127d97b605ddb8a543034b00c2bd1c626bce99f
Author: Adrian Hunter
Date: Thu Jun 7 14:30:02 2018 +0300
perf intel-pt: Fix packet decoding of CYC packets
commit 621a5a327c1e36ffd7bb567f44a559f64f76358f upstream.
Use a 64-bit type so that the cycle count is not limited to 32-bits.
Signed-off-by: Adrian Hunter
Cc: Jiri Olsa
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1528371002-8862-1-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 719cdad75a13ae5a03d0e5ee64e8987fe142f791
Author: Adrian Hunter
Date: Thu May 31 13:23:45 2018 +0300
perf intel-pt: Fix "Unexpected indirect branch" error
commit 9fb523363f6e3984457fee95bb7019395384ffa7 upstream.
Some Atom CPUs can produce FUP packets that contain NLIP (next linear
instruction pointer) instead of CLIP (current linear instruction
pointer). That will result in "Unexpected indirect branch" errors. Fix
by comparing IP to NLIP in that case.
Signed-off-by: Adrian Hunter
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1527762225-26024-5-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 2fd3f5d72b65be710ad631837db99ebba1cc9492
Author: Adrian Hunter
Date: Thu May 31 13:23:44 2018 +0300
perf intel-pt: Fix MTC timing after overflow
commit dd27b87ab5fcf3ea1c060b5e3ab5d31cc78e9f4c upstream.
On some platforms, overflows will clear before MTC wraparound, and there
is no following TSC/TMA packet. In that case the previous TMA is valid.
Since there will be a valid TMA either way, stop setting 'have\_tma' to
false upon overflow.
Signed-off-by: Adrian Hunter
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1527762225-26024-4-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit b8b98ab7e155cc9a31e1b447609e8b89ac992781
Author: Adrian Hunter
Date: Thu May 31 13:23:43 2018 +0300
perf intel-pt: Fix decoding to accept CBR between FUP and corresponding TIP
commit bd2e49ec48feb1855f7624198849eea4610e2286 upstream.
It is possible to have a CBR packet between a FUP packet and
corresponding TIP packet. Stop treating it as an error.
Signed-off-by: Adrian Hunter
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1527762225-26024-3-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit dea2a7f5a71a033f9031f6494a2f69cba1e4aff1
Author: Adrian Hunter
Date: Thu May 31 13:23:42 2018 +0300
perf intel-pt: Fix sync\_switch INTEL\_PT\_SS\_NOT\_TRACING
commit dbcb82b93f3e8322891e47472c89e63058b81e99 upstream.
sync\_switch is a facility to synchronize decoding more closely with the
point in the kernel when the context actually switched.
In one case, INTEL\_PT\_SS\_NOT\_TRACING state was not correctly
transitioning to INTEL\_PT\_SS\_TRACING state due to a missing case clause.
Add it.
Signed-off-by: Adrian Hunter
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/1527762225-26024-2-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit de6f838305eb5a0eaaf020f942fc226afcc85e8d
Author: Adrian Hunter
Date: Mon Jun 4 15:56:54 2018 +0300
perf tools: Fix symbol and object code resolution for vdso32 and vdsox32
commit aef4feace285f27c8ed35830a5d575bec7f3e90a upstream.
Fix \_\_kmod\_path\_\_parse() so that perf tools does not treat vdso32 and
vdsox32 as kernel modules and fail to find the object.
Signed-off-by: Adrian Hunter
Cc: Jiri Olsa
Cc: Wang Nan
Cc: stable@vger.kernel.org
Fixes: 1f121b03d058 ("perf tools: Deal with kernel module names in '[]' correctly")
Link: http://lkml.kernel.org/r/1528117014-30032-3-git-send-email-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 28493295f09208e8b1040c04bff072a4cfcbb36e
Author: Sean Wang
Date: Wed Apr 11 16:53:56 2018 +0800
arm: dts: mt7623: fix invalid memory node being generated
commit c0b0d540db1a8bfb041166c4991dd6f624e8de45 upstream.
Below two wrong nodes in existing DTS files would cause a fail boot since
in fact the address 0 is not the correct place the memory device locates
at.
memory {
device\_type = "memory";
reg = <0x0 0x0 0x0 0x0>;
};
memory@80000000 {
reg = <0x0 0x80000000 0x0 0x40000000>;
};
In order to avoid having a memory node starting at address 0, we can't
include file skeleton64.dtsi and instead need to explicitly manually
define a few of properties the DTS relies on such as #address-cells
and #size-cells in root node and device\_type in the node memory@80000000.
Cc: stable@vger.kernel.org
Fixes: 31ac0d69a1d4 ("ARM: dts: mediatek: add MT7623 basic support")
Signed-off-by: Sean Wang
Cc: Rob Herring
Signed-off-by: Matthias Brugger
Signed-off-by: Greg Kroah-Hartman
commit a9eb2d03252e476735de7ff9752ec6ed16ad7025
Author: Sibi Sankar
Date: Wed Apr 18 01:14:15 2018 +0530
remoteproc: Prevent incorrect rproc state on xfer mem ownership failure
commit 2724807f7f70a6a3e67b3f6bf921cc77ed39c8a1 upstream.
Any failure in the secure call for transferring mem ownership of mba
region to Q6 would result in reporting that the remoteproc device
is running. This is because the previous q6v5\_clk\_enable would have
been a success. Prevent this by updating variable 'ret' accordingly.
Cc: stable@vger.kernel.org
Signed-off-by: Sibi Sankar
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 0c8d1ee930ae452f036669f7462e3efd3fb770ef
Author: Jarkko Nikula
Date: Fri May 18 11:38:27 2018 +0300
mfd: intel-lpss: Fix Intel Cannon Lake LPSS I2C input clock
commit 4e93a658576ab115977225c9d0992b97ff19ba8c upstream.
Intel Cannon Lake PCH has much higher 216 MHz input clock to LPSS I2C
than Sunrisepoint which uses 120 MHz. Preliminary information was that
both share the same clock rate but actual silicon implements elevated
rate for better support for 3.4 MHz high-speed I2C.
This incorrect input clock rate results too high I2C bus clock in case
ACPI doesn't provide tuned I2C timing parameters since I2C host
controller driver calculates them from input clock rate.
Fix this by using the correct rate. We still share the same 230 ns SDA
hold time value than Sunrisepoint.
Cc: stable@vger.kernel.org
Fixes: b418bbff36dd ("mfd: intel-lpss: Add Intel Cannonlake PCI IDs")
Reported-by: Jian-Hong Pan
Reported-by: Chris Chiu
Reported-by: Daniel Drake
Signed-off-by: Jarkko Nikula
Reviewed-by: Andy Shevchenko
Acked-by: Mika Westerberg
Tested-by: Jian-Hong Pan
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit 00b9cb007e41dd2e6e889489308b26c41fbf86ac
Author: Andy Shevchenko
Date: Tue Apr 24 18:00:10 2018 +0300
mfd: intel-lpss: Program REMAP register in PIO mode
commit d28b62520830b2d0bffa2d98e81afc9f5e537e8b upstream.
According to documentation REMAP register has to be programmed in
either DMA or PIO mode of the slice.
Move the DMA capability check below to let REMAP register be programmed
in PIO mode.
Cc: stable@vger.kernel.org # 4.3+
Fixes: 4b45efe85263 ("mfd: Add support for Intel Sunrisepoint LPSS devices")
Signed-off-by: Andy Shevchenko
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit 23c1debbdbe06d6fc1a5bde0e398847c71d32201
Author: Peter Ujfalusi
Date: Mon Apr 9 11:45:39 2018 +0300
mfd: twl-core: Fix clock initialization
commit c218b3b242bd04539621b468f01ecd2af5a21a45 upstream.
When looking up the clock we must use the client->dev as device since that
is the one which is probed via DT.
Cc: stable@vger.kernel.org # 4.16+
Signed-off-by: Peter Ujfalusi
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit a67941723d4dd6d9192790faee628468ca2f11ba
Author: Anton Ivanov
Date: Thu Jun 7 12:43:15 2018 +0100
um: Fix raw interface options
commit 5ec9121195a4f1cecd0fa592636c5f81eb03dc8c upstream.
Raw interface initialization needs QDISC\_BYPASS. Otherwise
it sees its own packets when transmitting.
Fixes: 49da7e64f33e ("High Performance UML Vector Network Driver")
Cc:
Signed-off-by: Anton Ivanov
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 026eef7be810eb9aa5eba9a5435098e0fbbc5d58
Author: Anton Ivanov
Date: Tue Jun 5 09:27:30 2018 +0100
um: Fix initialization of vector queues
commit 4579a1ba692af81da7ea6ce197f8169ddc0c327f upstream.
UML vector drivers could derefence uninitialized memory
when cleaning up after a queue allocation failure.
Fixes: 49da7e64f33e ("High Performance UML Vector Network Driver")
Cc:
Reported-by: Dan Capenter
Signed-off-by: Anton Ivanov
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit bc2bad3b87004ced2c07d185c04386eb8d8d6952
Author: Chao Yu
Date: Mon Apr 9 20:25:06 2018 +0800
f2fs: don't use GFP\_ZERO for page caches
commit 81114baa835b59ed02d14aa1d67f91ea874077cd upstream.
Related to https://lkml.org/lkml/2018/4/8/661
Sometimes, we need to write meta data to new allocated block address,
then we will allocate a zeroed page in inner inode's address space, and
fill partial data in it, and leave other place with zero value which means
some fields are initial status.
There are two inner inodes (meta inode and node inode) setting \_\_GFP\_ZERO,
I have just checked them, for both of them, we can avoid using \_\_GFP\_ZERO,
and do initialization by ourselves to avoid unneeded/redundant zeroing
from mm.
Cc:
Signed-off-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit fca2a4240d9a0a1bbfcc7636e8ca103e52427fea
Author: Linus Torvalds
Date: Mon Jun 11 12:22:12 2018 -0700
Revert "iommu/amd\_iommu: Use CONFIG\_DMA\_DIRECT\_OPS=y and dma\_direct\_{alloc,free}()"
commit e16c4790de39dc861b749674c2a9319507f6f64f upstream.
This reverts commit b468620f2a1dfdcfddfd6fa54367b8bcc1b51248.
It turns out that this broke drm on AMD platforms. Quoting Gabriel C:
"I can confirm reverting b468620f2a1dfdcfddfd6fa54367b8bcc1b51248 fixes
that issue for me.
The GPU is working fine with SME enabled.
Now with working GPU :) I can also confirm performance is back to
normal without doing any other workarounds"
Christan KÃ¶nig analyzed it partially:
"As far as I analyzed it we now get an -ENOMEM from dma\_alloc\_attrs()
in drivers/gpu/drm/ttm/ttm\_page\_alloc\_dma.c when IOMMU is enabled"
and Christoph Hellwig responded:
"I think the prime issue is that dma\_direct\_alloc respects the dma
mask. Which we don't need if actually using the iommu. This would be
mostly harmless exept for the the SEV bit high in the address that
makes the checks fail.
For now I'd say revert this commit for 4.17/4.18-rc and I'll look into
addressing these issues properly"
Reported-and-bisected-by: Gabriel C
Acked-by: Christoph Hellwig
Cc: Christian KÃ¶nig
Cc: Michel DÃ¤nzer
Cc: Joerg Roedel
Cc: Tom Lendacky
Cc: Andrew Morton
Cc: stable@kernel.org # v4.17
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d8c7843981b77386d390e638d1da4915eddd5641
Author: Johan Hovold
Date: Mon Nov 20 11:45:46 2017 +0100
backlight: tps65217\_bl: Fix Device Tree node lookup
commit 2b12dfa124dbadf391cb9a616aaa6b056823bf75 upstream.
Fix child-node lookup during probe, which ended up searching the whole
device tree depth-first starting at the parent rather than just matching
on its children.
This would only cause trouble if the child node is missing while there
is an unrelated node named "backlight" elsewhere in the tree.
Cc: stable  # 3.7
Fixes: eebfdc17cc6c ("backlight: Add TPS65217 WLED driver")
Signed-off-by: Johan Hovold
Acked-by: Daniel Thompson
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit 86053c4b0f6a302d3f1c7dfcb758dc69516ea96f
Author: Johan Hovold
Date: Mon Nov 20 11:45:45 2017 +0100
backlight: max8925\_bl: Fix Device Tree node lookup
commit d1cc0ec3da23e44c23712579515494b374f111c9 upstream.
Fix child-node lookup during probe, which ended up searching the whole
device tree depth-first starting at the parent rather than just matching
on its children.
To make things worse, the parent mfd node was also prematurely freed,
while the child backlight node was leaked.
Cc: stable  # 3.9
Fixes: 47ec340cb8e2 ("mfd: max8925: Support dt for backlight")
Signed-off-by: Johan Hovold
Acked-by: Daniel Thompson
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit 280d922daedc388f17f8981d85465dc8736d826b
Author: Johan Hovold
Date: Mon Nov 20 11:45:44 2017 +0100
backlight: as3711\_bl: Fix Device Tree node lookup
commit 4a9c8bb2aca5b5a2a15744333729745dd9903562 upstream.
Fix child-node lookup during probe, which ended up searching the whole
device tree depth-first starting at the parent rather than just matching
on its children.
To make things worse, the parent mfd node was also prematurely freed.
Cc: stable  # 3.10
Fixes: 59eb2b5e57ea ("drivers/video/backlight/as3711\_bl.c: add OF support")
Signed-off-by: Johan Hovold
Acked-by: Daniel Thompson
Signed-off-by: Lee Jones
Signed-off-by: Greg Kroah-Hartman
commit d49a9fd028016b74f61ebbd98e41cbc899f2df93
Author: Silvio Cesare
Date: Fri May 4 13:44:02 2018 +1000
UBIFS: Fix potential integer overflow in allocation
commit 353748a359f1821ee934afc579cf04572406b420 upstream.
There is potential for the size and len fields in ubifs\_data\_node to be
too large causing either a negative value for the length fields or an
integer overflow leading to an incorrect memory allocation. Likewise,
when the len field is small, an integer underflow may occur.
Signed-off-by: Silvio Cesare
Fixes: 1e51764a3c2ac ("UBIFS: add new flash file system")
Cc: stable@vger.kernel.org
Signed-off-by: Kees Cook
Signed-off-by: Greg Kroah-Hartman
commit 9211df81e8a3a60cb525d995833976f34633f9b8
Author: Richard Weinberger
Date: Mon May 28 22:04:32 2018 +0200
ubi: fastmap: Correctly handle interrupted erasures in EBA
commit 781932375ffc6411713ee0926ccae8596ed0261c upstream.
Fastmap cannot track the LEB unmap operation, therefore it can
happen that after an interrupted erasure the mapping still looks
good from Fastmap's point of view, while reading from the PEB will
cause an ECC error and confuses the upper layer.
Instead of teaching users of UBI how to deal with that, we read back
the VID header and check for errors. If the PEB is empty or shows ECC
errors we fixup the mapping and schedule the PEB for erasure.
Fixes: dbb7d2a88d2a ("UBI: Add fastmap core")
Cc:
Reported-by: martin bayern
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 2162ded7497fedcf4670ae8a2ef2fd6b374d541b
Author: Richard Weinberger
Date: Wed May 16 22:17:03 2018 +0200
ubi: fastmap: Cancel work upon detach
commit 6e7d80161066c99d12580d1b985cb1408bb58cf1 upstream.
Ben Hutchings pointed out that 29b7a6fa1ec0 ("ubi: fastmap: Don't flush
fastmap work on detach") does not really fix the problem, it just
reduces the risk to hit the race window where fastmap work races against
free()'ing ubi->volumes[].
The correct approach is making sure that no more fastmap work is in
progress before we free ubi data structures.
So we cancel fastmap work right after the ubi background thread is
stopped.
By setting ubi->thread\_enabled to zero we make sure that no further work
tries to wake the thread.
Fixes: 29b7a6fa1ec0 ("ubi: fastmap: Don't flush fastmap work on detach")
Fixes: 74cdaf24004a ("UBI: Fastmap: Fix memory leaks while closing the WL sub-system")
Cc: stable@vger.kernel.org
Cc: Ben Hutchings
Cc: Martin Townsend
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 46b10f263b92a0f351a74321b0429b1f8369db42
Author: Srinivas Kandagatla
Date: Mon Jun 4 10:39:01 2018 +0100
rpmsg: smd: do not use mananged resources for endpoints and channels
commit 4a2e84c6ed85434ce7843e4844b4d3263f7e233b upstream.
All the managed resources would be freed by the time release function
is invoked. Handling such memory in qcom\_smd\_edge\_release() would do
bad things.
Found this issue while testing Audio usecase where the dsp is started up
and shutdown in a loop.
This patch fixes this issue by using simple kzalloc for allocating
channel->name and channel which is then freed in qcom\_smd\_edge\_release().
Without this patch restarting a remoteproc would crash the system.
Fixes: 53e2822e56c7 ("rpmsg: Introduce Qualcomm SMD backend")
Cc:
Signed-off-by: Srinivas Kandagatla
Signed-off-by: Bjorn Andersson
Signed-off-by: Greg Kroah-Hartman
commit 4e08619a020674456e390bdfc25563d2165c5065
Author: NeilBrown
Date: Thu Apr 26 14:46:29 2018 +1000
md: fix two problems with setting the "re-add" device state.
commit 011abdc9df559ec75779bb7c53a744c69b2a94c6 upstream.
If "re-add" is written to the "state" file for a device
which is faulty, this has an effect similar to removing
and re-adding the device. It should take up the
same slot in the array that it previously had, and
an accelerated (e.g. bitmap-based) rebuild should happen.
The slot that "it previously had" is determined by
rdev->saved\_raid\_disk.
However this is not set when a device fails (only when a device
is added), and it is cleared when resync completes.
This means that "re-add" will normally work once, but may not work a
second time.
This patch includes two fixes.
1/ when a device fails, record the ->raid\_disk value in
->saved\_raid\_disk before clearing ->raid\_disk
2/ when "re-add" is written to a device for which
->saved\_raid\_disk is not set, fail.
I think this is suitable for stable as it can
cause re-adding a device to be forced to do a full
resync which takes a lot longer and so puts data at
more risk.
Cc:  (v4.1)
Fixes: 97f6cd39da22 ("md-cluster: re-add capabilities")
Signed-off-by: NeilBrown
Reviewed-by: Goldwyn Rodrigues
Signed-off-by: Shaohua Li
Signed-off-by: Greg Kroah-Hartman
commit b0b68cc5d7bfd0a036687592baf8879634ca29a5
Author: Michael Trimarchi
Date: Wed May 30 23:57:44 2018 +0530
rtc: sun6i: Fix bit\_idx value for clk\_register\_gate
commit 09018d4bd7994c2c9f775029bc24589bc85f76fa upstream.
clk-gate core will take bit\_idx through clk\_register\_gate
and then do clk\_gate\_ops by using BIT(bit\_idx), but rtc-sun6i
is passing bit\_idx as BIT(bit\_idx) it becomes BIT(BIT(bit\_idx)
which is wrong and eventually external gate clock is not enabling.
This patch fixed by passing bit index and the original change
introduced from below commit.
"rtc: sun6i: Add support for the external oscillator gate"
(sha1: 17ecd246414b3a0fe0cb248c86977a8bda465b7b)
Signed-off-by: Michael Trimarchi
Fixes: 17ecd246414b ("rtc: sun6i: Add support for the external oscillator gate")
Cc: stable@vger.kernel.org
Signed-off-by: Jagan Teki
Acked-by: Maxime Ripard
Signed-off-by: Alexandre Belloni
Signed-off-by: Greg Kroah-Hartman
commit abbfa3a4e3188280e2664cc9c042fc9f63bc4afd
Author: Marcin Ziemianowicz
Date: Sun Apr 29 15:01:11 2018 -0400
clk: at91: PLL recalc\_rate() now using cached MUL and DIV values
commit a982e45dc150da3a08907b6dd676b735391704b4 upstream.
When a USB device is connected to the USB host port on the SAM9N12 then
you get "-62" error which seems to indicate USB replies from the device
are timing out. Based on a logic sniffer, I saw the USB bus was running
at half speed.
The PLL code uses cached MUL and DIV values which get set in set\_rate()
and applied in prepare(), but the recalc\_rate() function instead
queries the hardware instead of using these cached values. Therefore,
if recalc\_rate() is called between a set\_rate() and prepare(), the
wrong frequency is calculated and later the USB clock divider for the
SAM9N12 SOC will be configured for an incorrect clock.
In my case, the PLL hardware was set to 96 Mhz before the OHCI
driver loads, and therefore the usb clock divider was being set
to /2 even though the OHCI driver set the PLL to 48 Mhz.
As an alternative explanation, I noticed this was fixed in the past by
87e2ed338f1b ("clk: at91: fix recalc\_rate implementation of PLL
driver") but the bug was later re-introduced by 1bdf02326b71 ("clk:
at91: make use of syscon/regmap internally").
Fixes: 1bdf02326b71 ("clk: at91: make use of syscon/regmap internally)
Cc:
Signed-off-by: Marcin Ziemianowicz
Acked-by: Boris Brezillon
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit 87f5d29340113f78d766129e4fc81d36cac10b4e
Author: Martin Blumenstingl
Date: Sun May 20 19:16:06 2018 +0200
clk: meson: meson8b: mark fclk\_div2 gate clocks as CLK\_IS\_CRITICAL
commit 72e1f2302040398dafb64bbb93abdde78c1f2267 upstream.
Until commit 05f814402d6174 ("clk: meson: add fdiv clock gates") we
relied on the bootloader to enable the fclk\_div clock gates. It turns
out that our clock tree is incomplete at least on Meson8b (tested with
an Odroid-C1, which uses an RGMII PHY) because after the mentioned
commit Ethernet is not working anymore (no RX/TX activity can be seen).
At the same time Ethernet was still working on Meson8m2 with a RMII PHY.
Testing has shown that as soon as "fclk\_div2" is disabled Ethernet stops
working on Odroid-C1. Unfortunately it's currently not clear what the
Ethernet controller IP block uses the fclk\_div2 clock for. Mark the
clock as CLK\_IS\_CRITICAL to keep it enabled (as it's already enabled by
most bootloaders by default, which is why we didn't notice it before).
Fixes: 05f814402d6174 ("clk: meson: add fdiv clock gates")
Cc: stable@vger.kernel.org
Signed-off-by: Martin Blumenstingl
Tested-by: Kevin Hilman
Signed-off-by: Jerome Brunet
Signed-off-by: Greg Kroah-Hartman
commit a90be8e17ebe7cfd60ecf0541125abc96ed5a366
Author: Ross Zwisler
Date: Wed Jun 6 10:45:13 2018 -0600
libnvdimm, pmem: Unconditionally deep flush on \*sync
commit ce7f11a230d5b7165480b96c0cc7a90358b5b5e2 upstream.
Prior to this commit we would only do a "deep flush" (have nvdimm\_flush()
write to each of the flush hints for a region) in response to an
msync/fsync/sync call if the nvdimm\_has\_cache() returned true at the time
we were setting up the request queue. This happens due to the write cache
value passed in to blk\_queue\_write\_cache(), which then causes the block
layer to send down BIOs with REQ\_FUA and REQ\_PREFLUSH set. We do have a
"write\_cache" sysfs entry for namespaces, i.e.:
/sys/bus/nd/devices/pfn0.1/block/pmem0/dax/write\_cache
which can be used to control whether or not the kernel thinks a given
namespace has a write cache, but this didn't modify the deep flush behavior
that we set up when the driver was initialized. Instead, it only modified
whether or not DAX would flush CPU caches via dax\_flush() in response to
\*sync calls.
Simplify this by making the \*sync deep flush always happen, regardless of
the write cache setting of a namespace. The DAX CPU cache flushing will
still be controlled the write\_cache setting of the namespace.
Cc:
Fixes: 5fdf8e5ba566 ("libnvdimm: re-enable deep flush for pmem devices via fsync()")
Signed-off-by: Ross Zwisler
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit 4bc3f448b0ede75975925dfa8fb06b32b4bf05e4
Author: Robert Elliott
Date: Thu May 31 18:36:36 2018 -0500
linvdimm, pmem: Preserve read-only setting for pmem devices
commit 254a4cd50b9fe2291a12b8902e08e56dcc4e9b10 upstream.
The pmem driver does not honor a forced read-only setting for very long:
$ blockdev --setro /dev/pmem0
$ blockdev --getro /dev/pmem0
1
followed by various commands like these:
$ blockdev --rereadpt /dev/pmem0
or
$ mkfs.ext4 /dev/pmem0
results in this in the kernel serial log:
nd\_pmem namespace0.0: region0 read-write, marking pmem0 read-write
with the read-only setting lost:
$ blockdev --getro /dev/pmem0
0
That's from bus.c nvdimm\_revalidate\_disk(), which always applies the
setting from nd\_region (which is initially based on the ACPI NFIT
NVDIMM state flags not\_armed bit).
In contrast, commit 20bd1d026aac ("scsi: sd: Keep disk read-only when
re-reading partition") fixed this issue for SCSI devices to preserve
the previous setting if it was set to read-only.
This patch modifies bus.c to preserve any previous read-only setting.
It also eliminates the kernel serial log print except for cases where
read-write is changed to read-only, so it doesn't print read-only to
read-only non-changes.
Cc:
Fixes: 581388209405 ("libnvdimm, nfit: handle unarmed dimms, mark namespaces read-only")
Signed-off-by: Robert Elliott
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit cfb80b3e275285f9740e3617c8178401684b635a
Author: Steffen Maier
Date: Thu May 17 19:14:49 2018 +0200
scsi: zfcp: fix missing REC trigger trace on enqueue without ERP thread
commit 6a76550841d412330bd86aed3238d1888ba70f0e upstream.
Example trace record formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : REC
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1 ZFCP\_DBF\_REC\_TRIG
Tag : .......
LUN : 0x...
WWPN : 0x...
D\_ID : 0x...
Adapter status : 0x...
Port status : 0x...
LUN status : 0x...
Ready count : 0x...
Running count : 0x...
ERP want : 0x0. ZFCP\_ERP\_ACTION\_REOPEN\_...
ERP need : 0xc0 ZFCP\_ERP\_ACTION\_NONE
Signed-off-by: Steffen Maier
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 56bcb85ccb9899740a5118d2c50f0df57221ec4b
Author: Steffen Maier
Date: Thu May 17 19:14:48 2018 +0200
scsi: zfcp: fix missing REC trigger trace for all objects in ERP\_FAILED
commit 8c3d20aada70042a39c6a6625be037c1472ca610 upstream.
That other commit introduced an inconsistency because it would trace on
ERP\_FAILED for all callers of port forced reopen triggers (not just
terminate\_rport\_io), but it would not trace on ERP\_FAILED for all callers of
other ERP triggers such as adapter, port regular, LUN.
Therefore, generalize that other commit. zfcp\_erp\_action\_enqueue() already
had two early outs which re-used the one zfcp\_dbf\_rec\_trig() call. All ERP
trigger functions finally run through zfcp\_erp\_action\_enqueue(). So move
the special handling for ZFCP\_STATUS\_COMMON\_ERP\_FAILED into
zfcp\_erp\_action\_enqueue() and add another early out with new trace marker
for pseudo ERP need in this case. This removes all early returns from all
ERP trigger functions so we always end up at zfcp\_dbf\_rec\_trig().
Example trace record formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : REC
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1 ZFCP\_DBF\_REC\_TRIG
Tag : .......
LUN : 0x...
WWPN : 0x...
D\_ID : 0x...
Adapter status : 0x...
Port status : 0x...
LUN status : 0x...
Ready count : 0x...
Running count : 0x...
ERP want : 0x0. ZFCP\_ERP\_ACTION\_REOPEN\_...
ERP need : 0xe0 ZFCP\_ERP\_ACTION\_FAILED
Signed-off-by: Steffen Maier
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit a671d81eb7808e89afe306d6ffced378bca72b25
Author: Steffen Maier
Date: Thu May 17 19:14:47 2018 +0200
scsi: zfcp: fix missing REC trigger trace on terminate\_rport\_io for ERP\_FAILED
commit d70aab55924b44f213fec2b900b095430b33eec6 upstream.
For problem determination we always want to see when we were invoked on the
terminate\_rport\_io callback whether we perform something or not.
Temporal event sequence of interest with a long fast\_io\_fail\_tmo of 27 sec:
loose remote port
t workqueue
[s] zfcp\_q\_ IRQ zfcperp
=== ================== =================== ============================
0 recv RSCN
q p.test\_link\_work
block rport
start fast\_io\_fail\_tmo
send ADISC ELS
4 recv ADISC fail
block zfcp\_port
port forced reopen
send open port
12 recv open port fail
q p.gid\_pn\_work
zfcp\_erp\_wakeup
(zfcp\_erp\_wait would return)
GID\_PN fail
Before this point, we got a SCSI trace with tag "sctrpi1" on fast\_io\_fail,
e.g. with the typical 5 sec setting.
port.status |= ERP\_FAILED
If fast\_io\_fail\_tmo triggers after this point, we missed a SCSI trace.
workqueue
fc\_dl\_
==================
27 fc\_timeout\_fail\_rport\_io
fc\_terminate\_rport\_io
zfcp\_scsi\_terminate\_rport\_io
zfcp\_erp\_port\_forced\_reopen
\_zfcp\_erp\_port\_forced\_reopen
if (port.status & ERP\_FAILED)
return;
Therefore, write a trace before above early return.
Example trace record formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : REC
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1 ZFCP\_DBF\_REC\_TRIG
Tag : sctrpi1 SCSI terminate rport I/O
LUN : 0xffffffffffffffff none (invalid)
WWPN : 0x
D\_ID : 0x
Adapter status : 0x...
Port status : 0x...
LUN status : 0x00000000 none (invalid)
Ready count : 0x...
Running count : 0x...
ERP want : 0x03 ZFCP\_ERP\_ACTION\_REOPEN\_PORT\_FORCED
ERP need : 0xe0 ZFCP\_ERP\_ACTION\_FAILED
Signed-off-by: Steffen Maier
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 7ee4ac8af0fca7503bc96c479972f9caf6d315cf
Author: Steffen Maier
Date: Thu May 17 19:14:46 2018 +0200
scsi: zfcp: fix missing REC trigger trace on terminate\_rport\_io early return
commit 96d9270499471545048ed8a6d7f425a49762283d upstream.
get\_device() and its internally used kobject\_get() only return NULL if they
get passed NULL as argument. zfcp\_get\_port\_by\_wwpn() loops over
adapter->port\_list so the iteration variable port is always non-NULL.
Struct device is embedded in struct zfcp\_port so &port->dev is always
non-NULL. This is the argument to get\_device(). However, if we get an
fc\_rport in terminate\_rport\_io() for which we cannot find a match within
zfcp\_get\_port\_by\_wwpn(), the latter can return NULL. v2.6.30 commit
70932935b61e ("[SCSI] zfcp: Fix oops when port disappears") introduced an
early return without adding a trace record for this case. Even if we don't
need recovery in this case, for debugging we should still see that our
callback was invoked originally by scsi\_transport\_fc.
Example trace record formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : REC
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1
Tag : sctrpin SCSI terminate rport I/O, no zfcp port
LUN : 0xffffffffffffffff none (invalid)
WWPN : 0x WWPN
D\_ID : 0x N\_Port-ID
Adapter status : 0x...
Port status : 0xffffffff unknown (-1)
LUN status : 0x00000000 none (invalid)
Ready count : 0x...
Running count : 0x...
ERP want : 0x03 ZFCP\_ERP\_ACTION\_REOPEN\_PORT\_FORCED
ERP need : 0xc0 ZFCP\_ERP\_ACTION\_NONE
Signed-off-by: Steffen Maier
Fixes: 70932935b61e ("[SCSI] zfcp: Fix oops when port disappears")
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 9a5fa89470c870230c98cc4a775cc87185359991
Author: Steffen Maier
Date: Thu May 17 19:14:45 2018 +0200
scsi: zfcp: fix misleading REC trigger trace where erp\_action setup failed
commit 512857a795cbbda5980efa4cdb3c0b6602330408 upstream.
If a SCSI device is deleted during scsi\_eh host reset, we cannot get a
reference to the SCSI device anymore since scsi\_device\_get returns !=0 by
design. Assuming the recovery of adapter and port(s) was successful,
zfcp\_erp\_strategy\_followup\_success() attempts to trigger a LUN reset for the
half-gone SCSI device. Unfortunately, it causes the following confusing
trace record which states that zfcp will do a LUN recovery as "ERP need" is
ZFCP\_ERP\_ACTION\_REOPEN\_LUN == 1 and equals "ERP want".
Old example trace record formatted with zfcpdbf from s390-tools:
Tag: : ersfs\_3 ERP, trigger, unit reopen, port reopen succeeded
LUN : 0x
WWPN : 0x
D\_ID : 0x
Adapter status : 0x5400050b
Port status : 0x54000001
LUN status : 0x40000000 ZFCP\_STATUS\_COMMON\_RUNNING
but not ZFCP\_STATUS\_COMMON\_UNBLOCKED as it
was closed on close part of adapter reopen
ERP want : 0x01
ERP need : 0x01 misleading
However, zfcp\_erp\_setup\_act() returns NULL as it cannot get the reference.
Hence, zfcp\_erp\_action\_enqueue() takes an early goto out and \_NO\_ recovery
actually happens.
We always do want the recovery trigger trace record even if no erp\_action
could be enqueued as in this case. For other cases where we did not enqueue
an erp\_action, 'need' has always been zero to indicate this. In order to
indicate above goto out, introduce an eyecatcher "flag" to mark the "ERP
need" as 'not needed' but still keep the information which erp\_action type,
that zfcp\_erp\_required\_act() had decided upon, is needed. 0xc\_ is chosen to
be visibly different from 0x0\_ in "ERP want".
New example trace record formatted with zfcpdbf from s390-tools:
Tag: : ersfs\_3 ERP, trigger, unit reopen, port reopen succeeded
LUN : 0x
WWPN : 0x
D\_ID : 0x
Adapter status : 0x5400050b
Port status : 0x54000001
LUN status : 0x40000000
ERP want : 0x01
ERP need : 0xc1 would need LUN ERP, but no action set up
^
Before v2.6.38 commit ae0904f60fab ("[SCSI] zfcp: Redesign of the debug
tracing for recovery actions.") we could detect this case because the
"erp\_action" field in the trace was NULL. The rework removed erp\_action as
argument and field from the trace.
This patch here is for tracing. A fix to allow LUN recovery in the case at
hand is a topic for a separate patch.
See also commit fdbd1c5e27da ("[SCSI] zfcp: Allow running unit/LUN shutdown
without acquiring reference") for a similar case and background info.
Signed-off-by: Steffen Maier
Fixes: ae0904f60fab ("[SCSI] zfcp: Redesign of the debug tracing for recovery actions.")
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit fee64fc23de13e1d6d188cbba79e0764ee045b0d
Author: Steffen Maier
Date: Thu May 17 19:14:44 2018 +0200
scsi: zfcp: fix missing SCSI trace for retry of abort / scsi\_eh TMF
commit 81979ae63e872ef650a7197f6ce6590059d37172 upstream.
We already have a SCSI trace for the end of abort and scsi\_eh TMF. Due to
zfcp\_erp\_wait() and fc\_block\_scsi\_eh() time can pass between the start of
our eh callback and an actual send/recv of an abort / TMF request. In order
to see the temporal sequence including any abort / TMF send retries, add a
trace before the above two blocking functions. This supports problem
determination with scsi\_eh and parallel zfcp ERP.
No need to explicitly trace the beginning of our eh callback, since we
typically can send an abort / TMF and see its HBA response (in the worst
case, it's a pseudo response on dismiss all of adapter recovery, e.g. due to
an FSF request timeout [fsrth\_1] of the abort / TMF). If we cannot send, we
now get a trace record for the first "abrt\_wt" or "[lt]r\_wait" which denotes
almost the beginning of the callback.
No need to explicitly trace the wakeup after the above two blocking
functions because the next retry loop causes another trace in any case and
that is sufficient.
Example trace records formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : SCSI
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1
Tag : abrt\_wt abort, before zfcp\_erp\_wait()
Request ID : 0x0000000000000000 none (invalid)
SCSI ID : 0x
SCSI LUN : 0x
SCSI LUN high : 0x
SCSI result : 0x
SCSI retries : 0x
SCSI allowed : 0x
SCSI scribble : 0x
SCSI opcode :
FCP rsp inf cod: 0x.. none (invalid)
FCP rsp IU : ... none (invalid)
Timestamp : ...
Area : SCSI
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1
Tag : lr\_wait LUN reset, before zfcp\_erp\_wait()
Request ID : 0x0000000000000000 none (invalid)
SCSI ID : 0x
SCSI LUN : 0x
SCSI LUN high : 0x
SCSI result : 0x... unrelated
SCSI retries : 0x.. unrelated
SCSI allowed : 0x.. unrelated
SCSI scribble : 0x... unrelated
SCSI opcode : ... unrelated
FCP rsp inf cod: 0x.. none (invalid)
FCP rsp IU : ... none (invalid)
Signed-off-by: Steffen Maier
Fixes: 63caf367e1c9 ("[SCSI] zfcp: Improve reliability of SCSI eh handlers in zfcp")
Fixes: af4de36d911a ("[SCSI] zfcp: Block scsi\_eh thread for rport state BLOCKED")
Cc:  #2.6.38+
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit a39141dc0b8a5eec80504f3f27fe0e8965c3b22f
Author: Steffen Maier
Date: Thu May 17 19:14:43 2018 +0200
scsi: zfcp: fix missing SCSI trace for result of eh\_host\_reset\_handler
commit df30781699f53e4fd4c494c6f7dd16e3d5c21d30 upstream.
For problem determination we need to see whether and why we were successful
or not. This allows deduction of scsi\_eh escalation.
Example trace record formatted with zfcpdbf from s390-tools:
Timestamp : ...
Area : SCSI
Subarea : 00
Level : 1
Exception : -
CPU ID : ..
Caller : 0x...
Record ID : 1
Tag : schrh\_r SCSI host reset handler result
Request ID : 0x0000000000000000 none (invalid)
SCSI ID : 0xffffffff none (invalid)
SCSI LUN : 0xffffffff none (invalid)
SCSI LUN high : 0xffffffff none (invalid)
SCSI result : 0x00002002 field re-used for midlayer value: SUCCESS
or in other cases: 0x2009 == FAST\_IO\_FAIL
SCSI retries : 0xff none (invalid)
SCSI allowed : 0xff none (invalid)
SCSI scribble : 0xffffffffffffffff none (invalid)
SCSI opcode : ffffffff ffffffff ffffffff ffffffff none (invalid)
FCP rsp inf cod: 0xff none (invalid)
FCP rsp IU : 00000000 00000000 00000000 00000000 none (invalid)
00000000 00000000
v2.6.35 commit a1dbfddd02d2 ("[SCSI] zfcp: Pass return code from
fc\_block\_scsi\_eh to scsi eh") introduced the first return with something
other than the previously hardcoded single SUCCESS return path.
Signed-off-by: Steffen Maier
Fixes: a1dbfddd02d2 ("[SCSI] zfcp: Pass return code from fc\_block\_scsi\_eh to scsi eh")
Cc:  #2.6.38+
Reviewed-by: Jens Remus
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 5d91d06a69dc9d847ee51029270d6334bfe956a9
Author: Mikhail Malygin
Date: Wed Jun 13 13:05:57 2018 +0000
scsi: qla2xxx: Spinlock recursion in qla\_target
commit 49d7bd36813ea8e6b4c97b640d24e7fbd44c84f0 upstream.
The patch reverts changes done in qlt\_schedule\_sess\_for\_deletion() to
avoid spinlock recursion sess->vha->work\_lock should be used instead
of ha->tgt.sess\_lock, that can be locked in callers: qlt\_reset() or
qlt\_handle\_login()
[mkp: roll in build warning reported by sfr]
Fixes: 1c6cacf4ea6c04 ("scsi: qla2xxx: Fixup locking for session deletion")
Cc:  #v4.17
Signed-off-by: Mikhail Malygin
Reported-by: Mikhail Malygin
Tested-by: Mikhail Malygin
Acked-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 2880dcd24ee633062ea6f4466c11a50af4654e9b
Author: Anil Gurumurthy
Date: Wed Jun 6 08:41:42 2018 -0700
scsi: qla2xxx: Mask off Scope bits in retry delay
commit 3cedc8797b9c0f2222fd45a01f849c57c088828b upstream.
Some newer target uses "Status Qualifier" response in a returned "Busy
Status". This new response code of 0x4001, which is "Scope" bits,
translates to "Affects all units accessible by target". Due to this new
value returned in the Scope bits, driver was using that value as timeout
value which resulted into driver waiting for 27min timeout.
This patch masks off this Scope bits so that driver does not use this
value as retry delay time.
Cc:
Signed-off-by: Anil Gurumurthy
Signed-off-by: Giridhar Malavali
Signed-off-by: Himanshu Madhani
Reviewed-by: Ewan D. Milne
Reviewed-by: Martin Wilck
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 4988b9fb1773fe2bd5dde6e1529e41f5d6851830
Author: Himanshu Madhani
Date: Sun Jun 3 22:09:53 2018 -0700
scsi: qla2xxx: Fix setting lower transfer speed if GPSC fails
commit 413c2f33489b134e3cc65d9c3ff7861e8fdfe899 upstream.
This patch prevents driver from setting lower default speed of 1 GB/sec,
if the switch does not support Get Port Speed Capabilities (GPSC)
command. Setting this default speed results into much lower write
performance for large sequential WRITE. This patch modifies driver to
check for gpsc\_supported flags and prevents driver from issuing
MBC\_SET\_PORT\_PARAM (001Ah) to set default speed of 1 GB/sec. If driver
does not send this mailbox command, firmware assumes maximum supported
link speed and will operate at the max speed.
Cc: stable@vger.kernel.org
Signed-off-by: Himanshu Madhani
Reported-by: Eda Zhou
Reviewed-by: Ewan D. Milne
Tested-by: Ewan D. Milne
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 09d4c4ef82a19b042e59b1901e6528d040555a37
Author: Quinn Tran
Date: Tue May 1 09:01:46 2018 -0700
scsi: qla2xxx: Delete session for nport id change
commit 1d317b21231bb2b81a6e0f94f708b8619ec8775b upstream.
This patch fixes regression introduced by commit a4239945b8ad ("scsi:
qla2xxx: Add switch command to simplify fabric discovery") by scheduling
session deletion when Nport ID changes.
[mkp: clarified commit]
Fixes: a4239945b8ad ("scsi: qla2xxx: Add switch command to simplify fabric discovery")
Cc:
Signed-off-by: Quinn Tran
Signed-off-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit e956c1569c09fccc31d67ded3eb543bc56fd59ce
Author: Sinan Kaya
Date: Sat Jun 2 00:28:53 2018 -0400
scsi: hpsa: disable device during shutdown
commit 0d98ba8d70b0070ac117452ea0b663e26bbf46bf upstream.
'Commit cc27b735ad3a ("PCI/portdrv: Turn off PCIe services during
shutdown")' has been added to kernel to shutdown pending PCIe port service
interrupts during reboot so that a newly started kexec kernel wouldn't
observe pending interrupts.
pcie\_port\_device\_remove() is disabling the root port and switches by
calling pci\_disable\_device() after all PCIe service drivers are shutdown.
This has been found to cause crashes on HP DL360 Gen9 machines during
reboot due to hpsa driver not clearing the bus master bit during the
shutdown procedure by calling pci\_disable\_device().
Disable device as part of the shutdown sequence.
Signed-off-by: Sinan Kaya
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=199779
Fixes: cc27b735ad3a ("PCI/portdrv: Turn off PCIe services during shutdown")
Cc: stable@vger.kernel.org
Reported-by: Ryan Finnie
Tested-by: Don Brace
Acked-by: Don Brace
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 7e7a859106fce05763f6010884fcac01d18f3566
Author: Luis Henriques
Date: Mon Jun 18 17:08:03 2018 +0100
scsi: scsi\_debug: Fix memory leak on module unload
commit 52ab9768f723823a71dc659f0fad803a90f80236 upstream.
Since commit 80c49563e250 ("scsi: scsi\_debug: implement IMMED bit") there
are long delays in F\_SYNC\_DELAY and F\_SSU\_DELAY. This can cause a memory
leak in schedule\_resp(), which can be invoked while unloading the
scsi\_debug module: free\_all\_queued() had already freed all sd\_dp and
schedule\_resp will alloc a new one, which will never get freed. Here's the
kmemleak report while running xfstests generic/350:
unreferenced object 0xffff88007d752b00 (size 128):
comm "rmmod", pid 26940, jiffies 4295816945 (age 7.588s)
hex dump (first 32 bytes):
00 2b 75 7d 00 88 ff ff 00 00 00 00 00 00 00 00 .+u}............
00 00 00 00 00 00 00 00 8e 31 a2 34 5f 03 00 00 .........1.4\_...
backtrace:
[<000000002abd83d0>] 0xffffffffa000705e
[<000000004c063fda>] scsi\_dispatch\_cmd+0xc7/0x1a0
[<000000000c119a00>] scsi\_request\_fn+0x251/0x550
[<000000009de0c736>] \_\_blk\_run\_queue+0x3f/0x60
[<000000001c4453c8>] blk\_execute\_rq\_nowait+0x98/0xd0
[<00000000d17ec79f>] blk\_execute\_rq+0x3a/0x50
[<00000000a7654b6e>] scsi\_execute+0x113/0x250
[<00000000fd78f7cd>] sd\_sync\_cache+0x95/0x160
[<0000000024dacb14>] sd\_shutdown+0x9b/0xd0
[<00000000e9101710>] sd\_remove+0x5f/0xb0
[<00000000c43f0d63>] device\_release\_driver\_internal+0x13c/0x1f0
[<00000000e8ad57b6>] bus\_remove\_device+0xe9/0x160
[<00000000713a7b8a>] device\_del+0x120/0x320
[<00000000e5db670c>] \_\_scsi\_remove\_device+0x115/0x150
[<00000000eccbef30>] scsi\_forget\_host+0x20/0x60
[<00000000cd5a0738>] scsi\_remove\_host+0x6d/0x120
Cc: stable@vger.kernel.org # v4.17+
Signed-off-by: Luis Henriques
Acked-by: Douglas Gilbert
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 0bccb4aa0d4f44e24c6662a76d0a68f5b9aa6d3a
Author: Dan Williams
Date: Thu Apr 19 21:32:19 2018 -0700
mm: fix \_\_gup\_device\_huge vs unmap
commit a9b6de77b1a3ff729f7bfc54b2e17711776a416c upstream.
get\_user\_pages\_fast() for device pages is missing the typical validation
that all page references have been taken while the mapping was valid.
Without this validation truncate operations can not reliably coordinate
against new page reference events like O\_DIRECT.
Cc:
Fixes: 3565fce3a659 ("mm, x86: get\_user\_pages() for dax mappings")
Reported-by: Jan Kara
Reviewed-by: Jan Kara
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit d1dbe4ccfec137ba98888b3d62b503a255645410
Author: Christophe JAILLET
Date: Sun Apr 8 21:44:01 2018 +0200
iio: sca3000: Fix an error handling path in 'sca3000\_probe()'
commit 4a5b45383ca371e123ba103d34d4b3b87616245c upstream.
Use 'devm\_iio\_kfifo\_allocate()' instead of 'iio\_kfifo\_allocate()' in order
to simplify code and avoid a memory leak in an error path in
'sca3000\_probe()'. A call to 'sca3000\_unconfigure\_ring()' was missing.
Sent via the next merge window as unimportant bug and there are
other patches dependent on it.
Signed-off-by: Christophe JAILLET
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 4c4501247384557f2a73cb6baf5c90ff74c24ff6
Author: Alexandru Ardelean
Date: Mon Mar 12 14:06:53 2018 +0200
iio: adc: ad7791: remove sample freq sysfs attributes
commit 7eb6b35d93c356f1afebbfb808bc296d6351e708 upstream.
In the current state, these attributes are broken, because they are
registered already, and the kernel throws a warning.
The first registration happens via the `IIO\_CHAN\_INFO\_SAMP\_FREQ` flag from
the `ad\_sigma\_delta` driver.
In this commit these attrs are removed, and in the following the
IIO\_CHAN\_INFO\_SAMP\_FREQ behavior will be implemented, which replaces these
hooks.
This is done to make things a bit easier to review as there is a bit of
overlap in the patch if it's done all at once.
Fixes: a13e831fcaa7 ("staging: iio: ad7192: implement IIO\_CHAN\_INFO\_SAMP\_FREQ")
Signed-off-by: Alexandru Ardelean
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit b3643ef1ca815808e354f2a034ee98f02cbbc9e2
Author: Filipe Manana
Date: Mon Jun 11 19:24:16 2018 +0100
Btrfs: fix return value on rename exchange failure
commit c5b4a50b74018b3677098151ec5f4fce07d5e6a0 upstream.
If we failed during a rename exchange operation after starting/joining a
transaction, we would end up replacing the return value, stored in the
local 'ret' variable, with the return value from btrfs\_end\_transaction().
So this could end up returning 0 (success) to user space despite the
operation having failed and aborted the transaction, because if there are
multiple tasks having a reference on the transaction at the time
btrfs\_end\_transaction() is called by the rename exchange, that function
returns 0 (otherwise it returns -EIO and not the original error value).
So fix this by not overwriting the return value on error after getting
a transaction handle.
Fixes: cdd1fedf8261 ("btrfs: add support for RENAME\_EXCHANGE and RENAME\_WHITEOUT")
CC: stable@vger.kernel.org # 4.9+
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 31b3044dc5020d85ade8d6731a27fdbc7dbdcbbd
Author: Maciej S. Szmigiero
Date: Sat May 19 14:23:54 2018 +0200
X.509: unpack RSA signatureValue field from BIT STRING
commit b65c32ec5a942ab3ada93a048089a938918aba7f upstream.
The signatureValue field of a X.509 certificate is encoded as a BIT STRING.
For RSA signatures this BIT STRING is of so-called primitive subtype, which
contains a u8 prefix indicating a count of unused bits in the encoding.
We have to strip this prefix from signature data, just as we already do for
key data in x509\_extract\_key\_data() function.
This wasn't noticed earlier because this prefix byte is zero for RSA key
sizes divisible by 8. Since BIT STRING is a big-endian encoding adding zero
prefixes has no bearing on its value.
The signature length, however was incorrect, which is a problem for RSA
implementations that need it to be exactly correct (like AMD CCP).
Signed-off-by: Maciej S. Szmigiero
Fixes: c26fd69fa009 ("X.509: Add a crypto key parser for binary (DER) X.509 certificates")
Cc: stable@vger.kernel.org
Signed-off-by: James Morris
Signed-off-by: Greg Kroah-Hartman
commit 00d2cb166d8342050c1bfc707bdbe9fb1bc428ba
Author: Waiman Long
Date: Thu May 24 09:26:38 2018 -0400
locking/rwsem: Fix up\_read\_non\_owner() warning with DEBUG\_RWSEMS
commit 03eeafdd9ab06a770d42c2b264d50dff7e2f4eee upstream.
It was found that the use of up\_read\_non\_owner() in NFS was causing
the following warning when DEBUG\_RWSEMS was configured.
DEBUG\_LOCKS\_WARN\_ON(sem->owner != ((struct task\_struct \*)(1UL << 0)))
Looking into the rwsem.c file, it was discovered that the corresponding
down\_read\_non\_owner() function was not setting the owner field properly.
This is fixed now, and the warning should be gone.
Fixes: 5149cbac4235 ("locking/rwsem: Add DEBUG\_RWSEMS to look for lock/unlock mismatches")
Signed-off-by: Waiman Long
Signed-off-by: Thomas Gleixner
Acked-by: Peter Zijlstra (Intel)
Tested-by: Gavin Schenk
Cc: Davidlohr Bueso
Cc: Dan Williams
Cc: Arnd Bergmann
Cc: linux-nfs@vger.kernel.org
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/1527168398-4291-1-git-send-email-longman@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 3f695ef9c4dc0945555398b89d1a50cd1b035149
Author: Yang Yingliang
Date: Fri Jun 22 10:52:51 2018 +0100
irqchip/gic-v3-its: Don't bind LPI to unavailable NUMA node
commit c1797b11a09c8323c92b074fd48b89a936c991d0 upstream.
On a NUMA system, if an ITS is local to an offline node, the ITS driver may
pick an offline CPU to bind the LPI. In this case, pick an online CPU (and
the first one will do).
But on some systems, binding an LPI to non-local node CPU may cause
deadlock (see Cavium erratum 23144). In this case, just fail the activate
and return an error code.
Signed-off-by: Yang Yingliang
Signed-off-by: Marc Zyngier
Signed-off-by: Thomas Gleixner
Cc: Jason Cooper
Cc: Alexandre Belloni
Cc: Sumit Garg
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20180622095254.5906-5-marc.zyngier@arm.com
Signed-off-by: Greg Kroah-Hartman
commit 8a42ff24cfc7fee97b9a269652436da305903e56
Author: Geert Uytterhoeven
Date: Fri Jun 22 16:33:57 2018 +0200
time: Make sure jiffies\_to\_msecs() preserves non-zero time periods
commit abcbcb80cd09cd40f2089d912764e315459b71f7 upstream.
For the common cases where 1000 is a multiple of HZ, or HZ is a multiple of
1000, jiffies\_to\_msecs() never returns zero when passed a non-zero time
period.
However, if HZ > 1000 and not an integer multiple of 1000 (e.g. 1024 or
1200, as used on alpha and DECstation), jiffies\_to\_msecs() may return zero
for small non-zero time periods. This may break code that relies on
receiving back a non-zero value.
jiffies\_to\_usecs() does not need such a fix: one jiffy can only be less
than one Âµs if HZ > 1000000, and such large values of HZ are already
rejected at build time, twice:
- include/linux/jiffies.h does #error if HZ >= 12288,
- kernel/time/time.c has BUILD\_BUG\_ON(HZ > USEC\_PER\_SEC).
Broken since forever.
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Thomas Gleixner
Reviewed-by: Arnd Bergmann
Cc: John Stultz
Cc: Stephen Boyd
Cc: linux-alpha@vger.kernel.org
Cc: linux-mips@linux-mips.org
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20180622143357.7495-1-geert@linux-m68k.org
Signed-off-by: Greg Kroah-Hartman
commit 396be03fda35ed8acd8a5bd571a2516b55c45bf2
Author: Huacai Chen
Date: Tue Jun 12 17:54:42 2018 +0800
MIPS: io: Add barrier after register read in inX()
commit 18f3e95b90b28318ef35910d21c39908de672331 upstream.
While a barrier is present in the outX() functions before the register
write, a similar barrier is missing in the inX() functions after the
register read. This could allow memory accesses following inX() to
observe stale data.
This patch is very similar to commit a1cc7034e33d12dc1 ("MIPS: io: Add
barrier after register read in readX()"). Because war\_io\_reorder\_wmb()
is both used by writeX() and outX(), if readX() need a barrier then so
does inX().
Cc: stable@vger.kernel.org
Signed-off-by: Huacai Chen
Patchwork: https://patchwork.linux-mips.org/patch/19516/
Signed-off-by: Paul Burton
Cc: James Hogan
Cc: linux-mips@linux-mips.org
Cc: Fuxin Zhang
Cc: Zhangjin Wu
Cc: Huacai Chen
Signed-off-by: Greg Kroah-Hartman
commit 6f2c82f5cc7b43df24d6f99b890bf9e29f35f196
Author: Linus Walleij
Date: Sat May 26 19:12:51 2018 +0200
MIPS: pb44: Fix i2c-gpio GPIO descriptor table
commit 326345f995a83e326fa2e01d54bfa9a6a307bd4d upstream.
I used bad names in my clumsiness when rewriting many board
files to use GPIO descriptors instead of platform data. A few
had the platform\_device ID set to -1 which would indeed give
the device name "i2c-gpio".
But several had it set to >=0 which gives the names
"i2c-gpio.0", "i2c-gpio.1" ...
Fix the one affected board in the MIPS tree. Sorry.
Fixes: b2e63555592f ("i2c: gpio: Convert to use descriptors")
Reported-by: Simon Guinot
Signed-off-by: Linus Walleij
Reviewed-by: Paul Burton
Cc: Ralf Baechle
Cc: Wolfram Sang
Cc: Simon Guinot
Cc: linux-mips@linux-mips.org
Cc:  # 4.15+
Patchwork: https://patchwork.linux-mips.org/patch/19387/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit 319d04b8a4390880b514499f7d6c88a9812d2c9f
Author: Srinivas Pandruvada
Date: Mon Jun 18 12:47:45 2018 -0700
cpufreq: intel\_pstate: Fix scaling max/min limits with Turbo 3.0
commit ff7c9917143b3a6cf2fa61212a32d67cf259bf9c upstream.
When scaling max/min settings are changed, internally they are converted
to a ratio using the max turbo 1 core turbo frequency. This works fine
when 1 core max is same irrespective of the core. But under Turbo 3.0,
this will not be the case. For example:
Core 0: max turbo pstate: 43 (4.3GHz)
Core 1: max turbo pstate: 45 (4.5GHz)
In this case 1 core turbo ratio will be maximum of all, so it will be
45 (4.5GHz). Suppose scaling max is set to 4GHz (ratio 40) for all cores
,then on core one it will be
= max\_state \* policy->max / max\_freq;
= 43 \* (4000000/4500000) = 38 (3.8GHz)
= 38
which is 200MHz less than the desired.
On core2, it will be correctly set to ratio 40 (4GHz). Same holds true
for scaling min frequency limit. So this requires usage of correct turbo
max frequency for core one, which in this case is 4.3GHz. So we need to
adjust per CPU cpu->pstate.turbo\_freq using the maximum HWP ratio of that
core.
This change uses the HWP capability of a core to adjust max turbo
frequency. But since Broadwell HWP doesn't use ratios in the HWP
capabilities, we have to use legacy max 1 core turbo ratio. This is not
a problem as the HWP capabilities don't differ among cores in Broadwell.
We need to check for non Broadwell CPU model for applying this change,
though.
Signed-off-by: Srinivas Pandruvada
Cc: 4.6+  # 4.6+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 32c319d4f120a32aa94148157650e51c83ca3354
Author: Fabio Estevam
Date: Thu Jun 7 13:51:33 2018 -0300
pinctrl: devicetree: Fix pctldev pointer overwrite
commit bc3322bc166a2905bc91f774d7b22773dc7c063a upstream.
Commit b89405b6102f ("pinctrl: devicetree: Fix dt\_to\_map\_one\_config
handling of hogs") causes the pinctrl hog pins to not get initialized
on i.MX platforms leaving them with the IOMUX settings untouched.
This causes several regressions on i.MX such as:
- OV5640 camera driver can not be probed anymore on imx6qdl-sabresd
because the camera clock pin is in a pinctrl\_hog group and since
its pinctrl initialization is skipped, the camera clock is kept
in GPIO functionality instead of CLK\_CKO function.
- Audio stopped working on imx6qdl-wandboard and imx53-qsb for
the same reason.
Richard Fitzgerald explains the problem:
"I see the bug. If the hog node isn't a 1st level child of the pinctrl
parent node it will go around the for(;;) loop again but on the first
pass I overwrite pctldev with the result of
get\_pinctrl\_dev\_from\_of\_node() so it doesn't point to the pinctrl driver
any more."
Fix the issue by stashing the original pctldev so it doesn't
get overwritten.
Fixes: b89405b6102f ("pinctrl: devicetree: Fix dt\_to\_map\_one\_config handling of hogs")
Cc:
Reported-by: Mika PenttilÃ¤
Reported-by: Steve Longerbeam
Suggested-by: Richard Fitzgerald
Signed-off-by: Fabio Estevam
Reviewed-by: Dong Aisheng
Reviewed-by: Richard Fitzgerald
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 1a31d6f5dcf10e5f7bd5ceab9839fbcdacc87506
Author: PaweÅ‚ Chmiel
Date: Mon Apr 16 17:52:45 2018 +0200
pinctrl: samsung: Correct EINTG banks order
commit 5cf9a338db94cfd570aa2607bef1b30996f188e3 upstream.
All banks with GPIO interrupts should be at beginning of bank array and
without any other types of banks between them. This order is expected
by exynos\_eint\_gpio\_irq, when doing interrupt group to bank translation.
Otherwise, kernel NULL pointer dereference would happen when trying to
handle interrupt, due to wrong bank being looked up. Observed on
s5pv210, when trying to handle gpj0 interrupt, where kernel was mapping
it to gpi bank.
Cc: stable@vger.kernel.org
Fixes: 023e06dfa688 ("pinctrl: exynos: add exynos5410 SoC specific data")
Fixes: 608a26a7bc04 ("pinctrl: Add s5pv210 support to pinctrl-exynos)
Signed-off-by: PaweÅ‚ Chmiel
Reviewed-by: Tomasz Figa
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Greg Kroah-Hartman
commit 1bdeee56be2f112e90afa05e001cd4879684be77
Author: Terry Zhou
Date: Wed May 23 10:44:05 2018 +0200
pinctrl: armada-37xx: Fix spurious irq management
commit 702d1e81feae70aa16ca364b4d2d95ccad801022 upstream.
Until now, if we found spurious irq in irq\_handler, we only updated the
status in register but not the status in the code. Due to this the system
will got stuck dues to the infinite loop
[gregory.clement@bootlin.com: update comment and add fix and stable tags]
Fixes: 30ac0d3b0702 ("pinctrl: armada-37xx: Add edge both type gpio irq support")
Cc:
Signed-off-by: Terry Zhou
Reviewed-by: Gregory CLEMENT
Signed-off-by: Gregory CLEMENT
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 6feb00b1af7561142797e473ff2445177be3de6a
Author: Randy Dunlap
Date: Wed Feb 28 18:33:03 2018 -0800
auxdisplay: fix broken menu
commit b5b903fba96a4d1771422efd5c713ebb73f7dc82 upstream.
Having the CHARLCD Kconfig symbol between "menuconfig AUXDISPLAY"
and "if AUXDISPLAY" breaks the AUXDISPLAY submenus, so move the
CHARLCD Kconfig symbol near the end of the file so that the menu
display is continuous.
Also include ARM\_CHARLCD inside of the if AUXDISPLAY/endif block.
Geert says that it should be there.
Fixes: 39f8ea46724e ("auxdisplay: charlcd: Extract character LCD core from misc/panel")
Cc: stable@vger.kernel.org # v4.12
Cc: Geert Uytterhoeven
Reviewed-by: Andy Shevchenko
Signed-off-by: Randy Dunlap
Signed-off-by: Miguel Ojeda
Signed-off-by: Greg Kroah-Hartman
commit 4db687446aa2fcdb34ba52da6d5eefd4d1f02e18
Author: Mika Westerberg
Date: Mon May 28 15:47:50 2018 +0300
PCI: Account for all bridges on bus when distributing bus numbers
commit 3374c545c27c5350b954d1ab03c880d5502e5eba upstream.
When distributing extra bus number space to hotplug bridges for future
extension, we don't account for the fact that there might be non-hotplug
bridges on the bus after the hotplug bridges. For example:
01:00.0 --+- 02:00.0 (HotPlug-) -- Thunderbolt host controller
+- 02:01.0 (HotPlug+)
\- 02:02.0 (HotPlug-) -- xHCI host controller
pci\_scan\_child\_bus\_extend() is supposed to distribute the remaining bus
numbers to the hotplug bridge at 02:01.0, but only after accounting for all
bridges on bus 02. Since we don't check whether there's another
non-hotplug bridge after the hotplug bridge 02:01.0, it may not leave space
for the non-hotplug bridge:
pci 0000:00:1b.0: PCI bridge to [bus 01-39] (Root Port)
pci 0000:01:00.0: PCI bridge to [bus 02-39]
...
pci 0000:02:00.0: PCI bridge to [bus 03]
pci 0000:02:01.0: PCI bridge to [bus 04]
pci\_bus 0000:04: [bus 04-39] extended by 0x35
pci\_bus 0000:04: bus scan returning with max=39
pci\_bus 0000:04: busn\_res: [bus 04-39] end is updated to 39
pci 0000:02:02.0: scanning [bus 00-00] behind bridge, pass 1
pci\_bus 0000:3a: scanning bus
pci\_bus 0000:3a: bus scan returning with max=3a
pci\_bus 0000:3a: busn\_res: [bus 3a] end is updated to 3a
pci\_bus 0000:3a: [bus 3a] partially hidden behind bridge 0000:02 [bus 02-39]
pci\_bus 0000:3a: [bus 3a] partially hidden behind bridge 0000:01 [bus 01-39]
pci\_bus 0000:02: bus scan returning with max=3a
pci\_bus 0000:02: busn\_res: [bus 02-39] end can not be updated to 3a
The resulting 'lspci -t' output looks like this:
+-1b.0-[01-39]----00.0-[02-3a]--+-00.0-[03]----00.0
^^ +-01.0-[04-39]--
\-02.0-[3a]----00.0
^^
The xHCI host controller behind 02:02.0 is not usable because it would have
to be assigned bus 3a, which is not accessible through 00:1b.0.
To fix this, reserve at least one bus for each bridge while scanning
already configured bridges. Then use this information in the second
scan to correct the available extra bus space for hotplug bridges.
After this change the 'lspci -t' output is what is expected:
+-1b.0-[01-39]----00.0-[02-39]--+-00.0-[03]----00.0
+-01.0-[04-38]--
\-02.0-[39]----00.0
The xHCI controller is now on bus 39, where it is usable.
Fixes: 1c02ea810065 ("PCI: Distribute available buses to hotplug-capable bridges")
Reported-by: Mario Limonciello
Signed-off-by: Mika Westerberg
[bhelgaas: changelog]
Signed-off-by: Bjorn Helgaas
Reviewed-by: Rafael J. Wysocki
Reviewed-by: Andy Shevchenko
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit f7b9f2ffe7e1bdbef9912453a5ff270ad78e944d
Author: Mika Westerberg
Date: Wed May 23 17:14:39 2018 -0500
PCI: pciehp: Clear Presence Detect and Data Link Layer Status Changed on resume
commit 13c65840feab8109194f9490c9870587173cb29d upstream.
After a suspend/resume cycle the Presence Detect or Data Link Layer Status
Changed bits might be set. If we don't clear them those events will not
fire anymore and nothing happens for instance when a device is now
hot-unplugged.
Fix this by clearing those bits in a newly introduced function
pcie\_reenable\_notification(). This should be fine because immediately
after, we check if the adapter is still present by reading directly from
the status register.
Signed-off-by: Mika Westerberg
Signed-off-by: Bjorn Helgaas
Reviewed-by: Rafael J. Wysocki
Reviewed-by: Andy Shevchenko
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit f383f7cc3cfcb9d84ac76111ec5316feada0a26d
Author: Mika Westerberg
Date: Fri Apr 27 13:06:30 2018 -0500
PCI: Add ACS quirk for Intel 300 series
commit f154a718e6cc0d834f5ac4dc4c3b174e65f3659e upstream.
Intel 300 series chipset still has the same ACS issue as the previous
generations so extend the ACS quirk to cover it as well.
Signed-off-by: Mika Westerberg
Signed-off-by: Bjorn Helgaas
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 9103d6f434193b2b02ea97dd7fe6c060b30b72e7
Author: Alex Williamson
Date: Wed Apr 25 14:27:37 2018 -0600
PCI: Add ACS quirk for Intel 7th & 8th Gen mobile
commit e8440f4bfedc623bee40c84797ac78d9303d0db6 upstream.
The specification update indicates these have the same errata for
implementing non-standard ACS capabilities.
Signed-off-by: Alex Williamson
Signed-off-by: Bjorn Helgaas
CC: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit d6ae41669452ec519058c36403bad333ef1fa2bc
Author: Sridhar Pitchai
Date: Tue May 1 17:56:32 2018 +0000
PCI: hv: Make sure the bus domain is really unique
commit 29927dfb7f69bcf2ae7fd1cda10997e646a5189c upstream.
When Linux runs as a guest VM in Hyper-V and Hyper-V adds the virtual PCI
bus to the guest, Hyper-V always provides unique PCI domain.
commit 4a9b0933bdfc ("PCI: hv: Use device serial number as PCI domain")
overrode unique domain with the serial number of the first device added to
the virtual PCI bus.
The reason for that patch was to have a consistent and short name for the
device, but Hyper-V doesn't provide unique serial numbers. Using non-unique
serial numbers as domain IDs leads to duplicate device addresses, which
causes PCI bus registration to fail.
commit 0c195567a8f6 ("netvsc: transparent VF management") avoids the need
for commit 4a9b0933bdfc ("PCI: hv: Use device serial number as PCI
domain"). When scripts were used to configure VF devices, the name of
the VF needed to be consistent and short, but with commit 0c195567a8f6
("netvsc: transparent VF management") all the setup is done in the kernel,
and we do not need to maintain consistent name.
Revert commit 4a9b0933bdfc ("PCI: hv: Use device serial number as PCI
domain") so we can reliably support multiple devices being assigned to
a guest.
Tag the patch for stable kernels containing commit 0c195567a8f6
("netvsc: transparent VF management").
Fixes: 4a9b0933bdfc ("PCI: hv: Use device serial number as PCI domain")
Signed-off-by: Sridhar Pitchai
[lorenzo.pieralisi@arm.com: trimmed commit log]
Signed-off-by: Lorenzo Pieralisi
Cc: stable@vger.kernel.org # v4.14+
Reviewed-by: Bjorn Helgaas
Signed-off-by: Greg Kroah-Hartman
commit ffd5fb98d659c6718c98db6a99341ffa34f7342d
Author: Jae Hyun Yoo
Date: Thu Apr 26 10:22:32 2018 -0700
clk:aspeed: Fix reset bits for PCI/VGA and PECI
commit e76e56823a318ca580be4cfc5a6a9269bc70abea upstream.
This commit fixes incorrect setting of reset bits for PCI/VGA and
PECI modules.
1. Reset bit for PCI/VGA is 8.
2. PECI reset bit is missing so added bit 10 as its reset bit.
Signed-off-by: Jae Hyun Yoo
Fixes: 15ed8ce5f84e ("clk: aspeed: Register gated clocks")
Cc: stable
Signed-off-by: Stephen Boyd
Signed-off-by: Greg Kroah-Hartman
commit 09d006c3f89cfc75a028ad5badd5c98db23a6ca6
Author: Tokunori Ikegami
Date: Sun Jun 3 23:02:01 2018 +0900
MIPS: BCM47XX: Enable 74K Core ExternalSync for PCIe erratum
commit 2a027b47dba6b77ab8c8e47b589ae9bbc5ac6175 upstream.
The erratum and workaround are described by BCM5300X-ES300-RDS.pdf as
below.
R10: PCIe Transactions Periodically Fail
Description: The BCM5300X PCIe does not maintain transaction ordering.
This may cause PCIe transaction failure.
Fix Comment: Add a dummy PCIe configuration read after a PCIe
configuration write to ensure PCIe configuration access
ordering. Set ES bit of CP0 configu7 register to enable
sync function so that the sync instruction is functional.
Resolution: hndpci.c: extpci\_write\_config()
hndmips.c: si\_mips\_init()
mipsinc.h CONF7\_ES
This is fixed by the CFE MIPS bcmsi chipset driver also for BCM47XX.
Also the dummy PCIe configuration read is already implemented in the
Linux BCMA driver.
Enable ExternalSync in Config7 when CONFIG\_BCMA\_DRIVER\_PCI\_HOSTMODE=y
too so that the sync instruction is externalised.
Signed-off-by: Tokunori Ikegami
Reviewed-by: Paul Burton
Acked-by: Hauke Mehrtens
Cc: Chris Packham
Cc: RafaÅ‚ MiÅ‚ecki
Cc: linux-mips@linux-mips.org
Cc: stable@vger.kernel.org
Patchwork: https://patchwork.linux-mips.org/patch/19461/
Signed-off-by: James Hogan
Signed-off-by: Greg Kroah-Hartman
commit a5382451cc5745efa920cbfc5a108f03c57a7a54
Author: Joakim Tjernlund
Date: Wed Jun 6 12:13:30 2018 +0200
mtd: cfi\_cmdset\_0002: Avoid walking all chips when unlocking.
commit f1ce87f6080b1dda7e7b1eda3da332add19d87b9 upstream.
cfi\_ppb\_unlock() walks all flash chips when unlocking sectors,
avoid walking chips unaffected by the unlock operation.
Fixes: 1648eaaa1575 ("mtd: cfi\_cmdset\_0002: Support Persistent Protection Bits (PPB) locking")
Cc: stable@vger.kernel.org
Signed-off-by: Joakim Tjernlund
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 6b4d98009539a28c7b14a922caf1bed539ac279c
Author: Joakim Tjernlund
Date: Wed Jun 6 12:13:29 2018 +0200
mtd: cfi\_cmdset\_0002: Fix unlocking requests crossing a chip boudary
commit 0cd8116f172eed018907303dbff5c112690eeb91 upstream.
The "sector is in requested range" test used to determine whether
sectors should be re-locked or not is done on a variable that is reset
everytime we cross a chip boundary, which can lead to some blocks being
re-locked while the caller expect them to be unlocked.
Fix the check to make sure this cannot happen.
Fixes: 1648eaaa1575 ("mtd: cfi\_cmdset\_0002: Support Persistent Protection Bits (PPB) locking")
Cc: stable@vger.kernel.org
Signed-off-by: Joakim Tjernlund
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 5dd85fdba5fdefdf9dce2d7971867c44f9858973
Author: Joakim Tjernlund
Date: Wed Jun 6 12:13:28 2018 +0200
mtd: cfi\_cmdset\_0002: fix SEGV unlocking multiple chips
commit 5fdfc3dbad099281bf027a353d5786c09408a8e5 upstream.
cfi\_ppb\_unlock() tries to relock all sectors that were locked before
unlocking the whole chip.
This locking used the chip start address + the FULL offset from the
first flash chip, thereby forming an illegal address. Fix that by using
the chip offset(adr).
Fixes: 1648eaaa1575 ("mtd: cfi\_cmdset\_0002: Support Persistent Protection Bits (PPB) locking")
Cc: stable@vger.kernel.org
Signed-off-by: Joakim Tjernlund
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 69d3096b390e0c5f9169c3ec890ad91f986e72e2
Author: Joakim Tjernlund
Date: Wed Jun 6 12:13:27 2018 +0200
mtd: cfi\_cmdset\_0002: Use right chip in do\_ppb\_xxlock()
commit f93aa8c4de307069c270b2d81741961162bead6c upstream.
do\_ppb\_xxlock() fails to add chip->start when querying for lock status
(and chip\_ready test), which caused false status reports.
Fix that by adding adr += chip->start and adjust call sites
accordingly.
Fixes: 1648eaaa1575 ("mtd: cfi\_cmdset\_0002: Support Persistent Protection Bits (PPB) locking")
Cc: stable@vger.kernel.org
Signed-off-by: Joakim Tjernlund
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 7ac7aa8b70a6186220c277febd4b6e4b89c617cf
Author: Mason Yang
Date: Wed Jun 20 11:46:30 2018 +0200
mtd: rawnand: All AC chips have a broken GET\_FEATURES(TIMINGS).
commit fe3dd97dd66bb7fb23b8077a3803d2f951e60b00 upstream.
Make sure we flag all broken chips as not supporting this feature.
Also move this logic to a new function to keep things readable.
Fixes: 34c5c01e0c8c ("mtd: rawnand: macronix: nack the support of changing timings for one chip")
Cc:
Signed-off-by: Mason Yang
Signed-off-by: Boris Brezillon
Reviewed-by: Miquel Raynal
Signed-off-by: Greg Kroah-Hartman
commit 4c10798dacfedbbe576680793d66cb28f0fdce82
Author: Chris Packham
Date: Tue Jun 19 17:31:24 2018 +1200
mtd: rawnand: micron: add ONFI\_FEATURE\_ON\_DIE\_ECC to supported features
commit 12baf7721143c83150fa973484b7b5fcd86b23f0 upstream.
Add ONFI\_FEATURE\_ON\_DIE\_ECC to the set/get features list for Micron
NAND flash.
Fixes: 789157e41a06 ("mtd: rawnand: allow vendors to declare (un)supported features")
Cc:
Signed-off-by: Chris Packham
Reviewed-by: Miquel Raynal
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 52e9bf78f293e84011a47ef2c69c2c22d519f031
Author: Martin Kaiser
Date: Mon Jun 18 22:41:03 2018 +0200
mtd: rawnand: mxc: set spare area size register explicitly
commit 3f77f244d8ec28e3a0a81240ffac7d626390060c upstream.
The v21 version of the NAND flash controller contains a Spare Area Size
Register (SPAS) at offset 0x10. Its setting defaults to the maximum
spare area size of 218 bytes. The size that is set in this register is
used by the controller when it calculates the ECC bytes internally in
hardware.
Usually, this register is updated from settings in the IIM fuses when
the system is booting from NAND flash. For other boot media, however,
the SPAS register remains at the default setting, which may not work for
the particular flash chip on the board. The same goes for flash chips
whose configuration cannot be set in the IIM fuses (e.g. chips with 2k
sector size and 128 bytes spare area size can't be configured in the IIM
fuses on imx25 systems).
Set the SPAS register explicitly during the preset operation. Derive the
register value from mtd->oobsize that was detected during probe by
decoding the flash chip's ID bytes.
While at it, rename the define for the spare area register's offset to
NFC\_V21\_RSLTSPARE\_AREA. The register at offset 0x10 on v1 controllers is
different from the register on v21 controllers.
Fixes: d484018 ("mtd: mxc\_nand: set NFC registers after reset")
Cc: stable@vger.kernel.org
Signed-off-by: Martin Kaiser
Reviewed-by: Sascha Hauer
Reviewed-by: Miquel Raynal
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 0bea8b947d91784cef8a1d6d89e91c12cc73b501
Author: Abhishek Sahu
Date: Wed Jun 13 14:32:36 2018 +0530
mtd: rawnand: fix return value check for bad block status
commit e9893e6fa932f42c90c4ac5849fa9aa0f0f00a34 upstream.
Positive return value from read\_oob() is making false BAD
blocks. For some of the NAND controllers, OOB bytes will be
protected with ECC and read\_oob() will return number of bitflips.
If there is any bitflip in ECC protected OOB bytes for BAD block
status page, then that block is getting treated as BAD.
Fixes: c120e75e0e7d ("mtd: nand: use read\_oob() instead of cmdfunc() for bad block check")
Cc:
Signed-off-by: Abhishek Sahu
Reviewed-by: Miquel Raynal
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 5777295dc8d8951db1741c0cdfd9fa6bf13fd489
Author: Masahiro Yamada
Date: Sat Jun 23 01:06:34 2018 +0900
mtd: rawnand: denali\_dt: set clk\_x\_rate to 200 MHz unconditionally
commit 3f6e6986045d47f87bd982910821b7ab9758487e upstream.
Since commit 1bb88666775e ("mtd: nand: denali: handle timing parameters
by setup\_data\_interface()"), denali\_dt.c gets the clock rate from the
clock driver. The driver expects the frequency of the bus interface
clock, whereas the clock driver of SOCFPGA provides the core clock.
Thus, the setup\_data\_interface() hook calculates timing parameters
based on a wrong frequency.
To make it work without relying on the clock driver, hard-code the clock
frequency, 200MHz. This is fine for existing DT of UniPhier, and also
fixes the issue of SOCFPGA because both platforms use 200 MHz for the
bus interface clock.
Fixes: 1bb88666775e ("mtd: nand: denali: handle timing parameters by setup\_data\_interface()")
Cc: linux-stable  #4.14+
Reported-by: Philipp Rosenberger
Suggested-by: Boris Brezillon
Signed-off-by: Masahiro Yamada
Tested-by: Richard Weinberger
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 4a10b5b3e490f74bd089640cbe478fdb11b1fab0
Author: Tokunori Ikegami
Date: Wed May 30 18:32:26 2018 +0900
mtd: cfi\_cmdset\_0002: Change write buffer to check correct value
commit dfeae1073583dc35c33b32150e18b7048bbb37e6 upstream.
For the word write it is checked if the chip has the correct value.
But it is not checked for the write buffer as only checked if ready.
To make sure for the write buffer change to check the value.
It is enough as this patch is only checking the last written word.
Since it is described by data sheets to check the operation status.
Signed-off-by: Tokunori Ikegami
Reviewed-by: Joakim Tjernlund
Cc: Chris Packham
Cc: Brian Norris
Cc: David Woodhouse
Cc: Boris Brezillon
Cc: Marek Vasut
Cc: Richard Weinberger
Cc: Cyrille Pitchen
Cc: linux-mtd@lists.infradead.org
Cc: stable@vger.kernel.org
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit bf6aa8a64b7ef9e087a5d4c783e51ace10568bb1
Author: Boris Brezillon
Date: Fri May 11 14:44:07 2018 +0200
mtd: rawnand: Do not check FAIL bit when executing a SET\_FEATURES op
commit 782d1967d0479ffd59412b2f3179c8bb35f50ff6 upstream.
The ONFI spec clearly says that FAIL bit is only valid for PROGRAM,
ERASE and READ-with-on-die-ECC operations, and should be ignored
otherwise.
It seems that checking it after sending a SET\_FEATURES is a bad idea
because a previous READ, PROGRAM or ERASE op may have failed, and
depending on the implementation, the FAIL bit is not cleared until a
new READ, PROGRAM or ERASE is started.
This leads to ->set\_features() returning -EIO while it actually worked,
which can sometimes stop a batch of READ/PROGRAM ops.
Note that we only fix the ->exec\_op() path here, because some drivers
are abusing the NAND\_STATUS\_FAIL flag in their ->waitfunc()
implementation to propagate other kind of errors, like
wait-ready-timeout or controller-related errors. Let's not try to fix
those drivers since they worked fine so far.
Fixes: 8878b126df76 ("mtd: nand: add ->exec\_op() implementation")
Cc: stable@vger.kernel.org
Signed-off-by: Boris Brezillon
Acked-by: Miquel Raynal
Signed-off-by: Greg Kroah-Hartman
commit a1cf63325930b6f6246e5d3c4d9aa09aebba3442
Author: Bharat Potnuri
Date: Fri Jun 15 20:52:33 2018 +0530
RDMA/core: Save kernel caller name when creating CQ using ib\_create\_cq()
commit 7350cdd0257e73a37df57253fb9decd8effacd37 upstream.
Few kernel applications like SCST-iSER create CQ using ib\_create\_cq(),
where accessing CQ structures using rdma restrack tool leads to below NULL
pointer dereference. This patch saves caller kernel module name similar to
ib\_alloc\_cq().
BUG: unable to handle kernel NULL pointer dereference at (null)
IP: [] skip\_spaces+0x30/0x30
PGD 738bac067 PUD 8533f0067 PMD 0
Oops: 0000 [#1] SMP
R10: ffff88017fc03300 R11: 0000000000000246 R12: 0000000000000000
R13: ffff88082fa5a668 R14: ffff88017475a000 R15: 0000000000000000
FS: 00002b32726582c0(0000) GS:ffff88087fc40000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 00000008491a1000 CR4: 00000000003607e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
[] ? fill\_res\_name\_pid+0x7c/0x90 [ib\_core]
[] fill\_res\_cq\_entry+0xef/0x170 [ib\_core]
[] res\_get\_common\_dumpit+0x3c4/0x480 [ib\_core]
[] nldev\_res\_get\_cq\_dumpit+0x13/0x20 [ib\_core]
[] netlink\_dump+0x117/0x2e0
[] \_\_netlink\_dump\_start+0x1ab/0x230
[] ibnl\_rcv\_msg+0x11d/0x1f0 [ib\_core]
[] ? nldev\_res\_get\_mr\_dumpit+0x20/0x20 [ib\_core]
[] ? rdma\_nl\_multicast+0x30/0x30 [ib\_core]
[] netlink\_rcv\_skb+0xa9/0xc0
[] ibnl\_rcv+0x98/0xb0 [ib\_core]
[] netlink\_unicast+0xf2/0x1b0
[] netlink\_sendmsg+0x31f/0x6a0
[] sock\_sendmsg+0xb0/0xf0
[] ? \_raw\_spin\_unlock\_bh+0x1e/0x20
[] ? release\_sock+0x118/0x170
[] SYSC\_sendto+0x121/0x1c0
[] ? sock\_alloc\_file+0xa0/0x140
[] ? \_\_fd\_install+0x25/0x60
[] SyS\_sendto+0xe/0x10
[] system\_call\_fastpath+0x16/0x1b
RIP [] skip\_spaces+0x30/0x30
RSP
CR2: 0000000000000000
Cc:
Fixes: f66c8ba4c9fa ("RDMA/core: Save kernel caller name when creating PD and CQ objects")
Reviewed-by: Steve Wise
Signed-off-by: Potnuri Bharat Teja
Reviewed-by: Leon Romanovsky
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit e9b7f6ccdf30e4fce1fd418ab4b012afb0bc2400
Author: Chuck Lever
Date: Fri May 4 15:35:46 2018 -0400
xprtrdma: Return -ENOBUFS when no pages are available
commit a8f688ec437dc2045cc8f0c89fe877d5803850da upstream.
The use of -EAGAIN in rpcrdma\_convert\_iovs() is a latent bug: the
transport never calls xprt\_write\_space() when more pages become
available. -ENOBUFS will trigger the correct "delay briefly and call
again" logic.
Fixes: 7a89f9c626e3 ("xprtrdma: Honor ->send\_request API contract")
Signed-off-by: Chuck Lever
Cc: stable@vger.kernel.org # 4.8+
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit ef6c1a40bd6a4830837d4e7a89ca8fafc4b8cc83
Author: Leon Romanovsky
Date: Tue May 29 14:56:14 2018 +0300
RDMA/mlx4: Discard unknown SQP work requests
commit 6b1ca7ece15e94251d1d0d919f813943e4a58059 upstream.
There is no need to crash the machine if unknown work request was
received in SQP MAD.
Cc:  # 3.6
Fixes: 37bfc7c1e83f ("IB/mlx4: SR-IOV multiplex and demultiplex MADs")
Signed-off-by: Leon Romanovsky
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 3c62cd44d96da4d01d8d0420cc727e988cfbb52d
Author: Jason Gunthorpe
Date: Tue Jun 12 09:40:23 2018 -0600
IB/uverbs: Fix ordering of ucontext check in ib\_uverbs\_write
commit 1eb9364ce81d9445ad6f9d44921a91d2a6597156 upstream.
During disassociation the ucontext will become NULL, however due to how
the SRCU locking works the ucontext must only be examined after looking
at the ib\_dev, which governs the RCU control flow.
With the wrong ordering userspace will see EINVAL instead of EIO for a
disassociated uverbs FD, which breaks rdma-core.
Cc: stable@vger.kernel.org
Fixes: 491d5c6a3023 ("RDMA/uverbs: Move uncontext check before SRCU read lock")
Reported-by: Mark Bloch
Signed-off-by: Jason Gunthorpe
Reviewed-by: Leon Romanovsky
Signed-off-by: Greg Kroah-Hartman
commit 02f470533d29c166affc013203c1c62a9e5d3137
Author: Mike Marciniszyn
Date: Thu May 31 11:30:09 2018 -0700
IB/hfi1: Fix user context tail allocation for DMA\_RTAIL
commit 1bc0299d976e000ececc6acd76e33b4582646cb7 upstream.
The following code fails to allocate a buffer for the
tail address that the hardware DMAs into when the user
context DMA\_RTAIL is set.
if (HFI1\_CAP\_KGET\_MASK(rcd->flags, DMA\_RTAIL)) {
rcd->rcvhdrtail\_kvaddr = dma\_zalloc\_coherent(
&dd->pcidev->dev, PAGE\_SIZE, &dma\_hdrqtail,
gfp\_flags);
if (!rcd->rcvhdrtail\_kvaddr)
goto bail\_free;
rcd->rcvhdrqtailaddr\_dma = dma\_hdrqtail;
}
So the rcvhdrtail\_kvaddr would then be NULL.
The mmap logic fails to check for a NULL rcvhdrtail\_kvaddr.
The fix is to test for both user and kernel DMA\_TAIL options
during the allocation as well as testing for a NULL
rcvhdrtail\_kvaddr during the mmap processing.
Additionally, all downstream testing of the capmask for DMA\_RTAIL
have been eliminated in favor of testing rcvhdrtail\_kvaddr.
Cc:  # 4.9.x
Reviewed-by: Michael J. Ruhl
Signed-off-by: Mike Marciniszyn
Signed-off-by: Dennis Dalessandro
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit a67b7eebaee52475fecc5ddfc0dfa4753302d8cb
Author: Sebastian Sanchez
Date: Wed May 2 06:43:39 2018 -0700
IB/hfi1: Optimize kthread pointer locking when queuing CQ entries
commit af8aab71370a692eaf7e7969ba5b1a455ac20113 upstream.
All threads queuing CQ entries on different CQs are unnecessarily
synchronized by a spin lock to check if the CQ kthread worker hasn't
been destroyed before queuing an CQ entry.
The lock used in 6efaf10f163d ("IB/rdmavt: Avoid queuing work into a
destroyed cq kthread worker") is a device global lock and will have
poor performance at scale as completions are entered from a large
number of CPUs.
Convert to use RCU where the read side of RCU is rvt\_cq\_enter() to
determine that the worker is alive prior to triggering the
completion event.
Apply write side RCU semantics in rvt\_driver\_cq\_init() and
rvt\_cq\_exit().
Fixes: 6efaf10f163d ("IB/rdmavt: Avoid queuing work into a destroyed cq kthread worker")
Cc:  # 4.14.x
Reviewed-by: Mike Marciniszyn
Signed-off-by: Sebastian Sanchez
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit dac7b47c23b877c50d21c10b075f512a4bd3b4b7
Author: Michael J. Ruhl
Date: Wed May 2 06:43:07 2018 -0700
IB/hfi1: Reorder incorrect send context disable
commit a93a0a31111231bb1949f4a83b17238f0fa32d6a upstream.
User send context integrity bits are cleared before the context is
disabled. If the send context is still processing data, any packets
that need those integrity bits will cause an error and halt the send
context.
During the disable handling, the driver waits for the context to drain.
If the context is halted, the driver will eventually timeout because
the context won't drain and then incorrectly bounce the link.
Reorder the bit clearing and the context disable.
Examine the software state and send context status as well as the
egress status to determine if a send context is in the halted state.
Promote the check macros to static functions for consistency with the
new check and to follow kernel style.
Remove an unused define that refers to the egress timeout.
Cc:  # 4.9.x
Reviewed-by: Mitko Haralanov
Reviewed-by: Mike Marciniszyn
Signed-off-by: Michael J. Ruhl
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 1d9945caf4bc153dbdd918d0d594741cd23f6bf9
Author: Mike Marciniszyn
Date: Wed May 2 06:42:44 2018 -0700
IB/hfi1: Fix fault injection init/exit issues
commit 8c79d8223bb11b2f005695a32ddd3985de97727c upstream.
There are config dependent code paths that expose panics in unload
paths both in this file and in debugfs\_remove\_recursive() because
CONFIG\_FAULT\_INJECTION and CONFIG\_FAULT\_INJECTION\_DEBUG\_FS can be
set independently.
Having CONFIG\_FAULT\_INJECTION set and CONFIG\_FAULT\_INJECTION\_DEBUG\_FS
reset causes fault\_create\_debugfs\_attr() to return an error.
The debugfs.c routines tolerate failures, but the module unload panics
dereferencing a NULL in the two exit routines. If that is fixed, the
dir passed to debugfs\_remove\_recursive comes from a memory location
that was freed and potentially reused causing a segfault or corrupting
memory.
Here is an example of the NULL deref panic:
[66866.286829] BUG: unable to handle kernel NULL pointer dereference at 0000000000000088
[66866.295602] IP: hfi1\_dbg\_ibdev\_exit+0x2a/0x80 [hfi1]
[66866.301138] PGD 858496067 P4D 858496067 PUD 8433a7067 PMD 0
[66866.307452] Oops: 0000 [#1] SMP
[66866.310953] Modules linked in: hfi1(-) rdmavt rdma\_ucm ib\_ucm ib\_uverbs ib\_umad rdma\_cm iw\_cm ib\_cm ib\_core rpcsec\_gss\_krb5 nfsv4 dns\_resolver nfsv3 nfs fscache sb\_edac x86\_pkg\_temp\_thermal intel\_powerclamp vfat fat coretemp kvm irqbypass crct10dif\_pclmul crc32\_pclmul ghash\_clmulni\_intel pcbc aesni\_intel iTCO\_wdt iTCO\_vendor\_support crypto\_simd mei\_me glue\_helper cryptd mxm\_wmi ipmi\_si pcspkr lpc\_ich sg mei ioatdma ipmi\_devintf i2c\_i801 mfd\_core shpchp ipmi\_msghandler wmi acpi\_power\_meter acpi\_cpufreq nfsd auth\_rpcgss nfs\_acl lockd grace sunrpc ip\_tables ext4 mbcache jbd2 sd\_mod mgag200 drm\_kms\_helper syscopyarea sysfillrect sysimgblt igb fb\_sys\_fops ttm ahci ptp crc32c\_intel libahci pps\_core drm dca libata i2c\_algo\_bit i2c\_core [last unloaded: opa\_vnic]
[66866.385551] CPU: 8 PID: 7470 Comm: rmmod Not tainted 4.14.0-mam-tid-rdma #2
[66866.393317] Hardware name: Intel Corporation S2600WT2/S2600WT2, BIOS SE5C610.86B.01.01.0018.C4.072020161249 07/20/2016
[66866.405252] task: ffff88084f28c380 task.stack: ffffc90008454000
[66866.411866] RIP: 0010:hfi1\_dbg\_ibdev\_exit+0x2a/0x80 [hfi1]
[66866.417984] RSP: 0018:ffffc90008457da0 EFLAGS: 00010202
[66866.423812] RAX: 0000000000000000 RBX: ffff880857de0000 RCX: 0000000180040001
[66866.431773] RDX: 0000000180040002 RSI: ffffea0021088200 RDI: 0000000040000000
[66866.439734] RBP: ffffc90008457da8 R08: ffff88084220e000 R09: 0000000180040001
[66866.447696] R10: 000000004220e001 R11: ffff88084220e000 R12: ffff88085a31c000
[66866.455657] R13: ffffffffa07c9820 R14: ffffffffa07c9890 R15: ffff881059d78100
[66866.463618] FS: 00007f6876047740(0000) GS:ffff88085f800000(0000) knlGS:0000000000000000
[66866.472644] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[66866.479053] CR2: 0000000000000088 CR3: 0000000856357006 CR4: 00000000001606e0
[66866.487013] Call Trace:
[66866.489747] remove\_one+0x1f/0x220 [hfi1]
[66866.494221] pci\_device\_remove+0x39/0xc0
[66866.498596] device\_release\_driver\_internal+0x141/0x210
[66866.504424] driver\_detach+0x3f/0x80
[66866.508409] bus\_remove\_driver+0x55/0xd0
[66866.512784] driver\_unregister+0x2c/0x50
[66866.517164] pci\_unregister\_driver+0x2a/0xa0
[66866.521934] hfi1\_mod\_cleanup+0x10/0xaa2 [hfi1]
[66866.526988] SyS\_delete\_module+0x171/0x250
[66866.531558] do\_syscall\_64+0x67/0x1b0
[66866.535644] entry\_SYSCALL64\_slow\_path+0x25/0x25
[66866.540792] RIP: 0033:0x7f6875525c27
[66866.544777] RSP: 002b:00007ffd48528e78 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[66866.553224] RAX: ffffffffffffffda RBX: 0000000001cc01d0 RCX: 00007f6875525c27
[66866.561185] RDX: 00007f6875596000 RSI: 0000000000000800 RDI: 0000000001cc0238
[66866.569146] RBP: 0000000000000000 R08: 00007f68757e9060 R09: 00007f6875596000
[66866.577120] R10: 00007ffd48528c00 R11: 0000000000000206 R12: 00007ffd48529db4
[66866.585080] R13: 0000000000000000 R14: 0000000001cc01d0 R15: 0000000001cc0010
[66866.593040] Code: 90 0f 1f 44 00 00 48 83 3d a3 8b 03 00 00 55 48 89 e5 53 48 89 fb 74 4e 48 8d bf 18 0c 00 00 e8 9d f2 ff ff 48 8b 83 20 0c 00 00 <48> 8b b8 88 00 00 00 e8 2a 21 b3 e0 48 8b bb 20 0c 00 00 e8 0e
[66866.614127] RIP: hfi1\_dbg\_ibdev\_exit+0x2a/0x80 [hfi1] RSP: ffffc90008457da0
[66866.621885] CR2: 0000000000000088
[66866.625618] ---[ end trace c4817425783fb092 ]---
Fix by insuring that upon failure from fault\_create\_debugfs\_attr() the
parent pointer for the routines is always set to NULL and guards added
in the exit routines to insure that debugfs\_remove\_recursive() is not
called when when the parent pointer is NULL.
Fixes: 0181ce31b260 ("IB/hfi1: Add receive fault injection feature")
Cc:  # 4.14.x
Reviewed-by: Michael J. Ruhl
Signed-off-by: Mike Marciniszyn
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 719311d815a5451f32366b6ecf41651120a51cf6
Author: Max Gurtovoy
Date: Thu May 31 11:05:23 2018 +0300
IB/isert: fix T10-pi check mask setting
commit 0e12af84cdd3056460f928adc164f9e87f4b303b upstream.
A copy/paste bug (probably) caused setting of an app\_tag check mask
in case where a ref\_tag check was needed.
Fixes: 38a2d0d429f1 ("IB/isert: convert to the generic RDMA READ/WRITE API")
Fixes: 9e961ae73c2c ("IB/isert: Support T10-PI protected transactions")
Cc: stable@vger.kernel.org
Reviewed-by: Christoph Hellwig
Reviewed-by: Sagi Grimberg
Reviewed-by: Martin K. Petersen
Signed-off-by: Max Gurtovoy
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit f94c02635dc78731a5a9ef63a382ed90cfb3e9fd
Author: Alex Estrin
Date: Tue May 15 18:31:39 2018 -0700
IB/isert: Fix for lib/dma\_debug check\_sync warning
commit 763b69654bfb88ea3230d015e7d755ee8339f8ee upstream.
The following error message occurs on a target host in a debug build
during session login:
[ 3524.411874] WARNING: CPU: 5 PID: 12063 at lib/dma-debug.c:1207 check\_sync+0x4ec/0x5b0
[ 3524.421057] infiniband hfi1\_0: DMA-API: device driver tries to sync DMA memory it has not allocated [device address=0x0000000000000000] [size=76 bytes]
......snip .....
[ 3524.535846] CPU: 5 PID: 12063 Comm: iscsi\_np Kdump: loaded Not tainted 3.10.0-862.el7.x86\_64.debug #1
[ 3524.546764] Hardware name: Dell Inc. PowerEdge R430/03XKDV, BIOS 1.2.6 06/08/2015
[ 3524.555740] Call Trace:
[ 3524.559102] [] dump\_stack+0x19/0x1b
[ 3524.565477] [] \_\_warn+0xd8/0x100
[ 3524.571557] [] warn\_slowpath\_fmt+0x5f/0x80
[ 3524.578610] [] check\_sync+0x4ec/0x5b0
[ 3524.585177] [] ? set\_cpus\_allowed\_ptr+0x5f/0x1c0
[ 3524.592812] [] debug\_dma\_sync\_single\_for\_cpu+0x80/0x90
[ 3524.601029] [] ? x2apic\_send\_IPI\_mask+0x13/0x20
[ 3524.608574] [] ? native\_smp\_send\_reschedule+0x5b/0x80
[ 3524.616699] [] ? resched\_curr+0xf6/0x140
[ 3524.623567] [] isert\_create\_send\_desc.isra.26+0xe0/0x110 [ib\_isert]
[ 3524.633060] [] isert\_put\_login\_tx+0x55/0x8b0 [ib\_isert]
[ 3524.641383] [] ? try\_to\_wake\_up+0x1a4/0x430
[ 3524.648561] [] iscsi\_target\_do\_tx\_login\_io+0xdd/0x230 [iscsi\_target\_mod]
[ 3524.658557] [] iscsi\_target\_do\_login+0x1a7/0x600 [iscsi\_target\_mod]
[ 3524.668084] [] ? kstrdup+0x49/0x60
[ 3524.674420] [] iscsi\_target\_start\_negotiation+0x56/0xc0 [iscsi\_target\_mod]
[ 3524.684656] [] \_\_iscsi\_target\_login\_thread+0x90e/0x1070 [iscsi\_target\_mod]
[ 3524.694901] [] ? \_\_iscsi\_target\_login\_thread+0x1070/0x1070 [iscsi\_target\_mod]
[ 3524.705446] [] ? \_\_iscsi\_target\_login\_thread+0x1070/0x1070 [iscsi\_target\_mod]
[ 3524.715976] [] iscsi\_target\_login\_thread+0x28/0x60 [iscsi\_target\_mod]
[ 3524.725739] [] kthread+0xef/0x100
[ 3524.732007] [] ? insert\_kthread\_work+0x80/0x80
[ 3524.739540] [] ret\_from\_fork\_nospec\_begin+0x21/0x21
[ 3524.747558] [] ? insert\_kthread\_work+0x80/0x80
[ 3524.755088] ---[ end trace 23f8bf9238bd1ed8 ]---
[ 3595.510822] iSCSI/iqn.1994-05.com.redhat:537fa56299: Unsupported SCSI Opcode 0xa3, sending CHECK\_CONDITION.
The code calls dma\_sync on login\_tx\_desc->dma\_addr prior to initializing it
with dma-mapped address.
login\_tx\_desc is a part of iser\_conn structure and is used only once
during login negotiation, so the issue is fixed by eliminating
dma\_sync call for this buffer using a special case routine.
Cc:
Reviewed-by: Mike Marciniszyn
Reviewed-by: Don Dutile
Signed-off-by: Alex Estrin
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 54bae587bb7d4d6483ce67746d80432db7b03f55
Author: Erez Shitrit
Date: Mon May 21 11:41:01 2018 +0300
IB/mlx5: Fetch soft WQE's on fatal error state
commit 7b74a83cf54a3747e22c57e25712bd70eef8acee upstream.
On fatal error the driver simulates CQE's for ULPs that rely on
completion of all their posted work-request.
For the GSI traffic, the mlx5 has its own mechanism that sends the
completions via software CQE's directly to the relevant CQ.
This should be kept in fatal error too, so the driver should simulate
such CQE's with the specified error state in order to complete GSI QP
work requests.
Without the fix the next deadlock might appears:
schedule\_timeout+0x274/0x350
wait\_for\_common+0xec/0x240
mcast\_remove\_one+0xd0/0x120 [ib\_core]
ib\_unregister\_device+0x12c/0x230 [ib\_core]
mlx5\_ib\_remove+0xc4/0x270 [mlx5\_ib]
mlx5\_detach\_device+0x184/0x1a0 [mlx5\_core]
mlx5\_unload\_one+0x308/0x340 [mlx5\_core]
mlx5\_pci\_err\_detected+0x74/0xe0 [mlx5\_core]
Cc:  # 4.7
Fixes: 89ea94a7b6c4 ("IB/mlx5: Reset flow support for IB kernel ULPs")
Signed-off-by: Erez Shitrit
Signed-off-by: Leon Romanovsky
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit d15cc815808fa0c26c0a57dee200ffc7c1dea5b1
Author: Jack Morgenstein
Date: Wed May 23 15:30:30 2018 +0300
IB/core: Make testing MR flags for writability a static inline function
commit 08bb558ac11ab944e0539e78619d7b4c356278bd upstream.
Make the MR writability flags check, which is performed in umem.c,
a static inline function in file ib\_verbs.h
This allows the function to be used by low-level infiniband drivers.
Cc:
Signed-off-by: Jason Gunthorpe
Signed-off-by: Jack Morgenstein
Signed-off-by: Leon Romanovsky
Signed-off-by: Greg Kroah-Hartman
commit 400bfde710faa5b7c9d0a08a23f899d939e4d8d0
Author: Jack Morgenstein
Date: Wed May 23 15:30:31 2018 +0300
IB/mlx4: Mark user MR as writable if actual virtual memory is writable
commit d8f9cc328c8888369880e2527e9186d745f2bbf6 upstream.
To allow rereg\_user\_mr to modify the MR from read-only to writable without
using get\_user\_pages again, we needed to define the initial MR as writable.
However, this was originally done unconditionally, without taking into
account the writability of the underlying virtual memory.
As a result, any attempt to register a read-only MR over read-only
virtual memory failed.
To fix this, do not add the writable flag bit when the user virtual memory
is not writable (e.g. const memory).
However, when the underlying memory is NOT writable (and we therefore
do not define the initial MR as writable), the IB core adds a
"force writable" flag to its user-pages request. If this succeeds,
the reg\_user\_mr caller gets a writable copy of the original pages.
If the user-space caller then does a rereg\_user\_mr operation to enable
writability, this will succeed. This should not be allowed, since
the original virtual memory was not writable.
Cc:
Fixes: 9376932d0c26 ("IB/mlx4\_ib: Add support for user MR re-registration")
Signed-off-by: Jason Gunthorpe
Signed-off-by: Jack Morgenstein
Signed-off-by: Leon Romanovsky
Signed-off-by: Greg Kroah-Hartman
commit cfb0cac8cd82493ba922d08ee998a7431a9fce7c
Author: Alex Estrin
Date: Wed May 2 06:43:15 2018 -0700
IB/{hfi1, qib}: Add handling of kernel restart
commit 8d3e71136a080d007620472f50c7b3e63ba0f5cf upstream.
A warm restart will fail to unload the driver, leaving link state
potentially flapping up to the point the BIOS resets the adapter.
Correct the issue by hooking the shutdown pci method,
which will bring port down.
Cc:  # 4.9.x
Reviewed-by: Mike Marciniszyn
Signed-off-by: Alex Estrin
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit ffa15404faa7d3b77e2caef33a03e1ba29deb507
Author: Mike Marciniszyn
Date: Fri May 18 17:07:01 2018 -0700
IB/qib: Fix DMA api warning with debug kernel
commit 0252f73334f9ef68868e4684200bea3565a4fcee upstream.
The following error occurs in a debug build when running MPI PSM:
[ 307.415911] WARNING: CPU: 4 PID: 23867 at lib/dma-debug.c:1158
check\_unmap+0x4ee/0xa20
[ 307.455661] ib\_qib 0000:05:00.0: DMA-API: device driver failed to check map
error[device address=0x00000000df82b000] [size=4096 bytes] [mapped as page]
[ 307.517494] Modules linked in:
[ 307.531584] ib\_isert iscsi\_target\_mod ib\_srpt target\_core\_mod rpcrdma
sunrpc ib\_srp scsi\_transport\_srp scsi\_tgt ib\_iser libiscsi ib\_ipoib
scsi\_transport\_iscsi rdma\_ucm ib\_ucm ib\_uverbs ib\_umad rdma\_cm ib\_cm iw\_cm
ib\_qib intel\_powerclamp coretemp rdmavt intel\_rapl iosf\_mbi kvm\_intel kvm
irqbypass crc32\_pclmul ghash\_clmulni\_intel ipmi\_ssif ib\_core aesni\_intel sg
ipmi\_si lrw gf128mul dca glue\_helper ipmi\_devintf iTCO\_wdt gpio\_ich hpwdt
iTCO\_vendor\_support ablk\_helper hpilo acpi\_power\_meter cryptd ipmi\_msghandler
ie31200\_edac shpchp pcc\_cpufreq lpc\_ich pcspkr ip\_tables xfs libcrc32c sd\_mod
crc\_t10dif crct10dif\_generic mgag200 i2c\_algo\_bit drm\_kms\_helper syscopyarea
sysfillrect sysimgblt fb\_sys\_fops ttm ahci crct10dif\_pclmul crct10dif\_common
drm crc32c\_intel libahci tg3 libata serio\_raw ptp i2c\_core
[ 307.846113] pps\_core dm\_mirror dm\_region\_hash dm\_log dm\_mod
[ 307.866505] CPU: 4 PID: 23867 Comm: mpitests-IMB-MP Kdump: loaded Not
tainted 3.10.0-862.el7.x86\_64.debug #1
[ 307.911178] Hardware name: HP ProLiant DL320e Gen8, BIOS J05 11/09/2013
[ 307.944206] Call Trace:
[ 307.956973] [] dump\_stack+0x19/0x1b
[ 307.982201] [] \_\_warn+0xd8/0x100
[ 308.005999] [] warn\_slowpath\_fmt+0x5f/0x80
[ 308.034260] [] check\_unmap+0x4ee/0xa20
[ 308.060801] [] ? page\_add\_file\_rmap+0x2a/0x1d0
[ 308.090689] [] debug\_dma\_unmap\_page+0x9d/0xb0
[ 308.120155] [] ? might\_fault+0xa0/0xb0
[ 308.146656] [] qib\_tid\_free.isra.14+0x215/0x2a0 [ib\_qib]
[ 308.180739] [] qib\_write+0x894/0x1280 [ib\_qib]
[ 308.210733] [] ? \_\_inode\_security\_revalidate+0x70/0x80
[ 308.244837] [] ? security\_file\_permission+0x27/0xb0
[ 308.266025] qib\_ib0.8006: multicast join failed for
ff12:401b:8006:0000:0000:0000:ffff:ffff, status -22
[ 308.323421] [] vfs\_write+0xc3/0x1f0
[ 308.347077] [] ? fget\_light+0xfc/0x510
[ 308.372533] [] SyS\_write+0x8a/0x100
[ 308.396456] [] system\_call\_fastpath+0x1c/0x21
The code calls a qib\_map\_page() which has never correctly tested for a
mapping error.
Fix by testing for pci\_dma\_mapping\_error() in all cases and properly
handling the failure in the caller.
Additionally, streamline qib\_map\_page() arguments to satisfy just
the single caller.
Cc:
Reviewed-by: Alex Estrin
Tested-by: Don Dutile
Reviewed-by: Don Dutile
Signed-off-by: Mike Marciniszyn
Signed-off-by: Dennis Dalessandro
Signed-off-by: Doug Ledford
Signed-off-by: Greg Kroah-Hartman
commit 330d7e922322ac2fa1be337d946a3167de08d1f7
Author: Hans de Goede
Date: Fri Jun 22 08:42:22 2018 +0200
efi/libstub/tpm: Initialize efi\_physical\_addr\_t vars to zero for mixed mode
commit 52e1cf2d19c2e62e6a81b8de3f7320d033917dd5 upstream.
Commit:
79832f0b5f71 ("efi/libstub/tpm: Initialize pointer variables to zero for mixed mode")
fixes a problem with the tpm code on mixed mode (64-bit kernel on 32-bit UEFI),
where 64-bit pointer variables are not fully initialized by the 32-bit EFI code.
A similar problem applies to the efi\_physical\_addr\_t variables which
are written by the ->get\_event\_log() EFI call. Even though efi\_physical\_addr\_t
is 64-bit everywhere, it seems that some 32-bit UEFI implementations only
fill in the lower 32 bits when passed a pointer to an efi\_physical\_addr\_t
to fill.
This commit initializes these to 0 to, to ensure the upper 32 bits are
0 in mixed mode. This fixes recent kernels sometimes hanging during
early boot on mixed mode UEFI systems.
Signed-off-by: Hans de Goede
Signed-off-by: Ard Biesheuvel
Cc:  # v4.16+
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-efi@vger.kernel.org
Link: http://lkml.kernel.org/r/20180622064222.11633-2-ard.biesheuvel@linaro.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit ba19d312979fbfe361306df85bb7b755e1ae472c
Author: Tadeusz Struk
Date: Tue May 22 14:37:18 2018 -0700
tpm: fix race condition in tpm\_common\_write()
commit 3ab2011ea368ec3433ad49e1b9e1c7b70d2e65df upstream.
There is a race condition in tpm\_common\_write function allowing
two threads on the same /dev/tpm, or two different applications
on the same /dev/tpmrm to overwrite each other commands/responses.
Fixed this by taking the priv->buffer\_mutex early in the function.
Also converted the priv->data\_pending from atomic to a regular size\_t
type. There is no need for it to be atomic since it is only touched
under the protection of the priv->buffer\_mutex.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Cc: stable@vger.kernel.org
Signed-off-by: Tadeusz Struk
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 2dd75ec3c29bac0f0cfafde9069a30af7a3ab778
Author: Tadeusz Struk
Date: Wed May 9 11:55:35 2018 -0700
tpm: fix use after free in tpm2\_load\_context()
commit 8c81c24758ffbf17cf06c6835d361ffa57be2f0e upstream.
If load context command returns with TPM2\_RC\_HANDLE or TPM2\_RC\_REFERENCE\_H0
then we have use after free in line 114 and double free in 117.
Fixes: 4d57856a21ed2 ("tpm2: add session handle context saving and restoring to the space code")
Cc: stable@vger.kernel.org
Signed-off-by: Tadeusz Struk
Reviewed-by: Jarkko Sakkinen
Signed-off--by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit fb4c5420a2440faa6ad375eac54f3f6f8d94d186
Author: Srinivas Kandagatla
Date: Mon Jun 4 15:14:08 2018 +0100
of: platform: stop accessing invalid dev in of\_platform\_device\_destroy
commit 522811e944ed9b36806faa019faec10f9d259cca upstream.
Immediately after the platform\_device\_unregister() the device will be
cleaned up. Accessing the freed pointer immediately after that will
crash the system.
Found this bug when kernel is built with CONFIG\_PAGE\_POISONING and testing
loading/unloading audio drivers in a loop on Qcom platforms.
Fix this by moving of\_node\_clear\_flag() just before the unregister calls.
Below is the crash trace:
Unable to handle kernel paging request at virtual address 6b6b6b6b6b6c03
Mem abort info:
ESR = 0x96000021
Exception class = DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
Data abort info:
ISV = 0, ISS = 0x00000021
CM = 0, WnR = 0
[006b6b6b6b6b6c03] address between user and kernel address ranges
Internal error: Oops: 96000021 [#1] PREEMPT SMP
Modules linked in:
CPU: 2 PID: 1784 Comm: sh Tainted: G W 4.17.0-rc7-02230-ge3a63a7ef641-dirty #204
Hardware name: Qualcomm Technologies, Inc. APQ 8016 SBC (DT)
pstate: 80000005 (Nzcv daif -PAN -UAO)
pc : clear\_bit+0x18/0x2c
lr : of\_platform\_device\_destroy+0x64/0xb8
sp : ffff00000c9c3930
x29: ffff00000c9c3930 x28: ffff80003d39b200
x27: ffff000008bb1000 x26: 0000000000000040
x25: 0000000000000124 x24: ffff80003a9a3080
x23: 0000000000000060 x22: ffff00000939f518
x21: ffff80003aa79e98 x20: ffff80003aa3dae0
x19: ffff80003aa3c890 x18: ffff800009feb794
x17: 0000000000000000 x16: 0000000000000000
x15: ffff800009feb790 x14: 0000000000000000
x13: ffff80003a058778 x12: ffff80003a058728
x11: ffff80003a058750 x10: 0000000000000000
x9 : 0000000000000006 x8 : ffff80003a825988
x7 : bbbbbbbbbbbbbbbb x6 : 0000000000000001
x5 : 0000000000000000 x4 : 0000000000000001
x3 : 0000000000000008 x2 : 0000000000000001
x1 : 6b6b6b6b6b6b6c03 x0 : 0000000000000000
Process sh (pid: 1784, stack limit = 0x (ptrval))
Call trace:
clear\_bit+0x18/0x2c
q6afe\_remove+0x20/0x38
apr\_device\_remove+0x30/0x70
device\_release\_driver\_internal+0x170/0x208
device\_release\_driver+0x14/0x20
bus\_remove\_device+0xcc/0x150
device\_del+0x10c/0x310
device\_unregister+0x1c/0x70
apr\_remove\_device+0xc/0x18
device\_for\_each\_child+0x50/0x80
apr\_remove+0x18/0x20
rpmsg\_dev\_remove+0x38/0x68
device\_release\_driver\_internal+0x170/0x208
device\_release\_driver+0x14/0x20
bus\_remove\_device+0xcc/0x150
device\_del+0x10c/0x310
device\_unregister+0x1c/0x70
qcom\_smd\_remove\_device+0xc/0x18
device\_for\_each\_child+0x50/0x80
qcom\_smd\_unregister\_edge+0x3c/0x70
smd\_subdev\_remove+0x18/0x28
rproc\_stop+0x48/0xd8
rproc\_shutdown+0x60/0xe8
state\_store+0xbc/0xf8
dev\_attr\_store+0x18/0x28
sysfs\_kf\_write+0x3c/0x50
kernfs\_fop\_write+0x118/0x1e0
\_\_vfs\_write+0x18/0x110
vfs\_write+0xa4/0x1a8
ksys\_write+0x48/0xb0
sys\_write+0xc/0x18
el0\_svc\_naked+0x30/0x34
Code: d2800022 8b400c21 f9800031 9ac32043 (c85f7c22)
---[ end trace 32020935775616a2 ]---
Signed-off-by: Srinivas Kandagatla
Cc: stable@vger.kernel.org
Signed-off-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
commit 5c6347cd5d8dc3f96bc1ea7c3bb17127ccfa9d13
Author: Stefan M Schaeckeler
Date: Mon May 21 16:26:14 2018 -0700
of: unittest: for strings, account for trailing \0 in property length field
commit 3b9cf7905fe3ab35ab437b5072c883e609d3498d upstream.
For strings, account for trailing \0 in property length field:
This is consistent with how dtc builds string properties.
Function \_\_of\_prop\_dup() would misbehave on such properties as it duplicates
properties based on the property length field creating new string values
without trailing \0s.
Signed-off-by: Stefan M Schaeckeler
Reviewed-by: Frank Rowand
Tested-by: Frank Rowand
Cc:
Signed-off-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
commit e1a0a5c8d2935c7c2d8e26cad82348b61d4bb15a
Author: Frank Rowand
Date: Wed May 16 21:19:51 2018 -0700
of: overlay: validate offset from property fixups
commit 482137bf2aecd887ebfa8756456764a2f6a0e545 upstream.
The smatch static checker marks the data in offset as untrusted,
leading it to warn:
drivers/of/resolver.c:125 update\_usages\_of\_a\_phandle\_reference()
error: buffer underflow 'prop->value' 's32min-s32max'
Add check to verify that offset is within the property data.
Reported-by: Dan Carpenter
Signed-off-by: Frank Rowand
Cc:
Signed-off-by: Rob Herring
Signed-off-by: Greg Kroah-Hartman
commit 8fe86da8660d898ed3debeb094069b4193ca528f
Author: Kevin Hilman
Date: Thu Jun 7 13:51:01 2018 -0700
ARM64: dts: meson-gx: fix ATF reserved memory region
commit 48e21ded0432ee1e2359d4143d7a6925cefee1b5 upstream.
Vendor firmware/uboot has different reserved regions depending on
firmware version, but current codebase reserves the same regions on
GXL and GXBB, so move the additional reserved memory region to common
.dtsi.
Found when putting a recent vendor u-boot on meson-gxbb-p200.
Suggested-by: Neil Armstrong
Cc: stable@vger.kernel.org
Signed-off-by: Kevin Hilman
Signed-off-by: Greg Kroah-Hartman
commit d886b01099d5b3315e011f0b484ec6837be7de30
Author: Jerome Brunet
Date: Thu Apr 26 12:50:46 2018 +0200
ARM64: dts: meson: disable sd-uhs modes on the libretech-cc
commit d5b4885b1dff72ac670b518cfeaac719d768bd4d upstream.
There is a problem with the sd-uhs mode when doing a soft reboot.
Switching back from 1.8v to 3.3v messes with the card, which no longer
respond (timeout errors). According to the specification, we should
perform a card reset (power cycling the card) but this is something we
cannot control on this design.
Then the only solution to restore the communication with the card is an
"unplug-plug" which is not acceptable
Until we find a solution, if any, disable the sd-uhs modes on this design.
For the people using uhs at the moment, there will a performance drop as
a result.
Fixes: 3cde63ebc85c ("ARM64: dts: meson-gxl: libretech-cc: enable high speed modes")
Signed-off-by: Jerome Brunet
Cc: stable@vger.kernel.org
Signed-off-by: Kevin Hilman
Signed-off-by: Greg Kroah-Hartman
commit 412ea46396d4ba0c7a755230075981d9d12546f8
Author: Thor Thayer
Date: Fri Jun 22 13:35:38 2018 -0500
arm64: dts: stratix10: Fix SPI nodes for Stratix10
commit 4595299c5eaebbec0ca5822214ad1925a10b3876 upstream.
Remove the unused bus-num node and change num-chipselect
to num-cs to match SPI bindings.
Cc: stable@vger.kernel.org
Fixes: 78cd6a9d8e154 ("arm64: dts: Add base stratix 10 dtsi")
Signed-off-by: Thor Thayer
Signed-off-by: Dinh Nguyen
Signed-off-by: Olof Johansson
Signed-off-by: Greg Kroah-Hartman
commit cdcadf3578f720f2baafde31d73cbfaa801538e5
Author: Miquel Raynal
Date: Tue May 22 11:40:28 2018 +0200
arm64: dts: marvell: fix CP110 ICU node size
commit 2f872ddcdb1e8e2186162616cea4581b8403849d upstream.
ICU size in CP110 is not 0x10 but at least 0x440 bytes long (from the
specification).
Fixes: 6ef84a827c37 ("arm64: dts: marvell: enable GICP and ICU on Armada 7K/8K")
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal
Reviewed-by: Thomas Petazzoni
Signed-off-by: Gregory CLEMENT
Signed-off-by: Greg Kroah-Hartman
commit 17f2f5cc6e4f5d0ffd50251dafb4f74e7b429955
Author: Will Deacon
Date: Fri Jun 22 16:23:45 2018 +0100
arm64: mm: Ensure writes to swapper are ordered wrt subsequent cache maintenance
commit 71c8fc0c96abf8e53e74ed4d891d671e585f9076 upstream.
When rewriting swapper using nG mappings, we must performance cache
maintenance around each page table access in order to avoid coherency
problems with the host's cacheable alias under KVM. To ensure correct
ordering of the maintenance with respect to Device memory accesses made
with the Stage-1 MMU disabled, DMBs need to be added between the
maintenance and the corresponding memory access.
This patch adds a missing DMB between writing a new page table entry and
performing a clean+invalidate on the same line.
Fixes: f992b4dfd58b ("arm64: kpti: Add ->enable callback to remap swapper using nG mappings")
Cc:  # 4.16.x-
Acked-by: Mark Rutland
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit c5256da5b8e3749bbd7c74c63ab0d3aa7fe1531a
Author: Will Deacon
Date: Fri Jun 22 10:25:25 2018 +0100
arm64: kpti: Use early\_param for kpti= command-line option
commit b5b7dd647f2d21b93f734ce890671cd908e69b0a upstream.
We inspect \_\_kpti\_forced early on as part of the cpufeature enable
callback which remaps the swapper page table using non-global entries.
Ensure that \_\_kpti\_forced has been updated to reflect the kpti=
command-line option before we start using it.
Fixes: ea1e3de85e94 ("arm64: entry: Add fake CPU feature for unmapping the kernel at EL0")
Cc:  # 4.16.x-
Reported-by: Wei Xu
Tested-by: Sudeep Holla
Tested-by: Wei Xu
Signed-off-by: Will Deacon
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit f151bbc7e62d1e332542fab8f9ca7d2caf5c17fb
Author: Jia He
Date: Fri Jun 8 15:41:44 2018 +0800
crypto: arm64/aes-blk - fix and move skcipher\_walk\_done out of kernel\_neon\_begin, \_end
commit 6e88f01206edab0e5bc105d8f35fac10f4ee14c5 upstream.
In a arm64 server(QDF2400),I met a similar might-sleep warning as [1]:
[ 7.019116] BUG: sleeping function called from invalid context at
./include/crypto/algapi.h:416
[ 7.027863] in\_atomic(): 1, irqs\_disabled(): 0, pid: 410, name:
cryptomgr\_test
[ 7.035106] 1 lock held by cryptomgr\_test/410:
[ 7.039549] #0: (ptrval) (&drbg->drbg\_mutex){+.+.}, at:
drbg\_instantiate+0x34/0x398
[ 7.048038] CPU: 9 PID: 410 Comm: cryptomgr\_test Not tainted
4.17.0-rc6+ #27
[ 7.068228] dump\_backtrace+0x0/0x1c0
[ 7.071890] show\_stack+0x24/0x30
[ 7.075208] dump\_stack+0xb0/0xec
[ 7.078523] \_\_\_might\_sleep+0x160/0x238
[ 7.082360] skcipher\_walk\_done+0x118/0x2c8
[ 7.086545] ctr\_encrypt+0x98/0x130
[ 7.090035] simd\_skcipher\_encrypt+0x68/0xc0
[ 7.094304] drbg\_kcapi\_sym\_ctr+0xd4/0x1f8
[ 7.098400] drbg\_ctr\_update+0x98/0x330
[ 7.102236] drbg\_seed+0x1b8/0x2f0
[ 7.105637] drbg\_instantiate+0x2ac/0x398
[ 7.109646] drbg\_kcapi\_seed+0xbc/0x188
[ 7.113482] crypto\_rng\_reset+0x4c/0xb0
[ 7.117319] alg\_test\_drbg+0xec/0x330
[ 7.120981] alg\_test.part.6+0x1c8/0x3c8
[ 7.124903] alg\_test+0x58/0xa0
[ 7.128044] cryptomgr\_test+0x50/0x58
[ 7.131708] kthread+0x134/0x138
[ 7.134936] ret\_from\_fork+0x10/0x1c
Seems there is a bug in Ard Biesheuvel's commit.
Fixes: 683381747270 ("crypto: arm64/aes-blk - move kernel mode neon
en/disable into loop")
[1] https://www.spinics.net/lists/linux-crypto/msg33103.html
Signed-off-by: jia.he@hxt-semitech.com
Acked-by: Ard Biesheuvel
Cc:  # 4.17
Acked-by: Will Deacon
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit be1db036d79629ce8f6a693367f88423753c36a7
Author: Dave Martin
Date: Thu Jun 7 12:32:05 2018 +0100
arm64: Fix syscall restarting around signal suppressed by tracer
commit 0fe42512b2f03f9e5a20b9f55ef1013a68b4cd48 upstream.
Commit 17c2895 ("arm64: Abstract syscallno manipulation") abstracts
out the pt\_regs.syscallno value for a syscall cancelled by a tracer
as NO\_SYSCALL, and provides helpers to set and check for this
condition. However, the way this was implemented has the
unintended side-effect of disabling part of the syscall restart
logic.
This comes about because the second in\_syscall() check in
do\_signal() re-evaluates the "in a syscall" condition based on the
updated pt\_regs instead of the original pt\_regs. forget\_syscall()
is explicitly called prior to the second check in order to prevent
restart logic in the ret\_to\_user path being spuriously triggered,
which means that the second in\_syscall() check always yields false.
This triggers a failure in
tools/testing/selftests/seccomp/seccomp\_bpf.c, when using ptrace to
suppress a signal that interrups a nanosleep() syscall.
Misbehaviour of this type is only expected in the case where a
tracer suppresses a signal and the target process is either being
single-stepped or the interrupted syscall attempts to restart via
-ERESTARTBLOCK.
This patch restores the old behaviour by performing the
in\_syscall() check only once at the start of the function.
Fixes: 17c289586009 ("arm64: Abstract syscallno manipulation")
Signed-off-by: Dave Martin
Reported-by: Sumit Semwal
Cc: Will Deacon
Cc:  # 4.14.x-
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 44608311b66cf9cc97ba580b234844b9a277144e
Author: Joel Fernandes (Google)
Date: Thu Jun 7 13:11:43 2018 -0700
softirq: Reorder trace\_softirqs\_on to prevent lockdep splat
commit 1a63dcd8765bc8680481dc2f9acf6ef13cee6d27 upstream.
I'm able to reproduce a lockdep splat with config options:
CONFIG\_PROVE\_LOCKING=y,
CONFIG\_DEBUG\_LOCK\_ALLOC=y and
CONFIG\_PREEMPTIRQ\_EVENTS=y
$ echo 1 > /d/tracing/events/preemptirq/preempt\_enable/enable
[ 26.112609] DEBUG\_LOCKS\_WARN\_ON(current->softirqs\_enabled)
[ 26.112636] WARNING: CPU: 0 PID: 118 at kernel/locking/lockdep.c:3854
[...]
[ 26.144229] Call Trace:
[ 26.144926]
[ 26.145506] lock\_acquire+0x55/0x1b0
[ 26.146499] ? \_\_do\_softirq+0x46f/0x4d9
[ 26.147571] ? \_\_do\_softirq+0x46f/0x4d9
[ 26.148646] trace\_preempt\_on+0x8f/0x240
[ 26.149744] ? trace\_preempt\_on+0x4d/0x240
[ 26.150862] ? \_\_do\_softirq+0x46f/0x4d9
[ 26.151930] preempt\_count\_sub+0x18a/0x1a0
[ 26.152985] \_\_do\_softirq+0x46f/0x4d9
[ 26.153937] irq\_exit+0x68/0xe0
[ 26.154755] smp\_apic\_timer\_interrupt+0x271/0x280
[ 26.156056] apic\_timer\_interrupt+0xf/0x20
[ 26.157105]
The issue was this:
preempt\_count = 1 << SOFTIRQ\_SHIFT
\_\_local\_bh\_enable(cnt = 1 << SOFTIRQ\_SHIFT) {
if (softirq\_count() == (cnt && SOFTIRQ\_MASK)) {
trace\_softirqs\_on() {
current->softirqs\_enabled = 1;
}
}
preempt\_count\_sub(cnt) {
trace\_preempt\_on() {
tracepoint() {
rcu\_read\_lock\_sched() {
// jumps into lockdep
Where preempt\_count still has softirqs disabled, but
current->softirqs\_enabled is true, and we get a splat.
Link: http://lkml.kernel.org/r/20180607201143.247775-1-joel@joelfernandes.org
Cc: Peter Zijlstra
Cc: Ingo Molnar
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Tom Zanussi
Cc: Namhyung Kim
Cc: Thomas Glexiner
Cc: Boqun Feng
Cc: Paul McKenney
Cc: Masami Hiramatsu
Cc: Todd Kjos
Cc: Erick Reyes
Cc: Julia Cartwright
Cc: Byungchul Park
Cc: stable@vger.kernel.org
Reviewed-by: Steven Rostedt (VMware)
Fixes: d59158162e032 ("tracing: Add support for preempt and irq enable/disable events")
Signed-off-by: Joel Fernandes (Google)
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 1a371b889a7dd3d5814c845aaf9e09d1df2a47f5
Author: Michael Buesch
Date: Thu Jun 14 20:08:11 2018 +0200
hwrng: core - Always drop the RNG in hwrng\_unregister()
commit 837bf7cc3b7504385ae0e829c72e470dfc27cf6c upstream.
enable\_best\_rng() is used in hwrng\_unregister() to switch away from the
currently active RNG, if that is the one currently being removed.
However enable\_best\_rng() might fail, if the next RNG's init routine
fails. In that case enable\_best\_rng() will return an error code and
the currently active RNG will remain active.
After unregistering this might lead to crashes due to use-after-free.
Fix this by dropping the currently active RNG, if enable\_best\_rng()
failed. This will result in no RNG to be active, if the next-best
one failed to initialize.
This problem was introduced by 142a27f0a731ddcf467546960a5585970ca98e21
Fixes: 142a27f0a731 ("hwrng: core - Reset user selected rng by...")
Reported-by: Wirz
Tested-by: Wirz
Signed-off-by: Michael BÃ¼sch
Cc: stable@vger.kernel.org
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 0654b4f4c3263e3841cdcaaa6e1c809f98a08b6f
Author: Dinh Nguyen
Date: Mon May 14 10:15:19 2018 -0500
ARM: dts: socfpga: Fix NAND controller node compatible for Arria10
commit 3877ef7a1ccecaae378c497e1dcddbc2dccb664c upstream.
The NAND compatible "denali,denal-nand-dt" property has never been used and
is obsolete. Remove it.
Cc: stable@vger.kernel.org
Fixes: f549af06e9b6("ARM: dts: socfpga: Add NAND device tree for Arria10")
Signed-off-by: Dinh Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 747e40a8bd88f300011af72b27ee4ea16836dfcb
Author: Marek Vasut
Date: Thu May 10 16:37:26 2018 +0200
ARM: dts: socfpga: Fix NAND controller clock supply
commit 4eda9b766b042ea38d84df91581b03f6145a2ab0 upstream.
The Denali NAND x-clock should be supplied by nand\_x\_clk, not by
nand\_clk. Fix this, otherwise the Denali driver gets incorrect
clock frequency information and incorrectly configures the NAND
timing.
Cc: stable@vger.kernel.org
Signed-off-by: Marek Vasut
Fixes: d837a80d19 ("ARM: dts: socfpga: add nand controller nodes")
Cc: Steffen Trumtrar
Signed-off-by: Dinh Nguyen
Signed-off-by: Greg Kroah-Hartman
commit b301deb10bf990a2a367b40409c9b5a805d8c5dd
Author: Marek Vasut
Date: Thu May 10 14:52:23 2018 +0200
ARM: dts: socfpga: Fix NAND controller node compatible
commit d9a695f3c8098ac9684689774a151cff30d8aa25 upstream.
The compatible string for the Denali NAND controller is incorrect,
fix it by replacing it with one matching the DT bindings and the
driver.
Cc: stable@vger.kernel.org
Signed-off-by: Marek Vasut
Fixes: d837a80d19 ("ARM: dts: socfpga: add nand controller nodes")
Cc: Steffen Trumtrar
Signed-off-by: Dinh Nguyen
Signed-off-by: Greg Kroah-Hartman
commit 71bc4823de1378581c682dd0c9c61710499bf11b
Author: Thor Thayer
Date: Fri Jun 22 13:37:34 2018 -0500
ARM: dts: Fix SPI node for Arria10
commit 975ba94c2c3aca4d9f1ae26f3916d7787495ce86 upstream.
Remove the unused bus-num node and change num-chipselect
to num-cs to match SPI bindings.
Cc: stable@vger.kernel.org
Fixes: f2d6f8f817814 ("ARM: dts: socfpga: Add SPI Master1 for Arria10 SR chip")
Signed-off-by: Thor Thayer
Signed-off-by: Dinh Nguyen
Signed-off-by: Olof Johansson
Signed-off-by: Greg Kroah-Hartman
commit 1999b9179d6fd694023caf1c4499b6f194b186f3
Author: Chen-Yu Tsai
Date: Tue Apr 24 19:34:18 2018 +0800
ARM: dts: sun8i: h3: fix ALL-H3-CC H3 ver VCC-1V2 regulator voltage
commit bceb1f25b8614e529cc74c5f2339e84f4d4a88ae upstream.
The voltage of the VCC-1V2 regulator on the ALL-H3-CC H3 ver. should be
1.2V, not the 3.3V currently defined in the device tree.
Fix the voltage in the device tree.
Fixes: 6ca358645d4d ("ARM: dts: sun8i: h3: Add dts file for Libre
Computer Board ALL-H3-CC H3 ver.")
Cc:  # 4.16.x
Signed-off-by: Chen-Yu Tsai
Signed-off-by: Maxime Ripard
Signed-off-by: Greg Kroah-Hartman
commit b16653fe7710dad19655c6d1575e4d7029b14b7e
Author: Icenowy Zheng
Date: Tue Feb 6 12:49:04 2018 +0800
ARM: dts: sun8i: h3: fix ALL-H3-CC H3 ver VDD-CPUX voltage
commit e6e7b7c2c81e05c8774193da06348119583d4292 upstream.
The VDD-CPUX voltage of ALL-H3-CC H3 ver should be 1.2V, not the 3.3V
currently defined in the device tree.
Fix the voltage in the device tree.
Fixes: 6ca358645d4d ("ARM: dts: sun8i: h3: Add dts file for Libre Computer Board ALL-H3-CC H3 ver.")
Signed-off-by: Icenowy Zheng
Reviewed-by: Chen-Yu Tsai
Cc:  # 4.16.x
Signed-off-by: Chen-Yu Tsai
Signed-off-by: Greg Kroah-Hartman
commit ab87bc596ece4bdc400aebe513a5638f81c3b046
Author: David Rivshin
Date: Wed Apr 25 21:15:01 2018 +0100
ARM: 8764/1: kgdb: fix NUMREGBYTES so that gdb\_regs[] is the correct size
commit 76ed0b803a2ab793a1b27d1dfe0de7955282cd34 upstream.
NUMREGBYTES (which is used as the size for gdb\_regs[]) is incorrectly
based on DBG\_MAX\_REG\_NUM instead of GDB\_MAX\_REGS. DBG\_MAX\_REG\_NUM
is the number of total registers, while GDB\_MAX\_REGS is the number
of 'unsigned longs' it takes to serialize those registers. Since
FP registers require 3 'unsigned longs' each, DBG\_MAX\_REG\_NUM is
smaller than GDB\_MAX\_REGS.
This causes GDB 8.0 give the following error on connect:
"Truncated register 19 in remote 'g' packet"
This also causes the register serialization/deserialization logic
to overflow gdb\_regs[], overwriting whatever follows.
Fixes: 834b2964b7ab ("kgdb,arm: fix register dump")
Cc:  # 2.6.37+
Signed-off-by: David Rivshin
Acked-by: Rabin Vincent
Tested-by: Daniel Thompson
Signed-off-by: Russell King
Signed-off-by: Greg Kroah-Hartman
commit 301a8cf5661ae685cf047cbe4291bf9c09886f68
Author: Vaibhav Jain
Date: Fri May 18 15:12:23 2018 +0530
cxl: Disable prefault\_mode in Radix mode
commit b6c84ba22ff3a198eb8d5552cf9b8fda1d792e54 upstream.
Currently we see a kernel-oops reported on Power-9 while attaching a
context to an AFU, with radix-mode and sysfs attr 'prefault\_mode' set
to anything other than 'none'. The backtrace of the oops is of this
form:
Unable to handle kernel paging request for data at address 0x00000080
Faulting instruction address: 0xc00800000bcf3b20
cpu 0x1: Vector: 300 (Data Access) at [c00000037f003800]
pc: c00800000bcf3b20: cxl\_load\_segment+0x178/0x290 [cxl]
lr: c00800000bcf39f0: cxl\_load\_segment+0x48/0x290 [cxl]
sp: c00000037f003a80
msr: 9000000000009033
dar: 80
dsisr: 40000000
current = 0xc00000037f280000
paca = 0xc0000003ffffe600 softe: 3 irq\_happened: 0x01
pid = 3529, comm = afp\_no\_int
cxl\_prefault+0xfc/0x248 [cxl]
process\_element\_entry\_psl9+0xd8/0x1a0 [cxl]
cxl\_attach\_dedicated\_process\_psl9+0x44/0x130 [cxl]
native\_attach\_process+0xc0/0x130 [cxl]
afu\_ioctl+0x3f4/0x5e0 [cxl]
do\_vfs\_ioctl+0xdc/0x890
ksys\_ioctl+0x68/0xf0
sys\_ioctl+0x40/0xa0
system\_call+0x58/0x6c
The issue is caused as on Power-8 the AFU attr 'prefault\_mode' was
used to improve initial storage fault performance by prefaulting
process segments. However on Power-9 with radix mode we don't have
Storage-Segments that we can prefault. Also prefaulting process Pages
will be too costly and fine-grained.
Hence, since the prefaulting mechanism doesn't makes sense of
radix-mode, this patch updates prefault\_mode\_store() to not allow any
other value apart from CXL\_PREFAULT\_NONE when radix mode is enabled.
Fixes: f24be42aab37 ("cxl: Add psl9 specific code")
Cc: stable@vger.kernel.org # v4.12+
Signed-off-by: Vaibhav Jain
Acked-by: Frederic Barrat
Acked-by: Andrew Donnellan
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 2c8fd3cbef28b56f6ebaef69477e334cbd9af0ba
Author: Vaibhav Jain
Date: Tue Apr 17 10:41:02 2018 +0530
cxl: Configure PSL to not use APC virtual machines
commit 9a6d2022bacd8fca0be6297459a02dfd28dad6ba upstream.
APC virtual machines arent used on POWER-9 chips and are already
disabled in on-chip CAPP. They also need to be disabled on the PSL via
'PSL Data Send Control Register' by setting bit(47). This forces the
PSL to send commands to CAPP with queue.id == 0.
Fixes: 5632874311db ("cxl: Add support for POWER9 DD2")
Cc: stable@vger.kernel.org # v4.15+
Signed-off-by: Vaibhav Jain
Acked-by: Andrew Donnellan
Reviewed-by: Alastair D'Silva
Reviewed-by: Christophe Lombard
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 5dbf5eb8ae631bfa8448a6381a64441c2e1e418a
Author: Michael Ellerman
Date: Wed Jun 13 23:23:56 2018 +1000
powerpc/64s: Fix DT CPU features Power9 DD2.1 logic
commit 749a0278c2177b2d16da5d8b135ba7f940bb4199 upstream.
In the device tree CPU features quirk code we want to set
CPU\_FTR\_POWER9\_DD2\_1 on all Power9s that aren't DD2.0 or earlier. But
we got the logic wrong and instead set it on all CPUs that aren't
Power9 DD2.0 or earlier, ie. including Power8.
Fix it by making sure we're on a Power9. This isn't a bug in practice
because the only code that checks the feature is Power9 only to begin
with. But we'll backport it anyway to avoid confusion.
Fixes: 9e9626ed3a4a ("powerpc/64s: Fix POWER9 DD2.2 and above in DT CPU features")
Cc: stable@vger.kernel.org # v4.17+
Reported-by: Paul Mackerras
Signed-off-by: Michael Ellerman
Acked-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 8108d537b4436dda926518b0a9385ab896031b73
Author: Michael Jeanson
Date: Thu Jun 14 11:27:42 2018 -0400
powerpc/e500mc: Set assembler machine type to e500mc
commit 69a8405999aa1c489de4b8d349468f0c2b83f093 upstream.
In binutils 2.26 a new opcode for the "wait" instruction was added for the
POWER9 and has precedence over the one specific to the e500mc. Commit
ebf714ff3756 ("powerpc/e500mc: Add support for the wait instruction in
e500\_idle") uses this instruction specifically on the e500mc to work around
an erratum.
This results in an invalid instruction in idle\_e500 when we build for the
e500mc on bintutils >= 2.26 with the default assembler machine type.
Since multiplatform between e500 and non-e500 is not supported, set the
assembler machine type globaly when CONFIG\_PPC\_E500MC=y.
Signed-off-by: Michael Jeanson
Reviewed-by: Mathieu Desnoyers
CC: Benjamin Herrenschmidt
CC: Paul Mackerras
CC: Michael Ellerman
CC: Kumar Gala
CC: Vakul Garg
CC: Scott Wood
CC: Mathieu Desnoyers
CC: linuxppc-dev@lists.ozlabs.org
CC: linux-kernel@vger.kernel.org
CC: stable@vger.kernel.org
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit e6df88998f68f3e2ff11867c264b3a7492e09556
Author: Nicholas Piggin
Date: Tue Jun 12 19:38:08 2018 +1000
powerpc/64s/radix: Fix radix\_kvm\_prefetch\_workaround paca access of not possible CPU
commit 758380b8155f69b4e2f77f27562f8a7a466749d6 upstream.
If possible CPUs are limited (e.g., by kexec), then the kvm prefetch
workaround function can access the paca pointer for a !possible CPU.
Fixes: d2e60075a3d44 ("powerpc/64: Use array of paca pointers and allocate pacas individually")
Cc: stable@kernel.org
Reported-by: Pridhiviraj Paidipeddi
Tested-by: Pridhiviraj Paidipeddi
Signed-off-by: Nicholas Piggin
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 397a7ac34adb78a63cb445b51bbe79f1814d7fdb
Author: Finley Xiao
Date: Mon May 14 11:29:38 2018 +0800
soc: rockchip: power-domain: Fix wrong value when power up pd with writemask
commit 9e59c5f66c624b43c766a9fe3b2430e0e976bf0e upstream.
Solve the pd could only ever turn off but never turn them on again,
if the pd registers have the writemask bits.
So far this affects the rk3328 only.
Fixes: 79bb17ce8edb ("soc: rockchip: power-domain: Support domain control in hiword-registers")
Cc: stable@vger.kernel.org
Signed-off-by: Finley Xiao
Signed-off-by: Elaine Zhang
Reviewed-by: Ulf Hansson
Signed-off-by: Heiko Stuebner
Signed-off-by: Greg Kroah-Hartman
commit dce27cf83bbaa1bbf3f009381066f7a0571a03d8
Author: Ross Zwisler
Date: Wed Jun 6 10:45:15 2018 -0600
libnvdimm, pmem: Do not flush power-fail protected CPU caches
commit 546eb0317cfa3c4f9e1d9ab892766d65d7f78fad upstream.
This commit:
5fdf8e5ba566 ("libnvdimm: re-enable deep flush for pmem devices via fsync()")
intended to make sure that deep flush was always available even on
platforms which support a power-fail protected CPU cache. An unintended
side effect of this change was that we also lost the ability to skip
flushing CPU caches on those power-fail protected CPU cache.
Fix this by skipping the low level cache flushing in dax\_flush() if we have
CPU caches which are power-fail protected. The user can still override this
behavior by manually setting the write\_cache state of a namespace. See
libndctl's ndctl\_namespace\_write\_cache\_is\_enabled(),
ndctl\_namespace\_enable\_write\_cache() and
ndctl\_namespace\_disable\_write\_cache() functions.
Cc:
Fixes: 5fdf8e5ba566 ("libnvdimm: re-enable deep flush for pmem devices via fsync()")
Signed-off-by: Ross Zwisler
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit e4e0a5d95cbcdcc093cf55a39ed1c90bef63c090
Author: Mahesh Salgaonkar
Date: Fri Apr 27 11:53:18 2018 +0530
powerpc/fadump: Unregister fadump on kexec down path.
commit 722cde76d68e8cc4f3de42e71c82fd40dea4f7b9 upstream.
Unregister fadump on kexec down path otherwise the fadump registration
in new kexec-ed kernel complains that fadump is already registered.
This makes new kernel to continue using fadump registered by previous
kernel which may lead to invalid vmcore generation. Hence this patch
fixes this issue by un-registering fadump in fadump\_cleanup() which is
called during kexec path so that new kernel can register fadump with
new valid values.
Fixes: b500afff11f6 ("fadump: Invalidate registration and release reserved memory for general use.")
Cc: stable@vger.kernel.org # v3.4+
Signed-off-by: Mahesh Salgaonkar
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 6de015f7f962f5532e45ff30e1a8c07dbaae6655
Author: Gautham R. Shenoy
Date: Thu May 31 17:45:09 2018 +0530
cpuidle: powernv: Fix promotion from snooze if next state disabled
commit 0a4ec6aa035a52c422eceb2ed51ed88392a3d6c2 upstream.
The commit 78eaa10f027c ("cpuidle: powernv/pseries: Auto-promotion of
snooze to deeper idle state") introduced a timeout for the snooze idle
state so that it could be eventually be promoted to a deeper idle
state. The snooze timeout value is static and set to the target
residency of the next idle state, which would train the cpuidle
governor to pick the next idle state eventually.
The unfortunate side-effect of this is that if the next idle state(s)
is disabled, the CPU will forever remain in snooze, despite the fact
that the system is completely idle, and other deeper idle states are
available.
This patch fixes the issue by dynamically setting the snooze timeout
to the target residency of the next enabled state on the device.
Before Patch:
POWER8 : Only nap disabled.
$ cpupower monitor sleep 30
sleep took 30.01297 seconds and exited with status 0
|Idle\_Stats
PKG |CORE|CPU | snoo | Nap | Fast
0| 8| 0| 96.41| 0.00| 0.00
0| 8| 1| 96.43| 0.00| 0.00
0| 8| 2| 96.47| 0.00| 0.00
0| 8| 3| 96.35| 0.00| 0.00
0| 8| 4| 96.37| 0.00| 0.00
0| 8| 5| 96.37| 0.00| 0.00
0| 8| 6| 96.47| 0.00| 0.00
0| 8| 7| 96.47| 0.00| 0.00
POWER9: Shallow states (stop0lite, stop1lite, stop2lite, stop0, stop1,
stop2) disabled:
$ cpupower monitor sleep 30
sleep took 30.05033 seconds and exited with status 0
|Idle\_Stats
PKG |CORE|CPU | snoo | stop | stop | stop | stop | stop | stop | stop | stop
0| 16| 0| 89.79| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00
0| 16| 1| 90.12| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00
0| 16| 2| 90.21| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00
0| 16| 3| 90.29| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00
After Patch:
POWER8 : Only nap disabled.
$ cpupower monitor sleep 30
sleep took 30.01200 seconds and exited with status 0
|Idle\_Stats
PKG |CORE|CPU | snoo | Nap | Fast
0| 8| 0| 16.58| 0.00| 77.21
0| 8| 1| 18.42| 0.00| 75.38
0| 8| 2| 4.70| 0.00| 94.09
0| 8| 3| 17.06| 0.00| 81.73
0| 8| 4| 3.06| 0.00| 95.73
0| 8| 5| 7.00| 0.00| 96.80
0| 8| 6| 1.00| 0.00| 98.79
0| 8| 7| 5.62| 0.00| 94.17
POWER9: Shallow states (stop0lite, stop1lite, stop2lite, stop0, stop1,
stop2) disabled:
$ cpupower monitor sleep 30
sleep took 30.02110 seconds and exited with status 0
|Idle\_Stats
PKG |CORE|CPU | snoo | stop | stop | stop | stop | stop | stop | stop | stop
0| 0| 0| 0.69| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 9.39| 89.70
0| 0| 1| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.05| 93.21
0| 0| 2| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 89.93
0| 0| 3| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 0.00| 93.26
Fixes: 78eaa10f027c ("cpuidle: powernv/pseries: Auto-promotion of snooze to deeper idle state")
Cc: stable@vger.kernel.org # v4.2+
Signed-off-by: Gautham R. Shenoy
Reviewed-by: Balbir Singh
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 3d5abb68b21e621b095a5e1af4c8a6eb8e9008f6
Author: Akshay Adiga
Date: Wed May 16 17:32:14 2018 +0530
powerpc/powernv/cpuidle: Init all present cpus for deep states
commit ac9816dcbab53c57bcf1d7b15370b08f1e284318 upstream.
Init all present cpus for deep states instead of "all possible" cpus.
Init fails if a possible cpu is guarded. Resulting in making only
non-deep states available for cpuidle/hotplug.
Stewart says, this means that for single threaded workloads, if you
guard out a CPU core you'll not get WoF (Workload Optimised
Frequency), which means that performance goes down when you wouldn't
expect it to.
Fixes: 77b54e9f213f ("powernv/powerpc: Add winkle support for offline cpus")
Cc: stable@vger.kernel.org # v3.19+
Signed-off-by: Akshay Adiga
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 588c94787a9c5607b4fdabe3c4a129ba3ea701ea
Author: Haren Myneni
Date: Mon Jun 4 18:33:38 2018 +1000
powerpc/powernv: copy/paste - Mask SO bit in CR
commit 75743649064ec0cf5ddd69f240ef23af66dde16e upstream.
NX can set the 3rd bit in CR register for XER[SO] (Summary overflow)
which is not related to paste request. The current paste function
returns failure for a successful request when this bit is set. So mask
this bit and check the proper return status.
Fixes: 2392c8c8c045 ("powerpc/powernv/vas: Define copy/paste interfaces")
Cc: stable@vger.kernel.org # v4.14+
Signed-off-by: Haren Myneni
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 5eaad8b7f7222c050dcbfd2827b304664e23b144
Author: Alexey Kardashevskiy
Date: Wed May 30 19:22:50 2018 +1000
powerpc/powernv/ioda2: Remove redundant free of TCE pages
commit 98fd72fe82527fd26618062b60cfd329451f2329 upstream.
When IODA2 creates a PE, it creates an IOMMU table with it\_ops::free
set to pnv\_ioda2\_table\_free() which calls pnv\_pci\_ioda2\_table\_free\_pages().
Since iommu\_tce\_table\_put() calls it\_ops::free when the last reference
to the table is released, explicit call to pnv\_pci\_ioda2\_table\_free\_pages()
is not needed so let's remove it.
This should fix double free in the case of PCI hotuplug as
pnv\_pci\_ioda2\_table\_free\_pages() does not reset neither
iommu\_table::it\_base nor ::it\_size.
This was not exposed by SRIOV as it uses different code path via
pnv\_pcibios\_sriov\_disable().
IODA1 does not inialize it\_ops::free so it does not have this issue.
Fixes: c5f7700bbd2e ("powerpc/powernv: Dynamically release PE")
Cc: stable@vger.kernel.org # v4.8+
Signed-off-by: Alexey Kardashevskiy
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 698ca4b33dbddb801e485600ba2b8a3f34d81d3c
Author: Michael Neuling
Date: Thu May 17 15:37:14 2018 +1000
powerpc/ptrace: Fix enforcement of DAWR constraints
commit cd6ef7eebf171bfcba7dc2df719c2a4958775040 upstream.
Back when we first introduced the DAWR, in commit 4ae7ebe9522a
("powerpc: Change hardware breakpoint to allow longer ranges"), we
screwed up the constraint making it a 1024 byte boundary rather than a
512. This makes the check overly permissive. Fortunately GDB is the
only real user and it always did they right thing, so we never
noticed.
This fixes the constraint to 512 bytes.
Fixes: 4ae7ebe9522a ("powerpc: Change hardware breakpoint to allow longer ranges")
Cc: stable@vger.kernel.org # v3.9+
Signed-off-by: Michael Neuling
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit a4de2ca91f0e394840effd163a902150b982f1a2
Author: Anju T Sudhakar
Date: Wed May 16 12:05:18 2018 +0530
powerpc/perf: Fix memory allocation for core-imc based on num\_possible\_cpus()
commit d2032678e57fc508d7878307badde8f89b632ba3 upstream.
Currently memory is allocated for core-imc based on cpu\_present\_mask,
which has bit 'cpu' set iff cpu is populated. We use (cpu number / threads
per core) as the array index to access the memory.
Under some circumstances firmware marks a CPU as GUARDed CPU and boot the
system, until cleared of errors, these CPU's are unavailable for all
subsequent boots. GUARDed CPUs are possible but not present from linux
view, so it blows a hole when we assume the max length of our allocation
is driven by our max present cpus, where as one of the cpus might be online
and be beyond the max present cpus, due to the hole.
So (cpu number / threads per core) value bounds the array index and leads
to memory overflow.
Call trace observed during a guard test:
Faulting instruction address: 0xc000000000149f1c
cpu 0x69: Vector: 380 (Data Access Out of Range) at [c000003fea303420]
pc:c000000000149f1c: prefetch\_freepointer+0x14/0x30
lr:c00000000014e0f8: \_\_kmalloc+0x1a8/0x1ac
sp:c000003fea3036a0
msr:9000000000009033
dar:c9c54b2c91dbf6b7
current = 0xc000003fea2c0000
paca = 0xc00000000fddd880 softe: 3 irq\_happened: 0x01
pid = 1, comm = swapper/104
Linux version 4.16.7-openpower1 (smc@smc-desktop) (gcc version 6.4.0
(Buildroot 2018.02.1-00006-ga8d1126)) #2 SMP Fri May 4 16:44:54 PDT 2018
enter ? for help
call trace:
\_\_kmalloc+0x1a8/0x1ac
(unreliable)
init\_imc\_pmu+0x7f4/0xbf0
opal\_imc\_counters\_probe+0x3fc/0x43c
platform\_drv\_probe+0x48/0x80
driver\_probe\_device+0x22c/0x308
\_\_driver\_attach+0xa0/0xd8
bus\_for\_each\_dev+0x88/0xb4
driver\_attach+0x2c/0x40
bus\_add\_driver+0x1e8/0x228
driver\_register+0xd0/0x114
\_\_platform\_driver\_register+0x50/0x64
opal\_imc\_driver\_init+0x24/0x38
do\_one\_initcall+0x150/0x15c
kernel\_init\_freeable+0x250/0x254
kernel\_init+0x1c/0x150
ret\_from\_kernel\_thread+0x5c/0xc8
Allocating memory for core-imc based on cpu\_possible\_mask, which has
bit 'cpu' set iff cpu is populatable, will fix this issue.
Reported-by: Pridhiviraj Paidipeddi
Signed-off-by: Anju T Sudhakar
Reviewed-by: Balbir Singh
Tested-by: Pridhiviraj Paidipeddi
Fixes: 39a846db1d57 ("powerpc/perf: Add core IMC PMU support")
Cc: stable@vger.kernel.org # v4.14+
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 2b51c0ea71f2892f00cfd47da4e949df2215a249
Author: Michael Neuling
Date: Thu May 17 15:37:15 2018 +1000
powerpc/ptrace: Fix setting 512B aligned breakpoints with PTRACE\_SET\_DEBUGREG
commit 4f7c06e26ec9cf7fe9f0c54dc90079b6a4f4b2c3 upstream.
In commit e2a800beaca1 ("powerpc/hw\_brk: Fix off by one error when
validating DAWR region end") we fixed setting the DAWR end point to
its max value via PPC\_PTRACE\_SETHWDEBUG. Unfortunately we broke
PTRACE\_SET\_DEBUGREG when setting a 512 byte aligned breakpoint.
PTRACE\_SET\_DEBUGREG currently sets the length of the breakpoint to
zero (memset() in hw\_breakpoint\_init()). This worked with
arch\_validate\_hwbkpt\_settings() before the above patch was applied but
is now broken if the breakpoint is 512byte aligned.
This sets the length of the breakpoint to 8 bytes when using
PTRACE\_SET\_DEBUGREG.
Fixes: e2a800beaca1 ("powerpc/hw\_brk: Fix off by one error when validating DAWR region end")
Cc: stable@vger.kernel.org # v3.11+
Signed-off-by: Michael Neuling
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit d7690c985744939c12ff762135406233257be304
Author: Ram Pai
Date: Fri May 4 13:01:51 2018 -0700
powerpc/pkeys: Detach execute\_only key on !PROT\_EXEC
commit eabdb8ca8690eedd461e61ea7780595fbbae8132 upstream.
Disassociate the exec\_key from a VMA if the VMA permission is not
PROT\_EXEC anymore. Otherwise the exec\_only key continues to be
associated with the vma, causing unexpected behavior.
The problem was reported on x86 by Shakeel Butt, which is also
applicable on powerpc.
Fixes: 5586cf61e108 ("powerpc: introduce execute-only pkey")
Cc: stable@vger.kernel.org # v4.16+
Reported-by: Shakeel Butt
Signed-off-by: Ram Pai
Reviewed-by: Thiago Jung Bauermann
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 6ab840f24cecd21c8da572d6e07ae25b0cdce5d7
Author: Aneesh Kumar K.V
Date: Wed May 30 18:48:04 2018 +0530
powerpc/mm/hash: Add missing isync prior to kernel stack SLB switch
commit 91d06971881f71d945910de128658038513d1b24 upstream.
Currently we do not have an isync, or any other context synchronizing
instruction prior to the slbie/slbmte in \_switch() that updates the
SLB entry for the kernel stack.
However that is not correct as outlined in the ISA.
From Power ISA Version 3.0B, Book III, Chapter 11, page 1133:
"Changing the contents of ... the contents of SLB entries ... can
have the side effect of altering the context in which data
addresses and instruction addresses are interpreted, and in which
instructions are executed and data accesses are performed.
...
These side effects need not occur in program order, and therefore
may require explicit synchronization by software.
...
The synchronizing instruction before the context-altering
instruction ensures that all instructions up to and including that
synchronizing instruction are fetched and executed in the context
that existed before the alteration."
And page 1136:
"For data accesses, the context synchronizing instruction before the
slbie, slbieg, slbia, slbmte, tlbie, or tlbiel instruction ensures
that all preceding instructions that access data storage have
completed to a point at which they have reported all exceptions
they will cause."
We're not aware of any bugs caused by this, but it should be fixed
regardless.
Add the missing isync when updating kernel stack SLB entry.
Cc: stable@vger.kernel.org
Signed-off-by: Aneesh Kumar K.V
[mpe: Flesh out change log with more ISA text & explanation]
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit dcc2f0e875c53b3ffe70859354d3048567688893
Author: Miklos Szeredi
Date: Thu May 31 12:26:10 2018 +0200
fuse: fix control dir setup and teardown
commit 6becdb601bae2a043d7fb9762c4d48699528ea6e upstream.
syzbot is reporting NULL pointer dereference at fuse\_ctl\_remove\_conn() [1].
Since fc->ctl\_ndents is incremented by fuse\_ctl\_add\_conn() when new\_inode()
failed, fuse\_ctl\_remove\_conn() reaches an inode-less dentry and tries to
clear d\_inode(dentry)->i\_private field.
Fix by only adding the dentry to the array after being fully set up.
When tearing down the control directory, do d\_invalidate() on it to get rid
of any mounts that might have been added.
[1] https://syzkaller.appspot.com/bug?id=f396d863067238959c91c0b7cfc10b163638cac6
Reported-by: syzbot
Fixes: bafa96541b25 ("[PATCH] fuse: add control filesystem")
Cc:  # v2.6.18
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit bb086bb13b2427078b2de4ac93f10830b493e74d
Author: Tetsuo Handa
Date: Tue May 1 13:12:14 2018 +0900
fuse: don't keep dead fuse\_conn at fuse\_fill\_super().
commit 543b8f8662fe6d21f19958b666ab0051af9db21a upstream.
syzbot is reporting use-after-free at fuse\_kill\_sb\_blk() [1].
Since sb->s\_fs\_info field is not cleared after fc was released by
fuse\_conn\_put() when initialization failed, fuse\_kill\_sb\_blk() finds
already released fc and tries to hold the lock. Fix this by clearing
sb->s\_fs\_info field after calling fuse\_conn\_put().
[1] https://syzkaller.appspot.com/bug?id=a07a680ed0a9290585ca424546860464dd9658db
Signed-off-by: Tetsuo Handa
Reported-by: syzbot
Fixes: 3b463ae0c626 ("fuse: invalidation reverse calls")
Cc: John Muir
Cc: Csaba Henk
Cc: Anand Avati
Cc:  # v2.6.31
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 7b6bdfafaffc71ce611ab28e09eedc6a0b743832
Author: Miklos Szeredi
Date: Thu Feb 8 15:17:38 2018 +0100
fuse: atomic\_o\_trunc should truncate pagecache
commit df0e91d488276086bc07da2e389986cae0048c37 upstream.
Fuse has an "atomic\_o\_trunc" mode, where userspace filesystem uses the
O\_TRUNC flag in the OPEN request to truncate the file atomically with the
open.
In this mode there's no need to send a SETATTR request to userspace after
the open, so fuse\_do\_setattr() checks this mode and returns. But this
misses the important step of truncating the pagecache.
Add the missing parts of truncation to the ATTR\_OPEN branch.
Reported-by: Chad Austin
Fixes: 6ff958edbf39 ("fuse: add atomic open+truncate support")
Signed-off-by: Miklos Szeredi
Cc:
Signed-off-by: Greg Kroah-Hartman
commit f1e5a66aebb9325d7643812ac3e1b0a641931fc1
Author: Tejun Heo
Date: Fri Feb 2 09:54:14 2018 -0800
fuse: fix congested state leak on aborted connections
commit 8a301eb16d99983a4961f884690ec97b92e7dcfe upstream.
If a connection gets aborted while congested, FUSE can leave
nr\_wb\_congested[] stuck until reboot causing wait\_iff\_congested() to
wait spuriously which can lead to severe performance degradation.
The leak is caused by gating congestion state clearing with
fc->connected test in request\_end(). This was added way back in 2009
by 26c3679101db ("fuse: destroy bdi on umount"). While the commit
description doesn't explain why the test was added, it most likely was
to avoid dereferencing bdi after it got destroyed.
Since then, bdi lifetime rules have changed many times and now we're
always guaranteed to have access to the bdi while the superblock is
alive (fc->sb).
Drop fc->connected conditional to avoid leaking congestion states.
Signed-off-by: Tejun Heo
Reported-by: Joshua Miller
Cc: Johannes Weiner
Cc: stable@vger.kernel.org # v2.6.29+
Acked-by: Jan Kara
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit b8a177e22083de43da0727715d63b49eecbce659
Author: Tetsuo Handa
Date: Fri May 11 19:54:19 2018 +0900
printk: fix possible reuse of va\_list variable
commit 988a35f8da1dec5a8cd2788054d1e717be61bf25 upstream.
I noticed that there is a possibility that printk\_safe\_log\_store() causes
kernel oops because "args" parameter is passed to vsnprintf() again when
atomic\_cmpxchg() detected that we raced. Fix this by using va\_copy().
Link: http://lkml.kernel.org/r/201805112002.GIF21216.OFVHFOMLJtQFSO@I-love.SAKURA.ne.jp
Cc: Peter Zijlstra
Cc: Steven Rostedt
Cc: dvyukov@google.com
Cc: syzkaller@googlegroups.com
Cc: fengguang.wu@intel.com
Cc: linux-kernel@vger.kernel.org
Signed-off-by: Tetsuo Handa
Fixes: 42a0bb3f71383b45 ("printk/nmi: generic solution for safe printk in NMI")
Cc: 4.7+  # v4.7+
Reviewed-by: Sergey Senozhatsky
Signed-off-by: Petr Mladek
Signed-off-by: Greg Kroah-Hartman
commit 9d842dd3290c8280a3d4bd4d481071eaddd6275b
Author: Amit Pundir
Date: Mon Apr 16 12:10:24 2018 +0530
Bluetooth: hci\_qca: Avoid missing rampatch failure with userspace fw loader
commit 7dc5fe0814c35ec4e7d2e8fa30abab72e0e6a172 upstream.
AOSP use userspace firmware loader to load firmwares, which will
return -EAGAIN in case qca/rampatch\_00440302.bin is not found.
Since there is no rampatch for dragonboard820c QCA controller
revision, just make it work as is.
CC: Loic Poulain
CC: Nicolas Dechesne
CC: Marcel Holtmann
CC: Johan Hedberg
CC: Stable
Signed-off-by: Amit Pundir
Signed-off-by: Marcel Holtmann
Signed-off-by: Greg Kroah-Hartman
commit 52ba3606a808c433c2a03fd9ad144129ddbdbd7f
Author: Corey Minyard
Date: Tue May 22 08:14:51 2018 -0500
ipmi:bt: Set the timeout before doing a capabilities check
commit fe50a7d0393a552e4539da2d31261a59d6415950 upstream.
There was one place where the timeout value for an operation was
not being set, if a capabilities request was done from idle. Move
the timeout value setting to before where that change might be
requested.
IMHO the cause here is the invisible returns in the macros. Maybe
that's a job for later, though.
Reported-by: Nordmark Claes
Signed-off-by: Corey Minyard
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 510c1658ddd55a870fe6a46c7656321a45f47dd8
Author: Mikulas Patocka
Date: Wed May 30 08:19:22 2018 -0400
branch-check: fix long->int truncation when profiling branches
commit 2026d35741f2c3ece73c11eb7e4a15d7c2df9ebe upstream.
The function \_\_builtin\_expect returns long type (see the gcc
documentation), and so do macros likely and unlikely. Unfortunatelly, when
CONFIG\_PROFILE\_ANNOTATED\_BRANCHES is selected, the macros likely and
unlikely expand to \_\_branch\_check\_\_ and \_\_branch\_check\_\_ truncates the
long type to int. This unintended truncation may cause bugs in various
kernel code (we found a bug in dm-writecache because of it), so it's
better to fix \_\_branch\_check\_\_ to return long.
Link: http://lkml.kernel.org/r/alpine.LRH.2.02.1805300818140.24812@file01.intranet.prod.int.rdu2.redhat.com
Cc: Ingo Molnar
Cc: stable@vger.kernel.org
Fixes: 1f0d69a9fc815 ("tracing: profile likely and unlikely annotations")
Signed-off-by: Mikulas Patocka
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit e5da9c5d96abad17fb4d08e37bac665ac9fa635f
Author: Matthias Schiffer
Date: Sat Mar 24 17:57:49 2018 +0100
mips: ftrace: fix static function graph tracing
commit 6fb8656646f996d1eef42e6d56203c4915cb9e08 upstream.
ftrace\_graph\_caller was never run after calling ftrace\_trace\_function,
breaking the function graph tracer. Fix this, bringing it in line with the
x86 implementation.
While we're at it, also streamline the control flow of \_mcount a bit to
reduce the number of branches.
This issue was reported before:
https://www.linux-mips.org/archives/linux-mips/2014-11/msg00295.html
Signed-off-by: Matthias Schiffer
Tested-by: Matt Redfearn
Patchwork: https://patchwork.linux-mips.org/patch/18929/
Signed-off-by: Paul Burton
Cc: stable@vger.kernel.org # v3.17+
Signed-off-by: Greg Kroah-Hartman
commit 9830adf3ff203f802d80f1989391811bf28628ae
Author: Steven Rostedt (VMware)
Date: Mon May 14 15:40:29 2018 -0400
ftrace/selftest: Have the reset\_trigger code be a bit more careful
commit 756b56a9e832e063edc83be7c3889e98c536dd2b upstream.
The trigger code is picky in how it can be disabled as there may be
dependencies between different events and synthetic events. Change the order
on how triggers are reset.
1) Reset triggers of all synthetic events first
2) Remove triggers with actions attached to them
3) Remove all other triggers
If this order isn't followed, then some triggers will not be reset, and an
error may happen because a trigger is busy.
Cc: stable@vger.kernel.org
Fixes: cfa0963dc474f ("kselftests/ftrace : Add event trigger testcases")
Reviewed-by: Namhyung Kim
Acked-by: Masami Hiramatsu
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 1bdd898794afba925199aaf77e2d502091d3b400
Author: Geert Uytterhoeven
Date: Fri Jun 1 11:28:22 2018 +0200
lib/vsprintf: Remove atomic-unsafe support for %pCr
commit 666902e42fd8344b923c02dc5b0f37948ff4f225 upstream.
"%pCr" formats the current rate of a clock, and calls clk\_get\_rate().
The latter obtains a mutex, hence it must not be called from atomic
context.
Remove support for this rarely-used format, as vsprintf() (and e.g.
printk()) must be callable from any context.
Any remaining out-of-tree users will start seeing the clock's name
printed instead of its rate.
Reported-by: Jia-Ju Bai
Fixes: 900cca2944254edd ("lib/vsprintf: add %pC{,n,r} format specifiers for clocks")
Link: http://lkml.kernel.org/r/1527845302-12159-5-git-send-email-geert+renesas@glider.be
To: Jia-Ju Bai
To: Jonathan Corbet
To: Michael Turquette
To: Stephen Boyd
To: Zhang Rui
To: Eduardo Valentin
To: Eric Anholt
To: Stefan Wahren
To: Greg Kroah-Hartman
Cc: Sergey Senozhatsky
Cc: Petr Mladek
Cc: Linus Torvalds
Cc: Steven Rostedt
Cc: linux-doc@vger.kernel.org
Cc: linux-clk@vger.kernel.org
Cc: linux-pm@vger.kernel.org
Cc: linux-serial@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-renesas-soc@vger.kernel.org
Cc: linux-kernel@vger.kernel.org
Cc: Geert Uytterhoeven
Cc: stable@vger.kernel.org # 4.1+
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Petr Mladek
Signed-off-by: Greg Kroah-Hartman
commit d9d35ee53b915e81880006285a43901bf97aa09b
Author: Geert Uytterhoeven
Date: Fri Jun 1 11:28:19 2018 +0200
clk: renesas: cpg-mssr: Stop using printk format %pCr
commit ef4b0be62641d296cf4c0ad8f75ab83ab066ed51 upstream.
Printk format "%pCr" will be removed soon, as clk\_get\_rate() must not be
called in atomic context.
Replace it by open-coding the operation. This is safe here, as the code
runs in task context.
Link: http://lkml.kernel.org/r/1527845302-12159-2-git-send-email-geert+renesas@glider.be
To: Jia-Ju Bai
To: Jonathan Corbet
To: Michael Turquette
To: Stephen Boyd
To: Zhang Rui
To: Eduardo Valentin
To: Eric Anholt
To: Stefan Wahren
To: Greg Kroah-Hartman
Cc: Sergey Senozhatsky
Cc: Petr Mladek
Cc: Linus Torvalds
Cc: Steven Rostedt
Cc: linux-doc@vger.kernel.org
Cc: linux-clk@vger.kernel.org
Cc: linux-pm@vger.kernel.org
Cc: linux-serial@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-renesas-soc@vger.kernel.org
Cc: linux-kernel@vger.kernel.org
Cc: Geert Uytterhoeven
Cc: stable@vger.kernel.org # 4.5+
Signed-off-by: Geert Uytterhoeven
Acked-by: Stephen Boyd
Signed-off-by: Petr Mladek
Signed-off-by: Greg Kroah-Hartman
commit b1735e3cb143b8b75d36e3883a9ae883c156a02a
Author: Geert Uytterhoeven
Date: Fri Jun 1 11:28:20 2018 +0200
thermal: bcm2835: Stop using printk format %pCr
commit bd2a07f71a1e2e198f8a30cb551d9defe422d83d upstream.
Printk format "%pCr" will be removed soon, as clk\_get\_rate() must not be
called in atomic context.
Replace it by printing the variable that already holds the clock rate.
Note that calling clk\_get\_rate() is safe here, as the code runs in task
context.
Link: http://lkml.kernel.org/r/1527845302-12159-3-git-send-email-geert+renesas@glider.be
To: Jia-Ju Bai
To: Jonathan Corbet
To: Michael Turquette
To: Stephen Boyd
To: Zhang Rui
To: Eduardo Valentin
To: Eric Anholt
To: Stefan Wahren
To: Greg Kroah-Hartman
Cc: Sergey Senozhatsky
Cc: Petr Mladek
Cc: Linus Torvalds
Cc: Steven Rostedt
Cc: linux-doc@vger.kernel.org
Cc: linux-clk@vger.kernel.org
Cc: linux-pm@vger.kernel.org
Cc: linux-serial@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: linux-renesas-soc@vger.kernel.org
Cc: linux-kernel@vger.kernel.org
Cc: stable@vger.kernel.org # 4.12+
Signed-off-by: Geert Uytterhoeven
Acked-by: Stefan Wahren
Signed-off-by: Petr Mladek
Signed-off-by: Greg Kroah-Hartman
commit f5333c0ab3d0dfb329a271b3527a7f4567b5c932
Author: Alexander Sverdlin
Date: Sat Apr 28 22:51:39 2018 +0200
ASoC: cirrus: i2s: Fix {TX|RX}LinCtrlData setup
commit 5d302ed3cc80564fb835bed5fdba1e1250ecc9e5 upstream.
According to "EP93xx Userâ€™s Guide", I2STXLinCtrlData and I2SRXLinCtrlData
registers actually have different format. The only currently used bit
(Left\_Right\_Justify) has different position. Fix this and simplify the
whole setup taking into account the fact that both registers have zero
default value.
The practical effect of the above is repaired SND\_SOC\_DAIFMT\_RIGHT\_J
support (currently unused).
Signed-off-by: Alexander Sverdlin
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit ba0ec6da7c24495fb5b600f2d57c11b083288dad
Author: Alexander Sverdlin
Date: Sat Apr 28 22:51:38 2018 +0200
ASoC: cirrus: i2s: Fix LRCLK configuration
commit 2d534113be9a2aa532a1ae127a57e83558aed358 upstream.
The bit responsible for LRCLK polarity is i2s\_tlrs (0), not i2s\_trel (2)
(refer to "EP93xx User's Guide").
Previously card drivers which specified SND\_SOC\_DAIFMT\_NB\_IF actually got
SND\_SOC\_DAIFMT\_NB\_NF, an adaptation is necessary to retain the old
behavior.
Signed-off-by: Alexander Sverdlin
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 9f2a8125e21a1646184e53b71b0e32b35e0f27fc
Author: Kai Chieh Chuang
Date: Fri Apr 27 10:11:35 2018 +0800
ASoC: mediatek: preallocate pages use platform device
commit 5845e6155d8f4a4a9bae2d4c1d1bb4a4d9a925c2 upstream.
preallocate pages should use platform device,
since we set dma mask for platform device.
Signed-off-by: KaiChieh Chuang
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 697f9ed49d487c2fcf0f0443101d85663958b937
Author: Paul Handrigan
Date: Fri May 4 16:37:41 2018 -0500
ASoC: cs35l35: Add use\_single\_rw to regmap config
commit 6a6ad7face95af0b9e6aaf1eb2261eb70240b89b upstream.
Add the use\_single\_rw flag to regmap config since the
device does not support bulk transactions over i2c.
Signed-off-by: Paul Handrigan
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 83d0e2f3de225db275605c8319a87adbd852d67c
Author: Srinivas Kandagatla
Date: Mon Jun 4 12:13:26 2018 +0100
ASoC: dapm: delete dapm\_kcontrol\_data paths list before freeing it
commit ff2faf1289c1f81b5b26b9451dd1c2006aac8db8 upstream.
dapm\_kcontrol\_data is freed as part of dapm\_kcontrol\_free(), leaving the
paths pointer dangling in the list.
This leads to system crash when we try to unload and reload sound card.
I hit this bug during ADSP crash/reboot test case on Dragon board DB410c.
Without this patch, on SLAB Poisoning enabled build, kernel crashes with
"BUG kmalloc-128 (Tainted: G W ): Poison overwritten"
Signed-off-by: Srinivas Kandagatla
Signed-off-by: Mark Brown
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 63f60351c4dc7b9d207928b1b2e2aa8465d5d8f8
Author: Ingo Flaschberger
Date: Tue May 1 16:10:33 2018 +0200
1wire: family module autoload fails because of upper/lower case mismatch.
commit 065c09563c872e52813a17218c52cd642be1dca6 upstream.
1wire family module autoload fails because of upper/lower
Â case mismatch.
Signed-off-by: Ingo Flaschberger
Acked-by: Evgeniy Polyakov
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 9247717225a4aac70a5e0869ade4b03af76c4081
Author: Maxim Moseychuk
Date: Thu Jan 4 21:43:03 2018 +0300
usb: do not reset if a low-speed or full-speed device timed out
commit 6e01827ed93947895680fbdad68c072a0f4e2450 upstream.
Some low-speed and full-speed devices (for example, bluetooth)
do not have time to initialize. For them, ETIMEDOUT is a valid error.
We need to give them another try. Otherwise, they will
never be initialized correctly and in dmesg will be messages
"Bluetooth: hci0 command 0x1002 tx timeout" or similars.
Fixes: 264904ccc33c ("usb: retry reset if a device times out")
Cc: stable
Signed-off-by: Maxim Moseychuk
Signed-off-by: Greg Kroah-Hartman
commit e05b3dce989b37b74d7cca907e3a3a10fbcca908
Author: Wolfram Sang
Date: Fri Jun 1 13:00:37 2018 +0200
mmc: renesas\_sdhi: really fix WP logic regressions
commit ef5332c10d4f332a2ac79e9ad5452f4e89d1815a upstream.
This reverts commit e060d376cc61 ("mmc: renesas\_sdhi: fix WP detection")
and adds some code to really fix the regressions.
It was missed so far that Renesas R-Car instantiations of SDHI chose to
disable internal WP and used the existence of "wp-gpios" to en/disable
WP at all.
With the first refactoring by Yamada-san with commit 2ad1db059b9a ("mmc:
renesas\_sdhi: use MMC\_CAP2\_NO\_WRITE\_PROTECT instead of TMIO own flag"),
WP was always disabled even when GPIOs were present. With Wolfram's
first fix which gets now reverted, GPIOs were honored. But when not
available, the fallback was to internal WP and not to disabled WP. This
caused wrong WP status on uSD card slots.
Restore the old behaviour now. By default, WP is disabled. When a GPIO
is found, the GPIO re-enables WP. We will think about possible better
ways to handle this in the future.
Tested on a previously regressing Renesas Lager board (H2) and a still
working Renesas Salvator-X board (M3-W).
Reported-by: Yoshihiro Shimoda
Signed-off-by: Wolfram Sang
Cc: stable@vger.kernel.org # v4.17+
Signed-off-by: Ulf Hansson
Signed-off-by: Greg Kroah-Hartman
commit 29ba76637083f40f86efddf03a9cf24d1ae36c92
Author: Waldemar Rymarkiewicz
Date: Thu Jun 14 15:56:08 2018 +0200
PM / OPP: Update voltage in case freq == old\_freq
commit c5c2a97b3ac7d1ec19e7cff9e38caca6afefc3de upstream.
This commit fixes a rare but possible case when the clk rate is updated
without update of the regulator voltage.
At boot up, CPUfreq checks if the system is running at the right freq. This
is a sanity check in case a bootloader set clk rate that is outside of freq
table present with cpufreq core. In such cases system can be unstable so
better to change it to a freq that is preset in freq-table.
The CPUfreq takes next freq that is >= policy->cur and this is our
target\_freq that needs to be set now.
dev\_pm\_opp\_set\_rate(dev, target\_freq) checks the target\_freq and the
old\_freq (a current rate). If these are equal it returns early. If not,
it searches for OPP (old\_opp) that fits best to old\_freq (not listed in
the table) and updates old\_freq (!).
Here, we can end up with old\_freq = old\_opp.rate = target\_freq, which
is not handled in \_generic\_set\_opp\_regulator(). It's supposed to update
voltage only when freq > old\_freq || freq > old\_freq.
if (freq > old\_freq) {
ret = \_set\_opp\_voltage(dev, reg, new\_supply);
[...]
if (freq < old\_freq) {
ret = \_set\_opp\_voltage(dev, reg, new\_supply);
if (ret)
It results in, no voltage update while clk rate is updated.
Example:
freq-table = {
1000MHz 1.15V
666MHZ 1.10V
333MHz 1.05V
}
boot-up-freq = 800MHz # not listed in freq-table
freq = target\_freq = 1GHz
old\_freq = 800Mhz
old\_opp = \_find\_freq\_ceil(opp\_table, &old\_freq); #(old\_freq is modified!)
old\_freq = 1GHz
Fixes: 6a0712f6f199 ("PM / OPP: Add dev\_pm\_opp\_set\_rate()")
Cc: 4.6+  # v4.6+
Signed-off-by: Waldemar Rymarkiewicz
Signed-off-by: Viresh Kumar
Signed-off-by: Greg Kroah-Hartman
commit f6639146359505d646b0f38fcaa6f2dfab8d0886
Author: Rafael J. Wysocki
Date: Thu Jun 14 10:01:52 2018 +0200
PM / core: Fix supplier device runtime PM usage counter imbalance
commit 47e5abfb546a3ace23a77453dc2e9db92704c5ac upstream.
If a device link is added via device\_link\_add() by the driver of the
link's consumer device, the supplier's runtime PM usage counter is
going to be dropped by the pm\_runtime\_put\_suppliers() call in
driver\_probe\_device(). However, in that case it is not incremented
unless the supplier driver is already present and the link is not
stateless. That leads to a runtime PM usage counter imbalance for
the supplier device in a few cases.
To prevent that from happening, bump up the supplier runtime
PM usage counter in device\_link\_add() for all links with the
DL\_FLAG\_PM\_RUNTIME flag set that are added at the consumer probe
time. Use pm\_runtime\_get\_noresume() for that as the callers of
device\_link\_add() who want the supplier to be resumed by it are
expected to pass DL\_FLAG\_RPM\_ACTIVE in flags to it anyway, but
additionally resume the supplier if the link is added during
consumer driver probe to retain the existing behavior for the
callers depending on it.
Fixes: 21d5c57b3726 (PM / runtime: Use device links)
Reported-by: Ulf Hansson
Reviewed-by: Ulf Hansson
Tested-by: Marek Szyprowski
Cc: 4.10+  # 4.10+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit f6826af90f30b6f113ff897c6d645950a903bae2
Author: Rafael J. Wysocki
Date: Wed Jun 13 13:17:26 2018 +0200
ACPI / LPSS: Avoid PM quirks on suspend and resume from S3
commit a09c591306881dfb04387c6ee7b7e2e4683fa531 upstream.
It is reported that commit a192aa923b66a (ACPI / LPSS: Consolidate
runtime PM and system sleep handling) introduced a system suspend
regression on some machines, but the only functional change made by
it was to cause the PM quirks in the LPSS to also be used during
system suspend and resume. While that should always work for
suspend-to-idle, it turns out to be problematic for S3
(suspend-to-RAM).
To address that issue restore the previous S3 suspend and resume
behavior of the LPSS to avoid applying PM quirks then.
Fixes: a192aa923b66a (ACPI / LPSS: Consolidate runtime PM and system sleep handling)
Link: https://bugs.launchpad.net/bugs/1774950
Reported-by: Kai-Heng Feng
Tested-by: Kai-Heng Feng
Signed-off-by: Rafael J. Wysocki
Reviewed-by: Ulf Hansson
Reviewed-by: Andy Shevchenko
Acked-by: Mika Westerberg
Cc: 4.15+  # 4.15+
Signed-off-by: Greg Kroah-Hartman
commit 5d647d72e2893e14f52f8b6f5568f775d08f9c4e
Author: Rafael J. Wysocki
Date: Fri May 18 10:17:42 2018 +0200
PCI / PM: Do not clear state\_saved for devices that remain suspended
commit 656088aa9b513907833ba091d0dcde87571fe05b upstream.
The state\_saved flag should not be cleared in pci\_pm\_suspend() if the
given device is going to remain suspended, or the device's config
space will not be restored properly during the subsequent resume.
Namely, if the device is going to stay in suspend, both the late
and noirq callbacks return early for it, so if its state\_saved flag
is cleared in pci\_pm\_suspend(), it will remain unset throughout the
remaining part of suspend and resume and pci\_restore\_state() called
for the device going forward will return without doing anything.
For this reason, change pci\_pm\_suspend() to only clear state\_saved
if the given device is not going to remain suspended. [This is
analogous to what commit ae860a19f37c (PCI / PM: Do not clear
state\_saved in pci\_pm\_freeze() when smart suspend is set) did for
hibernation.]
Fixes: c4b65157aeef (PCI / PM: Take SMART\_SUSPEND driver flag into account)
Cc: 4.15+  # 4.15+
Signed-off-by: Rafael J. Wysocki
Reviewed-by: Mika Westerberg
Acked-by: Bjorn Helgaas
Signed-off-by: Greg Kroah-Hartman
commit d3d6cde518fe6bf560be2eb100e803319b9053b7
Author: Ulf Hansson
Date: Thu Apr 26 10:53:00 2018 +0200
PM / Domains: Fix error path during attach in genpd
commit 72038df3c580c4c326b83c86149d7ac34007532a upstream.
In case the PM domain fails to be powered on in genpd\_dev\_pm\_attach(), it
returns -EPROBE\_DEFER, but keeping the device attached to its PM domain.
This leads to problems when the next attempt to attach is re-tried. More
precisely, in that situation an -EEXIST error code is returned, because the
device already has its PM domain pointer assigned, from the first attempt.
Now, because of the sloppy error handling by the existing callers of
dev\_pm\_domain\_attach(), probing is allowed to continue when -EEXIST is
returned. However, in such case there are no guarantees that the PM domain
is powered on by genpd, which may lead to hangs when buses/drivers tried to
access their devices.
Let's fix this behaviour, simply by detaching the device when powering on
fails in genpd\_dev\_pm\_attach().
Cc: v4.11+  # v4.11+
Signed-off-by: Ulf Hansson
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 4b4c442c757608e8d7de87a93eab8e79aee0df1a
Author: Eric W. Biederman
Date: Fri Apr 20 09:14:56 2018 -0500
signal/xtensa: Consistenly use SIGBUS in do\_unaligned\_user
commit 7de712ccc096b81d23cc0a941cd9b8cb3956605d upstream.
While working on changing this code to use force\_sig\_fault I
discovered that do\_unaliged\_user is sets si\_signo to SIGBUS and passes
SIGSEGV to force\_sig\_info. Which is just b0rked.
The code is reporting a SIGBUS error so replace the SIGSEGV with SIGBUS.
Cc: Chris Zankel
Cc: Max Filippov
Cc: linux-xtensa@linux-xtensa.org
Cc: stable@vger.kernel.org
Acked-by: Max Filippov
Fixes: 5a0015d62668 ("[PATCH] xtensa: Architecture support for Tensilica Xtensa Part 3")
Signed-off-by: "Eric W. Biederman"
Signed-off-by: Greg Kroah-Hartman
commit ed99259924e51eb3fb21f348de046f5095939f34
Author: Daniel Wagner
Date: Tue May 8 10:55:09 2018 +0200
serial: sh-sci: Use spin\_{try}lock\_irqsave instead of open coding version
commit 8afb1d2c12163f77777f84616a8e9444d0050ebe upstream.
Commit 40f70c03e33a ("serial: sh-sci: add locking to console write
function to avoid SMP lockup") copied the strategy to avoid locking
problems in conjuncture with the console from the UART8250
driver. Instead using directly spin\_{try}lock\_irqsave(),
local\_irq\_save() followed by spin\_{try}lock() was used. While this is
correct on mainline, for -rt it is a problem. spin\_{try}lock() will
check if it is running in a valid context. Since the local\_irq\_save()
has already been executed, the context has changed and
spin\_{try}lock() will complain. The reason why spin\_{try}lock()
complains is that on -rt the spin locks are turned into mutexes and
therefore can sleep. Sleeping with interrupts disabled is not valid.
BUG: sleeping function called from invalid context at /home/wagi/work/rt/v4.4-cip-rt/kernel/locking/rtmutex.c:995
in\_atomic(): 0, irqs\_disabled(): 128, pid: 778, name: irq/76-eth0
CPU: 0 PID: 778 Comm: irq/76-eth0 Not tainted 4.4.126-test-cip22-rt14-00403-gcd03665c8318 #12
Hardware name: Generic RZ/G1 (Flattened Device Tree)
Backtrace:
[] (dump\_backtrace) from [] (show\_stack+0x18/0x1c)
r7:c06b01f0 r6:60010193 r5:00000000 r4:c06b01f0
[] (show\_stack) from [] (dump\_stack+0x78/0x94)
[] (dump\_stack) from [] (\_\_\_might\_sleep+0x134/0x194)
r7:60010113 r6:c06d3559 r5:00000000 r4:ffffe000
[] (\_\_\_might\_sleep) from [] (rt\_spin\_lock+0x20/0x74)
r5:c06f4d60 r4:c06f4d60
[] (rt\_spin\_lock) from [] (serial\_console\_write+0x100/0x118)
r5:c06f4d60 r4:c06f4d60
[] (serial\_console\_write) from [] (call\_console\_drivers.constprop.15+0x10c/0x124)
r10:c06d2894 r9:c04e18b0 r8:00000028 r7:00000000 r6:c06d3559 r5:c06d2798
r4:c06b9914 r3:c02576e4
[] (call\_console\_drivers.constprop.15) from [] (console\_unlock+0x32c/0x430)
r10:c06d30d8 r9:00000028 r8:c06dd518 r7:00000005 r6:00000000 r5:c06d2798
r4:c06d2798 r3:00000028
[] (console\_unlock) from [] (vprintk\_emit+0x394/0x4f0)
r10:c06d2798 r9:c06d30ee r8:00000006 r7:00000005 r6:c06a78fc r5:00000027
r4:00000003
[] (vprintk\_emit) from [] (vprintk+0x28/0x30)
r10:c060bd46 r9:00001000 r8:c06b9a90 r7:c06b9a90 r6:c06b994c r5:c06b9a3c
r4:c0062fa8
[] (vprintk) from [] (vprintk\_default+0x10/0x14)
[] (vprintk\_default) from [] (printk+0x78/0x84)
[] (printk) from [] (credit\_entropy\_bits+0x17c/0x2cc)
r3:00000001 r2:decade60 r1:c061a5ee r0:c061a523
r4:00000006
[] (credit\_entropy\_bits) from [] (add\_interrupt\_randomness+0x160/0x178)
r10:466e7196 r9:1f536000 r8:fffeef74 r7:00000000 r6:c06b9a60 r5:c06b9a3c
r4:dfbcf680
[] (add\_interrupt\_randomness) from [] (irq\_thread+0x1e8/0x248)
r10:c006537c r9:c06cdf21 r8:c0064fcc r7:df791c24 r6:df791c00 r5:ffffe000
r4:df525180
[] (irq\_thread) from [] (kthread+0x108/0x11c)
r10:00000000 r9:00000000 r8:c0065184 r7:df791c00 r6:00000000 r5:df791d00
r4:decac000
[] (kthread) from [] (ret\_from\_fork+0x14/0x3c)
r8:00000000 r7:00000000 r6:00000000 r5:c003fa9c r4:df791d00
Cc: Sebastian Andrzej Siewior
Signed-off-by: Daniel Wagner
Reviewed-by: Geert Uytterhoeven
Signed-off-by: Greg Kroah-Hartman
commit 4335787184afe4cd4b6c9916eab520788772fd50
Author: Mika Westerberg
Date: Mon Feb 5 14:32:59 2018 +0300
mtd: spi-nor: intel-spi: Fix atomic sequence handling
commit c7d6a82d90e193b1e4daba957e3908f26306d491 upstream.
On many older systems using SW sequencer the PREOP\_OPTYPE register
contains two preopcodes as following:
PREOP\_OPTYPE=0xf2785006
The last two bytes are the opcodes decoded to:
0x50 - Write enable for volatile status register
0x06 - Write enable
The former is used to modify volatile bits in the status register. For
non-volatile bits the latter is needed. Preopcodes are used in SW
sequencer to send one command "atomically" without anything else
interfering the transfer. The sequence that gets executed is:
- Send preopcode (write enable) from PREOP\_OPTYPE register
- Send the actual SPI command
- Poll busy bit in the status register (0x05, RDSR)
Commit 8c473dd61bb5 ("spi-nor: intel-spi: Don't assume OPMENU0/1 to be
programmed by BIOS") enabled atomic sequence handling but because both
preopcodes are programmed, the following happens:
if (preop >> 8)
val |= SSFSTS\_CTL\_SPOP;
Since on these systems preop >> 8 == 0x50 we end up picking volatile
write enable instead. Because of this the actual write command is pretty
much NOP unless there is a WREN latched in the chip already.
Furthermore we should not really just assume that WREN was issued in
previous call to intel\_spi\_write\_reg() because that might not be the
case.
This updates driver to first check that the opcode is actually available
in PREOP\_OPTYPE register and if not return error back to the spi-nor
core (if the controller is not locked we program it now). In addition we
save the opcode to ispi->atomic\_preopcode field which is checked in next
call to intel\_spi\_sw\_cycle() to actually enable atomic sequence using
the requested preopcode.
Fixes: 8c473dd61bb5 ("spi-nor: intel-spi: Don't assume OPMENU0/1 to be programmed by BIOS")
Signed-off-by: Mika Westerberg
Cc: stable@vger.kernel.org
Reviewed-by: Marek Vasut
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit bfef6597752eb8f7b14c2c464121f0085ce80057
Author: Guenter Roeck
Date: Sun Apr 29 09:16:45 2018 -0700
hwmon: (k10temp) Add support for Stoney Ridge and Bristol Ridge CPUs
commit ccaf63b4d6eaf3447037cefbb0b1038fa80c6639 upstream.
Add support for Stoney Ridge and Bristol Ridge (Family 15h Model 0x70)
CPUs. Registers match those of Family 15h Model 0x60.
Cc: stable@vger.kernel.org # v4.16+
Tested-by: Gabriel Craciunescu
Signed-off-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit bfc36279c0b1a4a83953f9909fabfa9498bb6779
Author: Dmitry Torokhov
Date: Tue May 22 16:08:41 2018 -0700
platform/chrome: cros\_ec\_lpc: do not try DMI match when ACPI device found
commit b410b1226620b6c959f1e9c87529acd058e90caf upstream.
Older models of Chromebooks did not describe the LPC EC in their ACPI
tables; starting with Strago-based devices Google is using GOOG0004 device
to describe EC LPC.
DMI-based match is fragile and does not work reliably, especially when
using custom firmware. It is also not needed when we can locate the right
ACPI device, so let's stop bailing out when DMI does not match but the
right ACPI device is present.
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Benson Leung
Signed-off-by: Greg Kroah-Hartman
commit b0b94616ae3203f68d4a859cffdc0e5444374a45
Author: Finn Thain
Date: Wed Apr 11 20:50:14 2018 -0400
m68k/mac: Fix SWIM memory resource end address
commit 3e2816c1078eb2b5a3276eb83d4da156b3e2d04f upstream.
The resource size is 0x2000 == end - start + 1.
Therefore end == start + 0x2000 - 1.
Cc: Laurent Vivier
Cc: stable@vger.kernel.org # v4.14+
Tested-by: Stan Johnson
Signed-off-by: Finn Thain
Acked-by: Laurent Vivier
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Greg Kroah-Hartman
commit 9ff6f230f86dff6a5095064340d07d5ee271aa50
Author: Michael Schmitz
Date: Mon May 14 23:10:53 2018 +1200
m68k/mm: Adjust VM area to be unmapped by gap size for \_\_iounmap()
commit 3f90f9ef2dda316d64e420d5d51ba369587ccc55 upstream.
If 020/030 support is enabled, get\_io\_area() leaves an IO\_SIZE gap
between mappings which is added to the vm\_struct representing the
mapping. \_\_ioremap() uses the actual requested size (after alignment),
while \_\_iounmap() is passed the size from the vm\_struct.
On 020/030, early termination descriptors are used to set up mappings of
extent 'size', which are validated on unmapping. The unmapped gap of
size IO\_SIZE defeats the sanity check of the pmd tables, causing
\_\_iounmap() to loop forever on 030.
On 040/060, unmapping of page table entries does not check for a valid
mapping, so the umapping loop always completes there.
Adjust size to be unmapped by the gap that had been added in the
vm\_struct prior.
This fixes the hang in atari\_platform\_init() reported a long time ago,
and a similar one reported by Finn recently (addressed by removing
ioremap() use from the SWIM driver.
Tested on my Falcon in 030 mode - untested but should work the same on
040/060 (the extra page tables cleared there would never have been set
up anyway).
Signed-off-by: Michael Schmitz
[geert: Minor commit description improvements]
[geert: This was fixed in 2.4.23, but not in 2.5.x]
Signed-off-by: Geert Uytterhoeven
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 872712718f6384f74ae5538f1e92fe8226465052
Author: Siarhei Liakh
Date: Thu Jun 14 19:36:07 2018 +0000
x86: Call fixup\_exception() before notify\_die() in math\_error()
commit 3ae6295ccb7cf6d344908209701badbbbb503e40 upstream.
fpu\_\_drop() has an explicit fwait which under some conditions can trigger a
fixable FPU exception while in kernel. Thus, we should attempt to fixup the
exception first, and only call notify\_die() if the fixup failed just like
in do\_general\_protection(). The original call sequence incorrectly triggers
KDB entry on debug kernels under particular FPU-intensive workloads.
Andy noted, that this makes the whole conditional irq enable thing even
more inconsistent, but fixing that it outside the scope of this.
Signed-off-by: Siarhei Liakh
Signed-off-by: Thomas Gleixner
Reviewed-by: Andy Lutomirski
Cc: "H. Peter Anvin"
Cc: "Borislav Petkov"
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/DM5PR11MB201156F1CAB2592B07C79A03B17D0@DM5PR11MB2011.namprd11.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 587bb245cddf210445fc132915b72e83a8e3308e
Author: Borislav Petkov
Date: Fri Jun 22 11:54:28 2018 +0200
x86/mce: Do not overwrite MCi\_STATUS in mce\_no\_way\_out()
commit 1f74c8a64798e2c488f86efc97e308b85fb7d7aa upstream.
mce\_no\_way\_out() does a quick check during #MC to see whether some of
the MCEs logged would require the kernel to panic immediately. And it
passes a struct mce where MCi\_STATUS gets written.
However, after having saved a valid status value, the next iteration
of the loop which goes over the MCA banks on the CPU, overwrites the
valid status value because we're using struct mce as storage instead of
a temporary variable.
Which leads to MCE records with an empty status value:
mce: [Hardware Error]: CPU 0: Machine Check Exception: 6 Bank 0: 0000000000000000
mce: [Hardware Error]: RIP 10: {trigger\_mce+0x7/0x10}
In order to prevent the loss of the status register value, return
immediately when severity is a panic one so that we can panic
immediately with the first fatal MCE logged. This is also the intention
of this function and not to noodle over the banks while a fatal MCE is
already logged.
Tony: read the rest of the MCA bank to populate the struct mce fully.
Suggested-by: Tony Luck
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Cc:
Link: https://lkml.kernel.org/r/20180622095428.626-8-bp@alien8.de
Signed-off-by: Greg Kroah-Hartman
commit d819beffd3d1cfd29fbed6727a999be50775883f
Author: Tony Luck
Date: Fri Jun 22 11:54:23 2018 +0200
x86/mce: Fix incorrect "Machine check from unknown source" message
commit 40c36e2741d7fe1e66d6ec55477ba5fd19c9c5d2 upstream.
Some injection testing resulted in the following console log:
mce: [Hardware Error]: CPU 22: Machine Check Exception: f Bank 1: bd80000000100134
mce: [Hardware Error]: RIP 10: {pmem\_do\_bvec+0x11d/0x330 [nd\_pmem]}
mce: [Hardware Error]: TSC c51a63035d52 ADDR 3234bc4000 MISC 88
mce: [Hardware Error]: PROCESSOR 0:50654 TIME 1526502199 SOCKET 0 APIC 38 microcode 2000043
mce: [Hardware Error]: Run the above through 'mcelog --ascii'
Kernel panic - not syncing: Machine check from unknown source
This confused everybody because the first line quite clearly shows
that we found a logged error in "Bank 1", while the last line says
"unknown source".
The problem is that the Linux code doesn't do the right thing
for a local machine check that results in a fatal error.
It turns out that we know very early in the handler whether the
machine check is fatal. The call to mce\_no\_way\_out() has checked
all the banks for the CPU that took the local machine check. If
it says we must crash, we can do so right away with the right
messages.
We do scan all the banks again. This means that we might initially
not see a problem, but during the second scan find something fatal.
If this happens we print a slightly different message (so I can
see if it actually every happens).
[ bp: Remove unneeded severity assignment. ]
Signed-off-by: Tony Luck
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Cc: Ashok Raj
Cc: Dan Williams
Cc: Qiuxu Zhuo
Cc: linux-edac
Cc: stable@vger.kernel.org # 4.2
Link: http://lkml.kernel.org/r/52e049a497e86fd0b71c529651def8871c804df0.1527283897.git.tony.luck@intel.com
Signed-off-by: Greg Kroah-Hartman
commit 293e1d1a3152058772a498355bb938654534148d
Author: Tony Luck
Date: Fri May 25 14:42:09 2018 -0700
x86/mce: Check for alternate indication of machine check recovery on Skylake
commit 4c5717da1d021cf368eabb3cb1adcaead56c0d1e upstream.
Currently we just check the "CAPID0" register to see whether the CPU
can recover from machine checks.
But there are also some special SKUs which do not have all advanced
RAS features, but do enable machine check recovery for use with NVDIMMs.
Add a check for any of bits {8:5} in the "CAPID5" register (each
reports some NVDIMM mode available, if any of them are set, then
the system supports memory machine check recovery).
Signed-off-by: Tony Luck
Signed-off-by: Thomas Gleixner
Cc: Qiuxu Zhuo
Cc: Ashok Raj
Cc: stable@vger.kernel.org # 4.9
Cc: Dan Williams
Cc: Borislav Petkov
Link: https://lkml.kernel.org/r/03cbed6e99ddafb51c2eadf9a3b7c8d7a0cc204e.1527283897.git.tony.luck@intel.com
Signed-off-by: Greg Kroah-Hartman
commit f03fdc44f3ec2507163d1b41ec5a46b5f4537fe1
Author: Tony Luck
Date: Fri May 25 14:41:39 2018 -0700
x86/mce: Improve error message when kernel cannot recover
commit c7d606f560e4c698884697fef503e4abacdd8c25 upstream.
Since we added support to add recovery from some errors inside the kernel in:
commit b2f9d678e28c ("x86/mce: Check for faults tagged in EXTABLE\_CLASS\_FAULT exception table entries")
we have done a less than stellar job at reporting the cause of recoverable
machine checks that occur in other parts of the kernel. The user just gets
the unhelpful message:
mce: [Hardware Error]: Machine check: Action required: unknown MCACOD
doubly unhelpful when they check the manual for the reported IA32\_MSR\_STATUS.MCACOD
and see that it is listed as one of the standard recoverable values.
Add an extra rule to the MCE severity table to catch this case and report it
as:
mce: [Hardware Error]: Machine check: Data load in unrecoverable area of kernel
Fixes: b2f9d678e28c ("x86/mce: Check for faults tagged in EXTABLE\_CLASS\_FAULT exception table entries")
Signed-off-by: Tony Luck
Signed-off-by: Thomas Gleixner
Cc: Qiuxu Zhuo
Cc: Ashok Raj
Cc: stable@vger.kernel.org # 4.6+
Cc: Dan Williams
Cc: Borislav Petkov
Link: https://lkml.kernel.org/r/4cc7c465150a9a48b8b9f45d0b840278e77eb9b5.1527283897.git.tony.luck@intel.com
Signed-off-by: Greg Kroah-Hartman
commit d8e7492ccbc89e7a3a0652aac2206042344bab0d
Author: mike.travis@hpe.com
Date: Thu May 24 15:17:14 2018 -0500
x86/platform/UV: Add kernel parameter to set memory block size
commit d7609f4210cb716c11abfe2bfb5997191095d00b upstream.
Add a kernel parameter that allows setting UV memory block size. This
is to provide an adjustment for new forms of PMEM and other DIMM memory
that might require alignment restrictions other than scanning the global
address table for the required minimum alignment. The value set will be
further adjusted by both the GAM range table scan as well as restrictions
imposed by set\_memory\_block\_size\_order().
Signed-off-by: Mike Travis
Reviewed-by: Andrew Banman
Cc: Andrew Morton
Cc: Dimitri Sivanich
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Russ Anderson
Cc: Thomas Gleixner
Cc: dan.j.williams@intel.com
Cc: jgross@suse.com
Cc: kirill.shutemov@linux.intel.com
Cc: mhocko@suse.com
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/lkml/20180524201711.854849120@stormcage.americas.sgi.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 0f810a6393274b22b945f9488a2f1c3e2bc230be
Author: mike.travis@hpe.com
Date: Thu May 24 15:17:13 2018 -0500
x86/platform/UV: Use new set memory block size function
commit bbbd2b51a2aa0d76b3676271e216cf3647773397 upstream.
Add a call to the new function to "adjust" the current fixed UV memory
block size of 2GB so it can be changed to a different physical boundary.
This accommodates changes in the Intel BIOS, and therefore UV BIOS,
which now can align boundaries different than the previous UV standard
of 2GB. It also flags any UV Global Address boundaries from BIOS that
cause a change in the mem block size (boundary).
The current boundary of 2GB has been used on UV since the first system
release in 2009 with Linux 2.6 and has worked fine. But the new NVDIMM
persistent memory modules (PMEM), along with the Intel BIOS changes to
support these modules caused the memory block size boundary to be set
to a lower limit. Intel only guarantees that this minimum boundary at
64MB though the current Linux limit is 128MB.
Note that the default remains 2GB if no changes occur.
Signed-off-by: Mike Travis
Reviewed-by: Andrew Banman
Cc: Andrew Morton
Cc: Dimitri Sivanich
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Russ Anderson
Cc: Thomas Gleixner
Cc: dan.j.williams@intel.com
Cc: jgross@suse.com
Cc: kirill.shutemov@linux.intel.com
Cc: mhocko@suse.com
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/lkml/20180524201711.732785782@stormcage.americas.sgi.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 08129e03840bcced45c0ff0cf5cb6589cae13cf5
Author: mike.travis@hpe.com
Date: Thu May 24 15:17:12 2018 -0500
x86/platform/UV: Add adjustable set memory block size function
commit f642fb5864a6e3645edce6f85ffe7b44d5e9b990 upstream.
Add a new function to "adjust" the current fixed UV memory block size
of 2GB so it can be changed to a different physical boundary. This is
out of necessity so arch dependent code can accommodate specific BIOS
requirements which can align these new PMEM modules at less than the
default boundaries.
A "set order" type of function was used to insure that the memory block
size will be a power of two value without requiring a validity check.
64GB was chosen as the upper limit for memory block size values to
accommodate upcoming 4PB systems which have 6 more bits of physical
address space (46 becoming 52).
Signed-off-by: Mike Travis
Reviewed-by: Andrew Banman
Cc: Andrew Morton
Cc: Dimitri Sivanich
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Russ Anderson
Cc: Thomas Gleixner
Cc: dan.j.williams@intel.com
Cc: jgross@suse.com
Cc: kirill.shutemov@linux.intel.com
Cc: mhocko@suse.com
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/lkml/20180524201711.609546602@stormcage.americas.sgi.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 4143a919a2d15fa18e982455f9bb25c43b6ca658
Author: Juergen Gross
Date: Thu Jun 21 10:43:31 2018 +0200
x86/xen: Add call of speculative\_store\_bypass\_ht\_init() to PV paths
commit 74899d92e66663dc7671a8017b3146dcd4735f3b upstream.
Commit:
1f50ddb4f418 ("x86/speculation: Handle HT correctly on AMD")
... added speculative\_store\_bypass\_ht\_init() to the per-CPU initialization sequence.
speculative\_store\_bypass\_ht\_init() needs to be called on each CPU for
PV guests, too.
Reported-by: Brian Woods
Tested-by: Brian Woods
Signed-off-by: Juergen Gross
Cc:
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: boris.ostrovsky@oracle.com
Cc: xen-devel@lists.xenproject.org
Fixes: 1f50ddb4f4189243c05926b842dc1a0332195f31 ("x86/speculation: Handle HT correctly on AMD")
Link: https://lore.kernel.org/lkml/20180621084331.21228-1-jgross@suse.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit cc4549f933108bca5779eb2c109af12b07429ffb
Author: Dan Williams
Date: Thu Jun 7 09:13:48 2018 -0700
x86/spectre\_v1: Disable compiler optimizations over array\_index\_mask\_nospec()
commit eab6870fee877258122a042bfd99ee7908c40280 upstream.
Mark Rutland noticed that GCC optimization passes have the potential to elide
necessary invocations of the array\_index\_mask\_nospec() instruction sequence,
so mark the asm() volatile.
Mark explains:
"The volatile will inhibit \*some\* cases where the compiler could lift the
array\_index\_nospec() call out of a branch, e.g. where there are multiple
invocations of array\_index\_nospec() with the same arguments:
if (idx < foo) {
idx1 = array\_idx\_nospec(idx, foo)
do\_something(idx1);
}
< some other code >
if (idx < foo) {
idx2 = array\_idx\_nospec(idx, foo);
do\_something\_else(idx2);
}
... since the compiler can determine that the two invocations yield the same
result, and reuse the first result (likely the same register as idx was in
originally) for the second branch, effectively re-writing the above as:
if (idx < foo) {
idx = array\_idx\_nospec(idx, foo);
do\_something(idx);
}
< some other code >
if (idx < foo) {
do\_something\_else(idx);
}
... if we don't take the first branch, then speculatively take the second, we
lose the nospec protection.
There's more info on volatile asm in the GCC docs:
https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Volatile
"
Reported-by: Mark Rutland
Signed-off-by: Dan Williams
Acked-by: Mark Rutland
Acked-by: Thomas Gleixner
Acked-by: Linus Torvalds
Cc:
Cc: Peter Zijlstra
Fixes: babdde2698d4 ("x86: Implement array\_index\_mask\_nospec")
Link: https://lkml.kernel.org/lkml/152838798950.14521.4893346294059739135.stgit@dwillia2-desk3.amr.corp.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman

