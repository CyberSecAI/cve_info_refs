=== Content from blog.0patch.com_b76801f9_20250125_160958.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Friday, August 31, 2018

Posted by

[Mitja Kolsek](https://draft.blogger.com/profile/00089863558178974677 "author profile")

on

[August 31, 2018](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html "permanent link")

### How We Micropatched a Publicly Dropped 0day in Task Scheduler (CVE-2018-8440)

### Being Who You Are Can be a Bad Thing if You're a System Service

by Mitja Kolsek, the 0patch Team

*[Update 9/11/2018] Official fix for this vulnerability is now available and users are advised to apply Windows Updates, which will automatically result in our micropatch not getting applied any more. You're welcome to read about our [comparison between our micropatch and Microsoft's official fix](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html).*

Earlier this week security researcher [SandboxEscaper](https://twitter.com/SandboxEscaper) published details and proof-of-concept (POC) for a "0day" local privilege escalation vulnerability in Windows Task Scheduler service, which allows a local unprivileged user to change permissions of any file on the system - and thus subsequently replace or modify that file.

As the researcher's POC demonstrates, one can use this vulnerability to replace a system executable file and wait for a privileged process to execute it. In particular, it was shown that a printing-related DLL could be replaced and then executed by triggering the Print Spooler Service to load it. (The latter being a legitimate system operation, only used for demonstrating how replacing a system executable leads to elevated privileges. One could alternatively replace one of a large number of other system executables, or perhaps even a configuration file that gets loaded by a privileged process.)

[SandboxEscaper's documentation](https://github.com/SandboxEscaper/randomrepo/blob/master/PoC-LPE.rar) properly identifies the problem being in Task Scheduler's [SchRpcSetSecurity](https://msdn.microsoft.com/en-us/library/cc248452.aspx) method, which is externally accessible via [Advanced Local Procedure Call (ALPC)](https://en.wikipedia.org/wiki/Local_Procedure_Call) facility. This method, which can be called by any local process, sets a desired security descriptor (sddl) on a task or folder, i.e., on a provided file path (path).

```
HRESULT SchRpcSetSecurity(
   [in, string] const wchar_t* path,
   [in, string] const wchar_t* sddl,
   [in] DWORD flags
 );
```

SandboxEscaper noticed that this method fails to *impersonate* the requesting client when setting the security descriptor, which results in Task Scheduler changing the access control list of the chosen file or folder as Local System user even if the user calling this method is a low-privileged user. Impersonation is a feature where, to put it simply, a process running as user A gets a request for some action from user B and performs this action disguised as user B, borrowing user B's permissions for that. Task Scheduler is such a process running as user Local System, and when some other user calls its SchRpcSetSecurity method, it should impersonate the caller to perform the file operation using their identity - but apparently it doesn't, and uses its own powerful permissions to do so.

What the POC does to demonstrate this issue is:

1. create an UpdateTask.job file in folder %SystemRoot%\Tasks where any user is allowed to create files (this is needed in the process of creating a new scheduled task, and non-admin users are allowed to do that); however, this file is not an ordinary file but rather a *[hard link](https://docs.microsoft.com/en-us/windows/desktop/fileio/hard-links-and-junctions)* pointing to a system file PrintConfig.dll. (which non-system user can't modify or replace);
2. call Task Scheduler's SchRpcSetSecurity method to change permissions on UpdateTask.job such that everyone will be able to modify it; this actually changes permissions of the linked-to PrintConfig.dll file, which thus becomes user-modifiable;
3. replace PrintConfig.dll with a "malicious" DLL that simply launched Notepad;
4. trigger the Print Spooler service to load and execute the modified PrintConfig.dll using its own Local System identity.

## Vulnerability Analysis

The problem is clearly in step #2, which allows a non-admin user to change permissions on a system executable, and one can quickly assess the root cause of the problem to be a combination of two facts:

1. Task Scheduler doesn't impersonate the caller in SchRpcSetSecurity method when performing the SetSecurityFile file system operation, and
2. Task Scheduler being willing to perform SchRpcSetSecurity on a hard link.

After running the POC, we took a look at operations performed on UpdateTask.job with Process Monitor, and found the one that changes permissions:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7tcK2fDK4Hws2D0yRmUPumdmsZPSoXqUH2hKLEnzhs8uPWB0cXeK21w6AM3ecqX0GkWzdcgZMoVXDVLVfeSdViaqrjCe4GZ5MA6SoPiQLuNMjly1a6dMVx0A7pBubCcCE3E8ULckBQyMN/s640/SetSecurityFile.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7tcK2fDK4Hws2D0yRmUPumdmsZPSoXqUH2hKLEnzhs8uPWB0cXeK21w6AM3ecqX0GkWzdcgZMoVXDVLVfeSdViaqrjCe4GZ5MA6SoPiQLuNMjly1a6dMVx0A7pBubCcCE3E8ULckBQyMN/s1600/SetSecurityFile.png)

So we took a look at its call stack to see who invoked this action:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj97_SxzF1mMg9CFr9pUUwjTRtG4hRLvfNFaJDK8uEmykWhTLOaf03GNTDmBPcLvx7wq2EuCzwulwAXD229-U50U9Kdej-2S__WTQLGtasnlpxgxm2OvkPm0eQhG-rCLi9y5RO8Qm24JMcE/s640/SetSecurityFile_callstack.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj97_SxzF1mMg9CFr9pUUwjTRtG4hRLvfNFaJDK8uEmykWhTLOaf03GNTDmBPcLvx7wq2EuCzwulwAXD229-U50U9Kdej-2S__WTQLGtasnlpxgxm2OvkPm0eQhG-rCLi9y5RO8Qm24JMcE/s1600/SetSecurityFile_callstack.png)

Okay, there's schedsvc.dll (Task Scheduler's executable) making a call to taskcomp.dll (Task Scheduler's helper library), which ends up with a call to kernel's NtSetSecurityObject. So we disassembled schedsvc.dll and taskcomp.dll to see what's going on in there at the identified locations. What we found was interesting.

The call from schedsvc.dll to taskcomp.dll occurs in function RpcServer::SetSecurity (in the orange block):

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZkq0Paz4dPFWUKXi2NI8IBePbtTDmmrnISAb2EPQPUWJTLLZzlyZI7hyphenhyphenhBhTtAZ2Z2YQMcx5ftkGVKepxxfmB2FdwZGc7GbEaCD3yjFdjZFDJMztf4T8vsb4FoKj0UnPdfE-J90h46qk0/s640/call1.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZkq0Paz4dPFWUKXi2NI8IBePbtTDmmrnISAb2EPQPUWJTLLZzlyZI7hyphenhyphenhBhTtAZ2Z2YQMcx5ftkGVKepxxfmB2FdwZGc7GbEaCD3yjFdjZFDJMztf4T8vsb4FoKj0UnPdfE-J90h46qk0/s1600/call1.PNG)

We were expecting to see code without any impersonation here, but actually found impersonation being used - just that the call that sets file permissions is done before the impersonation (in the lowest code block) begins.

The plan was clear: let's begin impersonation before the offending call to make sure that said call will be impersonated. So we created a micropatch with a single patchlet containing a call to RpcImpersonateCient and placed it at the beginning of the block preceding the orange block. How about reverting the impersonation? It turns out that wasn't needed because all code execution paths were leading directly to another impersonation call without making any other kernel calls that might be affected by our impersonation.

We tried this micropatch, but the exploit still worked !?! What was going on?

It turned out that there is another permissions-setting call in function RpcServer::SetSecurity, possibly a fallback mechanism in case the first one failed. So we made the first one fail, and the second one came to the rescue - again without impersonation (the middle orange block).

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3UCSuqYBKe8XpqTG8-lgY3wKW07RIKnf1r_fYaTeAybg3ZhsSjoZIWU0_oTuS55s5CwJE_1_-fKMmNJLd8IBtvhlfKVtDIO0JxDTcZAz46JHXBX-v_aCNwkNRmg6lvRY7pUxlzxIC3ie0/s640/call2.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3UCSuqYBKe8XpqTG8-lgY3wKW07RIKnf1r_fYaTeAybg3ZhsSjoZIWU0_oTuS55s5CwJE_1_-fKMmNJLd8IBtvhlfKVtDIO0JxDTcZAz46JHXBX-v_aCNwkNRmg6lvRY7pUxlzxIC3ie0/s1600/call2.PNG)

In this case, we can see a call to RpcRevertToSelf right before the offending call, which means that previous impersonation was reverted too soon to include the said call.

What we did here was remove the premature RpcRevertToSelf call and insert a replacement RpcRevertToSelf call to the code block following the offending call. While this block has many other branches leading to it, we checked that these are not impersonated which means our inserted call won't erroneously prematurely revert some other impersonation.

So finally, our micropatch worked and Process Monitor showed this instead:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2If7ALUTg_tSgliXIXK0ChBAiRVPqaBD-GyPJLIlBtuomXtBhI9neHmlD63qhvbGXttQP0Xvl0rW4g8WBmxk7c_SxlZ0mESdUQmAFWfSOO-N-UQbDhMjzhO7qQV3aVt0J3QfSdjLcEmeM/s640/CreateFile_access_denied.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2If7ALUTg_tSgliXIXK0ChBAiRVPqaBD-GyPJLIlBtuomXtBhI9neHmlD63qhvbGXttQP0Xvl0rW4g8WBmxk7c_SxlZ0mESdUQmAFWfSOO-N-UQbDhMjzhO7qQV3aVt0J3QfSdjLcEmeM/s1600/CreateFile_access_denied.png)

You can see the "Impersonating" line, proving that we have successfully forced Task Scheduler to impersonate the calling user when trying to set permissions on UpdateTask.job. Now, since this file was a hard link to another file which our user had insufficient permissions to modify ACL for, the result was ACCESS DENIED, as it should be.

This is the source code of our micropatch, with all of its 4 instructions in three patchlets:

; Patch for VULN-4051 in schedsvc.dll version 10.0.17134.1 64bit
MODULE\_PATH "..\AffectedModules\schedsvc.dll\_10.0.17134.1\_64bit\schedsvc.dll"
PATCH\_ID 328
PATCH\_FORMAT\_VER 2
VULN\_ID 4051
PLATFORM win64

patchlet\_start
 PATCHLET\_ID 1
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F5CB
 PIT rpcrt4.dll!RpcImpersonateClient
 code\_start
  xor ecx, ecx ; Impersonating the client that made the request
  call PIT\_RpcImpersonateClient
 code\_end
patchlet\_end

patchlet\_start
 PATCHLET\_ID 2
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F81E
 JUMPOVERBYTES 6 ; We eliminate the 6-byte call to RevertToSelf
 code\_start
  nop
 code\_end
patchlet\_end

patchlet\_start
 PATCHLET\_ID 3
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F844
 PIT rpcrt4.dll!RpcRevertToSelf
 code\_start
  call PIT\_RpcRevertToSelf
 code\_end
patchlet\_end

## Micropatch In Action

This video shows our micropatch in action.

## Frequently Asked Questions

*Q: Which Windows versions does this micropatch apply to?*

Currently we have instances of this micropatch applying to:

1. fully updated 64bit Windows 7 [added on 9/6]
2. fully updated 64bit Windows Server 2008 [added on 9/6]
3. fully updated 64bit Windows 10 version 1607 [added on 9/4]
4. fully updated 64bit Windows 10 version 1709 [added on 9/5]
5. fully updated 64bit Windows 10 version 1803
6. fully updated 64bit Windows Server 2016
7. fully updated 64bit Windows Server 1803 [added on 9/6]

[Update 9/6/2018] Big thanks to [Will Dormann](https://twitter.com/wdormann) for confirming the
vulnerability as well as effectiveness of our micropatch on Windows
Server 1803 in a real-time Twitter DM session!

We can quickly port the micropatch to other affected versions but we'll only do that on request (support@0patch.com). As far as we know at this point, the vulnerability was confirmed to also be present and exploitable on [32bit Windows 10](https://twitter.com/wdormann/status/1034554597908664320) and [32bit Windows 7](https://twitter.com/wdormann/status/1034948211579015168), so it's safe to assume that at least all Windows versions from Windows 7 and Windows Server 2008 are likely affected.

*Q: Will modifying the exploit allow attackers to bypass this micropatch?*

No, and that's one of the significant advantages of changing the code compared to signature- or behavior- based exploit prevention systems. For instance, while most antivirus products will detect the original POC by now, Will Dormann [modified the POC](https://twitter.com/wdormann/status/1035174336322330624) and showed that it went undetected. Such modifications *always* allow for bypassing detection-based systems, while fixing the code actually removes the vulnerability. There is simply nothing there to bypass. There is *no more efficient and reliable way* to address a vulnerability than to actually remove it. (Although the entire industry built *around* vulnerabilities will try to convince you otherwise.)

*Q: How do weapply this micropatch?*

If you have 0patch Agent already installed, this micropatch is already downloaded and applied so you don't have to do anything. Otherwise, [download](https://dist.0patch.com/download/latestagent) and launch the 0patch Agent installer, [create a free 0patch account](https://dist.0patch.com/User/Register)
and register the agent to that account. You will immediately receive
all micropatches including this one, and it will automatically get applied to Task Scheduler.

*Q: Is this patch functionally identical to how Microsoft will fix it?*

Obviously we can't know that. As we always claim, the original vendor - with their internal knowledge of the product - is best-positioned to correct their own code. Nobody else knows all the possible side effects of a code change as well as they do (granted, with large products even they often don't see everything) and in an ideal world software vendors would be issuing micropatches like this to quickly and painlessly fix vulnerabilities. That said, Microsoft may do the same as we did, but they may also prevent Task Scheduler from changing permissions on hard links. Or they may find that they need to support hard links *and* not impersonating the user is essential for some other operation that Task Scheduler performs - and will make a substantial code change. We often create micropatches after the vendor has issued the official update, which allows us to see what they did and ideally replicate their logic in a micropatch. With a 0day, this is obviously not possible.

You should therefore consider our micropatch a temporary solution while waiting for the official fix.

*Q: What will happen on Patch Tuesday?*

When Microsoft makes their official fix available, you simply apply it as you would if you had never heard of 0patch. Applying it will automatically obsolete this micropatch on your computer as the update will replace a vulnerable executable with a fixed one, thereby changing its cryptographic hash. Since our micropatches are associated with specific hashes, this will make the micropatch inapplicable without intervention on either your end or ours.

*Q: Can we keep using this micropatch instead of applying Microsoft's update?*

**We strongly recommend against that.** Microsoft's update will not only fix this issue in a more informed way, but will also bring fixes for other vulnerabilities that we don't have micropatches for. Yes, we hate losing hours of our lives to updating our systems too, but wouldn't dream of outright replacing official updates with our micropatches ;)

*Q: How can you provide a micropatch so quickly compared to original vendors?*

While having a micropatch candidate ready [24 hours after a 0day was dropped](https://twitter.com/0patch/status/1034577454961176577) is quick relative to today's standards of software patching, a couple of things must be considered:

1. Software vendors know their products much better than we do, and are likely to create a more comprehensive code fix than we can without their knowledge and source code. That takes more time than writing a micropatch.
2. Software vendors bundle numerous fixes together in a "fat update" that replaces entire executables, which requires a lot more testing across the board. We test our micropatches with focused tests targeting only the patched code.
3. "Fat updates" are a huge problem for users and vendors when something goes wrong, which is why software vendors are even more wary of issuing a defective update. Of course a micropatch also can be flawed, but it can be revoked remotely and instantly replaced with a corrected version without users ever noticing anything. That said, we will always have "fat updates" for substantial functional changes, we're just arguing that we may not need them this frequently because most vulnerabilities could be patched with micropatches.
4. Software vendors must issue patches for all supported versions, and extensively test all of them. We currently only have this micropatch for two three four six seven affected Windows versions.
   Nevertheless, porting to other versions, basic testing and deployment would take us about
   two hours of effort for each additional version, so that could still be done in one day.

All that said, comparing our speed with software vendors' must also account for the difference in our deliverables. A micropatch can be quickly created, deployed to all computers in a hour's time and applied without even the slightest disturbance to users. But it must be considered a temporary security measure until the official patch can be applied.

*Q: What should we do if we encounter problems with Task Scheduler after applying this micropatch?*

Obviously we can't guarantee that our micropatch won't cause some unwanted side effects, e.g., with non-admin users editing existing scheduled tasks under certain circumstances. (Then again, software vendors can't guarantee that either.) The rule of thumb for using 0patch (or any other 3rd party behavior-changing product like antivirus or malware blockers) should be to first disable the agent and see if the problem persists, before contacting the original software vendor for the affected product. If the problem persists, the culprit is unlikely to be the micropatch. If the problem goes away, it's probably us and we'd like to hear from you at support@0patch.com.

Fortunately, in contrast to standard "fat update" patching that software products employ today, 0patch allows you to *instantly revert a patch with a click of a button*.

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://draft.blogger.com/post-edit.g?blogID=7114610046316422325&postID=9156776864167622344&from=pencil "Edit Post")

[Email This](https://draft.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=email "Email This")[BlogThis!](https://draft.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=blog "BlogThis!")[Share to X](https://draft.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=twitter "Share to X")[Share to Facebook](https://draft.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=facebook "Share to Facebook")[Share to Pinterest](https://draft.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html "Newer Post")

[Older Post](https://blog.0patch.com/2018/05/0patching-foxit-reader-buffer-oops.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/9156776864167622344/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* ►
  [2025](https://blog.0patch.com/2025/)
  (1)
  + ►
    [January](https://blog.0patch.com/2025/01/)
    (1)

* ►
  [2024](https://blog.0patch.com/2024/)
  (23)
  + ►
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + ►
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + ►
    [January](https://blog.0patch.com/2024/01/)
    (1)

* ►
  [2023](https://blog.0patch.com/2023/)
  (26)
  + ►
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + ►
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + ►
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + ►
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + ►
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2023/01/)
    (2)

* ►
  [2022](https://blog.0patch.com/2022/)
  (26)
  + ►
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + ►
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + ►
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + ►
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + ►
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + ►
    [January](https://blog.0patch.com/2022/01/)
    (1)

* ►
  [2021](https://blog.0patch.com/2021/)
  (23)
  + ►
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + ►
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + ►
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2021/01/)
    (2)

* ►
  [2020](https://blog.0patch.com/2020/)
  (19)
  + ►
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + ►
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + ►
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2020/01/)
    (2)

* ►
  [2019](https://blog.0patch.com/2019/)
  (7)
  + ►
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + ►
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + ►
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + ►
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2019/01/)
    (1)

* ▼
  [2018](https://blog.0patch.com/2018/)
  (11)
  + ►
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + ▼
    [August](https://blog.0patch.com/2018/08/)
    (1)
    - [How We Micropatched a Publicly Dropped 0day in Tas...](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html)
  + ►
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + ►
    [January](https://blog.0patch.com/2018/01/)
    (2)

* ►
  [2017](https://blog.0patch.com/2017/)
  (19)
  + ►
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + ►
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + ►
    [January](https://blog.0patch.com/2017/01/)
    (1)

* ►
  [2016](https://blog.0patch.com/2016/)
  (7)
  + ►
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + ►
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://draft.blogger.com).



=== Content from blog.0patch.com_3ee25477_20250126_101115.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Tuesday, September 11, 2018

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[September 11, 2018](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html "permanent link")

### Comparing Our Micropatch With Microsoft's Official Patch For CVE-2018-8440

by Mitja Kolsek, the 0patch Team

As expected, Windows Update has just brought the official patch for CVE-2018-8440 today, a patch that would replace our ["unofficial" micropatch we've issued 13 days ago](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html).

To quickly refresh your memory, 15 days ago security researcher [SandboxEscaper](https://twitter.com/SandboxEscaper)
published details and proof-of-concept (POC) for a "0day" local
privilege escalation vulnerability in Windows Task Scheduler service,
allowing a local unprivileged user to change permissions of any file
on the system. The next day, we at 0patch have analyzed the vulnerability and prepared a "micropatch candidate" (a micropatch that blocks the POC but needs to be tested for functional side effects). We published the micropatch for Windows 10 version 1803 the day after, and subsequently ported this micropatch to a number of other Windows versions.

Obviously, correcting someone else's code is not to be taken lightly (especially if that code is running on millions of computers), and not having the source code doesn't make it any easier. However, our team of security researchers and the growing community of experts who want to get their vulnerabilities fixed as quickly and efficiently as possible, are doing just that.

In this particular case, our analysis showed that a call for changing permissions of a file, made from Task Scheduler's code, should have been impersonated - but it wasn't. We corrected that by making a call to RpcImpersonateClient right before the call, and another call to RpcRevertToSelf right after it. Pretty basic stuff. And it worked.

Our micropatches are sometimes very similar to official patches (at least functionally speaking), and other times very different; not surprisingly, there is always more than one way to skin a cat - or to fix a vulnerability. So when the official patch from Microsoft came out today, we were naturally curious as to how they fixed it.

The first thing we noticed was that the Windows Update replaced schedsvc.dll with a new version. Promising - this is the exact DLL we had micropatched. Next we ran BinDiff to compare the new and the old version. Even more promising - the only modified function was RpcServer::SetSecurity, which is the very function we had micropatched. And finally, BinDiff showed the exact difference between the old and the new version of this function. Let's take a look at that (note: the diff is for 64bit Windows 7).

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhrwhbo46WkicbHhye1nFmyQ0eVzB-XMWBYcQMNUlmAznm816mUGSIeOXzpz75qu1YPVxUROiXdgW8VIneb8mFFUOyjiWzzMA6HSbzbbjXJfFsjcyS0uoUXNLaQTjwXxvvnFHIrkPiZKXWB/s640/Windows+7+official+patch.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhrwhbo46WkicbHhye1nFmyQ0eVzB-XMWBYcQMNUlmAznm816mUGSIeOXzpz75qu1YPVxUROiXdgW8VIneb8mFFUOyjiWzzMA6HSbzbbjXJfFsjcyS0uoUXNLaQTjwXxvvnFHIrkPiZKXWB/s1600/Windows%2B7%2Bofficial%2Bpatch.PNG)

As you can see, Microsoft's official patch is functionally identical to our micropatch. We could say that this official patch delivers Microsoft's unofficial confirmation that our approach to patching this vulnerability - in a complex closed-source product - was also optimal from their perspective. That's very positive feedback for us and a great case for "unofficial" 3rd-party micropatches.

Don't get carried away, however! There have been, and will be cases where a 3rd-party micropatch will fix a vulnerability differently and less well than the official vendor fix - or even break a thing or two. While we're doing our best and leverage our advantages (agility, instant patch deployment, instant patch removal), original product developers will always have advantage in their knowledge about the product and its environment, and their code fixes will be preferred. Nevertheless, our mistakes are much easier to remedy than those delivered in a 300MB package that requires a reboot both to install and uninstall. When a micropatch needs to be revoked, it takes just a few minutes for us to do that, and within an hour all online agents stop applying it without interrupting users in the slightest. And an improved version of the micropatch can later be delivered just as easily.

In any case, if you have installed 0patch Agent to micropatch this vulnerability on your computer(s), it is now time to let the official fix take over. To do that, you simply apply today's Windows Updates and as soon as they replace the vulnerable schedsvc.dll, our micropatch will automatically stop applying because the cryptographic hash of the DLL will no longer match that associated with the micropatch. You don't have to do anything else; this is 0patch being a good citizen and stepping aside when it's no longer your best option.

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=1503701383912738140&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1503701383912738140&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1503701383912738140&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1503701383912738140&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1503701383912738140&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=1503701383912738140&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html "Newer Post")

[Older Post](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/1503701383912738140/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* ►
  [2025](https://blog.0patch.com/2025/)
  (1)
  + ►
    [January](https://blog.0patch.com/2025/01/)
    (1)

* ►
  [2024](https://blog.0patch.com/2024/)
  (23)
  + ►
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + ►
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + ►
    [January](https://blog.0patch.com/2024/01/)
    (1)

* ►
  [2023](https://blog.0patch.com/2023/)
  (26)
  + ►
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + ►
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + ►
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + ►
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + ►
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2023/01/)
    (2)

* ►
  [2022](https://blog.0patch.com/2022/)
  (26)
  + ►
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + ►
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + ►
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + ►
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + ►
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + ►
    [January](https://blog.0patch.com/2022/01/)
    (1)

* ►
  [2021](https://blog.0patch.com/2021/)
  (23)
  + ►
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + ►
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + ►
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2021/01/)
    (2)

* ►
  [2020](https://blog.0patch.com/2020/)
  (19)
  + ►
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + ►
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + ►
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2020/01/)
    (2)

* ►
  [2019](https://blog.0patch.com/2019/)
  (7)
  + ►
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + ►
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + ►
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + ►
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2019/01/)
    (1)

* ▼
  [2018](https://blog.0patch.com/2018/)
  (11)
  + ►
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + ▼
    [September](https://blog.0patch.com/2018/09/)
    (2)
    - [Outrunning Attackers On The Jet Database Engine 0d...](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html)
    - [Comparing Our Micropatch With Microsoft's Official...](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html)
  + ►
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + ►
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + ►
    [January](https://blog.0patch.com/2018/01/)
    (2)

* ►
  [2017](https://blog.0patch.com/2017/)
  (19)
  + ►
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + ►
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + ►
    [January](https://blog.0patch.com/2017/01/)
    (1)

* ►
  [2016](https://blog.0patch.com/2016/)
  (7)
  + ►
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + ►
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from blog.0patch.com_b76801f9_20250126_101116.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Friday, August 31, 2018

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[August 31, 2018](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html "permanent link")

### How We Micropatched a Publicly Dropped 0day in Task Scheduler (CVE-2018-8440)

### Being Who You Are Can be a Bad Thing if You're a System Service

by Mitja Kolsek, the 0patch Team

*[Update 9/11/2018] Official fix for this vulnerability is now available and users are advised to apply Windows Updates, which will automatically result in our micropatch not getting applied any more. You're welcome to read about our [comparison between our micropatch and Microsoft's official fix](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html).*

Earlier this week security researcher [SandboxEscaper](https://twitter.com/SandboxEscaper) published details and proof-of-concept (POC) for a "0day" local privilege escalation vulnerability in Windows Task Scheduler service, which allows a local unprivileged user to change permissions of any file on the system - and thus subsequently replace or modify that file.

As the researcher's POC demonstrates, one can use this vulnerability to replace a system executable file and wait for a privileged process to execute it. In particular, it was shown that a printing-related DLL could be replaced and then executed by triggering the Print Spooler Service to load it. (The latter being a legitimate system operation, only used for demonstrating how replacing a system executable leads to elevated privileges. One could alternatively replace one of a large number of other system executables, or perhaps even a configuration file that gets loaded by a privileged process.)

[SandboxEscaper's documentation](https://github.com/SandboxEscaper/randomrepo/blob/master/PoC-LPE.rar) properly identifies the problem being in Task Scheduler's [SchRpcSetSecurity](https://msdn.microsoft.com/en-us/library/cc248452.aspx) method, which is externally accessible via [Advanced Local Procedure Call (ALPC)](https://en.wikipedia.org/wiki/Local_Procedure_Call) facility. This method, which can be called by any local process, sets a desired security descriptor (sddl) on a task or folder, i.e., on a provided file path (path).

```
HRESULT SchRpcSetSecurity(
   [in, string] const wchar_t* path,
   [in, string] const wchar_t* sddl,
   [in] DWORD flags
 );
```

SandboxEscaper noticed that this method fails to *impersonate* the requesting client when setting the security descriptor, which results in Task Scheduler changing the access control list of the chosen file or folder as Local System user even if the user calling this method is a low-privileged user. Impersonation is a feature where, to put it simply, a process running as user A gets a request for some action from user B and performs this action disguised as user B, borrowing user B's permissions for that. Task Scheduler is such a process running as user Local System, and when some other user calls its SchRpcSetSecurity method, it should impersonate the caller to perform the file operation using their identity - but apparently it doesn't, and uses its own powerful permissions to do so.

What the POC does to demonstrate this issue is:

1. create an UpdateTask.job file in folder %SystemRoot%\Tasks where any user is allowed to create files (this is needed in the process of creating a new scheduled task, and non-admin users are allowed to do that); however, this file is not an ordinary file but rather a *[hard link](https://docs.microsoft.com/en-us/windows/desktop/fileio/hard-links-and-junctions)* pointing to a system file PrintConfig.dll. (which non-system user can't modify or replace);
2. call Task Scheduler's SchRpcSetSecurity method to change permissions on UpdateTask.job such that everyone will be able to modify it; this actually changes permissions of the linked-to PrintConfig.dll file, which thus becomes user-modifiable;
3. replace PrintConfig.dll with a "malicious" DLL that simply launched Notepad;
4. trigger the Print Spooler service to load and execute the modified PrintConfig.dll using its own Local System identity.

## Vulnerability Analysis

The problem is clearly in step #2, which allows a non-admin user to change permissions on a system executable, and one can quickly assess the root cause of the problem to be a combination of two facts:

1. Task Scheduler doesn't impersonate the caller in SchRpcSetSecurity method when performing the SetSecurityFile file system operation, and
2. Task Scheduler being willing to perform SchRpcSetSecurity on a hard link.

After running the POC, we took a look at operations performed on UpdateTask.job with Process Monitor, and found the one that changes permissions:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7tcK2fDK4Hws2D0yRmUPumdmsZPSoXqUH2hKLEnzhs8uPWB0cXeK21w6AM3ecqX0GkWzdcgZMoVXDVLVfeSdViaqrjCe4GZ5MA6SoPiQLuNMjly1a6dMVx0A7pBubCcCE3E8ULckBQyMN/s640/SetSecurityFile.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh7tcK2fDK4Hws2D0yRmUPumdmsZPSoXqUH2hKLEnzhs8uPWB0cXeK21w6AM3ecqX0GkWzdcgZMoVXDVLVfeSdViaqrjCe4GZ5MA6SoPiQLuNMjly1a6dMVx0A7pBubCcCE3E8ULckBQyMN/s1600/SetSecurityFile.png)

So we took a look at its call stack to see who invoked this action:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj97_SxzF1mMg9CFr9pUUwjTRtG4hRLvfNFaJDK8uEmykWhTLOaf03GNTDmBPcLvx7wq2EuCzwulwAXD229-U50U9Kdej-2S__WTQLGtasnlpxgxm2OvkPm0eQhG-rCLi9y5RO8Qm24JMcE/s640/SetSecurityFile_callstack.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj97_SxzF1mMg9CFr9pUUwjTRtG4hRLvfNFaJDK8uEmykWhTLOaf03GNTDmBPcLvx7wq2EuCzwulwAXD229-U50U9Kdej-2S__WTQLGtasnlpxgxm2OvkPm0eQhG-rCLi9y5RO8Qm24JMcE/s1600/SetSecurityFile_callstack.png)

Okay, there's schedsvc.dll (Task Scheduler's executable) making a call to taskcomp.dll (Task Scheduler's helper library), which ends up with a call to kernel's NtSetSecurityObject. So we disassembled schedsvc.dll and taskcomp.dll to see what's going on in there at the identified locations. What we found was interesting.

The call from schedsvc.dll to taskcomp.dll occurs in function RpcServer::SetSecurity (in the orange block):

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZkq0Paz4dPFWUKXi2NI8IBePbtTDmmrnISAb2EPQPUWJTLLZzlyZI7hyphenhyphenhBhTtAZ2Z2YQMcx5ftkGVKepxxfmB2FdwZGc7GbEaCD3yjFdjZFDJMztf4T8vsb4FoKj0UnPdfE-J90h46qk0/s640/call1.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhZkq0Paz4dPFWUKXi2NI8IBePbtTDmmrnISAb2EPQPUWJTLLZzlyZI7hyphenhyphenhBhTtAZ2Z2YQMcx5ftkGVKepxxfmB2FdwZGc7GbEaCD3yjFdjZFDJMztf4T8vsb4FoKj0UnPdfE-J90h46qk0/s1600/call1.PNG)

We were expecting to see code without any impersonation here, but actually found impersonation being used - just that the call that sets file permissions is done before the impersonation (in the lowest code block) begins.

The plan was clear: let's begin impersonation before the offending call to make sure that said call will be impersonated. So we created a micropatch with a single patchlet containing a call to RpcImpersonateCient and placed it at the beginning of the block preceding the orange block. How about reverting the impersonation? It turns out that wasn't needed because all code execution paths were leading directly to another impersonation call without making any other kernel calls that might be affected by our impersonation.

We tried this micropatch, but the exploit still worked !?! What was going on?

It turned out that there is another permissions-setting call in function RpcServer::SetSecurity, possibly a fallback mechanism in case the first one failed. So we made the first one fail, and the second one came to the rescue - again without impersonation (the middle orange block).

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3UCSuqYBKe8XpqTG8-lgY3wKW07RIKnf1r_fYaTeAybg3ZhsSjoZIWU0_oTuS55s5CwJE_1_-fKMmNJLd8IBtvhlfKVtDIO0JxDTcZAz46JHXBX-v_aCNwkNRmg6lvRY7pUxlzxIC3ie0/s640/call2.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh3UCSuqYBKe8XpqTG8-lgY3wKW07RIKnf1r_fYaTeAybg3ZhsSjoZIWU0_oTuS55s5CwJE_1_-fKMmNJLd8IBtvhlfKVtDIO0JxDTcZAz46JHXBX-v_aCNwkNRmg6lvRY7pUxlzxIC3ie0/s1600/call2.PNG)

In this case, we can see a call to RpcRevertToSelf right before the offending call, which means that previous impersonation was reverted too soon to include the said call.

What we did here was remove the premature RpcRevertToSelf call and insert a replacement RpcRevertToSelf call to the code block following the offending call. While this block has many other branches leading to it, we checked that these are not impersonated which means our inserted call won't erroneously prematurely revert some other impersonation.

So finally, our micropatch worked and Process Monitor showed this instead:

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2If7ALUTg_tSgliXIXK0ChBAiRVPqaBD-GyPJLIlBtuomXtBhI9neHmlD63qhvbGXttQP0Xvl0rW4g8WBmxk7c_SxlZ0mESdUQmAFWfSOO-N-UQbDhMjzhO7qQV3aVt0J3QfSdjLcEmeM/s640/CreateFile_access_denied.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg2If7ALUTg_tSgliXIXK0ChBAiRVPqaBD-GyPJLIlBtuomXtBhI9neHmlD63qhvbGXttQP0Xvl0rW4g8WBmxk7c_SxlZ0mESdUQmAFWfSOO-N-UQbDhMjzhO7qQV3aVt0J3QfSdjLcEmeM/s1600/CreateFile_access_denied.png)

You can see the "Impersonating" line, proving that we have successfully forced Task Scheduler to impersonate the calling user when trying to set permissions on UpdateTask.job. Now, since this file was a hard link to another file which our user had insufficient permissions to modify ACL for, the result was ACCESS DENIED, as it should be.

This is the source code of our micropatch, with all of its 4 instructions in three patchlets:

; Patch for VULN-4051 in schedsvc.dll version 10.0.17134.1 64bit
MODULE\_PATH "..\AffectedModules\schedsvc.dll\_10.0.17134.1\_64bit\schedsvc.dll"
PATCH\_ID 328
PATCH\_FORMAT\_VER 2
VULN\_ID 4051
PLATFORM win64

patchlet\_start
 PATCHLET\_ID 1
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F5CB
 PIT rpcrt4.dll!RpcImpersonateClient
 code\_start
  xor ecx, ecx ; Impersonating the client that made the request
  call PIT\_RpcImpersonateClient
 code\_end
patchlet\_end

patchlet\_start
 PATCHLET\_ID 2
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F81E
 JUMPOVERBYTES 6 ; We eliminate the 6-byte call to RevertToSelf
 code\_start
  nop
 code\_end
patchlet\_end

patchlet\_start
 PATCHLET\_ID 3
 PATCHLET\_TYPE 2
 PATCHLET\_OFFSET 0x6F844
 PIT rpcrt4.dll!RpcRevertToSelf
 code\_start
  call PIT\_RpcRevertToSelf
 code\_end
patchlet\_end

## Micropatch In Action

This video shows our micropatch in action.

## Frequently Asked Questions

*Q: Which Windows versions does this micropatch apply to?*

Currently we have instances of this micropatch applying to:

1. fully updated 64bit Windows 7 [added on 9/6]
2. fully updated 64bit Windows Server 2008 [added on 9/6]
3. fully updated 64bit Windows 10 version 1607 [added on 9/4]
4. fully updated 64bit Windows 10 version 1709 [added on 9/5]
5. fully updated 64bit Windows 10 version 1803
6. fully updated 64bit Windows Server 2016
7. fully updated 64bit Windows Server 1803 [added on 9/6]

[Update 9/6/2018] Big thanks to [Will Dormann](https://twitter.com/wdormann) for confirming the
vulnerability as well as effectiveness of our micropatch on Windows
Server 1803 in a real-time Twitter DM session!

We can quickly port the micropatch to other affected versions but we'll only do that on request (support@0patch.com). As far as we know at this point, the vulnerability was confirmed to also be present and exploitable on [32bit Windows 10](https://twitter.com/wdormann/status/1034554597908664320) and [32bit Windows 7](https://twitter.com/wdormann/status/1034948211579015168), so it's safe to assume that at least all Windows versions from Windows 7 and Windows Server 2008 are likely affected.

*Q: Will modifying the exploit allow attackers to bypass this micropatch?*

No, and that's one of the significant advantages of changing the code compared to signature- or behavior- based exploit prevention systems. For instance, while most antivirus products will detect the original POC by now, Will Dormann [modified the POC](https://twitter.com/wdormann/status/1035174336322330624) and showed that it went undetected. Such modifications *always* allow for bypassing detection-based systems, while fixing the code actually removes the vulnerability. There is simply nothing there to bypass. There is *no more efficient and reliable way* to address a vulnerability than to actually remove it. (Although the entire industry built *around* vulnerabilities will try to convince you otherwise.)

*Q: How do weapply this micropatch?*

If you have 0patch Agent already installed, this micropatch is already downloaded and applied so you don't have to do anything. Otherwise, [download](https://dist.0patch.com/download/latestagent) and launch the 0patch Agent installer, [create a free 0patch account](https://dist.0patch.com/User/Register)
and register the agent to that account. You will immediately receive
all micropatches including this one, and it will automatically get applied to Task Scheduler.

*Q: Is this patch functionally identical to how Microsoft will fix it?*

Obviously we can't know that. As we always claim, the original vendor - with their internal knowledge of the product - is best-positioned to correct their own code. Nobody else knows all the possible side effects of a code change as well as they do (granted, with large products even they often don't see everything) and in an ideal world software vendors would be issuing micropatches like this to quickly and painlessly fix vulnerabilities. That said, Microsoft may do the same as we did, but they may also prevent Task Scheduler from changing permissions on hard links. Or they may find that they need to support hard links *and* not impersonating the user is essential for some other operation that Task Scheduler performs - and will make a substantial code change. We often create micropatches after the vendor has issued the official update, which allows us to see what they did and ideally replicate their logic in a micropatch. With a 0day, this is obviously not possible.

You should therefore consider our micropatch a temporary solution while waiting for the official fix.

*Q: What will happen on Patch Tuesday?*

When Microsoft makes their official fix available, you simply apply it as you would if you had never heard of 0patch. Applying it will automatically obsolete this micropatch on your computer as the update will replace a vulnerable executable with a fixed one, thereby changing its cryptographic hash. Since our micropatches are associated with specific hashes, this will make the micropatch inapplicable without intervention on either your end or ours.

*Q: Can we keep using this micropatch instead of applying Microsoft's update?*

**We strongly recommend against that.** Microsoft's update will not only fix this issue in a more informed way, but will also bring fixes for other vulnerabilities that we don't have micropatches for. Yes, we hate losing hours of our lives to updating our systems too, but wouldn't dream of outright replacing official updates with our micropatches ;)

*Q: How can you provide a micropatch so quickly compared to original vendors?*

While having a micropatch candidate ready [24 hours after a 0day was dropped](https://twitter.com/0patch/status/1034577454961176577) is quick relative to today's standards of software patching, a couple of things must be considered:

1. Software vendors know their products much better than we do, and are likely to create a more comprehensive code fix than we can without their knowledge and source code. That takes more time than writing a micropatch.
2. Software vendors bundle numerous fixes together in a "fat update" that replaces entire executables, which requires a lot more testing across the board. We test our micropatches with focused tests targeting only the patched code.
3. "Fat updates" are a huge problem for users and vendors when something goes wrong, which is why software vendors are even more wary of issuing a defective update. Of course a micropatch also can be flawed, but it can be revoked remotely and instantly replaced with a corrected version without users ever noticing anything. That said, we will always have "fat updates" for substantial functional changes, we're just arguing that we may not need them this frequently because most vulnerabilities could be patched with micropatches.
4. Software vendors must issue patches for all supported versions, and extensively test all of them. We currently only have this micropatch for two three four six seven affected Windows versions.
   Nevertheless, porting to other versions, basic testing and deployment would take us about
   two hours of effort for each additional version, so that could still be done in one day.

All that said, comparing our speed with software vendors' must also account for the difference in our deliverables. A micropatch can be quickly created, deployed to all computers in a hour's time and applied without even the slightest disturbance to users. But it must be considered a temporary security measure until the official patch can be applied.

*Q: What should we do if we encounter problems with Task Scheduler after applying this micropatch?*

Obviously we can't guarantee that our micropatch won't cause some unwanted side effects, e.g., with non-admin users editing existing scheduled tasks under certain circumstances. (Then again, software vendors can't guarantee that either.) The rule of thumb for using 0patch (or any other 3rd party behavior-changing product like antivirus or malware blockers) should be to first disable the agent and see if the problem persists, before contacting the original software vendor for the affected product. If the problem persists, the culprit is unlikely to be the micropatch. If the problem goes away, it's probably us and we'd like to hear from you at support@0patch.com.

Fortunately, in contrast to standard "fat update" patching that software products employ today, 0patch allows you to *instantly revert a patch with a click of a button*.

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=9156776864167622344&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=9156776864167622344&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html "Newer Post")

[Older Post](https://blog.0patch.com/2018/05/0patching-foxit-reader-buffer-oops.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/9156776864167622344/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* ►
  [2025](https://blog.0patch.com/2025/)
  (1)
  + ►
    [January](https://blog.0patch.com/2025/01/)
    (1)

* ►
  [2024](https://blog.0patch.com/2024/)
  (23)
  + ►
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + ►
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + ►
    [January](https://blog.0patch.com/2024/01/)
    (1)

* ►
  [2023](https://blog.0patch.com/2023/)
  (26)
  + ►
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + ►
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + ►
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + ►
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + ►
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + ►
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2023/01/)
    (2)

* ►
  [2022](https://blog.0patch.com/2022/)
  (26)
  + ►
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + ►
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + ►
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + ►
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + ►
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + ►
    [January](https://blog.0patch.com/2022/01/)
    (1)

* ►
  [2021](https://blog.0patch.com/2021/)
  (23)
  + ►
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + ►
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + ►
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + ►
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + ►
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2021/01/)
    (2)

* ►
  [2020](https://blog.0patch.com/2020/)
  (19)
  + ►
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + ►
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + ►
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + ►
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + ►
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + ►
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + ►
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2020/01/)
    (2)

* ►
  [2019](https://blog.0patch.com/2019/)
  (7)
  + ►
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + ►
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + ►
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + ►
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + ►
    [January](https://blog.0patch.com/2019/01/)
    (1)

* ▼
  [2018](https://blog.0patch.com/2018/)
  (11)
  + ►
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + ▼
    [August](https://blog.0patch.com/2018/08/)
    (1)
    - [How We Micropatched a Publicly Dropped 0day in Tas...](https://blog.0patch.com/2018/08/how-we-micropatched-publicly-dropped.html)
  + ►
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + ►
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + ►
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + ►
    [January](https://blog.0patch.com/2018/01/)
    (2)

* ►
  [2017](https://blog.0patch.com/2017/)
  (19)
  + ►
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + ►
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + ►
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + ►
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + ►
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + ►
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + ►
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + ►
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + ►
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + ►
    [January](https://blog.0patch.com/2017/01/)
    (1)

* ►
  [2016](https://blog.0patch.com/2016/)
  (7)
  + ►
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + ►
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + ►
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + ►
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from portal.msrc.microsoft.com_65bdd835_20250125_160959.html ===
You need to enable JavaScript to run this app.
