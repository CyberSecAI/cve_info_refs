=== Content from blog.0patch.com_89e8d4b7_20250126_115107.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Friday, October 12, 2018

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[October 12, 2018](https://blog.0patch.com/2018/10/patching-re-patching-and-meta-patching.html "permanent link")

### Patching, Re-Patching and Meta-Patching the Jet Database Engine RCE (CVE-2018-8423)

**Flawed Patches Will Always Happen, But We Can Change How They Get Fixed**

by Mitja Kolsek, the 0patch Team

*TL;DR: Microsoft patched CVE-2018-8423 eighteen days after we had micropatched it. Their official patch turned out to be incomplete so we re-micropatched it.*

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjmSGYYKpjZ0QrC6O-XHQFPMWKjtrEMCuidy-wMFp-eK7buMkyf5_3M9ZjZN6ctzft0FDt6dB-kTJfNjLfYsLIrO3UEIKx0kBqtlh5-ZFk2hKB1j6a-S6NmotNZ_9i_CUorRhVIFRpgNNu/s640/Vuln_4112_CVE-2018-8423_PatchCard_LI_FB_1024x536.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjjmSGYYKpjZ0QrC6O-XHQFPMWKjtrEMCuidy-wMFp-eK7buMkyf5_3M9ZjZN6ctzft0FDt6dB-kTJfNjLfYsLIrO3UEIKx0kBqtlh5-ZFk2hKB1j6a-S6NmotNZ_9i_CUorRhVIFRpgNNu/s1600/Vuln_4112_CVE-2018-8423_PatchCard_LI_FB_1024x536.png)

This is a story about a Windows vulnerability that was reported to Microsoft, published as "0day" before the official patch was available, micropatched by us one day later, subsequently patched by Microsoft, found to be incorrectly patched, and now micropatched again over the flawed official patch. Confused? It's actually a nice case study to demonstrate... not how we are smarter than Microsoft (we really aren't) but how micropatching is a much more suitable technology for fixing vulnerabilities on billions of computers than the current de-facto standard of what we call "fat updates".

The story begins with the ZDI reporting a memory corruption vulnerability in Jet Database Engine (subsequently assigned CVE-2018-8423) to Microsoft, which then led to a public 0day drop 135 days later without Microsoft having issued an official fix for it. We at 0patch took ZDI's proof-of-concept exploit and created a free micropatch for our users just 24 hours later. For more details up to that point see our [previous blog post](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html).

Now, a few days ago, Microsoft issued their fix for this issue as part their October 2018 Monthly Update. As expected, the update brought a modified msrd3x40.dll binary: this is the binary with the vulnerability, which we had micropatched with 4 CPU instructions (one of which was just for reporting purposes). The version of msrd3x40.dll changed from 4.0.9801.0 to 4.0.9801.5 and of course its cryptographic hash also changed - which resulted in our micropatch for this issue no longer getting applied to msrd3x40.dll. This is a welcome automatic side effect of in-memory patching, unburdening users from doing **anything** beyond applying the official vendor update once it becomes available. It also nicely demonstrates how traditional "module-replacing" updating can safely co-exist with in-memory micropatching.

Naturally we were curious whether Microsoft's fix was identical to our micropatch. Two months ago, we compared Microsoft's fix with our own micropatch for the famous Sandbox Escaper's 0day and [found them to be functionally identical](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html).

So we BinDiff-ed the patched msrd3x40.dll to its vulnerable version and reviewed the differences. At this point we will only state that we found the official fix to be slightly different to our micropatch, and unfortunately in a way that only limited the vulnerability instead of eliminating it. We promptly notified Microsoft about it and will not reveal further details or proof-or-concept until they issue a correct fix.

We have, however, issued a micropatch that corrects Microsoft's patch. Namely, in an ironical twist of fate **Microsoft's October update actually re-opened the CVE-2018-8423 vulnerability for 0patch users** who were previously protected by our micropatch. This new micropatch, which has already been distributed to all online users by now, resumes their protection. At the time of this writing, it is confirmed to be applicable to fully updated 32-bit and 64-bit Windows 10, Windows 8.1, Windows 7, Windows Server 2008 and Windows Server 2012. We suspect all other affected Windows versions also share the same version of msrd3x40.dll, in which case the micropatch will apply there as well. (We'll update this information as we go.)

We all know that many Windows users and admins don't immediately apply Windows updates as they become available. This begs the question: **What will happen if you have 0patch Agent installed and haven't applied the October Windows Updates yet?** Obviously, you're currently protected by our micropatch for msrd3x40.dll version 4.0.9801.0, which is getting applied to this module whenever the module gets loaded in any running process. When you decide to apply the October Windows Updates, they will make you restart your computer, after which there will be a new version of msrd3x40.dll there, version 4.0.9801.5. But our new micropatch for it will also already be there installed and waiting in your 0patch Agent, so whenever the newÂ  msrd3x40.dll gets loaded, it will immediately be micropatched in memory. **Bottom line: you don't have to do anything!**

You can see our micropatch in action in the video clip below. The video shows that after the official vendor fix for CVE-2018-8423 has been applied, the original
proof-of-concept published by the ZDI really doesn't work anymore
(WScript.exe correctly detects invalid input data and displays an error
message), but a slightly modified POC still manages to cause an
out-of-bounds write and crashes the process. ("Page heap" must be
enabled for the process to actually crash, while memory corruption
occurs without that as well.) Finally, the video shows that our
micropatch fixes the vulnerability for the modified POC as well.

Now what does this story tell us? A couple of things.

**1) In-memory micropatching nicely co-exists with traditional "fat" updating**. Not only does a micropatch that is currently getting applied get automatically obsoleted when the target binary is replaced by a new version, but a micropatch for a future binary version can also be patiently waiting for you to apply a vendor update, and automatically start getting applied to it when you do. All without you so much as lifting a finger.

**2) Flawed patches will always happen**. This time it was Microsoft, next time it will be someone else, and then we will make a flawed micropatch ourselves. The possibility of flawed micropatches is designed into our model though; by now you already know that a micropatch gets distributed to all online agents within 60 minutes of issuance, and gets instantly applied to vulnerable modules on your computer. But in case something went terribly wrong with it and it broke something (like [this vendor patch did](https://blog.0patch.com/2018/05/a-single-instruction-micropatch-for.html)), we could also have it revoked on all online agents within 60 minutes, causing it to stop applying. Meanwhile, you would be able to manually disable the micropatch via 0patch Console.

**3) Micropatching is quick and user-friendly.** All of the above - deployment, application, removal, and revocation or a micropatch - happens instantly, without restarting the computer or even having to re-open running applications. Compare this with today's standard approach to patching: first you download a ridiculous amount of bytes, which often forever take disk space on your computer, and then you have to at least restart patched applications (with all the documents you're working on) if not restart the computer, to actually get a handful of code changes applied. When something goes wrong, it takes at least as much time to revert to the pre-patched state, and that's only in the ideal case.

**4) In-memory micropatching is a superior method to "fat" updates for fixing most security issues.** We're not saying we could entirely do away with the concept or replacing modules on your computer and just keep micropatching it into eternity. No, software products periodically need significant modifications, but that's mostly for functional or user interface-related changes - and these really don't need to come on a monthly basis. Security fixes, however, actually need to be delivered faster if we ever want to outrun the attackers, and applied in a less user-hostile way than what we're all used to experiencing today, ideally so that users won't even notice their vulnerabilities disappearing under their feet. We can envision a product update model that includes annual or semi-annual fat updates, and lots of intermediate micropatches for security issues and occasional functional ones.

Our micropatches, including this current one, are still completely free for everyone, and can be obtained by installing and registering 0patch Agent from [https://0patch.com](https://0patch.com/). We highly welcome your feedback on support@0patch.com.

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=2415278792112844657&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=2415278792112844657&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=2415278792112844657&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=2415278792112844657&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=2415278792112844657&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=2415278792112844657&target=pinterest "Share to Pinterest")

#### 2 comments:

1. ![](//www.blogger.com/img/blogger_logo_round_35.png)[Yuhong Bao](https://www.blogger.com/profile/14519473280837410246)[October 23, 2018 at 4:48â¯AM](https://blog.0patch.com/2018/10/patching-re-patching-and-meta-patching.html?showComment=1540295331656#c1876972072333605041)

   If you don't use old Jet 2.x/3.x databases, there is probably a way to disable MSRD2X40/MSRD3X40 via the registry.

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=7114610046316422325&postID=1876972072333605041)Replies
   Reply
2. ![](//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhhQFaStjy8JjwzvhfkPxpEqUpqY4csPxrWkv9MBCfTLjzRzkkIsYZng-Zs_M3E0jZdfW-6WjV2aMw6sv48fHlSpCJ65Wd48EBMmnsjV0qqv3IbW43pUxwWdPGO_8-B17g/s45-c/KolsekM+5_1.jpg)[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677)[October 23, 2018 at 6:19â¯AM](https://blog.0patch.com/2018/10/patching-re-patching-and-meta-patching.html?showComment=1540300785781#c7975579929120969329)

   Probably - there is a full path to the DLL written in the registry that at least WScript.exe reads to load msrd3x40.dll; we changed this path to experiment with a patched DLL we copied onto a machine without latest Windows updates. So this would likely also allow us to disable the loading of the Jet DLL but probably not in a graceful way, and who knows if everyone using Jet actually consults this registry value.

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=7114610046316422325&postID=7975579929120969329)Replies
   Reply

Add commentLoad more...

[Newer Post](https://blog.0patch.com/2019/01/one-two-three-micropatches-for-three.html "Newer Post")

[Older Post](https://blog.0patch.com/2018/10/words-patching-and-instantly-now-in.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/2415278792112844657/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* âº
  [2025](https://blog.0patch.com/2025/)
  (1)
  + âº
    [January](https://blog.0patch.com/2025/01/)
    (1)

* âº
  [2024](https://blog.0patch.com/2024/)
  (23)
  + âº
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + âº
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + âº
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + âº
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + âº
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + âº
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + âº
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + âº
    [January](https://blog.0patch.com/2024/01/)
    (1)

* âº
  [2023](https://blog.0patch.com/2023/)
  (26)
  + âº
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + âº
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + âº
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + âº
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + âº
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + âº
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + âº
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + âº
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + âº
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2023/01/)
    (2)

* âº
  [2022](https://blog.0patch.com/2022/)
  (26)
  + âº
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + âº
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + âº
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + âº
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + âº
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + âº
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + âº
    [January](https://blog.0patch.com/2022/01/)
    (1)

* âº
  [2021](https://blog.0patch.com/2021/)
  (23)
  + âº
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + âº
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + âº
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + âº
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + âº
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + âº
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + âº
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + âº
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2021/01/)
    (2)

* âº
  [2020](https://blog.0patch.com/2020/)
  (19)
  + âº
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + âº
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + âº
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + âº
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + âº
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + âº
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + âº
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2020/01/)
    (2)

* âº
  [2019](https://blog.0patch.com/2019/)
  (7)
  + âº
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + âº
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + âº
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + âº
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â¼
  [2018](https://blog.0patch.com/2018/)
  (11)
  + â¼
    [October](https://blog.0patch.com/2018/10/)
    (2)
    - [Patching, Re-Patching and Meta-Patching the Jet Da...](https://blog.0patch.com/2018/10/patching-re-patching-and-meta-patching.html)
    - [Words "Patching" and "Instantly" Now in the Same P...](https://blog.0patch.com/2018/10/words-patching-and-instantly-now-in.html)
  + âº
    [September](https://blog.0patch.com/2018/09/)
    (2)
  + âº
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + âº
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + âº
    [January](https://blog.0patch.com/2018/01/)
    (2)

* âº
  [2017](https://blog.0patch.com/2017/)
  (19)
  + âº
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + âº
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + âº
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + âº
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + âº
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + âº
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + âº
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + âº
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + âº
    [January](https://blog.0patch.com/2017/01/)
    (1)

* âº
  [2016](https://blog.0patch.com/2016/)
  (7)
  + âº
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + âº
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + âº
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).



=== Content from portal.msrc.microsoft.com_f021dc73_20250125_204742.html ===
You need to enable JavaScript to run this app.

=== Content from blog.0patch.com_179e3402_20250126_115110.html ===


# [0patch Blog](https://blog.0patch.com/)

Security Patching Simplified To The Extreme

## Monday, September 24, 2018

Posted by

[Mitja Kolsek](https://www.blogger.com/profile/00089863558178974677 "author profile")

on

[September 24, 2018](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html "permanent link")

### Outrunning Attackers On The Jet Database Engine 0day (CVE-2018-8423)

**Micropatching Makes It Possible To Create And Apply Patches Before Attackers Write a Reliable Exploit**

by Mitja Kolsek, the 0patch Team

### Timeline

* **Day 0** (05/08/18) - ZDI reports the vulnerability to Microsoft
* **Day 135** (09/20/18) - ZDI publishes vulnerability details and PoC, no official fix available
* **Day 136** (09/21/18) - Micropatches for all supported Windows versions created, distributed and applied on all users' computers
* **Day 154** (10/09/18) - Microsoft issues an official fix
* **Day 157** (10/12/18) - [Official fix found to be incomplete, further micropatches created and distributed, Microsoft notified](https://blog.0patch.com/2018/10/patching-re-patching-and-meta-patching.html).

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj_4dCel4S8gy__bWvT5Xk343On81_y4BuB14RxZPdb9fYiwKFt0jAS5FZKrQglbLL9rlgtjiXCAFxQpPOeF2fVCwcb3QyTR6cQ1gTiFsFSMCggM08TWu63Z91g4QzOYZQUbjigS0Z4a8rq/s640/Vuln_4112_NO-CVE_PatchCard_Twitter_506x253.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj_4dCel4S8gy__bWvT5Xk343On81_y4BuB14RxZPdb9fYiwKFt0jAS5FZKrQglbLL9rlgtjiXCAFxQpPOeF2fVCwcb3QyTR6cQ1gTiFsFSMCggM08TWu63Z91g4QzOYZQUbjigS0Z4a8rq/s1600/Vuln_4112_NO-CVE_PatchCard_Twitter_506x253.png)

###

### Introduction

Last Thursday, [Zero Day Initiative published details](https://www.thezdi.com/blog/2018/9/20/zdi-can-6135-a-remote-code-execution-vulnerability-in-the-microsoft-windows-jet-database-engine) of an unpatched remotely exploitable vulnerability in all Windows versions (discovered by [Lucas Leong](https://twitter.com/_wmliang_)) due to Microsoft missing their 120-day fixing window. We immediately tested ZDI's [proof-of-concept](https://github.com/thezdi/PoC/tree/master/ZDI-18-1075) and found the following:

1. Jet is only supported in 32-bit, which means that a 64-bit application tricked into accessing a malformed data source file will not be exploitable. Indeed, double-clicking ZDI's poc.js on 64-bit Windows results in an error message; in order to launch poc.js on a 64bit machine one needs to use the 32-bit wscript.exe by launching c:\windows\SysWOW64\wscript.exe poc.js.
2. Obviously, getting a user to launch a .js file is not a convincing attack scenario (such file could already do anything within user's privileges). The good news for attackers is that this attack can be mounted via Internet Explorer, especially since even on 64-bit Windows, Internet Explorer rendering processes are 32-bit. On the upside, we were unable to get the exploit working from a web site because - at least on IE11 - the security setting "Access data sources across domains" is disabled in Internet and Intranet zone, which resulted in a JavaScript error. Launching a malicious poc.html from a local drive (or USB disk) does work, however, whereby the accompanying data source file can be in a shared folder and doesn't need to be delivered with poc.html.
   Nevertheless, the user then has to press the "Allow blocked content" button, which amounts to a considerable level of social engineering required to execute the attack via Internet Explorer.
3. A more realistic attack could probably be conceived using a malicious Office document referencing an external malformed Jet data source. We haven't investigated that, however, as our job is not to write exploits but micropatches. (Resourceful attackers will soon reveal their weaponization ideas anyway.)

### Vulnerability Analysis

As usually, we started our analysis from the *closest observable point of failure* and worked backward to the vulnerable code. Ideally, the "closest observable point of failure" is a process crash, and in this case, ZDI's PoC indeed causes a crash in wscript.exe due to an attempt to write past the allocated memory block. So their PoC was perfect for us. (Not surprisingly, it's easier for us to work with a crash case than a full blown calc-popping exploit.) Here's how the crash looks like in WinDbg, with Page Heap enabled and invalid memory access in function TblPage::CreateIndexes:

eax=00002300 ebx=00000002 ecx=00834918 edx=00000000 esi=008360a8 edi=0024d64c

eip=6b881234 esp=0024d4c0 ebp=07ac427c iopl=0Â Â Â Â Â Â Â Â  nv up ei pl nz ac po nc

cs=0023Â  ss=002bÂ  ds=002bÂ  es=002bÂ  fs=0053Â  gs=002bÂ Â Â Â Â Â Â Â Â Â Â Â  efl=00010212

msrd3x40!DllRegisterServer+0x1b644:

6b881234 89b48174050000Â  movÂ Â Â Â  dword ptr [ecx+eax\*4+574h],esi ds:002b:0083da8c=????????

For anyone with some mileage in reverse engineering, the instruction causing the exception indicates that the code is accessing an indexed element in an array containing 4-byte elements, whereby the array starts at ecx+574h and the index is in eax (which contains 2300h). And it's clear that the index is beyond the array's limits.

From a patcher's perspective, this raises the following questions:

1) Where does this index come from? (And does it affect anything else, which would cause a micropatch to simply shift the problem further down the code and prompting another micropatch for that?)

2) Does the array have a fixed size? (Which would mean a simple hard-coded index validation micropatch could suffice.)

In tracking the index value 2300h, we found that eax was read from address esi+24h a few instructions back. We then used !heap to find out who allocated it and set an access breakpoint to see who wrote this value there. That turned out to be function Index::Restore, which is called a couple of instruction earlier in TblPage::CreateIndexes. What happens there is value 2300h is copied to the location we're watching with our access breakpoint from address pointed to by edx. And edx at that moment points to the memory-mapped copy of the malformed data source file.

So we found out that the malformed value 2300h comes directly from the PoC file group1, specifically at offset 1257h. Furthermore, looking around the code for additional uses of this user-provided index, we found one case immediately after the crash location, so whatever we'd do we'd need to make sure that this second use wouldn't also cause problems.

An obvious solution to fixing both uses of the malformed index was to check the index immediately after it gets copied from the memory-mapped file (i.e., right after the call to Index::Restore), and setting it to some safe value in case it was out of bounds. But in order to check the bounds we'd need to know the bounds.

Using !heap on ecx at the point of crash we inspected who allocated the memory block from which the PoC has escaped, and how large that block was. We found it to be a fixed-size block of 778h bytes, most likely a C++ object containing a fixed-size array of 4-byte elements. But how many elements? Let's calculate: the array begins at offset 574h in the memory block, and ends at most at offset 778h-1. The difference between the two means there is at most 204h bytes in the array, and dividing that by 4 (bytes) we get 81h elements, meaning that valid index values are between 00h and (at most) 80h.

Note that we say "at most 80h" - at this point we can't know whether the entire space between offset 574h and the end of the memory block is reserved for the array (although it surely seems so), we just calculated the bounds for preventing the offending instruction from escaping the memory block. And we'll be okay with this for now: we'll prevent an exploit from overwriting heap management data or other objects allocated on the heap, which will take most (if not all) of the leverage from the attacker.

### The Micropatch

So how should the micropatch look like? It would have to be injected right after the call to Index::Restore and check that the user-supplied value that was written to [esi+24h] doesn't exceed 80h. If it did exceed 80h, the patch would have to correct the value at [esi+24h], say by overwriting it with 0 (which is a valid index).Â  And here is the source code of this micropatch:

; Patch for VULN-4112 in msrd3x40.dll version 4.0.9801.0 32bit

MODULE\_PATH "..\AffectedModules\msrd3x40.dll\_4.0.9801.0\_32bit\msrd3x40.dll"

PATCH\_ID 1000010

PATCH\_FORMAT\_VER 2

VULN\_ID 4112

PLATFORM win32

patchlet\_start

Â PATCHLET\_ID 1

Â PATCHLET\_TYPE 2

Â PATCHLET\_OFFSET 0x4118C

Â code\_start

Â Â  cmp dword [esi+24h], 0x80Â  ; is the index lower than or equal to 0x80?

Â Â  jbe passÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; if not, we let it pass

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; (jbe means unsigned compare, we don't want to allow

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ; values like 0x80002300 to be considered negative)

Â Â  mov dword [esi+24h], 0Â Â Â Â  ; otherwise we set it to 0

Â Â  call PIT\_ExploitBlockedÂ Â Â  ; and show the Exploit Blocked popup

Â  pass:

Â code\_end

patchlet\_end

We initially wrote this micropatch for Windows 7, and had a candidate ready just 7 hours after ZDI had published their PoC. After attempting to port it to other supported Windows versions, we noticed that almost all of them have the exact same version of msrd3x40.dll - which meant the same micropatch would apply to all these systems. The only Windows version with a different msrd3x40.dll was Windows 10: peculiarly, both DLLs had the same version and exactly the same size, but plenty of small differences between the two (including the link timestamp). The code was exactly the same and in the same place though (probably just a re-build), so we could actually use the exact same source code for the micropatch, just a different file hash.

These two micropatches for a published 0day were then issued **less than 24 hours after the 0day was dropped,** and **distributed to our users' computers within 60 minutes**, where they were automatically applied to any running process with vulnerable msrd3x40.dll loaded. Which nicely demonstrates the speed, simplicity and user-friendliness of micropatching when it comes to fixing vulnerabilities. **In fact one of our goals with 0patch is to make vulnerability patching so fast that attackers won't even manage to develop a reliable exploit for a public vulnerability, much less launch a campaign with it, before the vulnerability is already patched on most users' computers. What a goal, huh?**

### How Can You Get These Micropatches, And What To Do Next?

These micropatches are completely free for everyone, and can be obtained by installing and registering 0patch Agent from [https://0patch.com](https://0patch.com/). They will prevent exploitation of this 0day as long as you have the latest Windows updates applied (we did not port them to older Windows updates, but if you have a need for that you can contact us at support@0patch.com).

Once Microsoft issues their official fix (likely on October Patch Tuesday), you will simply apply that update and these micropatches will automatically get obsoleted without you having to do anything else.

Cheers!

[@mkolsek](https://twitter.com/mkolsek)

[@0patch](https://twitter.com/0patch)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7114610046316422325&postID=468625058640472600&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=468625058640472600&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=468625058640472600&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=468625058640472600&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=468625058640472600&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=7114610046316422325&postID=468625058640472600&target=pinterest "Share to Pinterest")

#### 1 comment:

1. ![](//www.blogger.com/img/blogger_logo_round_35.png)[Strikeout](https://www.blogger.com/profile/13830291171735678346)[September 25, 2018 at 10:03â¯AM](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html?showComment=1537895029300#c6754189610626466337)

   Hey friends, thanks for the patches! I personally do not have a usage for them but I really enjoy the process of finding the issue then how you guys patched it.

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=7114610046316422325&postID=6754189610626466337)Replies
   Reply

Add commentLoad more...

[Newer Post](https://blog.0patch.com/2018/10/words-patching-and-instantly-now-in.html "Newer Post")

[Older Post](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html "Older Post")

[Home](https://blog.0patch.com/)

Subscribe to:
[Post Comments (Atom)](https://blog.0patch.com/feeds/468625058640472600/comments/default)

## About 0patch

[0patch](https://0patch.com) (pronounced 'zero patch') is a platform for instantly distributing, applying and removing microscopic binary patches to/from running processes without having to restart these processes (much less reboot the entire computer). Brought to you by [ACROS Security](https://www.acrossecurity.com).

[Follow @0patch](https://twitter.com/0patch)

## Blog Archive

* âº
  [2025](https://blog.0patch.com/2025/)
  (1)
  + âº
    [January](https://blog.0patch.com/2025/01/)
    (1)

* âº
  [2024](https://blog.0patch.com/2024/)
  (23)
  + âº
    [December](https://blog.0patch.com/2024/12/)
    (1)
  + âº
    [November](https://blog.0patch.com/2024/11/)
    (4)
  + âº
    [October](https://blog.0patch.com/2024/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2024/09/)
    (1)
  + âº
    [July](https://blog.0patch.com/2024/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2024/06/)
    (2)
  + âº
    [May](https://blog.0patch.com/2024/05/)
    (1)
  + âº
    [April](https://blog.0patch.com/2024/04/)
    (4)
  + âº
    [March](https://blog.0patch.com/2024/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2024/02/)
    (4)
  + âº
    [January](https://blog.0patch.com/2024/01/)
    (1)

* âº
  [2023](https://blog.0patch.com/2023/)
  (26)
  + âº
    [November](https://blog.0patch.com/2023/11/)
    (3)
  + âº
    [October](https://blog.0patch.com/2023/10/)
    (3)
  + âº
    [September](https://blog.0patch.com/2023/09/)
    (2)
  + âº
    [August](https://blog.0patch.com/2023/08/)
    (1)
  + âº
    [July](https://blog.0patch.com/2023/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2023/06/)
    (5)
  + âº
    [May](https://blog.0patch.com/2023/05/)
    (1)
  + âº
    [April](https://blog.0patch.com/2023/04/)
    (1)
  + âº
    [March](https://blog.0patch.com/2023/03/)
    (5)
  + âº
    [February](https://blog.0patch.com/2023/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2023/01/)
    (2)

* âº
  [2022](https://blog.0patch.com/2022/)
  (26)
  + âº
    [December](https://blog.0patch.com/2022/12/)
    (3)
  + âº
    [October](https://blog.0patch.com/2022/10/)
    (6)
  + âº
    [September](https://blog.0patch.com/2022/09/)
    (3)
  + âº
    [August](https://blog.0patch.com/2022/08/)
    (2)
  + âº
    [July](https://blog.0patch.com/2022/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2022/06/)
    (3)
  + âº
    [May](https://blog.0patch.com/2022/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2022/03/)
    (4)
  + âº
    [January](https://blog.0patch.com/2022/01/)
    (1)

* âº
  [2021](https://blog.0patch.com/2021/)
  (23)
  + âº
    [December](https://blog.0patch.com/2021/12/)
    (2)
  + âº
    [November](https://blog.0patch.com/2021/11/)
    (3)
  + âº
    [October](https://blog.0patch.com/2021/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2021/09/)
    (1)
  + âº
    [August](https://blog.0patch.com/2021/08/)
    (3)
  + âº
    [July](https://blog.0patch.com/2021/07/)
    (2)
  + âº
    [June](https://blog.0patch.com/2021/06/)
    (1)
  + âº
    [May](https://blog.0patch.com/2021/05/)
    (3)
  + âº
    [March](https://blog.0patch.com/2021/03/)
    (2)
  + âº
    [February](https://blog.0patch.com/2021/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2021/01/)
    (2)

* âº
  [2020](https://blog.0patch.com/2020/)
  (19)
  + âº
    [December](https://blog.0patch.com/2020/12/)
    (2)
  + âº
    [November](https://blog.0patch.com/2020/11/)
    (2)
  + âº
    [September](https://blog.0patch.com/2020/09/)
    (1)
  + âº
    [August](https://blog.0patch.com/2020/08/)
    (2)
  + âº
    [July](https://blog.0patch.com/2020/07/)
    (3)
  + âº
    [June](https://blog.0patch.com/2020/06/)
    (2)
  + âº
    [May](https://blog.0patch.com/2020/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2020/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2020/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2020/01/)
    (2)

* âº
  [2019](https://blog.0patch.com/2019/)
  (7)
  + âº
    [September](https://blog.0patch.com/2019/09/)
    (1)
  + âº
    [June](https://blog.0patch.com/2019/06/)
    (1)
  + âº
    [April](https://blog.0patch.com/2019/04/)
    (2)
  + âº
    [February](https://blog.0patch.com/2019/02/)
    (2)
  + âº
    [January](https://blog.0patch.com/2019/01/)
    (1)

* â¼
  [2018](https://blog.0patch.com/2018/)
  (11)
  + âº
    [October](https://blog.0patch.com/2018/10/)
    (2)
  + â¼
    [September](https://blog.0patch.com/2018/09/)
    (2)
    - [Outrunning Attackers On The Jet Database Engine 0d...](https://blog.0patch.com/2018/09/outrunning-attackers-on-jet-database.html)
    - [Comparing Our Micropatch With Microsoft's Official...](https://blog.0patch.com/2018/09/comparing-our-micropatch-with.html)
  + âº
    [August](https://blog.0patch.com/2018/08/)
    (1)
  + âº
    [May](https://blog.0patch.com/2018/05/)
    (2)
  + âº
    [March](https://blog.0patch.com/2018/03/)
    (1)
  + âº
    [February](https://blog.0patch.com/2018/02/)
    (1)
  + âº
    [January](https://blog.0patch.com/2018/01/)
    (2)

* âº
  [2017](https://blog.0patch.com/2017/)
  (19)
  + âº
    [December](https://blog.0patch.com/2017/12/)
    (1)
  + âº
    [November](https://blog.0patch.com/2017/11/)
    (4)
  + âº
    [October](https://blog.0patch.com/2017/10/)
    (2)
  + âº
    [September](https://blog.0patch.com/2017/09/)
    (2)
  + âº
    [August](https://blog.0patch.com/2017/08/)
    (1)
  + âº
    [July](https://blog.0patch.com/2017/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2017/06/)
    (1)
  + âº
    [May](https://blog.0patch.com/2017/05/)
    (1)
  + âº
    [March](https://blog.0patch.com/2017/03/)
    (2)
  + âº
    [February](https://blog.0patch.com/2017/02/)
    (3)
  + âº
    [January](https://blog.0patch.com/2017/01/)
    (1)

* âº
  [2016](https://blog.0patch.com/2016/)
  (7)
  + âº
    [September](https://blog.0patch.com/2016/09/)
    (1)
  + âº
    [July](https://blog.0patch.com/2016/07/)
    (1)
  + âº
    [June](https://blog.0patch.com/2016/06/)
    (3)
  + âº
    [January](https://blog.0patch.com/2016/01/)
    (2)

## LinkedIn and Google tags

  ![](https://px.ads.linkedin.com/collect/?pid=1234785&fmt=gif)

|  |  |
| --- | --- |

Copyright ACROS Security / 0patch. Powered by [Blogger](https://www.blogger.com).


