=== Content from research.checkpoint.com_95eec4e0_20250126_091043.html ===




=== Content from research.checkpoint.com_2921be6d_20250125_135406.html ===

[![](https://research.checkpoint.com/wp-content/uploads/2024/06/CPR-by-Check-Point-logo.svg)](https://research.checkpoint.com)

* [CONTACT US](https://research.checkpoint.com/contact/)
* [DISCLOSURE POLICY](https://research.checkpoint.com/disclosure-policy/)
* [CHECKPOINT.COM](https://www.checkpoint.com/)
* [UNDER ATTACK?](https://www.checkpoint.com/about-us/contact-incident-response/)

[![](https://research.checkpoint.com/wp-content/uploads/2024/06/CPR-by-Check-Point-logo.svg)](https://research.checkpoint.com)

* [Latest Publications](https://research.checkpoint.com/latest-publications/)
* [CPR Podcast Channel](https://research.checkpoint.com/cpr-podcast-channel/)
* [Web 3.0 Security](https://research.checkpoint.com/category/web3/)
* [Intelligence Reports](https://research.checkpoint.com/intelligence-reports/)
* Resources
  + [ThreatCloud AI](https://www.checkpoint.com/ai/)
  + [Threat Intelligence & Research](https://www.checkpoint.com/solutions/threat-intelligence-research/)
  + [Zero Day Protection](https://www.checkpoint.com/infinity/zero-day-protection/)
  + [Sandblast File Analysis](http://threatemulation.checkpoint.com/)
* [About Us](https://research.checkpoint.com/about-us/)
* [SUBSCRIBE](https://research.checkpoint.com/subscription/)

SUBSCRIBE

## CATEGORIES

* [Android Malware
  23](https://research.checkpoint.com/category/android-malware/)
* [Artificial Intelligence
  4](https://research.checkpoint.com/category/artificial-intelligence-2/)
* [ChatGPT
  3](https://research.checkpoint.com/category/chatgpt/)
* [Check Point Research Publications
  396](https://research.checkpoint.com/category/threat-research/)
* [Cloud Security
  1](https://research.checkpoint.com/category/cloud-security/)
* [CPRadio
  44](https://research.checkpoint.com/category/cpradio/)
* [Crypto
  2](https://research.checkpoint.com/category/crypto/)
* [Data & Threat Intelligence
  1](https://research.checkpoint.com/category/data-threat-intelligence/)
* [Data Analysis
  0](https://research.checkpoint.com/category/data-analysis/)
* [Demos
  22](https://research.checkpoint.com/category/demos/)
* [Global Cyber Attack Reports
  339](https://research.checkpoint.com/category/threat-intelligence-reports/)
* [How To Guides
  13](https://research.checkpoint.com/category/how-to-guides/)
* [Ransomware
  2](https://research.checkpoint.com/category/ransomware/)
* [Russo-Ukrainian War
  1](https://research.checkpoint.com/category/russo-ukrainian-war/)
* [Security Report
  1](https://research.checkpoint.com/category/security-report/)
* [Threat and data analysis
  0](https://research.checkpoint.com/category/threat-and-data-analysis/)
* [Threat Research
  172](https://research.checkpoint.com/category/threat-research-2/)
* [Web 3.0 Security
  9](https://research.checkpoint.com/category/web3/)
* [Wipers
  0](https://research.checkpoint.com/category/wipers/)

![](https://research.checkpoint.com/wp-content/uploads/2019/02/PXE_Dust_Blog_1021x580.jpg)

# PXE Dust: Finding a Vulnerability in Windows Servers Deployment Services

March 6, 2019

https://research.checkpoint.com/2019/pxe-dust-finding-a-vulnerability-in-windows-servers-deployment-services/

**Research By:** Omer Gull

**Introduction**

Many large organizations use Windows Deployment Services (WDS) to install customized operating systems on new machines in the network. The Windows Deployment Services is usually, by its nature, accessible to anyone connected via an LAN port and provides the relevant software. They determine the Operating System as well as the accompanying programs and services for each new network element.

With this amount of accessibility, it is natural to consider what would be the ramifications if a malicious actor was able to breach this server and modify it to control the content of every new computer, and equip it with his own proprietary malware.

In this report, we discuss our research on the WDS infrastructure and our attempts to exploit its vulnerabilities.

**Windows Deployment Services**

WDS is Microsoft’s solution for network-based installation of Windows operating systems. WDS uses disk imaging, in particular the Windows Imaging Format (WIM), and is included as a Server Role in all 32-bit and 64-bit versions of Windows Server since 2008.

WDS is a complex system and we are far from understanding its entire operation. For the scope of this research, though, we analyzed how WDS behaved during a new installation as this pre-authentication negotiation appears to be a promising attack vector.

Before delivering the full blown Windows image, WDS must provide some network booting strategy. For that purpose it uses a PXE (Preboot eXecution Environment ) server. PXE is a standard created by Intel that establishes a common set of pre-boot services within the boot firmware with the end goal being to enable a client perform a network boot and receive a Network Boot Program (NBP) from a network boot server. To transfer an NBP, a PXE server uses the Trivial File Transfer Protocol (TFTP).

TFTP is a simple file transfer protocol implemented on top of the UDP/IP protocols using the well-known port number 69. Due to its simple design, TFTP can be easily implemented by small footprint code. Therefore, it is the protocol of choice for the initial stages of any network booting strategy such as BOOTP, BSDP and PXE.  However, TFTP lacks most of the advanced features offered by more robust file transfer protocols. For example, it cannot list, delete, or rename files or directories and it has no user authentication. Instead, the protocol only supports reading and writing.  Today, TFTP is rarely used for Internet transfers and its main use is from within LANs. All of this makes it a promising protocol for our purposes.

**Fuzzing**

Our first task then was to create a TFTP dumb fuzzer using [Boofuzz](https://github.com/jtpereyda/boofuzz).

Boofuzz, the successor to the [Sulley fuzzing framework](https://github.com/OpenRCE/sulley), offers an easy setup with great documentation and thanks to the simple Boofuzz syntax, translating the relevant RFCs to a [fuzzing script](https://github.com/CheckPointSW/Cyber-Research/blob/master/Vulnerability/PXE_Dust/tftp-sulley-fuzzer.py) was a fairly straightforward task.

*Tftp.py* defines the protocol semantics and fields to be fuzzed. As this fuzzer is very generic, this code could be re-targeted to fuzz any other TFTP implementation, and we encourage other researchers to do so.

While the fuzzer was running, we manually reversed the server implemented in *wdstftp.dll*. as these two methodologies often complement each other.

**wdstftp.dll**

When we reversed the dll, we started to review the file read mechanisms implemented in *CTftp::ParseRequest*. As mentioned earlier, the protocol does not implement too many complex features so this surface is a reasonable place to start.

TFTP Read Requests (RRQ) are handled in the *CTftpPacket::ParseRequest*. After validating the requested file that exists within the PXE base directory, it is read into a *CTptReadFile::CacheBlock* structure.

[![](/wp-content/uploads/2019/02/img1-1.png)](/wp-content/uploads/2019/02/img1-1.png)

**Figure 1:** CacheBlock Struct

These *CacheBlock*s are managed in a linked list.

[*ReadFile*](https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-readfile)[s](https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-readfile) are performed asynchronously by the server with *CTptReadFile::\_IOCompletionCallback* assigned as their callback function.

[![](/wp-content/uploads/2019/02/img2-1.png)](/wp-content/uploads/2019/02/img2-1.png)

**Figure 2:** ReadFile Callback

So far so good. However, we then noticed a rather strange behavior. It seems that the *CacheBlock*s linked list is limited in size to….. two nodes?

[![](/wp-content/uploads/2019/02/img3-1.png)](/wp-content/uploads/2019/02/img3-1.png)

**Figure 3:** maxCacheBlocks = 2

In the figure below, we can see that when the number of cache blocks exceeds 2, the tail is deleted.

[![](/wp-content/uploads/2019/02/img4-1.png)](/wp-content/uploads/2019/02/img4-1.png)

**Figure 4:** free tail

With our new-found knowledge of the TFTP protocol, and the use of the [*blksize*](https://tools.ietf.org/html/rfc2348) and [*windowsize*](https://tools.ietf.org/html/rfc7440#page-3) options, we should be able to craft a request that will populate more than two cache blocks before receiving an acknowledgement packet. If all goes well and the timing is right, a cacheblock is freed before it is used by the callback function *CTptReadFile::\_IOCompletionCallback*.

Ready, set (page heap on), go.

[![](/wp-content/uploads/2019/02/img5-1.png)](/wp-content/uploads/2019/02/img5-1.png)

**Figure 5:** Crash in windbg

We can see that RAX now points to freed memory(!), effectively giving us a Use-After-Free vulnerability in Windows Deployment Services.

This bug seems fairly trivial, so why did our fuzzer miss it?

The answer is that the Sulley framework fuzzes one field at a time, and our requested reads were never this long. This is a good lesson for future fuzzers: on the one hand you want your packets to be valid enough so they won’t be rejected by the parser. On the other hand, if you make it too valid, you’ll miss potential bugs.

**Exploitation Methods**

As this is a remotely triggerable, non-authenticated, high privileged Windows server bug, we can definitely mark this as a critical vulnerability.

Usually, when exploiting a Use-After-Free (UAF) bug, we try to allocate a different object (of similar size) or a similar object in a different state and cause some sort of confusion between them.

Looking for allocation primitives that will allow us to allocate an object that will fit in the freed area, we examined the process heap.

It turns out that WDS actually uses several heaps, and our heap was shared between *wdstftp.dll*, *wdssrv.dll* and *wdsmc.dll*.

While wdstftp.dll allowed for some quite flexible allocations such as the one in [TFTP Error packets](https://tools.ietf.org/html/rfc1350#page-8), they were all ASCII that was converted to Unicode.

[![](/wp-content/uploads/2019/02/img6-1.png)](/wp-content/uploads/2019/02/img6-1.png)

**Figure 6:** Unicode POC

This is a nice primitive for a POC, but forging a functional payload is going to take a bit more as we’ll need to de-reference some pointers.

The next allocation primitive mechanism candidate was *wdssrv.dll*. It exposed an RPC interface that provides the ability to remotely invoke services provided by the WDS Server.

The protocol’s binary nature and [generous documentation](https://msdn.microsoft.com/en-us/library/dd541214.aspx) seemed promising.

Looking for any attacker controllable allocations, we reached *CRpcHandler::OnRecvRequest.*

As its name suggests, this RPC handler does the initial parsing of RPC requests before inserting them into a queue to be handled by future workers. Sadly, these workers will not share our heap so we are limited to the handler itself.

To use the freed memory, we need to use the same Heap bucket (size 0x5c-0x78).

Our only allocation in the handler of somewhat controlled size is the *CMemoryBuffer::Initialize*.

[![](/wp-content/uploads/2019/02/img7-1.png)](/wp-content/uploads/2019/02/img7-1.png)

**Figure 7:** RPC allocation primitive

The following script allows us to perform a successful allocation that fits in our target bucket.

[![](/wp-content/uploads/2019/02/img8.png)](/wp-content/uploads/2019/02/img8.png)

**Figure 8:** RPC POC

However, apparently some of the struct, and most importantly the CacheBlocks *callbackCtx* pointers, were left untouched (and uninitialized).

[![](/wp-content/uploads/2019/02/img9.png)](/wp-content/uploads/2019/02/img9.png)

**Figure 9:** Memory layout using RPC POC

If we enlarge our RPC payload, we will be allocated to the wrong bucket due to size calculations performed by *CMemoryBuffer::Initialize*.

Our next thought was to see if we could escalate things using the CacheBlocks field we are able to alter.

Unfortunately, further reversing revealed that *CTftpReader* hadn’t really used them. Too bad…

For our final attempt in exploiting this bug, we tried a different approach. We tried to repurpose the bug and use it to gain a significant information disclosure from the server. In a standard scenario, the *IOCompletionCallback* is called on a CacheBlock that was filled with the file’s content, and sends its content back to us. By confusing the server and planting a “fresh” CacheBlock that wasn’t yet filled with the file’s content, we hoped that the server would send us the uninitialized memory of our new CacheBlock, thus causing a major information leak.

After numerous attempts to win this race, we always received back partial file content instead of uninitialized memory. We suspect that a busy server that handles a large amount of file read/write requests would read our TFTP image more slowly, thus improving our chance to win this race condition.

**Conclusion**

WDS is a popular Windows server service that is widely used for the installation of image distribution. Its underlying PXE server had a critical remotely triggered use after-free-bug that can be potentially exploited by an unauthenticated attacker.

We responsibly disclosed the bug we found to Microsoft who assigned it as CVE-2018-8476 with critical status and described it as potentially leading to a code execution against all Windows Servers since 2008 SP2.

Due to time constraints, we have not continued to pursue the exploitation of the bug though both Check Point Research and Microsoft believe that the bug is likely exploitable.

The Check Point IPS blade provides protections against this threat:

Microsoft Windows Deployment Services TFTP Server Code Execution (CVE-2018-8476)

[![](https://research.checkpoint.com/wp-content/uploads/2022/10/back_arrow.svg)

GO UP](#single-post)

[BACK TO ALL POSTS](/latest-publications/)

## POPULAR POSTS

[![](https://research.checkpoint.com/wp-content/uploads/2023/01/AI-1059x529-copy.jpg)](https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/)

* Artificial Intelligence
* ChatGPT
* Check Point Research Publications

[OPWNAI : Cybercriminals Starting to Use ChatGPT](https://research.checkpoint.com/2023/opwnai-cybercriminals-starting-to-use-chatgpt/)

[![](https://research.checkpoint.com/wp-content/uploads/2019/01/Fortnite_1021x580.jpg)](https://research.checkpoint.com/2019/hacking-fortnite/)

* Check Point Research Publications
* Threat Research

[Hacking Fortnite Accounts](https://research.checkpoint.com/2019/hacking-fortnite/)

[![](https://research.checkpoint.com/wp-content/uploads/2022/12/OpenAIchatGPT_header.jpg)](https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/)

* Artificial Intelligence
* ChatGPT
* Check Point Research Publications

[OpwnAI: AI That Can Save the Day or HACK it Away](https://research.checkpoint.com/2022/opwnai-ai-that-can-save-the-day-or-hack-it-away/)

### BLOGS AND PUBLICATIONS

[![](https://research.checkpoint.com/wp-content/uploads/2020/02/CheckPointResearchTurkishRat_blog_header.jpg)](https://research.checkpoint.com/2020/the-turkish-rat-distributes-evolved-adwind-in-a-massive-ongoing-phishing-campaign/)

* Check Point Research Publications
* Global Cyber Attack Reports
* Threat Research

February 17, 2020
### “The Turkish Rat” Evolved Adwind in a Massive Ongoing Phishing Campaign

[![](https://research.checkpoint.com/wp-content/uploads/2017/08/WannaCry-Post-No-Image-1021x450.jpg)](https://research.checkpoint.com/2017/the-next-wannacry-vulnerability-is-here/)

* Check Point Research Publications

August 11, 2017
### “The Next WannaCry” Vulnerability is Here

[![](https://research.checkpoint.com/wp-content/uploads/2018/01/rubyminer.jpg)](https://research.checkpoint.com/2018/rubyminer-cryptominer-affects-30-ww-networks/)

* Check Point Research Publications

January 11, 2018
### ‘RubyMiner’ Cryptominer Affects 30% of WW Networks

[![](https://research.checkpoint.com/wp-content/uploads/2022/12/CheckPointResearchLogo_white-1-e1671590634727.png)](https://research.checkpoint.com)

* Publications
  + [Global cyber attack reports](/category/threat-intelligence-reports/)
  + [Research publications](/category/threat-research/)
  + [IPS advisories](https://advisories.checkpoint.com/advisories/)
  + [Check point blog](https://blog.checkpoint.com/)
  + [Demos](/category/demos/)
* Tools
  + [Sandblast file analysis](http://threatemulation.checkpoint.com/)
  + [ThreatCloud](https://www.checkpoint.com/infinity/threatcloud/)
  + [Threat Intelligence](https://www.checkpoint.com/solutions/threat-intelligence-research/)
  + [Zero day protection](https://www.checkpoint.com/infinity/zero-day-protection/)
  + [Live threat map](https://threatmap.checkpoint.com/)
* [About Us](https://research.checkpoint.com/about-us/)
  + [Contact Us](https://research.checkpoint.com/contact/)

### Let’s get in touch

Subscribe for cpr blogs, news and more

[Subscribe Now](/subscription/)

© 1994-2024 Check Point Software Technologies LTD. All rights reserved.

Property of [CheckPoint.com](https://www.checkpoint.com/)

[Privacy Policy](/privacy-policy/)

![](https://research.checkpoint.com/wp-content/uploads/2022/10/popup-side-image.jpg)

## SUBSCRIBE TO CYBER INTELLIGENCE REPORTS

First Name

Last Name

Country—Please choose an option—ChinaIndiaUnited StatesIndonesiaBrazilPakistanNigeriaBangladeshRussiaJapanMexicoPhilippinesVietnamEthiopiaEgyptGermanyIranTurkeyDemocratic Republic of the CongoThailandFranceUnited KingdomItalyBurmaSouth AfricaSouth KoreaColombiaSpainUkraineTanzaniaKenyaArgentinaAlgeriaPolandSudanUgandaCanadaIraqMoroccoPeruUzbekistanSaudi ArabiaMalaysiaVenezuelaNepalAfghanistanYemenNorth KoreaGhanaMozambiqueTaiwanAustraliaIvory CoastSyriaMadagascarAngolaCameroonSri LankaRomaniaBurkina FasoNigerKazakhstanNetherlandsChileMalawiEcuadorGuatemalaMaliCambodiaSenegalZambiaZimbabweChadSouth SudanBelgiumCubaTunisiaGuineaGreecePortugalRwandaCzech RepublicSomaliaHaitiBeninBurundiBoliviaHungarySwedenBelarusDominican RepublicAzerbaijanHondurasAustriaUnited Arab EmiratesIsraelSwitzerlandTajikistanBulgariaHong Kong (China)SerbiaPapua New GuineaParaguayLaosJordanEl SalvadorEritreaLibyaTogoSierra LeoneNicaraguaKyrgyzstanDenmarkFinlandSlovakiaSingaporeTurkmenistanNorwayLebanonCosta RicaCentral African RepublicIrelandGeorgiaNew ZealandRepublic of the CongoPalestineLiberiaCroatiaOmanBosnia and HerzegovinaPuerto RicoKuwaitMoldovMauritaniaPanamaUruguayArmeniaLithuaniaAlbaniaMongoliaJamaicaNamibiaLesothoQatarMacedoniaSloveniaBotswanaLatviaGambiaKosovoGuinea-BissauGabonEquatorial GuineaTrinidad and TobagoEstoniaMauritiusSwazilandBahrainTimor-LesteDjiboutiCyprusFijiReunion (France)GuyanaComorosBhutanMontenegroMacau (China)Solomon IslandsWestern SaharaLuxembourgSurinameCape VerdeMaltaGuadeloupe (France)Martinique (France)BruneiBahamasIcelandMaldivesBelizeBarbadosFrench Polynesia (France)VanuatuNew Caledonia (France)French Guiana (France)Mayotte (France)SamoaSao Tom and PrincipeSaint LuciaGuam (USA)Curacao (Netherlands)Saint Vincent and the GrenadinesKiribatiUnited States Virgin Islands (USA)GrenadaTongaAruba (Netherlands)Federated States of MicronesiaJersey (UK)SeychellesAntigua and BarbudaIsle of Man (UK)AndorraDominicaBermuda (UK)Guernsey (UK)Greenland (Denmark)Marshall IslandsAmerican Samoa (USA)Cayman Islands (UK)Saint Kitts and NevisNorthern Mariana Islands (USA)Faroe Islands (Denmark)Sint Maarten (Netherlands)Saint Martin (France)LiechtensteinMonacoSan MarinoTurks and Caicos Islands (UK)Gibraltar (UK)British Virgin Islands (UK)Aland Islands (Finland)Caribbean Netherlands (Netherlands)PalauCook Islands (NZ)Anguilla (UK)Wallis and Futuna (France)TuvaluNauruSaint Barthelemy (France)Saint Pierre and Miquelon (France)Montserrat (UK)Saint Helena, Ascension and Tristan da Cunha (UK)Svalbard and Jan Mayen (Norway)Falkland Islands (UK)Norfolk Island (Australia)Christmas Island (Australia)Niue (NZ)Tokelau (NZ)Vatican CityCocos (Keeling) Islands (Australia)Pitcairn Islands (UK)

Email

## We value your privacy!

BFSI uses cookies on this site. We use cookies to enable faster and easier experience for you. By continuing to visit this website you agree to our use of cookies.

ACCEPT
REJECT



=== Content from portal.msrc.microsoft.com_5bd2bf13_20250125_135404.html ===
You need to enable JavaScript to run this app.
