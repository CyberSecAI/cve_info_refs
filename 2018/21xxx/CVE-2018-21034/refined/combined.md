=== Content from github.com_c2932588_20250124_133059.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fissues%2F470)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fissues%2F470)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=argoproj%2Fargo-cd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-cd](/argoproj/argo-cd)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-cd) You must be signed in to change notification settings
* [Fork
  5.7k](/login?return_to=%2Fargoproj%2Fargo-cd)
* [Star
   18.5k](/login?return_to=%2Fargoproj%2Fargo-cd)

* [Code](/argoproj/argo-cd)
* [Issues
  3.1k](/argoproj/argo-cd/issues)
* [Pull requests
  485](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects
  5](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

Additional navigation options

* [Code](/argoproj/argo-cd)
* [Issues](/argoproj/argo-cd/issues)
* [Pull requests](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

# K8s secrets need to be redacted in API server #470

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[K8s secrets need to be redacted in API server](#top)#470Copy linkAssignees [![alexmt](https://avatars.githubusercontent.com/u/426437?s=64&u=fa4394a0bc2d8d083d91a7f31efdfb73a21cb9eb&v=4)](/alexmt)Milestone[0.9](https://github.com/argoproj/argo-cd/milestone/9)[![@jessesuen](https://avatars.githubusercontent.com/u/12677113?u=0094b361933133ea2af1ee342805b7777fe5fb6a&v=4&size=80)](/jessesuen)
## Description

[![@jessesuen](https://avatars.githubusercontent.com/u/12677113?u=0094b361933133ea2af1ee342805b7777fe5fb6a&v=4&size=48)](/jessesuen)[jessesuen](https://github.com/jessesuen)opened [on Jul 26, 2018](https://github.com/argoproj/argo-cd/issues/470#issue-345036909)

We currently treat secrets the same as any other k8s object, displaying the YAML/JSON contents in the UI. But secret values need to be redacted or a separate RBAC rule to view them.

## Metadata

### Assignees

* [![@alexmt](https://avatars.githubusercontent.com/u/426437?s=64&u=fa4394a0bc2d8d083d91a7f31efdfb73a21cb9eb&v=4)alexmt](/alexmt)
### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

* [0.9](https://github.com/argoproj/argo-cd/milestone/9)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b8092439_20250124_133100.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fpull%2F3088)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fpull%2F3088)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=argoproj%2Fargo-cd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-cd](/argoproj/argo-cd)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-cd) You must be signed in to change notification settings
* [Fork
  5.7k](/login?return_to=%2Fargoproj%2Fargo-cd)
* [Star
   18.5k](/login?return_to=%2Fargoproj%2Fargo-cd)

* [Code](/argoproj/argo-cd)
* [Issues
  3.1k](/argoproj/argo-cd/issues)
* [Pull requests
  485](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects
  5](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

Additional navigation options

* [Code](/argoproj/argo-cd)
* [Issues](/argoproj/argo-cd/issues)
* [Pull requests](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fargoproj%2Fargo-cd%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fargoproj%2Fargo-cd%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix: reduct secret values of manifests stored in git #3088

 Merged

[alexmt](/alexmt)
merged 1 commit into
[argoproj:master](/argoproj/argo-cd/tree/master "argoproj/argo-cd:master")
from
[alexmt:redact-manifests-secrets](/alexmt/argo-cd/tree/redact-manifests-secrets "alexmt/argo-cd:redact-manifests-secrets")

Feb 7, 2020

 Merged

# [fix: reduct secret values of manifests stored in git](#top) #3088

[alexmt](/alexmt)
merged 1 commit into
[argoproj:master](/argoproj/argo-cd/tree/master "argoproj/argo-cd:master")
from
[alexmt:redact-manifests-secrets](/alexmt/argo-cd/tree/redact-manifests-secrets "alexmt/argo-cd:redact-manifests-secrets")

Feb 7, 2020

[Conversation
3](/argoproj/argo-cd/pull/3088)
[Commits
1](/argoproj/argo-cd/pull/3088/commits)
[Checks
0](/argoproj/argo-cd/pull/3088/checks)
[Files changed](/argoproj/argo-cd/pull/3088/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![alexmt](https://avatars.githubusercontent.com/u/426437?s=60&v=4)](/alexmt)

Copy link

Collaborator

### @alexmt **[alexmt](/alexmt)** commented [Feb 7, 2020](#issue-561360120)

Checklist:

* Either (a) I've created an [enhancement proposal](https://github.com/argoproj/argo-cd/issues/new/choose) and discussed it with the community, (b) this is a bug fix, or (c) this does not need to be in the release notes.
* The title of the PR states what changed and the related issues number (used for the release note).
* I've updated both the CLI and UI to expose my feature, or I plan to submit a second PR with them.
* Optional. My organization is added to the README.
* I've signed the CLA and my build is green ([troubleshooting builds](https://argoproj.github.io/argo-cd/developer-guide/ci/)).

Sorry, something went wrong.

All reactions

`[fix: reduct secret values of manifests stored in git](/argoproj/argo-cd/pull/3088/commits/80751397c420d402d0e6315966f95329eb5d3285 "fix: reduct secret values of manifests stored in git")`

`[8075139](/argoproj/argo-cd/pull/3088/commits/80751397c420d402d0e6315966f95329eb5d3285)`

 [![@alexmt](https://avatars.githubusercontent.com/u/426437?s=40&u=fa4394a0bc2d8d083d91a7f31efdfb73a21cb9eb&v=4)](/alexmt)
[alexmt](/alexmt)
requested a review
from [jessesuen](/jessesuen)
[February 7, 2020 01:02](#event-3016025935)

[![@codecov](https://avatars.githubusercontent.com/in/254?s=80&v=4)](/apps/codecov)

Copy link

### **[codecov](/apps/codecov) bot** commented [Feb 7, 2020](#issuecomment-583190772) • edited Loading

|  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=h1) Report Merging [#3088](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=desc) into [master](https://codecov.io/gh/argoproj/argo-cd/commit/a1afe44066fcd0a0ab90a02a23177164bbad42cf?src=pr&el=desc) will **decrease** coverage by `0.02%`. The diff coverage is `0%`.  [Impacted file tree graph](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=tree)  ``` @@            Coverage Diff            @@ ##           master   #3088      +/-   ## ========================================= - Coverage   38.33%   38.3%   -0.03%      =========================================   Files         168     168                 Lines       18189   18202      +13        Branches      272     272               =========================================   Hits         6973    6973               - Misses      10342   10355      +13        Partials      874     874 ```  | [Impacted Files](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=tree) | Coverage Δ |  | | --- | --- | --- | | [server/application/application.go](https://codecov.io/gh/argoproj/argo-cd/pull/3088/diff?src=pr&el=tree#diff-c2VydmVyL2FwcGxpY2F0aW9uL2FwcGxpY2F0aW9uLmdv) | `26.13% <0%> (-0.41%)` | ⬇️ |   ---   [Continue to review full report at Codecov](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=continue).  **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta) `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` Powered by [Codecov](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=footer). Last update [a1afe44...8075139](https://codecov.io/gh/argoproj/argo-cd/pull/3088?src=pr&el=lastupdated). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments). |

All reactions

Sorry, something went wrong.

[![dthomson25](https://avatars.githubusercontent.com/u/8616845?s=60&v=4)](/dthomson25)

**[dthomson25](/dthomson25)**
approved these changes
[Feb 7, 2020](#pullrequestreview-355498411)

 [View reviewed changes](/argoproj/argo-cd/pull/3088/files/80751397c420d402d0e6315966f95329eb5d3285)

Copy link

Member

### @dthomson25 **[dthomson25](/dthomson25)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM

Sorry, something went wrong.

All reactions

[![@alexmt](https://avatars.githubusercontent.com/u/426437?s=40&u=fa4394a0bc2d8d083d91a7f31efdfb73a21cb9eb&v=4)](/alexmt)
[alexmt](/alexmt)
merged commit [`916d4ae`](/argoproj/argo-cd/commit/916d4aed5775fead4ab75f47c1d352cd0e73b815)
into
argoproj:master

[Feb 7, 2020](https://github.com/argoproj/argo-cd/pull/3088#event-3019449647)

[![@Eriner](https://avatars.githubusercontent.com/u/6919167?s=80&u=ce615e00b7b251254802cdb74bf8d4da8eff8856&v=4)](/Eriner)

Copy link

Contributor

### **[Eriner](/Eriner)** commented [Feb 10, 2020](#issuecomment-583958753)

| MITRE has assigned `CVE-2018-21034` for this issue. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fpull%2F3088)

Reviewers

[![@dthomson25](https://avatars.githubusercontent.com/u/8616845?s=40&v=4)](/dthomson25) [dthomson25](/dthomson25)

dthomson25 approved these changes

[![@jessesuen](https://avatars.githubusercontent.com/u/12677113?s=40&v=4)](/jessesuen) [jessesuen](/jessesuen)

 Awaiting requested review from jessesuen

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@alexmt](https://avatars.githubusercontent.com/u/426437?s=52&v=4)](/alexmt) [![@Eriner](https://avatars.githubusercontent.com/u/6919167?s=52&v=4)](/Eriner) [![@dthomson25](https://avatars.githubusercontent.com/u/8616845?s=52&v=4)](/dthomson25)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d7d1d9ab_20250124_133058.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fblob%2Fa1afe44066fcd0a0ab90a02a23177164bbad42cf%2Futil%2Fdiff%2Fdiff.go)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fblob%2Fa1afe44066fcd0a0ab90a02a23177164bbad42cf%2Futil%2Fdiff%2Fdiff.go)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=argoproj%2Fargo-cd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-cd](/argoproj/argo-cd)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-cd) You must be signed in to change notification settings
* [Fork
  5.7k](/login?return_to=%2Fargoproj%2Fargo-cd)
* [Star
   18.5k](/login?return_to=%2Fargoproj%2Fargo-cd)

* [Code](/argoproj/argo-cd)
* [Issues
  3.1k](/argoproj/argo-cd/issues)
* [Pull requests
  485](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects
  5](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

Additional navigation options

* [Code](/argoproj/argo-cd)
* [Issues](/argoproj/argo-cd/issues)
* [Pull requests](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

## Files

 a1afe44
## Breadcrumbs

1. [argo-cd](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf)
2. /[util](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util)
3. /[diff](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util/diff)
/
# diff.go

Copy path Blame  Blame
## Latest commit

## History

[History](/argoproj/argo-cd/commits/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util/diff/diff.go)559 lines (523 loc) · 16.8 KB a1afe44
## Breadcrumbs

1. [argo-cd](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf)
2. /[util](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util)
3. /[diff](/argoproj/argo-cd/tree/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util/diff)
/
# diff.go

Top
## File metadata and controls

* Code
* Blame

559 lines (523 loc) · 16.8 KB[Raw](https://github.com/argoproj/argo-cd/raw/a1afe44066fcd0a0ab90a02a23177164bbad42cf/util/diff/diff.go)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559package diff
import ( "encoding/json" "errors" "fmt" "io/ioutil" "os" "os/exec" "path" "reflect"
 jsonpatch "github.com/evanphx/json-patch" "github.com/ghodss/yaml" "github.com/google/shlex" log "github.com/sirupsen/logrus" "github.com/yudai/gojsondiff" "github.com/yudai/gojsondiff/formatter" corev1 "k8s.io/api/core/v1" "k8s.io/apimachinery/pkg/apis/meta/v1/unstructured" "k8s.io/apimachinery/pkg/runtime" "k8s.io/apimachinery/pkg/util/jsonmergepatch" "k8s.io/apimachinery/pkg/util/strategicpatch" "k8s.io/client-go/kubernetes/scheme" "k8s.io/kubernetes/pkg/apis/core"
 jsonutil "github.com/argoproj/argo-cd/util/json")
type DiffResult struct { // Deprecated: Use PredictedLive and NormalizedLive instead Diff gojsondiff.Diff Modified bool PredictedLive []byte NormalizedLive []byte}
type DiffResultList struct { Diffs []DiffResult Modified bool}
type Normalizer interface { Normalize(un \*unstructured.Unstructured) error}
// Diff performs a diff on two unstructured objects. If the live object happens to have a// "kubectl.kubernetes.io/last-applied-configuration", then perform a three way diff.func Diff(config, live \*unstructured.Unstructured, normalizer Normalizer) (\*DiffResult, error) { if config != nil { config = remarshal(config) Normalize(config, normalizer) } if live != nil { live = remarshal(live) Normalize(live, normalizer) } orig := GetLastAppliedConfigAnnotation(live) if orig != nil && config != nil { Normalize(orig, normalizer) dr, err := ThreeWayDiff(orig, config, live) if err == nil { return dr, nil } log.Debugf("three-way diff calculation failed: %v. Falling back to two-way diff", err) } return TwoWayDiff(config, live)}
func getLegacyTwoWayDiff(config, live \*unstructured.Unstructured) gojsondiff.Diff { var configObj, liveObj map[string]interface{} if config != nil { config = removeNamespaceAnnotation(config) configObj = config.Object } if live != nil { liveObj = jsonutil.RemoveMapFields(configObj, live.Object) } return gojsondiff.New().CompareObjects(liveObj, configObj)}
// TwoWayDiff performs a three-way diff and uses specified config as a recently applied configfunc TwoWayDiff(config, live \*unstructured.Unstructured) (\*DiffResult, error) { if live != nil && config != nil { return ThreeWayDiff(config, config.DeepCopy(), live) } else if live != nil { liveData, err := json.Marshal(live) if err != nil { return nil, err } return &DiffResult{Modified: false, Diff: getLegacyTwoWayDiff(config, live), NormalizedLive: liveData, PredictedLive: []byte("null")}, nil } else if config != nil { predictedLiveData, err := json.Marshal(config.Object) if err != nil { return nil, err } return &DiffResult{Modified: true, NormalizedLive: []byte("null"), PredictedLive: predictedLiveData, Diff: getLegacyTwoWayDiff(config, live)}, nil } else { return nil, errors.New("both live and config are null objects") }}
// ThreeWayDiff performs a diff with the understanding of how to incorporate the// last-applied-configuration annotation in the diff.// Inputs are assumed to be stripped of type informationfunc ThreeWayDiff(orig, config, live \*unstructured.Unstructured) (\*DiffResult, error) { orig = removeNamespaceAnnotation(orig) config = removeNamespaceAnnotation(config)
 // Remove defaulted fields from the live object. // This subtracts any extra fields in the live object which are not present in last-applied-configuration. // This is needed to perform a fair comparison when we send the objects to gojsondiff // TODO: Remove line below to fix https://github.com/argoproj/argo-cd/issues/2865 and add special case for StatefulSet live = &unstructured.Unstructured{Object: jsonutil.RemoveMapFields(orig.Object, live.Object)}
 // 1. calculate a 3-way merge patch patchBytes, versionedObject, err := threeWayMergePatch(orig, config, live) if err != nil { return nil, err }
 // 2. get expected live object by applying the patch against the live object liveBytes, err := json.Marshal(live) if err != nil { return nil, err }
 var predictedLiveBytes []byte if versionedObject != nil { predictedLiveBytes, err = strategicpatch.StrategicMergePatch(liveBytes, patchBytes, versionedObject) if err != nil { return nil, err } } else { predictedLiveBytes, err = jsonpatch.MergePatch(liveBytes, patchBytes) if err != nil { return nil, err } }
 predictedLive := &unstructured.Unstructured{} err = json.Unmarshal(predictedLiveBytes, predictedLive) if err != nil { return nil, err }
 // 3. compare live and expected live object dr := DiffResult{ PredictedLive: predictedLiveBytes, NormalizedLive: liveBytes, Modified: string(predictedLiveBytes) != string(liveBytes), // legacy diff for backward compatibility Diff: gojsondiff.New().CompareObjects(live.Object, predictedLive.Object), } return &dr, nil}
// stripTypeInformation strips any type information (e.g. float64 vs. int) from the unstructured// object by remarshalling the object. This is important for diffing since it will cause godiff// to report a false difference.func stripTypeInformation(un \*unstructured.Unstructured) \*unstructured.Unstructured { unBytes, err := json.Marshal(un) if err != nil { panic(err) } var newUn unstructured.Unstructured err = json.Unmarshal(unBytes, &newUn) if err != nil { panic(err) } return &newUn}
// removeNamespaceAnnotation remove the namespace and an empty annotation map from the metadata.// The namespace field is present in live (namespaced) objects, but not necessarily present in// config or last-applied. This results in a diff which we don't care about. We delete the two so// that the diff is more relevant.func removeNamespaceAnnotation(orig \*unstructured.Unstructured) \*unstructured.Unstructured { orig = orig.DeepCopy() if metadataIf, ok := orig.Object["metadata"]; ok { metadata := metadataIf.(map[string]interface{}) delete(metadata, "namespace") if annotationsIf, ok := metadata["annotations"]; ok { shouldDelete := false if annotationsIf == nil { shouldDelete = true } else { annotation := annotationsIf.(map[string]interface{}) if len(annotation) == 0 { shouldDelete = true } } if shouldDelete { delete(metadata, "annotations") } } } return orig}
func threeWayMergePatch(orig, config, live \*unstructured.Unstructured) ([]byte, runtime.Object, error) { origBytes, err := json.Marshal(orig.Object) if err != nil { return nil, nil, err } configBytes, err := json.Marshal(config.Object) if err != nil { return nil, nil, err } liveBytes, err := json.Marshal(live.Object) if err != nil { return nil, nil, err } if versionedObject, err := scheme.Scheme.New(orig.GroupVersionKind()); err == nil { lookupPatchMeta, err := strategicpatch.NewPatchMetaFromStruct(versionedObject) if err != nil { return nil, nil, err } patch, err := strategicpatch.CreateThreeWayMergePatch(origBytes, configBytes, liveBytes, lookupPatchMeta, true) if err != nil { return nil, nil, err } return patch, versionedObject, nil } else { patch, err := jsonmergepatch.CreateThreeWayJSONMergePatch(origBytes, configBytes, liveBytes) if err != nil { return nil, nil, err } return patch, nil, nil }}
func GetLastAppliedConfigAnnotation(live \*unstructured.Unstructured) \*unstructured.Unstructured { if live == nil { return nil } annots := live.GetAnnotations() if annots == nil { return nil } lastAppliedStr, ok := annots[corev1.LastAppliedConfigAnnotation] if !ok { return nil } var obj unstructured.Unstructured err := json.Unmarshal([]byte(lastAppliedStr), &obj) if err != nil { log.Warnf("Failed to unmarshal %s in %s", core.LastAppliedConfigAnnotation, live.GetName()) return nil } return &obj}
// DiffArray performs a diff on a list of unstructured objects. Objects are expected to match// environmentsfunc DiffArray(configArray, liveArray []\*unstructured.Unstructured, normalizer Normalizer) (\*DiffResultList, error) { numItems := len(configArray) if len(liveArray) != numItems { return nil, fmt.Errorf("left and right arrays have mismatched lengths") }
 diffResultList := DiffResultList{ Diffs: make([]DiffResult, numItems), } for i := 0; i < numItems; i++ { config := configArray[i] live := liveArray[i] diffRes, err := Diff(config, live, normalizer) if err != nil { return nil, err } diffResultList.Diffs[i] = \*diffRes if diffRes.Modified { diffResultList.Modified = true } } return &diffResultList, nil}
// JSONFormat returns the diff as a JSON stringfunc (d \*DiffResult) JSONFormat() (string, error) { if !d.Diff.Modified() { return "", nil } jsonFmt := formatter.NewDeltaFormatter() return jsonFmt.Format(d.Diff)}
func Normalize(un \*unstructured.Unstructured, normalizer Normalizer) { if un == nil { return }
 // creationTimestamp is sometimes set to null in the config when exported (e.g. SealedSecrets) // Removing the field allows a cleaner diff. unstructured.RemoveNestedField(un.Object, "metadata", "creationTimestamp")
 gvk := un.GroupVersionKind() if gvk.Group == "" && gvk.Kind == "Secret" { NormalizeSecret(un) } else if gvk.Group == "rbac.authorization.k8s.io" && (gvk.Kind == "ClusterRole" || gvk.Kind == "Role") { normalizeRole(un) }
 if normalizer != nil { err := normalizer.Normalize(un) if err != nil { log.Warnf("Failed to normalize %s/%s/%s: %v", un.GroupVersionKind(), un.GetNamespace(), un.GetName(), err) } }}
// NormalizeSecret mutates the supplied object and encodes stringData to data, and converts nils to// empty strings. If the object is not a secret, or is an invalid secret, then returns the same object.func NormalizeSecret(un \*unstructured.Unstructured) { if un == nil { return } gvk := un.GroupVersionKind() if gvk.Group != "" || gvk.Kind != "Secret" { return } var secret corev1.Secret err := runtime.DefaultUnstructuredConverter.FromUnstructured(un.Object, &secret) if err != nil { return } // We normalize nils to empty string to handle: https://github.com/argoproj/argo-cd/issues/943 for k, v := range secret.Data { if len(v) == 0 { secret.Data[k] = []byte("") } } if len(secret.StringData) > 0 { if secret.Data == nil { secret.Data = make(map[string][]byte) } for k, v := range secret.StringData { secret.Data[k] = []byte(v) } delete(un.Object, "stringData") } newObj, err := runtime.DefaultUnstructuredConverter.ToUnstructured(&secret) if err != nil { log.Warnf("object unable to convert from secret: %v", err) return } if secret.Data != nil { err = unstructured.SetNestedField(un.Object, newObj["data"], "data") if err != nil { log.Warnf("failed to set secret.data: %v", err) return } }}
// normalizeRole mutates the supplied Role/ClusterRole and sets rules to null if it is an empty listfunc normalizeRole(un \*unstructured.Unstructured) { if un == nil { return } gvk := un.GroupVersionKind() if gvk.Group != "rbac.authorization.k8s.io" || (gvk.Kind != "Role" && gvk.Kind != "ClusterRole") { return } rulesIf, ok := un.Object["rules"] if !ok { return } rules, ok := rulesIf.([]interface{}) if !ok { return } if rules != nil && len(rules) == 0 { un.Object["rules"] = nil }}
// CreateTwoWayMergePatch is a helper to construct a two-way merge patch from objects (instead of bytes)func CreateTwoWayMergePatch(orig, new, dataStruct interface{}) ([]byte, bool, error) { origBytes, err := json.Marshal(orig) if err != nil { return nil, false, err } newBytes, err := json.Marshal(new) if err != nil { return nil, false, err } patch, err := strategicpatch.CreateTwoWayMergePatch(origBytes, newBytes, dataStruct) if err != nil { return nil, false, err } return patch, string(patch) != "{}", nil}
// HideSecretData replaces secret data values in specified target, live secrets and in last applied configuration of live secret with stars. Also preserves differences between// target, live and last applied config values. E.g. if all three are equal the values would be replaced with same number of stars. If all the are different then number of stars// in replacement should be different.func HideSecretData(target \*unstructured.Unstructured, live \*unstructured.Unstructured) (\*unstructured.Unstructured, \*unstructured.Unstructured, error) { var orig \*unstructured.Unstructured if live != nil { orig = GetLastAppliedConfigAnnotation(live) live = live.DeepCopy() } if target != nil { target = target.DeepCopy() }
 keys := map[string]bool{} for \_, obj := range []\*unstructured.Unstructured{target, live, orig} { if obj == nil { continue } NormalizeSecret(obj) if data, found, err := unstructured.NestedMap(obj.Object, "data"); found && err == nil { for k := range data { keys[k] = true } } }
 for k := range keys { // we use "+" rather than the more common "\*" nextReplacement := "++++++++" valToReplacement := make(map[string]string) for \_, obj := range []\*unstructured.Unstructured{target, live, orig} { var data map[string]interface{} if obj != nil { var err error data, \_, err = unstructured.NestedMap(obj.Object, "data") if err != nil { return nil, nil, err } } if data == nil { data = make(map[string]interface{}) } valData, ok := data[k] if !ok { continue } val := toString(valData) replacement, ok := valToReplacement[val] if !ok { replacement = nextReplacement nextReplacement = nextReplacement + "++++" valToReplacement[val] = replacement } data[k] = replacement err := unstructured.SetNestedField(obj.Object, data, "data") if err != nil { return nil, nil, err } } } if live != nil && orig != nil { annotations := live.GetAnnotations() if annotations == nil { annotations = make(map[string]string) } lastAppliedData, err := json.Marshal(orig) if err != nil { return nil, nil, err } annotations[core.LastAppliedConfigAnnotation] = string(lastAppliedData) live.SetAnnotations(annotations) } return target, live, nil}
func toString(val interface{}) string { if val == nil { return "" } return fmt.Sprintf("%s", val)}
// remarshal checks resource kind and version and re-marshal using corresponding struct custom marshaller.// This ensures that expected resource state is formatter same as actual resource state in kubernetes// and allows to find differences between actual and target states more accurately.// Remarshalling also strips any type information (e.g. float64 vs. int) from the unstructured// object. This is important for diffing since it will cause godiff to report a false difference.func remarshal(obj \*unstructured.Unstructured) \*unstructured.Unstructured { obj = stripTypeInformation(obj) data, err := json.Marshal(obj) if err != nil { panic(err) } gvk := obj.GroupVersionKind() item, err := scheme.Scheme.New(obj.GroupVersionKind()) if err != nil { // this is common. the scheme is not registered log.Debugf("Could not create new object of type %s: %v", gvk, err) return obj } // This will drop any omitempty fields, perform resource conversion etc... unmarshalledObj := reflect.New(reflect.TypeOf(item).Elem()).Interface() err = json.Unmarshal(data, &unmarshalledObj) if err != nil { // User may have specified an invalid spec in git. Return original object log.Warnf("Could not unmarshal to object of type %s: %v", gvk, err) return obj } unstrBody, err := runtime.DefaultUnstructuredConverter.ToUnstructured(unmarshalledObj) if err != nil { log.Warnf("Could not unmarshal to object of type %s: %v", gvk, err) return obj } // remove all default values specified by custom formatter (e.g. creationTimestamp) unstrBody = jsonutil.RemoveMapFields(obj.Object, unstrBody) return &unstructured.Unstructured{Object: unstrBody}}
// PrintDiff prints a diff between two unstructured objects to stdout using an external diff utility// Honors the diff utility set in the KUBECTL\_EXTERNAL\_DIFF environment variablefunc PrintDiff(name string, live \*unstructured.Unstructured, target \*unstructured.Unstructured) error { tempDir, err := ioutil.TempDir("", "argocd-diff") if err != nil { return err } targetFile := path.Join(tempDir, name) targetData := []byte("") if target != nil { targetData, err = yaml.Marshal(target) if err != nil { return err } } err = ioutil.WriteFile(targetFile, targetData, 0644) if err != nil { return err } liveFile := path.Join(tempDir, fmt.Sprintf("%s-live.yaml", name)) liveData := []byte("") if live != nil { liveData, err = yaml.Marshal(live) if err != nil { return err } } err = ioutil.WriteFile(liveFile, liveData, 0644) if err != nil { return err } cmdBinary := "diff" var args []string if envDiff := os.Getenv("KUBECTL\_EXTERNAL\_DIFF"); envDiff != "" { parts, err := shlex.Split(envDiff) if err != nil { return err } cmdBinary = parts[0] args = parts[1:] } cmd := exec.Command(cmdBinary, append(args, liveFile, targetFile)...) cmd.Stderr = os.Stderr cmd.Stdout = os.Stdout return cmd.Run()}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


