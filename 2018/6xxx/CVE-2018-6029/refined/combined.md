=== Content from blackwolfsec.cc_2d00b9a5_20250125_132436.html ===


[BlackWolf](/)
# BlackWolfsec

* [首页](/)
* [分类](/categories)
* [归档](/archives)
* [标签](/tags)
* [我的简历](/about)
* 搜索

## NoneCMS1.3版本SSRF漏洞

发表于
2018-01-23

|

分类于
[代码审计](/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)

|

## 0x00前言

NoneCMS添加文章处过滤不严存在SSRF漏洞

## 0x01漏洞分析

| ``` 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152 ``` | ``` #application/admin/controller/Article.phppublic function copy()    {        if (request()->isAjax()) {            $url = input('post.url');            $cid = input('post.cid');            if (!$url || !substr_count($url, 'csdn')) {                exit(json_encode(['status' => 0, 'msg' => '请输入csdn博客文章地址', 'url' => '']));            }            if (!$cid) {                exit(json_encode(['status' => 0, 'msg' => '请先选择分类', 'url' => '']));            }            try {                \phpQuery::newDocumentFile($url);                $title = pq('.link_title a')->text();                if (!$title) {                    $title = pq('.list_c_t a')->text();                }                if (!$title) {                    $title = pq('h1.csdn_top')->text();                }                $content = pq('#article_content')->text();                //如果抓取不到主内容                if (!$content) {                    throw new Exception("文章不存在或禁止爬虫");                }                $params['cid'] = $cid;                $params['content'] = $content;                $params['title'] = $title;                $params['publishtime'] = '';                $params['description'] = trim(strip_tags($content));                $params['copyfrom'] = $url;                $article = new articleModel();                if ($article->data($params,true)->save()) {                    return ['status' => 1, 'msg' => '转载成功', 'url' => url('article/index', ['id' => $cid])];                } else {                    return ['status' => 0, 'msg' => '转载失败', 'url' => ''];                }            } catch (Exception $e) {                return ['status' => 0, 'msg' => '添加失败：' . $e->getMessage(), 'url' => ''];            }        } else {            return $this->fetch();        }    } ``` |
| --- | --- |

1.当请求copy方法时首先判断请求方式为Ajax，然后检测要求存在url参数,并且url中包含csdn字符串即可（很容易利用`?csdn`绕过）。
2.调用`\phpQuery::newDocumentFile`，函数内容如下：

| ``` 123456 ``` | ``` public static function newDocumentFile($file, $contentType = null) {	$documentID = self::createDocumentWrapper(		file_get_contents($file), $contentType	);	return new phpQueryObject($documentID);} ``` |
| --- | --- |

请求目标url,内部调用了file\_get\_contents请求。
3.由此可见，存在ssrf漏洞。

## 0x02POC:

![payload](http://blackwolfsec.cc/static/picture/nonecms_ssrf_1.png)

目标服务器成功收到请求

![ssrf](http://blackwolfsec.cc/static/picture/nonecms_ssrf_2.png)

## 0x03小结

需要管理员登录后才能利用，且由于请求目标不是CSDN，会导致copy函数后面的处理获取不到有效数据，会提示“服务器出错”，但是实际请求已经成功发送出去了。

## 0x04修复建议

利用parse\_url提取URL的域名是否属于CSDN。

[# PHP](/tags/PHP/)
[# 代码审计](/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)
[# CVE](/tags/CVE/)

[NoneCMS后台任意文件删除](/2018/01/22/Nonecms/ "NoneCMS后台任意文件删除")

[某CMS5.X版本GETSHELL漏洞合集-五连杀](/2018/03/13/5_x_getshell/ "某CMS5.X版本GETSHELL漏洞合集-五连杀")

* 文章目录
* 站点概览

![邮箱地址：YWRtaW5AYmxhY2t3b2xmc2VjLmNj](/static/picture/logo.jpg)
[53
日志](/archives)

[10
分类](/categories/index.html)

[51
标签](/tags/index.html)

[RSS](/atom.xml)

[安全圈](http://anquanquan.info "安全圈")

[小黑屋](http://das.scusec.org/ "小黑屋")

[ourren](http://www.ourren.com/ "ourren")

[零の杂货铺](http://phantom0301.cc/ "零の杂货铺")

1. [1. 0x00前言](#0x00前言)
2. [2. 0x01漏洞分析](#0x01漏洞分析)
3. [3. 0x02POC:](#0x02POC)
4. [4. 0x03小结](#0x03小结)
5. [5. 0x04修复建议](#0x04修复建议)

© 2016 -
2020

邮箱地址：YWRtaW5AYmxhY2t3b2xmc2VjLmNj

由 [Hexo](https://hexo.io) 强力驱动

主题 -
[NexT.Mist](http://blackwolfsec.cc/)


