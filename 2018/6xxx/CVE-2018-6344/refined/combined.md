=== Content from bugs.chromium.org_48b8f3fd_20250126_025027.html ===



=== Content from googleprojectzero.blogspot.com_e78f6da0_20250124_183916.html ===


# [Project Zero](https://googleprojectzero.blogspot.com/)

News and updates from the Project Zero team at Google

## Tuesday, December 11, 2018

### Adventures in Video Conferencing Part 3: The Even Wilder World of WhatsApp

Posted by Natalie Silvanovich, Project Zero

WhatsApp is another application that supports video conferencing that does not use WebRTC as its core implementation. Instead, it uses [PJSIP](https://www.pjsip.org/), which contains some WebRTC code, but also contains a substantial amount of other code, and predates the WebRTC project. I fuzzed this implementation to see if it had similar results to WebRTC and FaceTime.
# Fuzzing Set-up

PJSIP is open source, so it was easy to identify the PJSIP code in the Android WhatsApp binary (libwhatsapp.so). Since PJSIP uses the open source library [libsrtp](https://github.com/cisco/libsrtp), I started off by opening the binary in IDA and searching for the string srtp\_protect, the name of the function libsrtp uses for encryption. This led to a log entry emitted by a function that looked like srtp\_protect. There was only one function in the binary that called this function, and called memcpy soon before the call. Some log entries before the call contained the file name srtp\_transport.c, which exists in the PJSIP [repository](http://svn.pjsip.org/repos/pjproject/tags/1.2/pjmedia/src/pjmedia/transport_srtp.c). The log entries in the WhatsApp binary say that the function being called is transport\_send\_rtp2 and the PJSIP source only has a function called transport\_send\_rtp, but it looks similar to the function calling srtp\_protect in WhatsApp, in that it has the same number of calls before and after the memcpy. Assuming that the code in WhatsApp is some variation of that code, the memcpy copies the entire unencrypted packet right before it is encrypted.

Hooking this memcpy seemed like a possible way to fuzz WhatsApp video calling. I started off by hooking memcpy for the entire app using a tool called [Frida](https://www.frida.re/docs/android/). This tool can easily hook native function in Android applications, and I was able to see calls to memcpy from WhatsApp within minutes. Unfortunately though, video conferencing is very performance sensitive, and a delay sending video packets actually influences the contents of the next packet, so hooking every memcpy call didn’t seem practical. Instead, I decided to change the single memcpy to point to a function I wrote.

I started off by writing a function in assembly that loaded a library from the filesystem using dlopen, retrieved a symbol by calling dlsym and then called into the library. Frida was very useful in debugging this, as it could hook calls to dlopen and dlsym to make sure they were being called correctly. I overwrote a function in the WhatsApp GIF transcoder with this function, as it is only used in sending text messages, which I didn’t plan to do with this altered version. I then set the memcpy call to point to this function instead of memcpy, using this online ARM branch [finder](http://armconverter.com/branchfinder/).

| sub\_2F8CC MOV             X21, X30 MOV             X22, X0 MOV             X23, X1 MOV             X20, X2 MOV             X1, #1 ADRP            X0, #aDataDataCom\_wh@PAGE ; "/data/data/com.whatsapp/libn.so" ADD             X0, X0, #aDataDataCom\_wh@PAGEOFF ; "/data/data/com.whatsapp/libn.so" BL              .dlopen ADRP            X1, #aApthread@PAGE ; "apthread" ADD             X1, X1, #aApthread@PAGEOFF ; "apthread" BL              .dlsym MOV             X8, X0 MOV             X0, X22 MOV             X1, X23 MOV             X2, X20 NOP BLR             X8 MOV             X30, X21 RET |
| --- |

The library loading function

I then wrote a library for Android which had the same parameters as memcpy, but fuzzed and copied the buffer instead of just copying it, and put it on the filesystem where it would be loaded by dlopen. I then tried making a WhatsApp call with this setup. The video call looked like it was being fuzzed and crashed in roughly fifteen minutes.
# Replay Set-up

To replay the packets I added logging to the library, so that each buffer that was altered would also be saved to a file. Then I created a second library that copied the logged packets into the buffer being copied instead of altering it. This required modifying the WhatsApp binary slightly, because the logged packet will usually not be the same size as the packet currently being sent. I changed the length of the hooked memcpy to be passed by reference instead of by value, and then had the library change the length to the length of the logged packet. This changed the value of the length so that it would be correct for the call to srtp\_protect. Luckily, the buffer that the packet is copied into is a fixed length, so there is no concern that a valid packet will overflow the buffer length. This is a common design pattern in RTP processing that improves performance by reducing length checks. It was also helpful in modifying FaceTime to replay packets of varying length, as described in the previous post.

This initial replay setup did not work, and looking at the logged packets, it turned out that WhatsApp uses four streams with different SSRCs for video conferencing (possibly one for video, one for audio, one for synchronization and one for good luck). The streams each had only one payload type, and they were all different, so it was fairly easy to map each SSRC to its stream. So I modified the replay library to determine the current SSRC for each stream based on the payload types of incoming packets, and then to replace the SSRC of the replayed packets with the correct one based on their payload type. This reliably replayed a WhatsApp call. I was then able to fuzz and reproduce crashes on WhatsApp.
# Results

Using this setup, I reported one heap corruption [issue](https://bugs.chromium.org/p/project-zero/issues/detail?id=1654) on WhatsApp, CVE-2018-6344. This issue has since been fixed. After this issue was resolved, fuzzing did not yield any additional crashes with security impact, and we moved on to other methodologies. Part 4 will describe our other (unsuccessful) attempts to find vulnerabilities in WhatsApp.

Posted by
Anonymous

at

[9:42 AM](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-3.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=4838136820032157985&postID=2508285266292582368&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=2508285266292582368&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=2508285266292582368&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=2508285266292582368&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=2508285266292582368&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=4838136820032157985&postID=2508285266292582368&target=pinterest "Share to Pinterest")

#### 1 comment:

1. ![](//www.blogger.com/img/blogger_logo_round_35.png)[Unknown](https://www.blogger.com/profile/13559387891613826269)[December 12, 2018 at 11:14 PM](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-3.html?showComment=1544685292034#c622633904281910425)

   I've been enjoying the series quite a bit. Out of curiosity, did you use the same fuzz function used in part 1?
   Do you have any thoughts the tradeoffs between writing a quick fuzzer than just randomizes data and something a little bit more advanced that might try certain magic values for something like this?

   Reply[Delete](https://www.blogger.com/delete-comment.g?blogID=4838136820032157985&postID=622633904281910425)Replies
   Reply

Add commentLoad more...

[Newer Post](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-4.html "Newer Post")

[Older Post](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-2.html "Older Post")

[Home](https://googleprojectzero.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](https://googleprojectzero.blogspot.com/feeds/2508285266292582368/comments/default)

## Search This Blog

|  |  |
| --- | --- |

## Pages

* [About Project Zero](https://googleprojectzero.blogspot.com/p/about-project-zero.html)
* [Working at Project Zero](https://googleprojectzero.blogspot.com/p/working-at-project-zero.html)
* [0day "In the Wild"](https://googleprojectzero.blogspot.com/p/0day.html)
* [0day Exploit Root Cause Analyses](https://googleprojectzero.github.io/0days-in-the-wild/rca.html)
* [Vulnerability Disclosure FAQ](https://googleprojectzero.blogspot.com/p/vulnerability-disclosure-faq.html)

## Archives

* ►
  [2024](https://googleprojectzero.blogspot.com/2024/)
  (12)
  + ►
    [December](https://googleprojectzero.blogspot.com/2024/12/)
    (3)
  + ►
    [November](https://googleprojectzero.blogspot.com/2024/11/)
    (2)
  + ►
    [October](https://googleprojectzero.blogspot.com/2024/10/)
    (2)
  + ►
    [June](https://googleprojectzero.blogspot.com/2024/06/)
    (3)
  + ►
    [April](https://googleprojectzero.blogspot.com/2024/04/)
    (2)

* ►
  [2023](https://googleprojectzero.blogspot.com/2023/)
  (11)
  + ►
    [November](https://googleprojectzero.blogspot.com/2023/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2023/10/)
    (1)
  + ►
    [September](https://googleprojectzero.blogspot.com/2023/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2023/08/)
    (4)
  + ►
    [April](https://googleprojectzero.blogspot.com/2023/04/)
    (1)
  + ►
    [March](https://googleprojectzero.blogspot.com/2023/03/)
    (1)
  + ►
    [January](https://googleprojectzero.blogspot.com/2023/01/)
    (2)

* ►
  [2022](https://googleprojectzero.blogspot.com/2022/)
  (17)
  + ►
    [December](https://googleprojectzero.blogspot.com/2022/12/)
    (1)
  + ►
    [November](https://googleprojectzero.blogspot.com/2022/11/)
    (3)
  + ►
    [October](https://googleprojectzero.blogspot.com/2022/10/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2022/08/)
    (1)
  + ►
    [June](https://googleprojectzero.blogspot.com/2022/06/)
    (3)
  + ►
    [May](https://googleprojectzero.blogspot.com/2022/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2022/04/)
    (3)
  + ►
    [March](https://googleprojectzero.blogspot.com/2022/03/)
    (2)
  + ►
    [February](https://googleprojectzero.blogspot.com/2022/02/)
    (1)
  + ►
    [January](https://googleprojectzero.blogspot.com/2022/01/)
    (1)

* ►
  [2021](https://googleprojectzero.blogspot.com/2021/)
  (24)
  + ►
    [December](https://googleprojectzero.blogspot.com/2021/12/)
    (2)
  + ►
    [October](https://googleprojectzero.blogspot.com/2021/10/)
    (3)
  + ►
    [September](https://googleprojectzero.blogspot.com/2021/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2021/08/)
    (1)
  + ►
    [June](https://googleprojectzero.blogspot.com/2021/06/)
    (1)
  + ►
    [May](https://googleprojectzero.blogspot.com/2021/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2021/04/)
    (3)
  + ►
    [March](https://googleprojectzero.blogspot.com/2021/03/)
    (1)
  + ►
    [February](https://googleprojectzero.blogspot.com/2021/02/)
    (1)
  + ►
    [January](https://googleprojectzero.blogspot.com/2021/01/)
    (10)

* ►
  [2020](https://googleprojectzero.blogspot.com/2020/)
  (36)
  + ►
    [December](https://googleprojectzero.blogspot.com/2020/12/)
    (2)
  + ►
    [November](https://googleprojectzero.blogspot.com/2020/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2020/10/)
    (2)
  + ►
    [September](https://googleprojectzero.blogspot.com/2020/09/)
    (4)
  + ►
    [August](https://googleprojectzero.blogspot.com/2020/08/)
    (5)
  + ►
    [July](https://googleprojectzero.blogspot.com/2020/07/)
    (8)
  + ►
    [June](https://googleprojectzero.blogspot.com/2020/06/)
    (2)
  + ►
    [April](https://googleprojectzero.blogspot.com/2020/04/)
    (3)
  + ►
    [February](https://googleprojectzero.blogspot.com/2020/02/)
    (4)
  + ►
    [January](https://googleprojectzero.blogspot.com/2020/01/)
    (5)

* ►
  [2019](https://googleprojectzero.blogspot.com/2019/)
  (27)
  + ►
    [December](https://googleprojectzero.blogspot.com/2019/12/)
    (2)
  + ►
    [November](https://googleprojectzero.blogspot.com/2019/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2019/10/)
    (2)
  + ►
    [September](https://googleprojectzero.blogspot.com/2019/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2019/08/)
    (11)
  + ►
    [May](https://googleprojectzero.blogspot.com/2019/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2019/04/)
    (3)
  + ►
    [March](https://googleprojectzero.blogspot.com/2019/03/)
    (2)
  + ►
    [February](https://googleprojectzero.blogspot.com/2019/02/)
    (2)
  + ►
    [January](https://googleprojectzero.blogspot.com/2019/01/)
    (2)

* ▼
  [2018](https://googleprojectzero.blogspot.com/2018/)
  (22)
  + ▼
    [December](https://googleprojectzero.blogspot.com/2018/12/)
    (7)
    - [On VBScript](https://googleprojectzero.blogspot.com/2018/12/on-vbscript.html)
    - [Searching statically-linked vulnerable library fun...](https://googleprojectzero.blogspot.com/2018/12/searching-statically-linked-vulnerable.html)
    - [Adventures in Video Conferencing Part 5: Where Do ...](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-5.html)
    - [Adventures in Video Conferencing Part 4: What Didn...](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-4.html)
    - [Adventures in Video Conferencing Part 3: The Even ...](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-3.html)
    - [Adventures in Video Conferencing Part 2: Fun with ...](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-2.html)
    - [Adventures in Video Conferencing Part 1: The Wild ...](https://googleprojectzero.blogspot.com/2018/12/adventures-in-video-conferencing-part-1.html)
  + ►
    [November](https://googleprojectzero.blogspot.com/2018/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2018/10/)
    (4)
  + ►
    [September](https://googleprojectzero.blogspot.com/2018/09/)
    (2)
  + ►
    [August](https://googleprojectzero.blogspot.com/2018/08/)
    (3)
  + ►
    [July](https://googleprojectzero.blogspot.com/2018/07/)
    (1)
  + ►
    [June](https://googleprojectzero.blogspot.com/2018/06/)
    (1)
  + ►
    [May](https://googleprojectzero.blogspot.com/2018/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2018/04/)
    (1)
  + ►
    [January](https://googleprojectzero.blogspot.com/2018/01/)
    (1)

* ►
  [2017](https://googleprojectzero.blogspot.com/2017/)
  (19)
  + ►
    [December](https://googleprojectzero.blogspot.com/2017/12/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2017/10/)
    (3)
  + ►
    [September](https://googleprojectzero.blogspot.com/2017/09/)
    (2)
  + ►
    [August](https://googleprojectzero.blogspot.com/2017/08/)
    (2)
  + ►
    [July](https://googleprojectzero.blogspot.com/2017/07/)
    (1)
  + ►
    [May](https://googleprojectzero.blogspot.com/2017/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2017/04/)
    (6)
  + ►
    [March](https://googleprojectzero.blogspot.com/2017/03/)
    (1)
  + ►
    [February](https://googleprojectzero.blogspot.com/2017/02/)
    (2)

* ►
  [2016](https://googleprojectzero.blogspot.com/2016/)
  (17)
  + ►
    [December](https://googleprojectzero.blogspot.com/2016/12/)
    (2)
  + ►
    [November](https://googleprojectzero.blogspot.com/2016/11/)
    (1)
  + ►
    [October](https://googleprojectzero.blogspot.com/2016/10/)
    (1)
  + ►
    [September](https://googleprojectzero.blogspot.com/2016/09/)
    (2)
  + ►
    [August](https://googleprojectzero.blogspot.com/2016/08/)
    (1)
  + ►
    [July](https://googleprojectzero.blogspot.com/2016/07/)
    (1)
  + ►
    [June](https://googleprojectzero.blogspot.com/2016/06/)
    (3)
  + ►
    [March](https://googleprojectzero.blogspot.com/2016/03/)
    (3)
  + ►
    [February](https://googleprojectzero.blogspot.com/2016/02/)
    (2)
  + ►
    [January](https://googleprojectzero.blogspot.com/2016/01/)
    (1)

* ►
  [2015](https://googleprojectzero.blogspot.com/2015/)
  (33)
  + ►
    [December](https://googleprojectzero.blogspot.com/2015/12/)
    (2)
  + ►
    [November](https://googleprojectzero.blogspot.com/2015/11/)
    (2)
  + ►
    [October](https://googleprojectzero.blogspot.com/2015/10/)
    (1)
  + ►
    [September](https://googleprojectzero.blogspot.com/2015/09/)
    (4)
  + ►
    [August](https://googleprojectzero.blogspot.com/2015/08/)
    (6)
  + ►
    [July](https://googleprojectzero.blogspot.com/2015/07/)
    (5)
  + ►
    [June](https://googleprojectzero.blogspot.com/2015/06/)
    (4)
  + ►
    [May](https://googleprojectzero.blogspot.com/2015/05/)
    (1)
  + ►
    [April](https://googleprojectzero.blogspot.com/2015/04/)
    (1)
  + ►
    [March](https://googleprojectzero.blogspot.com/2015/03/)
    (2)
  + ►
    [February](https://googleprojectzero.blogspot.com/2015/02/)
    (3)
  + ►
    [January](https://googleprojectzero.blogspot.com/2015/01/)
    (2)

* ►
  [2014](https://googleprojectzero.blogspot.com/2014/)
  (11)
  + ►
    [December](https://googleprojectzero.blogspot.com/2014/12/)
    (1)
  + ►
    [November](https://googleprojectzero.blogspot.com/2014/11/)
    (2)
  + ►
    [October](https://googleprojectzero.blogspot.com/2014/10/)
    (2)
  + ►
    [September](https://googleprojectzero.blogspot.com/2014/09/)
    (1)
  + ►
    [August](https://googleprojectzero.blogspot.com/2014/08/)
    (2)
  + ►
    [July](https://googleprojectzero.blogspot.com/2014/07/)
    (3)

|  |  |
| --- | --- |

|  |  |
| --- | --- |

Powered by [Blogger](https://www.blogger.com).


