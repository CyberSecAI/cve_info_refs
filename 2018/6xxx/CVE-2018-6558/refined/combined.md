=== Content from github.com_e0c89f96_20250125_220655.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fissues%2F77)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fissues%2F77)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=google%2Ffscrypt)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[fscrypt](/google/fscrypt)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Ffscrypt) You must be signed in to change notification settings
* [Fork
  98](/login?return_to=%2Fgoogle%2Ffscrypt)
* [Star
   907](/login?return_to=%2Fgoogle%2Ffscrypt)

* [Code](/google/fscrypt)
* [Issues
  39](/google/fscrypt/issues)
* [Pull requests
  2](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

Additional navigation options

* [Code](/google/fscrypt)
* [Issues](/google/fscrypt/issues)
* [Pull requests](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

# pam\_fscrypt messes up user groups during loginÂ #77

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[pam\_fscrypt messes up user groups during login](#top)#77Copy linkLabels[bug](https://github.com/google/fscrypt/issues?q=state%3Aopen%20label%3A%22bug%22)[![@stephan-gh](https://avatars.githubusercontent.com/u/3035868?u=322009e7d41adb145bdb6152bc5cbe9d5354797c&v=4&size=80)](/stephan-gh)
## Description

[![@stephan-gh](https://avatars.githubusercontent.com/u/3035868?u=322009e7d41adb145bdb6152bc5cbe9d5354797c&v=4&size=48)](/stephan-gh)[stephan-gh](https://github.com/stephan-gh)opened [on Jan 23, 2018](https://github.com/google/fscrypt/issues/77#issue-290941921)

I've added `pam_fscrypt` to `/etc/pam.d/system-auth` (on Arch Linux) as described in the README:

```
auth      required  pam_unix.so     try_first_pass nullok
auth      optional  pam_permit.so
auth      required  pam_env.so
auth      optional  pam_fscrypt.so

account   required  pam_unix.so
account   optional  pam_permit.so
account   required  pam_time.so

password  required  pam_unix.so     try_first_pass nullok sha512 shadow
password  optional  pam_permit.so
password  optional  pam_fscrypt.so

session   required  pam_limits.so
session   required  pam_unix.so
session   optional  pam_permit.so
session   optional  pam_fscrypt.so  drop_caches lock_policies

```

With `pam_fscrypt` enabled, I'm no longer in the `wheel` group after login for some reason, which means I can no longer use `sudo`. Instead, it adds me to the root group:

```
$ id
uid=1000(i3test) gid=1000(i3test) groups=1000(i3test),0(root)

```

With `session optional pam_fscrypt.so` commented out:

```
$ id
uid=1000(i3test) gid=1000(i3test) groups=1000(i3test),985(wheel)

```

Log:

```
login[434]: pam_unix(login:session): session opened for user i3test by LOGIN(uid=0)
pam_fscrypt[434]: OpenSession()
pam_fscrypt[434]: Session count for UID=1000 updated to 1
pam_fscrypt[434]: KeyctlLink(483117192, 57274768) = <nil>
pam_fscrypt[434]: Setting privileges to "i3test"
pam_fscrypt[434]: Setregid(-1, 1000) = <nil>
pam_fscrypt[434]: Setgroups([1000 985]) = <nil>
pam_fscrypt[434]: Setreuid(-1, 1000) = <nil>
pam_fscrypt[434]: Reading config from "/etc/fscrypt.conf"
pam_fscrypt[434]: creating context for "i3test"
pam_fscrypt[434]: found ext4 filesystem "/" (/dev/sda2)
pam_fscrypt[434]: listing descriptors in "/.fscrypt/protectors"
pam_fscrypt[434]: found 0 descriptor(s)
pam_fscrypt[434]: no protector to unlock: no PAM protector for UID=1000 on "/"
pam_fscrypt[434]: Setting privileges to "root"
pam_fscrypt[434]: Setreuid(-1, 0) = <nil>
pam_fscrypt[434]: Setregid(-1, 0) = <nil>
pam_fscrypt[434]: Setgroups([0]) = <nil>
pam_fscrypt[434]: pam func succeeded
login[434]: LOGIN ON tty1 BY i3test
login[434]: pam_unix(login:session): session closed for user i3test
pam_fscrypt[434]: CloseSession(map[drop_caches:true lock_policies:true debug:true])
pam_fscrypt[434]: Session count for UID=1000 updated to 0
pam_fscrypt[434]: locking polices protected with login protector
pam_fscrypt[434]: KeyctlLink(483117192, 57274768) = <nil>
pam_fscrypt[434]: Setting privileges to "i3test"
pam_fscrypt[434]: Setregid(-1, 1000) = <nil>
pam_fscrypt[434]: Setgroups([1000 985]) = <nil>
pam_fscrypt[434]: Setreuid(-1, 1000) = <nil>
pam_fscrypt[434]: Reading config from "/etc/fscrypt.conf"
pam_fscrypt[434]: creating context for "i3test"
pam_fscrypt[434]: found ext4 filesystem "/" (/dev/sda2)
pam_fscrypt[434]: listing descriptors in "/.fscrypt/protectors"
pam_fscrypt[434]: found 0 descriptor(s)
pam_fscrypt[434]: nothing to lock: no PAM protector for UID=1000 on "/"
pam_fscrypt[434]: Setting privileges to "root"
pam_fscrypt[434]: Setreuid(-1, 0) = <nil>
pam_fscrypt[434]: Setregid(-1, 0) = <nil>
pam_fscrypt[434]: Setgroups([0]) = <nil>
pam_fscrypt[434]: dropping appropriate filesystem caches at session close
pam_fscrypt[434]: syncing changes to filesystem
pam_fscrypt[434]: freeing reclaimable inodes and dentries
pam_fscrypt[434]: pam func succeeded
kernel: login (434): drop_caches: 2

```

Any ideas? :)

ðŸ˜•2
## Metadata

### Assignees

No one assigned

### Labels

[bug](https://github.com/google/fscrypt/issues?q=state%3Aopen%20label%3A%22bug%22)
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from github.com_d9cf9775_20250125_220653.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F3022c1603d968c22f147b4a2c49c4637dd1be91b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F3022c1603d968c22f147b4a2c49c4637dd1be91b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=google%2Ffscrypt)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[fscrypt](/google/fscrypt)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Ffscrypt) You must be signed in to change notification settings
* [Fork
  98](/login?return_to=%2Fgoogle%2Ffscrypt)
* [Star
   907](/login?return_to=%2Fgoogle%2Ffscrypt)

* [Code](/google/fscrypt)
* [Issues
  39](/google/fscrypt/issues)
* [Pull requests
  2](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

Additional navigation options

* [Code](/google/fscrypt)
* [Issues](/google/fscrypt/issues)
* [Pull requests](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

## Commit

[Permalink](/google/fscrypt/commit/3022c1603d968c22f147b4a2c49c4637dd1be91b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Ensure setting user privileges is reversible

[Browse files](/google/fscrypt/tree/3022c1603d968c22f147b4a2c49c4637dd1be91b)
Browse the repository at this point in the history

```
This change makes sure after dropping then elevating privileges for a
process, the euid, guid, and groups are all the same as they were
originally. This significantly simplifies the privilege logic.

This fixes [CVE-2018-6558](https://github.com/advisories/GHSA-qj26-7grj-whg3 "CVE-2018-6558"), which allowed an unprivleged user to gain
membership in the root group (gid 0) due to the groups not being
properly reset in the process.
```

* Loading branch information

[![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=40&v=4)](/josephlr)

[josephlr](/google/fscrypt/commits?author=josephlr "View all commits by josephlr")
committed
Aug 23, 2018

1 parent
[d4d88e1](/google/fscrypt/commit/d4d88e16b54eaa9ba2a8dcb07ba545b60f4d4208)

commit 3022c16

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**92 additions**
and
**87 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* pam

  + pam/pam.go
    [pam.go](#diff-02a489eb5b68908dc93afc83b86714473c3cebe6a4684c7d23ba3af1dbe5287e)
* security

  + security/privileges.go
    [privileges.go](#diff-fe723aa379b45cfee133a2a4407fbe364fbd998b03e7bf7cefff1194264f1037)

## There are no files selected for viewing

33 changes: 16 additions & 17 deletions

33
[pam/pam.go](#diff-02a489eb5b68908dc93afc83b86714473c3cebe6a4684c7d23ba3af1dbe5287e "pam/pam.go")

Show comments

[View file](/google/fscrypt/blob/3022c1603d968c22f147b4a2c49c4637dd1be91b/pam/pam.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -35,16 +35,14 @@ import ( |
|  |  | "unsafe" |
|  |  |  |
|  |  | "github.com/google/fscrypt/security" |
|  |  | "github.com/google/fscrypt/util" |
|  |  | ) |
|  |  |  |
|  |  | // Handle wraps the C pam\_handle\_t type. This is used from within modules. |
|  |  | type Handle struct { |
|  |  | handle \*C.pam\_handle\_t |
|  |  | status C.int |
|  |  | // OrigUser is the user who invoked the PAM module (usually root) |
|  |  | OrigUser \*user.User |
|  |  | // PamUser is the user who the PAM module is for |
|  |  | handle \*C.pam\_handle\_t |
|  |  | status C.int |
|  |  | origPrivs \*security.Privileges |
|  |  | // PamUser is the user for whom the PAM module is running. |
|  |  | PamUser \*user.User |
|  |  | } |
|  |  |  |
| Expand All | | @@ -62,13 +60,8 @@ func NewHandle(pamh unsafe.Pointer) (\*Handle, error) { |
|  |  | return nil, err |
|  |  | } |
|  |  |  |
|  |  | if h.PamUser, err = user.Lookup(C.GoString(pamUsername)); err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | if h.OrigUser, err = util.EffectiveUser(); err != nil { |
|  |  | return nil, err |
|  |  | } |
|  |  | return h, nil |
|  |  | h.PamUser, err = user.Lookup(C.GoString(pamUsername)) |
|  |  | return h, err |
|  |  | } |
|  |  |  |
|  |  | func (h \*Handle) setData(name string, data unsafe.Pointer, cleanup C.CleanupFunc) error { |
| Expand Down  Expand Up | | @@ -140,14 +133,20 @@ func (h \*Handle) StartAsPamUser() error { |
|  |  | if \_, err := security.UserKeyringID(h.PamUser, true); err != nil { |
|  |  | log.Printf("Setting up keyrings in PAM: %v", err) |
|  |  | } |
|  |  | return security.SetProcessPrivileges(h.PamUser) |
|  |  | userPrivs, err := security.UserPrivileges(h.PamUser) |
|  |  | if err != nil { |
|  |  | return err |
|  |  | } |
|  |  | if h.origPrivs, err = security.ProcessPrivileges(); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | return security.SetProcessPrivileges(userPrivs) |
|  |  | } |
|  |  |  |
|  |  | // StopAsPamUser restores the original privileges that were running the |
|  |  | // PAM module (this is usually root). As this error is often ignored in a defer |
|  |  | // statement, any error is also logged. |
|  |  | // PAM module (this is usually root). |
|  |  | func (h \*Handle) StopAsPamUser() error { |
|  |  | err := security.SetProcessPrivileges(h.OrigUser) |
|  |  | err := security.SetProcessPrivileges(h.origPrivs) |
|  |  | if err != nil { |
|  |  | log.Print(err) |
|  |  | } |
| Expand Down | |  |

146 changes: 76 additions & 70 deletions

146
[security/privileges.go](#diff-fe723aa379b45cfee133a2a4407fbe364fbd998b03e7bf7cefff1194264f1037 "security/privileges.go")

Show comments

[View file](/google/fscrypt/blob/3022c1603d968c22f147b4a2c49c4637dd1be91b/security/privileges.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -43,30 +43,15 @@ package security |
|  |  | // cgo maps them to different Go types. |
|  |  |  |
|  |  | /\* |
|  |  | #define \_GNU\_SOURCE // for getresuid and setresuid |
|  |  | #include <sys/types.h> |
|  |  | #include <unistd.h> // setreuid, setregid |
|  |  | #include <grp.h> // setgroups |
|  |  |  |
|  |  | static int my\_setreuid(uid\_t ruid, uid\_t euid) |
|  |  | { |
|  |  | return setreuid(ruid, euid); |
|  |  | } |
|  |  |  |
|  |  | static int my\_setregid(gid\_t rgid, gid\_t egid) |
|  |  | { |
|  |  | return setregid(rgid, egid); |
|  |  | } |
|  |  |  |
|  |  | static int my\_setgroups(size\_t size, const gid\_t \*list) |
|  |  | { |
|  |  | return setgroups(size, list); |
|  |  | } |
|  |  | #include <unistd.h> // getting and setting uids and gids |
|  |  | #include <grp.h> // setgroups |
|  |  | \*/ |
|  |  | import "C" |
|  |  |  |
|  |  | import ( |
|  |  | "log" |
|  |  | "os" |
|  |  | "os/user" |
|  |  | "syscall" |
|  |  |  |
| Expand All | | @@ -75,72 +60,93 @@ import ( |
|  |  | "github.com/google/fscrypt/util" |
|  |  | ) |
|  |  |  |
|  |  | // SetProcessPrivileges temporarily drops the privileges of the current process |
|  |  | // to have the effective uid/gid of the target user. The privileges can be |
|  |  | // changed again with another call to SetProcessPrivileges. |
|  |  | func SetProcessPrivileges(target \*user.User) error { |
|  |  | euid := util.AtoiOrPanic(target.Uid) |
|  |  | egid := util.AtoiOrPanic(target.Gid) |
|  |  | if os.Geteuid() == euid { |
|  |  | log.Printf("Privileges already set to %q", target.Username) |
|  |  | return nil |
|  |  | } |
|  |  | log.Printf("Setting privileges to %q", target.Username) |
|  |  | // Privileges encapulate the effective uid/gid and groups of a process. |
|  |  | type Privileges struct { |
|  |  | euid C.uid\_t |
|  |  | egid C.gid\_t |
|  |  | groups []C.gid\_t |
|  |  | } |
|  |  |  |
|  |  | // If setting privs to root, we want to set the uid first, so we will |
|  |  | // then have the necessary permissions to perform the other actions. |
|  |  | if euid == 0 { |
|  |  | if err := setUids(-1, euid); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | } |
|  |  | if err := setGids(-1, egid); err != nil { |
|  |  | return err |
|  |  | } |
|  |  | if err := setGroups(target); err != nil { |
|  |  | return err |
|  |  | // ProcessPrivileges returns the process's current effective privileges. |
|  |  | func ProcessPrivileges() (\*Privileges, error) { |
|  |  | ruid := C.getuid() |
|  |  | euid := C.geteuid() |
|  |  | rgid := C.getgid() |
|  |  | egid := C.getegid() |
|  |  |  |
|  |  | var groups []C.gid\_t |
|  |  | n, err := C.getgroups(0, nil) |
|  |  | if n < 0 { |
|  |  | return nil, err |
|  |  | } |
|  |  | // If not setting privs to root, we want to avoid dropping the uid |
|  |  | // util the very end. |
|  |  | if euid != 0 { |
|  |  | if err := setUids(-1, euid); err != nil { |
|  |  | return err |
|  |  | // If n == 0, the user isn't in any groups, so groups == nil is fine. |
|  |  | if n > 0 { |
|  |  | groups = make([]C.gid\_t, n) |
|  |  | n, err = C.getgroups(n, &groups[0]) |
|  |  | if n < 0 { |
|  |  | return nil, err |
|  |  | } |
|  |  | groups = groups[:n] |
|  |  | } |
|  |  | return nil |
|  |  | log.Printf("Current privs (real, effective): uid=(%d,%d) gid=(%d,%d) groups=%v", |
|  |  | ruid, euid, rgid, egid, groups) |
|  |  | return &Privileges{euid, egid, groups}, nil |
|  |  | } |
|  |  |  |
|  |  | func setUids(ruid, euid int) error { |
|  |  | res, err := C.my\_setreuid(C.uid\_t(ruid), C.uid\_t(euid)) |
|  |  | log.Printf("setreuid(%d, %d) = %d (errno %v)", ruid, euid, res, err) |
|  |  | if res == 0 { |
|  |  | return nil |
|  |  | // UserPrivileges returns the defualt privileges for the specified user. |
|  |  | func UserPrivileges(user \*user.User) (\*Privileges, error) { |
|  |  | privs := &Privileges{ |
|  |  | euid: C.uid\_t(util.AtoiOrPanic(user.Uid)), |
|  |  | egid: C.gid\_t(util.AtoiOrPanic(user.Gid)), |
|  |  | } |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting uids") |
|  |  | userGroups, err := user.GroupIds() |
|  |  | if err != nil { |
|  |  | return nil, util.SystemError(err.Error()) |
|  |  | } |
|  |  | privs.groups = make([]C.gid\_t, len(userGroups)) |
|  |  | for i, group := range userGroups { |
|  |  | privs.groups[i] = C.gid\_t(util.AtoiOrPanic(group)) |
|  |  | } |
|  |  | return privs, nil |
|  |  | } |
|  |  |  |
|  |  | func setGids(rgid, egid int) error { |
|  |  | res, err := C.my\_setregid(C.gid\_t(rgid), C.gid\_t(egid)) |
|  |  | log.Printf("setregid(%d, %d) = %d (errno %v)", rgid, egid, res, err) |
|  |  | if res == 0 { |
|  |  | return nil |
|  |  | // SetProcessPrivileges sets the privileges of the current process to have those |
|  |  | // specified by privs. The original privileges can be obtained by first saving |
|  |  | // the output of ProcessPrivileges, calling SetProcessPrivileges with the |
|  |  | // desired privs, then calling SetProcessPrivileges with the saved privs. |
|  |  | func SetProcessPrivileges(privs \*Privileges) error { |
|  |  | log.Printf("Setting euid=%d egid=%d groups=%v", privs.euid, privs.egid, privs.groups) |
|  |  |  |
|  |  | // If setting privs as root, we need to set the euid to 0 first, so that |
|  |  | // we will have the necessary permissions to make the other changes to |
|  |  | // the groups/egid/euid, regardless of our original euid. |
|  |  | C.seteuid(0) |
|  |  |  |
|  |  | // Seperately handle the case where the user is in no groups. |
|  |  | numGroups := C.size\_t(len(privs.groups)) |
|  |  | groupsPtr := (\*C.gid\_t)(nil) |
|  |  | if numGroups > 0 { |
|  |  | groupsPtr = &privs.groups[0] |
|  |  | } |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting gids") |
|  |  | } |
|  |  |  |
|  |  | func setGroups(target \*user.User) error { |
|  |  | groupStrings, err := target.GroupIds() |
|  |  | if err != nil { |
|  |  | return util.SystemError(err.Error()) |
|  |  | if res, err := C.setgroups(numGroups, groupsPtr); res < 0 { |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting groups") |
|  |  | } |
|  |  | if res, err := C.setegid(privs.egid); res < 0 { |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting egid") |
|  |  | } |
|  |  | gids := make([]C.gid\_t, len(groupStrings)) |
|  |  | for i, groupString := range groupStrings { |
|  |  | gids[i] = C.gid\_t(util.AtoiOrPanic(groupString)) |
|  |  | if res, err := C.seteuid(privs.euid); res < 0 { |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting euid") |
|  |  | } |
|  |  | res, err := C.my\_setgroups(C.size\_t(len(groupStrings)), &gids[0]) |
|  |  | log.Printf("setgroups(%v) = %d (errno %v)", gids, res, err) |
|  |  | ProcessPrivileges() |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func setUids(ruid, euid int) error { |
|  |  | res, err := C.setreuid(C.uid\_t(ruid), C.uid\_t(euid)) |
|  |  | log.Printf("setreuid(%d, %d) = %d (errno %v)", ruid, euid, res, err) |
|  |  | if res == 0 { |
|  |  | return nil |
|  |  | } |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting groups") |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting uids") |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `3022c16`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F3022c1603d968c22f147b4a2c49c4637dd1be91b) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from launchpad.net_176c806f_20250126_121922.html ===

[Log in / Register](https://launchpad.net/~tyhicks/%2Blogin)

[![](https://launchpadlibrarian.net/83129119/tyhicks-small.png)](https://launchpad.net/~tyhicks)

## [Tyler Hicks](https://launchpad.net/~tyhicks)

* Overview
* [Code](https://code.launchpad.net/~tyhicks)
* [Bugs](https://bugs.launchpad.net/~tyhicks)
* [Blueprints](https://blueprints.launchpad.net/~tyhicks)
* [Translations](https://translations.launchpad.net/~tyhicks)
* [Answers](https://answers.launchpad.net/~tyhicks)

* [Related packages](https://launchpad.net/~tyhicks/%2Brelated-packages)
* [Related projects](https://launchpad.net/~tyhicks/%2Brelated-projects)

## User information

Launchpad Id:
tyhicks

Email:
[Log in](%2Blogin) for email information.

Member since:
2008-10-03

[![Icon of AppArmor Developers](https://launchpadlibrarian.net/65472736/toxie-14.png "Member of AppArmor Developers")](/~apparmor-dev)
[![Icon of Bluetooth](https://launchpadlibrarian.net/4683649/stock_bluetooth.png "Member of Bluetooth")](/~bluetooth)
[![Icon of eCryptfs](https://launchpadlibrarian.net/88108046/ecryptfs_14.png "Member of eCryptfs")](/~ecryptfs)
[![Icon of Edubuntu Developers](https://launchpadlibrarian.net/71879383/edubuntu-logo-only_14.png "Member of Edubuntu Developers")](/~edubuntu-dev)
[![Icon of GNOME3 Team](https://launchpadlibrarian.net/235731434/roundel14.png "Member of GNOME3 Team")](/~gnome3-team)
[![Icon of Indicator Applet Developers](https://launchpadlibrarian.net/22816053/add-notification-applet.14.png "Member of Indicator Applet Developers")](/~indicator-applet-developers)
[![Icon of Kubuntu Ninjas - Yellow belts](https://launchpadlibrarian.net/192173133/belt2-yellow3.png "Member of Kubuntu Ninjas - Yellow belts")](/~kubuntu-ninjas-yellow-belts)
[![Icon of Kubuntu Ninjas](https://launchpadlibrarian.net/31496145/icon.png "Member of Kubuntu Ninjas")](/~kubuntu-ninjas)
[![Icon of Kubuntu Package Archives](https://launchpadlibrarian.net/44411915/deb-small.png "Member of Kubuntu Package Archives")](/~kubuntu-ppa)
[![Icon of Lubuntu Code](https://launchpadlibrarian.net/704307155/lennyborg_14.png "Member of Lubuntu Code")](/~lubuntu-code)
[![Icon of Lubuntu Continuous Integration](https://launchpadlibrarian.net/704307325/lennyborg_14.png "Member of Lubuntu Continuous Integration")](/~lubuntu-ci)
[![Icon of Lubuntu Developers](https://launchpadlibrarian.net/704306355/lennyborg_14.png "Member of Lubuntu Developers")](/~lubuntu-dev)
[![Icon of Lubuntu Packages Team](https://launchpadlibrarian.net/704305879/lenny_bug_14.png "Member of Lubuntu Packages Team")](/~lubuntu-packaging)
[![Icon of Lubuntu](https://launchpadlibrarian.net/357050187/14.png "Member of Lubuntu")](/~lubuntu-desktop)
[![Icon of MOTU](https://launchpadlibrarian.net/1516491/motu-image-2.png "Member of MOTU")](/~motu)
[![Icon of Network-manager](https://launchpadlibrarian.net/11610188/nm-team.png "Member of Network-manager")](/~network-manager)
[![Icon of Super Friends](https://launchpadlibrarian.net/134634591/superman14.png "Member of Super Friends")](/~super-friends)
[![Icon of Ubuntu Bug Control](https://launchpadlibrarian.net/4423778/qa-icon.png "Member of Ubuntu Bug Control")](/~ubuntu-bugcontrol)
[![Icon of Ubuntu Contributing Developers](https://launchpadlibrarian.net/17290192/wrench_emblem-trans.png "Member of Ubuntu Contributing Developers")](/~ubuntu-developer-members)
[![Icon of Ubuntu Core Development Team](https://launchpadlibrarian.net/1072365/main.png "Member of Ubuntu Core Development Team")](/~ubuntu-core-dev)
[![Icon of Ubuntu Development Team](https://launchpadlibrarian.net/1072363/motu.png "Member of Ubuntu Development Team")](/~ubuntu-dev)
[![Icon of Ubuntu Documentation Project Team](https://launchpadlibrarian.net/162165522/ubuntu-doc.png "Member of Ubuntu Documentation Project Team")](/~ubuntu-doc)
[![Icon of Ubuntu GNOME Developers](https://launchpadlibrarian.net/254356645/roundel14.png "Member of Ubuntu GNOME Developers")](/~ubuntu-gnome-dev)
[![Icon of Ubuntu GNOME](https://launchpadlibrarian.net/258611022/ubuntu-gnome_14.png "Member of Ubuntu GNOME")](/~ubuntu-gnome)
[![Icon of Ubuntu Kylin Members](https://launchpadlibrarian.net/444398797/623185830.jpg "Member of Ubuntu Kylin Members")](/~ubuntukylin-members)
[![Icon of Ubuntu MATE Developers](https://launchpadlibrarian.net/212349832/icon.png "Member of Ubuntu MATE Developers")](/~ubuntu-mate-dev)
[![Icon of Ubuntu Members](https://launchpadlibrarian.net/606495581/CoF%2014px.png "Member of Ubuntu Members")](/~ubuntumembers)
[![Icon of Ubuntu Studio Development](https://launchpadlibrarian.net/479050820/14.png "Member of Ubuntu Studio Development")](/~ubuntustudio-dev)
[![Icon of Xubuntu Artwork](https://launchpadlibrarian.net/341831649/icon_optimized_14.png "Member of Xubuntu Artwork")](/~xubuntu-art)
[![Icon of Xubuntu Developers](https://launchpadlibrarian.net/139019912/x-dev.png "Member of Xubuntu Developers")](/~xubuntu-dev)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English

OpenPGP keys:

CE1D6FE48F85F246C77C3516AD3F818B34FA35B7

SSH keys:

[tyhicks@elm - Canonical](%2Bsshkeys)

[tyhicks@sec - Canonical](%2Bsshkeys)

[tyhicks@boyd - Canonical](%2Bsshkeys)

Time zone:

America/Chicago
(UTC-0600)

Karma:
[0](https://launchpad.net/~tyhicks/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**tyhicks**
 on
**irc.oftc.net**

![IRC](/@@/social-irc "IRC")
**tyhicks**
 on
**irc.libera.chat**

## [All bugs in progress](https://launchpad.net/~tyhicks/%2Bassignedbugs?search=Search&field.status=In+Progress) Assigned bugs

||  | #1379536 [Coarse-grained kernel keyring mediation](https://bugs.launchpad.net/apparmor/%2Bbug/1379536) |  |
| --- | --- | --- |
| in [AppArmor](/apparmor), [Ubuntu](/ubuntu) | | |

| --- | --- | --- | --- | --- | --- |
||  | #842647 [[git] file blocks duplicated at the end of the file](https://bugs.launchpad.net/ecryptfs/%2Bbug/842647) |  |
| --- | --- | --- |
| in [eCryptfs](/ecryptfs), [Ubuntu](/ubuntu) | | |

||  | #1501913 [Apparmor Abstraction Prevents Firefox From Opening Torrents in Deluge-Gtk](https://bugs.launchpad.net/apparmor/%2Bbug/1501913) |  |
| --- | --- | --- |
| in [AppArmor](/apparmor), [Ubuntu](/ubuntu) | | |

||  | #1439849 [BUG: unable to handle kernel NULL pointer dereference at 0000000000000010](https://bugs.launchpad.net/ubuntu/%2Bsource/linux/%2Bbug/1439849) |  |
| --- | --- | --- |
| in [Ubuntu](/ubuntu) | | |

## [All assigned blueprints](/~tyhicks/%2Bspecs?role=assignee) Assigned blueprints

| **[User data encryption requirements and work for 14.04](https://blueprints.launchpad.net/ubuntu/%2Bspec/client-1311-user-data-encryption "client-1311-user-data-encryption")** for **Ubuntu**  Ubuntu Desktop currently offer both encrypted disk and encrypted home as part of the install. Ubuntu Touch should also offer a user data encryption option for its users. | |
| --- | --- |
| **[Application Confinement (Online Accounts)](https://blueprints.launchpad.net/ubuntu/%2Bspec/security-r-app-online-accounts "security-r-app-online-accounts")** for **Ubuntu**  Acceptance criteria for July: Goal: Developers can integrate AppArmor into online accounts Acceptance criteria for August: Goal: Users receive a contextual runtime prompt when an app uses online accounts | |
| **[eCryptfs status and future](https://blueprints.launchpad.net/ubuntu/%2Bspec/security-p-ecryptfs "security-p-ecryptfs")** for **Ubuntu**  This session is about discussing the current status and issues with eCryptfs, and making a decision what needs to be done in order for it to be an appropriate install-time option in the LTS release. | |

## Personal package archives

| [AppArmor-mediated DBus prototype](/~tyhicks/%2Barchive/ubuntu/aadbus) |
| --- |
| [PPA named ecryptfs-utils-daily for Tyler Hicks](/~tyhicks/%2Barchive/ubuntu/ecryptfs-utils-daily) |
| [Testing PPA](/~tyhicks/%2Barchive/ubuntu/testing) |

* [View snap packages](https://launchpad.net/~tyhicks/%2Bsnaps)

## [All memberships](https://launchpad.net/~tyhicks/%2Bparticipation) Latest memberships

| [Ubuntu cloaked people on Libera](/~ubuntu-irc-cloaks)  Joined on 2021-05-24 | |
| --- | --- |
| [Ubuntu SSO 2-factor testers](/~sso-2f-testers)  Joined on 2020-02-20 | |
| [Ubuntu Core Development Team](/~ubuntu-core-dev)  Joined on 2016-02-29 | |
| [AppArmor Developers](/~apparmor-dev)  Joined on 2012-11-07 | |
| [eCryptfs](/~ecryptfs)  Joined on 2008-11-11 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
Â â€¢
[Take the tour](https://launchpad.net/%2Btour)
Â â€¢
[Read the guide](https://help.launchpad.net/)

Â© 2004
[CanonicalÂ Ltd.](http://canonical.com/)
Â â€¢
[Terms of use](https://launchpad.net/legal)
Â â€¢
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
Â â€¢
[Contact Launchpad Support](/feedback)
Â â€¢
[Blog](http://blog.launchpad.net/)
Â â€¢
[Careers](https://canonical.com/careers)
Â â€¢
[System status](https://ubuntu.social/%40launchpadstatus)
Â â€¢
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from github.com_8478e213_20250126_121910.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-qj26-7grj-whg3)

**CVE-2018-6558**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-qj26-7grj-whg3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [GitHub Reviewed](/advisories?query=type%3Areviewed)
3. [CVE-2018-6558](/advisories/GHSA-qj26-7grj-whg3)

## Privilege Escalation in fscrypt

Moderate severity

GitHub Reviewed

Published
Jun 23, 2021
to the GitHub Advisory Database
â€¢
Updated May 20, 2024

[Vulnerability details](/advisories/GHSA-qj26-7grj-whg3)
[Dependabot alerts
0](/advisories/GHSA-qj26-7grj-whg3/dependabot)

## Package

gomod

github.com/google/fscrypt
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

< 0.2.4

## Patched versions

0.2.4

## Description

The pam\_fscrypt module in fscrypt before 0.2.4 may incorrectly restore primary and supplementary group IDs to the values associated with the root user, which allows attackers to gain privileges via a successful login through certain applications that use Linux-PAM (aka pam).

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2018-6558>
* [google/fscrypt#77](https://github.com/google/fscrypt/issues/77)
* [google/fscrypt@3022c16](https://github.com/google/fscrypt/commit/3022c1603d968c22f147b4a2c49c4637dd1be91b)
* [google/fscrypt@315f9b0](https://github.com/google/fscrypt/commit/315f9b042237200174a1fb99427f74027e191d66)
* <https://launchpad.net/bugs/1787548>
* <https://pkg.go.dev/vuln/GO-2020-0027>

Reviewed
May 20, 2021

Published to the GitHub Advisory Database
Jun 23, 2021

Last updated
May 20, 2024

### Severity

Moderate

6.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
High

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N

### EPSS score

0.097%

# Exploit Prediction Scoring System (EPSS)

This score estimates the probability of this vulnerability being exploited within the next 30 days.
Data provided by [FIRST](https://www.first.org/epss/user-guide).

 (42nd percentile)

### Weaknesses

No CWEs

### CVE ID

CVE-2018-6558

### GHSA ID

GHSA-qj26-7grj-whg3

### Source code

[google/fscrypt](https://github.com/google/fscrypt)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-qj26-7grj-whg3/improve).

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from launchpad.net_f09f2e04_20250126_121923.html ===

[Log in / Register](https://launchpad.net/~alexmurray/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~alexmurray)

## [Alex Murray](https://launchpad.net/~alexmurray)

* Overview
* [Code](https://code.launchpad.net/~alexmurray)
* [Bugs](https://bugs.launchpad.net/~alexmurray)
* [Blueprints](https://blueprints.launchpad.net/~alexmurray)
* [Translations](https://translations.launchpad.net/~alexmurray)
* [Answers](https://answers.launchpad.net/~alexmurray)

Ubuntu Security Tech Lead for Canonical and in my spare time developer of Hardware Sensors Indicator (indicator-sensors) and a bunch of other software bits (mainly Emacs related)

See <https://github.com/alexmurray>

* [Related packages](https://launchpad.net/~alexmurray/%2Brelated-packages)
* [Related projects](https://launchpad.net/~alexmurray/%2Brelated-projects)

## User information

Launchpad Id:
alexmurray

Email:
[Log in](%2Blogin) for email information.

Member since:
2006-05-24

[![Icon of AppArmor Developers](https://launchpadlibrarian.net/65472736/toxie-14.png "Member of AppArmor Developers")](/~apparmor-dev)
[![Icon of Bluetooth](https://launchpadlibrarian.net/4683649/stock_bluetooth.png "Member of Bluetooth")](/~bluetooth)
[![Icon of Build Daemon Maintainers](https://launchpadlibrarian.net/1558154/buildd-maint.png "Member of Build Daemon Maintainers")](/~launchpad-buildd-admins)
[![Icon of Canonical Partner Developers](https://launchpadlibrarian.net/74993564/14.png "Member of Canonical Partner Developers")](/~canonical-partner-dev)
[![Icon of Docky Users](https://launchpadlibrarian.net/51321694/docky14.png "Member of Docky Users")](/~docky-users)
[![Icon of Edubuntu Developers](https://launchpadlibrarian.net/71879383/edubuntu-logo-only_14.png "Member of Edubuntu Developers")](/~edubuntu-dev)
[![Icon of GNOME3 Team](https://launchpadlibrarian.net/235731434/roundel14.png "Member of GNOME3 Team")](/~gnome3-team)
[![Icon of Indicator Applet Developers](https://launchpadlibrarian.net/22816053/add-notification-applet.14.png "Member of Indicator Applet Developers")](/~indicator-applet-developers)
[![Icon of Kubuntu Ninjas - Yellow belts](https://launchpadlibrarian.net/192173133/belt2-yellow3.png "Member of Kubuntu Ninjas - Yellow belts")](/~kubuntu-ninjas-yellow-belts)
[![Icon of Kubuntu Ninjas](https://launchpadlibrarian.net/31496145/icon.png "Member of Kubuntu Ninjas")](/~kubuntu-ninjas)
[![Icon of Kubuntu Package Archives](https://launchpadlibrarian.net/44411915/deb-small.png "Member of Kubuntu Package Archives")](/~kubuntu-ppa)
[![Icon of Launchpad Beta Testers](https://launchpadlibrarian.net/600856498/Canonical_Launchpad_icon_14px.png "Member of Launchpad Beta Testers")](/~launchpad-beta-testers)
[![Icon of Launchpad Users](https://launchpadlibrarian.net/600856618/Canonical_Launchpad_icon_14px.png "Member of Launchpad Users")](/~launchpad-users)
[![Icon of Lubuntu Code](https://launchpadlibrarian.net/704307155/lennyborg_14.png "Member of Lubuntu Code")](/~lubuntu-code)
[![Icon of Lubuntu Continuous Integration](https://launchpadlibrarian.net/704307325/lennyborg_14.png "Member of Lubuntu Continuous Integration")](/~lubuntu-ci)
[![Icon of Lubuntu Developers](https://launchpadlibrarian.net/704306355/lennyborg_14.png "Member of Lubuntu Developers")](/~lubuntu-dev)
[![Icon of Lubuntu Packages Team](https://launchpadlibrarian.net/704305879/lenny_bug_14.png "Member of Lubuntu Packages Team")](/~lubuntu-packaging)
[![Icon of Lubuntu](https://launchpadlibrarian.net/357050187/14.png "Member of Lubuntu")](/~lubuntu-desktop)
[![Icon of Mactel Support Community](https://launchpadlibrarian.net/12126197/Logo_14.png "Member of Mactel Support Community")](/~mactel-support-community)
[![Icon of Mactel Support](https://launchpadlibrarian.net/12039822/appleubuntu_14.png "Member of Mactel Support")](/~mactel-support)
[![Icon of MOTU SWAT](https://launchpadlibrarian.net/5609742/sword16x16.png "Member of MOTU SWAT")](/~motu-swat)
[![Icon of MOTU](https://launchpadlibrarian.net/1516491/motu-image-2.png "Member of MOTU")](/~motu)
[![Icon of Network-manager](https://launchpadlibrarian.net/11610188/nm-team.png "Member of Network-manager")](/~network-manager)
[![Icon of OEM Archive Admins](https://launchpadlibrarian.net/31251458/oem-admin-logo_14x14.png "Member of OEM Archive Admins")](/~oem-archive)
[![Icon of Super Friends](https://launchpadlibrarian.net/134634591/superman14.png "Member of Super Friends")](/~super-friends)
[![Icon of Ubuntu Bug Control](https://launchpadlibrarian.net/4423778/qa-icon.png "Member of Ubuntu Bug Control")](/~ubuntu-bugcontrol)
[![Icon of Ubuntu BugSquad](https://launchpadlibrarian.net/1812570/bugsquad.png "Member of Ubuntu BugSquad")](/~bugsquad)
[![Icon of Ubuntu Contributing Developers](https://launchpadlibrarian.net/17290192/wrench_emblem-trans.png "Member of Ubuntu Contributing Developers")](/~ubuntu-developer-members)
[![Icon of Ubuntu Core Development Team](https://launchpadlibrarian.net/1072365/main.png "Member of Ubuntu Core Development Team")](/~ubuntu-core-dev)
[![Icon of Ubuntu Development Team](https://launchpadlibrarian.net/1072363/motu.png "Member of Ubuntu Development Team")](/~ubuntu-dev)
[![Icon of Ubuntu Documentation Project Team](https://launchpadlibrarian.net/162165522/ubuntu-doc.png "Member of Ubuntu Documentation Project Team")](/~ubuntu-doc)
[![Icon of Ubuntu Drivers](https://launchpadlibrarian.net/1546355/hobbyhorse.gif "Member of Ubuntu Drivers")](/~ubuntu-drivers)
[![Icon of Ubuntu GNOME Developers](https://launchpadlibrarian.net/254356645/roundel14.png "Member of Ubuntu GNOME Developers")](/~ubuntu-gnome-dev)
[![Icon of Ubuntu GNOME](https://launchpadlibrarian.net/258611022/ubuntu-gnome_14.png "Member of Ubuntu GNOME")](/~ubuntu-gnome)
[![Icon of Ubuntu Kylin Members](https://launchpadlibrarian.net/444398797/623185830.jpg "Member of Ubuntu Kylin Members")](/~ubuntukylin-members)
[![Icon of Ubuntu LXC Security team](https://launchpadlibrarian.net/673452720/14.png "Member of Ubuntu LXC Security team")](/~ubuntu-lxc-security)
[![Icon of Ubuntu MATE Developers](https://launchpadlibrarian.net/212349832/icon.png "Member of Ubuntu MATE Developers")](/~ubuntu-mate-dev)
[![Icon of Ubuntu Members](https://launchpadlibrarian.net/606495581/CoF%2014px.png "Member of Ubuntu Members")](/~ubuntumembers)
[![Icon of Ubuntu Security Team](https://launchpadlibrarian.net/1575441/Lock.png "Member of Ubuntu Security Team")](/~ubuntu-security)
[![Icon of Ubuntu Sponsors](https://launchpadlibrarian.net/40794090/minitools.png "Member of Ubuntu Sponsors")](/~ubuntu-sponsors)
[![Icon of Ubuntu Studio Development](https://launchpadlibrarian.net/479050820/14.png "Member of Ubuntu Studio Development")](/~ubuntustudio-dev)
[![Icon of Xubuntu Artwork](https://launchpadlibrarian.net/341831649/icon_optimized_14.png "Member of Xubuntu Artwork")](/~xubuntu-art)
[![Icon of Xubuntu Developers](https://launchpadlibrarian.net/139019912/x-dev.png "Member of Xubuntu Developers")](/~xubuntu-dev)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English

OpenPGP keys:

88E9530BCBDDC200517B5EB0F498D2D9DE7DAD9C

SSH keys:

[alex.murray@canonical.com](%2Bsshkeys)

Time zone:

Australia/Adelaide
(UTC+1030)

Karma:
[30917](https://launchpad.net/~alexmurray/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**amurray**
 on
**irc.canonical.com**

![IRC](/@@/social-irc "IRC")
**amurray**
 on
**irc.libera.chat**

![Matrix](/@@/social-matrix "Matrix") [**@alexmurray:ubuntu.com**](https://matrix.to//#/@alexmurray:ubuntu.com)

## Personal package archives

| [adduser updated to enable private homedirs by default](/~alexmurray/%2Barchive/ubuntu/adduser-private-homedirs) |
| --- |
| [apparmor-4.0.0-alpha2-for-mantic](/~alexmurray/%2Barchive/ubuntu/apparmor-4.0.0-alpha2-for-mantic) |
| [apparmor-4.0.0-alpha2-for-mantic-take2](/~alexmurray/%2Barchive/ubuntu/apparmor-4.0.0-alpha2-for-mantic-take2) |
| [AppArmor Prompting Demo](/~alexmurray/%2Barchive/ubuntu/apparmor-prompting) |
| [docker-test](/~alexmurray/%2Barchive/ubuntu/docker-test) |
| [Emacs](/~alexmurray/%2Barchive/ubuntu/emacs) |
| [Test PPA for Emacs backports](/~alexmurray/%2Barchive/ubuntu/emacs-test) |
| [gcc-stack-clash-and-cf-protection](/~alexmurray/%2Barchive/ubuntu/gcc-stack-clash-and-cf-protection) |
| [gcc-stack-clash-protection](/~alexmurray/%2Barchive/ubuntu/gcc-stack-clash-protection) |
| [gcc-stack-clash-protection2](/~alexmurray/%2Barchive/ubuntu/gcc-stack-clash-protection2) |
| [global](/~alexmurray/%2Barchive/ubuntu/global) |
| [PPA for indicator-sensors](/~alexmurray/%2Barchive/ubuntu/indicator-sensors) |
| [Indicator Sensors Daily PPA](/~alexmurray/%2Barchive/ubuntu/indicator-sensors-daily) |
| [iptables-mantic](/~alexmurray/%2Barchive/ubuntu/iptables-mantic) |
| [iptables-mantic-i386](/~alexmurray/%2Barchive/ubuntu/iptables-mantic-i386) |
| [libchamplain](/~alexmurray/%2Barchive/ubuntu/libchamplain) |
| [clamav 1.0 transition test](/~alexmurray/%2Barchive/ubuntu/libclamav11) |
| [LP1765304](/~alexmurray/%2Barchive/ubuntu/lp1765304) |
| [LP1784964](/~alexmurray/%2Barchive/ubuntu/lp1784964) |
| [LP1862158](/~alexmurray/%2Barchive/ubuntu/lp1862158) |
| [lp1876055](/~alexmurray/%2Barchive/ubuntu/lp1876055) |
| [LP1877633](/~alexmurray/%2Barchive/ubuntu/lp1877633) |
| [lp1973322](/~alexmurray/%2Barchive/ubuntu/lp1973322) |
| [lp1989309](/~alexmurray/%2Barchive/ubuntu/lp1989309) |
| [lp2016042](/~alexmurray/%2Barchive/ubuntu/lp2016042) |
| [lp2036128](/~alexmurray/%2Barchive/ubuntu/lp2036128) |
| [PPA for Alex Murray](/~alexmurray/%2Barchive/ubuntu/ppa) |
| [radare2](/~alexmurray/%2Barchive/ubuntu/radare2) |
| [test](/~alexmurray/%2Barchive/ubuntu/test) |

* [View source package recipes](https://code.launchpad.net/~alexmurray/%2Brecipes)
* [View snap packages](https://launchpad.net/~alexmurray/%2Bsnaps)

## [All memberships](https://launchpad.net/~alexmurray/%2Bparticipation) Latest memberships

| [Ubuntu Sponsors](/~ubuntu-sponsors)  Joined on 2023-11-09 | |
| --- | --- |
| [MOTU SWAT](/~motu-swat)  Joined on 2023-05-15 | |
| [Ubuntu Technical Board](/~techboard)  Joined on 2022-12-17 | |
| [Bileto Announcement List](/~bileto-announce)  Joined on 2022-02-22 | |
| [Ubuntu BugSquad](/~bugsquad)  Joined on 2021-11-29 | |

## [Recent activities](https://launchpad.net/~alexmurray/%2Bkarma) Most active in

| [review-tools](/review-tools) |  |  |  |  |
| --- | --- | --- | --- | --- |
| [Ubuntu CVE Tracker](/ubuntu-cve-tracker) |  |  |  |  |
| [QA Regression Testing](/qa-regression-testing) |  |  |  |  |
| [ubuntu-security-tools](/ubuntu-security-tools) |  |  |  |  |
| [Ubuntu](/ubuntu) |  |  |  |  |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
Â â€¢
[Take the tour](https://launchpad.net/%2Btour)
Â â€¢
[Read the guide](https://help.launchpad.net/)

Â© 2004
[CanonicalÂ Ltd.](http://canonical.com/)
Â â€¢
[Terms of use](https://launchpad.net/legal)
Â â€¢
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
Â â€¢
[Contact Launchpad Support](/feedback)
Â â€¢
[Blog](http://blog.launchpad.net/)
Â â€¢
[Careers](https://canonical.com/careers)
Â â€¢
[System status](https://ubuntu.social/%40launchpadstatus)
Â â€¢
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from github.com_fb30d3bf_20250125_220654.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F315f9b042237200174a1fb99427f74027e191d66)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F315f9b042237200174a1fb99427f74027e191d66)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=google%2Ffscrypt)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[google](/google)
/
**[fscrypt](/google/fscrypt)**
Public

* [Notifications](/login?return_to=%2Fgoogle%2Ffscrypt) You must be signed in to change notification settings
* [Fork
  98](/login?return_to=%2Fgoogle%2Ffscrypt)
* [Star
   907](/login?return_to=%2Fgoogle%2Ffscrypt)

* [Code](/google/fscrypt)
* [Issues
  39](/google/fscrypt/issues)
* [Pull requests
  2](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

Additional navigation options

* [Code](/google/fscrypt)
* [Issues](/google/fscrypt/issues)
* [Pull requests](/google/fscrypt/pulls)
* [Actions](/google/fscrypt/actions)
* [Security](/google/fscrypt/security)
* [Insights](/google/fscrypt/pulse)

## Commit

[Permalink](/google/fscrypt/commit/315f9b042237200174a1fb99427f74027e191d66)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Ensure keyring privilege changes are reversible

[Browse files](/google/fscrypt/tree/315f9b042237200174a1fb99427f74027e191d66)
Browse the repository at this point in the history

```
This change makes sure that, when we set the ruid and euid in order to
get the user keyring linked into the current process keyring, we will
always be able to reverse these changes (using a suid of 0).

This fixes an issue where "su <user>" would result in a system error
when called by an unprivileged user. It also explains exactly how and
why we are making these privilege changes.
```

* Loading branch information

[![@josephlr](https://avatars.githubusercontent.com/u/5506060?s=40&v=4)](/josephlr)

[josephlr](/google/fscrypt/commits?author=josephlr "View all commits by josephlr")
committed
Aug 23, 2018

1 parent
[3022c16](/google/fscrypt/commit/3022c1603d968c22f147b4a2c49c4637dd1be91b)

commit 315f9b0

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**49 additions**
and
**34 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* security

  + security/keyring.go
    [keyring.go](#diff-20d5f48bd07050a49db62c88010a6852878e92c3a4fb628e1bb61b237aacfbf1)
  + security/privileges.go
    [privileges.go](#diff-fe723aa379b45cfee133a2a4407fbe364fbd998b03e7bf7cefff1194264f1037)

## There are no files selected for viewing

60 changes: 32 additions & 28 deletions

60
[security/keyring.go](#diff-20d5f48bd07050a49db62c88010a6852878e92c3a4fb628e1bb61b237aacfbf1 "security/keyring.go")

Show comments

[View file](/google/fscrypt/blob/315f9b042237200174a1fb99427f74027e191d66/security/keyring.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,7 +22,6 @@ package security |
|  |  | import ( |
|  |  | "fmt" |
|  |  | "log" |
|  |  | "os" |
|  |  | "os/user" |
|  |  | "sync" |
|  |  |  |
| Expand Down  Expand Up | | @@ -138,42 +137,47 @@ func UserKeyringID(target \*user.User, checkSession bool) (int, error) { |
|  |  | return targetKeyring, nil |
|  |  | } |
|  |  |  |
|  |  | func userKeyringIDLookup(uid int) (int, error) { |
|  |  | func userKeyringIDLookup(uid int) (keyringID int, err error) { |
|  |  | cacheLock.Lock() |
|  |  | defer cacheLock.Unlock() |
|  |  | if keyringID, ok := keyringIDCache[uid]; ok { |
|  |  | return keyringID, nil |
|  |  | } |
|  |  |  |
|  |  | ruid, euid := os.Getuid(), os.Geteuid() |
|  |  | // If all the ids do not agree, we will have to change them |
|  |  | needSetUids := uid != ruid || uid != euid |
|  |  |  |
|  |  | // The value of KEY\_SPEC\_USER\_KEYRING is determined by the real uid, so |
|  |  | // we must set the ruid appropriately. Note that this will also trigger |
|  |  | // the creation of the uid keyring if it does not yet exist. |
|  |  | if needSetUids { |
|  |  | defer setUids(ruid, euid) // Always reset privileges |
|  |  | if err := setUids(uid, 0); err != nil { |
|  |  | return 0, err |
|  |  | var ok bool |
|  |  | if keyringID, ok = keyringIDCache[uid]; ok { |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Our goals here are to: |
|  |  | // - Find the user keyring (for the provided uid) |
|  |  | // - Link it into the current process keyring (so we can use it) |
|  |  | // - Make no permenant changes to the process privileges |
|  |  | // Complicating this are the facts that: |
|  |  | // - The value of KEY\_SPEC\_USER\_KEYRING is determined by the ruid |
|  |  | // - Keyring linking permissions use the euid |
|  |  | // So we have to change both the ruid and euid to make this work, |
|  |  | // setting the suid to 0 so that we can later switch back. |
|  |  | ruid, euid, suid := getUids() |
|  |  | if ruid != uid || euid != uid { |
|  |  | if err = setUids(uid, uid, 0); err != nil { |
|  |  | return |
|  |  | } |
|  |  | defer func() { |
|  |  | resetErr := setUids(ruid, euid, suid) |
|  |  | if resetErr != nil { |
|  |  | err = resetErr |
|  |  | } |
|  |  | }() |
|  |  | } |
|  |  | keyringID, err := unix.KeyctlGetKeyringID(unix.KEY\_SPEC\_USER\_KEYRING, true) |
|  |  |  |
|  |  | // We get the value of KEY\_SPEC\_USER\_KEYRING. Note that this will also |
|  |  | // trigger the creation of the uid keyring if it does not yet exist. |
|  |  | keyringID, err = unix.KeyctlGetKeyringID(unix.KEY\_SPEC\_USER\_KEYRING, true) |
|  |  | log.Printf("keyringID(\_uid.%d) = %d, %v", uid, keyringID, err) |
|  |  | if err != nil { |
|  |  | return 0, err |
|  |  | } |
|  |  |  |
|  |  | // We still want to use this key after our privileges are reset. If we |
|  |  | // link the key into the process keyring, we will possess it and still |
|  |  | // be able to use it. However, the permissions to link are based on the |
|  |  | // effective uid, so we must set the euid appropriately. |
|  |  | if needSetUids { |
|  |  | if err := setUids(0, uid); err != nil { |
|  |  | return 0, err |
|  |  | } |
|  |  | } |
|  |  | if err := keyringLink(keyringID, unix.KEY\_SPEC\_PROCESS\_KEYRING); err != nil { |
|  |  | // We still want to use this keyring after our privileges are reset. So |
|  |  | // we link it into the process keyring, preventing a loss of access. |
|  |  | if err = keyringLink(keyringID, unix.KEY\_SPEC\_PROCESS\_KEYRING); err != nil { |
|  |  | return 0, err |
|  |  | } |
|  |  |  |
| Expand Down | |  |

23 changes: 17 additions & 6 deletions

23
[security/privileges.go](#diff-fe723aa379b45cfee133a2a4407fbe364fbd998b03e7bf7cefff1194264f1037 "security/privileges.go")

Show comments

[View file](/google/fscrypt/blob/315f9b042237200174a1fb99427f74027e191d66/security/privileges.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -142,11 +142,22 @@ func SetProcessPrivileges(privs \*Privileges) error { |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func setUids(ruid, euid int) error { |
|  |  | res, err := C.setreuid(C.uid\_t(ruid), C.uid\_t(euid)) |
|  |  | log.Printf("setreuid(%d, %d) = %d (errno %v)", ruid, euid, res, err) |
|  |  | if res == 0 { |
|  |  | return nil |
|  |  | func setUids(ruid, euid, suid int) error { |
|  |  | log.Printf("Setting ruid=%d euid=%d suid=%d", ruid, euid, suid) |
|  |  | // We elevate the all the privs before setting them. This prevents |
|  |  | // issues with (ruid=1000,euid=1000,suid=0), where just a single call |
|  |  | // to setresuid might fail with permission denied. |
|  |  | if res, err := C.setresuid(0, 0, 0); res < 0 { |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting uids") |
|  |  | } |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting uids") |
|  |  | if res, err := C.setresuid(C.uid\_t(ruid), C.uid\_t(euid), C.uid\_t(suid)); res < 0 { |
|  |  | return errors.Wrapf(err.(syscall.Errno), "setting uids") |
|  |  | } |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | func getUids() (int, int, int) { |
|  |  | var ruid, euid, suid C.uid\_t |
|  |  | C.getresuid(&ruid, &euid, &suid) |
|  |  | return int(ruid), int(euid), int(suid) |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `315f9b0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgoogle%2Ffscrypt%2Fcommit%2F315f9b042237200174a1fb99427f74027e191d66) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from launchpad.net_34629631_20250125_220656.html ===

[Log in / Register](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Blogin)

[![](https://launchpadlibrarian.net/606381979/CoF%2064px.png)](https://launchpad.net/ubuntu)

## [Ubuntu](https://launchpad.net/ubuntu)[fscrypt package](https://launchpad.net/ubuntu/%2Bsource/fscrypt)

* [Overview](https://launchpad.net/ubuntu/%2Bsource/fscrypt)
* [Code](https://code.launchpad.net/ubuntu/%2Bsource/fscrypt)
* [Bugs](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt)
* Blueprints
* [Translations](https://translations.launchpad.net/ubuntu/%2Bsource/fscrypt)
* [Answers](https://answers.launchpad.net/ubuntu/%2Bsource/fscrypt)

# PAM fscrypt adds root(0) group to all users called by su

Bug #1787548 reported by
[Mark](https://launchpad.net/~markthecodehamster)
on 2018-08-17

[260](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [Shadow](https://bugs.launchpad.net/shadow) | Invalid | Undecided | Unassigned |  |
|  | [fscrypt (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt "Latest release: 0.3.5-1, uploaded to main on 2024-10-27 04:28:43.328912+00:00 by Debian Go Packaging Team (team+pkg-go), maintained by Debian Go Packaging Team (team+pkg-go)") | Fix Released | Medium | Unassigned |  |
|  | [shadow (Ubuntu)](https://bugs.launchpad.net/ubuntu/%2Bsource/shadow "Latest release: 1:4.16.0-7ubuntu1, uploaded to main on 2025-01-13 22:04:10.516110+00:00 by Skia (hyask), maintained by Ubuntu Developers (ubuntu-devel-discuss-lists)") | Invalid | Undecided | Unassigned |  |

### Bug Description

related packages: /bin/su (from login , shadow)

OS: ubuntu 18.04.1, updated

Bug: a normal user (not in 'root' group), when the PAM module fscrypt is active, all calls of su give the user additional group root(0).

Results: this is a permission escalation, such user can now delete files owned by root group (where permisions are g+w)

Steps to reproduce:

0/ login uses pam unix authentication module (default on ubuntu, no action needed)

0.1/ create a new user:

# useradd developer

1/ verify:

#id developer

// on my system, shows

// uid=1004(developer) gid=1004(developer) groups=1004(developer)

\su - developer -c id

sudo -u developer id

2/ enable pam-fscrypt

# apt install libpam-fscrypt

# pam-auth-update --enable fscrypt

3/ verify again (bug shows)

// repeate step 1/

// the su command will show the bug (sudo won't, interestingly)

\su - developer -c id

// uid=1004(developer) gid=1004(developer) groups=1004(developer),0(root)

4/ workaround and return to original state:

pam-auth-update --disable fscrypt

apt remove libpam-fscrypt

Thank you,

## CVE References

* [2018-6558](/bugs/cve/2018-6558 "The pam_fscrypt module in fscrypt bef...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2018-08-17: |  |  | [#1](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/1) |
| --- | --- | --- | --- |

Mark, nice discovery, thanks for the report. I've asked upstream fscrypt authors for assistance.

Thanks

Mark, nice discovery, thanks for the report. I've asked upstream fscrypt authors for assistance.
Thanks

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-18: |  |  | [#2](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/2) |
| --- | --- | --- | --- |

* [Fix for the bug](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5176999/%2Bfiles/0001-Cleanup-privilege-dropping-code.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5176999)
  (7.6 KiB,
  text/plain)

Mark, thank you so much for finding this bug.

I'm the maintainer for fscrypt, and the attached patch (when applied to fscrypt's master branch) seems to resolve this issue. I ran a few tests on my local system (along with fscrypt's existing tests) and everything still seems to be working.

The bug was caused by the fscrypt PAM module's privilege dropping code. It would drop privileges (for security, ironically enough) before performing unprivileged actions on behalf of the user. However, when restoring privileges before the PAM module exited, the EUID EGID and groups were all set back to root. However, when running su, the GID and groups in a PAM module are those of the user (while the UID is root). So this restored \_too many\_ privileges making the user part of the root group.

Let me know if there are any issues, if this patch breaks things, or if it doesn't fix the bug.

Joe

Mark, thank you so much for finding this bug.
I'm the maintainer for fscrypt, and the attached patch (when applied to fscrypt's master branch) seems to resolve this issue. I ran a few tests on my local system (along with fscrypt's existing tests) and everything still seems to be working.
The bug was caused by the fscrypt PAM module's privilege dropping code. It would drop privileges (for security, ironically enough) before performing unprivileged actions on behalf of the user. However, when restoring privileges before the PAM module exited, the EUID EGID and groups were all set back to root. However, when running su, the GID and groups in a PAM module are those of the user (while the UID is root). So this restored \_too many\_ privileges making the user part of the root group.
Let me know if there are any issues, if this patch breaks things, or if it doesn't fix the bug.
Joe

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark (markthecodehamster)](https://launchpad.net/~markthecodehamster) wrote on 2018-08-18: |  |  | [#3](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/3) |
| --- | --- | --- | --- |

Hi Joe,

thank you very much for such a swift response and fixing the bug!

And also for the very useful explanation, which let's me better understand the patch.

I'm sorry though, I won't be able to test your patch (I'm traveling to a conference and I won't be able to setup my system to compile fscrypt from source soon). But I bet you've tested it well.

If you don't mind, I have some comments to the code/patch (bear with me, I don't speak GO and know the code of pam-fscrypt only from this patch, so I may be completely stupid..)

> // StopAsPamUser restores the original privileges that were running the

Â // PAM module (this is usually root). As this error is often ignored in a defer

Â // statement, any error is also logged.

Â func (h \*Handle) StopAsPamUser() error {

- err := security.SetProcessPrivileges(h.OrigUser)

+ err := security.SetProcessPrivileges(h.origPrivs)

Â Â if err != nil {

Â Â Â log.Print(err)

Â Â }

I'm surprised by the comment "this err is often ignored..", as this seems the critical part (returning to orig privileges). Although it returns error(?) so a failure is probably handeled elsewhere on a higher layer. (Actually, how is this handeled? - if there's an err in privilege escalation, it's ok, you'd just say "sorry, fscrypt failed to run"; but if deescalation fails - what'd you do? Kill the process, kernel panic?)

> + n, err := C.getgroups(C.int(len(groups)), &groups[0])

+ if n < 0 {

+ return nil, err

+ }

Couple of things here, although likely just nitpiks.

You index groups w/o checking for size>0, although I wasn't able to create a user who is not in atleast 1 grp. maybe the make() can fail?

if could be if n < 1: error;

on the line "n, err :=" you don't check for err, you do it everywhere else. But probably getgroups cannot fail and only returns n>0 if no err?

> +// specified by privs. The original privileges can be by first saving the output

typo: can be ..obtained?..by

The patch looks like a nice cleanup that simplifies things.

Thank you for your work on the project!

cheers, Mark

Hi Joe,
thank you very much for such a swift response and fixing the bug!
And also for the very useful explanation, which let's me better understand the patch.
I'm sorry though, I won't be able to test your patch (I'm traveling to a conference and I won't be able to setup my system to compile fscrypt from source soon). But I bet you've tested it well.
If you don't mind, I have some comments to the code/patch (bear with me, I don't speak GO and know the code of pam-fscrypt only from this patch, so I may be completely stupid..)
> // StopAsPamUser restores the original privileges that were running the
// PAM module (this is usually root). As this error is often ignored in a defer
// statement, any error is also logged.
func (h \*Handle) StopAsPamUser() error {
- err := security.SetProcessPrivileges(h.OrigUser)
+ err := security.SetProcessPrivileges(h.origPrivs)
if err != nil {
log.Print(err)
}
I'm surprised by the comment "this err is often ignored..", as this seems the critical part (returning to orig privileges). Although it returns error(?) so a failure is probably handeled elsewhere on a higher layer. (Actually, how is this handeled? - if there's an err in privilege escalation, it's ok, you'd just say "sorry, fscrypt failed to run"; but if deescalation fails - what'd you do? Kill the process, kernel panic?)
> + n, err := C.getgroups(C.int(len(groups)), &groups[0])
+ if n < 0 {
+ return nil, err
+ }
Couple of things here, although likely just nitpiks.
You index groups w/o checking for size>0, although I wasn't able to create a user who is not in atleast 1 grp. maybe the make() can fail?
if could be if n < 1: error;
on the line "n, err :=" you don't check for err, you do it everywhere else. But probably getgroups cannot fail and only returns n>0 if no err?
> +// specified by privs. The original privileges can be by first saving the output
typo: can be ..obtained?..by
The patch looks like a nice cleanup that simplifies things.
Thank you for your work on the project!
cheers, Mark

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-21: |  |  | [#4](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/4) |
| --- | --- | --- | --- |

* [Revised Patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5178553/%2Bfiles/0001-Cleanup-privilege-dropping-code.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5178553)
  (8.0 KiB,
  text/plain)

Hey Mark,

Thanks for the comments. I incorporated them into the revised patch.

> I'm surprised by the comment "this err is often ignored..", as this seems the critical part (returning to orig privileges). Although it returns error(?) so a failure is probably handeled elsewhere on a higher layer. (Actually, how is this handeled? - if there's an err in privilege escalation, it's ok, you'd just say "sorry, fscrypt failed to run"; but if deescalation fails - what'd you do? Kill the process, kernel panic?)

This turns out to be a fairly tricky issue as pam\_fscrypt runs as "optional" for Auth/Session/Password, meaning a PAM\_SERVICE\_ERR it returns will only end up being logged in the default configuration (as errors with the user's fscrypt setup \_should not\_ block login). Right now I've just removed the comment about the error being ignored (you're right it should just be handled at a higher level).

Killing the process isn't an option because it would also block login. However, now the the privileges changing code is correct, a failure at any point in pam\_fscrypt should no longer result in an insecure state (although it may put su or the login process in a bad state). For example, now if StopAsPamUser fails to run at all, running "su test" results in a system error.

I should note that the eventual goal is to remove most of the PAM code and integrate most the session control stuff with the init system. But that's a long way off. See <https://github.com/google/fscrypt/issues/95>

> You index groups w/o checking for size>0, although I wasn't able to create a user who is not in atleast 1 grp. maybe the make() can fail?

Good catch on this! I've updated the code to handle the "user in 0 groups case". I was able to get a process executing in which getgroups() returned an empty array, so the code should handle it. The main issue here isn't the make() failing, but the call to setgroups() killing the process when using &privs.groups[0] without a bounds check.

> typo: can be ..obtained?..by

Fixed

Hey Mark,
Thanks for the comments. I incorporated them into the revised patch.
> I'm surprised by the comment "this err is often ignored..", as this seems the critical part (returning to orig privileges). Although it returns error(?) so a failure is probably handeled elsewhere on a higher layer. (Actually, how is this handeled? - if there's an err in privilege escalation, it's ok, you'd just say "sorry, fscrypt failed to run"; but if deescalation fails - what'd you do? Kill the process, kernel panic?)
This turns out to be a fairly tricky issue as pam\_fscrypt runs as "optional" for Auth/Session/Password, meaning a PAM\_SERVICE\_ERR it returns will only end up being logged in the default configuration (as errors with the user's fscrypt setup \_should not\_ block login). Right now I've just removed the comment about the error being ignored (you're right it should just be handled at a higher level).
Killing the process isn't an option because it would also block login. However, now the the privileges changing code is correct, a failure at any point in pam\_fscrypt should no longer result in an insecure state (although it may put su or the login process in a bad state). For example, now if StopAsPamUser fails to run at all, running "su test" results in a system error.
I should note that the eventual goal is to remove most of the PAM code and integrate most the session control stuff with the init system. But that's a long way off. See https://github.com/google/fscrypt/issues/95
> You index groups w/o checking for size>0, although I wasn't able to create a user who is not in atleast 1 grp. maybe the make() can fail?
Good catch on this! I've updated the code to handle the "user in 0 groups case". I was able to get a process executing in which getgroups() returned an empty array, so the code should handle it. The main issue here isn't the make() failing, but the call to setgroups() killing the process when using &privs.groups[0] without a bounds check.
> typo: can be ..obtained?..by
Fixed

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Alex Murray (alexmurray)](https://launchpad.net/~alexmurray) wrote on 2018-08-22: |  |  | [#5](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/5) |
| --- | --- | --- | --- |

The issue has been assigned CVE-2018-6558

The issue has been assigned CVE-2018-6558

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tyler Hicks (tyhicks)](https://launchpad.net/~tyhicks) wrote on 2018-08-22: |  |  | [#6](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/6) |
| --- | --- | --- | --- |

@Joe I just noticed that the proposed fix breaks the ability to do a simple 'su - <USER>' where <USER> is not root or the current user and the current user is unprivileged:

$ su - fs

Password:

su: System error

Here's the debug logging from pam\_fscrypt:

pam\_fscrypt[5468]: Authenticate()

pam\_fscrypt[5468]: keyringID(\_uid.1001) = 834965334, <nil>

pam\_fscrypt[5468]: KeyctlLink(834965334, -2) = <nil>

pam\_fscrypt[5468]: keyringID(session) = 132871448, <nil>

pam\_fscrypt[5468]: KeyctlSearch(132871448, keyring, \_uid.1001) = -1, required key not available

pam\_fscrypt[5468]: Setting up keyrings in PAM: user keyring not linked into session keyring

pam\_fscrypt[5468]: Setting euid=1001 egid=1001 groups=[1001]

pam\_fscrypt[5468]: pam func failed: setting egid: operation not permitted

In the comand above, UID 1000 is invoking su and attempting to change UID 1001.

The debug logging doesn't mention what the original euid, egid, and supplementary groups are when the pam\_fscrypt Authenticate() function is first entered but I suspect that the euid is the is that of the original user invoking su (1000). The process doesn't have sufficient privs to switch to egid 1001, Authenicate() returns an error, and the whole thing fails. I'm not certain but maybe the correct thing to do in this case is return PAM\_IGNORE rather than PAM\_SERVICE\_ERR.

@Joe I just noticed that the proposed fix breaks the ability to do a simple 'su - <USER>' where <USER> is not root or the current user and the current user is unprivileged:
$ su - fs
Password:
su: System error
Here's the debug logging from pam\_fscrypt:
pam\_fscrypt[5468]: Authenticate()
pam\_fscrypt[5468]: keyringID(\_uid.1001) = 834965334, <nil>
pam\_fscrypt[5468]: KeyctlLink(834965334, -2) = <nil>
pam\_fscrypt[5468]: keyringID(session) = 132871448, <nil>
pam\_fscrypt[5468]: KeyctlSearch(132871448, keyring, \_uid.1001) = -1, required key not available
pam\_fscrypt[5468]: Setting up keyrings in PAM: user keyring not linked into session keyring
pam\_fscrypt[5468]: Setting euid=1001 egid=1001 groups=[1001]
pam\_fscrypt[5468]: pam func failed: setting egid: operation not permitted
In the comand above, UID 1000 is invoking su and attempting to change UID 1001.
The debug logging doesn't mention what the original euid, egid, and supplementary groups are when the pam\_fscrypt Authenticate() function is first entered but I suspect that the euid is the is that of the original user invoking su (1000). The process doesn't have sufficient privs to switch to egid 1001, Authenicate() returns an error, and the whole thing fails. I'm not certain but maybe the correct thing to do in this case is return PAM\_IGNORE rather than PAM\_SERVICE\_ERR.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-22: |  |  | [#7](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/7) |
| --- | --- | --- | --- |

* [0001-Ensure-setting-user-privileges-is-reversible.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179133/%2Bfiles/0001-Ensure-setting-user-privileges-is-reversible.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179133)
  (8.4 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-22: |  |  | [#8](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/8) |
| --- | --- | --- | --- |

* [0002-Ensure-keyring-privilege-changes-are-reversible.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179134/%2Bfiles/0002-Ensure-keyring-privilege-changes-are-reversible.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179134)
  (4.9 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-22: |  |  | [#9](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/9) |
| --- | --- | --- | --- |

* [0003-Improve-debug-and-error-output-for-pam\_fscrypt.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179135/%2Bfiles/0003-Improve-debug-and-error-output-for-pam_fscrypt.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179135)
  (5.4 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-22: |  |  | [#10](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/10) |
| --- | --- | --- | --- |

So the attached patch set should solve the issue Tyler pointed out. It ended up not being an issue with the PAM return codes, but an issue with the privs themselves. The "System Error" comes the privs not being properly restored.

It was a little more involved to fix all of the privilege changing code, but now everything should be nice and reversible, no matter what the original privs.

So the attached patch set should solve the issue Tyler pointed out. It ended up not being an issue with the PAM return codes, but an issue with the privs themselves. The "System Error" comes the privs not being properly restored.
It was a little more involved to fix all of the privilege changing code, but now everything should be nice and reversible, no matter what the original privs.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tyler Hicks (tyhicks)](https://launchpad.net/~tyhicks) wrote on 2018-08-22: |  |  | [#11](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/11) |
| --- | --- | --- | --- |

Thanks, the new patches do fix the regression that I mentioned in comment 6.

Thanks, the new patches do fix the regression that I mentioned in comment 6.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Joe Richey (joerichey)](https://launchpad.net/~joerichey) wrote on 2018-08-23: |  |  | [#12](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/12) |
| --- | --- | --- | --- |

Release v0.2.4 is out containing the fix:

<https://github.com/google/fscrypt/releases/tag/v0.2.4>

Release v0.2.4 is out containing the fix:
https://github.com/google/fscrypt/releases/tag/v0.2.4

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tyler Hicks (tyhicks)](https://launchpad.net/~tyhicks) wrote on 2018-08-23: |  |  | [#13](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/13) |
| --- | --- | --- | --- |

I've uploaded an fscrypt security update to the Ubuntu Security PPA. Ubuntu Security will release it once they've reviewed and approved the changes.

I've uploaded an fscrypt security update to the Ubuntu Security PPA. Ubuntu Security will release it once they've reviewed and approved the changes.

| **information type**: | Private Security â†’ Public Security |
| --- | --- |
| Changed in shadow (Ubuntu): | |
| **status**: | New â†’ Invalid |
| Changed in shadow: | |
| **status**: | New â†’ Invalid |
| Changed in fscrypt (Ubuntu): | |
| **status**: | New â†’ Confirmed |
| **importance**: | Undecided â†’ Medium |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Launchpad Janitor (janitor)](https://launchpad.net/~janitor) wrote on 2018-08-24: |  |  | [#14](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/comments/14) |
| --- | --- | --- | --- |

This bug was fixed in the package fscrypt - 0.2.2-0ubuntu2.1

---------------

fscrypt (0.2.2-0ubuntu2.1) bionic-security; urgency=medium

\* SECURITY UPDATE: Privilege escalation via improperly restored

Â Â Â Â supplementary groups in libpam-fscrypt (LP: [#1787548](/bugs/1787548))

Â Â Â Â - CVE-2018-6558.patch: Save the euid, egid, and supplementary groups when

Â Â Â Â Â Â entering the PAM module, drop privileges to perform actions on behalf of

Â Â Â Â Â Â the user, and then properly restore the saved values before exiting the

Â Â Â Â Â Â PAM module. Based on patch from upstream.

Â Â Â Â - CVE-2018-6558

Â Â \* 0001-security-drop-and-regain-privileges-in-all-threads.patch: Drop and

Â Â Â Â regain privileges in all threads of the current process

Â Â \* 0001-Ensure-keyring-privilege-changes-are-reversible.patch: Ensure keyring

Â Â Â Â privilege changes are reversible to prevent failures when, for example,

Â Â Â Â "su <user>" is executed as an unprivileged user

-- Tyler Hicks <email address hidden> Wed, 22 Aug 2018 18:57:26 +0000

This bug was fixed in the package fscrypt - 0.2.2-0ubuntu2.1
---------------
fscrypt (0.2.2-0ubuntu2.1) bionic-security; urgency=medium
\* SECURITY UPDATE: Privilege escalation via improperly restored
supplementary groups in libpam-fscrypt (LP: #1787548)
- CVE-2018-6558.patch: Save the euid, egid, and supplementary groups when
entering the PAM module, drop privileges to perform actions on behalf of
the user, and then properly restore the saved values before exiting the
PAM module. Based on patch from upstream.
- CVE-2018-6558
\* 0001-security-drop-and-regain-privileges-in-all-threads.patch: Drop and
regain privileges in all threads of the current process
\* 0001-Ensure-keyring-privilege-changes-are-reversible.patch: Ensure keyring
privilege changes are reversible to prevent failures when, for example,
"su <user>" is executed as an unprivileged user
-- Tyler Hicks <tyhicks@canonical.com> Wed, 22 Aug 2018 18:57:26 +0000

| Changed in fscrypt (Ubuntu): | |
| --- | --- |
| **status**: | Confirmed â†’ Fix Released |

[See full activity log](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/ubuntu/%2Bsource/fscrypt/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [Fix for the bug](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5176999/%2Bfiles/0001-Cleanup-privilege-dropping-code.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5176999 "Change patch details")
* [Revised Patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5178553/%2Bfiles/0001-Cleanup-privilege-dropping-code.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5178553 "Change patch details")
* [0001-Ensure-setting-user-privileges-is-reversible.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179133/%2Bfiles/0001-Ensure-setting-user-privileges-is-reversible.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179133 "Change patch details")
* [0002-Ensure-keyring-privilege-changes-are-reversible.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179134/%2Bfiles/0002-Ensure-keyring-privilege-changes-are-reversible.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179134 "Change patch details")
* [0003-Improve-debug-and-error-output-for-pam\_fscrypt.patch](https://bugs.launchpad.net/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179135/%2Bfiles/0003-Improve-debug-and-error-output-for-pam_fscrypt.patch)
  [Edit](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Battachment/5179135 "Change patch details")

* [Add patch](/ubuntu/%2Bsource/fscrypt/%2Bbug/1787548/%2Baddcomment?field.patch=on)

## Remote bug watches

* [auto-github-google-fscrypt #95](https://github.com/google/fscrypt/issues/95)

  [open enhancement]
  [Edit](/bugs/1787548/%2Bwatch/130085 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
Â â€¢
[Take the tour](https://launchpad.net/%2Btour)
Â â€¢
[Read the guide](https://help.launchpad.net/)

Â© 2004
[CanonicalÂ Ltd.](http://canonical.com/)
Â â€¢
[Terms of use](https://launchpad.net/legal)
Â â€¢
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
Â â€¢
[Contact Launchpad Support](/feedback)
Â â€¢
[Blog](http://blog.launchpad.net/)
Â â€¢
[Careers](https://canonical.com/careers)
Â â€¢
[System status](https://ubuntu.social/%40launchpadstatus)
Â â€¢
4d55102
([Get the code!](https://dev.launchpad.net/))


