=== Content from bugs.launchpad.net_5b9566a9_20250125_164327.html ===

[Log in / Register](https://bugs.launchpad.net/neutron/%2Bbug/1767422/%2Blogin)

[![](https://launchpadlibrarian.net/337040413/OpenStack_Project_Neutron_mascot_64x64.png)](https://launchpad.net/neutron)

## [neutron](https://launchpad.net/neutron)

* [Overview](https://launchpad.net/neutron)
* [Code](https://code.launchpad.net/neutron)
* [Bugs](https://bugs.launchpad.net/neutron)
* [Blueprints](https://blueprints.launchpad.net/neutron)
* [Translations](https://translations.launchpad.net/neutron)
* [Answers](https://answers.launchpad.net/neutron)

# Neutron agent internal ports remain untagged for some time, which makes them trunk ports

Bug #1767422 reported by
[Miguel Angel Ajo](https://launchpad.net/~mangelajo)
on 2018-04-27

[10](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [neutron](https://bugs.launchpad.net/neutron) | Fix Released | High | [Jakub Libosvar](https://launchpad.net/~libosvar) | [neutron rocky-1](https://launchpad.net/neutron/%2Bmilestone/rocky-1) |

### Bug Description

Neutron agent ports are added to br-int without any tag. That makes them trunk ports (receiving traffic for all VLANs) until neutron-openvswitch-agent will handle them.

Sometimes the ports are left untagged forever, meaning that for example ha-router ha port will receive traffic directly from the external network (jumps to br-int to br-ex , and also back), or dnsmasq receives requests on the external network.

Outgoing traffic is dropped in br-ex though..

Vague details here (it's all we have so far):

This also becomes an issue (still under investigation) with the ovs-vswitchd agent and the revalidator thread (the thread that will check the kernel datapath flows under some circumstances to get stuck, for some reason it slows down a lot while analyzing trunk ports, eventually crashing the node on CPU usage).

This is also related to one security lp here: <https://bugs.launchpad.net/bugs/1734320>

See [original description](comments/0)

Tags:

[in-stable-ocata](/neutron/%2Bbugs?field.tag=in-stable-ocata)
[in-stable-pike](/neutron/%2Bbugs?field.tag=in-stable-pike)
[in-stable-queens](/neutron/%2Bbugs?field.tag=in-stable-queens)
[neutron-proactive-backport-potential](/neutron/%2Bbugs?field.tag=neutron-proactive-backport-potential)

[Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo)
on 2018-04-27

| Changed in neutron: | |
| --- | --- |
| **importance**: | Undecided → High |
| **assignee**: | nobody → Miguel Angel Ajo (mangelajo) |
| **milestone**: | none → rocky-1 |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo) wrote on 2018-04-27: |  |  | [#1](/neutron/%2Bbug/1767422/comments/1) |
| --- | --- | --- | --- |

Related to : <https://bugzilla.redhat.com/show_bug.cgi?id=1558336>

Related to : https://bugzilla.redhat.com/show\_bug.cgi?id=1558336

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-04-27:  [**Fix proposed to neutron (master)**](/neutron/%2Bbug/1767422/comments/2) |  |  | [#2](/neutron/%2Bbug/1767422/comments/2) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.openstack.org/564825>

Fix proposed to branch: master
Review: https://review.openstack.org/564825

| Changed in neutron: | |
| --- | --- |
| **status**: | New → In Progress |

[Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo)
on 2018-04-27

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-08:  [**Fix proposed to neutron (stable/queens)**](/neutron/%2Bbug/1767422/comments/3) |  |  | [#3](/neutron/%2Bbug/1767422/comments/3) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/queens

Review: <https://review.openstack.org/566864>

Fix proposed to branch: stable/queens
Review: https://review.openstack.org/566864

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-08:  [**Fix proposed to neutron (stable/pike)**](/neutron/%2Bbug/1767422/comments/4) |  |  | [#4](/neutron/%2Bbug/1767422/comments/4) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/pike

Review: <https://review.openstack.org/566865>

Fix proposed to branch: stable/pike
Review: https://review.openstack.org/566865

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2018-05-09

| Changed in neutron: | |
| --- | --- |
| **assignee**: | Miguel Angel Ajo (mangelajo) → Slawek Kaplonski (slaweq) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-09:  [**Fix proposed to neutron (master)**](/neutron/%2Bbug/1767422/comments/5) |  |  | [#5](/neutron/%2Bbug/1767422/comments/5) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.openstack.org/567225>

Fix proposed to branch: master
Review: https://review.openstack.org/567225

| Changed in neutron: | |
| --- | --- |
| **assignee**: | Slawek Kaplonski (slaweq) → Jakub Libosvar (libosvar) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-09:  [**Change abandoned on neutron (master)**](/neutron/%2Bbug/1767422/comments/6) |  |  | [#6](/neutron/%2Bbug/1767422/comments/6) |
| --- | --- | --- | --- |

Change abandoned by Jakub Libosvar (<email address hidden>) on branch: master

Review: <https://review.openstack.org/567225>

Reason: Using ovs-ofctl mod-port doesn't work on ports in namespaces.

Change abandoned by Jakub Libosvar (jlibosva-redhat@email.cz) on branch: master
Review: https://review.openstack.org/567225
Reason: Using ovs-ofctl mod-port doesn't work on ports in namespaces.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-10:  [**Fix merged to neutron (master)**](/neutron/%2Bbug/1767422/comments/7) |  |  | [#7](/neutron/%2Bbug/1767422/comments/7) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/564825>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=88f5e11d8bf820b0124be0f6ec3c2d96011592d9>

Submitter: Zuul

Branch: master

commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9

Author: Miguel Angel Ajo <email address hidden>

Date: Fri Apr 27 18:05:48 2018 +0200

Avoid agents adding ports as trunk by default.

Agent OVS interface code adds ports without a vlan tag,

    if neutron-openvswitch-agent fails to set the tag, or takes

    too long, the port will be a trunk port, receiving

    traffic from the external network or any other port

    sending traffic on br-int.

Also, those kinds of ports are triggering a code path

    on the ovs-vswitchd revalidator thread which can eventually

    hog the CPU of the host (that's a bug under investigation [1])

[1] <https://bugzilla.redhat.com/show_bug.cgi?id=1558336>

Co-Authored-By: Slawek Kaplonski <email address hidden>

    Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c

    Closes-Bug: 1767422

Reviewed: https://review.openstack.org/564825
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=88f5e11d8bf820b0124be0f6ec3c2d96011592d9
Submitter: Zuul
Branch: master
commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9
Author: Miguel Angel Ajo <majopela@redhat.com>
Date: Fri Apr 27 18:05:48 2018 +0200
Avoid agents adding ports as trunk by default.
Agent OVS interface code adds ports without a vlan tag,
if neutron-openvswitch-agent fails to set the tag, or takes
too long, the port will be a trunk port, receiving
traffic from the external network or any other port
sending traffic on br-int.
Also, those kinds of ports are triggering a code path
on the ovs-vswitchd revalidator thread which can eventually
hog the CPU of the host (that's a bug under investigation [1])
[1] https://bugzilla.redhat.com/show\_bug.cgi?id=1558336
Co-Authored-By: Slawek Kaplonski <skaplons@redhat.com>
Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c
Closes-Bug: 1767422

| Changed in neutron: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-11:  [**Related fix proposed to neutron (stable/ocata)**](/neutron/%2Bbug/1767422/comments/8) |  |  | [#8](/neutron/%2Bbug/1767422/comments/8) |
| --- | --- | --- | --- |

Related fix proposed to branch: stable/ocata

Review: <https://review.openstack.org/567885>

Related fix proposed to branch: stable/ocata
Review: https://review.openstack.org/567885

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-11:  [**Fix proposed to neutron (stable/ocata)**](/neutron/%2Bbug/1767422/comments/9) |  |  | [#9](/neutron/%2Bbug/1767422/comments/9) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ocata

Review: <https://review.openstack.org/567901>

Fix proposed to branch: stable/ocata
Review: https://review.openstack.org/567901

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-15:  [**Fix merged to neutron (stable/queens)**](/neutron/%2Bbug/1767422/comments/10) |  |  | [#10](/neutron/%2Bbug/1767422/comments/10) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/566864>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd>

Submitter: Zuul

Branch: stable/queens

commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd

Author: Miguel Angel Ajo <email address hidden>

Date: Fri Apr 27 18:05:48 2018 +0200

Avoid agents adding ports as trunk by default.

Agent OVS interface code adds ports without a vlan tag,

    if neutron-openvswitch-agent fails to set the tag, or takes

    too long, the port will be a trunk port, receiving

    traffic from the external network or any other port

    sending traffic on br-int.

Also, those kinds of ports are triggering a code path

    on the ovs-vswitchd revalidator thread which can eventually

    hog the CPU of the host (that's a bug under investigation [1])

[1] <https://bugzilla.redhat.com/show_bug.cgi?id=1558336>

Co-Authored-By: Slawek Kaplonski <email address hidden>

    Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c

    Closes-Bug: 1767422

    (cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)

Reviewed: https://review.openstack.org/566864
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd
Submitter: Zuul
Branch: stable/queens
commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd
Author: Miguel Angel Ajo <majopela@redhat.com>
Date: Fri Apr 27 18:05:48 2018 +0200
Avoid agents adding ports as trunk by default.
Agent OVS interface code adds ports without a vlan tag,
if neutron-openvswitch-agent fails to set the tag, or takes
too long, the port will be a trunk port, receiving
traffic from the external network or any other port
sending traffic on br-int.
Also, those kinds of ports are triggering a code path
on the ovs-vswitchd revalidator thread which can eventually
hog the CPU of the host (that's a bug under investigation [1])
[1] https://bugzilla.redhat.com/show\_bug.cgi?id=1558336
Co-Authored-By: Slawek Kaplonski <skaplons@redhat.com>
Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c
Closes-Bug: 1767422
(cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-05-15:  [**Fix merged to neutron (stable/pike)**](/neutron/%2Bbug/1767422/comments/11) |  |  | [#11](/neutron/%2Bbug/1767422/comments/11) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/566865>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=adb0ac4e5454391d68026cbeee93169578a10743>

Submitter: Zuul

Branch: stable/pike

commit adb0ac4e5454391d68026cbeee93169578a10743

Author: Miguel Angel Ajo <email address hidden>

Date: Fri Apr 27 18:05:48 2018 +0200

Avoid agents adding ports as trunk by default.

Agent OVS interface code adds ports without a vlan tag,

    if neutron-openvswitch-agent fails to set the tag, or takes

    too long, the port will be a trunk port, receiving

    traffic from the external network or any other port

    sending traffic on br-int.

Also, those kinds of ports are triggering a code path

    on the ovs-vswitchd revalidator thread which can eventually

    hog the CPU of the host (that's a bug under investigation [1])

[1] <https://bugzilla.redhat.com/show_bug.cgi?id=1558336>

Conflicts:

        neutron/tests/functional/agent/test\_ovs\_lib.py

needed the addition of the following import:

    from neutron.plugins.ml2.drivers.openvswitch.agent.common import (

        constants as agent\_const)

Co-Authored-By: Slawek Kaplonski <email address hidden>

    Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c

    Closes-Bug: 1767422

    (cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)

    (cherry picked from commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd)

Reviewed: https://review.openstack.org/566865
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=adb0ac4e5454391d68026cbeee93169578a10743
Submitter: Zuul
Branch: stable/pike
commit adb0ac4e5454391d68026cbeee93169578a10743
Author: Miguel Angel Ajo <majopela@redhat.com>
Date: Fri Apr 27 18:05:48 2018 +0200
Avoid agents adding ports as trunk by default.
Agent OVS interface code adds ports without a vlan tag,
if neutron-openvswitch-agent fails to set the tag, or takes
too long, the port will be a trunk port, receiving
traffic from the external network or any other port
sending traffic on br-int.
Also, those kinds of ports are triggering a code path
on the ovs-vswitchd revalidator thread which can eventually
hog the CPU of the host (that's a bug under investigation [1])
[1] https://bugzilla.redhat.com/show\_bug.cgi?id=1558336
Conflicts:
neutron/tests/functional/agent/test\_ovs\_lib.py
needed the addition of the following import:
from neutron.plugins.ml2.drivers.openvswitch.agent.common import (
constants as agent\_const)
Co-Authored-By: Slawek Kaplonski <skaplons@redhat.com>
Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c
Closes-Bug: 1767422
(cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)
(cherry picked from commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd)

| **tags**: | added: in-stable-pike |
| --- | --- |

[Bernard Cafarelli (bcafarel)](https://launchpad.net/~bcafarel)
on 2018-05-31

| **tags**: | added: neutron-proactive-backport-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-06-07:  [**Fix included in openstack/neutron 13.0.0.0b2**](/neutron/%2Bbug/1767422/comments/12) |  |  | [#12](/neutron/%2Bbug/1767422/comments/12) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 13.0.0.0b2 development milestone.

This issue was fixed in the openstack/neutron 13.0.0.0b2 development milestone.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-06-18:  [**Fix included in openstack/neutron 12.0.3**](/neutron/%2Bbug/1767422/comments/13) |  |  | [#13](/neutron/%2Bbug/1767422/comments/13) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 12.0.3 release.

This issue was fixed in the openstack/neutron 12.0.3 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-06-18:  [**Fix included in openstack/neutron 11.0.5**](/neutron/%2Bbug/1767422/comments/14) |  |  | [#14](/neutron/%2Bbug/1767422/comments/14) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron 11.0.5 release.

This issue was fixed in the openstack/neutron 11.0.5 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-06-19:  [**Related fix merged to neutron (stable/ocata)**](/neutron/%2Bbug/1767422/comments/15) |  |  | [#15](/neutron/%2Bbug/1767422/comments/15) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/567885>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=e08233696816431b3f536bc556928491ecd14e2f>

Submitter: Zuul

Branch: stable/ocata

commit e08233696816431b3f536bc556928491ecd14e2f

Author: Miguel Angel Ajo <email address hidden>

Date: Wed May 9 16:23:41 2018 +0200

Don't delete flows on ports which were on dead vlan during plug

Ocata codebase of the neutron agent deletes\_flows

    when a port has been tagged and already had a tag.

Later versions implement uninstall\_flows to selectively delete

    specific flows, but such patches are big and buggy (have several

    follow up patches).

This prevents that the patch handling 1767422 will get the DSCP

    flows deleted when port is tagged. Which is detected by functional

    testing.

I have manually tested that setting a port admin\_state\_up False,

    and then True, will correctly move the port into dead vlan, and

    then back to non dead vlan, and properly remove the in\_port=x,DROP

    openflow rule regardless of this change.

Related: rhbz#1575706

    Related-Bug: 1767422

Change-Id: Ib7915ae7bb7f471ff70ce25ce3beb16189ad5394

Reviewed: https://review.openstack.org/567885
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=e08233696816431b3f536bc556928491ecd14e2f
Submitter: Zuul
Branch: stable/ocata
commit e08233696816431b3f536bc556928491ecd14e2f
Author: Miguel Angel Ajo <majopela@redhat.com>
Date: Wed May 9 16:23:41 2018 +0200
Don't delete flows on ports which were on dead vlan during plug
Ocata codebase of the neutron agent deletes\_flows
when a port has been tagged and already had a tag.
Later versions implement uninstall\_flows to selectively delete
specific flows, but such patches are big and buggy (have several
follow up patches).
This prevents that the patch handling 1767422 will get the DSCP
flows deleted when port is tagged. Which is detected by functional
testing.
I have manually tested that setting a port admin\_state\_up False,
and then True, will correctly move the port into dead vlan, and
then back to non dead vlan, and properly remove the in\_port=x,DROP
openflow rule regardless of this change.
Related: rhbz#1575706
Related-Bug: 1767422
Change-Id: Ib7915ae7bb7f471ff70ce25ce3beb16189ad5394

| **tags**: | added: in-stable-ocata |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2018-07-03:  [**Fix merged to neutron (stable/ocata)**](/neutron/%2Bbug/1767422/comments/16) |  |  | [#16](/neutron/%2Bbug/1767422/comments/16) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/567901>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=559bf87fd0d92e4d230058f5819c78f8b727d326>

Submitter: Zuul

Branch: stable/ocata

commit 559bf87fd0d92e4d230058f5819c78f8b727d326

Author: Miguel Angel Ajo <email address hidden>

Date: Fri Apr 27 18:05:48 2018 +0200

Avoid agents adding ports as trunk by default.

Agent OVS interface code adds ports without a vlan tag,

    if neutron-openvswitch-agent fails to set the tag, or takes

    too long, the port will be a trunk port, receiving

    traffic from the external network or any other port

    sending traffic on br-int.

Also, those kinds of ports are triggering a code path

    on the ovs-vswitchd revalidator thread which can eventually

    hog the CPU of the host (that's a bug under investigation [1])

[1] <https://bugzilla.redhat.com/show_bug.cgi?id=1558336>

Conflicts:

        neutron/tests/functional/agent/test\_ovs\_lib.py

needed the addition of the following import:

    from neutron.plugins.ml2.drivers.openvswitch.agent.common import (

        constants as agent\_const)

Co-Authored-By: Slawek Kaplonski <email address hidden>

    Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c

    Closes-Bug: 1767422

    (cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)

    (cherry picked from commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd)

Reviewed: https://review.openstack.org/567901
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=559bf87fd0d92e4d230058f5819c78f8b727d326
Submitter: Zuul
Branch: stable/ocata
commit 559bf87fd0d92e4d230058f5819c78f8b727d326
Author: Miguel Angel Ajo <majopela@redhat.com>
Date: Fri Apr 27 18:05:48 2018 +0200
Avoid agents adding ports as trunk by default.
Agent OVS interface code adds ports without a vlan tag,
if neutron-openvswitch-agent fails to set the tag, or takes
too long, the port will be a trunk port, receiving
traffic from the external network or any other port
sending traffic on br-int.
Also, those kinds of ports are triggering a code path
on the ovs-vswitchd revalidator thread which can eventually
hog the CPU of the host (that's a bug under investigation [1])
[1] https://bugzilla.redhat.com/show\_bug.cgi?id=1558336
Conflicts:
neutron/tests/functional/agent/test\_ovs\_lib.py
needed the addition of the following import:
from neutron.plugins.ml2.drivers.openvswitch.agent.common import (
constants as agent\_const)
Co-Authored-By: Slawek Kaplonski <skaplons@redhat.com>
Change-Id: I024bbbdf7059835b2f23c264b48478c71633a43c
Closes-Bug: 1767422
(cherry picked from commit 88f5e11d8bf820b0124be0f6ec3c2d96011592d9)
(cherry picked from commit 2b1d413ee90dfe2e9ae41c35ab37253df53fc6cd)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-05-14:  [**Fix included in openstack/neutron ocata-eol**](/neutron/%2Bbug/1767422/comments/17) |  |  | [#17](/neutron/%2Bbug/1767422/comments/17) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/neutron ocata-eol release.

This issue was fixed in the openstack/neutron ocata-eol release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-06-30:  [**Related fix proposed to neutron (master)**](/neutron/%2Bbug/1767422/comments/18) |  |  | [#18](/neutron/%2Bbug/1767422/comments/18) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/neutron/+/848312](https://review.opendev.org/c/openstack/neutron/%2B/848312)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/neutron/+/848312

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-07-08:  [**Related fix merged to neutron (master)**](/neutron/%2Bbug/1767422/comments/19) |  |  | [#19](/neutron/%2Bbug/1767422/comments/19) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/neutron/+/848312](https://review.opendev.org/c/openstack/neutron/%2B/848312)

Committed: <https://opendev.org/openstack/neutron/commit/308924e5fb65359a6ccd6c0a6a26d7fda48aebee>

Submitter: "Zuul (22348)"

Branch: master

commit 308924e5fb65359a6ccd6c0a6a26d7fda48aebee

Author: Rodolfo Alonso Hernandez <email address hidden>

Date: Wed Jul 6 07:42:33 2022 +0000

Remove workaround for LP#1767422

Since [1] and [2], the workaround done in [3] is no longer needed

    because we set the port tag when is bound and fixed the VLAN tag

    setting.

[1][https://review.opendev.org/c/openstack/neutron/+/819567](https://review.opendev.org/c/openstack/neutron/%2B/819567)

    [2][https://review.opendev.org/c/openstack/neutron/+/820897](https://review.opendev.org/c/openstack/neutron/%2B/820897)

    [3][https://review.opendev.org/c/openstack/neutron/+/566864](https://review.opendev.org/c/openstack/neutron/%2B/566864)

Closes-Bug: #1980126

    Related-Bug: #1767422

Change-Id: Iee35cde7bbfee0e809cf71c4542dfbdefc97209f

Reviewed: https://review.opendev.org/c/openstack/neutron/+/848312
Committed: https://opendev.org/openstack/neutron/commit/308924e5fb65359a6ccd6c0a6a26d7fda48aebee
Submitter: "Zuul (22348)"
Branch: master
commit 308924e5fb65359a6ccd6c0a6a26d7fda48aebee
Author: Rodolfo Alonso Hernandez <ralonsoh@redhat.com>
Date: Wed Jul 6 07:42:33 2022 +0000
Remove workaround for LP#1767422
Since [1] and [2], the workaround done in [3] is no longer needed
because we set the port tag when is bound and fixed the VLAN tag
setting.
[1]https://review.opendev.org/c/openstack/neutron/+/819567
[2]https://review.opendev.org/c/openstack/neutron/+/820897
[3]https://review.opendev.org/c/openstack/neutron/+/566864
Closes-Bug: #1980126
Related-Bug: #1767422
Change-Id: Iee35cde7bbfee0e809cf71c4542dfbdefc97209f

[See full activity log](https://bugs.launchpad.net/neutron/%2Bbug/1767422/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/neutron/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/neutron/%2Bbug/1767422/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/neutron/%2Bbug/1767422/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/neutron/%2Bbug/1767422/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

* [redhat-bugs #1558336](https://bugzilla.redhat.com/show_bug.cgi?id=1558336)

  [CLOSED NOTABUG]
  [Edit](/bugs/1767422/%2Bwatch/128786 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from access.redhat.com_95f432d3_20250126_102140.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from bugs.launchpad.net_38084be8_20250125_164326.html ===

[Log in / Register](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Blogin)

[![](https://launchpadlibrarian.net/337040413/OpenStack_Project_Neutron_mascot_64x64.png)](https://launchpad.net/neutron)

## [neutron](https://launchpad.net/neutron)

* [Overview](https://launchpad.net/neutron)
* [Code](https://code.launchpad.net/neutron)
* [Bugs](https://bugs.launchpad.net/neutron)
* [Blueprints](https://blueprints.launchpad.net/neutron)
* [Translations](https://translations.launchpad.net/neutron)
* [Answers](https://answers.launchpad.net/neutron)

# Eavesdropping private traffic

Bug #1734320 reported by
[Paul Peereboom](https://launchpad.net/~peereb)
on 2017-11-24

[50](/%2Bhelp-bugs/bug-heat.html)

This bug affects 4 people

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | Undecided | [sean mooney](https://launchpad.net/~sean-k-mooney) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Won't Fix | Undecided | Unassigned |  |
|  | [neutron](https://bugs.launchpad.net/neutron) | Fix Released | High | [Rodolfo Alonso](https://launchpad.net/~rodolfo-alonso-hernandez) |  |
|  | [os-vif](https://bugs.launchpad.net/os-vif) | Fix Released | High | [sean mooney](https://launchpad.net/~sean-k-mooney) |  |

### Bug Description

Eavesdropping private traffic

=============================

Abstract

--------

We've discovered a security issue that allows end users within their own private network to receive from, and send traffic to, other private networks on the same compute node.

Description

-----------

During live-migration there is a small time window where the ports of instances are untagged. Instances have a port trunked to the integration bridge and receive 802.1Q tagged private traffic from other tenants.

If the port is administratively down during live migration, the port will remain in trunk mode indefinitely.

Traffic is possible between ports is that are administratively down, even between tenants self-service networks.

Conditions

----------

The following conditions are necessary.

\* Openvswitch Self-service networks

\* An Openstack administrator or an automated process needs to schedule a Live migration

We tested this on newton.

Issues

------

This outcome is the result of multiple independent issues. We will list the most important first, and follow with bugs that create a fragile situation.

Issue #1 Initially creating a trunk port

When the port is initially created, it is in trunk mode. This creates a fail-open situation.

See: <https://github.com/openstack/os-vif/blob/newton-eol/vif_plug_ovs/linux_net.py#L52>

Recommendation: create ports in the port\_dead state, don't leave it dangling in trunk-mode. Add a drop-flow initially.

Issue #2 Order of creation.

The instance is actually migrated before the (networking) configuration is completed.

Recommendation: wait with finishing the live migration until the underlying configuration has been applied completely.

Issue #3 Not closing the port when it is down.

Neutron calls the port\_dead function to ensure the port is down. It sets the tag to 4095 and adds a "drop" flow if (and only if) there is already another tag on the port. The port\_dead function will keep untagged ports untagged.

<https://github.com/openstack/neutron/blob/stable/newton/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_neutron_agent.py#L995>

Recommendation: Make port\_dead also shut the port if no tag is found. Log a warning if this happens.

Issue #4 Putting the port administratively down actually puts the port on a compute node shared vlan

Instances from different projects on different private networks can talk to each other if they put their ports down. The code does install an openflow "drop" rule but it has a lower priority (2) than the allow rules.

Recommendation: Increase the port\_dead openflow drop rule priority to MAX

Timeline

--------

2017-09-14 Discovery eavesdropping issue

 2017-09-15 Verify workaround.

 2017-10-04 Discovery port-down-traffic issue

 2017-11-24 Vendor Disclosure to Openstack

Steps to reproduce

------------------

1. Attach an instance to two networks:

admin$ openstack server create --nic net-id=<net-uuid1> --nic net-id=<net-uuid2> --image <image\_id> --flavor <flavor\_id> instance\_temp

2. Attach a FIP to the instance to be able to log in to this instance

3. Verify:

admin$ openstack server show -c name -c addresses fe28a2ee-098f-4425-9d3c-8e2cd383547d

+-----------+-----------------------------------------------------------------------------+

| Field | Value |

+-----------+-----------------------------------------------------------------------------+

| addresses | network1=192.168.99.8, <FIP>; network2=192.168.80.14 |

| name | instance\_temp |

+-----------+-----------------------------------------------------------------------------+

4. Ssh to the instance using network1 and run a tcpdump on the other port network2

[root@instance\_temp]$ tcpdump -eeenni eth1

5. Get port-id of network2

admin$ nova interface-list fe28a2ee-098f-4425-9d3c-8e2cd383547d

+------------+--------------------------------------+--------------------------------------+---------------+-------------------+

| Port State | Port ID | Net ID | IP addresses | MAC Addr |

+------------+--------------------------------------+--------------------------------------+---------------+-------------------+

| ACTIVE | a848520b-0814-4030-bb48-49e4b5cf8160 | d69028f7-9558-4f14-8ce6-29cb8f1c19cd | 192.168.80.14 | fa:16:3e:2d:8b:7b |

| ACTIVE | fad148ca-cf7a-4839-aac3-a2cd8d1d2260 | d22c22ae-0a42-4e3b-8144-f28534c3439a | 192.168.99.8 | fa:16:3e:60:2c:fa |

+------------+--------------------------------------+--------------------------------------+---------------+-------------------+

6. Force port down on network 2

admin$ neutron port-update a848520b-0814-4030-bb48-49e4b5cf8160 --admin-state-up False

7. Port gets tagged with vlan 4095, the dead vlan tag, which is normal:

compute1# grep a848520b-0814-4030-bb48-49e4b5cf8160 /var/log/neutron/neutron-openvswitch-agent.log | tail -1

INFO neutron.plugins.ml2.drivers.openvswitch.agent.ovs\_neutron\_agent [req-e008feb3-8a35-4c97-adac-b48ff88165b2 - - - - -] VIF port: a848520b-0814-4030-bb48-49e4b5cf8160 admin state up disabled, putting on the dead VLAN

8. Verify the port is tagged with vlan 4095

compute1# ovs-vsctl show | grep -A3 qvoa848520b-08

      Port "qvoa848520b-08"

          tag: 4095

          Interface "qvoa848520b-08"

9. Now live-migrate the instance:

admin# nova live-migration fe28a2ee-098f-4425-9d3c-8e2cd383547d

10. Verify the tag is gone on compute2, and take a deep breath

compute2# ovs-vsctl show | grep -A3 qvoa848520b-08

      Port "qvoa848520b-08"

          Interface "qvoa848520b-08"

      Port...

compute2# echo "Wut!"

11. Now traffic of all other self-service networks present on compute2 can be sniffed from instance\_temp

[root@instance\_temp] tcpdump -eenni eth1

13:14:31.748266 fa:16:3e:6a:17:38 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 10, p 0, ethertype ARP, Request who-has 10.103.12.160 tell 10.103.12.152, length 28

13:14:31.804573 fa:16:3e:e8:a2:d2 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.70, length 28

13:14:31.810482 fa:16:3e:95:ca:3a > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.154, length 28

13:14:31.977820 fa:16:3e:6f:f4:9b > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.150, length 28

13:14:31.979590 fa:16:3e:0f:3d:cc > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 9, p 0, ethertype ARP, Request who-has 10.103.9.163 tell 10.103.9.1, length 28

13:14:32.048082 fa:16:3e:65:64:38 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.101, length 28

13:14:32.127400 fa:16:3e:30:cb:b5 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 10, p 0, ethertype ARP, Request who-has 10.103.12.160 tell 10.103.12.165, length 28

13:14:32.141982 fa:16:3e:96:cd:b0 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.100, length 28

13:14:32.205327 fa:16:3e:a2:0b:76 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.153, length 28

13:14:32.444142 fa:16:3e:1f:db:ed > 01:00:5e:00:00:12, ethertype 802.1Q (0x8100), length 58: vlan 72, p 0, ethertype IPv4, 192.168.99.212 > 224.0.0.18: VRRPv2, Advertisement, vrid 50, prio 103, authtype none, intvl 1s, length 20

13:14:32.449497 fa:16:3e:1c:24:c0 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.20, length 28

13:14:32.476015 fa:16:3e:f2:3b:97 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 33, p 0, ethertype ARP, Request who-has 10.0.1.9 tell 10.0.1.22, length 28

13:14:32.575034 fa:16:3e:44:fe:35 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 10, p 0, ethertype ARP, Request who-has 10.103.12.160 tell 10.103.12.163, length 28

13:14:32.676185 fa:16:3e:1e:92:d7 > ff:ff:ff:ff:ff:ff, ethertype 802.1Q (0x8100), length 46: vlan 10, p 0, ethertype ARP, Request who-has 10.103.12.160 tell 10.103.12.150, length 28

13:14:32.711755 fa:16:3e:99:6c:c8 > 01:00:5e:00:00:12, ethertype 802.1Q (0x8100), length 62: vlan 10, p 0, ethertype IPv4, 10.103.12.154 > 224.0.0.18: VRRPv2, Advertisement, vrid 2, prio 49, authtype simple, intvl 1s, length 24

13:14:32.711773 fa:16:3e:f5:23:d5 > 01:00:5e:00:00:12, ethertype 802.1Q (0x8100), length 58: vlan 12, p 0, ethertype IPv4, 10.103.15.154 > 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 49, authtype simple, intvl 1s, length 20

Workaround

----------

We temporary fixed this issue by forcing the dead vlan tag on port creation on compute nodes:

/usr/lib/python2.7/site-packages/vif\_plug\_ovs/linux\_net.py:

def \_create\_ovs\_vif\_cmd(bridge, dev, iface\_id, mac,

                        instance\_id, interface\_type=None,

                        vhost\_server\_path=None):

+ # ODCN: initialize port as dead

+ # ODCN: TODO: set drop flow

    cmd = ['--', '--if-exists', 'del-port', dev, '--',

            'add-port', bridge, dev,

+ 'tag=4095',

            '--', 'set', 'Interface', dev,

            'external-ids:iface-id=%s' % iface\_id,

            'external-ids:iface-status=active',

            'external-ids:attached-mac=%s' % mac,

            'external-ids:vm-uuid=%s' % instance\_id]

    if interface\_type:

        cmd += ['type=%s' % interface\_type]

    if vhost\_server\_path:

        cmd += ['options:vhost-server-path=%s' % vhost\_server\_path]

    return cmd

<https://github.com/openstack/neutron/blob/stable/newton/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_neutron_agent.py#L995>

def port\_dead(self, port, log\_errors=True):

        '''Once a port has no binding, put it on the "dead vlan".

:param port: an ovs\_lib.VifPort object.

        '''

        # Don't kill a port if it's already dead

        cur\_tag = self.int\_br.db\_get\_val("Port", port.port\_name, "tag",

                                         log\_errors=log\_errors)

+ # ODCN GM 20170915

+ if not cur\_tag:

+ LOG.error('port\_dead(): port %s has no tag', port.port\_name)

+ # ODCN AJS 20170915

+ if not cur\_tag or cur\_tag != constants.DEAD\_VLAN\_TAG:

- if cur\_tag and cur\_tag != constants.DEAD\_VLAN\_TAG:

           LOG.info('port\_dead(): put port %s on dead vlan', port.port\_name)

           self.int\_br.set\_db\_attribute("Port", port.port\_name, "tag",

                                         constants.DEAD\_VLAN\_TAG,

                                         log\_errors=log\_errors)

            self.int\_br.drop\_port(in\_port=port.ofport)

plugins/ml2/drivers/openvswitch/agent/openflow/ovs\_ofctl/ovs\_bridge.py

    def drop\_port(self, in\_port):

+ # ODCN AJS 20171004:

- self.install\_drop(priority=2, in\_port=in\_port)

+ self.install\_drop(priority=65535, in\_port=in\_port)

Regards,

ODC Noord.

Gerhard Muntingh

Albert Siersema

Paul Peereboom

See [original description](comments/0)

Tags:

[security](/neutron/%2Bbugs?field.tag=security)
[in-stable-pike](/neutron/%2Bbugs?field.tag=in-stable-pike)
[in-stable-queens](/neutron/%2Bbugs?field.tag=in-stable-queens)
[in-stable-rocky](/neutron/%2Bbugs?field.tag=in-stable-rocky)
[in-stable-victoria](/neutron/%2Bbugs?field.tag=in-stable-victoria)
[in-stable-wallaby](/neutron/%2Bbugs?field.tag=in-stable-wallaby)
[neutron-proactive-backport-potential](/neutron/%2Bbugs?field.tag=neutron-proactive-backport-potential)

## CVE References

* [2018-14636](/bugs/cve/2018-14636 "Live-migrated instances are briefly a...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-11-24: |  |  | [#1](/neutron/%2Bbug/1734320/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

| Changed in ossa: | |
| --- | --- |
| **status**: | New → Incomplete |
| **description**: | updated |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-24: |  |  | [#2](/neutron/%2Bbug/1734320/comments/2) |
| --- | --- | --- | --- |

Looking.

Looking.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-24: |  |  | [#3](/neutron/%2Bbug/1734320/comments/3) |
| --- | --- | --- | --- |

My fear is that this vulnerability might be present on releases newer than Newton.

My fear is that this vulnerability might be present on releases newer than Newton.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Kevin Benton (kevinbenton)](https://launchpad.net/~kevinbenton) wrote on 2017-11-24: |  |  | [#4](/neutron/%2Bbug/1734320/comments/4) |
| --- | --- | --- | --- |

The other thing that surprised me about this is that there are rules forwarding traffic to the port when it doesn't have a VLAN tag. Is the behavior of the NORMAL action to flood to all untagged ports as if they were trunks carrying all VLANs?

The other suggested fixes all seem to be working under the assumption that traffic will flow to ports if no rules are installed. I think it would be safest to ensure that a newly added port to br-int doesn't receive any traffic until flows are setup. Going that route would also avoid having to ban all earlier versions of os-vif because a VLAN tag would not need to be set on plugging.

The other thing that surprised me about this is that there are rules forwarding traffic to the port when it doesn't have a VLAN tag. Is the behavior of the NORMAL action to flood to all untagged ports as if they were trunks carrying all VLANs?
The other suggested fixes all seem to be working under the assumption that traffic will flow to ports if no rules are installed. I think it would be safest to ensure that a newly added port to br-int doesn't receive any traffic until flows are setup. Going that route would also avoid having to ban all earlier versions of os-vif because a VLAN tag would not need to be set on plugging.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-11-28: |  |  | [#5](/neutron/%2Bbug/1734320/comments/5) |
| --- | --- | --- | --- |

Should we subscribe the Nova project for the issue #2 (Order of creation)?

Also, isn't instance migration an admin only operation? If so, can a regular user abuse this bug without an admin cooperation?

Should we subscribe the Nova project for the issue #2 (Order of creation)?
Also, isn't instance migration an admin only operation? If so, can a regular user abuse this bug without an admin cooperation?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-28: |  |  | [#6](/neutron/%2Bbug/1734320/comments/6) |
| --- | --- | --- | --- |

@Tristan: perhaps looping in the nova project is not a bad idea, and yes, you're right that migration can only be performed by an admin according to the default policy.json.

@Tristan: perhaps looping in the nova project is not a bad idea, and yes, you're right that migration can only be performed by an admin according to the default policy.json.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-28: |  |  | [#7](/neutron/%2Bbug/1734320/comments/7) |
| --- | --- | --- | --- |

Today I was looking at this a bit to see if 'resizing' would expose the same behavior, as that is available to regular users. I shall be able to find more time tomorrow to assess what's going on pike and ocata.

Today I was looking at this a bit to see if 'resizing' would expose the same behavior, as that is available to regular users. I shall be able to find more time tomorrow to assess what's going on pike and ocata.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-11-28: |  |  | [#8](/neutron/%2Bbug/1734320/comments/8) |
| --- | --- | --- | --- |

Thanks Armando for the prompt feedback. I've subscribed nova-coresec to discuss the scope of this vulnerability, in particular the issue #2.

@nova-coresec, is it correct to assume migration operation are restricted to admin? If a deployment does authorize regular user to do migration operation, wouldn't they be vulnerable to other unexpected issues anyway?

Thanks Armando for the prompt feedback. I've subscribed nova-coresec to discuss the scope of this vulnerability, in particular the issue #2.
@nova-coresec, is it correct to assume migration operation are restricted to admin? If a deployment does authorize regular user to do migration operation, wouldn't they be vulnerable to other unexpected issues anyway?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Paul Peereboom (peereb)](https://launchpad.net/~peereb) wrote on 2017-11-28: |  |  | [#9](/neutron/%2Bbug/1734320/comments/9) |
| --- | --- | --- | --- |

@Tristan: yes nova live-migration is by default an admin only operation. But forcing the port-down can be done by a user aswell. Then it's just waiting for an admin to do a live-migration of a instance. We live-migrate instances regularly to empty a compute node and patch the compute node.

@Tristan: yes nova live-migration is by default an admin only operation. But forcing the port-down can be done by a user aswell. Then it's just waiting for an admin to do a live-migration of a instance. We live-migrate instances regularly to empty a compute node and patch the compute node.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-28: |  |  | [#10](/neutron/%2Bbug/1734320/comments/10) |
| --- | --- | --- | --- |

Block migration would also be affected by the same behavior.

Block migration would also be affected by the same behavior.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-11-28: |  |  | [#11](/neutron/%2Bbug/1734320/comments/11) |
| --- | --- | --- | --- |

@Paul, well I tend to agree this is a vulnerability (class A according to the VMT taxonomy: <http://security.openstack.org/vmt-process.html#incident-report-taxonomy> ). However, since a malicious user can't control the condition of exploitation, other VMT member may disagree with issuing an advisory for this issue.

I guess it boils down to how likely a user can snoop sensitive traffic.

@Paul, well I tend to agree this is a vulnerability (class A according to the VMT taxonomy: http://security.openstack.org/vmt-process.html#incident-report-taxonomy ). However, since a malicious user can't control the condition of exploitation, other VMT member may disagree with issuing an advisory for this issue.
I guess it boils down to how likely a user can snoop sensitive traffic.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-28: |  |  | [#12](/neutron/%2Bbug/1734320/comments/12) |
| --- | --- | --- | --- |

That's why I am trying to verify that the resize operation has the same behavior, because if that's the case, the user is very much in control!

That's why I am trying to verify that the resize operation has the same behavior, because if that's the case, the user is very much in control!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Paul Peereboom (peereb)](https://launchpad.net/~peereb) wrote on 2017-11-29: |  |  | [#13](/neutron/%2Bbug/1734320/comments/13) |
| --- | --- | --- | --- |

Agree lets see if we can reproduce without admin credentials.

Agree lets see if we can reproduce without admin credentials.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-29: |  |  | [#14](/neutron/%2Bbug/1734320/comments/14) |
| --- | --- | --- | --- |

I used a Pike-based deployment as a testing platform and I can confirm that the resize operation exposes the same behavior as live/block migration (as reported in this report), i.e. the port connected to the VM shows up without a local VLAN tag on the target host.

I still have to look at the extent of the damage that the user can inflict. So, it looks like the malicious user can be in full control of the condition of exploitation.

I used a Pike-based deployment as a testing platform and I can confirm that the resize operation exposes the same behavior as live/block migration (as reported in this report), i.e. the port connected to the VM shows up without a local VLAN tag on the target host.
I still have to look at the extent of the damage that the user can inflict. So, it looks like the malicious user can be in full control of the condition of exploitation.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-11-29: |  |  | [#15](/neutron/%2Bbug/1734320/comments/15) |
| --- | --- | --- | --- |

Thanks Armando,

so the next question is, can this be fixed across all the supported stable release? (e.g.: pike and ocata) ?

And is there something to fix in the os-vif and nova project too?

Thanks Armando,
so the next question is, can this be fixed across all the supported stable release? (e.g.: pike and ocata) ?
And is there something to fix in the os-vif and nova project too?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-11-29: |  |  | [#16](/neutron/%2Bbug/1734320/comments/16) |
| --- | --- | --- | --- |

Hi Tristan,

I wanted to look a bit deeper at what happens on the datapath, but I keep getting sidetracked. The report and analysis from Paul has been excellent, and I welcome that level of detail very much, but I want to see this through a bit more to formulate a recommendation.

Thanks for everyone involved!

Hi Tristan,
I wanted to look a bit deeper at what happens on the datapath, but I keep getting sidetracked. The report and analysis from Paul has been excellent, and I welcome that level of detail very much, but I want to see this through a bit more to formulate a recommendation.
Thanks for everyone involved!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-12-02: |  |  | [#17](/neutron/%2Bbug/1734320/comments/17) |
| --- | --- | --- | --- |

OK, I finally had some interrupted time in which I could look into this more carefully. the TL;DR summary is: the behavior is exposed in live-migrate/block-migrate/resize operations. That said, I don't believe this vulnerability is serious at least under default conditions. Here's why:

1) live/block migration is an admin operation: if the admin avoids turning a port down, the vulnerability is not exposed. Turning a port down is not strictly necessary. Furthermore block migration is disruptive, in that users loses console and network connectivity to the instance.

2) resize is a user allowed operation, but the operation leads to traffic disruption. Even though a user can explicitly turn a port DOWN and resize the instance without admin intervention, there's no way she can keep connectivity to the instance while the operation is in progress. Turning the port back UP will reinstate the local VLAN tag and restore connectivity. The loophole at that point is closed.

For these reasons, I would cautiously say that this vulnerability is not easily exploitable, but we do want to warn the admin of the potential loophole (OSSN B2?), and eventually address the neutron OVS agent codebase to ensure that a port is always tagged even when it's in ADMIN\_DOWN after a migration/resize operation.

I'd recommend against changing os-vif to start a port on the dead vlan for two reasons:

a) neutron use cases go beyond just spinning up VMs. So if possible we should find a fix confined within neutron alone.

b) I feel that the os-vif fix as proposed is ineffective in closing any timing window because while the port is untagged, it's practically unlikely that a user can get hold of the console remotely.

I am open to feedback on my recommendation, but in the meantime I would like to thank the reporter for the very detailed, well thought and challenging report. I had fun cracking this one. Keep them coming!

Needless to say, open to further discussion.

@Tristan: what's next steps? Is this OSSA then marked CONFIRMED? I would like to involve Ihar and Miguel for what comes next. Unless my rationale is flawed, I consider my triage complete and I'd like to push the ball into someone else's court.

Cheers,

Armando

OK, I finally had some interrupted time in which I could look into this more carefully. the TL;DR summary is: the behavior is exposed in live-migrate/block-migrate/resize operations. That said, I don't believe this vulnerability is serious at least under default conditions. Here's why:
1) live/block migration is an admin operation: if the admin avoids turning a port down, the vulnerability is not exposed. Turning a port down is not strictly necessary. Furthermore block migration is disruptive, in that users loses console and network connectivity to the instance.
2) resize is a user allowed operation, but the operation leads to traffic disruption. Even though a user can explicitly turn a port DOWN and resize the instance without admin intervention, there's no way she can keep connectivity to the instance while the operation is in progress. Turning the port back UP will reinstate the local VLAN tag and restore connectivity. The loophole at that point is closed.
For these reasons, I would cautiously say that this vulnerability is not easily exploitable, but we do want to warn the admin of the potential loophole (OSSN B2?), and eventually address the neutron OVS agent codebase to ensure that a port is always tagged even when it's in ADMIN\_DOWN after a migration/resize operation.
I'd recommend against changing os-vif to start a port on the dead vlan for two reasons:
a) neutron use cases go beyond just spinning up VMs. So if possible we should find a fix confined within neutron alone.
b) I feel that the os-vif fix as proposed is ineffective in closing any timing window because while the port is untagged, it's practically unlikely that a user can get hold of the console remotely.
I am open to feedback on my recommendation, but in the meantime I would like to thank the reporter for the very detailed, well thought and challenging report. I had fun cracking this one. Keep them coming!
Needless to say, open to further discussion.
@Tristan: what's next steps? Is this OSSA then marked CONFIRMED? I would like to involve Ihar and Miguel for what comes next. Unless my rationale is flawed, I consider my triage complete and I'd like to push the ball into someone else's court.
Cheers,
Armando

| Changed in neutron: | |
| --- | --- |
| **status**: | New → Triaged |
| Changed in nova: | |
| **status**: | New → Confirmed |
| Changed in neutron: | |
| **importance**: | Undecided → Low |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2017-12-02: |  |  | [#18](/neutron/%2Bbug/1734320/comments/18) |
| --- | --- | --- | --- |

Thank you Armando for this thorough investigation.

You mention console access as a requirement, but couldn't the user run nohup task in the background to capture the traffic, and then retrieve the data later?

To answer your last question, if this is triaged as B2, then we would subscribe the ossg-coresec group so that an OSSN could be prepared and may be sent to the downstream stakeholders through the embargo-notice mailing list before disclosing this bug. Though the live migration case may be bad enough (e.g.: for operator going through that process often) that we may want to issue an advisory instead.

Please feel free to subscribe more neutron or nova developers to this bug, at least to check for unforeseen scenarios.

Thank you Armando for this thorough investigation.
You mention console access as a requirement, but couldn't the user run nohup task in the background to capture the traffic, and then retrieve the data later?
To answer your last question, if this is triaged as B2, then we would subscribe the ossg-coresec group so that an OSSN could be prepared and may be sent to the downstream stakeholders through the embargo-notice mailing list before disclosing this bug. Though the live migration case may be bad enough (e.g.: for operator going through that process often) that we may want to issue an advisory instead.
Please feel free to subscribe more neutron or nova developers to this bug, at least to check for unforeseen scenarios.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gerhard Muntingh (gerhard-1)](https://launchpad.net/~gerhard-1) wrote on 2017-12-02: |  |  | [#19](/neutron/%2Bbug/1734320/comments/19) |
| --- | --- | --- | --- |

Hi Armando, I'm also impressed by the thorough investigation. Especially the resize insight.

Please carefully read point two below. I think the issue is more serious because of it.

1) Turning the port down (as a user) is not necessary, but it changes the trunk-mode time from a couple of seconds to indefinitely.

2) There's no need to put the port (eth0) back up, if the attacker creates a secondary network interface (eth1) to access the instance. No console access is needed. This is the described scenario in the original report.

Thanks,

Gerhard.

Hi Armando, I'm also impressed by the thorough investigation. Especially the resize insight.
Please carefully read point two below. I think the issue is more serious because of it.
1) Turning the port down (as a user) is not necessary, but it changes the trunk-mode time from a couple of seconds to indefinitely.
2) There's no need to put the port (eth0) back up, if the attacker creates a secondary network interface (eth1) to access the instance. No console access is needed. This is the described scenario in the original report.
Thanks,
Gerhard.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-12-02: |  |  | [#20](/neutron/%2Bbug/1734320/comments/20) |
| --- | --- | --- | --- |

I didn't mean that console would be a requirement for the exploit, and indeed I overlooked the two-NICs scenario. Thanks for your feedback...I feared I was missing something ;)

That said, I have been thinking if ensuring a tag on the port after resize/migration operation suffices to mitigate the exploitation.

Ihar identified snippet of code [1] as potential contentious, and I wonder if along location [2] would be the only two areas required to be hardened.

Thoughts?

Thanks,

Armando

[1] <https://github.com/openstack/neutron/blob/master/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_neutron_agent.py#L1426-L1436>

[2] <https://github.com/openstack/neutron/blob/newton-eol/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_neutron_agent.py#L995>

I didn't mean that console would be a requirement for the exploit, and indeed I overlooked the two-NICs scenario. Thanks for your feedback...I feared I was missing something ;)
That said, I have been thinking if ensuring a tag on the port after resize/migration operation suffices to mitigate the exploitation.
Ihar identified snippet of code [1] as potential contentious, and I wonder if along location [2] would be the only two areas required to be hardened.
Thoughts?
Thanks,
Armando
[1] https://github.com/openstack/neutron/blob/master/neutron/plugins/ml2/drivers/openvswitch/agent/ovs\_neutron\_agent.py#L1426-L1436
[2] https://github.com/openstack/neutron/blob/newton-eol/neutron/plugins/ml2/drivers/openvswitch/agent/ovs\_neutron\_agent.py#L995

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gerhard Muntingh (gerhard-1)](https://launchpad.net/~gerhard-1) wrote on 2017-12-04: |  |  | [#21](/neutron/%2Bbug/1734320/comments/21) |
| --- | --- | --- | --- |

Hardening both locations doesn't fix the issue. It brings the time window back to a couple of seconds.

Out of curiosity, can't nova-compute skip the os-vif step, and have neutron configure the port entirely?

Looping will also work.

Also, don't forget the less serious issue #4.

Hardening both locations doesn't fix the issue. It brings the time window back to a couple of seconds.
Out of curiosity, can't nova-compute skip the os-vif step, and have neutron configure the port entirely?
Looping will also work.
Also, don't forget the less serious issue #4.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2017-12-05: |  |  | [#22](/neutron/%2Bbug/1734320/comments/22) |
| --- | --- | --- | --- |

I agree with Gerhard on the fact that hardening on neutron side won't completely eliminate the issue in nova/neutron setup. We should also have a fix on os-vif side where we enforce dead tag on newly created ports. AFAIU os-vif may not have been used before recent releases of Nova so the fix may need to be both in os-vif and nova stable branches.

As for #4, I think it will not be an issue if we enforce dead tag when putting a port down. (The problem is currently we don't do it for unbound ports.)

If I try to capture all the things we may need to patch, I get the following:

- (neutron) port\_dead to always set dead tag on new unbound ports;

- (os-vif/nova) enforce dead tag for new ovs ports.

The first patch fixes the issue on neutron side for setups that are not using Nova / os-vif. In those setups, components calling to Neutron should make sure newly created ports are dead, otherwise they are still exposed to a (short) vulnerable window. (Should we include this info in a release note / security report? Should we reach out to Neutron API consumers that may be affected?)

The second fix will completely close the short vulnerable window in neutron/nova setups discussed above.

(I actually feel that those two issues are independent and should be treated as two separate CVEs targeting different components.)

Then additional hardening patches could also be:

- (neutron) use drop rule for normal action on br-int; (may be invasive / breaking external code);

(and/or)

- (neutron) bump priority for drop flow rule set for dead ports.

The hardening may happen in public since neither of those issues should expose anything as long as os-vif/neutron patches as described before.

Does it make sense?

Is anyone from Nova team aware of the issue?

I agree with Gerhard on the fact that hardening on neutron side won't completely eliminate the issue in nova/neutron setup. We should also have a fix on os-vif side where we enforce dead tag on newly created ports. AFAIU os-vif may not have been used before recent releases of Nova so the fix may need to be both in os-vif and nova stable branches.
As for #4, I think it will not be an issue if we enforce dead tag when putting a port down. (The problem is currently we don't do it for unbound ports.)
If I try to capture all the things we may need to patch, I get the following:
- (neutron) port\_dead to always set dead tag on new unbound ports;
- (os-vif/nova) enforce dead tag for new ovs ports.
The first patch fixes the issue on neutron side for setups that are not using Nova / os-vif. In those setups, components calling to Neutron should make sure newly created ports are dead, otherwise they are still exposed to a (short) vulnerable window. (Should we include this info in a release note / security report? Should we reach out to Neutron API consumers that may be affected?)
The second fix will completely close the short vulnerable window in neutron/nova setups discussed above.
(I actually feel that those two issues are independent and should be treated as two separate CVEs targeting different components.)
Then additional hardening patches could also be:
- (neutron) use drop rule for normal action on br-int; (may be invasive / breaking external code);
(and/or)
- (neutron) bump priority for drop flow rule set for dead ports.
The hardening may happen in public since neither of those issues should expose anything as long as os-vif/neutron patches as described before.
Does it make sense?
Is anyone from Nova team aware of the issue?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Armando Migliaccio (armando-migliaccio)](https://launchpad.net/~armando-migliaccio) wrote on 2017-12-05: |  |  | [#23](/neutron/%2Bbug/1734320/comments/23) |
| --- | --- | --- | --- |

Ihar, I agree with your assessment, thanks for pushing this forward; I am a bit uneasy about the implications of adding a drop rule for normal actions on br-int for the reasons you've stated (maybe that breaks Tap as a Service or SFC or other stuff?). We should also make sure that the change on the os-vif side will not break things like OVN/ODL or other drivers that rely on OVS because I don't believe there's any local VLAN tagging involved for those. Have you considered these scenarios?

To answer Gerhard's question about os-vif, iirc the rationale of having nova do the plugging is to enable scenarios where there's no network agent involved on the neutron side and/or to abstract the networking service from hypervisor internals.

Ihar, I agree with your assessment, thanks for pushing this forward; I am a bit uneasy about the implications of adding a drop rule for normal actions on br-int for the reasons you've stated (maybe that breaks Tap as a Service or SFC or other stuff?). We should also make sure that the change on the os-vif side will not break things like OVN/ODL or other drivers that rely on OVS because I don't believe there's any local VLAN tagging involved for those. Have you considered these scenarios?
To answer Gerhard's question about os-vif, iirc the rationale of having nova do the plugging is to enable scenarios where there's no network agent involved on the neutron side and/or to abstract the networking service from hypervisor internals.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Gerhard Muntingh (gerhard-1)](https://launchpad.net/~gerhard-1) wrote on 2017-12-06: |  |  | [#24](/neutron/%2Bbug/1734320/comments/24) |
| --- | --- | --- | --- |

Thanks, that makes sense.

I suspect adding a drop rule for normal action on br-int will require quite some explicit flows to deal with all the other bridges (br-ex), but we'll see.

On neutron hardening: Bumping priority for drop flow rule set for dead ports will fix issue #4.

Thanks, that makes sense.
I suspect adding a drop rule for normal action on br-int will require quite some explicit flows to deal with all the other bridges (br-ex), but we'll see.
On neutron hardening: Bumping priority for drop flow rule set for dead ports will fix issue #4.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Lavalle (minsel)](https://launchpad.net/~minsel) wrote on 2017-12-06: |  |  | [#25](/neutron/%2Bbug/1734320/comments/25) |
| --- | --- | --- | --- |

Thanks to everybody who has helped in diagnosing this issue. It seems we have two sets of actions:

1) Fixing: that involves port\_dead to always set dead tag on new unbound ports in Neutron and enforce dead tag for new ovs ports in nova / os-vif

2) Hardening of Neutron code

I suggest that as the very next step we concentrate in the fixing part. For this the Neutron side seems to be uncontroversial. The only sticking point left is the potential breakage of other back-ends with the os-vif fix. Can we involve someone from OVN to see what the implications might be?

Thanks to everybody who has helped in diagnosing this issue. It seems we have two sets of actions:
1) Fixing: that involves port\_dead to always set dead tag on new unbound ports in Neutron and enforce dead tag for new ovs ports in nova / os-vif
2) Hardening of Neutron code
I suggest that as the very next step we concentrate in the fixing part. For this the Neutron side seems to be uncontroversial. The only sticking point left is the potential breakage of other back-ends with the os-vif fix. Can we involve someone from OVN to see what the implications might be?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2017-12-06: |  |  | [#26](/neutron/%2Bbug/1734320/comments/26) |
| --- | --- | --- | --- |

Please subscribe anyone you think may be able to help identify a safe solution.

Please subscribe anyone you think may be able to help identify a safe solution.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2017-12-07: |  |  | [#27](/neutron/%2Bbug/1734320/comments/27) |
| --- | --- | --- | --- |

I subscribed Miguel Angel Ajo from networking-ovn team to assess whether proposed os-vif fix would break them.

I subscribed Miguel Angel Ajo from networking-ovn team to assess whether proposed os-vif fix would break them.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2017-12-07: |  |  | [#28](/neutron/%2Bbug/1734320/comments/28) |
| --- | --- | --- | --- |

(something we discussed with Armando yesterday)

if for some reason the suggested change to os-vif to mark all new ports with dead tag is breaking other projects, we may roll it in as opt-in, where consumer passes some flag through binding profile dictionary that would instruct nova to also mark a new port as dead; then the flag would be proxied into os-vif binding code that would enact the request. If the flag was not set / passed disabled, then nova would not request port death, and os-vif would do the same action as it does right now.

There are several compatibility issues to be concerned about here.

1. we effectively change api payload for binding extension; but because we already treat profile dict as a large box of random crap to pass around between neutron and nova, unpatched nova should already be ready to receive a dict with unknown keys.

2. it may be that os-vif is not patched while nova is, which would potentially lead to binding call to os-vif failing because of unknown flag passed by nova. I don't think we can bump minimal supported os-vif version in requirements.txt, so nova will need to find a way to deal with older releases. If nothing else, we can always catch TypeError: ... expected at least X arguments, got Y error and fall back to flag-less call to os-vif (plus a warning).

(something we discussed with Armando yesterday)
if for some reason the suggested change to os-vif to mark all new ports with dead tag is breaking other projects, we may roll it in as opt-in, where consumer passes some flag through binding profile dictionary that would instruct nova to also mark a new port as dead; then the flag would be proxied into os-vif binding code that would enact the request. If the flag was not set / passed disabled, then nova would not request port death, and os-vif would do the same action as it does right now.
There are several compatibility issues to be concerned about here.
1. we effectively change api payload for binding extension; but because we already treat profile dict as a large box of random crap to pass around between neutron and nova, unpatched nova should already be ready to receive a dict with unknown keys.
2. it may be that os-vif is not patched while nova is, which would potentially lead to binding call to os-vif failing because of unknown flag passed by nova. I don't think we can bump minimal supported os-vif version in requirements.txt, so nova will need to find a way to deal with older releases. If nothing else, we can always catch TypeError: ... expected at least X arguments, got Y error and fall back to flag-less call to os-vif (plus a warning).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2017-12-07: |  |  | [#29](/neutron/%2Bbug/1734320/comments/29) |
| --- | --- | --- | --- |

This ^ would of course imply that instead of having one/two places to patch (os-vif + maybe neutron), we will have three (neutron -> nova -> os-vif).

This ^ would of course imply that instead of having one/two places to patch (os-vif + maybe neutron), we will have three (neutron -> nova -> os-vif).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo) wrote on 2017-12-07: |  |  | [#30](/neutron/%2Bbug/1734320/comments/30) |
| --- | --- | --- | --- |

Hi,

Thank you very much for looping me in,

I'm not sure if networking-ovn, or other plugins that don't use tags+NORMAL-rules in OVS would work with the os-vif change (which as far as I undertood creates the ports right away in the dead vlan).

Could we also loop Numan Siddique to verify how ovn behaves in this case?, tomorrow we have a bank holiday in Spain, and I will be physically away from my computer until late.

The question is if the "vlan tag" will be just ignored based on the used OpenFlow rules, or what happens exactly.

Hi,
Thank you very much for looping me in,
I'm not sure if networking-ovn, or other plugins that don't use tags+NORMAL-rules in OVS would work with the os-vif change (which as far as I undertood creates the ports right away in the dead vlan).
Could we also loop Numan Siddique to verify how ovn behaves in this case?, tomorrow we have a bank holiday in Spain, and I will be physically away from my computer until late.
The question is if the "vlan tag" will be just ignored based on the used OpenFlow rules, or what happens exactly.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2017-12-08: |  |  | [#31](/neutron/%2Bbug/1734320/comments/31) |
| --- | --- | --- | --- |

Miguel: my request from comment #26 definitely applies to you as well. Please subscribe anyone you think may be able to help identify a safe solution.

Miguel: my request from comment #26 definitely applies to you as well. Please subscribe anyone you think may be able to help identify a safe solution.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo) wrote on 2017-12-11: |  |  | [#32](/neutron/%2Bbug/1734320/comments/32) |
| --- | --- | --- | --- |

Sorry, I didn't know that I had permissions to add more people, I did it with numan, but I will verify now that I'm back from PTO

Sorry, I didn't know that I had permissions to add more people, I did it with numan, but I will verify now that I'm back from PTO

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Angel Ajo (mangelajo)](https://launchpad.net/~mangelajo) wrote on 2017-12-12: |  |  | [#33](/neutron/%2Bbug/1734320/comments/33) |
| --- | --- | --- | --- |

[root@primary ~]# ovs-vsctl show

a6b77a09-2647-47d7-8815-ef4d4f689ce8

    Bridge br-int

        fail\_mode: secure

        Port "tap5a27427b-22"

            Interface "tap5a27427b-22"

        Port br-int

            Interface br-int

                type: internal

        Port "patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"

            Interface "patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"

                type: patch

                options: {peer="patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"}

        Port "tapa4e1ef4d-40"

            tag: 4095

            Interface "tapa4e1ef4d-40"

        Port "tap4b56611b-99"

            tag: 4095

            Interface "tap4b56611b-99"

        Port "tap473919fe-31"

            tag: 4095

            Interface "tap473919fe-31"

    Bridge br-ex

        Port br-ex

            Interface br-ex

                type: internal

        Port "patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"

            Interface "patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"

                type: patch

                options: {peer="patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"}

[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.4

cirros@10.0.0.4's password:

[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.6

The authenticity of host '10.0.0.6 (10.0.0.6)' can't be established.

RSA key fingerprint is SHA256:cDLkQEB0LfxZfIvpd084MucUa4uohUd0COf3ArPa1A0.

RSA key fingerprint is MD5:cd:4e:f7:f5:e1:bb:61:ea:a7:4d:46:f8:67:43:20:00.

Are you sure you want to continue connecting (yes/no)? yes

Warning: Permanently added '10.0.0.6' (RSA) to the list of known hosts.

cirros@10.0.0.6's password:

[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.8

The authenticity of host '10.0.0.8 (10.0.0.8)' can't be established.

RSA key fingerprint is SHA256:XUX8EfLF2oRJLqDChEEw3smHGeHm7zcQapdpayZcb0Y.

RSA key fingerprint is MD5:33:00:41:fb:96:25:a4:79:b5:2e:63:c8:03:8f:2e:be.

Are you sure you want to continue connecting (yes/no)? ^C

[root@primary ~]#

[root@primary ~]#

Sorry for the delay, I've verified that the solution would be fine for OVN (and I suspect that also for other openflow based solutions which don't use the "NORMAL" rule).

[root@primary ~]# ovs-vsctl show
a6b77a09-2647-47d7-8815-ef4d4f689ce8
Bridge br-int
fail\_mode: secure
Port "tap5a27427b-22"
Interface "tap5a27427b-22"
Port br-int
Interface br-int
type: internal
Port "patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"
Interface "patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"
type: patch
options: {peer="patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"}
Port "tapa4e1ef4d-40"
tag: 4095
Interface "tapa4e1ef4d-40"
Port "tap4b56611b-99"
tag: 4095
Interface "tap4b56611b-99"
Port "tap473919fe-31"
tag: 4095
Interface "tap473919fe-31"
Bridge br-ex
Port br-ex
Interface br-ex
type: internal
Port "patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"
Interface "patch-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e-to-br-int"
type: patch
options: {peer="patch-br-int-to-provnet-d556080a-799f-4621-bb2d-d4ac9b8bb32e"}
[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.4
cirros@10.0.0.4's password:
[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.6
The authenticity of host '10.0.0.6 (10.0.0.6)' can't be established.
RSA key fingerprint is SHA256:cDLkQEB0LfxZfIvpd084MucUa4uohUd0COf3ArPa1A0.
RSA key fingerprint is MD5:cd:4e:f7:f5:e1:bb:61:ea:a7:4d:46:f8:67:43:20:00.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.0.0.6' (RSA) to the list of known hosts.
cirros@10.0.0.6's password:
[root@primary ~]# ip netns exec ovnmeta-a4e1ef4d-47ce-4b92-8043-70d88237eff1 ssh cirros@10.0.0.8
The authenticity of host '10.0.0.8 (10.0.0.8)' can't be established.
RSA key fingerprint is SHA256:XUX8EfLF2oRJLqDChEEw3smHGeHm7zcQapdpayZcb0Y.
RSA key fingerprint is MD5:33:00:41:fb:96:25:a4:79:b5:2e:63:c8:03:8f:2e:be.
Are you sure you want to continue connecting (yes/no)? ^C
[root@primary ~]#
[root@primary ~]#
Sorry for the delay, I've verified that the solution would be fine for OVN (and I suspect that also for other openflow based solutions which don't use the "NORMAL" rule).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Miguel Lavalle (minsel)](https://launchpad.net/~minsel) wrote on 2017-12-13: |  |  | [#34](/neutron/%2Bbug/1734320/comments/34) |
| --- | --- | --- | --- |

@Tocayo Miguel Ajo,

Thanks for the testing. Much appreciated

Based on this I think we can move ahead with the "fixing" part, which involves:

1) port\_dead to always set dead tag on new unbound ports in Neutron

2) Enforce dead tag for new ovs ports in nova / os-vif

What are the mechanics of creating, reviewing and merging these two patches under the embargo conditions of this CVE? I am available to work on this

I'll still loop in someone from ODL to make sure they are fine with the proposed approach

@Tocayo Miguel Ajo,
Thanks for the testing. Much appreciated
Based on this I think we can move ahead with the "fixing" part, which involves:
1) port\_dead to always set dead tag on new unbound ports in Neutron
2) Enforce dead tag for new ovs ports in nova / os-vif
What are the mechanics of creating, reviewing and merging these two patches under the embargo conditions of this CVE? I am available to work on this
I'll still loop in someone from ODL to make sure they are fine with the proposed approach

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2017-12-13: |  |  | [#35](/neutron/%2Bbug/1734320/comments/35) |
| --- | --- | --- | --- |

If the issue is considered widespread, easy enough to exploit and able to do a sufficient amount of damage or obtain sensitive information with some certainty, then we would want to keep this report privately embargoed while fixes are developed, attached to this bug and tested/reviewed locally by the bug's subscribers. Once working fixes for master are identified and backports are created and attached to this bug for all supported stable branches, we will get a CVE identifier assigned, propose a disclosure schedule and provide advance notice and copies of the patches privately to downstream stakeholders.

If the risk from this bug is of questionable severity, we should subscribe the ossg-coresec team to get their opinion on the possibility of switching to our (simpler) public workflow for this report instead.

As a reminder, our process for both of these options is described here: <https://security.openstack.org/vmt-process.html>

If the issue is considered widespread, easy enough to exploit and able to do a sufficient amount of damage or obtain sensitive information with some certainty, then we would want to keep this report privately embargoed while fixes are developed, attached to this bug and tested/reviewed locally by the bug's subscribers. Once working fixes for master are identified and backports are created and attached to this bug for all supported stable branches, we will get a CVE identifier assigned, propose a disclosure schedule and provide advance notice and copies of the patches privately to downstream stakeholders.
If the risk from this bug is of questionable severity, we should subscribe the ossg-coresec team to get their opinion on the possibility of switching to our (simpler) public workflow for this report instead.
As a reminder, our process for both of these options is described here: https://security.openstack.org/vmt-process.html

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2018-01-05: |  |  | [#36](/neutron/%2Bbug/1734320/comments/36) |
| --- | --- | --- | --- |

I tried to reach out to Matt (Nova PTL) via email, so far no luck. I think their involvement is crucial here.

I tried to reach out to Matt (Nova PTL) via email, so far no luck. I think their involvement is crucial here.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2018-01-05: |  |  | [#37](/neutron/%2Bbug/1734320/comments/37) |
| --- | --- | --- | --- |

* [0001-Mark-all-dead-ports-with-dead-tag.patch](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Battachment/5031634/%2Bfiles/0001-Mark-all-dead-ports-with-dead-tag.patch)
  [Edit](/neutron/%2Bbug/1734320/%2Battachment/5031634)
  (2.7 KiB,
  text/plain)

This is the neutron piece of the puzzle to make ovs agent mark all untagged ports as dead. I am considering adding a new functional or fullstack test for the scenario too, but posting what I have for now to start review.

This is the neutron piece of the puzzle to make ovs agent mark all untagged ports as dead. I am considering adding a new functional or fullstack test for the scenario too, but posting what I have for now to start review.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2018-01-09: |  |  | [#38](/neutron/%2Bbug/1734320/comments/38) |
| --- | --- | --- | --- |

* [os-vif tagging new ovs port with dead tag](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Battachment/5033809/%2Bfiles/0001-Create-new-ovs-ports-with-dead-vlan-tag.patch)
  [Edit](/neutron/%2Bbug/1734320/%2Battachment/5033809)
  (2.5 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2018-01-09: |  |  | [#39](/neutron/%2Bbug/1734320/comments/39) |
| --- | --- | --- | --- |

In nova, there is also some code in nova/network/linux\_net.py (specifically, class LinuxOVSInterfaceDriver) that seems to have plug() method that calls add-port and would benefit from dead tag setting too, but I failed to find a place where this code is hooked into actual services, so I wonder if this code is not some dead end that will be cleaned up in due course after os-vif switch. I will leave it up to nova team to decide.

In nova, there is also some code in nova/network/linux\_net.py (specifically, class LinuxOVSInterfaceDriver) that seems to have plug() method that calls add-port and would benefit from dead tag setting too, but I failed to find a place where this code is hooked into actual services, so I wonder if this code is not some dead end that will be cleaned up in due course after os-vif switch. I will leave it up to nova team to decide.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka) wrote on 2018-01-09: |  |  | [#40](/neutron/%2Bbug/1734320/comments/40) |
| --- | --- | --- | --- |

Backporting for neutron seems simple: the patch applies cleanly to stable/ocata which is the oldest version upstream supports.

Since I also have an interest in earlier releases that may still be supported by Red Hat, I also checked that the patch applies with some adjustments up to liberty. As for earlier releases, they are probably not affected because they don't include <https://review.openstack.org/#/q/I5ef9665770df3a9bbaf79049b219fadd73e20309> that made neutron ovs agent skip tagging ports as dead if they don't have a tag in the first place.

Which makes me think that we should make sure that the CVE fix doesn't break the assumptions that the patch I linked to above made. The concern there is, as far as I understand, is that drop flows are left on the bridge even after port is gone, which may hinder performance etal.

Backporting for neutron seems simple: the patch applies cleanly to stable/ocata which is the oldest version upstream supports.
Since I also have an interest in earlier releases that may still be supported by Red Hat, I also checked that the patch applies with some adjustments up to liberty. As for earlier releases, they are probably not affected because they don't include https://review.openstack.org/#/q/I5ef9665770df3a9bbaf79049b219fadd73e20309 that made neutron ovs agent skip tagging ports as dead if they don't have a tag in the first place.
Which makes me think that we should make sure that the CVE fix doesn't break the assumptions that the patch I linked to above made. The concern there is, as far as I understand, is that drop flows are left on the bridge even after port is gone, which may hinder performance etal.

[Ihar Hrachyshka (ihar-hrachyshka)](https://launchpad.net/~ihar-hrachyshka)
on 2018-01-25

| Changed in neutron: | |
| --- | --- |
| **importance**: | Low → High |

[Jeremy Stanley (fungi)](https://launchpad.net/~fungi)
on 2018-04-27

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | Incomplete → Won't Fix |
| **information type**: | Private Security → Public |
| **tags**: | added: security |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2018-08-21

| Changed in os-vif: | |
| --- | --- |
| **assignee**: | nobody → Slawek Kaplonski (slaweq) |
| **status**: | New → In Progress |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2018-09-13

| Changed in os-vif: | |
| --- | --- |
| **assignee**: | Slawek Kaplonski (slaweq) → sean mooney (sean-k-mooney) |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2018-09-13

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → sean mooney (sean-k-mooney) |
| **status**: | Confirmed → In Progress |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2018-11-08

| Changed in neutron: | |
| --- | --- |
| **assignee**: | nobody → sean mooney (sean-k-mooney) |
| **status**: | Triaged → In Progress |

[sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney)
on 2018-12-10

| Changed in os-vif: | |
| --- | --- |
| **importance**: | Undecided → High |
| **status**: | In Progress → Fix Committed |

[Bernard Cafarelli (bcafarel)](https://launchpad.net/~bcafarel)
on 2019-01-04

| **tags**: | added: neutron-proactive-backport-potential |
| --- | --- |

[sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney)
on 2019-01-04

| Changed in os-vif: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |
| Changed in neutron: | |
| **status**: | In Progress → Fix Committed |
| Changed in nova: | |
| **status**: | In Progress → Won't Fix |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2019-01-16

| Changed in nova: | |
| --- | --- |
| **status**: | Won't Fix → In Progress |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2019-10-04

| **tags**: | added: in-stable-rocky |
| --- | --- |

| 44 comments hidden Loading more comments | [view all 124 comments](?comments=all) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Oleg Bondarev (obondarev)](https://launchpad.net/~obondarev) wrote on 2019-10-18: |  |  | [#85](/neutron/%2Bbug/1734320/comments/85) |
| --- | --- | --- | --- |

Should this bug be reopened for os-vif now when revert <https://review.opendev.org/#/c/631829> was merged?

@sean-k-mooney can you please share that status of this bug? Is there anything except neutron <https://review.opendev.org/#/c/640258> and nova <https://review.opendev.org/#/c/602432/> changes pending?

Should this bug be reopened for os-vif now when revert https://review.opendev.org/#/c/631829 was merged?
@sean-k-mooney can you please share that status of this bug? Is there anything except neutron https://review.opendev.org/#/c/640258 and nova https://review.opendev.org/#/c/602432/ changes pending?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2019-10-18: |  |  | [#86](/neutron/%2Bbug/1734320/comments/86) |
| --- | --- | --- | --- |

there is a mitagation for this bug in all cases except when the ovs firewall driver is used with kernel ovs.

<https://review.opendev.org/#/c/631829> has not been reverted and there is no plans to revert it.

it.

<https://review.opendev.org/#/c/612534/> was intoduced to add a config option to enable isolation.

<https://review.opendev.org/#/c/636061/> allows the caller of os-vif to determin if os-vif should plug the interface to the network backend.

the nova change uses that abilty to delegate the plugging to os-vif instead of libvirt

<https://review.opendev.org/#/c/602432/13/nova/network/os_vif_util.py>

but we cannot do that until the neutron change is merged <https://review.opendev.org/#/c/640258>

i am not really activly workign on either patch right now.

i tried to repoduce the dvr failutre locally but in my env it seams to work fine.

we know from the upstream testing that in a non dvr env this seams to work fine.

if some neutron dvr folks can try and fix the dvr issue that woudl move things forward

but a few neutorn review have looked and we are not sure why this is broken.

i think the issue is here <https://review.opendev.org/#/c/640258/15/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py@404>

we are not looking at the correct field however i have not had tiem to actully debug this as i have been working on other issue.

so to summarize the status

form an os-vif point of view i consider this bug to be fixed.

the nova fix is currently blocked by dvr support in the neutron patch.

if you are using a configuration other than kernel ovs with the ovs firewall driver we believe this bug is fixed.

there is a mitagation for this bug in all cases except when the ovs firewall driver is used with kernel ovs.
https://review.opendev.org/#/c/631829 has not been reverted and there is no plans to revert it.
it.
https://review.opendev.org/#/c/612534/ was intoduced to add a config option to enable isolation.
https://review.opendev.org/#/c/636061/ allows the caller of os-vif to determin if os-vif should plug the interface to the network backend.
the nova change uses that abilty to delegate the plugging to os-vif instead of libvirt
https://review.opendev.org/#/c/602432/13/nova/network/os\_vif\_util.py
but we cannot do that until the neutron change is merged https://review.opendev.org/#/c/640258
i am not really activly workign on either patch right now.
i tried to repoduce the dvr failutre locally but in my env it seams to work fine.
we know from the upstream testing that in a non dvr env this seams to work fine.
if some neutron dvr folks can try and fix the dvr issue that woudl move things forward
but a few neutorn review have looked and we are not sure why this is broken.
i think the issue is here https://review.opendev.org/#/c/640258/15/neutron/plugins/ml2/drivers/openvswitch/agent/ovs\_dvr\_neutron\_agent.py@404
we are not looking at the correct field however i have not had tiem to actully debug this as i have been working on other issue.
so to summarize the status
form an os-vif point of view i consider this bug to be fixed.
the nova fix is currently blocked by dvr support in the neutron patch.
if you are using a configuration other than kernel ovs with the ovs firewall driver we believe this bug is fixed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2019-10-18:  [**Fix merged to neutron (stable/queens)**](/neutron/%2Bbug/1734320/comments/87) |  |  | [#87](/neutron/%2Bbug/1734320/comments/87) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/686346>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=9b0919e64809729f4c0186e9be63b1082510bbb1>

Submitter: Zuul

Branch: stable/queens

commit 9b0919e64809729f4c0186e9be63b1082510bbb1

Author: Sean Mooney <email address hidden>

Date: Thu Nov 8 16:07:55 2018 +0000

raise priority of dead vlan drop

- This change adds a max priority flow to drop

      all traffic that is associated with the

      DEAD VLAN 4095.

    - This change is part of a partial mitigation of

      [bug 1734320](/bugs/1734320). Without this change vlan 4095 traffic

      will be dropped via a low priority flow after being

      processed by part/all of the openflow pipeline.

      By raising the priorty and droping in table 0

      we drop invalid packets as soon as they enter

      the pipeline.

Conflicts:

        neutron/tests/unit/plugins/ml2/drivers/openvswitch/agent/openflow/native/test\_br\_int.py

Change-Id: I3482c7c4f00942828cc9396cd2f3d646c9e8c9d1

    Partial-Bug: #1734320

    (cherry picked from commit e3dc447b908f57e9acc0378111b8e09cbd88ddc5)

Reviewed: https://review.opendev.org/686346
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=9b0919e64809729f4c0186e9be63b1082510bbb1
Submitter: Zuul
Branch: stable/queens
commit 9b0919e64809729f4c0186e9be63b1082510bbb1
Author: Sean Mooney <work@seanmooney.info>
Date: Thu Nov 8 16:07:55 2018 +0000
raise priority of dead vlan drop
- This change adds a max priority flow to drop
all traffic that is associated with the
DEAD VLAN 4095.
- This change is part of a partial mitigation of
bug 1734320. Without this change vlan 4095 traffic
will be dropped via a low priority flow after being
processed by part/all of the openflow pipeline.
By raising the priorty and droping in table 0
we drop invalid packets as soon as they enter
the pipeline.
Conflicts:
neutron/tests/unit/plugins/ml2/drivers/openvswitch/agent/openflow/native/test\_br\_int.py
Change-Id: I3482c7c4f00942828cc9396cd2f3d646c9e8c9d1
Partial-Bug: #1734320
(cherry picked from commit e3dc447b908f57e9acc0378111b8e09cbd88ddc5)

| **tags**: | added: in-stable-queens |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2019-10-23:  [**Fix merged to neutron (stable/pike)**](/neutron/%2Bbug/1734320/comments/88) |  |  | [#88](/neutron/%2Bbug/1734320/comments/88) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/686347>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=797a379c51a05fca356d2f2575bfc386b0287afd>

Submitter: Zuul

Branch: stable/pike

commit 797a379c51a05fca356d2f2575bfc386b0287afd

Author: Sean Mooney <email address hidden>

Date: Thu Nov 8 16:07:55 2018 +0000

raise priority of dead vlan drop

- This change adds a max priority flow to drop

      all traffic that is associated with the

      DEAD VLAN 4095.

    - This change is part of a partial mitigation of

      [bug 1734320](/bugs/1734320). Without this change vlan 4095 traffic

      will be dropped via a low priority flow after being

      processed by part/all of the openflow pipeline.

      By raising the priorty and droping in table 0

      we drop invalid packets as soon as they enter

      the pipeline.

Conflicts:

        neutron/tests/unit/plugins/ml2/drivers/openvswitch/agent/openflow/native/test\_br\_int.py

Change-Id: I3482c7c4f00942828cc9396cd2f3d646c9e8c9d1

    Partial-Bug: #1734320

    (cherry picked from commit e3dc447b908f57e9acc0378111b8e09cbd88ddc5)

Reviewed: https://review.opendev.org/686347
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=797a379c51a05fca356d2f2575bfc386b0287afd
Submitter: Zuul
Branch: stable/pike
commit 797a379c51a05fca356d2f2575bfc386b0287afd
Author: Sean Mooney <work@seanmooney.info>
Date: Thu Nov 8 16:07:55 2018 +0000
raise priority of dead vlan drop
- This change adds a max priority flow to drop
all traffic that is associated with the
DEAD VLAN 4095.
- This change is part of a partial mitigation of
bug 1734320. Without this change vlan 4095 traffic
will be dropped via a low priority flow after being
processed by part/all of the openflow pipeline.
By raising the priorty and droping in table 0
we drop invalid packets as soon as they enter
the pipeline.
Conflicts:
neutron/tests/unit/plugins/ml2/drivers/openvswitch/agent/openflow/native/test\_br\_int.py
Change-Id: I3482c7c4f00942828cc9396cd2f3d646c9e8c9d1
Partial-Bug: #1734320
(cherry picked from commit e3dc447b908f57e9acc0378111b8e09cbd88ddc5)

| **tags**: | added: in-stable-pike |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Oleg Bondarev (obondarev)](https://launchpad.net/~obondarev) wrote on 2019-10-24: |  |  | [#89](/neutron/%2Bbug/1734320/comments/89) |
| --- | --- | --- | --- |

Copying here my comment on neutron patch <https://review.opendev.org/640258/>: not sure the failures are related to DVR: it seems we only run full tempest set with dvr enabled (with OVS). Test failures are mostly about VM not becoming ACTIVE (stuck in BUILD), I guess due to neutron VM port not becoming ACTIVE. This should not be affected by DVR in any way. Also in ovs agent logs I see errors on ovs-vsctl operations with ports having ofport -1.

Copying here my comment on neutron patch https://review.opendev.org/640258/: not sure the failures are related to DVR: it seems we only run full tempest set with dvr enabled (with OVS). Test failures are mostly about VM not becoming ACTIVE (stuck in BUILD), I guess due to neutron VM port not becoming ACTIVE. This should not be affected by DVR in any way. Also in ovs agent logs I see errors on ovs-vsctl operations with ports having ofport -1.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2019-10-24: |  |  | [#90](/neutron/%2Bbug/1734320/comments/90) |
| --- | --- | --- | --- |

yes so as i commented before

the issue is here <https://review.opendev.org/#/c/640258/15/neutron/plugins/ml2/drivers/openvswitch/agent/ovs_dvr_neutron_agent.py@404>

We are not reading the correct field so once we fix that we expect it to work in the dvr case.

that is noted in the Gerrit review. the failures are all cased by the fact we try to read a filed that

does not exist this raise an error and the port does not become acitve. we the reach the timout on the nova side and role back the vm.

it is not an error for a port to have -1 on the ovs side.

that is what we want to allow.

a ofport id of -1 mean the port is declare in the control plane e.g.

in the ovs-db but has not yet been attach to the data plane.

when the tap deive is actully created in the kernel it will automaticaly be

added to the ovs dataplane and a ofport id will be assigned.

so do be clear we expect ove to assing a port id of -1 and it may also raise a waring in the ovs-db

but that is normal and the intended behavior. this is what happens with vhost-user by the way as the ofport id does not get asigned until the vm startrs and until that point it will have a ofportid of -1 not []

yes so as i commented before
the issue is here https://review.opendev.org/#/c/640258/15/neutron/plugins/ml2/drivers/openvswitch/agent/ovs\_dvr\_neutron\_agent.py@404
We are not reading the correct field so once we fix that we expect it to work in the dvr case.
that is noted in the Gerrit review. the failures are all cased by the fact we try to read a filed that
does not exist this raise an error and the port does not become acitve. we the reach the timout on the nova side and role back the vm.
it is not an error for a port to have -1 on the ovs side.
that is what we want to allow.
a ofport id of -1 mean the port is declare in the control plane e.g.
in the ovs-db but has not yet been attach to the data plane.
when the tap deive is actully created in the kernel it will automaticaly be
added to the ovs dataplane and a ofport id will be assigned.
so do be clear we expect ove to assing a port id of -1 and it may also raise a waring in the ovs-db
but that is normal and the intended behavior. this is what happens with vhost-user by the way as the ofport id does not get asigned until the vm startrs and until that point it will have a ofportid of -1 not []

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Paul Peereboom (peereb)](https://launchpad.net/~peereb) wrote on 2019-12-18: |  |  | [#91](/neutron/%2Bbug/1734320/comments/91) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/neutron/%2Bbug/1734320/comments/91/%2Bdownload) (4.1 KiB)

Hi Sean,

I've finally managed to setup a Stein environment to test the isolate\_vif option. I tried to set isolate\_vif in nova.conf but instances than fails to spawn with the following in the nova-compute.log:

2019-12-18 13:32:07.180 30660 ERROR vif\_plug\_ovs.ovsdb.impl\_vsctl [req-303dc31c-3c1e-446e-8f1e-83b604cee0c6 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Unable to e

xecute ['ovs-vsctl', '--timeout=120', '--oneline', '--format=json', '--db=tcp:127.0.0.1:6640', '--', '--may-exist', 'add-port', 'br-int', 'qvo5639e4bf-52', '--', 'set', 'Interface', 'qvo5639e4bf-52', 'ext

ernal\_ids:iface-id=5639e4bf-52d7-4674-9084-e258acb47fae', 'external\_ids:iface-status=active', 'external\_ids:attached-mac=fa:16:3e:d8:ff:c8', 'external\_ids:vm-uuid=1a6cfd1e-7414-4ac3-8c5d-81918a445ab5', 't

ag=4095']. Exception: Unexpected error while running command.

Command: ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo5639e4bf-52 -- set Interface qvo5639e4bf-52 external\_ids:iface-id=5639e4bf-52d7-4674-9084

-e258acb47fae external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:d8:ff:c8 external\_ids:vm-uuid=1a6cfd1e-7414-4ac3-8c5d-81918a445ab5 tag=4095

Exit code: 1

Stdout: ''

Stderr: 'ovs-vsctl: Interface does not contain a column whose name matches "tag"\n': oslo\_concurrency.processutils.ProcessExecutionError: Unexpected error while running command.

2019-12-18 13:32:07.254 30660 INFO os\_vif [req-303dc31c-3c1e-446e-8f1e-83b604cee0c6 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Successfully plugged vif VIFBridge(

active=False,address=fa:16:3e:d8:ff:c8,bridge\_name='qbr5639e4bf-52',has\_traffic\_filtering=True,id=5639e4bf-52d7-4674-9084-e258acb47fae,network=Network(c4197b2d-f568-4bd2-9b0a-eb0fa05e7428),plugin='ovs',po

rt\_profile=VIFPortProfileOpenVSwitch,preserve\_on\_delete=False,vif\_name='tap5639e4bf-52')

2019-12-18 13:32:07.275 30660 ERROR vif\_plug\_ovs.ovsdb.impl\_vsctl [req-be4f125b-e4e5-427d-ba84-b0fb86478807 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Unable to e

xecute ['ovs-vsctl', '--timeout=120', '--oneline', '--format=json', '--db=tcp:127.0.0.1:6640', '--', '--may-exist', 'add-port', 'br-int', 'qvo8e2e0cb9-27', '--', 'set', 'Interface', 'qvo8e2e0cb9-27', 'ext

ernal\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2', 'external\_ids:iface-status=active', 'external\_ids:attached-mac=fa:16:3e:41:40:43', 'external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2', 't

ag=4095']. Exception: Unexpected error while running command.

Command: ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 -- set Interface qvo8e2e0cb9-27 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d

-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2 tag=4095

Exit code: 1

Stdout: ''

Stderr: 'ovs-vsctl: Interface does not contain a column whose name matches "tag"\n': oslo\_concurrency.processutils.ProcessExecutionError: Unexpected error while running command.

Open...

[Read more...](/neutron/%2Bbug/1734320/comments/91)

Hi Sean,
I've finally managed to setup a Stein environment to test the isolate\_vif option. I tried to set isolate\_vif in nova.conf but instances than fails to spawn with the following in the nova-compute.log:
2019-12-18 13:32:07.180 30660 ERROR vif\_plug\_ovs.ovsdb.impl\_vsctl [req-303dc31c-3c1e-446e-8f1e-83b604cee0c6 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Unable to e
xecute ['ovs-vsctl', '--timeout=120', '--oneline', '--format=json', '--db=tcp:127.0.0.1:6640', '--', '--may-exist', 'add-port', 'br-int', 'qvo5639e4bf-52', '--', 'set', 'Interface', 'qvo5639e4bf-52', 'ext
ernal\_ids:iface-id=5639e4bf-52d7-4674-9084-e258acb47fae', 'external\_ids:iface-status=active', 'external\_ids:attached-mac=fa:16:3e:d8:ff:c8', 'external\_ids:vm-uuid=1a6cfd1e-7414-4ac3-8c5d-81918a445ab5', 't
ag=4095']. Exception: Unexpected error while running command.
Command: ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo5639e4bf-52 -- set Interface qvo5639e4bf-52 external\_ids:iface-id=5639e4bf-52d7-4674-9084
-e258acb47fae external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:d8:ff:c8 external\_ids:vm-uuid=1a6cfd1e-7414-4ac3-8c5d-81918a445ab5 tag=4095
Exit code: 1
Stdout: ''
Stderr: 'ovs-vsctl: Interface does not contain a column whose name matches "tag"\n': oslo\_concurrency.processutils.ProcessExecutionError: Unexpected error while running command.
2019-12-18 13:32:07.254 30660 INFO os\_vif [req-303dc31c-3c1e-446e-8f1e-83b604cee0c6 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Successfully plugged vif VIFBridge(
active=False,address=fa:16:3e:d8:ff:c8,bridge\_name='qbr5639e4bf-52',has\_traffic\_filtering=True,id=5639e4bf-52d7-4674-9084-e258acb47fae,network=Network(c4197b2d-f568-4bd2-9b0a-eb0fa05e7428),plugin='ovs',po
rt\_profile=VIFPortProfileOpenVSwitch,preserve\_on\_delete=False,vif\_name='tap5639e4bf-52')
2019-12-18 13:32:07.275 30660 ERROR vif\_plug\_ovs.ovsdb.impl\_vsctl [req-be4f125b-e4e5-427d-ba84-b0fb86478807 68910e67a8cb49e1af2d2bb3b4e3fa49 d5d22a5d7e194a0789a07a3c4d2affd6 - default default] Unable to e
xecute ['ovs-vsctl', '--timeout=120', '--oneline', '--format=json', '--db=tcp:127.0.0.1:6640', '--', '--may-exist', 'add-port', 'br-int', 'qvo8e2e0cb9-27', '--', 'set', 'Interface', 'qvo8e2e0cb9-27', 'ext
ernal\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2', 'external\_ids:iface-status=active', 'external\_ids:attached-mac=fa:16:3e:41:40:43', 'external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2', 't
ag=4095']. Exception: Unexpected error while running command.
Command: ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 -- set Interface qvo8e2e0cb9-27 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d
-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2 tag=4095
Exit code: 1
Stdout: ''
Stderr: 'ovs-vsctl: Interface does not contain a column whose name matches "tag"\n': oslo\_concurrency.processutils.ProcessExecutionError: Unexpected error while running command.
Openstack version: Stein
[root@compute1 (GN0) ~]# ovs-vsctl -V
ovs-vsctl (Open vSwitch) 2.11.0
DB Schema 7.16.1
[root@compute1 (GN0) ~]# rpm -qa | grep neutron
openstack-neutron-common-14.0.3-0.20190923200444.5eb234b.el8ost.noarch
openstack-neutron-openvswitch-14.0.3-0.20190923200444.5eb234b.el8ost.noarch
python3-neutron-lib-1.25.0-0.20190521130309.fc2a810.el8ost.noarch
python3-neutronclient-6.12.0-0.20190312100012.680b417.el8ost.noarch
openstack-neutron-14.0.3-0.20190923200444.5eb234b.el8ost.noarch
python3-neutron-14.0.3-0.20190923200444.5eb234b.el8ost.noarch
openstack-neutron-ml2-14.0.3-0.20190923200444.5eb234b.el8ost.noarch
[root@compute1 (GN0) ~]# rpm -qa | grep nova
python3-novaclient-13.0.1-0.20190710173535.ef842ca.el8ost.noarch
python3-nova-19.0.3-0.20190814170534.a8e19af.el8ost.noarch
openstack-nova-common-19.0.3-0.20190814170534.a8e19af.el8ost.noarch
openstack-nova-compute-19.0.3-0.20190814170534.a8e19af.el8ost.noarch
Do I miss something?
Regards,
Paul

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Paul Peereboom (peereb)](https://launchpad.net/~peereb) wrote on 2019-12-18: |  |  | [#92](/neutron/%2Bbug/1734320/comments/92) |
| --- | --- | --- | --- |

Aha think I got it, looks like the tag order is wrong:

Fails:

ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 -- set Interface qvoc94a40f4-a3 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2 tag=4095

Works:

ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 tag=4095 -- set Interface qvoc94a40f4-a3 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2

Aha think I got it, looks like the tag order is wrong:
Fails:
ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 -- set Interface qvoc94a40f4-a3 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2 tag=4095
Works:
ovs-vsctl --timeout=120 --oneline --format=json --db=tcp:127.0.0.1:6640 -- --may-exist add-port br-int qvo8e2e0cb9-27 tag=4095 -- set Interface qvoc94a40f4-a3 external\_ids:iface-id=8e2e0cb9-2785-4d09-835d-f20897035cf2 external\_ids:iface-status=active external\_ids:attached-mac=fa:16:3e:41:40:43 external\_ids:vm-uuid=4773263b-d538-4e1b-b405-7c39c96eb7e2

[Bernard Cafarelli (bcafarel)](https://launchpad.net/~bcafarel)
on 2020-01-14

| **tags**: | removed: neutron-proactive-backport-potential |
| --- | --- |

[ABDULLAH (l7kx)](https://launchpad.net/~l7kx)
on 2020-08-03

| Changed in neutron: | |
| --- | --- |
| **status**: | Fix Committed → Confirmed |
| **status**: | Confirmed → New |
| Changed in nova: | |
| **status**: | In Progress → Fix Released |
| Changed in neutron: | |
| **status**: | New → Incomplete |
| **status**: | Incomplete → Confirmed |

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2020-08-04

| Changed in neutron: | |
| --- | --- |
| **assignee**: | sean mooney (sean-k-mooney) → Rodolfo Alonso (rodolfo-alonso-hernandez) |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-08-25:  [**Fix merged to neutron (master)**](/neutron/%2Bbug/1734320/comments/93) |  |  | [#93](/neutron/%2Bbug/1734320/comments/93) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/640258>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=7fd2725cb14b81f442eb57a38755829270ff2c43>

Submitter: Zuul

Branch: master

commit 7fd2725cb14b81f442eb57a38755829270ff2c43

Author: Sean Mooney <email address hidden>

Date: Fri Mar 1 04:43:20 2019 +0000

Do not skip ports with ofport unset or invalid

This change removes the "\_check\_ofport" function and its use form

    the ovs\_lib.py file.

By skipping ports without a unique ofport in the "get\_vifs\_by\_ids"

    and "get\_vifs\_by\_id" functions, the OVS agent incorrectly treated

    newly added port with an ofport of -1 as removed ports in the

    "treat\_devices\_added\_or\_updated" function.

Co-Authored-By: Rodolfo Alonso Hernandez <email address hidden>

Change-Id: I79158baafbb99bee99a1d687039313eb454d3a9b

    Partial-Bug: #1734320

    Partial-Bug: #1815989

Reviewed: https://review.opendev.org/640258
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=7fd2725cb14b81f442eb57a38755829270ff2c43
Submitter: Zuul
Branch: master
commit 7fd2725cb14b81f442eb57a38755829270ff2c43
Author: Sean Mooney <work@seanmooney.info>
Date: Fri Mar 1 04:43:20 2019 +0000
Do not skip ports with ofport unset or invalid
This change removes the "\_check\_ofport" function and its use form
the ovs\_lib.py file.
By skipping ports without a unique ofport in the "get\_vifs\_by\_ids"
and "get\_vifs\_by\_id" functions, the OVS agent incorrectly treated
newly added port with an ofport of -1 as removed ports in the
"treat\_devices\_added\_or\_updated" function.
Co-Authored-By: Rodolfo Alonso Hernandez <ralonsoh@redhat.com>
Change-Id: I79158baafbb99bee99a1d687039313eb454d3a9b
Partial-Bug: #1734320
Partial-Bug: #1815989

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-08-26:  [**Related fix proposed to nova (master)**](/neutron/%2Bbug/1734320/comments/94) |  |  | [#94](/neutron/%2Bbug/1734320/comments/94) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.opendev.org/748296>

Related fix proposed to branch: master
Review: https://review.opendev.org/748296

[Bernard Cafarelli (bcafarel)](https://launchpad.net/~bcafarel)
on 2020-09-04

| **tags**: | added: neutron-proactive-backport-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2020-09-04: |  |  | [#95](/neutron/%2Bbug/1734320/comments/95) |
| --- | --- | --- | --- |

by the way while the neutron patch is now merged the nova patch to delegate the pluggin to os-vif is blocked as the neutron api seams to be sending network-vif-plugged events at the wrong time when we are evacuating nad during some other lifecycle operations like revert. so untill we figure out that the backport fo the most resent neturon patch will do nothing help adress this.

the way nova is using neutron has not changed so libvirt will still delete the port on ovs and recreated it defeating the work that has been done to validate the netowrking is set up before we migrate.

by the way while the neutron patch is now merged the nova patch to delegate the pluggin to os-vif is blocked as the neutron api seams to be sending network-vif-plugged events at the wrong time when we are evacuating nad during some other lifecycle operations like revert. so untill we figure out that the backport fo the most resent neturon patch will do nothing help adress this.
the way nova is using neutron has not changed so libvirt will still delete the port on ovs and recreated it defeating the work that has been done to validate the netowrking is set up before we migrate.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [sean mooney (sean-k-mooney)](https://launchpad.net/~sean-k-mooney) wrote on 2020-09-04: |  |  | [#96](/neutron/%2Bbug/1734320/comments/96) |
| --- | --- | --- | --- |

with that said it is safe to backport the neutron patch that recnetly merged and it will have to be backported before the nova patch is but we were recommending waiting for the nova patch and any other neutron patche that might be required to merge first before starting the backports

we only want to backport a fully working solution

with that said it is safe to backport the neutron patch that recnetly merged and it will have to be backported before the nova patch is but we were recommending waiting for the nova patch and any other neutron patche that might be required to merge first before starting the backports
we only want to backport a fully working solution

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-09-08:  [**Change abandoned on nova (master)**](/neutron/%2Bbug/1734320/comments/97) |  |  | [#97](/neutron/%2Bbug/1734320/comments/97) |
| --- | --- | --- | --- |

Change abandoned by sean mooney (<email address hidden>) on branch: master

Review: <https://review.opendev.org/748296>

Change abandoned by sean mooney (smooney@redhat.com) on branch: master
Review: https://review.opendev.org/748296

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-09-25:  [**Fix proposed to neutron (stable/ussuri)**](/neutron/%2Bbug/1734320/comments/98) |  |  | [#98](/neutron/%2Bbug/1734320/comments/98) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: <https://review.opendev.org/754475>

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/754475

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-10-06:  [**Related fix merged to neutron (master)**](/neutron/%2Bbug/1734320/comments/99) |  |  | [#99](/neutron/%2Bbug/1734320/comments/99) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/753314>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=c8a819aff4db62e58192af0a272a7f1ce7923146>

Submitter: Zuul

Branch: master

commit c8a819aff4db62e58192af0a272a7f1ce7923146

Author: Rodolfo Alonso Hernandez <email address hidden>

Date: Thu Sep 24 09:44:47 2020 +0000

Filter out port with invalid ofport in OVS firewall

Since [1], "get\_vif\_port\_by\_id" is also returning ports with an

    invalid ofport. OVS firewall cannot set an OpenFlow rule for a port

    without a valid ofport. "get\_ovs\_port" should filter out those ports.

Related-Bug: #1815989

    Related-Bug: #1734320

[1]<https://review.opendev.org/#/c/640258/>

Change-Id: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50

Reviewed: https://review.opendev.org/753314
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=c8a819aff4db62e58192af0a272a7f1ce7923146
Submitter: Zuul
Branch: master
commit c8a819aff4db62e58192af0a272a7f1ce7923146
Author: Rodolfo Alonso Hernandez <ralonsoh@redhat.com>
Date: Thu Sep 24 09:44:47 2020 +0000
Filter out port with invalid ofport in OVS firewall
Since [1], "get\_vif\_port\_by\_id" is also returning ports with an
invalid ofport. OVS firewall cannot set an OpenFlow rule for a port
without a valid ofport. "get\_ovs\_port" should filter out those ports.
Related-Bug: #1815989
Related-Bug: #1734320
[1]https://review.opendev.org/#/c/640258/
Change-Id: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-10-07:  [**Related fix proposed to neutron (stable/victoria)**](/neutron/%2Bbug/1734320/comments/100) |  |  | [#100](/neutron/%2Bbug/1734320/comments/100) |
| --- | --- | --- | --- |

Related fix proposed to branch: stable/victoria

Review: <https://review.opendev.org/756478>

Related fix proposed to branch: stable/victoria
Review: https://review.opendev.org/756478

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2020-10-23:  [**Related fix merged to neutron (stable/victoria)**](/neutron/%2Bbug/1734320/comments/101) |  |  | [#101](/neutron/%2Bbug/1734320/comments/101) |
| --- | --- | --- | --- |

Reviewed: <https://review.opendev.org/756478>

Committed: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=24dd977c2217bb10baf2cf226eab2bd0e5b47d62>

Submitter: Zuul

Branch: stable/victoria

commit 24dd977c2217bb10baf2cf226eab2bd0e5b47d62

Author: Rodolfo Alonso Hernandez <email address hidden>

Date: Thu Sep 24 09:44:47 2020 +0000

Filter out port with invalid ofport in OVS firewall

Since [1], "get\_vif\_port\_by\_id" is also returning ports with an

    invalid ofport. OVS firewall cannot set an OpenFlow rule for a port

    without a valid ofport. "get\_ovs\_port" should filter out those ports.

Related-Bug: #1815989

    Related-Bug: #1734320

[1]<https://review.opendev.org/#/c/640258/>

Change-Id: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50

    (cherry picked from commit c8a819aff4db62e58192af0a272a7f1ce7923146)

Reviewed: https://review.opendev.org/756478
Committed: https://git.openstack.org/cgit/openstack/neutron/commit/?id=24dd977c2217bb10baf2cf226eab2bd0e5b47d62
Submitter: Zuul
Branch: stable/victoria
commit 24dd977c2217bb10baf2cf226eab2bd0e5b47d62
Author: Rodolfo Alonso Hernandez <ralonsoh@redhat.com>
Date: Thu Sep 24 09:44:47 2020 +0000
Filter out port with invalid ofport in OVS firewall
Since [1], "get\_vif\_port\_by\_id" is also returning ports with an
invalid ofport. OVS firewall cannot set an OpenFlow rule for a port
without a valid ofport. "get\_ovs\_port" should filter out those ports.
Related-Bug: #1815989
Related-Bug: #1734320
[1]https://review.opendev.org/#/c/640258/
Change-Id: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50
(cherry picked from commit c8a819aff4db62e58192af0a272a7f1ce7923146)

| **tags**: | added: in-stable-victoria |
| --- | --- |

[Slawek Kaplonski (slaweq)](https://launchpad.net/~slaweq)
on 2020-12-11

| Changed in neutron: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-05-01:  [**Fix merged to nova (master)**](/neutron/%2Bbug/1734320/comments/102) |  |  | [#102](/neutron/%2Bbug/1734320/comments/102) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/602432](https://review.opendev.org/c/openstack/nova/%2B/602432)

Committed: <https://opendev.org/openstack/nova/commit/a62dd42c0dbb6b2ab128e558e127d76962738446>

Submitter: "Zuul (22348)"

Branch: master

commit a62dd42c0dbb6b2ab128e558e127d76962738446

Author: Stephen Finucane <email address hidden>

Date: Fri Apr 30 12:51:35 2021 +0100

libvirt: Delegate OVS plug to os-vif

os-vif 1.15.0 added the ability to create an OVS port during plugging

    by specifying the 'create\_port' attribute in the 'port\_profile' field.

    By delegating port creation to os-vif, we can rely on it's 'isolate\_vif'

    config option [1] that will temporarily configure the VLAN to 4095

    (0xfff), which is reserved for implementation use [2] and is used by

    neutron to as a dead VLAN [3]. By doing this, we ensure VIFs are plugged

    securely, preventing guests from accessing other tenants' networks

    before the neutron OVS agent can wire up the port.

This change requires a little dance as part of the live migration flow.

    Since we can't be certain the destination host has a version of os-vif

    that supports this feature, we need to use a sentinel to indicate when

    it does. Typically we would do so with a field in

    'LibvirtLiveMigrateData', such as the 'src\_supports\_numa\_live\_migration'

    and 'dst\_supports\_numa\_live\_migration' fields used to indicate support

    for NUMA-aware live migration. However, doing this prevents us

    backporting this important fix since o.vo changes are not backportable.

    Instead, we (somewhat evilly) rely on the free-form nature of the

    'VIFMigrateData.profile\_json' string field, which stores JSON blobs and

    is included in 'LibvirtLiveMigrateData' via the 'vifs' attribute, to

    transport this sentinel. This is a hack but is necessary to work around

    the lack of a free-form "capabilities" style dict that would allow us do

    backportable fixes to live migration features.

Note that this change has the knock on effect of modifying the XML

    generated for OVS ports: when hybrid plug is false will now be of type

    'ethernet' rather than 'bridge' as before. This explains the larger than

    expected test damage but should not affect users.

[1] <https://opendev.org/openstack/os-vif/src/tag/2.4.0/vif_plug_ovs/ovs.py#L90-L93>

    [2] <https://en.wikipedia.org/wiki/IEEE_802.1Q#Frame_format>

    [3] [https://answers.launchpad.net/neutron/+question/231806](https://answers.launchpad.net/neutron/%2Bquestion/231806)

Change-Id: I11fb5d3ada7f27b39c183157ea73c8b72b4e672e

    Depends-On: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50

    Closes-Bug: #1734320

    Closes-Bug: #1815989

Reviewed: https://review.opendev.org/c/openstack/nova/+/602432
Committed: https://opendev.org/openstack/nova/commit/a62dd42c0dbb6b2ab128e558e127d76962738446
Submitter: "Zuul (22348)"
Branch: master
commit a62dd42c0dbb6b2ab128e558e127d76962738446
Author: Stephen Finucane <stephenfin@redhat.com>
Date: Fri Apr 30 12:51:35 2021 +0100
libvirt: Delegate OVS plug to os-vif
os-vif 1.15.0 added the ability to create an OVS port during plugging
by specifying the 'create\_port' attribute in the 'port\_profile' field.
By delegating port creation to os-vif, we can rely on it's 'isolate\_vif'
config option [1] that will temporarily configure the VLAN to 4095
(0xfff), which is reserved for implementation use [2] and is used by
neutron to as a dead VLAN [3]. By doing this, we ensure VIFs are plugged
securely, preventing guests from accessing other tenants' networks
before the neutron OVS agent can wire up the port.
This change requires a little dance as part of the live migration flow.
Since we can't be certain the destination host has a version of os-vif
that supports this feature, we need to use a sentinel to indicate when
it does. Typically we would do so with a field in
'LibvirtLiveMigrateData', such as the 'src\_supports\_numa\_live\_migration'
and 'dst\_supports\_numa\_live\_migration' fields used to indicate support
for NUMA-aware live migration. However, doing this prevents us
backporting this important fix since o.vo changes are not backportable.
Instead, we (somewhat evilly) rely on the free-form nature of the
'VIFMigrateData.profile\_json' string field, which stores JSON blobs and
is included in 'LibvirtLiveMigrateData' via the 'vifs' attribute, to
transport this sentinel. This is a hack but is necessary to work around
the lack of a free-form "capabilities" style dict that would allow us do
backportable fixes to live migration features.
Note that this change has the knock on effect of modifying the XML
generated for OVS ports: when hybrid plug is false will now be of type
'ethernet' rather than 'bridge' as before. This explains the larger than
expected test damage but should not affect users.
[1] https://opendev.org/openstack/os-vif/src/tag/2.4.0/vif\_plug\_ovs/ovs.py#L90-L93
[2] https://en.wikipedia.org/wiki/IEEE\_802.1Q#Frame\_format
[3] https://answers.launchpad.net/neutron/+question/231806
Change-Id: I11fb5d3ada7f27b39c183157ea73c8b72b4e672e
Depends-On: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50
Closes-Bug: #1734320
Closes-Bug: #1815989

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-05-10:  [**Fix proposed to nova (stable/wallaby)**](/neutron/%2Bbug/1734320/comments/103) |  |  | [#103](/neutron/%2Bbug/1734320/comments/103) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/wallaby

Review: [https://review.opendev.org/c/openstack/nova/+/790447](https://review.opendev.org/c/openstack/nova/%2B/790447)

Fix proposed to branch: stable/wallaby
Review: https://review.opendev.org/c/openstack/nova/+/790447

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-06-18:  [**Related fix proposed to nova (master)**](/neutron/%2Bbug/1734320/comments/104) |  |  | [#104](/neutron/%2Bbug/1734320/comments/104) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/nova/+/797142](https://review.opendev.org/c/openstack/nova/%2B/797142)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/nova/+/797142

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-06-18:  [**Fix proposed to nova (stable/victoria)**](/neutron/%2Bbug/1734320/comments/105) |  |  | [#105](/neutron/%2Bbug/1734320/comments/105) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/victoria

Review: [https://review.opendev.org/c/openstack/nova/+/797144](https://review.opendev.org/c/openstack/nova/%2B/797144)

Fix proposed to branch: stable/victoria
Review: https://review.opendev.org/c/openstack/nova/+/797144

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-06-21:  [**Fix proposed to nova (stable/ussuri)**](/neutron/%2Bbug/1734320/comments/106) |  |  | [#106](/neutron/%2Bbug/1734320/comments/106) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/ussuri

Review: [https://review.opendev.org/c/openstack/nova/+/797291](https://review.opendev.org/c/openstack/nova/%2B/797291)

Fix proposed to branch: stable/ussuri
Review: https://review.opendev.org/c/openstack/nova/+/797291

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-06-21:  [**Fix proposed to nova (stable/train)**](/neutron/%2Bbug/1734320/comments/107) |  |  | [#107](/neutron/%2Bbug/1734320/comments/107) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/train

Review: [https://review.opendev.org/c/openstack/nova/+/797316](https://review.opendev.org/c/openstack/nova/%2B/797316)

Fix proposed to branch: stable/train
Review: https://review.opendev.org/c/openstack/nova/+/797316

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-06-22:  [**Related fix proposed to nova (master)**](/neutron/%2Bbug/1734320/comments/108) |  |  | [#108](/neutron/%2Bbug/1734320/comments/108) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/nova/+/797428](https://review.opendev.org/c/openstack/nova/%2B/797428)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/nova/+/797428

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-07-25:  [**Related fix merged to nova (master)**](/neutron/%2Bbug/1734320/comments/109) |  |  | [#109](/neutron/%2Bbug/1734320/comments/109) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/797142](https://review.opendev.org/c/openstack/nova/%2B/797142)

Committed: <https://opendev.org/openstack/nova/commit/99cf5292c782828ea33a3448ae0e7da028d5d176>

Submitter: "Zuul (22348)"

Branch: master

commit 99cf5292c782828ea33a3448ae0e7da028d5d176

Author: Stephen Finucane <email address hidden>

Date: Fri Jun 18 17:55:50 2021 +0100

objects: Fix VIFMigrateData.supports\_os\_vif\_delegation setter

We're using a 'profile' getter/setter in the 'VIFMigrateData' object to

    ensure we transform the JSON encoded string we store in the database to

    an actual dictionary on load and vice versa on save. However, because

    the getter is returning a new object (constructed from 'json.loads')

    rather than a reference to the original data (which is a string),

    modifying this object doesn't actually change the underlying data in the

    object. We were relying on this broken behavior to set the

    'supports\_os\_vif\_delegation' attribute of the 'VIFMigrateData' object

    and trigger the delegated port creation introduced in change

    I11fb5d3ada7f27b39c183157ea73c8b72b4e672e, which means that code isn't

    actually doing anything yet. Resolve this.

Change-Id: I362deb1088c88cdcd8219922da9dc9a01b10a940

    Signed-off-by: Stephen Finucane <email address hidden>

    Related-Bug: #1734320

    Related-Bug: #1815989

Reviewed: https://review.opendev.org/c/openstack/nova/+/797142
Committed: https://opendev.org/openstack/nova/commit/99cf5292c782828ea33a3448ae0e7da028d5d176
Submitter: "Zuul (22348)"
Branch: master
commit 99cf5292c782828ea33a3448ae0e7da028d5d176
Author: Stephen Finucane <stephenfin@redhat.com>
Date: Fri Jun 18 17:55:50 2021 +0100
objects: Fix VIFMigrateData.supports\_os\_vif\_delegation setter
We're using a 'profile' getter/setter in the 'VIFMigrateData' object to
ensure we transform the JSON encoded string we store in the database to
an actual dictionary on load and vice versa on save. However, because
the getter is returning a new object (constructed from 'json.loads')
rather than a reference to the original data (which is a string),
modifying this object doesn't actually change the underlying data in the
object. We were relying on this broken behavior to set the
'supports\_os\_vif\_delegation' attribute of the 'VIFMigrateData' object
and trigger the delegated port creation introduced in change
I11fb5d3ada7f27b39c183157ea73c8b72b4e672e, which means that code isn't
actually doing anything yet. Resolve this.
Change-Id: I362deb1088c88cdcd8219922da9dc9a01b10a940
Signed-off-by: Stephen Finucane <stephenfin@redhat.com>
Related-Bug: #1734320
Related-Bug: #1815989

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-07-26: |  |  | [#110](/neutron/%2Bbug/1734320/comments/110) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/nova/+/797428](https://review.opendev.org/c/openstack/nova/%2B/797428)

Committed: <https://opendev.org/openstack/nova/commit/fa0fb2fe3d61de1cb871c48ee97053cf2fb5827a>

Submitter: "Zuul (22348)"

Branch: master

commit fa0fb2fe3d61de1cb871c48ee97053cf2fb5827a

Author: Stephen Finucane <email address hidden>

Date: Tue Jun 22 11:37:22 2021 +0100

libvirt: Always delegate OVS plug to os-vif

In change I11fb5d3ada7f27b39c183157ea73c8b72b4e672e, we started

    delegating plugging of OVS ports to os-vif to work around a number of

    bugs. However, this was only introduced for live migration. Plugging is

    still handled by libvirt for spawn. This results in an odd situation,

    whereby an interface of type 'bridge' will be use when creating the

    instance initially, only for this to change to 'ethernet' on live

    migration. Resolve this by \*always\* delegating plugging to os-vif. This

    is achieved by consistently setting the 'delegate\_create' attribute of

    'nova.network.model.VIF' to 'True', which will later get transformed to

    the 'create\_port' attribute of the 'os\_vif.objects.vif.VIFOpenVSwitch'

    object(s) created in 'nova.network.os\_vif\_util.\_nova\_to\_osvif\_vif\_ovs'

    and ultimately result in delegate port creation.

Note that we don't need to worry about making the setting of

    'delegate\_create' conditional on whether we're looking at an OVS port or

    not: this will be handled by '\_nova\_to\_osvif\_vif\_ovs'. We also don't

    need to worry about unsetting this attribute before a live migration:

    the 'delegate\_create' attribute is always overridden as part of

    'nova.objects.migrate\_data.VIFMigrateData.get\_dest\_vif'.

Change-Id: I014c5a81752f86c6b99d19d769c42f318e18e676

    Signed-off-by: Stephen Finucane <email address hidden>

    Related-Bug: #1734320

    Related-Bug: #1815989

Reviewed: https://review.opendev.org/c/openstack/nova/+/797428
Committed: https://opendev.org/openstack/nova/commit/fa0fb2fe3d61de1cb871c48ee97053cf2fb5827a
Submitter: "Zuul (22348)"
Branch: master
commit fa0fb2fe3d61de1cb871c48ee97053cf2fb5827a
Author: Stephen Finucane <stephenfin@redhat.com>
Date: Tue Jun 22 11:37:22 2021 +0100
libvirt: Always delegate OVS plug to os-vif
In change I11fb5d3ada7f27b39c183157ea73c8b72b4e672e, we started
delegating plugging of OVS ports to os-vif to work around a number of
bugs. However, this was only introduced for live migration. Plugging is
still handled by libvirt for spawn. This results in an odd situation,
whereby an interface of type 'bridge' will be use when creating the
instance initially, only for this to change to 'ethernet' on live
migration. Resolve this by \*always\* delegating plugging to os-vif. This
is achieved by consistently setting the 'delegate\_create' attribute of
'nova.network.model.VIF' to 'True', which will later get transformed to
the 'create\_port' attribute of the 'os\_vif.objects.vif.VIFOpenVSwitch'
object(s) created in 'nova.network.os\_vif\_util.\_nova\_to\_osvif\_vif\_ovs'
and ultimately result in delegate port creation.
Note that we don't need to worry about making the setting of
'delegate\_create' conditional on whether we're looking at an OVS port or
not: this will be handled by '\_nova\_to\_osvif\_vif\_ovs'. We also don't
need to worry about unsetting this attribute before a live migration:
the 'delegate\_create' attribute is always overridden as part of
'nova.objects.migrate\_data.VIFMigrateData.get\_dest\_vif'.
Change-Id: I014c5a81752f86c6b99d19d769c42f318e18e676
Signed-off-by: Stephen Finucane <stephenfin@redhat.com>
Related-Bug: #1734320
Related-Bug: #1815989

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2021-09-17:  [**Fix included in openstack/nova 24.0.0.0rc1**](/neutron/%2Bbug/1734320/comments/111) |  |  | [#111](/neutron/%2Bbug/1734320/comments/111) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 24.0.0.0rc1 release candidate.

This issue was fixed in the openstack/nova 24.0.0.0rc1 release candidate.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-02-08:  [**Related fix proposed to nova (stable/wallaby)**](/neutron/%2Bbug/1734320/comments/112) |  |  | [#112](/neutron/%2Bbug/1734320/comments/112) |
| --- | --- | --- | --- |

Related fix proposed to branch: stable/wallaby

Review: [https://review.opendev.org/c/openstack/nova/+/828148](https://review.opendev.org/c/openstack/nova/%2B/828148)

Related fix proposed to branch: stable/wallaby
Review: https://review.opendev.org/c/openstack/nova/+/828148

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-10-05:  [**Change abandoned on nova (stable/train)**](/neutron/%2Bbug/1734320/comments/113) |  |  | [#113](/neutron/%2Bbug/1734320/comments/113) |
| --- | --- | --- | --- |

Change abandoned by "Stephen Finucane <email address hidden>" on branch: stable/train

Review: [https://review.opendev.org/c/openstack/nova/+/797316](https://review.opendev.org/c/openstack/nova/%2B/797316)

Change abandoned by "Stephen Finucane <stephenfin@redhat.com>" on branch: stable/train
Review: https://review.opendev.org/c/openstack/nova/+/797316

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-10-05:  [**Change abandoned on nova (stable/ussuri)**](/neutron/%2Bbug/1734320/comments/114) |  |  | [#114](/neutron/%2Bbug/1734320/comments/114) |
| --- | --- | --- | --- |

Change abandoned by "Stephen Finucane <email address hidden>" on branch: stable/ussuri

Review: [https://review.opendev.org/c/openstack/nova/+/797291](https://review.opendev.org/c/openstack/nova/%2B/797291)

Change abandoned by "Stephen Finucane <stephenfin@redhat.com>" on branch: stable/ussuri
Review: https://review.opendev.org/c/openstack/nova/+/797291

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-10-05:  [**Change abandoned on nova (stable/victoria)**](/neutron/%2Bbug/1734320/comments/115) |  |  | [#115](/neutron/%2Bbug/1734320/comments/115) |
| --- | --- | --- | --- |

Change abandoned by "Stephen Finucane <email address hidden>" on branch: stable/victoria

Review: [https://review.opendev.org/c/openstack/nova/+/797144](https://review.opendev.org/c/openstack/nova/%2B/797144)

Change abandoned by "Stephen Finucane <stephenfin@redhat.com>" on branch: stable/victoria
Review: https://review.opendev.org/c/openstack/nova/+/797144

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2022-10-05:  [**Change abandoned on nova (stable/wallaby)**](/neutron/%2Bbug/1734320/comments/116) |  |  | [#116](/neutron/%2Bbug/1734320/comments/116) |
| --- | --- | --- | --- |

Change abandoned by "Stephen Finucane <email address hidden>" on branch: stable/wallaby

Review: [https://review.opendev.org/c/openstack/nova/+/790447](https://review.opendev.org/c/openstack/nova/%2B/790447)

Change abandoned by "Stephen Finucane <stephenfin@redhat.com>" on branch: stable/wallaby
Review: https://review.opendev.org/c/openstack/nova/+/790447

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-02-28:  [**Change abandoned on neutron (stable/ussuri)**](/neutron/%2Bbug/1734320/comments/117) |  |  | [#117](/neutron/%2Bbug/1734320/comments/117) |
| --- | --- | --- | --- |

Change abandoned by "Rodolfo Alonso <email address hidden>" on branch: stable/ussuri

Review: [https://review.opendev.org/c/openstack/neutron/+/754475](https://review.opendev.org/c/openstack/neutron/%2B/754475)

Reason: If needed, please restore the patch and address the comments.

Change abandoned by "Rodolfo Alonso <ralonsoh@redhat.com>" on branch: stable/ussuri
Review: https://review.opendev.org/c/openstack/neutron/+/754475
Reason: If needed, please restore the patch and address the comments.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2023-04-23:  [**Fix merged to nova (stable/wallaby)**](/neutron/%2Bbug/1734320/comments/118) |  |  | [#118](/neutron/%2Bbug/1734320/comments/118) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/neutron/%2Bbug/1734320/comments/118/%2Bdownload) (4.4 KiB)

Reviewed: [https://review.opendev.org/c/openstack/nova/+/790447](https://review.opendev.org/c/openstack/nova/%2B/790447)

Committed: <https://opendev.org/openstack/nova/commit/23a4b27dc0c156ad6cbe5260d518da3fd62294b8>

Submitter: "Zuul (22348)"

Branch: stable/wallaby

commit 23a4b27dc0c156ad6cbe5260d518da3fd62294b8

Author: Stephen Finucane <email address hidden>

Date: Fri Apr 30 12:51:35 2021 +0100

libvirt: Delegate OVS plug to os-vif

os-vif 1.15.0 added the ability to create an OVS port during plugging

    by specifying the 'create\_port' attribute in the 'port\_profile' field.

    By delegating port creation to os-vif, we can rely on it's 'isolate\_vif'

    config option [1] that will temporarily configure the VLAN to 4095

    (0xfff), which is reserved for implementation use [2] and is used by

    neutron to as a dead VLAN [3]. By doing this, we ensure VIFs are plugged

    securely, preventing guests from accessing other tenants' networks

    before the neutron OVS agent can wire up the port.

This change requires a little dance as part of the live migration flow.

    Since we can't be certain the destination host has a version of os-vif

    that supports this feature, we need to use a sentinel to indicate when

    it does. Typically we would do so with a field in

    'LibvirtLiveMigrateData', such as the 'src\_supports\_numa\_live\_migration'

    and 'dst\_supports\_numa\_live\_migration' fields used to indicate support

    for NUMA-aware live migration. However, doing this prevents us

    backporting this important fix since o.vo changes are not backportable.

    Instead, we (somewhat evilly) rely on the free-form nature of the

    'VIFMigrateData.profile\_json' string field, which stores JSON blobs and

    is included in 'LibvirtLiveMigrateData' via the 'vifs' attribute, to

    transport this sentinel. This is a hack but is necessary to work around

    the lack of a free-form "capabilities" style dict that would allow us do

    backportable fixes to live migration features.

Note that this change has the knock on effect of modifying the XML

    generated for OVS ports: when hybrid plug is false will now be of type

    'ethernet' rather than 'bridge' as before. This explains the larger than

    expected test damage but should not affect users.

Changes:

      lower-constraints.txt

      requirements.txt

      nova/network/os\_vif\_util.py

      nova/tests/unit/virt/libvirt/test\_vif.py

      nova/tests/unit/virt/libvirt/test\_driver.py

      nova/virt/libvirt/driver.py

NOTE(stephenfin): Change I362deb1088c88cdcd8219922da9dc9a01b10a940

    ("objects: Fix VIFMigrateData.supports\_os\_vif\_delegation setter") which

    contains an important fix for the original change, is squashed into this

    change. In addition, the os-vif version bump we introduced in the

    original version of this patch is not backportable and as a result, we

    must introduce two additional checks. Both checks ensure we have a

    suitable version of os-vif and skip the new code paths if not. The first

    check is in the libvirt driver's 'check\_can\_live\_migrate\_destination'

    function, which as the name suggests runs on the destination host early

    in the live migration process. If os-v...

[Read more...](/neutron/%2Bbug/1734320/comments/118)

Reviewed: https://review.opendev.org/c/openstack/nova/+/790447
Committed: https://opendev.org/openstack/nova/commit/23a4b27dc0c156ad6cbe5260d518da3fd62294b8
Submitter: "Zuul (22348)"
Branch: stable/wallaby
commit 23a4b27dc0c156ad6cbe5260d518da3fd62294b8
Author: Stephen Finucane <stephenfin@redhat.com>
Date: Fri Apr 30 12:51:35 2021 +0100
libvirt: Delegate OVS plug to os-vif
os-vif 1.15.0 added the ability to create an OVS port during plugging
by specifying the 'create\_port' attribute in the 'port\_profile' field.
By delegating port creation to os-vif, we can rely on it's 'isolate\_vif'
config option [1] that will temporarily configure the VLAN to 4095
(0xfff), which is reserved for implementation use [2] and is used by
neutron to as a dead VLAN [3]. By doing this, we ensure VIFs are plugged
securely, preventing guests from accessing other tenants' networks
before the neutron OVS agent can wire up the port.
This change requires a little dance as part of the live migration flow.
Since we can't be certain the destination host has a version of os-vif
that supports this feature, we need to use a sentinel to indicate when
it does. Typically we would do so with a field in
'LibvirtLiveMigrateData', such as the 'src\_supports\_numa\_live\_migration'
and 'dst\_supports\_numa\_live\_migration' fields used to indicate support
for NUMA-aware live migration. However, doing this prevents us
backporting this important fix since o.vo changes are not backportable.
Instead, we (somewhat evilly) rely on the free-form nature of the
'VIFMigrateData.profile\_json' string field, which stores JSON blobs and
is included in 'LibvirtLiveMigrateData' via the 'vifs' attribute, to
transport this sentinel. This is a hack but is necessary to work around
the lack of a free-form "capabilities" style dict that would allow us do
backportable fixes to live migration features.
Note that this change has the knock on effect of modifying the XML
generated for OVS ports: when hybrid plug is false will now be of type
'ethernet' rather than 'bridge' as before. This explains the larger than
expected test damage but should not affect users.
Changes:
lower-constraints.txt
requirements.txt
nova/network/os\_vif\_util.py
nova/tests/unit/virt/libvirt/test\_vif.py
nova/tests/unit/virt/libvirt/test\_driver.py
nova/virt/libvirt/driver.py
NOTE(stephenfin): Change I362deb1088c88cdcd8219922da9dc9a01b10a940
("objects: Fix VIFMigrateData.supports\_os\_vif\_delegation setter") which
contains an important fix for the original change, is squashed into this
change. In addition, the os-vif version bump we introduced in the
original version of this patch is not backportable and as a result, we
must introduce two additional checks. Both checks ensure we have a
suitable version of os-vif and skip the new code paths if not. The first
check is in the libvirt driver's 'check\_can\_live\_migrate\_destination'
function, which as the name suggests runs on the destination host early
in the live migration process. If os-vif is not new enough on the
destination, we will report that we cannot support os-vif delegation.
The other check is in the '\_nova\_to\_osvif\_vif\_ovs' helper in
'nova.network.os\_vif\_util'. This simply ensures we don't try to set an
invalid attribute on the os-vif object if the version isn't new enough.
Two tests are modified to accommodate these checks with similar version
check logic. The lower-constraints job can be relied on to validate
behavior on the older version of os-vif.
[1] https://opendev.org/openstack/os-vif/src/tag/2.4.0/vif\_plug\_ovs/ovs.py#L90-L93
[2] https://en.wikipedia.org/wiki/IEEE\_802.1Q#Frame\_format
[3] https://answers.launchpad.net/neutron/+question/231806
NOTE(auniyal):
\* libvirt: Always delegate OVS plug to os-vif is squashed
https://github.com/openstack/nova/commit/fa0fb2fe3d61de1cb871c48ee97053cf2fb5827a
\* Updated fakelibvirt.Domain.XMLDesc to add pci address
for ovs interface, which is a patial backport of
https://github.com/openstack/nova/commit/1ad287bf9a8f65ce68c14f4634775f58abda15c2
Change-Id: I11fb5d3ada7f27b39c183157ea73c8b72b4e672e
Depends-On: Id12486b3127ab4ac8ad9ef2b3641da1b79a25a50
Closes-Bug: #1734320
Closes-Bug: #1815989
(cherry picked from commit a62dd42c0dbb6b2ab128e558e127d76962738446)

| **tags**: | added: in-stable-wallaby |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-03-05:  [**Fix included in openstack/nova wallaby-eom**](/neutron/%2Bbug/1734320/comments/119) |  |  | [#119](/neutron/%2Bbug/1734320/comments/119) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova wallaby-eom release.

This issue was fixed in the openstack/nova wallaby-eom release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-03-05:  [**Change abandoned on nova (stable/wallaby)**](/neutron/%2Bbug/1734320/comments/120) |  |  | [#120](/neutron/%2Bbug/1734320/comments/120) |
| --- | --- | --- | --- |

Change abandoned by "Elod Illes <email address hidden>" on branch: stable/wallaby

Review: [https://review.opendev.org/c/openstack/nova/+/828148](https://review.opendev.org/c/openstack/nova/%2B/828148)

Reason: stable/wallaby branch of openstack/nova is about to be deleted. To be able to do that, all open patches need to be abandoned. Please cherry pick the patch to unmaintained/wallaby if you want to further work on this patch.

Change abandoned by "Elod Illes <elod.illes@est.tech>" on branch: stable/wallaby
Review: https://review.opendev.org/c/openstack/nova/+/828148
Reason: stable/wallaby branch of openstack/nova is about to be deleted. To be able to do that, all open patches need to be abandoned. Please cherry pick the patch to unmaintained/wallaby if you want to further work on this patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-06-28:  [**Related fix proposed to neutron (master)**](/neutron/%2Bbug/1734320/comments/121) |  |  | [#121](/neutron/%2Bbug/1734320/comments/121) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/neutron/+/923035](https://review.opendev.org/c/openstack/neutron/%2B/923035)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/neutron/+/923035

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2024-06-28:  [**Related fix proposed to os-vif (master)**](/neutron/%2Bbug/1734320/comments/122) |  |  | [#122](/neutron/%2Bbug/1734320/comments/122) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: [https://review.opendev.org/c/openstack/os-vif/+/923036](https://review.opendev.org/c/openstack/os-vif/%2B/923036)

Related fix proposed to branch: master
Review: https://review.opendev.org/c/openstack/os-vif/+/923036

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2025-01-08:  [**Related fix merged to os-vif (master)**](/neutron/%2Bbug/1734320/comments/123) |  |  | [#123](/neutron/%2Bbug/1734320/comments/123) |
| --- | --- | --- | --- |

Reviewed: [https://review.opendev.org/c/openstack/os-vif/+/923036](https://review.opendev.org/c/openstack/os-vif/%2B/923036)

Committed: <https://opendev.org/openstack/os-vif/commit/99814b280fbdf8169d291e003cf6dc5a80e08074>

Submitter: "Zuul (22348)"

Branch: master

commit 99814b280fbdf8169d291e003cf6dc5a80e08074

Author: Bence Romsics <email address hidden>

Date: Tue Jun 25 15:52:23 2024 +0200

Do not add taps in trunk bridges to the dead vlan

When using neutron trunks, the tpi port is meant to be put in the dead

    vlan, not the tap, therefore

1) we no longer add taps in trunk bridges to the dead vlan in order to

       avoid [bug #2069543](/bugs/2069543).

While working on this I realized a related problem:

In neutron we changed how the dead vlan is handled. Instead of simply

    setting tag=4095 we set (beyond having a drop rule for tag 4095):

tag : 4095

    trunks : [4095]

    vlan\_mode : trunk

We do this not with the intention of making the port a trunk, but with

    the intention of dropping all traffic arriving on the port. For details

    please see the following patches:

neutron $ git log --oneline --no-merges --grep='dead vlan' -2

    0ddca28454 Make sure "dead vlan" ports cannot transmit packets

    7aae31c9f9 Make the dead vlan actually dead

Therefore 2) this patch also starts handling ports in the dead vlan as

    neutron does.

Change-Id: I4f80d94bc1f346fd0a7ad0b9d684792f1451cf24

    Closes-Bug: #2069543

    Related-Bug: #1734320

    Related-Bug: #1930414

    Related-Bug: #1959564

Reviewed: https://review.opendev.org/c/openstack/os-vif/+/923036
Committed: https://opendev.org/openstack/os-vif/commit/99814b280fbdf8169d291e003cf6dc5a80e08074
Submitter: "Zuul (22348)"
Branch: master
commit 99814b280fbdf8169d291e003cf6dc5a80e08074
Author: Bence Romsics <bence.romsics@gmail.com>
Date: Tue Jun 25 15:52:23 2024 +0200
Do not add taps in trunk bridges to the dead vlan
When using neutron trunks, the tpi port is meant to be put in the dead
vlan, not the tap, therefore
1) we no longer add taps in trunk bridges to the dead vlan in order to
avoid bug #2069543.
While working on this I realized a related problem:
In neutron we changed how the dead vlan is handled. Instead of simply
setting tag=4095 we set (beyond having a drop rule for tag 4095):
tag : 4095
trunks : [4095]
vlan\_mode : trunk
We do this not with the intention of making the port a trunk, but with
the intention of dropping all traffic arriving on the port. For details
please see the following patches:
neutron $ git log --oneline --no-merges --grep='dead vlan' -2
0ddca28454 Make sure "dead vlan" ports cannot transmit packets
7aae31c9f9 Make the dead vlan actually dead
Therefore 2) this patch also starts handling ports in the dead vlan as
neutron does.
Change-Id: I4f80d94bc1f346fd0a7ad0b9d684792f1451cf24
Closes-Bug: #2069543
Related-Bug: #1734320
Related-Bug: #1930414
Related-Bug: #1959564

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2025-01-21:  [**Fix proposed to nova (unmaintained/victoria)**](/neutron/%2Bbug/1734320/comments/124) |  |  | [#124](/neutron/%2Bbug/1734320/comments/124) |
| --- | --- | --- | --- |

Fix proposed to branch: unmaintained/victoria

Review: [https://review.opendev.org/c/openstack/nova/+/939728](https://review.opendev.org/c/openstack/nova/%2B/939728)

Fix proposed to branch: unmaintained/victoria
Review: https://review.opendev.org/c/openstack/nova/+/939728

[See full activity log](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Bactivity)

Displaying first 40
and last 40
comments.
[View all 124
comments](/neutron/%2Bbug/1734320?comments=all) or [add a comment](/neutron/%2Bbug/1734320?comments=all).

* [Report a bug](/neutron/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/neutron/%2Bbug/1734320/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-Mark-all-dead-ports-with-dead-tag.patch](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Battachment/5031634/%2Bfiles/0001-Mark-all-dead-ports-with-dead-tag.patch)
  [Edit](/neutron/%2Bbug/1734320/%2Battachment/5031634 "Change patch details")
* [os-vif tagging new ovs port with dead tag](https://bugs.launchpad.net/neutron/%2Bbug/1734320/%2Battachment/5033809/%2Bfiles/0001-Create-new-ovs-ports-with-dead-vlan-tag.patch)
  [Edit](/neutron/%2Bbug/1734320/%2Battachment/5033809 "Change patch details")

* [Add patch](/neutron/%2Bbug/1734320/%2Baddcomment?field.patch=on)

## Remote bug watches

* [redhat-bugs #1558336](https://bugzilla.redhat.com/show_bug.cgi?id=1558336)

  [CLOSED NOTABUG]
  [Edit](/bugs/1734320/%2Bwatch/128803 "Change watch details")

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugzilla.redhat.com_7d0829f8_20250125_164329.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3DCVE-2018-14636)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3DCVE-2018-14636)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3DCVE-2018-14636)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1594977

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1594977**](show_bug.cgi?id=1594977)
(CVE-2018-14636)
- [CVE-2018-14636](https://access.redhat.com/security/cve/CVE-2018-14636) openstack-neutron: eavesdropping private traffic due to trunk ports after live migration

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2018-14636 openstack-neutron: eavesdropping private traffic due to trunk ...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2018-14636 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | Duplicates (1): | [1594825](show_bug.cgi?id=1594825 "CLOSED DUPLICATE - fix for security issue on neutron to downstream (LP#1734320 Eavesdropping private traffic )")  ([view as bug list](buglist.cgi?bug_id=1594825)) | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1594978](show_bug.cgi?id=1594978 "CLOSED CURRENTRELEASE - CVE-2018-14636 openstack-neutron: eavesdropping private traffic due to trunk ports after live migration [openstack-rdo]") [1614596](show_bug.cgi?id=1614596) [1614597](show_bug.cgi?id=1614597) [1614598](show_bug.cgi?id=1614598) [1614599](show_bug.cgi?id=1614599) [1614600](show_bug.cgi?id=1614600) [1678057](show_bug.cgi?id=1678057) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1594979](show_bug.cgi?id=1594979) | | TreeView+ | [depends on](buglist.cgi?bug_id=1594977&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1594977&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2018-06-25 21:57 UTC by Laura Pardo | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-08-04 15:02 UTC ([History](show_activity.cgi?id=1594977)) | | [CC List:](page.cgi?id=fields.html#cclist) | 21 users (show)  apevec chrisw dmoppert ebarrera jjoyce jpadman jschluet lhh lpeer majopela markmc mburns osoukup rbryant sclewis scohen security-response-team skaplons slinaber srevivo tdecacqu | | Fixed In Version: | openstack-neutron 13.0.0.0b2, openstack-neutron 12.0.3, openstack-neutron 11.0.5 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | Live-migrated instances are briefly able to inspect traffic for other instances on the same hypervisor. This brief window could be extended indefinitely if the instance's port is set administratively down prior to live-migration and kept down after the migration is complete. This is possible due to the Open vSwitch integration bridge being connected to the instance during migration. When connected to the integration bridge, all traffic for instances using the same Open vSwitch instance would potentially be visible to the migrated guest, as the required Open vSwitch VLAN filters are only applied post-migration. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2021-07-06 16:40:20 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1594977#c0)  Laura Pardo    2018-06-25 21:57:09 UTC  ``` A flaw was found in Openstack Neutron. During live-migration there is a small time window where the ports of instances are untagged. Instances have a port trunked to the integration bridge and receive 802.1Q tagged private traffic from other tenants. If the port is administratively down during live migration, the port will remain in trunk mode indefinitely. Traffic is possible between ports is that are administratively down, even between tenants self-service networks. This allows end users within their own private network to receive from, and send traffic to, other private networks on the same compute node.   References: [https://bugs.launchpad.net/neutron/+bug/1734320](https://bugs.launchpad.net/neutron/%2Bbug/1734320) [https://bugs.launchpad.net/neutron/+bug/1767422](https://bugs.launchpad.net/neutron/%2Bbug/1767422) [https://bugzilla.redhat.com/show_bug.cgi?id=1594825](show_bug.cgi?id=1594825 "CLOSED DUPLICATE - fix for security issue on neutron to downstream (LP#1734320 Eavesdropping private traffic )")  Patch: <https://git.openstack.org/cgit/openstack/neutron/commit/?id=88f5e11d8bf820b0124be0f6ec3c2d96011592d9>   ```  [Comment 1](show_bug.cgi?id=1594977#c1)  Laura Pardo    2018-06-25 21:57:46 UTC  ``` Created openstack-neutron tracking bugs for this issue:  Affects: openstack-rdo [[bug 1594978](show_bug.cgi?id=1594978 "CLOSED CURRENTRELEASE - CVE-2018-14636 openstack-neutron: eavesdropping private traffic due to trunk ports after live migration [openstack-rdo]")]   ```  [Comment 2](show_bug.cgi?id=1594977#c2)  Joshua Padman    2018-07-04 00:56:34 UTC  ``` *** [Bug 1594825](show_bug.cgi?id=1594825 "CLOSED DUPLICATE - fix for security issue on neutron to downstream (LP#1734320 Eavesdropping private traffic )") has been marked as a duplicate of this bug. ***   ```  [Comment 8](show_bug.cgi?id=1594977#c8)  Miguel Angel Ajo    2018-08-10 14:58:49 UTC  ``` Oh, the patches referenced on the bz are incorrect for this bz, also the 2nd launchpad ( [https://bugs.launchpad.net/neutron/+bug/1767422](https://bugs.launchpad.net/neutron/%2Bbug/1767422) ).   Those patches, and that second launchpad address the case when an agent (dhcp/l3/etc) get's a port plugged, but then the openvswitch-agent is not able to tag the port, it remains untagged, and it's a trunk port.  But those patches *are not* addressing the instances themselves.  This needs to be addressed in nova, or os-vif by plugging the port in vlan 4095, then, when neutron is ready will re-plug to the right vlan.   ```  [Comment 9](show_bug.cgi?id=1594977#c9)  Slawek Kaplonski    2018-08-21 10:19:41 UTC  ``` I checked that and it is like Miguel wrote in last comment. This issue isn't fixed in any of OSP versions yet. It should be fixed in os-vif module as this module is responsible for creating ports in openvswitch during booting/migrating instances. I proposed already such patch in upstream: <https://review.openstack.org/594118>   ```  [Comment 10](show_bug.cgi?id=1594977#c10)  James Hebden    2018-08-28 04:57:07 UTC  ``` Thanks Slawomir for the additional work to close the loop on this. We had included the fixes that had been provided upstream for information purposes, and as Miguel has noted in the tracker, additional patches to nova/os-vif are required to close this out fully. Can you confirm if the upstream neutron patches will also be applied? My understanding of the situation is that both this, and your additional os-vif patch are required to fully close this out.   ```  [Comment 11](show_bug.cgi?id=1594977#c11)  Slawek Kaplonski    2018-08-28 07:35:17 UTC  ``` Hi James. Unfortunately my patch proposed to os-vif will have to be modified and it will also require other patch in Neutron probably. We can't simply set this vlan tag always in os-vif as it breaks other Neutron backends (like networking-odl or dragonfly for example). I will work on that and propose patch to neutron and then modify this one for os-vif.   ```  [Comment 12](show_bug.cgi?id=1594977#c12)  James Hebden    2018-09-09 22:31:03 UTC  ``` Thanks Slawomir, for the clarification, that makes sense. Thanks for your work on this.   ```  [Comment 23](show_bug.cgi?id=1594977#c23)  Product Security DevOps Team    2021-07-06 16:40:20 UTC  ``` This bug is now closed. Further updates for individual products will be reflected on the CVE page(s):  <https://access.redhat.com/security/cve/cve-2018-14636>   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1594977&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)


