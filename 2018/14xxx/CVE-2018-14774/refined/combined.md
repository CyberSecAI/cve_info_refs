=== Content from symfony.com_cb1aa356_20250126_074429.html ===

[Skip to content](#main-content)

Close

* About
  + [What is Symfony?](/what-is-symfony)
  + [Community](/community)
  + [News](/blog/)
  + [Contributing](/doc/current/contributing/index.html)
  + [Support](/support)
* Documentation
  + [Symfony Docs](/doc/current/index.html)
  + [Symfony Book](/book)
  + [Screencasts](https://symfonycasts.com)
  + [Symfony Bundles](/bundles)
  + [Symfony Cloud](/doc/cloud/)
  + [Training](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_submenu&utm_campaign=permanent_referral)
* Services
  + [Platform.sh for Symfony](/cloud/)
    Best platform to deploy Symfony apps
  + [SymfonyInsight](https://insight.symfony.com)
    Automatic quality checks for your apps
  + [Symfony Certification](https://certification.symfony.com)
    Prove your knowledge and boost your career
  + [SensioLabs](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_submenu&utm_campaign=permanent_referral)
    Professional services to help you with Symfony
  + [Blackfire](https://www.blackfire.io/?utm_source=symfony&utm_medium=symfonycom_footer&utm_campaign=profiler)
    Profile and monitor performance of your apps
* Other
* [Blog](/blog/)
* [Download](/download)

sponsored by

New
[**Symfony Jobs**: find a new job or post your job for free to discover new talent](/jobs)

# [Symfony](#symfony "Permanent link to this headline")

## Symfony is a set of reusable PHP *components*...

The standard foundation on which the best PHP applications
are built. Choose any of the 50 stand-alone components
available for your own applications.

[Browse components](/components)

## ... and a PHP *framework* for web projects

Speed up the creation and maintenance of your PHP web
applications. End repetitive coding tasks and enjoy the
power of controlling your code.

[What is Symfony](/what-is-symfony)

### Getting Started with Symfony

* Read [the docs](/doc/current/setup.html)
* Read [the official book](/book) (translated into many languages)
* Watch [the video course](https://symfonycasts.com/tracks/symfony7)

## , the creator of Symfony, helps you solve every stage of your development project

### Start

* [Feasibility Study](https://sensiolabs.com/services/feasibility-study?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)
* [Agile Bootstrap Workshop](https://sensiolabs.com/services/agile-bootstrap-workshop?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)

### Design

* [Architecture Workshop](https://sensiolabs.com/services/architecture-workshop?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)
* [Migration Workshop](https://sensiolabs.com/services/migration-workshop?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)

### Build

* [Symfony Coaching](https://sensiolabs.com/services/symfony-coaching?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)
* [Code Auditing](https://sensiolabs.com/services/quality-performance-security-audits?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)

### Run

* [Version Upgrade](https://sensiolabs.com/services/version-upgrade?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)
* [Rescue Mission](https://sensiolabs.com/services/rescue-mission?utm_source=symfony&utm_medium=homepage_banner&utm_campaign=permanent_referral)

The best way to host your Symfony projects — powered by
[Platform.sh](https://platform.sh/marketplace/symfony/?utm_source=website&utm_medium=website&utm_campaign=symfonycloud_symfony)

[GET STARTED](/cloud/)

[Read the docs](/cloud/get-started)

### Training

* [Symfony Certification Coaching](https://training.sensiolabs.com/en/courses/SF7PRECERTIF-preparation-symfony-7-certification-online-sensiolabs-university?utm_source=symfony&utm_medium=symfony_homepage&utm_campaign=permanent_referral)
* [Symfony 7 Training Courses](https://training.sensiolabs.com/en/?utm_source=symfony&utm_medium=symfony_homepage&utm_campaign=permanent_referral)
* [SensioLabs University eLearning platform](https://university.sensiolabs.com/e-learning-platform?utm_source=symfony&utm_medium=symfony_homepage&utm_campaign=permanent_referral)

[View all sessions](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_homepage_allsessions&utm_campaign=permanent_referral "SensioLabs training sessions")

---

### Popular Screencasts

* [Design Patterns Episode 2](https://symfonycasts.com/screencast/design-patterns-2)
* [Cosmic Coding with Symfony 7](https://symfonycasts.com/screencast/symfony)
* [API Platform 3 Part 1: Mythically Good RESTful APIs](https://symfonycasts.com/screencast/api-platform)

[Subscribe](https://symfonycasts.com/signup/ "Subscribe to SymfonyCasts")

---

### Certifications

[![Symfony certifications logo](/images/home/logo-certification.svg)](https://certification.symfony.com/)

* [Symfony Certification](https://certification.symfony.com/exams/symfony.html)

  Exams available for all Symfony versions!
* [Twig Certification](https://certification.symfony.com/exams/twig.html)

  Created for designers with Twig experience.

[Register](https://certification.symfony.com/purchase.html "Register for the Symfony and Twig certifications")

## Symfony footer

![Avatar of Tobias Naumann, a Symfony contributor](https://connect.symfony.com/api/images/86e0a6c8-0022-432f-99a2-f886647b7820.png?format=48x48)

Thanks
**[Tobias Naumann](https://connect.symfony.com/profile/tna)**
(**@tna**)
for being a Symfony contributor

[**4** commits](https://github.com/tna)
•
**42** lines changed

[View all contributors](/contributors) that help us make Symfony

### Become a Symfony contributor

Be an active part of the community and contribute ideas, code and bug fixes.
Both experts and newcomers are welcome.

[Learn how to contribute](/doc/current/contributing/index.html)

**Symfony**™ is a trademark of Symfony SAS. [All rights reserved](/trademark).

* [What is Symfony?](/what-is-symfony)

  + [What is Symfony?](/what-is-symfony)
  + [Symfony at a Glance](/at-a-glance)
  + [Symfony Components](/components)
  + [Symfony Releases](/releases)
  + [Security Policy](/doc/current/contributing/code/security.html)
  + [Logo & Screenshots](/logo)
  + [Trademark & Licenses](/license)
  + [symfony1 Legacy](/legacy)
* [Learn Symfony](/doc/current/index.html)

  + [Symfony Docs](/doc/current/index.html)
  + [Symfony Book](/book)
  + [Reference](/doc/current/reference/index.html)
  + [Bundles](/bundles)
  + [Best Practices](/doc/current/best_practices.html)
  + [Training](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [eLearning Platform](https://university.sensiolabs.com/e-learning-platform?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Certification](https://certification.symfony.com/)
* [Screencasts](https://symfonycasts.com/)

  + [Learn Symfony](https://symfonycasts.com/tracks/symfony)
  + [Learn PHP](https://symfonycasts.com/tracks/php)
  + [Learn JavaScript](https://symfonycasts.com/tracks/javascript)
  + [Learn Drupal](https://symfonycasts.com/tracks/drupal)
  + [Learn RESTful APIs](https://symfonycasts.com/tracks/rest)
* [Community](/community)

  + [Symfony Community](/community)
  + [SymfonyConnect](https://connect.symfony.com/)
  + [Events & Meetups](/events/)
  + [Projects using Symfony](/projects)
  + [Contributors](/contributors)
  + [Symfony Jobs](/jobs)
  + [Backers](/backers)
  + [Code of Conduct](/doc/current/contributing/code_of_conduct/code_of_conduct.html)
  + [Downloads Stats](/stats/downloads)
  + [Support](/support)
* [Blog](/blog/)

  + [All Blog Posts](/blog/)
  + [A Week of Symfony](/blog/category/a-week-of-symfony)
  + [Case Studies](/blog/category/case-studies)
  + [Cloud](/blog/category/cloud)
  + [Community](/blog/category/community)
  + [Conferences](/blog/category/conferences)
  + [Diversity](/blog/category/diversity)
  + [Living on the edge](/blog/category/living-on-the-edge)
  + [Releases](/blog/category/releases)
  + [Security Advisories](/blog/category/security-advisories)
  + [Symfony Insight](/blog/category/symfony-insight)
  + [Twig](/blog/category/twig)
  + [SensioLabs Blog](https://sensiolabs.com/blog?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
* [Services](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)

  + [SensioLabs services](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Train developers](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Manage your project quality](https://insight.symfony.com/)
  + [Improve your project performance](https://www.blackfire.io/?utm_source=symfony&utm_medium=symfonycom_footer&utm_campaign=profiler)
  + [Host Symfony projects](/cloud/)

  [Powered by](/cloud/)

### Follow Symfony

Site appearance:

Light mode
Dark mode
Sync with system

CLOSE
Search Symfony Docs

Search



=== Content from symfony.com_089b6b5a_20250125_091542.html ===

[Skip to content](#main-content)

Close

* About
  + [What is Symfony?](/what-is-symfony)
  + [Community](/community)
  + [News](/blog/)
  + [Contributing](/doc/current/contributing/index.html)
  + [Support](/support)
* Documentation
  + [Symfony Docs](/doc/current/index.html)
  + [Symfony Book](/book)
  + [Screencasts](https://symfonycasts.com)
  + [Symfony Bundles](/bundles)
  + [Symfony Cloud](/doc/cloud/)
  + [Training](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_submenu&utm_campaign=permanent_referral)
* Services
  + [Platform.sh for Symfony](/cloud/)
    Best platform to deploy Symfony apps
  + [SymfonyInsight](https://insight.symfony.com)
    Automatic quality checks for your apps
  + [Symfony Certification](https://certification.symfony.com)
    Prove your knowledge and boost your career
  + [SensioLabs](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_submenu&utm_campaign=permanent_referral)
    Professional services to help you with Symfony
  + [Blackfire](https://www.blackfire.io/?utm_source=symfony&utm_medium=symfonycom_footer&utm_campaign=profiler)
    Profile and monitor performance of your apps
* Other
* [Blog](/blog/)
* [Download](/download)

sponsored by

1. [Home](https://symfony.com/)
2. [Blog](/blog/)
3. CVE-2018-14774: Possible host header injection when using HttpCache

# CVE-2018-14774: Possible host header injection when using HttpCache

August 1, 2018

•
Published by
[![Avatar of Fabien Potencier](https://connect.symfony.com/api/images/4aed4f5d-e0cb-4320-902f-885fddaa7d15.png?format=28x28)](https://connect.symfony.com/api/alternates/4aed4f5d-e0cb-4320-902f-885fddaa7d15)
[Fabien Potencier](https://connect.symfony.com/api/alternates/4aed4f5d-e0cb-4320-902f-885fddaa7d15)

## Affected versions

Symfony 2.7.0 to 2.7.48, 2.8.0 to 2.8.43, 3.3.0 to 3.3.17, 3.4.0 to 3.4.13, 4.0.0 to 4.0.13,
and 4.1.0 to 4.1.2 versions of the Symfony HttpKernel component are affected by this
security issue.

The issue has been fixed in Symfony 2.7.49, 2.8.44, 3.3.18, 3.4.14, 4.0.14, and 4.1.3.

Note that no fixes are provided for Symfony 3.0, 3.1, and 3.2 as they are not
maintained anymore.

## Description

When using `HttpCache`, the values of the `X-Forwarded-Host` headers are implicitly and wrongly set as trusted, leading to potential host header injection.

## Resolution

The trusted headers are removed when doing internal sub-requests and the remote client is not trusted.

The patch for this issue is available [here](https://github.com/symfony/symfony/commit/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a) for branch 2.8.

## Credits

I would like to thank @chaosversum for reporting the issue and Nicolas Grekas for fixing it.

[Log in](/connect/login?target=https://symfony.com/blog/cve-2018-14774-possible-host-header-injection-when-using-httpcache) to add a reaction to this post

add a reaction ❤️ 👍 🚀

Published in
[#Security Advisories](/blog/category/security-advisories)

Have found a security issue in Symfony? Send the details to
**security [at] symfony.com** and don't
disclose it publicly until we can provide a fix for it.

[Manage your notification preferences](/account/notifications)
to receive an email as soon as a Symfony security release is published.

**Help the Symfony project!**

As with any Open-Source project, [contributing](/doc/current/contributing.html)
code or documentation is the most common way to help, but we also have a wide range of
[sponsoring opportunities](/sponsor).

## [Comments](#comments "Permanent link to this headline")

Comments are closed.

To ensure that comments stay relevant, they are closed for old posts.

* [All Blog Posts](/blog/)
* [A Week of Symfony](/blog/category/a-week-of-symfony)
* [Case Studies](/blog/category/case-studies)
* [Cloud](/blog/category/cloud)
* [Community](/blog/category/community)
* [Conferences](/blog/category/conferences)
* [Diversity](/blog/category/diversity)
* [Living on the edge](/blog/category/living-on-the-edge)
* [Releases](/blog/category/releases)
* [Security Advisories](/blog/category/security-advisories)
* [Symfony Insight](/blog/category/symfony-insight)
* [Twig](/blog/category/twig)
* [SensioLabs Blog](https://sensiolabs.com/blog?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)

[Archives](/blog/archives/2025/1)

[Blog Posts RSS](https://feeds.feedburner.com/symfony/blog "Symfony Blog RSS feed")

[Blog Comments RSS](https://feeds.feedburner.com/symfony/blog/comments "RSS Feed for Symfony Blog comments")

[![Code consumes server resources. Blackfire tells you how](/images/network/blackfire_04.webp)](https://www.blackfire.io/profiler?utm_source=symfony&utm_medium=ad_visual&utm_campaign=profiler)

[Code consumes server resources. Blackfire tells you how](https://www.blackfire.io/profiler?utm_source=symfony&utm_medium=ad_visual&utm_campaign=profiler)

[![Online exam, become Symfony certified today](/images/network/sf7certif_02.webp)](https://certification.symfony.com/?utm_source=ad&utm_medium=banner&utm_campaign=certification&utm_content=symfonycertified)

[Online exam, become Symfony certified today](https://certification.symfony.com/?utm_source=ad&utm_medium=banner&utm_campaign=certification&utm_content=symfonycertified)

[![Peruse our complete Symfony & PHP solutions catalog for your web development needs.](/images/network/slsolutions_01.webp)](https://sensiolabs.com/services?utm_source=symfony&utm_medium=ad_visual&utm_campaign=permanent_referral)

[Peruse our complete Symfony & PHP solutions catalog for your web development needs.](https://sensiolabs.com/services?utm_source=symfony&utm_medium=ad_visual&utm_campaign=permanent_referral)

## Symfony footer

![Avatar of tuqqu, a Symfony contributor](https://www.gravatar.com/avatar/aebf04a376906b8d9483e9b3498b6e6f?size=48&rating=g&default=retro)

Thanks
**tuqqu**
for being a Symfony contributor

**1** commit
•
**22** lines changed

[View all contributors](/contributors) that help us make Symfony

### Become a Symfony contributor

Be an active part of the community and contribute ideas, code and bug fixes.
Both experts and newcomers are welcome.

[Learn how to contribute](/doc/current/contributing/index.html)

**Symfony**™ is a trademark of Symfony SAS. [All rights reserved](/trademark).

* [What is Symfony?](/what-is-symfony)

  + [What is Symfony?](/what-is-symfony)
  + [Symfony at a Glance](/at-a-glance)
  + [Symfony Components](/components)
  + [Symfony Releases](/releases)
  + [Security Policy](/doc/current/contributing/code/security.html)
  + [Logo & Screenshots](/logo)
  + [Trademark & Licenses](/license)
  + [symfony1 Legacy](/legacy)
* [Learn Symfony](/doc/current/index.html)

  + [Symfony Docs](/doc/current/index.html)
  + [Symfony Book](/book)
  + [Reference](/doc/current/reference/index.html)
  + [Bundles](/bundles)
  + [Best Practices](/doc/current/best_practices.html)
  + [Training](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [eLearning Platform](https://university.sensiolabs.com/e-learning-platform?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Certification](https://certification.symfony.com/)
* [Screencasts](https://symfonycasts.com/)

  + [Learn Symfony](https://symfonycasts.com/tracks/symfony)
  + [Learn PHP](https://symfonycasts.com/tracks/php)
  + [Learn JavaScript](https://symfonycasts.com/tracks/javascript)
  + [Learn Drupal](https://symfonycasts.com/tracks/drupal)
  + [Learn RESTful APIs](https://symfonycasts.com/tracks/rest)
* [Community](/community)

  + [Symfony Community](/community)
  + [SymfonyConnect](https://connect.symfony.com/)
  + [Events & Meetups](/events/)
  + [Projects using Symfony](/projects)
  + [Contributors](/contributors)
  + [Symfony Jobs](/jobs)
  + [Backers](/backers)
  + [Code of Conduct](/doc/current/contributing/code_of_conduct/code_of_conduct.html)
  + [Downloads Stats](/stats/downloads)
  + [Support](/support)
* [Blog](/blog/)

  + [All Blog Posts](/blog/)
  + [A Week of Symfony](/blog/category/a-week-of-symfony)
  + [Case Studies](/blog/category/case-studies)
  + [Cloud](/blog/category/cloud)
  + [Community](/blog/category/community)
  + [Conferences](/blog/category/conferences)
  + [Diversity](/blog/category/diversity)
  + [Living on the edge](/blog/category/living-on-the-edge)
  + [Releases](/blog/category/releases)
  + [Security Advisories](/blog/category/security-advisories)
  + [Symfony Insight](/blog/category/symfony-insight)
  + [Twig](/blog/category/twig)
  + [SensioLabs Blog](https://sensiolabs.com/blog?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
* [Services](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)

  + [SensioLabs services](https://sensiolabs.com/?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Train developers](https://sensiolabs.com/training?utm_source=symfony&utm_medium=symfony_footer&utm_campaign=permanent_referral)
  + [Manage your project quality](https://insight.symfony.com/)
  + [Improve your project performance](https://www.blackfire.io/?utm_source=symfony&utm_medium=symfonycom_footer&utm_campaign=profiler)
  + [Host Symfony projects](/cloud/)

  [Powered by](/cloud/)

### Follow Symfony

Site appearance:

Light mode
Dark mode
Sync with system

CLOSE
Search Symfony Docs

Search



=== Content from github.com_5f7f600d_20250125_091542.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsymfony%2Fsymfony%2Fcommit%2F725dee4cd8b4ccd52e335ae4b4522242cea9bd4a)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsymfony%2Fsymfony%2Fcommit%2F725dee4cd8b4ccd52e335ae4b4522242cea9bd4a)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=symfony%2Fsymfony)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[symfony](/symfony)
/
**[symfony](/symfony/symfony)**
Public

* [Notifications](/login?return_to=%2Fsymfony%2Fsymfony) You must be signed in to change notification settings
* [Fork
  9.5k](/login?return_to=%2Fsymfony%2Fsymfony)
* [Star
   29.9k](/login?return_to=%2Fsymfony%2Fsymfony)

* [Code](/symfony/symfony)
* [Issues
  535](/symfony/symfony/issues)
* [Pull requests
  332](/symfony/symfony/pulls)
* [Discussions](/symfony/symfony/discussions)
* [Actions](/symfony/symfony/actions)
* [Projects
  0](/symfony/symfony/projects)
* [Security](/symfony/symfony/security)
* [Insights](/symfony/symfony/pulse)

Additional navigation options

* [Code](/symfony/symfony)
* [Issues](/symfony/symfony/issues)
* [Pull requests](/symfony/symfony/pulls)
* [Discussions](/symfony/symfony/discussions)
* [Actions](/symfony/symfony/actions)
* [Projects](/symfony/symfony/projects)
* [Security](/symfony/symfony/security)
* [Insights](/symfony/symfony/pulse)

## Commit

[Permalink](/symfony/symfony/commit/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[HttpKernel] fix trusted headers management in HttpCache and InlineFr…

[Browse files](/symfony/symfony/tree/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a)
Browse the repository at this point in the history

```
…agmentRenderer
```

* Loading branch information

[![@nicolas-grekas](https://avatars.githubusercontent.com/u/243674?s=40&v=4)](/nicolas-grekas)

[nicolas-grekas](/symfony/symfony/commits?author=nicolas-grekas "View all commits by nicolas-grekas")
committed
Aug 1, 2018

1 parent
[6604978](/symfony/symfony/commit/6604978f8355e1e7c2d1d5584107eee3e10cdbfe)

commit 725dee4

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**350 additions**
and
**92 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/Symfony/Component

  + HttpFoundation

    - src/Symfony/Component/HttpFoundation/Request.php
      [Request.php](#diff-779a02ff90f6fc60228d531d684382d3b585b3c823ba53028ff8d2a9e03a2ea0)
  + HttpKernel

    - Fragment

      * src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php
        [InlineFragmentRenderer.php](#diff-00e2dfc1e3d4842357b49121c5936436a1c30e3d4f4ece78d1bfbe397fe4d689)
    - HttpCache

      * src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php
        [HttpCache.php](#diff-52acfde1fc8edad0d27239560fe7a544c35907dacd30e7551c73ba338065f5ae)
      * src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php
        [SubRequestHandler.php](#diff-7d4dc5cf0a613f43baeca47d6206dc08040b6e8c376b69eebead679f9642d7aa)
    - Tests

      * Fragment

        + src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php
          [InlineFragmentRendererTest.php](#diff-36ed5d4880a321363807f5de73b775d6b15065391dfe8fbaac3ddb6eca41a5d6)
      * HttpCache

        + src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php
          [HttpCacheTest.php](#diff-e9f458bde9b527e37c5c5ad184619f7af3fe06c2a74b00bd56e38cbf3d99c73d)
        + src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php
          [SubRequestHandlerTest.php](#diff-6f7e93710cb2f2e896932b4dc33f8468428919394465a1f924459d86947d70ad)
        + src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php
          [TestHttpKernel.php](#diff-7d407fc1c81a48975452fc3c2b01afe18a28a0507443bcad52903ae13c1c507d)

## There are no files selected for viewing

5 changes: 5 additions & 0 deletions

5
[src/Symfony/Component/HttpFoundation/Request.php](#diff-779a02ff90f6fc60228d531d684382d3b585b3c823ba53028ff8d2a9e03a2ea0 "src/Symfony/Component/HttpFoundation/Request.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpFoundation/Request.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1944,6 +1944,11 @@ private function getTrustedValues($type, $ip = null) |
|  |  | if (self::$trustedHeaders[self::HEADER\_FORWARDED] && $this->headers->has(self::$trustedHeaders[self::HEADER\_FORWARDED])) { |
|  |  | $forwardedValues = $this->headers->get(self::$trustedHeaders[self::HEADER\_FORWARDED]); |
|  |  | $forwardedValues = preg\_match\_all(sprintf('{(?:%s)=(?:"?\[?)([a-zA-Z0-9\.:\_\-/]\*+)}', self::$forwardedParams[$type]), $forwardedValues, $matches) ? $matches[1] : array(); |
|  |  | if (self::HEADER\_CLIENT\_PORT === $type) { |
|  |  | foreach ($forwardedValues as $k => $v) { |
|  |  | $forwardedValues[$k] = substr\_replace($v, '0.0.0.0', 0, strrpos($v, ':')); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (null !== $ip) { |
| Expand Down | |  |

29 changes: 2 additions & 27 deletions

29
[src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php](#diff-00e2dfc1e3d4842357b49121c5936436a1c30e3d4f4ece78d1bfbe397fe4d689 "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,6 +16,7 @@ |
|  |  | use Symfony\Component\HttpFoundation\Response; |
|  |  | use Symfony\Component\HttpKernel\Controller\ControllerReference; |
|  |  | use Symfony\Component\HttpKernel\Event\GetResponseForExceptionEvent; |
|  |  | use Symfony\Component\HttpKernel\HttpCache\SubRequestHandler; |
|  |  | use Symfony\Component\HttpKernel\HttpKernelInterface; |
|  |  | use Symfony\Component\HttpKernel\KernelEvents; |
|  |  |  |
| Expand Down  Expand Up | | @@ -76,7 +77,7 @@ public function render($uri, Request $request, array $options = array()) |
|  |  |  |
|  |  | $level = ob\_get\_level(); |
|  |  | try { |
|  |  | return $this->kernel->handle($subRequest, HttpKernelInterface::SUB\_REQUEST, false); |
|  |  | return SubRequestHandler::handle($this->kernel, $subRequest, HttpKernelInterface::SUB\_REQUEST, false); |
|  |  | } catch (\Exception $e) { |
|  |  | // we dispatch the exception event to trigger the logging |
|  |  | // the response that comes back is simply ignored |
| Expand Down  Expand Up | | @@ -109,21 +110,6 @@ protected function createSubRequest($uri, Request $request) |
|  |  | $cookies = $request->cookies->all(); |
|  |  | $server = $request->server->all(); |
|  |  |  |
|  |  | // Override the arguments to emulate a sub-request. |
|  |  | // Sub-request object will point to localhost as client ip and real client ip |
|  |  | // will be included into trusted header for client ip |
|  |  | try { |
|  |  | if ($trustedHeaderName = Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP)) { |
|  |  | $currentXForwardedFor = $request->headers->get($trustedHeaderName, ''); |
|  |  |  |
|  |  | $server['HTTP\_'.$trustedHeaderName] = ($currentXForwardedFor ? $currentXForwardedFor.', ' : '').$request->getClientIp(); |
|  |  | } |
|  |  | } catch (\InvalidArgumentException $e) { |
|  |  | // Do nothing |
|  |  | } |
|  |  |  |
|  |  | $server['REMOTE\_ADDR'] = $this->resolveTrustedProxy(); |
|  |  |  |
|  |  | unset($server['HTTP\_IF\_MODIFIED\_SINCE']); |
|  |  | unset($server['HTTP\_IF\_NONE\_MATCH']); |
|  |  |  |
| Expand All | | @@ -139,17 +125,6 @@ protected function createSubRequest($uri, Request $request) |
|  |  | return $subRequest; |
|  |  | } |
|  |  |  |
|  |  | private function resolveTrustedProxy() |
|  |  | { |
|  |  | if (!$trustedProxies = Request::getTrustedProxies()) { |
|  |  | return '127.0.0.1'; |
|  |  | } |
|  |  |  |
|  |  | $firstTrustedProxy = reset($trustedProxies); |
|  |  |  |
|  |  | return false !== ($i = strpos($firstTrustedProxy, '/')) ? substr($firstTrustedProxy, 0, $i) : $firstTrustedProxy; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* {@inheritdoc} |
|  |  | \*/ |
| Expand Down | |  |

21 changes: 1 addition & 20 deletions

21
[src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php](#diff-52acfde1fc8edad0d27239560fe7a544c35907dacd30e7551c73ba338065f5ae "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -468,27 +468,8 @@ protected function forward(Request $request, $catch = false, Response $entry = n |
|  |  | $this->surrogate->addSurrogateCapability($request); |
|  |  | } |
|  |  |  |
|  |  | // modify the X-Forwarded-For header if needed |
|  |  | $forwardedFor = $request->headers->get('X-Forwarded-For'); |
|  |  | if ($forwardedFor) { |
|  |  | $request->headers->set('X-Forwarded-For', $forwardedFor.', '.$request->server->get('REMOTE\_ADDR')); |
|  |  | } else { |
|  |  | $request->headers->set('X-Forwarded-For', $request->server->get('REMOTE\_ADDR')); |
|  |  | } |
|  |  |  |
|  |  | // fix the client IP address by setting it to 127.0.0.1 as HttpCache |
|  |  | // is always called from the same process as the backend. |
|  |  | $request->server->set('REMOTE\_ADDR', '127.0.0.1'); |
|  |  |  |
|  |  | // make sure HttpCache is a trusted proxy |
|  |  | if (!\in\_array('127.0.0.1', $trustedProxies = Request::getTrustedProxies())) { |
|  |  | $trustedProxies[] = '127.0.0.1'; |
|  |  | Request::setTrustedProxies($trustedProxies); |
|  |  | } |
|  |  |  |
|  |  | // always a "master" request (as the real master request can be in cache) |
|  |  | $response = $this->kernel->handle($request, HttpKernelInterface::MASTER\_REQUEST, $catch); |
|  |  | // FIXME: we probably need to also catch exceptions if raw === true |
|  |  | $response = SubRequestHandler::handle($this->kernel, $request, HttpKernelInterface::MASTER\_REQUEST, $catch); |
|  |  |  |
|  |  | // we don't implement the stale-if-error on Requests, which is nonetheless part of the RFC |
|  |  | if (null !== $entry && \in\_array($response->getStatusCode(), array(500, 502, 503, 504))) { |
| Expand Down | |  |

100 changes: 100 additions & 0 deletions

100
[src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php](#diff-7d4dc5cf0a613f43baeca47d6206dc08040b6e8c376b69eebead679f9642d7aa "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,100 @@ |
|  |  | <?php |
|  |  |  |
|  |  | /\* |
|  |  | \* This file is part of the Symfony package. |
|  |  | \* |
|  |  | \* (c) Fabien Potencier <fabien@symfony.com> |
|  |  | \* |
|  |  | \* For the full copyright and license information, please view the LICENSE |
|  |  | \* file that was distributed with this source code. |
|  |  | \*/ |
|  |  |  |
|  |  | namespace Symfony\Component\HttpKernel\HttpCache; |
|  |  |  |
|  |  | use Symfony\Component\HttpFoundation\IpUtils; |
|  |  | use Symfony\Component\HttpFoundation\Request; |
|  |  | use Symfony\Component\HttpFoundation\Response; |
|  |  | use Symfony\Component\HttpKernel\HttpKernelInterface; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @author Nicolas Grekas <p@tchwork.com> |
|  |  | \* |
|  |  | \* @internal |
|  |  | \*/ |
|  |  | class SubRequestHandler |
|  |  | { |
|  |  | /\*\* |
|  |  | \* @return Response |
|  |  | \*/ |
|  |  | public static function handle(HttpKernelInterface $kernel, Request $request, $type, $catch) |
|  |  | { |
|  |  | // save global state related to trusted headers and proxies |
|  |  | $trustedProxies = Request::getTrustedProxies(); |
|  |  | $trustedHeaders = array( |
|  |  | Request::HEADER\_FORWARDED => Request::getTrustedHeaderName(Request::HEADER\_FORWARDED), |
|  |  | Request::HEADER\_CLIENT\_IP => Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP), |
|  |  | Request::HEADER\_CLIENT\_HOST => Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_HOST), |
|  |  | Request::HEADER\_CLIENT\_PROTO => Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_PROTO), |
|  |  | Request::HEADER\_CLIENT\_PORT => Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_PORT), |
|  |  | ); |
|  |  |  |
|  |  | // remove untrusted values |
|  |  | $remoteAddr = $request->server->get('REMOTE\_ADDR'); |
|  |  | if (!IpUtils::checkIp($remoteAddr, $trustedProxies)) { |
|  |  | foreach (array\_filter($trustedHeaders) as $name) { |
|  |  | $request->headers->remove($name); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // compute trusted values, taking any trusted proxies into account |
|  |  | $trustedIps = array(); |
|  |  | $trustedValues = array(); |
|  |  | foreach (array\_reverse($request->getClientIps()) as $ip) { |
|  |  | $trustedIps[] = $ip; |
|  |  | $trustedValues[] = sprintf('for="%s"', $ip); |
|  |  | } |
|  |  | if ($ip !== $remoteAddr) { |
|  |  | $trustedIps[] = $remoteAddr; |
|  |  | $trustedValues[] = sprintf('for="%s"', $remoteAddr); |
|  |  | } |
|  |  |  |
|  |  | // set trusted values, reusing as much as possible the global trusted settings |
|  |  | if ($name = $trustedHeaders[Request::HEADER\_FORWARDED]) { |
|  |  | $trustedValues[0] .= sprintf(';host="%s";proto=%s', $request->getHttpHost(), $request->getScheme()); |
|  |  | $request->headers->set($name, implode(', ', $trustedValues)); |
|  |  | } |
|  |  | if ($name = $trustedHeaders[Request::HEADER\_CLIENT\_IP]) { |
|  |  | $request->headers->set($name, implode(', ', $trustedIps)); |
|  |  | } |
|  |  | if (!$name && !$trustedHeaders[Request::HEADER\_FORWARDED]) { |
|  |  | $request->headers->set('X-Forwarded-For', implode(', ', $trustedIps)); |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_CLIENT\_IP, 'X\_FORWARDED\_FOR'); |
|  |  | } |
|  |  |  |
|  |  | // fix the client IP address by setting it to 127.0.0.1, |
|  |  | // which is the core responsibility of this method |
|  |  | $request->server->set('REMOTE\_ADDR', '127.0.0.1'); |
|  |  |  |
|  |  | // ensure 127.0.0.1 is set as trusted proxy |
|  |  | if (!IpUtils::checkIp('127.0.0.1', $trustedProxies)) { |
|  |  | Request::setTrustedProxies(array\_merge($trustedProxies, array('127.0.0.1'))); |
|  |  | } |
|  |  |  |
|  |  | try { |
|  |  | $e = null; |
|  |  | $response = $kernel->handle($request, $type, $catch); |
|  |  | } catch (\Throwable $e) { |
|  |  | } catch (\Exception $e) { |
|  |  | } |
|  |  |  |
|  |  | // restore global state |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_CLIENT\_IP, $trustedHeaders[Request::HEADER\_CLIENT\_IP]); |
|  |  | Request::setTrustedProxies($trustedProxies); |
|  |  |  |
|  |  | if (null !== $e) { |
|  |  | throw $e; |
|  |  | } |
|  |  |  |
|  |  | return $response; |
|  |  | } |
|  |  | } |

38 changes: 20 additions & 18 deletions

38
[src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php](#diff-36ed5d4880a321363807f5de73b775d6b15065391dfe8fbaac3ddb6eca41a5d6 "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,12 +26,16 @@ class InlineFragmentRendererTest extends TestCase |
|  |  |  |
|  |  | protected function setUp() |
|  |  | { |
|  |  | $this->originalTrustedHeaderName = Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP); |
|  |  | $this->originalTrustedHeaderNames = array( |
|  |  | Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP), |
|  |  | Request::getTrustedHeaderName(Request::HEADER\_FORWARDED), |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | protected function tearDown() |
|  |  | { |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_CLIENT\_IP, $this->originalTrustedHeaderName); |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_CLIENT\_IP, $this->originalTrustedHeaderNames[0]); |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_FORWARDED, $this->originalTrustedHeaderNames[1]); |
|  |  | } |
|  |  |  |
|  |  | public function testRender() |
| Expand All | | @@ -55,7 +59,7 @@ public function testRenderWithObjectsAsAttributes() |
|  |  | $subRequest = Request::create('/\_fragment?\_path=\_format%3Dhtml%26\_locale%3Den%26\_controller%3Dmain\_controller'); |
|  |  | $subRequest->attributes->replace(array('object' => $object, '\_format' => 'html', '\_controller' => 'main\_controller', '\_locale' => 'en')); |
|  |  | $subRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $subRequest->server->set('HTTP\_X\_FORWARDED\_FOR', '127.0.0.1'); |
|  |  | $subRequest->headers->set('forwarded', array('for="127.0.0.1";host="localhost";proto=http')); |
|  |  |  |
|  |  | $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($subRequest)); |
|  |  |  |
| Expand Down  Expand Up | | @@ -83,8 +87,12 @@ public function testRenderWithObjectsAsAttributesPassedAsObjectsInTheController( |
|  |  | public function testRenderWithTrustedHeaderDisabled() |
|  |  | { |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_CLIENT\_IP, ''); |
|  |  | Request::setTrustedHeaderName(Request::HEADER\_FORWARDED, ''); |
|  |  |  |
|  |  | $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest(Request::create('/'))); |
|  |  | $expectedSubRequest = Request::create('/'); |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  |  |
|  |  | $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest)); |
|  |  | $this->assertSame('foo', $strategy->render('/', Request::create('/'))->getContent()); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -168,11 +176,10 @@ public function testESIHeaderIsKeptInSubrequest() |
|  |  | { |
|  |  | $expectedSubRequest = Request::create('/'); |
|  |  | $expectedSubRequest->headers->set('Surrogate-Capability', 'abc="ESI/1.0"'); |
|  |  |  |
|  |  | if (Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP)) { |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->server->set('HTTP\_X\_FORWARDED\_FOR', '127.0.0.1'); |
|  |  | } |
|  |  | $expectedSubRequest->headers->set('forwarded', array('for="127.0.0.1";host="localhost";proto=http')); |
|  |  |  |
|  |  | $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest)); |
|  |  |  |
| Expand All | | @@ -194,10 +201,8 @@ public function testESIHeaderIsKeptInSubrequestWithTrustedHeaderDisabled() |
|  |  | public function testHeadersPossiblyResultingIn304AreNotAssignedToSubrequest() |
|  |  | { |
|  |  | $expectedSubRequest = Request::create('/'); |
|  |  | if (Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP)) { |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->server->set('HTTP\_X\_FORWARDED\_FOR', '127.0.0.1'); |
|  |  | } |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->headers->set('forwarded', array('for="127.0.0.1";host="localhost";proto=http')); |
|  |  |  |
|  |  | $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest)); |
|  |  | $request = Request::create('/', 'GET', array(), array(), array(), array('HTTP\_IF\_MODIFIED\_SINCE' => 'Fri, 01 Jan 2016 00:00:00 GMT', 'HTTP\_IF\_NONE\_MATCH' => '\*')); |
| Expand All | | @@ -208,12 +213,9 @@ public function testFirstTrustedProxyIsSetAsRemote() |
|  |  | { |
|  |  | $expectedSubRequest = Request::create('/'); |
|  |  | $expectedSubRequest->headers->set('Surrogate-Capability', 'abc="ESI/1.0"'); |
|  |  | $expectedSubRequest->server->set('REMOTE\_ADDR', '1.1.1.1'); |
|  |  |  |
|  |  | if (Request::getTrustedHeaderName(Request::HEADER\_CLIENT\_IP)) { |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->server->set('HTTP\_X\_FORWARDED\_FOR', '127.0.0.1'); |
|  |  | } |
|  |  | $expectedSubRequest->server->set('REMOTE\_ADDR', '127.0.0.1'); |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->headers->set('forwarded', array('for="127.0.0.1";host="localhost";proto=http')); |
|  |  |  |
|  |  | Request::setTrustedProxies(array('1.1.1.1')); |
|  |  |  |
| Expand All | | @@ -230,9 +232,9 @@ public function testIpAddressOfRangedTrustedProxyIsSetAsRemote() |
|  |  | { |
|  |  | $expectedSubRequest = Request::create('/'); |
|  |  | $expectedSubRequest->headers->set('Surrogate-Capability', 'abc="ESI/1.0"'); |
|  |  | $expectedSubRequest->server->set('REMOTE\_ADDR', '1.1.1.1'); |
|  |  | $expectedSubRequest->server->set('REMOTE\_ADDR', '127.0.0.1'); |
|  |  | $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1')); |
|  |  | $expectedSubRequest->server->set('HTTP\_X\_FORWARDED\_FOR', '127.0.0.1'); |
|  |  | $expectedSubRequest->headers->set('forwarded', array('for="127.0.0.1";host="localhost";proto=http')); |
|  |  |  |
|  |  | Request::setTrustedProxies(array('1.1.1.1/24')); |
|  |  |  |
| Expand Down | |  |

54 changes: 30 additions & 24 deletions

54
[src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php](#diff-e9f458bde9b527e37c5c5ad184619f7af3fe06c2a74b00bd56e38cbf3d99c73d "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php")

Show comments

[View file](/symfony/symfony/blob/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a/src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1303,66 +1303,72 @@ public function testClientIpIsAlwaysLocalhostForForwardedRequests() |
|  |  | $this->setNextResponse(); |
|  |  | $this->request('GET', '/', array('REMOTE\_ADDR' => '10.0.0.1')); |
|  |  |  |
|  |  | $this->assertEquals('127.0.0.1', $this->kernel->getBackendRequest()->server->get('REMOTE\_ADDR')); |
|  |  | $that = $this; |
|  |  | $this->kernel->assert(function ($backendRequest) use ($that) { |
|  |  | $that->assertSame('127.0.0.1', $backendRequest->server->get('REMOTE\_ADDR')); |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @dataProvider getTrustedProxyData |
|  |  | \*/ |
|  |  | public function testHttpCacheIsSetAsATrustedProxy(array $existing, array $expected) |
|  |  | public function testHttpCacheIsSetAsATrustedProxy(array $existing) |
|  |  | { |
|  |  | Request::setTrustedProxies($existing); |
|  |  |  |
|  |  | $this->setNextResponse(); |
|  |  | $this->request('GET', '/', array('REMOTE\_ADDR' => '10.0.0.1')); |
|  |  | $this->assertSame($existing, Request::getTrustedProxies()); |
|  |  |  |
|  |  | $this->assertEquals($expected, Request::getTrustedProxies()); |
|  |  | $that = $this; |
|  |  | $existing = array\_unique(array\_merge($existing, array('127.0.0.1'))); |
|  |  | $this->kernel->assert(function ($backendRequest) use ($existing, $that) { |
|  |  | $that->assertSame($existing, Request::getTrustedProxies()); |
|  |  | $that->assertsame('10.0.0.1', $backendRequest->getClientIp()); |
|  |  | }); |
|  |  |  |
|  |  | Request::setTrustedProxies(array()); |
|  |  | } |
|  |  |  |
|  |  | public function getTrustedProxyData() |
|  |  | { |
|  |  | return array( |
|  |  | array(array(), array('127.0.0.1')), |
|  |  | array(array('10.0.0.2'), array('10.0.0.2', '127.0.0.1')), |
|  |  | array(array('10.0.0.2', '127.0.0.1'), array('10.0.0.2', '127.0.0.1')), |
|  |  | array(array()), |
|  |  | array(array('10.0.0.2')), |
|  |  | array(array('10.0.0.2', '127.0.0.1')), |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @dataProvider getXForwardedForData |
|  |  | \* @dataProvider getForwardedData |
|  |  | \*/ |
|  |  | public function testXForwarderForHeaderForForwardedRequests($xForwardedFor, $expected) |
|  |  | public function testForwarderHeaderForForwardedRequests($forwarded, $expected) |
|  |  | { |
|  |  | $this->setNextResponse(); |
|  |  | $server = array('REMOTE\_ADDR' => '10.0.0.1'); |
|  |  | if (false !== $xForwardedFor) { |
|  |  | $server['HTTP\_X\_FORWARDED\_FOR'] = $xForwardedFor; |
|  |  | if (null !== $forwarded) { |
|  |  | Request::setTrustedProxies($server); |
|  |  | $server['HTTP\_FORWARDED'] = $forwarded; |
|  |  | } |
|  |  | $this->request('GET', '/', $server); |
|  |  |  |
|  |  | $this->assertEquals($expected, $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For')); |
|  |  | $that = $this; |
|  |  | $this->kernel->assert(function ($backendRequest) use ($expected, $that) { |
|  |  | $that->assertSame($expected, $backendRequest->headers->get('Forwarded')); |
|  |  | }); |
|  |  |  |
|  |  | Request::setTrustedProxies(array()); |
|  |  | } |
|  |  |  |
|  |  | public function getXForwardedForData() |
|  |  | public function getForwardedData() |
|  |  | { |
|  |  | return array( |
|  |  | array(false, '10.0.0.1'), |
|  |  | array('10.0.0.2', '10.0.0.2, 10.0.0.1'), |
|  |  | array('10.0.0.2, 10.0.0.3', '10.0.0.2, 10.0.0.3, 10.0.0.1'), |
|  |  | array(null, 'for="10.0.0.1";host="localhost";proto=http'), |
|  |  | array('for=10.0.0.2', 'for="10.0.0.2";host="localhost";proto=http, for="10.0.0.1"'), |
|  |  | array('for=10.0.0.2, for=10.0.0.3', 'for="10.0.0.2";host="localhost";proto=http, for="10.0.0.3", for="10.0.0.1"'), |
|  |  | ); |
|  |  | } |
|  |  |  |
|  |  | public function testXForwarderForHeaderForPassRequests() |
|  |  | { |
|  |  | $this->setNextResponse(); |
|  |  | $server = array('REMOTE\_ADDR' => '10.0.0.1'); |
|  |  | $this->request('POST', '/', $server); |
|  |  |  |
|  |  | $this->assertEquals('10.0.0.1', $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For')); |
|  |  | } |
|  |  |  |
|  |  | public function testEsiCacheRemoveValidationHeadersIfEmbeddedResponses() |
|  |  | { |
|  |  | $time = \DateTime::createFromFormat('U', time()); |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `725dee4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsymfony%2Fsymfony%2Fcommit%2F725dee4cd8b4ccd52e335ae4b4522242cea9bd4a) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


