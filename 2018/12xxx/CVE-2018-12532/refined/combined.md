=== Content from seclists.org_29f3d820_20250125_010956.html ===

[![](/shared/images/nst-icons.svg#menu)](#menu)
![](/shared/images/nst-icons.svg#close)
[![Home page logo](/images/sitelogo.png)](/)
[Nmap.org](https://nmap.org/)
[Npcap.com](https://npcap.com/)
[Seclists.org](https://seclists.org/)
[Sectools.org](https://sectools.org)
[Insecure.org](https://insecure.org/)

![](/shared/images/nst-icons.svg#search)

[![fulldisclosure logo](/images/fulldisclosure-logo.png)](/fulldisclosure/)
## [Full Disclosure](/fulldisclosure/) mailing list archives

[![Previous](/images/left-icon-16x16.png)](20)
[By Date](date.html#21)
[![Next](/images/right-icon-16x16.png)](22)

[![Previous](/images/left-icon-16x16.png)](20)
[By Thread](index.html#21)
[![Next](/images/right-icon-16x16.png)](24)

![](/shared/images/nst-icons.svg#search)

# RichFaces exploitation toolkit

---

*From*: Red Timmy Security <publications () redtimmy com>

*Date*: Fri, 13 Mar 2020 21:29:47 +0100

---

```

Hi,

```
The RichFaces library has been vulnerable to many Java deserialization
and EL injection vulnerabilities. This infamous library is included with
many JSF web applications for providing advanced UI elements beyond the
(very limited) set that is built-in with the framework. Therefore, many
websites using JSF are vulnerable to exploitation.
```

```
Until now, the vulnerabilities had to be exploited manually. Richsploit
is a toolkit that can exploit multiple versions of RichFaces:
```

RichFaces 3
3.1.0 ≤ 3.3.3   CVE-2013-2165
3.1.0 ≤ 3.3.4   CVE-2018-12533
3.1.0 ≤ 3.3.4   CVE-2018-14667
RichFaces 4
4.0.0 ≤ 4.3.2   CVE-2013-2165
4.0.0 ≤ 4.5.4   CVE-2015-0279
4.5.3 ≤ 4.5.17  CVE-2018-12532

```
For more information, please read our blog post at:
<https://www.redtimmy.com/java-hacking/richsploit-one-tool-to-exploit-all-versions-of-richfaces-ever-released/>
```

```
The tool can be downloaded from GitHub:
<https://github.com/redtimmy/Richsploit>
```

Regards,
Red Timmy Security

_______________________________________________
Sent through the Full Disclosure mailing list
<https://nmap.org/mailman/listinfo/fulldisclosure>
Web Archives & RSS: <http://seclists.org/fulldisclosure/>
```

---

[![Previous](/images/left-icon-16x16.png)](20)
[By Date](date.html#21)
[![Next](/images/right-icon-16x16.png)](22)

[![Previous](/images/left-icon-16x16.png)](20)
[By Thread](index.html#21)
[![Next](/images/right-icon-16x16.png)](24)

### Current thread:

* **RichFaces exploitation toolkit** *Red Timmy Security (Mar 13)*
  + [Oce Colorwave 500 printer - multiple vulnerabilities](24) *Red Timmy Security (Mar 20)*

![](/shared/images/nst-icons.svg#search)

## [Nmap Security Scanner](https://nmap.org/)

* [Ref Guide](https://nmap.org/book/man.html)* [Install Guide](https://nmap.org/book/install.html)* [Docs](https://nmap.org/docs.html)* [Download](https://nmap.org/download.html)* [Nmap OEM](https://nmap.org/oem/)

## [Npcap packet capture](https://npcap.com/)

* [User's Guide](https://npcap.com/guide/)* [API docs](https://npcap.com/guide/npcap-devguide.html#npcap-api)* [Download](https://npcap.com/#download)* [Npcap OEM](https://npcap.com/oem/)

## [Security Lists](https://seclists.org/)

* [Nmap Announce](https://seclists.org/nmap-announce/)* [Nmap Dev](https://seclists.org/nmap-dev/)* [Full Disclosure](https://seclists.org/fulldisclosure/)* [Open Source Security](https://seclists.org/oss-sec/)* [BreachExchange](https://seclists.org/dataloss/)

## [Security Tools](https://sectools.org)

* [Vuln scanners](https://sectools.org/tag/vuln-scanners/)* [Password audit](https://sectools.org/tag/pass-audit/)* [Web scanners](https://sectools.org/tag/web-scanners/)* [Wireless](https://sectools.org/tag/wireless/)* [Exploitation](https://sectools.org/tag/sploits/)

## [About](https://insecure.org/)

* [About/Contact](https://insecure.org/fyodor/)* [Privacy](https://insecure.org/privacy.html)* [Advertising](https://insecure.org/advertising.html)* [Nmap Public Source License](https://nmap.org/npsl/)

[![](/shared/images/nst-icons.svg#twitter)](https://twitter.com/nmap "Visit us on Twitter")
[![](/shared/images/nst-icons.svg#facebook)](https://facebook.com/nmap "Visit us on Facebook")
[![](/shared/images/nst-icons.svg#github)](https://github.com/nmap/ "Visit us on Github")
[![](/shared/images/nst-icons.svg#reddit)](https://reddit.com/r/nmap/ "Discuss Nmap on Reddit")



=== Content from codewhitesec.blogspot.com_7f03f608_20250125_010957.html ===


[![CODE WHITE | Blog](https://blogger.googleusercontent.com/img/a/AVvXsEj5Uf8yLEGkRscTa_5sbFc8tc_A_Eo5dEcBTvonsinlrYzMYlSpayK3n1OE1GSux75yfyPLenZc8u_lD3LP9kI5nHmiQ8LtF_sqKP0E4oQDtM2rSsiDUmJV2m6YTAkE6IUHV5SGErA75184WJsMoyH_x132VzImyblphcfcAULW6E5RO44Z5uWsBDO8q2k=s752)](https://codewhitesec.blogspot.com/)

## May 30, 2018

### Poor RichFaces

RichFaces is one of the most popular component libraries for JavaServer Faces (JSF). In the past, two vulnerabilities (CVE-2013-2165 and CVE-2015-0279) have been found that allow RCE in versions 3.x ≤ 3.3.3 and 4.x ≤ 4.5.3. Code White discovered two new vulnerabilities which bypass the implemented mitigations. Thereby, all RichFaces versions including the latest 3.3.4 and 4.5.17 are vulnerable to RCE.

## Introduction

JavaServer Faces (JSF) is a framework for building user interfaces for web applications. While there are only two major JSF implementations (i. e., Apache MyFaces and Oracle Mojarra), there are several component libraries, which provide additional UI components and features. RichFaces is one of the most popular libraries among these component libraries and since it became part of JBoss (and thereby also part of Red Hat), it is also part of several JBoss/Red Hat products, for example JBoss EAP and JBoss Portal.[[1]](#footnote-1)

RichFaces has three major version branches: 3.x, 4.x, and 5.x. However, as 5.x has never left alpha state, it is rather irrelevant. In early 2016, the [developers of RichFaces announced the end-of-life of RichFaces in June 2016](https://developer.jboss.org/people/michpetrov/blog/2016/02/12/the-future-of-richfaces). The latest releases of the respective branches are 3.3.4 and 4.5.17.

## The Past

In the past, two significant vulnerabilities have been discovered by Takeshi Terada of MBSD, which both affect various RichFaces versions:

CVE-2013-2165: Arbitrary Java Deserialization in RichFaces 3.x ≤ 3.3.3 and 4.x ≤ 4.3.2
Deserialization of arbitrary Java serialized object streams in *org.ajax4jsf.resource.ResourceBuilderImpl* allows remote code execution.
CVE-2015-0279: Arbitrary EL Evaluation in RichFaces 4.x ≤ 4.5.3 ([RF-13977](https://issues.jboss.org/browse/RF-13977))
Injection of arbitrary EL method expressions in *org.richfaces.resource.MediaOutputResource* allows remote code execution.

Both vulnerabilities rely on the feature to generate images, video, sounds, and other resources on the fly based on data provided in the request. The provided data is either interpreted as a plain array of bytes or as a Java serialized object stream. In RichFaces 3.x, the data gets appended to the URL path preceded by either `/DATB/` (byte array) or `/DATA/` (Java serialized object stream); in RichFaces 4.x, the data is transmitted in a request parameter named `db` (byte array) or `do` (Java serialized object stream). In all cases, the binary data is compressed using DEFLATE and then encoded using a URL-safe Base64 encoding.

### CVE-2013-2165: Arbitrary Java Deserialization

This vulnerability is a straight forward Java deserialization vulnerability. When a RichFaces 3.x resource is requested, it eventually gets processed by [`ResourceBuilderImpl.getResourceDataForKey(String)`](http://grepcode.com/file/repository.jboss.org/nexus/content/repositories/releases/org.richfaces.framework/richfaces-impl/3.3.4.Final/org/ajax4jsf/resource/ResourceBuilderImpl.java#ResourceBuilderImpl.getResourceDataForKey%28java.lang.String%29). If the requested resource key begins with `/DATA/`, the remaining data gets decoded and decompressed (using [`ResourceBuilderImpl.decrypt(byte[])`](http://grepcode.com/file/repository.jboss.org/nexus/content/repositories/releases/org.richfaces.framework/richfaces-impl/3.3.4.Final/org/ajax4jsf/resource/ResourceBuilderImpl.java#ResourceBuilderImpl.decrypt%28byte%5B%5D%29), which actually, despite its name, does not incorporate encryption[[2]](#footnote-2)) and finally deserialized without any further validation.

In RichFaces 4.x, it is basically the same: the *org.richfaces.resource.DefaultCodecResourceRequestData* holds the request data passed via `db`/`do` and [`Util.decodeObjectData(String)`](https://github.com/richfaces4/core/blob/4.3.2.20130513-Final/impl/src/main/java/org/richfaces/util/Util.java#L232-L248) is used in the latter case. That method then decodes and decompresses the data in a similar way and finally deserializes it without any further validation.

This can be exploited with [*ysoserial*](https://github.com/frohoff/ysoserial) using a suitable gadget.

The arbitrary Java deserialization was patched in RichFaces 3.3.4 and 4.3.3 by introducing look-ahead deserialization with a limited set of whitelisted classes.[[3]](#footnote-3) Due to several aftereffects, the list was extended occasionally.[[4]](#footnote-4)

### CVE-2015-0279: Arbitrary EL Evaluation

The RichFaces issue [RF-13977](https://issues.jboss.org/browse/RF-13977) corresponding to this vulnerability is public and actually quite detailed. It describes that the RichFaces Showcase application utilizes the *MediaOutputResource* dynamic resource builder. The data object passed in the `do` URL parameter holds the state object, which is used by [`MediaOutputResource.restoreState(FacesContext, Object)`](https://github.com/richfaces/richfaces/blob/4.5.3.Final/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java#L86-L94) to restore its state. This includes the *contentProducer* field, which is expected to be a *MethodExpression* object. That *MethodExpression* later gets invoked by [`MediaOutputResource.encode(FacesContext)`](https://github.com/richfaces/richfaces/blob/4.5.3.Final/components/a4j/src/main/java/org/richfaces/resource/MediaOutputResource.java#L60-L63) to pass execution to the referenced method to generate the resource's contents. In the mentioned example, the EL method expression `#{mediaBean.process}` references the [*process* method of a Java Bean named *mediaBean*](https://github.com/richfaces/richfaces/blob/4.5.3.Final/examples/showcase/src/main/java/org/richfaces/demo/mediaOutput/MediaBean.java#L457-L479).

Now the problem with that is that the EL expression can be changed, even just with basic Linux utilities. There is no protection in place that would prevent one from tampering with it. Depending on the EL implementation, this allows arbitrary code execution, as demonstrated by the reporter:

However, exploitation of this vulnerability is not always that easy. Especially if there is no existing sample of a valid `do` state object that can be tampered with. Because if one would want to create the state object, it would require the use of compatible libraries, otherwise the deserialization may fail. Moreover, the EL implementation does not allow arbitrary expressions with parameterized invocations in method expressions as this has only just been added in EL 2.2. EL exploitation is quite an interesting topic in itself.

The [patch for this issue introduced in RichFaces 4.5.4](https://github.com/richfaces/richfaces/commit/4c5ddae4d6ddcea591fa949762c1c79ac11cac99) was to check the expression of the *contentProducer* whether it contains a parenthesis. This would prevent the invocation of methods with parameters like `loadClass("java.lang.Runtime")`.

## The Present

The kind of the past vulnerabilities led to the assumption that there may be a way to bypass the mitigations. And after some research, two ways were found to gain remote code execution in a similar manner also affecting the latest RichFaces versions 3.3.4 and 4.5.17:

RF-14310: Arbitrary EL Evaluation in RichFaces 3.x ≤ 3.3.4
Injection of arbitrary EL expressions allows remote code execution via *org.richfaces.renderkit.html.Paint2DResource*.
RF-14309: Arbitrary EL Evaluation in RichFaces 4.5.3 ≤ 4.5.17
Injection of arbitrary EL variable mapper allows to bypass mitigation of CVE-2015-0279 and thereby remote code execution.

Although the issues RF-14309 and RF-14310 were discovered in the order of their identifier, we'll explain them in the opposite order. Also note that the issues are not public but only visible to persons responsible to resolve security issues.

### RF-14310: Arbitrary EL Evaluation

This vulnerability is very similar to CVE-2015-0279/RF-13799. While the injection of arbitrary EL expressions was possible right from the beginning, there is always a need to get them triggered somehow. This similarity was found in the [org.richfaces.renderkit.html.Paint2DResource](http://www.grepcode.com/file/repository.jboss.org/nexus/content/repositories/releases/org.richfaces.ui/richfaces-ui/3.3.4.Final/org/richfaces/renderkit/html/Paint2DResource.java/) class. When a resource of that type gets requested, its `send(ResourceContext)` method gets called. The resource data transmitted in the request must be an *org.richfaces.renderkit.html.Paint2DResource$ImageData* object. This passes the whitelisting as *ImageData* extends *org.ajax4jsf.resource.SerializableResource*, which actually was introduced in 3.3.4 to fix the Java deserialization vulnerability.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjQcgiDcrzcRT_AEX2hz_y0mV7FZinaFo8bHiG9uSVpp7_RXobnW4HkmmXLuqHFnXU3S9YMiqlbRrVeMP404Ssimn3IWNyexIH3nExXi0iTkM4O-jcn8vrss7ZyJl5pmR0MaDxz5CTBG-8/s640/Selection_2018-05-30_02.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjQcgiDcrzcRT_AEX2hz_y0mV7FZinaFo8bHiG9uSVpp7_RXobnW4HkmmXLuqHFnXU3S9YMiqlbRrVeMP404Ssimn3IWNyexIH3nExXi0iTkM4O-jcn8vrss7ZyJl5pmR0MaDxz5CTBG-8/s1600/Selection_2018-05-30_02.png)
### RF-14309: Arbitrary EL Evaluation

As the patch to CVE-2015-0279 introduced in 4.5.4 disallowed the use of parenthesis in the EL method expression of the *contentProducer*, it seemed like a dead end. But if you are fimilar with EL internals, you would know that they can have custom function mappers and variable mappers, which are used by the *ELResolver* to resolve functions (i. e., *name* in `${prefix:name()}`) and variables (i. e., *var* in `${var.property}`) to *Method* and *ValueExpression* instances respectively. Fortunately, various *VariableMapper* implementations were added to the whitelist starting with 4.5.3.[[5]](#footnotemark-5)

So to exploit this, all that is needed is to use a variable in the *contentProducer* method expression like `${dummy.toString}` and add an appropriate *VariableMapper* to the method expression that maps `dummy` to a *ValueExpression* of your choice.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGv6N3nHKe8W2U13xIphuPImdvQcz4ctOYfjmdVtuqJnmi_55RwChazepeOW7yp6rthIzqx87rJMqKaDIyRMb33_atHtX3I8o0iZfcoHuLqilYX4NiXggKzbG9q0dNBhiUNysK6i_d2q8/s640/Selection_2018-05-30_01.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhGv6N3nHKe8W2U13xIphuPImdvQcz4ctOYfjmdVtuqJnmi_55RwChazepeOW7yp6rthIzqx87rJMqKaDIyRMb33_atHtX3I8o0iZfcoHuLqilYX4NiXggKzbG9q0dNBhiUNysK6i_d2q8/s1600/Selection_2018-05-30_01.png)
## The Future

RichFaces has reached its end-of-life in June 2016 and their [RichFaces End-Of-Life Questions & Answers](https://developer.jboss.org/wiki/RichFacesEnd-Of-LifeQuestionsAnswers) is pretty clear on the time thereafter:

> **What will happen if a serious bug or security issue is discovered in the future?**
>
> There will be no patches after the end of support. In case of discovering a serious issue you will have to develop a patch yourself or switch to another framework.
>
> – [RichFaces End-Of-Life Questions & Answers](https://developer.jboss.org/wiki/RichFacesEnd-Of-LifeQuestionsAnswers)

So we can't expect official patches.

## The Bonus

While looking for ways to exploit the recent versions of RichFaces, there were two classes in the JSF API 2.0 and later, which seemed promising:

* [*javax.faces.component.ValueBindingValueExpressionAdapter*](http://www.grepcode.com/file/repo1.maven.org/maven2/javax.faces/jsf-api/2.0/javax/faces/component/ValueBindingValueExpressionAdapter.java)
* [*javax.faces.component.ValueExpressionValueBindingAdapter*](http://www.grepcode.com/file/repo1.maven.org/maven2/javax.faces/jsf-api/2.0/javax/faces/component/ValueExpressionValueBindingAdapter.java)

The interesting thing about these classes is that they have a `equals(Object)` method, which eventually calls `getType(ELContext)` on a EL value expression. For example, if [`equals(Object)` gets called on a *ValueExpressionValueBindingAdapter* object](http://www.grepcode.com/file/repo1.maven.org/maven2/javax.faces/jsf-api/2.0/javax/faces/component/ValueExpressionValueBindingAdapter.java#ValueExpressionValueBindingAdapter.equals%28java.lang.Object%29) with a *ValueExpression* object as `other`, `getType(ELContext)` of `other` gets called. And as the value expression has to be evaluated to determine its resulting type, this can be used as a Java deserialization primitive to execute EL value expressions on deserialization.

This is very similar to the *Myfaces1* and *Myfaces2* gadgets in *ysoserial*.[[6]](#footnotemark-6) However, while they require Apache MyFaces, this one is independent from the JSF implementation and only requires a matching EL implementation.

Unfortunately, this gadget does not work for RichFaces. The reason for that is that *ValueExpressionValueBindingAdapter* needs to have a valid value binding as `getType(ELContext)` gets called first. But *javax.faces.el.ValueBinding* is not whitelisted. And wrapping it in a *StateHolderSaver* does not work because the state object is of type *Object[]* and therefore the cast to *Serializable[]* in [`StateHolderSaver.restore(FacesContext)`](http://www.grepcode.com/file/repo1.maven.org/maven2/org.jboss.spec.javax.faces/jboss-jsf-api_2.1_spec/2.0.9.Final/javax/faces/component/StateHolderSaver.java#StateHolderSaver.restore%28javax.faces.context.FacesContext%29) fails.[[7]](#footnotemark-7) This is probably a bug in RichFaces as *Serializable[]* is not whitelisted either although *StateHolderSaver* uses *Serializable[]* internally on *StateHolder* instances.

## Conclusion

It has been shown that all RichFaces versions 3.x and 4.x including the latest 3.3.4 and 4.5.17 are exploitable by one or multiple vulnerabilities:

* RichFaces 3
  + 3.1.0 ≤ 3.3.3: CVE-2013-2165
  + 3.1.0 ≤ 3.3.4: RF-14310
* RichFaces 4
  + 4.0.0 ≤ 4.3.2: CVE-2013-2165
  + 4.0.0 ≤ 4.5.4: CVE-2015-0279
  + 4.5.3 ≤ 4.5.17: RF-14309

As we can't expect official patches, one way to mitigate all these vulnerabilities is to block requests to the concerned URLs:

* Blocking requests of URLs with paths containing `/DATA/` should mitigate CVE-2013-2165 and RF-14310.
* Blocking requests of URLs with paths containing `org.richfaces.resource.MediaOutputResource` (literally or URL encoded) should mitigate CVE-2015-0279 and RF-14309.

---

* [1](#footnotemark-1) See [JBoss Enterprise Application Platform Component Details](https://access.redhat.com/articles/112673) and [Red Hat JBoss Portal Component Details](https://access.redhat.com/articles/119873) for further version information.
* [2](#footnotemark-2) However, [*org.ajax4jsf.util.base64.Codec*](ory.jboss.org/nexus/content/repositories/releases/org.richfaces.framework/richfaces-impl/3.3.4.Final/org/ajax4jsf/util/base64/Codec.java) does support DES encryption if a password is set.
* [3](#footnotemark-3) See [commit richfaces4/core@12ee116](https://github.com/richfaces4/core/commit/12ee1166f04806b3ba072d27f9a9b3b3feae2ec9)
* [4](#footnotemark-4) See the history of *org/richfaces/resource/resource-serialization.properties* in [4.x ≤ 4.3.x](https://github.com/richfaces4/core/commits/4.3.7.20140523-Final/impl/src/main/resources/org/richfaces/resource/resource-serialization.properties) and in [4.5.x](https://github.com/richfaces/richfaces/commits/4.5.17.Final/core/src/main/resources/org/richfaces/resource/resource-serialization.properties) for reference.
* [5](#footnotemark-5) *com.sun.el.lang.VariableMapperImpl* and *org.apache.el.lang.VariableMapperImpl* were added in 4.5.3, *org.jboss.el.lang.VariableMapperImpl* was added in 4.5.8; see also the [history of *org/richfaces/resource/resource-serialization.properties* in 4.5.x](https://github.com/richfaces/richfaces/commits/4.5.17.Final/core/src/main/resources/org/richfaces/resource/resource-serialization.properties)
* [6](#footnotemark-6) See [Myfaces1.java](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/Myfaces1.java) and [Myfaces2.java](https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/Myfaces2.java) in the [*ysoserial* repository on GitHub](https://github.com/frohoff/ysoserial).
* [7](#footnotemark-7) This actually depends on the JSF API implementation and version. For example, *org.jboss.spec.javax.faces/jboss-jsf-api\_2.1\_spec* and *org.glassfish/javax.faces* do have this unfortunate behavior in all versions while *com.sun.faces/jsf-api* added it in version 2.1.0.

Posted by

[Markus Wulftange](https://www.blogger.com/profile/14370068139467987062 "author profile")

at

[May 30, 2018](https://codewhitesec.blogspot.com/2018/05/poor-richfaces.html "permanent link")

[![](//img2.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=718041348982184937&postID=7992202036012226720&from=pencil "Edit Post")

Tags
[Gadget](https://codewhitesec.blogspot.com/search/label/Gadget),
[Vulnerability Details](https://codewhitesec.blogspot.com/search/label/Vulnerability%20Details)

[Newer Post](https://codewhitesec.blogspot.com/2018/06/cve-2018-0624.html "Newer Post")
[Older Post](https://codewhitesec.blogspot.com/2018/03/exploiting-adobe-coldfusion.html "Older Post")
[Home](https://codewhitesec.blogspot.com/)

| Further Links  * [Homepage](https://www.code-white.com) * [Twitter](https://twitter.com/codewhitesec) * [Xing](https://www.xing.com/companies/codewhitegmbh) * [LinkedIn](https://www.linkedin.com/company/code-white-gmbh) * [Privacy Policy](https://code-white.com/en/privacy/) * [Impressum](https://www.code-white.com/en/#contact) | Join Us [Career @ Code White](https://code-white.com/en/career/) | Blog Archive Blog Archive July (1) April (1) March (1) September (1) June (1) January (1) September (1) June (1) July (1) March (1) January (1) August (1) July (1) February (1) July (1) June (1) May (1) March (1) January (1) May (1) April (1) May (1) April (1) February (2) August (1) July (1) June (1) May (2) March (2) February (1) |
| --- | --- | --- |

2020 © Code White GmbH. Powered by [Blogger](https://www.blogger.com).


