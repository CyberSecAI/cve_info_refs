=== Content from bugzilla.mozilla.org_0420c40f_20250125_204308.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/522634)
* [XML](/show_bug.cgi?ctype=xml&id=522634)

Closed
[Bug 522634](/show_bug.cgi?id=522634)

Opened 15 years ago
Closed 15 years ago

# decodeURIComponent/decodeURI allows non-shortest form of 16 bits char on 4 bytes representation

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

decodeURIComponent/decodeURI allows non-shortest form of 16 bits char on 4 bytes representation

## Categories

### (Core :: XPCOM, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=XPCOM#XPCOM)

XPCOM
▾

Core :: XPCOM
This is the basis of our component technology; this covers the mozilla/xpcom source directory and includes the "repository". Unlikely a tester would be able to tell there was an XPCOM problem specifically.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=XPCOM&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=XPCOM&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=XPCOM)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86

Windows NT

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
DUPLICATE
of [bug 511859](/show_bug.cgi?id=511859 "VERIFIED FIXED - Utf8ToOneUcs4Char in jsstr.cpp ,overlong UTF-8 seqence detection problem.")

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

DUPLICATE

of

Mark as Duplicate

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sirdarckcat, Unassigned)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

*Unassigned*

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/de37b9dc788b0268d438591e085e4496?d=mm&size=40)  [sirdarckcat](/user_profile?user_id=284837)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/fcf93a5a624020bf2256443c69e08b51?d=mm&size=40)  [nika](/user_profile?user_id=534482)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

1 person

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

---

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Eduardo Vela N](/user_profile?user_id=284837)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=522634#c0)• 15 years ago |
|  | |

User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 GTB5
Build Identifier: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 GTB5
Firefox is supposed to consider the non-shortest form exception (<http://www.unicode.org/reports/tr36/#UTF-8_Exploit>), section 3.1 of the Unicode Technical Report #36 but apparently there's a flaw on it. This is specially problematic for the reasons that an overlong unicode sequence not taken into consideration may allow several types of filter bypasses.
The following non-shortest form for the char U+1000:
0xF0 0x81 0x80 0x80
is allowed, as well as the correct shortest form:
0xE1 0x80 0x80
Note that this problem is only present on the 4 bytes representation (0xE0 0x81 0x80 is correctly marked as U+FFFD)
Reproducible: Always
Steps to Reproduce:
1. alert(decodeURI("%F0%81%80%80")==decodeURI("%E1%80%80"))
2. alert(escape(decodeURI("%F0%81%80%80")))
Actual Results:
1. true
2. %u1000
Expected Results:
1. false
2. %uFFFD
Check:
<http://www.unicode.org/reports/tr36/#UTF-8_Exploit>

|  | [Masahiro YAMADA](/user_profile?user_id=250835) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=522634#c1)• 15 years ago |
|  | |

This is fixed by [bug 511859](/show_bug.cgi?id=511859 "VERIFIED FIXED - Utf8ToOneUcs4Char in jsstr.cpp ,overlong UTF-8 seqence detection problem.")Status: UNCONFIRMED → RESOLVEDClosed: 15 years agoResolution: --- → DUPLICATE

|  | [Nobody; OK to take it and work on it](/user_profile?user_id=1)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=522634#a351884564_1)• 4 years ago |

Component: String → XPCOM
You need to [log in](/show_bug.cgi?id=522634&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑



=== Content from bugzilla.mozilla.org_f691dcf6_20250125_204307.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/511859)
* [XML](/show_bug.cgi?ctype=xml&id=511859)

Closed
[Bug 511859](/show_bug.cgi?id=511859)

Opened 15 years ago
Closed 15 years ago

# Utf8ToOneUcs4Char in jsstr.cpp ,overlong UTF-8 seqence detection problem.

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Utf8ToOneUcs4Char in jsstr.cpp ,overlong UTF-8 seqence detection problem.

## Categories

### (Core :: JavaScript Engine, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Webcompat Priority | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| status1.9.2 | --- | [beta3-fixed](/buglist.cgi?f1=cf_status_192&o1=equals&v1=beta3-fixed) |
| status1.9.1 | --- | [wontfix](/buglist.cgi?f1=cf_status_191&o1=equals&v1=wontfix) |

|  | Tracking | Status |
| --- | --- | --- |
| status1.9.2 |  | beta3-fixed |
| relnote-firefox |  | --- |
| status1.9.1 |  | wontfix |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: masa141421356, Assigned: masa141421356)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/fffcf7bbfeb4e69ee917488cfc2a310d?d=mm&size=40)  [masa141421356](/user_profile?user_id=250835)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/fffcf7bbfeb4e69ee917488cfc2a310d?d=mm&size=40)  [masa141421356](/user_profile?user_id=250835)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

### ( [URL](http://mxr.mozilla.org/mozilla-central/source/js/src/jsstr.cpp#5132 "http://mxr.mozilla.org/mozilla-central/source/js/src/jsstr.cpp#5132") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[172699](/show_bug.cgi?id=172699 "VERIFIED FIXED - JS UTF-8 decoder accepts overlong sequences"), [505991](/show_bug.cgi?id=505991 "VERIFIED FIXED - Location bar should not decode precent encoded overlong UTF-8 sequence")

[514760](/show_bug.cgi?id=514760 "RESOLVED DUPLICATE - [ES3.1]decodeURI() should throw URIError for percent encoded overlong UTF-8 sequence")

Dependency [tree](/showdependencytree.cgi?id=511859&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=511859)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[518347](/show_bug.cgi?id=518347 "RESOLVED DUPLICATE - Remove support of 5byte and 6byte UTF-8 sequences in jsstr.cpp"), [522634](/show_bug.cgi?id=522634 "RESOLVED DUPLICATE - decodeURIComponent/decodeURI allows non-shortest form of 16 bits char on 4 bytes representation")

[514760](/show_bug.cgi?id=514760 "RESOLVED DUPLICATE - [ES3.1]decodeURI() should throw URIError for percent encoded overlong UTF-8 sequence")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[mxr.mozilla.org/mozilla-central/sourc...](http://mxr.mozilla.org/mozilla-central/source/js/src/jsstr.cpp#5132 "http://mxr.mozilla.org/mozilla-central/source/js/src/jsstr.cpp#5132")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Whiteboard: [sg:want?] fixed-in-tracemonkey)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

---

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:want?] fixed-in-tracemonkey

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [sayrer](/user_profile?user_id=180188) | [blocking1.9.2](#a3672535_180188 "15 years ago") | + |
| --- | --- | --- |
| [sayrer](/user_profile?user_id=180188) | blocking1.9.2 | + |
| --- | --- | --- |
| [bc](/user_profile?user_id=23402) | [in-testsuite](#c19 "15 years ago") | + |
| --- | --- | --- |
| [bc](/user_profile?user_id=23402) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files, 2 obsolete files)

| [testcase](/attachment.cgi?id=395816)  [15 years ago](#c0)  [Masahiro YAMADA](/user_profile?user_id=250835)   1.49 KB, text/html |  | [Details](/attachment.cgi?id=395816&action=edit) |
| --- | --- | --- |
| [fixed testcase](/attachment.cgi?id=395817)  [15 years ago](#c1)  [Masahiro YAMADA](/user_profile?user_id=250835)   1.52 KB, text/html |  | [Details](/attachment.cgi?id=395817&action=edit) |
| [PAtch rev.1.0](/attachment.cgi?id=395934)  [15 years ago](#c3)  [Masahiro YAMADA](/user_profile?user_id=250835)   772 bytes, patch |  | [Details](/attachment.cgi?id=395934&action=edit) | [Diff](/attachment.cgi?id=395934&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=395934) |
| [Patch rev.1.1](/attachment.cgi?id=403067)  [15 years ago](#c11)  [Masahiro YAMADA](/user_profile?user_id=250835)   5.31 KB, patch | Waldo : [review+](#a3583412_83595 "15 years ago") | [Details](/attachment.cgi?id=403067&action=edit) | [Diff](/attachment.cgi?id=403067&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=403067) |
| [Test](/attachment.cgi?id=404251)  [15 years ago](#c15)  [Masahiro YAMADA](/user_profile?user_id=250835)   5.05 KB, text/plain |  | [Details](/attachment.cgi?id=404251&action=edit) |
| [The test-fix I was going to check in, but the previous changes are better](/attachment.cgi?id=404323)  [15 years ago](#c16)  [Jeff Walden [:Waldo]](/user_profile?user_id=83595)   888 bytes, patch |  | [Details](/attachment.cgi?id=404323&action=edit) | [Diff](/attachment.cgi?id=404323&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=404323) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=511859#c0)• 15 years ago |
|  | |

Attached file
[testcase](attachment.cgi?id=395816) (obsolete)
— [Details](attachment.cgi?id=395816&action=edit)

see <http://mxr.mozilla.org/mozilla-central/source/js/src/jsstr.cpp#5132>
> /\* from Unicode 3.1, non-shortest form is illegal \*/
> static const uint32 minucs4Table[] = {
> 0x00000080, 0x00000800, 0x0001000, 0x0020000, 0x0400000
> };
It should be as following (three zeros are missing)
/\* from Unicode 3.1, non-shortest form is illegal \*/
static const uint32 minucs4Table[] = {
0x00000080, 0x00000800, 0x00010000, 0x00200000, 0x04000000
};

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=511859#c1)• 15 years ago |
|  | |

Attached file
[fixed testcase](attachment.cgi?id=395817)
— [Details](attachment.cgi?id=395817&action=edit)

[Attachment #395816](/attachment.cgi?id=395816&action=edit "testcase") -
Attachment is obsolete: true

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a1182_250835)• 15 years ago |

Blocks: [505991](/show_bug.cgi?id=505991 "VERIFIED FIXED - Location bar should not decode precent encoded overlong UTF-8 sequence")

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=511859#c2)• 15 years ago |
|  | |

For the record, ECMA-262 ed. 3 required that overlong sequences be accepted. ES5 changes to the now-standard position of forbidding overlong sequences.Whiteboard: [good first bug]

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=511859#c3)• 15 years ago |
|  | |

Attached patch

[PAtch rev.1.0](attachment.cgi?id=395934&action=diff) (obsolete)
— [Details](attachment.cgi?id=395934&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=395934)

Assignee: general → masa141421356Status: NEW → ASSIGNED

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a29933_250835)• 15 years ago |

[Attachment #395934](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") -
Flags: review?(jwalden+bmo)

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a29995_250835)• 15 years ago |

OS: Windows XP → AllHardware: x86 → All

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=511859#c4)• 15 years ago |
|  | |

"Rhino" does not have same problem (see also : [bug 173180](/show_bug.cgi?id=173180 "VERIFIED FIXED - Rhino UTF-8 decoder accepts overlong sequences")).

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=511859#c5)• 15 years ago |
|  | |

Comment on [attachment 395934](/attachment.cgi?id=395934 "PAtch rev.1.0") [[details]](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") [[diff]](/attachment.cgi?id=395934&action=diff "PAtch rev.1.0") [[review]](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=395934)
PAtch rev.1.0
>diff --git a/js/src/jsstr.cpp b/js/src/jsstr.cpp
>--- a/js/src/jsstr.cpp
>+++ b/js/src/jsstr.cpp
>@@ -5124,17 +5124,17 @@ js\_OneUcs4ToUtf8Char(uint8 \*utf8Buffer,
> \*/
> static uint32
> Utf8ToOneUcs4Char(const uint8 \*utf8Buffer, int utf8Length)
> {
> uint32 ucs4Char;
> uint32 minucs4Char;
> /\* from Unicode 3.1, non-shortest form is illegal \*/
> static const uint32 minucs4Table[] = {
>- 0x00000080, 0x00000800, 0x0001000, 0x0020000, 0x0400000
>+ 0x00000080, 0x00000800, 0x00010000, 0x00200000, 0x04000000
> };
>
> JS\_ASSERT(utf8Length >= 1 && utf8Length <= 6);
> if (utf8Length == 1) {
> ucs4Char = \*utf8Buffer;
> JS\_ASSERT(!(ucs4Char & 0x80));
> } else {
> JS\_ASSERT((\*utf8Buffer & (0x100 - (1 << (7-utf8Length)))) ==
This patch is sufficient to fix the problem according to ECMAScript-262 ed. 3, to be sure. However, I'm not sure, at this point, that that's sufficient for an acceptable fix, given that ES5 is very nearly out and requires rejection of overlong sequences, and that the necessary changes to address that are not large in scope. Would you mind creating a patch which addresses those problems? Minimally, I see the length of the array here, the 6 and 7 in the assertions in context, and the 6 in Decode -- I'd appreciate it if you could look and see if there are any others that need addressing.
Also, if I could trouble you to do so, adding a test or two to TestUTF8 in js/src/shell/js.cpp that will catch overlong sequences would be appreciated.
Thanks!

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=511859#c6)• 15 years ago |
|  | |

Comment on [attachment 395934](/attachment.cgi?id=395934 "PAtch rev.1.0") [[details]](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") [[diff]](/attachment.cgi?id=395934&action=diff "PAtch rev.1.0") [[review]](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=395934)
PAtch rev.1.0
Removing review request in case the previous comment went unnoticed...
[Attachment #395934](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") -
Flags: review?(jwalden+bmo)

|  | [Brendan Eich [:brendan]](/user_profile?user_id=1214) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=511859#c7)• 15 years ago |
|  | |

We often make progress (esp. with contributed patches -- thanks to the reporter indeed for this one) by taking a bird in the hand and doing a followup bug to get the second in the bush.
/be

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a1240912_250835)• 15 years ago |

Blocks: [514760](/show_bug.cgi?id=514760 "RESOLVED DUPLICATE - [ES3.1]decodeURI() should throw URIError for percent encoded overlong UTF-8 sequence")

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=511859#c10)• 15 years ago |
|  | |

Comment on [attachment 395934](/attachment.cgi?id=395934 "PAtch rev.1.0") [[details]](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") [[diff]](/attachment.cgi?id=395934&action=diff "PAtch rev.1.0") [[review]](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=395934)
PAtch rev.1.0
I wrote unified patch for this bug and [bug 514760](/show_bug.cgi?id=514760 "RESOLVED DUPLICATE - [ES3.1]decodeURI() should throw URIError for percent encoded overlong UTF-8 sequence") and [bug 518347](/show_bug.cgi?id=518347 "RESOLVED DUPLICATE - Remove support of 5byte and 6byte UTF-8 sequences in jsstr.cpp").
And now testing.
[Attachment #395934](/attachment.cgi?id=395934&action=edit "PAtch rev.1.0") -
Attachment is obsolete: true

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=511859#c11)• 15 years ago |
|  | |

Attached patch

[Patch rev.1.1](attachment.cgi?id=403067&action=diff)
— [Details](attachment.cgi?id=403067&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=403067)

This patch contains fix of [bug 518347](/show_bug.cgi?id=518347 "RESOLVED DUPLICATE - Remove support of 5byte and 6byte UTF-8 sequences in jsstr.cpp") and [bug 514760](/show_bug.cgi?id=514760 "RESOLVED DUPLICATE - [ES3.1]decodeURI() should throw URIError for percent encoded overlong UTF-8 sequence").
Memo: This patch causes to test failure of js1\_5/Regress/regress-172699.js but it is by design.
[Attachment #403067](/attachment.cgi?id=403067&action=edit "Patch rev.1.1") -
Flags: review?(jwalden+bmo)

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=511859#c12)• 15 years ago |
|  | |

Masahiro, please fix or disable the test as part of the checkin.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a3583412_83595)• 15 years ago |

[Attachment #403067](/attachment.cgi?id=403067&action=edit "Patch rev.1.1") -
Flags: review?(jwalden+bmo) → review+

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=511859#c13)• 15 years ago |
|  | |

Comment on [attachment 403067](/attachment.cgi?id=403067 "Patch rev.1.1") [[details]](/attachment.cgi?id=403067&action=edit "Patch rev.1.1") [[diff]](/attachment.cgi?id=403067&action=diff "Patch rev.1.1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=403067)
Patch rev.1.1
>diff --git a/js/src/jsstr.cpp b/js/src/jsstr.cpp
>+#define OVERLONG\_UTF8 ((uint32)0xFFFFFFFF)
For future reference, we're using C++ const values rather than defines these days -- better typing and all that.
>- if (ucs4Char < minucs4Char ||
>- ucs4Char == 0xFFFE || ucs4Char == 0xFFFF) {
>+ if (ucs4Char < minucs4Char) {
>+ ucs4Char = OVERLONG\_UTF8;
>+ } else if (ucs4Char == 0xFFFE || ucs4Char == 0xFFFF) {
> ucs4Char = 0xFFFD;
> }
Seems like a good idea to add a JS\_UNLIKELY() around the overlong comparison as a helper for compilation without PGO.
I'll push this with nits fixed to TM later tonight -- definite fodder for 192 as well, I think. Thanks!

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=511859#c14)• 15 years ago |
|  | |

Hum. So, looking and thinking about the existing behavior not changed by this patch, I don't see the U+FFF(EF)-to-replacement behavior in the spec. [Bug 172699](/show_bug.cgi?id=172699 "VERIFIED FIXED - JS UTF-8 decoder accepts overlong sequences") added it when doing the prior-to-this-patch decode-overlong-to-replacement behavior. Should we implement this extra conversion not specified by ES5? It's not clear, certainly not without any motivating help from bug comments. Filed [bug 520095](/show_bug.cgi?id=520095 "VERIFIED FIXED - Should encoded U+FFFE and U+FFFF decode to U+FFFD?") to address this, even if addressing is simply adding a comment next to those lines saying why the deviation from spec exists.

|  | [Masahiro YAMADA](/user_profile?user_id=250835)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=511859#c15)• 15 years ago |
|  | |

Attached file
[Test](attachment.cgi?id=404251)
— [Details](attachment.cgi?id=404251&action=edit)

This test fails on unpatched browser, but not fails on patched edition.
# This test does not contain test of changes on Ucs4 to UTF-8 convertion.
# it is reason why I don't set "review?" flag to this.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=511859#c16)• 15 years ago |
|  | |

Attached patch

[The test-fix I was going to check in, but the previous changes are better](attachment.cgi?id=404323&action=diff)
— [Details](attachment.cgi?id=404323&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=511859&attachment=404323)

I was going to make these minimal changes to get the test to work again, but yours are much better, touching more of the different ways the patch here would change behavior.

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=511859#c17)• 15 years ago |
|  | |

...actually, on second look, it probably makes sense to add both your test and make the changes I'd made. Did that, with a few formatting tweaks to your test (we surround binary operators with a space on each side, so |expect = foo| rather than |expect=foo|), and pushed to TM (also with appropriate changes to the relevant jstests.list file):
<http://hg.mozilla.org/tracemonkey/rev/8bb236bece1f>
Thanks again!Whiteboard: [good first bug] → fixed-in-tracemonkey

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=511859#c18)• 15 years ago |
|  | |

Accepting overlong UTF-8 sequences is a well-known bug with potential security implications. In the context of JavaScript those implications are likely less serious than in, say, C code, but it still seems important to fix this.
If this is to be fixed for 1.9.2 (I think it should given the security considerations), I think we can all agree it must be fixed for the beta.Flags: blocking1.9.2?Whiteboard: fixed-in-tracemonkey → [sg:want?] fixed-in-tracemonkey

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=511859#c19)• 15 years ago |
|  | |

thanks waldo!Flags: in-testsuite+

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a3672535_180188)• 15 years ago |

Flags: blocking1.9.2? → blocking1.9.2+

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a3910472_180188)• 15 years ago |

Priority: -- → P2

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a3920697_180188)• 15 years ago |

Priority: P2 → P1

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=511859#c20)• 15 years ago |
|  | |

<http://hg.mozilla.org/mozilla-central/rev/8bb236bece1f>Status: ASSIGNED → RESOLVEDClosed: 15 years agoResolution: --- → FIXED

|  | [Bob Clary [:bc] (inactive)](/user_profile?user_id=23402) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=511859#c21)• 15 years ago |
|  | |

v 1.9.3Status: RESOLVED → VERIFIED

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=511859#c23)• 15 years ago |
|  | |

<http://hg.mozilla.org/releases/mozilla-1.9.2/rev/e42c563313a0>
[status1.9.2](/buglist.cgi?f1=cf_status_192&o1=isnotempty):
--- → [final-fixed](/buglist.cgi?f1=cf_status_192&o1=equals&v1=final-fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=511859#a51972897_1689)• 14 years ago |

[status1.9.1](/buglist.cgi?f1=cf_status_191&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_191&o1=equals&v1=wontfix)
You need to [log in](/show_bug.cgi?id=511859&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Masahiro YAMADA](/user_profile?user_id=250835)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from hg.mozilla.org_bf28e59e_20250125_204304.html ===

[![mercurial](/static/da583331cf02/moz-logo-bw-rgb.svg)](https://firefox-source-docs.mozilla.org/contributing/vcs/mercurial.html)

[Mercurial](/) > [releases](/releases) > [mozilla-1.9.2](/releases/mozilla-1.9.2) / changeset / e42c563313a0934fdd6876b1b5ccf52315e4f000

[summary](/releases/mozilla-1.9.2/summary) |
[shortlog](/releases/mozilla-1.9.2/shortlog/e42c563313a0) |
[changelog](/releases/mozilla-1.9.2/log/e42c563313a0) |
[pushlog](/releases/mozilla-1.9.2/pushloghtml) |
[graph](/releases/mozilla-1.9.2/graph/e42c563313a0) |
[tags](/releases/mozilla-1.9.2/tags) |
[bookmarks](/releases/mozilla-1.9.2/bookmarks) |
[branches](/releases/mozilla-1.9.2/branches) |
[files](/releases/mozilla-1.9.2/file/e42c563313a0) |
changeset |
[raw](/releases/mozilla-1.9.2/raw-rev/e42c563313a0) | [zip](/releases/mozilla-1.9.2/archive/e42c563313a0.zip) |
[help](/releases/mozilla-1.9.2/help)

Find changesets by keywords (author, files, the commit message), revision
number or hash, or [revset expression](/releases/mozilla-1.9.2/help/revsets).

[Bug 511859](https://bugzilla.mozilla.org/show_bug.cgi?id=511859) - Reject overlong UTF-8 encodings of code points rather than converting them to U+FFFD or the code point they supposedly describe. r=jwalden

| author | Masahiro Yamada <masa141421356@gmail.com> |
| --- | --- |
|  | Fri, 13 Nov 2009 03:36:54 +0100 |
| changeset 32906 | [e42c563313a0934fdd6876b1b5ccf52315e4f000](/releases/mozilla-1.9.2/rev/e42c563313a0934fdd6876b1b5ccf52315e4f000) |
| parent 32905 | [72110846033e6d91d6b802d6b7d44e34d3090caf](/releases/mozilla-1.9.2/rev/72110846033e6d91d6b802d6b7d44e34d3090caf) |
| child 32907 | [64c0d07ef7685134547c9ddbad9b380033a9daf4](/releases/mozilla-1.9.2/rev/64c0d07ef7685134547c9ddbad9b380033a9daf4) |
| push id | [674](/releases/mozilla-1.9.2/pushloghtml?changeset=e42c563313a0934fdd6876b1b5ccf52315e4f000) |
| push user | rsayre@mozilla.com |
| push date | Fri, 13 Nov 2009 03:39:20 +0000 |
| reviewers | [jwalden](/releases/mozilla-1.9.2/log?rev=reviewer%28jwalden%29&revcount=50) |
| bugs | [511859](https://bugzilla.mozilla.org/show_bug.cgi?id=511859) |
| milestone | 1.9.2b3pre |

[Bug 511859](https://bugzilla.mozilla.org/show_bug.cgi?id=511859) - Reject overlong UTF-8 encodings of code points rather than converting them to U+FFFD or the code point they supposedly describe. r=jwalden

| [js/src/jsstr.cpp](/releases/mozilla-1.9.2/diff/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) |  | [file](/releases/mozilla-1.9.2/file/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) | [annotate](/releases/mozilla-1.9.2/annotate/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) | [diff](/releases/mozilla-1.9.2/diff/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) | [comparison](/releases/mozilla-1.9.2/comparison/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) | [revisions](/releases/mozilla-1.9.2/log/e42c563313a0934fdd6876b1b5ccf52315e4f000/js/src/jsstr.cpp) |
| --- | --- | --- |

```

--- a/js/src/jsstr.cpp
+++ b/js/src/jsstr.cpp
@@ -43,16 +43,18 @@
  *
  * In order to avoid unnecessary js_LockGCThing/js_UnlockGCThing calls, these
  * native methods store strings (possibly newborn) converted from their 'this'
  * parameter and arguments on the stack: 'this' conversions at argv[-1], arg
  * conversions at their index (argv[0], argv[1]).  This is a legitimate method
  * of rooting things that might lose their newborn root due to subsequent GC
  * allocations in the same native method.
  */
+#define __STDC_LIMIT_MACROS
+
 #include <stdlib.h>
 #include <string.h>
 #include "jstypes.h"
 #include "jsstdint.h"
 #include "jsutil.h" /* Added by JSIFY */
 #include "jshash.h" /* Added by JSIFY */
 #include "jsprf.h"
 #include "jsapi.h"
@@ -292,16 +294,18 @@ static JSBool
 str_decodeURI_Component(JSContext *cx, uintN argc, jsval *vp);

 static JSBool
 str_encodeURI(JSContext *cx, uintN argc, jsval *vp);

 static JSBool
 str_encodeURI_Component(JSContext *cx, uintN argc, jsval *vp);

+static const uint32 OVERLONG_UTF8 = UINT32_MAX;
+
 static uint32
 Utf8ToOneUcs4Char(const uint8 *utf8Buffer, int utf8Length);

 /*
  * Contributions from the String class to the set of methods defined for the
  * global object.  escape and unescape used to be defined in the Mocha library,
  * but as ECMA decided to spec them, they've been moved to the core engine
  * and made ECMA-compliant.  (Incomplete escapes are interpreted as literal
@@ -3638,17 +3642,17 @@ js_InflateStringToBuffer(JSContext *cx,
     while (srclen) {
         v = (uint8) *src;
         n = 1;
         if (v & 0x80) {
             while (v & (0x80 >> n))
                 n++;
             if (n > srclen)
                 goto bufferTooSmall;
-            if (n == 1 || n > 6)
+            if (n == 1 || n > 4)
                 goto badCharacter;
             for (j = 1; j < n; j++) {
                 if ((src[j] & 0xC0) != 0x80)
                     goto badCharacter;
             }
             v = Utf8ToOneUcs4Char((uint8 *)src, n);
             if (v >= 0x10000) {
                 v -= 0x10000;
@@ -5157,17 +5161,17 @@ static JSBool
 Encode(JSContext *cx, JSString *str, const jschar *unescapedSet,
        const jschar *unescapedSet2, jsval *rval)
 {
     size_t length, j, k, L;
     JSCharBuffer cb(cx);
     const jschar *chars;
     jschar c, c2;
     uint32 v;
-    uint8 utf8buf[6];
+    uint8 utf8buf[4];
     jschar hexBuf[4];
     static const char HexDigits[] = "0123456789ABCDEF"; /* NB: uppercase */

     str->getCharsAndLength(chars, length);
     if (length == 0) {
         *rval = STRING_TO_JSVAL(cx->runtime->emptyString);
         return JS_TRUE;
     }
@@ -5221,17 +5225,17 @@ static JSBool
 Decode(JSContext *cx, JSString *str, const jschar *reservedSet, jsval *rval)
 {
     size_t length, start, k;
     JSCharBuffer cb(cx);
     const jschar *chars;
     jschar c, H;
     uint32 v;
     jsuint B;
-    uint8 octets[6];
+    uint8 octets[4];
     intN j, n;

     str->getCharsAndLength(chars, length);
     if (length == 0) {
         *rval = STRING_TO_JSVAL(cx->runtime->emptyString);
         return JS_TRUE;
     }

@@ -5247,17 +5251,17 @@ Decode(JSContext *cx, JSString *str, con
             B = JS7_UNHEX(chars[k+1]) * 16 + JS7_UNHEX(chars[k+2]);
             k += 2;
             if (!(B & 0x80)) {
                 c = (jschar)B;
             } else {
                 n = 1;
                 while (B & (0x80 >> n))
                     n++;
-                if (n == 1 || n > 6)
+                if (n == 1 || n > 4)
                     goto report_bad_uri;
                 octets[0] = (uint8)B;
                 if (k + 3 * (n - 1) >= length)
                     goto report_bad_uri;
                 for (j = 1; j < n; j++) {
                     k++;
                     if (chars[k] != '%')
                         goto report_bad_uri;
@@ -5346,24 +5350,24 @@ str_encodeURI_Component(JSContext *cx, u
     str = ArgToRootedString(cx, argc, vp, 0);
     if (!str)
         return JS_FALSE;
     return Encode(cx, str, js_uriUnescaped_ucstr, NULL, vp);
 }

 /*
  * Convert one UCS-4 char and write it into a UTF-8 buffer, which must be at
- * least 6 bytes long.  Return the number of UTF-8 bytes of data written.
+ * least 4 bytes long.  Return the number of UTF-8 bytes of data written.
  */
 int
 js_OneUcs4ToUtf8Char(uint8 *utf8Buffer, uint32 ucs4Char)
 {
     int utf8Length = 1;

-    JS_ASSERT(ucs4Char <= 0x7FFFFFFF);
+    JS_ASSERT(ucs4Char <= 0x10FFFF);
     if (ucs4Char < 0x80) {
         *utf8Buffer = (uint8)ucs4Char;
     } else {
         int i;
         uint32 a = ucs4Char >> 11;
         utf8Length = 2;
         while (a) {
             a >>= 5;
@@ -5386,34 +5390,35 @@ js_OneUcs4ToUtf8Char(uint8 *utf8Buffer,
  */
 static uint32
 Utf8ToOneUcs4Char(const uint8 *utf8Buffer, int utf8Length)
 {
     uint32 ucs4Char;
     uint32 minucs4Char;
     /* from Unicode 3.1, non-shortest form is illegal */
     static const uint32 minucs4Table[] = {
-        0x00000080, 0x00000800, 0x0001000, 0x0020000, 0x0400000
+        0x00000080, 0x00000800, 0x00010000
     };

-    JS_ASSERT(utf8Length >= 1 && utf8Length <= 6);
+    JS_ASSERT(utf8Length >= 1 && utf8Length <= 4);
     if (utf8Length == 1) {
         ucs4Char = *utf8Buffer;
         JS_ASSERT(!(ucs4Char & 0x80));
     } else {
         JS_ASSERT((*utf8Buffer & (0x100 - (1 << (7-utf8Length)))) ==
                   (0x100 - (1 << (8-utf8Length))));
         ucs4Char = *utf8Buffer++ & ((1<<(7-utf8Length))-1);
         minucs4Char = minucs4Table[utf8Length-2];
         while (--utf8Length) {
             JS_ASSERT((*utf8Buffer & 0xC0) == 0x80);
             ucs4Char = ucs4Char<<6 | (*utf8Buffer++ & 0x3F);
         }
-        if (ucs4Char < minucs4Char ||
-            ucs4Char == 0xFFFE || ucs4Char == 0xFFFF) {
+        if (JS_UNLIKELY(ucs4Char < minucs4Char)) {
+            ucs4Char = OVERLONG_UTF8;
+        } else if (ucs4Char == 0xFFFE || ucs4Char == 0xFFFF) {
             ucs4Char = 0xFFFD;
         }
     }
     return ucs4Char;
 }

 #if defined DEBUG || defined JS_DUMP_PROPTREE_STATS

```

mozilla-1.9.2
Deployed from [da583331cf02](https://hg.mozilla.org/hgcustom/version-control-tools/rev/da583331cf02) at 2025-01-21T15:07:35Z.
[RSS](/releases/mozilla-1.9.2/rss-log)
[Atom](/releases/mozilla-1.9.2/atom-log)



=== Content from sirdarckcat.blogspot.com_93a63074_20250125_204305.html ===


[skip to main](#main)  |
[skip to sidebar](#sidebar)

# [sirdarckcat](http://sirdarckcat.blogspot.com/)

## Thursday, October 15, 2009

### [A couple of unicode issues on PHP and Firefox](http://sirdarckcat.blogspot.com/2009/10/couple-of-unicode-issues-on-php-and.html)

Well, here I am developing ACS, finding that this project resembles at some degree the creation of a browser.. but anyway, it's close to a working beta (yay!).

In any case, a couple of bugs came to my attention, some of them are public, some of them are not.

First of all, I want to describe the PHP vulnerability I made public on my presentation with David Lindsay, at [Blackhat USA 2009](http://sirdarckcat.blogspot.com/2009/08/our-favorite-xss-filters-and-how-to.html), that apparently only [Chris Weber](https://twitter.com/christoweb/status/3130572209), [Giorgio Maone (creator of NoScript)](http://noscript.net/changelog#1.9.6.1), [Mario Heiderich (creator of PHP-IDS)](http://php-ids.org/) and the [Acunetix security team](http://www.acunetix.com/blog/web-security-articles/security-risks-associated-with-utf8_decode/) have realized the danger of it.

It has been reported, well, [more than enough times](http://bugs.php.net/bug.php?id=48230) to the PHP team (I made another attempt today, hoping this will get fixed in some time soon.. if at all). This issue affects all PHP versions Mario Heiderich and me could test, and endangers practically all PHP programs that use the [utf8\_decode()](http://php.net/utf8_decode) function for decoding (as recommended by OWASP guidelines).

> The disclosure timeline follows:
>
> \* Reported by root@80sec.com: May 11 2009
>
> \* Discovered by webmaster@lapstore.de: June 19 2009
>
> \* Discovered by Giorgio Maone / Eduardo Vela: July 14 2009
>
> \* Reported and Fixed on PHPIDS: July 14 2009
>
> \* Microsoft notified of a XSS Filter bypass: July 14 2009
>
> \* Fixed XSS Filter bypass on NoScript 1.9.6:  July 20 2009
>
> \* Vulnerability disclosed on BlackHat USA 2009: July 29 2009
>
> \* Added signature to Acunetix WVS: August 14 2009
>
> \* Re-reported by sird@rckc.at: September 27 2009
>
> \* Vendor claims it was fixed on 5.2.11: September 29 2009
>
> \* Re-re-reported by sird@rckc.at after checking 5.2.11: October 16 2009
>
> \* Published sirdarckcat.blogspot.com: October 16 2009

You can check the bug here:

<http://bugs.php.net/bug.php?id=49687>

In reality there are several vulns in just a couple of lines, so I'll describe them here:

1.- **Overlong UTF-8:**
> As REQUIRED by UNICODE 3.1, and noted in the Unicode Technical Report #36, UTF-8 is forbidden to interpretate a character's non-shortest form.

<http://www.unicode.org/reports/tr36/#UTF-8_Exploit>

**VULN: *PHP makes no checks whatsoever on this matter.***

**Why is this a vulnerability?**

A filter (such as addslashes, htmlentities, escapeshellarg, etc.) will NOT be able to detect&escape such byte sequences, and so an application that relies on them for security checks wont be protected at all. Because it allows an attacker to encode "dangerous" chars, such as ', ", <, ;, &, \0 in different ways:

' = %27 = %c0%a7 = %e0%80%a7 = %f0%80%80%a7

" = %22 = %c0%a2 = %e0%80%a2 = %f0%80%80%a2

< = %3c = %c0%bc = %e0%80%bc = %f0%80%80%bc

; = %3b = %c0%bb = %e0%80%bb = %f0%80%80%bb

& = %26 = %c0%a6 = %e0%80%a6 = %f0%80%80%a6

\0= % 00 = %c0%80 = %e0%80%80 = %f0%80%80%80

[Use hackvertor to generate them.](http://www.businessinfo.co.uk/labs/hackvertor/hackvertor.php#JiA9IDxAb3ZlcmxvbmdfdXRmOF8wKDEpPiY8QC9vdmVybG9uZ191dGY4XzA%2BID0gPEBvdmVybG9uZ191dGY4XzEoMik%2BJjxAL292ZXJsb25nX3V0ZjhfMT4gPSA8QG92ZXJsb25nX3V0ZjhfMigzKT4mPEAvb3ZlcmxvbmdfdXRmOF8yPiA9IDxAb3ZlcmxvbmdfdXRmOF8zKDQpPiY8QC9vdmVybG9uZ191dGY4XzM%2B)

Enabling attacks on systems that use addslashes for example (but almost all encoding functions would be vulnerable):

> // add slashes!
>
> foreach($\_GET as $k=>$v)$\_GET[$k]=**addslashes**("$v");
>
>
>
> //  .... some code ...
>
>
>
> // $name is encoded in utf8
>
> $name=**utf8\_decode**($\_GET['name']);
>
> mysql\_query("SELECT \* FROM table WHERE name='$name';");
>
>
>
> ?>

2.- **Ill formed sequences**:

As REQUIRED by UNICODE 3.0, and noted in the Unicode Technical Report #36, if a leading byte is followed by an invalid successor byte, then it should NOT consume it.

    <http://www.unicode.org/reports/tr36/#Ill-Formed_Subsequences>

**VULN: *PHP will consume invalid bytes.***

**Why is this a vulnerability?**

It will allow an attacker to "eat" controll chars. For example:

> // htmlentities
>
> foreach($\_GET as $k=>$v)$\_GET[$k]=**htmlentities**("$v",ENT\_QUOTES);
>
>
>
> //  ... some code ...
>
>
>
> $name=$\_GET['name'];
>
> $url=$\_GET['url'];
>
>
>
> //  ... some code ...
>
>
>
> $profileImage="<img alt=\"Photo of $name\" src=\"http://$url\" />";
>
>
>
> // ... some code ...
>
> echo **utf8\_decode**($profileImage);
>
> ?>

A request such as:

?name=%90&src=%20onerror=alert(1)%20

Will execute the code "alert(1)" when the page loads.

Note that htmlpurifier does a utf8\_decode function call at the end of the decoding, BUT they are safe because of a pre-encoding made by htmlpurifier.. other codes that do the same wont be so lucky.

Bogdan Calin from Acunetix WVS described a couple of other potential attack scenarios:

> [![](http://www.acunetix.com/blog/wp-content/uploads/2009/08/xss_utf8_decode.PNG)](http://www.acunetix.com/blog/wp-content/uploads/2009/08/xss_utf8_decode.PNG)

Where an attacker could fool the filter by doing a request like:

vuln.php?input=**%F6%3Cimg+onmouseover=prompt(/xss/)//%F6%3E**

And:
> [![](http://www.acunetix.com/blog/wp-content/uploads/2009/08/sql_injection_addslashes_utf8_decode.PNG)](http://www.acunetix.com/blog/wp-content/uploads/2009/08/sql_injection_addslashes_utf8_decode.PNG)

>

Where an attacker could fool the filter by doing a request like:

index.php?username=**test%FC%27%27+or+1=1+–+**&password=a

3.- **Integer overflow:**

Unsigned short has a size of 16 bits (2 bytes), that is UNCAPABLE of storing unicode characters of 21 bits, and represented on UTF with 4 bytes (1111 0xxx 10xx xxxx 10xx xxxx 10xx xxxx). PHP attempts to sum a 21 bits value to a 16 bits-size variable, and then makes no checks on the value.

The affected code follows:

> //  php/ext/xml/xml.c#558
>
> PHPAPI char \*xml\_utf8\_decode(    //  ...
>
> {
>
>     int pos = len;
>
>     char \*newbuf = emallo    //  ...
>
>     unsigned short c;          // **sizeof(unsigned short)==16** bits
>
>     char (\*decoder)(unsig    //  ...
>
>     xml\_encoding \*enc = x    //  ...
>
> //  ...
>
> //  #580
>
>     c = (unsigned char)(\*s);
>
>     if (c >= 0xf0) {         /\* **four bytes encoded, 21** bits \*/
>
>         if(pos-4 >= 0) {
>
>             c = (**(s[0]&7)<<18) | ((s[1]&63)<<12)** | ((s[2]&63)<<6) | (s[3]&63);
>
>         } else {
>
>             c = '?';
>
>         }
>
>         s += 4;
>
>         pos -= 4;
>
> //  ...

The relevant part of the code is of course, the declaration of c as an unsigned int, the comment specifing that the char is 21 bits, and this:
> x= ((s[0]&7)<<18) | ...

s[0]&7<<18 means it will move 3 bits, 18 bits to the right. As we noted before.. c's size is only 16 bits.
> (xxxx xxxx & 0000 0111) << 18

Also, this part:
> ...  ((s[1]&63)<<12) | ...

s[1]&63<<12 means it will move 6 bits, 12 bits to the right. So, 2 bits are going to be lost.
> (xxxx xxxx & 0011 1111) << 12

This allows us to make something even more interesting.

Code like this:

**%FF%F0%40%FC** that is invalid unicode, overlong, and all you want (definatelly NOT valid), will be casted as a "lower than" simbol (<).

<http://eaea.sirdarckcat.net/xss.php?unicode&html_xss=%FF%F0%40%FC>

This besides the already mentioned problems, and the possibility of bypassing quite a lot of WAFs and Filters.. demonstrate the problem of a bad unicode implementation on PHP.

I hope the PHP development team acknowledges all this issues that have been reported before, and were explained some months ago on Blackhat USA (and the developers were noticed to check the ppt more than once), and now are explained yet another time.

**This was fixed on 5.2.11 :) on my birthday!! Sept 17**

Anyway.. that's not all, now to finish this post I want to publish a overlong utf-8 exception on Firefox (actually, Mozilla's).

# The firefox one

Firefox is supposed to consider the non-shortest form exception (point #1 in the PHP vulnerabilities), and section 3.1 of the Unicode Technical Report #36 but apparently there's a flaw on it. This is specially problematic for the reasons that an overlong unicode sequence not taken into consideration may allow several types of filter bypasses.

Anyway, the severity of this vulnerability is not as high as the PHP ones, but is worth mentioning. The following non-shortest form for the char U+1000:
> 0xF0 0x81 0x80 0x80

is allowed, as well as the correct shortest form:
> 0xE1 0x80 0x80

Note that this problem is only present on the 4 bytes representation.

You can track this bug at:

<https://bugzilla.mozilla.org/show_bug.cgi?id=522634>

Anyway, that's all! Thanks for your time :)

Greetings!!

at
[10:30 PM](http://sirdarckcat.blogspot.com/2009/10/couple-of-unicode-issues-on-php-and.html "permanent link")

[![](http://www.blogger.com/img/icon18_email.gif)](https://www.blogger.com/email-post/7482149/6447658206566334811 "Email Post")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=7482149&postID=6447658206566334811&from=pencil "Edit Post")

Labels:
[firefox](http://sirdarckcat.blogspot.com/search/label/firefox),
[unicode](http://sirdarckcat.blogspot.com/search/label/unicode),
[xss](http://sirdarckcat.blogspot.com/search/label/xss)

[Newer Post](http://sirdarckcat.blogspot.com/2010/07/full-disclosure-reverse-responsible.html "Newer Post")

[Older Post](http://sirdarckcat.blogspot.com/2009/08/our-favorite-xss-filters-and-how-to.html "Older Post")

[Home](http://sirdarckcat.blogspot.com/)

*This is a personal blog.*
[Follow @sirdarckcat](https://twitter.com/sirdarckcat?ref_src=twsrc%5Etfw)

## Blog Archive

* ►
  [2019](http://sirdarckcat.blogspot.com/2019/)
  (1)
  + ►
    [March](http://sirdarckcat.blogspot.com/2019/03/)
    (1)

* ►
  [2017](http://sirdarckcat.blogspot.com/2017/)
  (5)
  + ►
    [December](http://sirdarckcat.blogspot.com/2017/12/)
    (1)
  + ►
    [February](http://sirdarckcat.blogspot.com/2017/02/)
    (2)
  + ►
    [January](http://sirdarckcat.blogspot.com/2017/01/)
    (2)

* ►
  [2016](http://sirdarckcat.blogspot.com/2016/)
  (3)
  + ►
    [December](http://sirdarckcat.blogspot.com/2016/12/)
    (2)
  + ►
    [March](http://sirdarckcat.blogspot.com/2016/03/)
    (1)

* ►
  [2015](http://sirdarckcat.blogspot.com/2015/)
  (4)
  + ►
    [October](http://sirdarckcat.blogspot.com/2015/10/)
    (1)
  + ►
    [September](http://sirdarckcat.blogspot.com/2015/09/)
    (1)
  + ►
    [May](http://sirdarckcat.blogspot.com/2015/05/)
    (2)

* ►
  [2014](http://sirdarckcat.blogspot.com/2014/)
  (1)
  + ►
    [May](http://sirdarckcat.blogspot.com/2014/05/)
    (1)

* ►
  [2013](http://sirdarckcat.blogspot.com/2013/)
  (1)
  + ►
    [September](http://sirdarckcat.blogspot.com/2013/09/)
    (1)

* ►
  [2011](http://sirdarckcat.blogspot.com/2011/)
  (1)
  + ►
    [December](http://sirdarckcat.blogspot.com/2011/12/)
    (1)

* ►
  [2010](http://sirdarckcat.blogspot.com/2010/)
  (1)
  + ►
    [July](http://sirdarckcat.blogspot.com/2010/07/)
    (1)

* ▼
  [2009](http://sirdarckcat.blogspot.com/2009/)
  (4)
  + ▼
    [October](http://sirdarckcat.blogspot.com/2009/10/)
    (1)
    - [A couple of unicode issues on PHP and Firefox](http://sirdarckcat.blogspot.com/2009/10/couple-of-unicode-issues-on-php-and.html)
  + ►
    [August](http://sirdarckcat.blogspot.com/2009/08/)
    (1)
  + ►
    [April](http://sirdarckcat.blogspot.com/2009/04/)
    (1)
  + ►
    [January](http://sirdarckcat.blogspot.com/2009/01/)
    (1)

* ►
  [2008](http://sirdarckcat.blogspot.com/2008/)
  (6)
  + ►
    [October](http://sirdarckcat.blogspot.com/2008/10/)
    (1)
  + ►
    [September](http://sirdarckcat.blogspot.com/2008/09/)
    (1)
  + ►
    [June](http://sirdarckcat.blogspot.com/2008/06/)
    (1)
  + ►
    [May](http://sirdarckcat.blogspot.com/2008/05/)
    (2)
  + ►
    [January](http://sirdarckcat.blogspot.com/2008/01/)
    (1)

* ►
  [2007](http://sirdarckcat.blogspot.com/2007/)
  (17)
  + ►
    [December](http://sirdarckcat.blogspot.com/2007/12/)
    (2)
  + ►
    [November](http://sirdarckcat.blogspot.com/2007/11/)
    (2)
  + ►
    [October](http://sirdarckcat.blogspot.com/2007/10/)
    (1)
  + ►
    [September](http://sirdarckcat.blogspot.com/2007/09/)
    (4)
  + ►
    [August](http://sirdarckcat.blogspot.com/2007/08/)
    (4)
  + ►
    [July](http://sirdarckcat.blogspot.com/2007/07/)
    (4)


