=== Content from bugzilla.mozilla.org_2110ce00_20250124_163342.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/380418)
* [XML](/show_bug.cgi?ctype=xml&id=380418)

Closed
[Bug 380418](/show_bug.cgi?id=380418)
(CVE-2009-0357)

Opened 18 years ago
Closed 16 years ago

# XMLHttpRequest allows reading HTTPOnly cookies

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

XMLHttpRequest allows reading HTTPOnly cookies

## Categories

### (Core :: Networking: Cookies, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20Cookies#Networking%3A%20Cookies)

Networking: Cookies
▾

Core :: Networking: Cookies
A general mechanism which server side connections (such as CGI scripts) can use to both store and retrieve information on the client side of the connection. This refers to HTML cookies; little blobs of data we store and share with sites
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20Cookies)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla1.9.1b2

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jwkbugzilla, Assigned: bjarne)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/c3c6b76d2faae9073eacd5d44754b58f?d=mm&size=40)  [bjarne](/user_profile?user_id=323714)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/bd1b9ed4ddafb4e94ca9ec218f77fdb4?d=mm&size=40)  [jwkbugzilla](/user_profile?user_id=109976)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/608e04ebca94be52b05c003d51d43e07?d=mm&size=40)  [kershaw](/user_profile?user_id=505624)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

30 people

## References

### ( URL )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[477165](/show_bug.cgi?id=477165 "RESOLVED WORKSFORME - Help Center Live chat rooms will not connect with Firefox 3.0.6+ (helpcenterlive.com)")

[178993](/show_bug.cgi?id=178993 "RESOLVED FIXED - MSIE-extension: HttpOnly cookie attribute for cross-site scripting vulnerability prevention")

Dependency [tree](/showdependencytree.cgi?id=380418&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=380418)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

javascript:var req = new XMLHttpReque...

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: fixed1.8.1.21, verified1.9.0.6, verified1.9.1, Whiteboard: [sg:want P2])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2009-0357

[Keywords:](/describekeywords.cgi)

[fixed1.8.1.21](/buglist.cgi?keywords=fixed1.8.1.21&resolution=---),
[verified1.9.0.6](/buglist.cgi?keywords=verified1.9.0.6&resolution=---),
[verified1.9.1](/buglist.cgi?keywords=verified1.9.1&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[sg:want P2]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

5

Bug Flags:

| [sicking](/user_profile?user_id=9186) | [blocking1.9.1](#c34 "16 years ago") | + |
| --- | --- | --- |
| [sicking](/user_profile?user_id=9186) | blocking1.9.1 | + |
| --- | --- | --- |
| [pavlov](/user_profile?user_id=5756) | [blocking1.9](#a25337332_5756 "17 years ago") | - |
| --- | --- | --- |
| [pavlov](/user_profile?user_id=5756) | blocking1.9 | - |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [blocking1.9.0.6](#a50811415_1689 "16 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | blocking1.9.0.6 | + |
| --- | --- | --- |
| [pavlov](/user_profile?user_id=5756) | [wanted1.9.0.x](#a25337332_5756 "17 years ago") | + |
| --- | --- | --- |
| [pavlov](/user_profile?user_id=5756) | wanted1.9.0.x | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | [wanted1.8.1.x](#a8832569_1689 "17 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | wanted1.8.1.x | + |
| --- | --- | --- |
| [sgautherie](/user_profile?user_id=49577) | [in-testsuite](#c89 "16 years ago") | + |
| --- | --- | --- |
| [sgautherie](/user_profile?user_id=49577) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (7 files, 6 obsolete files)

| [Proposed patch and mochitest testcase](/attachment.cgi?id=264674)  [18 years ago](#c4)  [Wladimir Palant](/user_profile?user_id=109976)   10.23 KB, patch | jst : [review+](#c5 "18 years ago")  sicking : [superreview+](#c9 "18 years ago") | [Details](/attachment.cgi?id=264674&action=edit) | [Diff](/attachment.cgi?id=264674&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=264674) |
| --- | --- | --- |
| [Patch to be checked in](/attachment.cgi?id=270288)  [18 years ago](#c10)  [Wladimir Palant](/user_profile?user_id=109976)   10.24 KB, patch | dveditz : [review-](#c14 "18 years ago") | [Details](/attachment.cgi?id=270288&action=edit) | [Diff](/attachment.cgi?id=270288&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288) |
| [Patch fixing the ha.ckers.org/httponly.cgi issue](/attachment.cgi?id=339447)  [16 years ago](#c35)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   8.24 KB, patch |  | [Details](/attachment.cgi?id=339447&action=edit) | [Diff](/attachment.cgi?id=339447&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=339447) |
| [Improved patch](/attachment.cgi?id=340906)  [16 years ago](#c39)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   8.57 KB, patch |  | [Details](/attachment.cgi?id=340906&action=edit) | [Diff](/attachment.cgi?id=340906&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=340906) |
| [Proposed test-skeleton](/attachment.cgi?id=342871)  [16 years ago](#c46)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   2.83 KB, application/x-javascript |  | [Details](/attachment.cgi?id=342871&action=edit) |
| [Improved patch for getAllResponseHeaders, handling comma-separated cookies](/attachment.cgi?id=343113)  [16 years ago](#c52)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   12.27 KB, patch |  | [Details](/attachment.cgi?id=343113&action=edit) | [Diff](/attachment.cgi?id=343113&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343113) |
| [Improved unit-test](/attachment.cgi?id=343114)  [16 years ago](#c53)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   5.25 KB, application/x-javascript |  | [Details](/attachment.cgi?id=343114&action=edit) |
| [Patch to nsCookieService.cpp allowing comma as cookie-separator](/attachment.cgi?id=343289)  [16 years ago](#c57)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   7.33 KB, patch |  | [Details](/attachment.cgi?id=343289&action=edit) | [Diff](/attachment.cgi?id=343289&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343289) |
| [Patch to nsXMLHttpRequest.cpp implementing the simplest solution](/attachment.cgi?id=343383)  [16 years ago](#c59)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   1.99 KB, patch |  | [Details](/attachment.cgi?id=343383&action=edit) | [Diff](/attachment.cgi?id=343383&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343383) |
| [Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant](/attachment.cgi?id=343525)  [16 years ago](#c65)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   5.46 KB, patch | sicking : [review-](#c67 "16 years ago")  sicking : [superreview+](#c66 "16 years ago") | [Details](/attachment.cgi?id=343525&action=edit) | [Diff](/attachment.cgi?id=343525&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343525) |
| [Patch also blocking Set-Cookie2 header [Checkin: Comment 85]](/attachment.cgi?id=345336)  [16 years ago](#c68)  [Bjarne (:bjarne)](/user_profile?user_id=323714)   6.17 KB, patch | sicking : [review+](#c69 "16 years ago")  sicking : [superreview+](#c69 "16 years ago")  dveditz : [approval1.9.0.6+](#a51071803_1689 "16 years ago") | [Details](/attachment.cgi?id=345336&action=edit) | [Diff](/attachment.cgi?id=345336&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336) |
| [for 1.8.1](/attachment.cgi?id=355351)  [16 years ago](#c93)  [Alexander Sack](/user_profile?user_id=113760)   2.51 KB, patch | dveditz : [approval1.8.1.next+](#c97 "16 years ago") | [Details](/attachment.cgi?id=355351&action=edit) | [Diff](/attachment.cgi?id=355351&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355351) |
| [for 1.8.0](/attachment.cgi?id=355353)  [16 years ago](#c94)  [Alexander Sack](/user_profile?user_id=113760)   2.73 KB, patch | asac : [approval1.8.0.next+](#a52551089_113760 "16 years ago") | [Details](/attachment.cgi?id=355353&action=edit) | [Diff](/attachment.cgi?id=355353&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355353) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=380418#c0)• 18 years ago |
|  | |

XMLHttpRequest subverts the idea of HTTPOnly cookies since it allows sending a request and reading out Set-Cookie header of the response - even if it has HTTPOnly flag set. There are quite a few web applications out there that will send out a Set-Cookie header with the session cookie for every request just in case, thus rendering HTTPOnly flag ineffective.
To test you can go to <http://www.yabbforum.com/community/> and use this bookmarklet:
javascript:var req = new XMLHttpRequest();req.open("GET", "/community/", false);req.send(null);alert(req.getAllResponseHeaders());alert(req.getResponseHeader("Set-Cookie"))
You will see a list of all response headers including Set-Cookie, and then the result of req.getResponseHeader("Set-Cookie"). I think Set-Cookie headers should be excluded from the list and req.getResponseHeader("Set-Cookie") should always return null. This protection is only necessary for unprivileged scripts, the implementation can be the same as in setRequestHeader.

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=380418#c1)• 18 years ago |
|  | |

Good catch, does this work on other browsers?

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=380418#c2)• 18 years ago |
|  | |

It works in Opera as well - but on the other hand, I don't have an Opera build with HTTPOnly support yet. It also works in IE6. However, according to <http://ha.ckers.org/blog/20070511/bluehat-errata/> this is fixed in IE7 (I couldn't verify this).

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a22462_11608)• 18 years ago |

Flags: blocking1.9?Flags: blocking1.8.1.5?Flags: blocking1.8.1.4?

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=380418#c3)• 18 years ago |
|  | |

Jesse, [bug 178993](/show_bug.cgi?id=178993 "RESOLVED FIXED - MSIE-extension: HttpOnly cookie attribute for cross-site scripting vulnerability prevention") will only land after 1.8.1.4 (if approved), is there a point in having blocking1.8.1.4 here?

|  | [Jesse Ruderman](/user_profile?user_id=11608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a26058_11608)• 18 years ago |

Flags: blocking1.8.1.4?

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=380418#c4)• 18 years ago |
|  | |

Attached patch

[Proposed patch and mochitest testcase](attachment.cgi?id=264674&action=diff) (obsolete)
— [Details](attachment.cgi?id=264674&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=264674)

Moved the code used to verify request headers into a separate function so that it can be used for response headers as well. There was one functional change - instead of throwing on security manager errors I simply fall back to the "unprivileged script" case, that should be a sane thing to do here. The other relevant test case for this patch is <http://lxr.mozilla.org/mozilla/source/content/base/test/test_bug308484.html>Assignee: xml → trev.mozStatus: NEW → ASSIGNED
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: superreview?(sayrer)
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: review?(jst)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a370614_9186)• 18 years ago |

Flags: blocking1.9? → blocking1.9+

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=380418#c5)• 18 years ago |
|  | |

Comment on [attachment 264674](/attachment.cgi?id=264674 "Proposed patch and mochitest testcase") [[details]](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") [[diff]](/attachment.cgi?id=264674&action=diff "Proposed patch and mochitest testcase") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=264674)
Proposed patch and mochitest testcase
r=jst
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: review?(jst) → review+

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=380418#c6)• 18 years ago |
|  | |

Comment on [attachment 264674](/attachment.cgi?id=264674 "Proposed patch and mochitest testcase") [[details]](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") [[diff]](/attachment.cgi?id=264674&action=diff "Proposed patch and mochitest testcase") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=264674)
Proposed patch and mochitest testcase
>
>+// Request headers not allowed to be set by unprivileged scripts
>+const char \*kInvalidRequestHeaders[] = {
>+ "host", "content-length", "transfer-encoding", "via", "upgrade", nsnull
>+};
note: I'm not an sr. However, this list needs to match the list given by the W3C:
<http://www.w3.org/TR/XMLHttpRequest/#dfn-setrequestheader>
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: superreview?(sayrer) → superreview-

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=380418#c7)• 18 years ago |
|  | |

Robert, this list goes back to [bug 302263](/show_bug.cgi?id=302263 "RESOLVED FIXED - XMLHttpRequest allows dangerous request headers to be set") and the discussion there mentions the WHATWG spec (that is on W3C now). However, some of the forbidden headers actually seem harmless.

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=380418#c8)• 18 years ago |
|  | |

(In reply to [comment #7](/show_bug.cgi?id=380418#c7 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> Robert, this list goes back to [bug 302263](/show_bug.cgi?id=302263 "RESOLVED FIXED - XMLHttpRequest allows dangerous request headers to be set") and the discussion there mentions the
> WHATWG spec (that is on W3C now). However, some of the forbidden headers
> actually seem harmless.
>
Given that discussion, I agree that changing the list doesn't need to happen in this bug. and you need a real sr. :)

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a1304387_109976)• 18 years ago |

[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: superreview- → superreview?(jonas)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a3545670_1689)• 18 years ago |

Flags: blocking1.8.1.5? → blocking1.8.1.5+

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a3872954_109976)• 18 years ago |

Blocks: [178993](/show_bug.cgi?id=178993 "RESOLVED FIXED - MSIE-extension: HttpOnly cookie attribute for cross-site scripting vulnerability prevention")

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=380418#c9)• 18 years ago |
|  | |

Comment on [attachment 264674](/attachment.cgi?id=264674 "Proposed patch and mochitest testcase") [[details]](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") [[diff]](/attachment.cgi?id=264674&action=diff "Proposed patch and mochitest testcase") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=264674)
Proposed patch and mochitest testcase
I'd prefer the the nsHeaderVisitor ctor took an |const char \*\*aInvalidHeaders| argument rather than having a separate setter function. Otherwise it's very easy to forget which is hard to notice but is bad security wise.
sr=me with that
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Flags: superreview?(jonas) → superreview+

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=380418#c10)• 18 years ago |
|  | |

Attached patch

[Patch to be checked in](attachment.cgi?id=270288&action=diff)
— [Details](attachment.cgi?id=270288&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288)

So much about "no arguments constructor com policy" - but yes, fine with me, it makes the code much cleaner.
Requesting approval1.8.1.5 for this patch - [bug 178993](/show_bug.cgi?id=178993 "RESOLVED FIXED - MSIE-extension: HttpOnly cookie attribute for cross-site scripting vulnerability prevention") is landing on 1.8.1 branch so this should as well.
[Attachment #264674](/attachment.cgi?id=264674&action=edit "Proposed patch and mochitest testcase") -
Attachment is obsolete: true
[Attachment #270288](/attachment.cgi?id=270288&action=edit "Patch to be checked in") -
Flags: approval1.8.1.5?

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a4200132_109976)• 18 years ago |

Whiteboard: [checkin needed]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=380418#c11)• 18 years ago |
|  | |

Comment on [attachment 270288](/attachment.cgi?id=270288 "Patch to be checked in") [[details]](/attachment.cgi?id=270288&action=edit "Patch to be checked in") [[diff]](/attachment.cgi?id=270288&action=diff "Patch to be checked in") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288)
Patch to be checked in
This patch makes me nervous -- it looks like you stop reading any cookies, not just the httponly ones mentioned in the summary. I wish this had landed for 1.9a6 so we could get some real-world testing on it, and failing that I don't want to approve it until it's gotten as much trunk nightly baking as possible.
Not minusing, but clearing the request until it's gotten some baking. Please re-request branch approval after landing on trunk.
[Attachment #270288](/attachment.cgi?id=270288&action=edit "Patch to be checked in") -
Flags: approval1.8.1.5?

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=380418#c12)• 18 years ago |
|  | |

The visitor isn't an XPCOM object which makes it ok IMHO. In general we're moving away from restricting ourselves to all the rules of XPCOM except when it makes sence.
The ctor for all DOM nodes takes arguments.
The case when you don't want ctor arguments is when the object is being instantiated using XPCOM through do\_CreateInstance.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a4777973_103593)• 18 years ago |

Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)Whiteboard: [checkin needed]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=380418#c13)• 18 years ago |
|  | |

Without trunk landing I'm too nervous about breaking AJAX sites that rely on the ability to read non-httponly cookies. Maybe there are none, but we don't know that until we try it.Flags: blocking1.8.1.5+ → blocking1.8.1.6?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=380418#c14)• 18 years ago |
|  | |

Comment on [attachment 270288](/attachment.cgi?id=270288 "Patch to be checked in") [[details]](/attachment.cgi?id=270288&action=edit "Patch to be checked in") [[diff]](/attachment.cgi?id=270288&action=diff "Patch to be checked in") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288)
Patch to be checked in
Just tested IE7 and results were what I expected: Given a page that returns a mixture of httponly and regular cookies, IE7 does in fact let XMLHttpRequest see the regular Set-Cookie headers as in the past and strips out only the httponly ones.
I'm afraid I have to give this patch an r-minus
>+ PRBool privileged = PR\_FALSE;
>+ if (privilege) {
>+ nsIScriptSecurityManager \*secMan = nsContentUtils::GetSecurityManager();
>+ if (secMan) {
>+ secMan->IsCapabilityEnabled(privilege,
>+ &privileged);
>+ }
>+ }
Why not replace the above with nsContentUtils::IsCallerTrustedForRead() (or Write()) depending on a boolean flag passed rather than a string?
But I don't think UniversalBrowserRead should be good enough to read a header that is explicitly saying "script should never see this". UniversalXPConnect/chrome, sure, but not just "can access windows from other domains". And I likewise don't think UniversalBrowserWrite is good enough to set headers we've said are dangerous for content to set.
In that case nsContentUtils::IsCallerChrome() ought to cover it (ok, that only checks for true chrome and not the equivalent UniversalXPConnect, but you can argue that everywhere else it's used is similarly broken and we should add the UniversalXPConnect check to IsCallerChrome and fix them all at once).
[Attachment #270288](/attachment.cgi?id=270288&action=edit "Patch to be checked in") -
Flags: review-

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a5160809_109976)• 18 years ago |

Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=380418#c15)• 18 years ago |
|  | |

I take back all I said about IE7 working, I have no idea what RSnake's article is talking about.
getAllResponseHeaders() in IE7 gets \_all\_ response headers, including the httponly cookies.
getResponseHeader() returns the \_first\_ header of a given name. At first I thought this was working because I only had two cookies and the httponly one was second. But when I added a third non-httponly one, or swapped them, or made 5 cookies, it became clear it was just the first cookie set whether it was httponly or not.
Loading the same URL as a web page in IE& and running javascript:alert(document.cookie) showed me the correct number of non-httponly cookies and none of the httponly ones, so I know my Set-Cookie syntax matched what IE expected.Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)Whiteboard: [sg:want]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a5161858_1689)• 18 years ago |

Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=380418#c16)• 18 years ago |
|  | |

hm... if IE only shows one cookie of many then it's hard to imagine AJAX apps relying on XHR cookie access... Maybe we can afford to just drop the header entirely after all.
I'd feel better if we got some buy-in from other browser vendors/web app developers on the webapi mailing list and got some consistent restrictions embedded in the spec (<http://www.w3.org/TR/XMLHttpRequest/>)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=380418#c17)• 18 years ago |
|  | |

IMHO we should drop HTTPOnly cookies and let other cookies through. That seems like the most logical thing. I'll bring this up with the webapi wg

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=380418#c18)• 18 years ago |
|  | |

Drive-by note: you can set custom headers on Mochitest pages without having to do channel gunk, which is much easier to read. I didn't look too hard, but I don't think you actually need anything special that can't be provided by statically-set headers:
<http://developer.mozilla.org/en/docs/Mochitest#How_do_I_change_the_HTTP_headers_or_status_sent_with_a_file_used_in_a_Mochitest.3F>
Do note that you can't set multiple headers that way, which unfortunately might be a problem here. :-\ The server running this stuff was written in the (perhaps too ideal) world where multiple headers of the same name can always be combined into one header of the same name with value being the comma-joined header values, but I can change that if you really need it.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a8832569_1689)• 17 years ago |

Flags: blocking1.8.1.7? → wanted1.8.1.x+Whiteboard: [sg:want] → [sg:want P2]

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=380418#c19)• 17 years ago |
|  | |

Wladimir, are you working on a new patch here? If not, Dan, do you think you could write one up?
I don't care much what access is required to get to the HTTPOnly cookies, i'm fine with never exposing them.
Btw, has anyone notified microsoft of this problem since it seems like IE suffers from it too?Priority: -- → P4

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=380418#c20)• 17 years ago |
|  | |

No, I am not working on this bug - not much time lately, sorry about that.Assignee: trev.moz → nobodyStatus: ASSIGNED → NEWQA Contact: ashshbhatt → xml

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a15696164_180188)• 17 years ago |

Assignee: nobody → sayrer

|  | [Stuart Parmenter](/user_profile?user_id=5756) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a25337332_5756)• 17 years ago |

Flags: wanted1.9.0.x+Flags: tracking1.9+Flags: blocking1.9-

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=380418#c21)• 17 years ago |
|  | |

Are there any plans to move forward on this bug?

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=380418#c22)• 17 years ago |
|  | |

The patch was minused so we would need a new patch for it.

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=380418#c23)• 17 years ago |
|  | |

This is a fairly fundamental security flaw in FireFox that IE7 gets right. I would be thrilled to see any movement on this....

|  | [Mike Shaver (:shaver emeritus)](/user_profile?user_id=422) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=380418#c24)• 17 years ago |
|  | |

Jim: do you mean that we should follow IE7 in exposing http-only cookies in getAllResponseHeaders, but only show the first header in getResponseHeader? Unless Dan's analysis in [comment 15](/show_bug.cgi?id=380418#c15 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") is mistaken -- test cases demonstrating such are very welcome -- it seems like IE also exposes HttpOnly cookies here.

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=380418#c25)• 17 years ago |
|  | |

Mike: No. IE7 quietly ignores requests to read pre-existing HttpOnly cookies via the js calls getAllResponseHeaders and getResponseHeader as it rightly should. However, the set-cookie header still exposes HttpOnly cookies in all browsers (see <http://ha.ckers.org/httponly.cgi> )

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=380418#c26)• 17 years ago |
|  | |

Mike: I will set up a verbose test case to demonstrate what I think I'm talking about.

|  | [Mike Shaver (:shaver emeritus)](/user_profile?user_id=422) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=380418#c27)• 17 years ago |
|  | |

This bug, from [comment 0](/show_bug.cgi?id=380418#c0 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") on, is about reading Set-Cookie, no?
No browser-sent cookies should be in the response headers, since Cookie: is part of the \_request\_, not the response. I look forward to your test case!

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=380418#c28)• 17 years ago |
|  | |

Mike: My apologies, I'm moving to fast. You are right, of course. The only time set-cookies should ever be included in in a response, not a request. And you are right again that RSnakes' post saying that ie7 fixes the XMLHttpRequest HttpOnly cookie exposing issues is wrong. Regardless, can we agree that this should be fixed in FireFox? :) And last, I will set up a verbose test page that the FireFox team can use illustrate this vulnerability.

|  | [Mike Shaver (:shaver emeritus)](/user_profile?user_id=422) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=380418#c29)• 17 years ago |
|  | |

It should be fixed in Firefox, which is why this bug isn't WONTFIX or INVALID. I think the ha.ckers.org page is ample for developing against, though if you wanted to write a mochitest or two (see waldo's [comment 18](/show_bug.cgi?id=380418#c18 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") for some limitations) that would be helpful.

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=380418#c30)• 16 years ago |
|  | |

<http://www.codinghorror.com/blog/archives/001167.html> asserts that this is indeed fixed in IE7, and makes me wonder if we should be moving this up to blocking status on 1.9.1Flags: blocking1.9.1?

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=380418#c31)• 16 years ago |
|  | |

Bjarne, could you take a look at this?Assignee: sayrer → nobodyComponent: XML → Networking: CookiesQA Contact: xml → networking.cookies

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=380418#c32)• 16 years ago |
|  | |

Bjarne, could you take a look at this?Assignee: nobody → bjarne

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=380418#c33)• 16 years ago |
|  | |

I just tested, IE 7.0.6001.18000 still exposes HTTPOnly cookies via set-cookie headers in XMLHttpRequest.getAllResponseHeaders()
From the OWASP WebGoat HTTPOnly lab:
Results:
\* FAILURE: Your browser does not prevent an XMLHTTPRequest read for the 'unique2u' cookie.
However, I would be thrilled to see FireFox lead the charge and be the first browser to truly implement HttpOnly correctly and completely.

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=380418#c34)• 16 years ago |
|  | |

Indeed. We're trying to supply a better alternative to IE, not something that is no worse.Flags: blocking1.9.1? → blocking1.9.1+Priority: P4 → P1

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a42905807_323714)• 16 years ago |

Status: NEW → ASSIGNED

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=380418#c35)• 16 years ago |
|  | |

Attached patch

[Patch fixing the ha.ckers.org/httponly.cgi issue](attachment.cgi?id=339447&action=diff) (obsolete)
— [Details](attachment.cgi?id=339447&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=339447)

This is a proof-of-concept which handles the example at <http://ha.ckers.org/httponly.cgi> . I'm attaching it to get feedback on the basic idea, as well as some issues described below.
The basic idea is to strip off httpOnly-cookies from each Set-Cookie header when nsHeaderVisitor::VisitHeader() assembles the array of response-headers. However, no checks for UniversalBrowserRead or similar (see e.g. [comment #14](/show_bug.cgi?id=380418#c14 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") above) are done. Please advise whether this is necessary or not. Moreover, if nsHeaderVisitor::VisitHeader() is used in other contexts, the implementation may have to be improved. Please advise.
Some more challenging test-cases should also be provided to ensure that it works properly, in particular the situation where there are only httpOnly cookies in a header : Should we just drop the header or should we return an empty set-cookie header?
Finally, referring to the TODO in the patch, if it's ok to introduce a dependency to the netwerk/cookie module, we could use the static method nsCookieService::GetTokenValue() instead of copying the code. Please advise.
[Attachment #339447](/attachment.cgi?id=339447&action=edit "Patch fixing the ha.ckers.org/httponly.cgi issue") -
Flags: review?(jonas)

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=380418#c36)• 16 years ago |
|  | |

In the case where there are only httpOnly cookies in a set-cookie header, I suggest the entire set-cookie header be removed from JS visibility.

|  | [Damon Sicore (:damons)](/user_profile?user_id=269330) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=380418#c37)• 16 years ago |
|  | |

Is this REALLY a beta 1 blocker? We'd push back 3.1 for this?

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=380418#c38)• 16 years ago |
|  | |

I would prefer to keep this on the blocker list yes.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=380418#c39)• 16 years ago |
|  | |

Attached patch

[Improved patch](attachment.cgi?id=340906&action=diff) (obsolete)
— [Details](attachment.cgi?id=340906&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=340906)

I completely agree with [comment #36](/show_bug.cgi?id=380418#c36 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"), and the patch implements this behavior.
Moreover, I find no code other than GetAllReponseHeaders() referring to nsHeaderVisitor, and I find no calls to GetAllReponseHeaders() in the codebase either. Thus, I seems safe to assume that this change in nsHeaderVisitor::VisitHeader() will not introduce regressions. However, this is obviously just based on reading the code and must be verified during normal test-procedures.
Awaiting review as well as comments to these open questions :
1) Referring to the TODO in the patch, is it ok to introduce a dependency to the netwerk/cookie module? If so, we could use the static method nsCookieService::GetTokenValue() instead of copying code into nsXMLHttpRequest
2) Do we need checks for UniversalBrowserRead or similar (see e.g. [comment #14](/show_bug.cgi?id=380418#c14 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")) or do we trust the claim about not introducing regressions? Or put in a different way : are there any scripts that SHOULD be allowed to see httpOnly-cookies?
3) Tests are needed. I can whip up some unit-tests or something one of these days, but if other people are working on this (see [comment #26](/show_bug.cgi?id=380418#c26 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") and [comment #28](/show_bug.cgi?id=380418#c28 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")), I'd be happy to wait.
[Attachment #339447](/attachment.cgi?id=339447&action=edit "Patch fixing the ha.ckers.org/httponly.cgi issue") -
Attachment is obsolete: true
[Attachment #340906](/attachment.cgi?id=340906&action=edit "Improved patch") -
Flags: review?(jonas)
[Attachment #339447](/attachment.cgi?id=339447&action=edit "Patch fixing the ha.ckers.org/httponly.cgi issue") -
Flags: review?(jonas)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=380418#c40)• 16 years ago |
|  | |

Setting to P2 as this doesn't need to be in beta1.Priority: P1 → P2

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=380418#c41)• 16 years ago |
|  | |

Should I proceed and create some tests for this?

|  | [Robert Sayre](/user_profile?user_id=180188) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=380418#c42)• 16 years ago |
|  | |

Yes, tests are needed.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=380418#c43)• 16 years ago |
|  | |

Ok, I'll get started on them on Monday. If anyone has a starting-point or ideas, feel free to contact me. :)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=380418#c44)• 16 years ago |
|  | |

You are only fixing getAllResponseHeaders, need to fix getResponseHeader as well.
So I'm not sure that we want to do things this way. It seems very complicated. I think we should simply deny access to the cookie and auth headers entirely.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=380418#c45)• 16 years ago |
|  | |

(In reply to [comment #44](/show_bug.cgi?id=380418#c44 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> You are only fixing getAllResponseHeaders, need to fix getResponseHeader as
> well.
I can quickly fix getResponseHeader using the same mechanism on Monday.
> So I'm not sure that we want to do things this way. It seems very complicated.
The fundamental idea is to return a copy of the cookies, exactly like the original code does, but strip off those marked as httponly. This, imho, is not highly complicated. :)
The patch itself contains a lot of code, I agree, but most of it is cut'n'paste from another module since I didn't want to mess around with the Makefile-magic necessary to access those methods from nsXMLHttpRequest. See open question 1 in [comment #39](/show_bug.cgi?id=380418#c39 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") and comment in the patch. Thus, most of the code can be removed if it's ok to introduce a dependency like that - I'm awaiting a decision or recommendation on this one.
> I think we should simply deny access to the cookie and auth headers entirely.
About (other) auth headers : It's the first time I've seen that mentioned in this defect. Is this an issue as well? Is there a discussion or defect about that somewhere? Test-case?
My understanding from the discussion in this defect is that the desired behaviour is to allow access to cookies except for the httponly ones. This has been implemented for getAllResponseHeaders and I can also do it for getResponseHeader. If this is \*not\* the desired behaviour, however, I'd be happy to implement something else. Just let me know what it should be. :)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=380418#c46)• 16 years ago |
|  | |

Attached file
[Proposed test-skeleton](attachment.cgi?id=342871) (obsolete)
— [Details](attachment.cgi?id=342871&action=edit)

This is a starting-point for a test-case. Comments are welcome.
The idea is to extend the test by adding to the global cookies-array with combinations of cookies to be set by the server and the expected value of the Set-Cookie-header.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=380418#c47)• 16 years ago |
|  | |

I see from comments in nsCookieService::ParseAttributes() that the cookie-implementation explicitly does not handle comma-separated cookies in one header, but rather require \n or \r to separate them. Must be fixed in the test-code...

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=380418#c48)• 16 years ago |
|  | |

Challenge : Combine the statement in [comment #47](/show_bug.cgi?id=380418#c47 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") with these facts about how nsHttpServer set header-values
1) if the value in the call response.setHeader(name, value) contains \n or \r, an NS\_ERROR\_INVALID\_ARG exception is thrown
2) splitting the value around \n or \r and call response.setHeader(name, value, true) for each cookie results in a header with a list of comma-separated values (as stated in RFC 2616, section 4.2)
Summing up : the (xpcshell) unit-test cannot use commas to separate cookies since the code from nsCookieService does not handle comma-separated cookies. Moreover, response.setHeader() in nsHttpServer will either construct a comma-separated list of cookies, or throw an exception if the cookies are separated with \n or \r.
I'll change the copied code to handle comma-separated cookies...

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=380418#c49)• 16 years ago |
|  | |

So I absolutely don't think we should duplicate this code. This is security critical code so it's important that we keep it consistent everywhere.
So either we should do the simple thing and block all 'Set-Cookie' headers completely. Or we should muck around with the APIs such that you can call into the same parsing function as the real cookie code is using.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=380418#c50)• 16 years ago |
|  | |

(In reply to [comment #49](/show_bug.cgi?id=380418#c49 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> So I absolutely don't think we should duplicate this code. This is security
> critical code so it's important that we keep it consistent everywhere.
>
> So either we should do the simple thing and block all 'Set-Cookie' headers
> completely. Or we should muck around with the APIs such that you can call into
> the same parsing function as the real cookie code is using.
I couldn't agree more. :) If the decision is to strip off httponly cookies and show the rest, the only sensible solution is to tap into the code used in the cookie-module. The other strategy (block Set-Cookie headers) is dead simple to implement...
However, I'm almost there with a patch to handle commas. I'll attach it together with a working unit-test to verify that the concept is sound. Are there existing tests for cookies somewhere that I can use to verify my code in addition to my unit-test?
(Btw, there is also [bug #370639](/show_bug.cgi?id=370639 "RESOLVED INCOMPLETE - Using comma (\",\") delimiter instead \";\" (semi-colon) in Cookie header by default is not useful") which points out an interesting issue, although not 100% related to this one.)

|  | [dwitte@gmail.com](/user_profile?user_id=75420) |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=380418#c51)• 16 years ago |
|  | |

(In reply to [comment #49](/show_bug.cgi?id=380418#c49 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> So I absolutely don't think we should duplicate this code. This is security
> critical code so it's important that we keep it consistent everywhere.
i agree with sicking here - no way should this be copy-paste. if we really do want a subset of cookies, let's API it up.
why aren't we just removing them altogether ([comment 16](/show_bug.cgi?id=380418#c16 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") and [comment 17](/show_bug.cgi?id=380418#c17 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))? sicking, did anything come of the webapi wg?
(In reply to [comment #50](/show_bug.cgi?id=380418#c50 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> However, I'm almost there with a patch to handle commas. I'll attach it
> together with a working unit-test to verify that the concept is sound. Are
> there existing tests for cookies somewhere that I can use to verify my code in
> addition to my unit-test?
yes, there's a TestCookie binary unit test in netwerk/test or somesuch, and there are cookie mochitests based in extensions/cookie/test{s}.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=380418#c52)• 16 years ago |
|  | |

Attached patch

[Improved patch for getAllResponseHeaders, handling comma-separated cookies](attachment.cgi?id=343113&action=diff)
— [Details](attachment.cgi?id=343113&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343113)

This is work-in-progress. I want to run this through the other cookie-tests as well as the attached unit-test.
(Comments are very welcome, though :) )
[Attachment #340906](/attachment.cgi?id=340906&action=edit "Improved patch") -
Attachment is obsolete: true
[Attachment #340906](/attachment.cgi?id=340906&action=edit "Improved patch") -
Flags: review?(jonas)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=380418#c53)• 16 years ago |
|  | |

Attached file
[Improved unit-test](attachment.cgi?id=343114)
— [Details](attachment.cgi?id=343114&action=edit)

This includes some variations. Feel free to add other tricky cases...
[Attachment #342871](/attachment.cgi?id=342871&action=edit "Proposed test-skeleton") -
Attachment is obsolete: true

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=380418#c54)• 16 years ago |
|  | |

So this looks like it's still duplicating the cookie code rather than reusing
it, right?

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=380418#c55)• 16 years ago |
|  | |

(In reply to [comment #54](/show_bug.cgi?id=380418#c54 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> So this looks like it's still duplicating the cookie code rather than reusing
> it, right?
Yes, by all means. :) But the cookie code I found and copied does not handle comma-separated cookies. This patch handles commas, and because of this I can now run the unit-test and verify that the strategy for removing httponly-cookies works.
(If there is other code somewhere which does handle cookies separated by commas, please point me to it...)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=380418#c56)• 16 years ago |
|  | |

I spent the day patching nsCookieService::GetTokenValue(). All tests in the TestCookie binary as well as cookie-mochitests run successfully with it, and I'll attach it a little later. The same code pasted into nsXMLHttpRequest also successfully run the previously attached unit-tests for this defect.
Now, I would like to outline three different strategies for handling this defect. Deciding which one to follow is not up to me, but I assume the right stakeholder(s) will make the decision.
Listed from simplest to most complex, I see these alternatives :
Alt #1 : We block access to the Set-Cookie-header from getAllResponseHeaders() and getResponseHeader(). This is simple to do, but may not be the most helpful strategy for the users.
Alt #2 : We use the existing nsCookieService::GetTokenValue() and in order to get a proper unit-test I fix nsHttpServer to handle cookies separated by \n and \r. This is safe and should not be too hard to do, but I need some assistance to expose the method from the cookie-module. (I can make it compile, but the linker complains, so I guess the method must be annotated somehow to export it from the lib.)
Alt #3 : We patch nsCookieService::GetTokenValue() to handle comma-separated cookies and expose it in order to use it from nsXMLHttpRequest. The unit-test for this defect will work with the existing nsHttpServer, but I still need assistance to expose the method from the cookie-module. This is by far the most risky alternative, replacing code in the cookie-module, but if there are reasons for actually following RFCs 2109 and 2965, allowing cookies to be separated by commas, then this is the right alternative.
I'll await a decision and attach the mentioned patch for information a little later when I have cleaned up the code.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=380418#c57)• 16 years ago |
|  | |

Attached patch

[Patch to nsCookieService.cpp allowing comma as cookie-separator](attachment.cgi?id=343289&action=diff)
— [Details](attachment.cgi?id=343289&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343289)

Referring to alternative #3 above, this is the necessary patch to the cookie-parser.

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=380418#c58)• 16 years ago |
|  | |

Why would we want to change how the cookie service parses anything at all? That scares me a lot. Comma separated cookies results in a ambiguous syntax as I recall it since the expire date can contain commas. Parsing cookies in a web compatible way (which is very different from any specs) is hard and very quirky. And security critical.
\*if\* we want to expose Set-Cookie at all I think we should reuse the existing code exactly as it is. Just make changes needed to expose the existing parsing functionality though APIs that the XHR object can reach.
However the more I think about it the more I think we should just block getting Set-Cookie at all. Cookies are way too charged with security, we have no idea what future updates to cookies might bring. And the value of getting Set-Cookie seems dubious at best.
So unless someone oppose, lets just block getting Set-Cookie entirely.

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 59](/show_bug.cgi?id=380418#c59)• 16 years ago |
|  | |

Attached patch

[Patch to nsXMLHttpRequest.cpp implementing the simplest solution](attachment.cgi?id=343383&action=diff) (obsolete)
— [Details](attachment.cgi?id=343383&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343383)

Currently, scripts with chrome-privileges are allowed to see the Set-Cookie header. Whether this is desirable is an open question. Whether to block the Set-Cookie2 header as well is also an open question.
I have a hard time setting up a unit-test for this since xpcshell-scripts run with chrome-privileges and so does mochitests (according to the docs). Thus, there is no unit-test submitted and the fix has only been verified using the ha.ckers.org webpage. The code-change is trivial, though... If somebody can show me how to run a test \*without\* chrome-privileges I'd be happy to write one for this defect.
[Attachment #343383](/attachment.cgi?id=343383&action=edit "Patch to nsXMLHttpRequest.cpp implementing the simplest solution") -
Flags: review?(jonas)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 60](/show_bug.cgi?id=380418#c60)• 16 years ago |
|  | |

(In reply to [comment #58](/show_bug.cgi?id=380418#c58 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> Why would we want to change how the cookie service parses anything at all? That
> scares me a lot.
Me too, for sure. :)
> Comma separated cookies results in a ambiguous syntax as I
> recall it since the expire date can contain commas.
This seems to be covered by some of the existing cookie-tests, and it is handled by the patch.
> Parsing cookies in a web
> compatible way (which is very different from any specs) is hard and very
> quirky. And security critical.
We don't disagree here. :)
> \*if\* we want to expose Set-Cookie at all I think we should reuse the existing
> code exactly as it is. Just make changes needed to expose the existing parsing
> functionality though APIs that the XHR object can reach.
I'm leaning towards this one (alternative 2 in [comment #56](/show_bug.cgi?id=380418#c56 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")). However, if there is any desire for supporting comma-separated cookies among whoever is working with the cookie-module, then the submitted patch handles commas and passes all existing cookie-tests. It's still a bit scary, though... :)
> However the more I think about it the more I think we should just block getting
> Set-Cookie at all. Cookies are way too charged with security, we have no idea
> what future updates to cookies might bring. And the value of getting Set-Cookie
> seems dubious at best.
>
>
> So unless someone oppose, lets just block getting Set-Cookie entirely.
Very well. See patch above. :)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 61](/show_bug.cgi?id=380418#c61)• 16 years ago |
|  | |

Btw, while working on this I found some possibly related (not duplicated) defects : defect #250859 and defect #358320. Defect #370639 has already been mentioned in [comment #50](/show_bug.cgi?id=380418#c50 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"), although this is about constructing the cookie-string to send.

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 62](/show_bug.cgi?id=380418#c62)• 16 years ago |
|  | |

How about un-bitrotting [attachment 270288](/attachment.cgi?id=270288 "Patch to be checked in") [[details]](/attachment.cgi?id=270288&action=edit "Patch to be checked in") [[diff]](/attachment.cgi?id=270288&action=diff "Patch to be checked in") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288) and replacing security checks by nsContentUtils::IsCallerChrome()? It has a unit test as well ;)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 63](/show_bug.cgi?id=380418#c63)• 16 years ago |
|  | |

(In reply to [comment #62](/show_bug.cgi?id=380418#c62 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> How about un-bitrotting [attachment 270288](/attachment.cgi?id=270288 "Patch to be checked in") [[details]](/attachment.cgi?id=270288&action=edit "Patch to be checked in") [[diff]](/attachment.cgi?id=270288&action=diff "Patch to be checked in") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=270288) and replacing security checks by
> nsContentUtils::IsCallerChrome()?
Good point... :) If the decision really is to follow the simplest strategy and just block the header, your original patch with the suggested modification will probably do the trick. Sicking...? Dveditz...?
> It has a unit test as well ;)
... which seems to be just what I was asking for... wish I'd discovered it earlier today... :-}

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 64](/show_bug.cgi?id=380418#c64)• 16 years ago |
|  | |

If you use IsCapabilityEnabled("UniversalXPConnect") rather than nsContentUtils::IsCallerChrome you can easily test for that using mochitest directly. See
<http://developer.mozilla.org/en/Mochitest#How_can_I_get_around_the_error_.22Permission_denied_to_get_property_XPCComponents.classes.22.3f>

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 65](/show_bug.cgi?id=380418#c65)• 16 years ago |
|  | |

Attached patch

[Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant](attachment.cgi?id=343525&action=diff) (obsolete)
— [Details](attachment.cgi?id=343525&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343525)

Validations in setRequestHeader() resulting from [bug #302263](/show_bug.cgi?id=302263 "RESOLVED FIXED - XMLHttpRequest allows dangerous request headers to be set") is not touched by this patch. However, it should be pointed out that UniversalBrowserWrite is sufficient to pass these validations, which may not be good enough (see [comment #14](/show_bug.cgi?id=380418#c14 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")).
The unit-test is a clean copy of the (excellent) one by Wladimir Palant.
For the record : I still think strategies 2 and 3 from [comment #56](/show_bug.cgi?id=380418#c56 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") will result in an overall better product, but this is not my call. :)
[Attachment #343383](/attachment.cgi?id=343383&action=edit "Patch to nsXMLHttpRequest.cpp implementing the simplest solution") -
Attachment is obsolete: true
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Flags: review?(jonas)
[Attachment #343383](/attachment.cgi?id=343383&action=edit "Patch to nsXMLHttpRequest.cpp implementing the simplest solution") -
Flags: review?(jonas)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 66](/show_bug.cgi?id=380418#c66)• 16 years ago |
|  | |

Comment on [attachment 343525](/attachment.cgi?id=343525 "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[details]](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[diff]](/attachment.cgi?id=343525&action=diff "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343525)
Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant
This looks great!! Thanks for doing this.
An alternative way to getting the channel and calling setResponseHeader is to use ^header^ files to actually get those headers set. See
<http://developer.mozilla.org/en/Mochitest#How_do_I_change_the_HTTP_headers_or_status_sent_with_a_file_used_in_a_Mochitest.3f>
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Flags: superreview+
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Flags: review?(jonas)
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Flags: review+

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 67](/show_bug.cgi?id=380418#c67)• 16 years ago |
|  | |

Comment on [attachment 343525](/attachment.cgi?id=343525 "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[details]](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[diff]](/attachment.cgi?id=343525&action=diff "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=343525)
Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant
So I was told that we should block Set-Cookie2 as well since some browsers implement that.
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Flags: review+ → review-

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 68](/show_bug.cgi?id=380418#c68)• 16 years ago |
|  | |

Attached patch

[Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]](attachment.cgi?id=345336&action=diff)
— [Details](attachment.cgi?id=345336&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336)

Also modified unit-test according to comments from reviewer.
[Attachment #343525](/attachment.cgi?id=343525&action=edit "Patch implementing the simplest strategy, honoring comments from reviewer and including unit-test by Wladimir Palant") -
Attachment is obsolete: true
[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: review?(jonas)

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 69](/show_bug.cgi?id=380418#c69)• 16 years ago |
|  | |

Comment on [attachment 345336](/attachment.cgi?id=345336 "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[details]](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[diff]](/attachment.cgi?id=345336&action=diff "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336)
Patch also blocking Set-Cookie2 header
[Checkin: [Comment 85](/show_bug.cgi?id=380418#c85 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")]
>+ // Try reading headers in privileged context
>+ netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect UniversalBrowserRead");
>+ is(request.getResponseHeader("Set-Cookie"), "test", "Reading Set-Cookie response header in privileged context");
>+ is(request.getResponseHeader("Set-Cookie2"), "test2", "Reading Set-Cookie2 response header in privileged context");
>+ is(request.getResponseHeader("X-Dummy"), "test", "Reading X-Dummy response header in privileged context");
>+
>+ ok(/\bSet-Cookie:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie in all response headers in privileged context");
>+ ok(/\bSet-Cookie2:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie2 in all response headers in privileged context");
>+ ok(/\bX-Dummy:/i.test(request.getAllResponseHeaders()), "Looking for X-Dummy in all response headers in privileged context");
>+
>+ // Try reading headers in unprivileged context
>+ setTimeout(function() {
>+ is(request.getResponseHeader("Set-Cookie"), null, "Reading Set-Cookie response header in unprivileged context");
>+ is(request.getResponseHeader("Set-Cookie2"), null, "Reading Set-Cookie2 response header in unprivileged context");
>+ is(request.getResponseHeader("X-Dummy"), "test", "Reading X-Dummy response header in unprivileged context");
>+
>+ ok(!/\bSet-Cookie:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie in all response headers in unprivileged context");
>+ ok(!/\bSet-Cookie2:/i.test(request.getAllResponseHeaders()), "Looking for Set-Cookie2 in all response headers in unprivileged context");
>+ ok(/\bX-Dummy:/i.test(request.getAllResponseHeaders()), "Looking for X-Dummy in all response headers in unprivileged context");
>+
>+ SimpleTest.finish();
>+ }, 0);
Nit: If you first check that Set-Cookie is normally blocked, \*then\* call netscape.security.PrivilegeManager.enablePrivilege, and then check that you now can get to it, you won't have to mess with setting a timeout.
r/sr=me either way.
[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: superreview+
[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: review?(jonas)
[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: review+

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 70](/show_bug.cgi?id=380418#c70)• 16 years ago |
|  | |

Added request for check-in (I think).Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 71](/show_bug.cgi?id=380418#c71)• 16 years ago |
|  | |

Anything else needed to get this landed...?

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 72](/show_bug.cgi?id=380418#c72)• 16 years ago |
|  | |

Nope, just gotta wait until the tree reopens.

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 73](/show_bug.cgi?id=380418#c73)• 16 years ago |
|  | |

Supposedly, Microsoft fixed that issue in MS08-069 released today (<http://www.microsoft.com/technet/security/bulletin/ms08-069.mspx>). "MSXML Header Request Vulnerability" describes a different issue however.

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 74](/show_bug.cgi?id=380418#c74)• 16 years ago |
|  | |

Sigh, don't we have anyone watching the checkin-needed flag these days? Or is the tree simply too backed up with bigger things needing to land?

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 75](/show_bug.cgi?id=380418#c75)• 16 years ago |
|  | |

Added to the 1.9.1 metered checkin list

|  | [Bjarne (:bjarne)](/user_profile?user_id=323714)  Assignee |  |
| --- | --- | --- |
| [Comment 76](/show_bug.cgi?id=380418#c76)• 16 years ago |
|  | |

(In reply to [comment #73](/show_bug.cgi?id=380418#c73 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> Supposedly, Microsoft fixed that issue in MS08-069 released today
> (<http://www.microsoft.com/technet/security/bulletin/ms08-069.mspx>). "MSXML
> Header Request Vulnerability" describes a different issue however.
Does anyone know how they handle it? Do they just block the header, like the patch for this defect does, or do they filter out only httponly-cookies? (I don't have a MS-system available to test it myself...)

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 77](/show_bug.cgi?id=380418#c77)• 16 years ago |
|  | |

Just checked with IE6 after update - request.getResponseHeader() displays the cookie without httponly flag, request.getAllResponseHeaders() displays Set-Cookie header for the unprotected cookie but not the cookie with httponly flag. So IE really only filters out httponly-cookies.

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 78](/show_bug.cgi?id=380418#c78)• 16 years ago |
|  | |

If you have a mixture of both "normal" and httponly cookies, do they only block the httponly ones, or do they block all of them?
Either way, I think we should try our solution due to its simplicity.

|  | [Wladimir Palant](/user_profile?user_id=109976)  Reporter |  |
| --- | --- | --- |
| [Comment 79](/show_bug.cgi?id=380418#c79)• 16 years ago |
|  | |

I tested on <http://ha.ckers.org/httponly.cgi> - yes, they filter out httponly cookie while letting through the normal one. And of course I prefer the simple solution as well.

|  | [Dave Townsend [:mossop]](/user_profile?user_id=91159) |  |
| --- | --- | --- |
| [Comment 80](/show_bug.cgi?id=380418#c80)• 16 years ago |
|  | |

I've removed this from the b2 checkin queue because it is not a b2 blocker nor does it have approval-1.9.1b2

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a47702252_103593)• 16 years ago |

[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: approval1.9.1b2?

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Comment 81](/show_bug.cgi?id=380418#c81)• 16 years ago |
|  | |

Comment on [attachment 345336](/attachment.cgi?id=345336 "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[details]](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[diff]](/attachment.cgi?id=345336&action=diff "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336)
Patch also blocking Set-Cookie2 header
[Checkin: [Comment 85](/show_bug.cgi?id=380418#c85 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")]
Seems to me that we need to take this for b2 if we're going to take it at all...

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 82](/show_bug.cgi?id=380418#c82)• 16 years ago |
|  | |

Gavin: Why? The main reason I see for taking this for beta is so that we can get wide trunk testing sooner in order for porting it to branch. Had a discussion with damon about this at lunch and he was in favor of just letting the branch porting wait.

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Comment 83](/show_bug.cgi?id=380418#c83)• 16 years ago |
|  | |

Because it looked to me like a change that should get wide testing before we ship it. You're in a better position to judge that than I though - feel free to cancel the approval request!

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 84](/show_bug.cgi?id=380418#c84)• 16 years ago |
|  | |

Yeah, that's actually true, if we're not having a beta3 then I think this really should go in for beta2. Talked with jst and he things we should get it in now, so setting as beta2 blocker and re-adding to metered landings.Priority: P2 → P1Target Milestone: --- → mozilla1.9.1b2

|  | [:Gavin Sharp [email: gavin@gavinsharp.com]](/user_profile?user_id=103593) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a47719566_103593)• 16 years ago |

[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: approval1.9.1b2?

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Comment 85](/show_bug.cgi?id=380418#c85)• 16 years ago |
|  | |

Checked in, marking FIXED.

|  | [Johnny Stenback (:jst)](/user_profile?user_id=12352) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a47742591_12352)• 16 years ago |

Status: ASSIGNED → RESOLVEDClosed: 16 years agoResolution: --- → FIXED

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 86](/show_bug.cgi?id=380418#c86)• 16 years ago |
|  | |

Looks like IE's recent patch (<http://www.microsoft.com/technet/security/bulletin/ms08-069.mspx>) now stops set-cookie exposure to HTTPOnly cookies via JavaScript - but not set-cookie2 HTTPOnly exposure. <http://ha.ckers.org/httponly.cgi> was updated to include set-cookie and set-cookie2 tests today, btw.

|  | [marius schilder](/user_profile?user_id=90076) |  |
| --- | --- | --- |
| [Comment 87](/show_bug.cgi?id=380418#c87)• 16 years ago |
|  | |

Note IE does not return a single Set-Cookie header. As such, getResponseHeader('Set-Cookie') now only returns the first non-httponly Set-Cookie header. But that probable made it simpler for them to just filter the httponly Set-Cookie headers.
Also note, combining Set-Cookie headers with a comma separator has issues with comma being a legal value in an individual Set-Cookie header.
I doubt there are useful apps out there that rely on being able to parse Set-Cookie headers from getAllResponseHeaders(). If there are, we might be breaking more of them by combining multiple Set-Cookie headers into a single one already.

|  | [Serge Gautherie (:sgautherie)](/user_profile?user_id=49577) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a49493051_49577)• 16 years ago |

[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Attachment description: Patch also blocking Set-Cookie2 header → Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]

|  | [Serge Gautherie (:sgautherie)](/user_profile?user_id=49577) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a49493431_49577)• 16 years ago |

Whiteboard: [sg:want P2] → [c-n: has baked for 1.9.1] [sg:want P2]

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 88](/show_bug.cgi?id=380418#c88)• 16 years ago |
|  | |

Wasn't this checked in before we branched? If so, why the status whiteboard?

|  | [Serge Gautherie (:sgautherie)](/user_profile?user_id=49577) |  |
| --- | --- | --- |
| [Comment 89](/show_bug.cgi?id=380418#c89)• 16 years ago |
|  | |

(In reply to [comment #88](/show_bug.cgi?id=380418#c88 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies"))
> Wasn't this checked in before we branched? If so, why the status whiteboard?
You're right: I was misleaded by the leftover 'checkin-needed' keyword...Flags: in-testsuite+Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)Whiteboard: [c-n: has baked for 1.9.1] [sg:want P2] → [sg:want P2]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 90](/show_bug.cgi?id=380418#c90)• 16 years ago |
|  | |

Comment on [attachment 345336](/attachment.cgi?id=345336 "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[details]](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[diff]](/attachment.cgi?id=345336&action=diff "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336)
Patch also blocking Set-Cookie2 header
[Checkin: [Comment 85](/show_bug.cgi?id=380418#c85 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")]
3.0.6 might be too aggressive, but we do want this on 3.0 after we've gotten enough real-world 3.1beta testing.
[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: approval1.9.0.6?

|  | [Samuel Sidler (old account; do not CC)](/user_profile?user_id=190622) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a50048512_190622)• 16 years ago |

Whiteboard: [sg:want P2] → [sg:want P2][needs baking; check on 12/17]

|  | [Mike Beltzner [:beltzner, not reading bugmail]](/user_profile?user_id=137548) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a50049260_137548)• 16 years ago |

Keywords: [fixed1.9.1](/buglist.cgi?keywords=fixed1.9.1&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a50660558_1689)• 16 years ago |

Flags: blocking1.9.0.6?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a50811415_1689)• 16 years ago |

Flags: blocking1.9.0.6? → blocking1.9.0.6+Whiteboard: [sg:want P2][needs baking; check on 12/17] → [sg:want P2]

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 91](/show_bug.cgi?id=380418#c91)• 16 years ago |
|  | |

Comon, be brave - push it out! IE already fixed this problem with <http://www.microsoft.com/technet/security/bulletin/ms08-069.mspx> - SO CLOSE but no cigar - IE still leaks set-cookie2 cookie headers. If you push this out, FireFox will truly be the first browser to implement HTTPOnly completely. It will impress the girls!

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a51071803_1689)• 16 years ago |

[Attachment #345336](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header
[Checkin: Comment 85]") -
Flags: approval1.9.0.6? → approval1.9.0.6+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 92](/show_bug.cgi?id=380418#c92)• 16 years ago |
|  | |

Comment on [attachment 345336](/attachment.cgi?id=345336 "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[details]](/attachment.cgi?id=345336&action=edit "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[diff]](/attachment.cgi?id=345336&action=diff "Patch also blocking Set-Cookie2 header [Checkin: Comment 85]") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=345336)
Patch also blocking Set-Cookie2 header
[Checkin: [Comment 85](/show_bug.cgi?id=380418#c85 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies")]
Approved for 1.9.0.6, a=dveditz for release-drivers.

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 93](/show_bug.cgi?id=380418#c93)• 16 years ago |
|  | |

Attached patch

[for 1.8.1](attachment.cgi?id=355351&action=diff)
— [Details](attachment.cgi?id=355351&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355351)

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 94](/show_bug.cgi?id=380418#c94)• 16 years ago |
|  | |

Attached patch

[for 1.8.0](attachment.cgi?id=355353&action=diff)
— [Details](attachment.cgi?id=355353&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355353)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 95](/show_bug.cgi?id=380418#c95)• 16 years ago |
|  | |

Checked into 1.9.0 branchKeywords: [fixed1.9.0.6](/buglist.cgi?keywords=fixed1.9.0.6&resolution=---)

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 96](/show_bug.cgi?id=380418#c96)• 16 years ago |
|  | |

Comment on [attachment 355351](/attachment.cgi?id=355351 "for 1.8.1") [[details]](/attachment.cgi?id=355351&action=edit "for 1.8.1") [[diff]](/attachment.cgi?id=355351&action=diff "for 1.8.1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355351)
for 1.8.1
please approve for 1.8 branches.
[Attachment #355351](/attachment.cgi?id=355351&action=edit "for 1.8.1") -
Flags: approval1.8.1.next?
[Attachment #355351](/attachment.cgi?id=355351&action=edit "for 1.8.1") -
Flags: approval1.8.0.next?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 97](/show_bug.cgi?id=380418#c97)• 16 years ago |
|  | |

Comment on [attachment 355351](/attachment.cgi?id=355351 "for 1.8.1") [[details]](/attachment.cgi?id=355351&action=edit "for 1.8.1") [[diff]](/attachment.cgi?id=355351&action=diff "for 1.8.1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355351)
for 1.8.1
a=dveditz for 1.8.1-branch
[Attachment #355351](/attachment.cgi?id=355351&action=edit "for 1.8.1") -
Flags: approval1.8.1.next?
[Attachment #355351](/attachment.cgi?id=355351&action=edit "for 1.8.1") -
Flags: approval1.8.1.next+
[Attachment #355351](/attachment.cgi?id=355351&action=edit "for 1.8.1") -
Flags: approval1.8.0.next?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 98](/show_bug.cgi?id=380418#c98)• 16 years ago |
|  | |

Comment on [attachment 355353](/attachment.cgi?id=355353 "for 1.8.0") [[details]](/attachment.cgi?id=355353&action=edit "for 1.8.0") [[diff]](/attachment.cgi?id=355353&action=diff "for 1.8.0") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355353)
for 1.8.0
a=dveditz for 1.8.0 branch, but I don't have permission to set the '+' flag.
[Attachment #355353](/attachment.cgi?id=355353&action=edit "for 1.8.0") -
Flags: approval1.8.0.next?

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a52551089_113760)• 16 years ago |

[Attachment #355353](/attachment.cgi?id=355353&action=edit "for 1.8.0") -
Flags: approval1.8.0.next? → approval1.8.0.next+

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 99](/show_bug.cgi?id=380418#c99)• 16 years ago |
|  | |

Comment on [attachment 355353](/attachment.cgi?id=355353 "for 1.8.0") [[details]](/attachment.cgi?id=355353&action=edit "for 1.8.0") [[diff]](/attachment.cgi?id=355353&action=diff "for 1.8.0") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355353)
for 1.8.0
a=asac for 1.8.0

|  | [Alexander Sack](/user_profile?user_id=113760) |  |
| --- | --- | --- |
| [Comment 100](/show_bug.cgi?id=380418#c100)• 16 years ago |
|  | |

committed [attachment 355351](/attachment.cgi?id=355351 "for 1.8.1") [[details]](/attachment.cgi?id=355351&action=edit "for 1.8.1") [[diff]](/attachment.cgi?id=355351&action=diff "for 1.8.1") [[review]](/page.cgi?id=splinter.html&ignore=&bug=380418&attachment=355351) to MOZILLA\_1\_8\_BRANCH:
Checking in content/base/src/nsXMLHttpRequest.cpp;
/cvsroot/mozilla/content/base/src/nsXMLHttpRequest.cpp,v <-- nsXMLHttpRequest.cpp
new revision: 1.156.2.22; previous revision: 1.156.2.21
doneKeywords: [fixed1.8.1.21](/buglist.cgi?keywords=fixed1.8.1.21&resolution=---)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 101](/show_bug.cgi?id=380418#c101)• 16 years ago |
|  | |

Verified this for 1.9.0.6 with the original case in [comment 0](/show_bug.cgi?id=380418#c0 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") using Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.0.6pre) Gecko/2009011304 GranParadiso/3.0.6pre.Keywords: [fixed1.9.0.6](/buglist.cgi?keywords=fixed1.9.0.6&resolution=---) → [verified1.9.0.6](/buglist.cgi?keywords=verified1.9.0.6&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a54806879_1689)• 16 years ago |

Alias: CVE-2009-0357

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 102](/show_bug.cgi?id=380418#c102)• 16 years ago |
|  | |

You are all champions! FireFox 3.0.0.6 is the first browser to truly offer complete and comprehensive HTTPOnly support! <http://manicode.blogspot.com/2009/02/firefox-3006-httponly-champion.html>
My hats off to you all, beer is on me!

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 103](/show_bug.cgi?id=380418#c103)• 16 years ago |
|  | |

Robert Hansen was not fond of the fact that ALL cookies were removed from the XHR response headers via JS access. I'm not sure I agree, but felt it prudent to pass his thoughts your way. What do you think?
(from Robert Hansen re: The fact that all set-cookie/2 calls were removed from response headers)
That's kind of a bug (or at minimum a bad feature). XHR should allow any headers to be viewed that don't have the HTTPOnly flag. Who knows, maybe some web developers use XMLHTTPRequest to read the cookie (which might contain something benign like last seen date) and use it to display it back on the page? Now HTTPOnly breaks that functionality. The last thing you want is people removing HTTPOnly to re-enable functionality that already worked.
Firefox overstepped the whole point of the security feature. You don't start disabling random other things just because you disable one. Think about it from a developer's perspective. You're sitting in a conference room, and you're not that brilliant and you say, "I heard that if you use HTTPOnly sometimes you won't be able to read not HTTPOnly cookies." And you less than brilliant developer friend says, "Whelp, I guess we had better not consider it, we need to read those cookies, by golly." And henceforth you have lower adoption.
HTTPOnly has had enough problems without introducing extremely hard to understand "features" (hard to understand unless you are intimately familiar with the tech). Plus, I have been known to replay cookies using XHR before too, because I want the exact syntax (including path name and expiration), and not the slimmed down document.cookie version of the actual header. It's not all that uncommon. It would be a nightmare do debug if I didn't know that Firefox had done that (on a different cookie, no less). I'd bet a dollar most developers wouldn't have a clue as to why it was happening.

|  | [Mike Shaver (:shaver emeritus)](/user_profile?user_id=422) |  |
| --- | --- | --- |
| [Comment 104](/show_bug.cgi?id=380418#c104)• 16 years ago |
|  | |

Robert misunderstands, I believe. We never show set-cookie in XHR results, regardless of whether there is an HTTPOnly cookie in the response or not, so use of HTTPOnly doesn't affect anything here. Ergo, there's no reason to avoid it in favour of more functionality.
(That's my interpretation of the patch, at least, I haven't tested exhaustively.)

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 105](/show_bug.cgi?id=380418#c105)• 16 years ago |
|  | |

Right, and Roberts claim is that developers need the ability to read non-HTTPOnly cookies from the XHR response headers, which IE 7x currently allows, but FF 3.0.0.6 does not.

|  | [marius schilder](/user_profile?user_id=90076) |  |
| --- | --- | --- |
| [Comment 106](/show_bug.cgi?id=380418#c106)• 16 years ago |
|  | |

See #87 regarding how useful Set-Cookie response headers are. You can parse the non-httponly cookies from document.cookie more reliably. And spec says implementations are free to drop transient headers and security related like set-cookie are called out specifically. The current 3.0.6 behavior is just fine.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 107](/show_bug.cgi?id=380418#c107)• 16 years ago |
|  | |

Re: [comment 103](/show_bug.cgi?id=380418#c103 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") -- removing HttpOnly from your cookies will not bring the functionality back. That won't be a temptation. If we had hidden only headers with HTTPOnly cookies then developers \*might\* be tempted to remove that attribute. Developers might get pissed at us for our aggressive approach here, but it cannot be accused of discouraging adoption of HttpOnly since the functionality is gone whether or not you use it.
I've filed [bug 476977](/show_bug.cgi?id=476977 "RESOLVED WONTFIX - Expose cookie details to the DOM") on enhancing the DOM with the additional cookie data that developers might be trying to get out of manually parsing headers from XHR.

|  | [Matthew Middleton (:zzxc)](/user_profile?user_id=61426) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=380418#a54980386_61426)• 16 years ago |

Blocks: [477165](/show_bug.cgi?id=477165 "RESOLVED WORKSFORME - Help Center Live chat rooms will not connect with Firefox 3.0.6+ (helpcenterlive.com)")

|  | [Jim Manico](/user_profile?user_id=304186) |  |
| --- | --- | --- |
| [Comment 108](/show_bug.cgi?id=380418#c108)• 16 years ago |
|  | |

(from Robert Hansen)
I read the thread, and that makes more sense. I thought XHR was disabling all because one cookie had HTTPOnly. I didn’t realize it was independent of that feature. That’s less bad. Still, it’s going to cause some people to riot in the streets when they’re trying to get code to work regardless of how secure their cookies are, but at least it won’t harm HTTPOnly adoption, they’re correct.

|  | [Jonas Sicking (:sicking) No longer reading bugmail consistently](/user_profile?user_id=9186) |  |
| --- | --- | --- |
| [Comment 109](/show_bug.cgi?id=380418#c109)• 16 years ago |
|  | |

As far as developers go, a much better solution for them is to use tools like the LiveHTTPHeaders or FireBug extensions.

|  | [Tony Chung [:tchung]](/user_profile?user_id=257111) |  |
| --- | --- | --- |
| [Comment 110](/show_bug.cgi?id=380418#c110)• 16 years ago |
|  | |

Built the bookmarklet from [comment 0](/show_bug.cgi?id=380418#c0 "VERIFIED FIXED - XMLHttpRequest allows reading HTTPOnly cookies") and results returned null.
Verified fix on Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US;
rv:1.9.2a1pre) Gecko/20090205 Minefield/3.2a1pre
and Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre)
Gecko/20090205 Shiretoko/3.1b3pre Ubiquity/0.1.5Status: RESOLVED → VERIFIEDKeywords: [fixed1.9.1](/buglist.cgi?keywords=fixed1.9.1&resolution=---) → [verified1.9.1](/buglist.cgi?keywords=verified1.9.1&resolution=---)
You need to [log in](/show_bug.cgi?id=380418&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Wladimir Palant](/user_profile?user_id=109976)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


