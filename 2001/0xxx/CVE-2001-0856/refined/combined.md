=== Content from www.cl.cam.ac.uk_47c70ae3_20250125_072527.html ===


| Extracting a 3DES key from an IBM 4758Summary The IBM 4758 is an extremely secure cryptographic co-processor. It is used by banking systems and in other security conscious applications to hold keying material. It is designed to make it impossible to extract this keying material unless you have the correct permissions and can involve others in a conspiracy.  We are able, by a mixture of sleight-of-hand and raw processing power, to persuade an IBM 4758 running IBM's ATM (cash machine) support software called the "Common Cryptographic Architecture" (CCA) to export any and all of this program's DES and 3DES keys to us. All we need is:   * about 20 minutes uninterrupted access to the device * one person's ability to use the Combine\_Key\_Parts permission * a standard off-the-shelf $995 FPGA evaluation board from Altera * about two days of "cracking" time   The attack can only be performed by an insider with physical access to the cryptographic co-processor, but they can act alone. The FPGA evaluation board is used as a "brute force key cracking" machine. Programming this is a reasonably straightforward task that does not require specialist hardware design knowledge. Since the board is pre-built and comes with all the necessary connectors and tools, it is entirely suitable for amateur use.  Besides being the first documented attack on the IBM 4758 to be run "in anger", we believe that this is only the second DES cracking machine in the open community that has actually been built and then used to find an unknown key!  Until IBM fix the CCA software to prevent our attack, banks are vulnerable to a dishonest branch manager whose teenager has $995 and a few hours to spend in duplicating our work.  **NEW: 5 FEB 2002:** Version 2.41 of the CCA has now been made available available on IBM's website at <http://www-3.ibm.com/security/cryptocards/html/release241.shtml> . Version 2.41 includes fixes specifically designed to prevent the attack described on this website, and some of the related weaknesses described in Mike Bond's paper "Attacks on Cryptoprocessor Transaction Sets".  * The major modification to the transaction set is the separation of   duty between confidentiality and integrity assurance for clear loading   of symmetric keys. The old modes of operation for Key\_Part\_Import were   FIRST, MIDDLE, and LAST. New modes of operation ADD and COMPLETE have   been created. The party responsible for testing the integrity of a key   (using Key\_Test) can now use the COMPLETE mode, which does not permit   modification of the key being tested. * Several changes have been made to the semantics of Key\_Part\_Import, and   the symmetric key inport and export commands to prevent type changes   between replicate and non-replicate keys during import, and to prevent   export of non-replicate keys under replicate keys. * Extra access control points have been created which disable the fixes in   order to permit upgrade to version 2.41 for reasons other than security.  The CCA is a much safer product now that no single individual can damage the integrity of the key material. The attack described on this website was based purely on *specification* level faults. Note that some of the security-related fixes in release 2.41 relate to *implementation* faults; these have no direct connection with the attacks described on this site, but presumably came to light as a consequence of the closer examination of the CCA code that followed the publicity. Contents [What is an IBM 4758 ?](ibm4758.html) [What is an FPGA ?](fpga.html) [What are DES and 3DES ?](des3des.html) [How the DES cracker works](cracker.html) [Some relevant sums](sums.html) [How the attack works](attack.html) [Some real results](results.html) [Who are we ?](whoarewe.html) [Do It Yourself](diy.html)   [Some reactions (to the existence of these web pages)](reaction.html)  How the problem might be fixed In creating these web pages we wished to concentrate on what the problem was with the IBM 4758 running the CCA software. How it might be fixed will to some extent be a matter of programming taste, and might also raise very complex issues of compatability with systems that are already in the field. We therefore shied away from describing how IBM might fix the problem.  However, so many people have asked for ideas about this, that we are now making available an outline of what needs to be done, both by IBM to correct the flaws we have found in their system and by banks who wish to minimise their short terms risks before new software becomes available. This information (which of necessity is somewhat technical) may be found at <http://www.cl.cam.ac.uk/~mkb23/fix.html>. [Frequently Asked Questions](faq.html) [What does an IBM 4758 look like?](faq.html#Q020) [Who uses IBM 4758s?](faq.html#Q040) [Are all IBM 4758s susceptible to the attack?](faq.html#Q060) [What is the CCA?](faq.html#Q080) [Are the IBM 4758 and the CCA the same thing?](faq.html#Q100) [How hard is it to physically attack a IBM 4758?](faq.html#Q120) [I heard that the IBM 4758 is FIPS Level 4 validated. Have you broken the validation?](faq.html#Q140) [So what does FIPS Level 4 validation mean?](faq.html#Q160) [Are other cryptoprocessors susceptible as well as the IBM 4758?](faq.html#Q180) [What is DES?](faq.html#Q200) [What is Triple-DES (3DES)?](faq.html#Q210) [How much stronger is Triple-DES than DES?](faq.html#Q220) [What privileges do you need to run this attack?](faq.html#Q240) [What information does this attack steal from the bank?](faq.html#Q260) [How do PIN numbers work?](faq.html#Q280) [Why is PIN number theft so dangerous?](faq.html#Q300) [How would a bank respond if someone did this attack?](faq.html#Q320) [Is all banking security this bad?](faq.html#Q340) [So can anyone who downloads this rip off a bank?](faq.html#Q360) [Who could rip off a bank then?](faq.html#Q380) [If this attack is so dangerous, why are you telling everyone?](faq.html#Q400) [Where can I go to book tickets to Bermuda?](faq.html#Q420) Other links Michael Bond. "Attacks on Cryptoprocessor Transaction Sets" Proceedings of the CHES 2001 Workshop, Paris 2001. Springer Verlag LNCS 2162, pp 220-234. Available on the web as: <http://www.cl.cam.ac.uk/~mkb23/research/Attacks-on-Crypto-TS.pdf>  Michael Bond & Ross Anderson. "API-Level Attacks on Embedded Systems" IEEE Computer 34(10), October 2001, pp 67-75.  "Brute force attacks on crytographic keys" a web-based survey of results, plus an annotated bibliography concentrating on DES crackers. <http://www.cl.cam.ac.uk/~rnc1/brute.html>  "IBM PCI Cryptographic Coprocessor CCA Basic Services Reference and Guide for IBM 4758 Models 002 and 023 with Release 2.40", Seventh Edition, September 2001. Available from: ftp://www6.software.ibm.com/software/cryptocards/CCA\_Basic\_Services\_Reference\_240.pdf     ---   [Return to Richard Clayton's Home Page](/~rnc1/index.html) [Return to Mike Bond's Home Page](/~mkb23/research.html)  last modified 15 NOV 2001 -- http://www.cl.cam.ac.uk/~rnc1/descrack/index.html |
| --- |



=== Content from marc.info_ec59732b_20250125_072527.html ===

```
[[prev in list](?l=bugtraq&m=100533377500312&w=2)] [[next in list](?l=bugtraq&m=100535677908200&w=2)] [[prev in thread](?l=cryptography&m=100534120726686&w=2)] [[next in thread](?l=bugtraq&m=101475098707952&w=2)]
List:       [bugtraq](?l=bugtraq&r=1&w=2)
Subject:    [Extracting a 3DES key from an IBM 4758](?t=100533073000006&r=1&w=2)
From:       [aleph1 () securityfocus ! com](?a=93501451600001&r=1&w=2)
Date:       [2001-11-09 16:16:52](?l=bugtraq&r=1&w=2&b=200111)
[Download RAW [message](?l=bugtraq&m=100533053219673&q=mbox) or [body](?l=bugtraq&m=100533053219673&q=raw)]

Extracting a 3DES key from an IBM 4758

The IBM 4758 is an extremely secure crytographic co-processor. It is used
by banking systems and in other security conscious applications to hold
keying material. It is designed to make it impossible to extract this keying
material unless you have the correct permissions and can involve others in a
conspiracy.

We are able, by a mixture of sleight-of-hand and raw processing power, to
persuade an IBM 4758 running IBM's ATM (cash machine) support software called
the "Common Cryptographic Architecture" (CCA) to export any and all its DES
and 3DES keys to us. All we need is:

* about 20 minutes uninterrupted access to the device
* one person's ability to use the Combine_Key_Parts permission
* a standard off-the-shelf $995 FPGA evaluation board from Altera
* about two days of "cracking" time

The attack can only be performed by an insider with physical access to the
cryptographic co-processor, but they can act alone. The FPGA evaluation board
is used as a "brute force key cracking" machine. Programming this is a
reasonably straightforward task that does not require specialist hardware
design knowledge. Since the board is pre-built and comes with all the
necessary connectors and tools, it is entirely suitable for amateur use.

Besides being the first documented attack on the IBM 4758 to be run "in
anger", we believe that this is only the second DES cracking machine in the
open community that has actually been built and then used to find an unknown
key!

Until IBM fix the CCA software to prevent our attack, banks are vulnerable
to a dishonest branch manager whose teenager has $995 and a few hours to
spend in duplicating our work.

<http://www.cl.cam.ac.uk/~rnc1/descrack/>

--
Elias Levy
SecurityFocus
<http://www.securityfocus.com/>
Si vis pacem, para bellum

[[prev in list](?l=bugtraq&m=100533377500312&w=2)] [[next in list](?l=bugtraq&m=100535677908200&w=2)] [[prev in thread](?l=cryptography&m=100534120726686&w=2)] [[next in thread](?l=bugtraq&m=101475098707952&w=2)]

```

[Configure](?q=configure) |
[About](?q=about) |
[News](?q=news) |
Add a list |
Sponsored by [KoreLogic](http://www.korelogic.com/)



=== Content from www.cl.cam.ac.uk_6736acaf_20250125_072527.html ===


| Extracting a 3DES key from an IBM 4758Part 5: How the attack works The [IBM 4758](ibm4758.html) with its CCA software is widely used in the banking industry to hold encryption keys securely. The device is extremely tamper-resistant and no physical attack is known that will allow keys to be accessed.  Clearly, if you hold sufficient permissions then you can extract the encryption keys via software means. The CCA software is designed to ensure that two or more people must combine their permissions before security sensitive procedures will be allowed. Our attack succeeds with very limited access permissions and does not require collusion with other people.  Communications to and from a branch will be encrypted with "triple DES" (3DES) keys that are shared between the two ends of the link. For example, cash machines (ATM) will need to communicate with a central system to validate customer PINs and thereby establish if a bona fide request for money is being made.  When a 3DES key is to be changed the central computer will cause a new key to be generated securely within its IBM 4758. It actually makes two separate values (called "key parts") which can be exclusive ORd (XORd) together to produce this key. These two key parts are printed on a secure printer (perhaps onto sealed, tamper-evident line printer forms) and given to two of the bank's security officers. The security officers travel to the branch and each types in their key part and destroys their piece of paper. The branch's IBM 4758 now XORs the two key parts together to reconstruct the 3DES key. Communications may now be done using a 3DES key that is entirely secure. The security officers cannot determine the value of the key unless they collude with each other and the key has never existed outside the physically secure confines of the cryptoprocessor modules.  In order to "steal" this valuable 3DES key we arrange for it to be exported from the branch machine. The CCA software will allow this export -- **provided** that the 3DES key has been encrypted with another securely held 3DES key. The CCA software's security design relies upon us not being able to learn such a 3DES key. Our attack involves using some "sleight-of-hand" to create a 3DES "exporter key" in such a way that we **do** know its value.  But first, let's start at the beginning! Our attack requires that we begin by learning the value of a "single DES" data key that is supposedly unknown to us. So we write a program to do the following tasks and load it into the IBM 4758. | Step 1: | Create a single DES key part of unknown value. Creating a key part requires permission to run the "generate" command. If this is not available, then you can get the same effect by presenting a random chosenly token which the system will decrypt to a unknowable value. Many such values will have incorrect parity, but a little perserverance in repeating this action will eventually yield a usable value. | | --- | --- | | Step 2: | Create a single DES key part of value 0. | | Step 3: | XOR these two key parts together to create a DES data key Step 3 requires an access permission called Combine\_Key\_Parts. It isn't possible to transfer keys to branches without this permission being held by someone at the branch. | | Step 4: | Encrypt zero (the simplest possible data value) with the data key and display the encrypted value. | | Step 5: | Repeat steps 2 to 4 for values 1..16383 There are a few implementation details in step 5 to do with parity bits on the DES key and creating more that 16384 values to allow for the 64->14 value hashing function in the FPGA design -- but they merely obscure the simplicity of what is being done here and so they've been omitted. |   This set of tasks less than 10 minutes to run, and at the end of them we have 16384 different encrypted versions of zero. We can then use our [FPGA design](cracker.html) to crack these values in parallel. With average luck then one of the values will be found after about 25 hours. By seeing which value it is, we can determine which value (from 0 to 16383) was involved -- and hence we have determined the "unknown" value from Step 1.   | Step 6: | Combine the unknown value from Step 1 with a known value so as to create a data key. In step 6 we could re-use one of the values from step 3, but for tidiness we use a totally different known value. Note that this step can be done during the same session as steps 1..5, there is no need to wait for the "crack" to be completed. Step 6 needs the same Combine\_Key\_Parts permission as above. | | --- | --- |   We now know the value of a data key within the IBM 4758. However, the attack is not yet over, because a mere data key is not permitted to export the secret keys we want to steal. Some more work is needed.   | Step 7: | Create a triple DES (3DES) "replicate key part" of unknown value. A replicate key part has both halves of the 3DES key identical and it is used for interworking with legacy applications that can only handle DES encryption. [Recall](des3des.html) that with both halves of a 3DES key the same, 3DES encrypts exactly the same way as single DES. | | --- | --- | | Step 8: | Create a 3DES replicate key part with both halves 0. | | Step 9: | XOR these two key parts together to create a 3DES exporter key | | Step 10: | Encrypt the data key created at step 6 with the exporter key and display the encrypted value. Note that since the key being exported is a single DES key we are allowed to export it with a replicate 3DES key, since they are of equivalent strength. However, the secret keys that we want to steal are non-replicate 3DES keys and the CCA software will not allow them to be exported with a (far weaker) replicate key. | | Step 11: | Repeat steps 8 to 10 for values 1..16383 placed in each half of a replicate key part Once again, as in step 5, there are a few implementation details relating to parity and the actual number of iterations. |   This set of tasks, 7 to 11 (which bear considerable resemblance to steps 1 to 5) also takes about 10 minutes and can be done immediately after steps 1 to 6 as part of the same session. When they are complete, we will have 16384 different encrypted versions of the single DES key made at step 6.  As soon as the FPGA cracking operation described above has been completed we will know the value of the step 6 key. We can then use the FPGA board for a second time, using the step 10 data in order to determine the unknown value of the replicate key part we made at step 7.  Note that since the keys we made at step 9 were exporter keys we were not allowed to encrypt data with them -- hence we couldn't just encrypt zero as we did in the first part of the attack. This explains why the first part of the attack was necessary -- we needed a known key value to use in the second part of the attack.   | Step 12: | Create a 3DES key part with both halves DIFFERENT but known. | | --- | --- | | Step 13: | Combine this with the unknown replicate key part from Step 7 in order to create a 3DES exporter key with both halves different. This is where the CCA software falls down. It allows us to bootstrap from a replicate 3DES key part to a non-replicate 3DES key. | | Step 14: | Export all the $$$ecret keys from the IBM 4758 using this 3DES exporter key. Once again, it is possible to do steps 12..14 in the same session as all the previous steps. As soon as step 14 is complete, the various keys and key parts that have been made inside the IBM 4758 can be deleted and everything made tidy again. About two days later, when the FPGA design has been run twice, all the $$$ecret keys can be decrypted -- and suitable use made of them. |   ie: we've stolen any and all of the secret keys from the CCA software running inside the remarkably secure IBM 4758, and all we needed was:   * about 20 minutes uninterrupted access to the device * the Combine\_Key\_Parts permission * an off-the-shelf $995 FPGA evaluation board * about two days of "cracking" time   Oops!  To be strictly accurate, some detail has been skated over in Step 14. You can only export some keys from the IBM 4758 because the CCA software may only have marked some keys as exportable. If the keys you want are not marked this way then you'll need to do a bit more work. You'll need to create a random importer key (ensuring that it is exportable!) and export it. Once its value is known (ie once you've finished all the above steps) then you can reimport keys you have previously observed being imported and can typecast them to "exportable" during this importation. The details are rather messy and are left as an exercise for the interested reader.  [Next part: Some real results](results.html)  [Previous part: How the DES cracker works](cracker.html)     ---   [Back to main page](/~rnc1/descrack/index.html)  last modified 11 NOV 2001 -- http://www.cl.cam.ac.uk/~rnc1/descrack/attack.html |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |


