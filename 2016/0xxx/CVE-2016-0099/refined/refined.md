```
CVE-2016-0099
```
The provided content describes a local privilege escalation vulnerability in the Windows Secondary Logon Service (CVE-2016-0099). Here's a breakdown:

**Root cause of vulnerability:**
The vulnerability stems from the `Secondary Logon` service failing to properly sanitize standard handles when creating a new process using `CreateProcessWithToken` or `CreateProcessWithLogon` APIs. Specifically, when the `STARTF_USESTDHANDLES` flag is used, the service copies the standard handles manually with `DuplicateHandle` without any sanitization. This allows a malicious user to provide a handle to the current thread and, because of how NtDuplicateObject handles thread handles, obtain a thread handle to the `seclogon` process with `THREAD_ALL_ACCESS` rights.

**Weaknesses/vulnerabilities present:**
- Lack of sanitization of standard handles passed to `CreateProcessWithLogonW`.
- Incorrect use of `NtDuplicateObject` in the secondary logon service.
- Ability to obtain a handle with `THREAD_ALL_ACCESS` rights to a thread in the seclogon service.

**Impact of exploitation:**
-  An attacker can gain `Local System` privileges.
- With elevated privileges, the attacker can then install programs, view, change, or delete data, or create new accounts with full user rights.
- Using a handle to a thread pool thread, the attacker can force a system level impersonation token that overrides the security enforcement of system services like `BITS` and `Task Scheduler` allowing for arbitrary file writes and process creation at `Local System` level.
- The attacker can set the threadâ€™s context causing the thread to dispatch to an arbitrary `RIP`.

**Attack vectors:**
- The attacker needs to be logged on to the system.
- The attacker needs to execute a specially crafted application.
- Using `CreateProcessWithLogonW` with the `LOGON_NETCREDENTIALS_ONLY` flag, the attacker does not need a valid password, since it's used only to change the network password of a copy of the caller's token.

**Required attacker capabilities/position:**
- Local access to the machine with a non-admin user account.
- Ability to execute a malicious application.
- The system needs at least 2 CPU cores for the race condition to succeed.
- Powershell v2+ must be available.

**Additional notes:**
- The vulnerability affects Windows 7 to 10 and Windows Server 2008 to 2012 (both 32-bit and 64-bit).
- The provided content includes a PowerShell exploit, a C# exploit, and a Metasploit module, showcasing different ways to exploit this vulnerability.
- The vulnerability was discovered by James Forshaw (@tiraniddo).
- The exploit is a race condition, and may not work consistently, requiring multiple attempts.
```