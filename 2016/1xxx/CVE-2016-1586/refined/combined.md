=== Content from git.launchpad.net_206eee6d_20250124_131950.html ===


| [cgit logo](/) | [index](/) : [oxide](/oxide/ "oxide") | 1.16 1.17 1.18 1.19 1.20 1.21 1.22 crmaster master |
| --- | --- | --- |
| [no description] |  |

| [summary](/oxide/)[refs](/oxide/refs/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)[log](/oxide/log/)[tree](/oxide/tree/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)[commit](/oxide/commit/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)[diff](/oxide/diff/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Coulson <chris.coulson@canonical.com> | 2016-09-23 21:15:25 +0100 |
| --- | --- | --- |
| committer | Chris Coulson <chris.coulson@canonical.com> | 2016-09-23 21:15:25 +0100 |
| commit | [29014da83e5fc358d6bff0f574e9ed45e61a35ac](/oxide/commit/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) ([patch](/oxide/patch/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)) | |
| tree | [79b7b253fdfb1feee18ae71988fe366d2e548a76](/oxide/tree/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | |
| parent | [648e85080604e22bab00b48428b4e80c522cabea](/oxide/commit/?id=648e85080604e22bab00b48428b4e80c522cabea) ([diff](/oxide/diff/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac&id2=648e85080604e22bab00b48428b4e80c522cabea)) | |

Refactor ownership of BrowserContext (LP: #1503639, LP: #1626099)Previously, BrowserContext was reference counted inside Oxide. However, it's not reference counted in Chromium which meant we needed an additional mechanism (BrowserContextDestroyer) to ensure that it outlives any RenderProcessHosts using it. As this required a custom trait for deletion, it lead to the weird scenario where BrowserContext (a non-threadsafe class inherited from base::NonThreadSafe) had to have a thread-safe reference count.
Now, the main BrowserContext is exclusively owned by the application, and is scheduled for deletion via BrowserContextDestroyer as soon as the application releases it. OTR BrowserContexts are owned by the BrowserContext that creates them, and WebContentsUnloader schedules the OTR BrowserContext for deletion as soon as the last WebContents using it is scheduled for unload.
[Diffstat](/oxide/diff/?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)

| -rw-r--r-- | [qt/core/browser/oxide\_qt\_web\_context.cc](/oxide/diff/qt/core/browser/oxide_qt_web_context.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [qt/core/browser/oxide\_qt\_web\_context.h](/oxide/diff/qt/core/browser/oxide_qt_web_context.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [qt/quick/api/oxideqquickwebview.cc](/oxide/diff/qt/quick/api/oxideqquickwebview.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [qt/tests/qmltests/core/single-process.exclude](/oxide/diff/qt/tests/qmltests/core/single-process.exclude?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [qt/tests/qmltests/core/tst\_bug1626099.html](/oxide/diff/qt/tests/qmltests/core/tst_bug1626099.html?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [qt/tests/qmltests/core/tst\_bug1626099.qml](/oxide/diff/qt/tests/qmltests/core/tst_bug1626099.qml?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 44 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/BUILD.gn](/oxide/diff/shared/BUILD.gn?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/in\_process\_renderer\_observer.cc](/oxide/diff/shared/browser/in_process_renderer_observer.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 37 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/in\_process\_renderer\_observer.h](/oxide/diff/shared/browser/in_process_renderer_observer.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_context.cc](/oxide/diff/shared/browser/oxide_browser_context.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 86 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_context.h](/oxide/diff/shared/browser/oxide_browser_context.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 46 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_context\_destroyer.cc](/oxide/diff/shared/browser/oxide_browser_context_destroyer.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 244 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_context\_destroyer.h](/oxide/diff/shared/browser/oxide_browser_context_destroyer.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_main\_parts.cc](/oxide/diff/shared/browser/oxide_browser_main_parts.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_browser\_process\_main.cc](/oxide/diff/shared/browser/oxide_browser_process_main.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_content\_browser\_client.cc](/oxide/diff/shared/browser/oxide_content_browser_client.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 28 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_content\_browser\_client.h](/oxide/diff/shared/browser/oxide_content_browser_client.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_web\_contents\_unloader.cc](/oxide/diff/shared/browser/oxide_web_contents_unloader.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 56 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_web\_contents\_unloader.h](/oxide/diff/shared/browser/oxide_web_contents_unloader.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 10 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_web\_view.cc](/oxide/diff/shared/browser/oxide_web_view.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_web\_view\_contents\_helper.cc](/oxide/diff/shared/browser/oxide_web_view_contents_helper.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [shared/browser/oxide\_web\_view\_contents\_helper.h](/oxide/diff/shared/browser/oxide_web_view_contents_helper.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac) | 3 | |  |  |  | | --- | --- | --- | |

22 files changed, 577 insertions, 170 deletions

| diff --git a/qt/core/browser/oxide\_qt\_web\_context.cc b/qt/core/browser/oxide\_qt\_web\_context.ccindex 3dc3c133..617fbea8 100644--- a/[qt/core/browser/oxide\_qt\_web\_context.cc](/oxide/tree/qt/core/browser/oxide_qt_web_context.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[qt/core/browser/oxide\_qt\_web\_context.cc](/oxide/tree/qt/core/browser/oxide_qt_web_context.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -53,7 +53,6 @@ #include "qt/core/browser/oxide\_qt\_user\_script.h" #include "qt/core/glue/oxide\_qt\_web\_context\_proxy\_client.h" #include "shared/browser/media/oxide\_media\_capture\_devices\_context.h"-#include "shared/browser/oxide\_browser\_context.h" #include "shared/browser/oxide\_browser\_context\_delegate.h" #include "shared/browser/oxide\_browser\_process\_main.h" #include "shared/browser/oxide\_devtools\_manager.h"@@ -66,6 +65,7 @@ namespace oxide { namespace qt { +using oxide::BrowserContext; using oxide::DevToolsManager; using oxide::MediaCaptureDevicesContext; using oxide::UserAgentSettings;@@ -456,7 +456,7 @@ WebContext::~WebContext() { }  // static-WebContext\* WebContext::FromBrowserContext(oxide::BrowserContext\* context) {+WebContext\* WebContext::FromBrowserContext(BrowserContext\* context) { BrowserContextDelegate\* delegate = static\_cast<BrowserContextDelegate\*>(context->GetDelegate()); if (!delegate) {@@ -466,21 +466,21 @@ WebContext\* WebContext::FromBrowserContext(oxide::BrowserContext\* context) { return delegate->context(); } -oxide::BrowserContext\* WebContext::GetContext() {+BrowserContext\* WebContext::GetContext() { if (context\_.get()) { return context\_.get(); }  DCHECK(construct\_props\_); - oxide::BrowserContext::Params params(+ BrowserContext::Params params( construct\_props\_->data\_path, construct\_props\_->cache\_path, construct\_props\_->max\_cache\_size\_hint, construct\_props\_->session\_cookie\_mode); params.host\_mapping\_rules = construct\_props\_->host\_mapping\_rules; - context\_ = oxide::BrowserContext::Create(params);+ context\_ = BrowserContext::Create(params);  UserAgentSettings\* ua\_settings = UserAgentSettings::Get(context\_.get()); diff --git a/qt/core/browser/oxide\_qt\_web\_context.h b/qt/core/browser/oxide\_qt\_web\_context.hindex db2f68f7..1425b388 100644--- a/[qt/core/browser/oxide\_qt\_web\_context.h](/oxide/tree/qt/core/browser/oxide_qt_web_context.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[qt/core/browser/oxide\_qt\_web\_context.h](/oxide/tree/qt/core/browser/oxide_qt_web_context.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -33,6 +33,7 @@  #include "qt/core/glue/oxide\_qt\_web\_context\_proxy.h" #include "shared/browser/media/oxide\_media\_capture\_devices\_context\_client.h"+#include "shared/browser/oxide\_browser\_context.h"  QT\_BEGIN\_NAMESPACE class QNetworkAccessManager;@@ -43,9 +44,6 @@ class CookieStore; }  namespace oxide {--class BrowserContext;- namespace qt {  class SetCookiesContext;@@ -152,7 +150,7 @@ class WebContext : public WebContextProxy,  WebContextProxyClient\* client\_; - scoped\_refptr<BrowserContext> context\_;+ BrowserContext::UniquePtr context\_;  struct ConstructProperties; std::unique\_ptr<ConstructProperties> construct\_props\_;diff --git a/qt/quick/api/oxideqquickwebview.cc b/qt/quick/api/oxideqquickwebview.ccindex 06fe5ba9..d0076ae4 100644--- a/[qt/quick/api/oxideqquickwebview.cc](/oxide/tree/qt/quick/api/oxideqquickwebview.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[qt/quick/api/oxideqquickwebview.cc](/oxide/tree/qt/quick/api/oxideqquickwebview.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -2042,8 +2042,8 @@ If the application doesn't set this, then WebView will use the application default WebContext (Oxide::defaultWebContext).  The application should ensure that the provided WebContext outlives this-WebView. Although WebView will continue to function normally if its provided-WebContext is deleted, it will mean that this property is null.+WebView. Deleting the WebContext whilst the WebView is still alive may cause+some features to stop working.  If this WebView is created as a request to open a new window (via newViewRequested), then the WebContext will be inherited from the openingdiff --git a/qt/tests/qmltests/core/single-process.exclude b/qt/tests/qmltests/core/single-process.excludeindex 8a6a6834..937b64d0 100644--- a/[qt/tests/qmltests/core/single-process.exclude](/oxide/tree/qt/tests/qmltests/core/single-process.exclude?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[qt/tests/qmltests/core/single-process.exclude](/oxide/tree/qt/tests/qmltests/core/single-process.exclude?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -1,2 +1,3 @@+tst\_bug1626099.qml tst\_Incognito\_cleanup.qml tst\_Incognito\_cookies.qmldiff --git a/qt/tests/qmltests/core/tst\_bug1626099.html b/qt/tests/qmltests/core/tst\_bug1626099.htmlnew file mode 100644index 00000000..3ac94c54--- /dev/null+++ b/[qt/tests/qmltests/core/tst\_bug1626099.html](/oxide/tree/qt/tests/qmltests/core/tst_bug1626099.html?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -0,0 +1,15 @@+<html>+<head>+<script>++window.addEventListener("unload", function(e) {+ while (true) {+ console.log("Spinning unload handler");+ }+});++</script>+</head>+<body>+</body>+</html>diff --git a/qt/tests/qmltests/core/tst\_bug1626099.qml b/qt/tests/qmltests/core/tst\_bug1626099.qmlnew file mode 100644index 00000000..d11d76dc--- /dev/null+++ b/[qt/tests/qmltests/core/tst\_bug1626099.qml](/oxide/tree/qt/tests/qmltests/core/tst_bug1626099.qml?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -0,0 +1,44 @@+import QtQuick 2.0+import QtTest 1.0+import Oxide.testsupport 1.0++Item {+ id: top++ Component {+ id: webViewFactory+ TestWebView {+ incognito: true+ }+ }++ TestCase {+ id: test+ name: "Incognito\_cleanup"+ when: windowShown++ // Verify that the OTR browsing context is destroyed as soon as the+ // last incognito webview using it is destroyed. This is like+ // tst\_Incognito\_cleanup.qml with the exception that it runs the test+ // with a page that spins its unload handler, in order to delay+ // teardown of the incognito BrowserContext+ function test\_bug1626099() {+ var webView = webViewFactory.createObject(top, {});+ webView.url = "http://testsuite/tst\_bug1626099.html";+ verify(webView.waitForLoadSucceeded());++ webView.getTestApi().evaluateCode("document.cookie = \"foo=bar\"", false);+ compare(webView.getTestApi().evaluateCode("document.cookie", false), "foo=bar");++ var webViewHelper = TestSupport.createQObjectTestHelper(webView);+ webView.destroy();+ TestUtils.waitFor(function() { return webViewHelper.destroyed; });++ webView = webViewFactory.createObject(top, {});+ webView.url = "http://testsuite/tst\_bug1626099.html";+ verify(webView.waitForLoadSucceeded());++ compare(webView.getTestApi().evaluateCode("document.cookie", false), "");+ }+ }+}diff --git a/shared/BUILD.gn b/shared/BUILD.gnindex 43cafb2b..c9e7e914 100644--- a/[shared/BUILD.gn](/oxide/tree/shared/BUILD.gn?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/BUILD.gn](/oxide/tree/shared/BUILD.gn?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -284,6 +284,8 @@ component("shared") { "browser/input/oxide\_input\_method\_context.h", "browser/input/oxide\_input\_method\_context\_observer.cc", "browser/input/oxide\_input\_method\_context\_observer.h",+ "browser/in\_process\_renderer\_observer.cc",+ "browser/in\_process\_renderer\_observer.h", "browser/media/oxide\_media\_capture\_devices\_context.cc", "browser/media/oxide\_media\_capture\_devices\_context.h", "browser/media/oxide\_media\_capture\_devices\_context\_client.h",diff --git a/shared/browser/in\_process\_renderer\_observer.cc b/shared/browser/in\_process\_renderer\_observer.ccnew file mode 100644index 00000000..d69034e8--- /dev/null+++ b/[shared/browser/in\_process\_renderer\_observer.cc](/oxide/tree/shared/browser/in_process_renderer_observer.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -0,0 +1,37 @@+// vim:expandtab:shiftwidth=2:tabstop=2:+// Copyright (C) 2016 Canonical Ltd.++// This library is free software; you can redistribute it and/or+// modify it under the terms of the GNU Lesser General Public+// License as published by the Free Software Foundation; either+// version 2.1 of the License, or (at your option) any later version.++// This library is distributed in the hope that it will be useful,+// but WITHOUT ANY WARRANTY; without even the implied warranty of+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU+// Lesser General Public License for more details.++// You should have received a copy of the GNU Lesser General Public+// License along with this library; if not, write to the Free Software+// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA++#include "in\_process\_renderer\_observer.h"++#include "content/public/browser/render\_process\_host.h"++#include "oxide\_web\_contents\_unloader.h"++namespace oxide {++void InProcessRendererObserver::RenderProcessHostDestroyed(+ content::RenderProcessHost\* host) {+ WebContentsUnloader::GetInstance()->Shutdown();+}++InProcessRendererObserver::InProcessRendererObserver() {+ DCHECK(content::RenderProcessHost::run\_renderer\_in\_process());+}++InProcessRendererObserver::~InProcessRendererObserver() = default;++} // namespace oxidediff --git a/shared/browser/in\_process\_renderer\_observer.h b/shared/browser/in\_process\_renderer\_observer.hnew file mode 100644index 00000000..03d0d2f7--- /dev/null+++ b/[shared/browser/in\_process\_renderer\_observer.h](/oxide/tree/shared/browser/in_process_renderer_observer.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -0,0 +1,40 @@+// vim:expandtab:shiftwidth=2:tabstop=2:+// Copyright (C) 2016 Canonical Ltd.++// This library is free software; you can redistribute it and/or+// modify it under the terms of the GNU Lesser General Public+// License as published by the Free Software Foundation; either+// version 2.1 of the License, or (at your option) any later version.++// This library is distributed in the hope that it will be useful,+// but WITHOUT ANY WARRANTY; without even the implied warranty of+// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU+// Lesser General Public License for more details.++// You should have received a copy of the GNU Lesser General Public+// License along with this library; if not, write to the Free Software+// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA++#ifndef \_OXIDE\_SHARED\_BROWSER\_IN\_PROCESS\_RENDERER\_OBSERVER\_H\_+#define \_OXIDE\_SHARED\_BROWSER\_IN\_PROCESS\_RENDERER\_OBSERVER\_H\_++#include "base/macros.h"+#include "content/public/browser/render\_process\_host\_observer.h"++namespace oxide {++class InProcessRendererObserver : public content::RenderProcessHostObserver {+ public:+ InProcessRendererObserver();+ ~InProcessRendererObserver() override;++ private:+ // content::RenderProcessHostObserver implementation+ void RenderProcessHostDestroyed(content::RenderProcessHost\* host) override;++ DISALLOW\_COPY\_AND\_ASSIGN(InProcessRendererObserver);+};++} // namespace oxide++#endif // \_OXIDE\_SHARED\_BROWSER\_IN\_PROCESS\_RENDERER\_OBSERVER\_H\_diff --git a/shared/browser/oxide\_browser\_context.cc b/shared/browser/oxide\_browser\_context.ccindex 8d2420b5..00ae02bc 100644--- a/[shared/browser/oxide\_browser\_context.cc](/oxide/tree/shared/browser/oxide_browser_context.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_context.cc](/oxide/tree/shared/browser/oxide_browser_context.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -558,24 +558,16 @@ class OTRBrowserContextImpl : public BrowserContext { public: OTRBrowserContextImpl(BrowserContextImpl\* original, BrowserContextIODataImpl\* original\_io\_data);-- base::WeakPtr<OTRBrowserContextImpl> GetWeakPtr() {- return weak\_ptr\_factory\_.GetWeakPtr();- }+ ~OTRBrowserContextImpl() override;  private:- ~OTRBrowserContextImpl() override;+ BrowserContext\* GetOffTheRecordContext() override { return this; } - scoped\_refptr<BrowserContext> GetOffTheRecordContext() override {- return make\_scoped\_refptr(this);- }- BrowserContext\* GetOriginalContext() const override;+ BrowserContext\* GetOriginalContext() override;  bool HasOffTheRecordContext() const override { return true; } - scoped\_refptr<BrowserContextImpl> original\_context\_;-- base::WeakPtrFactory<OTRBrowserContextImpl> weak\_ptr\_factory\_;+ BrowserContextImpl\* original\_context\_; };  class BrowserContextImpl : public BrowserContext {@@ -583,50 +575,49 @@ class BrowserContextImpl : public BrowserContext { BrowserContextImpl(const BrowserContext::Params& params);  private:+ friend class BrowserContext;+ ~BrowserContextImpl() override; - scoped\_refptr<BrowserContext> GetOffTheRecordContext() override;+ BrowserContext\* GetOffTheRecordContext() override; - BrowserContext\* GetOriginalContext() const override {- return const\_cast<BrowserContextImpl\*>(this);- }+ BrowserContext\* GetOriginalContext() override { return this; }  bool HasOffTheRecordContext() const override { return otr\_context\_ != nullptr; } - base::WeakPtr<OTRBrowserContextImpl> otr\_context\_;+ std::unique\_ptr<OTRBrowserContextImpl> otr\_context\_; }; -OTRBrowserContextImpl::~OTRBrowserContextImpl() {}--BrowserContext\* OTRBrowserContextImpl::GetOriginalContext() const {- return original\_context\_.get();+BrowserContext\* OTRBrowserContextImpl::GetOriginalContext() {+ return original\_context\_; } +OTRBrowserContextImpl::~OTRBrowserContextImpl() {}+ OTRBrowserContextImpl::OTRBrowserContextImpl( BrowserContextImpl\* original, BrowserContextIODataImpl\* original\_io\_data) : BrowserContext(new OTRBrowserContextIODataImpl(original\_io\_data)),- original\_context\_(original),- weak\_ptr\_factory\_(this) {+ original\_context\_(original) { BrowserContextDependencyManager::GetInstance() ->CreateBrowserContextServices(this); } -BrowserContextImpl::~BrowserContextImpl() {- CHECK(!otr\_context\_);-}--scoped\_refptr<BrowserContext> BrowserContextImpl::GetOffTheRecordContext() {+BrowserContext\* BrowserContextImpl::GetOffTheRecordContext() { if (!otr\_context\_) {- OTRBrowserContextImpl\* context = new OTRBrowserContextImpl(- this,- static\_cast<BrowserContextIODataImpl \*>(io\_data()));- otr\_context\_ = context->GetWeakPtr();+ otr\_context\_ =+ base::MakeUnique<OTRBrowserContextImpl>(+ this,+ static\_cast<BrowserContextIODataImpl\*>(io\_data())); } - return make\_scoped\_refptr(otr\_context\_.get());+ return otr\_context\_.get();+}++BrowserContextImpl::~BrowserContextImpl() {+ CHECK(!otr\_context\_); }  BrowserContextImpl::BrowserContextImpl(const BrowserContext::Params& params)@@ -643,8 +634,9 @@ BrowserContextImpl::BrowserContextImpl(const BrowserContext::Params& params) ->CreateBrowserContextServices(this); } -void BrowserContextTraits::Destruct(const BrowserContext\* x) {- BrowserContextDestroyer::DestroyContext(const\_cast<BrowserContext\*>(x));+void BrowserContext::Deleter::operator()(BrowserContext\* context) {+ CHECK(!context->IsOffTheRecord());+ BrowserContextDestroyer::DestroyContext(base::WrapUnique(context)); }  std::unique\_ptr<content::ZoomLevelDelegate>@@ -744,8 +736,8 @@ void BrowserContext::RemoveObserver(BrowserContextObserver\* observer) { observers\_.RemoveObserver(observer); } -BrowserContext::BrowserContext(BrowserContextIOData\* io\_data) :- io\_data\_(io\_data) {+BrowserContext::BrowserContext(BrowserContextIOData\* io\_data)+ : io\_data\_(io\_data) { CHECK(BrowserProcessMain::GetInstance()->IsRunning()) << "The main browser process components must be started before " << "creating a context";@@ -786,9 +778,8 @@ BrowserContext::~BrowserContext() { }  // static-scoped\_refptr<BrowserContext> BrowserContext::Create(const Params& params) {- scoped\_refptr<BrowserContext> context = new BrowserContextImpl(params);- return context;+BrowserContext::UniquePtr BrowserContext::Create(const Params& params) {+ return BrowserContext::UniquePtr(new BrowserContextImpl(params)); }  // static@@ -800,7 +791,10 @@ void BrowserContext::ForEach(const BrowserContextCallback& callback) {  // static void BrowserContext::AssertNoContextsExist() {- CHECK\_EQ(g\_all\_contexts.Get().size(), static\_cast<size\_t>(0));+ CHECK\_EQ(g\_all\_contexts.Get().size(), static\_cast<size\_t>(0))+ << "BrowserContexts still exist at shutdown! This is normally the result "+ << "of an application leak, but it's possible that there might be an "+ << "Oxide bug too"; }  BrowserContextID BrowserContext::GetID() const {@@ -820,6 +814,14 @@ void BrowserContext::SetDelegate(BrowserContextDelegate\* delegate) { data.delegate = delegate; } +// static+void BrowserContext::DestroyOffTheRecordContextForContext(+ BrowserContext\* context) {+ CHECK(!context->IsOffTheRecord() && context->HasOffTheRecordContext());+ BrowserContextDestroyer::DestroyContext(+ std::move(static\_cast<BrowserContextImpl\*>(context)->otr\_context\_));+}+ bool BrowserContext::IsOffTheRecord() const { DCHECK(CalledOnValidThread()); return io\_data()->IsOffTheRecord();@@ -829,7 +831,7 @@ bool BrowserContext::IsSameContext(BrowserContext\* other) const { DCHECK(CalledOnValidThread()); return other->GetOriginalContext() == this || (other->HasOffTheRecordContext() &&- other->GetOffTheRecordContext().get() == this);+ other->GetOffTheRecordContext() == this); }  base::FilePath BrowserContext::GetPath() const {diff --git a/shared/browser/oxide\_browser\_context.h b/shared/browser/oxide\_browser\_context.hindex b6c61e41..35230176 100644--- a/[shared/browser/oxide\_browser\_context.h](/oxide/tree/shared/browser/oxide_browser_context.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_context.h](/oxide/tree/shared/browser/oxide_browser_context.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -146,17 +146,10 @@ class BrowserContextIOData {  class BrowserContext; -struct OXIDE\_SHARED\_EXPORT BrowserContextTraits {- static void Destruct(const BrowserContext\* x);-};- // This class holds the context needed for a browsing session. It lives on-// and must only be accessed on the UI thread - note that it uses a thread-safe-// refcount only so that we can override the delete behaviour-class OXIDE\_SHARED\_EXPORT BrowserContext- : public content::BrowserContext,- public base::RefCountedThreadSafe<BrowserContext, BrowserContextTraits>,- public base::NonThreadSafe {+// and must only be accessed on the UI thread+class OXIDE\_SHARED\_EXPORT BrowserContext : public content::BrowserContext,+ public base::NonThreadSafe { public:  struct Params {@@ -176,12 +169,24 @@ class OXIDE\_SHARED\_EXPORT BrowserContext std::vector<std::string> host\_mapping\_rules; }; + virtual ~BrowserContext();+ static BrowserContext\* FromContent( content::BrowserContext\* context) { return static\_cast<BrowserContext \*>(context); } - static scoped\_refptr<BrowserContext> Create(const Params& params);+ struct Deleter {+ void operator()(BrowserContext\* context);+ };++ typedef std::unique\_ptr<BrowserContext, Deleter> UniquePtr;++ // Create a new BrowserContext. Callers should be aware that the returned+ // std::unique\_ptr is not guaranteed to delete the BrowserContext immediately+ // when released - it schedules the BrowserContext to be deleted when it's no+ // longer in use.+ static UniquePtr Create(const Params& params);  typedef base::Callback<void(BrowserContext\*)> BrowserContextCallback; static void ForEach(const BrowserContextCallback& callback);@@ -194,10 +199,22 @@ class OXIDE\_SHARED\_EXPORT BrowserContext BrowserContextDelegate\* GetDelegate() const; void SetDelegate(BrowserContextDelegate\* delegate); - virtual scoped\_refptr<BrowserContext> GetOffTheRecordContext() = 0;- virtual BrowserContext\* GetOriginalContext() const = 0;+ // Returns an OTR BrowserContext, creating it if it needs to. Callers must+ // never delete the returned BrowserContext directly, but must pass the+ // BrowserContext returned by GetOriginalContext() to+ // DestroyOffTheRecordContextForContext when it's no longer required.+ virtual BrowserContext\* GetOffTheRecordContext() = 0;++ // Returns the main BrowserContext associated with |this|. Callers must never+ // delete the returned BrowserContext.+ // The returned BrowserContext is only guaranteed to be valid until |this| is+ // released.+ virtual BrowserContext\* GetOriginalContext() = 0;+ virtual bool HasOffTheRecordContext() const = 0; + static void DestroyOffTheRecordContextForContext(BrowserContext\* context);+ bool IsOffTheRecord() const override; // from content::BrowserContext  bool IsSameContext(BrowserContext\* other) const;@@ -231,10 +248,7 @@ class OXIDE\_SHARED\_EXPORT BrowserContext BrowserContextIOData\* GetIOData() const;  protected:- friend class BrowserContextDestroyer; // for destructor- BrowserContext(BrowserContextIOData\* io\_data);- virtual ~BrowserContext();  BrowserContextIOData\* io\_data() const { return io\_data\_; } diff --git a/shared/browser/oxide\_browser\_context\_destroyer.cc b/shared/browser/oxide\_browser\_context\_destroyer.ccindex 676de2c1..e57cd360 100644--- a/[shared/browser/oxide\_browser\_context\_destroyer.cc](/oxide/tree/shared/browser/oxide_browser_context_destroyer.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_context\_destroyer.cc](/oxide/tree/shared/browser/oxide_browser_context_destroyer.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -17,8 +17,11 @@  #include "oxide\_browser\_context\_destroyer.h" +#include <list>++#include "base/lazy\_instance.h" #include "base/logging.h"-#include "base/message\_loop/message\_loop.h"+#include "base/threading/thread\_task\_runner\_handle.h" #include "content/public/browser/browser\_context.h" #include "content/public/browser/render\_process\_host.h" @@ -26,76 +29,229 @@  namespace oxide { +namespace {++base::LazyInstance<std::list<BrowserContextDestroyer\*>>+ g\_contexts\_pending\_deletion = LAZY\_INSTANCE\_INITIALIZER;++std::set<content::RenderProcessHost\*> +GetHostsForContext(BrowserContext\* context) {+ std::set<content::RenderProcessHost\*> hosts;++ for (auto it = content::RenderProcessHost::AllHostsIterator();+ !it.IsAtEnd(); it.Advance()) {+ content::RenderProcessHost\* host = it.GetCurrentValue();+ if (host->GetBrowserContext() != context) {+ continue;+ }++ hosts.insert(host);+ }++ return std::move(hosts);+}++}+ BrowserContextDestroyer::BrowserContextDestroyer(- BrowserContext\* context,- const std::set<content::RenderProcessHost\*>& hosts)- : context\_(context),- pending\_hosts\_(0) {- for (std::set<content::RenderProcessHost\*>::iterator it = hosts.begin();- it != hosts.end(); ++it) {- (\*it)->AddObserver(this);- ++pending\_hosts\_;+ std::unique\_ptr<BrowserContext> context,+ const std::set<content::RenderProcessHost\*>& hosts,+ uint32\_t otr\_contexts\_pending\_deletion)+ : context\_(std::move(context)),+ otr\_contexts\_pending\_deletion\_(otr\_contexts\_pending\_deletion),+ finish\_destroy\_scheduled\_(false) {+ DCHECK(hosts.size() > 0 ||+ (!context->IsOffTheRecord() &&+ (otr\_contexts\_pending\_deletion > 0 ||+ context->HasOffTheRecordContext())));++ g\_contexts\_pending\_deletion.Get().push\_back(this);++ for (auto\* host : hosts) {+ ObserveHost(host); } } -BrowserContextDestroyer::~BrowserContextDestroyer() {}+BrowserContextDestroyer::~BrowserContextDestroyer() = default;++void BrowserContextDestroyer::ObserveHost(content::RenderProcessHost\* host) {+ DCHECK(pending\_host\_ids\_.find(host->GetID()) == pending\_host\_ids\_.end());++ host->AddObserver(this);+ pending\_host\_ids\_.insert(host->GetID());+}++void BrowserContextDestroyer::MaybeScheduleFinishDestroyContext(+ content::RenderProcessHost\* host\_being\_destroyed) {+ DCHECK(!finish\_destroy\_scheduled\_);++ if (pending\_host\_ids\_.size() > 0) {+ // We're monitoring RenderProcessHosts that are using this context, so it's+ // not safe to delete yet+ return;+ }++ if (!context\_->IsOffTheRecord() &&+ (otr\_contexts\_pending\_deletion\_ > 0 ||+ context\_->HasOffTheRecordContext())) {+ // There are still live OTR BrowserContexts that depend on this context, so+ // it can't be deleted yet+ return;+ }++ finish\_destroy\_scheduled\_ = true;++ base::ThreadTaskRunnerHandle::Get()->PostTask(+ FROM\_HERE,+ base::Bind(&BrowserContextDestroyer::FinishDestroyContext,+ // We have exclusive ownership of |this| - nobody else can+ // reference or delete it+ base::Unretained(this)));+}  void BrowserContextDestroyer::FinishDestroyContext() {- DCHECK\_EQ(pending\_hosts\_, 0U);+ DCHECK(finish\_destroy\_scheduled\_);+ CHECK\_EQ(GetHostsForContext(context\_.get()).size(), 0U)+ << "One or more RenderProcessHosts exist whilst its BrowserContext is "+ << "being deleted!"; - delete context\_;- context\_ = nullptr;+ g\_contexts\_pending\_deletion.Get().remove(this);++ if (context\_->IsOffTheRecord()) {+ // If this is an OTR context and its owner BrowserContext has been scheduled+ // for deletion, update the owner's BrowserContextDestroyer+ BrowserContextDestroyer\* orig\_destroyer =+ GetForContext(context\_->GetOriginalContext());+ if (orig\_destroyer) {+ DCHECK\_GT(orig\_destroyer->otr\_contexts\_pending\_deletion\_, 0U);+ DCHECK(!orig\_destroyer->finish\_destroy\_scheduled\_);+ --orig\_destroyer->otr\_contexts\_pending\_deletion\_;+ orig\_destroyer->MaybeScheduleFinishDestroyContext();+ }+ }  delete this; } +// static+BrowserContextDestroyer\* BrowserContextDestroyer::GetForContext(+ content::BrowserContext\* context) {+ auto it = std::find\_if(g\_contexts\_pending\_deletion.Get().begin(),+ g\_contexts\_pending\_deletion.Get().end(),+ [context](const BrowserContextDestroyer\* d) {+ return d->context\_.get() == context;+ });++ if (it == g\_contexts\_pending\_deletion.Get().end()) {+ return nullptr;+ }++ return \*it;+}+ void BrowserContextDestroyer::RenderProcessHostDestroyed( content::RenderProcessHost\* host) {- DCHECK\_GT(pending\_hosts\_, 0U);- if (--pending\_hosts\_ != 0) {- return;- }+ DCHECK\_GT(pending\_host\_ids\_.size(), 0U);++ size\_t erased = pending\_host\_ids\_.erase(host->GetID());+ DCHECK\_GT(erased, 0U);++ MaybeScheduleFinishDestroyContext(host);+}++// static+void BrowserContextDestroyer::DestroyContext(+ std::unique\_ptr<BrowserContext> context) { - if (content::RenderProcessHost::run\_renderer\_in\_process()) {- FinishDestroyContext();+ bool has\_live\_otr\_context = false;+ uint32\_t otr\_contexts\_pending\_deletion = 0;++ if (!context->IsOffTheRecord()) {+ // If |context| is not an OTR BrowserContext, we need to keep track of how+ // many OTR BrowserContexts that were owned by it are scheduled for deletion+ // but still exist, as |context| must outlive these+ for (auto\* destroyer : g\_contexts\_pending\_deletion.Get()) {+ if (destroyer->context\_->IsOffTheRecord() &&+ destroyer->context\_->GetOriginalContext() == context.get()) {+ ++otr\_contexts\_pending\_deletion;+ }+ }++ // If |context| is not an OTR BrowserContext but currently owns a live OTR+ // BrowserContext, then we have to outlive that+ has\_live\_otr\_context = context->HasOffTheRecordContext(); } else {- base::MessageLoop::current()->PostTask(- FROM\_HERE,- base::Bind(&BrowserContextDestroyer::FinishDestroyContext,- // We have exclusive ownership of |this| - nobody else can- // reference or delete it- base::Unretained(this)));+ // If |context| is an OTR BrowserContext and its owner has already been+ // scheduled for deletion, then we need to prevent the owner from being+ // deleted until after |context|+ BrowserContextDestroyer\* orig\_destroyer =+ GetForContext(context->GetOriginalContext());+ if (orig\_destroyer) {+ CHECK(!orig\_destroyer->finish\_destroy\_scheduled\_);+ ++orig\_destroyer->otr\_contexts\_pending\_deletion\_;+ }+ }++ // Get all of the live RenderProcessHosts that are using |context|+ std::set<content::RenderProcessHost\*> hosts =+ GetHostsForContext(context.get());++ content::BrowserContext::NotifyWillBeDestroyed(context.get());++ // |hosts| might not be empty if the application released its BrowserContext+ // too early, or if |context| is an OTR context or this application is single+ // process++ if (!hosts.empty() ||+ otr\_contexts\_pending\_deletion > 0 ||+ has\_live\_otr\_context) {+ // |context| is not safe to delete yet+ new BrowserContextDestroyer(std::move(context),+ hosts,+ otr\_contexts\_pending\_deletion); } }  // static-void BrowserContextDestroyer::DestroyContext(BrowserContext\* context) {- CHECK(context->IsOffTheRecord() || !context->HasOffTheRecordContext());+void BrowserContextDestroyer::Shutdown() {+ auto destroy\_all\_unused\_contexts = []() {+ auto it = g\_contexts\_pending\_deletion.Get().begin();+ while (it != g\_contexts\_pending\_deletion.Get().end()) {+ BrowserContextDestroyer\* destroyer = \*it;+ ++it; - content::BrowserContext::NotifyWillBeDestroyed(context);-- std::set<content::RenderProcessHost\*> hosts;+ if (!destroyer->finish\_destroy\_scheduled\_) {+ continue;+ } - for (content::RenderProcessHost::iterator it =- content::RenderProcessHost::AllHostsIterator();- !it.IsAtEnd(); it.Advance()) {- content::RenderProcessHost\* host = it.GetCurrentValue();- if (host->GetBrowserContext() != context) {- continue;+ destroyer->FinishDestroyContext();+ // |destroyer| is invalid now }+ }; - hosts.insert(host);+ // We make 2 passes over the list because the first pass can destroy an+ // incognito BrowserContext that subsequently schedules its owner context for+ // deletion+ destroy\_all\_unused\_contexts();+ destroy\_all\_unused\_contexts();+}++// static+void BrowserContextDestroyer::RenderProcessHostAssignedToSiteInstance(+ content::RenderProcessHost\* host) {+ BrowserContextDestroyer\* destroyer = GetForContext(host->GetBrowserContext());+ if (!destroyer) {+ return; } - // XXX: Given that we shutdown the service worker context and that there- // shouldn't be any live WebContents left, are there any circumstances- // other than in single-process mode where |hosts| isn't empty?+ CHECK(!destroyer->finish\_destroy\_scheduled\_); - if (hosts.empty()) {- delete context;- } else {- new BrowserContextDestroyer(context, hosts);+ if (destroyer->pending\_host\_ids\_.find(host->GetID()) !=+ destroyer->pending\_host\_ids\_.end()) {+ return; }++ destroyer->ObserveHost(host); }  } // namespace oxidediff --git a/shared/browser/oxide\_browser\_context\_destroyer.h b/shared/browser/oxide\_browser\_context\_destroyer.hindex 61d363bd..037be290 100644--- a/[shared/browser/oxide\_browser\_context\_destroyer.h](/oxide/tree/shared/browser/oxide_browser_context_destroyer.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_context\_destroyer.h](/oxide/tree/shared/browser/oxide_browser_context_destroyer.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -18,12 +18,14 @@ #ifndef \_OXIDE\_SHARED\_BROWSER\_BROWSER\_CONTEXT\_DESTROYER\_H\_ #define \_OXIDE\_SHARED\_BROWSER\_BROWSER\_CONTEXT\_DESTROYER\_H\_ +#include <memory> #include <set>  #include "base/macros.h" #include "content/public/browser/render\_process\_host\_observer.h"  namespace content {+class BrowserContext; class RenderProcessHost; } @@ -31,23 +33,51 @@ namespace oxide {  class BrowserContext; +// A mechanism to manage BrowserContext destruction, ensuring it stays alive+// until consumers inside Chromium no longer require it class BrowserContextDestroyer : public content::RenderProcessHostObserver { public:- static void DestroyContext(BrowserContext\* context);+ // Schedule |context| for deletion. If no RenderProcessHosts are using it then+ // this will result in it being deleted immediately, else deletion will be+ // happen after all RenderProcessHosts using it have gone away+ static void DestroyContext(std::unique\_ptr<BrowserContext> context);++ // Delete all BrowserContexts that are pending deletion and safe to be deleted+ static void Shutdown();++ // Notify that |host| has been assigned to a SiteInstance. This is the first+ // notification we get from content after a RenderProcessHost is created,+ // although this doesn't mean it was actually just created.+ // This ensures that |host| will be tracked if its BrowserContext has already+ // been scheduled for deletion.+ static void RenderProcessHostAssignedToSiteInstance(+ content::RenderProcessHost\* host);  private:- BrowserContextDestroyer(BrowserContext\* context,- const std::set<content::RenderProcessHost\*>& hosts);+ BrowserContextDestroyer(std::unique\_ptr<BrowserContext> context,+ const std::set<content::RenderProcessHost\*>& hosts,+ uint32\_t otr\_contexts\_pending\_deletion); ~BrowserContextDestroyer() override; + void ObserveHost(content::RenderProcessHost\* host);++ void MaybeScheduleFinishDestroyContext(+ content::RenderProcessHost\* host\_being\_destroyed = nullptr); void FinishDestroyContext(); + static BrowserContextDestroyer\* GetForContext(+ content::BrowserContext\* context);+ // content::RenderProcessHostObserver implementation void RenderProcessHostDestroyed(content::RenderProcessHost\* host) override; - BrowserContext\* context\_;+ std::unique\_ptr<BrowserContext> context\_;++ std::set<int> pending\_host\_ids\_;++ uint32\_t otr\_contexts\_pending\_deletion\_; - uint32\_t pending\_hosts\_;+ bool finish\_destroy\_scheduled\_;  DISALLOW\_COPY\_AND\_ASSIGN(BrowserContextDestroyer); };diff --git a/shared/browser/oxide\_browser\_main\_parts.cc b/shared/browser/oxide\_browser\_main\_parts.ccindex 701a6e7f..069a2886 100644--- a/[shared/browser/oxide\_browser\_main\_parts.cc](/oxide/tree/shared/browser/oxide_browser_main_parts.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_main\_parts.cc](/oxide/tree/shared/browser/oxide_browser_main_parts.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -49,6 +49,7 @@ #include "shared/gpu/oxide\_gl\_context\_dependent.h"  #include "oxide\_browser\_context.h"+#include "oxide\_browser\_context\_destroyer.h" #include "oxide\_browser\_platform\_integration.h" #include "oxide\_browser\_process\_main.h" #include "oxide\_geolocation\_delegate.h"@@ -57,6 +58,7 @@ #include "oxide\_lifecycle\_observer.h" #include "oxide\_message\_pump.h" #include "oxide\_render\_process\_initializer.h"+#include "oxide\_web\_contents\_unloader.h" #include "oxide\_web\_contents\_view.h" #include "screen.h" @@ -341,15 +343,15 @@ bool BrowserMainParts::MainMessageLoopRun(int\* result\_code) { }  void BrowserMainParts::PostMainMessageLoopRun() {+ WebContentsUnloader::GetInstance()->Shutdown();++ BrowserContextDestroyer::Shutdown();+ BrowserContext::AssertNoContextsExist();+ CompositorUtils::GetInstance()->Shutdown(); }  void BrowserMainParts::PostDestroyThreads() {- if (BrowserProcessMain::GetInstance()->GetProcessModel() ==- PROCESS\_MODEL\_SINGLE\_PROCESS) {- BrowserContext::AssertNoContextsExist();- }- device\_client\_.reset();  display::Screen::SetScreenInstance(nullptr);diff --git a/shared/browser/oxide\_browser\_process\_main.cc b/shared/browser/oxide\_browser\_process\_main.ccindex 22dc77c5..65d8187a 100644--- a/[shared/browser/oxide\_browser\_process\_main.cc](/oxide/tree/shared/browser/oxide_browser_process_main.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_browser\_process\_main.cc](/oxide/tree/shared/browser/oxide_browser_process_main.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -72,10 +72,8 @@ #include "shared/common/oxide\_content\_client.h" #include "shared/common/oxide\_form\_factor.h" -#include "oxide\_browser\_context.h" #include "oxide\_form\_factor\_detection.h" #include "oxide\_message\_pump.h"-#include "oxide\_web\_contents\_unloader.h"  namespace content { @@ -581,14 +579,6 @@ void BrowserProcessMainImpl::Shutdown() {  MessagePump::Get()->Stop(); - WebContentsUnloader::GetInstance()->Shutdown();-- if (process\_model\_ != PROCESS\_MODEL\_SINGLE\_PROCESS) {- // In single process mode, we do this check after destroying- // threads, as we hold the single BrowserContext alive until then- BrowserContext::AssertNoContextsExist();- }- browser\_main\_runner\_->Shutdown(); browser\_main\_runner\_.reset(); diff --git a/shared/browser/oxide\_content\_browser\_client.cc b/shared/browser/oxide\_content\_browser\_client.ccindex 10236485..e10e20d5 100644--- a/[shared/browser/oxide\_content\_browser\_client.cc](/oxide/tree/shared/browser/oxide_content_browser_client.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_content\_browser\_client.cc](/oxide/tree/shared/browser/oxide_content_browser_client.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -46,7 +46,9 @@ #include "shared/common/oxide\_content\_client.h"  #include "display\_form\_factor.h"+#include "in\_process\_renderer\_observer.h" #include "oxide\_browser\_context.h"+#include "oxide\_browser\_context\_destroyer.h" #include "oxide\_browser\_main\_parts.h" #include "oxide\_browser\_platform\_integration.h" #include "oxide\_browser\_process\_main.h"@@ -92,12 +94,17 @@ content::BrowserMainParts\* ContentBrowserClient::CreateBrowserMainParts(  void ContentBrowserClient::RenderProcessWillLaunch( content::RenderProcessHost\* host) {+ if (content::RenderProcessHost::run\_renderer\_in\_process()) {+ host->AddObserver(new InProcessRendererObserver());+ }+ host->AddFilter(new RenderMessageFilter(host)); } -std::string ContentBrowserClient::GetAcceptLangs(- content::BrowserContext\* browser\_context) {- return UserAgentSettings::Get(browser\_context)->GetAcceptLangs();+void ContentBrowserClient::SiteInstanceGotProcess(+ content::SiteInstance\* site\_instance) {+ BrowserContextDestroyer::RenderProcessHostAssignedToSiteInstance(+ site\_instance->GetProcess()); }  void ContentBrowserClient::AppendExtraCommandLineSwitches(@@ -130,6 +137,16 @@ void ContentBrowserClient::AppendExtraCommandLineSwitches( } } +std::string+ContentBrowserClient::GetApplicationLocale() {+ return application\_locale\_;+}++std::string ContentBrowserClient::GetAcceptLangs(+ content::BrowserContext\* browser\_context) {+ return UserAgentSettings::Get(browser\_context)->GetAcceptLangs();+}+ bool ContentBrowserClient::AllowGetCookie(const GURL& url, const GURL& first\_party, const net::CookieList& cookie\_list,@@ -339,11 +356,6 @@ ContentBrowserClient::GetOsTypeOverrideForGpuDataManager( #endif } -std::string-ContentBrowserClient::GetApplicationLocale() {- return application\_locale\_;-}- ContentBrowserClient::ContentBrowserClient( const std::string& application\_locale, BrowserPlatformIntegration\* integration)diff --git a/shared/browser/oxide\_content\_browser\_client.h b/shared/browser/oxide\_content\_browser\_client.hindex 15d47c93..45f3f333 100644--- a/[shared/browser/oxide\_content\_browser\_client.h](/oxide/tree/shared/browser/oxide_content_browser_client.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_content\_browser\_client.h](/oxide/tree/shared/browser/oxide_content_browser_client.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -48,14 +48,15 @@ class ContentBrowserClient final : public content::ContentBrowserClient {  private: // content::ContentBrowserClient implementation- std::string GetApplicationLocale() override; content::BrowserMainParts\* CreateBrowserMainParts( const content::MainFunctionParams& parameters) override; void RenderProcessWillLaunch(content::RenderProcessHost\* host) override;- std::string GetAcceptLangs(- content::BrowserContext\* browser\_context) override;+ void SiteInstanceGotProcess(content::SiteInstance\* site\_instance) override; void AppendExtraCommandLineSwitches(base::CommandLine\* command\_line, int child\_process\_id) override;+ std::string GetApplicationLocale() override;+ std::string GetAcceptLangs(+ content::BrowserContext\* browser\_context) override; bool AllowGetCookie(const GURL& url, const GURL& first\_party, const net::CookieList& cookie\_list,diff --git a/shared/browser/oxide\_web\_contents\_unloader.cc b/shared/browser/oxide\_web\_contents\_unloader.ccindex efc28ea5..6e0d4cf0 100644--- a/[shared/browser/oxide\_web\_contents\_unloader.cc](/oxide/tree/shared/browser/oxide_web_contents_unloader.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_web\_contents\_unloader.cc](/oxide/tree/shared/browser/oxide_web_contents_unloader.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -24,8 +24,26 @@ #include "content/public/browser/web\_contents.h" #include "content/public/browser/web\_contents\_observer.h" +#include "oxide\_browser\_context.h"+#include "oxide\_web\_view\_contents\_helper.h"+ namespace oxide { +namespace {++void MaybeDestroyOffTheRecordContext(BrowserContext\* context) {+ DCHECK(context->IsOffTheRecord());++ if (WebViewContentsHelper::IsContextInUse(context)) {+ return;+ }++ BrowserContext::DestroyOffTheRecordContextForContext(+ context->GetOriginalContext());+}++}+ class WebContentsUnloaderObserver : public content::WebContentsObserver { public: explicit WebContentsUnloaderObserver(content::WebContents\* contents)@@ -46,10 +64,12 @@ class WebContentsUnloaderObserver : public content::WebContentsObserver { WebContentsUnloader::WebContentsUnloader() = default;  void WebContentsUnloader::CloseContents(content::WebContents\* contents) {- ScopedVector<content::WebContents>::iterator it =- std::find(contents\_unloading\_.begin(),- contents\_unloading\_.end(),- contents);+ auto it = std::find\_if(+ contents\_unloading\_.begin(),+ contents\_unloading\_.end(),+ [contents](const std::unique\_ptr<content::WebContents>& c) {+ return contents == c.get();+ }); DCHECK(it != contents\_unloading\_.end());  contents\_unloading\_.erase(it);@@ -64,21 +84,28 @@ WebContentsUnloader\* WebContentsUnloader::GetInstance() {  void WebContentsUnloader::Unload( std::unique\_ptr<content::WebContents> contents) {- if (!contents->NeedToFireBeforeUnload()) {+ content::WebContents\* c = contents.get();+ contents\_unloading\_.push\_back(std::move(contents));++ content::BrowserContext\* context = c->GetBrowserContext();+ if (context->IsOffTheRecord()) {+ MaybeDestroyOffTheRecordContext(BrowserContext::FromContent(context));+ }++ if (!c->NeedToFireBeforeUnload()) { // Despite the name, this checks if sudden termination is allowed. If so, // we shouldn't fire the unload handler particularly if this was script // closed, else we'll never get an ACK+ CloseContents(c);+ // |c| is invalid now return; }  // To intercept render process crashes- new WebContentsUnloaderObserver(contents.get());+ new WebContentsUnloaderObserver(c);  // So we can intercept CloseContents- contents->SetDelegate(this);-- content::WebContents\* c = contents.get();- contents\_unloading\_.push\_back(contents.release());+ c->SetDelegate(this);  c->ClosePage(); // Note: |c| might be deleted at this point@@ -88,4 +115,13 @@ void WebContentsUnloader::Shutdown() { contents\_unloading\_.clear(); } +bool WebContentsUnloader::IsUnloadInProgress(content::WebContents\* contents) {+ return std::find\_if(+ contents\_unloading\_.begin(),+ contents\_unloading\_.end(),+ [contents](const std::unique\_ptr<content::WebContents>& c) {+ return contents == c.get();+ }) != contents\_unloading\_.end();+}+ }diff --git a/shared/browser/oxide\_web\_contents\_unloader.h b/shared/browser/oxide\_web\_contents\_unloader.hindex 00651ee2..619d59e3 100644--- a/[shared/browser/oxide\_web\_contents\_unloader.h](/oxide/tree/shared/browser/oxide_web_contents_unloader.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_web\_contents\_unloader.h](/oxide/tree/shared/browser/oxide_web_contents_unloader.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -19,9 +19,9 @@ #define \_OXIDE\_SHARED\_BROWSER\_WEB\_CONTENTS\_UNLOADER\_H\_  #include <memory>+#include <vector>  #include "base/macros.h"-#include "base/memory/scoped\_vector.h" #include "content/public/browser/web\_contents\_delegate.h"  namespace base {@@ -48,9 +48,13 @@ class WebContentsUnloader : public content::WebContentsDelegate { // takes ownership of |contents| and deletes it when complete void Unload(std::unique\_ptr<content::WebContents> contents); - // Delete all WebContents that are currently closing+ // Delete all WebContents that are currently closing without waiting for+ // unload handlers to complete void Shutdown(); + // Determine whether |contents| is currently unloading+ bool IsUnloadInProgress(content::WebContents\* contents);+ private: friend class base::DefaultSingletonTraits<WebContentsUnloader>; @@ -60,7 +64,7 @@ class WebContentsUnloader : public content::WebContentsDelegate { void CloseContents(content::WebContents\* contents) override;  // The WebContents for which we are waiting to unload- ScopedVector<content::WebContents> contents\_unloading\_;+ std::vector<std::unique\_ptr<content::WebContents>> contents\_unloading\_;  DISALLOW\_COPY\_AND\_ASSIGN(WebContentsUnloader); };diff --git a/shared/browser/oxide\_web\_view.cc b/shared/browser/oxide\_web\_view.ccindex d1f2769f..03520d9c 100644--- a/[shared/browser/oxide\_web\_view.cc](/oxide/tree/shared/browser/oxide_web_view.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_web\_view.cc](/oxide/tree/shared/browser/oxide_web_view.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -994,11 +994,11 @@ WebView::WebView(const CommonParams& common\_params, : WebView(common\_params.client) { CHECK(create\_params.context) << "Didn't specify a BrowserContext"; - scoped\_refptr<BrowserContext> context = create\_params.incognito ?+ BrowserContext\* context = create\_params.incognito ? create\_params.context->GetOffTheRecordContext() : create\_params.context->GetOriginalContext(); - content::WebContents::CreateParams content\_params(context.get());+ content::WebContents::CreateParams content\_params(context); content\_params.initial\_size = gfx::ToEnclosingRect(common\_params.view\_client->GetBounds()).size(); content\_params.initially\_hidden = !common\_params.view\_client->IsVisible();@@ -1013,7 +1013,7 @@ WebView::WebView(const CommonParams& common\_params, if (create\_params.restore\_entries.size() > 0) { std::vector<std::unique\_ptr<content::NavigationEntry>> entries = sessions::ContentSerializedNavigationBuilder::ToNavigationEntries(- create\_params.restore\_entries, context.get());+ create\_params.restore\_entries, context); web\_contents\_->GetController().Restore( create\_params.restore\_index, create\_params.restore\_type,diff --git a/shared/browser/oxide\_web\_view\_contents\_helper.cc b/shared/browser/oxide\_web\_view\_contents\_helper.ccindex a0aecf2e..e2443455 100644--- a/[shared/browser/oxide\_web\_view\_contents\_helper.cc](/oxide/tree/shared/browser/oxide_web_view_contents_helper.cc?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_web\_view\_contents\_helper.cc](/oxide/tree/shared/browser/oxide_web_view_contents_helper.cc?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -17,6 +17,9 @@  #include "oxide\_web\_view\_contents\_helper.h" +#include <set>++#include "base/lazy\_instance.h" #include "base/logging.h" #include "content/public/browser/render\_view\_host.h" #include "content/public/browser/web\_contents.h"@@ -26,6 +29,7 @@ #include "shared/common/oxide\_content\_client.h"  #include "oxide\_browser\_context.h"+#include "oxide\_web\_contents\_unloader.h" #include "oxide\_web\_contents\_view.h" #include "oxide\_web\_preferences.h" #include "oxide\_web\_view.h"@@ -34,9 +38,14 @@ namespace oxide {  namespace { const char kWebViewContentsHelperKey[] = "oxide\_web\_view\_contents\_helper\_data";+base::LazyInstance<std::set<WebViewContentsHelper\*>> g\_contents\_helpers =+ LAZY\_INSTANCE\_INITIALIZER; }  WebViewContentsHelper::~WebViewContentsHelper() {+ size\_t erased = g\_contents\_helpers.Get().erase(this);+ DCHECK\_GT(erased, 0U);+ if (web\_preferences() && owns\_web\_preferences\_) { WebPreferences\* prefs = web\_preferences(); WebPreferencesObserver::Observe(nullptr);@@ -57,14 +66,10 @@ void WebViewContentsHelper::NotifyPopupBlockerEnabledChanged() { UpdateWebPreferences(); } -void WebViewContentsHelper::WebPreferencesValueChanged() {- UpdateWebPreferences();-}- void WebViewContentsHelper::NotifyDoNotTrackChanged() { content::RendererPreferences\* renderer\_prefs = web\_contents\_->GetMutableRendererPrefs();- renderer\_prefs->enable\_do\_not\_track = context\_->GetDoNotTrack();+ renderer\_prefs->enable\_do\_not\_track = GetBrowserContext()->GetDoNotTrack();  // Send the new override string to the renderer. content::RenderViewHost\* rvh = web\_contents\_->GetRenderViewHost();@@ -88,20 +93,25 @@ void WebViewContentsHelper::OnShellModeChanged() { UpdateWebPreferences(); } +void WebViewContentsHelper::WebPreferencesValueChanged() {+ UpdateWebPreferences();+}+ WebViewContentsHelper::WebViewContentsHelper(content::WebContents\* contents, content::WebContents\* opener) : BrowserContextObserver( BrowserContext::FromContent(contents->GetBrowserContext())),- context\_(BrowserContext::FromContent(contents->GetBrowserContext())), web\_contents\_(contents), owns\_web\_preferences\_(false) { DCHECK(!FromWebContents(web\_contents\_)); + g\_contents\_helpers.Get().insert(this);+ web\_contents\_->SetUserData(kWebViewContentsHelperKey, this);  content::RendererPreferences\* renderer\_prefs = web\_contents\_->GetMutableRendererPrefs();- renderer\_prefs->enable\_do\_not\_track = context\_->GetDoNotTrack();+ renderer\_prefs->enable\_do\_not\_track = GetBrowserContext()->GetDoNotTrack();  // Hardcoded selection colors to match the current Ambiance theme from the // Ubuntu UI Toolkit (https://bazaar.launchpad.net/~ubuntu-sdk-team/ubuntu-ui-toolkit/trunk/view/head:/src/Ubuntu/Components/Themes/Ambiance/1.3/Palette.qml)@@ -135,7 +145,6 @@ WebViewContentsHelper\* WebViewContentsHelper::FromWebContents( contents->GetUserData(kWebViewContentsHelperKey)); } -// static WebViewContentsHelper\* WebViewContentsHelper::FromRenderViewHost( content::RenderViewHost\* rvh) { content::WebContents\* contents =@@ -147,12 +156,25 @@ WebViewContentsHelper\* WebViewContentsHelper::FromRenderViewHost( return FromWebContents(contents); } +// static+bool WebViewContentsHelper::IsContextInUse(BrowserContext\* context) {+ for (auto\* helper : g\_contents\_helpers.Get()) {+ if (helper->GetBrowserContext() == context &&+ !WebContentsUnloader::GetInstance()->IsUnloadInProgress(+ helper->GetWebContents())) {+ return true;+ }+ }++ return false;+}+ content::WebContents\* WebViewContentsHelper::GetWebContents() const { return web\_contents\_; }  BrowserContext\* WebViewContentsHelper::GetBrowserContext() const {- return context\_.get();+ return BrowserContext::FromContent(web\_contents\_->GetBrowserContext()); }  WebPreferences\* WebViewContentsHelper::GetWebPreferences() const {diff --git a/shared/browser/oxide\_web\_view\_contents\_helper.h b/shared/browser/oxide\_web\_view\_contents\_helper.hindex 9274bd53..3a5e474f 100644--- a/[shared/browser/oxide\_web\_view\_contents\_helper.h](/oxide/tree/shared/browser/oxide_web_view_contents_helper.h?id=648e85080604e22bab00b48428b4e80c522cabea)+++ b/[shared/browser/oxide\_web\_view\_contents\_helper.h](/oxide/tree/shared/browser/oxide_web_view_contents_helper.h?id=29014da83e5fc358d6bff0f574e9ed45e61a35ac)@@ -48,6 +48,8 @@ class WebViewContentsHelper final : private BrowserContextObserver, static WebViewContentsHelper\* FromWebContents(content::WebContents\* contents); static WebViewContentsHelper\* FromRenderViewHost(content::RenderViewHost\* rvh); + static bool IsContextInUse(BrowserContext\* context);+ content::WebContents\* GetWebContents() const; BrowserContext\* GetBrowserContext() const; @@ -72,7 +74,6 @@ class WebViewContentsHelper final : private BrowserContextObserver, // WebPreferencesObserver implementation void WebPreferencesValueChanged() final; - scoped\_refptr<BrowserContext> context\_; content::WebContents\* web\_contents\_;  bool owns\_web\_preferences\_; |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-24 13:19:49 +0000


