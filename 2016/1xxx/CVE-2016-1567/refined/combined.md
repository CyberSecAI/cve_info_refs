=== Content from www.talosintel.com_c6997524_20250124_174537.html ===


* [Cisco Login](/users/auth/saml)

* [Intelligence Center](/reputation)

  + [# Intelligence Center](/reputation)
  + BACK
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* [Vulnerability Research](/vulnerability_info)

  + [# Vulnerability Research](/vulnerability_info)
  + BACK
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* [Incident Response](/incident_response)

  + [# Incident Response](/incident_response)
  + BACK
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* [Blog](https://blog.talosintelligence.com)
* [Support](https://support.talosintelligence.com)

More

* Security Resources

  # Security Resources

  + BACK
  Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* Media

  # Media

  + BACK
  Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* Company

  # Company

  + BACK
  Company
  + [About Talos](/about)
  + [Careers](/careers)

* Under Attack?
* [Cisco Login](/users/auth/saml)

## Contact Cisco Talos Incident Response

×

Close

This form is for Incident Response service inquiries only, including emergency network security needs.

For reputation or categorization inquiries, visit the [Talos Support site](/support).
For emergency DDoS mitigation assistance, please contact the [Cisco Secure DDoS Protection Team](https://www.cisco.com/c/en/us/products/collateral/security/ddos-emergency-attack-mitigation-aag.pdf).

Name

Company (optional)

Email address

Phone number

Preferred communication:

Email

Phone

What Incident Response Service are you interested in?
General Talos IR services and retainer information
Emergency Response
IR Plan
IR Playbooks
IR Readiness Assessment
Tabletop Exercises
Compromise Assessment
Threat Hunting
Cyber Range Training
Intelligence on Demand

Please provide as much detail as possible so we can best address your needs

I acknowledge that this is an inquiry for Incident Response services and that any other use of this form will not receive a response.

Send Email
Cancel

# Talos Vulnerability Report

### TALOS-2016-0071

## Network Time Protocol Skeleton Key: Symmetric Authentication Impersonation Vulnerability

##### January 19, 2016

##### CVE Number

CVE-2015-7974, CVE-2016-1567

CERT VU#357792

### Summary

Symmetric key encryption requires a single trusted key to be specified for
each server configuration. A key specified only for one server should only work
to authenticate that server, other trusted keys should be refused.

Instead we observe that when symmetric key authentication is verified, there is
no check that the key used is the key specified for the address, any trusted key
can be used as long as the keyid references another key the systems share and
that key is used to compute the MAC.

This has three implications for the client server model. A client that has multiple
servers configured each with different keys could be attacked by one of its servers
spoofing every other server using its own key. Even worse a server can be attacked
by any of its authenticated clients in a similar manner.

Finally, being able to use any key to authenticate a packet for a client or server
means that if any key in the trustedkeys list uses a weak digest algorithim (MD5),
then an attacker can abuse that method instead of being restricted by the stronger
keys configured.

NOTE: Code locations referenced below refer to the NTP reference
implementation from http://www.ntp.org.

There is no clear location in the code where this defect occurs, since it exists
due to an omission. Verifying the key used matches the proper server’s key could be
done in ntp\_proto.c around line 803 (in 4.8.2p3) where authdecrypt is called, or
it might make sense to build it into the libntp code such as the authdecrypt
function itself.

Be aware that this issue could affect other ntpd modes of operation such as
broadcast or active/passive peering.

### Tested Versions

NTP 4.2.8p3

NTPsec a5fb34b9cc89b92a8fef2f459004865c93bb7f92

chrony 2.2

### Product URLs

(http://www.ntp.org/)[http://www.ntp.org/]
(https://www.ntpsec.org/)[https://www.ntpsec.org/]
(http://chrony.tuxfamily.org/)[http://chrony.tuxfamily.org/]

### CVSS Score

CVSSv2: 3.6 - AV:N/AC:H/Au:S/C:N/I:P/A:P

CVSSv3: 4.2 - CVSS:3.0/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:L

### Details

ntpd does not ensure that the key used to verify the authenticity of a
packet actually belongs to the alleged sender of the packet.

The intended binding between keys (via keyids) and peers is indicated
to ntpd through the configuration file. For example:

```
server ntp-server key 1

```

indicates that keyid 1 is a symmetric key shared with ntp-server.
Packets bound for ntp-server should be authenticated under keyid 1
and, to prevent impersonation, packets from ntp-server should be
authenticated using keyid 1.

Unfortunately, when receiving a packet, allegedly from ntp-sever, ntpd
does not require the packet to authenticate under keyid 1. ntpd only
ensures that the packet authenticates under *some* trustedkey known to
ntpd. This allows any authenticated peer to impersonate any other
authenticated peer.

We confirmed this vulnerability with the following setup. (The tests
below were performed with NTP 4.2.8p3. 4.2.8p4 appears to introduce
regressions which break LOCAL refclocks and symmetric associations.)

* ntp-server - simulated stratum 1 server to provide time to clients

  ```
    # /etc/ntp.conf
    keys /etc/ntp.keys
    trustedkey 1
    server 127.127.1.1 prefer
    fudge 127.127.1.1 stratum 0

    # /etc/ntp.keys:
    1 MD5 youllneverguess
    2 MD5 you_really_wont

  ```
* ntp-client - authenticates ntp-server with keyid 1 and ntp-client2
  with keyid 2

  ```
    # /etc/ntp.conf
    keys /etc/ntp.keys
    trustedkey 1 2
    server ntp-server key 1 minpoll 2 maxpoll 2 iburst
    peer ntp-client2 key 2 minpoll 2 maxpoll 2 noselect

    # /etc/ntp.keys
    1 MD5 youllneverguess
    2 MD5 you_really_wont

  ```
* ntp-client2 - authenticates ntp-server with keyid 1, uses keyid 1 to
  talk to ntp-client

  ```
    # /etc/ntp.conf
    keys /etc/ntp.keys
    trustedkey 1 2
    server ntp-server key 1 minpoll 2 maxpoll 2 iburst
    peer ntp-client key 1 minpoll 2 maxpoll 2

    # /etc/ntp.keys
    1 MD5 youllneverguess
    2 MD5 you_really_wont

  ```
* attacker1 (192.168.33.9) - conducts a man-in-the-middle attack using
  ntp-client2’s peer key (keyid 2) to impersonate ntp-server to
  ntp-client and shift time

  attacker1 uses an ARP-spoofing attack to intercept and replay all
  packets between ntp-client and ntp-server. When it receives a
  server mode packet, it modifies the sent and recv time to be 100
  years in the future. It then authenticates the packet with
  ntp-client2’s key (keyid 2). In this specific attack, the
  timestamps overflow so 100 years in the future from 2015 is 1979.

  ntp-client accepts the forged replies as though they were coming
  from ntp-server and, eventually, steps its clock.

### Do The Sender and Recipient Have to Agree on the Keyid?

According to the ntpd documentation `html/authentic.html`:

> The servers and clients involved must agree on the key ID, key type
> and key to authenticate NTP packets.

Though it doesn’t indicate precisely what “agreement” means or why,
this conflicts with RFC 5905 which states:

> keyid: Symmetric key ID for the 128-bit MD5 key used to generate and
> verify the MAC. The client and server or peer can use different
> values, but they must map to the same key.

This statement is problematic and only partially true. It is
problematic because it does not address the binding of symmetric keys
(specified by keyid) to the peers that they authenticate, allowing for
impersonation between peers. It is only partially true because, in
client-server modes, the server will use the keyid from the client
mode packet to authenticate the incoming client mode packet as well as
the outgoing server mode packet. Thus, in a benign scenario, clients
and server must agree both on keyid and the key value. In symmetric
modes, the statement is partially true because each peer uses the
keyid specified in its peer association when generating an outgoing
packet. However, in all cases, the keyid specified in an incoming
packet will be used to authenticate that packet. Therefore, even in
symmetric modes, if the two peers use different keyids A and B for a
given symmetric association, each peer must map *both* keyids to the
same key — the sender will use A (respectively B) to generate the
authenticator for the outgoing packet and, therefore, the recipient
will use A (respectively B) to authenticate the incoming packet. This
is illustrated by the non-normative example code from RFC 5905:

* According to receive() (https://tools.ietf.org/html/rfc5905#page-78)
  the keyid in the received packet is used to look up the key to
  authenticate the packet.
* The keyid in the received packet is used to set the peer keyid for
  manycast peers (https://tools.ietf.org/html/rfc5905#page-78),
  symmetric peers (https://tools.ietf.org/html/rfc5905#page-79), and
  broadcast peers.
* The keyid in the received packet is also used to choose the
  keyid and key to authenticate the transmitted packet in
  fast\_xmit() (https://tools.ietf.org/html/rfc5905#page-88)
* In peer\_xmit() (https://tools.ietf.org/html/rfc5905#page-108)
  the keyid of the peer is used to authenticate the transmitted
  packet. It appears to omit setting the keyid on the transmitted
  packet. But, for preemptable associations, the peer keyid came
  from a received packet. For configured associations, it’s the
  value from the configuration file.

This is also borne out by the ntpd source code. When ntpd receives an
incoming packet with an authenticator, it verifies the authentication
under the key specified by the keyid from the incoming packet:

* receive() reads the keyid from the packet:

  ```
    skeyid = ntohl(((u_int32 *)pkt)[authlen / 4]);

  ```
* receive() then calls authdecrypt() with that keyid:

  ```
    if (!authdecrypt(skeyid, (u_int32 *)pkt, authlen,
        has_mac))
        is_authentic = AUTH_ERROR;
    else
        is_authentic = AUTH_OK;

  ```
* authdecrypt() calls authhavekey() which looks up the key by
  keyid:

  ```
    if (id == sk->keyid) {
        if (0 == sk->type) {

  ```
* And finally, MD5authdecrypt() is called to compute and verify the
  digest using the key value found via the packet’s key id
* But, there is never a check which verifies that the keyid from the
  incoming packet (skeyid) matches the keyid configured for the peer
  association in question (peer->keyid)

### Test Case: Equal keyids Refer to Differing Key Material

To verify that the sender and recipient can’t merely use different
keyids to refer to the same key material unless *both* have been
configured to map *both* keyids to the same key, we configured
ntp-client2 with the same keys as ntp-server and ntp-client, but we
swapped the keyids on ntp-client2. This confirmed that, though
ntp-client2 was using the same key material as the other two nodes, all
packets from ntp-client2 would fail authentication because the other
nodes did not also have the same key material mapped to the keyids
sent by ntp-client2.

* ntp-client can sync with ntp-server just fine

  ```
    # /etc/ntp.keys
    1 MD5 youllneverguess
    2 MD5 you_really_wont

    # /etc/ntp.conf
    keys /etc/ntp.keys
    trustedkey 1 2

    server ntp-server key 1 minpoll 2 maxpoll 2 iburst
    peer ntp-client2  key 2 minpoll 2 maxpoll 2

    ntp-client$ ntpq -c as

    ind assid status  conf reach auth condition  last_event cnt
    ===========================================================
      1 43544  f65a   yes   yes   ok   sys.peer    sys_peer  5  # ntp-server
      2 43545  e01a   yes    no   ok     reject    sys_peer  1  # ntp-client2

  ```

  ntp-client detects that ntp-client2’s packets fail authentication.
  However, because ntp-client2 is also rejecting ntp-client’s
  packets due to bad auth, the origin timestamp doesn’t match and
  that check fails first before an auth check is performed. Note
  the `auth 2` (AUTH\_ERROR) on line 2 of the log snippet below.

  ```
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): calling authdecrypt
    Nov  3 19:23:37 ntp-client ntpd: receive: at 698 192.168.33.11<-192.168.33.13 mode 1 keyid 00000001 len 68 auth 2
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): big switch
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): AM_PROCPKT, regular packet
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): done with big switch
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): flip is 0, not interleaved
    Nov  3 19:23:37 ntp-client ntpd: (ntp_proto.c): met bogus condition (p_org is not qual to peer->aorg), test2

  ```
* ntp-client2 uses the same keys but different ids.

  ```
    # /etc/ntp.keys
    2 MD5 youllneverguess
    1 MD5 you_really_wont

    # /etc/ntp.conf
    keys /etc/ntp.keys
    trustedkey 1 2

    server ntp-server key 2 minpoll 2 maxpoll 2 iburst
    peer ntp-client   key 1 minpoll 2 maxpoll 2

  ```

  We can see that ntp-client2 is rejecting both the server and the peer
  due to bad auth.

  ```
    ntp-client2$ ntpq -c as

    ind assid status  conf reach auth condition  last_event cnt
    ===========================================================
      1 64340  c01c   yes    no   bad    reject              1  # ntp-server
      2 64341  c01c   yes    no   bad    reject              1  # ntp-client

  ```

  We can see this when ntp-client2 receives a packet from ntp-client:

  ```
    Nov  3 19:40:29 ntp-client2 ntpd: receive: at 1438 192.168.33.13<-192.168.33.11 mode 1 keyid 00000002 len 68 auth 2
    Nov  3 19:40:29 ntp-client2 ntpd: (ntp_proto.c): big switch
    Nov  3 19:40:29 ntp-client2 ntpd: (ntp_proto.c): AM_PROCPKT, regular packet
    Nov  3 19:40:29 ntp-client2 ntpd: (ntp_proto.c): done with big switch
    Nov  3 19:40:29 ntp-client2 ntpd: (ntp_proto.c): flip is 0, not interleaved
    Nov  3 19:40:29 ntp-client2 ntpd: (ntp_proto.c): digest failed
    Nov  3 19:40:29 ntp-client2 ntpd: event at 1438 192.168.33.11 c01c 8c bad_auth digest

  ```

### Test Case: Using Different keyids That Map To The Same Key Material

This tests confirms that, as long as the sender and the recipient have
the same key material configured for a given keyid, the recipient
won’t enforce the binding between the keyid configured for an
association and the keyid used to authenticate an incoming packet
under that association.

We configure the same keys on both hosts

```
# /etc/ntp.keys on both hosts
1 MD5 youllneverguess
2 MD5 you_really_wont

```

But ntp-client uses keyid 2 to communicate with ntp-client2.

```
# ntp-client /etc/ntp.conf
keys /etc/ntp.keys
trustedkey 1 2

server ntp-server iburst key 1 minpoll 2 maxpoll 2
peer ntp-client2 key 2

```

And ntp-client2 uses keyid 1 when sending packets to ntp-client.

```
# ntp-client2 /etc/ntp.conf
keys /etc/ntp.keys
trustedkey 1 2

server ntp-server iburst key 1 minpoll 2 maxpoll 2
peer ntp-client key 1

```

As can be seen here, both ntp-client and ntp-client2 accept the
packets from their peer despite being configured to use different
keyids.

```
ntp-client$ ntpq -c as
ind assid status  conf reach auth condition  last_event cnt
===========================================================
  1 55125  f65a   yes   yes   ok   sys.peer    sys_peer  5  # ntp-server
  2 55126  f03a   yes   yes   ok     reject    sys_peer  3  # ntp-client2

ntp-client2$ ntpq -c as
ind assid status  conf reach auth condition  last_event cnt
===========================================================
  1 53439  f63a   yes   yes   ok   sys.peer    sys_peer  3  # ntp-server
  2 53440  f024   yes   yes   ok     reject   reachable  2  # ntp-client

```
### Possible Fix

The following (untested) patch ensures that the keyid used to
authenticate the packet is the same as the keyid configured for the
corresponding peer association. If not, it sets `is_authentic` to
`AUTH_ERROR` and skips the call to `authdecrypt()`.

```
diff --git a/ntpd/ntp_proto.c b/ntpd/ntp_proto.c
index 2a15d72..01959f0 100644
--- a/ntpd/ntp_proto.c
+++ b/ntpd/ntp_proto.c
@@ -840,6 +840,11 @@ receive(
 		}
 #endif	/* AUTOKEY */

+ 		/* Ensure that the packet actually came from the expected peer */
+ 		if(skeyid <= NTP_MAXKEY && peer && skeyid != peer->keyid) {
+  			is_authentic = AUTH_ERROR;
+  			// TODO: log impersonation attempt
+
 		/*
 		 * Compute the cryptosum. Note a clogging attack may
 		 * succeed in bloating the key cache. If an autokey,
@@ -847,11 +852,13 @@ receive(
 		 * again. If the packet is authentic, it can mobilize an
 		 * association. Note that there is no key zero.
 		 */
-		if (!authdecrypt(skeyid, (u_int32 *)pkt, authlen,
+  		} else if (!authdecrypt(skeyid, (u_int32 *)pkt, authlen,
 		    has_mac))
 			is_authentic = AUTH_ERROR;
 		else
 			is_authentic = AUTH_OK;
+
+
 #ifdef AUTOKEY
 		if (crypto_flags && skeyid > NTP_MAXKEY)
 			authtrust(skeyid, 0);

```
### Timeline

2015-10-07 - Vendor Disclosure

2016-01-19 - Public Release

##### Credit

Matt Street

---

[Vulnerability Reports](/vulnerability_reports) [Next Report

TALOS-2016-0072](/vulnerability_reports/TALOS-2016-0072) [Previous Report

TALOS-2016-0070](/vulnerability_reports/TALOS-2016-0070)

* + ###### [Intelligence Center](/reputation)
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* + ###### [Vulnerability Research](/vulnerability_info)
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* + ###### [Incident Response](/incident_response)
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* + ###### Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* + ###### Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* + ###### Support
  + [Support Documentation](https://support.talosintelligence.com)
* + ###### Company
  + [About Talos](/about)
  + [Careers](/careers)
  + [Cisco Security](https://www.cisco.com/c/en/us/products/security/product-listing.html)

###### Follow us

[![Cisco](/assets/logo_cisco_white-d87b7f7d3152ad412e48aad924a972cc5b802b7a53cb56b0792a4456c9b7b3a5.svg)](http://tools.cisco.com/security/center/home.x)

©
2025
Cisco Systems, Inc. and/or its affiliates. All rights
reserved. View our
[Privacy Policy.](http://www.cisco.com/web/siteassets/legal/privacy_full.html)



=== Content from chrony.tuxfamily.org_5b3c1005_20250124_174535.html ===

# c h r o n y

* [Introduction](./index.html)
* [News](./news.html)
* [Download](./download.html)
* [Documentation](./documentation.html)
* [FAQ](./faq.html)
* [Examples](./examples.html)
* [Mailing lists](./lists.html)
* [Comparison](./comparison.html)
* [Contributing](./contributing.html)
* [Links](./links.html)

# News

## 8 Oct 2024: chrony-4.6.1 released

### Enhancements

* Add ntsaeads directive to enable only selected AEAD algorithms for NTS

### Workarounds

* [Negotiate use of compliant NTS
  keys with AES-128-GCM-SIV AEAD algorithm](doc/spec/nts-compliant-128gcm.html)
  (by default the keys are generated differently than in RFC 8915 for
  compatibility with chrony server and client versions 4.4, 4.5, and 4.6)
* Switch to compliant NTS keys if first response from server is NTS NAK

## 2 Sep 2024: chrony-4.6 released

### Enhancements

* Add activate option to local directive to set activation threshold
* Add ipv4 and ipv6 options to server/pool/peer directive
* Add kod option to ratelimit directive for server KoD RATE support
* Add leapseclist directive to read NIST/IERS leap-seconds.list file
* Add ptpdomain directive to set PTP domain for NTP over PTP
* Allow disabling pidfile
* Improve copy server option to accept unsynchronised status instantly
* Log one selection failure on start
* Add offset command to modify source offset correction
* Add timestamp sources to ntpdata report

### Bug fixes

* Fix crash on sources reload during initstepslew or RTC initialisation
* Fix source refreshment to not repeat failed name resolving attempts

## 5 Dec 2023: chrony-4.5 released

### Enhancements

* Add support for AES-GCM-SIV in GnuTLS
* Add support for corrections from PTP transparent clocks
* Add support for systemd socket activation

### Bug fixes

* Fix presend in interleaved mode
* Fix reloading of modified sources from sourcedir

## 9 Aug 2023: chrony-4.4 released

### Enhancements

* Add support for AES-GCM-SIV with Nettle >= 3.9 to shorten NTS
  cookies to avoid some length-specific blocking of NTP on Internet
* Add support for multiple refclocks using extpps option on one PHC
* Add maxpoll option to hwtimestamp directive to improve PHC tracking
  with low packet rates
* Add hwtstimeout directive to configure timeout for late timestamps
* Handle late hardware transmit timestamps of NTP requests on all sockets
* Handle mismatched 32/64-bit time\_t in SOCK refclock samples
* Improve source replacement
* Log important changes made by command requests (chronyc)
* Refresh address of NTP sources periodically
* Request nanosecond kernel RX timestamping on FreeBSD
* Set DSCP for IPv6 packets
* Shorten NTS-KE retry interval when network is down
* Update seccomp filter for musl
* Warn if loading keys from file with unexpected permissions
* Warn if source selection fails or falseticker is detected
* Add selectopts command to modify source-specific selection options
* Add timestamp sources to serverstats report and make its fields 64-bit
* Add -e option to chronyc to indicate end of response

## 31 Aug 2022: chrony-4.3 released

### Enhancements

* Add local option to refclock directive to stabilise system clock
  with more stable free-running clock (e.g. TCXO, OCXO)
* Add maxdelayquant option to server/pool/peer directive to replace
  maxdelaydevratio filter with long-term quantile-based filtering
* Add selection option to log directive
* Allow external PPS in PHC refclock without configurable pin
* Don’t accept first interleaved response to minimise error in delay
* Don’t use arc4random on Linux to avoid server performance loss
* Improve filter option to better handle missing NTP samples
* Improve stability with hardware timestamping and PHC refclock
* Update seccomp filter

### Bug fixes

* Fix waitsync command to reconnect when not getting response

## 16 Dec 2021: chrony-4.2 released

### Enhancements

* Add support for NTPv4 extension field improving synchronisation
  stability and resolution of root delay and dispersion (experimental)
* Add support for NTP over PTP (experimental)
* Add support for AES-CMAC and hash functions in GnuTLS
* Improve server interleaved mode to be more reliable and support
  multiple clients behind NAT
* Update seccomp filter
* Add statistics about interleaved mode to serverstats report

### Bug fixes

* Fix RTC support with 64-bit time\_t on 32-bit Linux
* Fix seccomp filter to work correctly with bind\*device directives
* Suppress kernel adjustments of system clock (dosynctodr) on illumos

### Other changes

* Switch Solaris support to illumos

## 13 May 2021: chrony-4.1 released

### Enhancements

* Add support for NTS servers specified by IP address (matching
  Subject Alternative Name in server certificate)
* Add source-specific configuration of trusted certificates
* Allow multiple files and directories with trusted certificates
* Allow multiple pairs of server keys and certificates
* Add copy option to server/pool directive
* Increase PPS lock limit to 40% of pulse interval
* Perform source selection immediately after loading dump files
* Reload dump files for addresses negotiated by NTS-KE server
* Update seccomp filter and add less restrictive level
* Restart ongoing name resolution on online command

### Bug fixes

* Fix responding to IPv4 command requests on FreeBSD
* Fix dump files to not include uncorrected offset
* Fix initstepslew to accept time from own NTP clients
* Reset NTP address and port when no longer negotiated by NTS-KE server

## 7 Oct 2020: chrony-4.0 released

### Enhancements

* Add support for Network Time Security (NTS) authentication
* Add support for AES-CMAC keys (AES128, AES256) with Nettle
* Add authselectmode directive to control selection of unauthenticated sources
* Add binddevice, bindacqdevice, bindcmddevice directives
* Add confdir directive to better support fragmented configuration
* Add sourcedir directive and "reload sources" command to support dynamic
  NTP sources specified in files
* Add clockprecision directive
* Add dscp directive to set Differentiated Services Code Point (DSCP)
* Add -L option to limit log messages by severity
* Add -p option to print whole configuration with included files
* Add -U option to allow start under non-root user
* Allow maxsamples to be set to 1 for faster update with -q/-Q option
* Avoid replacing NTP sources with sources that have unreachable address
* Improve pools to repeat name resolution to get "maxsources" sources
* Improve source selection with trusted sources
* Improve NTP loop test to prevent synchronisation to itself
* Repeat iburst when NTP source is switched from offline state to online
* Update clock synchronisation status and leap status more frequently
* Update seccomp filter
* Add "add pool" command
* Add "reset sources" command to drop all measurements
* Add authdata command to print details about NTP authentication
* Add selectdata command to print details about source selection
* Add -N option and sourcename command to print original names of sources
* Add -a option to some commands to print also unresolved sources
* Add -k, -p, -r options to clients command to select, limit, reset data

### Bug fixes

* Don’t set interface for NTP responses to allow asymmetric routing
* Handle RTCs that don’t support interrupts
* Respond to command requests with correct address on multihomed hosts

### Removed features

* Drop support for RIPEMD keys (RMD128, RMD160, RMD256, RMD320)
* Drop support for long (non-standard) MACs in NTPv4 packets (chrony 2.x
  clients using non-MD5/SHA1 keys need to use option "version 3")
* Drop support for line editing with GNU Readline

## 20 Aug 2020: chrony-3.5.1 released

### Security fixes

* Create new file when writing pidfile (CVE-2020-14367)

### CVE-2020-14367: Insecure writing of pidfile

When chronyd is configured to save the pidfile in a directory where the
chrony user has write permissions (e.g. /var/run/chrony - the default
since chrony-3.4), an attacker that compromised the chrony user account
could create a symbolic link at the location of the pidfile to make
chronyd starting with root privileges follow the symlink and write its
process ID to a file for which the chrony user doesn’t have write
permissions, causing a denial of service, or data loss.

This issue was reported by Matthias Gerstner of SUSE.

## 14 May 2019: chrony-3.5 released

### Enhancements

* Add support for more accurate reading of PHC on Linux 5.0
* Add support for hardware timestamping on interfaces with read-only
  timestamping configuration
* Add support for memory locking and real-time priority on FreeBSD,
  NetBSD, Solaris
* Update seccomp filter to work on more architectures
* Validate refclock driver options

### Bug fixes

* Fix bindaddress directive on FreeBSD
* Fix transposition of hardware RX timestamp on Linux 4.13 and later
* Fix building on non-glibc systems

## 19 Sep 2018: chrony-3.4 released

### Enhancements

* Add filter option to server/pool/peer directive
* Add minsamples and maxsamples options to hwtimestamp directive
* Add support for faster frequency adjustments in Linux 4.19
* Change default pidfile to /var/run/chrony/chronyd.pid to allow
  chronyd without root privileges to remove it on exit
* Disable sub-second polling intervals for distant NTP sources
* Extend range of supported sub-second polling intervals
* Get/set IPv4 destination/source address of NTP packets on FreeBSD
* Make burst options and command useful with short polling intervals
* Modify auto\_offline option to activate when sending request failed
* Respond from interface that received NTP request if possible
* Add onoffline command to switch between online and offline state
  according to current system network configuration
* Improve example NetworkManager dispatcher script

### Bug fixes

* Avoid waiting in Linux getrandom system call
* Fix PPS support on FreeBSD and NetBSD

## 4 Apr 2018: chrony-3.3 released

### Enhancements

* Add burst option to server/pool directive
* Add stratum and tai options to refclock directive
* Add support for Nettle crypto library
* Add workaround for missing kernel receive timestamps on Linux
* Wait for late hardware transmit timestamps
* Improve source selection with unreachable sources
* Improve protection against replay attacks on symmetric mode
* Allow PHC refclock to use socket in /var/run/chrony
* Add shutdown command to stop chronyd
* Simplify format of response to manual list command
* Improve handling of unknown responses in chronyc

### Bug fixes

* Respond to NTPv1 client requests with zero mode
* Fix -x option to not require CAP\_SYS\_TIME under non-root user
* Fix acquisitionport directive to work with privilege separation
* Fix handling of socket errors on Linux to avoid high CPU usage
* Fix chronyc to not get stuck in infinite loop after clock step

## 15 Sep 2017: chrony-3.2 released

### Enhancements

* Improve stability with NTP sources and reference clocks
* Improve stability with hardware timestamping
* Improve support for NTP interleaved modes
* Control frequency of system clock on macOS 10.13 and later
* Set TAI-UTC offset of system clock with leapsectz directive
* Minimise data in client requests to improve privacy
* Allow transmit-only hardware timestamping
* Add support for new timestamping options introduced in Linux 4.13
* Add root delay, root dispersion and maximum error to tracking log
* Add mindelay and asymmetry options to server/peer/pool directive
* Add extpps option to PHC refclock to timestamp external PPS signal
* Add pps option to refclock directive to treat any refclock as PPS
* Add width option to refclock directive to filter wrong pulse edges
* Add rxfilter option to hwtimestamp directive
* Add -x option to disable control of system clock
* Add -l option to log to specified file instead of syslog
* Allow multiple command-line options to be specified together
* Allow starting without root privileges with -Q option
* Update seccomp filter for new glibc versions
* Dump history on exit by default with dumpdir directive
* Use hardening compiler options by default

### Bug fixes

* Don’t drop PHC samples with low-resolution system clock
* Ignore outliers in PHC tracking, RTC tracking, manual input
* Increase polling interval when peer is not responding
* Exit with error message when include directive fails
* Don’t allow slash after hostname in allow/deny directive/command
* Try to connect to all addresses in chronyc before giving up

## 31 Jan 2017: chrony-3.1 released

### Enhancements

* Add support for precise cross timestamping of PHC on Linux
* Add minpoll, precision, nocrossts options to hwtimestamp directive
* Add rawmeasurements option to log directive and modify measurements
  option to log only valid measurements from synchronised sources
* Allow sub-second polling interval with NTP sources

### Bug fixes

* Fix time smoothing in interleaved mode

## 16 Jan 2017: chrony-3.0 released

### Enhancements

* Add support for software and hardware timestamping on Linux
* Add support for client/server and symmetric interleaved modes
* Add support for MS-SNTP authentication in Samba
* Add support for truncated MACs in NTPv4 packets
* Estimate and correct for asymmetric network jitter
* Increase default minsamples and polltarget to improve stability
  with very low jitter
* Add maxjitter directive to limit source selection by jitter
* Add offset option to server/pool/peer directive
* Add maxlockage option to refclock directive
* Add -t option to chronyd to exit after specified time
* Add partial protection against replay attacks on symmetric mode
* Don’t reset polling interval when switching sources to online state
* Allow rate limiting with very short intervals
* Improve maximum server throughput on Linux and NetBSD
* Remove dump files after start
* Add tab-completion to chronyc with libedit/readline
* Add ntpdata command to print details about NTP measurements
* Allow all source options to be set in add server/peer command
* Indicate truncated addresses/hostnames in chronyc output
* Print reference IDs as hexadecimal numbers to avoid confusion with
  IPv4 addresses

### Bug fixes

* Fix crash with disabled asynchronous name resolving

## 21 Nov 2016: chrony-2.4.1 released

### Bug fixes

* Fix processing of kernel timestamps on non-Linux systems
* Fix crash with smoothtime directive
* Fix validation of refclock sample times
* Fix parsing of refclock directive

## 7 Jun 2016: chrony-2.4 released

### Enhancements

* Add orphan option to local directive for orphan mode compatible with ntpd
* Add distance option to local directive to set activation threshold
  (1 second by default)
* Add maxdrift directive to set maximum allowed drift of system clock
* Try to replace NTP sources exceeding maximum distance
* Randomise source replacement to avoid getting stuck with bad sources
* Randomise selection of sources from pools on start
* Ignore reference timestamp as ntpd doesn’t always set it correctly
* Modify tracking report to use same values as seen by NTP clients
* Add -c option to chronyc to write reports in CSV format
* Provide detailed manual pages

### Bug fixes

* Fix SOCK refclock to work correctly when not specified as last refclock
* Fix initstepslew and -q/-Q options to accept time from own NTP clients
* Fix authentication with keys using 512-bit hash functions
* Fix crash on exit when multiple signals are received
* Fix conversion of very small floating-point numbers in command packets

### Removed features

* Drop documentation in Texinfo format

## 16 Feb 2016: chrony-2.3 released

### Enhancements

* Add support for NTP and command response rate limiting
* Add support for dropping root privileges on Mac OS X, FreeBSD, Solaris
* Add require and trust options for source selection
* Enable logchange by default (1 second threshold)
* Set RTC on Mac OS X with rtcsync directive
* Allow binding to NTP port after dropping root privileges on NetBSD
* Drop CAP\_NET\_BIND\_SERVICE capability on Linux when NTP port is disabled
* Resolve names in separate process when seccomp filter is enabled
* Replace old records in client log when memory limit is reached
* Don’t reveal local time and synchronisation state in client packets
* Don’t keep client sockets open for longer than necessary
* Ignore poll in KoD RATE packets as ntpd doesn’t always set it correctly
* Warn when using keys shorter than 80 bits
* Add keygen command to generate random keys easily
* Add serverstats command to report NTP and command packet statistics

### Bug fixes

* Fix clock correction after making step on Mac OS X
* Fix building on Solaris

## 20 Jan 2016: chrony-2.2.1 and chrony-1.31.2 released

### Security fixes

* Restrict authentication of NTP server/peer to specified key (CVE-2016-1567)

### CVE-2016-1567: Impersonation between authenticated peers

When a server/peer was specified with a key number to enable
authentication with a symmetric key, packets received from the
server/peer were accepted if they were authenticated with any of
the keys contained in the key file and not just the specified key.

This allowed an attacker who knew one key of a client/peer to modify
packets from its servers/peers that were authenticated with other
keys in a man-in-the-middle (MITM) attack. For example, in a network
where each NTP association had a separate key and all hosts had only
keys they needed, a client of a server could not attack other clients
of the server, but it could attack the server and also attack its own
clients (i.e. modify packets from other servers).

To not allow the server/peer to be authenticated with other keys, the
authentication test was extended to check if the key ID in the received
packet is equal to the configured key number. As a consequence, it’s
no longer possible to authenticate two peers to each other with two
different keys, both peers have to be configured to use the same key.

This issue was discovered by Matt Street of Cisco ASIG.

## 19 Oct 2015: chrony-2.2 released

### Enhancements

* Add support for configuration and monitoring over Unix domain socket
  (accessible by root or chrony user when root privileges are dropped)
* Add support for system call filtering with seccomp on Linux (experimental)
* Add support for dropping root privileges on NetBSD
* Control frequency of system clock on FreeBSD, NetBSD, Solaris
* Add system leap second handling mode on FreeBSD, NetBSD, Solaris
* Add dynamic drift removal on Mac OS X
* Add support for setting real-time priority on Mac OS X
* Add maxdistance directive to limit source selection by root distance
  (3 seconds by default)
* Add refresh command to get new addresses of NTP sources
* Allow wildcard patterns in include directive
* Restore time from driftfile with -s option if later than RTC time
* Add configure option to set default hwclockfile
* Add -d option to chronyc to enable debug messages
* Allow multiple addresses to be specified for chronyc with -h option
  and reconnect when no valid reply is received
* Make check interval in waitsync command configurable

### Bug fixes

* Fix building on NetBSD, Solaris
* Restore time from driftfile with -s option if reading RTC failed

### Removed features

* Drop support for authentication with command key (run-time configuration
  is now allowed only for local users that can access the Unix domain socket)

## 23 Jun 2015: chrony-2.1.1 released

### Bug fixes

* Fix clock stepping by integer number of seconds on Linux

## 22 Jun 2015: chrony-2.1 released

### Enhancements

* Add support for Mac OS X
* Try to replace unreachable and falseticker servers/peers specified
  by name like pool sources
* Add leaponly option to smoothtime directive to allow synchronised
  leap smear between multiple servers
* Use specific reference ID when smoothing served time
* Add smoothing command to report time smoothing status
* Add smoothtime command to activate or reset time smoothing

### Bug fixes

* Fix crash in source selection with preferred sources
* Fix resetting of time smoothing
* Include packet precision in peer dispersion
* Fix crash in chronyc on invalid command syntax

## 27 Apr 2015: chrony-2.0 released

### Enhancements

* Update to NTP version 4 (RFC 5905)
* Add pool directive to specify pool of NTP servers
* Add leapsecmode directive to select how to correct clock for leap second
* Add smoothtime directive to smooth served time and enable leap smear
* Add minsources directive to set required number of selectable sources
* Add minsamples and maxsamples options for all sources
* Add tempcomp configuration with list of points
* Allow unlimited number of NTP sources, refclocks and keys
* Allow unreachable sources to remain selected
* Improve source selection
* Handle offline sources as unreachable
* Open NTP server port only when necessary (client access is allowed by
  allow directive/command or peer/broadcast is configured)
* Change default bindcmdaddress to loopback address
* Change default maxdelay to 3 seconds
* Change default stratumweight to 0.001
* Update adjtimex synchronisation status
* Use system headers for adjtimex
* Check for memory allocation errors
* Reduce memory usage
* Add configure options to compile without NTP, cmdmon, refclock support
* Extend makestep command to set automatic clock stepping

### Bug fixes

* Add sanity checks for time and frequency offset
* Don’t report synchronised status during leap second
* Don’t combine reference clocks with close NTP sources
* Fix accepting requests from configured sources
* Fix initial fallback drift setting

## 7 Apr 2015: chrony-1.31.1 released

### Security fixes

* Protect authenticated symmetric NTP associations against DoS attacks
  (CVE-2015-1853)
* Fix access configuration with subnet size indivisible by 4 (CVE-2015-1821)
* Fix initialization of reply slots for authenticated commands (CVE-2015-1822)

### CVE-2015-1853: DoS attack on authenticated symmetric NTP associations

An attacker knowing that NTP hosts A and B are peering with each other
(symmetric association) can send a packet with random timestamps to host A with
source address of B which will set the NTP state variables on A to the values
sent by the attacker. Host A will then send on its next poll to B a packet with
originate timestamp that doesn’t match the transmit timestamp of B and the
packet will be dropped. If the attacker does this periodically for both hosts,
they won’t be able to synchronize to each other.

Authentication using a symmetric key can fully protect against this attack, but
in implementations following the NTPv3 (RFC 1305) or NTPv4 (RFC 5905)
specification the state variables were updated even when the authentication
check failed and the association was not protected.

### CVE-2015-1821: Heap-based buffer overflow in access configuration

When NTP or cmdmon access was configured (from chrony.conf or via authenticated
cmdmon) with a subnet size that is indivisible by 4 and an address that has
nonzero bits in the 4-bit subnet remainder (e.g. 192.168.15.0/22 or f000::/3),
the new setting was written to an incorrect location, possibly outside the
allocated array.

An attacker that has the command key and is allowed to access cmdmon (only
localhost is allowed by default) could exploit this to crash chronyd or
possibly execute arbitrary code with the privileges of the chronyd process.

### CVE-2015-1822: Use of uninitialized pointer in command processing

When allocating memory to save unacknowledged replies to authenticated command
requests, the last "next" pointer was not initialized to NULL. When all
allocated reply slots were used, the next reply could be written to an invalid
memory instead of allocating a new slot for it.

An attacker that has the command key and is allowed to access cmdmon (only
localhost is allowed by default) could exploit this to crash chronyd or
possibly execute arbitrary code with the privileges of the chronyd process.

## 10 Sep 2014: chrony-1.31 released

### Enhancements

* Support operation in other NTP eras (next era begins in 2036),
  NTP time is mapped to [-50, +86] years around build date by default
* Restore time from driftfile with -s when RTC is missing/unsupported
* Close connected client sockets when not waiting for reply
* Use one client socket with random port when acquisitionport is 0
* Use NTP packets instead of UDP echo for presend
* Don’t adjust polling interval when sending fails
* Allow binding to addresses that don’t exist yet
* Ignore measurements around leap second
* Improve detection of unexpected time jumps
* Include example of logrotate configuration, systemd services and
  NetworkManager dispatcher script

### Bug fixes

* Reconnect client sockets for each request to follow changes
  in network configuration automatically
* Restart timer when polling interval is changed on reset

## 1 Jul 2014: chrony-1.30 released

### Enhancements

* Add asynchronous name resolving with POSIX threads
* Add PTP hardware clock (PHC) refclock driver
* Add new generic clock driver to slew by adjusting frequency only
  (without kernel PLL or adjtime) and use it on Linux
* Add rtcautotrim directive to trim RTC automatically
* Add hwclockfile directive to share RTC LOCAL/UTC setting with hwclock
* Add maxslewrate directive to set maximum allowed slew rate
* Add maxdispersion option for refclocks
* Add -q/-Q options to set clock/print offset once and exit
* Allow directives to be specified on chronyd command line
* Replace frequency scaling in Linux driver with retaining of tick
* Try to detect unexpected forward time jumps and reset state
* Exit with non-zero code when maxchange limit is reached
* Improve makestep to not start and stop slew unnecessarily
* Change default corrtimeratio to 3.0 to improve frequency accuracy
* Announce leap second only on last day of June and December
* Use separate connected client sockets for each NTP server
* Remove separate NTP implementation used for initstepslew
* Limit maximum minpoll set by KoD RATE to default maxpoll
* Don’t send NTP requests with unknown key
* Print warning when source is added with unknown key
* Take leap second in PPS refclock from locked source
* Make reading of RTC for initial trim more reliable
* Don’t create cmdmon sockets when cmdport is 0
* Add configure option to set default user to drop root privileges
* Add configure option to compile with debug messages
* Print debug messages when -d is used more than once
* Change format of messages written to terminal with -d
* Write fatal messages also to stderr with -n
* Use IP\_RECVERR socket option in chronyc to not wait unnecessarily
* Shorten default chronyc timeout for localhost
* Change default hostname in chronyc from localhost to 127.0.0.1
* Print error message on invalid syntax with all chronyc commands
* Include simulation test suite using clknetsim

### Bug fixes

* Fix crash when selecting with multiple preferred sources
* Fix frequency calculation with large frequency offsets
* Fix code writing drift and RTC files to compile correctly
* Fix -4/-6 options in chronyc to not reset hostname set by -h
* Fix refclock sample validation with sub-second polling interval
* Set stratum correctly with non-PPS SOCK refclock and local stratum
* Modify dispersion accounting in refclocks to prevent PPS getting
  stuck with large dispersion and not accepting new samples

## Older news

See the [NEWS](https://gitlab.com/chrony/chrony/-/raw/master/NEWS) file in
the git repository.

Last updated 2024-10-08 15:03:02 +0200


