```
{
  "vulnerability": {
    "CVE": "CVE-2016-6707",
    "description": "An elevation of privilege vulnerability in System Server could enable a local malicious application to execute arbitrary code within the context of a privileged process.",
    "root_cause": "The vulnerability stems from a mismatch in how memory is handled when sharing bitmaps via ashmem. Specifically, when a bitmap is unflattened from a parcel, the size used for the mmap operation is derived from the bitmap's metadata, while the size used for the munmap operation is obtained from the ashmem region itself. This difference in size calculation, which can be manipulated by an attacker, allows for unmapping memory regions outside of the intended allocation.",
    "weaknesses": [
      "Incorrect assumption that the mmap-ed size and ashmem region size are equal.",
      "Use of attacker controlled size in `munmap` operation.",
      "Lack of proper validation/sanitization of bitmap metadata from binder parcel."
    ],
    "impact": "Arbitrary memory regions can be unmapped, allowing for use-after-free conditions. This can lead to arbitrary code execution by replacing a thread's stack with controlled data, allowing for a ROP chain execution within `system_server`.",
    "attack_vectors": [
      "Crafted bitmaps with mismatched metadata and ashmem sizes sent through binder transactions.",
       "Specifically crafted notifications containing bitmaps to trigger the vulnerability in `system_server`"
    ],
    "attacker_capabilities": "A local malicious application can send crafted bitmaps via binder transactions.",
    "additional_details": "The exploit leverages the `AudioService::loadSoundEffects` binder call to create a thread in `system_server`. It manipulates the address space by allocating bitmaps of specific size, creating holes, and finally, replacing a threadâ€™s stack with a crafted ROP chain. The ROP chain then maps an attacker controlled ashmem region as executable and jumps to it, achieving code execution. This attack bypasses ASLR by using shared libraries from zygote and also bypasses SELinux restrictions by using the dalvikcache context to map executable memory regions."
  }
}
```