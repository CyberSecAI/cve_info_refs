The provided content relates to CVE-2016-6561.

**Root cause of vulnerability:**
The vulnerability is caused by a NULL pointer dereference in the `smb_flush_file` function when handling SMB file flush requests for named pipes. The function attempts to access `ofile->f_node->flags` without verifying if `ofile->f_node` is NULL. In the case of pipes, `f_node` is NULL, leading to the dereference.

**Weaknesses/vulnerabilities present:**
- NULL pointer dereference. The code does not handle the case where `ofile->f_node` is NULL, which occurs when the file is a named pipe.
- Lack of proper handling of different file types in the `smb_flush_file` function.

**Impact of exploitation:**
- Kernel panic. The NULL pointer dereference causes the system to crash, leading to a denial of service.

**Attack vectors:**
- Sending an SMB flush request for a named pipe.

**Required attacker capabilities/position:**
- The attacker needs to be able to interact with the SMB server and request a flush on an opened named pipe.

**Additional details:**
- The vulnerability was present in both SMB1 and SMB2 implementations.
- The fix involves introducing a new function, `smb_ofile_flush`, that handles different file types using a switch statement and calls the appropriate flush method for each type. The fix specifically handles the `SMB_FTYPE_DISK` case which calls `smb_fsop_commit` if the `NODE_FLAGS_WRITE_THROUGH` flag is not set. All other cases are handled in a `default` case that does nothing.
- The original `smb_flush_file` function was updated to call the new `smb_ofile_flush` function.