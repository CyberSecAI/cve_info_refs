=== Content from www.illumos.org_bf68848f_20250125_020223.html ===


Search

### Project

### General

### Profile

* [Sign in](/login)
* [Register](/account/register)

* [Home](/)
* [Projects](/projects)
* [Help](https://www.redmine.org/guide)

[Search](/projects/illumos-gate/search?scope=subprojects):

 illumos gate[All Projects](/projects?jump=issues)
# illumos gate

* [Overview](/projects/illumos-gate)
* [Activity](/projects/illumos-gate/activity)
* [Issues](/projects/illumos-gate/issues)

### Custom queries

* [All unresolved bugs](/projects/illumos-gate/issues?query_id=4)
* [Bite-sized Bugs](/projects/illumos-gate/issues?query_id=31)
* [Documentation and locale issues](/projects/illumos-gate/issues?query_id=16)

Actions
Copy link
## Bug #7483

closed
![](https://www.gravatar.com/avatar/ac4bd7d247904ceacb4ab78885773cb05217dd99bb5d0c0808090dd8d9f652e8?rating=PG&size=50&default= "Author: Dan Vatca")
![](https://www.gravatar.com/avatar/ac4bd7d247904ceacb4ab78885773cb05217dd99bb5d0c0808090dd8d9f652e8?rating=PG&size=22&default= "Assignee: Dan Vatca")

### SMB flush on pipe triggers NULL pointer dereference in module smbsrv

Added by [Dan Vatca](/users/1760) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 11:11 AM") ago.
Updated [about 6 years](/projects/illumos-gate/activity?from=2018-11-01 "2018-11-01 05:41 PM") ago.

Status:ClosedPriority:NormalAssignee:[Dan Vatca](/users/1760)Category:cifs - CIFS server and clientStart date:2016-10-19Due date:% Done:

|  |
| --- |

100%

Estimated time:
Difficulty:MediumTags:needs-triageGerrit CR:External Bug:

---

**Description**

A machine sharing a ZFS dataset using the kernel SMB implementation stops with this panic:
```

> ::panicinfo
             cpu                3
          thread ffffff007a2e6c40
         message BAD TRAP: type=e (#pf Page fault) rp=ffffff007a2e6900 addr=11c occurred in module "smbsrv" due to a NULL pointer dereference
             rdi ffffff1a885cc560
             rsi ffffff1a885cc560
             rdx                0
             rcx ffffff1a7027b0d0
              r8                0
              r9                0
             rax ffffff1a61da6940
             rbx ffffff1a785ae9c8
             rbp ffffff007a2e6a10
             r10 fffffffffb854334
             r11 ffffff007a2e6c40
             r12 ffffff1a885cc560
             r13 ffffff1a785ae9e0
             r14                0
             r15 ffffff1a785aea58
          fsbase fffffd7ffe8f3240
          gsbase ffffff195b524a80
              ds               4b
              es               4b
              fs                0
              gs                0
          trapno                e
             err                0
             rip fffffffff84d12b2
              cs               30
          rflags            10282
             rsp ffffff007a2e69f0
              ss               38
          gdt_hi                0
          gdt_lo         a000ffff
          idt_hi                0
          idt_lo         9000ffff
             ldt                0
            task               70
             cr0         8005003b
             cr2              11c
             cr3          c400000
             cr4            426f8

```

The stack during panic is this:
```

> $C
ffffff007a2e6a10 smb_flush_file+0x32(ffffff1a785ae9c8, ffffff1a885cc560)
ffffff007a2e6a60 smb_com_flush+0x54(ffffff1a785ae9c8)
ffffff007a2e6b50 smb1sr_work+0x5ad(ffffff1a785ae9c8)
ffffff007a2e6b90 smb1_tq_work+0xa0(ffffff1a785ae9c8)
ffffff007a2e6c20 taskq_d_thread+0xb7(ffffff1b49369d70)
ffffff007a2e6c30 thread_start+8()

```

So the kernel needs to flush writes to an opened pipe (ofile->f\_ftype == SMB\_FTYPE\_MESG\_PIPE).
```

> ffffff1a885cc560::print -t struct smb_ofile
struct smb_ofile {
    list_node_t f_lnd = {
        struct list_node *list_next = 0xffffff1a7027b098
        struct list_node *list_prev = 0xffffff1a7027b098
    }
    list_node_t f_nnd = {
        struct list_node *list_next = 0
        struct list_node *list_prev = 0
    }
    uint32_t f_magic = 0x4f464c45
    kmutex_t f_mutex = {
        void *[1] _opaque = [ 0 ]
    }
    smb_ofile_state_t f_state = 0 (SMB_OFILE_STATE_OPEN)
    struct smb_server *f_server = 0xffffff198bbe0ac0
    smb_session_t *f_session = 0xffffff1a13a09a78
    smb_user_t *f_user = 0xffffff1a700c22b0
    smb_tree_t *f_tree = 0xffffff1a7027b038
    smb_node_t *f_node = 0
    smb_odir_t *f_odir = 0
    smb_opipe_t *f_pipe = 0xffffff19ea56c9b0
    uint32_t f_uniqid = 0x6c1ac7
    uint32_t f_refcnt = 0x1
    uint64_t f_seek_pos = 0xa0
    uint32_t f_flags = 0
    uint32_t f_granted_access = 0x120087
    uint32_t f_share_access = 0x7
    uint32_t f_create_options = 0
    uint32_t f_opened_by_pid = 0x14f4
    uint16_t f_fid = 0x1
    uint16_t f_ftype = 0x2
    uint64_t f_llf_pos = 0
    int f_mode = 0
    cred_t *f_cr = 0xffffff1a61da6940
    pid_t f_pid = 0
    smb_attr_t f_pending_attr = {
        uint_t sa_mask = 0
        vattr_t sa_vattr = {
            uint_t va_mask = 0
            vtype_t va_type = 0 (VNON)
            mode_t va_mode = 0
            uid_t va_uid = 0
            gid_t va_gid = 0
            dev_t va_fsid = 0
            u_longlong_t va_nodeid = 0
            nlink_t va_nlink = 0
            u_offset_t va_size = 0
            timestruc_t va_atime = {
                time_t tv_sec = 0
                long tv_nsec = 0
            }
            timestruc_t va_mtime = {
                time_t tv_sec = 0
                long tv_nsec = 0
            }
            timestruc_t va_ctime = {
                time_t tv_sec = 0
                long tv_nsec = 0
            }
            dev_t va_rdev = 0
            uint_t va_blksize = 0
            u_longlong_t va_nblocks = 0
            uint_t va_seq = 0
        }
        uint32_t sa_dosattr = 0
        timestruc_t sa_crtime = {
            time_t tv_sec = 0
            long tv_nsec = 0
        }
        u_offset_t sa_allocsz = 0
    }
    boolean_t f_written = 0 (0)
    char [256] f_quota_resume = [ '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\
0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', '\0', ... ]
    smb_oplock_grant_t f_oplock_grant = {
        list_node_t og_lnd = {
            struct list_node *list_next = 0
            struct list_node *list_prev = 0
        }
        uint32_t og_magic = 0
        uint8_t og_breaking = 0
        uint8_t og_level = 0
        uint16_t og_fid = 0
        uint16_t og_tid = 0
        uint16_t og_uid = 0
        struct smb_session *og_session = 0
        struct smb_ofile *og_ofile = 0
    }
}

```

The code that triggers the panic is this:
```

/*
 * smb_flush_file
 *
 * If writes on this file are not synchronous, flush it using the NFSv3
 * commit interface.
 */
static void
smb_flush_file(struct smb_request *sr, struct smb_ofile *ofile)
{
    sr->user_cr = smb_ofile_getcred(ofile);

    if ((ofile->f_node->flags & NODE_FLAGS_WRITE_THROUGH) == 0)
        (void) smb_fsop_commit(sr, sr->user_cr, ofile->f_node);
}

```

Here the ofile->f\_node is NULL, so trying to read flags will trigger the panic on NULL dereference.

Other information:
1. The kernel version that was running includes the SMB2 code, but had it disabled (smbd/max\_protocol => 1).
2. I can provide access to the full kernel dump if necessary for further investigation.

---

**Files**

| [illumos-7483-1.patch](/attachments/1476) (2.07 KB) [illumos-7483-1.patch](/attachments/download/1476/illumos-7483-1.patch "Download") |  | Dan Vatca, 2016-10-19 05:47 PM |  |
| --- | --- | --- | --- |

* [History](/issues/7483?tab=history)
* [Notes](/issues/7483?tab=notes)
* [Property changes](/issues/7483?tab=properties)

ActionsCopy link
[#1](#note-1)
#### Updated by [Gordon Ross](/users/29) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 01:27 PM") ago

That's interesting. SMB ofiles on pipes don't have an SMB node, so it's expected that ofile->f\_node is NULL here.
How was this reproduced? Do you have a capture of the SMB request that triggered it?

My guess would be that this function needs a switch on the ofile->f\_ftype, as we see in many smb\_ofile\_functions.
On inspection, this appears to be a problem in SMB2 as well.

For a fix, I'd suggest introducing a new function: smb\_ofile\_flush, placed after smb\_ofile\_seek or thereabouts,
and have that contain a switch statement on ofile->f\_type as you see in other smb\_ofile\_... functions.
```

    switch (of->f_ftype) {
    case SMB_FTYPE_DISK:
        ...

```

For now, I think we can implement just the FTYPE\_DISK case,
and have that call smb\_fsop\_commit as smb\_flush\_file did.

Then both the SMB1 handler (smb\_flush\_file) and the
SMB2 handler (smb2\_flush) should call smb\_ofile\_flush.

ActionsCopy link
[#2](#note-2)
#### Updated by [Dan Vatca](/users/1760) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 05:27 PM") ago

Unfortunately I don't have a network trace. This has happened just once in production.
The only information I have is that the users of this share are using Solidworks to edit CAD files.

ActionsCopy link
[#3](#note-3)
#### Updated by [Dan Vatca](/users/1760) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 05:47 PM") ago

* **File** [illumos-7483-1.patch](/attachments/1476) [illumos-7483-1.patch](/attachments/download/1476/illumos-7483-1.patch "Download") added

How about the attached patch?
Should I submit a CR?

ActionsCopy link
[#4](#note-4)
#### Updated by [Gordon Ross](/users/29) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 06:29 PM") ago

That looks pretty good, but I think in the new function
smb\_ofile\_flush you should use of->f\_cr rather than
sr->user\_cr (which is only set in SMB1 and is sort of
"the old way" for handling SMB credentials).

Oh, and as long as you have a default case in that
new function, I'd ditch the cases other than "DISK".

You'll also need a declaration, i.e. after
smb\_ofile\_set\_flags() in smb\_kproto.h

If you'd like to create a review request, use:
<https://www.illumos.org/rb/r/new/>

This is a terrible vulnerability! Thanks for finding it!

ActionsCopy link
[#5](#note-5)
#### Updated by [Dan Vatca](/users/1760) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 06:34 PM") ago

I am creating a CR right now and will incorporate your feedback and copyright.

ActionsCopy link
[#6](#note-6)
#### Updated by [Dan Vatca](/users/1760) [over 8 years](/projects/illumos-gate/activity?from=2016-10-19 "2016-10-19 06:52 PM") ago

Review board: <https://www.illumos.org/rb/r/240>
After publishing it, I realised I missed the f\_cr -> user\_cr change and will update it later. If you like, you can add your further comments on RB.

ActionsCopy link
[#7](#note-7)
#### Updated by [Electric Monk](/users/2769) [over 8 years](/projects/illumos-gate/activity?from=2016-10-21 "2016-10-21 12:34 AM") ago

* **Status** changed from *New* to *Closed*
* **% Done** changed from *0* to *100*

[git commit 6d1c73b5858fefc6161c7d686345f0dc887ea799](https://github.com/illumos/illumos-gate/commit/6d1c73b5858fefc6161c7d686345f0dc887ea799)
```
commit  6d1c73b5858fefc6161c7d686345f0dc887ea799
Author: Dan Vatca <dan.vatca@gmail.com>
Date:   2016-10-21T00:21:54.000Z

    7483 SMB flush on pipe triggers NULL pointer dereference in module smbsrv
    Reviewed by: Gordon Ross <gwr@nexenta.com>
    Reviewed by: Matt Barden <matt.barden@nexenta.com>
    Reviewed by: Evan Layton <evan.layton@nexenta.com>
    Reviewed by: Dan McDonald <danmcd@omniti.com>
    Approved by: Gordon Ross <gwr@nexenta.com>

```

Actions
Copy link

Also available in: [Atom](/issues/7483.atom)
[PDF](/issues/7483.pdf)

Powered by [Redmine](https://www.redmine.org/) © 2006-2024 Jean-Philippe Lang

Loading...



=== Content from github.com_62d57aad_20250125_020221.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fillumos%2Fillumos-gate%2Fcommit%2F6d1c73b5858fefc6161c7d686345f0dc887ea799)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fillumos%2Fillumos-gate%2Fcommit%2F6d1c73b5858fefc6161c7d686345f0dc887ea799)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=illumos%2Fillumos-gate)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[illumos](/illumos)
/
**[illumos-gate](/illumos/illumos-gate)**
Public

* [Notifications](/login?return_to=%2Fillumos%2Fillumos-gate) You must be signed in to change notification settings
* [Fork
  769](/login?return_to=%2Fillumos%2Fillumos-gate)
* [Star
   1.7k](/login?return_to=%2Fillumos%2Fillumos-gate)

* [Code](/illumos/illumos-gate)
* [Pull requests
  8](/illumos/illumos-gate/pulls)
* [Actions](/illumos/illumos-gate/actions)
* [Security](/illumos/illumos-gate/security)
* [Insights](/illumos/illumos-gate/pulse)

Additional navigation options

* [Code](/illumos/illumos-gate)
* [Pull requests](/illumos/illumos-gate/pulls)
* [Actions](/illumos/illumos-gate/actions)
* [Security](/illumos/illumos-gate/security)
* [Insights](/illumos/illumos-gate/pulse)

## Commit

[Permalink](/illumos/illumos-gate/commit/6d1c73b5858fefc6161c7d686345f0dc887ea799)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

7483 SMB flush on pipe triggers NULL pointer dereference in module sm…

[Browse files](/illumos/illumos-gate/tree/6d1c73b5858fefc6161c7d686345f0dc887ea799)
Browse the repository at this point in the history

```
…bsrv

Reviewed by: Gordon Ross <gwr@nexenta.com>
Reviewed by: Matt Barden <matt.barden@nexenta.com>
Reviewed by: Evan Layton <evan.layton@nexenta.com>
Reviewed by: Dan McDonald <danmcd@omniti.com>
Approved by: Gordon Ross <gwr@nexenta.com>
```

* Loading branch information

[![@danvatca](https://avatars.githubusercontent.com/u/1521596?s=40&v=4)](/danvatca) [![@gwr](https://avatars.githubusercontent.com/u/900508?s=40&v=4)](/gwr)

[danvatca](/illumos/illumos-gate/commits?author=danvatca "View all commits by danvatca")
authored and
[gwr](/illumos/illumos-gate/commits?author=gwr "View all commits by gwr")
committed
Oct 21, 2016

1 parent
[516627f](/illumos/illumos-gate/commit/516627f338a630bcf9806a91aa873bbbae9a2fac)

commit 6d1c73b

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**30 additions**
and
**29 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* usr/src/uts/common

  + fs/smbsrv

    - usr/src/uts/common/fs/smbsrv/smb2\_flush.c
      [smb2\_flush.c](#diff-bd15a819b1f07443b22453af4b09aa0a796507235580f46d8433b9b71bde1cfb)
    - usr/src/uts/common/fs/smbsrv/smb\_flush.c
      [smb\_flush.c](#diff-ed9829ac1bbcf13ecbe767c66a9bca3e4b4d76fc2b8c868d03d8a931ba0f85dc)
    - usr/src/uts/common/fs/smbsrv/smb\_ofile.c
      [smb\_ofile.c](#diff-d78867b2706e5b43116a7cf1cf365f574c2a129bfd5d62821e67af0609c84cf1)
  + smbsrv

    - usr/src/uts/common/smbsrv/smb\_kproto.h
      [smb\_kproto.h](#diff-b19bf9c127d10d874493c9aceafe811925ab2f11c48d0a36a8489d2c8c5804ee)

## There are no files selected for viewing

10 changes: 2 additions & 8 deletions

10
[usr/src/uts/common/fs/smbsrv/smb2\_flush.c](#diff-bd15a819b1f07443b22453af4b09aa0a796507235580f46d8433b9b71bde1cfb "usr/src/uts/common/fs/smbsrv/smb2_flush.c")

Show comments

[View file](/illumos/illumos-gate/blob/6d1c73b5858fefc6161c7d686345f0dc887ea799/usr/src/uts/common/fs/smbsrv/smb2_flush.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,6 +11,7 @@ |
|  |  |  |
|  |  | /\* |
|  |  | \* Copyright 2014 Nexenta Systems, Inc. All rights reserved. |
|  |  | \* Copyright 2016 Syneto S.R.L. All rights reserved. |
|  |  | \*/ |
|  |  |  |
|  |  | /\* |
| Expand All | | @@ -23,7 +24,6 @@ |
|  |  | smb\_sdrc\_t |
|  |  | smb2\_flush(smb\_request\_t \*sr) |
|  |  | { |
|  |  | smb\_ofile\_t \*of = NULL; |
|  |  | uint16\_t StructSize; |
|  |  | uint16\_t reserved1; |
|  |  | uint32\_t reserved2; |
| Expand Down  Expand Up | | @@ -51,14 +51,8 @@ smb2\_flush(smb\_request\_t \*sr) |
|  |  | smb2sr\_put\_error(sr, status); |
|  |  | return (SDRC\_SUCCESS); |
|  |  | } |
|  |  | of = sr->fid\_ofile; |
|  |  |  |
|  |  | /\* |
|  |  | \* XXX - todo: |
|  |  | \* Flush named pipe should drain writes. |
|  |  | \*/ |
|  |  | if ((of->f\_node->flags & NODE\_FLAGS\_WRITE\_THROUGH) == 0) |
|  |  | (void) smb\_fsop\_commit(sr, of->f\_cr, of->f\_node); |
|  |  | smb\_ofile\_flush(sr, sr->fid\_ofile); |
|  |  |  |
|  |  | /\* |
|  |  | \* SMB2 Flush reply |
| Expand Down | |  |

25 changes: 4 additions & 21 deletions

25
[usr/src/uts/common/fs/smbsrv/smb\_flush.c](#diff-ed9829ac1bbcf13ecbe767c66a9bca3e4b4d76fc2b8c868d03d8a931ba0f85dc "usr/src/uts/common/fs/smbsrv/smb_flush.c")

Show comments

[View file](/illumos/illumos-gate/blob/6d1c73b5858fefc6161c7d686345f0dc887ea799/usr/src/uts/common/fs/smbsrv/smb_flush.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,8 @@ |
|  |  | /\* |
|  |  | \* Copyright 2009 Sun Microsystems, Inc. All rights reserved. |
|  |  | \* Use is subject to license terms. |
|  |  | \* |
|  |  | \* Copyright 2016 Syneto S.R.L. All rights reserved. |
|  |  | \*/ |
|  |  |  |
|  |  | /\* |
| Expand All | | @@ -40,8 +42,6 @@ |
|  |  | #include <smbsrv/smb\_fsops.h> |
|  |  |  |
|  |  |  |
|  |  | static void smb\_flush\_file(struct smb\_request \*sr, struct smb\_ofile \*ofile); |
|  |  |  |
|  |  | /\* |
|  |  | \* smb\_com\_flush |
|  |  | \* |
| Expand Down  Expand Up | | @@ -90,15 +90,14 @@ smb\_com\_flush(smb\_request\_t \*sr) |
|  |  | ERRDOS, ERRbadfid); |
|  |  | return (SDRC\_ERROR); |
|  |  | } |
|  |  |  |
|  |  | smb\_flush\_file(sr, sr->fid\_ofile); |
|  |  | smb\_ofile\_flush(sr, sr->fid\_ofile); |
|  |  | } else { |
|  |  | flist = &sr->tid\_tree->t\_ofile\_list; |
|  |  | smb\_llist\_enter(flist, RW\_READER); |
|  |  | file = smb\_llist\_head(flist); |
|  |  | while (file) { |
|  |  | mutex\_enter(&file->f\_mutex); |
|  |  | smb\_flush\_file(sr, file); |
|  |  | smb\_ofile\_flush(sr, file); |
|  |  | mutex\_exit(&file->f\_mutex); |
|  |  | file = smb\_llist\_next(flist, file); |
|  |  | } |
| Expand All | | @@ -108,19 +107,3 @@ smb\_com\_flush(smb\_request\_t \*sr) |
|  |  | rc = smbsr\_encode\_empty\_result(sr); |
|  |  | return ((rc == 0) ? SDRC\_SUCCESS : SDRC\_ERROR); |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | /\* |
|  |  | \* smb\_flush\_file |
|  |  | \* |
|  |  | \* If writes on this file are not synchronous, flush it using the NFSv3 |
|  |  | \* commit interface. |
|  |  | \*/ |
|  |  | static void |
|  |  | smb\_flush\_file(struct smb\_request \*sr, struct smb\_ofile \*ofile) |
|  |  | { |
|  |  | sr->user\_cr = smb\_ofile\_getcred(ofile); |
|  |  |  |
|  |  | if ((ofile->f\_node->flags & NODE\_FLAGS\_WRITE\_THROUGH) == 0) |
|  |  | (void) smb\_fsop\_commit(sr, sr->user\_cr, ofile->f\_node); |
|  |  | } |

22 changes: 22 additions & 0 deletions

22
[usr/src/uts/common/fs/smbsrv/smb\_ofile.c](#diff-d78867b2706e5b43116a7cf1cf365f574c2a129bfd5d62821e67af0609c84cf1 "usr/src/uts/common/fs/smbsrv/smb_ofile.c")

Show comments

[View file](/illumos/illumos-gate/blob/6d1c73b5858fefc6161c7d686345f0dc887ea799/usr/src/uts/common/fs/smbsrv/smb_ofile.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ |
|  |  | /\* |
|  |  | \* Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved. |
|  |  | \* Copyright 2015 Nexenta Systems, Inc. All rights reserved. |
|  |  | \* Copyright 2016 Syneto S.R.L. All rights reserved. |
|  |  | \*/ |
|  |  |  |
|  |  | /\* |
| Expand Down  Expand Up | | @@ -836,6 +837,27 @@ smb\_ofile\_seek( |
|  |  | return (rc); |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* smb\_ofile\_flush |
|  |  | \* |
|  |  | \* If writes on this file are not synchronous, flush it using the NFSv3 |
|  |  | \* commit interface. |
|  |  | \* |
|  |  | \* XXX - todo: Flush named pipe should drain writes. |
|  |  | \*/ |
|  |  | void |
|  |  | smb\_ofile\_flush(struct smb\_request \*sr, struct smb\_ofile \*of) |
|  |  | { |
|  |  | switch (of->f\_ftype) { |
|  |  | case SMB\_FTYPE\_DISK: |
|  |  | if ((of->f\_node->flags & NODE\_FLAGS\_WRITE\_THROUGH) == 0) |
|  |  | (void) smb\_fsop\_commit(sr, of->f\_cr, of->f\_node); |
|  |  | break; |
|  |  | default: |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\* |
|  |  | \* smb\_ofile\_is\_open |
|  |  | \*/ |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[usr/src/uts/common/smbsrv/smb\_kproto.h](#diff-b19bf9c127d10d874493c9aceafe811925ab2f11c48d0a36a8489d2c8c5804ee "usr/src/uts/common/smbsrv/smb_kproto.h")

Show comments

[View file](/illumos/illumos-gate/blob/6d1c73b5858fefc6161c7d686345f0dc887ea799/usr/src/uts/common/smbsrv/smb_kproto.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,6 +22,7 @@ |
|  |  | /\* |
|  |  | \* Copyright (c) 2007, 2010, Oracle and/or its affiliates. All rights reserved. |
|  |  | \* Copyright 2015 Nexenta Systems, Inc. All rights reserved. |
|  |  | \* Copyright 2016 Syneto S.R.L. All rights reserved. |
|  |  | \*/ |
|  |  |  |
|  |  | /\* |
| Expand Down  Expand Up | | @@ -673,6 +674,7 @@ void smb\_ofile\_close(smb\_ofile\_t \*, int32\_t); |
|  |  | void smb\_ofile\_delete(void \*); |
|  |  | uint32\_t smb\_ofile\_access(smb\_ofile\_t \*, cred\_t \*, uint32\_t); |
|  |  | int smb\_ofile\_seek(smb\_ofile\_t \*, ushort\_t, int32\_t, uint32\_t \*); |
|  |  | void smb\_ofile\_flush(smb\_request\_t \*, smb\_ofile\_t \*); |
|  |  | boolean\_t smb\_ofile\_hold(smb\_ofile\_t \*); |
|  |  | void smb\_ofile\_release(smb\_ofile\_t \*); |
|  |  | void smb\_ofile\_request\_complete(smb\_ofile\_t \*); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6d1c73b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fillumos%2Fillumos-gate%2Fcommit%2F6d1c73b5858fefc6161c7d686345f0dc887ea799) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


