=== Content from xenbits.xen.org_175e371f_20250125_034203.html ===
From 777ebe30e81ab284f9b78392875fe884a593df35 Mon Sep 17 00:00:00 2001
From: Andrew Cooper
Date: Wed, 15 Jun 2016 18:32:14 +0100
Subject: [PATCH] x86/entry: Avoid SMAP violation in
compat\_create\_bounce\_frame()
A 32bit guest kernel might be running on user mappings.
compat\_create\_bounce\_frame() must whitelist its guest accesses to avoid
risking a SMAP violation.
For both variants of create\_bounce\_frame(), re-blacklist user accesses if
execution exits via an exception table redirection.
This is XSA-183 / CVE-2016-6259
Signed-off-by: Andrew Cooper
Reviewed-by: George Dunlap
Reviewed-by: Jan Beulich
---
v2:
\* Include CLAC on the exit paths from compat\_create\_bounce\_frame which occur
from faults attempting to load %fs
\* Reposition ASM\_STAC to avoid breaking the macro-op fusion of test/jz
---
xen/arch/x86/x86\_64/compat/entry.S | 3 +++
xen/arch/x86/x86\_64/entry.S | 2 ++
2 files changed, 5 insertions(+)
diff --git a/xen/arch/x86/x86\_64/compat/entry.S b/xen/arch/x86/x86\_64/compat/entry.S
index 0e3db7c..1eaf4bb 100644
--- a/xen/arch/x86/x86\_64/compat/entry.S
+++ b/xen/arch/x86/x86\_64/compat/entry.S
@@ -350,6 +350,7 @@ ENTRY(compat\_int80\_direct\_trap)
compat\_create\_bounce\_frame:
ASSERT\_INTERRUPTS\_ENABLED
mov %fs,%edi
+ ASM\_STAC
testb $2,UREGS\_cs+8(%rsp)
jz 1f
/\* Push new frame at registered guest-OS stack base. \*/
@@ -403,6 +404,7 @@ UNLIKELY\_START(nz, compat\_bounce\_failsafe)
movl %ds,%eax
.Lft12: movl %eax,%fs:0\*4(%rsi) # DS
UNLIKELY\_END(compat\_bounce\_failsafe)
+ ASM\_CLAC
/\* Rewrite our stack frame and return to guest-OS mode. \*/
/\* IA32 Ref. Vol. 3: TF, VM, RF and NT flags are cleared on trap. \*/
andl $~(X86\_EFLAGS\_VM|X86\_EFLAGS\_RF|\
@@ -448,6 +450,7 @@ compat\_crash\_page\_fault\_4:
addl $4,%esi
compat\_crash\_page\_fault:
.Lft14: mov %edi,%fs
+ ASM\_CLAC
movl %esi,%edi
call show\_page\_walk
jmp dom\_crash\_sync\_extable
diff --git a/xen/arch/x86/x86\_64/entry.S b/xen/arch/x86/x86\_64/entry.S
index 6e27508..0c2e63a 100644
--- a/xen/arch/x86/x86\_64/entry.S
+++ b/xen/arch/x86/x86\_64/entry.S
@@ -462,9 +462,11 @@ domain\_crash\_page\_fault\_16:
domain\_crash\_page\_fault\_8:
addq $8,%rsi
domain\_crash\_page\_fault:
+ ASM\_CLAC
movq %rsi,%rdi
call show\_page\_walk
ENTRY(dom\_crash\_sync\_extable)
+ ASM\_CLAC
# Get out of the guest-save area of the stack.
GET\_STACK\_BASE(%rax)
leaq STACK\_CPUINFO\_FIELD(guest\_cpu\_user\_regs)(%rax),%rsp
--
2.1.4


=== Content from xenbits.xen.org_fb8a49be_20250125_034203.html ===
From 2fd4f34058fb5f87fbd80978dbd2cb458aff565d Mon Sep 17 00:00:00 2001
From: Andrew Cooper
Date: Wed, 15 Jun 2016 18:32:14 +0100
Subject: [PATCH] x86/entry: Avoid SMAP violation in
compat\_create\_bounce\_frame()
A 32bit guest kernel might be running on user mappings.
compat\_create\_bounce\_frame() must whitelist its guest accesses to avoid
risking a SMAP violation.
For both variants of create\_bounce\_frame(), re-blacklist user accesses if
execution exits via an exception table redirection.
This is XSA-183 / CVE-2016-6259
Signed-off-by: Andrew Cooper
Reviewed-by: George Dunlap
Reviewed-by: Jan Beulich
---
v2:
\* Include CLAC on the exit paths from compat\_create\_bounce\_frame which occur
from faults attempting to load %fs
\* Reposition ASM\_STAC to avoid breaking the macro-op fusion of test/jz
---
xen/arch/x86/x86\_64/compat/entry.S | 3 +++
xen/arch/x86/x86\_64/entry.S | 2 ++
2 files changed, 5 insertions(+)
diff --git a/xen/arch/x86/x86\_64/compat/entry.S b/xen/arch/x86/x86\_64/compat/entry.S
index 7f02afd..e80c53c 100644
--- a/xen/arch/x86/x86\_64/compat/entry.S
+++ b/xen/arch/x86/x86\_64/compat/entry.S
@@ -318,6 +318,7 @@ ENTRY(compat\_int80\_direct\_trap)
compat\_create\_bounce\_frame:
ASSERT\_INTERRUPTS\_ENABLED
mov %fs,%edi
+ ASM\_STAC
testb $2,UREGS\_cs+8(%rsp)
jz 1f
/\* Push new frame at registered guest-OS stack base. \*/
@@ -364,6 +365,7 @@ compat\_create\_bounce\_frame:
movl TRAPBOUNCE\_error\_code(%rdx),%eax
.Lft8: movl %eax,%fs:(%rsi) # ERROR CODE
1:
+ ASM\_CLAC
/\* Rewrite our stack frame and return to guest-OS mode. \*/
/\* IA32 Ref. Vol. 3: TF, VM, RF and NT flags are cleared on trap. \*/
andl $~(X86\_EFLAGS\_VM|X86\_EFLAGS\_RF|\
@@ -403,6 +405,7 @@ compat\_crash\_page\_fault\_4:
addl $4,%esi
compat\_crash\_page\_fault:
.Lft14: mov %edi,%fs
+ ASM\_CLAC
movl %esi,%edi
call show\_page\_walk
jmp dom\_crash\_sync\_extable
diff --git a/xen/arch/x86/x86\_64/entry.S b/xen/arch/x86/x86\_64/entry.S
index ad8c64c..f7178cd 100644
--- a/xen/arch/x86/x86\_64/entry.S
+++ b/xen/arch/x86/x86\_64/entry.S
@@ -420,9 +420,11 @@ domain\_crash\_page\_fault\_16:
domain\_crash\_page\_fault\_8:
addq $8,%rsi
domain\_crash\_page\_fault:
+ ASM\_CLAC
movq %rsi,%rdi
call show\_page\_walk
ENTRY(dom\_crash\_sync\_extable)
+ ASM\_CLAC
# Get out of the guest-save area of the stack.
GET\_STACK\_END(ax)
leaq STACK\_CPUINFO\_FIELD(guest\_cpu\_user\_regs)(%rax),%rsp
--
2.1.4


=== Content from xenbits.xen.org_1b5ece08_20250125_034203.html ===

# Information

| Advisory | [XSA-183](advisory-183.html) |
| --- | --- |
| Public release | 2016-07-26 11:32 |
| Updated | 2023-12-15 15:35 |
| Version | 6 |
| CVE(s) | [CVE-2016-6259](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6259) |
| Title | x86: Missing SMAP whitelisting in 32-bit exception / event delivery |

# Files

<advisory-183.txt> (signed advisory file)

<xsa183-unstable.patch>

<xsa183-4.6.patch>
# Advisory

---

```

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

            Xen Security Advisory CVE-2016-6259 / XSA-183
                              version 6

    x86: Missing SMAP whitelisting in 32-bit exception / event delivery

UPDATES IN VERSION 6
====================

Fix patch name.

ISSUE DESCRIPTION
=================

Supervisor Mode Access Prevention is a hardware feature designed to make
an Operating System more robust, by raising a pagefault rather than
accidentally following a pointer into userspace.  However, legitimate
accesses into userspace require whitelisting, and the exception delivery
mechanism for 32bit PV guests wasn't whitelisted.

IMPACT
======

A malicious 32-bit PV guest kernel can trigger a safety check, crashing
the hypervisor and causing a denial of service to other VMs on the host.

VULNERABLE SYSTEMS
==================

Xen version 4.5 and newer are vulnerable.  Versions 4.4 and older are
not, due to not having software support for SMAP.

The vulnerability is only exposed on x86 hardware supporting the SMAP
feature (Intel Broadwell and later CPUs).  The vulnerability is not
exposed on ARM hardware, or x86 hardware which do not support SMAP.

The vulnerability is only exposed to x86 32bit PV guests.  The
vulnerability is not exposed to 64bit PV guests or HVM guests.

MITIGATION
==========

Running only HVM guests or 64-bit PV guests, avoids the vulnerability.

Disabling SMAP in the hypervisor by booting Xen with "smap=0" on the
command line will avoid this vulnerability.  (Depending on the
circumstances this workaround may pose a small risk of increasing the
impact of other, possibly unknown, vulnerabilities.)

CREDITS
=======

This issue was discovered by Andrew Cooper of Citrix.

RESOLUTION
==========

Applying the appropriate attached patch resolves this issue.

xsa183-unstable.patch  xen-unstable, 4.7.x
xsa183-4.6.patch       Xen 4.6.x, 4.5.x

$ sha256sum xsa183*
[ea0ea4b294332814330f222e6d78eea3b19c394eac8ae22feb4a5bd21e90331f  xsa183-unstable.patch](xsa183-unstable.patch)
[0fee41f21a3eb4af1487590098047f4625688bcef7419572a8f418f9fb728468  xsa183-4.6.patch](xsa183-4.6.patch)
$

DEPLOYMENT DURING EMBARGO
=========================

Deployment of the patches described above (or others which are
substantially similar) is permitted during the embargo, even on
public-facing systems with untrusted guest users and administrators.

But: Deployment of the "smap=0" mitigation is NOT permitted (except
where all the affected systems and VMs are administered and used only
by organisations which are members of the Xen Project Security Issues
Predisclosure List).  Specifically, deployment on public cloud systems
is NOT permitted.  This is because this produces a guest-visible
change which could lead to rediscovery of the vulnerability.

And: Distribution of updated software is prohibited (except to other
members of the predisclosure list).

Predisclosure list members who wish to deploy significantly different
patches and/or mitigations, please contact the Xen Project Security
Team.

(Note: this during-embargo deployment notice is retained in
post-embargo publicly released Xen Project advisories, even though it
is then no longer applicable.  This is to enable the community to have
oversight of the Xen Project Security Team's decisionmaking.)

For more information about permissible uses of embargoed information,
consult the Xen Project community's agreed Security Policy:
  <http://www.xenproject.org/security-policy.html>
-----BEGIN PGP SIGNATURE-----

iQFABAEBCAAqFiEEI+MiLBRfRHX6gGCng/4UyVfoK9kFAmV8b/MMHHBncEB4ZW4u
b3JnAAoJEIP+FMlX6CvZIywIAKZzQWsejt3CmepmImqpxXS7UJhBc7wBXSUr/HhU
WQilVcdD9u6OPhX7NQ9xL1xC9nEiS1t3qjK9wbrsh50mrMWvhnrHShnIa9NTlHvw
Uh+BUWd3tOUuPU1+OlPfoSm5MLVP9kcE5UJDlJiUmQbFH4x+Dq97TYhcwErVDBE4
EqdTmeo414ozm84jL/xCarEySM5JZBVZocpljbNxEqwzsgG0swoNu56aGm0Lggx9
DtKYey0XtENdNO31jYRn4/c6Dk0/FPJLSvJ5Kxow6ecQMe/Vnj9QaHv5ZMlSEcum
XLT7k93g79dYuGPu0nVD22O4Y2OvM0ftowWt75VsIM4F7f4=
=lQBT
-----END PGP SIGNATURE-----

```

---

Xenproject.org Security Team

