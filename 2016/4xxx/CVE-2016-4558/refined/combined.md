=== Content from www.kernel.org_02886032_20250125_124912.html ===
commit 3b41b7e302241aa7c1396802691182bec41ea2f5
Author: Greg Kroah-Hartman
Date: Wed May 18 18:35:34 2016 -0700
Linux 4.5.5
commit 7ef374ef659b976339f01cfb0b06006388f58b2c
Author: Linus Torvalds
Date: Sat May 14 11:11:44 2016 -0700
nf\_conntrack: avoid kernel pointer value leak in slab name
commit 31b0b385f69d8d5491a4bca288e25e63f1d945d0 upstream.
The slab name ends up being visible in the directory structure under
/sys, and even if you don't have access rights to the file you can see
the filenames.
Just use a 64-bit counter instead of the pointer to the 'net' structure
to generate a unique name.
This code will go away in 4.7 when the conntrack code moves to a single
kmemcache, but this is the backportable simple solution to avoiding
leaking kernel pointers to user space.
Fixes: 5b3501faa874 ("netfilter: nf\_conntrack: per netns nf\_conntrack\_cachep")
Signed-off-by: Linus Torvalds
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9abb19bd9efe6999877edc10ffef3d34f261c767
Author: Yauhen Kharuzhy
Date: Tue Mar 29 14:17:48 2016 -0700
btrfs: Reset IO error counters before start of device replacing
commit 7ccefb98ce3e5c4493cd213cd03714b7149cf0cb upstream.
If device replace entry was found on disk at mounting and its num\_write\_errors
stats counter has non-NULL value, then replace operation will never be
finished and -EIO error will be reported by btrfs\_scrub\_dev() because
this counter is never reset.
# mount -o degraded /media/a4fb5c0a-21c5-4fe7-8d0e-fdd87d5f71ee/
# btrfs replace status /media/a4fb5c0a-21c5-4fe7-8d0e-fdd87d5f71ee/
Started on 25.Mar 07:28:00, canceled on 25.Mar 07:28:01 at 0.0%, 40 write errs, 0 uncorr. read errs
# btrfs replace start -B 4 /dev/sdg /media/a4fb5c0a-21c5-4fe7-8d0e-fdd87d5f71ee/
ERROR: ioctl(DEV\_REPLACE\_START) failed on "/media/a4fb5c0a-21c5-4fe7-8d0e-fdd87d5f71ee/": Input/output error, no error
Reset num\_write\_errors and num\_uncorrectable\_read\_errors counters in the
dev\_replace structure before start of replacing.
Signed-off-by: Yauhen Kharuzhy
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit f188c432c9db3be8a705f6825c5a9d9f837ed215
Author: Josef Bacik
Date: Fri Mar 25 10:02:41 2016 -0400
Btrfs: don't use src fd for printk
commit c79b4713304f812d3d6c95826fc3e5fc2c0b0c14 upstream.
The fd we pass in may not be on a btrfs file system, so don't try to do
BTRFS\_I() on it. Thanks,
Signed-off-by: Josef Bacik
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 440323f92e3542110978dcbca890aad8b3798c34
Author: David Sterba
Date: Wed Mar 30 16:01:12 2016 +0200
btrfs: fallback to vmalloc in btrfs\_compare\_tree
commit 8f282f71eaee7ac979cdbe525f76daa0722798a8 upstream.
The allocation of node could fail if the memory is too fragmented for a
given node size, practically observed with 64k.
http://article.gmane.org/gmane.comp.file-systems.btrfs/54689
Reported-and-tested-by: Jean-Denis Girard
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 52ec554945bb69c7bd9790ce11338566b25ba293
Author: Mark Fasheh
Date: Wed Mar 30 17:57:48 2016 -0700
btrfs: handle non-fatal errors in btrfs\_qgroup\_inherit()
commit 918c2ee103cf9956f1c61d3f848dbb49fd2d104a upstream.
create\_pending\_snapshot() will go readonly on \_any\_ error return from
btrfs\_qgroup\_inherit(). If qgroups are enabled, a user can crash their fs by
just making a snapshot and asking it to inherit from an invalid qgroup. For
example:
$ btrfs sub snap -i 1/10 /btrfs/ /btrfs/foo
Will cause a transaction abort.
Fix this by only throwing errors in btrfs\_qgroup\_inherit() when we know
going readonly is acceptable.
The following xfstests test case reproduces this bug:
seq=`basename $0`
seqres=$RESULT\_DIR/$seq
echo "QA output created by $seq"
here=`pwd`
tmp=/tmp/$$
status=1 # failure is the default!
trap "\_cleanup; exit \$status" 0 1 2 3 15
\_cleanup()
{
cd /
rm -f $tmp.\*
}
# get standard environment, filters and checks
. ./common/rc
. ./common/filter
# remove previous $seqres.full before test
rm -f $seqres.full
# real QA test starts here
\_supported\_fs btrfs
\_supported\_os Linux
\_require\_scratch
rm -f $seqres.full
\_scratch\_mkfs
\_scratch\_mount
\_run\_btrfs\_util\_prog quota enable $SCRATCH\_MNT
# The qgroup '1/10' does not exist and should be silently ignored
\_run\_btrfs\_util\_prog subvolume snapshot -i 1/10 $SCRATCH\_MNT $SCRATCH\_MNT/snap1
\_scratch\_unmount
echo "Silence is golden"
status=0
exit
Signed-off-by: Mark Fasheh
Reviewed-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 24469ab4f3b7dd6fef36787bad42b2f75053556e
Author: Liu Bo
Date: Mon Mar 21 14:59:53 2016 -0700
Btrfs: fix invalid reference in replace\_path
commit 264813acb1c756aebc337b16b832604a0c9aadaf upstream.
Dan Carpenter's static checker has found this error, it's introduced by
commit 64c043de466d
("Btrfs: fix up read\_tree\_block to return proper error")
It's really supposed to 'break' the loop on error like others.
Cc: Dan Carpenter
Reported-by: Dan Carpenter
Signed-off-by: Liu Bo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit b96513cce7b82c66f6d1ff87261d65d7cda08861
Author: Alex Lyakas
Date: Thu Mar 10 13:10:15 2016 +0200
btrfs: do not write corrupted metadata blocks to disk
commit 0f805531daa2ebfb5706422dc2ead1cff9e53e65 upstream.
csum\_dirty\_buffer was issuing a warning in case the extent buffer
did not look alright, but was still returning success.
Let's return error in this case, and also add an additional sanity
check on the extent buffer header.
The caller up the chain may BUG\_ON on this, for example flush\_epd\_write\_bio will,
but it is better than to have a silent metadata corruption on disk.
Signed-off-by: Alex Lyakas
Reviewed-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 342da5cefddbf818e1cb59537e021cdad9744e93
Author: Alex Lyakas
Date: Thu Mar 10 13:09:46 2016 +0200
btrfs: csum\_tree\_block: return proper errno value
commit 8bd98f0e6bf792e8fa7c3fed709321ad42ba8d2e upstream.
Signed-off-by: Alex Lyakas
Reviewed-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 13b7e683b67b36a7dc3a5bc98e3718028b3c5dfd
Author: Filipe Manana
Date: Thu Feb 25 23:19:38 2016 +0000
Btrfs: do not collect ordered extents when logging that inode exists
commit 5e33a2bd7ca7fa687fb0965869196eea6815d1f3 upstream.
When logging that an inode exists, for example as part of a directory
fsync operation, we were collecting any ordered extents for the inode but
we ended up doing nothing with them except tagging them as processed, by
setting the flag BTRFS\_ORDERED\_LOGGED on them, which prevented a
subsequent fsync of that inode (using the LOG\_INODE\_ALL mode) from
collecting and processing them. This created a time window where a second
fsync against the inode, using the fast path, ended up not logging the
checksums for the new extents but it logged the extents since they were
part of the list of modified extents. This happened because the ordered
extents were not collected and checksums were not yet added to the csum
tree - the ordered extents have not gone through btrfs\_finish\_ordered\_io()
yet (which is where we add them to the csum tree by calling
inode.c:add\_pending\_csums()).
So fix this by not collecting an inode's ordered extents if we are logging
it with the LOG\_INODE\_EXISTS mode.
Signed-off-by: Filipe Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit ce91def62e14b955a3831af9123c60fefb68d421
Author: Filipe Manana
Date: Wed Feb 24 07:35:05 2016 +0000
Btrfs: fix race when checking if we can skip fsync'ing an inode
commit affc0ff902d539ebe9bba405d330410314f46e9f upstream.
If we're about to do a fast fsync for an inode and btrfs\_inode\_in\_log()
returns false, it's possible that we had an ordered extent in progress
(btrfs\_finish\_ordered\_io() not run yet) when we noticed that the inode's
last\_trans field was not greater than the id of the last committed
transaction, but shortly after, before we checked if there were any
ongoing ordered extents, the ordered extent had just completed and
removed itself from the inode's ordered tree, in which case we end up not
logging the inode, losing some data if a power failure or crash happens
after the fsync handler returns and before the transaction is committed.
Fix this by checking first if there are any ongoing ordered extents
before comparing the inode's last\_trans with the id of the last committed
transaction - when it completes, an ordered extent always updates the
inode's last\_trans before it removes itself from the inode's ordered
tree (at btrfs\_finish\_ordered\_io()).
Signed-off-by: Filipe Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 8eb64c913af6f50933b6a332123d7bb8688b7244
Author: Filipe Manana
Date: Thu Feb 18 14:28:55 2016 +0000
Btrfs: fix deadlock between direct IO reads and buffered writes
commit ade770294df29e08f913e5d733a756893128f45e upstream.
While running a test with a mix of buffered IO and direct IO against
the same files I hit a deadlock reported by the following trace:
[11642.140352] INFO: task kworker/u32:3:15282 blocked for more than 120 seconds.
[11642.142452] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.143982] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.146332] kworker/u32:3 D ffff880230ef7988 [11642.147737] systemd-journald[571]: Sent WATCHDOG=1 notification.
[11642.149771] 0 15282 2 0x00000000
[11642.151205] Workqueue: btrfs-flush\_delalloc btrfs\_flush\_delalloc\_helper [btrfs]
[11642.154074] ffff880230ef7988 0000000000000246 0000000000014ec0 ffff88023ec94ec0
[11642.156722] ffff880233fe8f80 ffff880230ef8000 ffff88023ec94ec0 7fffffffffffffff
[11642.159205] 0000000000000002 ffffffff8147b7f9 ffff880230ef79a0 ffffffff8147b541
[11642.161403] Call Trace:
[11642.162129] [] ? bit\_wait+0x2f/0x2f
[11642.163396] [] schedule+0x82/0x9a
[11642.164871] [] schedule\_timeout+0x43/0x109
[11642.167020] [] ? bit\_wait+0x2f/0x2f
[11642.167931] [] ? trace\_hardirqs\_on\_caller+0x17b/0x197
[11642.182320] [] ? trace\_hardirqs\_on+0xd/0xf
[11642.183762] [] ? timekeeping\_get\_ns+0xe/0x33
[11642.185308] [] ? ktime\_get+0x41/0x52
[11642.186782] [] io\_schedule\_timeout+0xa0/0x102
[11642.188217] [] ? io\_schedule\_timeout+0xa0/0x102
[11642.189626] [] bit\_wait\_io+0x1b/0x39
[11642.190803] [] \_\_wait\_on\_bit\_lock+0x4c/0x90
[11642.192158] [] \_\_lock\_page+0x66/0x68
[11642.193379] [] ? autoremove\_wake\_function+0x3a/0x3a
[11642.194831] [] lock\_page+0x31/0x34 [btrfs]
[11642.197068] [] extent\_write\_cache\_pages.isra.19.constprop.35+0x1af/0x2f4 [btrfs]
[11642.199188] [] extent\_writepages+0x4b/0x5c [btrfs]
[11642.200723] [] ? btrfs\_writepage\_start\_hook+0xce/0xce [btrfs]
[11642.202465] [] btrfs\_writepages+0x28/0x2a [btrfs]
[11642.203836] [] do\_writepages+0x23/0x2c
[11642.205624] [] \_\_filemap\_fdatawrite\_range+0x5a/0x61
[11642.207057] [] filemap\_fdatawrite\_range+0x13/0x15
[11642.208529] [] btrfs\_start\_ordered\_extent+0xd0/0x1a1 [btrfs]
[11642.210375] [] ? btrfs\_scrubparity\_helper+0x140/0x33a [btrfs]
[11642.212132] [] btrfs\_run\_ordered\_extent\_work+0x25/0x34 [btrfs]
[11642.213837] [] btrfs\_scrubparity\_helper+0x15c/0x33a [btrfs]
[11642.215457] [] btrfs\_flush\_delalloc\_helper+0xe/0x10 [btrfs]
[11642.217095] [] process\_one\_work+0x256/0x48b
[11642.218324] [] worker\_thread+0x1f5/0x2a7
[11642.219466] [] ? rescuer\_thread+0x289/0x289
[11642.220801] [] kthread+0xd4/0xdc
[11642.222032] [] ? kthread\_parkme+0x24/0x24
[11642.223190] [] ret\_from\_fork+0x3f/0x70
[11642.224394] [] ? kthread\_parkme+0x24/0x24
[11642.226295] 2 locks held by kworker/u32:3/15282:
[11642.227273] #0: ("%s-%s""btrfs", name){++++.+}, at: [] process\_one\_work+0x165/0x48b
[11642.229412] #1: ((&work->normal\_work)){+.+.+.}, at: [] process\_one\_work+0x165/0x48b
[11642.231414] INFO: task kworker/u32:8:15289 blocked for more than 120 seconds.
[11642.232872] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.234109] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.235776] kworker/u32:8 D ffff88020de5f848 0 15289 2 0x00000000
[11642.237412] Workqueue: writeback wb\_workfn (flush-btrfs-481)
[11642.238670] ffff88020de5f848 0000000000000246 0000000000014ec0 ffff88023ed54ec0
[11642.240475] ffff88021b1ece40 ffff88020de60000 ffff88023ed54ec0 7fffffffffffffff
[11642.242154] 0000000000000002 ffffffff8147b7f9 ffff88020de5f860 ffffffff8147b541
[11642.243715] Call Trace:
[11642.244390] [] ? bit\_wait+0x2f/0x2f
[11642.245432] [] schedule+0x82/0x9a
[11642.246392] [] schedule\_timeout+0x43/0x109
[11642.247479] [] ? bit\_wait+0x2f/0x2f
[11642.248551] [] ? trace\_hardirqs\_on\_caller+0x17b/0x197
[11642.249968] [] ? trace\_hardirqs\_on+0xd/0xf
[11642.251043] [] ? timekeeping\_get\_ns+0xe/0x33
[11642.252202] [] ? ktime\_get+0x41/0x52
[11642.253210] [] io\_schedule\_timeout+0xa0/0x102
[11642.254307] [] ? io\_schedule\_timeout+0xa0/0x102
[11642.256118] [] bit\_wait\_io+0x1b/0x39
[11642.257131] [] \_\_wait\_on\_bit\_lock+0x4c/0x90
[11642.258200] [] \_\_lock\_page+0x66/0x68
[11642.259168] [] ? autoremove\_wake\_function+0x3a/0x3a
[11642.260516] [] lock\_page+0x31/0x34 [btrfs]
[11642.261841] [] extent\_write\_cache\_pages.isra.19.constprop.35+0x1af/0x2f4 [btrfs]
[11642.263531] [] extent\_writepages+0x4b/0x5c [btrfs]
[11642.264747] [] ? btrfs\_writepage\_start\_hook+0xce/0xce [btrfs]
[11642.266148] [] btrfs\_writepages+0x28/0x2a [btrfs]
[11642.267264] [] do\_writepages+0x23/0x2c
[11642.268280] [] \_\_writeback\_single\_inode+0xda/0x5ba
[11642.269407] [] writeback\_sb\_inodes+0x27b/0x43d
[11642.270476] [] \_\_writeback\_inodes\_wb+0x76/0xae
[11642.271547] [] wb\_writeback+0x19e/0x41c
[11642.272588] [] wb\_workfn+0x201/0x341
[11642.273523] [] ? wb\_workfn+0x201/0x341
[11642.274479] [] process\_one\_work+0x256/0x48b
[11642.275497] [] worker\_thread+0x1f5/0x2a7
[11642.276518] [] ? rescuer\_thread+0x289/0x289
[11642.277520] [] ? rescuer\_thread+0x289/0x289
[11642.278517] [] kthread+0xd4/0xdc
[11642.279371] [] ? kthread\_parkme+0x24/0x24
[11642.280468] [] ret\_from\_fork+0x3f/0x70
[11642.281607] [] ? kthread\_parkme+0x24/0x24
[11642.282604] 3 locks held by kworker/u32:8/15289:
[11642.283423] #0: ("writeback"){++++.+}, at: [] process\_one\_work+0x165/0x48b
[11642.285629] #1: ((&(&wb->dwork)->work)){+.+.+.}, at: [] process\_one\_work+0x165/0x48b
[11642.287538] #2: (&type->s\_umount\_key#37){+++++.}, at: [] trylock\_super+0x1b/0x4b
[11642.289423] INFO: task fdm-stress:26848 blocked for more than 120 seconds.
[11642.290547] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.291453] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.292864] fdm-stress D ffff88022c107c20 0 26848 26591 0x00000000
[11642.294118] ffff88022c107c20 000000038108affa 0000000000014ec0 ffff88023ed54ec0
[11642.295602] ffff88013ab1ca40 ffff88022c108000 ffff8800b2fc19d0 00000000000e0fff
[11642.297098] ffff8800b2fc19b0 ffff88022c107c88 ffff88022c107c38 ffffffff8147b541
[11642.298433] Call Trace:
[11642.298896] [] schedule+0x82/0x9a
[11642.299738] [] lock\_extent\_bits+0xfe/0x1a3 [btrfs]
[11642.300833] [] ? add\_wait\_queue\_exclusive+0x44/0x44
[11642.301943] [] lock\_and\_cleanup\_extent\_if\_need+0x68/0x18e [btrfs]
[11642.303270] [] \_\_btrfs\_buffered\_write+0x238/0x4c1 [btrfs]
[11642.304552] [] ? btrfs\_file\_write\_iter+0x17c/0x408 [btrfs]
[11642.305782] [] btrfs\_file\_write\_iter+0x2f4/0x408 [btrfs]
[11642.306878] [] \_\_vfs\_write+0x7c/0xa5
[11642.307729] [] vfs\_write+0x9d/0xe8
[11642.308602] [] SyS\_write+0x50/0x7e
[11642.309410] [] entry\_SYSCALL\_64\_fastpath+0x12/0x6b
[11642.310403] 3 locks held by fdm-stress/26848:
[11642.311108] #0: (&f->f\_pos\_lock){+.+.+.}, at: [] \_\_fdget\_pos+0x3a/0x40
[11642.312578] #1: (sb\_writers#11){.+.+.+}, at: [] \_\_sb\_start\_write+0x5f/0xb0
[11642.314170] #2: (&sb->s\_type->i\_mutex\_key#15){+.+.+.}, at: [] btrfs\_file\_write\_iter+0x73/0x408 [btrfs]
[11642.316796] INFO: task fdm-stress:26849 blocked for more than 120 seconds.
[11642.317842] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.318691] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.319959] fdm-stress D ffff8801964ffa68 0 26849 26591 0x00000000
[11642.321312] ffff8801964ffa68 00ff8801e9975f80 0000000000014ec0 ffff88023ed94ec0
[11642.322555] ffff8800b00b4840 ffff880196500000 ffff8801e9975f20 0000000000000002
[11642.323715] ffff8801e9975f18 ffff8800b00b4840 ffff8801964ffa80 ffffffff8147b541
[11642.325096] Call Trace:
[11642.325532] [] schedule+0x82/0x9a
[11642.326303] [] schedule\_timeout+0x43/0x109
[11642.327180] [] ? mark\_held\_locks+0x5e/0x74
[11642.328114] [] ? \_raw\_spin\_unlock\_irq+0x2c/0x4a
[11642.329051] [] ? trace\_hardirqs\_on\_caller+0x17b/0x197
[11642.330053] [] \_\_wait\_for\_common+0x109/0x147
[11642.330952] [] ? \_\_wait\_for\_common+0x109/0x147
[11642.331869] [] ? usleep\_range+0x4a/0x4a
[11642.332925] [] ? wake\_up\_q+0x47/0x47
[11642.333736] [] wait\_for\_completion+0x24/0x26
[11642.334672] [] btrfs\_wait\_ordered\_extents+0x1c8/0x217 [btrfs]
[11642.335858] [] btrfs\_mksubvol+0x224/0x45d [btrfs]
[11642.336854] [] ? add\_wait\_queue\_exclusive+0x44/0x44
[11642.337820] [] btrfs\_ioctl\_snap\_create\_transid+0x148/0x17a [btrfs]
[11642.339026] [] btrfs\_ioctl\_snap\_create\_v2+0xc7/0x110 [btrfs]
[11642.340214] [] btrfs\_ioctl+0x590/0x27bd [btrfs]
[11642.341123] [] ? mutex\_unlock+0xe/0x10
[11642.341934] [] ? ext4\_file\_write\_iter+0x2a3/0x36f [ext4]
[11642.342936] [] ? \_\_lock\_is\_held+0x3c/0x57
[11642.343772] [] ? rcu\_read\_unlock+0x3e/0x5d
[11642.344673] [] do\_vfs\_ioctl+0x458/0x4dc
[11642.346024] [] ? \_\_fget\_light+0x62/0x71
[11642.346873] [] SyS\_ioctl+0x57/0x79
[11642.347720] [] entry\_SYSCALL\_64\_fastpath+0x12/0x6b
[11642.350222] 4 locks held by fdm-stress/26849:
[11642.350898] #0: (sb\_writers#11){.+.+.+}, at: [] \_\_sb\_start\_write+0x5f/0xb0
[11642.352375] #1: (&type->i\_mutex\_dir\_key#4/1){+.+.+.}, at: [] btrfs\_mksubvol+0x4b/0x45d [btrfs]
[11642.354072] #2: (&fs\_info->subvol\_sem){++++..}, at: [] btrfs\_mksubvol+0xf4/0x45d [btrfs]
[11642.355647] #3: (&root->ordered\_extent\_mutex){+.+...}, at: [] btrfs\_wait\_ordered\_extents+0x50/0x217 [btrfs]
[11642.357516] INFO: task fdm-stress:26850 blocked for more than 120 seconds.
[11642.358508] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.359376] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.368625] fdm-stress D ffff88021f167688 0 26850 26591 0x00000000
[11642.369716] ffff88021f167688 0000000000000001 0000000000014ec0 ffff88023edd4ec0
[11642.370950] ffff880128a98680 ffff88021f168000 ffff88023edd4ec0 7fffffffffffffff
[11642.372210] 0000000000000002 ffffffff8147b7f9 ffff88021f1676a0 ffffffff8147b541
[11642.373430] Call Trace:
[11642.373853] [] ? bit\_wait+0x2f/0x2f
[11642.374623] [] schedule+0x82/0x9a
[11642.375948] [] schedule\_timeout+0x43/0x109
[11642.376862] [] ? bit\_wait+0x2f/0x2f
[11642.377637] [] ? trace\_hardirqs\_on\_caller+0x17b/0x197
[11642.378610] [] ? trace\_hardirqs\_on+0xd/0xf
[11642.379457] [] ? timekeeping\_get\_ns+0xe/0x33
[11642.380366] [] ? ktime\_get+0x41/0x52
[11642.381353] [] io\_schedule\_timeout+0xa0/0x102
[11642.382255] [] ? io\_schedule\_timeout+0xa0/0x102
[11642.383162] [] bit\_wait\_io+0x1b/0x39
[11642.383945] [] \_\_wait\_on\_bit\_lock+0x4c/0x90
[11642.384875] [] \_\_lock\_page+0x66/0x68
[11642.385749] [] ? autoremove\_wake\_function+0x3a/0x3a
[11642.386721] [] lock\_page+0x31/0x34 [btrfs]
[11642.387596] [] extent\_write\_cache\_pages.isra.19.constprop.35+0x1af/0x2f4 [btrfs]
[11642.389030] [] extent\_writepages+0x4b/0x5c [btrfs]
[11642.389973] [] ? rcu\_read\_lock\_sched\_held+0x61/0x69
[11642.390939] [] ? btrfs\_writepage\_start\_hook+0xce/0xce [btrfs]
[11642.392271] [] ? \_\_clear\_extent\_bit+0x26e/0x2c0 [btrfs]
[11642.393305] [] btrfs\_writepages+0x28/0x2a [btrfs]
[11642.394239] [] do\_writepages+0x23/0x2c
[11642.395045] [] \_\_filemap\_fdatawrite\_range+0x5a/0x61
[11642.395991] [] filemap\_fdatawrite\_range+0x13/0x15
[11642.397144] [] btrfs\_start\_ordered\_extent+0xd0/0x1a1 [btrfs]
[11642.398392] [] ? clear\_extent\_bit+0x17/0x19 [btrfs]
[11642.399363] [] btrfs\_get\_blocks\_direct+0x12b/0x61c [btrfs]
[11642.400445] [] ? dio\_bio\_add\_page+0x3d/0x54
[11642.401309] [] ? submit\_page\_section+0x7b/0x111
[11642.402213] [] do\_blockdev\_direct\_IO+0x685/0xc24
[11642.403139] [] ? btrfs\_page\_exists\_in\_range+0x1a1/0x1a1 [btrfs]
[11642.404360] [] ? btrfs\_get\_extent\_fiemap+0x1c0/0x1c0 [btrfs]
[11642.406187] [] \_\_blockdev\_direct\_IO+0x31/0x33
[11642.407070] [] ? \_\_blockdev\_direct\_IO+0x31/0x33
[11642.407990] [] ? btrfs\_get\_extent\_fiemap+0x1c0/0x1c0 [btrfs]
[11642.409192] [] btrfs\_direct\_IO+0x1c7/0x27e [btrfs]
[11642.410146] [] ? btrfs\_get\_extent\_fiemap+0x1c0/0x1c0 [btrfs]
[11642.411291] [] generic\_file\_read\_iter+0x89/0x4e1
[11642.412263] [] ? mark\_lock+0x24/0x201
[11642.413057] [] \_\_vfs\_read+0x79/0x9d
[11642.413897] [] vfs\_read+0x8f/0xd2
[11642.414708] [] SyS\_read+0x50/0x7e
[11642.415573] [] entry\_SYSCALL\_64\_fastpath+0x12/0x6b
[11642.416572] 1 lock held by fdm-stress/26850:
[11642.417345] #0: (&f->f\_pos\_lock){+.+.+.}, at: [] \_\_fdget\_pos+0x3a/0x40
[11642.418703] INFO: task fdm-stress:26851 blocked for more than 120 seconds.
[11642.419698] Not tainted 4.4.0-rc6-btrfs-next-21+ #1
[11642.420612] "echo 0 > /proc/sys/kernel/hung\_task\_timeout\_secs" disables this message.
[11642.421807] fdm-stress D ffff880196483d28 0 26851 26591 0x00000000
[11642.422878] ffff880196483d28 00ff8801c8f60740 0000000000014ec0 ffff88023ed94ec0
[11642.424149] ffff8801c8f60740 ffff880196484000 0000000000000246 ffff8801c8f60740
[11642.425374] ffff8801bb711840 ffff8801bb711878 ffff880196483d40 ffffffff8147b541
[11642.426591] Call Trace:
[11642.427013] [] schedule+0x82/0x9a
[11642.427856] [] schedule\_preempt\_disabled+0x18/0x24
[11642.428852] [] mutex\_lock\_nested+0x1d7/0x3b4
[11642.429743] [] ? btrfs\_wait\_ordered\_extents+0x50/0x217 [btrfs]
[11642.430911] [] btrfs\_wait\_ordered\_extents+0x50/0x217 [btrfs]
[11642.432102] [] ? btrfs\_wait\_ordered\_roots+0x57/0x191 [btrfs]
[11642.433259] [] ? btrfs\_wait\_ordered\_extents+0x50/0x217 [btrfs]
[11642.434431] [] btrfs\_wait\_ordered\_roots+0xcd/0x191 [btrfs]
[11642.436079] [] btrfs\_sync\_fs+0xe0/0x1ad [btrfs]
[11642.437009] [] ? SyS\_tee+0x23c/0x23c
[11642.437860] [] sync\_fs\_one\_sb+0x20/0x22
[11642.438723] [] iterate\_supers+0x75/0xc2
[11642.439597] [] sys\_sync+0x52/0x80
[11642.440454] [] entry\_SYSCALL\_64\_fastpath+0x12/0x6b
[11642.441533] 3 locks held by fdm-stress/26851:
[11642.442370] #0: (&type->s\_umount\_key#37){+++++.}, at: [] iterate\_supers+0x5f/0xc2
[11642.444043] #1: (&fs\_info->ordered\_operations\_mutex){+.+...}, at: [] btrfs\_wait\_ordered\_roots+0x44/0x191 [btrfs]
[11642.446010] #2: (&root->ordered\_extent\_mutex){+.+...}, at: [] btrfs\_wait\_ordered\_extents+0x50/0x217 [btrfs]
This happened because under specific timings the path for direct IO reads
can deadlock with concurrent buffered writes. The diagram below shows how
this happens for an example file that has the following layout:
[ extent A ] [ extent B ] [ ....
0K 4K 8K
CPU 1 CPU 2 CPU 3
DIO read against range
[0K, 8K[ starts
btrfs\_direct\_IO()
--> calls btrfs\_get\_blocks\_direct()
which finds the extent map for the
extent A and leaves the range
[0K, 4K[ locked in the inode's
io tree
buffered write against
range [4K, 8K[ starts
\_\_btrfs\_buffered\_write()
--> dirties page at 4K
a user space
task calls sync
for e.g or
writepages() is
invoked by mm
writepages()
run\_delalloc\_range()
cow\_file\_range()
--> ordered extent X
for the buffered
write is created
and
writeback starts
--> calls btrfs\_get\_blocks\_direct()
again, without submitting first
a bio for reading extent A, and
finds the extent map for extent B
--> calls lock\_extent\_direct()
--> locks range [4K, 8K[
--> finds ordered extent X
covering range [4K, 8K[
--> unlocks range [4K, 8K[
buffered write against
range [0K, 8K[ starts
\_\_btrfs\_buffered\_write()
prepare\_pages()
--> locks pages with
offsets 0 and 4K
lock\_and\_cleanup\_extent\_if\_need()
--> blocks attempting to
lock range [0K, 8K[ in
the inode's io tree,
because the range [0, 4K[
is already locked by the
direct IO task at CPU 1
--> calls
btrfs\_start\_ordered\_extent(oe X)
btrfs\_start\_ordered\_extent(oe X)
--> At this point writeback for ordered
extent X has not finished yet
filemap\_fdatawrite\_range()
btrfs\_writepages()
extent\_writepages()
extent\_write\_cache\_pages()
--> finds page with offset 0
with the writeback tag
(and not dirty)
--> tries to lock it
--> deadlock, task at CPU 2
has the page locked and
is blocked on the io range
[0, 4K[ that was locked
earlier by this task
So fix this by falling back to a buffered read in the direct IO read path
when an ordered extent for a buffered write is found.
Signed-off-by: Filipe Manana
Reviewed-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 4165ca37d62621cbf4e3ea4eea3bb9aa4f8c32b6
Author: Filipe Manana
Date: Fri Feb 12 14:44:00 2016 +0000
Btrfs: fix extent\_same allowing destination offset beyond i\_size
commit f4dfe6871006c62abdccc77b2818b11f376e98e2 upstream.
When using the same file as the source and destination for a dedup
(extent\_same ioctl) operation we were allowing it to dedup to a
destination offset beyond the file's size, which doesn't make sense and
it's not allowed for the case where the source and destination files are
not the same file. This made de deduplication operation successful only
when the source range corresponded to a hole, a prealloc extent or an
extent with all bytes having a value of 0x00. This was also leaving a
file hole (between i\_size and destination offset) without the
corresponding file extent items, which can be reproduced with the
following steps for example:
$ mkfs.btrfs -f /dev/sdi
$ mount /dev/sdi /mnt/sdi
$ xfs\_io -f -c "pwrite -S 0xab 304457 404990" /mnt/sdi/foobar
wrote 404990/404990 bytes at offset 304457
395 KiB, 99 ops; 0.0000 sec (31.150 MiB/sec and 7984.5149 ops/sec)
$ /git/hub/duperemove/btrfs-extent-same 24576 /mnt/sdi/foobar 28672 /mnt/sdi/foobar 929792
Deduping 2 total files
(28672, 24576): /mnt/sdi/foobar
(929792, 24576): /mnt/sdi/foobar
1 files asked to be deduped
i: 0, status: 0, bytes\_deduped: 24576
24576 total bytes deduped in this operation
$ umount /mnt/sdi
$ btrfsck /dev/sdi
Checking filesystem on /dev/sdi
UUID: 98c528aa-0833-427d-9403-b98032ffbf9d
checking extents
checking free space cache
checking fs roots
root 5 inode 257 errors 100, file extent discount
Found file extent holes:
start: 712704, len: 217088
found 540673 bytes used err is 1
total csum bytes: 400
total tree bytes: 131072
total fs tree bytes: 32768
total extent tree bytes: 16384
btree space waste bytes: 123675
file data blocks allocated: 671744
referenced 671744
btrfs-progs v4.2.3
So fix this by not allowing the destination to go beyond the file's size,
just as we do for the same where the source and destination files are not
the same.
A test for xfstests follows.
Signed-off-by: Filipe Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 36ff8607d6b0986289bf94bd9d110a1e0feeac38
Author: Filipe Manana
Date: Fri Feb 12 11:34:23 2016 +0000
Btrfs: fix file loss on log replay after renaming a file and fsync
commit 2be63d5ce929603d4e7cedabd9e992eb34a0ff95 upstream.
We have two cases where we end up deleting a file at log replay time
when we should not. For this to happen the file must have been renamed
and a directory inode must have been fsynced/logged.
Two examples that exercise these two cases are listed below.
Case 1)
$ mkfs.btrfs -f /dev/sdb
$ mount /dev/sdb /mnt
$ mkdir -p /mnt/a/b
$ mkdir /mnt/c
$ touch /mnt/a/b/foo
$ sync
$ mv /mnt/a/b/foo /mnt/c/
# Create file bar just to make sure the fsync on directory a/ does
# something and it's not a no-op.
$ touch /mnt/a/bar
$ xfs\_io -c "fsync" /mnt/a
< power fail / crash >
The next time the filesystem is mounted, the log replay procedure
deletes file foo.
Case 2)
$ mkfs.btrfs -f /dev/sdb
$ mount /dev/sdb /mnt
$ mkdir /mnt/a
$ mkdir /mnt/b
$ mkdir /mnt/c
$ touch /mnt/a/foo
$ ln /mnt/a/foo /mnt/b/foo\_link
$ touch /mnt/b/bar
$ sync
$ unlink /mnt/b/foo\_link
$ mv /mnt/b/bar /mnt/c/
$ xfs\_io -c "fsync" /mnt/a/foo
< power fail / crash >
The next time the filesystem is mounted, the log replay procedure
deletes file bar.
The reason why the files are deleted is because when we log inodes
other then the fsync target inode, we ignore their last\_unlink\_trans
value and leave the log without enough information to later replay the
rename operations. So we need to look at the last\_unlink\_trans values
and fallback to a transaction commit if they are greater than the
id of the last committed transaction.
So fix this by looking at the last\_unlink\_trans values and fallback to
transaction commits when needed. Also, when logging other inodes (for
case 1 we logged descendants of the fsync target inode while for case 2
we logged ascendants) we need to care about concurrent tasks updating
the last\_unlink\_trans of inodes we are logging (which was already an
existing problem in check\_parent\_dirs\_for\_sync()). Since we can not
acquire their inode mutex (vfs' struct inode ->i\_mutex), as that causes
deadlocks with other concurrent operations that acquire the i\_mutex of
2 inodes (other fsyncs or renames for example), we need to serialize on
the log\_mutex of the inode we are logging. A task setting a new value for
an inode's last\_unlink\_trans must acquire the inode's log\_mutex and it
must do this update before doing the actual unlink operation (which is
already the case except when deleting a snapshot). Conversely the task
logging the inode must first log the inode and then check the inode's
last\_unlink\_trans value while holding its log\_mutex, as if its value is
not greater then the id of the last committed transaction it means it
logged a safe state of the inode's items, while if its value is not
smaller then the id of the last committed transaction it means the inode
state it has logged might not be safe (the concurrent task might have
just updated last\_unlink\_trans but hasn't done yet the unlink operation)
and therefore a transaction commit must be done.
Test cases for xfstests follow in separate patches.
Signed-off-by: Filipe Manana
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 29b3f509c92a94cd7751db8b96c29d6c8de6bf11
Author: Filipe Manana
Date: Wed Feb 10 10:42:25 2016 +0000
Btrfs: fix unreplayable log after snapshot delete + parent dir fsync
commit 1ec9a1ae1e30c733077c0b288c4301b66b7a81f2 upstream.
If we delete a snapshot, fsync its parent directory and crash/power fail
before the next transaction commit, on the next mount when we attempt to
replay the log tree of the root containing the parent directory we will
fail and prevent the filesystem from mounting, which is solvable by wiping
out the log trees with the btrfs-zero-log tool but very inconvenient as
we will lose any data and metadata fsynced before the parent directory
was fsynced.
For example:
$ mkfs.btrfs -f /dev/sdc
$ mount /dev/sdc /mnt
$ mkdir /mnt/testdir
$ btrfs subvolume snapshot /mnt /mnt/testdir/snap
$ btrfs subvolume delete /mnt/testdir/snap
$ xfs\_io -c "fsync" /mnt/testdir
< crash / power failure and reboot >
$ mount /dev/sdc /mnt
mount: mount(2) failed: No such file or directory
And in dmesg/syslog we get the following message and trace:
[192066.361162] BTRFS info (device dm-0): failed to delete reference to snap, inode 257 parent 257
[192066.363010] ------------[ cut here ]------------
[192066.365268] WARNING: CPU: 4 PID: 5130 at fs/btrfs/inode.c:3986 \_\_btrfs\_unlink\_inode+0x17a/0x354 [btrfs]()
[192066.367250] BTRFS: Transaction aborted (error -2)
[192066.368401] Modules linked in: btrfs dm\_flakey dm\_mod ppdev sha256\_generic xor raid6\_pq hmac drbg ansi\_cprng aesni\_intel acpi\_cpufreq tpm\_tis aes\_x86\_64 tpm ablk\_helper evdev cryptd sg parport\_pc i2c\_piix4 psmouse lrw parport i2c\_core pcspkr gf128mul processor serio\_raw glue\_helper button loop autofs4 ext4 crc16 mbcache jbd2 sd\_mod sr\_mod cdrom ata\_generic virtio\_scsi ata\_piix libata virtio\_pci virtio\_ring crc32c\_intel scsi\_mod e1000 virtio floppy [last unloaded: btrfs]
[192066.377154] CPU: 4 PID: 5130 Comm: mount Tainted: G W 4.4.0-rc6-btrfs-next-20+ #1
[192066.378875] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS by qemu-project.org 04/01/2014
[192066.380889] 0000000000000000 ffff880143923670 ffffffff81257570 ffff8801439236b8
[192066.382561] ffff8801439236a8 ffffffff8104ec07 ffffffffa039dc2c 00000000fffffffe
[192066.384191] ffff8801ed31d000 ffff8801b9fc9c88 ffff8801086875e0 ffff880143923710
[192066.385827] Call Trace:
[192066.386373] [] dump\_stack+0x4e/0x79
[192066.387387] [] warn\_slowpath\_common+0x99/0xb2
[192066.388429] [] ? \_\_btrfs\_unlink\_inode+0x17a/0x354 [btrfs]
[192066.389236] [] warn\_slowpath\_fmt+0x48/0x50
[192066.389884] [] \_\_btrfs\_unlink\_inode+0x17a/0x354 [btrfs]
[192066.390621] [] ? iput+0xb0/0x266
[192066.391200] [] btrfs\_unlink\_inode+0x1c/0x3d [btrfs]
[192066.391930] [] check\_item\_in\_log+0x1fe/0x29b [btrfs]
[192066.392715] [] replay\_dir\_deletes+0x167/0x1cf [btrfs]
[192066.393510] [] replay\_one\_buffer+0x417/0x570 [btrfs]
[192066.394241] [] walk\_up\_log\_tree+0x10e/0x1dc [btrfs]
[192066.394958] [] walk\_log\_tree+0xa5/0x190 [btrfs]
[192066.395628] [] btrfs\_recover\_log\_trees+0x239/0x32c [btrfs]
[192066.396790] [] ? replay\_one\_extent+0x50a/0x50a [btrfs]
[192066.397891] [] open\_ctree+0x1d8b/0x2167 [btrfs]
[192066.398897] [] btrfs\_mount+0x5ef/0x729 [btrfs]
[192066.399823] [] ? trace\_hardirqs\_on+0xd/0xf
[192066.400739] [] ? lockdep\_init\_map+0xb9/0x1b3
[192066.401700] [] mount\_fs+0x67/0x131
[192066.402482] [] vfs\_kern\_mount+0x6c/0xde
[192066.403930] [] btrfs\_mount+0x1cb/0x729 [btrfs]
[192066.404831] [] ? trace\_hardirqs\_on+0xd/0xf
[192066.405726] [] ? lockdep\_init\_map+0xb9/0x1b3
[192066.406621] [] mount\_fs+0x67/0x131
[192066.407401] [] vfs\_kern\_mount+0x6c/0xde
[192066.408247] [] do\_mount+0x893/0x9d2
[192066.409047] [] ? strndup\_user+0x3f/0x8c
[192066.409842] [] SyS\_mount+0x75/0xa1
[192066.410621] [] entry\_SYSCALL\_64\_fastpath+0x12/0x6b
[192066.411572] ---[ end trace 2de42126c1e0a0f0 ]---
[192066.412344] BTRFS: error (device dm-0) in \_\_btrfs\_unlink\_inode:3986: errno=-2 No such entry
[192066.413748] BTRFS: error (device dm-0) in btrfs\_replay\_log:2464: errno=-2 No such entry (Failed to recover log tree)
[192066.415458] BTRFS error (device dm-0): cleaner transaction attach returned -30
[192066.444613] BTRFS: open\_ctree failed
This happens because when we are replaying the log and processing the
directory entry pointing to the snapshot in the subvolume tree, we treat
its btrfs\_dir\_item item as having a location with a key type matching
BTRFS\_INODE\_ITEM\_KEY, which is wrong because the type matches
BTRFS\_ROOT\_ITEM\_KEY and therefore must be processed differently, as the
object id refers to a root number and not to an inode in the root
containing the parent directory.
So fix this by triggering a transaction commit if an fsync against the
parent directory is requested after deleting a snapshot. This is the
simplest approach for a rare use case. Some alternative that avoids the
transaction commit would require more code to explicitly delete the
snapshot at log replay time (factoring out common code from ioctl.c:
btrfs\_ioctl\_snap\_destroy()), special care at fsync time to remove the
log tree of the snapshot's root from the log root of the root of tree
roots, amongst other steps.
A test case for xfstests that triggers the issue follows.
seq=`basename $0`
seqres=$RESULT\_DIR/$seq
echo "QA output created by $seq"
tmp=/tmp/$$
status=1 # failure is the default!
trap "\_cleanup; exit \$status" 0 1 2 3 15
\_cleanup()
{
\_cleanup\_flakey
cd /
rm -f $tmp.\*
}
# get standard environment, filters and checks
. ./common/rc
. ./common/filter
. ./common/dmflakey
# real QA test starts here
\_need\_to\_be\_root
\_supported\_fs btrfs
\_supported\_os Linux
\_require\_scratch
\_require\_dm\_target flakey
\_require\_metadata\_journaling $SCRATCH\_DEV
rm -f $seqres.full
\_scratch\_mkfs >>$seqres.full 2>&1
\_init\_flakey
\_mount\_flakey
# Create a snapshot at the root of our filesystem (mount point path), delete it,
# fsync the mount point path, crash and mount to replay the log. This should
# succeed and after the filesystem is mounted the snapshot should not be visible
# anymore.
\_run\_btrfs\_util\_prog subvolume snapshot $SCRATCH\_MNT $SCRATCH\_MNT/snap1
\_run\_btrfs\_util\_prog subvolume delete $SCRATCH\_MNT/snap1
$XFS\_IO\_PROG -c "fsync" $SCRATCH\_MNT
\_flakey\_drop\_and\_remount
[ -e $SCRATCH\_MNT/snap1 ] && \
echo "Snapshot snap1 still exists after log replay"
# Similar scenario as above, but this time the snapshot is created inside a
# directory and not directly under the root (mount point path).
mkdir $SCRATCH\_MNT/testdir
\_run\_btrfs\_util\_prog subvolume snapshot $SCRATCH\_MNT $SCRATCH\_MNT/testdir/snap2
\_run\_btrfs\_util\_prog subvolume delete $SCRATCH\_MNT/testdir/snap2
$XFS\_IO\_PROG -c "fsync" $SCRATCH\_MNT/testdir
\_flakey\_drop\_and\_remount
[ -e $SCRATCH\_MNT/testdir/snap2 ] && \
echo "Snapshot snap2 still exists after log replay"
\_unmount\_flakey
echo "Silence is golden"
status=0
exit
Signed-off-by: Filipe Manana
Tested-by: Liu Bo
Reviewed-by: Liu Bo
Signed-off-by: Chris Mason
Signed-off-by: Greg Kroah-Hartman
commit 259d2fbd9de65c6a74b3b24e3108b1b1e503849b
Author: David Sterba
Date: Thu Oct 8 14:14:16 2015 +0200
btrfs: change max\_inline default to 2048
commit f7e98a7fff8634ae655c666dc2c9fc55a48d0a73 upstream.
The current practical default is ~4k on x86\_64 (the logic is more complex,
simplified for brevity), the inlined files land in the metadata group and
thus consume space that could be needed for the real metadata.
The inlining brings some usability surprises:
1) total space consumption measured on various filesystems and btrfs
with DUP metadata was quite visible because of the duplicated data
within metadata
2) inlined data may exhaust the metadata, which are more precious in case
the entire device space is allocated to chunks (ie. balance cannot
make the space more compact)
3) performance suffers a bit as the inlined blocks are duplicate and
stored far away on the device.
Proposed fix: set the default to 2048
This fixes namely 1), the total filesysystem space consumption will be on
par with other filesystems.
Partially fixes 2), more data are pushed to the data block groups.
The characteristics of 3) are based on actual small file size
distribution.
The change is independent of the metadata blockgroup type (though it's
most visible with DUP) or system page size as these parameters are not
trival to find out, compared to file size.
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 202efaae84a571169bb9f0b17618eb7f718675cc
Author: David Sterba
Date: Thu Feb 11 15:30:07 2016 +0100
btrfs: remove error message from search ioctl for nonexistent tree
commit 11ea474f74709fc764fb7e80306e0776f94ce8b8 upstream.
Let's remove the error message that appears when the tree\_id is not
present. This can happen with the quota tree and has been observed in
practice. The applications are supposed to handle -ENOENT and we don't
need to report that in the system log as it's not a fatal error.
Reported-by: Vlastimil Babka
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 94863434d5f90aae0a956f7c2b753f959dcc0c85
Author: Josef Bacik
Date: Wed Jan 13 11:48:06 2016 -0500
Btrfs: fix truncate\_space\_check
commit dc95f7bfc57fa4b75a77d0da84d5db249d74aa3f upstream.
truncate\_space\_check is using btrfs\_csum\_bytes\_to\_leaves() but forgetting to
multiply by nodesize so we get an actual byte count. We need a tracepoint here
so that we have the matching reserve for the release that will come later. Also
add a comment to make clear what the intent of truncate\_space\_check is.
Signed-off-by: Josef Bacik
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 94ad29d2ad1010e9966b385a3d4151fb475cfc61
Author: Zhao Lei
Date: Fri Dec 18 21:33:05 2015 +0800
btrfs: reada: Fix in-segment calculation for reada
commit 503785306d182ab624a2232856ef8ab503ee85f9 upstream.
reada\_zone->end is end pos of segment:
end = start + cache->key.offset - 1;
So we need to use "<=" in condition to judge is a pos in the
segment.
The problem happened rearly, because logical pos rarely pointed
to last 4k of a blockgroup, but we need to fix it to make code
right in logic.
Signed-off-by: Zhao Lei
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit e23744bfad9fad9d1991298a449342e6f76dd1a6
Author: Alex Deucher
Date: Wed May 11 16:21:03 2016 -0400
drm/amdgpu: fix DP mode validation
commit c47b9e0944e483309d66c807d650ac8b8ceafb57 upstream.
Switch the order of the loops to walk the rates on the top
so we exhaust all DP 1.1 rate/lane combinations before trying
DP 1.2 rate/lane combos.
This avoids selecting rates that are supported by the monitor,
but not the connector leading to valid modes getting rejected.
bug:
https://bugs.freedesktop.org/show\_bug.cgi?id=95206
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit df6ac4bcc9c820841b17b9af0f8c270b54e485cb
Author: Alex Deucher
Date: Wed May 11 16:16:53 2016 -0400
drm/radeon: fix DP mode validation
commit ff0bd441bdfbfa09d05fdba9829a0401a46635c1 upstream.
Switch the order of the loops to walk the rates on the top
so we exhaust all DP 1.1 rate/lane combinations before trying
DP 1.2 rate/lane combos.
This avoids selecting rates that are supported by the monitor,
but not the connector leading to valid modes getting rejected.
bug:
https://bugs.freedesktop.org/show\_bug.cgi?id=95206
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 0f1b8876ab01c393da876070f8a970165db5e158
Author: Arindam Nath
Date: Wed May 4 23:39:59 2016 +0530
drm/radeon: fix DP link training issue with second 4K monitor
commit 1a738347df2ee4977459a8776fe2c62196bdcb1b upstream.
There is an issue observed when we hotplug a second DP
4K monitor to the system. Sometimes, the link training
fails for the second monitor after HPD interrupt
generation.
The issue happens when some queued or deferred transactions
are already present on the AUX channel when we initiate
a new transcation to (say) get DPCD or during link training.
We set AUX\_IGNORE\_HPD\_DISCON bit in the AUX\_CONTROL
register so that we can ignore any such deferred
transactions when a new AUX transaction is initiated.
Signed-off-by: Arindam Nath
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 9907c72bc2428326c31280568875d78ce848e2b9
Author: Imre Deak
Date: Tue May 3 15:54:19 2016 +0300
drm/i915/bdw: Add missing delay during L3 SQC credit programming
commit d6a862fe8c48229ba342648bcd535b2404724603 upstream.
BSpec requires us to wait ~100 clocks before re-enabling clock gating,
so make sure we do this.
CC: Ville Syrjälä
Signed-off-by: Imre Deak
Reviewed-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/1462280061-1457-2-git-send-email-imre.deak@intel.com
(cherry picked from commit 48e5d68d28f00c0cadac5a830980ff3222781abb)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 6c1827a97251893cffd513e83c9b5ef5a20d254d
Author: Lyude
Date: Tue May 3 11:01:32 2016 -0400
Revert "drm/i915: start adding dp mst audio"
commit 26792526cc3e29e3ccbc15c996beb61fa64be5af upstream.
Right now MST audio is causing too many kernel panics to really keep
around in the kernel. On top of that, even after fixing said panics it's
still basically non-functional (at least on all the setups I've tested
it on). Revert until we have a proper solution for this.
This reverts commit 3d52ccf52f2c51f613e42e65be0f06e4e6788093.
Signed-off-by: Lyude
Fixes: 3d52ccf52f2c ("drm/i915: start adding dp mst audio")
Signed-off-by: Daniel Vetter
Link: http://patchwork.freedesktop.org/patch/msgid/1462287692-28570-1-git-send-email-cpaul@redhat.com
(cherry picked from commit 5a8f97ea04c98201deeb973c3f711c3c156115e9)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 36d8fb8f65ad431fcb26142d6f871de20168fb8e
Author: Daniel Vetter
Date: Tue May 3 10:33:01 2016 +0200
drm/i915: Bail out of pipe config compute loop on LPT
commit 2700818ac9f935d8590715eecd7e8cadbca552b6 upstream.
LPT is pch, so might run into the fdi bandwidth constraint (especially
since it has only 2 lanes). But right now we just force pipe\_bpp back
to 24, resulting in a nice loop (which we bail out with a loud
WARN\_ON). Fix this.
Cc: Chris Wilson
Cc: Maarten Lankhorst
References: https://bugs.freedesktop.org/show\_bug.cgi?id=93477
Signed-off-by: Daniel Vetter
Tested-by: Chris Wilson
Signed-off-by: Maarten Lankhorst
Signed-off-by: Daniel Vetter
Link: http://patchwork.freedesktop.org/patch/msgid/1462264381-7573-1-git-send-email-daniel.vetter@ffwll.ch
(cherry picked from commit f58a1acc7e4a1f37d26124ce4c875c647fbcc61f)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit eca3d50f42068aaa949b633d70ea59914bb0b8dd
Author: Lucas Stach
Date: Thu May 5 10:16:44 2016 -0400
drm/radeon: fix PLL sharing on DCE6.1 (v2)
commit e3c00d87845ab375f90fa6e10a5e72a3a5778cd3 upstream.
On DCE6.1 PPLL2 is exclusively available to UNIPHYA, so it should not
be taken into consideration when looking for an already enabled PLL
to be shared with other outputs.
This fixes the broken VGA port (TRAVIS DP->VGA bridge) on my Richland
based laptop, where the internal display is connected to UNIPHYA through
a TRAVIS DP->LVDS bridge.
Bug:
https://bugs.freedesktop.org/show\_bug.cgi?id=78987
v2: agd: add check in radeon\_get\_shared\_nondp\_ppll as well, drop
extra parameter.
Signed-off-by: Lucas Stach
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit be19315585fa23cc9a2758e9f29f01b1095e134f
Author: Ville Syrjälä
Date: Tue Apr 26 19:46:32 2016 +0300
drm/i915: Update CDCLK\_FREQ register on BDW after changing cdclk frequency
commit a04e23d42a1ce5d5f421692bb1c7e9352832819d upstream.
Update CDCLK\_FREQ on BDW after changing the cdclk frequency. Not sure
if this is a late addition to the spec, or if I simply overlooked this
step when writing the original code.
This is what Bspec has to say about CDCLK\_FREQ:
"Program this field to the CD clock frequency minus one. This is used to
generate a divided down clock for miscellaneous timers in display."
And the "Broadwell Sequences for Changing CD Clock Frequency" section
clarifies this further:
"For CD clock 337.5 MHz, program 337 decimal.
For CD clock 450 MHz, program 449 decimal.
For CD clock 540 MHz, program 539 decimal.
For CD clock 675 MHz, program 674 decimal."
Cc: Mika Kahola
Fixes: b432e5cfd5e9 ("drm/i915: BDW clock change support")
Signed-off-by: Ville Syrjälä
Link: http://patchwork.freedesktop.org/patch/msgid/1461689194-6079-2-git-send-email-ville.syrjala@linux.intel.com
Reviewed-by: Mika Kahola
(cherry picked from commit 7f1052a8fa38df635ab0dc0e6025b64ab9834824)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 1943bd0f10074f9b4636a15e72c00d4e5142a8aa
Author: Mauro Carvalho Chehab
Date: Wed May 11 13:09:34 2016 -0300
Revert "[media] videobuf2-v4l2: Verify planes array in buffer dequeueing"
commit 93f0750dcdaed083d6209b01e952e98ca730db66 upstream.
This patch causes a Kernel panic when called on a DVB driver.
This was also reported by David R :
May 7 14:47:35 server kernel: [ 501.247123] BUG: unable to handle kernel NULL pointer dereference at 0000000000000004
May 7 14:47:35 server kernel: [ 501.247239] IP: [] \_\_verify\_planes\_array.isra.3+0x1/0x80 [videobuf2\_v4l2]
May 7 14:47:35 server kernel: [ 501.247354] PGD cae6f067 PUD ca99c067 PMD 0
May 7 14:47:35 server kernel: [ 501.247426] Oops: 0000 [#1] SMP
May 7 14:47:35 server kernel: [ 501.247482] Modules linked in: xfs tun xt\_connmark xt\_TCPMSS xt\_tcpmss xt\_owner xt\_REDIRECT nf\_nat\_redirect xt\_nat ipt\_MASQUERADE nf\_nat\_masquerade\_ipv4 ts\_kmp ts\_bm xt\_string ipt\_REJECT nf\_reject\_ipv4 xt\_recent xt\_conntrack xt\_multiport xt\_pkttype xt\_tcpudp xt\_mark nf\_log\_ipv4 nf\_log\_common xt\_LOG xt\_limit iptable\_mangle iptable\_nat nf\_conntrack\_ipv4 nf\_defrag\_ipv4 nf\_nat\_ipv4 nf\_nat nf\_conntrack iptable\_filter ip\_tables ip6table\_filter ip6\_tables x\_tables pppoe pppox dm\_crypt ts2020 regmap\_i2c ds3000 cx88\_dvb dvb\_pll cx88\_vp3054\_i2c mt352 videobuf2\_dvb cx8800 cx8802 cx88xx pl2303 tveeprom videobuf2\_dma\_sg ppdev videobuf2\_memops videobuf2\_v4l2 videobuf2\_core dvb\_usb\_digitv snd\_hda\_codec\_via snd\_hda\_codec\_hdmi snd\_hda\_codec\_generic radeon dvb\_usb snd\_hda\_intel amd64\_edac\_mod serio\_raw snd\_hda\_codec edac\_core fbcon k10temp bitblit softcursor snd\_hda\_core font snd\_pcm\_oss i2c\_piix4 snd\_mixer\_oss tileblit drm\_kms\_helper syscopyarea snd\_pcm snd\_seq\_dummy sysfillrect snd\_seq\_oss sysimgblt fb\_sys\_fops ttm snd\_seq\_midi r8169 snd\_rawmidi drm snd\_seq\_midi\_event e1000e snd\_seq snd\_seq\_device snd\_timer snd ptp pps\_core i2c\_algo\_bit soundcore parport\_pc ohci\_pci shpchp tpm\_tis tpm nfsd auth\_rpcgss oid\_registry hwmon\_vid exportfs nfs\_acl mii nfs bonding lockd grace lp sunrpc parport
May 7 14:47:35 server kernel: [ 501.249564] CPU: 1 PID: 6889 Comm: vb2-cx88[0] Not tainted 4.5.3 #3
May 7 14:47:35 server kernel: [ 501.249644] Hardware name: System manufacturer System Product Name/M4A785TD-V EVO, BIOS 0211 07/08/2009
May 7 14:47:35 server kernel: [ 501.249767] task: ffff8800aebf3600 ti: ffff8801e07a0000 task.ti: ffff8801e07a0000
May 7 14:47:35 server kernel: [ 501.249861] RIP: 0010:[] [] \_\_verify\_planes\_array.isra.3+0x1/0x80 [videobuf2\_v4l2]
May 7 14:47:35 server kernel: [ 501.250002] RSP: 0018:ffff8801e07a3de8 EFLAGS: 00010086
May 7 14:47:35 server kernel: [ 501.250071] RAX: 0000000000000283 RBX: ffff880210dc5000 RCX: 0000000000000283
May 7 14:47:35 server kernel: [ 501.250161] RDX: ffffffffa0222cf0 RSI: 0000000000000000 RDI: ffff880210dc5014
May 7 14:47:35 server kernel: [ 501.250251] RBP: ffff8801e07a3df8 R08: ffff8801e07a0000 R09: 0000000000000000
May 7 14:47:35 server kernel: [ 501.250348] R10: 0000000000000000 R11: 0000000000000001 R12: ffff8800cda2a9d8
May 7 14:47:35 server kernel: [ 501.250438] R13: ffff880210dc51b8 R14: 0000000000000000 R15: ffff8800cda2a828
May 7 14:47:35 server kernel: [ 501.250528] FS: 00007f5b77fff700(0000) GS:ffff88021fc40000(0000) knlGS:00000000adaffb40
May 7 14:47:35 server kernel: [ 501.250631] CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b
May 7 14:47:35 server kernel: [ 501.250704] CR2: 0000000000000004 CR3: 00000000ca19d000 CR4: 00000000000006e0
May 7 14:47:35 server kernel: [ 501.250794] Stack:
May 7 14:47:35 server kernel: [ 501.250822] ffff8801e07a3df8 ffffffffa0222cfd ffff8801e07a3e70 ffffffffa0236beb
May 7 14:47:35 server kernel: [ 501.250937] 0000000000000283 ffff8801e07a3e94 0000000000000000 0000000000000000
May 7 14:47:35 server kernel: [ 501.251051] ffff8800aebf3600 ffffffff8108d8e0 ffff8801e07a3e38 ffff8801e07a3e38
May 7 14:47:35 server kernel: [ 501.251165] Call Trace:
May 7 14:47:35 server kernel: [ 501.251200] [] ? \_\_verify\_planes\_array\_core+0xd/0x10 [videobuf2\_v4l2]
May 7 14:47:35 server kernel: [ 501.251306] [] vb2\_core\_dqbuf+0x2eb/0x4c0 [videobuf2\_core]
May 7 14:47:35 server kernel: [ 501.251398] [] ? prepare\_to\_wait\_event+0x100/0x100
May 7 14:47:35 server kernel: [ 501.251482] [] vb2\_thread+0x1cb/0x220 [videobuf2\_core]
May 7 14:47:35 server kernel: [ 501.251569] [] ? vb2\_core\_qbuf+0x230/0x230 [videobuf2\_core]
May 7 14:47:35 server kernel: [ 501.251662] [] ? vb2\_core\_qbuf+0x230/0x230 [videobuf2\_core]
May 7 14:47:35 server kernel: [ 501.255982] [] kthread+0xc4/0xe0
May 7 14:47:35 server kernel: [ 501.260292] [] ? kthread\_park+0x50/0x50
May 7 14:47:35 server kernel: [ 501.264615] [] ret\_from\_fork+0x3f/0x70
May 7 14:47:35 server kernel: [ 501.268962] [] ? kthread\_park+0x50/0x50
May 7 14:47:35 server kernel: [ 501.273216] Code: 0d 01 74 16 48 8b 46 28 48 8b 56 30 48 89 87 d0 01 00 00 48 89 97 d8 01 00 00 5d c3 66 66 66 66 66 2e 0f 1f 84 00 00 00 00 00 55 <8b> 46 04 48 89 e5 8d 50 f7 31 c0 83 fa 01 76 02 5d c3 48 83 7e
May 7 14:47:35 server kernel: [ 501.282146] RIP [] \_\_verify\_planes\_array.isra.3+0x1/0x80 [videobuf2\_v4l2]
May 7 14:47:35 server kernel: [ 501.286391] RSP
May 7 14:47:35 server kernel: [ 501.290619] CR2: 0000000000000004
May 7 14:47:35 server kernel: [ 501.294786] ---[ end trace b2b354153ccad110 ]---
This reverts commit 2c1f6951a8a82e6de0d82b1158b5e493fc6c54ab.
Cc: Sakari Ailus
Cc: Hans Verkuil
Fixes: 2c1f6951a8a8 ("[media] videobuf2-v4l2: Verify planes array in buffer dequeueing")
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Greg Kroah-Hartman
commit 6d8b57ff73188c389d1a3706fd67bb41915bc3ab
Author: Marek Szyprowski
Date: Mon May 9 09:31:47 2016 -0700
Input: max8997-haptic - fix NULL pointer dereference
commit 6ae645d5fa385f3787bf1723639cd907fe5865e7 upstream.
NULL pointer derefence happens when booting with DTB because the
platform data for haptic device is not set in supplied data from parent
MFD device.
The MFD device creates only platform data (from Device Tree) for itself,
not for haptic child.
Unable to handle kernel NULL pointer dereference at virtual address 0000009c
pgd = c0004000
[0000009c] \*pgd=00000000
Internal error: Oops: 5 [#1] PREEMPT SMP ARM
(max8997\_haptic\_probe) from [] (platform\_drv\_probe+0x4c/0xb0)
(platform\_drv\_probe) from [] (driver\_probe\_device+0x214/0x2c0)
(driver\_probe\_device) from [] (\_\_driver\_attach+0xac/0xb0)
(\_\_driver\_attach) from [] (bus\_for\_each\_dev+0x68/0x9c)
(bus\_for\_each\_dev) from [] (bus\_add\_driver+0x1a0/0x218)
(bus\_add\_driver) from [] (driver\_register+0x78/0xf8)
(driver\_register) from [] (do\_one\_initcall+0x90/0x1d8)
(do\_one\_initcall) from [] (kernel\_init\_freeable+0x15c/0x1fc)
(kernel\_init\_freeable) from [] (kernel\_init+0x8/0x114)
(kernel\_init) from [] (ret\_from\_fork+0x14/0x3c)
Signed-off-by: Marek Szyprowski
Fixes: 104594b01ce7 ("Input: add driver support for MAX8997-haptic")
[k.kozlowski: Write commit message, add CC-stable]
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit f18783e6ab935c8884e24c43d6e5d5c417e06923
Author: Al Viro
Date: Thu May 5 16:25:35 2016 -0400
get\_rock\_ridge\_filename(): handle malformed NM entries
commit 99d825822eade8d827a1817357cbf3f889a552d6 upstream.
Payloads of NM entries are not supposed to contain NUL. When we run
into such, only the part prior to the first NUL goes into the
concatenation (i.e. the directory entry name being encoded by a bunch
of NM entries). We do stop when the amount collected so far + the
claimed amount in the current NM entry exceed 254. So far, so good,
but what we return as the total length is the sum of \*claimed\*
sizes, not the actual amount collected. And that can grow pretty
large - not unlimited, since you'd need to put CE entries in
between to be able to get more than the maximum that could be
contained in one isofs directory entry / continuation chunk and
we are stop once we'd encountered 32 CEs, but you can get about 8Kb
easily. And that's what will be passed to readdir callback as the
name length. 8Kb \_\_copy\_to\_user() from a buffer allocated by
\_\_get\_free\_page()
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 9bd227fabce8cc260697ec1907342ae92473df06
Author: Steven Rostedt
Date: Wed May 11 15:09:36 2016 -0400
tools lib traceevent: Do not reassign parg after collapse\_tree()
commit 106b816cb46ebd87408b4ed99a2e16203114daa6 upstream.
At the end of process\_filter(), collapse\_tree() was changed to update
the parg parameter, but the reassignment after the call wasn't removed.
What happens is that the "current\_op" gets modified and freed and parg
is assigned to the new allocated argument. But after the call to
collapse\_tree(), parg is assigned again to the just freed "current\_op",
and this causes the tool to crash.
The current\_op variable must also be assigned to NULL in case of error,
otherwise it will cause it to be free()ed twice.
Signed-off-by: Steven Rostedt
Acked-by: Namhyung Kim
Fixes: 42d6194d133c ("tools lib traceevent: Refactor process\_filter()")
Link: http://lkml.kernel.org/r/20160511150936.678c18a1@gandalf.local.home
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit c9458953f34fc199b01d6d93848b3722c8bba04e
Author: Johannes Thumshirn
Date: Wed Apr 27 10:48:52 2016 +0200
qla1280: Don't allocate 512kb of host tags
commit 2bcbc81421c511ef117cadcf0bee9c4340e68db0 upstream.
The qla1280 driver sets the scsi\_host\_template's can\_queue field to 0xfffff
which results in an allocation failure when allocating the block layer tags
for the driver's queues. This was introduced with the change for host wide
tags in commit 64d513ac31b - "scsi: use host wide tags by default".
Reduce can\_queue to MAX\_OUTSTANDING\_COMMANDS (512) to solve the allocation
error.
Signed-off-by: Johannes Thumshirn
Fixes: 64d513ac31b - "scsi: use host wide tags by default"
Cc: Laura Abbott
Cc: Michael Reed
Reviewed-by: Laurence Oberman
Reviewed-by: Lee Duncan
Signed-off-by: Martin K. Petersen
Signed-off-by: James Bottomley
Signed-off-by: Greg Kroah-Hartman
commit aa9c7ecf1b628f4e5a7eaf6adbe6f96c74e73570
Author: Al Viro
Date: Wed Apr 27 01:11:55 2016 -0400
atomic\_open(): fix the handling of create\_error
commit 10c64cea04d3c75c306b3f990586ffb343b63287 upstream.
\* if we have a hashed negative dentry and either CREAT|EXCL on
r/o filesystem, or CREAT|TRUNC on r/o filesystem, or CREAT|EXCL
with failing may\_o\_create(), we should fail with EROFS or the
error may\_o\_create() has returned, but not ENOENT. Which is what
the current code ends up returning.
\* if we have CREAT|TRUNC hitting a regular file on a read-only
filesystem, we can't fail with EROFS here. At the very least,
not until we'd done follow\_managed() - we might have a writable
file (or a device, for that matter) bound on top of that one.
Moreover, the code downstream will see that O\_TRUNC and attempt
to grab the write access (\*after\* following possible mount), so
if we really should fail with EROFS, it will happen. No need
to do that inside atomic\_open().
The real logics is much simpler than what the current code is
trying to do - if we decided to go for simple lookup, ended
up with a negative dentry \*and\* had create\_error set, fail with
create\_error. No matter whether we'd got that negative dentry
from lookup\_real() or had found it in dcache.
Acked-by: Miklos Szeredi
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit c8ace74a3e8801af9ac120698c098f41d6453de8
Author: Hans de Goede
Date: Wed Apr 27 15:59:27 2016 +0200
regulator: axp20x: Fix axp22x ldo\_io voltage ranges
commit a2262e5a12e05389ab4c7fc5cf60016b041dd8dc upstream.
The minium voltage of 1800mV is a copy and paste error from the axp20x
regulator info. The correct minimum voltage for the ldo\_io regulators
on the axp22x is 700mV.
Fixes: 1b82b4e4f954 ("regulator: axp20x: Add support for AXP22X regulators")
Signed-off-by: Hans de Goede
Acked-by: Chen-Yu Tsai
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit f64ce5854222226ef9cabb41ed255e070cbc8528
Author: Krzysztof Kozlowski
Date: Mon Mar 28 13:09:56 2016 +0900
regulator: s2mps11: Fix invalid selector mask and voltages for buck9
commit 3b672623079bb3e5685b8549e514f2dfaa564406 upstream.
The buck9 regulator of S2MPS11 PMIC had incorrect vsel\_mask (0xff
instead of 0x1f) thus reading entire register as buck9's voltage. This
effectively caused regulator core to interpret values as higher voltages
than they were and then to set real voltage much lower than intended.
The buck9 provides power to other regulators, including LDO13
and LDO19 which supply the MMC2 (SD card). On Odroid XU3/XU4 the lower
voltage caused SD card detection errors on Odroid XU3/XU4:
mmc1: card never left busy state
mmc1: error -110 whilst initialising SD card
During driver probe the regulator core was checking whether initial
voltage matches the constraints. With incorrect vsel\_mask of 0xff and
default value of 0x50, the core interpreted this as 5 V which is outside
of constraints (3-3.775 V). Then the regulator core was adjusting the
voltage to match the constraints. With incorrect vsel\_mask this new
voltage mapped to a vere low voltage in the driver.
Signed-off-by: Krzysztof Kozlowski
Reviewed-by: Javier Martinez Canillas
Tested-by: Javier Martinez Canillas
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 911cf4b94f7b068f92eab0b02f620a44ad6e405d
Author: Wanpeng Li
Date: Wed May 11 17:55:18 2016 +0800
workqueue: fix rebind bound workers warning
commit f7c17d26f43d5cc1b7a6b896cd2fa24a079739b9 upstream.
------------[ cut here ]------------
WARNING: CPU: 0 PID: 16 at kernel/workqueue.c:4559 rebind\_workers+0x1c0/0x1d0
Modules linked in:
CPU: 0 PID: 16 Comm: cpuhp/0 Not tainted 4.6.0-rc4+ #31
Hardware name: IBM IBM System x3550 M4 Server -[7914IUW]-/00Y8603, BIOS -[D7E128FUS-1.40]- 07/23/2013
0000000000000000 ffff881037babb58 ffffffff8139d885 0000000000000010
0000000000000000 0000000000000000 0000000000000000 ffff881037babba8
ffffffff8108505d ffff881037ba0000 000011cf3e7d6e60 0000000000000046
Call Trace:
dump\_stack+0x89/0xd4
\_\_warn+0xfd/0x120
warn\_slowpath\_null+0x1d/0x20
rebind\_workers+0x1c0/0x1d0
workqueue\_cpu\_up\_callback+0xf5/0x1d0
notifier\_call\_chain+0x64/0x90
? trace\_hardirqs\_on\_caller+0xf2/0x220
? notify\_prepare+0x80/0x80
\_\_raw\_notifier\_call\_chain+0xe/0x10
\_\_cpu\_notify+0x35/0x50
notify\_down\_prepare+0x5e/0x80
? notify\_prepare+0x80/0x80
cpuhp\_invoke\_callback+0x73/0x330
? \_\_schedule+0x33e/0x8a0
cpuhp\_down\_callbacks+0x51/0xc0
cpuhp\_thread\_fun+0xc1/0xf0
smpboot\_thread\_fn+0x159/0x2a0
? smpboot\_create\_threads+0x80/0x80
kthread+0xef/0x110
? wait\_for\_completion+0xf0/0x120
? schedule\_tail+0x35/0xf0
ret\_from\_fork+0x22/0x50
? \_\_init\_kthread\_worker+0x70/0x70
---[ end trace eb12ae47d2382d8f ]---
notify\_down\_prepare: attempt to take down CPU 0 failed
This bug can be reproduced by below config w/ nohz\_full= all cpus:
CONFIG\_BOOTPARAM\_HOTPLUG\_CPU0=y
CONFIG\_DEBUG\_HOTPLUG\_CPU0=y
CONFIG\_NO\_HZ\_FULL=y
As Thomas pointed out:
| If a down prepare callback fails, then DOWN\_FAILED is invoked for all
| callbacks which have successfully executed DOWN\_PREPARE.
|
| But, workqueue has actually two notifiers. One which handles
| UP/DOWN\_FAILED/ONLINE and one which handles DOWN\_PREPARE.
|
| Now look at the priorities of those callbacks:
|
| CPU\_PRI\_WORKQUEUE\_UP = 5
| CPU\_PRI\_WORKQUEUE\_DOWN = -5
|
| So the call order on DOWN\_PREPARE is:
|
| CB 1
| CB ...
| CB workqueue\_up() -> Ignores DOWN\_PREPARE
| CB ...
| CB X ---> Fails
|
| So we call up to CB X with DOWN\_FAILED
|
| CB 1
| CB ...
| CB workqueue\_up() -> Handles DOWN\_FAILED
| CB ...
| CB X-1
|
| So the problem is that the workqueue stuff handles DOWN\_FAILED in the up
| callback, while it should do it in the down callback. Which is not a good idea
| either because it wants to be called early on rollback...
|
| Brilliant stuff, isn't it? The hotplug rework will solve this problem because
| the callbacks become symetric, but for the existing mess, we need some
| workaround in the workqueue code.
The boot CPU handles housekeeping duty(unbound timers, workqueues,
timekeeping, ...) on behalf of full dynticks CPUs. It must remain
online when nohz full is enabled. There is a priority set to every
notifier\_blocks:
workqueue\_cpu\_up > tick\_nohz\_cpu\_down > workqueue\_cpu\_down
So tick\_nohz\_cpu\_down callback failed when down prepare cpu 0, and
notifier\_blocks behind tick\_nohz\_cpu\_down will not be called any
more, which leads to workers are actually not unbound. Then hotplug
state machine will fallback to undo and online cpu 0 again. Workers
will be rebound unconditionally even if they are not unbound and
trigger the warning in this progress.
This patch fix it by catching !DISASSOCIATED to avoid rebind bound
workers.
Cc: Tejun Heo
Cc: Lai Jiangshan
Cc: Thomas Gleixner
Cc: Peter Zijlstra
Cc: Frédéric Weisbecker
Suggested-by: Lai Jiangshan
Signed-off-by: Wanpeng Li
Signed-off-by: Greg Kroah-Hartman
commit bef800fb18cba0052314ef90c3f278db500e5490
Author: Boris Brezillon
Date: Wed May 11 11:00:02 2016 +0200
ARM: dts: at91: sam9x5: Fix the memory range assigned to the PMC
commit aab0a4c83ceb344d2327194bf354820e50607af6 upstream.
The memory range assigned to the PMC (Power Management Controller) was
not including the PMC\_PCR register which are used to control peripheral
clocks.
This was working fine thanks to the page granularity of ioremap(), but
started to fail when we switched to syscon/regmap, because regmap is
making sure that all accesses are falling into the reserved range.
Signed-off-by: Boris Brezillon
Reported-by: Richard Genoud
Tested-by: Richard Genoud
Fixes: 863a81c3be1d ("clk: at91: make use of syscon to share PMC registers in several drivers")
Signed-off-by: Nicolas Ferre
Signed-off-by: Greg Kroah-Hartman
commit 1c1c3e93daeec9989e50614e99697903d32942ed
Author: Miklos Szeredi
Date: Wed May 11 01:16:37 2016 +0200
vfs: rename: check backing inode being equal
commit 9409e22acdfc9153f88d9b1ed2bd2a5b34d2d3ca upstream.
If a file is renamed to a hardlink of itself POSIX specifies that rename(2)
should do nothing and return success.
This condition is checked in vfs\_rename(). However it won't detect hard
links on overlayfs where these are given separate inodes on the overlayfs
layer.
Overlayfs itself detects this condition and returns success without doing
anything, but then vfs\_rename() will proceed as if this was a successful
rename (detach\_mounts(), d\_move()).
The correct thing to do is to detect this condition before even calling
into overlayfs. This patch does this by calling vfs\_select\_inode() to get
the underlying inodes.
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit ad56dcb2447522f6a165cb9bccff379e96acca8d
Author: Miklos Szeredi
Date: Wed May 11 01:16:37 2016 +0200
vfs: add vfs\_select\_inode() helper
commit 54d5ca871e72f2bb172ec9323497f01cd5091ec7 upstream.
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit b45e5d3d1a4f0e443fea0e91dc5a5ae1fe217734
Author: Alexander Shishkin
Date: Tue May 10 16:18:33 2016 +0300
perf/core: Disable the event on a truncated AUX record
commit 9f448cd3cbcec8995935e60b27802ae56aac8cc0 upstream.
When the PMU driver reports a truncated AUX record, it effectively means
that there is no more usable room in the event's AUX buffer (even though
there may still be some room, so that perf\_aux\_output\_begin() doesn't take
action). At this point the consumer still has to be woken up and the event
has to be disabled, otherwise the event will just keep spinning between
perf\_aux\_output\_begin() and perf\_aux\_output\_end() until its context gets
unscheduled.
Again, for cpu-wide events this means never, so once in this condition,
they will be forever losing data.
Fix this by disabling the event and waking up the consumer in case of a
truncated AUX record.
Reported-by: Markus Metzger
Signed-off-by: Alexander Shishkin
Signed-off-by: Peter Zijlstra (Intel)
Cc: Arnaldo Carvalho de Melo
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Cc: vince@deater.net
Link: http://lkml.kernel.org/r/1462886313-13660-3-git-send-email-alexander.shishkin@linux.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit b1a9793aac18fb5df398e9e2c48e4d5b89dbfca0
Author: Namhyung Kim
Date: Tue May 10 11:26:24 2016 -0300
perf diff: Fix duplicated output column
commit e9d848cb65d5f6f7731d12bd1b6d994bfdbcc94f upstream.
The commit b97511c5bc94 ("perf tools: Add overhead/overhead\_children
keys defaults via string") moved initialization of column headers but it
missed to check the sort\_\_mode. As 'perf diff' doesn't call
perf\_hpp\_\_init(), the setup\_overhead() also should not be called.
Before:
# Baseline Delta Children Overhead Shared Object Symbol
# ........ ....... ........ ........ ................... .......................
#
28.48% -28.47% 28.48% 28.48% [kernel.vmlinux ] [k] intel\_idle
11.51% -11.47% 11.51% 11.51% libxul.so [.] 0x0000000001a360f7
3.49% -3.49% 3.49% 3.49% [kernel.vmlinux] [k] generic\_exec\_single
2.91% -2.89% 2.91% 2.91% libdbus-1.so.3.8.11 [.] 0x000000000000cdc2
2.86% -2.85% 2.86% 2.86% libxcb.so.1.1.0 [.] 0x000000000000c890
2.44% -2.39% 2.44% 2.44% [kernel.vmlinux] [k] perf\_event\_aux\_ctx
After:
# Baseline Delta Shared Object Symbol
# ........ ....... ................... .......................
#
28.48% -28.47% [kernel.vmlinux] [k] intel\_idle
11.51% -11.47% libxul.so [.] 0x0000000001a360f7
3.49% -3.49% [kernel.vmlinux] [k] generic\_exec\_single
2.91% -2.89% libdbus-1.so.3.8.11 [.] 0x000000000000cdc2
2.86% -2.85% libxcb.so.1.1.0 [.] 0x000000000000c890
2.44% -2.39% [kernel.vmlinux] [k] perf\_event\_aux\_ctx
Signed-off-by: Namhyung Kim
Signed-off-by: Arnaldo Carvalho de Melo
Acked-by: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Fixes: b97511c5bc94 ("perf tools: Add overhead/overhead\_children keys defaults via string")
Link: http://lkml.kernel.org/r/1462890384-12486-2-git-send-email-acme@kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit d764263450e64f2dddb07afda47c54238fdc491d
Author: Jack Pham
Date: Thu Apr 14 23:37:26 2016 -0700
regmap: spmi: Fix regmap\_spmi\_ext\_read in multi-byte case
commit dec8e8f6e6504aa3496c0f7cc10c756bb0e10f44 upstream.
Specifically for the case of reads that use the Extended Register
Read Long command, a multi-byte read operation is broken up into
8-byte chunks. However the call to spmi\_ext\_register\_readl() is
incorrectly passing 'val\_size', which if greater than 8 will
always fail. The argument should instead be 'len'.
Fixes: c9afbb05a9ff ("regmap: spmi: support base and extended register spaces")
Signed-off-by: Jack Pham
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 7ac50df1487deaa39b2b19d7c205fe49d2ef132b
Author: Ludovic Desroches
Date: Tue Apr 19 16:03:45 2016 +0200
pinctrl: at91-pio4: fix pull-up/down logic
commit 5305a7b7e860bb40ab226bc7d58019416073948a upstream.
The default configuration of a pin is often with a value in the
pull-up/down field at chip reset. So, even if the internal logic of the
controller prevents writing a configuration with pull-up and pull-down at
the same time, we must ensure explicitly this condition before writing the
register.
This was leading to a pull-down condition not taken into account for
instance.
Signed-off-by: Ludovic Desroches
Fixes: 776180848b57 ("pinctrl: introduce driver for Atmel PIO4 controller")
Acked-by: Alexandre Belloni
Acked-by: Nicolas Ferre
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit ffcd833fdd15a5d8c420dc2dfdae694ef034813e
Author: Ben Hutchings
Date: Tue Apr 12 12:58:14 2016 +0100
spi: spi-ti-qspi: Handle truncated frames properly
commit 1ff7760ff66b98ef244bf0e5e2bd5310651205ad upstream.
We clamp frame\_len\_words to a maximum of 4096, but do not actually
limit the number of words written or read through the DATA registers
or the length added to spi\_message::actual\_length. This results in
silent data corruption for commands longer than this maximum.
Recalculate the length of each transfer, taking frame\_len\_words into
account. Use this length in qspi\_{read,write}\_msg(), and to increment
spi\_message::actual\_length.
Signed-off-by: Ben Hutchings
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 81a9d92dbfa2d56a68dd128e3bafcca6a54b8e7e
Author: Ben Hutchings
Date: Tue Apr 12 12:56:25 2016 +0100
spi: spi-ti-qspi: Fix FLEN and WLEN settings if bits\_per\_word is overridden
commit ea1b60fb085839a9544cb3a0069992991beabb7f upstream.
Each transfer can specify 8, 16 or 32 bits per word independently of
the default for the device being addressed. However, currently we
calculate the number of words in the frame assuming that the word size
is the device default.
If multiple transfers in the same message have differing
bits\_per\_word, we bitwise-or the different values in the WLEN register
field.
Fix both of these. Also rename 'frame\_length' to 'frame\_len\_words' to
make clear that it's not a byte count like spi\_message::frame\_length.
Signed-off-by: Ben Hutchings
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit a0703bba986a25dcc0af82dbd189440905dc6aa4
Author: Jarkko Nikula
Date: Tue Apr 26 10:08:26 2016 +0300
spi: pxa2xx: Do not detect number of enabled chip selects on Intel SPT
commit 66ec246eb9982e7eb8e15e1fc55f543230310dd0 upstream.
Certain Intel Sunrisepoint PCH variants report zero chip selects in SPI
capabilities register even they have one per port. Detection in
pxa2xx\_spi\_probe() sets master->num\_chipselect to 0 leading to -EINVAL
from spi\_register\_master() where chip select count is validated.
Fix this by not using SPI capabilities register on Sunrisepoint. They don't
have more than one chip select so use the default value 1 instead of
detection.
Fixes: 8b136baa5892 ("spi: pxa2xx: Detect number of enabled Intel LPSS SPI chip select signals")
Signed-off-by: Jarkko Nikula
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 8d5b1e9a9d19230c4c7c851a2793920cfd1c8ec7
Author: Takashi Iwai
Date: Tue May 10 10:24:02 2016 +0200
ALSA: hda - Fix broken reconfig
commit addacd801e1638f41d659cb53b9b73fc14322cb1 upstream.
The HD-audio reconfig function got broken in the recent kernels,
typically resulting in a failure like:
snd\_hda\_intel 0000:00:1b.0: control 3:0:0:Playback Channel Map:0 is already present
This is because of the code restructuring to move the PCM and control
instantiation into the codec drive probe, by the commit [bcd96557bd0a:
ALSA: hda - Build PCMs and controls at codec driver probe]. Although
the commit above removed the calls of snd\_hda\_codec\_build\_pcms() and
\*\_build\_controls() at the controller driver probe, the similar calls
in the reconfig were still left forgotten. This caused the
conflicting and duplicated PCMs and controls.
The fix is trivial: just remove these superfluous calls from
reconfig\_codec().
Fixes: bcd96557bd0a ('ALSA: hda - Build PCMs and controls at codec driver probe')
Reported-by: Jochen Henneberg
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 227dfa13aaca85a3b236f02eb203ed5f00f07189
Author: Kaho Ng
Date: Mon May 9 00:27:49 2016 +0800
ALSA: hda - Fix white noise on Asus UX501VW headset
commit 2da2dc9ead232f25601404335cca13c0f722d41b upstream.
For reducing the noise from the headset output on ASUS UX501VW,
call the existing fixup, alc\_fixup\_headset\_mode\_alc668(), additionally.
Thread: https://bbs.archlinux.org/viewtopic.php?id=209554
Signed-off-by: Kaho Ng
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit f36adc590eb3e9a4fd6c61a1cb9f6b273dd58138
Author: Yura Pakhuchiy
Date: Sat May 7 23:53:36 2016 +0700
ALSA: hda - Fix subwoofer pin on ASUS N751 and N551
commit 3231e2053eaeee70bdfb216a78a30f11e88e2243 upstream.
Subwoofer does not work out of the box on ASUS N751/N551 laptops. This
patch fixes it. Patch tested on N751 laptop. N551 part is not tested,
but according to [1] and [2] this laptop requires similar changes, so I
included them in the patch.
1. https://github.com/honsiorovskyi/asus-n551-hda-fix
2. https://bugs.launchpad.net/ubuntu/+source/alsa-tools/+bug/1405691
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=117781
Signed-off-by: Yura Pakhuchiy
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b2cd322d3db7c2181ebe310a8e8f6e5eb3071293
Author: Takashi Iwai
Date: Wed May 11 17:48:00 2016 +0200
ALSA: usb-audio: Yet another Phoneix Audio device quirk
commit 84add303ef950b8d85f54bc2248c2bc73467c329 upstream.
Phoenix Audio has yet another device with another id (even a different
vendor id, 0556:0014) that requires the same quirk for the sample
rate.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=110221
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 1024e85d016617e8f69515d190af127a46be10f1
Author: Takashi Iwai
Date: Fri Apr 29 11:20:15 2016 +0200
ALSA: usb-audio: Quirk for yet another Phoenix Audio devices (v2)
commit 2d2c038a9999f423e820d89db2b5d7774b67ba49 upstream.
Phoenix Audio MT202pcs (1de7:0114) and MT202exe (1de7:0013) need the
same workaround as TMX320 for avoiding the firmware bug. It fixes the
frequent error about the sample rate inquiries and the slow device
probe as consequence.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=117321
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 04706e53238a1b4b5bc07cac93265ca2a0992cb8
Author: Herbert Xu
Date: Thu May 5 16:42:49 2016 +0800
crypto: testmgr - Use kmalloc memory for RSA input
commit df27b26f04ed388ff4cc2b5d8cfdb5d97678816f upstream.
As akcipher uses an SG interface, you must not use vmalloc memory
as input for it. This patch fixes testmgr to copy the vmalloc
test vectors to kmalloc memory before running the test.
This patch also removes a superfluous sg\_virt call in do\_test\_rsa.
Reported-by: Anatoly Pugachev
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit afd96c1fffcd9040b446213a604d43b24734d0ad
Author: Herbert Xu
Date: Wed May 4 17:52:56 2016 +0800
crypto: hash - Fix page length clamping in hash walk
commit 13f4bb78cf6a312bbdec367ba3da044b09bf0e29 upstream.
The crypto hash walk code is broken when supplied with an offset
greater than or equal to PAGE\_SIZE. This patch fixes it by adjusting
walk->pg and walk->offset when this happens.
Reported-by: Steffen Klassert
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 0ea84f612750521608c690615813f846b13706d6
Author: Tadeusz Struk
Date: Fri Apr 29 10:43:40 2016 -0700
crypto: qat - fix adf\_ctl\_drv.c:undefined reference to adf\_init\_pf\_wq
commit 6dc5df71ee5c8b44607928bfe27be50314dcf848 upstream.
Fix undefined reference issue reported by kbuild test robot.
Reported-by: kbuild test robot
Signed-off-by: Tadeusz Struk
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 2b30856211abd0a02bc2fc336a7c06ba279d107b
Author: Tadeusz Struk
Date: Mon Apr 25 07:32:19 2016 -0700
crypto: qat - fix invalid pf2vf\_resp\_wq logic
commit 9e209fcfb804da262e38e5cd2e680c47a41f0f95 upstream.
The pf2vf\_resp\_wq is a global so it has to be created at init
and destroyed at exit, instead of per device.
Tested-by: Suresh Marikkannu
Signed-off-by: Tadeusz Struk
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit f1b9cba08781033c7641e54d1589b3d43d51d443
Author: Andrea Arcangeli
Date: Thu May 12 15:42:25 2016 -0700
mm: thp: calculate the mapcount correctly for THP pages during WP faults
commit 6d0a07edd17cfc12fdc1f36de8072fa17cc3666f upstream.
This will provide fully accuracy to the mapcount calculation in the
write protect faults, so page pinning will not get broken by false
positive copy-on-writes.
total\_mapcount() isn't the right calculation needed in
reuse\_swap\_page(), so this introduces a page\_trans\_huge\_mapcount()
that is effectively the full accurate return value for page\_mapcount()
if dealing with Transparent Hugepages, however we only use the
page\_trans\_huge\_mapcount() during COW faults where it strictly needed,
due to its higher runtime cost.
This also provide at practical zero cost the total\_mapcount
information which is needed to know if we can still relocate the page
anon\_vma to the local vma. If page\_trans\_huge\_mapcount() returns 1 we
can reuse the page no matter if it's a pte or a pmd\_trans\_huge
triggering the fault, but we can only relocate the page anon\_vma to
the local vma->anon\_vma if we're sure it's only this "vma" mapping the
whole THP physical range.
Kirill A. Shutemov discovered the problem with moving the page
anon\_vma to the local vma->anon\_vma in a previous version of this
patch and another problem in the way page\_move\_anon\_rmap() was called.
Andrew Morton discovered that CONFIG\_SWAP=n wouldn't build in a
previous version, because reuse\_swap\_page must be a macro to call
page\_trans\_huge\_mapcount from swap.h, so this uses a macro again
instead of an inline function. With this change at least it's a less
dangerous usage than it was before, because "page" is used only once
now, while with the previous code reuse\_swap\_page(page++) would have
called page\_mapcount on page+1 and it would have increased page twice
instead of just once.
Dean Luick noticed an uninitialized variable that could result in a
rmap inefficiency for the non-THP case in a previous version.
Mike Marciniszyn said:
: Our RDMA tests are seeing an issue with memory locking that bisects to
: commit 61f5d698cc97 ("mm: re-enable THP")
:
: The test program registers two rather large MRs (512M) and RDMA
: writes data to a passive peer using the first and RDMA reads it back
: into the second MR and compares that data. The sizes are chosen randomly
: between 0 and 1024 bytes.
:
: The test will get through a few (<= 4 iterations) and then gets a
: compare error.
:
: Tracing indicates the kernel logical addresses associated with the individual
: pages at registration ARE correct , the data in the "RDMA read response only"
: packets ARE correct.
:
: The "corruption" occurs when the packet crosse two pages that are not physically
: contiguous. The second page reads back as zero in the program.
:
: It looks like the user VA at the point of the compare error no longer points to
: the same physical address as was registered.
:
: This patch totally resolves the issue!
Link: http://lkml.kernel.org/r/1462547040-1737-2-git-send-email-aarcange@redhat.com
Signed-off-by: Andrea Arcangeli
Reviewed-by: "Kirill A. Shutemov"
Reviewed-by: Dean Luick
Tested-by: Alex Williamson
Tested-by: Mike Marciniszyn
Tested-by: Josh Collier
Cc: Marc Haber
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 19654c855d606ffb3e9e6c9d8d0a093e1cd4adae
Author: Sergey Senozhatsky
Date: Mon May 9 16:28:49 2016 -0700
zsmalloc: fix zs\_can\_compact() integer overflow
commit 44f43e99fe70833058482d183e99fdfd11220996 upstream.
zs\_can\_compact() has two race conditions in its core calculation:
unsigned long obj\_wasted = zs\_stat\_get(class, OBJ\_ALLOCATED) -
zs\_stat\_get(class, OBJ\_USED);
1) classes are not locked, so the numbers of allocated and used
objects can change by the concurrent ops happening on other CPUs
2) shrinker invokes it from preemptible context
Depending on the circumstances, thus, OBJ\_ALLOCATED can become
less than OBJ\_USED, which can result in either very high or
negative `total\_scan' value calculated later in do\_shrink\_slab().
do\_shrink\_slab() has some logic to prevent those cases:
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-62
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-62
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-64
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-62
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-62
vmscan: shrink\_slab: zs\_shrinker\_scan+0x0/0x28 [zsmalloc] negative objects to delete nr=-62
However, due to the way `total\_scan' is calculated, not every
shrinker->count\_objects() overflow can be spotted and handled.
To demonstrate the latter, I added some debugging code to do\_shrink\_slab()
(x86\_64) and the results were:
vmscan: OVERFLOW: shrinker->count\_objects() == -1 [18446744073709551615]
vmscan: but total\_scan > 0: 92679974445502
vmscan: resulting total\_scan: 92679974445502
[..]
vmscan: OVERFLOW: shrinker->count\_objects() == -1 [18446744073709551615]
vmscan: but total\_scan > 0: 22634041808232578
vmscan: resulting total\_scan: 22634041808232578
Even though shrinker->count\_objects() has returned an overflowed value,
the resulting `total\_scan' is positive, and, what is more worrisome, it
is insanely huge. This value is getting used later on in
shrinker->scan\_objects() loop:
while (total\_scan >= batch\_size ||
total\_scan >= freeable) {
unsigned long ret;
unsigned long nr\_to\_scan = min(batch\_size, total\_scan);
shrinkctl->nr\_to\_scan = nr\_to\_scan;
ret = shrinker->scan\_objects(shrinker, shrinkctl);
if (ret == SHRINK\_STOP)
break;
freed += ret;
count\_vm\_events(SLABS\_SCANNED, nr\_to\_scan);
total\_scan -= nr\_to\_scan;
cond\_resched();
}
`total\_scan >= batch\_size' is true for a very-very long time and
'total\_scan >= freeable' is also true for quite some time, because
`freeable < 0' and `total\_scan' is large enough, for example,
22634041808232578. The only break condition, in the given scheme of
things, is shrinker->scan\_objects() == SHRINK\_STOP test, which is a
bit too weak to rely on, especially in heavy zsmalloc-usage scenarios.
To fix the issue, take a pool stat snapshot and use it instead of
racy zs\_stat\_get() calls.
Link: http://lkml.kernel.org/r/20160509140052.3389-1-sergey.senozhatsky@gmail.com
Signed-off-by: Sergey Senozhatsky
Cc: Minchan Kim
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 23d3f15feaaba0cc20ac549f3aae796c95120326
Author: Junxiao Bi
Date: Thu May 12 15:42:18 2016 -0700
ocfs2: fix posix\_acl\_create deadlock
commit c25a1e0671fbca7b2c0d0757d533bd2650d6dc0c upstream.
Commit 702e5bc68ad2 ("ocfs2: use generic posix ACL infrastructure")
refactored code to use posix\_acl\_create. The problem with this function
is that it is not mindful of the cluster wide inode lock making it
unsuitable for use with ocfs2 inode creation with ACLs. For example,
when used in ocfs2\_mknod, this function can cause deadlock as follows.
The parent dir inode lock is taken when calling posix\_acl\_create ->
get\_acl -> ocfs2\_iop\_get\_acl which takes the inode lock again. This can
cause deadlock if there is a blocked remote lock request waiting for the
lock to be downconverted. And same deadlock happened in ocfs2\_reflink.
This fix is to revert back using ocfs2\_init\_acl.
Fixes: 702e5bc68ad2 ("ocfs2: use generic posix ACL infrastructure")
Signed-off-by: Tariq Saeed
Signed-off-by: Junxiao Bi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Joseph Qi
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 0c4998e34bdd567bca20f857015c595839457a2e
Author: Junxiao Bi
Date: Thu May 12 15:42:15 2016 -0700
ocfs2: revert using ocfs2\_acl\_chmod to avoid inode cluster lock hang
commit 5ee0fbd50fdf1c1329de8bee35ea9d7c6a81a2e0 upstream.
Commit 743b5f1434f5 ("ocfs2: take inode lock in ocfs2\_iop\_set/get\_acl()")
introduced this issue. ocfs2\_setattr called by chmod command holds
cluster wide inode lock when calling posix\_acl\_chmod. This latter
function in turn calls ocfs2\_iop\_get\_acl and ocfs2\_iop\_set\_acl. These
two are also called directly from vfs layer for getfacl/setfacl commands
and therefore acquire the cluster wide inode lock. If a remote
conversion request comes after the first inode lock in ocfs2\_setattr,
OCFS2\_LOCK\_BLOCKED will be set. And this will cause the second call to
inode lock from the ocfs2\_iop\_get\_acl() to block indefinetly.
The deleted version of ocfs2\_acl\_chmod() calls \_\_posix\_acl\_chmod() which
does not call back into the filesystem. Therefore, we restore
ocfs2\_acl\_chmod(), modify it slightly for locking as needed, and use that
instead.
Fixes: 743b5f1434f5 ("ocfs2: take inode lock in ocfs2\_iop\_set/get\_acl()")
Signed-off-by: Tariq Saeed
Signed-off-by: Junxiao Bi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Joseph Qi
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8be13acc8709f013813da8ae36c6f0e538cbcc0f
Author: Paolo Abeni
Date: Fri May 13 18:33:41 2016 +0200
net/route: enforce hoplimit max value
[ Upstream commit 626abd59e51d4d8c6367e03aae252a8aa759ac78 ]
Currently, when creating or updating a route, no check is performed
in both ipv4 and ipv6 code to the hoplimit value.
The caller can i.e. set hoplimit to 256, and when such route will
be used, packets will be sent with hoplimit/ttl equal to 0.
This commit adds checks for the RTAX\_HOPLIMIT value, in both ipv4
ipv6 route code, substituting any value greater than 255 with 255.
This is consistent with what is currently done for ADVMSS and MTU
in the ipv4 code.
Signed-off-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 057f85ef44965346eb3bd5e8978dd7297b386ee7
Author: Eric Dumazet
Date: Mon May 9 20:55:16 2016 -0700
tcp: refresh skb timestamp at retransmit time
[ Upstream commit 10a81980fc47e64ffac26a073139813d3f697b64 ]
In the very unlikely case \_\_tcp\_retransmit\_skb() can not use the cloning
done in tcp\_transmit\_skb(), we need to refresh skb\_mstamp before doing
the copy and transmit, otherwise TCP TS val will be an exact copy of
original transmit.
Fixes: 7faee5c0d514 ("tcp: remove TCP\_SKB\_CB(skb)->when")
Signed-off-by: Eric Dumazet
Cc: Yuchung Cheng
Acked-by: Yuchung Cheng
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 56633a532c9b3aa41ef8aca951d37ebdd5997a1a
Author: xypron.glpk@gmx.de
Date: Mon May 9 00:46:18 2016 +0200
net: thunderx: avoid exposing kernel stack
[ Upstream commit 161de2caf68c549c266e571ffba8e2163886fb10 ]
Reserved fields should be set to zero to avoid exposing
bits from the kernel stack.
Signed-off-by: Heinrich Schuchardt
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f7ee286fab0b55bf5908978c94e50d52e627b3ac
Author: Kangjie Lu
Date: Sun May 8 12:10:14 2016 -0400
net: fix a kernel infoleak in x25 module
[ Upstream commit 79e48650320e6fba48369fccf13fd045315b19b8 ]
Stack object "dte\_facilities" is allocated in x25\_rx\_call\_request(),
which is supposed to be initialized in x25\_negotiate\_facilities.
However, 5 fields (8 bytes in total) are not initialized. This
object is then copied to userland via copy\_to\_user, thus infoleak
occurs.
Signed-off-by: Kangjie Lu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 05b902a09b329bbe0b330332efe4c46ee0dbc83f
Author: Mikko Rapeli
Date: Sun Apr 24 17:45:00 2016 +0200
uapi glibc compat: fix compile errors when glibc net/if.h included before linux/if.h
[ Upstream commit 4a91cb61bb995e5571098188092e296192309c77 ]
glibc's net/if.h contains copies of definitions from linux/if.h and these
conflict and cause build failures if both files are included by application
source code. Changes in uapi headers, which fixed header file dependencies to
include linux/if.h when it was needed, e.g. commit 1ffad83d, made the
net/if.h and linux/if.h incompatibilities visible as build failures for
userspace applications like iproute2 and xtables-addons.
This patch fixes compile errors when glibc net/if.h is included before
linux/if.h:
./linux/if.h:99:21: error: redeclaration of enumerator ‘IFF\_NOARP’
./linux/if.h:98:23: error: redeclaration of enumerator ‘IFF\_RUNNING’
./linux/if.h:97:26: error: redeclaration of enumerator ‘IFF\_NOTRAILERS’
./linux/if.h:96:27: error: redeclaration of enumerator ‘IFF\_POINTOPOINT’
./linux/if.h:95:24: error: redeclaration of enumerator ‘IFF\_LOOPBACK’
./linux/if.h:94:21: error: redeclaration of enumerator ‘IFF\_DEBUG’
./linux/if.h:93:25: error: redeclaration of enumerator ‘IFF\_BROADCAST’
./linux/if.h:92:19: error: redeclaration of enumerator ‘IFF\_UP’
./linux/if.h:252:8: error: redefinition of ‘struct ifconf’
./linux/if.h:203:8: error: redefinition of ‘struct ifreq’
./linux/if.h:169:8: error: redefinition of ‘struct ifmap’
./linux/if.h:107:23: error: redeclaration of enumerator ‘IFF\_DYNAMIC’
./linux/if.h:106:25: error: redeclaration of enumerator ‘IFF\_AUTOMEDIA’
./linux/if.h:105:23: error: redeclaration of enumerator ‘IFF\_PORTSEL’
./linux/if.h:104:25: error: redeclaration of enumerator ‘IFF\_MULTICAST’
./linux/if.h:103:21: error: redeclaration of enumerator ‘IFF\_SLAVE’
./linux/if.h:102:22: error: redeclaration of enumerator ‘IFF\_MASTER’
./linux/if.h:101:24: error: redeclaration of enumerator ‘IFF\_ALLMULTI’
./linux/if.h:100:23: error: redeclaration of enumerator ‘IFF\_PROMISC’
The cases where linux/if.h is included before net/if.h need a similar fix in
the glibc side, or the order of include files can be changed userspace
code as a workaround.
This change was tested in x86 userspace on Debian unstable with
scripts/headers\_compile\_test.sh:
$ make headers\_install && \
cd usr/include && ../../scripts/headers\_compile\_test.sh -l -k
...
cc -Wall -c -nostdinc -I /usr/lib/gcc/i586-linux-gnu/5/include -I /usr/lib/gcc/i586-linux-gnu/5/include-fixed -I . -I /home/mcfrisk/src/linux-2.6/usr/headers\_compile\_test\_include.2uX2zH -I /home/mcfrisk/src/linux-2.6/usr/headers\_compile\_test\_include.2uX2zH/i586-linux-gnu -o /dev/null ./linux/if.h\_libc\_before\_kernel.h
PASSED libc before kernel test: ./linux/if.h
Reported-by: Jan Engelhardt
Reported-by: Josh Boyer
Reported-by: Stephen Hemminger
Reported-by: Waldemar Brodkorb
Cc: Gabriel Laskar
Signed-off-by: Mikko Rapeli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 14ece2e866a334f51e59a3d0344466e497e40086
Author: Linus Lüssing
Date: Wed May 4 17:25:02 2016 +0200
bridge: fix igmp / mld query parsing
[ Upstream commit 856ce5d083e14571d051301fe3c65b32b8cbe321 ]
With the newly introduced helper functions the skb pulling is hidden
in the checksumming function - and undone before returning to the
caller.
The IGMP and MLD query parsing functions in the bridge still
assumed that the skb is pointing to the beginning of the IGMP/MLD
message while it is now kept at the beginning of the IPv4/6 header.
If there is a querier somewhere else, then this either causes
the multicast snooping to stay disabled even though it could be
enabled. Or, if we have the querier enabled too, then this can
create unnecessary IGMP / MLD query messages on the link.
Fixing this by taking the offset between IP and IGMP/MLD header into
account, too.
Fixes: 9afd85c9e455 ("net: Export IGMP/MLD message validation code")
Reported-by: Simon Wunderlich
Signed-off-by: Linus Lüssing
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6542eb9ef70183c6a299782f52728ca99ee1d9ab
Author: Nikolay Aleksandrov
Date: Wed May 4 16:18:45 2016 +0200
net: bridge: fix old ioctl unlocked net device walk
[ Upstream commit 31ca0458a61a502adb7ed192bf9716c6d05791a5 ]
get\_bridge\_ifindices() is used from the old "deviceless" bridge ioctl
calls which aren't called with rtnl held. The comment above says that it is
called with rtnl but that is not really the case.
Here's a sample output from a test ASSERT\_RTNL() which I put in
get\_bridge\_ifindices and executed "brctl show":
[ 957.422726] RTNL: assertion failed at net/bridge//br\_ioctl.c (30)
[ 957.422925] CPU: 0 PID: 1862 Comm: brctl Tainted: G W O
4.6.0-rc4+ #157
[ 957.423009] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996),
BIOS 1.8.1-20150318\_183358- 04/01/2014
[ 957.423009] 0000000000000000 ffff880058adfdf0 ffffffff8138dec5
0000000000000400
[ 957.423009] ffffffff81ce8380 ffff880058adfe58 ffffffffa05ead32
0000000000000001
[ 957.423009] 00007ffec1a444b0 0000000000000400 ffff880053c19130
0000000000008940
[ 957.423009] Call Trace:
[ 957.423009] [] dump\_stack+0x85/0xc0
[ 957.423009] []
br\_ioctl\_deviceless\_stub+0x212/0x2e0 [bridge]
[ 957.423009] [] sock\_ioctl+0x22b/0x290
[ 957.423009] [] do\_vfs\_ioctl+0x95/0x700
[ 957.423009] [] SyS\_ioctl+0x79/0x90
[ 957.423009] [] entry\_SYSCALL\_64\_fastpath+0x23/0xc1
Since it only reads bridge ifindices, we can use rcu to safely walk the net
device list. Also remove the wrong rtnl comment above.
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit da6b6f3e3ba5980f00f1e24362802a4fe618a279
Author: Ian Campbell
Date: Wed May 4 14:21:53 2016 +0100
VSOCK: do not disconnect socket when peer has shutdown SEND only
[ Upstream commit dedc58e067d8c379a15a8a183c5db318201295bb ]
The peer may be expecting a reply having sent a request and then done a
shutdown(SHUT\_WR), so tearing down the whole socket at this point seems
wrong and breaks for me with a client which does a SHUT\_WR.
Looking at other socket family's stream\_recvmsg callbacks doing a shutdown
here does not seem to be the norm and removing it does not seem to have
had any adverse effects that I can see.
I'm using Stefan's RFC virtio transport patches, I'm unsure of the impact
on the vmci transport.
Signed-off-by: Ian Campbell
Cc: "David S. Miller"
Cc: Stefan Hajnoczi
Cc: Claudio Imbrenda
Cc: Andy King
Cc: Dmitry Torokhov
Cc: Jorgen Hansen
Cc: Adit Ranadive
Cc: netdev@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit eaf9dc35e458ce057d15137d5faf6147b1ac4504
Author: Daniel Jurgens
Date: Wed May 4 15:00:33 2016 +0300
net/mlx4\_en: Fix endianness bug in IPV6 csum calculation
[ Upstream commit 82d69203df634b4dfa765c94f60ce9482bcc44d6 ]
Use htons instead of unconditionally byte swapping nexthdr. On a little
endian systems shifting the byte is correct behavior, but it results in
incorrect csums on big endian architectures.
Fixes: f8c6455bb04b ('net/mlx4\_en: Extend checksum offloading by CHECKSUM COMPLETE')
Signed-off-by: Daniel Jurgens
Reviewed-by: Carol Soto
Tested-by: Carol Soto
Signed-off-by: Tariq Toukan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ff82293b226fd3bbfbd6d3fcbb0ffbbd55c85862
Author: Kangjie Lu
Date: Tue May 3 16:46:24 2016 -0400
net: fix infoleak in rtnetlink
[ Upstream commit 5f8e44741f9f216e33736ea4ec65ca9ac03036e6 ]
The stack object “map” has a total size of 32 bytes. Its last 4
bytes are padding generated by compiler. These padding bytes are
not initialized and sent out via “nla\_put”.
Signed-off-by: Kangjie Lu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 33d437ee77122c4889d1e9c7ff6488f04b9cf05e
Author: Kangjie Lu
Date: Tue May 3 16:35:05 2016 -0400
net: fix infoleak in llc
[ Upstream commit b8670c09f37bdf2847cc44f36511a53afc6161fd ]
The stack object “info” has a total size of 12 bytes. Its last byte
is padding which is not initialized and leaked via “put\_cmsg”.
Signed-off-by: Kangjie Lu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 926b7f45d2763578e2a7401f5ee90719be74059c
Author: Uwe Kleine-König
Date: Tue May 3 16:38:53 2016 +0200
net: fec: only clear a queue's work bit if the queue was emptied
[ Upstream commit 1c021bb717a70aaeaa4b25c91f43c2aeddd922de ]
In the receive path a queue's work bit was cleared unconditionally even
if fec\_enet\_rx\_queue only read out a part of the available packets from
the hardware. This resulted in not reading any packets in the next napi
turn and so packets were delayed or lost.
The obvious fix is to only clear a queue's bit when the queue was
emptied.
Fixes: 4d494cdc92b3 ("net: fec: change data structure to support multiqueue")
Signed-off-by: Uwe Kleine-König
Reviewed-by: Lucas Stach
Tested-by: Fugang Duan
Acked-by: Fugang Duan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 54aa3889c020e7857babc6c72e615d2bc32fc6fa
Author: Nicolas Dichtel
Date: Tue May 3 09:58:27 2016 +0200
ipv6/ila: fix nlsize calculation for lwtunnel
[ Upstream commit 79e8dc8b80bff0bc5bbb90ca5e73044bf207c8ac ]
The handler 'ila\_fill\_encap\_info' adds one attribute: ILA\_ATTR\_LOCATOR.
Fixes: 65d7ab8de582 ("net: Identifier Locator Addressing module")
CC: Tom Herbert
Signed-off-by: Nicolas Dichtel
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 97a77feecd4669e060cdc8d6f815c9929507d5c9
Author: Neil Horman
Date: Mon May 2 12:20:15 2016 -0400
netem: Segment GSO packets on enqueue
[ Upstream commit 6071bd1aa13ed9e41824bafad845b7b7f4df5cfd ]
This was recently reported to me, and reproduced on the latest net kernel,
when attempting to run netperf from a host that had a netem qdisc attached
to the egress interface:
[ 788.073771] ---------------------[ cut here ]---------------------------
[ 788.096716] WARNING: at net/core/dev.c:2253 skb\_warn\_bad\_offload+0xcd/0xda()
[ 788.129521] bnx2: caps=(0x00000001801949b3, 0x0000000000000000) len=2962
data\_len=0 gso\_size=1448 gso\_type=1 ip\_summed=3
[ 788.182150] Modules linked in: sch\_netem kvm\_amd kvm crc32\_pclmul ipmi\_ssif
ghash\_clmulni\_intel sp5100\_tco amd64\_edac\_mod aesni\_intel lrw gf128mul
glue\_helper ablk\_helper edac\_mce\_amd cryptd pcspkr sg edac\_core hpilo ipmi\_si
i2c\_piix4 k10temp fam15h\_power hpwdt ipmi\_msghandler shpchp acpi\_power\_meter
pcc\_cpufreq nfsd auth\_rpcgss nfs\_acl lockd grace sunrpc ip\_tables xfs libcrc32c
sd\_mod crc\_t10dif crct10dif\_generic mgag200 syscopyarea sysfillrect sysimgblt
i2c\_algo\_bit drm\_kms\_helper ahci ata\_generic pata\_acpi ttm libahci
crct10dif\_pclmul pata\_atiixp tg3 libata crct10dif\_common drm crc32c\_intel ptp
serio\_raw bnx2 r8169 hpsa pps\_core i2c\_core mii dm\_mirror dm\_region\_hash dm\_log
dm\_mod
[ 788.465294] CPU: 16 PID: 0 Comm: swapper/16 Tainted: G W
------------ 3.10.0-327.el7.x86\_64 #1
[ 788.511521] Hardware name: HP ProLiant DL385p Gen8, BIOS A28 12/17/2012
[ 788.542260] ffff880437c036b8 f7afc56532a53db9 ffff880437c03670
ffffffff816351f1
[ 788.576332] ffff880437c036a8 ffffffff8107b200 ffff880633e74200
ffff880231674000
[ 788.611943] 0000000000000001 0000000000000003 0000000000000000
ffff880437c03710
[ 788.647241] Call Trace:
[ 788.658817]  [] dump\_stack+0x19/0x1b
[ 788.686193] [] warn\_slowpath\_common+0x70/0xb0
[ 788.713803] [] warn\_slowpath\_fmt+0x5c/0x80
[ 788.741314] [] ? \_\_\_ratelimit+0x93/0x100
[ 788.767018] [] skb\_warn\_bad\_offload+0xcd/0xda
[ 788.796117] [] skb\_checksum\_help+0x17c/0x190
[ 788.823392] [] netem\_enqueue+0x741/0x7c0 [sch\_netem]
[ 788.854487] [] dev\_queue\_xmit+0x2a8/0x570
[ 788.880870] [] ip\_finish\_output+0x53d/0x7d0
...
The problem occurs because netem is not prepared to handle GSO packets (as it
uses skb\_checksum\_help in its enqueue path, which cannot manipulate these
frames).
The solution I think is to simply segment the skb in a simmilar fashion to the
way we do in \_\_dev\_queue\_xmit (via validate\_xmit\_skb), with some minor changes.
When we decide to corrupt an skb, if the frame is GSO, we segment it, corrupt
the first segment, and enqueue the remaining ones.
tested successfully by myself on the latest net kernel, to which this applies
Signed-off-by: Neil Horman
CC: Jamal Hadi Salim
CC: "David S. Miller"
CC: netem@lists.linux-foundation.org
CC: eric.dumazet@gmail.com
CC: stephen@networkplumber.org
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3d020622f6c4445bb4fd74de4b40a69ae7dddf69
Author: WANG Cong
Date: Thu Feb 25 14:55:03 2016 -0800
sch\_dsmark: update backlog as well
[ Upstream commit bdf17661f63a79c3cb4209b970b1cc39e34f7543 ]
Similarly, we need to update backlog too when we update qlen.
Cc: Jamal Hadi Salim
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 981f02b55d11910cf65d9e4963d0993aeb7ba1ec
Author: WANG Cong
Date: Thu Feb 25 14:55:02 2016 -0800
sch\_htb: update backlog as well
[ Upstream commit 431e3a8e36a05a37126f34b41aa3a5a6456af04e ]
We saw qlen!=0 but backlog==0 on our production machine:
qdisc htb 1: dev eth0 root refcnt 2 r2q 10 default 1 direct\_packets\_stat 0 ver 3.17
Sent 172680457356 bytes 222469449 pkt (dropped 0, overlimits 123575834 requeues 0)
backlog 0b 72p requeues 0
The problem is we only count qlen for HTB qdisc but not backlog.
We need to update backlog too when we update qlen, so that we
can at least know the average packet length.
Cc: Jamal Hadi Salim
Acked-by: Jamal Hadi Salim
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 01465faa0e2d311512690724196042f9bb466034
Author: WANG Cong
Date: Thu Feb 25 14:55:01 2016 -0800
net\_sched: update hierarchical backlog too
[ Upstream commit 2ccccf5fb43ff62b2b96cc58d95fc0b3596516e4 ]
When the bottom qdisc decides to, for example, drop some packet,
it calls qdisc\_tree\_decrease\_qlen() to update the queue length
for all its ancestors, we need to update the backlog too to
keep the stats on root qdisc accurate.
Cc: Jamal Hadi Salim
Acked-by: Jamal Hadi Salim
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2da507a87181a33b490ca4daba2c994cbaf7055f
Author: WANG Cong
Date: Thu Feb 25 14:55:00 2016 -0800
net\_sched: introduce qdisc\_replace() helper
[ Upstream commit 86a7996cc8a078793670d82ed97d5a99bb4e8496 ]
Remove nearly duplicated code and prepare for the following patch.
Cc: Jamal Hadi Salim
Acked-by: Jamal Hadi Salim
Signed-off-by: Cong Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 862ad6c9c9b4496b91384624fee6af74c6420d6d
Author: Jiri Benc
Date: Fri Apr 29 23:31:32 2016 +0200
gre: do not pull header in ICMP error processing
[ Upstream commit b7f8fe251e4609e2a437bd2c2dea01e61db6849c ]
iptunnel\_pull\_header expects that IP header was already pulled; with this
expectation, it pulls the tunnel header. This is not true in gre\_err.
Furthermore, ipv4\_update\_pmtu and ipv4\_redirect expect that skb->data points
to the IP header.
We cannot pull the tunnel header in this path. It's just a matter of not
calling iptunnel\_pull\_header - we don't need any of its effects.
Fixes: bda7bb463436 ("gre: Allow multiple protocol listener for gre protocol.")
Signed-off-by: Jiri Benc
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a2ea9029cafdd2e03d2e642b2d4867098088fb80
Author: Tim Bingham
Date: Fri Apr 29 13:30:23 2016 -0400
net: Implement net\_dbg\_ratelimited() for CONFIG\_DYNAMIC\_DEBUG case
[ Upstream commit 2c94b53738549d81dc7464a32117d1f5112c64d3 ]
Prior to commit d92cff89a0c8 ("net\_dbg\_ratelimited: turn into no-op
when !DEBUG") the implementation of net\_dbg\_ratelimited() was buggy
for both the DEBUG and CONFIG\_DYNAMIC\_DEBUG cases.
The bug was that net\_ratelimit() was being called and, despite
returning true, nothing was being printed to the console. This
resulted in messages like the following -
"net\_ratelimit: %d callbacks suppressed"
with no other output nearby.
After commit d92cff89a0c8 ("net\_dbg\_ratelimited: turn into no-op when
!DEBUG") the bug is fixed for the DEBUG case. However, there's no
output at all for CONFIG\_DYNAMIC\_DEBUG case.
This patch restores debug output (if enabled) for the
CONFIG\_DYNAMIC\_DEBUG case.
Add a definition of net\_dbg\_ratelimited() for the CONFIG\_DYNAMIC\_DEBUG
case. The implementation takes care to check that dynamic debugging is
enabled before calling net\_ratelimit().
Fixes: d92cff89a0c8 ("net\_dbg\_ratelimited: turn into no-op when !DEBUG")
Signed-off-by: Tim Bingham
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 59d0a01cc7af0c8556c64812a3429dc1e96cd006
Author: Alexei Starovoitov
Date: Wed Apr 27 18:56:22 2016 -0700
samples/bpf: fix trace\_output example
[ Upstream commit 569cc39d39385a74b23145496bca2df5ac8b2fb8 ]
llvm cannot always recognize memset as builtin function and optimize
it away, so just delete it. It was a leftover from testing
of bpf\_perf\_event\_output() with large data structures.
Fixes: 39111695b1b8 ("samples: bpf: add bpf\_perf\_event\_output example")
Signed-off-by: Alexei Starovoitov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0ae7bad57030e0f1cb22d34ceecd4a3d1bd3b4b0
Author: Alexei Starovoitov
Date: Wed Apr 27 18:56:21 2016 -0700
bpf: fix check\_map\_func\_compatibility logic
[ Upstream commit 6aff67c85c9e5a4bc99e5211c1bac547936626ca ]
The commit 35578d798400 ("bpf: Implement function bpf\_perf\_event\_read() that get the selected hardware PMU conuter")
introduced clever way to check bpf\_helper<->map\_type compatibility.
Later on commit a43eec304259 ("bpf: introduce bpf\_perf\_event\_output() helper") adjusted
the logic and inadvertently broke it.
Get rid of the clever bool compare and go back to two-way check
from map and from helper perspective.
Fixes: a43eec304259 ("bpf: introduce bpf\_perf\_event\_output() helper")
Reported-by: Jann Horn
Signed-off-by: Alexei Starovoitov
Signed-off-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1b106ad23a72bba34c7f37574defa324fdd76fc7
Author: Alexei Starovoitov
Date: Wed Apr 27 18:56:20 2016 -0700
bpf: fix refcnt overflow
[ Upstream commit 92117d8443bc5afacc8d5ba82e541946310f106e ]
On a system with >32Gbyte of phyiscal memory and infinite RLIMIT\_MEMLOCK,
the malicious application may overflow 32-bit bpf program refcnt.
It's also possible to overflow map refcnt on 1Tb system.
Impose 32k hard limit which means that the same bpf program or
map cannot be shared by more than 32k processes.
Fixes: 1be7f75d1668 ("bpf: enable non-root eBPF programs")
Reported-by: Jann Horn
Signed-off-by: Alexei Starovoitov
Acked-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2ffd01aa8d12c83c43b611a74a09852ea4dd0111
Author: Jann Horn
Date: Tue Apr 26 22:26:26 2016 +0200
bpf: fix double-fdput in replace\_map\_fd\_with\_map\_ptr()
[ Upstream commit 8358b02bf67d3a5d8a825070e1aa73f25fb2e4c7 ]
When bpf(BPF\_PROG\_LOAD, ...) was invoked with a BPF program whose bytecode
references a non-map file descriptor as a map file descriptor, the error
handling code called fdput() twice instead of once (in \_\_bpf\_map\_get() and
in replace\_map\_fd\_with\_map\_ptr()). If the file descriptor table of the
current task is shared, this causes f\_count to be decremented too much,
allowing the struct file to be freed while it is still in use
(use-after-free). This can be exploited to gain root privileges by an
unprivileged user.
This bug was introduced in
commit 0246e64d9a5f ("bpf: handle pseudo BPF\_LD\_IMM64 insn"), but is only
exploitable since
commit 1be7f75d1668 ("bpf: enable non-root eBPF programs") because
previously, CAP\_SYS\_ADMIN was required to reach the vulnerable code.
(posted publicly according to request by maintainer)
Signed-off-by: Jann Horn
Signed-off-by: Linus Torvalds
Acked-by: Alexei Starovoitov
Acked-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7d57af4f11f18b6aa48e5f083ada67fac917612e
Author: Eric Dumazet
Date: Sat Apr 23 11:35:46 2016 -0700
net/mlx4\_en: fix spurious timestamping callbacks
[ Upstream commit fc96256c906362e845d848d0f6a6354450059e81 ]
When multiple skb are TX-completed in a row, we might incorrectly keep
a timestamp of a prior skb and cause extra work.
Fixes: ec693d47010e8 ("net/mlx4\_en: Add HW timestamping (TS) support")
Signed-off-by: Eric Dumazet
Cc: Willem de Bruijn
Reviewed-by: Eran Ben Elisha
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 698faa8f415febe9fa6231ab55fb4aa5a78d9b28
Author: Paolo Abeni
Date: Thu Apr 21 22:23:31 2016 +0200
ipv4/fib: don't warn when primary address is missing if in\_dev is dead
[ Upstream commit 391a20333b8393ef2e13014e6e59d192c5594471 ]
After commit fbd40ea0180a ("ipv4: Don't do expensive useless work
during inetdev destroy.") when deleting an interface,
fib\_del\_ifaddr() can be executed without any primary address
present on the dead interface.
The above is safe, but triggers some "bug: prim == NULL" warnings.
This commit avoids warning if the in\_dev is dead
Signed-off-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 186654f41a99acbedef6f77c673f1a28636b29e4
Author: Saeed Mahameed
Date: Fri Apr 22 00:33:05 2016 +0300
net/mlx5e: Use vport MTU rather than physical port MTU
[ Upstream commit cd255efff9baadd654d6160e52d17ae7c568c9d3 ]
Set and report vport MTU rather than physical MTU,
Driver will set both vport and physical port mtu and will
rely on the query of vport mtu.
SRIOV VFs have to report their MTU to their vport manager (PF),
and this will allow them to work with any MTU they need
without failing the request.
Also for some cases where the PF is not a port owner, PF can
work with MTU less than the physical port mtu if set physical
port mtu didn't take effect.
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 99d966897d7b50279297aeeb25d6f32b84109879
Author: Saeed Mahameed
Date: Fri Apr 22 00:33:04 2016 +0300
net/mlx5e: Fix minimum MTU
[ Upstream commit d8edd2469ace550db707798180d1c84d81f93bca ]
Minimum MTU that can be set in Connectx4 device is 68.
This fixes the case where a user wants to set invalid MTU,
the driver will fail to satisfy this request and the interface
will stay down.
It is better to report an error and continue working with old
mtu.
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 88e2d2d2eb82a0f3c96a19868dbe30dac219cd47
Author: Saeed Mahameed
Date: Fri Apr 22 00:33:03 2016 +0300
net/mlx5e: Device's mtu field is u16 and not int
[ Upstream commit 046339eaab26804f52f6604877f5674f70815b26 ]
For set/query MTU port firmware commands the MTU field
is 16 bits, here I changed all the "int mtu" parameters
of the functions wrapping those firmware commands to be u16.
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2eeed9d5da7c144c9e1dda81094b9cb711333cb2
Author: Maor Gottlieb
Date: Fri Apr 22 00:33:00 2016 +0300
net/mlx5\_core: Fix soft lockup in steering error flow
[ Upstream commit c3f9bf628bc7edda298897d952f5e761137229c9 ]
In the error flow of adding flow rule to auto-grouped flow
table, we call to tree\_remove\_node.
tree\_remove\_node locks the node's parent, however the node's parent
is already locked by mlx5\_add\_flow\_rule and this causes a deadlock.
After this patch, if we failed to add the flow rule, we unlock the
flow table before calling to tree\_remove\_node.
fixes: f0d22d187473 ('net/mlx5\_core: Introduce flow steering autogrouped
flow table')
Signed-off-by: Maor Gottlieb
Reported-by: Amir Vadai
Signed-off-by: Saeed Mahameed
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0c056cfb4195db32a96a82640dd3f0f6ac48131a
Author: Simon Horman
Date: Thu Apr 21 11:49:15 2016 +1000
openvswitch: use flow protocol when recalculating ipv6 checksums
[ Upstream commit b4f70527f052b0c00be4d7cac562baa75b212df5 ]
When using masked actions the ipv6\_proto field of an action
to set IPv6 fields may be zero rather than the prevailing protocol
which will result in skipping checksum recalculation.
This patch resolves the problem by relying on the protocol
in the flow key rather than that in the set field action.
Fixes: 83d2b9ba1abc ("net: openvswitch: Support masked set actions.")
Cc: Jarno Rajahalme
Signed-off-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 11236cf9aef1402ddc1734409d89d3ad76e5eddc
Author: Ben Hutchings
Date: Wed Apr 20 23:23:08 2016 +0100
atl2: Disable unimplemented scatter/gather feature
[ Upstream commit f43bfaeddc79effbf3d0fcb53ca477cca66f3db8 ]
atl2 includes NETIF\_F\_SG in hw\_features even though it has no support
for non-linear skbs. This bug was originally harmless since the
driver does not claim to implement checksum offload and that used to
be a requirement for SG.
Now that SG and checksum offload are independent features, if you
explicitly enable SG \*and\* use one of the rare protocols that can use
SG without checkusm offload, this potentially leaks sensitive
information (before you notice that it just isn't working). Therefore
this obscure bug has been designated CVE-2016-2117.
Reported-by: Justin Yackoski
Signed-off-by: Ben Hutchings
Fixes: ec5f06156423 ("net: Kill link between CSUM and SG features.")
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a8be898cdbd0094677c5c908d37447c51b113c37
Author: Joe Stringer
Date: Mon Apr 18 14:51:47 2016 -0700
openvswitch: Orphan skbs before IPv6 defrag
[ Upstream commit 49e261a8a21e0960a3f7ff187a453ba1c1149053 ]
This is the IPv6 counterpart to commit 8282f27449bf ("inet: frag: Always
orphan skbs inside ip\_defrag()").
Prior to commit 029f7f3b8701 ("netfilter: ipv6: nf\_defrag: avoid/free
clone operations"), ipv6 fragments sent to nf\_ct\_frag6\_gather() would be
cloned (implicitly orphaning) prior to queueing for reassembly. As such,
when the IPv6 message is eventually reassembled, the skb->sk for all
fragments would be NULL. After that commit was introduced, rather than
cloning, the original skbs were queued directly without orphaning. The
end result is that all frags except for the first and last may have a
socket attached.
This commit explicitly orphans such skbs during nf\_ct\_frag6\_gather() to
prevent BUG\_ON(skb->sk) during a later call to ip6\_fragment().
kernel BUG at net/ipv6/ip6\_output.c:631!
[...]
Call Trace:
[] ? \_\_lock\_acquire+0x927/0x20a0
[] ? do\_output.isra.28+0x1b0/0x1b0 [openvswitch]
[] ? \_\_lock\_is\_held+0x52/0x70
[] ovs\_fragment+0x1f7/0x280 [openvswitch]
[] ? mark\_held\_locks+0x75/0xa0
[] ? \_raw\_spin\_unlock\_irqrestore+0x36/0x50
[] ? dst\_discard\_out+0x20/0x20
[] ? dst\_ifdown+0x80/0x80
[] do\_output.isra.28+0xf3/0x1b0 [openvswitch]
[] do\_execute\_actions+0x709/0x12c0 [openvswitch]
[] ? ovs\_flow\_stats\_update+0x74/0x1e0 [openvswitch]
[] ? ovs\_flow\_stats\_update+0xa1/0x1e0 [openvswitch]
[] ? \_raw\_spin\_unlock+0x27/0x40
[] ovs\_execute\_actions+0x45/0x120 [openvswitch]
[] ovs\_dp\_process\_packet+0x85/0x150 [openvswitch]
[] ? \_raw\_spin\_unlock+0x27/0x40
[] ovs\_execute\_actions+0xc4/0x120 [openvswitch]
[] ovs\_dp\_process\_packet+0x85/0x150 [openvswitch]
[] ? key\_extract+0x442/0xc10 [openvswitch]
[] ovs\_vport\_receive+0x5d/0xb0 [openvswitch]
[] ? \_\_lock\_acquire+0x927/0x20a0
[] ? \_\_lock\_acquire+0x927/0x20a0
[] ? \_\_lock\_acquire+0x927/0x20a0
[] ? \_raw\_spin\_unlock\_irqrestore+0x36/0x50
[] internal\_dev\_xmit+0x6d/0x150 [openvswitch]
[] ? internal\_dev\_xmit+0x5/0x150 [openvswitch]
[] dev\_hard\_start\_xmit+0x2df/0x660
[] ? validate\_xmit\_skb.isra.105.part.106+0x1a/0x2b0
[] \_\_dev\_queue\_xmit+0x8f5/0x950
[] ? \_\_dev\_queue\_xmit+0x50/0x950
[] ? mark\_held\_locks+0x75/0xa0
[] dev\_queue\_xmit+0x10/0x20
[] neigh\_resolve\_output+0x178/0x220
[] ? ip6\_finish\_output2+0x219/0x7b0
[] ip6\_finish\_output2+0x219/0x7b0
[] ? ip6\_finish\_output2+0x65/0x7b0
[] ? ip\_idents\_reserve+0x6b/0x80
[] ? ip6\_fragment+0x93f/0xc50
[] ip6\_fragment+0xba1/0xc50
[] ? ip6\_flush\_pending\_frames+0x40/0x40
[] ip6\_finish\_output+0xcb/0x1d0
[] ip6\_output+0x5f/0x1a0
[] ? ip6\_fragment+0xc50/0xc50
[] ip6\_local\_out+0x3d/0x80
[] ip6\_send\_skb+0x2f/0xc0
[] ip6\_push\_pending\_frames+0x4d/0x50
[] icmpv6\_push\_pending\_frames+0xac/0xe0
[] icmpv6\_echo\_reply+0x42e/0x500
[] icmpv6\_rcv+0x4cf/0x580
[] ip6\_input\_finish+0x1a7/0x690
[] ? ip6\_input\_finish+0x5/0x690
[] ip6\_input+0x30/0xa0
[] ? ip6\_rcv\_finish+0x1a0/0x1a0
[] ip6\_rcv\_finish+0x4e/0x1a0
[] ipv6\_rcv+0x45f/0x7c0
[] ? ipv6\_rcv+0x36/0x7c0
[] ? ip6\_make\_skb+0x1c0/0x1c0
[] \_\_netif\_receive\_skb\_core+0x229/0xb80
[] ? mark\_held\_locks+0x75/0xa0
[] ? process\_backlog+0x6f/0x230
[] \_\_netif\_receive\_skb+0x16/0x70
[] process\_backlog+0x78/0x230
[] ? process\_backlog+0xdd/0x230
[] net\_rx\_action+0x203/0x480
[] ? mark\_held\_locks+0x75/0xa0
[] \_\_do\_softirq+0xde/0x49f
[] ? ip6\_finish\_output2+0x228/0x7b0
[] do\_softirq\_own\_stack+0x1c/0x30
[] do\_softirq.part.18+0x3b/0x40
[] \_\_local\_bh\_enable\_ip+0xb6/0xc0
[] ip6\_finish\_output2+0x251/0x7b0
[] ? ip6\_fragment+0xba1/0xc50
[] ? ip\_idents\_reserve+0x6b/0x80
[] ? ip6\_fragment+0x93f/0xc50
[] ip6\_fragment+0xba1/0xc50
[] ? ip6\_flush\_pending\_frames+0x40/0x40
[] ip6\_finish\_output+0xcb/0x1d0
[] ip6\_output+0x5f/0x1a0
[] ? ip6\_fragment+0xc50/0xc50
[] ip6\_local\_out+0x3d/0x80
[] ip6\_send\_skb+0x2f/0xc0
[] ip6\_push\_pending\_frames+0x4d/0x50
[] rawv6\_sendmsg+0xa28/0xe30
[] ? inet\_sendmsg+0xc7/0x1d0
[] inet\_sendmsg+0x106/0x1d0
[] ? inet\_sendmsg+0x5/0x1d0
[] sock\_sendmsg+0x38/0x50
[] SYSC\_sendto+0xf6/0x170
[] ? trace\_hardirqs\_on\_thunk+0x1b/0x1d
[] SyS\_sendto+0xe/0x10
[] entry\_SYSCALL\_64\_fastpath+0x18/0xa8
Code: 06 48 83 3f 00 75 26 48 8b 87 d8 00 00 00 2b 87 d0 00 00 00 48 39 d0 72 14 8b 87 e4 00 00 00 83 f8 01 75 09 48 83 7f 18 00 74 9a <0f> 0b 41 8b 86 cc 00 00 00 49 8#
RIP [] ip6\_fragment+0x73a/0xc50
RSP
Fixes: 029f7f3b8701 ("netfilter: ipv6: nf\_defrag: avoid/free clone
operations")
Reported-by: Daniele Di Proietto
Signed-off-by: Joe Stringer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2b1e1a75e30807a9d767f28e85a01acb0a521049
Author: Daniel Borkmann
Date: Sat Apr 16 02:27:58 2016 +0200
vlan: pull on \_\_vlan\_insert\_tag error path and fix csum correction
[ Upstream commit 9241e2df4fbc648a92ea0752918e05c26255649e ]
When \_\_vlan\_insert\_tag() fails from skb\_vlan\_push() path due to the
skb\_cow\_head(), we need to undo the \_\_skb\_push() in the error path
as well that was done earlier to move skb->data pointer to mac header.
Moreover, I noticed that when in the non-error path the \_\_skb\_pull()
is done and the original offset to mac header was non-zero, we fixup
from a wrong skb->data offset in the checksum complete processing.
So the skb\_postpush\_rcsum() really needs to be done before \_\_skb\_pull()
where skb->data still points to the mac header start and thus operates
under the same conditions as in \_\_vlan\_insert\_tag().
Fixes: 93515d53b133 ("net: move vlan pop/push functions into common code")
Signed-off-by: Daniel Borkmann
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9a11c27b88032a88b882a2ff6b2265f975145197
Author: Daniel Borkmann
Date: Sat Feb 20 00:29:30 2016 +0100
net: use skb\_postpush\_rcsum instead of own implementations
[ Upstream commit 6b83d28a55a891a9d70fc61ccb1c138e47dcbe74 ]
Replace individual implementations with the recently introduced
skb\_postpush\_rcsum() helper.
Signed-off-by: Daniel Borkmann
Acked-by: Tom Herbert
Acked-by: Alexei Starovoitov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5ac8f80af2fb18f1db0afacae3276901e17809ea
Author: Craig Gallek
Date: Tue Apr 12 13:11:25 2016 -0400
soreuseport: fix ordering for mixed v4/v6 sockets
[ Upstream commit d894ba18d4e449b3a7f6eb491f16c9e02933736e ]
With the SO\_REUSEPORT socket option, it is possible to create sockets
in the AF\_INET and AF\_INET6 domains which are bound to the same IPv4 address.
This is only possible with SO\_REUSEPORT and when not using IPV6\_V6ONLY on
the AF\_INET6 sockets.
Prior to the commits referenced below, an incoming IPv4 packet would
always be routed to a socket of type AF\_INET when this mixed-mode was used.
After those changes, the same packet would be routed to the most recently
bound socket (if this happened to be an AF\_INET6 socket, it would
have an IPv4 mapped IPv6 address).
The change in behavior occurred because the recent SO\_REUSEPORT optimizations
short-circuit the socket scoring logic as soon as they find a match. They
did not take into account the scoring logic that favors AF\_INET sockets
over AF\_INET6 sockets in the event of a tie.
To fix this problem, this patch changes the insertion order of AF\_INET
and AF\_INET6 addresses in the TCP and UDP socket lists when the sockets
have SO\_REUSEPORT set. AF\_INET sockets will be inserted at the head of the
list and AF\_INET6 sockets with SO\_REUSEPORT set will always be inserted at
the tail of the list. This will force AF\_INET sockets to always be
considered first.
Fixes: e32ea7e74727 ("soreuseport: fast reuseport UDP socket selection")
Fixes: 125e80b88687 ("soreuseport: fast reuseport TCP socket selection")
Reported-by: Maciej Żenczykowski
Signed-off-by: Craig Gallek
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 62862f1047561038739d9ee09a92b554fc3da6d3
Author: Bjørn Mork
Date: Tue Apr 12 16:11:12 2016 +0200
cdc\_mbim: apply "NDP to end" quirk to all Huawei devices
[ Upstream commit c5b5343cfbc9f46af65033fa4f407d7b7d98371d ]
We now have a positive report of another Huawei device needing
this quirk: The ME906s-158 (12d1:15c1). This is an m.2 form
factor modem with no obvious relationship to the E3372 (12d1:157d)
we already have a quirk entry for. This is reason enough to
believe the quirk might be necessary for any number of current
and future Huawei devices.
Applying the quirk to all Huawei devices, since it is crucial
to any device affected by the firmware bug, while the impact
on non-affected devices is negligible.
The quirk can if necessary be disabled per-device by writing
N to /sys/class/net//cdc\_ncm/ndp\_to\_end
Reported-by: Andreas Fett
Signed-off-by: Bjørn Mork
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 682c5a13beec6c33d8b65fa4ae612f1c74033d63
Author: Alexei Starovoitov
Date: Tue Apr 12 10:26:19 2016 -0700
bpf/verifier: reject invalid LD\_ABS | BPF\_DW instruction
[ Upstream commit d82bccc69041a51f7b7b9b4a36db0772f4cdba21 ]
verifier must check for reserved size bits in instruction opcode and
reject BPF\_LD | BPF\_ABS | BPF\_DW and BPF\_LD | BPF\_IND | BPF\_DW instructions,
otherwise interpreter will WARN\_RATELIMIT on them during execution.
Fixes: ddd872bc3098 ("bpf: verifier: add checks for BPF\_ABS | BPF\_IND instructions")
Signed-off-by: Alexei Starovoitov
Acked-by: Daniel Borkmann
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e4bb8baf1c4dabce8e704704c46701051988bd9d
Author: Lars Persson
Date: Tue Apr 12 08:45:52 2016 +0200
net: sched: do not requeue a NULL skb
[ Upstream commit 3dcd493fbebfd631913df6e2773cc295d3bf7d22 ]
A failure in validate\_xmit\_skb\_list() triggered an unconditional call
to dev\_requeue\_skb with skb=NULL. This slowly grows the queue
discipline's qlen count until all traffic through the queue stops.
We take the optimistic approach and continue running the queue after a
failure since it is unknown if later packets also will fail in the
validate path.
Fixes: 55a93b3ea780 ("qdisc: validate skb without holding lock")
Signed-off-by: Lars Persson
Acked-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 555694a8f03fae56a5952436c21defd1b072150b
Author: Mathias Krause
Date: Sun Apr 10 12:52:28 2016 +0200
packet: fix heap info leak in PACKET\_DIAG\_MCLIST sock\_diag interface
[ Upstream commit 309cf37fe2a781279b7675d4bb7173198e532867 ]
Because we miss to wipe the remainder of i->addr[] in packet\_mc\_add(),
pdiag\_put\_mclist() leaks uninitialized heap bytes via the
PACKET\_DIAG\_MCLIST netlink attribute.
Fix this by explicitly memset(0)ing the remaining bytes in i->addr[].
Fixes: eea68e2f1a00 ("packet: Report socket mclist info via diag module")
Signed-off-by: Mathias Krause
Cc: Eric W. Biederman
Cc: Pavel Emelyanov
Acked-by: Pavel Emelyanov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 992ce0a3636c20b6399fdb6d83cf0c14fff4f815
Author: Chris Friesen
Date: Fri Apr 8 15:21:30 2016 -0600
route: do not cache fib route info on local routes with oif
[ Upstream commit d6d5e999e5df67f8ec20b6be45e2229455ee3699 ]
For local routes that require a particular output interface we do not want
to cache the result. Caching the result causes incorrect behaviour when
there are multiple source addresses on the interface. The end result
being that if the intended recipient is waiting on that interface for the
packet he won't receive it because it will be delivered on the loopback
interface and the IP\_PKTINFO ipi\_ifindex will be set to the loopback
interface as well.
This can be tested by running a program such as "dhcp\_release" which
attempts to inject a packet on a particular interface so that it is
received by another program on the same board. The receiving process
should see an IP\_PKTINFO ipi\_ifndex value of the source interface
(e.g., eth1) instead of the loopback interface (e.g., lo). The packet
will still appear on the loopback interface in tcpdump but the important
aspect is that the CMSG info is correct.
Sample dhcp\_release command line:
dhcp\_release eth1 192.168.204.222 02:11:33:22:44:66
Signed-off-by: Allain Legacy
Signed off-by: Chris Friesen
Reviewed-by: Julian Anastasov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7f4c2607942a70f47ea754c8c9d1a5b3244d2359
Author: David S. Miller
Date: Sun Apr 10 23:01:30 2016 -0400
decnet: Do not build routes to devices without decnet private data.
[ Upstream commit a36a0d4008488fa545c74445d69eaf56377d5d4e ]
In particular, make sure we check for decnet private presence
for loopback devices.
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ec176528312064f611a7d1ac3bbe16675e2ab97e
Author: Arnd Bergmann
Date: Wed Jan 13 15:36:17 2016 +0100
staging: wilc1000: remove extraneous variable
commit ce7b516f3f9e11fe4ee06fad0d7e853bb6e8f160 upstream.
Building wilc1000 with clang currently fails in the staging-next branch:
drivers/staging/wilc1000/wilc\_spi.c:123:34: warning: tentative definition of variable with internal linkage has incomplete non-array type 'const struct wilc1000\_ops' [-Wtentative-definition-incomplete-type]
static const struct wilc1000\_ops wilc1000\_spi\_ops;
The reason is that wilc1000\_ops was left behind after a recent cleanup,
and is completely unused and also uninitialized and const and has an
incomplete type.
Removing the variable is obviously correct, and gets rid of the warning.
No idea why gcc does not complain about it though.
Signed-off-by: Arnd Bergmann
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman


=== Content from www.ubuntu.com_5df93f23_20250125_124917.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3007-1: Linux kernel (Raspberry Pi 2) vulnerabilities

10 June 2016

Several security issues were fixed in the kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2

## Details

Justin Yackoski discovered that the Atheros L2 Ethernet Driver in the Linux

kernel incorrectly enables scatter/gather I/O. A remote attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-2117](/security/CVE-2016-2117))

Jann Horn discovered that eCryptfs improperly attempted to use the mmap()

handler of a lower filesystem that did not implement one, causing a

recursive page fault to occur. A local unprivileged attacker could use to

cause a denial of service (system crash) or possibly execute arbitrary code

with administrative privileges. ([CVE-2016-1583](/security/CVE-2016-1583))

Multiple race conditions where discovered in the Linux kernel's ext4 file

system. A local user could exploit this flaw to cause a denial of service

(disk corruption) by writing to a page that is associated with a different

users file after unsynchronized hole punching and page-fault handling.

([CVE-2015-8839](/security/CVE-2015-8839))

Ralf Spenneberg discovered that the Linux kernel's GTCO digitizer USB

device driver did not properly validate endpoint descriptors. An attacker

with physical access could use this to cause a denial of service (system

crash). ([CVE-2016-2187](/security/CVE-2016-2187))

Vitaly Kuznetsov discovered that the Linux kernel did not properly suppress

hugetlbfs support in X86 paravirtualized guests. An attacker in the guest

OS could cause a denial of service (guest system crash). ([CVE-2016-3961](/security/CVE-2016-3961))

Kangjie Lu discovered an information leak in the ANSI/IEEE 802.2 LLC type 2

Support implementations in the Linux kernel. A local attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-4485](/security/CVE-2016-4485))

Kangjie Lu discovered an information leak in the routing netlink socket

interface (rtnetlink) implementation in the Linux kernel. A local attacker

could use this to obtain potentially sensitive information from kernel

memory. ([CVE-2016-4486](/security/CVE-2016-4486))

Jann Horn discovered that the extended Berkeley Packet Filter (eBPF)

implementation in the Linux kernel could overflow reference counters on

systems with more than 32GB of physical ram and with RLIMIT\_MEMLOCK set to

infinite. A local unprivileged attacker could use to create a use-after-

free situation, causing a denial of service (system crash) or possibly gain

administrative privileges. ([CVE-2016-4558](/security/CVE-2016-4558))

Jann Horn discovered that the InfiniBand interfaces within the Linux kernel

could be coerced into overwriting kernel memory. A local unprivileged

attacker could use this to possibly gain administrative privileges on

systems where InifiniBand related kernel modules are loaded.

([CVE-2016-4565](/security/CVE-2016-4565))

It was discovered that in some situations the Linux kernel did not handle

propagated mounts correctly. A local unprivileged attacker could use this

to cause a denial of service (system crash). ([CVE-2016-4581](/security/CVE-2016-4581))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1012-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1012.16](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1012.16)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2015-8839](/security/CVE-2015-8839)
* [CVE-2016-1583](/security/CVE-2016-1583)
* [CVE-2016-2117](/security/CVE-2016-2117)
* [CVE-2016-2187](/security/CVE-2016-2187)
* [CVE-2016-3961](/security/CVE-2016-3961)
* [CVE-2016-4485](/security/CVE-2016-4485)
* [CVE-2016-4486](/security/CVE-2016-4486)
* [CVE-2016-4558](/security/CVE-2016-4558)
* [CVE-2016-4565](/security/CVE-2016-4565)
* [CVE-2016-4581](/security/CVE-2016-4581)

## Related notices

* [USN-3005-1](/security/notices/USN-3005-1)
* [USN-3006-1](/security/notices/USN-3006-1)
* [USN-3003-1](/security/notices/USN-3003-1)
* [USN-2996-1](/security/notices/USN-2996-1)
* [USN-3000-1](/security/notices/USN-3000-1)
* [USN-3001-1](/security/notices/USN-3001-1)
* [USN-2997-1](/security/notices/USN-2997-1)
* [USN-2999-1](/security/notices/USN-2999-1)
* [USN-3002-1](/security/notices/USN-3002-1)
* [USN-3008-1](/security/notices/USN-3008-1)
* [USN-2998-1](/security/notices/USN-2998-1)
* [USN-3004-1](/security/notices/USN-3004-1)
* [USN-2989-1](/security/notices/USN-2989-1)
* [USN-3127-1](/security/notices/USN-3127-1)
* [USN-3050-1](/security/notices/USN-3050-1)
* [USN-3127-2](/security/notices/USN-3127-2)
* [USN-3049-1](/security/notices/USN-3049-1)
* [USN-3018-2](/security/notices/USN-3018-2)
* [USN-3018-1](/security/notices/USN-3018-1)
* [USN-3021-2](/security/notices/USN-3021-2)
* [USN-3021-1](/security/notices/USN-3021-1)
* [USN-3019-1](/security/notices/USN-3019-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from git.kernel.org_9b595bba_20250125_124907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=92117d8443bc5afacc8d5ba82e541946310f106e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=92117d8443bc5afacc8d5ba82e541946310f106e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=92117d8443bc5afacc8d5ba82e541946310f106e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=92117d8443bc5afacc8d5ba82e541946310f106e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexei Starovoitov <ast@fb.com> | 2016-04-27 18:56:20 -0700 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2016-04-28 17:29:45 -0400 |
| commit | [92117d8443bc5afacc8d5ba82e541946310f106e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=92117d8443bc5afacc8d5ba82e541946310f106e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=92117d8443bc5afacc8d5ba82e541946310f106e)) | |
| tree | [d0db595b54f82b59049d4b879561c2f97d25e18b](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=92117d8443bc5afacc8d5ba82e541946310f106e) | |
| parent | [bd34cf66cc48a5fb17deb7a1494845c45d71ba8e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=92117d8443bc5afacc8d5ba82e541946310f106e&id2=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)) | |
| download | [linux-92117d8443bc5afacc8d5ba82e541946310f106e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-92117d8443bc5afacc8d5ba82e541946310f106e.tar.gz) | |

bpf: fix refcnt overflowOn a system with >32Gbyte of phyiscal memory and infinite RLIMIT\_MEMLOCK,
the malicious application may overflow 32-bit bpf program refcnt.
It's also possible to overflow map refcnt on 1Tb system.
Impose 32k hard limit which means that the same bpf program or
map cannot be shared by more than 32k processes.
Fixes: 1be7f75d1668 ("bpf: enable non-root eBPF programs")
Reported-by: Jann Horn <jannh@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=92117d8443bc5afacc8d5ba82e541946310f106e)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/include/linux/bpf.h?id=92117d8443bc5afacc8d5ba82e541946310f106e) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/inode.c?id=92117d8443bc5afacc8d5ba82e541946310f106e) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/syscall.c?id=92117d8443bc5afacc8d5ba82e541946310f106e) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/bpf/verifier.c?id=92117d8443bc5afacc8d5ba82e541946310f106e) | 11 | |  |  |  | | --- | --- | --- | |

4 files changed, 33 insertions, 12 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 21ee41b92e8aaa..f1d5c5acc8dd58 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/linux/bpf.h?id=92117d8443bc5afacc8d5ba82e541946310f106e)@@ -171,12 +171,13 @@ void bpf\_register\_prog\_type(struct bpf\_prog\_type\_list \*tl); void bpf\_register\_map\_type(struct bpf\_map\_type\_list \*tl);  struct bpf\_prog \*bpf\_prog\_get(u32 ufd);+struct bpf\_prog \*bpf\_prog\_inc(struct bpf\_prog \*prog); void bpf\_prog\_put(struct bpf\_prog \*prog); void bpf\_prog\_put\_rcu(struct bpf\_prog \*prog);  struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd); struct bpf\_map \*\_\_bpf\_map\_get(struct fd f);-void bpf\_map\_inc(struct bpf\_map \*map, bool uref);+struct bpf\_map \*bpf\_map\_inc(struct bpf\_map \*map, bool uref); void bpf\_map\_put\_with\_uref(struct bpf\_map \*map); void bpf\_map\_put(struct bpf\_map \*map); int bpf\_map\_precharge\_memlock(u32 pages);diff --git a/kernel/bpf/inode.c b/kernel/bpf/inode.cindex f2ece3c174a5b5..8f94ca1860cfdc 100644--- a/[kernel/bpf/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/inode.c?id=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)+++ b/[kernel/bpf/inode.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/inode.c?id=92117d8443bc5afacc8d5ba82e541946310f106e)@@ -31,10 +31,10 @@ static void \*bpf\_any\_get(void \*raw, enum bpf\_type type) { switch (type) { case BPF\_TYPE\_PROG:- atomic\_inc(&((struct bpf\_prog \*)raw)->aux->refcnt);+ raw = bpf\_prog\_inc(raw); break; case BPF\_TYPE\_MAP:- bpf\_map\_inc(raw, true);+ raw = bpf\_map\_inc(raw, true); break; default: WARN\_ON\_ONCE(1);@@ -297,7 +297,8 @@ static void \*bpf\_obj\_do\_get(const struct filename \*pathname, goto out;  raw = bpf\_any\_get(inode->i\_private, \*type);- touch\_atime(&path);+ if (!IS\_ERR(raw))+ touch\_atime(&path);  path\_put(&path); return raw;diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex adc5e4bd74f8bc..cf5e9f7ad13ad1 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/syscall.c?id=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/syscall.c?id=92117d8443bc5afacc8d5ba82e541946310f106e)@@ -218,11 +218,18 @@ struct bpf\_map \*\_\_bpf\_map\_get(struct fd f) return f.file->private\_data; } -void bpf\_map\_inc(struct bpf\_map \*map, bool uref)+/\* prog's and map's refcnt limit \*/+#define BPF\_MAX\_REFCNT 32768++struct bpf\_map \*bpf\_map\_inc(struct bpf\_map \*map, bool uref) {- atomic\_inc(&map->refcnt);+ if (atomic\_inc\_return(&map->refcnt) > BPF\_MAX\_REFCNT) {+ atomic\_dec(&map->refcnt);+ return ERR\_PTR(-EBUSY);+ } if (uref) atomic\_inc(&map->usercnt);+ return map; }  struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd)@@ -234,7 +241,7 @@ struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd) if (IS\_ERR(map)) return map; - bpf\_map\_inc(map, true);+ map = bpf\_map\_inc(map, true); fdput(f);  return map;@@ -658,6 +665,15 @@ static struct bpf\_prog \*\_\_bpf\_prog\_get(struct fd f) return f.file->private\_data; } +struct bpf\_prog \*bpf\_prog\_inc(struct bpf\_prog \*prog)+{+ if (atomic\_inc\_return(&prog->aux->refcnt) > BPF\_MAX\_REFCNT) {+ atomic\_dec(&prog->aux->refcnt);+ return ERR\_PTR(-EBUSY);+ }+ return prog;+}+ /\* called by sockets/tracing/seccomp before attaching program to an event \* pairs with bpf\_prog\_put() \*/@@ -670,7 +686,7 @@ struct bpf\_prog \*bpf\_prog\_get(u32 ufd) if (IS\_ERR(prog)) return prog; - atomic\_inc(&prog->aux->refcnt);+ prog = bpf\_prog\_inc(prog); fdput(f);  return prog;diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex db2574e7b8b008..89bcaa0966da06 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/bpf/verifier.c?id=92117d8443bc5afacc8d5ba82e541946310f106e)@@ -2049,15 +2049,18 @@ static int replace\_map\_fd\_with\_map\_ptr(struct verifier\_env \*env) return -E2BIG; } - /\* remember this map \*/- env->used\_maps[env->used\_map\_cnt++] = map;- /\* hold the map. If the program is rejected by verifier, \* the map will be released by release\_maps() or it \* will be used by the valid program until it's unloaded \* and all maps are released in free\_bpf\_prog\_info() \*/- bpf\_map\_inc(map, false);+ map = bpf\_map\_inc(map, false);+ if (IS\_ERR(map)) {+ fdput(f);+ return PTR\_ERR(map);+ }+ env->used\_maps[env->used\_map\_cnt++] = map;+ fdput(f); next\_insn: insn++; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 12:47:45 +0000



=== Content from www.ubuntu.com_826e3601_20250125_124914.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3005-1: Linux kernel (Xenial HWE) vulnerabilities

10 June 2016

Several security issues were fixed in the kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty

## Details

Justin Yackoski discovered that the Atheros L2 Ethernet Driver in the Linux

kernel incorrectly enables scatter/gather I/O. A remote attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-2117](/security/CVE-2016-2117))

Jann Horn discovered that eCryptfs improperly attempted to use the mmap()

handler of a lower filesystem that did not implement one, causing a

recursive page fault to occur. A local unprivileged attacker could use to

cause a denial of service (system crash) or possibly execute arbitrary code

with administrative privileges. ([CVE-2016-1583](/security/CVE-2016-1583))

Multiple race conditions where discovered in the Linux kernel's ext4 file

system. A local user could exploit this flaw to cause a denial of service

(disk corruption) by writing to a page that is associated with a different

users file after unsynchronized hole punching and page-fault handling.

([CVE-2015-8839](/security/CVE-2015-8839))

Ralf Spenneberg discovered that the Linux kernel's GTCO digitizer USB

device driver did not properly validate endpoint descriptors. An attacker

with physical access could use this to cause a denial of service (system

crash). ([CVE-2016-2187](/security/CVE-2016-2187))

Vitaly Kuznetsov discovered that the Linux kernel did not properly suppress

hugetlbfs support in X86 paravirtualized guests. An attacker in the guest

OS could cause a denial of service (guest system crash). ([CVE-2016-3961](/security/CVE-2016-3961))

Kangjie Lu discovered an information leak in the ANSI/IEEE 802.2 LLC type 2

Support implementations in the Linux kernel. A local attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-4485](/security/CVE-2016-4485))

Kangjie Lu discovered an information leak in the routing netlink socket

interface (rtnetlink) implementation in the Linux kernel. A local attacker

could use this to obtain potentially sensitive information from kernel

memory. ([CVE-2016-4486](/security/CVE-2016-4486))

Jann Horn discovered that the extended Berkeley Packet Filter (eBPF)

implementation in the Linux kernel could overflow reference counters on

systems with more than 32GB of physical ram and with RLIMIT\_MEMLOCK set to

infinite. A local unprivileged attacker could use to create a use-after-

free situation, causing a denial of service (system crash) or possibly gain

administrative privileges. ([CVE-2016-4558](/security/CVE-2016-4558))

Jann Horn discovered that the InfiniBand interfaces within the Linux kernel

could be coerced into overwriting kernel memory. A local unprivileged

attacker could use this to possibly gain administrative privileges on

systems where InifiniBand related kernel modules are loaded.

([CVE-2016-4565](/security/CVE-2016-4565))

It was discovered that in some situations the Linux kernel did not handle

propagated mounts correctly. A local unprivileged attacker could use this

to cause a denial of service (system crash). ([CVE-2016-4581](/security/CVE-2016-4581))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-4.4.0-24-generic](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)
* [linux-image-4.4.0-24-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-24.43~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-24.43~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2015-8839](/security/CVE-2015-8839)
* [CVE-2016-1583](/security/CVE-2016-1583)
* [CVE-2016-2117](/security/CVE-2016-2117)
* [CVE-2016-2187](/security/CVE-2016-2187)
* [CVE-2016-3961](/security/CVE-2016-3961)
* [CVE-2016-4485](/security/CVE-2016-4485)
* [CVE-2016-4486](/security/CVE-2016-4486)
* [CVE-2016-4558](/security/CVE-2016-4558)
* [CVE-2016-4565](/security/CVE-2016-4565)
* [CVE-2016-4581](/security/CVE-2016-4581)

## Related notices

* [USN-3007-1](/security/notices/USN-3007-1)
* [USN-3006-1](/security/notices/USN-3006-1)
* [USN-3003-1](/security/notices/USN-3003-1)
* [USN-2996-1](/security/notices/USN-2996-1)
* [USN-3000-1](/security/notices/USN-3000-1)
* [USN-3001-1](/security/notices/USN-3001-1)
* [USN-2997-1](/security/notices/USN-2997-1)
* [USN-2999-1](/security/notices/USN-2999-1)
* [USN-3002-1](/security/notices/USN-3002-1)
* [USN-3008-1](/security/notices/USN-3008-1)
* [USN-2998-1](/security/notices/USN-2998-1)
* [USN-3004-1](/security/notices/USN-3004-1)
* [USN-2989-1](/security/notices/USN-2989-1)
* [USN-3127-1](/security/notices/USN-3127-1)
* [USN-3050-1](/security/notices/USN-3050-1)
* [USN-3127-2](/security/notices/USN-3127-2)
* [USN-3049-1](/security/notices/USN-3049-1)
* [USN-3018-2](/security/notices/USN-3018-2)
* [USN-3018-1](/security/notices/USN-3018-1)
* [USN-3021-2](/security/notices/USN-3021-2)
* [USN-3021-1](/security/notices/USN-3021-1)
* [USN-3019-1](/security/notices/USN-3019-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from www.openwall.com_a48731a8_20250125_124913.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](5) [[thread-next>]](7) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20160506131455.GA17272@lorien.valinor.li>
Date: Fri, 6 May 2016 15:14:55 +0200
From: Salvatore Bonaccorso <carnil@...ian.org>
To: OSS Security Mailinglist <oss-security@...ts.openwall.com>
Cc: Ben Hutchings <benh@...ian.org>
Subject: CVE Requests: Linux: BPF flaws (one use-after-free / local root
 privilege escalation)

A use-after-free flaw via double-fdput in bpf was recently fixed in
Linux. Details:

<https://bugs.chromium.org/p/project-zero/issues/detail?id=808>

Fixed via:
<https://git.kernel.org/linus/8358b02bf67d3a5d8a825070e1aa73f25fb2e4c7>

And as well reported/forwarded in Debian:
<https://bugs.debian.org/823603>

Could you please assign a CVE for this issue?

The following two might as well warrant a CVE (Ben Hutchings CC'ed has
already applied those to the packaging repository in Debian):

bpf: fix refcnt overflow:
<https://git.kernel.org/linus/92117d8443bc5afacc8d5ba82e541946310f106e>

bpf: fix check_map_func_compatibility logic
<https://git.kernel.org/linus/6aff67c85c9e5a4bc99e5211c1bac547936626ca>

Not sure though if the later one has a security impact. The bug
allowed generic map functions to be applied to special map types
(program, perf events) that did not support them properly.

Regards,
Salvatore

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from access.redhat.com_9a03a4c7_20250126_084140.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from github.com_8207428f_20250125_124919.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F92117d8443bc5afacc8d5ba82e541946310f106e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F92117d8443bc5afacc8d5ba82e541946310f106e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/92117d8443bc5afacc8d5ba82e541946310f106e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

bpf: fix refcnt overflow

[Browse files](/torvalds/linux/tree/92117d8443bc5afacc8d5ba82e541946310f106e)
Browse the repository at this point in the history

```
On a system with >32Gbyte of phyiscal memory and infinite RLIMIT_MEMLOCK,
the malicious application may overflow 32-bit bpf program refcnt.
It's also possible to overflow map refcnt on 1Tb system.
Impose 32k hard limit which means that the same bpf program or
map cannot be shared by more than 32k processes.

Fixes: [1be7f75](https://github.com/torvalds/linux/commit/1be7f75d1668d6296b80bf35dcf6762393530afc) ("bpf: enable non-root eBPF programs")
Reported-by: Jann Horn <jannh@google.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Acked-by: Daniel Borkmann <daniel@iogearbox.net>
Signed-off-by: David S. Miller <davem@davemloft.net>
```

* Loading branch information

[![@4ast](https://avatars.githubusercontent.com/u/12205493?s=40&v=4)](/4ast) [![@davem330](https://avatars.githubusercontent.com/u/1053866?s=40&v=4)](/davem330)

[4ast](/torvalds/linux/commits?author=4ast "View all commits by 4ast")
authored and
[davem330](/torvalds/linux/commits?author=davem330 "View all commits by davem330")
committed
Apr 28, 2016

1 parent
[bd34cf6](/torvalds/linux/commit/bd34cf66cc48a5fb17deb7a1494845c45d71ba8e)

commit 92117d8

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**33 additions**
and
**12 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* include/linux

  + include/linux/bpf.h
    [bpf.h](#diff-10c25cae50af6c8c81a80025da7200c8afa166f20c0b39bc85a745b9105f8ce6)
* kernel/bpf

  + kernel/bpf/inode.c
    [inode.c](#diff-6a107ef45e436bc09307d0e201e8575044617f24d64ddf6f706894950cc15d52)
  + kernel/bpf/syscall.c
    [syscall.c](#diff-9fb056de263cc4a10925f1474cc0371518419d22bdb4b26d8cfcc7043bfa7883)
  + kernel/bpf/verifier.c
    [verifier.c](#diff-edbb57adf10d1ce1fbb830a34fa92712fd01db1fbd9b6f2504001eb7bcc7b9d0)

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[include/linux/bpf.h](#diff-10c25cae50af6c8c81a80025da7200c8afa166f20c0b39bc85a745b9105f8ce6 "include/linux/bpf.h")

Show comments

[View file](/torvalds/linux/blob/92117d8443bc5afacc8d5ba82e541946310f106e/include/linux/bpf.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -171,12 +171,13 @@ void bpf\_register\_prog\_type(struct bpf\_prog\_type\_list \*tl); |
|  |  | void bpf\_register\_map\_type(struct bpf\_map\_type\_list \*tl); |
|  |  |  |
|  |  | struct bpf\_prog \*bpf\_prog\_get(u32 ufd); |
|  |  | struct bpf\_prog \*bpf\_prog\_inc(struct bpf\_prog \*prog); |
|  |  | void bpf\_prog\_put(struct bpf\_prog \*prog); |
|  |  | void bpf\_prog\_put\_rcu(struct bpf\_prog \*prog); |
|  |  |  |
|  |  | struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd); |
|  |  | struct bpf\_map \*\_\_bpf\_map\_get(struct fd f); |
|  |  | void bpf\_map\_inc(struct bpf\_map \*map, bool uref); |
|  |  | struct bpf\_map \*bpf\_map\_inc(struct bpf\_map \*map, bool uref); |
|  |  | void bpf\_map\_put\_with\_uref(struct bpf\_map \*map); |
|  |  | void bpf\_map\_put(struct bpf\_map \*map); |
|  |  | int bpf\_map\_precharge\_memlock(u32 pages); |
| Expand Down | |  |

7 changes: 4 additions & 3 deletions

7
[kernel/bpf/inode.c](#diff-6a107ef45e436bc09307d0e201e8575044617f24d64ddf6f706894950cc15d52 "kernel/bpf/inode.c")

Show comments

[View file](/torvalds/linux/blob/92117d8443bc5afacc8d5ba82e541946310f106e/kernel/bpf/inode.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -31,10 +31,10 @@ static void \*bpf\_any\_get(void \*raw, enum bpf\_type type) |
|  |  | { |
|  |  | switch (type) { |
|  |  | case BPF\_TYPE\_PROG: |
|  |  | atomic\_inc(&((struct bpf\_prog \*)raw)->aux->refcnt); |
|  |  | raw = bpf\_prog\_inc(raw); |
|  |  | break; |
|  |  | case BPF\_TYPE\_MAP: |
|  |  | bpf\_map\_inc(raw, true); |
|  |  | raw = bpf\_map\_inc(raw, true); |
|  |  | break; |
|  |  | default: |
|  |  | WARN\_ON\_ONCE(1); |
| Expand Down  Expand Up | | @@ -297,7 +297,8 @@ static void \*bpf\_obj\_do\_get(const struct filename \*pathname, |
|  |  | goto out; |
|  |  |  |
|  |  | raw = bpf\_any\_get(inode->i\_private, \*type); |
|  |  | touch\_atime(&path); |
|  |  | if (!IS\_ERR(raw)) |
|  |  | touch\_atime(&path); |
|  |  |  |
|  |  | path\_put(&path); |
|  |  | return raw; |
| Expand Down | |  |

24 changes: 20 additions & 4 deletions

24
[kernel/bpf/syscall.c](#diff-9fb056de263cc4a10925f1474cc0371518419d22bdb4b26d8cfcc7043bfa7883 "kernel/bpf/syscall.c")

Show comments

[View file](/torvalds/linux/blob/92117d8443bc5afacc8d5ba82e541946310f106e/kernel/bpf/syscall.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -218,11 +218,18 @@ struct bpf\_map \*\_\_bpf\_map\_get(struct fd f) |
|  |  | return f.file->private\_data; |
|  |  | } |
|  |  |  |
|  |  | void bpf\_map\_inc(struct bpf\_map \*map, bool uref) |
|  |  | /\* prog's and map's refcnt limit \*/ |
|  |  | #define BPF\_MAX\_REFCNT 32768 |
|  |  |  |
|  |  | struct bpf\_map \*bpf\_map\_inc(struct bpf\_map \*map, bool uref) |
|  |  | { |
|  |  | atomic\_inc(&map->refcnt); |
|  |  | if (atomic\_inc\_return(&map->refcnt) > BPF\_MAX\_REFCNT) { |
|  |  | atomic\_dec(&map->refcnt); |
|  |  | return ERR\_PTR(-EBUSY); |
|  |  | } |
|  |  | if (uref) |
|  |  | atomic\_inc(&map->usercnt); |
|  |  | return map; |
|  |  | } |
|  |  |  |
|  |  | struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd) |
| Expand All | | @@ -234,7 +241,7 @@ struct bpf\_map \*bpf\_map\_get\_with\_uref(u32 ufd) |
|  |  | if (IS\_ERR(map)) |
|  |  | return map; |
|  |  |  |
|  |  | bpf\_map\_inc(map, true); |
|  |  | map = bpf\_map\_inc(map, true); |
|  |  | fdput(f); |
|  |  |  |
|  |  | return map; |
| Expand Down  Expand Up | | @@ -658,6 +665,15 @@ static struct bpf\_prog \*\_\_bpf\_prog\_get(struct fd f) |
|  |  | return f.file->private\_data; |
|  |  | } |
|  |  |  |
|  |  | struct bpf\_prog \*bpf\_prog\_inc(struct bpf\_prog \*prog) |
|  |  | { |
|  |  | if (atomic\_inc\_return(&prog->aux->refcnt) > BPF\_MAX\_REFCNT) { |
|  |  | atomic\_dec(&prog->aux->refcnt); |
|  |  | return ERR\_PTR(-EBUSY); |
|  |  | } |
|  |  | return prog; |
|  |  | } |
|  |  |  |
|  |  | /\* called by sockets/tracing/seccomp before attaching program to an event |
|  |  | \* pairs with bpf\_prog\_put() |
|  |  | \*/ |
| Expand All | | @@ -670,7 +686,7 @@ struct bpf\_prog \*bpf\_prog\_get(u32 ufd) |
|  |  | if (IS\_ERR(prog)) |
|  |  | return prog; |
|  |  |  |
|  |  | atomic\_inc(&prog->aux->refcnt); |
|  |  | prog = bpf\_prog\_inc(prog); |
|  |  | fdput(f); |
|  |  |  |
|  |  | return prog; |
| Expand Down | |  |

11 changes: 7 additions & 4 deletions

11
[kernel/bpf/verifier.c](#diff-edbb57adf10d1ce1fbb830a34fa92712fd01db1fbd9b6f2504001eb7bcc7b9d0 "kernel/bpf/verifier.c")

Show comments

[View file](/torvalds/linux/blob/92117d8443bc5afacc8d5ba82e541946310f106e/kernel/bpf/verifier.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2049,15 +2049,18 @@ static int replace\_map\_fd\_with\_map\_ptr(struct verifier\_env \*env) |
|  |  | return -E2BIG; |
|  |  | } |
|  |  |  |
|  |  | /\* remember this map \*/ |
|  |  | env->used\_maps[env->used\_map\_cnt++] = map; |
|  |  |  |
|  |  | /\* hold the map. If the program is rejected by verifier, |
|  |  | \* the map will be released by release\_maps() or it |
|  |  | \* will be used by the valid program until it's unloaded |
|  |  | \* and all maps are released in free\_bpf\_prog\_info() |
|  |  | \*/ |
|  |  | bpf\_map\_inc(map, false); |
|  |  | map = bpf\_map\_inc(map, false); |
|  |  | if (IS\_ERR(map)) { |
|  |  | fdput(f); |
|  |  | return PTR\_ERR(map); |
|  |  | } |
|  |  | env->used\_maps[env->used\_map\_cnt++] = map; |
|  |  |  |
|  |  | fdput(f); |
|  |  | next\_insn: |
|  |  | insn++; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `92117d8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F92117d8443bc5afacc8d5ba82e541946310f106e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.ubuntu.com_85bb8679_20250125_124915.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-3006-1: Linux kernel vulnerabilities

10 June 2016

Several security issues were fixed in the kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel

## Details

Justin Yackoski discovered that the Atheros L2 Ethernet Driver in the Linux

kernel incorrectly enables scatter/gather I/O. A remote attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-2117](/security/CVE-2016-2117))

Jann Horn discovered that eCryptfs improperly attempted to use the mmap()

handler of a lower filesystem that did not implement one, causing a

recursive page fault to occur. A local unprivileged attacker could use to

cause a denial of service (system crash) or possibly execute arbitrary code

with administrative privileges. ([CVE-2016-1583](/security/CVE-2016-1583))

Multiple race conditions where discovered in the Linux kernel's ext4 file

system. A local user could exploit this flaw to cause a denial of service

(disk corruption) by writing to a page that is associated with a different

users file after unsynchronized hole punching and page-fault handling.

([CVE-2015-8839](/security/CVE-2015-8839))

Ralf Spenneberg discovered that the Linux kernel's GTCO digitizer USB

device driver did not properly validate endpoint descriptors. An attacker

with physical access could use this to cause a denial of service (system

crash). ([CVE-2016-2187](/security/CVE-2016-2187))

Vitaly Kuznetsov discovered that the Linux kernel did not properly suppress

hugetlbfs support in X86 paravirtualized guests. An attacker in the guest

OS could cause a denial of service (guest system crash). ([CVE-2016-3961](/security/CVE-2016-3961))

Kangjie Lu discovered an information leak in the ANSI/IEEE 802.2 LLC type 2

Support implementations in the Linux kernel. A local attacker could use

this to obtain potentially sensitive information from kernel memory.

([CVE-2016-4485](/security/CVE-2016-4485))

Kangjie Lu discovered an information leak in the routing netlink socket

interface (rtnetlink) implementation in the Linux kernel. A local attacker

could use this to obtain potentially sensitive information from kernel

memory. ([CVE-2016-4486](/security/CVE-2016-4486))

Jann Horn discovered that the extended Berkeley Packet Filter (eBPF)

implementation in the Linux kernel could overflow reference counters on

systems with more than 32GB of physical ram and with RLIMIT\_MEMLOCK set to

infinite. A local unprivileged attacker could use to create a use-after-

free situation, causing a denial of service (system crash) or possibly gain

administrative privileges. ([CVE-2016-4558](/security/CVE-2016-4558))

Jann Horn discovered that the InfiniBand interfaces within the Linux kernel

could be coerced into overwriting kernel memory. A local unprivileged

attacker could use this to possibly gain administrative privileges on

systems where InifiniBand related kernel modules are loaded.

([CVE-2016-4565](/security/CVE-2016-4565))

It was discovered that in some situations the Linux kernel did not handle

propagated mounts correctly. A local unprivileged attacker could use this

to cause a denial of service (system crash). ([CVE-2016-4581](/security/CVE-2016-4581))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-24-generic](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)
* [linux-image-4.4.0-24-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-24.43](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-24.43)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2015-8839](/security/CVE-2015-8839)
* [CVE-2016-1583](/security/CVE-2016-1583)
* [CVE-2016-2117](/security/CVE-2016-2117)
* [CVE-2016-2187](/security/CVE-2016-2187)
* [CVE-2016-3961](/security/CVE-2016-3961)
* [CVE-2016-4485](/security/CVE-2016-4485)
* [CVE-2016-4486](/security/CVE-2016-4486)
* [CVE-2016-4558](/security/CVE-2016-4558)
* [CVE-2016-4565](/security/CVE-2016-4565)
* [CVE-2016-4581](/security/CVE-2016-4581)

## Related notices

* [USN-3005-1](/security/notices/USN-3005-1)
* [USN-3007-1](/security/notices/USN-3007-1)
* [USN-3003-1](/security/notices/USN-3003-1)
* [USN-2996-1](/security/notices/USN-2996-1)
* [USN-3000-1](/security/notices/USN-3000-1)
* [USN-3001-1](/security/notices/USN-3001-1)
* [USN-2997-1](/security/notices/USN-2997-1)
* [USN-2999-1](/security/notices/USN-2999-1)
* [USN-3002-1](/security/notices/USN-3002-1)
* [USN-3008-1](/security/notices/USN-3008-1)
* [USN-2998-1](/security/notices/USN-2998-1)
* [USN-3004-1](/security/notices/USN-3004-1)
* [USN-2989-1](/security/notices/USN-2989-1)
* [USN-3127-1](/security/notices/USN-3127-1)
* [USN-3050-1](/security/notices/USN-3050-1)
* [USN-3127-2](/security/notices/USN-3127-2)
* [USN-3049-1](/security/notices/USN-3049-1)
* [USN-3018-2](/security/notices/USN-3018-2)
* [USN-3018-1](/security/notices/USN-3018-1)
* [USN-3021-2](/security/notices/USN-3021-2)
* [USN-3021-1](/security/notices/USN-3021-1)
* [USN-3019-1](/security/notices/USN-3019-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from bugzilla.redhat.com_cda9402a_20250125_124918.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D1334303)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D1334303)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D1334303)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1334303

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1334303**](show_bug.cgi?id=1334303)
(CVE-2016-4558)
- [CVE-2016-4558](https://access.redhat.com/security/cve/CVE-2016-4558) kernel: bpf: refcnt overflow

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2016-4558 kernel: bpf: refcnt overflow

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2016-4558 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | high | | [Severity:](page.cgi?id=fields.html#bug_severity) | high | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1334311](show_bug.cgi?id=1334311 "CLOSED ERRATA - CVE-2016-4557 CVE-2016-4558 kernel: various flaws [fedora-all]") [1335701](show_bug.cgi?id=1335701) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1334304](show_bug.cgi?id=1334304) | | TreeView+ | [depends on](buglist.cgi?bug_id=1334303&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1334303&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2016-05-09 11:12 UTC by Andrej Nemec | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2021-10-21 00:52 UTC ([History](show_activity.cgi?id=1334303)) | | [CC List:](page.cgi?id=fields.html#cclist) | 26 users (show)  aquini bhu dhoward fhrbata gansalmon iboverma itamar jforbes jkacur joelsmith jonathan jross jwboyer kernel-maint kernel-mgr kstutsma lgoncalv madhu.chinakonda mchehab mcressma nmurray rt-maint rvrbovsk slawomir williams wmealing | | Fixed In Version: |  | | | Doc Type: | Bug Fix | | | Doc Text: | A flaw was found in the Linux kernel's implementation of BPF in which systems can application can overflow a 32 bit refcount in both program and map refcount. This refcount can wrap and end up a user after free. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2021-10-21 00:52:32 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1334303#c0)  Andrej Nemec    2016-05-09 11:12:52 UTC  ``` A flaw was found in the Linux kernels implementation of BPF in which systems with more than 32GB of physical memory and unlimited RLIMIT_MEMLOCK settings an application can overflow a 32 bit refcount.    Additionally in the same environment, malicious applications can overflow a map refcount on larger memory (1Tb).  When the overflow wraps to zero a reference can be held while being free'd.  This can lead to a use after free   CVE assignment:  <http://seclists.org/oss-sec/2016/q2/266>  Upstream fix:  <https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=92117d8443bc5afacc8d5ba82e541946310f106e>   ```  [Comment 1](show_bug.cgi?id=1334303#c1)  Adam Mariš    2016-05-09 11:29:03 UTC  ```  Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 1334311](show_bug.cgi?id=1334311 "CLOSED ERRATA - CVE-2016-4557 CVE-2016-4558 kernel: various flaws [fedora-all]")]   ```  [Comment 3](show_bug.cgi?id=1334303#c3)  Wade Mealing    2016-05-13 02:08:16 UTC  ```  Statement:  This issue does not affect the Linux kernels as shipped with Red Hat Enterprise Linux 4, 5, 6, 7 and Red Hat Enterprise MRG 2.   ```  [Comment 6](show_bug.cgi?id=1334303#c6)  Fedora Update System    2016-05-14 23:22:20 UTC  ``` kernel-4.5.4-300.fc24 has been pushed to the Fedora 24 stable repository. If problems still persist, please make note of it in this bug report.   ```  [Comment 7](show_bug.cgi?id=1334303#c7)  Fedora Update System    2016-05-25 00:53:04 UTC  ``` kernel-4.4.10-200.fc22 has been pushed to the Fedora 22 stable repository. If problems still persist, please make note of it in this bug report.   ```  [Comment 9](show_bug.cgi?id=1334303#c9)  Fedora Update System    2016-06-02 14:59:04 UTC  ``` kernel-4.5.5-201.fc23 has been pushed to the Fedora 23 stable repository. If problems still persist, please make note of it in this bug report.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1334303&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)


