=== Content from bugs.launchpad.net_39476521_20250125_083150.html ===

[Log in / Register](https://bugs.launchpad.net/glance/%2Bbug/1593799/%2Blogin)

[![](https://launchpadlibrarian.net/355215744/glance-chipmunk-64.png)](https://launchpad.net/glance)

## [Glance](https://launchpad.net/glance)

* [Overview](https://launchpad.net/glance)
* [Code](https://code.launchpad.net/glance)
* [Bugs](https://bugs.launchpad.net/glance)
* [Blueprints](https://blueprints.launchpad.net/glance)
* [Translations](https://translations.launchpad.net/glance)
* [Answers](https://answers.launchpad.net/glance)

# glance-manage db purge breaks image immutability promise

Bug #1593799 reported by
[Erno Kuvaja](https://launchpad.net/~jokke)
on 2016-06-17

[18](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [Glance](https://bugs.launchpad.net/glance) | Fix Released | Critical | Unassigned |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Opinion | Undecided | Unassigned |  |
|  | [OpenStack Security Notes](https://bugs.launchpad.net/ossn) | Fix Released | High | [Travis McPeak](https://launchpad.net/~travis-mcpeak) |  |

### Bug Description

Using glance-manage db purge command opens possibility to recycle image-IDs.

When the row is deleted from the database the ID is not known by glance anymore and thus it's not unique during the deployment lifecycle. This opens possibility to following scenario:

1) End user boots VM from private/public/shared image.

2) Image owner deletes the image.

3) glance-manage db purge gets ran which deletes record that image has ever existed.

4) Either malicious user or someone unintentionally creates new image with same ID (being same user so having access to the image by owning it or it becoming public/shared(/possbly community at some point))

5) Same end user boots either snapshot from the original image or nova needs to migrate the VM to another host. Now the user's VM will be rebuilt on top of the new image. Worst case scenario the user had no idea that the image data changed in between.

This behavior breaks Glance image immutability promise that has bee stated that the data related to image ID that has gone active will never change.

We have two solutions for this. Either we introduce table to track the deleted image-IDs and get glance to cross check that during the image create or we leave it as is but issue notice/documentation what are the implications if the purge is used transferring the responsibility to the cloud operators.

This was partially discussed in the virtual glance midcycle meetup so it might not be justified to leave this as private but I wanted to leave that decision to VMT.

Tags:

[security](/glance/%2Bbugs?field.tag=security)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-06-17: |  |  | [#1](/glance/%2Bbug/1593799/comments/1) |
| --- | --- | --- | --- |

I added Brian as we discussed about this yesterday and he is part of glance-coresec but did not have access to the bug.

I added Brian as we discussed about this yesterday and he is part of glance-coresec but did not have access to the bug.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-06-17: |  |  | [#2](/glance/%2Bbug/1593799/comments/2) |
| --- | --- | --- | --- |

This is a good summary of the problem.

One thing we thought about was restricting the ability to specify an image\_id at the time of image creation to admins by policy, so that this feature couldn't be abused. An objection to that strategy is that for hybrid clouds, it would be convenient for regular users to use the same id for the same image in each cloud.

This is a good summary of the problem.
One thing we thought about was restricting the ability to specify an image\_id at the time of image creation to admins by policy, so that this feature couldn't be abused. An objection to that strategy is that for hybrid clouds, it would be convenient for regular users to use the same id for the same image in each cloud.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2016-06-17: |  |  | [#3](/glance/%2Bbug/1593799/comments/3) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

| Changed in ossa: | |
| --- | --- |
| **status**: | New → Incomplete |
| **description**: | updated |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2016-06-17: |  |  | [#4](/glance/%2Bbug/1593799/comments/4) |
| --- | --- | --- | --- |

If this was discussed in a public venue (I can't find mention of it in IRC logs so presumably it happened in voice chat instead?) then there's not a lot of point in maintaining an embargo. Also if the fix ends up just being a change to documentation or happens only in master (adding database tables doesn't seem likely to pass muster for a stable backport) then this would at most be a security note and not an advisory anyway.

It also seems like exploitation would be hard to target unless the operator is routinely purging Glance's DB.

If this was discussed in a public venue (I can't find mention of it in IRC logs so presumably it happened in voice chat instead?) then there's not a lot of point in maintaining an embargo. Also if the fix ends up just being a change to documentation or happens only in master (adding database tables doesn't seem likely to pass muster for a stable backport) then this would at most be a security note and not an advisory anyway.
It also seems like exploitation would be hard to target unless the operator is routinely purging Glance's DB.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-06-17: |  |  | [#5](/glance/%2Bbug/1593799/comments/5) |
| --- | --- | --- | --- |

The discussion was in the virtual mid-cycle meeting in bluejeans and I believe a recording is available.

Just one thing about the exploit -- combine this with [https://bugs.launchpad.net/glance/+bug/1545092](https://bugs.launchpad.net/glance/%2Bbug/1545092), and a bad actor could put the DB in a situation where it needs to be purged right away.

I don't think [bug 1545092](/bugs/1545092) has been publicized yet (there was going to be a combined security note about a few issues, iirc), maybe the recommendation for this bug could be rolled into that.

The discussion was in the virtual mid-cycle meeting in bluejeans and I believe a recording is available.
Just one thing about the exploit -- combine this with https://bugs.launchpad.net/glance/+bug/1545092, and a bad actor could put the DB in a situation where it needs to be purged right away.
I don't think bug 1545092 has been publicized yet (there was going to be a combined security note about a few issues, iirc), maybe the recommendation for this bug could be rolled into that.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-06-17: |  |  | [#6](/glance/%2Bbug/1593799/comments/6) |
| --- | --- | --- | --- |

The recording is not yet available and if we want to keep this private, I can withold that part from the recording. (I need to edit it to avoid publishing sensitive info like phone numbers anyways).

The recording is not yet available and if we want to keep this private, I can withold that part from the recording. (I need to edit it to avoid publishing sensitive info like phone numbers anyways).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-06-17: |  |  | [#7](/glance/%2Bbug/1593799/comments/7) |
| --- | --- | --- | --- |

so the audience on that call was ~7 people which of at least 3 belongs to the glance sec group Brian, Nikhil and Hemanth, the 4th would be me so we do not have too many people yet this has been going out.

so the audience on that call was ~7 people which of at least 3 belongs to the glance sec group Brian, Nikhil and Hemanth, the 4th would be me so we do not have too many people yet this has been going out.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-06-17: |  |  | [#8](/glance/%2Bbug/1593799/comments/8) |
| --- | --- | --- | --- |

We haven't published the recordings so I agree that having this in a private bug is okay.

Please note that this issue exists at least since Liberty. The commit that introduced this feature and hence a vulnerability along with it is:

commit 9a6823326b43c01562a736d417f6e5f7f68e44cf

Author: Martin Mágr <email address hidden>

Date: Mon Aug 24 13:37:54 2015 +0200

Add db purge command

This patch adds "db purge" to glance-manage for deleting soft deleted

    images, tasks.

Change-Id: I5b609292aa15f8133d0d785fcf9143825bed8073

    Implements: blueprint database-purge

I can confirm that this is a real issue.

Also, I think this vulnerability can exist irrespective of the existence of the db-purge utility as a individual operator can choose to hard-delete the soft-deleted old rows on their deployment.

There is a problem with introducing a new table due the growth in the size of the DB over period of time. This was one of the major reason why the db-purge utility was introduced. I think this bug is subject to further discussion on the best possible solution. I, however, find it in the best interest to send a CVE note with a advice on not deleting soft-deleted images. It should be left to the operator to decide which images are safe to be removed from the database once their deployment is assured of non-existence of such -- like no tracking of that image id in Nova, Cinder, Ironic, Heat, etc.

We haven't published the recordings so I agree that having this in a private bug is okay.
Please note that this issue exists at least since Liberty. The commit that introduced this feature and hence a vulnerability along with it is:
commit 9a6823326b43c01562a736d417f6e5f7f68e44cf
Author: Martin Mágr <mmagr@redhat.com>
Date: Mon Aug 24 13:37:54 2015 +0200
Add db purge command
This patch adds "db purge" to glance-manage for deleting soft deleted
images, tasks.
Change-Id: I5b609292aa15f8133d0d785fcf9143825bed8073
Implements: blueprint database-purge
I can confirm that this is a real issue.
Also, I think this vulnerability can exist irrespective of the existence of the db-purge utility as a individual operator can choose to hard-delete the soft-deleted old rows on their deployment.
There is a problem with introducing a new table due the growth in the size of the DB over period of time. This was one of the major reason why the db-purge utility was introduced. I think this bug is subject to further discussion on the best possible solution. I, however, find it in the best interest to send a CVE note with a advice on not deleting soft-deleted images. It should be left to the operator to decide which images are safe to be removed from the database once their deployment is assured of non-existence of such -- like no tracking of that image id in Nova, Cinder, Ironic, Heat, etc.

| Changed in glance: | |
| --- | --- |
| **status**: | New → Confirmed |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2016-06-17: |  |  | [#9](/glance/%2Bbug/1593799/comments/9) |
| --- | --- | --- | --- |

The VMT doesn't request CVE assignment for bugs which aren't going to have fixes backported, though that doesn't stop someone else from requesting a CVE once this is public. However, the point of a CVE is to be able to track whether a given deployment is vulnerable, and if there's no patch or configuration change which makes deployments no longer at risk of this then there's not much point to having a CVE assigned for it anyway in my opinion.

The VMT doesn't request CVE assignment for bugs which aren't going to have fixes backported, though that doesn't stop someone else from requesting a CVE once this is public. However, the point of a CVE is to be able to track whether a given deployment is vulnerable, and if there's no patch or configuration change which makes deployments no longer at risk of this then there's not much point to having a CVE assigned for it anyway in my opinion.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2016-06-20: |  |  | [#10](/glance/%2Bbug/1593799/comments/10) |
| --- | --- | --- | --- |

By "note" there I'm going to assume you meant OSSN, and I agree that's likely warranted. I'm subscribing the Security team reviewers for further input.

By "note" there I'm going to assume you meant OSSN, and I agree that's likely warranted. I'm subscribing the Security team reviewers for further input.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-06-20: |  |  | [#11](/glance/%2Bbug/1593799/comments/11) |
| --- | --- | --- | --- |

Thanks Jeremy.

Without going into the technical details about the kind of notes we want to make available to the audience, I think a good security/email documentation with availability for reference (link or number) will help us resolve the communication gap around where we see this being an issue for some of the operators who have chosen to use the db-purge utility since Liberty. Nevertheless, this being a issue for all operators irrespective of who has chosen to use the upstream utility, I think an email to the wider audience is necessary.

Also, I think we need a best practice on this kind of behavior. Maintaining the list of image-ids ever used may be a good amount of trouble for some of the ops, but I'd like to hear some feedback from the glance-core-sec before taking further action.

Thanks Jeremy.
Without going into the technical details about the kind of notes we want to make available to the audience, I think a good security/email documentation with availability for reference (link or number) will help us resolve the communication gap around where we see this being an issue for some of the operators who have chosen to use the db-purge utility since Liberty. Nevertheless, this being a issue for all operators irrespective of who has chosen to use the upstream utility, I think an email to the wider audience is necessary.
Also, I think we need a best practice on this kind of behavior. Maintaining the list of image-ids ever used may be a good amount of trouble for some of the ops, but I'd like to hear some feedback from the glance-core-sec before taking further action.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Hemanth Makkapati (hemanth-makkapati)](https://launchpad.net/~hemanth-makkapati) wrote on 2016-06-20: |  |  | [#12](/glance/%2Bbug/1593799/comments/12) |
| --- | --- | --- | --- |

I didn't get a chance yet to replicate this on devstack but this certainly sounds like a real issue.

I like the idea of creating a separate table that keeps track of all the deleted IDs. Doing this will at least isolate the performance issues to one operation, image create (that too only when an ID is provided). On the other hand, the no-purge strategy won't be practical for big clouds and it will impact performance of many image operations. Like Nikhil said, even if we get rid of the purge utility, there is no guarantee that operators themselves won't prune the database. So, I'm inclining towards educating the operators about the risks involved and maybe also provide a way to control or completely disable image creation by id with a policy and/or configuration. That way, the operators can take a call themselves based on their respective business case.

I didn't get a chance yet to replicate this on devstack but this certainly sounds like a real issue.
I like the idea of creating a separate table that keeps track of all the deleted IDs. Doing this will at least isolate the performance issues to one operation, image create (that too only when an ID is provided). On the other hand, the no-purge strategy won't be practical for big clouds and it will impact performance of many image operations. Like Nikhil said, even if we get rid of the purge utility, there is no guarantee that operators themselves won't prune the database. So, I'm inclining towards educating the operators about the risks involved and maybe also provide a way to control or completely disable image creation by id with a policy and/or configuration. That way, the operators can take a call themselves based on their respective business case.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-06-28: |  |  | [#13](/glance/%2Bbug/1593799/comments/13) |
| --- | --- | --- | --- |

Agreed, this seems like a good target for an OSSN.

Agreed, this seems like a good target for an OSSN.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-06-28: |  |  | [#14](/glance/%2Bbug/1593799/comments/14) |
| --- | --- | --- | --- |

(added)

(added)

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-07-11

| Changed in ossa: | |
| --- | --- |
| **status**: | Incomplete → Opinion |

[Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak)
on 2016-07-21

| Changed in ossn: | |
| --- | --- |
| **assignee**: | nobody → Travis McPeak (travis-mcpeak) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-17: |  |  | [#15](/glance/%2Bbug/1593799/comments/15) |
| --- | --- | --- | --- |

I'm working on the note for this now. What's the best recommendation we can give? It seems like we don't have the ability to either:

- disable image creation by ID

 - track previously assigned image IDs

So what's the best recommendation we can give?

I'm working on the note for this now. What's the best recommendation we can give? It seems like we don't have the ability to either:
- disable image creation by ID
- track previously assigned image IDs
So what's the best recommendation we can give?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-08-18: |  |  | [#16](/glance/%2Bbug/1593799/comments/16) |
| --- | --- | --- | --- |

Travis,

I think the best recommendation we can give at this stage is to not use purge on any system that does not have image creation limited to trusted users.

Travis,
I think the best recommendation we can give at this stage is to not use purge on any system that does not have image creation limited to trusted users.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-18: |  |  | [#17](/glance/%2Bbug/1593799/comments/17) |
| --- | --- | --- | --- |

I agree with Erno. I don't know how much info is usually included in this kind of note, but it might be worth mentioning that if an operator absolutely must do some trimming, the key thing is not to delete the soft-deleted rows in the 'images' table. It should be OK to hard delete the associated rows in the image\_members, image\_properties, image\_tags, and image\_locations tables.

I agree with Erno. I don't know how much info is usually included in this kind of note, but it might be worth mentioning that if an operator absolutely must do some trimming, the key thing is not to delete the soft-deleted rows in the 'images' table. It should be OK to hard delete the associated rows in the image\_members, image\_properties, image\_tags, and image\_locations tables.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-18: |  |  | [#18](/glance/%2Bbug/1593799/comments/18) |
| --- | --- | --- | --- |

Thanks Erno and Brian. I'm working on a draft of the note now. I'll post here soon.

Thanks Erno and Brian. I'm working on a draft of the note now. I'll post here soon.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-19: |  |  | [#19](/glance/%2Bbug/1593799/comments/19) |
| --- | --- | --- | --- |

How does this look?

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X

 - Bob (image X's owner) deletes the image

 - Mallory creates a new image and specifies that the ID should be X

 - Alice boots her VM without realizing that the image has changed

### Affected Services / Software ###

Glance, Liberty, Mitaka

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

How does this look?
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X
- Bob (image X's owner) deletes the image
- Mallory creates a new image and specifies that the ID should be X
- Alice boots her VM without realizing that the image has changed
### Affected Services / Software ###
Glance, Liberty, Mitaka
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

[Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak)
on 2016-08-19

| Changed in ossn: | |
| --- | --- |
| **status**: | New → Confirmed |
| **importance**: | Undecided → High |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-24: |  |  | [#20](/glance/%2Bbug/1593799/comments/20) |
| --- | --- | --- | --- |

Thanks, Travis. Sorry to be so long getting to this.

I hate to be pedantic (but I used to be a professor, so I can't help it). Two comments:

(1) The scenario in your "Summary" isn't quite right. For that exact scenario to work you'd also have to have one of the following:

(A) Mallory has permission to "publicize" images (limited to admins by default policy). Otherwise, Alice can't access the "new" image X uploaded by Mallory.

(B) Mallory doesn't have permission to "publicize" images, but knows Alice's project ID, and shares the image with Alice. (If we assume that the original image X was shared by Bob, since Mallory didn't own the original image X, she couldn't see the full member list of everyone Bob had shared it with, so she'd have to guess or do some social engineering.)

I guess what I'm really getting at here is that the most likely scenario for this to work is that either Bob and Mallory are the same person or are in cahoots. But after writing all that down, in the long run, it doesn't matter, it \*is\* possible for this to happen, so maybe your summary is sufficient after all.

(2) If a deployer wants to purge the database for space reasons, it would be OK to manually remove the soft-deleted rows from the image\_properties, image\_tags, image\_members, and image\_locations tables. (You do say "don't delete rows from the images table", but maybe it's worth saying that it's OK to delete rows from these other tables.) I haven't read a lot of security notes, so ignore this suggestion if it's a dumb idea or inconsistent with the usual practice.

Otherwise, the note LGTM.

Thanks, Travis. Sorry to be so long getting to this.
I hate to be pedantic (but I used to be a professor, so I can't help it). Two comments:
(1) The scenario in your "Summary" isn't quite right. For that exact scenario to work you'd also have to have one of the following:
(A) Mallory has permission to "publicize" images (limited to admins by default policy). Otherwise, Alice can't access the "new" image X uploaded by Mallory.
(B) Mallory doesn't have permission to "publicize" images, but knows Alice's project ID, and shares the image with Alice. (If we assume that the original image X was shared by Bob, since Mallory didn't own the original image X, she couldn't see the full member list of everyone Bob had shared it with, so she'd have to guess or do some social engineering.)
I guess what I'm really getting at here is that the most likely scenario for this to work is that either Bob and Mallory are the same person or are in cahoots. But after writing all that down, in the long run, it doesn't matter, it \*is\* possible for this to happen, so maybe your summary is sufficient after all.
(2) If a deployer wants to purge the database for space reasons, it would be OK to manually remove the soft-deleted rows from the image\_properties, image\_tags, image\_members, and image\_locations tables. (You do say "don't delete rows from the images table", but maybe it's worth saying that it's OK to delete rows from these other tables.) I haven't read a lot of security notes, so ignore this suggestion if it's a dumb idea or inconsistent with the usual practice.
Otherwise, the note LGTM.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-24: |  |  | [#21](/glance/%2Bbug/1593799/comments/21) |
| --- | --- | --- | --- |

Brian - thanks for the clarity, and this isn't pedantic. We shoot for being precise in these notes. I'll update the note to reflect these points.

Brian - thanks for the clarity, and this isn't pedantic. We shoot for being precise in these notes. I'll update the note to reflect these points.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-25: |  |  | [#22](/glance/%2Bbug/1593799/comments/22) |
| --- | --- | --- | --- |

Everybody happy with this?

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X

 - Bob (image X's owner) deletes the image

 - Mallory creates a new image and specifies that the ID should be X

 - Alice boots her VM without realizing that the image has changed

It's worth noting that in this scenario Mallory needs to know Alice's

project ID to share the new image with Alice. This isn't enough to

mitigate the issue as project IDs weren't designed to be confidential.

### Affected Services / Software ###

Glance, Liberty, Mitaka

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged. It is

however safe to delete rows from `image\_properties`, `image\_tags`,

`image\_members`, and `image\_locations` tables.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

Everybody happy with this?
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X
- Bob (image X's owner) deletes the image
- Mallory creates a new image and specifies that the ID should be X
- Alice boots her VM without realizing that the image has changed
It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.
### Affected Services / Software ###
Glance, Liberty, Mitaka
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-25: |  |  | [#23](/glance/%2Bbug/1593799/comments/23) |
| --- | --- | --- | --- |

Thanks the note looks mostly clean.

A few things to note:

\* Affected Services will include Newton as we haven't removed the purge utility yet and don't plan on removing in Newton.

\* Attack scenario is not very clear, not sure if that's intended. If you would like -- some more inline suggestions:

 - Alice creates a VM that boots from image ID X "shared with her by trusted individual Bob"

 - Bob (image X's owner) deletes the image "and as per design no notification is sent to Alice"

 - Mallory creates a new image and specifies that the ID should be X "and shares it with Alice, again Alice is not aware of this update."

 - Alice boots her VM without realizing that the image has changed

\* Another possible scenario involves Mallory having the ability to publicize the image in which case sharing isn't required in the above case.

As a courtesy, please make sure to give 24 hours to the glance-core-sec team as people are in different parts of the world before publishing note.

Thanks the note looks mostly clean.
A few things to note:
\* Affected Services will include Newton as we haven't removed the purge utility yet and don't plan on removing in Newton.
\* Attack scenario is not very clear, not sure if that's intended. If you would like -- some more inline suggestions:
- Alice creates a VM that boots from image ID X "shared with her by trusted individual Bob"
- Bob (image X's owner) deletes the image "and as per design no notification is sent to Alice"
- Mallory creates a new image and specifies that the ID should be X "and shares it with Alice, again Alice is not aware of this update."
- Alice boots her VM without realizing that the image has changed
\* Another possible scenario involves Mallory having the ability to publicize the image in which case sharing isn't required in the above case.
As a courtesy, please make sure to give 24 hours to the glance-core-sec team as people are in different parts of the world before publishing note.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-25: |  |  | [#24](/glance/%2Bbug/1593799/comments/24) |
| --- | --- | --- | --- |

Thanks, latest:

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X which has been shared

 with her by a trusted party, Bob.

 - Bob (image X's owner) deletes the image. As per design, Alice

 receives no notification this happened.

 - Mallory creates a new image and specifies that the ID should be X.

 - Mallory shares image X with Alice. Again, per design, Alice is not

 notified of this change.

 - Alice boots her VM without realizing that the image has changed.

It's worth noting that in this scenario Mallory needs to know Alice's

project ID to share the new image with Alice. This isn't enough to

mitigate the issue as project IDs weren't designed to be confidential.

### Affected Services / Software ###

Glance, Liberty, Mitaka, Newton

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged. It is

however safe to delete rows from `image\_properties`, `image\_tags`,

`image\_members`, and `image\_locations` tables.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

Thanks, latest:
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X which has been shared
with her by a trusted party, Bob.
- Bob (image X's owner) deletes the image. As per design, Alice
receives no notification this happened.
- Mallory creates a new image and specifies that the ID should be X.
- Mallory shares image X with Alice. Again, per design, Alice is not
notified of this change.
- Alice boots her VM without realizing that the image has changed.
It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.
### Affected Services / Software ###
Glance, Liberty, Mitaka, Newton
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-25: |  |  | [#25](/glance/%2Bbug/1593799/comments/25) |
| --- | --- | --- | --- |

A nit, otherwise looks good.

Worth mentioning that:-

Mallory and(or) Bob doesn't need to use the sharing workflow if "publicizing" images is allowed by policy in the cloud deployment.

Thanks for working with us patiently on this, Travis!

A nit, otherwise looks good.
Worth mentioning that:-
Mallory and(or) Bob doesn't need to use the sharing workflow if "publicizing" images is allowed by policy in the cloud deployment.
Thanks for working with us patiently on this, Travis!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-25: |  |  | [#26](/glance/%2Bbug/1593799/comments/26) |
| --- | --- | --- | --- |

Good point (and my pleasure about working with you on the note!)

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X which has been shared

 with her by a trusted party, Bob.

 - Bob (image X's owner) deletes the image. As per design, Alice

 receives no notification this happened.

 - Mallory creates a new image and specifies that the ID should be X.

 - Mallory shares image X with Alice. Again, per design, Alice is not

 notified of this change.

 - Alice boots her VM without realizing that the image has changed.

It's worth noting that in this scenario Mallory needs to know Alice's

project ID to share the new image with Alice. This isn't enough to

mitigate the issue as project IDs weren't designed to be confidential.

If the environment allows non-administrators to publish images Mallory

doesn't have to explicitly share with Alice or know her project ID.

### Affected Services / Software ###

Glance, Liberty, Mitaka, Newton

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged. It is

however safe to delete rows from `image\_properties`, `image\_tags`,

`image\_members`, and `image\_locations` tables.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

Good point (and my pleasure about working with you on the note!)
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X which has been shared
with her by a trusted party, Bob.
- Bob (image X's owner) deletes the image. As per design, Alice
receives no notification this happened.
- Mallory creates a new image and specifies that the ID should be X.
- Mallory shares image X with Alice. Again, per design, Alice is not
notified of this change.
- Alice boots her VM without realizing that the image has changed.
It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.
If the environment allows non-administrators to publish images Mallory
doesn't have to explicitly share with Alice or know her project ID.
### Affected Services / Software ###
Glance, Liberty, Mitaka, Newton
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-26: |  |  | [#27](/glance/%2Bbug/1593799/comments/27) |
| --- | --- | --- | --- |

This sentence looks rather incomplete:

"If the environment allows non-administrators to publish images Mallory

doesn't have to explicitly share with Alice or know her project ID."

was it intentional?

This sentence looks rather incomplete:
"If the environment allows non-administrators to publish images Mallory
doesn't have to explicitly share with Alice or know her project ID."
was it intentional?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-26: |  |  | [#28](/glance/%2Bbug/1593799/comments/28) |
| --- | --- | --- | --- |

Good catch, how about this?

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X which has been shared

 with her by a trusted party, Bob.

 - Bob (image X's owner) deletes the image. As per design, Alice

 receives no notification this happened.

 - Mallory creates a new image and specifies that the ID should be X.

 - Mallory shares image X with Alice. Again, per design, Alice is not

 notified of this change.

 - Alice boots her VM without realizing that the image has changed.

It's worth noting that in this scenario Mallory needs to know Alice's

project ID to share the new image with Alice. This isn't enough to

mitigate the issue as project IDs weren't designed to be confidential.

Also, if the environment allows non-administrators to publish images,

Mallory doesn't have to explicitly share with Alice or know her project

ID to perform this attack.

### Affected Services / Software ###

Glance, Liberty, Mitaka, Newton

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged. It is

however safe to delete rows from `image\_properties`, `image\_tags`,

`image\_members`, and `image\_locations` tables.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

Good catch, how about this?
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X which has been shared
with her by a trusted party, Bob.
- Bob (image X's owner) deletes the image. As per design, Alice
receives no notification this happened.
- Mallory creates a new image and specifies that the ID should be X.
- Mallory shares image X with Alice. Again, per design, Alice is not
notified of this change.
- Alice boots her VM without realizing that the image has changed.
It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.
Also, if the environment allows non-administrators to publish images,
Mallory doesn't have to explicitly share with Alice or know her project
ID to perform this attack.
### Affected Services / Software ###
Glance, Liberty, Mitaka, Newton
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-26: |  |  | [#29](/glance/%2Bbug/1593799/comments/29) |
| --- | --- | --- | --- |

This looks good to me, Travis. Thanks!

This looks good to me, Travis. Thanks!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-08-29: |  |  | [#30](/glance/%2Bbug/1593799/comments/30) |
| --- | --- | --- | --- |

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance db purge` utility or manually by an administrator.

`glance-manage db purge` This is not functionality of python-glanceclient but glance-manage admin tool.

Other than that looks good to me on latest rev.

### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance db purge` utility or manually by an administrator.
`glance-manage db purge` This is not functionality of python-glanceclient but glance-manage admin tool.
Other than that looks good to me on latest rev.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-29: |  |  | [#31](/glance/%2Bbug/1593799/comments/31) |
| --- | --- | --- | --- |

Erno is completely correct, the command should be 'glance-manage db purge'. With that correction, I think the proposed text is fine.

Erno is completely correct, the command should be 'glance-manage db purge'. With that correction, I think the proposed text is fine.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-29: |  |  | [#32](/glance/%2Bbug/1593799/comments/32) |
| --- | --- | --- | --- |

Good catch Erno.

On a second or may be third thought :) --

"""

### Affected Services / Software ###

Glance, Liberty, Mitaka, Newton

"""

I wonder if we should have this as :-

"""

### Affected Services / Software ###

Glance, Liberty onward.

Glance team isn't planning on removing this purge feature yet. If you would like to see it removed please propose the same to the developers or if you are monitoring if this is (will be) removed, then please read the release notes of that release.

"""

The reason is, if we simply list out releases "Glance, Liberty, Mitaka, Newton" then this note will / may become outdated in Ocata.

Thoughts?

Good catch Erno.
On a second or may be third thought :) --
"""
### Affected Services / Software ###
Glance, Liberty, Mitaka, Newton
"""
I wonder if we should have this as :-
"""
### Affected Services / Software ###
Glance, Liberty onward.
Glance team isn't planning on removing this purge feature yet. If you would like to see it removed please propose the same to the developers or if you are monitoring if this is (will be) removed, then please read the release notes of that release.
"""
The reason is, if we simply list out releases "Glance, Liberty, Mitaka, Newton" then this note will / may become outdated in Ocata.
Thoughts?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-29: |  |  | [#33](/glance/%2Bbug/1593799/comments/33) |
| --- | --- | --- | --- |

Move up the level to critical -- as per the latest description the issue is pretty convoluted.

Move up the level to critical -- as per the latest description the issue is pretty convoluted.

| Changed in glance: | |
| --- | --- |
| **importance**: | High → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-29: |  |  | [#34](/glance/%2Bbug/1593799/comments/34) |
| --- | --- | --- | --- |

Thanks Nikhil. I've listed them this way because it's our standard format for notes, although you're right about the issue where notes become outdated :|

Thanks Nikhil. I've listed them this way because it's our standard format for notes, although you're right about the issue where notes become outdated :|

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-29: |  |  | [#35](/glance/%2Bbug/1593799/comments/35) |
| --- | --- | --- | --- |

(hopefully) last version:

Deleted Glance image IDs may be reassigned

---

### Summary ###

It is possible for image IDs from deleted images to be reassigned to

other images. This creates the possibility that:

- Alice creates a VM that boots from image ID X which has been shared

 with her by a trusted party, Bob.

 - Bob (image X's owner) deletes the image. As per design, Alice

 receives no notification this happened.

 - Mallory creates a new image and specifies that the ID should be X.

 - Mallory shares image X with Alice. Again, per design, Alice is not

 notified of this change.

 - Alice boots her VM without realizing that the image has changed.

It's worth noting that in this scenario Mallory needs to know Alice's

project ID to share the new image with Alice. This isn't enough to

mitigate the issue as project IDs weren't designed to be confidential.

Also, if the environment allows non-administrators to publish images,

Mallory doesn't have to explicitly share with Alice or know her project

ID to perform this attack.

### Affected Services / Software ###

Glance, Liberty, Mitaka, Newton

### Discussion ###

Glance's image table doesn't maintain a list of previously used image

IDs. Previously assigned image IDs will be listed in the image table

as deleted, but these records may be removed (for performance reasons)

with the `glance-manage db purge` utility or manually by an

administrator.

If these records are removed a malicious user may intentionally upload

a new image using the same ID (Glance allows an image creator to

optionally specify the image ID). This would cause any victim

instances referencing the ID to use an attacker supplied image.

### Recommended Actions ###

The combination of purged Glance database entries and non-admin image

upload is dangerous. In environments where normal users are permitted

to upload images, the `images` table should not be purged. It is

however safe to delete rows from `image\_properties`, `image\_tags`,

`image\_members`, and `image\_locations` tables.

### Contacts / References ###

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : <email address hidden>

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

(hopefully) last version:
Deleted Glance image IDs may be reassigned
---
### Summary ###
It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:
- Alice creates a VM that boots from image ID X which has been shared
with her by a trusted party, Bob.
- Bob (image X's owner) deletes the image. As per design, Alice
receives no notification this happened.
- Mallory creates a new image and specifies that the ID should be X.
- Mallory shares image X with Alice. Again, per design, Alice is not
notified of this change.
- Alice boots her VM without realizing that the image has changed.
It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.
Also, if the environment allows non-administrators to publish images,
Mallory doesn't have to explicitly share with Alice or know her project
ID to perform this attack.
### Affected Services / Software ###
Glance, Liberty, Mitaka, Newton
### Discussion ###
Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance-manage db purge` utility or manually by an
administrator.
If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.
### Recommended Actions ###
The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.
### Contacts / References ###
Author: Travis McPeak, IBM
This OSSN : https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Original LaunchPad Bug : https://bugs.launchpad.net/glance/+bug/1593799/
OpenStack Security ML : openstack-security@lists.openstack.org
OpenStack Security Group : https://launchpad.net/~openstack-ossg

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-29: |  |  | [#36](/glance/%2Bbug/1593799/comments/36) |
| --- | --- | --- | --- |

LGTM! Thanks, Travis.

LGTM! Thanks, Travis.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-29: |  |  | [#37](/glance/%2Bbug/1593799/comments/37) |
| --- | --- | --- | --- |

Cool - I'll get with VMT later today for a refresher on how to send this out :)

Cool - I'll get with VMT later today for a refresher on how to send this out :)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-29: |  |  | [#38](/glance/%2Bbug/1593799/comments/38) |
| --- | --- | --- | --- |

Thanks, this works for me too.

Great work and thanks for your patience Travis!

Thanks, this works for me too.
Great work and thanks for your patience Travis!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Erno Kuvaja (jokke)](https://launchpad.net/~jokke) wrote on 2016-08-30: |  |  | [#39](/glance/%2Bbug/1593799/comments/39) |
| --- | --- | --- | --- |

LGTM, Thanks Travis!

LGTM, Thanks Travis!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-31: |  |  | [#40](/glance/%2Bbug/1593799/comments/40) |
| --- | --- | --- | --- |

Added Stuart as he wants to pitch in. Please hold off on sending note until we get his vetted advice.

Added Stuart as he wants to pitch in. Please hold off on sending note until we get his vetted advice.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-31: |  |  | [#41](/glance/%2Bbug/1593799/comments/41) |
| --- | --- | --- | --- |

+1 to adding Stuart, it will be worth the wait.

+1 to adding Stuart, it will be worth the wait.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-08-31: |  |  | [#42](/glance/%2Bbug/1593799/comments/42) |
| --- | --- | --- | --- |

Sorry guys, I thought this was ready to go. I already sent a copy to stakeholders. We've got an embargo date of 9/13.

Sorry guys, I thought this was ready to go. I already sent a copy to stakeholders. We've got an embargo date of 9/13.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2016-08-31: |  |  | [#43](/glance/%2Bbug/1593799/comments/43) |
| --- | --- | --- | --- |

Well, you did have three +2s on your proposed text! Still curious to hear Stuart's thoughts, though.

Well, you did have three +2s on your proposed text! Still curious to hear Stuart's thoughts, though.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-08-31: |  |  | [#44](/glance/%2Bbug/1593799/comments/44) |
| --- | --- | --- | --- |

No worries Travis (+1 to what Brian said in comment #43).

No worries Travis (+1 to what Brian said in comment #43).

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stuart McLaren (stuart-mclaren)](https://launchpad.net/~stuart-mclaren) wrote on 2016-09-01: |  |  | [#45](/glance/%2Bbug/1593799/comments/45) |
| --- | --- | --- | --- |

This is a good catch (kicking myself I didn't see it).

We probably don't want a major rewrite of the wording at this point.

If it's possible to make one change I think "publish" in this sentence is not well defined:

"if the environment allows non-administrators to publish images"

Really, we want "publicize" or "create public images" here, because some people will probably interpret "publish" as regular create or upload. I'd like to see this changed if it's possible.

Less importantly, image sharing is also controlled by policy (we actually disable it by default) so if you also have it disabled you're unaffected. We could add an equivalent "if the environment allows image sharing". (Though this is probably fairly obvious).

For any future notifications it may be good practice to explicitly name the various policies ("publicize\_image"/"add\_member") we may be implying.

Would it be worthwhile to update the db purge code? (If so, I may be able to find a volunteer.)

Thanks.

This is a good catch (kicking myself I didn't see it).
We probably don't want a major rewrite of the wording at this point.
If it's possible to make one change I think "publish" in this sentence is not well defined:
"if the environment allows non-administrators to publish images"
Really, we want "publicize" or "create public images" here, because some people will probably interpret "publish" as regular create or upload. I'd like to see this changed if it's possible.
Less importantly, image sharing is also controlled by policy (we actually disable it by default) so if you also have it disabled you're unaffected. We could add an equivalent "if the environment allows image sharing". (Though this is probably fairly obvious).
For any future notifications it may be good practice to explicitly name the various policies ("publicize\_image"/"add\_member") we may be implying.
Would it be worthwhile to update the db purge code? (If so, I may be able to find a volunteer.)
Thanks.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Stuart McLaren (stuart-mclaren)](https://launchpad.net/~stuart-mclaren) wrote on 2016-09-01: |  |  | [#46](/glance/%2Bbug/1593799/comments/46) |
| --- | --- | --- | --- |

Clarification: "we actually disable it by default": By "we" here I meant HPE -- the upstream default is for sharing to be enabled.

Clarification: "we actually disable it by default": By "we" here I meant HPE -- the upstream default is for sharing to be enabled.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-09-01: |  |  | [#47](/glance/%2Bbug/1593799/comments/47) |
| --- | --- | --- | --- |

>> Would it be worthwhile to update the db purge code? (If so, I may be able to find a volunteer.)

I think having some changes done would be a good addition. However, what those changes are and the effects/side-effects of the same may need to be discussed with some operators who were strongly pro this db purge feature. I believe a spec is a good starting point.

>> Would it be worthwhile to update the db purge code? (If so, I may be able to find a volunteer.)
I think having some changes done would be a good addition. However, what those changes are and the effects/side-effects of the same may need to be discussed with some operators who were strongly pro this db purge feature. I believe a spec is a good starting point.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Nikhil Komawar (nikhil-komawar)](https://launchpad.net/~nikhil-komawar) wrote on 2016-09-01: |  |  | [#48](/glance/%2Bbug/1593799/comments/48) |
| --- | --- | --- | --- |

(thanks for the review and input, Stuart)

(thanks for the review and input, Stuart)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Travis McPeak (travis-mcpeak)](https://launchpad.net/~travis-mcpeak) wrote on 2016-09-01: |  |  | [#49](/glance/%2Bbug/1593799/comments/49) |
| --- | --- | --- | --- |

Cool, we can easily modify the contents of the note once it is out of embargo September 13th. I didn't understand the publish/publicize differences, learn something new e'ryday :) .

Cool, we can easily modify the contents of the note once it is out of embargo September 13th. I didn't understand the publish/publicize differences, learn something new e'ryday :) .

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Luke Hinds (lhinds)](https://launchpad.net/~lhinds) wrote on 2016-09-15: |  |  | [#50](/glance/%2Bbug/1593799/comments/50) |
| --- | --- | --- | --- |

OSSN-0075 released:

<https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Is everyone ok if we make this bug public now?

OSSN-0075 released:
https://wiki.openstack.org/wiki/OSSN/OSSN-0075
Is everyone ok if we make this bug public now?

| Changed in ossn: | |
| --- | --- |
| **status**: | Confirmed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Jeremy Stanley (fungi)](https://launchpad.net/~fungi) wrote on 2016-09-15: |  |  | [#51](/glance/%2Bbug/1593799/comments/51) |
| --- | --- | --- | --- |

Yes, ideally it should have been switched to public (and a bug tag of "security" added) prior to distributing the OSSN, so that those reading it could make use of the bug link it contained.

I'll go ahead and do that now.

Yes, ideally it should have been switched to public (and a bug tag of "security" added) prior to distributing the OSSN, so that those reading it could make use of the bug link it contained.
I'll go ahead and do that now.

| **information type**: | Private Security → Public |
| --- | --- |
| **tags**: | added: security |

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-09-16

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Luke Hinds (lhinds)](https://launchpad.net/~lhinds) wrote on 2016-09-16: |  |  | [#52](/glance/%2Bbug/1593799/comments/52) |
| --- | --- | --- | --- |

Thanks Jeremy, I have this noted for next time.

Thanks Jeremy, I have this noted for next time.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Brian Rosmaita (brian-rosmaita)](https://launchpad.net/~brian-rosmaita) wrote on 2018-08-17: |  |  | [#53](/glance/%2Bbug/1593799/comments/53) |
| --- | --- | --- | --- |

The fix is in Rocky:

spec: <https://specs.openstack.org/openstack/glance-specs/specs/rocky/implemented/glance/mitigate-ossn-0075.html>

code: <http://git.openstack.org/cgit/openstack/glance/commit/?h=stable/rocky&id=5cc9d999352c21d3f4b5c39d3ea9d4378ca86544>

docs: <http://git.openstack.org/cgit/openstack/glance/commit/?h=stable/rocky&id=23d4e0e9c07f1ff6646e2f6236ee9625abd2a5cb>

The fix is in Rocky:
spec: https://specs.openstack.org/openstack/glance-specs/specs/rocky/implemented/glance/mitigate-ossn-0075.html
code: http://git.openstack.org/cgit/openstack/glance/commit/?h=stable/rocky&id=5cc9d999352c21d3f4b5c39d3ea9d4378ca86544
docs: http://git.openstack.org/cgit/openstack/glance/commit/?h=stable/rocky&id=23d4e0e9c07f1ff6646e2f6236ee9625abd2a5cb

| Changed in glance: | |
| --- | --- |
| **status**: | Confirmed → Fix Released |

[See full activity log](https://bugs.launchpad.net/glance/%2Bbug/1593799/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/glance/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/glance/%2Bbug/1593799/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/glance/%2Bbug/1593799/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/glance/%2Bbug/1593799/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from h20566.www2.hpe.com_b3892c4c_20250125_083152.html ===




=== Content from wiki.openstack.org_8dcaeb55_20250125_083157.html ===


* [![OpenStack](https://wiki.openstack.org/w/images/thumb/c/c4/OpenStack_Logo_-_notext.png/30px-OpenStack_Logo_-_notext.png)](/wiki/Main_Page "Visit the main page")

* Page
  + [Page](/wiki/OSSN/OSSN-0075 "View the content page [c]")
  + [Discussion](/w/index.php?title=Talk:OSSN/OSSN-0075&action=edit&redlink=1 "Discussion about the content page [t]")
  + [View source](/w/index.php?title=OSSN/OSSN-0075&action=edit "This page is protected.
    You can view its source [e]")
  + [History](/w/index.php?title=OSSN/OSSN-0075&action=history "Past revisions of this page [h]")

* Print/export
  + [Create a book](/w/index.php?title=Special:Book&bookcmd=book_creator&referer=OSSN%2FOSSN-0075)
  + [Download as PDF](/w/index.php?title=Special:Book&bookcmd=render_article&arttitle=OSSN%2FOSSN-0075&returnto=OSSN%2FOSSN-0075&oldid=132937&writer=rl)
  + [Printable version](/w/index.php?title=OSSN/OSSN-0075&printable=yes "Printable version of this page [p]")

* Tools
  + [Page information](/w/index.php?title=OSSN/OSSN-0075&action=info "More information about this page")
  + [Permanent link](/w/index.php?title=OSSN/OSSN-0075&oldid=132937 "Permanent link to this revision of the page")
  + [Special pages](/wiki/Special%3ASpecialPages "A list of all special pages [q]")
  + [Related changes](/wiki/Special%3ARecentChangesLinked/OSSN/OSSN-0075 "Recent changes in pages linked from this page [k]")
  + [What links here](/wiki/Special%3AWhatLinksHere/OSSN/OSSN-0075 "A list of all wiki pages that link here [j]")

* * [Create account](/w/index.php?title=Special:CreateAccount&returnto=OSSN%2FOSSN-0075 "You are encouraged to create an account and log in; however, it is not mandatory")
* * [Log in](/w/index.php?title=Special:UserLogin&returnto=OSSN%2FOSSN-0075 "You are encouraged to log in; however, it is not mandatory [o]")
* * [Log in / create account with OpenID](/w/index.php?title=Special:OpenIDLogin&returnto=OSSN/OSSN-0075)
* + English

* [Home](http://www.openstack.org)
* [Software](http://www.openstack.org/software)
* [User Stories](http://www.openstack.org/user-stories)
* [Community](http://www.openstack.org/community)
* [Profile](http://www.openstack.org/profile)
* [Blog](http://www.openstack.org/blog)
* [Wiki](http://wiki.openstack.org)
* [Documentation](http://docs.openstack.org)

Jump to: [navigation](#mw-head),
[search](#p-search)

# OSSN/OSSN-0075

< [OSSN](/wiki/OSSN "OSSN")

## Deleted Glance image IDs may be reassigned

### Summary

It is possible for image IDs from deleted images to be reassigned to
other images. This creates the possibility that:

* Alice creates a VM that boots from image ID X which has been shared with her by a trusted party, Bob.
* Bob (image X's owner) deletes the image. As per design, Alice receives no notification this happened.
* Mallory creates a new image and specifies that the ID should be X.
* Mallory shares image X with Alice. Again, per design, Alice is not notified of this change.
* Alice boots her VM without realizing that the image has changed.

It's worth noting that in this scenario Mallory needs to know Alice's
project ID to share the new image with Alice. This isn't enough to
mitigate the issue as project IDs weren't designed to be confidential.

Also, if the environment allows non-administrators to publish images,
Mallory doesn't have to explicitly share with Alice or know her project
ID to perform this attack.

### Affected Services / Software

Glance, Liberty, Mitaka, Newton

### Discussion

Glance's image table doesn't maintain a list of previously used image
IDs. Previously assigned image IDs will be listed in the image table
as deleted, but these records may be removed (for performance reasons)
with the `glance-manage db purge` utility or manually by an
administrator.

If these records are removed a malicious user may intentionally upload
a new image using the same ID (Glance allows an image creator to
optionally specify the image ID). This would cause any victim
instances referencing the ID to use an attacker supplied image.

### Recommended Actions

The combination of purged Glance database entries and non-admin image
upload is dangerous. In environments where normal users are permitted
to upload images, the `images` table should not be purged. It is
however safe to delete rows from `image\_properties`, `image\_tags`,
`image\_members`, and `image\_locations` tables.

### Contacts / References

Author: Travis McPeak, IBM

This OSSN : <https://wiki.openstack.org/wiki/OSSN/OSSN-0075>

Original LaunchPad Bug : [https://bugs.launchpad.net/glance/+bug/1593799/](https://bugs.launchpad.net/glance/%2Bbug/1593799/)

OpenStack Security ML : openstack-security@lists.openstack.org

OpenStack Security Group : <https://launchpad.net/~openstack-ossg>

Retrieved from "<https://wiki.openstack.org/w/index.php?title=OSSN/OSSN-0075&oldid=132937>"

* [Privacy policy](/wiki/OpenStack%3APrivacy_policy "OpenStack:Privacy policy")
* [About OpenStack](/wiki/OpenStack%3AAbout "OpenStack:About")
* [Disclaimers](/wiki/OpenStack%3AGeneral_disclaimer "OpenStack:General disclaimer")

* [![Attribution 3.0 Unported (CC BY 3.0)](/w/resources/assets/licenses/cc-by.png)](http://creativecommons.org/licenses/by/3.0/)
* [![Powered by MediaWiki](/w/resources/assets/poweredby_mediawiki_88x31.png)](//www.mediawiki.org/)


