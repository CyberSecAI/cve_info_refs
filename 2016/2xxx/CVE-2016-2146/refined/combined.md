=== Content from github.com_d2423264_20250125_034519.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FUNINETT%2Fmod_auth_mellon%2Fpull%2F71)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FUNINETT%2Fmod_auth_mellon%2Fpull%2F71)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=Uninett%2Fmod_auth_mellon)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Jan 28, 2020. It is now read-only.

[Uninett](/Uninett)
/
**[mod\_auth\_mellon](/Uninett/mod_auth_mellon)**
Public archive

* [Notifications](/login?return_to=%2FUninett%2Fmod_auth_mellon) You must be signed in to change notification settings
* [Fork
  181](/login?return_to=%2FUninett%2Fmod_auth_mellon)
* [Star
   208](/login?return_to=%2FUninett%2Fmod_auth_mellon)

* [Code](/Uninett/mod_auth_mellon)
* [Issues
  0](/Uninett/mod_auth_mellon/issues)
* [Pull requests
  0](/Uninett/mod_auth_mellon/pulls)
* [Actions](/Uninett/mod_auth_mellon/actions)
* [Projects
  0](/Uninett/mod_auth_mellon/projects)
* [Wiki](/Uninett/mod_auth_mellon/wiki)
* [Security](/Uninett/mod_auth_mellon/security)
* [Insights](/Uninett/mod_auth_mellon/pulse)

Additional navigation options

* [Code](/Uninett/mod_auth_mellon)
* [Issues](/Uninett/mod_auth_mellon/issues)
* [Pull requests](/Uninett/mod_auth_mellon/pulls)
* [Actions](/Uninett/mod_auth_mellon/actions)
* [Projects](/Uninett/mod_auth_mellon/projects)
* [Wiki](/Uninett/mod_auth_mellon/wiki)
* [Security](/Uninett/mod_auth_mellon/security)
* [Insights](/Uninett/mod_auth_mellon/pulse)

# Handle ap\_get\_client\_block() error in am\_read\_post\_data() #71

 Merged

[olavmrk](/olavmrk)
merged 1 commit into
[Uninett:master](/Uninett/mod_auth_mellon/tree/master "Uninett/mod_auth_mellon:master")
from
[vrasneur:am\_read\_post\_data-segfault](/vrasneur/mod_auth_mellon/tree/am_read_post_data-segfault "vrasneur/mod_auth_mellon:am_read_post_data-segfault")

Mar 2, 2016

 Merged

# [Handle ap\_get\_client\_block() error in am\_read\_post\_data()](#top) #71

[olavmrk](/olavmrk)
merged 1 commit into
[Uninett:master](/Uninett/mod_auth_mellon/tree/master "Uninett/mod_auth_mellon:master")
from
[vrasneur:am\_read\_post\_data-segfault](/vrasneur/mod_auth_mellon/tree/am_read_post_data-segfault "vrasneur/mod_auth_mellon:am_read_post_data-segfault")

Mar 2, 2016

[Conversation
7](/Uninett/mod_auth_mellon/pull/71)
[Commits
1](/Uninett/mod_auth_mellon/pull/71/commits)
[Checks
0](/Uninett/mod_auth_mellon/pull/71/checks)
[Files changed](/Uninett/mod_auth_mellon/pull/71/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![vrasneur](https://avatars.githubusercontent.com/u/8555503?s=60&v=4)](/vrasneur)

Copy link

### @vrasneur **[vrasneur](/vrasneur)** commented [Mar 2, 2016](#issue-137831230)

Hello,

I had the same segmentation fault as in the issue [#48](https://github.com/Uninett/mod_auth_mellon/issues/48).

Here is a patch that should fix the segfault: am\_read\_post\_data() should check if ap\_get\_client\_block() returns an error.

The patch also fixes a possible underflow in am\_read\_post\_data() if mod\_auth\_mellon receives too much POST data. I have not checked if it is possible to trigger that underflow.

Regards,

Vincent Rasneur

Software security engineer, DenyAll

vrasneur@denyall.com

Sorry, something went wrong.

All reactions

![olavmrk](https://avatars.githubusercontent.com/u/349658?s=60&v=4)

 **[olavmrk](/olavmrk)**
reviewed
[Mar 2, 2016](#discussion-diff-54728670)
 [View reviewed changes](/Uninett/mod_auth_mellon/pull/71/files/52ef7cbd79f76407dc521188fa1e7c3eb3727c5d#diff-c40c9826e9cdc348dd2c0c7fba74725e226d9347ae8aed72b565fba99055da33)

[auth\_mellon\_util.c](/Uninett/mod_auth_mellon/pull/71/files#diff-c40c9826e9cdc348dd2c0c7fba74725e226d9347ae8aed72b565fba99055da33)

|  |  | ap\_log\_rerror(APLOG\_MARK, APLOG\_ERR, 0, r, |
| --- | --- | --- |
|  |  | "Failed to read POST data from client."); |
|  |  | return HTTP\_INTERNAL\_SERVER\_ERROR; |
|  |  | } |
|  |  | else if ((apr\_size\_t)read\_length > bytes\_left) { |

Copy link

Contributor

### @olavmrk **[olavmrk](/olavmrk)** [Mar 2, 2016](#discussion_r54728670)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Could you clarify this a bit -- in what cases will `ap_get_client_block` return more than `bytes_left`?

From the [documentation](https://github.com/apache/httpd/blob/2.4.18/include/http_protocol.h#L494), it looks like it shouldn't do that:

```
/**
 * Call this in a loop.  It will put data into a buffer and return the length
 * of the input block
 * @param r The current request
 * @param buffer The buffer in which to store the data
 * @param bufsiz The size of the buffer
 * @return Number of bytes inserted into the buffer.  When done reading, 0
 *         if EOF, or -1 if there was an error
 */

```

Sorry, something went wrong.

All reactions

[![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=80&v=4)](/olavmrk)

Copy link

Contributor

### **[olavmrk](/olavmrk)** commented [Mar 2, 2016](#issuecomment-191266002)

| Thanks for looking into this!  You are right that we need to handle errors condition from `ap_get_client_block()`. The failure mode is a bit interesting -- as far as I can tell, we will repeatedly call `ap_get_client_block()` with an ever-larger read request. Not sure how many iterations are required before it crashes though.  I do strongly suspect that it crashes on the second iteration, since at that point we are asking Apache to read from something that has already returned an error.  Looking at the code, I think we also need to put an upper bound to the number of bytes that we are willing to read, but I think that belongs in a separate patch. |
| --- |

All reactions

Sorry, something went wrong.

![olavmrk](https://avatars.githubusercontent.com/u/349658?s=60&v=4)

 **[olavmrk](/olavmrk)**
reviewed
[Mar 2, 2016](#discussion-diff-54731955)
 [View reviewed changes](/Uninett/mod_auth_mellon/pull/71/files/52ef7cbd79f76407dc521188fa1e7c3eb3727c5d#diff-c40c9826e9cdc348dd2c0c7fba74725e226d9347ae8aed72b565fba99055da33)

[auth\_mellon\_util.c](/Uninett/mod_auth_mellon/pull/71/files#diff-c40c9826e9cdc348dd2c0c7fba74725e226d9347ae8aed72b565fba99055da33)

|  |  | \*/ |
| --- | --- | --- |
|  |  | read\_length = ap\_get\_client\_block(r, &(\*data)[bytes\_read], |
|  |  | bytes\_left); |
|  |  | if (read\_length == 0) { |
|  |  | // got the EOF |
|  |  | break; |

Copy link

Contributor

### @olavmrk **[olavmrk](/olavmrk)** [Mar 2, 2016](#discussion_r54731955)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Now that getting an "early" EOF (before we get the expected number of bytes) isn't an error, I think the code needs to adjust a couple of things:

* Add a null terminator (like is done at [line 570](https://github.com/UNINETT/mod_auth_mellon/pull/71/files#diff-e746ce33fcd1ce691925112f3a4be984R570)).
* Update `length` with the actual number of bytes read (as on [line 564](https://github.com/UNINETT/mod_auth_mellon/pull/71/files#diff-e746ce33fcd1ce691925112f3a4be984R564)).

Sorry, something went wrong.

All reactions

[![@vrasneur](https://avatars.githubusercontent.com/u/8555503?s=80&v=4)](/vrasneur)

Copy link

Author

### **[vrasneur](/vrasneur)** commented [Mar 2, 2016](#issuecomment-191269405)

| Hi olavmrk,  As I have said, I did not check if the underflow is triggerable. The main fix is to check for the ap\_get\_client\_block() error.  For the crash, when ap\_get\_client\_block() returns -1, the loop in mod\_auth\_mellon will allocate an "infinite" number of empty bucket brigades.  On my coredump, you could see that Apache had created approximately 451,000,000 empty brigades before crashing ;-) |
| --- |

All reactions

Sorry, something went wrong.

[![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=80&v=4)](/olavmrk)

Copy link

Contributor

### **[olavmrk](/olavmrk)** commented [Mar 2, 2016](#issuecomment-191275707)

| As I have said, I did not check if the underflow is triggerable. The main fix is to check for the ap\_get\_client\_block() error.  I don't think it can ever happen (`ap_get_client_block()` returning more data than requested) , so I'd remove that condition. Leaving it in will only lead to confusion for future generations.  For the crash, when ap\_get\_client\_block() returns -1, the loop in mod\_auth\_mellon will allocate an "infinite" number of empty bucket brigades.  OK, that is good to know. Then this crashes the web server process, but doesn't allow for overwriting arbitrary data.  Could you amend your patch with:   * The check for `(apr_size_t)read_length > bytes_left` removed. * Adjustments of `length` and null terminator on early EOF. |
| --- |

All reactions

Sorry, something went wrong.

`[Handle ap_get_client_block() error in am_read_post_data()](/Uninett/mod_auth_mellon/pull/71/commits/5f03a632c9652687c7dac1ea44f334b9983ab268 "Handle ap_get_client_block() error in am_read_post_data()")`

`[5f03a63](/Uninett/mod_auth_mellon/pull/71/commits/5f03a632c9652687c7dac1ea44f334b9983ab268)`

 [![@vrasneur](https://avatars.githubusercontent.com/u/8555503?s=40&v=4)](/vrasneur)
[vrasneur](/vrasneur)
[force-pushed](/Uninett/mod_auth_mellon/compare/c09d29d481aa2dacacf056fcbdd18019dc8dba5c..5f03a632c9652687c7dac1ea44f334b9983ab268)
the
am\_read\_post\_data-segfault

branch
from
[`c09d29d`](/Uninett/mod_auth_mellon/commit/c09d29d481aa2dacacf056fcbdd18019dc8dba5c) to
[`5f03a63`](/Uninett/mod_auth_mellon/commit/5f03a632c9652687c7dac1ea44f334b9983ab268)  [Compare](/Uninett/mod_auth_mellon/compare/c09d29d481aa2dacacf056fcbdd18019dc8dba5c..5f03a632c9652687c7dac1ea44f334b9983ab268)
[March 2, 2016 15:45](#event-574843619)

[![@vrasneur](https://avatars.githubusercontent.com/u/8555503?s=80&v=4)](/vrasneur)

Copy link

Author

### **[vrasneur](/vrasneur)** commented [Mar 2, 2016](#issuecomment-191295626)

| I have updated the patch.  Is it OK for you? |
| --- |

All reactions

Sorry, something went wrong.

[olavmrk](/olavmrk)
added a commit
that referenced
this pull request
[Mar 2, 2016](#ref-commit-ccb7dc3)
[![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=40&v=4)](/olavmrk)

`[Merge pull request](/Uninett/mod_auth_mellon/commit/ccb7dc35b941667122e02d5e81a52e2e4718ccee "Merge pull request #71 from vrasneur/am_read_post_data-segfault

Handle ap_get_client_block() error in am_read_post_data()") [#71](https://github.com/Uninett/mod_auth_mellon/pull/71) [from vrasneur/am_read_post_data-segfault](/Uninett/mod_auth_mellon/commit/ccb7dc35b941667122e02d5e81a52e2e4718ccee "Merge pull request #71 from vrasneur/am_read_post_data-segfault

Handle ap_get_client_block() error in am_read_post_data()")`
…

`[ccb7dc3](/Uninett/mod_auth_mellon/commit/ccb7dc35b941667122e02d5e81a52e2e4718ccee)`

```
Handle ap_get_client_block() error in am_read_post_data()
```

[![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=40&v=4)](/olavmrk)
[olavmrk](/olavmrk)
merged commit [`ccb7dc3`](/Uninett/mod_auth_mellon/commit/ccb7dc35b941667122e02d5e81a52e2e4718ccee)
into
Uninett:master

[Mar 2, 2016](https://github.com/Uninett/mod_auth_mellon/pull/71#event-574911731)

[![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=80&v=4)](/olavmrk)

Copy link

Contributor

### **[olavmrk](/olavmrk)** commented [Mar 2, 2016](#issuecomment-191313599)

| Yes, thanks! |
| --- |

All reactions

Sorry, something went wrong.

[jhrozek](/jhrozek)
added a commit
to jhrozek/mod\_auth\_mellon
that referenced
this pull request
[Jul 29, 2021](#ref-commit-fbeb6c0)
[![@jhrozek](https://avatars.githubusercontent.com/u/715522?s=40&u=9f19e11e146235c272f7879b89190411b3523e94&v=4)](/jhrozek)

`[Prepare mellon release 0.18.0](/jhrozek/mod_auth_mellon/commit/fbeb6c038591644c24f9048839d8a9b1137c43c8 "Prepare mellon release 0.18.0

Resolves: #71")`
…

`[fbeb6c0](/jhrozek/mod_auth_mellon/commit/fbeb6c038591644c24f9048839d8a9b1137c43c8)`

```
Resolves: [Uninett#71](https://github.com/Uninett/mod_auth_mellon/pull/71)
```

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FUNINETT%2Fmod_auth_mellon%2Fpull%2F71).

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@vrasneur](https://avatars.githubusercontent.com/u/8555503?s=52&v=4)](/vrasneur) [![@olavmrk](https://avatars.githubusercontent.com/u/349658?s=52&v=4)](/olavmrk)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


