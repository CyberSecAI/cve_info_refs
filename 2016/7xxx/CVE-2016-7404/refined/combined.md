=== Content from idp-portal.suse.com_6b95d262_20250126_090936.html ===

## UCS

# Welcome to Univention Corporate Server

## JavaScript required

A browser with JavaScript enabled is required in order to use this service.

When using Internet Explorer, please check your security settings and add this address to your trusted sites.



=== Content from git.openstack.org_408cb2b4_20250126_090935.html ===

This website requires JavaScript.
[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
[Get Started](https://docs.opendev.org/opendev/infra-manual/latest/gettingstarted.html)

[openstack](/openstack)/[magnum](/openstack/magnum)

[Code](/openstack/magnum/src/branch/master)
[Issues](https://bugs.launchpad.net/magnum)
[Proposed changes](https://review.opendev.org/#/q/status:open+project:openstack/magnum)

### Fix CVE-2016-7404

[Browse Source](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22)

```
This commit addresses multiple potential vulnerabilities in
Magnum. It makes the following changes:

* Permissions for /etc/sysconfig/heat-params inside Magnum
  created instances are tightened to 0600 (used to be 0755).
* Certificate retrieval is modified to work without the need
  for a Keystone trust.
* The cluster's Keystone trust id is only passed into
  instances for clusters where that is actually needed. This
  prevents the trustee user from consuming the trust in cases
  where it is not needed.
* The configuration setting trust/cluster_user_trust (False by
  default) is introduced. It needs to be explicitely enabled
  by the cloud operator to allow clusters that need the
  trust_id to be passed into instances to work. Without this
  setting, attempts to create such clusters will fail.

Please note, that none of these changes apply to existing
clusters. They will have to be deleted and rebuilt to benefit
from these changes.

(cherry picked from commit e93d82e8b3bc19211efd54edc17aebdca50670c1)

Changes for backport:

* Moved cluster_user_trust setting to magnum/common/keystone.py
* Resolved merge conflicts.
* Fixed unit tests with configuration overrides.

Change-Id: I408d845ee4fd00d5bcd1e90f0a78f2bba3f2a57a
```
...

This commit is contained in:

![](/assets/img/avatar_default.png "johannes.grassler@suse.com")
parent
[d98d185817](/openstack/magnum/commit/d98d1858175d55b0f5c631b7bb798d5fb49dc91d)

commit
0bb0d6486d

 **26 changed files** with **171 additions** and **75 deletions**

[Show all changes](?style=unified&whitespace=show-all&show-outdated=)
[Ignore whitespace when comparing lines](?style=unified&whitespace=ignore-all&show-outdated=)
[Ignore changes in amount of whitespace](?style=unified&whitespace=ignore-change&show-outdated=)
[Ignore changes in whitespace at EOL](?style=unified&whitespace=ignore-eol&show-outdated=)

Show Stats
[Download Patch File](/openstack/magnum/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22.patch)
[Download Diff File](/openstack/magnum/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22.diff)
Expand all files
Collapse all files

#### 1 [devstack/lib/magnum](#diff-26caa71a2ba1ad2009d41145e47df1a559164cbb "devstack/lib/magnum") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/devstack/lib/magnum)

|  | |  |  | `@ -206,6 +206,7 @@ function create_magnum_conf {` |
|  |  |  |  | `--os-identity-api-version 3 role add \` |
|  |  |  |  | `--user $trustee_domain_admin_id --domain $trustee_domain_id \` |
|  |  |  |  | `admin` |
|  |  |  |  | `iniset $MAGNUM_CONF trust cluster_user_trust True` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_name magnum` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_admin_name trustee_domain_admin` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_admin_password $MAGNUM_TRUSTEE_DOMAIN_ADMIN_PASSWORD` |
|  | |  |  |  |

#### 54 [etc/magnum/policy.json](#diff-4790802fb3805cfc4221e17e7fc581cb81395ce9 "etc/magnum/policy.json") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/etc/magnum/policy.json)

|  | |  |  | `@ -4,35 +4,37 @@` |
|  |  |  |  | `"default": "rule:admin_or_owner",` |
|  |  |  |  | `"admin_api": "rule:context_is_admin",` |
|  |  |  |  | `"admin_or_user": "is_admin:True or user_id:%(user_id)s",` |
|  |  |  |  | `"cluster_user": "user_id:%(trustee_user_id)s",` |
|  |  |  |  | `"deny_cluster_user": "not domain_id:%(trustee_domain_id)s",` |
|  |  |  |  |  |
|  |  |  |  | `"bay:create": "rule:default",` |
|  |  |  |  | `"bay:delete": "rule:default",` |
|  |  |  |  | `"bay:detail": "rule:default",` |
|  |  |  |  | `"bay:get": "rule:default",` |
|  |  |  |  | `"bay:get_all": "rule:default",` |
|  |  |  |  | `"bay:update": "rule:default",` |
|  |  |  |  | `"bay:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:update": "rule:deny_cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"baymodel:create": "rule:default",` |
|  |  |  |  | `"baymodel:delete": "rule:default",` |
|  |  |  |  | `"baymodel:detail": "rule:default",` |
|  |  |  |  | `"baymodel:get": "rule:default",` |
|  |  |  |  | `"baymodel:get_all": "rule:default",` |
|  |  |  |  | `"baymodel:update": "rule:default",` |
|  |  |  |  | `"baymodel:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:update": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:publish": "rule:admin_or_owner",` |
|  |  |  |  |  |
|  |  |  |  | `"cluster:create": "rule:default",` |
|  |  |  |  | `"cluster:delete": "rule:default",` |
|  |  |  |  | `"cluster:detail": "rule:default",` |
|  |  |  |  | `"cluster:get": "rule:default",` |
|  |  |  |  | `"cluster:get_all": "rule:default",` |
|  |  |  |  | `"cluster:update": "rule:default",` |
|  |  |  |  | `"cluster:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:update": "rule:deny_cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"clustertemplate:create": "rule:default",` |
|  |  |  |  | `"clustertemplate:delete": "rule:default",` |
|  |  |  |  | `"clustertemplate:detail": "rule:default",` |
|  |  |  |  | `"clustertemplate:get": "rule:default",` |
|  |  |  |  | `"clustertemplate:get_all": "rule:default",` |
|  |  |  |  | `"clustertemplate:update": "rule:default",` |
|  |  |  |  | `"clustertemplate:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:update": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:publish": "rule:admin_or_owner",` |
|  |  |  |  |  |
|  |  |  |  | `"rc:create": "rule:default",` |
|  | |  |  | `@ -42,8 +44,8 @@` |
|  |  |  |  | `"rc:get_all": "rule:default",` |
|  |  |  |  | `"rc:update": "rule:default",` |
|  |  |  |  |  |
|  |  |  |  | `"certificate:create": "rule:admin_or_user",` |
|  |  |  |  | `"certificate:get": "rule:admin_or_user",` |
|  |  |  |  | `"certificate:create": "rule:admin_or_user or rule:cluster_user",` |
|  |  |  |  | `"certificate:get": "rule:admin_or_user or rule:cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"magnum-service:get_all": "rule:admin_api"` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 12 [magnum/common/keystone.py](#diff-74f18bb994acb9070f891077270eb3cec29babde "magnum/common/keystone.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/common/keystone.py)

|  | |  |  | `@ -31,6 +31,17 @@ CFG_LEGACY_GROUP = 'keystone_authtoken'` |
|  |  |  |  | `LOG = logging.getLogger(__name__)` |
|  |  |  |  |  |
|  |  |  |  | `trust_opts = [` |
|  |  |  |  | `cfg.BoolOpt('cluster_user_trust',` |
|  |  |  |  | `default=False,` |
|  |  |  |  | `help=_('This setting controls whether to assign a trust to'` |
|  |  |  |  | `' the cluster user or not. You will need to set it to'` |
|  |  |  |  | `' True for clusters with volume_driver=cinder or'` |
|  |  |  |  | `' registry_enabled=true in the underlying cluster'` |
|  |  |  |  | `' template to work. This is a potential security risk'` |
|  |  |  |  | `' since the trust gives instances OpenStack API access'` |
|  |  |  |  | `" to the cluster's project. Note that this setting"` |
|  |  |  |  | `' does not affect per-cluster trusts assigned to the'` |
|  |  |  |  | `'Magnum service user.')),` |
|  |  |  |  | `cfg.StrOpt('trustee_domain_id',` |
|  |  |  |  | `help=_('Id of the domain to create trustee for clusters')),` |
|  |  |  |  | `cfg.StrOpt('trustee_domain_name',` |
|  | |  |  | `@ -249,6 +260,7 @@ class KeystoneClientV3(object):` |
|  |  |  |  | `project=trustor_project_id,` |
|  |  |  |  | `trustee_user=trustee_user,` |
|  |  |  |  | `impersonation=True,` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `role_names=roles)` |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `LOG.exception(_LE('Failed to create trust'))` |
|  | |  |  |  |

#### 12 [magnum/common/policy.py](#diff-46de79205bbb66ce639006dcbabd1f030f3725d1 "magnum/common/policy.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/common/policy.py)

|  | |  |  | `@ -20,6 +20,8 @@ from oslo_config import cfg` |
|  |  |  |  | `from oslo_policy import policy` |
|  |  |  |  | `import pecan` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import context` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  |  |
|  |  |  |  |  |
|  | |  |  | `@ -92,10 +94,20 @@ def enforce(context, rule=None, target=None,` |
|  |  |  |  | `if target is None:` |
|  |  |  |  | `target = {'project_id': context.project_id,` |
|  |  |  |  | `'user_id': context.user_id}` |
|  |  |  |  | `add_policy_attributes(target)` |
|  |  |  |  | `return enforcer.enforce(rule, target, credentials,` |
|  |  |  |  | `do_raise=do_raise, exc=exc, *args, **kwargs)` |
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  | `def add_policy_attributes(target):` |
|  |  |  |  | `"""Adds extra information for policy enforcement to raw target object"""` |
|  |  |  |  | `admin_context = context.make_admin_context()` |
|  |  |  |  | `admin_osc = clients.OpenStackClients(admin_context)` |
|  |  |  |  | `trustee_domain_id = admin_osc.keystone().trustee_domain_id` |
|  |  |  |  | `target['trustee_domain_id'] = trustee_domain_id` |
|  |  |  |  | `return target` |
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  | `def enforce_wsgi(api_name, act=None):` |
|  |  |  |  | `"""This is a decorator to simplify wsgi action policy rule check.` |
|  |  |  |  |  |
|  | |  |  |  |

#### 13 [magnum/conductor/handlers/common/trust\_manager.py](#diff-ca04528272cb484d200295b1ce14bc5f21350988 "magnum/conductor/handlers/common/trust_manager.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/conductor/handlers/common/trust_manager.py)

|  | |  |  | `@ -22,15 +22,20 @@ LOG = logging.getLogger(__name__)` |
|  |  |  |  | `def create_trustee_and_trust(osc, cluster):` |
|  |  |  |  | `try:` |
|  |  |  |  | `password = utils.generate_password(length=18)` |
|  |  |  |  |  |
|  |  |  |  | `trustee = osc.keystone().create_trustee(` |
|  |  |  |  | `cluster.uuid,` |
|  |  |  |  | `"%s_%s" % (cluster.uuid, cluster.project_id),` |
|  |  |  |  | `password,` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `cluster.trustee_username = trustee.name` |
|  |  |  |  | `cluster.trustee_user_id = trustee.id` |
|  |  |  |  | `cluster.trustee_password = password` |
|  |  |  |  | `trust = osc.keystone().create_trust(trustee.id)` |
|  |  |  |  |  |
|  |  |  |  | `trust = osc.keystone().create_trust(` |
|  |  |  |  | `cluster.trustee_user_id)` |
|  |  |  |  | `cluster.trust_id = trust.id` |
|  |  |  |  |  |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `LOG.exception(` |
|  |  |  |  | `_LE('Failed to create trustee and trust for Cluster: %s'),` |
|  | |  |  | `@ -41,9 +46,11 @@ def create_trustee_and_trust(osc, cluster):` |
|  |  |  |  |  |
|  |  |  |  | `def delete_trustee_and_trust(osc, context, cluster):` |
|  |  |  |  | `try:` |
|  |  |  |  | `kst = osc.keystone()` |
|  |  |  |  |  |
|  |  |  |  | `# The cluster which is upgraded from Liberty doesn't have trust_id` |
|  |  |  |  | `if cluster.trust_id:` |
|  |  |  |  | `osc.keystone().delete_trust(context, cluster)` |
|  |  |  |  | `kst.delete_trust(context, cluster)` |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `# Exceptions are already logged by keystone().delete_trust` |
|  |  |  |  | `pass` |
|  | |  |  |  |

#### 17 [magnum/db/sqlalchemy/api.py](#diff-e5d881e4db7cb1e98b20d7f23b03f8b6ac579ffa "magnum/db/sqlalchemy/api.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/db/sqlalchemy/api.py)

|  | |  |  | `@ -24,6 +24,8 @@ from oslo_utils import uuidutils` |
|  |  |  |  | `from sqlalchemy.orm.exc import MultipleResultsFound` |
|  |  |  |  | `from sqlalchemy.orm.exc import NoResultFound` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import context as request_context` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  | `from magnum.db import api` |
|  |  |  |  | `from magnum.db.sqlalchemy import models` |
|  | |  |  | `@ -113,8 +115,21 @@ class Connection(api.Connection):` |
|  |  |  |  | `if context.is_admin and context.all_tenants:` |
|  |  |  |  | `return query` |
|  |  |  |  |  |
|  |  |  |  | `if context.project_id:` |
|  |  |  |  | `admin_context = request_context.make_admin_context(all_tenants=True)` |
|  |  |  |  | `osc = clients.OpenStackClients(admin_context)` |
|  |  |  |  | `kst = osc.keystone()` |
|  |  |  |  |  |
|  |  |  |  | `# User in a regular project (not in the trustee domain)` |
|  |  |  |  | `if context.project_id and context.domain_id != kst.trustee_domain_id:` |
|  |  |  |  | `query = query.filter_by(project_id=context.project_id)` |
|  |  |  |  | `# Match project ID component in trustee user's user name against` |
|  |  |  |  | `# cluster's project_id to associate per-cluster trustee users who have` |
|  |  |  |  | `# no project information with the project their clusters/cluster models` |
|  |  |  |  | `# reside in. This is equivalent to the project filtering above.` |
|  |  |  |  | `elif context.domain_id == kst.trustee_domain_id:` |
|  |  |  |  | `user_name = kst.client.users.get(context.user_id).name` |
|  |  |  |  | `user_project = user_name.split('_', 2)[1]` |
|  |  |  |  | `query = query.filter_by(project_id=user_project)` |
|  |  |  |  | `else:` |
|  |  |  |  | `query = query.filter_by(user_id=context.user_id)` |
|  |  |  |  |  |
|  | |  |  |  |

#### 16 [magnum/drivers/common/template\_def.py](#diff-f27543741fa044c270ff580ebadb5373aa039675 "magnum/drivers/common/template_def.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/template_def.py)

|  | |  |  | `@ -23,6 +23,7 @@ import six` |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  | `from magnum.i18n import _` |
|  |  |  |  | `from magnum.i18n import _LE` |
|  |  |  |  | `from magnum.i18n import _LW` |
|  |  |  |  |  |
|  |  |  |  | `from requests import exceptions as req_exceptions` |
|  | |  |  | `@ -380,7 +381,20 @@ class BaseTemplateDefinition(TemplateDefinition):` |
|  |  |  |  | `extra_params['trustee_user_id'] = cluster.trustee_user_id` |
|  |  |  |  | `extra_params['trustee_username'] = cluster.trustee_username` |
|  |  |  |  | `extra_params['trustee_password'] = cluster.trustee_password` |
|  |  |  |  | `extra_params['trust_id'] = cluster.trust_id` |
|  |  |  |  |  |
|  |  |  |  | `# Only pass trust ID into the template when it is needed.` |
|  |  |  |  | `if (cluster_template.volume_driver == 'rexray' or` |
|  |  |  |  | `cluster_template.registry_enabled):` |
|  |  |  |  | `if CONF.trust.cluster_user_trust:` |
|  |  |  |  | `extra_params['trust_id'] = cluster.trust_id` |
|  |  |  |  | `else:` |
|  |  |  |  | `missing_setting = ('trust/cluster_user_trust = True')` |
|  |  |  |  | `msg = _LE('This cluster can only be created with %s in '` |
|  |  |  |  | `'magnum.conf')` |
|  |  |  |  | `raise exception.ConfigInvalid(msg % missing_setting)` |
|  |  |  |  | `else:` |
|  |  |  |  | `extra_params['trust_id'] = ""` |
|  |  |  |  |  |
|  |  |  |  | `extra_params['auth_url'] = context.auth_url` |
|  |  |  |  |  |
|  |  |  |  | `return super(BaseTemplateDefinition,` |
|  | |  |  |  |

#### 5 [magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh](#diff-1a1b780fdc64b7a7cbce45144e79dcfc2c5310a8 "magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh)

|  | |  |  | `@ -49,11 +49,6 @@ auth_json=$(cat << EOF` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 5 [magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh](#diff-23e2c3c880e0ac4f7a09fc55c439bbf08efbbfa4 "magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh)

|  | |  |  | `@ -71,11 +71,6 @@ auth_json=$(cat << EOF` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 2 [magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml](#diff-f91765aba714d50215b95a17e90ee5958ec77f6c "magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_API_PUBLIC_ADDRESS="$KUBE_API_PUBLIC_ADDRESS"` |
|  |  |  |  | `KUBE_API_PRIVATE_ADDRESS="$KUBE_API_PRIVATE_ADDRESS"` |
|  | |  |  |  |

#### 2 [magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml](#diff-205390ec2767cdb58b7f40437ca6392f6ea6bff3 "magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_ALLOW_PRIV="$KUBE_ALLOW_PRIV"` |
|  |  |  |  | `KUBE_MASTER_IP="$KUBE_MASTER_IP"` |
|  | |  |  |  |

#### 5 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/make-cert-client.yaml](#diff-6a526a857b1187d2558f474d4b59d4b44380be85 "magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert-client.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert-client.yaml)

|  | |  |  | `@ -66,11 +66,6 @@ write_files:` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 5 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/make-cert.yaml](#diff-a31daf1014e2c6891d9c5c6a4cb4af3e7b7682dc "magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert.yaml)

|  | |  |  | `@ -89,11 +89,6 @@ write_files:` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 2 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/write-heat-params-master.yaml](#diff-58c79f3907546c82d3a24253166fce61d11f0192 "magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_API_PUBLIC_ADDRESS="$KUBE_API_PUBLIC_ADDRESS"` |
|  |  |  |  | `KUBE_API_PRIVATE_ADDRESS="$KUBE_API_PRIVATE_ADDRESS"` |
|  | |  |  |  |

#### 2 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/write-heat-params.yaml](#diff-de7be66c36d3cc10421209a74850c5b3eababf3f "magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_ALLOW_PRIV="$KUBE_ALLOW_PRIV"` |
|  |  |  |  | `KUBE_MASTER_IP="$KUBE_MASTER_IP"` |
|  | |  |  |  |

#### 2 [magnum/drivers/mesos\_ubuntu\_v1/templates/fragments/write-heat-params.yaml](#diff-941726854b493cd4bc345acac53bef2c0223e94b "magnum/drivers/mesos_ubuntu_v1/templates/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/mesos_ubuntu_v1/templates/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `MESOS_MASTERS_IPS="$MESOS_MASTERS_IPS"` |
|  |  |  |  | `EXECUTOR_REGISTRATION_TIMEOUT="$EXECUTOR_REGISTRATION_TIMEOUT"` |
|  | |  |  |  |

#### 6 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/make-cert.py](#diff-29cf41f825f86537fbda37e8d95a831a9379360e "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/make-cert.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/make-cert.py)

|  | |  |  | `@ -147,11 +147,6 @@ def get_user_token(config):` |
|  |  |  |  | `"password": "%(trustee_password)s"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "%(trust_id)s"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  | `@ -159,7 +154,6 @@ def get_user_token(config):` |
|  |  |  |  | `params = {` |
|  |  |  |  | `'trustee_user_id': config['TRUSTEE_USER_ID'],` |
|  |  |  |  | `'trustee_password': config['TRUSTEE_PASSWORD'],` |
|  |  |  |  | `'trust_id': config['TRUST_ID']` |
|  |  |  |  | `}` |
|  |  |  |  | `creds = creds_str % params` |
|  |  |  |  | `headers = {'Content-Type': 'application/json'}` |
|  | |  |  |  |

#### 2 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/write-heat-params-master.yaml](#diff-6f65b0303ac33001590f7e8f36ff60fd3e0a7098 "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `WAIT_HANDLE_ENDPOINT="$WAIT_HANDLE_ENDPOINT"` |
|  |  |  |  | `WAIT_HANDLE_TOKEN="$WAIT_HANDLE_TOKEN"` |
|  | |  |  |  |

#### 2 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/write-heat-params-node.yaml](#diff-f472452e6a4f2aa076350557d48abf21849142f2 "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-node.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-node.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `WAIT_HANDLE_ENDPOINT="$WAIT_HANDLE_ENDPOINT"` |
|  |  |  |  | `WAIT_HANDLE_TOKEN="$WAIT_HANDLE_TOKEN"` |
|  | |  |  |  |

#### 27 [magnum/tests/base.py](#diff-be3e520cee42a5380a35b94db780cd49240a51f5 "magnum/tests/base.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/base.py)

|  | |  |  | `@ -26,6 +26,7 @@ import pecan` |
|  |  |  |  | `import testscenarios` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import context as magnum_context` |
|  |  |  |  | `from magnum.common import keystone as magnum_keystone` |
|  |  |  |  | `from magnum.objects import base as objects_base` |
|  |  |  |  | `from magnum.tests import conf_fixture` |
|  |  |  |  | `from magnum.tests import fake_notifier` |
|  | |  |  | `@ -63,11 +64,18 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `trustee_domain_id = '12345678-9012-3456-7890-123456789abc'` |
|  |  |  |  |  |
|  |  |  |  | `self.context = magnum_context.RequestContext(` |
|  |  |  |  | `auth_token_info=token_info,` |
|  |  |  |  | `project_id='fake_project',` |
|  |  |  |  | `user_id='fake_user')` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks = {}` |
|  |  |  |  |  |
|  |  |  |  | `self.keystone_client = magnum_keystone.KeystoneClientV3(self.context)` |
|  |  |  |  |  |
|  |  |  |  | `self.policy = self.useFixture(policy_fixture.PolicyFixture())` |
|  |  |  |  |  |
|  |  |  |  | `self.useFixture(fixtures.MockPatchObject(` |
|  | |  |  | `@ -89,9 +97,22 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  |  |
|  |  |  |  | `p = mock.patch.object(magnum_context, 'make_context',` |
|  |  |  |  | `side_effect=make_context)` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks['magnum.common.context.make_context'] = p` |
|  |  |  |  |  |
|  |  |  |  | `q = mock.patch.object(magnum_keystone.KeystoneClientV3,` |
|  |  |  |  | `'trustee_domain_id',` |
|  |  |  |  | `return_value=trustee_domain_id)` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks[` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id'] = q` |
|  |  |  |  |  |
|  |  |  |  | `self.mock_make_context = p.start()` |
|  |  |  |  | `self.addCleanup(p.stop)` |
|  |  |  |  |  |
|  |  |  |  | `self.mock_make_trustee_domain_id = q.start()` |
|  |  |  |  | `self.addCleanup(q.stop)` |
|  |  |  |  |  |
|  |  |  |  | `self.useFixture(conf_fixture.ConfFixture())` |
|  |  |  |  | `self.useFixture(fixtures.NestedTempfile())` |
|  |  |  |  |  |
|  | |  |  | `@ -104,6 +125,12 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  |  |
|  |  |  |  | `self.addCleanup(reset_pecan)` |
|  |  |  |  |  |
|  |  |  |  | `def start_global(self, name):` |
|  |  |  |  | `self.global_mocks[name].start()` |
|  |  |  |  |  |
|  |  |  |  | `def stop_global(self, name):` |
|  |  |  |  | `self.global_mocks[name].stop()` |
|  |  |  |  |  |
|  |  |  |  | `def _restore_obj_registry(self):` |
|  |  |  |  | `objects_base.MagnumObjectRegistry._registry._obj_classes \` |
|  |  |  |  | `= self._base_test_obj_backup` |
|  | |  |  |  |

#### 15 [magnum/tests/unit/common/test\_keystone.py](#diff-027328334404b2a79785b7726d045c3cb1e830e3 "magnum/tests/unit/common/test_keystone.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/common/test_keystone.py)

|  | |  |  | `@ -55,6 +55,19 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `admin_tenant_name='service',` |
|  |  |  |  | `group=keystone.CFG_LEGACY_GROUP)` |
|  |  |  |  |  |
|  |  |  |  | `# Disable global mocking for trustee_domain_id` |
|  |  |  |  | `self.stop_global(` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id')` |
|  |  |  |  |  |
|  |  |  |  | `def tearDown(self):` |
|  |  |  |  | `# Re-enable global mocking for trustee_domain_id. We need this because` |
|  |  |  |  | `# mock blows up when trying to stop an already stopped patch (which it` |
|  |  |  |  | `# will do due to the addCleanup() in base.TestCase).` |
|  |  |  |  | `self.start_global(` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id')` |
|  |  |  |  |  |
|  |  |  |  | `super(KeystoneClientTest, self).tearDown()` |
|  |  |  |  |  |
|  |  |  |  | `def test_client_with_password(self, mock_ks):` |
|  |  |  |  | `self.ctx.is_admin = True` |
|  |  |  |  | `ks_client = keystone.KeystoneClientV3(self.ctx)` |
|  | |  |  | `@ -136,6 +149,7 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `ks_client.create_trust(trustee_user='888888')` |
|  |  |  |  |  |
|  |  |  |  | `mock_ks.return_value.trusts.create.assert_called_once_with(` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `trustor_user='123456', project='654321',` |
|  |  |  |  | `trustee_user='888888', role_names=['role1', 'role2'],` |
|  |  |  |  | `impersonation=True)` |
|  | |  |  | `@ -152,6 +166,7 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `ks_client.create_trust(trustee_user='888888')` |
|  |  |  |  |  |
|  |  |  |  | `mock_ks.return_value.trusts.create.assert_called_once_with(` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `trustor_user='123456', project='654321',` |
|  |  |  |  | `trustee_user='888888', role_names=['role3'],` |
|  |  |  |  | `impersonation=True)` |
|  | |  |  |  |

#### 3 [magnum/tests/unit/conductor/handlers/common/test\_trust\_manager.py](#diff-573fabc47926ad5ed879cee665d8b4a3fabd7040 "magnum/tests/unit/conductor/handlers/common/test_trust_manager.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/common/test_trust_manager.py)

|  | |  |  | `@ -37,6 +37,7 @@ class TrustManagerTestCase(base.BaseTestCase):` |
|  |  |  |  | `mock_generate_password.return_value = mock_password` |
|  |  |  |  | `mock_cluster = mock.MagicMock()` |
|  |  |  |  | `mock_cluster.uuid = 'mock_cluster_uuid'` |
|  |  |  |  | `mock_cluster.project_id = 'mock_cluster_project_id'` |
|  |  |  |  | `mock_keystone = mock.MagicMock()` |
|  |  |  |  | `mock_trustee = mock.MagicMock()` |
|  |  |  |  | `mock_trustee.id = 'mock_trustee_id'` |
|  | |  |  | `@ -52,7 +53,7 @@ class TrustManagerTestCase(base.BaseTestCase):` |
|  |  |  |  | `trust_manager.create_trustee_and_trust(self.osc, mock_cluster)` |
|  |  |  |  |  |
|  |  |  |  | `mock_keystone.create_trustee.assert_called_once_with(` |
|  |  |  |  | `mock_cluster.uuid,` |
|  |  |  |  | `'%s_%s' % (mock_cluster.uuid, mock_cluster.project_id),` |
|  |  |  |  | `mock_password,` |
|  |  |  |  | `)` |
|  |  |  |  | `mock_keystone.create_trust.assert_called_once_with(` |
|  | |  |  |  |

#### 5 [magnum/tests/unit/conductor/handlers/test\_cluster\_conductor.py](#diff-32b27b7e3e9205dc1d31153482395e79a7201403 "magnum/tests/unit/conductor/handlers/test_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_cluster_conductor.py)

|  | |  |  | `@ -191,6 +191,11 @@ class TestHandler(db_base.DbTestCase):` |
|  |  |  |  | `mock_poller.poll_and_check.return_value = loopingcall.LoopingCallDone()` |
|  |  |  |  | `mock_heat_poller_class.return_value = mock_poller` |
|  |  |  |  | `osc = mock.sentinel.osc` |
|  |  |  |  |  |
|  |  |  |  | `def return_keystone():` |
|  |  |  |  | `return self.keystone_client` |
|  |  |  |  |  |
|  |  |  |  | `osc.keystone = return_keystone` |
|  |  |  |  | `mock_openstack_client_class.return_value = osc` |
|  |  |  |  |  |
|  |  |  |  | `def create_stack_side_effect(context, osc, cluster, timeout):` |
|  | |  |  |  |

#### 14 [magnum/tests/unit/conductor/handlers/test\_k8s\_cluster\_conductor.py](#diff-38cc883aaaac12bf783461cd4cdb87bfa3675d1f "magnum/tests/unit/conductor/handlers/test_k8s_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_k8s_cluster_conductor.py)

|  | |  |  | `@ -173,7 +173,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'insecure_registry_url': '10.0.0.1:5000',` |
|  |  |  |  | `'kube_version': 'fake-version',` |
|  | |  |  | `@ -210,6 +210,10 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'RegionOne',` |
|  |  |  |  | `group='docker_registry')` |
|  |  |  |  |  |
|  |  |  |  | `cfg.CONF.set_override('cluster_user_trust',` |
|  |  |  |  | `True,` |
|  |  |  |  | `group='trust')` |
|  |  |  |  |  |
|  |  |  |  | `(template_path,` |
|  |  |  |  | `definition,` |
|  |  |  |  | `env_files) = cluster_conductor._extract_template_definition(` |
|  | |  |  | `@ -311,7 +315,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'ssh_key_name': 'keypair_id',` |
|  |  |  |  | `'tenant_name': 'fake_tenant',` |
|  |  |  |  | `'tls_disabled': False,` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'trustee_domain_id': 'trustee_domain_id',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  | |  |  | `@ -372,7 +376,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'cluster_uuid': self.cluster_dict['uuid'],` |
|  |  |  |  | `'magnum_url': self.mock_osc.magnum_url.return_value,` |
|  | |  |  | `@ -429,7 +433,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'cluster_uuid': self.cluster_dict['uuid'],` |
|  |  |  |  | `'magnum_url': self.mock_osc.magnum_url.return_value,` |
|  | |  |  | `@ -585,7 +589,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'insecure_registry_url': '10.0.0.1:5000',` |
|  |  |  |  | `'kube_version': 'fake-version',` |
|  | |  |  |  |

#### 9 [magnum/tests/unit/conductor/handlers/test\_mesos\_cluster\_conductor.py](#diff-aec8efdf52bf9f38b6748dc6120da5901bbb616f "magnum/tests/unit/conductor/handlers/test_mesos_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_mesos_cluster_conductor.py)

|  | |  |  | `@ -37,6 +37,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'http_proxy': 'http_proxy',` |
|  |  |  |  | `'https_proxy': 'https_proxy',` |
|  |  |  |  | `'no_proxy': 'no_proxy',` |
|  |  |  |  | `'registry_enabled': False,` |
|  |  |  |  | `'server_type': 'vm',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'labels': {'rexray_preempt': 'False',` |
|  | |  |  | `@ -109,7 +110,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  | `@ -158,7 +159,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  |  |  |  | `'username': 'mesos_user',` |
|  | |  |  | `@ -208,7 +209,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  | `@ -260,7 +261,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  |  |

#### 8 [magnum/tests/unit/conductor/handlers/test\_swarm\_cluster\_conductor.py](#diff-b9be38b620d0836ef58541ee456f8af236d84912 "magnum/tests/unit/conductor/handlers/test_swarm_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_swarm_cluster_conductor.py)

|  | |  |  | `@ -68,6 +68,12 @@ class TestClusterConductorWithSwarm(base.TestCase):` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'coe_version': 'fake-version'` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `# We need this due to volume_driver=rexray` |
|  |  |  |  | `cfg.CONF.set_override('cluster_user_trust',` |
|  |  |  |  | `True,` |
|  |  |  |  | `group='trust')` |
|  |  |  |  |  |
|  |  |  |  | `osc_patcher = mock.patch('magnum.common.clients.OpenStackClients')` |
|  |  |  |  | `self.mock_osc_class = osc_patcher.start()` |
|  |  |  |  | `self.addCleanup(osc_patcher.stop)` |
|  | |  |  | `@ -257,7 +263,7 @@ class TestClusterConductorWithSwarm(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'swarm_version': 'fake-version',` |
|  |  |  |  | `'rexray_preempt': 'False'` |
|  | |  |  |  |

Write
Preview

Loading…

x

Add

Cancel
Save

Reference in New Issue

**Repository**
openstack/magnum

**Title**

**Body**

Create Issue

Block a user
Blocking a user prevents them from interacting with repositories, such as opening or commenting on pull requests or issues. Learn more about blocking a user.

User to block:

Optional note:

The note is not visible to the blocked user.

Cancel
Block

[Powered by Gitea](https://about.gitea.com)
Version:
v1.23.1
Page: **942ms**
Template: **508ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Français
Gaeilge
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
മലയാളം
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)



=== Content from opendev.org_13226fbd_20250125_135337.html ===

This website requires JavaScript.
[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
[Get Started](https://docs.opendev.org/opendev/infra-manual/latest/gettingstarted.html)

[openstack](/openstack)/[magnum](/openstack/magnum)

[Code](/openstack/magnum/src/branch/master)
[Issues](https://bugs.launchpad.net/magnum)
[Proposed changes](https://review.opendev.org/#/q/status:open+project:openstack/magnum)

### Fix CVE-2016-7404

[Browse Source](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22)

```
This commit addresses multiple potential vulnerabilities in
Magnum. It makes the following changes:

* Permissions for /etc/sysconfig/heat-params inside Magnum
  created instances are tightened to 0600 (used to be 0755).
* Certificate retrieval is modified to work without the need
  for a Keystone trust.
* The cluster's Keystone trust id is only passed into
  instances for clusters where that is actually needed. This
  prevents the trustee user from consuming the trust in cases
  where it is not needed.
* The configuration setting trust/cluster_user_trust (False by
  default) is introduced. It needs to be explicitely enabled
  by the cloud operator to allow clusters that need the
  trust_id to be passed into instances to work. Without this
  setting, attempts to create such clusters will fail.

Please note, that none of these changes apply to existing
clusters. They will have to be deleted and rebuilt to benefit
from these changes.

(cherry picked from commit e93d82e8b3bc19211efd54edc17aebdca50670c1)

Changes for backport:

* Moved cluster_user_trust setting to magnum/common/keystone.py
* Resolved merge conflicts.
* Fixed unit tests with configuration overrides.

Change-Id: I408d845ee4fd00d5bcd1e90f0a78f2bba3f2a57a
```
...

This commit is contained in:

![](/assets/img/avatar_default.png "johannes.grassler@suse.com")
parent
[d98d185817](/openstack/magnum/commit/d98d1858175d55b0f5c631b7bb798d5fb49dc91d)

commit
0bb0d6486d

 **26 changed files** with **171 additions** and **75 deletions**

[Show all changes](?style=unified&whitespace=show-all&show-outdated=)
[Ignore whitespace when comparing lines](?style=unified&whitespace=ignore-all&show-outdated=)
[Ignore changes in amount of whitespace](?style=unified&whitespace=ignore-change&show-outdated=)
[Ignore changes in whitespace at EOL](?style=unified&whitespace=ignore-eol&show-outdated=)

Show Stats
[Download Patch File](/openstack/magnum/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22.patch)
[Download Diff File](/openstack/magnum/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22.diff)
Expand all files
Collapse all files

#### 1 [devstack/lib/magnum](#diff-26caa71a2ba1ad2009d41145e47df1a559164cbb "devstack/lib/magnum") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/devstack/lib/magnum)

|  | |  |  | `@ -206,6 +206,7 @@ function create_magnum_conf {` |
|  |  |  |  | `--os-identity-api-version 3 role add \` |
|  |  |  |  | `--user $trustee_domain_admin_id --domain $trustee_domain_id \` |
|  |  |  |  | `admin` |
|  |  |  |  | `iniset $MAGNUM_CONF trust cluster_user_trust True` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_name magnum` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_admin_name trustee_domain_admin` |
|  |  |  |  | `iniset $MAGNUM_CONF trust trustee_domain_admin_password $MAGNUM_TRUSTEE_DOMAIN_ADMIN_PASSWORD` |
|  | |  |  |  |

#### 54 [etc/magnum/policy.json](#diff-4790802fb3805cfc4221e17e7fc581cb81395ce9 "etc/magnum/policy.json") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/etc/magnum/policy.json)

|  | |  |  | `@ -4,35 +4,37 @@` |
|  |  |  |  | `"default": "rule:admin_or_owner",` |
|  |  |  |  | `"admin_api": "rule:context_is_admin",` |
|  |  |  |  | `"admin_or_user": "is_admin:True or user_id:%(user_id)s",` |
|  |  |  |  | `"cluster_user": "user_id:%(trustee_user_id)s",` |
|  |  |  |  | `"deny_cluster_user": "not domain_id:%(trustee_domain_id)s",` |
|  |  |  |  |  |
|  |  |  |  | `"bay:create": "rule:default",` |
|  |  |  |  | `"bay:delete": "rule:default",` |
|  |  |  |  | `"bay:detail": "rule:default",` |
|  |  |  |  | `"bay:get": "rule:default",` |
|  |  |  |  | `"bay:get_all": "rule:default",` |
|  |  |  |  | `"bay:update": "rule:default",` |
|  |  |  |  | `"bay:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"bay:update": "rule:deny_cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"baymodel:create": "rule:default",` |
|  |  |  |  | `"baymodel:delete": "rule:default",` |
|  |  |  |  | `"baymodel:detail": "rule:default",` |
|  |  |  |  | `"baymodel:get": "rule:default",` |
|  |  |  |  | `"baymodel:get_all": "rule:default",` |
|  |  |  |  | `"baymodel:update": "rule:default",` |
|  |  |  |  | `"baymodel:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:update": "rule:deny_cluster_user",` |
|  |  |  |  | `"baymodel:publish": "rule:admin_or_owner",` |
|  |  |  |  |  |
|  |  |  |  | `"cluster:create": "rule:default",` |
|  |  |  |  | `"cluster:delete": "rule:default",` |
|  |  |  |  | `"cluster:detail": "rule:default",` |
|  |  |  |  | `"cluster:get": "rule:default",` |
|  |  |  |  | `"cluster:get_all": "rule:default",` |
|  |  |  |  | `"cluster:update": "rule:default",` |
|  |  |  |  | `"cluster:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"cluster:update": "rule:deny_cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"clustertemplate:create": "rule:default",` |
|  |  |  |  | `"clustertemplate:delete": "rule:default",` |
|  |  |  |  | `"clustertemplate:detail": "rule:default",` |
|  |  |  |  | `"clustertemplate:get": "rule:default",` |
|  |  |  |  | `"clustertemplate:get_all": "rule:default",` |
|  |  |  |  | `"clustertemplate:update": "rule:default",` |
|  |  |  |  | `"clustertemplate:create": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:delete": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:detail": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:get": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:get_all": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:update": "rule:deny_cluster_user",` |
|  |  |  |  | `"clustertemplate:publish": "rule:admin_or_owner",` |
|  |  |  |  |  |
|  |  |  |  | `"rc:create": "rule:default",` |
|  | |  |  | `@ -42,8 +44,8 @@` |
|  |  |  |  | `"rc:get_all": "rule:default",` |
|  |  |  |  | `"rc:update": "rule:default",` |
|  |  |  |  |  |
|  |  |  |  | `"certificate:create": "rule:admin_or_user",` |
|  |  |  |  | `"certificate:get": "rule:admin_or_user",` |
|  |  |  |  | `"certificate:create": "rule:admin_or_user or rule:cluster_user",` |
|  |  |  |  | `"certificate:get": "rule:admin_or_user or rule:cluster_user",` |
|  |  |  |  |  |
|  |  |  |  | `"magnum-service:get_all": "rule:admin_api"` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 12 [magnum/common/keystone.py](#diff-74f18bb994acb9070f891077270eb3cec29babde "magnum/common/keystone.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/common/keystone.py)

|  | |  |  | `@ -31,6 +31,17 @@ CFG_LEGACY_GROUP = 'keystone_authtoken'` |
|  |  |  |  | `LOG = logging.getLogger(__name__)` |
|  |  |  |  |  |
|  |  |  |  | `trust_opts = [` |
|  |  |  |  | `cfg.BoolOpt('cluster_user_trust',` |
|  |  |  |  | `default=False,` |
|  |  |  |  | `help=_('This setting controls whether to assign a trust to'` |
|  |  |  |  | `' the cluster user or not. You will need to set it to'` |
|  |  |  |  | `' True for clusters with volume_driver=cinder or'` |
|  |  |  |  | `' registry_enabled=true in the underlying cluster'` |
|  |  |  |  | `' template to work. This is a potential security risk'` |
|  |  |  |  | `' since the trust gives instances OpenStack API access'` |
|  |  |  |  | `" to the cluster's project. Note that this setting"` |
|  |  |  |  | `' does not affect per-cluster trusts assigned to the'` |
|  |  |  |  | `'Magnum service user.')),` |
|  |  |  |  | `cfg.StrOpt('trustee_domain_id',` |
|  |  |  |  | `help=_('Id of the domain to create trustee for clusters')),` |
|  |  |  |  | `cfg.StrOpt('trustee_domain_name',` |
|  | |  |  | `@ -249,6 +260,7 @@ class KeystoneClientV3(object):` |
|  |  |  |  | `project=trustor_project_id,` |
|  |  |  |  | `trustee_user=trustee_user,` |
|  |  |  |  | `impersonation=True,` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `role_names=roles)` |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `LOG.exception(_LE('Failed to create trust'))` |
|  | |  |  |  |

#### 12 [magnum/common/policy.py](#diff-46de79205bbb66ce639006dcbabd1f030f3725d1 "magnum/common/policy.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/common/policy.py)

|  | |  |  | `@ -20,6 +20,8 @@ from oslo_config import cfg` |
|  |  |  |  | `from oslo_policy import policy` |
|  |  |  |  | `import pecan` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import context` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  |  |
|  |  |  |  |  |
|  | |  |  | `@ -92,10 +94,20 @@ def enforce(context, rule=None, target=None,` |
|  |  |  |  | `if target is None:` |
|  |  |  |  | `target = {'project_id': context.project_id,` |
|  |  |  |  | `'user_id': context.user_id}` |
|  |  |  |  | `add_policy_attributes(target)` |
|  |  |  |  | `return enforcer.enforce(rule, target, credentials,` |
|  |  |  |  | `do_raise=do_raise, exc=exc, *args, **kwargs)` |
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  | `def add_policy_attributes(target):` |
|  |  |  |  | `"""Adds extra information for policy enforcement to raw target object"""` |
|  |  |  |  | `admin_context = context.make_admin_context()` |
|  |  |  |  | `admin_osc = clients.OpenStackClients(admin_context)` |
|  |  |  |  | `trustee_domain_id = admin_osc.keystone().trustee_domain_id` |
|  |  |  |  | `target['trustee_domain_id'] = trustee_domain_id` |
|  |  |  |  | `return target` |
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  | `def enforce_wsgi(api_name, act=None):` |
|  |  |  |  | `"""This is a decorator to simplify wsgi action policy rule check.` |
|  |  |  |  |  |
|  | |  |  |  |

#### 13 [magnum/conductor/handlers/common/trust\_manager.py](#diff-ca04528272cb484d200295b1ce14bc5f21350988 "magnum/conductor/handlers/common/trust_manager.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/conductor/handlers/common/trust_manager.py)

|  | |  |  | `@ -22,15 +22,20 @@ LOG = logging.getLogger(__name__)` |
|  |  |  |  | `def create_trustee_and_trust(osc, cluster):` |
|  |  |  |  | `try:` |
|  |  |  |  | `password = utils.generate_password(length=18)` |
|  |  |  |  |  |
|  |  |  |  | `trustee = osc.keystone().create_trustee(` |
|  |  |  |  | `cluster.uuid,` |
|  |  |  |  | `"%s_%s" % (cluster.uuid, cluster.project_id),` |
|  |  |  |  | `password,` |
|  |  |  |  | `)` |
|  |  |  |  |  |
|  |  |  |  | `cluster.trustee_username = trustee.name` |
|  |  |  |  | `cluster.trustee_user_id = trustee.id` |
|  |  |  |  | `cluster.trustee_password = password` |
|  |  |  |  | `trust = osc.keystone().create_trust(trustee.id)` |
|  |  |  |  |  |
|  |  |  |  | `trust = osc.keystone().create_trust(` |
|  |  |  |  | `cluster.trustee_user_id)` |
|  |  |  |  | `cluster.trust_id = trust.id` |
|  |  |  |  |  |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `LOG.exception(` |
|  |  |  |  | `_LE('Failed to create trustee and trust for Cluster: %s'),` |
|  | |  |  | `@ -41,9 +46,11 @@ def create_trustee_and_trust(osc, cluster):` |
|  |  |  |  |  |
|  |  |  |  | `def delete_trustee_and_trust(osc, context, cluster):` |
|  |  |  |  | `try:` |
|  |  |  |  | `kst = osc.keystone()` |
|  |  |  |  |  |
|  |  |  |  | `# The cluster which is upgraded from Liberty doesn't have trust_id` |
|  |  |  |  | `if cluster.trust_id:` |
|  |  |  |  | `osc.keystone().delete_trust(context, cluster)` |
|  |  |  |  | `kst.delete_trust(context, cluster)` |
|  |  |  |  | `except Exception:` |
|  |  |  |  | `# Exceptions are already logged by keystone().delete_trust` |
|  |  |  |  | `pass` |
|  | |  |  |  |

#### 17 [magnum/db/sqlalchemy/api.py](#diff-e5d881e4db7cb1e98b20d7f23b03f8b6ac579ffa "magnum/db/sqlalchemy/api.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/db/sqlalchemy/api.py)

|  | |  |  | `@ -24,6 +24,8 @@ from oslo_utils import uuidutils` |
|  |  |  |  | `from sqlalchemy.orm.exc import MultipleResultsFound` |
|  |  |  |  | `from sqlalchemy.orm.exc import NoResultFound` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import context as request_context` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  | `from magnum.db import api` |
|  |  |  |  | `from magnum.db.sqlalchemy import models` |
|  | |  |  | `@ -113,8 +115,21 @@ class Connection(api.Connection):` |
|  |  |  |  | `if context.is_admin and context.all_tenants:` |
|  |  |  |  | `return query` |
|  |  |  |  |  |
|  |  |  |  | `if context.project_id:` |
|  |  |  |  | `admin_context = request_context.make_admin_context(all_tenants=True)` |
|  |  |  |  | `osc = clients.OpenStackClients(admin_context)` |
|  |  |  |  | `kst = osc.keystone()` |
|  |  |  |  |  |
|  |  |  |  | `# User in a regular project (not in the trustee domain)` |
|  |  |  |  | `if context.project_id and context.domain_id != kst.trustee_domain_id:` |
|  |  |  |  | `query = query.filter_by(project_id=context.project_id)` |
|  |  |  |  | `# Match project ID component in trustee user's user name against` |
|  |  |  |  | `# cluster's project_id to associate per-cluster trustee users who have` |
|  |  |  |  | `# no project information with the project their clusters/cluster models` |
|  |  |  |  | `# reside in. This is equivalent to the project filtering above.` |
|  |  |  |  | `elif context.domain_id == kst.trustee_domain_id:` |
|  |  |  |  | `user_name = kst.client.users.get(context.user_id).name` |
|  |  |  |  | `user_project = user_name.split('_', 2)[1]` |
|  |  |  |  | `query = query.filter_by(project_id=user_project)` |
|  |  |  |  | `else:` |
|  |  |  |  | `query = query.filter_by(user_id=context.user_id)` |
|  |  |  |  |  |
|  | |  |  |  |

#### 16 [magnum/drivers/common/template\_def.py](#diff-f27543741fa044c270ff580ebadb5373aa039675 "magnum/drivers/common/template_def.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/template_def.py)

|  | |  |  | `@ -23,6 +23,7 @@ import six` |
|  |  |  |  | `from magnum.common import clients` |
|  |  |  |  | `from magnum.common import exception` |
|  |  |  |  | `from magnum.i18n import _` |
|  |  |  |  | `from magnum.i18n import _LE` |
|  |  |  |  | `from magnum.i18n import _LW` |
|  |  |  |  |  |
|  |  |  |  | `from requests import exceptions as req_exceptions` |
|  | |  |  | `@ -380,7 +381,20 @@ class BaseTemplateDefinition(TemplateDefinition):` |
|  |  |  |  | `extra_params['trustee_user_id'] = cluster.trustee_user_id` |
|  |  |  |  | `extra_params['trustee_username'] = cluster.trustee_username` |
|  |  |  |  | `extra_params['trustee_password'] = cluster.trustee_password` |
|  |  |  |  | `extra_params['trust_id'] = cluster.trust_id` |
|  |  |  |  |  |
|  |  |  |  | `# Only pass trust ID into the template when it is needed.` |
|  |  |  |  | `if (cluster_template.volume_driver == 'rexray' or` |
|  |  |  |  | `cluster_template.registry_enabled):` |
|  |  |  |  | `if CONF.trust.cluster_user_trust:` |
|  |  |  |  | `extra_params['trust_id'] = cluster.trust_id` |
|  |  |  |  | `else:` |
|  |  |  |  | `missing_setting = ('trust/cluster_user_trust = True')` |
|  |  |  |  | `msg = _LE('This cluster can only be created with %s in '` |
|  |  |  |  | `'magnum.conf')` |
|  |  |  |  | `raise exception.ConfigInvalid(msg % missing_setting)` |
|  |  |  |  | `else:` |
|  |  |  |  | `extra_params['trust_id'] = ""` |
|  |  |  |  |  |
|  |  |  |  | `extra_params['auth_url'] = context.auth_url` |
|  |  |  |  |  |
|  |  |  |  | `return super(BaseTemplateDefinition,` |
|  | |  |  |  |

#### 5 [magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh](#diff-1a1b780fdc64b7a7cbce45144e79dcfc2c5310a8 "magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/make-cert-client.sh)

|  | |  |  | `@ -49,11 +49,6 @@ auth_json=$(cat << EOF` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 5 [magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh](#diff-23e2c3c880e0ac4f7a09fc55c439bbf08efbbfa4 "magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/make-cert.sh)

|  | |  |  | `@ -71,11 +71,6 @@ auth_json=$(cat << EOF` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 2 [magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml](#diff-f91765aba714d50215b95a17e90ee5958ec77f6c "magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_API_PUBLIC_ADDRESS="$KUBE_API_PUBLIC_ADDRESS"` |
|  |  |  |  | `KUBE_API_PRIVATE_ADDRESS="$KUBE_API_PRIVATE_ADDRESS"` |
|  | |  |  |  |

#### 2 [magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml](#diff-205390ec2767cdb58b7f40437ca6392f6ea6bff3 "magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/common/templates/kubernetes/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_ALLOW_PRIV="$KUBE_ALLOW_PRIV"` |
|  |  |  |  | `KUBE_MASTER_IP="$KUBE_MASTER_IP"` |
|  | |  |  |  |

#### 5 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/make-cert-client.yaml](#diff-6a526a857b1187d2558f474d4b59d4b44380be85 "magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert-client.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert-client.yaml)

|  | |  |  | `@ -66,11 +66,6 @@ write_files:` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 5 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/make-cert.yaml](#diff-a31daf1014e2c6891d9c5c6a4cb4af3e7b7682dc "magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/make-cert.yaml)

|  | |  |  | `@ -89,11 +89,6 @@ write_files:` |
|  |  |  |  | `"password": "$TRUSTEE_PASSWORD"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "$TRUST_ID"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  |  |

#### 2 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/write-heat-params-master.yaml](#diff-58c79f3907546c82d3a24253166fce61d11f0192 "magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_API_PUBLIC_ADDRESS="$KUBE_API_PUBLIC_ADDRESS"` |
|  |  |  |  | `KUBE_API_PRIVATE_ADDRESS="$KUBE_API_PRIVATE_ADDRESS"` |
|  | |  |  |  |

#### 2 [magnum/drivers/k8s\_coreos\_v1/templates/fragments/write-heat-params.yaml](#diff-de7be66c36d3cc10421209a74850c5b3eababf3f "magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/k8s_coreos_v1/templates/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `KUBE_ALLOW_PRIV="$KUBE_ALLOW_PRIV"` |
|  |  |  |  | `KUBE_MASTER_IP="$KUBE_MASTER_IP"` |
|  | |  |  |  |

#### 2 [magnum/drivers/mesos\_ubuntu\_v1/templates/fragments/write-heat-params.yaml](#diff-941726854b493cd4bc345acac53bef2c0223e94b "magnum/drivers/mesos_ubuntu_v1/templates/fragments/write-heat-params.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/mesos_ubuntu_v1/templates/fragments/write-heat-params.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `MESOS_MASTERS_IPS="$MESOS_MASTERS_IPS"` |
|  |  |  |  | `EXECUTOR_REGISTRATION_TIMEOUT="$EXECUTOR_REGISTRATION_TIMEOUT"` |
|  | |  |  |  |

#### 6 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/make-cert.py](#diff-29cf41f825f86537fbda37e8d95a831a9379360e "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/make-cert.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/make-cert.py)

|  | |  |  | `@ -147,11 +147,6 @@ def get_user_token(config):` |
|  |  |  |  | `"password": "%(trustee_password)s"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `},` |
|  |  |  |  | `"scope": {` |
|  |  |  |  | `"OS-TRUST:trust": {` |
|  |  |  |  | `"id": "%(trust_id)s"` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  | |  |  | `@ -159,7 +154,6 @@ def get_user_token(config):` |
|  |  |  |  | `params = {` |
|  |  |  |  | `'trustee_user_id': config['TRUSTEE_USER_ID'],` |
|  |  |  |  | `'trustee_password': config['TRUSTEE_PASSWORD'],` |
|  |  |  |  | `'trust_id': config['TRUST_ID']` |
|  |  |  |  | `}` |
|  |  |  |  | `creds = creds_str % params` |
|  |  |  |  | `headers = {'Content-Type': 'application/json'}` |
|  | |  |  |  |

#### 2 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/write-heat-params-master.yaml](#diff-6f65b0303ac33001590f7e8f36ff60fd3e0a7098 "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-master.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-master.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `WAIT_HANDLE_ENDPOINT="$WAIT_HANDLE_ENDPOINT"` |
|  |  |  |  | `WAIT_HANDLE_TOKEN="$WAIT_HANDLE_TOKEN"` |
|  | |  |  |  |

#### 2 [magnum/drivers/swarm\_fedora\_atomic\_v1/templates/fragments/write-heat-params-node.yaml](#diff-f472452e6a4f2aa076350557d48abf21849142f2 "magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-node.yaml") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/drivers/swarm_fedora_atomic_v1/templates/fragments/write-heat-params-node.yaml)

|  | |  |  | `@ -3,7 +3,7 @@ merge_how: dict(recurse_array)+list(append)` |
|  |  |  |  | `write_files:` |
|  |  |  |  | `- path: /etc/sysconfig/heat-params` |
|  |  |  |  | `owner: "root:root"` |
|  |  |  |  | `permissions: "0644"` |
|  |  |  |  | `permissions: "0600"` |
|  |  |  |  | `content: |` |
|  |  |  |  | `WAIT_HANDLE_ENDPOINT="$WAIT_HANDLE_ENDPOINT"` |
|  |  |  |  | `WAIT_HANDLE_TOKEN="$WAIT_HANDLE_TOKEN"` |
|  | |  |  |  |

#### 27 [magnum/tests/base.py](#diff-be3e520cee42a5380a35b94db780cd49240a51f5 "magnum/tests/base.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/base.py)

|  | |  |  | `@ -26,6 +26,7 @@ import pecan` |
|  |  |  |  | `import testscenarios` |
|  |  |  |  |  |
|  |  |  |  | `from magnum.common import context as magnum_context` |
|  |  |  |  | `from magnum.common import keystone as magnum_keystone` |
|  |  |  |  | `from magnum.objects import base as objects_base` |
|  |  |  |  | `from magnum.tests import conf_fixture` |
|  |  |  |  | `from magnum.tests import fake_notifier` |
|  | |  |  | `@ -63,11 +64,18 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `trustee_domain_id = '12345678-9012-3456-7890-123456789abc'` |
|  |  |  |  |  |
|  |  |  |  | `self.context = magnum_context.RequestContext(` |
|  |  |  |  | `auth_token_info=token_info,` |
|  |  |  |  | `project_id='fake_project',` |
|  |  |  |  | `user_id='fake_user')` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks = {}` |
|  |  |  |  |  |
|  |  |  |  | `self.keystone_client = magnum_keystone.KeystoneClientV3(self.context)` |
|  |  |  |  |  |
|  |  |  |  | `self.policy = self.useFixture(policy_fixture.PolicyFixture())` |
|  |  |  |  |  |
|  |  |  |  | `self.useFixture(fixtures.MockPatchObject(` |
|  | |  |  | `@ -89,9 +97,22 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  |  |
|  |  |  |  | `p = mock.patch.object(magnum_context, 'make_context',` |
|  |  |  |  | `side_effect=make_context)` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks['magnum.common.context.make_context'] = p` |
|  |  |  |  |  |
|  |  |  |  | `q = mock.patch.object(magnum_keystone.KeystoneClientV3,` |
|  |  |  |  | `'trustee_domain_id',` |
|  |  |  |  | `return_value=trustee_domain_id)` |
|  |  |  |  |  |
|  |  |  |  | `self.global_mocks[` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id'] = q` |
|  |  |  |  |  |
|  |  |  |  | `self.mock_make_context = p.start()` |
|  |  |  |  | `self.addCleanup(p.stop)` |
|  |  |  |  |  |
|  |  |  |  | `self.mock_make_trustee_domain_id = q.start()` |
|  |  |  |  | `self.addCleanup(q.stop)` |
|  |  |  |  |  |
|  |  |  |  | `self.useFixture(conf_fixture.ConfFixture())` |
|  |  |  |  | `self.useFixture(fixtures.NestedTempfile())` |
|  |  |  |  |  |
|  | |  |  | `@ -104,6 +125,12 @@ class TestCase(base.BaseTestCase):` |
|  |  |  |  |  |
|  |  |  |  | `self.addCleanup(reset_pecan)` |
|  |  |  |  |  |
|  |  |  |  | `def start_global(self, name):` |
|  |  |  |  | `self.global_mocks[name].start()` |
|  |  |  |  |  |
|  |  |  |  | `def stop_global(self, name):` |
|  |  |  |  | `self.global_mocks[name].stop()` |
|  |  |  |  |  |
|  |  |  |  | `def _restore_obj_registry(self):` |
|  |  |  |  | `objects_base.MagnumObjectRegistry._registry._obj_classes \` |
|  |  |  |  | `= self._base_test_obj_backup` |
|  | |  |  |  |

#### 15 [magnum/tests/unit/common/test\_keystone.py](#diff-027328334404b2a79785b7726d045c3cb1e830e3 "magnum/tests/unit/common/test_keystone.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/common/test_keystone.py)

|  | |  |  | `@ -55,6 +55,19 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `admin_tenant_name='service',` |
|  |  |  |  | `group=keystone.CFG_LEGACY_GROUP)` |
|  |  |  |  |  |
|  |  |  |  | `# Disable global mocking for trustee_domain_id` |
|  |  |  |  | `self.stop_global(` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id')` |
|  |  |  |  |  |
|  |  |  |  | `def tearDown(self):` |
|  |  |  |  | `# Re-enable global mocking for trustee_domain_id. We need this because` |
|  |  |  |  | `# mock blows up when trying to stop an already stopped patch (which it` |
|  |  |  |  | `# will do due to the addCleanup() in base.TestCase).` |
|  |  |  |  | `self.start_global(` |
|  |  |  |  | `'magnum.common.keystone.KeystoneClientV3.trustee_domain_id')` |
|  |  |  |  |  |
|  |  |  |  | `super(KeystoneClientTest, self).tearDown()` |
|  |  |  |  |  |
|  |  |  |  | `def test_client_with_password(self, mock_ks):` |
|  |  |  |  | `self.ctx.is_admin = True` |
|  |  |  |  | `ks_client = keystone.KeystoneClientV3(self.ctx)` |
|  | |  |  | `@ -136,6 +149,7 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `ks_client.create_trust(trustee_user='888888')` |
|  |  |  |  |  |
|  |  |  |  | `mock_ks.return_value.trusts.create.assert_called_once_with(` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `trustor_user='123456', project='654321',` |
|  |  |  |  | `trustee_user='888888', role_names=['role1', 'role2'],` |
|  |  |  |  | `impersonation=True)` |
|  | |  |  | `@ -152,6 +166,7 @@ class KeystoneClientTest(base.TestCase):` |
|  |  |  |  | `ks_client.create_trust(trustee_user='888888')` |
|  |  |  |  |  |
|  |  |  |  | `mock_ks.return_value.trusts.create.assert_called_once_with(` |
|  |  |  |  | `delegation_depth=0,` |
|  |  |  |  | `trustor_user='123456', project='654321',` |
|  |  |  |  | `trustee_user='888888', role_names=['role3'],` |
|  |  |  |  | `impersonation=True)` |
|  | |  |  |  |

#### 3 [magnum/tests/unit/conductor/handlers/common/test\_trust\_manager.py](#diff-573fabc47926ad5ed879cee665d8b4a3fabd7040 "magnum/tests/unit/conductor/handlers/common/test_trust_manager.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/common/test_trust_manager.py)

|  | |  |  | `@ -37,6 +37,7 @@ class TrustManagerTestCase(base.BaseTestCase):` |
|  |  |  |  | `mock_generate_password.return_value = mock_password` |
|  |  |  |  | `mock_cluster = mock.MagicMock()` |
|  |  |  |  | `mock_cluster.uuid = 'mock_cluster_uuid'` |
|  |  |  |  | `mock_cluster.project_id = 'mock_cluster_project_id'` |
|  |  |  |  | `mock_keystone = mock.MagicMock()` |
|  |  |  |  | `mock_trustee = mock.MagicMock()` |
|  |  |  |  | `mock_trustee.id = 'mock_trustee_id'` |
|  | |  |  | `@ -52,7 +53,7 @@ class TrustManagerTestCase(base.BaseTestCase):` |
|  |  |  |  | `trust_manager.create_trustee_and_trust(self.osc, mock_cluster)` |
|  |  |  |  |  |
|  |  |  |  | `mock_keystone.create_trustee.assert_called_once_with(` |
|  |  |  |  | `mock_cluster.uuid,` |
|  |  |  |  | `'%s_%s' % (mock_cluster.uuid, mock_cluster.project_id),` |
|  |  |  |  | `mock_password,` |
|  |  |  |  | `)` |
|  |  |  |  | `mock_keystone.create_trust.assert_called_once_with(` |
|  | |  |  |  |

#### 5 [magnum/tests/unit/conductor/handlers/test\_cluster\_conductor.py](#diff-32b27b7e3e9205dc1d31153482395e79a7201403 "magnum/tests/unit/conductor/handlers/test_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_cluster_conductor.py)

|  | |  |  | `@ -191,6 +191,11 @@ class TestHandler(db_base.DbTestCase):` |
|  |  |  |  | `mock_poller.poll_and_check.return_value = loopingcall.LoopingCallDone()` |
|  |  |  |  | `mock_heat_poller_class.return_value = mock_poller` |
|  |  |  |  | `osc = mock.sentinel.osc` |
|  |  |  |  |  |
|  |  |  |  | `def return_keystone():` |
|  |  |  |  | `return self.keystone_client` |
|  |  |  |  |  |
|  |  |  |  | `osc.keystone = return_keystone` |
|  |  |  |  | `mock_openstack_client_class.return_value = osc` |
|  |  |  |  |  |
|  |  |  |  | `def create_stack_side_effect(context, osc, cluster, timeout):` |
|  | |  |  |  |

#### 14 [magnum/tests/unit/conductor/handlers/test\_k8s\_cluster\_conductor.py](#diff-38cc883aaaac12bf783461cd4cdb87bfa3675d1f "magnum/tests/unit/conductor/handlers/test_k8s_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_k8s_cluster_conductor.py)

|  | |  |  | `@ -173,7 +173,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'insecure_registry_url': '10.0.0.1:5000',` |
|  |  |  |  | `'kube_version': 'fake-version',` |
|  | |  |  | `@ -210,6 +210,10 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'RegionOne',` |
|  |  |  |  | `group='docker_registry')` |
|  |  |  |  |  |
|  |  |  |  | `cfg.CONF.set_override('cluster_user_trust',` |
|  |  |  |  | `True,` |
|  |  |  |  | `group='trust')` |
|  |  |  |  |  |
|  |  |  |  | `(template_path,` |
|  |  |  |  | `definition,` |
|  |  |  |  | `env_files) = cluster_conductor._extract_template_definition(` |
|  | |  |  | `@ -311,7 +315,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'ssh_key_name': 'keypair_id',` |
|  |  |  |  | `'tenant_name': 'fake_tenant',` |
|  |  |  |  | `'tls_disabled': False,` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'trustee_domain_id': 'trustee_domain_id',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  | |  |  | `@ -372,7 +376,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'cluster_uuid': self.cluster_dict['uuid'],` |
|  |  |  |  | `'magnum_url': self.mock_osc.magnum_url.return_value,` |
|  | |  |  | `@ -429,7 +433,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'cluster_uuid': self.cluster_dict['uuid'],` |
|  |  |  |  | `'magnum_url': self.mock_osc.magnum_url.return_value,` |
|  | |  |  | `@ -585,7 +589,7 @@ class TestClusterConductorWithK8s(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'insecure_registry_url': '10.0.0.1:5000',` |
|  |  |  |  | `'kube_version': 'fake-version',` |
|  | |  |  |  |

#### 9 [magnum/tests/unit/conductor/handlers/test\_mesos\_cluster\_conductor.py](#diff-aec8efdf52bf9f38b6748dc6120da5901bbb616f "magnum/tests/unit/conductor/handlers/test_mesos_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_mesos_cluster_conductor.py)

|  | |  |  | `@ -37,6 +37,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'http_proxy': 'http_proxy',` |
|  |  |  |  | `'https_proxy': 'https_proxy',` |
|  |  |  |  | `'no_proxy': 'no_proxy',` |
|  |  |  |  | `'registry_enabled': False,` |
|  |  |  |  | `'server_type': 'vm',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'labels': {'rexray_preempt': 'False',` |
|  | |  |  | `@ -109,7 +110,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  | `@ -158,7 +159,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  |  |  |  | `'username': 'mesos_user',` |
|  | |  |  | `@ -208,7 +209,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  | `@ -260,7 +261,7 @@ class TestClusterConductorWithMesos(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'volume_driver': 'volume_driver',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'region_name': self.mock_osc.cinder_region_name.return_value,` |
|  | |  |  |  |

#### 8 [magnum/tests/unit/conductor/handlers/test\_swarm\_cluster\_conductor.py](#diff-b9be38b620d0836ef58541ee456f8af236d84912 "magnum/tests/unit/conductor/handlers/test_swarm_cluster_conductor.py") Unescape Escape [View File](/openstack/magnum/src/commit/0bb0d6486d6771ee21bbf897a091b1aa59e01b22/magnum/tests/unit/conductor/handlers/test_swarm_cluster_conductor.py)

|  | |  |  | `@ -68,6 +68,12 @@ class TestClusterConductorWithSwarm(base.TestCase):` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'coe_version': 'fake-version'` |
|  |  |  |  | `}` |
|  |  |  |  |  |
|  |  |  |  | `# We need this due to volume_driver=rexray` |
|  |  |  |  | `cfg.CONF.set_override('cluster_user_trust',` |
|  |  |  |  | `True,` |
|  |  |  |  | `group='trust')` |
|  |  |  |  |  |
|  |  |  |  | `osc_patcher = mock.patch('magnum.common.clients.OpenStackClients')` |
|  |  |  |  | `self.mock_osc_class = osc_patcher.start()` |
|  |  |  |  | `self.addCleanup(osc_patcher.stop)` |
|  | |  |  | `@ -257,7 +263,7 @@ class TestClusterConductorWithSwarm(base.TestCase):` |
|  |  |  |  | `'trustee_username': 'fake_trustee',` |
|  |  |  |  | `'trustee_password': 'fake_trustee_password',` |
|  |  |  |  | `'trustee_user_id': '7b489f04-b458-4541-8179-6a48a553e656',` |
|  |  |  |  | `'trust_id': 'bd11efc5-d4e2-4dac-bbce-25e348ddf7de',` |
|  |  |  |  | `'trust_id': '',` |
|  |  |  |  | `'auth_url': 'http://192.168.10.10:5000/v3',` |
|  |  |  |  | `'swarm_version': 'fake-version',` |
|  |  |  |  | `'rexray_preempt': 'False'` |
|  | |  |  |  |

Write
Preview

Loading…

x

Add

Cancel
Save

Reference in New Issue

**Repository**
openstack/magnum

**Title**

**Body**

Create Issue

Block a user
Blocking a user prevents them from interacting with repositories, such as opening or commenting on pull requests or issues. Learn more about blocking a user.

User to block:

Optional note:

The note is not visible to the blocked user.

Cancel
Block

[Powered by Gitea](https://about.gitea.com)
Version:
v1.23.1
Page: **877ms**
Template: **466ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Français
Gaeilge
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
മലയാളം
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)



=== Content from bugzilla.suse.com_60c8a44f_20250125_135333.html ===


| Bugzilla – Bug 998182 | VUL-0: CVE-2016-7404: openstack-magnum: Magnum created instances have full API access to creating user's OpenStack account | Last modified: 2017-07-07 10:03:21 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D998182)
* |
  [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

[**Bug 998182**](show_bug.cgi?id=998182)
(CVE-2016-7404)
- VUL-0: CVE-2016-7404: openstack-magnum: Magnum created instances have full API access to creating user's OpenStack account

[Summary:](page.cgi?id=glossary.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
VUL-0: CVE-2016-7404: openstack-magnum: Magnum created instances have full A...

| | [Status](page.cgi?id=status_resolution_matrix.html): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=glossary.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2016-7404 | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | SUSE Security Incidents | | [Classification:](page.cgi?id=glossary.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Novell Products | | [Component:](describecomponents.cgi?product=SUSE Security Incidents "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Incidents ([show other bugs](buglist.cgi?component=Incidents&product=SUSE%20Security%20Incidents&bug_status=__open__)) | | [Version:](page.cgi?id=glossary.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=glossary.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Other Other | |  | | | [Priority](page.cgi?id=glossary.html#priority): | P3 - Medium **Severity**: Normal | | [Target Milestone:](page.cgi?id=glossary.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=glossary.html#assigned_to "The person in charge of resolving the bug.") | Security Team bot | | [QA Contact:](page.cgi?id=glossary.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") | Security Team bot | |  | | | [URL:](page.cgi?id=glossary.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") | <https://trello.com/c/q0y5EQDH> | | [Whiteboard:](page.cgi?id=glossary.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") | CVSSv3:RedHat:CVE-2016-7404:6.5:(AV:... | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=glossary.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=glossary.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2016-09-09 15:07 UTC by Johannes Grassler | | --- | --- | | Modified: | 2017-07-07 10:03 UTC ([History](show_activity.cgi?id=998182)) | | CC List: | 7 users (show)  dmueller meissner mjura rsalevsky sayali.lunkad security-team vuntz | |  | | | [See Also:](page.cgi?id=glossary.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Found By:](page.cgi?id=glossary.html#cf_foundby "A custom Drop Down field in this installation of Bugzilla.") | Development | | [Services Priority:](page.cgi?id=glossary.html#cf_nts_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Business Priority:](page.cgi?id=glossary.html#cf_biz_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Blocker:](page.cgi?id=glossary.html#cf_blocker "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Marketing QA Status:](page.cgi?id=glossary.html#cf_marketing_qa_status "A custom Drop Down field in this installation of Bugzilla.") | --- | | [IT Deployment:](page.cgi?id=glossary.html#cf_it_deployment "A custom Drop Down field in this installation of Bugzilla.") | --- | |  | |  * [Clone This Bug](enter_bug.cgi?cloned_bug_id=998182) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Draft 5 of patch (WIP)**](attachment.cgi?id=695553 "View the content of the attachment") (31.93 KB, patch)  [2016-10-04 08:40 UTC](#attach_695553 "Go to the comment associated with the attachment"), Johannes Grassler | [Details](attachment.cgi?id=695553&action=edit) | [Diff](attachment.cgi?id=695553&action=diff) | | [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=998182&action=viewall&hide_obsolete=1)  [Add an attachment](attachment.cgi?bugid=998182&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=998182&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Comment 2](show_bug.cgi?id=998182#c2)  Swamp Workflow Management   2016-09-10 22:00:14 UTC  ``` bugbot adjusting priority ``` [Comment 5](show_bug.cgi?id=998182#c5)  Marcus Meissner   2016-09-15 08:37:27 UTC  ``` Mitre has assigned CVE-2016-7404. ``` [Comment 6](show_bug.cgi?id=998182#c6)  Johannes Grassler   2016-09-15 14:43:59 UTC  ``` There appears to be a bit of a problem with upstream responsibility for security bugs in Magnum. I asked several core developers, including Hongbin Lu (Magnum's PTL) whether they can access the bug and it 404s for all of them. The reason is because Magnum doesn't appear to be well integrated into the vulnerability management process, i.e. it's not listed on this page and doesn't have a designated vulnerability liason:  <https://wiki.openstack.org/wiki/CrossProjectLiaisons#Vulnerability_management>  That being said, I went with the spirit of the process (default to a project's PTL if nobody is named explicitely) and added Hongbin as a subscriber on the upstream bug. He's currently looking at it. ``` [Comment 32](show_bug.cgi?id=998182#c32)  Marcus Meissner   2017-04-10 13:32:56 UTC  ``` <https://github.com/openstack/magnum/tree/master/etc/magnum> now has it ``` [Comment 35](show_bug.cgi?id=998182#c35)  Marcus Meissner   2017-05-10 15:24:24 UTC  ``` public ``` [Comment 36](show_bug.cgi?id=998182#c36)  Marcus Meissner   2017-05-10 15:26:08 UTC  ``` <https://git.openstack.org/cgit/openstack/magnum/commit/?id=0bb0d6486d6771ee21bbf897a091b1aa59e01b22>  Fix CVE-2016-7404 This commit addresses multiple potential vulnerabilities in Magnum. It makes the following changes:  * Permissions for /etc/sysconfig/heat-params inside Magnum   created instances are tightened to 0600 (used to be 0755). * Certificate retrieval is modified to work without the need   for a Keystone trust. * The cluster's Keystone trust id is only passed into   instances for clusters where that is actually needed. This   prevents the trustee user from consuming the trust in cases   where it is not needed. * The configuration setting trust/cluster_user_trust (False by   default) is introduced. It needs to be explicitely enabled   by the cloud operator to allow clusters that need the   trust_id to be passed into instances to work. Without this   setting, attempts to create such clusters will fail.  Please note, that none of these changes apply to existing clusters. They will have to be deleted and rebuilt to benefit from these changes.  (cherry picked from commit e93d82e8b3bc19211efd54edc17aebdca50670c1)  Changes for backport:  * Moved cluster_user_trust setting to magnum/common/keystone.py * Resolved merge conflicts. * Fixed unit tests with configuration overrides.  Change-Id: I408d845ee4fd00d5bcd1e90f0a78f2bba3f2a57a ``` [Comment 37](show_bug.cgi?id=998182#c37)  Swamp Workflow Management   2017-05-10 16:11:46 UTC  ``` SUSE-SU-2017:1233-1: An update that fixes one vulnerability is now available.  Category: security (moderate) Bug References: 998182 CVE References: CVE-2016-7404 Sources used: SUSE OpenStack Cloud 7 (src):    openstack-magnum-3.1.2~a0~dev20-9.4, openstack-magnum-doc-3.1.2~a0~dev20-9.3 ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=998182)
* - [XML](show_bug.cgi?ctype=xml&id=998182)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=998182)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D998182)
  + |
    [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

+ Legal:
+ [openSUSE](http://en.opensuse.org/Terms_of_site)
+ [SUSE](https://www.suse.com/company/legal/)



=== Content from bugs.launchpad.net_f4e60391_20250126_090929.html ===

[Log in / Register](https://bugs.launchpad.net/magnum/%2Blogin)

[![](/@@/product-logo)](https://launchpad.net/magnum)

## [Magnum](https://launchpad.net/magnum)

* [Overview](https://launchpad.net/magnum)
* [Code](https://code.launchpad.net/magnum)
* Bugs
* [Blueprints](https://blueprints.launchpad.net/magnum)
* [Translations](https://translations.launchpad.net/magnum)
* [Answers](https://answers.launchpad.net/magnum)

[Advanced search](?advanced=1)

Ubuntu
also
tracks bugs for packages derived from this project:
[magnum in Ubuntu](/ubuntu/%2Bsource/magnum).

| **1** → **75** of 314 results | First • Previous • [**Next**](https://bugs.launchpad.net/magnum/%2Bbugs?memo=75&start=75) • [Last](https://bugs.launchpad.net/magnum/%2Bbugs?direction=backwards&start=300) |
| --- | --- |

Critical

In Progress

#1543308
[We must not disable selinux](https://bugs.launchpad.net/magnum/%2Bbug/1543308)

Magnum

10

Critical

Confirmed

#1718947
[Limit the name of the Instance names](https://bugs.launchpad.net/magnum/%2Bbug/1718947)

Magnum

6

High

New

#1422831
[Error on deleting volume on bay update](https://bugs.launchpad.net/magnum/%2Bbug/1422831)

Magnum

18

High

Triaged

#1424969
[os-\*-\* tools should be containerised](https://bugs.launchpad.net/magnum/%2Bbug/1424969)

Magnum

12

High

Confirmed

#1489908
[Tech-Debt: Add tests for DB migration](https://bugs.launchpad.net/magnum/%2Bbug/1489908)

Magnum

6

High

Confirmed

#1539527
[magnum service-list no response if m-cond is down](https://bugs.launchpad.net/magnum/%2Bbug/1539527)

Magnum

6

High

Confirmed

#1556000
[Find an alternative way to replace WSME library](https://bugs.launchpad.net/magnum/%2Bbug/1556000)

Magnum

6

High

In Progress

#1568018
[Stable liberty seems to fail tests](https://bugs.launchpad.net/magnum/%2Bbug/1568018)

Magnum

6

High

In Progress

#1680900
[Reduce size of software-configs in user-data](https://bugs.launchpad.net/magnum/%2Bbug/1680900)

Magnum

8

High

In Progress

#1704329
[Clluster creation failed because of failure in getting etcd discovery url](https://bugs.launchpad.net/magnum/%2Bbug/1704329)

Magnum

6

High

New

#1707024
[CoreDNS 007 is deleted from the dockerhub repo](https://bugs.launchpad.net/magnum/%2Bbug/1707024)

Magnum

6

High

In Progress

#1752433
[trust invalid when user is disabled](https://bugs.launchpad.net/magnum/%2Bbug/1752433)

Magnum

14

High

In Progress

#1775358
[k8s\_fedora\_atomic: Add label to cloud\_provder\_enabled to enable/disable the cloud provider](https://bugs.launchpad.net/magnum/%2Bbug/1775358)

Magnum

6

Medium

Confirmed

#1477444
[document how to setup magnum api with apache](https://bugs.launchpad.net/magnum/%2Bbug/1477444)

Magnum

6

Medium

In Progress

#1490334
[Align k8s CoreOS template with atomic](https://bugs.launchpad.net/magnum/%2Bbug/1490334)

Magnum

30

Medium

New

#1492537
[Tech Debt: cert\_manager should be library](https://bugs.launchpad.net/magnum/%2Bbug/1492537)

Magnum

6

Medium

Confirmed

#1492695
[magnum api report http500 when AuthorizationFailure occur make user confused](https://bugs.launchpad.net/magnum/%2Bbug/1492695)

Magnum

6

Medium

New

#1494800
[Enable ssl pool manager on https](https://bugs.launchpad.net/magnum/%2Bbug/1494800)

Magnum

6

Medium

In Progress

#1496572
[Templates definitions should test outputs against heat templates](https://bugs.launchpad.net/magnum/%2Bbug/1496572)

Magnum

6

Medium

Confirmed

#1499909
[CoreOS doesn't support multi-part mimes and as such doesn't work](https://bugs.launchpad.net/magnum/%2Bbug/1499909)

Magnum

16

Medium

Confirmed

#1510776
[Api hangs if it doesn't receive an ack from conductor](https://bugs.launchpad.net/magnum/%2Bbug/1510776)

Magnum

10

Medium

Fix Committed

#1517218
[consolidate heat fragments](https://bugs.launchpad.net/magnum/%2Bbug/1517218)

Magnum

6

Medium

New

#1535230
[After the delete bay fails we can do nothing](https://bugs.launchpad.net/magnum/%2Bbug/1535230)

Magnum

6

Medium

In Progress

#1536739
[bay create is slow in gates](https://bugs.launchpad.net/magnum/%2Bbug/1536739)

Magnum

10

Medium

In Progress

#1541713
[master\_count should be allowed at update](https://bugs.launchpad.net/magnum/%2Bbug/1541713)

Magnum

6

Medium

In Progress

#1546101
[Add coreos k8s test](https://bugs.launchpad.net/magnum/%2Bbug/1546101)

Magnum

6

Medium

Triaged

#1546817
[Intermittent SSL error in k8s gate job](https://bugs.launchpad.net/magnum/%2Bbug/1546817)

Magnum

6

Medium

Triaged

#1551867
[Magnum config should use a single region](https://bugs.launchpad.net/magnum/%2Bbug/1551867)

Magnum

6

Medium

Fix Committed

#1557312
[--fix-network doesn't pass to bay at all](https://bugs.launchpad.net/magnum/%2Bbug/1557312)

Magnum

6

Medium

Confirmed

#1563248
[Periodic task reports Manifest exceeds maximum allowed size (524288 bytes)](https://bugs.launchpad.net/magnum/%2Bbug/1563248)

Magnum

6

Medium

In Progress

#1580491
[Unable to change master\_count bay attribute](https://bugs.launchpad.net/magnum/%2Bbug/1580491)

Magnum

10

Medium

Triaged

#1594888
[Magnum requires 'auth\_user' despite using Keystone v3](https://bugs.launchpad.net/magnum/%2Bbug/1594888)

Magnum

6

Medium

Triaged

#1596700
 [Pass some common cert related arguments to clients](https://bugs.launchpad.net/magnum/%2Bbug/1596700)

Magnum

6

Medium

In Progress

#1600125
[Can not remove the non-empty nodes of k8sbay](https://bugs.launchpad.net/magnum/%2Bbug/1600125)

Magnum

6

Medium

In Progress

#1607228
[Magnum should allow to disable a conductor service like other openstack components.](https://bugs.launchpad.net/magnum/%2Bbug/1607228)

Magnum

6

Medium

In Progress

#1607230
[Magnum should allow to delete a service from CLI.](https://bugs.launchpad.net/magnum/%2Bbug/1607230)

Magnum

6

Medium

In Progress

#1616156
[error getting node not found](https://bugs.launchpad.net/magnum/%2Bbug/1616156)

Magnum

8

Medium

Triaged

#1623788
[Cluster creation fails on discovery when behind a proxy even after providing proxy information](https://bugs.launchpad.net/magnum/%2Bbug/1623788)

Magnum

12

Medium

In Progress

#1669056
[Reasons are opaque when cluster creates fail](https://bugs.launchpad.net/magnum/%2Bbug/1669056)

Magnum

6

Medium

In Progress

#1722523
[with CoreOS: ERROR: The Parameter (etcd\_volume\_size) was not defined in template.](https://bugs.launchpad.net/magnum/%2Bbug/1722523)

Magnum

28

Medium

Triaged

#1722537
[Create for cluster failed: Unknown attribute for argument cluster: labels (HTTP 400)](https://bugs.launchpad.net/magnum/%2Bbug/1722537)

Magnum

10

Medium

Confirmed

#1744362
[heat-container-agent fails to communicate with Keystone.](https://bugs.launchpad.net/magnum/%2Bbug/1744362)

Magnum

38

Low

New

#1479475
[Document recovery steps if devstack host restart](https://bugs.launchpad.net/magnum/%2Bbug/1479475)

Magnum

8

Low

Confirmed

#1485320
[Resource CREATE failed: NeutronClientException: resources.etc d\_monitor: 404 Not Found](https://bugs.launchpad.net/magnum/%2Bbug/1485320)

Magnum

16

Low

In Progress

#1490320
[Use oslo.reports config options for GMR](https://bugs.launchpad.net/magnum/%2Bbug/1490320)

Magnum

6

Low

New

#1493217
[no\_proxy isn't correctly set if don't provide no\_proxy when create baymodel](https://bugs.launchpad.net/magnum/%2Bbug/1493217)

Magnum

6

Low

In Progress

#1521369
[Refactor Kub template to use '/etc/kubernetes/ssl' for cerificates](https://bugs.launchpad.net/magnum/%2Bbug/1521369)

Magnum

6

Low

New

#1529760
[create lb when service is created](https://bugs.launchpad.net/magnum/%2Bbug/1529760)

Magnum

10

Low

In Progress

#1540126
[Rename "external\_network\_id" to "external\_network"](https://bugs.launchpad.net/magnum/%2Bbug/1540126)

Magnum

8

Low

Incomplete

#1544195
[User can not provision ironic node via nova when providing pre-created port](https://bugs.launchpad.net/magnum/%2Bbug/1544195)

Magnum

22

Low

Triaged

#1546594
[Copy service logs on timeout](https://bugs.launchpad.net/magnum/%2Bbug/1546594)

Magnum

6

Low

Fix Committed

#1547345
[When we create baymodel wth the invalid flavor parameter, the baymodel can be created successfully](https://bugs.launchpad.net/magnum/%2Bbug/1547345)

Magnum

6

Low

Fix Committed

#1551838
[magnum local\_cert\_manager doesn't use x509keypair model](https://bugs.launchpad.net/magnum/%2Bbug/1551838)

Magnum

6

Low

Fix Committed

#1561232
[bashisms found in /bin/sh scripts](https://bugs.launchpad.net/magnum/%2Bbug/1561232)

Magnum

6

Low

In Progress

#1564032
[Add gate test for bay deletion from others](https://bugs.launchpad.net/magnum/%2Bbug/1564032)

Magnum

6

Low

In Progress

#1606113
[Driver for fedora atomic uses deprecated heat resources type.](https://bugs.launchpad.net/magnum/%2Bbug/1606113)

Magnum

6

Low

In Progress

#1607234
[Magnum should provide command for listing complete information of services.](https://bugs.launchpad.net/magnum/%2Bbug/1607234)

Magnum

6

Low

Fix Committed

#1607933
 [Allow passing a "insecure" flag in trusts](https://bugs.launchpad.net/magnum/%2Bbug/1607933)

Magnum

6

Low

Fix Committed

#1608577
[KUBE\_NODE\_PUBLIC\_IP is not being used in fedora driver.](https://bugs.launchpad.net/magnum/%2Bbug/1608577)

Magnum

6

Low

In Progress

#1609674
[Define common security groups and reuse them in all the drivers.](https://bugs.launchpad.net/magnum/%2Bbug/1609674)

Magnum

6

Low

In Progress

#1610186
[Use accounts.yaml file as default method to create users for functional tests](https://bugs.launchpad.net/magnum/%2Bbug/1610186)

Magnum

6

Low

New

#1624977
[[docs] Magnum architecture diagram need to be updated.](https://bugs.launchpad.net/magnum/%2Bbug/1624977)

Magnum

6

Low

In Progress

#1630611
[Wrong reference of Heat resource is set](https://bugs.launchpad.net/magnum/%2Bbug/1630611)

Magnum

6

Low

In Progress

#1638843
[Failed to update cluster when the stackid is none](https://bugs.launchpad.net/magnum/%2Bbug/1638843)

Magnum

6

Low

Confirmed

#1647582
[Ironic driver doesn't support enable\_floating\_ip=False](https://bugs.launchpad.net/magnum/%2Bbug/1647582)

Magnum

6

Low

Confirmed

#1658663
[kubectl, failed to negotiate an api version](https://bugs.launchpad.net/magnum/%2Bbug/1658663)

Magnum

8

Low

In Progress

#1689090
[Wrong code-block used in doc](https://bugs.launchpad.net/magnum/%2Bbug/1689090)

Magnum

6

Low

Confirmed

#1722755
[Fix default docker-storage-driver](https://bugs.launchpad.net/magnum/%2Bbug/1722755)

Magnum

6

Wishlist

Triaged

#1406457
[Add error handling for maximum length of values](https://bugs.launchpad.net/magnum/%2Bbug/1406457)

Magnum

6

Wishlist

Triaged

#1409981
[Tech Debt: Add apiserver\_port params for heat template](https://bugs.launchpad.net/magnum/%2Bbug/1409981)

Magnum

6

Wishlist

Fix Committed

#1460161
[Document the Magnum API](https://bugs.launchpad.net/magnum/%2Bbug/1460161)

Magnum

12

Wishlist

Confirmed

#1472865
[Tech Debt: Make heat timeouts parameters](https://bugs.launchpad.net/magnum/%2Bbug/1472865)

Magnum

6

Wishlist

In Progress

#1490105
[Some of baymodel attributes should be renamed for user-friendliness](https://bugs.launchpad.net/magnum/%2Bbug/1490105)

Magnum

6

Wishlist

New

#1492538
[Tech Debt: clean up exception in local\_cert\_manager](https://bugs.launchpad.net/magnum/%2Bbug/1492538)

Magnum

6

Wishlist

In Progress

#1500998
[Magnum: Tech Debt: Services Implementation enhancements](https://bugs.launchpad.net/magnum/%2Bbug/1500998)

Magnum

12

| **1** → **75** of 314 results | First • Previous • [**Next**](https://bugs.launchpad.net/magnum/%2Bbugs?memo=75&start=75) • [Last](https://bugs.launchpad.net/magnum/%2Bbugs?direction=backwards&start=300) |
| --- | --- |

* [Report a bug](%2Bfilebug)

Bug supervisor:
[Magnum Drivers](https://launchpad.net/~magnum-drivers)

* [New bugs](%2Bbugs?search=Search&field.status=New)
* [Open bugs](https://bugs.launchpad.net/magnum/%2Bbugs)
* [In-progress bugs](%2Bbugs?search=Search&field.status=In+Progress)
* [Critical bugs](%2Bbugs?search=Search&field.importance=Critical&field.status=New&field.status=Incomplete&field.status=Confirmed&field.status=Triaged&field.status=In+Progress&field.status=Fix+Committed)
* [High importance bugs](%2Bbugs?search=Search&field.importance=High&field.status=New&field.status=Incomplete&field.status=Confirmed&field.status=Triaged&field.status=In+Progress&field.status=Fix+Committed)
* [Incomplete bugs](https://bugs.launchpad.net/magnum/%2Bexpirable-bugs)
  (can expire)
* [Bugs fixed elsewhere](https://bugs.launchpad.net/magnum/%2Bbugs?field.status_upstream=resolved_upstream)
* [Bugs with patches](/magnum/%2Bpatches)
* [Open CVE bugs](https://bugs.launchpad.net/magnum/%2Bbugs?field.has_cve=on)
  - [CVE reports](/magnum/%2Bcve)

![](/@@/spinner)

Show more tags…
Show fewer tags…

## Series-targeted bugs

* 1
  [kilo](https://bugs.launchpad.net/magnum/kilo/%2Bbugs)
* 1
  [mitaka](https://bugs.launchpad.net/magnum/mitaka/%2Bbugs)
* 4
  [newton](https://bugs.launchpad.net/magnum/newton/%2Bbugs)
* 3
  [ocata](https://bugs.launchpad.net/magnum/ocata/%2Bbugs)
* 2
  [pike](https://bugs.launchpad.net/magnum/pike/%2Bbugs)
* 6
  [queens](https://bugs.launchpad.net/magnum/queens/%2Bbugs)
* 3
  [rocky](https://bugs.launchpad.net/magnum/rocky/%2Bbugs)
* 1
  [trunk](https://bugs.launchpad.net/magnum/trunk/%2Bbugs)

## Milestone-targeted bugs

* 2
  [newton-2](https://launchpad.net/magnum/%2Bmilestone/newton-2)
* 46
  [mitaka-1](https://launchpad.net/magnum/%2Bmilestone/mitaka-1)

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
4d55102
([Get the code!](https://dev.launchpad.net/))



=== Content from review.opendev.org_0a925145_20250126_090929.html ===



