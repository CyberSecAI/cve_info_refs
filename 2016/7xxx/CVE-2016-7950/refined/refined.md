```
Message-ID: <20161004144653.GB20328@paperthin-usb.laas.fr>
Date: Tue, 4 Oct 2016 16:46:53 +0200
From: Matthieu Herrb <matthieu.herrb@...s.fr>
To: oss-security@...ts.openwall.com
Subject: X.Org security advisory: Protocol handling issues in X Window System
 client libraries

X.Org security advisory: October 4, 2016

Protocol handling issues in X Window System client libraries
============================================================

Description

Tobias Stoeckmann from the OpenBSD project has discovered a number of
issues in the way various X client libraries handle the responses they
receive from servers, and has worked with X.Org's security team to
analyze, confirm, and fix these issues. These issue come in addition
to the ones discovered by Ilja van Sprundel in 2013.

Most of these issues stem from the client libraries trusting the
server to send correct protocol data, and not verifying that the
values will not overflow or cause other damage. Most of the time X
clients & servers are run by the same user, with the server more
privileged than the clients, so this is not a problem, but there are
scenarios in which a privileged client can be connected to an
unprivileged server, for instance, connecting a setuid X client (such
as a screen lock program) to a virtual X server (such as Xvfb or
Xephyr) which the user has modified to return invalid data,
potentially allowing the user to escalate their privileges.

The X.Org security team would like to take this opportunity to remind
X client authors that current best practices suggest separating code
that requires privileges from the GUI, to reduce the attack surface of
issues like this.

Affected libraries and CVE Ids
...
libXrender - insufficient validation of data from the X server
	can cause out of boundary memory writes.
	Affected version: libXrender <= 0.9.9
...
Fixes
...
libXrender
9362c7d Validate lengths while parsing server data.
8fad00b Avoid OOB write in XRenderQueryFilters
...
They will also be available in these modules releases from X.Org:
...
 * libXrender 0.9.10
...
Thanks
...
--
Matthieu Herrb
```
```
# X.Org security advisory: Protocol handling issues in X Window System client libraries

**Matthieu Herrb**
matthieu at herrb.eu

*Tue Oct 4 14:01:07 UTC 2016*
...
```
```
X.Org security advisory: October 4, 2016

Protocol handling issues in X Window System client libraries
============================================================

Description

Tobias Stoeckmann from the OpenBSD project has discovered a number of
issues in the way various X client libraries handle the responses they
receive from servers, and has worked with X.Org's security team to
analyze, confirm, and fix these issues. These issue come in addition
to the ones discovered by Ilja van Sprundel in 2013.

Most of these issues stem from the client libraries trusting the
server to send correct protocol data, and not verifying that the
values will not overflow or cause other damage. Most of the time X
clients & servers are run by the same user, with the server more
privileged than the clients, so this is not a problem, but there are
scenarios in which a privileged client can be connected to an
unprivileged server, for instance, connecting a setuid X client (such
as a screen lock program) to a virtual X server (such as Xvfb or
Xephyr) which the user has modified to return invalid data,
potentially allowing the user to escalate their privileges.

The X.Org security team would like to take this opportunity to remind
X client authors that current best practices suggest separating code
that requires privileges from the GUI, to reduce the attack surface of
issues like this.

Affected libraries and CVE Ids
...
libXrender - insufficient validation of data from the X server
	can cause out of boundary memory writes.
	Affected version: libXrender <= 0.9.9
...
Fixes

Fixes are available in the following git commits.
...
libXrender
9362c7d Validate lengths while parsing server data.
8fad00b Avoid OOB write in XRenderQueryFilters
...
They will also be available in these modules releases from X.Org:
...
 * libXrender 0.9.10
...
Thanks
...
--
Matthieu Herrb

```
```
Message-Id: <20161004164544.B3A4342E016@smtpvbsrv1.mitre.org>
Date: Tue,  4 Oct 2016 12:45:44 -0400 (EDT)
From: cve-assign@...re.org
To: meissner@...e.de
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: X.Org security advisory: Protocol handling issues in X Window System client libraries
...
> libXrender - insufficient validation of data from the X server
>       can cause out of boundary memory writes.
>       Affected version: libXrender <= 0.9.9

> <https://cgit.freedesktop.org/xorg/lib/libXrender/commit/?id=9362c7ddd1af3b168953d0737877bc52d79c94f4> Validate lengths while parsing server data.

Use CVE-2016-7949.

> <https://cgit.freedesktop.org/xorg/lib/libXrender/commit/?id=8fad00b0b647ee662ce4737ca15be033b7a21714> Avoid OOB write in XRenderQueryFilters

Use CVE-2016-7950.
...
-----BEGIN PGP SIGNATURE-----
...
=Lv54
-----END PGP SIGNATURE-----
```
```
# X.Org: Multiple vulnerabilities — GLSA **201704-03**
...
| Package | **x11-libs/libXrender** on all architectures |
| --- | --- |
| Affected versions | < **0.9.10** |
| Unaffected versions | >= **0.9.10** |
...
### Description

Multiple vulnerabilities have been discovered in X.Org server and
libraries. Please review the CVE identifiers referenced below for
details.

### Impact

A local or remote users can utilize the vulnerabilities to attach to the
X.Org session as a user and execute arbitrary code.
...
### References
...
* [CVE-2016-7950](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-7950)
...
**Severity**

high

**Exploitable**

local, remote
...

```
```
[**Bug 1381928**](show_bug.cgi?id=1381928)
(CVE-2016-7950)
- [CVE-2016-7950](https://access.redhat.com/security/cve/CVE-2016-7950) libXrender: Insufficient validation of server responses results out-of-bounds write in XRenderQueryFilters
...
| [Status](page.cgi?id=fields.html#bug_status): | CLOSED WONTFIX |
...
| Fixed In Version: | libXrender 0.9.10 |
...
[Description](show_bug.cgi?id=1381928#c0)  Andrej Nemec    2016-10-05 11:34:23 UTC  ```  It was found that when receiving a response from the server protocol data is not validated sufficiently. The memory for filter names is reserved right after receiving the reply. After that, filters are iterated and each individual filter name is stored in that reserved memory. The individual name lengths are not checked for validity, which means that a malicious server can reserve less memory than it will write to during each iteration.  Upstream patch:  <https://cgit.freedesktop.org/xorg/lib/libXrender/commit/?id=8fad00b0b647ee662ce4737ca15be033b7a21714>  External References:  <https://lists.x.org/archives/xorg-announce/2016-October/002720.html>  CVE assignment:  <http://seclists.org/oss-sec/2016/q4/17>   ```
```
```
[SECURITY] Fedora 25 Update: libXrender-0.9.10-1.fc25
...
--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2016-7949, CVE-2016-7950
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #1381927 - CVE-2016-7949 libXrender: Insufficient validation of server responses results in overflow of previously reserved memory
<https://bugzilla.redhat.com/show_bug.cgi?id=1381927>
[ 2 ] Bug #1381928 - CVE-2016-7950 libXrender: Insufficient validation of server responses results out-of-bounds write in XRenderQueryFilters
<https://bugzilla.redhat.com/show_bug.cgi?id=1381928>
...
```
```
| author | Tobias Stoeckmann <tobias@stoeckmann.org> | 2016-09-25 21:42:09 +0200 |
| --- | --- | --- |
| committer | Matthieu Herrb <matthieu@herrb.eu> | 2016-09-25 22:14:27 +0200 |
| commit | [8fad00b0b647ee662ce4737ca15be033b7a21714](/xorg/lib/libXrender/commit/?id=8fad00b0b647ee662ce4737ca15be033b7a21714) ([patch](/xorg/lib/libXrender/patch/?id=8fad00b0b647ee662ce4737ca15be033b7a21714)) | |
| tree | [defc41b75d44d03839779cd43a72288efc3ee004](/xorg/lib/libXrender/tree/?id=8fad00b0b647ee662ce4737ca15be033b7a21714) | |
| parent | [b2df5bc42f64b45e44dbad61f3386bcb5ec1383d](/xorg/lib/libXrender/commit/?id=b2df5bc42f64b45e44dbad61f3386bcb5ec1383d) ([diff](/xorg/lib/libXrender/diff/?id=8fad00b0b647ee662ce4737ca15be033b7a21714&id2=b2df5bc42f64b45e44dbad61f3386bcb5ec1383d)) | |

Avoid OOB write in XRenderQueryFiltersThe memory for filter names is reserved right after receiving the reply.
After that, filters are iterated and each individual filter name is
stored in that reserved memory.
The individual name lengths are not checked for validity, which means
that a malicious server can reserve less memory than it will write to
during each iteration.
v2: consume remaining bytes in reply buffer on error.
Signed-off-by: Tobias Stoeckmann <tobias@stoeckmann.org>
Reviewed-by: Matthieu Herrb <matthieu@herrb.eu>
[Diffstat](/xorg/lib/libXrender/diff/?id=8fad00b0b647ee662ce4737ca15be033b7a21714)

| -rw-r--r-- | [src/Filter.c](/xorg/lib/libXrender/diff/src/Filter.c?id=8fad00b0b647ee662ce4737ca15be033b7a21714) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/src/Filter.c b/src/Filter.cindex edfa572..8d701eb 100644--- a/[src/Filter.c](/xorg/lib/libXrender/tree/src/Filter.c?id=b2df5bc42f64b45e44dbad61f3386bcb5ec1383d)+++ b/[src/Filter.c](/xorg/lib/libXrender/tree/src/Filter.c?id=8fad00b0b647ee662ce4737ca15be033b7a21714)@@ -38,7 +38,7 @@ XRenderQueryFilters (Display \*dpy, Drawable drawable) char \*name; char len; int i;- unsigned long nbytes, nbytesAlias, nbytesName;+ unsigned long nbytes, nbytesAlias, nbytesName, reply\_left;  if (!RenderHasExtension (info)) return NULL;@@ -114,6 +114,7 @@ XRenderQueryFilters (Display \*dpy, Drawable drawable) \* Read the filter aliases \*/ \_XRead16Pad (dpy, filters->alias, 2 \* rep.numAliases);+ reply\_left = 8 + rep.length - 2 \* rep.numAliases;;  /\* \* Read the filter names@@ -122,9 +123,19 @@ XRenderQueryFilters (Display \*dpy, Drawable drawable) { int l; \_XRead (dpy, &len, 1);+ reply\_left--; l = len & 0xff;+ if ((unsigned long)l + 1 > nbytesName) {+ \_XEatDataWords(dpy, reply\_left);+ Xfree(filters);+ UnlockDisplay (dpy);+ SyncHandle ();+ return NULL;+ }+ nbytesName -= l + 1; filters->filter[i] = name; \_XRead (dpy, name, l);+ reply\_left -= l; name[l] = '\0'; name += l + 1; } |
| --- |
```
```
[SECURITY] Fedora 24 Update: libXrender-0.9.10-1.fc24
...
--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2016-7949, CVE-2016-7950
--------------------------------------------------------------------------------
References:

[ 1 ] Bug #1381927 - CVE-2016-7949 libXrender: Insufficient validation of server responses results in overflow of previously reserved memory
<https://bugzilla.redhat.com/show_bug.cgi?id=1381927>
[ 2 ] Bug #1381928 - CVE-2016-7950 libXrender: Insufficient validation of server responses results out-of-bounds write in XRenderQueryFilters
<https://bugzilla.redhat.com/show_bug.cgi?id=1381928>
...
```
Based on the provided information, here's an analysis of CVE-2016-7950:

**Root cause of vulnerability:**
The vulnerability stems from insufficient validation of data received from an X server by the `libXrender` client library, specifically in the `XRenderQueryFilters` function. The client reserves memory for filter names based on the server's initial response. However, the client does not validate the individual lengths of the filter names sent by the server during iteration, potentially allowing a malicious server to send filter name lengths that exceed the reserved memory, causing out-of-bounds write.

**Weaknesses/vulnerabilities present:**
- **Insufficient input validation:** The client library trusts the server to provide valid filter name lengths, failing to check if those lengths would cause an out-of-bounds write.
- **Out-of-bounds write:**  The vulnerability leads to an out-of-bounds write on the heap if the server provides filter names with lengths that, during iteration, exceed the initial memory allocation.

**Impact of exploitation:**
- **Memory Corruption:** An attacker can cause memory corruption via out-of-bounds write.
- **Arbitrary Code Execution**: As the advisory in gentoo states, it can allow local or remote attackers to execute arbitrary code.
- **Privilege Escalation:** If a privileged client is connected to an unprivileged server controlled by the attacker, the attacker can potentially escalate their privileges.

**Attack vectors:**
- A malicious or compromised X server sending specially crafted responses to a vulnerable `libXrender` client.
- This can occur when a privileged client is connected to an unprivileged server, such as a setuid screen lock program connecting to a virtual X server modified by an attacker.
- The vulnerability can also be exploited in a local setting, where the attacker has the ability to influence the X server's responses

**Required attacker capabilities/position:**
- Control over the X server or ability to influence its responses.
- Ability to establish a connection to a vulnerable `libXrender` client.
- Knowledge of the vulnerable X protocol and how to craft malicious server responses.