```
Message-ID: <ea35113c-d493-4bf7-ca47-9df7891dde67@mantisbt.org>
Date: Sat, 27 Aug 2016 23:16:56 +0200
From: Damien Regad <dregad@...tisbt.org>
To: oss-security@...ts.openwall.com
Subject: MantisBT weakened CSP when using bundled Gravatar plugin

Greetings,

Please assign a CVE ID for the following issue.

Description
-----------
MantisBT 1.3.0-rc.2 introduced a new bundled plugin to handle display of
users' avatars using Gravatar.

Instead of adding the Gravatar web site to the list of allowed image
sources in MantisBT's Content Security Policy, the plugin was replacing
the whole policy by:

   img-src 'self' <http://www.gravatar.com/>

instead of the more strict default one of:

   default-src 'self'; frame-ancestors 'none'; style-src 'self';
   script-src 'self'

Relaxed policy allows execution of remote and inline scripts, e.g.
potentially enabling XSS attacks.

Affected versions
-----------------
- >= 1.3.0-rc.2
- >= 2.0.0-beta.1

Fixed in versions:
------------------
- 1.3.1
- 2.0.0-beta.2

As of this writing, these have not been released yet, but both should be
available in the coming days. Until then, installations should be
patched manually.

As a workaround, disabling the Gravatar plugin restores the safer
default policy.
```
- **Root cause of vulnerability:** The Gravatar plugin in MantisBT versions 1.3.0-rc.2 and later, and 2.0.0-beta.1 and later, replaces the default Content Security Policy (CSP) with a less restrictive one.
- **Weaknesses/vulnerabilities present:** The plugin replaces the default CSP with `img-src 'self' <http://www.gravatar.com/>`. This weakens the CSP by removing directives like `default-src 'self'`, `frame-ancestors 'none'`, `style-src 'self'`, and `script-src 'self'`, allowing for the execution of remote and inline scripts.
- **Impact of exploitation:** The relaxed CSP can lead to Cross-Site Scripting (XSS) attacks by allowing execution of remote and inline scripts.
- **Attack vectors:** An attacker could inject malicious scripts, taking advantage of the relaxed CSP.
- **Required attacker capabilities/position:** An attacker needs to be able to inject malicious scripts into the web application, leveraging the relaxed CSP.

```
Message-Id: <20160829215135.463377BC071@smtpvmsrv1.mitre.org>
Date: Mon, 29 Aug 2016 17:51:35 -0400 (EDT)
From: cve-assign@...re.org
To: dregad@...tisbt.org
Cc: cve-assign@...re.org, oss-security@...ts.openwall.com
Subject: Re: MantisBT weakened CSP when using bundled Gravatar plugin
Use CVE-2016-7111.
```

This content assigns CVE-2016-7111 to the described vulnerability.

```
Description | When sending the same HTTP variable to PHP twice via the header() function, the old value is replaced. The default Gravatar plugin sets its own "Content-Security-Policy" HTTP header, which overrides the more strict defaults normally used by Mantis. Mantis should probably offer a plugin hook (as once discussed in [0011826:0025958](/bugs/view.php?id=11826#c25958 "0011826: [2010-06-23 01:53] dhx")) so that any plugin can add its wanted CSP rules before the header is sent. |
```
This confirms the vulnerability details. It mentions that the Gravatar plugin overrides the default CSP due to how PHP's `header()` function handles duplicate headers and suggests a plugin hook.

```
Add API for Content-Security-Policy
Add APIs to allow plugins to change the Content-Security-Policy header.
```

```
Protect against calling http\_csp\_add() too late
If the CSP header is sent and then http_csp_add() is called, trigger error.
```

```
Fix weakened CSP by Gravatar plugin
Merge vboctor's branch 'issue_21263_csp_headers_13x'
```
These commit messages describe fixes that were implemented to address the vulnerability:
  - APIs were added to allow plugins to modify the CSP header.
  - A check was added to trigger an error if `http_csp_add()` is called after the CSP header is sent.
  - The Gravatar plugin's CSP handling was corrected to not override the default CSP

```
Add EVENT\_CORE\_HEADERS event
Called before core emits headers enabling plugins to emit their
own headers or call APIs that shape the value of headers emitted by
core like Content-Security-Policy.
```
This commit adds a new event that fires before headers are emitted, allowing plugins to modify them, which is a key part of addressing the vulnerability.