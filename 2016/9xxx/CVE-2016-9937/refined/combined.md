=== Content from downloads.asterisk.org_56a6acad_20250124_230856.html ===
commit 888142e89160169220bff1bae742f6ef558a7b11
Author: Joshua Colp
Date: Tue Nov 15 00:18:21 2016 +0000
res\_format\_attr\_opus: Fix crash when fmtp contains spaces.
When an opus offer or answer was received that contained an
fmtp line with spaces between the attributes the module would
fail to properly parse it and crash due to recursion.
This change makes the module handle the space properly and
also removes the recursion requirement.
ASTERISK-26579
Change-Id: I01f53e5d9fa9f1925a7365f8d25071b5b3ac2dc3
diff --git a/res/res\_format\_attr\_opus.c b/res/res\_format\_attr\_opus.c
index 49382f6..857b943 100644
--- a/res/res\_format\_attr\_opus.c
+++ b/res/res\_format\_attr\_opus.c
@@ -102,27 +102,35 @@ static int opus\_clone(const struct ast\_format \*src, struct ast\_format \*dst)
static void sdp\_fmtp\_get(const char \*attributes, const char \*name, int \*attr)
{
- const char \*kvp = "";
+ const char \*kvp = attributes;
int val;
- if (attributes && !(kvp = strstr(attributes, name))) {
+ if (ast\_strlen\_zero(attributes)) {
return;
}
- /\*
- \* If the named attribute is not at the start of the given attributes, and
- \* the preceding character is not a space or semicolon then it's not the
- \* attribute we are looking for. It's an attribute with the name embedded
- \* within it (e.g. ptime in maxptime, stereo in sprop-stereo).
+ /\* This logic goes through each attribute in the fmtp line looking for the
+ \* requested named attribute.
\*/
- if (kvp != attributes && \*(kvp - 1) != ' ' && \*(kvp - 1) != ';') {
- /\* Keep searching as it might still be in the attributes string \*/
- sdp\_fmtp\_get(strchr(kvp, ';'), name, attr);
- /\*
- \* Otherwise it's a match, so retrieve the value and set the attribute.
- \*/
- } else if (sscanf(kvp, "%\*[^=]=%30d", &val) == 1) {
- \*attr = val;
+ while (\*kvp) {
+ /\* Skip any preceeding blanks as some implementations separate attributes using spaces too \*/
+ kvp = ast\_skip\_blanks(kvp);
+
+ /\* If we are at at the requested attribute get its value and return \*/
+ if (!strncmp(kvp, name, strlen(name)) && kvp[strlen(name)] == '=') {
+ if (sscanf(kvp, "%\*[^=]=%30d", &val) == 1) {
+ \*attr = val;
+ break;
+ }
+ }
+
+ /\* Move on to the next attribute if possible \*/
+ kvp = strchr(kvp, ';');
+ if (!kvp) {
+ break;
+ }
+
+ kvp++;
}
}


=== Content from issues.asterisk.org_5d33729f_20250124_230900.html ===

[[Home](/)]

| Summary: | ASTERISK-26579: codec\_opus: Recursiveness when parsing fmtp line | | |
| --- | --- | --- | --- |
| Reporter: | JÃ¸rgen H (jorgen) | Labels: |  |
| Date Opened: | 2016-11-11 04:23:57.000-0600 | Date Closed: | 2016-12-08 11:07:01.000-0600 |
| Priority: | Major | Regression? |  |
| Status: | Closed/Complete | Components: | Resources/res\_format\_attr\_opus |
| Versions: | 14.1.2 | Frequency ofOccurrence | Constant |
| RelatedIssues: |  | | |
| Environment: | linux x64 | Attachments: | ( 0) [res\_format\_attr\_opus.diff](../attachments/26/ASTERISK-26579/00-res_format_attr_opus.diff)( 1) [res\_format\_attr\_opus.diff](../attachments/26/ASTERISK-26579/01-res_format_attr_opus.diff)( 2) [res\_format\_attr\_opus.diff](../attachments/26/ASTERISK-26579/02-res_format_attr_opus.diff) |
| Description: | recursive stack overflow  {noformat}  sdp\_fmtp\_get (attributes=<optimized out>, name=0x7ff5071de32c "ptime", attr=0x7ff4fc0548f8) at res\_format\_attr\_opus.c:120  #6450 0x00007ff5071dc957 in sdp\_fmtp\_get (attr=<optimized out>, name=<optimized out>, attributes=<optimized out>) at res\_format\_attr\_opus.c:120  {noformat}  sdp is  {noformat}  v=0  o=- 975991180 975991180 IN IP4 xxx  s=Asterisk  c=IN IP4 xxx  t=0 0  m=audio 25524 RTP/AVP 107 8 0 4 9 101  a=rtpmap:107 opus/48000/2  a=rtpmap:8 PCMA/8000  a=rtpmap:0 PCMU/8000  a=rtpmap:4 G723/8000  a=rtpmap:9 G722/8000  a=rtpmap:101 telephone-event/8000  a=fmtp:101 0-16  a=ptime:20  a=maxptime:20  {noformat} | | |
| Comments: | By: Asterisk Team (asteriskteam) 2016-11-11 04:23:58.718-0600Thanks for creating a report! The issue has entered the triage process. That means the issue will wait in this status until a Bug Marshal has an opportunity to review the issue. Once the issue has been reviewed you will receive comments regarding the next steps towards resolution.   A good first step is for you to review the [Asterisk Issue Guidelines|https://wiki.asterisk.org/wiki/display/AST/Asterisk+Issue+Guidelines] if you haven't already. The guidelines detail what is expected from an Asterisk issue report.   Then, if you are submitting a patch, please review the [Patch Contribution Process|https://wiki.asterisk.org/wiki/display/AST/Patch+Contribution+Process].  ---   By: JÃ¸rgen H (jorgen) 2016-11-11 05:41:55.755-0600I'm not very into asterisk code, but this code is probably fix:   [Edit by Rusty - inline patch removed as per guidelines]  ---   By: Rusty Newton (rnewton) 2016-11-11 08:55:27.081-0600Thanks for the report! Unfortunately we cannot accept inline patches due to legal reasons.   If you'd like to submit a patch, please sign a license agreement and attach the patch to the issue using (More > Attach Files) and mark it as a contribution so that it will be associated with your license.   ---   By: JÃ¸rgen H (jorgen) 2016-11-12 14:51:21.531-0600suggestion to fix  ---   By: Rusty Newton (rnewton) 2016-11-13 08:22:51.141-0600Once your license is accepted, you'll need to reattach the patch and mark it as contribution for it to be visible. Otherwise it won't show up.   You likely tried to attach it too early, as I see in the history where you attached it, but it is not visible on the issue.  ---   By: Joshua C. Colp (jcolp) 2016-11-14 09:18:58.438-0600I'm currently investigating this issue and have been unable to reproduce it using the information provided. I've tried both incoming and outgoing calls on chan\_pjsip and chan\_sip.   Can you provide the complete console output, SIP trace, and scenario information?  ---   By: JÃ¸rgen H (jorgen) 2016-11-14 09:51:55.178-0600I seem to have included the sdp request in the bug, not the response that actually caused the segfault (but it is pretty similar). Here it is:   v=0  o=FreeSWITCH 1479107831 1479107832 IN IP4 xxxx  s=FreeSWITCH  c=IN IP4 xxxxx  t=0 0  m=audio 30666 RTP/AVP 107 101  a=rtpmap:107 opus/48000/2  a=fmtp:107 useinbandfec=0; cbr=1; minptime=10; maxptime=40  a=rtpmap:101 telephone-event/8000  a=fmtp:101 0-16  a=ptime:20  ---   By: Joshua C. Colp (jcolp) 2016-11-14 10:26:55.377-0600That is the data needed, thanks!  ---   By: Joshua C. Colp (jcolp) 2016-11-15 07:36:59.854-0600If you've signed the license agreement would you like to reattach the change so it can be used?  ---   By: JÃ¸rgen H (jorgen) 2016-11-15 11:24:08.844-0600suggestion to fix  ---   By: Joshua C. Colp (jcolp) 2016-11-15 11:25:25.113-0600Thanks! I ended up with something similar, but different.  ---   By: JÃ¸rgen H (jorgen) 2016-11-15 11:27:44.447-0600I dont think the website works uploading files using standard company security settings.  The file is located here:   https://mail.jcloud.no/file\_link?id=210&password=142531406075991303680x7fdb5ea4b2f01479230744870340695447734843   JS errors when posting:  [Error] QuotaExceededError: DOM Exception 22: An attempt was made to add something to storage that exceeded the quota.  aspect  toggle  dispatch  i  [Error] QuotaExceededError: DOM Exception 22: An attempt was made to add something to storage that exceeded the quota.  setItem  setItem  setIssueUpdatedMsg  storeCurrentIssueIdOnSucessfulSubmit  \_handleSubmitResponse  complete  completeHandler  j  fireWith  c  b  ---   By: JÃ¸rgen H (jorgen) 2016-11-15 11:28:53.714-0600Great. Ok nevermind. I'm just new to Jira :)  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:07:02.350-0600Change 4580 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4580|https://gerrit.asterisk.org/4580]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:07:13.905-0600Change 4579 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4579|https://gerrit.asterisk.org/4579]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:07:22.703-0600Change 4589 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4589|https://gerrit.asterisk.org/4589]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:07:48.018-0600Change 4578 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4578|https://gerrit.asterisk.org/4578]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:08:02.900-0600Change 4588 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4588|https://gerrit.asterisk.org/4588]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:08:11.403-0600Change 4581 merged by Kevin Harwell:  res\_format\_attr\_opus: Fix crash when fmtp contains spaces.   [https://gerrit.asterisk.org/4581|https://gerrit.asterisk.org/4581]  ---   By: Friendly Automation (friendly-automation) 2016-12-08 11:08:24.663-0600Change 4577 merged by Kevin Harwell:  codecs/opus/fmtp\_with\_spaces: Add test for fmtp parsing with spaces.   [https://gerrit.asterisk.org/4577|https://gerrit.asterisk.org/4577]  --- | | |



=== Content from downloads.asterisk.org_3942a6dd_20250124_230857.html ===


Asterisk
Project Security Advisory - AST-2016-008

| **Product** | Asterisk |
| **Summary** | Crash on SDP offer or answer from endpoint using Opus |
| **Nature of Advisory** | Remote Crash |
| **Susceptibility** | Remote unauthenticated sessions |
| **Severity** | Critical |
| **Exploits Known** | No |
| **Reported On** | November 11, 2016 |
| **Reported By** | jorgen |
| **Posted On** | December 08, 2016 |
| **Last Updated On** | December 13, 2016 |
| **Advisory Contact** | jcolp AT digium DOT com |
| **CVE Name** | CVE-2016-9937 |

| **Description** | If an SDP offer or answer is received with the Opus codec and with the format parameters separated using a space the code responsible for parsing will recursively call itself until it crashes. This occurs as the code does not properly handle spaces separating the parameters. This does NOT require the endpoint to have Opus configured in Asterisk. This also does not require the endpoint to be authenticated. If guest is enabled for chan\_sip or anonymous in chan\_pjsip an SDP offer or answer is still processed and the crash occurs. |

| **Resolution** | The code has been updated to properly handle spaces separating parameters in the fmtp line. Upgrade to a released version with the fix incorporated or apply patch. |

| **Affected Versions** | | |
| **Product** | **Release Series** |  |
| Asterisk Open Source | 13.x | 13.12.0 and higher |
| Asterisk Open Source | 14.x | All Versions |

| **Corrected In** | |
| **Product** | **Release** |
| Asterisk Open Source | 13.13.1, 14.2.1 |

| **Patches** | |
| **SVN URL** | **Revision** |
| http://downloads.asterisk.org/pub/security/AST-2016-008-13.diff | Asterisk 13 |
| http://downloads.asterisk.org/pub/security/AST-2016-008-14.diff | Asterisk 14 |

| **Links** | https://issues.asterisk.org/jira/browse/ASTERISK-26579 |

| Asterisk Project Security Advisories are posted at <http://www.asterisk.org/security>  This document may be superseded by later versions; if so, the latest version will be posted at http://downloads.digium.com/pub/security/AST-2016-008.pdf and http://downloads.digium.com/pub/security/AST-2016-008.html |

| **Revision History** | | |
| **Date** | **Editor** | **Revisions Made** |
| November 15, 2016 | Joshua Colp | Initial draft of Advisory |
| December 13, 2016 | Kevin Harwell | Added CVE number |

Asterisk
Project Security Advisory - AST-2016-008
Copyright
Â© 2016
Digium, Inc. All Rights Reserved.
Permission is hereby granted
to distribute and publish this advisory in its original, unaltered
form.



=== Content from downloads.asterisk.org_e7a9102a_20250124_230856.html ===
commit 98b94af8c3eab49249996eab8cb531685fc02dc0
Author: Joshua Colp
Date: Tue Nov 15 00:18:21 2016 +0000
res\_format\_attr\_opus: Fix crash when fmtp contains spaces.
When an opus offer or answer was received that contained an
fmtp line with spaces between the attributes the module would
fail to properly parse it and crash due to recursion.
This change makes the module handle the space properly and
also removes the recursion requirement.
ASTERISK-26579
Change-Id: I01f53e5d9fa9f1925a7365f8d25071b5b3ac2dc3
diff --git a/res/res\_format\_attr\_opus.c b/res/res\_format\_attr\_opus.c
index e4145d1..a763c3b 100644
--- a/res/res\_format\_attr\_opus.c
+++ b/res/res\_format\_attr\_opus.c
@@ -102,27 +102,35 @@ static int opus\_clone(const struct ast\_format \*src, struct ast\_format \*dst)
static void sdp\_fmtp\_get(const char \*attributes, const char \*name, int \*attr)
{
- const char \*kvp = "";
+ const char \*kvp = attributes;
int val;
- if (attributes && !(kvp = strstr(attributes, name))) {
+ if (ast\_strlen\_zero(attributes)) {
return;
}
- /\*
- \* If the named attribute is not at the start of the given attributes, and
- \* the preceding character is not a space or semicolon then it's not the
- \* attribute we are looking for. It's an attribute with the name embedded
- \* within it (e.g. ptime in maxptime, stereo in sprop-stereo).
+ /\* This logic goes through each attribute in the fmtp line looking for the
+ \* requested named attribute.
\*/
- if (kvp != attributes && \*(kvp - 1) != ' ' && \*(kvp - 1) != ';') {
- /\* Keep searching as it might still be in the attributes string \*/
- sdp\_fmtp\_get(strchr(kvp, ';'), name, attr);
- /\*
- \* Otherwise it's a match, so retrieve the value and set the attribute.
- \*/
- } else if (sscanf(kvp, "%\*[^=]=%30d", &val) == 1) {
- \*attr = val;
+ while (\*kvp) {
+ /\* Skip any preceeding blanks as some implementations separate attributes using spaces too \*/
+ kvp = ast\_skip\_blanks(kvp);
+
+ /\* If we are at at the requested attribute get its value and return \*/
+ if (!strncmp(kvp, name, strlen(name)) && kvp[strlen(name)] == '=') {
+ if (sscanf(kvp, "%\*[^=]=%30d", &val) == 1) {
+ \*attr = val;
+ break;
+ }
+ }
+
+ /\* Move on to the next attribute if possible \*/
+ kvp = strchr(kvp, ';');
+ if (!kvp) {
+ break;
+ }
+
+ kvp++;
}
}

