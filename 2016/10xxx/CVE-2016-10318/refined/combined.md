=== Content from www.kernel.org_91f8533f_20250125_151501.html ===
commit bd333da7f0dfb64d68774e283044be2996bda301
Author: Greg Kroah-Hartman
Date: Thu Sep 15 08:21:53 2016 +0200
Linux 4.7.4
commit 651e6e1500e598519d0f3463f30fa8448a791e68
Author: Wei Yongjun
Date: Sun Aug 21 15:41:44 2016 +0000
cpufreq: dt: Add terminate entry for of\_device\_id tables
commit bd37e022e334757a5dc1dae41baa29e16befe4ec upstream.
Make sure of\_device\_id tables are NULL terminated.
Signed-off-by: Wei Yongjun
Acked-by: Viresh Kumar
Fixes: f56aad1d98f1 (cpufreq: dt: Add generic platform-device creation support)
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 5ef15cd2eb598d67c60d7386da8706c8818ce5b4
Author: Tyrel Datwyler
Date: Fri Aug 12 17:20:07 2016 -0500
scsi: fix upper bounds check of sense key in scsi\_sense\_key\_string()
commit a87eeb900dbb9f8202f96604d56e47e67c936b9d upstream.
Commit 655ee63cf371 ("scsi constants: command, sense key + additional
sense string") added a "Completed" sense string with key 0xF to
snstext[], but failed to updated the upper bounds check of the sense key
in scsi\_sense\_key\_string().
Fixes: 655ee63cf371 ("[SCSI] scsi constants: command, sense key + additional sense strings")
Signed-off-by: Tyrel Datwyler
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 1e6e4141ba10817162c847d2f71c197acd337a7a
Author: Takashi Iwai
Date: Wed Sep 7 15:45:31 2016 +0200
ALSA: timer: Fix zero-division by continue of uninitialized instance
commit 9f8a7658bcafb2a7853f7a2eae8a94e87e6e695b upstream.
When a user timer instance is continued without the explicit start
beforehand, the system gets eventually zero-division error like:
divide error: 0000 [#1] SMP DEBUG\_PAGEALLOC KASAN
CPU: 1 PID: 27320 Comm: syz-executor Not tainted 4.8.0-rc3-next-20160825+ #8
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011
task: ffff88003c9b2280 task.stack: ffff880027280000
RIP: 0010:[] [< inline >] ktime\_divns include/linux/ktime.h:195
RIP: 0010:[] [] snd\_hrtimer\_callback+0x1bc/0x3c0 sound/core/hrtimer.c:62
Call Trace:
[< inline >] \_\_run\_hrtimer kernel/time/hrtimer.c:1238
[] \_\_hrtimer\_run\_queues+0x325/0xe70 kernel/time/hrtimer.c:1302
[] hrtimer\_interrupt+0x18b/0x420 kernel/time/hrtimer.c:1336
[] local\_apic\_timer\_interrupt+0x6f/0xe0 arch/x86/kernel/apic/apic.c:933
[] smp\_apic\_timer\_interrupt+0x76/0xa0 arch/x86/kernel/apic/apic.c:957
[] apic\_timer\_interrupt+0x8c/0xa0 arch/x86/entry/entry\_64.S:487
.....
Although a similar issue was spotted and a fix patch was merged in
commit [6b760bb2c63a: ALSA: timer: fix division by zero after
SNDRV\_TIMER\_IOCTL\_CONTINUE], it seems covering only a part of
iceberg.
In this patch, we fix the issue a bit more drastically. Basically the
continue of an uninitialized timer is supposed to be a fresh start, so
we do it for user timers. For the direct snd\_timer\_continue() call,
there is no way to pass the initial tick value, so we kick out for the
uninitialized case.
Reported-by: Dmitry Vyukov
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit f36dce606fa5677a8a9e45f36ffeb0762f8a3c4c
Author: Vegard Nossum
Date: Mon Aug 29 00:33:51 2016 +0200
ALSA: timer: fix NULL pointer dereference on memory allocation failure
commit 8ddc05638ee42b18ba4fe99b5fb647fa3ad20456 upstream.
I hit this with syzkaller:
kasan: CONFIG\_KASAN\_INLINE enabled
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 1327 Comm: a.out Not tainted 4.8.0-rc2+ #190
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014
task: ffff88011278d600 task.stack: ffff8801120c0000
RIP: 0010:[] [] snd\_hrtimer\_start+0x77/0x100
RSP: 0018:ffff8801120c7a60 EFLAGS: 00010006
RAX: dffffc0000000000 RBX: 0000000000000000 RCX: 0000000000000007
RDX: 0000000000000009 RSI: 1ffff10023483091 RDI: 0000000000000048
RBP: ffff8801120c7a78 R08: ffff88011a5cf768 R09: ffff88011a5ba790
R10: 0000000000000002 R11: ffffed00234b9ef1 R12: ffff880114843980
R13: ffffffff84213c00 R14: ffff880114843ab0 R15: 0000000000000286
FS: 00007f72958f3700(0000) GS:ffff88011aa00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000603001 CR3: 00000001126ab000 CR4: 00000000000006f0
Stack:
ffff880114843980 ffff880111eb2dc0 ffff880114843a34 ffff8801120c7ad0
ffffffff82c81ab1 0000000000000000 ffffffff842138e0 0000000100000000
ffff880111eb2dd0 ffff880111eb2dc0 0000000000000001 ffff880111eb2dc0
Call Trace:
[] snd\_timer\_start1+0x331/0x670
[] snd\_timer\_start+0x5d/0xa0
[] snd\_timer\_user\_ioctl+0x88e/0x2830
[] ? \_\_follow\_pte.isra.49+0x430/0x430
[] ? snd\_timer\_pause+0x80/0x80
[] ? do\_wp\_page+0x3aa/0x1c90
[] ? put\_prev\_entity+0x108f/0x21a0
[] ? snd\_timer\_pause+0x80/0x80
[] do\_vfs\_ioctl+0x193/0x1050
[] ? cpuacct\_account\_field+0x12f/0x1a0
[] ? ioctl\_preallocate+0x200/0x200
[] ? syscall\_trace\_enter+0x3cf/0xdb0
[] ? \_\_context\_tracking\_exit.part.4+0x9a/0x1e0
[] ? exit\_to\_usermode\_loop+0x190/0x190
[] ? check\_preemption\_disabled+0x37/0x1e0
[] ? security\_file\_ioctl+0x89/0xb0
[] SyS\_ioctl+0x8f/0xc0
[] ? do\_vfs\_ioctl+0x1050/0x1050
[] do\_syscall\_64+0x1c4/0x4e0
[] entry\_SYSCALL64\_slow\_path+0x25/0x25
Code: c7 c7 c4 b9 c8 82 48 89 d9 4c 89 ee e8 63 88 7f fe e8 7e 46 7b fe 48 8d 7b 48 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <0f> b6 04 02 84 c0 74 04 84 c0 7e 65 80 7b 48 00 74 0e e8 52 46
RIP [] snd\_hrtimer\_start+0x77/0x100
RSP
---[ end trace 5955b08db7f2b029 ]---
This can happen if snd\_hrtimer\_open() fails to allocate memory and
returns an error, which is currently not checked by snd\_timer\_open():
ioctl(SNDRV\_TIMER\_IOCTL\_SELECT)
- snd\_timer\_user\_tselect()
- snd\_timer\_close()
- snd\_hrtimer\_close()
- (struct snd\_timer \*) t->private\_data = NULL
- snd\_timer\_open()
- snd\_hrtimer\_open()
- kzalloc() fails; t->private\_data is still NULL
ioctl(SNDRV\_TIMER\_IOCTL\_START)
- snd\_timer\_user\_start()
- snd\_timer\_start()
- snd\_timer\_start1()
- snd\_hrtimer\_start()
- t->private\_data == NULL // boom
Signed-off-by: Vegard Nossum
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 78270197d0e9352a7ade07a85904131d5dff5650
Author: Vegard Nossum
Date: Mon Aug 29 00:33:50 2016 +0200
ALSA: timer: fix division by zero after SNDRV\_TIMER\_IOCTL\_CONTINUE
commit 6b760bb2c63a9e322c0e4a0b5daf335ad93d5a33 upstream.
I got this:
divide error: 0000 [#1] PREEMPT SMP KASAN
CPU: 1 PID: 1327 Comm: a.out Not tainted 4.8.0-rc2+ #189
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014
task: ffff8801120a9580 task.stack: ffff8801120b0000
RIP: 0010:[] [] snd\_hrtimer\_callback+0x1da/0x3f0
RSP: 0018:ffff88011aa87da8 EFLAGS: 00010006
RAX: 0000000000004f76 RBX: ffff880112655e88 RCX: 0000000000000000
RDX: 0000000000000000 RSI: ffff880112655ea0 RDI: 0000000000000001
RBP: ffff88011aa87e00 R08: ffff88013fff905c R09: ffff88013fff9048
R10: ffff88013fff9050 R11: 00000001050a7b8c R12: ffff880114778a00
R13: ffff880114778ab4 R14: ffff880114778b30 R15: 0000000000000000
FS: 00007f071647c700(0000) GS:ffff88011aa80000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000603001 CR3: 0000000112021000 CR4: 00000000000006e0
Stack:
0000000000000000 ffff880114778ab8 ffff880112655ea0 0000000000004f76
ffff880112655ec8 ffff880112655e80 ffff880112655e88 ffff88011aa98fc0
00000000b97ccf2b dffffc0000000000 ffff88011aa98fc0 ffff88011aa87ef0
Call Trace:
[] \_\_hrtimer\_run\_queues+0x347/0xa00
[] ? snd\_hrtimer\_close+0x130/0x130
[] ? retrigger\_next\_event+0x1b0/0x1b0
[] ? hrtimer\_interrupt+0x136/0x4b0
[] hrtimer\_interrupt+0x1b0/0x4b0
[] local\_apic\_timer\_interrupt+0x6e/0xf0
[] ? kvm\_guest\_apic\_eoi\_write+0x13/0xc0
[] smp\_apic\_timer\_interrupt+0x76/0xa0
[] apic\_timer\_interrupt+0x8c/0xa0
[] ? \_raw\_spin\_unlock\_irqrestore+0x2c/0x60
[] snd\_timer\_start1+0xdd/0x670
[] snd\_timer\_continue+0x45/0x80
[] snd\_timer\_user\_ioctl+0x1030/0x2830
[] ? \_\_follow\_pte.isra.49+0x430/0x430
[] ? snd\_timer\_pause+0x80/0x80
[] ? do\_wp\_page+0x3aa/0x1c90
[] ? handle\_mm\_fault+0xbc8/0x27f0
[] ? \_\_pmd\_alloc+0x370/0x370
[] ? snd\_timer\_pause+0x80/0x80
[] do\_vfs\_ioctl+0x193/0x1050
[] ? ioctl\_preallocate+0x200/0x200
[] ? syscall\_trace\_enter+0x3cf/0xdb0
[] ? \_\_context\_tracking\_exit.part.4+0x9a/0x1e0
[] ? exit\_to\_usermode\_loop+0x190/0x190
[] ? check\_preemption\_disabled+0x37/0x1e0
[] ? security\_file\_ioctl+0x89/0xb0
[] SyS\_ioctl+0x8f/0xc0
[] ? do\_vfs\_ioctl+0x1050/0x1050
[] do\_syscall\_64+0x1c4/0x4e0
[] entry\_SYSCALL64\_slow\_path+0x25/0x25
Code: e8 fc 42 7b fe 8b 0d 06 8a 50 03 49 0f af cf 48 85 c9 0f 88 7c 01 00 00 48 89 4d a8 e8 e0 42 7b fe 48 8b 45 c0 48 8b 4d a8 48 99 <48> f7 f9 49 01 c7 e8 cb 42 7b fe 48 8b 55 d0 48 b8 00 00 00 00
RIP [] snd\_hrtimer\_callback+0x1da/0x3f0
RSP
---[ end trace 6aa380f756a21074 ]---
The problem happens when you call ioctl(SNDRV\_TIMER\_IOCTL\_CONTINUE) on a
completely new/unused timer -- it will have ->sticks == 0, which causes a
divide by 0 in snd\_hrtimer\_callback().
Signed-off-by: Vegard Nossum
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ee89a89f41e7f33eca17617933161a7279f1e1fa
Author: Vegard Nossum
Date: Sun Aug 28 10:13:07 2016 +0200
ALSA: timer: fix NULL pointer dereference in read()/ioctl() race
commit 11749e086b2766cccf6217a527ef5c5604ba069c upstream.
I got this with syzkaller:
==================================================================
BUG: KASAN: null-ptr-deref on address 0000000000000020
Read of size 32 by task syz-executor/22519
CPU: 1 PID: 22519 Comm: syz-executor Not tainted 4.8.0-rc2+ #169
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2
014
0000000000000001 ffff880111a17a00 ffffffff81f9f141 ffff880111a17a90
ffff880111a17c50 ffff880114584a58 ffff880114584a10 ffff880111a17a80
ffffffff8161fe3f ffff880100000000 ffff880118d74a48 ffff880118d74a68
Call Trace:
[] dump\_stack+0x83/0xb2
[] kasan\_report\_error+0x41f/0x4c0
[] kasan\_report+0x34/0x40
[] ? snd\_timer\_user\_read+0x554/0x790
[] check\_memory\_region+0x13e/0x1a0
[] kasan\_check\_read+0x11/0x20
[] snd\_timer\_user\_read+0x554/0x790
[] ? snd\_timer\_user\_info\_compat.isra.5+0x2b0/0x2b0
[] ? proc\_fault\_inject\_write+0x1c1/0x250
[] ? next\_tgid+0x2a0/0x2a0
[] ? do\_group\_exit+0x108/0x330
[] ? fsnotify+0x72a/0xca0
[] \_\_vfs\_read+0x10e/0x550
[] ? snd\_timer\_user\_info\_compat.isra.5+0x2b0/0x2b0
[] ? do\_sendfile+0xc50/0xc50
[] ? \_\_fsnotify\_update\_child\_dentry\_flags+0x60/0x60
[] ? kcov\_ioctl+0x56/0x190
[] ? common\_file\_perm+0x2e2/0x380
[] ? \_\_fsnotify\_parent+0x5e/0x2b0
[] ? security\_file\_permission+0x86/0x1e0
[] ? rw\_verify\_area+0xe5/0x2b0
[] vfs\_read+0x115/0x330
[] SyS\_read+0xd1/0x1a0
[] ? vfs\_write+0x4b0/0x4b0
[] ? \_\_this\_cpu\_preempt\_check+0x1c/0x20
[] ? \_\_context\_tracking\_exit.part.4+0x3a/0x1e0
[] ? vfs\_write+0x4b0/0x4b0
[] do\_syscall\_64+0x1c4/0x4e0
[] ? syscall\_return\_slowpath+0x16c/0x1d0
[] entry\_SYSCALL64\_slow\_path+0x25/0x25
==================================================================
There are a couple of problems that I can see:
- ioctl(SNDRV\_TIMER\_IOCTL\_SELECT), which potentially sets
tu->queue/tu->tqueue to NULL on memory allocation failure, so read()
would get a NULL pointer dereference like the above splat
- the same ioctl() can free tu->queue/to->tqueue which means read()
could potentially see (and dereference) the freed pointer
We can fix both by taking the ioctl\_lock mutex when dereferencing
->queue/->tqueue, since that's always held over all the ioctl() code.
Just looking at the code I find it likely that there are more problems
here such as tu->qhead pointing outside the buffer if the size is
changed concurrently using SNDRV\_TIMER\_IOCTL\_PARAMS.
Signed-off-by: Vegard Nossum
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 35a2bce2fc5c286ad91b69639e2c34d4dab43833
Author: Kai-Heng Feng
Date: Tue Aug 30 15:36:34 2016 +0800
ALSA: hda - Enable subwoofer on Dell Inspiron 7559
commit fd06c77eb9200b53d421da5fffe0dcd894b5d72a upstream.
The subwoofer on Inspiron 7559 was disabled originally.
Applying a pin fixup to node 0x1b can enable it and make it work.
Old pin: 0x411111f0
New pin: 0x90170151
Signed-off-by: Kai-Heng Feng
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 47faaac925682eb65cc4b0d14b7812d8bcdbc686
Author: Shrirang Bagul
Date: Mon Aug 29 15:19:27 2016 +0800
ALSA: hda - Add headset mic quirk for Dell Inspiron 5468
commit 311042d1b67d9a1856a8e1294e7729fb86f64014 upstream.
This patch enables headset microphone on some variants of
Dell Inspiron 5468. (Dell SSID 0x07ad)
BugLink: https://bugs.launchpad.net/bugs/1617900
Signed-off-by: Shrirang Bagul
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3d46e7c4ab50a1f250628a6eb6f5b081270c9ba5
Author: Takashi Iwai
Date: Tue Aug 30 14:45:46 2016 +0200
ALSA: rawmidi: Fix possible deadlock with virmidi registration
commit 816f318b2364262a51024096da7ca3b84e78e3b5 upstream.
When a seq-virmidi driver is initialized, it registers a rawmidi
instance with its callback to create an associated seq kernel client.
Currently it's done throughly in rawmidi's register\_mutex context.
Recently it was found that this may lead to a deadlock another rawmidi
device that is being attached with the sequencer is accessed, as both
open with the same register\_mutex. This was actually triggered by
syzkaller, as Dmitry Vyukov reported:
======================================================
[ INFO: possible circular locking dependency detected ]
4.8.0-rc1+ #11 Not tainted
-------------------------------------------------------
syz-executor/7154 is trying to acquire lock:
(register\_mutex#5){+.+.+.}, at: [] snd\_rawmidi\_kernel\_open+0x4b/0x260 sound/core/rawmidi.c:341
but task is already holding lock:
(&grp->list\_mutex){++++.+}, at: [] check\_and\_subscribe\_port+0x5b/0x5c0 sound/core/seq/seq\_ports.c:495
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&grp->list\_mutex){++++.+}:
[] lock\_acquire+0x208/0x430 kernel/locking/lockdep.c:3746
[] down\_read+0x49/0xc0 kernel/locking/rwsem.c:22
[< inline >] deliver\_to\_subscribers sound/core/seq/seq\_clientmgr.c:681
[] snd\_seq\_deliver\_event+0x35e/0x890 sound/core/seq/seq\_clientmgr.c:822
[] > snd\_seq\_kernel\_client\_dispatch+0x126/0x170 sound/core/seq/seq\_clientmgr.c:2418
[] snd\_seq\_system\_broadcast+0xb2/0xf0 sound/core/seq/seq\_system.c:101
[] snd\_seq\_create\_kernel\_client+0x24a/0x330 sound/core/seq/seq\_clientmgr.c:2297
[< inline >] snd\_virmidi\_dev\_attach\_seq sound/core/seq/seq\_virmidi.c:383
[] snd\_virmidi\_dev\_register+0x29f/0x750 sound/core/seq/seq\_virmidi.c:450
[] snd\_rawmidi\_dev\_register+0x30c/0xd40 sound/core/rawmidi.c:1645
[] \_\_snd\_device\_register.part.0+0x63/0xc0 sound/core/device.c:164
[< inline >] \_\_snd\_device\_register sound/core/device.c:162
[] snd\_device\_register\_all+0xad/0x110 sound/core/device.c:212
[] snd\_card\_register+0xef/0x6c0 sound/core/init.c:749
[] snd\_virmidi\_probe+0x3ef/0x590 sound/drivers/virmidi.c:123
[] platform\_drv\_probe+0x8b/0x170 drivers/base/platform.c:564
......
-> #0 (register\_mutex#5){+.+.+.}:
[< inline >] check\_prev\_add kernel/locking/lockdep.c:1829
[< inline >] check\_prevs\_add kernel/locking/lockdep.c:1939
[< inline >] validate\_chain kernel/locking/lockdep.c:2266
[] \_\_lock\_acquire+0x4d44/0x4d80 kernel/locking/lockdep.c:3335
[] lock\_acquire+0x208/0x430 kernel/locking/lockdep.c:3746
[< inline >] \_\_mutex\_lock\_common kernel/locking/mutex.c:521
[] mutex\_lock\_nested+0xb1/0xa20 kernel/locking/mutex.c:621
[] snd\_rawmidi\_kernel\_open+0x4b/0x260 sound/core/rawmidi.c:341
[] midisynth\_subscribe+0xf7/0x350 sound/core/seq/seq\_midi.c:188
[< inline >] subscribe\_port sound/core/seq/seq\_ports.c:427
[] check\_and\_subscribe\_port+0x467/0x5c0 sound/core/seq/seq\_ports.c:510
[] snd\_seq\_port\_connect+0x2c9/0x500 sound/core/seq/seq\_ports.c:579
[] snd\_seq\_ioctl\_subscribe\_port+0x1d8/0x2b0 sound/core/seq/seq\_clientmgr.c:1480
[] snd\_seq\_do\_ioctl+0x184/0x1e0 sound/core/seq/seq\_clientmgr.c:2225
[] snd\_seq\_kernel\_client\_ctl+0xa8/0x110 sound/core/seq/seq\_clientmgr.c:2440
[] snd\_seq\_oss\_midi\_open+0x3b4/0x610 sound/core/seq/oss/seq\_oss\_midi.c:375
[] snd\_seq\_oss\_synth\_setup\_midi+0x107/0x4c0 sound/core/seq/oss/seq\_oss\_synth.c:281
[] snd\_seq\_oss\_open+0x748/0x8d0 sound/core/seq/oss/seq\_oss\_init.c:274
[] odev\_open+0x6a/0x90 sound/core/seq/oss/seq\_oss.c:138
[] soundcore\_open+0x30f/0x640 sound/sound\_core.c:639
......
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&grp->list\_mutex);
lock(register\_mutex#5);
lock(&grp->list\_mutex);
lock(register\_mutex#5);
\*\*\* DEADLOCK \*\*\*
======================================================
The fix is to simply move the registration parts in
snd\_rawmidi\_dev\_register() to the outside of the register\_mutex lock.
The lock is needed only to manage the linked list, and it's not
necessarily to cover the whole initialization process.
Reported-by: Dmitry Vyukov
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 45c7a1968ec6a0c5ede750be5ff2b3b19c1bd356
Author: Takashi Sakamoto
Date: Wed Aug 31 22:58:42 2016 +0900
ALSA: fireworks: accessing to user space outside spinlock
commit 6b1ca4bcadf9ef077cc5f03c6822ba276ed14902 upstream.
In hwdep interface of fireworks driver, accessing to user space is in a
critical section with disabled local interrupt. Depending on architecture,
accessing to user space can cause page fault exception. Then local
processor stores machine status and handles the synchronous event. A
handler corresponding to the event can call task scheduler to wait for
preparing pages. In a case of usage of single core processor, the state to
disable local interrupt is worse because it don't handle usual interrupts
from hardware.
This commit fixes this bug, performing the accessing outside spinlock. This
commit also gives up counting the number of queued response messages to
simplify ring-buffer management.
Reported-by: Vaishali Thakkar
Fixes: 555e8a8f7f14('ALSA: fireworks: Add command/response functionality into hwdep interface')
Signed-off-by: Takashi Sakamoto
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit f19d2b10b69097ae77b43e38e65ba5674f592d51
Author: Takashi Sakamoto
Date: Wed Aug 31 20:15:32 2016 +0900
ALSA: firewire-tascam: accessing to user space outside spinlock
commit 04b2d9c9c319277ad4fbbb71855c256a9f4d5f98 upstream.
In hwdep interface of firewire-tascam driver, accessing to user space is
in a critical section with disabled local interrupt. Depending on
architecture, accessing to user space can cause page fault exception. Then
local processor stores machine status and handle the synchronous event. A
handler corresponding to the event can call task scheduler to wait for
preparing pages. In a case of usage of single core processor, the state to
disable local interrupt is worse because it doesn't handle usual interrupts
from hardware.
This commit fixes this bug, by performing the accessing outside spinlock.
Reported-by: Vaishali Thakkar
Fixes: e5e0c3dd257b('ALSA: firewire-tascam: add hwdep interface')
Signed-off-by: Takashi Sakamoto
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit a9b37021a9c9bc8ff7783f18c4c186ce9542fe16
Author: Ken Lin
Date: Fri Aug 12 14:08:47 2016 -0400
ALSA: usb-audio: Add sample rate inquiry quirk for B850V3 CP2114
commit 83d9956b7e6b310c1062df7894257251c625b22e upstream.
Avoid getting sample rate on B850V3 CP2114 as it is unsupported and
causes noisy "current rate is different from the runtime rate" messages
when playback starts.
Signed-off-by: Ken Lin
Signed-off-by: Akshay Bhat
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ab3245d38de92b1fd322d7899af0eb5d0f8ce021
Author: Eric Biggers
Date: Thu Sep 8 11:36:39 2016 -0700
fscrypto: only allow setting encryption policy on directories
commit 002ced4be6429918800ce3e41d5cbc2d7c01822c upstream.
The FS\_IOC\_SET\_ENCRYPTION\_POLICY ioctl allowed setting an encryption
policy on nondirectory files. This was unintentional, and in the case
of nonempty regular files did not behave as expected because existing
data was not actually encrypted by the ioctl.
In the case of ext4, the user could also trigger filesystem errors in
->empty\_dir(), e.g. due to mismatched "directory" checksums when the
kernel incorrectly tried to interpret a regular file as a directory.
This bug affected ext4 with kernels v4.8-rc1 or later and f2fs with
kernels v4.6 and later. It appears that older kernels only permitted
directories and that the check was accidentally lost during the
refactoring to share the file encryption code between ext4 and f2fs.
This patch restores the !S\_ISDIR() check that was present in older
kernels.
Signed-off-by: Eric Biggers
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit edff68f618646ccd75b5ff5694cf63bc2b78a009
Author: Eric Biggers
Date: Thu Sep 8 10:57:08 2016 -0700
fscrypto: add authorization check for setting encryption policy
commit 163ae1c6ad6299b19e22b4a35d5ab24a89791a98 upstream.
On an ext4 or f2fs filesystem with file encryption supported, a user
could set an encryption policy on any empty directory(\*) to which they
had readonly access. This is obviously problematic, since such a
directory might be owned by another user and the new encryption policy
would prevent that other user from creating files in their own directory
(for example).
Fix this by requiring inode\_owner\_or\_capable() permission to set an
encryption policy. This means that either the caller must own the file,
or the caller must have the capability CAP\_FOWNER.
(\*) Or also on any regular file, for f2fs v4.6 and later and ext4
v4.8-rc1 and later; a separate bug fix is coming for that.
Signed-off-by: Eric Biggers
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit c488abc98a8a164a1ec264a4823a7e4baf587fc4
Author: Horia Geantă
Date: Mon Aug 29 14:52:14 2016 +0300
crypto: caam - fix IV loading for authenc (giv)decryption
commit 8b18e2359aff2ab810aba84cebffc9da07fef78f upstream.
For algorithms that implement IV generators before the crypto ops,
the IV needed for decryption is initially located in req->src
scatterlist, not in req->iv.
Avoid copying the IV into req->iv by modifying the (givdecrypt)
descriptors to load it directly from req->src.
aead\_givdecrypt() is no longer needed and goes away.
Fixes: 479bcc7c5b9e ("crypto: caam - Convert authenc to new AEAD interface")
Signed-off-by: Horia Geantă
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 9ee6a072a35bfd25a3bf0a2325fe9d6242f98753
Author: Chuck Lever
Date: Wed Jun 29 13:52:21 2016 -0400
xprtrdma: Create common scatterlist fields in rpcrdma\_mw
commit 564471d2f2f1ddaf02119b8759813666db93abba upstream.
Clean up: FMR is about to replace the rpcrdma\_map\_one code with
scatterlists. Move the scatterlist fields out of the FRWR-specific
union and into the generic part of rpcrdma\_mw.
One minor change: -EIO is now returned if FRWR registration fails.
The RPC is terminated immediately, since the problem is likely due
to a software bug, thus retrying likely won't help.
Signed-off-by: Chuck Lever
Tested-by: Steve Wise
Signed-off-by: Anna Schumaker
Signed-off-by: Greg Kroah-Hartman
commit b942c21ed56cca6e7af0487eb2dc841b1c16a047
Author: Wanpeng Li
Date: Tue Aug 23 20:07:19 2016 +0800
x86/apic: Do not init irq remapping if ioapic is disabled
commit 2e63ad4bd5dd583871e6602f9d398b9322d358d9 upstream.
native\_smp\_prepare\_cpus
-> default\_setup\_apic\_routing
-> enable\_IR\_x2apic
-> irq\_remapping\_prepare
-> intel\_prepare\_irq\_remapping
-> intel\_setup\_irq\_remapping
So IR table is setup even if "noapic" boot parameter is added. As a result we
crash later when the interrupt affinity is set due to a half initialized
remapping infrastructure.
Prevent remap initialization when IOAPIC is disabled.
Signed-off-by: Wanpeng Li
Cc: Peter Zijlstra
Cc: Joerg Roedel
Link: http://lkml.kernel.org/r/1471954039-3942-1-git-send-email-wanpeng.li@hotmail.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 60811d0f4d7a0d2a071ce890a1fa74843ebe553f
Author: Benjamin Coddington
Date: Mon Jun 6 18:07:59 2016 -0400
vhost/scsi: fix reuse of &vq->iov[out] in response
commit a77ec83a57890240c546df00ca5df1cdeedb1cc3 upstream.
The address of the iovec &vq->iov[out] is not guaranteed to contain the scsi
command's response iovec throughout the lifetime of the command. Rather, it
is more likely to contain an iovec from an immediately following command
after looping back around to vhost\_get\_vq\_desc(). Pass along the iovec
entirely instead.
Fixes: 79c14141a487 ("vhost/scsi: Convert completion path to use copy\_to\_iter")
Signed-off-by: Benjamin Coddington
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Greg Kroah-Hartman
commit 045cb95cf8db2bb62c2463bf51e59864f41f377d
Author: Paul Burton
Date: Fri Aug 19 18:07:15 2016 +0100
irqchip/mips-gic: Implement activate op for device domain
commit 2564970a381651865364974ea414384b569cb9c0 upstream.
If an IRQ is setup using \_\_setup\_irq(), which is used by the
request\_irq() family of functions, and we are using an SMP kernel then
the affinity of the IRQ will be set via setup\_affinity() immediately
after the IRQ is enabled. This call to gic\_set\_affinity() will lead to
the interrupt being mapped to a VPE. However there are other ways to use
IRQs which don't cause affinity to be set, for example if it is used to
chain to another IRQ controller with irq\_set\_chained\_handler\_and\_data().
The irq\_set\_chained\_handler\_and\_data() code path will enable the IRQ,
but will not trigger a call to gic\_set\_affinity() and in this case
nothing will map the interrupt to a VPE, meaning that the interrupt is
never received.
Fix this by implementing the activate operation for the GIC device IRQ
domain, using gic\_shared\_irq\_domain\_map() to map the interrupt to the
correct pin of cpu 0.
Fixes: c98c1822ee13 ("irqchip/mips-gic: Add device hierarchy domain")
Signed-off-by: Paul Burton
Cc: linux-mips@linux-mips.org
Cc: Jason Cooper
Cc: Marc Zyngier
Link: http://lkml.kernel.org/r/20160819170715.27820-2-paul.burton@imgtec.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 1e44b5c325c80c52e5bef114c0115623cd5adb70
Author: Paul Burton
Date: Fri Aug 19 18:07:14 2016 +0100
irqchip/mips-gic: Cleanup chip and handler setup
commit 6a33fa2b87513fee44cb8f0cd17b1acd6316bc6b upstream.
gic\_shared\_irq\_domain\_map() is called from gic\_irq\_domain\_alloc() where
the wrong chip has been set, and is then overwritten. Tidy this up by
setting the correct chip the first time, and setting the
handle\_level\_irq handler from gic\_irq\_domain\_alloc() too.
gic\_shared\_irq\_domain\_map() is also called from gic\_irq\_domain\_map(),
which now calls irq\_set\_chip\_and\_handler() to retain its previous
behaviour.
This patch prepares for a follow-on which will call
gic\_shared\_irq\_domain\_map() from a callback where the lock on the struct
irq\_desc is held, which without this change would cause the call to
irq\_set\_chip\_and\_handler() to lead to a deadlock.
Fixes: c98c1822ee13 ("irqchip/mips-gic: Add device hierarchy domain")
Signed-off-by: Paul Burton
Cc: linux-mips@linux-mips.org
Cc: Jason Cooper
Cc: Marc Zyngier
Link: http://lkml.kernel.org/r/20160819170715.27820-1-paul.burton@imgtec.com
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 1cd18821a4eb12d7026e0cb058c736fb3ed9b6e2
Author: Kent Overstreet
Date: Wed Aug 17 18:21:24 2016 -0700
bcache: RESERVE\_PRIO is too small by one when prio\_buckets() is a power of two.
commit acc9cf8c66c66b2cbbdb4a375537edee72be64df upstream.
This patch fixes a cachedev registration-time allocation deadlock.
This can deadlock on boot if your initrd auto-registeres bcache devices:
Allocator thread:
[ 720.727614] INFO: task bcache\_allocato:3833 blocked for more than 120 seconds.
[ 720.732361] [] schedule+0x37/0x90
[ 720.732963] [] bch\_bucket\_alloc+0x188/0x360 [bcache]
[ 720.733538] [] ? prepare\_to\_wait\_event+0xf0/0xf0
[ 720.734137] [] bch\_prio\_write+0x19d/0x340 [bcache]
[ 720.734715] [] bch\_allocator\_thread+0x3ff/0x470 [bcache]
[ 720.735311] [] ? \_\_schedule+0x2dc/0x950
[ 720.735884] [] ? invalidate\_buckets+0x980/0x980 [bcache]
Registration thread:
[ 720.710403] INFO: task bash:3531 blocked for more than 120 seconds.
[ 720.715226] [] schedule+0x37/0x90
[ 720.715805] [] \_\_bch\_btree\_map\_nodes+0x12d/0x150 [bcache]
[ 720.716409] [] ? bch\_btree\_insert\_check\_key+0x1c0/0x1c0 [bcache]
[ 720.717008] [] bch\_btree\_insert+0xf4/0x170 [bcache]
[ 720.717586] [] ? prepare\_to\_wait\_event+0xf0/0xf0
[ 720.718191] [] bch\_journal\_replay+0x14a/0x290 [bcache]
[ 720.718766] [] ? ttwu\_do\_activate.constprop.94+0x5d/0x70
[ 720.719369] [] ? try\_to\_wake\_up+0x1d4/0x350
[ 720.719968] [] run\_cache\_set+0x580/0x8e0 [bcache]
[ 720.720553] [] register\_bcache+0xe2e/0x13b0 [bcache]
[ 720.721153] [] kobj\_attr\_store+0xf/0x20
[ 720.721730] [] sysfs\_kf\_write+0x3d/0x50
[ 720.722327] [] kernfs\_fop\_write+0x12a/0x180
[ 720.722904] [] \_\_vfs\_write+0x37/0x110
[ 720.723503] [] ? \_\_sb\_start\_write+0x58/0x110
[ 720.724100] [] ? security\_file\_permission+0x23/0xa0
[ 720.724675] [] vfs\_write+0xa9/0x1b0
[ 720.725275] [] ? do\_audit\_syscall\_entry+0x6c/0x70
[ 720.725849] [] SyS\_write+0x55/0xd0
[ 720.726451] [] ? do\_page\_fault+0x30/0x80
[ 720.727045] [] system\_call\_fastpath+0x12/0x71
The fifo code in upstream bcache can't use the last element in the buffer,
which was the cause of the bug: if you asked for a power of two size,
it'd give you a fifo that could hold one less than what you asked for
rather than allocating a buffer twice as big.
Signed-off-by: Kent Overstreet
Tested-by: Eric Wheeler
Signed-off-by: Greg Kroah-Hartman
commit 89a27b9679c1929df52a966c44e1653f5b141636
Author: Vegard Nossum
Date: Mon Aug 22 12:47:43 2016 +0200
bdev: fix NULL pointer dereference
commit e9e5e3fae8da7e237049e00e0bfc9e32fd808fe8 upstream.
I got this:
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] PREEMPT SMP KASAN
Dumping ftrace buffer:
(ftrace buffer empty)
CPU: 0 PID: 5505 Comm: syz-executor Not tainted 4.8.0-rc2+ #161
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.9.3-0-ge2fc41e-prebuilt.qemu-project.org 04/01/2014
task: ffff880113415940 task.stack: ffff880118350000
RIP: 0010:[] [] bd\_mount+0x52/0xa0
RSP: 0018:ffff880118357ca0 EFLAGS: 00010207
RAX: dffffc0000000000 RBX: ffffffffffffffff RCX: ffffc90000bb6000
RDX: 0000000000000018 RSI: ffffffff846d6b20 RDI: 00000000000000c7
RBP: ffff880118357cb0 R08: ffff880115967c68 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000000 R12: ffff8801188211e8
R13: ffffffff847baa20 R14: ffff8801139cb000 R15: 0000000000000080
FS: 00007fa3ff6c0700(0000) GS:ffff88011aa00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fc1d8cc7e78 CR3: 0000000109f20000 CR4: 00000000000006f0
DR0: 000000000000001e DR1: 000000000000001e DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000600
Stack:
ffff880112cfd6c0 ffff8801188211e8 ffff880118357cf0 ffffffff8167f207
ffffffff816d7a1e ffff880112a413c0 ffffffff847baa20 ffff8801188211e8
0000000000000080 ffff880112cfd6c0 ffff880118357d38 ffffffff816dce0a
Call Trace:
[] mount\_fs+0x97/0x2e0
[] ? alloc\_vfsmnt+0x55e/0x760
[] vfs\_kern\_mount+0x7a/0x300
[] ? \_raw\_read\_unlock+0x2c/0x50
[] do\_mount+0x3d7/0x2730
[] ? trace\_do\_page\_fault+0x1f4/0x3a0
[] ? copy\_mount\_string+0x40/0x40
[] ? memset+0x31/0x40
[] ? copy\_mount\_options+0x1ee/0x320
[] SyS\_mount+0xb2/0x120
[] ? copy\_mnt\_ns+0x970/0x970
[] do\_syscall\_64+0x1c4/0x4e0
[] entry\_SYSCALL64\_slow\_path+0x25/0x25
Code: 83 e8 63 1b fc ff 48 85 c0 48 89 c3 74 4c e8 56 35 d1 ff 48 8d bb c8 00 00 00 48 b8 00 00 00 00 00 fc ff df 48 89 fa 48 c1 ea 03 <80> 3c 02 00 75 36 4c 8b a3 c8 00 00 00 48 b8 00 00 00 00 00 fc
RIP [] bd\_mount+0x52/0xa0
RSP
---[ end trace 13690ad962168b98 ]---
mount\_pseudo() returns ERR\_PTR(), not NULL, on error.
Fixes: 3684aa7099e0 ("block-dev: enable writeback cgroup support")
Cc: Shaohua Li
Cc: Tejun Heo
Cc: Jens Axboe
Signed-off-by: Vegard Nossum
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 9d6a2a371d193d7bde06d0512ca2745c0570d235
Author: Vincent Stehlé
Date: Fri Aug 12 15:26:30 2016 +0200
ubifs: Fix assertion in layout\_in\_gaps()
commit c0082e985fdf77b02fc9e0dac3b58504dcf11b7a upstream.
An assertion in layout\_in\_gaps() verifies that the gap\_lebs pointer is
below the maximum bound. When computing this maximum bound the idx\_lebs
count is multiplied by sizeof(int), while C pointers arithmetic does take
into account the size of the pointed elements implicitly already. Remove
the multiplication to fix the assertion.
Fixes: 1e51764a3c2ac05a ("UBIFS: add new flash file system")
Signed-off-by: Vincent Stehlé
Cc: Artem Bityutskiy
Signed-off-by: Artem Bityutskiy
Signed-off-by: Richard Weinberger
Signed-off-by: Greg Kroah-Hartman
commit 1ee6296b23cb5f6b297011defd8a2a637088c689
Author: Richard Weinberger
Date: Sun Jul 31 21:42:23 2016 +0200
ubifs: Fix xattr generic handler usage
commit 17ce1eb0b64eb27d4f9180daae7495fa022c7b0d upstream.
UBIFS uses full names to work with xattrs, therefore we have to use
xattr\_full\_name() to obtain the xattr prefix as string.
Cc: Andreas Gruenbacher
Fixes: 2b88fc21ca ("ubifs: Switch to generic xattr handlers")
Signed-off-by: Richard Weinberger
Reviewed-by: Andreas Gruenbacher
Tested-by: Dongsheng Yang
Signed-off-by: Greg Kroah-Hartman
commit dcfeecd938a75f52faa17f437a08d83001b32da2
Author: Tomas Winkler
Date: Wed Jul 20 10:24:02 2016 +0300
mei: me: disable driver on SPT SPS firmware
commit 8c57cac1457f3125a5d13dc03635c0708c61bff0 upstream.
Sunrise Point PCH with SPS Firmware doesn't expose working
MEI interface, we need to quirk it out.
The SPS Firmware is identifiable only on the first PCI function
of the device.
Tested-by: Sujith Pandel
Signed-off-by: Tomas Winkler
Signed-off-by: Greg Kroah-Hartman
commit 6b2c3e334a28bb41579378cb49b0cb88dabc4515
Author: Miklos Szeredi
Date: Mon Sep 5 13:55:20 2016 +0200
ovl: fix workdir creation
commit e1ff3dd1ae52cef5b5373c8cc4ad949c2c25a71c upstream.
Workdir creation fails in latest kernel.
Fix by allowing EOPNOTSUPP as a valid return value from
vfs\_removexattr(XATTR\_NAME\_POSIX\_ACL\_\*). Upper filesystem may not support
ACL and still be perfectly able to support overlayfs.
Reported-by: Martin Ziegler
Signed-off-by: Miklos Szeredi
Fixes: c11b9fdd6a61 ("ovl: remove posix\_acl\_default from workdir")
Signed-off-by: Greg Kroah-Hartman
commit 774b544fb06318ee9e345d180102bcfc47ebe587
Author: Miklos Szeredi
Date: Thu Sep 1 11:12:00 2016 +0200
ovl: listxattr: use strnlen()
commit 7cb35119d067191ce9ebc380a599db0b03cbd9d9 upstream.
Be defensive about what underlying fs provides us in the returned xattr
list buffer. If it's not properly null terminated, bail out with a warning
insead of BUG.
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 177b55a50dc37b13fe82596a09d77d407a26a2c2
Author: Miklos Szeredi
Date: Thu Sep 1 11:11:59 2016 +0200
ovl: remove posix\_acl\_default from workdir
commit c11b9fdd6a612f376a5e886505f1c54c16d8c380 upstream.
Clear out posix acl xattrs on workdir and also reset the mode after
creation so that an inherited sgid bit is cleared.
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 5737dae59e53d19683d113bf16d7179dabed13bd
Author: Miklos Szeredi
Date: Mon Aug 8 15:08:49 2016 +0200
ovl: don't copy up opaqueness
commit 0956254a2d5b9e2141385514553aeef694dfe3b5 upstream.
When a copy up of a directory occurs which has the opaque xattr set, the
xattr remains in the upper directory. The immediate behavior with overlayfs
is that the upper directory is not treated as opaque, however after a
remount the opaque flag is used and upper directory is treated as opaque.
This causes files created in the lower layer to be hidden when using
multiple lower directories.
Fix by not copying up the opaque flag.
To reproduce:
----8<---------8<---------8<---------8<---------8<---------8<----
mkdir -p l/d/s u v w mnt
mount -t overlay overlay -olowerdir=l,upperdir=u,workdir=w mnt
rm -rf mnt/d/
mkdir -p mnt/d/n
umount mnt
mount -t overlay overlay -olowerdir=u:l,upperdir=v,workdir=w mnt
touch mnt/d/foo
umount mnt
mount -t overlay overlay -olowerdir=u:l,upperdir=v,workdir=w mnt
ls mnt/d
----8<---------8<---------8<---------8<---------8<---------8<----
output should be: "foo n"
Reported-by: Derek McGowan
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=151291
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit 0147f6b0d92e085327531146bff9038ed99a10e8
Author: Miklos Szeredi
Date: Thu Sep 1 11:11:59 2016 +0200
ovl: proper cleanup of workdir
commit eea2fb4851e9dcbab6b991aaf47e2e024f1f55a0 upstream.
When mounting overlayfs it needs a clean "work" directory under the
supplied workdir.
Previously the mount code removed this directory if it already existed and
created a new one. If the removal failed (e.g. directory was not empty)
then it fell back to a read-only mount not using the workdir.
While this has never been reported, it is possible to get a non-empty
"work" dir from a previous mount of overlayfs in case of crash in the
middle of an operation using the work directory.
In this case the left over state should be discarded and the overlay
filesystem will be consistent, guaranteed by the atomicity of operations on
moving to/from the workdir to the upper layer.
This patch implements cleaning out any files left in workdir. It is
implemented using real recursion for simplicity, but the depth is limited
to 2, because the worst case is that of a directory containing whiteouts
under "work".
Signed-off-by: Miklos Szeredi
Signed-off-by: Greg Kroah-Hartman
commit b035f15daf750e1594964d68889e0de5c3014922
Author: Jan Beulich
Date: Mon Aug 15 09:02:38 2016 -0600
xenbus: don't look up transaction IDs for ordinary writes
commit 9a035a40f7f3f6708b79224b86c5777a3334f7ea upstream.
This should really only be done for XS\_TRANSACTION\_END messages, or
else at least some of the xenstore-\* tools don't work anymore.
Fixes: 0beef634b8 ("xenbus: don't BUG() on user mode induced condition")
Reported-by: Richard Schütz
Signed-off-by: Jan Beulich
Tested-by: Richard Schütz
Signed-off-by: David Vrabel
Signed-off-by: Greg Kroah-Hartman
commit 986b9db8f93e8f702a3c542f20f8c2e24e1dc1e2
Author: John Stultz
Date: Tue Aug 23 16:08:21 2016 -0700
timekeeping: Avoid taking lock in NMI path with CONFIG\_DEBUG\_TIMEKEEPING
commit 27727df240c7cc84f2ba6047c6f18d5addfd25ef upstream.
When I added some extra sanity checking in timekeeping\_get\_ns() under
CONFIG\_DEBUG\_TIMEKEEPING, I missed that the NMI safe \_\_ktime\_get\_fast\_ns()
method was using timekeeping\_get\_ns().
Thus the locking added to the debug checks broke the NMI-safety of
\_\_ktime\_get\_fast\_ns().
This patch open-codes the timekeeping\_get\_ns() logic for
\_\_ktime\_get\_fast\_ns(), so can avoid any deadlocks in NMI.
Fixes: 4ca22c2648f9 "timekeeping: Add warnings when overflows or underflows are observed"
Reported-by: Steven Rostedt
Reported-by: Peter Zijlstra
Signed-off-by: John Stultz
Link: http://lkml.kernel.org/r/1471993702-29148-2-git-send-email-john.stultz@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit b381a10cfe17d0e451f03eefd7c75346d08bcf02
Author: John Stultz
Date: Tue Aug 23 16:08:22 2016 -0700
timekeeping: Cap array access in timekeeping\_debug
commit a4f8f6667f099036c88f231dcad4cf233652c824 upstream.
It was reported that hibernation could fail on the 2nd attempt, where the
system hangs at hibernate() -> syscore\_resume() -> i8237A\_resume() ->
claim\_dma\_lock(), because the lock has already been taken.
However there is actually no other process would like to grab this lock on
that problematic platform.
Further investigation showed that the problem is triggered by setting
/sys/power/pm\_trace to 1 before the 1st hibernation.
Since once pm\_trace is enabled, the rtc becomes unmeaningful after suspend,
and meanwhile some BIOSes would like to adjust the 'invalid' RTC (e.g, smaller
than 1970) to the release date of that motherboard during POST stage, thus
after resumed, it may seem that the system had a significant long sleep time
which is a completely meaningless value.
Then in timekeeping\_resume -> tk\_debug\_account\_sleep\_time, if the bit31 of the
sleep time happened to be set to 1, fls() returns 32 and we add 1 to
sleep\_time\_bin[32], which causes an out of bounds array access and therefor
memory being overwritten.
As depicted by System.map:
0xffffffff81c9d080 b sleep\_time\_bin
0xffffffff81c9d100 B dma\_spin\_lock
the dma\_spin\_lock.val is set to 1, which caused this problem.
This patch adds a sanity check in tk\_debug\_account\_sleep\_time()
to ensure we don't index past the sleep\_time\_bin array.
[jstultz: Problem diagnosed and original patch by Chen Yu, I've solved the
issue slightly differently, but borrowed his excelent explanation of the
issue here.]
Fixes: 5c83545f24ab "power: Add option to log time spent in suspend"
Reported-by: Janek Kozicki
Reported-by: Chen Yu
Signed-off-by: John Stultz
Cc: linux-pm@vger.kernel.org
Cc: Peter Zijlstra
Cc: Xunlei Pang
Cc: "Rafael J. Wysocki"
Cc: Zhang Rui
Link: http://lkml.kernel.org/r/1471993702-29148-3-git-send-email-john.stultz@linaro.org
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 2a2abe885a29d7133a4bf6ad6e84e80031ecd7ca
Author: Dave Chinner
Date: Fri Aug 26 16:01:30 2016 +1000
xfs: fix superblock inprogress check
commit f3d7ebdeb2c297bd26272384e955033493ca291c upstream.
From inspection, the superblock sb\_inprogress check is done in the
verifier and triggered only for the primary superblock via a
"bp->b\_bn == XFS\_SB\_DADDR" check.
Unfortunately, the primary superblock is an uncached buffer, and
hence it is configured by xfs\_buf\_read\_uncached() with:
bp->b\_bn = XFS\_BUF\_DADDR\_NULL; /\* always null for uncached buffers \*/
And so this check never triggers. Fix it.
Signed-off-by: Dave Chinner
Reviewed-by: Brian Foster
Reviewed-by: Christoph Hellwig
Signed-off-by: Dave Chinner
Signed-off-by: Greg Kroah-Hartman
commit e227de882e47a2c23dc3b13d93ab4289cd29e179
Author: Christoph Huber
Date: Mon Aug 15 18:59:25 2016 +0200
ASoC: atmel\_ssc\_dai: Don't unconditionally reset SSC on stream startup
commit 3e103a65514c2947e53f3171b21255fbde8b60c6 upstream.
commit cbaadf0f90d6 ("ASoC: atmel\_ssc\_dai: refactor the startup and
shutdown") refactored code such that the SSC is reset on every
startup; this breaks duplex audio (e.g. first start audio playback,
then start record, causing the playback to stop/hang)
Fixes: cbaadf0f90d6 (ASoC: atmel\_ssc\_dai: refactor the startup and shutdown)
Signed-off-by: Christoph Huber
Signed-off-by: Peter Meerwald-Stadler
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit e77337a737bd7234a993b0c264f2406fdc166f19
Author: Eric Anholt
Date: Tue Jul 26 13:47:15 2016 -0700
drm/vc4: Fix oops when userspace hands in a bad BO.
commit 552416c146fadc67cd9b53ef7adf88d3381c43a6 upstream.
We'd end up NULL pointer dereferencing because we didn't take the
error path out in the parent. Fixes igt vc4\_lookup\_fail test.
Signed-off-by: Eric Anholt
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
Signed-off-by: Greg Kroah-Hartman
commit 1153f3b7a3acb9042ab220190307417da22aefa3
Author: Eric Anholt
Date: Tue Jul 26 13:47:14 2016 -0700
drm/vc4: Fix overflow mem unreferencing when the binner runs dry.
commit 9326e6f25574bbb8bd48206d245654780e3fd665 upstream.
Overflow memory handling is tricky: While it's still referenced by the
BPO registers, we want to keep it from being freed. When we are
putting a new set of overflow memory in the registers, we need to
assign the old one to the last rendering job using it.
We were looking at "what's currently running in the binner", but since
the bin/render submission split, we may end up with the binner
completing and having no new job while the renderer is still
processing. So, if we don't find a bin job at all, look at the
highest-seqno (last) render job to attach our overflow to.
Signed-off-by: Eric Anholt
Fixes: ca26d28bbaa3 ("drm/vc4: improve throughput by pipelining binning and rendering jobs")
Signed-off-by: Greg Kroah-Hartman
commit 3ae2ba7afed02d9ff0f0473bfb8d1971a75910cb
Author: Eric Anholt
Date: Tue Jul 26 13:47:10 2016 -0700
drm/vc4: Use drm\_free\_large() on handles to match its allocation.
commit d5fb46e0e3b7e49ee83ba92efc3ab4e1a545ecc1 upstream.
If you managed to exceed the limit to switch to vmalloc, we'd use the
wrong free.
Signed-off-by: Eric Anholt
Fixes: d5b1a78a772f ("drm/vc4: Add support for drawing 3D frames.")
Signed-off-by: Greg Kroah-Hartman
commit 6fe5402ea3771d2b7e6f67859585ad07ae70b537
Author: Rob Clark
Date: Mon Aug 22 15:15:23 2016 -0400
drm/msm: fix use of copy\_from\_user() while holding spinlock
commit 89f82cbb0d5c0ab768c8d02914188aa2211cd2e3 upstream.
Use instead \_\_copy\_from\_user\_inatomic() and fallback to slow-path where
we drop and re-aquire the lock in case of fault.
Reported-by: Vaishali Thakkar
Signed-off-by: Rob Clark
Signed-off-by: Greg Kroah-Hartman
commit ebb3678031911134cf323b6258f1bea706d2b1c7
Author: Daniel Vetter
Date: Sat Aug 20 12:22:11 2016 +0200
drm: Reject page\_flip for !DRIVER\_MODESET
commit 6f00975c619064a18c23fd3aced325ae165a73b9 upstream.
Somehow this one slipped through, which means drivers without modeset
support can be oopsed (since those also don't call
drm\_mode\_config\_init, which means the crtc lookup will chase an
uninitalized idr).
Reported-by: Alexander Potapenko
Cc: Alexander Potapenko
Signed-off-by: Daniel Vetter
Reviewed-by: Chris Wilson
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 5973e8e8b07c11af21d17e86fd9cb3867a19952f
Author: Mario Kleiner
Date: Sat Aug 27 01:02:28 2016 +0200
drm/atomic: Don't potentially reset color\_mgmt\_changed on successive property updates.
commit add1fa75101263ab4d74240f93000998d4325624 upstream.
Due to assigning the 'replaced' value instead of or'ing it,
if drm\_atomic\_crtc\_set\_property() gets called multiple times,
the last call will define the color\_mgmt\_changed flag, so
a non-updating call to a property can reset the flag and
prevent actual hw state updates required by preceding
property updates.
Signed-off-by: Mario Kleiner
Cc: Daniel Vetter
Reviewed-by: Daniel Vetter
Signed-off-by: Dave Airlie
Signed-off-by: Greg Kroah-Hartman
commit 792a5bf09a19f0ef30a55e32ad1a93c8f0612759
Author: Christian König
Date: Thu Aug 18 11:51:14 2016 +0200
drm/radeon: only apply the SS fractional workaround to RS[78]80
commit ae5b80d2b68eac945b124227dea34462118a6f01 upstream.
Looks like some RV6xx have problems with that.
bug:
https://bugs.freedesktop.org/show\_bug.cgi?id=97099
Reviewed-by: Alex Deucher
Signed-off-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 952cbbb0fcccdf22c98e18c94ec1ad849537e33a
Author: Christian König
Date: Wed Aug 17 09:46:42 2016 +0200
drm/radeon: fix radeon\_move\_blit on 32bit systems
commit 13f479b9df4e2bbf2d16e7e1b02f3f55f70e2455 upstream.
This bug seems to be present for a very long time.
Signed-off-by: Christian König
Reviewed-by: Alex Deucher
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 382089caae9c81d296dd4c5db9c2db05d7e8d80b
Author: Oliver Neukum
Date: Thu Sep 8 11:27:30 2016 +0200
cdc-acm: added sanity checking for probe()
This is an alternative to eccf2a4e6b64d249929acc1f7aaa2ab0fb199d3d
which inadvertedly fixes an oops in probe by a device returning
malformed descriptors. The problem allows a malicious device to
attack the kernel.
That patch in v4.8 is too extensive to backport to stable.
Thus this alternative fix is needed up to v4.7
Signed-off-by: Oliver Neukum
Reported-by: Binyamin Sharet
Tested-by: Binyamin Sharet
Signed-off-by: Greg Kroah-Hartman
commit 2f9fb2563dc7ec485a7fa3d2f66e1655ff3f8d9b
Author: Balbir Singh
Date: Wed Aug 10 15:43:06 2016 -0400
cgroup: reduce read locked section of cgroup\_threadgroup\_rwsem during fork
commit 568ac888215c7fb2fabe8ea739b00ec3c1f5d440 upstream.
cgroup\_threadgroup\_rwsem is acquired in read mode during process exit
and fork. It is also grabbed in write mode during
\_\_cgroups\_proc\_write(). I've recently run into a scenario with lots
of memory pressure and OOM and I am beginning to see
systemd
\_\_switch\_to+0x1f8/0x350
\_\_schedule+0x30c/0x990
schedule+0x48/0xc0
percpu\_down\_write+0x114/0x170
\_\_cgroup\_procs\_write.isra.12+0xb8/0x3c0
cgroup\_file\_write+0x74/0x1a0
kernfs\_fop\_write+0x188/0x200
\_\_vfs\_write+0x6c/0xe0
vfs\_write+0xc0/0x230
SyS\_write+0x6c/0x110
system\_call+0x38/0xb4
This thread is waiting on the reader of cgroup\_threadgroup\_rwsem to
exit. The reader itself is under memory pressure and has gone into
reclaim after fork. There are times the reader also ends up waiting on
oom\_lock as well.
\_\_switch\_to+0x1f8/0x350
\_\_schedule+0x30c/0x990
schedule+0x48/0xc0
jbd2\_log\_wait\_commit+0xd4/0x180
ext4\_evict\_inode+0x88/0x5c0
evict+0xf8/0x2a0
dispose\_list+0x50/0x80
prune\_icache\_sb+0x6c/0x90
super\_cache\_scan+0x190/0x210
shrink\_slab.part.15+0x22c/0x4c0
shrink\_zone+0x288/0x3c0
do\_try\_to\_free\_pages+0x1dc/0x590
try\_to\_free\_pages+0xdc/0x260
\_\_alloc\_pages\_nodemask+0x72c/0xc90
alloc\_pages\_current+0xb4/0x1a0
page\_table\_alloc+0xc0/0x170
\_\_pte\_alloc+0x58/0x1f0
copy\_page\_range+0x4ec/0x950
copy\_process.isra.5+0x15a0/0x1870
\_do\_fork+0xa8/0x4b0
ppc\_clone+0x8/0xc
In the meanwhile, all processes exiting/forking are blocked almost
stalling the system.
This patch moves the threadgroup\_change\_begin from before
cgroup\_fork() to just before cgroup\_canfork(). There is no nee to
worry about threadgroup changes till the task is actually added to the
threadgroup. This avoids having to call reclaim with
cgroup\_threadgroup\_rwsem held.
tj: Subject and description edits.
Signed-off-by: Balbir Singh
Acked-by: Zefan Li
Cc: Oleg Nesterov
Cc: Andrew Morton
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit ab016be6baebe3d9266decc8725de9354986803d
Author: Ming Lei
Date: Tue Aug 23 21:49:45 2016 +0800
block: make sure a big bio is split into at most 256 bvecs
commit 4d70dca4eadf2f95abe389116ac02b8439c2d16c upstream.
After arbitrary bio size was introduced, the incoming bio may
be very big. We have to split the bio into small bios so that
each holds at most BIO\_MAX\_PAGES bvecs for safety reason, such
as bio\_clone().
This patch fixes the following kernel crash:
> [ 172.660142] BUG: unable to handle kernel NULL pointer dereference at 0000000000000028
> [ 172.660229] IP: [] bio\_trim+0xf/0x2a
> [ 172.660289] PGD 7faf3e067 PUD 7f9279067 PMD 0
> [ 172.660399] Oops: 0000 [#1] SMP
> [...]
> [ 172.664780] Call Trace:
> [ 172.664813] [] ? raid1\_make\_request+0x2e8/0xad7 [raid1]
> [ 172.664846] [] ? blk\_queue\_split+0x377/0x3d4
> [ 172.664880] [] ? md\_make\_request+0xf6/0x1e9 [md\_mod]
> [ 172.664912] [] ? generic\_make\_request+0xb5/0x155
> [ 172.664947] [] ? prio\_io+0x85/0x95 [bcache]
> [ 172.664981] [] ? register\_cache\_set+0x355/0x8d0 [bcache]
> [ 172.665016] [] ? register\_bcache+0x1006/0x1174 [bcache]
The issue can be reproduced by the following steps:
- create one raid1 over two virtio-blk
- build bcache device over the above raid1 and another cache device
and bucket size is set as 2Mbytes
- set cache mode as writeback
- run random write over ext4 on the bcache device
Fixes: 54efd50(block: make generic\_make\_request handle arbitrarily sized bios)
Reported-by: Sebastian Roesner
Reported-by: Eric Wheeler
Cc: Shaohua Li
Acked-by: Kent Overstreet
Signed-off-by: Ming Lei
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 014146e4370fc132314f5015d74b940d1a4bf930
Author: Bart Van Assche
Date: Tue Aug 16 16:48:36 2016 -0700
block: Fix race triggered by blk\_set\_queue\_dying()
commit 1b856086813be9371929b6cc62045f9fd470f5a0 upstream.
blk\_set\_queue\_dying() can be called while another thread is
submitting I/O or changing queue flags, e.g. through dm\_stop\_queue().
Hence protect the QUEUE\_FLAG\_DYING flag change with locking.
Signed-off-by: Bart Van Assche
Cc: Christoph Hellwig
Cc: Mike Snitzer
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit c9274d891869880648c4ee9365df3ecc7ba2e285
Author: Daeho Jeong
Date: Sun Jul 3 17:51:39 2016 -0400
ext4: avoid modifying checksum fields directly during checksum verification
commit b47820edd1634dc1208f9212b7ecfb4230610a23 upstream.
We temporally change checksum fields in buffers of some types of
metadata into '0' for verifying the checksum values. By doing this
without locking the buffer, some metadata's checksums, which are
being committed or written back to the storage, could be damaged.
In our test, several metadata blocks were found with damaged metadata
checksum value during recovery process. When we only verify the
checksum value, we have to avoid modifying checksum fields directly.
Signed-off-by: Daeho Jeong
Signed-off-by: Youngjin Gil
Signed-off-by: Theodore Ts'o
Reviewed-by: Darrick J. Wong
Cc: Török Edwin
Signed-off-by: Greg Kroah-Hartman
commit 5f4100b7447787b1d86476ef5743f9d690390c3f
Author: Jan Kara
Date: Thu Aug 11 12:38:55 2016 -0400
ext4: avoid deadlock when expanding inode size
commit 2e81a4eeedcaa66e35f58b81e0755b87057ce392 upstream.
When we need to move xattrs into external xattr block, we call
ext4\_xattr\_block\_set() from ext4\_expand\_extra\_isize\_ea(). That may end
up calling ext4\_mark\_inode\_dirty() again which will recurse back into
the inode expansion code leading to deadlocks.
Protect from recursion using EXT4\_STATE\_NO\_EXPAND inode flag and move
its management into ext4\_expand\_extra\_isize\_ea() since its manipulation
is safe there (due to xattr\_sem) from possible races with
ext4\_xattr\_set\_handle() which plays with it as well.
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit d4039c808f2643f403fa21d62ed530ca6c2aafae
Author: Jan Kara
Date: Thu Aug 11 12:00:01 2016 -0400
ext4: properly align shifted xattrs when expanding inodes
commit 443a8c41cd49de66a3fda45b32b9860ea0292b84 upstream.
We did not count with the padding of xattr value when computing desired
shift of xattrs in the inode when expanding i\_extra\_isize. As a result
we could create unaligned start of inline xattrs. Account for alignment
properly.
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit ee0775439b230d331fd419c24234dc33978a3418
Author: Jan Kara
Date: Thu Aug 11 11:58:32 2016 -0400
ext4: fix xattr shifting when expanding inodes part 2
commit 418c12d08dc64a45107c467ec1ba29b5e69b0715 upstream.
When multiple xattrs need to be moved out of inode, we did not properly
recompute total size of xattr headers in the inode and the new header
position. Thus when moving the second and further xattr we asked
ext4\_xattr\_shift\_entries() to move too much and from the wrong place,
resulting in possible xattr value corruption or general memory
corruption.
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 0e792c6d66216535eab1a123607c22ff7d1e046c
Author: Jan Kara
Date: Thu Aug 11 11:50:30 2016 -0400
ext4: fix xattr shifting when expanding inodes
commit d0141191a20289f8955c1e03dad08e42e6f71ca9 upstream.
The code in ext4\_expand\_extra\_isize\_ea() treated new\_extra\_isize
argument sometimes as the desired target i\_extra\_isize and sometimes as
the amount by which we need to grow current i\_extra\_isize. These happen
to coincide when i\_extra\_isize is 0 which used to be the common case and
so nobody noticed this until recently when we added i\_projid to the
inode and so i\_extra\_isize now needs to grow from 28 to 32 bytes.
The result of these bugs was that we sometimes unnecessarily decided to
move xattrs out of inode even if there was enough space and we often
ended up corrupting in-inode xattrs because arguments to
ext4\_xattr\_shift\_entries() were just wrong. This could demonstrate
itself as BUG\_ON in ext4\_xattr\_shift\_entries() triggering.
Fix the problem by introducing new isize\_diff variable and use it where
appropriate.
Reported-by: Dave Chinner
Signed-off-by: Jan Kara
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 0aa940b1672473c83611945b1c0e99447de685c3
Author: Theodore Ts'o
Date: Mon Aug 1 00:51:02 2016 -0400
ext4: validate that metadata blocks do not overlap superblock
commit 829fa70dddadf9dd041d62b82cd7cea63943899d upstream.
A number of fuzzing failures seem to be caused by allocation bitmaps
or other metadata blocks being pointed at the superblock.
This can cause kernel BUG or WARNings once the superblock is
overwritten, so validate the group descriptor blocks to make sure this
doesn't happen.
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit f949290512332cb4519d1a8ee34a461121043307
Author: Seth Forshee
Date: Tue Apr 26 14:36:24 2016 -0500
cred: Reject inodes with invalid ids in set\_create\_file\_as()
commit 5f65e5ca286126a60f62c8421b77c2018a482b8a upstream.
Using INVALID\_[UG]ID for the LSM file creation context doesn't
make sense, so return an error if the inode passed to
set\_create\_file\_as() has an invalid id.
Signed-off-by: Seth Forshee
Acked-by: Serge Hallyn
Signed-off-by: Eric W. Biederman
Signed-off-by: Greg Kroah-Hartman
commit 5ac21f6892f662da82344862a5500cff2fffda5c
Author: Seth Forshee
Date: Tue Apr 26 14:36:23 2016 -0500
fs: Check for invalid i\_uid in may\_follow\_link()
commit 2d7f9e2ad35e4e7a3086231f19bfab33c6a8a64a upstream.
Filesystem uids which don't map into a user namespace may result
in inode->i\_uid being INVALID\_UID. A symlink and its parent
could have different owners in the filesystem can both get
mapped to INVALID\_UID, which may result in following a symlink
when this would not have otherwise been permitted when protected
symlinks are enabled.
Signed-off-by: Seth Forshee
Acked-by: Serge Hallyn
Signed-off-by: Eric W. Biederman
Signed-off-by: Greg Kroah-Hartman
commit fc08184d38909a70596ccdf6acc49b4f7723266c
Author: Tyler Hicks
Date: Thu Jun 2 23:43:22 2016 -0500
net: Use ns\_capable\_noaudit() when determining net sysctl permissions
commit d6e0d306449bcb5fa3c80e7a3edf11d45abf9ae9 upstream.
The capability check should not be audited since it is only being used
to determine the inode permissions. A failed check does not indicate a
violation of security policy but, when an LSM is enabled, a denial audit
message was being generated.
The denial audit message caused confusion for some application authors
because root-running Go applications always triggered the denial. To
prevent this confusion, the capability check in net\_ctl\_permissions() is
switched to the noaudit variant.
BugLink: https://launchpad.net/bugs/1465724
Signed-off-by: Tyler Hicks
Acked-by: Serge E. Hallyn
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 6bc11f071a775df8d8240a2599b024d8f1bf8e76
Author: Tyler Hicks
Date: Thu Jun 2 23:43:21 2016 -0500
kernel: Add noaudit variant of ns\_capable()
commit 98f368e9e2630a3ce3e80fb10fb2e02038cf9578 upstream.
When checking the current cred for a capability in a specific user
namespace, it isn't always desirable to have the LSMs audit the check.
This patch adds a noaudit variant of ns\_capable() for when those
situations arise.
The common logic between ns\_capable() and the new ns\_capable\_noaudit()
is moved into a single, shared function to keep duplicated code to a
minimum and ease maintainability.
Signed-off-by: Tyler Hicks
Acked-by: Serge E. Hallyn
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a913c940039ce803939bb81f3c3be3aab0d43b5c
Author: John Johansen
Date: Wed Dec 16 18:09:10 2015 -0800
apparmor: fix refcount race when finding a child profile
commit de7c4cc947f9f56f61520ee7edaf380434a98c8d upstream.
When finding a child profile via an rcu critical section, the profile
may be put and scheduled for deletion after the child is found but
before its refcount is incremented.
Protect against this by repeating the lookup if the profiles refcount
is 0 and is one its way to deletion.
Signed-off-by: John Johansen
Acked-by: Seth Arnold
Signed-off-by: Greg Kroah-Hartman
commit a15f1d0d13bee12b54e198286b91a83752f45b07
Author: Jens Axboe
Date: Thu Aug 25 08:56:51 2016 -0600
Revert "floppy: refactor open() flags handling"
commit f2791e7eadf437633f30faa51b30878cf15650be upstream.
This reverts commit 09954bad448791ef01202351d437abdd9497a804.
Cc: Mark Hounschell
Signed-off-by: Greg Kroah-Hartman


=== Content from github.com_e5e7d8ab_20250125_151503.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F163ae1c6ad6299b19e22b4a35d5ab24a89791a98)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F163ae1c6ad6299b19e22b4a35d5ab24a89791a98)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.9k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  437](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/163ae1c6ad6299b19e22b4a35d5ab24a89791a98)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fscrypto: add authorization check for setting encryption policy

[Browse files](/torvalds/linux/tree/163ae1c6ad6299b19e22b4a35d5ab24a89791a98)
Browse the repository at this point in the history

```
On an ext4 or f2fs filesystem with file encryption supported, a user
could set an encryption policy on any empty directory(*) to which they
had readonly access.  This is obviously problematic, since such a
directory might be owned by another user and the new encryption policy
would prevent that other user from creating files in their own directory
(for example).

Fix this by requiring inode_owner_or_capable() permission to set an
encryption policy.  This means that either the caller must own the file,
or the caller must have the capability CAP_FOWNER.

(*) Or also on any regular file, for f2fs v4.6 and later and ext4
    v4.8-rc1 and later; a separate bug fix is coming for that.

Signed-off-by: Eric Biggers <ebiggers@google.com>
Cc: stable@vger.kernel.org # 4.1+; check fs/{ext4,f2fs}
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
```

* Loading branch information

[![@ebiggers](https://avatars.githubusercontent.com/u/2373140?s=40&v=4)](/ebiggers) [![@tytso](https://avatars.githubusercontent.com/u/51416?s=40&v=4)](/tytso)

[ebiggers](/torvalds/linux/commits?author=ebiggers "View all commits by ebiggers")
authored and
[tytso](/torvalds/linux/commits?author=tytso "View all commits by tytso")
committed
Sep 10, 2016

1 parent
[c693593](/torvalds/linux/commit/c6935931c1894ff857616ff8549b61236a19148f)

commit 163ae1c

Showing
**1 changed file**
with
**3 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[fs/crypto/policy.c](#diff-62600a5211643afa791ad78ccab20bb47877bf56bc1079e019b934722d0e46e7 "fs/crypto/policy.c")

Show comments

[View file](/torvalds/linux/blob/163ae1c6ad6299b19e22b4a35d5ab24a89791a98/fs/crypto/policy.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -95,6 +95,9 @@ static int create\_encryption\_context\_from\_policy(struct inode \*inode, |
|  |  | int fscrypt\_process\_policy(struct inode \*inode, |
|  |  | const struct fscrypt\_policy \*policy) |
|  |  | { |
|  |  | if (!inode\_owner\_or\_capable(inode)) |
|  |  | return -EACCES; |
|  |  |  |
|  |  | if (policy->version != 0) |
|  |  | return -EINVAL; |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `163ae1c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F163ae1c6ad6299b19e22b4a35d5ab24a89791a98) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from git.kernel.org_cb5a990a_20250125_151458.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Biggers <ebiggers@google.com> | 2016-09-08 10:57:08 -0700 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2016-09-09 23:37:14 -0400 |
| commit | [163ae1c6ad6299b19e22b4a35d5ab24a89791a98](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)) | |
| tree | [5a351f56caaf3180dc3f04a2bcab9549724503d9](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98) | |
| parent | [c6935931c1894ff857616ff8549b61236a19148f](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c6935931c1894ff857616ff8549b61236a19148f) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98&id2=c6935931c1894ff857616ff8549b61236a19148f)) | |
| download | [linux-163ae1c6ad6299b19e22b4a35d5ab24a89791a98.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-163ae1c6ad6299b19e22b4a35d5ab24a89791a98.tar.gz) | |

fscrypto: add authorization check for setting encryption policyOn an ext4 or f2fs filesystem with file encryption supported, a user
could set an encryption policy on any empty directory(\*) to which they
had readonly access. This is obviously problematic, since such a
directory might be owned by another user and the new encryption policy
would prevent that other user from creating files in their own directory
(for example).
Fix this by requiring inode\_owner\_or\_capable() permission to set an
encryption policy. This means that either the caller must own the file,
or the caller must have the capability CAP\_FOWNER.
(\*) Or also on any regular file, for f2fs v4.6 and later and ext4
v4.8-rc1 and later; a separate bug fix is coming for that.
Signed-off-by: Eric Biggers <ebiggers@google.com>
Cc: stable@vger.kernel.org # 4.1+; check fs/{ext4,f2fs}
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)

| -rw-r--r-- | [fs/crypto/policy.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/crypto/policy.c?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/fs/crypto/policy.c b/fs/crypto/policy.cindex 0f9961eede1e74..c9800b1a2e930f 100644--- a/[fs/crypto/policy.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/crypto/policy.c?id=c6935931c1894ff857616ff8549b61236a19148f)+++ b/[fs/crypto/policy.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/crypto/policy.c?id=163ae1c6ad6299b19e22b4a35d5ab24a89791a98)@@ -95,6 +95,9 @@ static int create\_encryption\_context\_from\_policy(struct inode \*inode, int fscrypt\_process\_policy(struct inode \*inode, const struct fscrypt\_policy \*policy) {+ if (!inode\_owner\_or\_capable(inode))+ return -EACCES;+ if (policy->version != 0) return -EINVAL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-25 15:13:35 +0000


