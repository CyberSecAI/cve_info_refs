=== Content from cvsweb.netbsd.org_ddb09095_20250124_140144.html ===

[![The NetBSD Project](/images/powered-by-NetBSD.png)](http://www.NetBSD.org/)
# CVS log for src/crypto/dist/ipsec-tools/src/racoon/isakmp\_frag.c

[![[BACK]](/icons/back.gif)](./?only_with_tag=MAIN#isakmp_frag.c) **Up to [[cvs.NetBSD.org]](/bsdweb.cgi/?only_with_tag=MAIN#dirlist) / [src](/bsdweb.cgi/src/?only_with_tag=MAIN#dirlist) / [crypto](/bsdweb.cgi/src/crypto/?only_with_tag=MAIN#dirlist) / [dist](/bsdweb.cgi/src/crypto/dist/?only_with_tag=MAIN#dirlist) / [ipsec-tools](/bsdweb.cgi/src/crypto/dist/ipsec-tools/?only_with_tag=MAIN#dirlist) / [src](/bsdweb.cgi/src/crypto/dist/ipsec-tools/src/?only_with_tag=MAIN#dirlist) / [racoon](/bsdweb.cgi/src/crypto/dist/ipsec-tools/src/racoon/?only_with_tag=MAIN#dirlist)**

[Request diff between arbitrary revisions](#diff)

---

Keyword substitution: kv

Default branch: MAIN

Current tag: MAIN

---

Revision **1.10**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.10;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.10;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.10;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.10;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.10;only_with_tag=MAIN#rev1.10)

*Fri Oct 5 20:12:37 2018 UTC* (6 years, 3 months ago) by *christos*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [phil-wifi-20200421](./isakmp_frag.c?only_with_tag=phil-wifi-20200421),
[phil-wifi-20200411](./isakmp_frag.c?only_with_tag=phil-wifi-20200411),
[phil-wifi-20200406](./isakmp_frag.c?only_with_tag=phil-wifi-20200406),
[phil-wifi-20191119](./isakmp_frag.c?only_with_tag=phil-wifi-20191119),
[phil-wifi-20190609](./isakmp_frag.c?only_with_tag=phil-wifi-20190609),
[pgoyette-compat-20190127](./isakmp_frag.c?only_with_tag=pgoyette-compat-20190127),
[pgoyette-compat-20190118](./isakmp_frag.c?only_with_tag=pgoyette-compat-20190118),
[pgoyette-compat-1226](./isakmp_frag.c?only_with_tag=pgoyette-compat-1226),
[pgoyette-compat-1126](./isakmp_frag.c?only_with_tag=pgoyette-compat-1126),
[pgoyette-compat-1020](./isakmp_frag.c?only_with_tag=pgoyette-compat-1020),
[perseant-exfatfs-base-20240630](./isakmp_frag.c?only_with_tag=perseant-exfatfs-base-20240630),
[perseant-exfatfs-base](./isakmp_frag.c?only_with_tag=perseant-exfatfs-base),
[perseant-exfatfs](./isakmp_frag.c?only_with_tag=perseant-exfatfs),
[netbsd-9-base](./isakmp_frag.c?only_with_tag=netbsd-9-base),
[netbsd-9-4-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-9-4-RELEASE),
[netbsd-9-3-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-9-3-RELEASE),
[netbsd-9-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-9-2-RELEASE),
[netbsd-9-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-9-1-RELEASE),
[netbsd-9-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-9-0-RELEASE),
[netbsd-9-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-9-0-RC2),
[netbsd-9-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-9-0-RC1),
[netbsd-9](./isakmp_frag.c?only_with_tag=netbsd-9),
[netbsd-10-base](./isakmp_frag.c?only_with_tag=netbsd-10-base),
[netbsd-10-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-10-1-RELEASE),
[netbsd-10-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-10-0-RELEASE),
[netbsd-10-0-RC6](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC6),
[netbsd-10-0-RC5](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC5),
[netbsd-10-0-RC4](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC4),
[netbsd-10-0-RC3](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC3),
[netbsd-10-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC2),
[netbsd-10-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-10-0-RC1),
[netbsd-10](./isakmp_frag.c?only_with_tag=netbsd-10),
[is-mlppp-base](./isakmp_frag.c?only_with_tag=is-mlppp-base),
[is-mlppp](./isakmp_frag.c?only_with_tag=is-mlppp),
[cjep\_sun2x-base1](./isakmp_frag.c?only_with_tag=cjep_sun2x-base1),
[cjep\_sun2x-base](./isakmp_frag.c?only_with_tag=cjep_sun2x-base),
[cjep\_sun2x](./isakmp_frag.c?only_with_tag=cjep_sun2x),
[cjep\_staticlib\_x-base1](./isakmp_frag.c?only_with_tag=cjep_staticlib_x-base1),
[cjep\_staticlib\_x-base](./isakmp_frag.c?only_with_tag=cjep_staticlib_x-base),
[cjep\_staticlib\_x](./isakmp_frag.c?only_with_tag=cjep_staticlib_x),
[HEAD](./isakmp_frag.c?only_with_tag=HEAD)

Diff to: previous 1.9: [preferred](isakmp_frag.c.diff?r1=1.9;r2=1.10;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.9;r2=1.10;only_with_tag=MAIN;f=h)

Changes since revision 1.9: +51 -26
lines
```

From Thomas Reim:

Current racoon code cannot detect duplicate last fragments as it uses
the fragment flag instead of the fragment number.

The code does not consider that the IKE payload fragments might not be
received in the correct order. In this case, packet complete detection
will again fail and VPN clients abandoned from VPN service.
Nevertheless, clients still can add fragments to the fragment queue and
fill it up to the possible 255 fragments. Only duplicates are detected,
but not the fragments with a number greater than the last fragment
number.

The last fragment number is kept in the Phase 1 handler
after fragment queue deletion, which may lead to error notifications
after succesful reassembly of the IKE phase 1 message.

In general, the 2017's CVE fix added laconic and difficult to understand
failure notifications, which do not much help for analysis, why a VPN
client was blocked by racoon server.

This patch fixes the code and aligns it to Microsoft/Cisco IKE
fragmentation specification. It provides error logging which is in line
with above specification and adds some debug info to the logs to better
support analysis VPN client blackballing.

XXX: pullup-8

```

---

Revision **1.9**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.9;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.9;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.9;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.9;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.9;only_with_tag=MAIN#rev1.9)

*Tue Oct 2 18:49:24 2018 UTC* (6 years, 3 months ago) by *christos*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

Diff to: previous 1.8: [preferred](isakmp_frag.c.diff?r1=1.8;r2=1.9;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.8;r2=1.9;only_with_tag=MAIN;f=h)

Changes since revision 1.8: +3 -3
lines
```

PR/[53646](http://gnats.NetBSD.org/53646): Thomas Reim: Incorrect detection of the packet complete code in
fragment list check.

While the fix in [https://launchpad.net/~rdratlos/+archive/ubuntu/racoon](https://launchpad.net/~rdratlos/%2Barchive/ubuntu/racoon)

	- if (i > last_frag) /* It is complete */
	+ if (i >= last_frag) /* It is complete */

has the correct behavior, it violates the test for successful
completion of the invariant of the loop:

    for (i = 1; i <= last_frag; i++) {
	if (!check_fragment_index())
	    break;
    }
    if (i > last_frag)
	return ok;

It is better to move the check for NULL in the loop earlier, so that
the final iteration is done and the test is kept the same. It makes
the code easier to understand and preserves the original intent.

XXX: pullup-8

```

---

Revision **1.8**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.8;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.8;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.8;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.8;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.8;only_with_tag=MAIN#rev1.8)

*Sat May 19 19:32:16 2018 UTC* (6 years, 8 months ago) by *maxv*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [phil-wifi-base](./isakmp_frag.c?only_with_tag=phil-wifi-base),
[pgoyette-compat-0930](./isakmp_frag.c?only_with_tag=pgoyette-compat-0930),
[pgoyette-compat-0906](./isakmp_frag.c?only_with_tag=pgoyette-compat-0906),
[pgoyette-compat-0728](./isakmp_frag.c?only_with_tag=pgoyette-compat-0728),
[pgoyette-compat-0625](./isakmp_frag.c?only_with_tag=pgoyette-compat-0625),
[pgoyette-compat-0521](./isakmp_frag.c?only_with_tag=pgoyette-compat-0521)

Branch point for: [phil-wifi](./isakmp_frag.c?only_with_tag=phil-wifi)

Diff to: previous 1.7: [preferred](isakmp_frag.c.diff?r1=1.7;r2=1.8;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.7;r2=1.8;only_with_tag=MAIN;f=h)

Changes since revision 1.7: +1 -2
lines
```

More unused variables.

```

---

Revision **1.7**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.7;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.7;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.7;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.7;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.7;only_with_tag=MAIN#rev1.7)

*Sun Jul 23 05:40:27 2017 UTC* (7 years, 6 months ago) by *christos*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [pgoyette-compat-base](./isakmp_frag.c?only_with_tag=pgoyette-compat-base),
[pgoyette-compat-0502](./isakmp_frag.c?only_with_tag=pgoyette-compat-0502),
[pgoyette-compat-0422](./isakmp_frag.c?only_with_tag=pgoyette-compat-0422),
[pgoyette-compat-0415](./isakmp_frag.c?only_with_tag=pgoyette-compat-0415),
[pgoyette-compat-0407](./isakmp_frag.c?only_with_tag=pgoyette-compat-0407),
[pgoyette-compat-0330](./isakmp_frag.c?only_with_tag=pgoyette-compat-0330),
[pgoyette-compat-0322](./isakmp_frag.c?only_with_tag=pgoyette-compat-0322),
[pgoyette-compat-0315](./isakmp_frag.c?only_with_tag=pgoyette-compat-0315)

Branch point for: [pgoyette-compat](./isakmp_frag.c?only_with_tag=pgoyette-compat)

Diff to: previous 1.6: [preferred](isakmp_frag.c.diff?r1=1.6;r2=1.7;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.6;r2=1.7;only_with_tag=MAIN;f=h)

Changes since revision 1.6: +10 -5
lines
```

PR/[51682](http://gnats.NetBSD.org/51682): Antoine Beaupré: Simplify and comment previous patch.
XXX: pullup-8

```

---

Revision **1.6**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.6;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.6;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.6;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.6;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.6;only_with_tag=MAIN#rev1.6)

*Tue Jan 24 19:23:31 2017 UTC* (8 years ago) by *christos*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [prg-localcount2-base3](./isakmp_frag.c?only_with_tag=prg-localcount2-base3),
[prg-localcount2-base2](./isakmp_frag.c?only_with_tag=prg-localcount2-base2),
[prg-localcount2-base1](./isakmp_frag.c?only_with_tag=prg-localcount2-base1),
[prg-localcount2-base](./isakmp_frag.c?only_with_tag=prg-localcount2-base),
[prg-localcount2](./isakmp_frag.c?only_with_tag=prg-localcount2),
[pgoyette-localcount-20170426](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20170426),
[pgoyette-localcount-20170320](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20170320),
[perseant-stdc-iso10646-base](./isakmp_frag.c?only_with_tag=perseant-stdc-iso10646-base),
[perseant-stdc-iso10646](./isakmp_frag.c?only_with_tag=perseant-stdc-iso10646),
[netbsd-8-base](./isakmp_frag.c?only_with_tag=netbsd-8-base),
[bouyer-socketcan-base1](./isakmp_frag.c?only_with_tag=bouyer-socketcan-base1)

Branch point for: [netbsd-8](./isakmp_frag.c?only_with_tag=netbsd-8)

Diff to: previous 1.5: [preferred](isakmp_frag.c.diff?r1=1.5;r2=1.6;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.5;r2=1.6;only_with_tag=MAIN;f=h)

Changes since revision 1.5: +63 -32
lines
```

PR/[51682](http://gnats.NetBSD.org/51682): Avoid DoS with fragment out of order insertion; keep fragments
sorted in the list.

```

---

Revision **1.5**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.5;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.5;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.5;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.5;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.5;only_with_tag=MAIN#rev1.5)

*Wed Apr 22 11:24:20 2009 UTC* (15 years, 9 months ago) by *tteras*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [yamt-pagecache-tag8](./isakmp_frag.c?only_with_tag=yamt-pagecache-tag8),
[yamt-pagecache-base9](./isakmp_frag.c?only_with_tag=yamt-pagecache-base9),
[yamt-pagecache-base8](./isakmp_frag.c?only_with_tag=yamt-pagecache-base8),
[yamt-pagecache-base7](./isakmp_frag.c?only_with_tag=yamt-pagecache-base7),
[yamt-pagecache-base6](./isakmp_frag.c?only_with_tag=yamt-pagecache-base6),
[yamt-pagecache-base5](./isakmp_frag.c?only_with_tag=yamt-pagecache-base5),
[yamt-pagecache-base4](./isakmp_frag.c?only_with_tag=yamt-pagecache-base4),
[yamt-pagecache-base3](./isakmp_frag.c?only_with_tag=yamt-pagecache-base3),
[yamt-pagecache-base2](./isakmp_frag.c?only_with_tag=yamt-pagecache-base2),
[yamt-pagecache-base](./isakmp_frag.c?only_with_tag=yamt-pagecache-base),
[yamt-pagecache](./isakmp_frag.c?only_with_tag=yamt-pagecache),
[tls-maxphys-base](./isakmp_frag.c?only_with_tag=tls-maxphys-base),
[tls-maxphys](./isakmp_frag.c?only_with_tag=tls-maxphys),
[tls-earlyentropy-base](./isakmp_frag.c?only_with_tag=tls-earlyentropy-base),
[tls-earlyentropy](./isakmp_frag.c?only_with_tag=tls-earlyentropy),
[riastradh-xf86-video-intel-2-7-1-pre-2-21-15](./isakmp_frag.c?only_with_tag=riastradh-xf86-video-intel-2-7-1-pre-2-21-15),
[riastradh-drm2-base3](./isakmp_frag.c?only_with_tag=riastradh-drm2-base3),
[riastradh-drm2-base2](./isakmp_frag.c?only_with_tag=riastradh-drm2-base2),
[riastradh-drm2-base1](./isakmp_frag.c?only_with_tag=riastradh-drm2-base1),
[riastradh-drm2-base](./isakmp_frag.c?only_with_tag=riastradh-drm2-base),
[riastradh-drm2](./isakmp_frag.c?only_with_tag=riastradh-drm2),
[pgoyette-localcount-base](./isakmp_frag.c?only_with_tag=pgoyette-localcount-base),
[pgoyette-localcount-20170107](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20170107),
[pgoyette-localcount-20161104](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20161104),
[pgoyette-localcount-20160806](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20160806),
[pgoyette-localcount-20160726](./isakmp_frag.c?only_with_tag=pgoyette-localcount-20160726),
[netbsd-7-nhusb-base-20170116](./isakmp_frag.c?only_with_tag=netbsd-7-nhusb-base-20170116),
[netbsd-7-nhusb-base](./isakmp_frag.c?only_with_tag=netbsd-7-nhusb-base),
[netbsd-7-nhusb](./isakmp_frag.c?only_with_tag=netbsd-7-nhusb),
[netbsd-7-base](./isakmp_frag.c?only_with_tag=netbsd-7-base),
[netbsd-7-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-2-RELEASE),
[netbsd-7-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-1-RELEASE),
[netbsd-7-1-RC2](./isakmp_frag.c?only_with_tag=netbsd-7-1-RC2),
[netbsd-7-1-RC1](./isakmp_frag.c?only_with_tag=netbsd-7-1-RC1),
[netbsd-7-1-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-1-2-RELEASE),
[netbsd-7-1-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-1-1-RELEASE),
[netbsd-7-1](./isakmp_frag.c?only_with_tag=netbsd-7-1),
[netbsd-7-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-0-RELEASE),
[netbsd-7-0-RC3](./isakmp_frag.c?only_with_tag=netbsd-7-0-RC3),
[netbsd-7-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-7-0-RC2),
[netbsd-7-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-7-0-RC1),
[netbsd-7-0-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-0-2-RELEASE),
[netbsd-7-0-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-7-0-1-RELEASE),
[netbsd-7-0](./isakmp_frag.c?only_with_tag=netbsd-7-0),
[netbsd-7](./isakmp_frag.c?only_with_tag=netbsd-7),
[netbsd-6-base](./isakmp_frag.c?only_with_tag=netbsd-6-base),
[netbsd-6-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-RELEASE),
[netbsd-6-1-RC4](./isakmp_frag.c?only_with_tag=netbsd-6-1-RC4),
[netbsd-6-1-RC3](./isakmp_frag.c?only_with_tag=netbsd-6-1-RC3),
[netbsd-6-1-RC2](./isakmp_frag.c?only_with_tag=netbsd-6-1-RC2),
[netbsd-6-1-RC1](./isakmp_frag.c?only_with_tag=netbsd-6-1-RC1),
[netbsd-6-1-5-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-5-RELEASE),
[netbsd-6-1-4-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-4-RELEASE),
[netbsd-6-1-3-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-3-RELEASE),
[netbsd-6-1-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-2-RELEASE),
[netbsd-6-1-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-1-1-RELEASE),
[netbsd-6-1](./isakmp_frag.c?only_with_tag=netbsd-6-1),
[netbsd-6-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-RELEASE),
[netbsd-6-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-6-0-RC2),
[netbsd-6-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-6-0-RC1),
[netbsd-6-0-6-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-6-RELEASE),
[netbsd-6-0-5-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-5-RELEASE),
[netbsd-6-0-4-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-4-RELEASE),
[netbsd-6-0-3-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-3-RELEASE),
[netbsd-6-0-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-2-RELEASE),
[netbsd-6-0-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-6-0-1-RELEASE),
[netbsd-6-0](./isakmp_frag.c?only_with_tag=netbsd-6-0),
[netbsd-6](./isakmp_frag.c?only_with_tag=netbsd-6),
[matt-premerge-20091211](./isakmp_frag.c?only_with_tag=matt-premerge-20091211),
[matt-nb6-plus-nbase](./isakmp_frag.c?only_with_tag=matt-nb6-plus-nbase),
[matt-nb6-plus-base](./isakmp_frag.c?only_with_tag=matt-nb6-plus-base),
[matt-nb6-plus](./isakmp_frag.c?only_with_tag=matt-nb6-plus),
[matt-mips64-premerge-20101231](./isakmp_frag.c?only_with_tag=matt-mips64-premerge-20101231),
[localcount-20160914](./isakmp_frag.c?only_with_tag=localcount-20160914),
[khorben-n900](./isakmp_frag.c?only_with_tag=khorben-n900),
[jym-xensuspend-nbase](./isakmp_frag.c?only_with_tag=jym-xensuspend-nbase),
[jym-xensuspend-base](./isakmp_frag.c?only_with_tag=jym-xensuspend-base),
[ipsec-tools-0\_8\_2](./isakmp_frag.c?only_with_tag=ipsec-tools-0_8_2),
[ipsec-tools-0\_8\_1](./isakmp_frag.c?only_with_tag=ipsec-tools-0_8_1),
[ipsec-tools-0\_8\_0](./isakmp_frag.c?only_with_tag=ipsec-tools-0_8_0),
[ipsec-tools-0\_8-branch](./isakmp_frag.c?only_with_tag=ipsec-tools-0_8-branch),
[cherry-xenmp-base](./isakmp_frag.c?only_with_tag=cherry-xenmp-base),
[cherry-xenmp](./isakmp_frag.c?only_with_tag=cherry-xenmp),
[bouyer-socketcan-base](./isakmp_frag.c?only_with_tag=bouyer-socketcan-base),
[bouyer-quota2-nbase](./isakmp_frag.c?only_with_tag=bouyer-quota2-nbase),
[bouyer-quota2-base](./isakmp_frag.c?only_with_tag=bouyer-quota2-base),
[bouyer-quota2](./isakmp_frag.c?only_with_tag=bouyer-quota2),
[agc-symver-base](./isakmp_frag.c?only_with_tag=agc-symver-base),
[agc-symver](./isakmp_frag.c?only_with_tag=agc-symver)

Branch point for: [pgoyette-localcount](./isakmp_frag.c?only_with_tag=pgoyette-localcount),
[bouyer-socketcan](./isakmp_frag.c?only_with_tag=bouyer-socketcan)

Diff to: previous 1.4: [preferred](isakmp_frag.c.diff?r1=1.4;r2=1.5;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.4;r2=1.5;only_with_tag=MAIN;f=h)

Changes since revision 1.4: +3 -2
lines
```

From Neil Kettle: Fix a possible null pointer dereference in fragmentation
code.

```

---

Revision **1.4**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.4;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.4;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.4;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.4;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.4;only_with_tag=MAIN#rev1.4)

*Sat Sep 9 16:22:09 2006 UTC* (18 years, 4 months ago) by *manu*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [yamt-pf42-baseX](./isakmp_frag.c?only_with_tag=yamt-pf42-baseX),
[yamt-pf42-base4](./isakmp_frag.c?only_with_tag=yamt-pf42-base4),
[yamt-pf42-base3](./isakmp_frag.c?only_with_tag=yamt-pf42-base3),
[yamt-pf42-base2](./isakmp_frag.c?only_with_tag=yamt-pf42-base2),
[yamt-pf42-base](./isakmp_frag.c?only_with_tag=yamt-pf42-base),
[yamt-pf42](./isakmp_frag.c?only_with_tag=yamt-pf42),
[wrstuden-revivesa-base-3](./isakmp_frag.c?only_with_tag=wrstuden-revivesa-base-3),
[wrstuden-revivesa-base-2](./isakmp_frag.c?only_with_tag=wrstuden-revivesa-base-2),
[wrstuden-revivesa-base-1](./isakmp_frag.c?only_with_tag=wrstuden-revivesa-base-1),
[wrstuden-revivesa-base](./isakmp_frag.c?only_with_tag=wrstuden-revivesa-base),
[wrstuden-revivesa](./isakmp_frag.c?only_with_tag=wrstuden-revivesa),
[wrstuden-fixsa-newbase](./isakmp_frag.c?only_with_tag=wrstuden-fixsa-newbase),
[wrstuden-fixsa-base-1](./isakmp_frag.c?only_with_tag=wrstuden-fixsa-base-1),
[wrstuden-fixsa-base](./isakmp_frag.c?only_with_tag=wrstuden-fixsa-base),
[wrstuden-fixsa](./isakmp_frag.c?only_with_tag=wrstuden-fixsa),
[netbsd-5-base](./isakmp_frag.c?only_with_tag=netbsd-5-base),
[netbsd-5-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-2-RELEASE),
[netbsd-5-2-RC1](./isakmp_frag.c?only_with_tag=netbsd-5-2-RC1),
[netbsd-5-2-3-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-2-3-RELEASE),
[netbsd-5-2-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-2-2-RELEASE),
[netbsd-5-2-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-2-1-RELEASE),
[netbsd-5-2](./isakmp_frag.c?only_with_tag=netbsd-5-2),
[netbsd-5-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-RELEASE),
[netbsd-5-1-RC4](./isakmp_frag.c?only_with_tag=netbsd-5-1-RC4),
[netbsd-5-1-RC3](./isakmp_frag.c?only_with_tag=netbsd-5-1-RC3),
[netbsd-5-1-RC2](./isakmp_frag.c?only_with_tag=netbsd-5-1-RC2),
[netbsd-5-1-RC1](./isakmp_frag.c?only_with_tag=netbsd-5-1-RC1),
[netbsd-5-1-5-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-5-RELEASE),
[netbsd-5-1-4-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-4-RELEASE),
[netbsd-5-1-3-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-3-RELEASE),
[netbsd-5-1-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-2-RELEASE),
[netbsd-5-1-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-1-1-RELEASE),
[netbsd-5-1](./isakmp_frag.c?only_with_tag=netbsd-5-1),
[netbsd-5-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-0-RELEASE),
[netbsd-5-0-RC4](./isakmp_frag.c?only_with_tag=netbsd-5-0-RC4),
[netbsd-5-0-RC3](./isakmp_frag.c?only_with_tag=netbsd-5-0-RC3),
[netbsd-5-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-5-0-RC2),
[netbsd-5-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-5-0-RC1),
[netbsd-5-0-2-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-0-2-RELEASE),
[netbsd-5-0-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-5-0-1-RELEASE),
[netbsd-5-0](./isakmp_frag.c?only_with_tag=netbsd-5-0),
[netbsd-5](./isakmp_frag.c?only_with_tag=netbsd-5),
[netbsd-4-base](./isakmp_frag.c?only_with_tag=netbsd-4-base),
[netbsd-4-0-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-4-0-RELEASE),
[netbsd-4-0-RC5](./isakmp_frag.c?only_with_tag=netbsd-4-0-RC5),
[netbsd-4-0-RC4](./isakmp_frag.c?only_with_tag=netbsd-4-0-RC4),
[netbsd-4-0-RC3](./isakmp_frag.c?only_with_tag=netbsd-4-0-RC3),
[netbsd-4-0-RC2](./isakmp_frag.c?only_with_tag=netbsd-4-0-RC2),
[netbsd-4-0-RC1](./isakmp_frag.c?only_with_tag=netbsd-4-0-RC1),
[netbsd-4-0-1-RELEASE](./isakmp_frag.c?only_with_tag=netbsd-4-0-1-RELEASE),
[netbsd-4-0](./isakmp_frag.c?only_with_tag=netbsd-4-0),
[netbsd-4](./isakmp_frag.c?only_with_tag=netbsd-4),
[mjf-devfs2-base](./isakmp_frag.c?only_with_tag=mjf-devfs2-base),
[mjf-devfs2](./isakmp_frag.c?only_with_tag=mjf-devfs2),
[matt-nb5-pq3-base](./isakmp_frag.c?only_with_tag=matt-nb5-pq3-base),
[matt-nb5-pq3](./isakmp_frag.c?only_with_tag=matt-nb5-pq3),
[matt-nb5-mips64-u2-k2-k4-k7-k8-k9](./isakmp_frag.c?only_with_tag=matt-nb5-mips64-u2-k2-k4-k7-k8-k9),
[matt-nb5-mips64-u1-k1-k5](./isakmp_frag.c?only_with_tag=matt-nb5-mips64-u1-k1-k5),
[matt-nb5-mips64-premerge-20101231](./isakmp_frag.c?only_with_tag=matt-nb5-mips64-premerge-20101231),
[matt-nb5-mips64-premerge-20091211](./isakmp_frag.c?only_with_tag=matt-nb5-mips64-premerge-20091211),
[matt-nb5-mips64-k15](./isakmp_frag.c?only_with_tag=matt-nb5-mips64-k15),
[matt-nb5-mips64](./isakmp_frag.c?only_with_tag=matt-nb5-mips64),
[matt-nb4-mips64-k7-u2a-k9b](./isakmp_frag.c?only_with_tag=matt-nb4-mips64-k7-u2a-k9b),
[matt-mips64-base2](./isakmp_frag.c?only_with_tag=matt-mips64-base2),
[matt-mips64-base](./isakmp_frag.c?only_with_tag=matt-mips64-base),
[matt-mips64](./isakmp_frag.c?only_with_tag=matt-mips64),
[matt-armv6-prevmlocking](./isakmp_frag.c?only_with_tag=matt-armv6-prevmlocking),
[matt-armv6-nbase](./isakmp_frag.c?only_with_tag=matt-armv6-nbase),
[matt-armv6-base](./isakmp_frag.c?only_with_tag=matt-armv6-base),
[matt-armv6](./isakmp_frag.c?only_with_tag=matt-armv6),
[keiichi-mipv6-base](./isakmp_frag.c?only_with_tag=keiichi-mipv6-base),
[keiichi-mipv6](./isakmp_frag.c?only_with_tag=keiichi-mipv6),
[ipsec-tools-0\_7\_1](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7_1),
[ipsec-tools-0\_7-rc1](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-rc1),
[ipsec-tools-0\_7-beta3](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-beta3),
[ipsec-tools-0\_7-beta2](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-beta2),
[ipsec-tools-0\_7-beta1](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-beta1),
[ipsec-tools-0\_7-base](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-base),
[ipsec-tools-0\_7-RC1](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-RC1),
[ipsec-tools-0\_7](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7),
[hpcarm-cleanup-nbase](./isakmp_frag.c?only_with_tag=hpcarm-cleanup-nbase),
[hpcarm-cleanup-base](./isakmp_frag.c?only_with_tag=hpcarm-cleanup-base),
[hpcarm-cleanup](./isakmp_frag.c?only_with_tag=hpcarm-cleanup),
[cube-autoconf-base](./isakmp_frag.c?only_with_tag=cube-autoconf-base),
[cube-autoconf](./isakmp_frag.c?only_with_tag=cube-autoconf)

Branch point for: [jym-xensuspend](./isakmp_frag.c?only_with_tag=jym-xensuspend),
[ipsec-tools-0\_7-branch](./isakmp_frag.c?only_with_tag=ipsec-tools-0_7-branch)

Diff to: previous 1.3: [preferred](isakmp_frag.c.diff?r1=1.3;r2=1.4;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.3;r2=1.4;only_with_tag=MAIN;f=h)

Changes since revision 1.3: +0 -0
lines
```

Migration of ipsec-tools to NetBSD CVS part 2: resolving the import conflicts.
Since we previously had a release branch and we import here the HEAD of CVS,
let's assume all local changes are to be dumped. Local patches should have
been propagated upstream, anyway.

```

---

Revision **1.3**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.3;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.3;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.3;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.3;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.3;only_with_tag=MAIN#rev1.3)

*Mon Nov 21 14:20:29 2005 UTC* (19 years, 2 months ago) by *manu*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

CVS tags: [abandoned-netbsd-4-base](./isakmp_frag.c?only_with_tag=abandoned-netbsd-4-base),
[abandoned-netbsd-4](./isakmp_frag.c?only_with_tag=abandoned-netbsd-4)

Diff to: previous 1.2: [preferred](isakmp_frag.c.diff?r1=1.2;r2=1.3;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.2;r2=1.3;only_with_tag=MAIN;f=h)

Changes since revision 1.2: +0 -0
lines
```

Merge ipsec-tools 0.6.3 import

```

---

Revision **1.2**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.2;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.2;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.2;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.2;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.2;only_with_tag=MAIN#rev1.2)

*Sat Aug 20 00:57:06 2005 UTC* (19 years, 5 months ago) by *manu*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)

Diff to: previous 1.1: [preferred](isakmp_frag.c.diff?r1=1.1;r2=1.2;only_with_tag=MAIN), [colored](isakmp_frag.c.diff?r1=1.1;r2=1.2;only_with_tag=MAIN;f=h)

Changes since revision 1.1: +3 -1
lines
```

Update to ipsec-tools 0.6.1

```

---

Revision **1.1**: [download](/bsdweb.cgi/~checkout~/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c?rev=1.1;content-type=text%2Fx-csrc;only_with_tag=MAIN) - view: [text](isakmp_frag.c?rev=1.1;content-type=text%2Fplain;only_with_tag=MAIN), [markup](isakmp_frag.c?rev=1.1;content-type=text%2Fx-cvsweb-markup;only_with_tag=MAIN), [annotated](isakmp_frag.c?annotate=1.1;only_with_tag=MAIN) - [select for diffs](isakmp_frag.c?r1=1.1;only_with_tag=MAIN#rev1.1)

*Sat Feb 12 11:12:20 2005 UTC* (19 years, 11 months ago) by *manu*

Branches: [MAIN](./isakmp_frag.c?only_with_tag=MAIN)
```

Initial revision

```

---

Diff request

This form allows you to request diffs between any two revisions of a file.
You may select a symbolic revision name using the selection box or you may
type in a numeric name using the type-in text box.

| Diffs between | Use Text Field yamt-pf42-baseX yamt-pf42-base4 yamt-pf42-base3 yamt-pf42-base2 yamt-pf42-base yamt-pf42 yamt-pagecache-tag8 yamt-pagecache-base9 yamt-pagecache-base8 yamt-pagecache-base7 yamt-pagecache-base6 yamt-pagecache-base5 yamt-pagecache-base4 yamt-pagecache-base3 yamt-pagecache-base2 yamt-pagecache-base yamt-pagecache wrstuden-revivesa-base-3 wrstuden-revivesa-base-2 wrstuden-revivesa-base-1 wrstuden-revivesa-base wrstuden-revivesa wrstuden-fixsa-newbase wrstuden-fixsa-base-1 wrstuden-fixsa-base wrstuden-fixsa tls-maxphys-base tls-maxphys tls-earlyentropy-base tls-earlyentropy riastradh-xf86-video-intel-2-7-1-pre-2-21-15 riastradh-drm2-base3 riastradh-drm2-base2 riastradh-drm2-base1 riastradh-drm2-base riastradh-drm2 prg-localcount2-base3 prg-localcount2-base2 prg-localcount2-base1 prg-localcount2-base prg-localcount2 phil-wifi-base phil-wifi-20200421 phil-wifi-20200411 phil-wifi-20200406 phil-wifi-20191119 phil-wifi-20190609 phil-wifi pgoyette-localcount-base pgoyette-localcount-20170426 pgoyette-localcount-20170320 pgoyette-localcount-20170107 pgoyette-localcount-20161104 pgoyette-localcount-20160806 pgoyette-localcount-20160726 pgoyette-localcount pgoyette-compat-merge-20190127 pgoyette-compat-base pgoyette-compat-20190127 pgoyette-compat-20190118 pgoyette-compat-1226 pgoyette-compat-1126 pgoyette-compat-1020 pgoyette-compat-0930 pgoyette-compat-0906 pgoyette-compat-0728 pgoyette-compat-0625 pgoyette-compat-0521 pgoyette-compat-0502 pgoyette-compat-0422 pgoyette-compat-0415 pgoyette-compat-0407 pgoyette-compat-0330 pgoyette-compat-0322 pgoyette-compat-0315 pgoyette-compat perseant-stdc-iso10646-base perseant-stdc-iso10646 perseant-exfatfs-base-20240630 perseant-exfatfs-base perseant-exfatfs netbsd-9-base netbsd-9-4-RELEASE netbsd-9-3-RELEASE netbsd-9-2-RELEASE netbsd-9-1-RELEASE netbsd-9-0-RELEASE netbsd-9-0-RC2 netbsd-9-0-RC1 netbsd-9 netbsd-8-base netbsd-8-3-RELEASE netbsd-8-2-RELEASE netbsd-8-1-RELEASE netbsd-8-1-RC1 netbsd-8-0-RELEASE netbsd-8-0-RC2 netbsd-8-0-RC1 netbsd-8 netbsd-7-nhusb-base-20170116 netbsd-7-nhusb-base netbsd-7-nhusb netbsd-7-base netbsd-7-2-RELEASE netbsd-7-1-RELEASE netbsd-7-1-RC2 netbsd-7-1-RC1 netbsd-7-1-2-RELEASE netbsd-7-1-1-RELEASE netbsd-7-1 netbsd-7-0-RELEASE netbsd-7-0-RC3 netbsd-7-0-RC2 netbsd-7-0-RC1 netbsd-7-0-2-RELEASE netbsd-7-0-1-RELEASE netbsd-7-0 netbsd-7 netbsd-6-base netbsd-6-1-RELEASE netbsd-6-1-RC4 netbsd-6-1-RC3 netbsd-6-1-RC2 netbsd-6-1-RC1 netbsd-6-1-5-RELEASE netbsd-6-1-4-RELEASE netbsd-6-1-3-RELEASE netbsd-6-1-2-RELEASE netbsd-6-1-1-RELEASE netbsd-6-1 netbsd-6-0-RELEASE netbsd-6-0-RC2 netbsd-6-0-RC1 netbsd-6-0-6-RELEASE netbsd-6-0-5-RELEASE netbsd-6-0-4-RELEASE netbsd-6-0-3-RELEASE netbsd-6-0-2-RELEASE netbsd-6-0-1-RELEASE netbsd-6-0 netbsd-6 netbsd-5-base netbsd-5-2-RELEASE netbsd-5-2-RC1 netbsd-5-2-3-RELEASE netbsd-5-2-2-RELEASE netbsd-5-2-1-RELEASE netbsd-5-2 netbsd-5-1-RELEASE netbsd-5-1-RC4 netbsd-5-1-RC3 netbsd-5-1-RC2 netbsd-5-1-RC1 netbsd-5-1-5-RELEASE netbsd-5-1-4-RELEASE netbsd-5-1-3-RELEASE netbsd-5-1-2-RELEASE netbsd-5-1-1-RELEASE netbsd-5-1 netbsd-5-0-RELEASE netbsd-5-0-RC4 netbsd-5-0-RC3 netbsd-5-0-RC2 netbsd-5-0-RC1 netbsd-5-0-2-RELEASE netbsd-5-0-1-RELEASE netbsd-5-0 netbsd-5 netbsd-4-base netbsd-4-0-RELEASE netbsd-4-0-RC5 netbsd-4-0-RC4 netbsd-4-0-RC3 netbsd-4-0-RC2 netbsd-4-0-RC1 netbsd-4-0-1-RELEASE netbsd-4-0 netbsd-4 netbsd-3-base netbsd-3-1-RELEASE netbsd-3-1-RC4 netbsd-3-1-RC3 netbsd-3-1-RC2 netbsd-3-1-RC1 netbsd-3-1-1-RELEASE netbsd-3-1 netbsd-3-0-RELEASE netbsd-3-0-RC6 netbsd-3-0-RC5 netbsd-3-0-RC4 netbsd-3-0-RC3 netbsd-3-0-RC2 netbsd-3-0-RC1 netbsd-3-0-3-RELEASE netbsd-3-0-2-RELEASE netbsd-3-0-1-RELEASE netbsd-3-0 netbsd-3 netbsd-10-base netbsd-10-1-RELEASE netbsd-10-0-RELEASE netbsd-10-0-RC6 netbsd-10-0-RC5 netbsd-10-0-RC4 netbsd-10-0-RC3 netbsd-10-0-RC2 netbsd-10-0-RC1 netbsd-10 mjf-devfs2-base mjf-devfs2 matt-premerge-20091211 matt-nb8-mediatek-base matt-nb8-mediatek matt-nb6-plus-nbase matt-nb6-plus-base matt-nb6-plus matt-nb5-pq3-base matt-nb5-pq3 matt-nb5-mips64-u2-k2-k4-k7-k8-k9 matt-nb5-mips64-u1-k1-k5 matt-nb5-mips64-premerge-20101231 matt-nb5-mips64-premerge-20091211 matt-nb5-mips64-k15 matt-nb5-mips64 matt-nb4-mips64-k7-u2a-k9b matt-mips64-premerge-20101231 matt-mips64-base2 matt-mips64-base matt-mips64 matt-armv6-prevmlocking matt-armv6-nbase matt-armv6-base matt-armv6 localcount-20160914 khorben-n900 keiichi-mipv6-base keiichi-mipv6 jym-xensuspend-nbase jym-xensuspend-base jym-xensuspend is-mlppp-base is-mlppp ipsec-tools-base ipsec-tools-0\_8\_2 ipsec-tools-0\_8\_1 ipsec-tools-0\_8\_0 ipsec-tools-0\_8-branch ipsec-tools-0\_7\_3 ipsec-tools-0\_7\_2 ipsec-tools-0\_7\_1 ipsec-tools-0\_7-rc1 ipsec-tools-0\_7-branch ipsec-tools-0\_7-beta3 ipsec-tools-0\_7-beta2 ipsec-tools-0\_7-beta1 ipsec-tools-0\_7-base ipsec-tools-0\_7-RC1 ipsec-tools-0\_7 ipsec-tools-0\_6\_3 ipsec-tools-0\_6\_2 ipsec-tools-0\_6\_1-rc1 ipsec-tools-0\_6\_1 ipsec-tools-0\_6-base ipsec-tools-0\_6-20050317 ipsec-tools-0\_6-20050314 ipsec-tools-0\_6-20050224 ipsec-tools-0\_6-20050223 hpcarm-cleanup-nbase hpcarm-cleanup-base hpcarm-cleanup cube-autoconf-base cube-autoconf cjep\_sun2x-base1 cjep\_sun2x-base cjep\_sun2x cjep\_staticlib\_x-base1 cjep\_staticlib\_x-base cjep\_staticlib\_x cherry-xenmp-base cherry-xenmp bouyer-socketcan-base1 bouyer-socketcan-base bouyer-socketcan bouyer-quota2-nbase bouyer-quota2-base bouyer-quota2 agc-symver-base agc-symver abandoned-netbsd-4-base abandoned-netbsd-4 MAIN IPSEC\_TOOLS HEAD |  |
| --- | --- | --- |
| and | Use Text Field yamt-pf42-baseX yamt-pf42-base4 yamt-pf42-base3 yamt-pf42-base2 yamt-pf42-base yamt-pf42 yamt-pagecache-tag8 yamt-pagecache-base9 yamt-pagecache-base8 yamt-pagecache-base7 yamt-pagecache-base6 yamt-pagecache-base5 yamt-pagecache-base4 yamt-pagecache-base3 yamt-pagecache-base2 yamt-pagecache-base yamt-pagecache wrstuden-revivesa-base-3 wrstuden-revivesa-base-2 wrstuden-revivesa-base-1 wrstuden-revivesa-base wrstuden-revivesa wrstuden-fixsa-newbase wrstuden-fixsa-base-1 wrstuden-fixsa-base wrstuden-fixsa tls-maxphys-base tls-maxphys tls-earlyentropy-base tls-earlyentropy riastradh-xf86-video-intel-2-7-1-pre-2-21-15 riastradh-drm2-base3 riastradh-drm2-base2 riastradh-drm2-base1 riastradh-drm2-base riastradh-drm2 prg-localcount2-base3 prg-localcount2-base2 prg-localcount2-base1 prg-localcount2-base prg-localcount2 phil-wifi-base phil-wifi-20200421 phil-wifi-20200411 phil-wifi-20200406 phil-wifi-20191119 phil-wifi-20190609 phil-wifi pgoyette-localcount-base pgoyette-localcount-20170426 pgoyette-localcount-20170320 pgoyette-localcount-20170107 pgoyette-localcount-20161104 pgoyette-localcount-20160806 pgoyette-localcount-20160726 pgoyette-localcount pgoyette-compat-merge-20190127 pgoyette-compat-base pgoyette-compat-20190127 pgoyette-compat-20190118 pgoyette-compat-1226 pgoyette-compat-1126 pgoyette-compat-1020 pgoyette-compat-0930 pgoyette-compat-0906 pgoyette-compat-0728 pgoyette-compat-0625 pgoyette-compat-0521 pgoyette-compat-0502 pgoyette-compat-0422 pgoyette-compat-0415 pgoyette-compat-0407 pgoyette-compat-0330 pgoyette-compat-0322 pgoyette-compat-0315 pgoyette-compat perseant-stdc-iso10646-base perseant-stdc-iso10646 perseant-exfatfs-base-20240630 perseant-exfatfs-base perseant-exfatfs netbsd-9-base netbsd-9-4-RELEASE netbsd-9-3-RELEASE netbsd-9-2-RELEASE netbsd-9-1-RELEASE netbsd-9-0-RELEASE netbsd-9-0-RC2 netbsd-9-0-RC1 netbsd-9 netbsd-8-base netbsd-8-3-RELEASE netbsd-8-2-RELEASE netbsd-8-1-RELEASE netbsd-8-1-RC1 netbsd-8-0-RELEASE netbsd-8-0-RC2 netbsd-8-0-RC1 netbsd-8 netbsd-7-nhusb-base-20170116 netbsd-7-nhusb-base netbsd-7-nhusb netbsd-7-base netbsd-7-2-RELEASE netbsd-7-1-RELEASE netbsd-7-1-RC2 netbsd-7-1-RC1 netbsd-7-1-2-RELEASE netbsd-7-1-1-RELEASE netbsd-7-1 netbsd-7-0-RELEASE netbsd-7-0-RC3 netbsd-7-0-RC2 netbsd-7-0-RC1 netbsd-7-0-2-RELEASE netbsd-7-0-1-RELEASE netbsd-7-0 netbsd-7 netbsd-6-base netbsd-6-1-RELEASE netbsd-6-1-RC4 netbsd-6-1-RC3 netbsd-6-1-RC2 netbsd-6-1-RC1 netbsd-6-1-5-RELEASE netbsd-6-1-4-RELEASE netbsd-6-1-3-RELEASE netbsd-6-1-2-RELEASE netbsd-6-1-1-RELEASE netbsd-6-1 netbsd-6-0-RELEASE netbsd-6-0-RC2 netbsd-6-0-RC1 netbsd-6-0-6-RELEASE netbsd-6-0-5-RELEASE netbsd-6-0-4-RELEASE netbsd-6-0-3-RELEASE netbsd-6-0-2-RELEASE netbsd-6-0-1-RELEASE netbsd-6-0 netbsd-6 netbsd-5-base netbsd-5-2-RELEASE netbsd-5-2-RC1 netbsd-5-2-3-RELEASE netbsd-5-2-2-RELEASE netbsd-5-2-1-RELEASE netbsd-5-2 netbsd-5-1-RELEASE netbsd-5-1-RC4 netbsd-5-1-RC3 netbsd-5-1-RC2 netbsd-5-1-RC1 netbsd-5-1-5-RELEASE netbsd-5-1-4-RELEASE netbsd-5-1-3-RELEASE netbsd-5-1-2-RELEASE netbsd-5-1-1-RELEASE netbsd-5-1 netbsd-5-0-RELEASE netbsd-5-0-RC4 netbsd-5-0-RC3 netbsd-5-0-RC2 netbsd-5-0-RC1 netbsd-5-0-2-RELEASE netbsd-5-0-1-RELEASE netbsd-5-0 netbsd-5 netbsd-4-base netbsd-4-0-RELEASE netbsd-4-0-RC5 netbsd-4-0-RC4 netbsd-4-0-RC3 netbsd-4-0-RC2 netbsd-4-0-RC1 netbsd-4-0-1-RELEASE netbsd-4-0 netbsd-4 netbsd-3-base netbsd-3-1-RELEASE netbsd-3-1-RC4 netbsd-3-1-RC3 netbsd-3-1-RC2 netbsd-3-1-RC1 netbsd-3-1-1-RELEASE netbsd-3-1 netbsd-3-0-RELEASE netbsd-3-0-RC6 netbsd-3-0-RC5 netbsd-3-0-RC4 netbsd-3-0-RC3 netbsd-3-0-RC2 netbsd-3-0-RC1 netbsd-3-0-3-RELEASE netbsd-3-0-2-RELEASE netbsd-3-0-1-RELEASE netbsd-3-0 netbsd-3 netbsd-10-base netbsd-10-1-RELEASE netbsd-10-0-RELEASE netbsd-10-0-RC6 netbsd-10-0-RC5 netbsd-10-0-RC4 netbsd-10-0-RC3 netbsd-10-0-RC2 netbsd-10-0-RC1 netbsd-10 mjf-devfs2-base mjf-devfs2 matt-premerge-20091211 matt-nb8-mediatek-base matt-nb8-mediatek matt-nb6-plus-nbase matt-nb6-plus-base matt-nb6-plus matt-nb5-pq3-base matt-nb5-pq3 matt-nb5-mips64-u2-k2-k4-k7-k8-k9 matt-nb5-mips64-u1-k1-k5 matt-nb5-mips64-premerge-20101231 matt-nb5-mips64-premerge-20091211 matt-nb5-mips64-k15 matt-nb5-mips64 matt-nb4-mips64-k7-u2a-k9b matt-mips64-premerge-20101231 matt-mips64-base2 matt-mips64-base matt-mips64 matt-armv6-prevmlocking matt-armv6-nbase matt-armv6-base matt-armv6 localcount-20160914 khorben-n900 keiichi-mipv6-base keiichi-mipv6 jym-xensuspend-nbase jym-xensuspend-base jym-xensuspend is-mlppp-base is-mlppp ipsec-tools-base ipsec-tools-0\_8\_2 ipsec-tools-0\_8\_1 ipsec-tools-0\_8\_0 ipsec-tools-0\_8-branch ipsec-tools-0\_7\_3 ipsec-tools-0\_7\_2 ipsec-tools-0\_7\_1 ipsec-tools-0\_7-rc1 ipsec-tools-0\_7-branch ipsec-tools-0\_7-beta3 ipsec-tools-0\_7-beta2 ipsec-tools-0\_7-beta1 ipsec-tools-0\_7-base ipsec-tools-0\_7-RC1 ipsec-tools-0\_7 ipsec-tools-0\_6\_3 ipsec-tools-0\_6\_2 ipsec-tools-0\_6\_1-rc1 ipsec-tools-0\_6\_1 ipsec-tools-0\_6-base ipsec-tools-0\_6-20050317 ipsec-tools-0\_6-20050314 ipsec-tools-0\_6-20050224 ipsec-tools-0\_6-20050223 hpcarm-cleanup-nbase hpcarm-cleanup-base hpcarm-cleanup cube-autoconf-base cube-autoconf cjep\_sun2x-base1 cjep\_sun2x-base cjep\_sun2x cjep\_staticlib\_x-base1 cjep\_staticlib\_x-base cjep\_staticlib\_x cherry-xenmp-base cherry-xenmp bouyer-socketcan-base1 bouyer-socketcan-base bouyer-socketcan bouyer-quota2-nbase bouyer-quota2-base bouyer-quota2 agc-symver-base agc-symver abandoned-netbsd-4-base abandoned-netbsd-4 MAIN IPSEC\_TOOLS HEAD |  |

Log view options

| Preferred diff type: | Colored Long colored Unified Context Side by side |  |
| --- | --- | --- |
| View only branch: | Show all branches yamt-pf42 yamt-pagecache wrstuden-revivesa wrstuden-fixsa tls-maxphys tls-earlyentropy riastradh-drm2 prg-localcount2 phil-wifi pgoyette-localcount pgoyette-compat perseant-stdc-iso10646 perseant-exfatfs netbsd-9 netbsd-8 netbsd-7-nhusb netbsd-7-1 netbsd-7-0 netbsd-7 netbsd-6-1 netbsd-6-0 netbsd-6 netbsd-5-2 netbsd-5-1 netbsd-5-0 netbsd-5 netbsd-4-0 netbsd-4 netbsd-3-1 netbsd-3-0 netbsd-3 netbsd-10 mjf-devfs2 matt-nb8-mediatek matt-nb6-plus matt-nb5-pq3 matt-nb5-mips64 matt-mips64 matt-armv6 khorben-n900 keiichi-mipv6 jym-xensuspend is-mlppp ipsec-tools-0\_8-branch ipsec-tools-0\_7-branch hpcarm-cleanup cube-autoconf cjep\_sun2x cjep\_staticlib\_x cherry-xenmp bouyer-socketcan bouyer-quota2 agc-symver abandoned-netbsd-4 MAIN |  |
| Sort log by: | Not sorted Commit date Revision |  |

---

CVSweb <webmaster@jp.NetBSD.org>


=== Content from gnats.netbsd.org_d7680aff_20250124_140146.html ===

# NetBSD Problem Report #51682

```

From www@NetBSD.org  Fri Dec  2 21:21:07 2016
Return-Path: <www@NetBSD.org>
Received: from mail.netbsd.org (mail.netbsd.org [199.233.217.200])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(Client CN "mail.netbsd.org", Issuer "Postmaster NetBSD.org" (verified OK))
	by mollari.NetBSD.org (Postfix) with ESMTPS id 0A0107A284
	for <gnats-bugs@gnats.NetBSD.org>; Fri,  2 Dec 2016 21:21:07 +0000 (UTC)
Message-Id: <20161202212105.B6CEE7A303@mollari.NetBSD.org>
Date: Fri,  2 Dec 2016 21:21:05 +0000 (UTC)
From: rfoggia@trustwave.com
Reply-To: rfoggia@trustwave.com
To: gnats-bugs@NetBSD.org
Subject: Remote un-authenticated denial of service
X-Send-Pr-Version: www-1.0

>Number:         51682
>Category:       security
>Synopsis:       Remote un-authenticated denial of service
>Confidential:   no
>Severity:       non-critical
>Priority:       low
>Responsible:    security-officer
>State:          open
>Class:          support
>Submitter-Id:   net
>Arrival-Date:   Fri Dec 02 21:25:00 +0000 2016
>Last-Modified:  Thu Aug 31 08:55:01 +0000 2017
>Originator:     Robert Foggia
>Release:
>Organization:
Trustwave
>Environment:
>Description:
Finding 1: Remote un-authenticated denial of service in ipsec-tools

The ipsec-tools racoon daemon contains a remotely exploitable computational complexity attack when parsing and storing isakmp fragments. The implementation permits a remote attacker to exhaust computational resources on the remote endpoint by repeatedly sending isakmp fragment packets in a particular order such that the worst-case computational complexity is realized in the algorithm utilized to determine if reassembly of the fragments can take place.

We've reached out to IpSec-tools directly.  They said to also report it to you as well since you manage your own folk.

>How-To-Repeat:
The algorithm in question is a simple quadratic linked list walk and is in O(n(n+1)) hence O(n^2) for n fragments received. Since the implementation fails to identify repeated fragment indices, a remote attacker can repeatedly specify the same index. Worst-case complexity is realized if fragments are sent in reverse order, for instance:

253, 252 ... 3, 2, 1, 255 (last fragment)

The absence of fragment index 254 is not an error as this ensures fragment reassembly is not possible.

>Fix:
Only in ipsec-tools-0.8.2-new/: .DS_Store
Only in ipsec-tools-0.8.2-new/src: .DS_Store
diff -ru ipsec-tools-0.8.2/src/racoon/handler.h ipsec-tools-0.8.2-new/src/racoon/handler.h
--- ipsec-tools-0.8.2/src/racoon/handler.h	2010-11-17 10:40:41.000000000 +0000
+++ ipsec-tools-0.8.2-new/src/racoon/handler.h	2016-09-02 17:03:27.000000000 +0100
@@ -141,6 +141,7 @@
 #endif
 #ifdef ENABLE_FRAG
 	int frag;			/* IKE phase 1 fragmentation */
+	int	frag_last_index;
 	struct isakmp_frag_item *frag_chain;	/* Received fragments */
 #endif

diff -ru ipsec-tools-0.8.2/src/racoon/isakmp.c ipsec-tools-0.8.2-new/src/racoon/isakmp.c
--- ipsec-tools-0.8.2/src/racoon/isakmp.c	2012-08-29 09:55:26.000000000 +0100
+++ ipsec-tools-0.8.2-new/src/racoon/isakmp.c	2016-09-06 09:14:46.000000000 +0100
@@ -1069,6 +1069,7 @@
 		iph1->frag = 1;
 	else
 		iph1->frag = 0;
+	iph1->frag_last_index = 0;
 	iph1->frag_chain = NULL;
 #endif
 	iph1->approval = NULL;
@@ -1173,6 +1174,7 @@
 #endif
 #ifdef ENABLE_FRAG
 	iph1->frag = 0;
+	iph1->frag_last_index = 0;
 	iph1->frag_chain = NULL;
 #endif
 	iph1->approval = NULL;
diff -ru ipsec-tools-0.8.2/src/racoon/isakmp_frag.c ipsec-tools-0.8.2-new/src/racoon/isakmp_frag.c
--- ipsec-tools-0.8.2/src/racoon/isakmp_frag.c	2009-04-22 12:24:20.000000000 +0100
+++ ipsec-tools-0.8.2-new/src/racoon/isakmp_frag.c	2016-10-03 12:51:52.000000000 +0100
@@ -224,39 +224,66 @@
 	item->frag_next = NULL;
 	item->frag_packet = buf;

-	/* Look for the last frag while inserting the new item in the chain */
-	if (item->frag_last)
-		last_frag = item->frag_num;
-
-	if (iph1->frag_chain == NULL) {
-		iph1->frag_chain = item;
-	} else {
-		struct isakmp_frag_item *current;
-
-		current = iph1->frag_chain;
-		while (current->frag_next) {
-			if (current->frag_last)
-				last_frag = item->frag_num;
-			current = current->frag_next;
+	/* Check for the last frag before inserting the new item in the chain */
+	if (item->frag_last) {
+		/* if we have the last fragment, indices must match */
+		if (iph1->frag_last_index != 0 &&
+		    item->frag_last != iph1->frag_last_index) {
+			plog(LLV_ERROR, LOCATION, NULL,
+			     "Repeated last fragment index mismatch\n");
+			racoon_free(item);
+			vfree(buf);
+			return -1;
 		}
-		current->frag_next = item;
+
+		last_frag = iph1->frag_last_index = item->frag_num;
 	}

-	/* If we saw the last frag, check if the chain is complete */
+  /* insert fragment into chain */
+  if (iph1->frag_chain == NULL) {
+    iph1->frag_chain = item;
+  } else {
+    struct isakmp_frag_item *pitem = NULL, *citem = iph1->frag_chain;
+
+    do {
+      if (citem->frag_num == item->frag_num) {
+        plog(LLV_ERROR, LOCATION, NULL,
+             "Repeated fragment index mismatch\n");
+        racoon_free(item);
+        vfree(buf);
+        return -1;
+      }
+
+      if (citem->frag_num > item->frag_num) {
+        if (pitem)
+          pitem->next = item;
+        item->next = citem;
+        break;
+      }
+
+      pitem = citem;
+      citem = citem->frag_next;
+    } while (citem != NULL);
+
+    /* we reached the end of the list, insert */
+    if (citem == NULL)
+      pitem->next = item;
+  }
+
+	/* If we saw the last frag, check if the chain is complete
+   * we have a sorted list now, so just walk through */
 	if (last_frag != 0) {
+    item = iph1->frag_chain;
 		for (i = 1; i <= last_frag; i++) {
-			item = iph1->frag_chain;
-			do {
-				if (item->frag_num == i)
-					break;
-				item = item->frag_next;
-			} while (item != NULL);
+      if (item->frag_num != i)
+        break;
+      item = item->frag_next;

 			if (item == NULL) /* Not found */
 				break;
 		}

-		if (item != NULL) /* It is complete */
+		if (i > last_frag) /* It is complete */
 			return 1;
 	}

@@ -291,15 +318,9 @@
 	}
 	data = buf->v;

+  item = iph1->frag_chain;
 	for (i = 1; i <= frag_count; i++) {
-		item = iph1->frag_chain;
-		do {
-			if (item->frag_num == i)
-				break;
-			item = item->frag_next;
-		} while (item != NULL);
-
-		if (item == NULL) {
+    if (item->frag_num != i) {
 			plog(LLV_ERROR, LOCATION, NULL,
 			    "Missing fragment #%d\n", i);
 			vfree(buf);
@@ -308,6 +329,7 @@
 		}
 		memcpy(data, item->frag_packet->v, item->frag_packet->l);
 		data += item->frag_packet->l;
+    item = item->frag_next;
 	}

 out:
diff -ru ipsec-tools-0.8.2/src/racoon/isakmp_inf.c ipsec-tools-0.8.2-new/src/racoon/isakmp_inf.c
--- ipsec-tools-0.8.2/src/racoon/isakmp_inf.c	2013-04-12 10:53:52.000000000 +0100
+++ ipsec-tools-0.8.2-new/src/racoon/isakmp_inf.c	2016-09-05 11:00:40.000000000 +0100
@@ -720,6 +720,7 @@
 #endif
 #ifdef ENABLE_FRAG
 	iph1->frag = 0;
+	iph1->frag_last_index = 0;
 	iph1->frag_chain = NULL;
 #endif

>Audit-Trail:
From: christos@zoulas.com (Christos Zoulas)
To: gnats-bugs@NetBSD.org, security-officer@netbsd.org,
	gnats-admin@netbsd.org, security-alert@netbsd.org
Cc:
Subject: Re: security/51682: Remote un-authenticated denial of service
Date: Mon, 23 Jan 2017 21:34:33 -0500

 On Dec 2,  9:25pm, rfoggia@trustwave.com (rfoggia@trustwave.com) wrote:
 -- Subject: security/51682: Remote un-authenticated denial of service

 Hi,

 Have you tried this patch? It does not compile... Here's a version
 that compiles. How did you test it? Do you have a test harness you
 can share?

 Index: handler.h
 ===================================================================
 RCS file: /cvsroot/src/crypto/dist/ipsec-tools/src/racoon/handler.h,v
 retrieving revision 1.25
 diff -u -u -r1.25 handler.h
 --- handler.h	17 Nov 2010 10:40:41 -0000	1.25
 +++ handler.h	24 Jan 2017 02:29:15 -0000
 @@ -141,6 +141,7 @@
  #endif
  #ifdef ENABLE_FRAG
  	int frag;			/* IKE phase 1 fragmentation */
 +	int frag_last_index;
  	struct isakmp_frag_item *frag_chain;	/* Received fragments */
  #endif

 Index: isakmp.c
 ===================================================================
 RCS file: /cvsroot/src/crypto/dist/ipsec-tools/src/racoon/isakmp.c,v
 retrieving revision 1.75
 diff -u -u -r1.75 isakmp.c
 --- isakmp.c	9 Mar 2016 22:27:17 -0000	1.75
 +++ isakmp.c	24 Jan 2017 02:29:15 -0000
 @@ -1077,6 +1077,7 @@
  		iph1->frag = 1;
  	else
  		iph1->frag = 0;
 +	iph1->frag_last_index = 0;
  	iph1->frag_chain = NULL;
  #endif
  	iph1->approval = NULL;
 @@ -1181,6 +1182,7 @@
  #endif
  #ifdef ENABLE_FRAG
  	iph1->frag = 0;
 +	iph1->frag_last_index = 0;
  	iph1->frag_chain = NULL;
  #endif
  	iph1->approval = NULL;
 Index: isakmp_frag.c
 ===================================================================
 RCS file: /cvsroot/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c,v
 retrieving revision 1.5
 diff -u -u -r1.5 isakmp_frag.c
 --- isakmp_frag.c	22 Apr 2009 11:24:20 -0000	1.5
 +++ isakmp_frag.c	24 Jan 2017 02:29:15 -0000
 @@ -173,6 +173,38 @@
  	return ntohl(hp[MD5_DIGEST_LENGTH / sizeof(*hp)]);
  }

 +static int
 +isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 +{
 +	struct isakmp_frag_item *pitem = NULL;
 +	struct isakmp_frag_item *citem = iph1->frag_chain;
 +
 +	if (iph1->frag_chain == NULL) {
 +		iph1->frag_chain = item;
 +		return 0;
 +	}
 +
 +	do {
 +		if (citem->frag_num == item->frag_num)
 +			return -1;
 +
 +		if (citem->frag_num > item->frag_num) {
 +			if (pitem)
 +				pitem->frag_next = item;
 +			item->frag_next = citem;
 +			break;
 +		}
 +
 +		pitem = citem;
 +		citem = citem->frag_next;
 +	} while (citem != NULL);
 +
 +	/* we reached the end of the list, insert */
 +	if (citem == NULL)
 +	      pitem->frag_next = item;
 +	return 0;
 +}
 +
  int
  isakmp_frag_extract(iph1, msg)
  	struct ph1handle *iph1;
 @@ -224,39 +256,43 @@
  	item->frag_next = NULL;
  	item->frag_packet = buf;

 -	/* Look for the last frag while inserting the new item in the chain */
 -	if (item->frag_last)
 -		last_frag = item->frag_num;
 +	/* Check for the last frag before inserting the new item in the chain */
 +	if (item->frag_last) {
 +		/* if we have the last fragment, indices must match */
 +		if (iph1->frag_last_index != 0 &&
 +		    item->frag_last != iph1->frag_last_index) {
 +			plog(LLV_ERROR, LOCATION, NULL,
 +			     "Repeated last fragment index mismatch\n");
 +			racoon_free(item);
 +			vfree(buf);
 +			return -1;
 +		}

 -	if (iph1->frag_chain == NULL) {
 -		iph1->frag_chain = item;
 -	} else {
 -		struct isakmp_frag_item *current;
 +		last_frag = iph1->frag_last_index = item->frag_num;
 +	}

 -		current = iph1->frag_chain;
 -		while (current->frag_next) {
 -			if (current->frag_last)
 -				last_frag = item->frag_num;
 -			current = current->frag_next;
 -		}
 -		current->frag_next = item;
 +	/* insert fragment into chain */
 +	if (isakmp_frag_insert(iph1, item) == -1) {
 +		plog(LLV_ERROR, LOCATION, NULL,
 +		    "Repeated fragment index mismatch\n");
 +		racoon_free(item);
 +		vfree(buf);
 +		return -1;
  	}

 -	/* If we saw the last frag, check if the chain is complete */
 +	/* If we saw the last frag, check if the chain is complete
 +	 * we have a sorted list now, so just walk through */
  	if (last_frag != 0) {
 +		item = iph1->frag_chain;
  		for (i = 1; i <= last_frag; i++) {
 -			item = iph1->frag_chain;
 -			do {
 -				if (item->frag_num == i)
 -					break;
 -				item = item->frag_next;
 -			} while (item != NULL);
 -
 +			if (item->frag_num != i)
 +				break;
 +			item = item->frag_next;
  			if (item == NULL) /* Not found */
  				break;
  		}

 -		if (item != NULL) /* It is complete */
 +		if (i > last_frag) /* It is complete */
  			return 1;
  	}

 @@ -291,15 +327,9 @@
  	}
  	data = buf->v;

 +	item = iph1->frag_chain;
  	for (i = 1; i <= frag_count; i++) {
 -		item = iph1->frag_chain;
 -		do {
 -			if (item->frag_num == i)
 -				break;
 -			item = item->frag_next;
 -		} while (item != NULL);
 -
 -		if (item == NULL) {
 +		if (item->frag_num != i) {
  			plog(LLV_ERROR, LOCATION, NULL,
  			    "Missing fragment #%d\n", i);
  			vfree(buf);
 @@ -308,6 +338,7 @@
  		}
  		memcpy(data, item->frag_packet->v, item->frag_packet->l);
  		data += item->frag_packet->l;
 +		item = item->frag_next;
  	}

  out:
 Index: isakmp_inf.c
 ===================================================================
 RCS file: /cvsroot/src/crypto/dist/ipsec-tools/src/racoon/isakmp_inf.c,v
 retrieving revision 1.50
 diff -u -u -r1.50 isakmp_inf.c
 --- isakmp_inf.c	12 Apr 2013 09:53:10 -0000	1.50
 +++ isakmp_inf.c	24 Jan 2017 02:29:15 -0000
 @@ -720,6 +720,7 @@
  #endif
  #ifdef ENABLE_FRAG
  	iph1->frag = 0;
 +	iph1->frag_last_index = 0;
  	iph1->frag_chain = NULL;
  #endif

From: "Christos Zoulas" <christos@netbsd.org>
To: gnats-bugs@gnats.NetBSD.org
Cc:
Subject: PR/51682 CVS commit: src/crypto/dist/ipsec-tools/src/racoon
Date: Tue, 24 Jan 2017 14:23:31 -0500

 Module Name:	src
 Committed By:	christos
 Date:		Tue Jan 24 19:23:31 UTC 2017

 Modified Files:
 	src/crypto/dist/ipsec-tools/src/racoon: isakmp_frag.c

 Log Message:
 PR/51682: Avoid DoS with fragment out of order insertion; keep fragments
 sorted in the list.

 To generate a diff of this commit:
 cvs rdiff -u -r1.5 -r1.6 src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c

 Please note that diffs are not public domain; they are subject to the
 copyright notices on the relevant files.

From: "Christos Zoulas" <christos@netbsd.org>
To: gnats-bugs@gnats.NetBSD.org
Cc:
Subject: PR/51682 CVS commit: src/crypto/dist/ipsec-tools/src/racoon
Date: Tue, 24 Jan 2017 14:23:56 -0500

 Module Name:	src
 Committed By:	christos
 Date:		Tue Jan 24 19:23:56 UTC 2017

 Modified Files:
 	src/crypto/dist/ipsec-tools/src/racoon: handler.h isakmp.c isakmp_inf.c

 Log Message:
 PR/51682: Avoid DoS with fragment out of order insertion; keep fragments
 sorted in the list.

 To generate a diff of this commit:
 cvs rdiff -u -r1.25 -r1.26 src/crypto/dist/ipsec-tools/src/racoon/handler.h
 cvs rdiff -u -r1.75 -r1.76 src/crypto/dist/ipsec-tools/src/racoon/isakmp.c
 cvs rdiff -u -r1.50 -r1.51 \
     src/crypto/dist/ipsec-tools/src/racoon/isakmp_inf.c

 Please note that diffs are not public domain; they are subject to the
 copyright notices on the relevant files.

From: Robert Foggia <RFoggia@trustwave.com>
To: "gnats-bugs@NetBSD.org" <gnats-bugs@NetBSD.org>,
	"security-officer@netbsd.org" <security-officer@netbsd.org>,
	"gnats-admin@netbsd.org" <gnats-admin@netbsd.org>,
	"security-alert@netbsd.org" <security-alert@netbsd.org>
Cc:
Subject: Re: PR/51682 CVS commit: src/crypto/dist/ipsec-tools/src/racoon
Date: Wed, 28 Jun 2017 21:13:05 +0000

 SGVsbG8sDQoNCkp1c3QgY2hlY2tpbmcgaW4gdG8gc2VlIGlmIHRoaXMgd2FzIGZpeGVkLiAgV2Ug
 YXJlIGxvb2tpbmcgdG8gcHVibGlzaCBkZXRhaWxzIGFib3V0IHRoaXMuICBUaGFua3MhDQoNCg0K
 QmVzdCByZWdhcmRzLA0KDQpSb2JlcnQgRm9nZ2lhDQpTZWN1cml0eSBSZXNlYXJjaGVyLCBJbnRl
 bGxpZ2VuY2UgVGVhbSwgU3BpZGVyTGFicw0KdDogKzEgMzEyLjg3My43Njk2DQogDQpUcnVzdHdh
 dmUgfCBTTUFSVCBTRUNVUklUWSBPTiBERU1BTkQNCnd3dy50cnVzdHdhdmUuY29tIDxodHRwOi8v
 d3d3LnRydXN0d2F2ZS5jb20vPg0KDQoNCg0KDQoNCg0KDQpPbiAxLzI0LzE3LCAxOjI1IFBNLCAi
 Q2hyaXN0b3MgWm91bGFzIiA8Y2hyaXN0b3NAbmV0YnNkLm9yZz4gd3JvdGU6DQoNCj5UaGUgZm9s
 bG93aW5nIHJlcGx5IHdhcyBtYWRlIHRvIFBSIHNlY3VyaXR5LzUxNjgyOyBpdCBoYXMgYmVlbiBu
 b3RlZCBieSBHTkFUUy4NCj4NCj5Gcm9tOiAiQ2hyaXN0b3MgWm91bGFzIiA8Y2hyaXN0b3NAbmV0
 YnNkLm9yZz4NCj5UbzogZ25hdHMtYnVnc0BnbmF0cy5OZXRCU0Qub3JnDQo+Q2M6IA0KPlN1Ympl
 Y3Q6IFBSLzUxNjgyIENWUyBjb21taXQ6IHNyYy9jcnlwdG8vZGlzdC9pcHNlYy10b29scy9zcmMv
 cmFjb29uDQo+RGF0ZTogVHVlLCAyNCBKYW4gMjAxNyAxNDoyMzo1NiAtMDUwMA0KPg0KPiBNb2R1
 bGUgTmFtZToJc3JjDQo+IENvbW1pdHRlZCBCeToJY2hyaXN0b3MNCj4gRGF0ZToJCVR1ZSBKYW4g
 MjQgMTk6MjM6NTYgVVRDIDIwMTcNCj4gDQo+IE1vZGlmaWVkIEZpbGVzOg0KPiAJc3JjL2NyeXB0
 by9kaXN0L2lwc2VjLXRvb2xzL3NyYy9yYWNvb246IGhhbmRsZXIuaCBpc2FrbXAuYyBpc2FrbXBf
 aW5mLmMNCj4gDQo+IExvZyBNZXNzYWdlOg0KPiBQUi81MTY4MjogQXZvaWQgRG9TIHdpdGggZnJh
 Z21lbnQgb3V0IG9mIG9yZGVyIGluc2VydGlvbjsga2VlcCBmcmFnbWVudHMNCj4gc29ydGVkIGlu
 IHRoZSBsaXN0Lg0KPiANCj4gDQo+IFRvIGdlbmVyYXRlIGEgZGlmZiBvZiB0aGlzIGNvbW1pdDoN
 Cj4gY3ZzIHJkaWZmIC11IC1yMS4yNSAtcjEuMjYgc3JjL2NyeXB0by9kaXN0L2lwc2VjLXRvb2xz
 L3NyYy9yYWNvb24vaGFuZGxlci5oDQo+IGN2cyByZGlmZiAtdSAtcjEuNzUgLXIxLjc2IHNyYy9j
 cnlwdG8vZGlzdC9pcHNlYy10b29scy9zcmMvcmFjb29uL2lzYWttcC5jDQo+IGN2cyByZGlmZiAt
 dSAtcjEuNTAgLXIxLjUxIFwNCj4gICAgIHNyYy9jcnlwdG8vZGlzdC9pcHNlYy10b29scy9zcmMv
 cmFjb29uL2lzYWttcF9pbmYuYw0KPiANCj4gUGxlYXNlIG5vdGUgdGhhdCBkaWZmcyBhcmUgbm90
 IHB1YmxpYyBkb21haW47IHRoZXkgYXJlIHN1YmplY3QgdG8gdGhlDQo+IGNvcHlyaWdodCBub3Rp
 Y2VzIG9uIHRoZSByZWxldmFudCBmaWxlcy4NCj4gDQo=

From: Taylor R Campbell <riastradh@NetBSD.org>
To: Robert Foggia <RFoggia@trustwave.com>
Cc: "gnats-bugs@NetBSD.org" <gnats-bugs@NetBSD.org>,
	"security-officer@netbsd.org" <security-officer@netbsd.org>,
	"gnats-admin@netbsd.org" <gnats-admin@netbsd.org>, "security-alert@netbsd.org" <security-alert@netbsd.org>
Subject: Re: PR/51682 CVS commit: src/crypto/dist/ipsec-tools/src/racoon
Date: Thu, 29 Jun 2017 01:01:53 +0000

 > Date: Wed, 28 Jun 2017 21:13:05 +0000
 > From: Robert Foggia <RFoggia@trustwave.com>
 >
 > Just checking in to see if this was fixed.  We are looking to
 > publish details about this.  Thanks!

 It appears to have been fixed in HEAD, and thus will be in NetBSD 8.0.
 The change has not been applied to older branches -- netbsd-7 or
 netbsd-6 -- and I have not been paying enough attention to know
 whether the bug occurs there too.

From: Jiri Bohac <jbohac@suse.cz>
To: gnats-bugs@NetBSD.org
Cc:
Subject: Re: security/51682
Date: Wed, 12 Jul 2017 22:24:13 +0200

 While reviewing the fix for #51682, I found what I believe is a
 newly introduced regression / memory leak / DoS.

 Bug scenario: the fragments arrive out of order; iph1->frag_chain
 already contains some fragments; the newly received fragment has
 the lowest frag_num so it should be inserted in the beginning of
 the list:

 > RCS file: /cvsroot/src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c,v
 > retrieving revision 1.5
 > diff -u -u -r1.5 isakmp_frag.c
 > --- isakmp_frag.c	22 Apr 2009 11:24:20 -0000	1.5
 > +++ isakmp_frag.c	24 Jan 2017 02:29:15 -0000
 > @@ -173,6 +173,38 @@
 >  	return ntohl(hp[MD5_DIGEST_LENGTH / sizeof(*hp)]);
 >  }
 >
 > +static int
 > +isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 > +{
 > +	struct isakmp_frag_item *pitem = NULL;
 > +	struct isakmp_frag_item *citem = iph1->frag_chain;
 > +

 item is not the first to arrive, iph1->frag_chain != NULL,
 so the fragment is not inserted here:

 > +	if (iph1->frag_chain == NULL) {
 > +		iph1->frag_chain = item;
 > +		return 0;
 > +	}
 > +
 > +	do {
 > +		if (citem->frag_num == item->frag_num)
 > +			return -1;
 > +

 item is lowest-numbered fragment so we want to insert it now ...

 > +		if (citem->frag_num > item->frag_num) {

 ... but pitem is still NULL, we break doing nothing

 > +			if (pitem)
 > +				pitem->frag_next = item;
 > +			item->frag_next = citem;
 > +			break;
 > +		}
 > +
 > +		pitem = citem;
 > +		citem = citem->frag_next;
 > +	} while (citem != NULL);
 > +
 > +	/* we reached the end of the list, insert */
 > +	if (citem == NULL)
 > +	      pitem->frag_next = item;
 > +	return 0;

 We return 0.
 The newly received fragment is not inserted in the list -> it's
 lost (a regression) and never freed (possible DoS).

 I think the correct fix would either need more special cases or
 something simpler like: (untested)

 static int
 isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 {
 	struct isakmp_frag_item **pitem = &iph1->frag_chain
 	struct isakmp_frag_item *citem = iph1->frag_chain;

 	while (citem != NULL) {
 		if (citem->frag_num == item->frag_num)
 			return -1;

 		if (citem->frag_num > item->frag_num) {
 			item->frag_next = citem;
 			break;
 		}

 		pitem = &citem->frag_next;
 		citem = citem->frag_next;
 	}

 	(*pitem)->frag_next = item;
 	return 0;
 }

 --
 Jiri Bohac <jbohac@suse.cz>
 SUSE Labs, Prague, Czechia

From: =?utf-8?Q?Antoine_Beaupr=C3=A9?= <anarcat@orangeseeds.org>
To: gnats-bugs@NetBSD.org
Cc: Jiri Bohac <jbohac@suse.cz>
Subject: Re: security/51682
Date: Wed, 19 Jul 2017 12:39:33 -0400

 --=-=-=
 Content-Type: text/plain

 Hi,

 I agree there's something wrong with the code, although I would also
 like to have ways of reproducing this. Working on this bug right now is
 kind of a shot in the dark, and it seems numerous people here have
 worked on PoC or have real world conditions to reproduce those
 issues. It would be nice to share those so we can fix those issues
 properly.

 That said, I believe the change proposed by Jiri Bohac is incorrect: it
 will fail if iph1->frag_chain is NULL, as it will try to dereference
 that pointer and crash. I also find it confusing that pitem actually
 refers to the same item as citem - not sure that works at all.

 The original patch handled the empty list explicitely before the loop,
 and I'm not sure I see how else to deal with that peculiar case, so I
 kept that in my version. I also return explicitly within the loop to
 remove any possible confusion.

 static int
 isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 {
 	struct isakmp_frag_item *pitem = NULL;
 	struct isakmp_frag_item *citem = iph1->frag_chain;

         /* no frag yet, just insert at beginning of list */
 	if (iph1->frag_chain == NULL) {
 		iph1->frag_chain = item;
 		return 0;
 	}

         do {
 		/* duplicate fragment number, abort (CVE-2016-10396) */
 		if (citem->frag_num == item->frag_num)
 			return -1;

 		/* need to insert before current item */
 		if (citem->frag_num > item->frag_num) {
 			if (pitem != NULL)
 				pitem->frag_next = item
 			else
 				/* insert at the beginning of the list  */
 				iph1->frag_chain = item;
 			item->frag_next = citem;
 			return 0;
 		}

 		pitem = citem;
 		citem = citem->frag_next;
 	} while (citem != NULL);

 	/* we reached the end of the list, insert */
 	pitem->frag_next = item;
  	return 0;
 }

 I think this covers all cases (where are unit tests when you need
 them!), described in the comments:

  1. no frag yet: just insert at beginning of list

  2. duplicate fragment number: abort (CVE-2016-10396)

  3. the normal case, where we reach the end of the list and insert and
     the end

  4. the out of order case, where we insert elsewhere in the list

  5. an out of order special case, where insert at the beginning of the
     list but correctly linking with the remains of the list

 The final patch is attached.

 A.

 --
 Only in the darkness can you see the stars.
                         - Martin Luther King, Jr.

 --=-=-=
 Content-Type: text/x-diff
 Content-Disposition: inline; filename=CVE-2016-10396.patch

 Please note that diffs are not public domain; they are subject to the
 copyright notices on the relevant files.

 --- a/src/racoon/handler.h
 +++ b/src/racoon/handler.h
 @@ -141,6 +141,7 @@ struct ph1handle {
  #endif
  #ifdef ENABLE_FRAG
  	int frag;			/* IKE phase 1 fragmentation */
 +	int frag_last_index;
  	struct isakmp_frag_item *frag_chain;	/* Received fragments */
  #endif

 --- a/src/racoon/isakmp.c
 +++ b/src/racoon/isakmp.c
 @@ -1072,6 +1072,7 @@ isakmp_ph1begin_i(rmconf, remote, local)
  		iph1->frag = 1;
  	else
  		iph1->frag = 0;
 +	iph1->frag_last_index = 0;
  	iph1->frag_chain = NULL;
  #endif
  	iph1->approval = NULL;
 @@ -1176,6 +1177,7 @@ isakmp_ph1begin_r(msg, remote, local, et
  #endif
  #ifdef ENABLE_FRAG
  	iph1->frag = 0;
 +	iph1->frag_last_index = 0;
  	iph1->frag_chain = NULL;
  #endif
  	iph1->approval = NULL;
 --- a/src/racoon/isakmp_frag.c
 +++ b/src/racoon/isakmp_frag.c
 @@ -1,4 +1,4 @@
 -/*	$NetBSD: isakmp_frag.c,v 1.5 2009/04/22 11:24:20 tteras Exp $	*/
 +/*	$NetBSD: isakmp_frag.c,v 1.5.36.1 2017/04/21 16:50:42 bouyer Exp $	*/

  /* Id: isakmp_frag.c,v 1.4 2004/11/13 17:31:36 manubsd Exp */

 @@ -173,6 +173,43 @@ vendorid_frag_cap(gen)
  	return ntohl(hp[MD5_DIGEST_LENGTH / sizeof(*hp)]);
  }

 +static int
 +isakmp_frag_insert(struct ph1handle *iph1, struct isakmp_frag_item *item)
 +{
 +	struct isakmp_frag_item *pitem = NULL;
 +	struct isakmp_frag_item *citem = iph1->frag_chain;
 +
 +        /* no frag yet, just insert at beginning of list */
 +	if (iph1->frag_chain == NULL) {
 +		iph1->frag_chain = item;
 +		return 0;
 +	}
 +
 +        do {
 +		/* duplicate fragment number, abort (CVE-2016-10396) */
 +		if (citem->frag_num == item->frag_num)
 +			return -1;
 +
 +		/* need to insert before current item */
 +		if (citem->frag_num > item->frag_num) {
 +			if (pitem != NULL)
 +                        	pitem->frag_next = item;
 +			else
 +				/* insert at the beginning of the list  */
 +				iph1->frag_chain = item;
 +			item->frag_next = citem;
 +			return 0;
 +		}
 +
 +		pitem = citem;
 +		citem = citem->frag_next;
 +	} while (citem != NULL);
 +
 +	/* we reached the end of the list, insert */
 +	pitem->frag_next = item;
 + 	return 0;
 +}
 +
  int
  isakmp_frag_extract(iph1, msg)
  	struct ph1handle *iph1;
 @@ -224,39 +261,43 @@ isakmp_frag_extract(iph1, msg)
  	item->frag_next = NULL;
  	item->frag_packet = buf;

 -	/* Look for the last frag while inserting the new item in the chain */
 -	if (item->frag_last)
 -		last_frag = item->frag_num;
 +	/* Check for the last frag before inserting the new item in the chain */
 +	if (item->frag_last) {
 +		/* if we have the last fragment, indices must match */
 +		if (iph1->frag_last_index != 0 &&
 +		    item->frag_last != iph1->frag_last_index) {
 +			plog(LLV_ERROR, LOCATION, NULL,
 +			     "Repeated last fragment index mismatch\n");
 +			racoon_free(item);
 +			vfree(buf);
 +			return -1;
 +		}

 -	if (iph1->frag_chain == NULL) {
 -		iph1->frag_chain = item;
 -	} else {
 -		struct isakmp_frag_item *current;
 +		last_frag = iph1->frag_last_index = item->frag_num;
 +	}

 -		current = iph1->frag_chain;
 -		while (current->frag_next) {
 -			if (current->frag_last)
 -				last_frag = item->frag_num;
 -			current = current->frag_next;
 -		}
 -		current->frag_next = item;
 +	/* insert fragment into chain */
 +	if (isakmp_frag_insert(iph1, item) == -1) {
 +		plog(LLV_ERROR, LOCATION, NULL,
 +		    "Repeated fragment index mismatch\n");
 +		racoon_free(item);
 +		vfree(buf);
 +		return -1;
  	}

 -	/* If we saw the last frag, check if the chain is complete */
 +	/* If we saw the last frag, check if the chain is complete
 +	 * we have a sorted list now, so just walk through */
  	if (last_frag != 0) {
 +		item = iph1->frag_chain;
  		for (i = 1; i <= last_frag; i++) {
 -			item = iph1->frag_chain;
 -			do {
 -				if (item->frag_num == i)
 -					break;
 -				item = item->frag_next;
 -			} while (item != NULL);
 -
 +			if (item->frag_num != i)
 +				break;
 +			item = item->frag_next;
  			if (item == NULL) /* Not found */
  				break;
  		}

 -		if (item != NULL) /* It is complete */
 +		if (i > last_frag) /* It is complete */
  			return 1;
  	}

 @@ -291,15 +332,9 @@ isakmp_frag_reassembly(iph1)
  	}
  	data = buf->v;

 +	item = iph1->frag_chain;
  	for (i = 1; i <= frag_count; i++) {
 -		item = iph1->frag_chain;
 -		do {
 -			if (item->frag_num == i)
 -				break;
 -			item = item->frag_next;
 -		} while (item != NULL);
 -
 -		if (item == NULL) {
 +		if (item->frag_num != i) {
  			plog(LLV_ERROR, LOCATION, NULL,
  			    "Missing fragment #%d\n", i);
  			vfree(buf);
 @@ -308,6 +343,7 @@ isakmp_frag_reassembly(iph1)
  		}
  		memcpy(data, item->frag_packet->v, item->frag_packet->l);
  		data += item->frag_packet->l;
 +		item = item->frag_next;
  	}

  out:

 --=-=-=--

From: Jiri Bohac <jbohac@suse.cz>
To: Antoine =?iso-8859-1?Q?Beaupr=E9?= <anarcat@orangeseeds.org>
Cc: gnats-bugs@NetBSD.org
Subject: Re: security/51682
Date: Thu, 20 Jul 2017 12:26:14 +0200

 On Wed, Jul 19, 2017 at 12:39:33PM -0400, Antoine Beaupré wrote:
 > That said, I believe the change proposed by Jiri Bohac is incorrect: it
 > will fail if iph1->frag_chain is NULL, as it will try to dereference
 > that pointer and crash. I also find it confusing that pitem actually
 > refers to the same item as citem - not sure that works at all.

 Right. I wanted to write:
 	*pitem = item;
 instead of
 	(*pitem)->frag_next = item;

 Thanks for spotting this!

 pitem is a pointer-to-a-pointer; it is initialized with
 &iph1->frag_chain, so if iph1->frag_chain is NULL
 	*pitem = item
 will assign to iph1->frag_chain.

 Antoine Beaupré's patch looks good to me as well.

 --
 Jiri Bohac <jbohac@suse.cz>
 SUSE Labs, Prague, Czechia

From: "Christos Zoulas" <christos@netbsd.org>
To: gnats-bugs@gnats.NetBSD.org
Cc:
Subject: PR/51682 CVS commit: src/crypto/dist/ipsec-tools/src/racoon
Date: Sun, 23 Jul 2017 01:40:28 -0400

 Module Name:	src
 Committed By:	christos
 Date:		Sun Jul 23 05:40:28 UTC 2017

 Modified Files:
 	src/crypto/dist/ipsec-tools/src/racoon: isakmp_frag.c

 Log Message:
 PR/51682: Antoine Beaupré: Simplify and comment previous patch.
 XXX: pullup-8

 To generate a diff of this commit:
 cvs rdiff -u -r1.6 -r1.7 src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c

 Please note that diffs are not public domain; they are subject to the
 copyright notices on the relevant files.

From: "Manuel Bouyer" <bouyer@netbsd.org>
To: gnats-bugs@gnats.NetBSD.org
Cc:
Subject: PR/51682 CVS commit: [netbsd-8] src/crypto/dist/ipsec-tools/src/racoon
Date: Thu, 31 Aug 2017 08:50:57 +0000

 Module Name:	src
 Committed By:	bouyer
 Date:		Thu Aug 31 08:50:57 UTC 2017

 Modified Files:
 	src/crypto/dist/ipsec-tools/src/racoon [netbsd-8]: isakmp_frag.c

 Log Message:
 Pull up following revision(s) (requested by christos in ticket #233):
 	crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c: revision 1.7
 PR/51682: Antoine Beaupr?: Simplify and comment previous patch.
 XXX: pullup-8

 To generate a diff of this commit:
 cvs rdiff -u -r1.6 -r1.6.4.1 \
     src/crypto/dist/ipsec-tools/src/racoon/isakmp_frag.c

 Please note that diffs are not public domain; they are subject to the
 copyright notices on the relevant files.

```

---

| |  | [NetBSD Home](//www.NetBSD.org/) | | --- | --- | | |  | [NetBSD PR Database Search](//www.NetBSD.org/support/query-pr.html) | | --- | --- | |
| --- | --- | --- | --- | --- | --- |

---

[(Contact us)](//www.NetBSD.org/cgi-bin/feedback.cgi)
$NetBSD: query-full-pr,v 1.39 2013/11/01 18:47:49 spz Exp $

$NetBSD: gnats\_config.sh,v 1.8 2006/05/07 09:23:38 tsutsui Exp $

[Copyright © 1994-2014
The NetBSD Foundation, Inc. ALL RIGHTS RESERVED.](//www.NetBSD.org/about/disclaimer.html)



=== Content from cvsweb.netbsd.org_4cfdd5d4_20250124_140141.html ===
Please note that diffs are not public domain; they are subject to the
copyright notices on the relevant files.
--- src/crypto/dist/ipsec-tools/src/racoon/isakmp\_frag.c 2009/04/22 11:24:20 1.5
+++ src/crypto/dist/ipsec-tools/src/racoon/isakmp\_frag.c 2017/04/21 16:50:42 1.5.36.1
@@ -1,4 +1,4 @@
-/\* $NetBSD: isakmp\_frag.c,v 1.5 2009/04/22 11:24:20 tteras Exp $ \*/
+/\* $NetBSD: isakmp\_frag.c,v 1.5.36.1 2017/04/21 16:50:42 bouyer Exp $ \*/
/\* Id: isakmp\_frag.c,v 1.4 2004/11/13 17:31:36 manubsd Exp \*/
@@ -173,6 +173,38 @@ vendorid\_frag\_cap(gen)
return ntohl(hp[MD5\_DIGEST\_LENGTH / sizeof(\*hp)]);
}
+static int
+isakmp\_frag\_insert(struct ph1handle \*iph1, struct isakmp\_frag\_item \*item)
+{
+ struct isakmp\_frag\_item \*pitem = NULL;
+ struct isakmp\_frag\_item \*citem = iph1->frag\_chain;
+
+ if (iph1->frag\_chain == NULL) {
+ iph1->frag\_chain = item;
+ return 0;
+ }
+
+ do {
+ if (citem->frag\_num == item->frag\_num)
+ return -1;
+
+ if (citem->frag\_num > item->frag\_num) {
+ if (pitem)
+ pitem->frag\_next = item;
+ item->frag\_next = citem;
+ break;
+ }
+
+ pitem = citem;
+ citem = citem->frag\_next;
+ } while (citem != NULL);
+
+ /\* we reached the end of the list, insert \*/
+ if (citem == NULL)
+ pitem->frag\_next = item;
+ return 0;
+}
+
int
isakmp\_frag\_extract(iph1, msg)
struct ph1handle \*iph1;
@@ -224,39 +256,43 @@ isakmp\_frag\_extract(iph1, msg)
item->frag\_next = NULL;
item->frag\_packet = buf;
- /\* Look for the last frag while inserting the new item in the chain \*/
- if (item->frag\_last)
- last\_frag = item->frag\_num;
+ /\* Check for the last frag before inserting the new item in the chain \*/
+ if (item->frag\_last) {
+ /\* if we have the last fragment, indices must match \*/
+ if (iph1->frag\_last\_index != 0 &&
+ item->frag\_last != iph1->frag\_last\_index) {
+ plog(LLV\_ERROR, LOCATION, NULL,
+ "Repeated last fragment index mismatch\n");
+ racoon\_free(item);
+ vfree(buf);
+ return -1;
+ }
- if (iph1->frag\_chain == NULL) {
- iph1->frag\_chain = item;
- } else {
- struct isakmp\_frag\_item \*current;
+ last\_frag = iph1->frag\_last\_index = item->frag\_num;
+ }
- current = iph1->frag\_chain;
- while (current->frag\_next) {
- if (current->frag\_last)
- last\_frag = item->frag\_num;
- current = current->frag\_next;
- }
- current->frag\_next = item;
+ /\* insert fragment into chain \*/
+ if (isakmp\_frag\_insert(iph1, item) == -1) {
+ plog(LLV\_ERROR, LOCATION, NULL,
+ "Repeated fragment index mismatch\n");
+ racoon\_free(item);
+ vfree(buf);
+ return -1;
}
- /\* If we saw the last frag, check if the chain is complete \*/
+ /\* If we saw the last frag, check if the chain is complete
+ \* we have a sorted list now, so just walk through \*/
if (last\_frag != 0) {
+ item = iph1->frag\_chain;
for (i = 1; i <= last\_frag; i++) {
- item = iph1->frag\_chain;
- do {
- if (item->frag\_num == i)
- break;
- item = item->frag\_next;
- } while (item != NULL);
-
+ if (item->frag\_num != i)
+ break;
+ item = item->frag\_next;
if (item == NULL) /\* Not found \*/
break;
}
- if (item != NULL) /\* It is complete \*/
+ if (i > last\_frag) /\* It is complete \*/
return 1;
}
@@ -291,15 +327,9 @@ isakmp\_frag\_reassembly(iph1)
}
data = buf->v;
+ item = iph1->frag\_chain;
for (i = 1; i <= frag\_count; i++) {
- item = iph1->frag\_chain;
- do {
- if (item->frag\_num == i)
- break;
- item = item->frag\_next;
- } while (item != NULL);
-
- if (item == NULL) {
+ if (item->frag\_num != i) {
plog(LLV\_ERROR, LOCATION, NULL,
"Missing fragment #%d\n", i);
vfree(buf);
@@ -308,6 +338,7 @@ isakmp\_frag\_reassembly(iph1)
}
memcpy(data, item->frag\_packet->v, item->frag\_packet->l);
data += item->frag\_packet->l;
+ item = item->frag\_next;
}
out:

