=== Content from github.com_820aa996_20250124_192516.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbcit-ci%2FCodeIgniter%2Fissues%2F4963)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbcit-ci%2FCodeIgniter%2Fissues%2F4963)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=bcit-ci%2FCodeIgniter)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bcit-ci](/bcit-ci)
/
**[CodeIgniter](/bcit-ci/CodeIgniter)**
Public

* [Notifications](/login?return_to=%2Fbcit-ci%2FCodeIgniter) You must be signed in to change notification settings
* [Fork
  7.6k](/login?return_to=%2Fbcit-ci%2FCodeIgniter)
* [Star
   18.3k](/login?return_to=%2Fbcit-ci%2FCodeIgniter)

* [Code](/bcit-ci/CodeIgniter)
* [Issues
  65](/bcit-ci/CodeIgniter/issues)
* [Pull requests
  30](/bcit-ci/CodeIgniter/pulls)
* [Discussions](/bcit-ci/CodeIgniter/discussions)
* [Actions](/bcit-ci/CodeIgniter/actions)
* [Wiki](/bcit-ci/CodeIgniter/wiki)
* [Security](/bcit-ci/CodeIgniter/security)
* [Insights](/bcit-ci/CodeIgniter/pulse)

Additional navigation options

* [Code](/bcit-ci/CodeIgniter)
* [Issues](/bcit-ci/CodeIgniter/issues)
* [Pull requests](/bcit-ci/CodeIgniter/pulls)
* [Discussions](/bcit-ci/CodeIgniter/discussions)
* [Actions](/bcit-ci/CodeIgniter/actions)
* [Wiki](/bcit-ci/CodeIgniter/wiki)
* [Security](/bcit-ci/CodeIgniter/security)
* [Insights](/bcit-ci/CodeIgniter/pulse)

# PHPMailer - A critical vulnerability #4963

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[PHPMailer - A critical vulnerability](#top)#4963Copy linkLabels[Critical](https://github.com/bcit-ci/CodeIgniter/issues?q=state%3Aopen%20label%3A%22Critical%22)Milestone[3.1.3](https://github.com/bcit-ci/CodeIgniter/milestone/14)[![@natiq2004](https://avatars.githubusercontent.com/u/7011019?v=4&size=80)](/natiq2004)
## Description

[![@natiq2004](https://avatars.githubusercontent.com/u/7011019?v=4&size=48)](/natiq2004)[natiq2004](https://github.com/natiq2004)opened [on Dec 26, 2016](https://github.com/bcit-ci/CodeIgniter/issues/4963#issue-197606490)

Please read: <http://thehackernews.com/2016/12/phpmailer-security.html>

Please update: /system/libraries/Email.php

## Metadata

### Assignees

No one assigned

### Labels

[Critical](https://github.com/bcit-ci/CodeIgniter/issues?q=state%3Aopen%20label%3A%22Critical%22)
### Type

No type
### Projects

No projects
### Milestone

* [3.1.3](https://github.com/bcit-ci/CodeIgniter/milestone/14)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_252e4931_20250124_192517.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbcit-ci%2FCodeIgniter%2Fpull%2F4966)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbcit-ci%2FCodeIgniter%2Fpull%2F4966)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=bcit-ci%2FCodeIgniter)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bcit-ci](/bcit-ci)
/
**[CodeIgniter](/bcit-ci/CodeIgniter)**
Public

* [Notifications](/login?return_to=%2Fbcit-ci%2FCodeIgniter) You must be signed in to change notification settings
* [Fork
  7.6k](/login?return_to=%2Fbcit-ci%2FCodeIgniter)
* [Star
   18.3k](/login?return_to=%2Fbcit-ci%2FCodeIgniter)

* [Code](/bcit-ci/CodeIgniter)
* [Issues
  65](/bcit-ci/CodeIgniter/issues)
* [Pull requests
  30](/bcit-ci/CodeIgniter/pulls)
* [Discussions](/bcit-ci/CodeIgniter/discussions)
* [Actions](/bcit-ci/CodeIgniter/actions)
* [Wiki](/bcit-ci/CodeIgniter/wiki)
* [Security](/bcit-ci/CodeIgniter/security)
* [Insights](/bcit-ci/CodeIgniter/pulse)

Additional navigation options

* [Code](/bcit-ci/CodeIgniter)
* [Issues](/bcit-ci/CodeIgniter/issues)
* [Pull requests](/bcit-ci/CodeIgniter/pulls)
* [Discussions](/bcit-ci/CodeIgniter/discussions)
* [Actions](/bcit-ci/CodeIgniter/actions)
* [Wiki](/bcit-ci/CodeIgniter/wiki)
* [Security](/bcit-ci/CodeIgniter/security)
* [Insights](/bcit-ci/CodeIgniter/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fbcit-ci%2FCodeIgniter%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fbcit-ci%2FCodeIgniter%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# prevent use of escaped arguments with mail/sendmail #4966

 Closed

[derekjones](/derekjones)
wants to merge
1
commit into
[bcit-ci:master](/bcit-ci/CodeIgniter/tree/master "bcit-ci/CodeIgniter:master")
from
[derekjones:master](/derekjones/CodeIgniter/tree/master "derekjones/CodeIgniter:master")

 Closed

# [prevent use of escaped arguments with mail/sendmail](#top) #4966

[derekjones](/derekjones)
wants to merge
1
commit into
[bcit-ci:master](/bcit-ci/CodeIgniter/tree/master "bcit-ci/CodeIgniter:master")
from
[derekjones:master](/derekjones/CodeIgniter/tree/master "derekjones/CodeIgniter:master")

[Conversation
2](/bcit-ci/CodeIgniter/pull/4966)
[Commits
1](/bcit-ci/CodeIgniter/pull/4966/commits)
[Checks
0](/bcit-ci/CodeIgniter/pull/4966/checks)
[Files changed](/bcit-ci/CodeIgniter/pull/4966/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![derekjones](https://avatars.githubusercontent.com/u/763613?s=60&v=4)](/derekjones)

Copy link

Contributor

### @derekjones **[derekjones](/derekjones)** commented [Dec 30, 2016](#issue-198098485)

Fixes issue [#4963](https://github.com/bcit-ci/CodeIgniter/issues/4963)

Sorry, something went wrong.

All reactions

`[prevent use of escaped arguments with mail/sendmail](/bcit-ci/CodeIgniter/pull/4966/commits/348d5ebbced5def5014fc4b58ba90db89c68bd05 "prevent use of escaped arguments with mail/sendmail

Signed-off-by: Derek Jones <derek.jones@ellislab.com>")`
 …

`[348d5eb](/bcit-ci/CodeIgniter/pull/4966/commits/348d5ebbced5def5014fc4b58ba90db89c68bd05)`

```
Signed-off-by: Derek Jones <derek.jones@ellislab.com>
```

[![@derekjones](https://avatars.githubusercontent.com/u/763613?s=40&u=81f45aaee0627826d37b151f45af16f45046defb&v=4)](/derekjones)
[derekjones](/derekjones)
mentioned this pull request
[Dec 30, 2016](#ref-issue-197606490)

[PHPMailer - A critical vulnerability
#4963](/bcit-ci/CodeIgniter/issues/4963)

Closed

[narfbg](/narfbg)
added a commit
that referenced
this pull request
[Jan 5, 2017](#ref-commit-a960016)
[![@narfbg](https://avatars.githubusercontent.com/u/1058011?s=40&v=4)](/narfbg)

`[Address](/bcit-ci/CodeIgniter/commit/a9600161a845c6f26eebd9822ae7d799b89c8a00 "Address #4963

Would supersede PR #4966") [#4963](https://github.com/bcit-ci/CodeIgniter/issues/4963)`
…

`[a960016](/bcit-ci/CodeIgniter/commit/a9600161a845c6f26eebd9822ae7d799b89c8a00)`

```
Would supersede PR [#4966](https://github.com/bcit-ci/CodeIgniter/pull/4966)
```

[![@narfbg](https://avatars.githubusercontent.com/u/1058011?s=80&v=4)](/narfbg)

Copy link

Contributor

### **[narfbg](/narfbg)** commented [Jan 6, 2017](#issuecomment-270868886)

| Replaced with the linked commit. Thanks either way; it's good to see you're still following us. :) |
| --- |

All reactions

Sorry, something went wrong.

[![@narfbg](https://avatars.githubusercontent.com/u/1058011?s=40&v=4)](/narfbg)
[narfbg](/narfbg)
closed this
[Jan 6, 2017](#event-913836316)

[![@derekjones](https://avatars.githubusercontent.com/u/763613?s=80&u=81f45aaee0627826d37b151f45af16f45046defb&v=4)](/derekjones)

Copy link

Contributor

Author

### **[derekjones](/derekjones)** commented [Jan 6, 2017](#issuecomment-270948004)

| Of course! The security report caught my eye in my billion notifications, as they do. |
| --- |

All reactions

Sorry, something went wrong.

[narfbg](/narfbg)
added a commit
that referenced
this pull request
[Jan 9, 2017](#ref-commit-d9367b6)
[![@narfbg](https://avatars.githubusercontent.com/u/1058011?s=40&v=4)](/narfbg)

`[Address](/bcit-ci/CodeIgniter/commit/d9367b6acf96cbc407147bd4422c2cbb941ccaa1 "Address #4963

Would supersede PR #4966") [#4963](https://github.com/bcit-ci/CodeIgniter/issues/4963)`
…

`[d9367b6](/bcit-ci/CodeIgniter/commit/d9367b6acf96cbc407147bd4422c2cbb941ccaa1)`

```
Would supersede PR [#4966](https://github.com/bcit-ci/CodeIgniter/pull/4966)
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fbcit-ci%2FCodeIgniter%2Fpull%2F4966)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@derekjones](https://avatars.githubusercontent.com/u/763613?s=52&v=4)](/derekjones) [![@narfbg](https://avatars.githubusercontent.com/u/1058011?s=52&v=4)](/narfbg)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_75d77674_20250124_192515.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=64&v=4)](/Zenexer)

# [Zenexer](/Zenexer)/**[escapeshellrce.md](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36)**

Last active
January 6, 2025 14:32

Show Gist options

* [Download ZIP](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/archive/62094462fd9df18cf49fbffa25f5f2e8c9470084.zip)

* [Star
  49
  (49)](/login?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36)You must be signed in to star a gist
* [Fork
  10
  (10)](/login?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Zenexer/40d02da5e07f151adeaeeaa11af9ab36.js&quot;&gt;&lt;/script&gt;
* Save Zenexer/40d02da5e07f151adeaeeaa11af9ab36 to your computer and use it in GitHub Desktop.

[Code](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36)
[Revisions
23](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/revisions)
[Stars
49](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/stargazers)
[Forks
10](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Zenexer/40d02da5e07f151adeaeeaa11af9ab36.js&quot;&gt;&lt;/script&gt;

Save Zenexer/40d02da5e07f151adeaeeaa11af9ab36 to your computer and use it in GitHub Desktop.

[Download ZIP](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/archive/62094462fd9df18cf49fbffa25f5f2e8c9470084.zip)

Security Advisory: PHP's escapeshellcmd and escapeshellarg are insecure

 [Raw](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/raw/62094462fd9df18cf49fbffa25f5f2e8c9470084/escapeshellrce.md)

[**escapeshellrce.md**](#file-escapeshellrce-md)

Paul Buonopane paul@namepros.com at [NamePros](https://www.namepros.com/)

PGP: <https://keybase.io/zenexer>

*I'm working on cleaning up this advisory so that it's more informative at a glance. Suggestions are welcome.*

This advisory addresses the underlying PHP vulnerabilities behind Dawid Golunski's [CVE-2016-10033](https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html "Advisory from Dawid Golunski on CVE-2016-10033"), [CVE-2016-10045](https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html "Advisory from Dawid Golunski on CVE-2016-10045"), and [CVE-2016-10074](https://legalhackers.com/advisories/SwiftMailer-Exploit-Remote-Code-Exec-CVE-2016-10074-Vuln.html "Advisory from Dawid Golunski on CVE-2016-10074"). It assumes prior understanding of these vulnerabilities.

This advisory does not yet have associated CVE identifiers.

# Summary

1. It's impossible to write a universal shell escaping function, for a variety of reasons. However, PHP attempts to provide two shell escaping functions: escapeshellarg and escapeshellcmd.
2. escapeshellcmd undermines any prior sanitization. If escapeshellarg($input) would be sufficient in a given environment, escapeshellcmd(escapeshellarg($input)) voids any security guarantees. This is adequately demonstrated in the PoC for [CVE-2016-10045](https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html "Advisory from Dawid Golunski on CVE-2016-10045").
3. PHP uses escapeshellcmd internally. For example, $additional\_parameters in the mail function is passed through escapeshellcmd. This leads to the same vulnerability as #2, but it can happen even if escapeshellcmd never appears directly in an application's code. This makes it more difficult for developers to determine if their applications are vulnerable.

# Vulnerabilities

1. php\_escape\_shell\_cmd, the C function behind escapeshellcmd, is an "inherently dangerous function" because it can never fulfill the security guarantees it attempts to provide. This vulnerability specifically addresses PHP's own internal use of php\_escape\_shell\_cmd, not its exposure to PHP code via escapeshellcmd.
2. popen, exec, shell\_exec, system, passthru, proc\_open, and mail can potentially receive user input. A cautious developer would think to first sanitize this input before passing it to the affected functions. However, all of those functions are environment-dependent in such a way that sanitization cannot reasonably be performed. This would not be an issue if secure alternatives, such as pcntl\_exec, were universally available. (Additionally note that some PHP implementations, such as HHVM, don't offer pcntl\_fork/pcntl\_exec at all. That may seem out-of-scope, but those implementations rely on vanilla PHP for their design.)
3. escapeshellarg and escapeshellcmd don't properly sanitize input in the context of many Windows applications. [Here's why.](http://daviddeley.com/autohotkey/parameters/parameters.htm#WINPASS) This issue made [a previous appearance on bugs.php.net in 2009](https://bugs.php.net/bug.php?id=49446). This issue cannot be fully resolved by improving escapeshellarg because it is impossible to enumerate all possibilities. Any program has the freedom to introduce its own parsing rules.
4. escapeshellarg and escapeshellcmd may fail to properly sanitize input when a shell other than sh or bash is used. This issue (made a previous appearance on bugs.php.net in 2012](<https://bugs.php.net/bug.php?id=61706>). This issue cannot be fully resolved by improving escapeshellarg because it is infeasible to maintain rules for all possible shells.
5. escapeshellarg and escapeshellcmd assume that all encodings involved--particularly that of the shell--are ASCII-compatible. This is not always the case. Take EUC, for example, which is a stateful encoding. Stateful encodings in particular are likely to be mangled. Of all the vulnerabilities listed, I'm least certain of the current impact of this one; it could be vast or negligible.
6. escapeshellarg and escapeshellcmd do not and cannot reasonably provide the security that they attempt to guarantee. Unlike vuln 1, which handles PHP's own internal use of these functions, this vulnerability addresses the fact that PHP exposes these functions to developers writing PHP code. Developers use these functions expecting that they will provide bulletproof sanitization, when, in fact, they can't.

## CVE categorization

Numbered to match detailed descriptions above.

* CWE-242: Use of Inherently Dangerous Function
  + (1) php\_escape\_shell\_cmd is used internally by several PHP functions, and even more when safe\_mode is enabled. It can never fulfill the security promise it attempts to make.
* CWE-439: Behavioral Change in New Version or Environment
  + (2) popen, exec, shell\_exec, system, passthru, proc\_open, and mail cannot receive user input for at least one argument, as their behavior is environment-dependent, and escaping is infeasible. This would not be an issue if secure alternatives, such as pcntl\_exec, were universally available.
* CWE-75: Failure to Sanitize Special Elements into a Different Plane (Special Element Injection)
  + (3) escapeshellarg and escapeshellcmd fail to neutralize special elements in the context of many Windows applications.
  + (4) escapeshellarg and escapeshellcmd may fail to neutralize special elements in the context of shells other than sh and bash on POSIX platforms.
* CWE-838: Inappropriate Encoding for Output Context
  + (5) escapeshellarg and escapeshellcmd may behave incorrectly when the current encoding of PHP, the script, or the shell is not ASCII-compatible (e.g., stateful encodings).
* CWE-684: Incorrect Provision of Specified Functionality
  + (6) escapeshellarg and escapeshellcmd do not and cannot reasonably provide the security that they attempt to guarantee.

# Testing

As of writing, [this utility](https://gist.github.com/Zenexer/c123604d57914970ac297413751c3f21) provides an accurate representation of PHP's escapeshell functions on Linux and Windows. It was released hastily and isn't designed to be a long-term testing solution.

# Shell escaping

On Windows, the shell doesn't handle command line parsing; [the target program does](http://daviddeley.com/autohotkey/parameters/parameters.htm#WINPASS). Different technologies adhere to different algorithms when parsing arguments. As such, it's not possible to write a universal escape function that works on Windows.

On POSIX systems such as Linux, Mac, and BSD, the shell handles command line parsing. However, the user typically has control over the shells available on their system, and different distros often favor different shells. escapeshellarg and escapeshellcmd are designed for sh and bash; using them with other shells means that input may be improperly escaped. It's not reasonable to write a shell escape function that handles all possible shells.

On any platform, character encoding can play a part in how arguments are interpreted, particularly when non-ASCII-compatible encodings are used. This isn't likely to be an issue in regions that use Latin-based alphabets, but in other parts of the world, the current escape functions could have unpredictable results.

# Interim solution

Application developers will need to avoid using escapeshellarg and escapeshellcmd to sanitize user input. Even if input was already sanitized, once passed through those functions, it should be considered dirty. This makes certain parameters of certain built-in functions (e.g., $additional\_parameters of mail) incapable of securely handling user input securely.

Safe mode must be disabled.

PHP should not be run on Windows in production environments, or where input or code can be affected by third parties. Under no circumstances are escapeshellarg or escapeshellcmd remotely secure on Windows, and applications that rely on them for security will be vulnerable.

Developer should prefer pcntl\_fork + pcntl\_exec over alternatives that pass commands through the shell. Unfortunately, these functions aren't available in many environments, such as HHVM.

If shell escaping absolutely must be applied to user input, be sure to check that the shell and encoding are what you expect them to be. As a general rule, on POSIX, UTF-8 and sh/bash should be safe with escapeshellarg. On Windows, escaping will need to be customized for each executable.

escapeshellcmd should be considered inherently dangerous and shouldn't be used for escaping under any circumstances. Functions that use it internally, such as mail, will need to be handled with care.

## Sanitizing input for safe shell parsing

A proper utility will eventually land here: <https://github.com/Zenexer/safeshell>

In the meantime, the following code block is written by me and in the public domain, per [CC0](https://creativecommons.org/publicdomain/zero/1.0/). There's also a more advanced version combining the techniques in a separate file below, but it hasn't been thoroughly tested yet.

```
/**
 * Prevent attacks similar to CVE-2016-10033, CVE-2016-10045, and CVE-2016-10074
 * by disallowing potentially unsafe shell characters.
 *
 * @param   string  $string      the string to be tested for shell safety
 * @see     https://gist.github.com/Zenexer/40d02da5e07f151adeaeeaa11af9ab36
 * @author  Paul Buonopane <paul@namepros.com>
 * @license Public doman per CC0 1.0.  Attribution appreciated but not required.
 */
function isShellSafe($string)
{
    $string = strval($string);
    $length = strlen($string);

    // If you need to allow empty strings, you can remove this, but be sure you
    // understand the security implications of doing so.
    if (!$length) {
        return false;
    }

    // Method 1
    // Note: Results may be indeterminate with a stateful encodings, e.g. EUC
    for ($i = 0; $i < $length; $i++) {
        $c = $string[$i];
        if (!ctype_alnum($c) && strpos('@_-.', $c) === false) {
            return false;
        }
    }
    //return true;

    // Method 2
    // Note: Assumes UTF-8 encoding.  Conversion may be necessary.
    return (bool) preg_match('/\A[\pL\pN._@-]*\z/ui', $string);
}
```

# Long-term solution

PHP functions that rely on escapeshellcmd, such as mail, will need to be redesigned to take arrays of arguments and avoid using the shell.

PHP functions that rely on the shell, such as popen and exec, will need to be replaced with functions that take arrays of arguments and avoid using the shell (e.g., fork + execve). This behavior already exists in the form of pcntl\_fork + pcntl\_exec, but pcntl isn't as widely supported as popen and exec.

# Public disclosure

Before this document was published, it was clear that the probability of this information already being known by malicious parties was high. With an increased chance in widespread attacks following the attention CVE-2016-10033 and CVE-2016-10045, priority was placed on distributing the advisory as quickly and efficiently as possible.

# Affected projects

* CodeIgniter
* Drupal
* Joomla!
* PHPMailer
* Swift Mailer
* WordPress

 [Raw](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36/raw/62094462fd9df18cf49fbffa25f5f2e8c9470084/isshellsafe.php)

[**isshellsafe.php**](#file-isshellsafe-php)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | <?php |
| --- | --- |
|  | // This is a more advanced version of the function in the Markdown document |
|  | // at https://gist.github.com/Zenexer/40d02da5e07f151adeaeeaa11af9ab36. |
|  | // It hasn't been thoroughly tested yet and is still a work in progress. |
|  | // It may need modifications for compatibility in environments with certain |
|  | // charsets. Ultimately, this is a hacky workaround, not a fix, and it will |
|  | // never be perfect. |
|  |  |
|  | /\*\* |
|  | \* Prevent attacks similar to CVE-2016-10033 and CVE-2016-10045 by disallowing |
|  | \* potentially unsafe shell characters. |
|  | \* |
|  | \* Note that escapeshellarg and escapeshellcmd are inadequate for this purpose, |
|  | \* especially on Windows. Additionally, sanitization won't be sufficient for |
|  | \* strings that must pass through escapeshellcmd, which is used by many built-in |
|  | \* PHP functions, including mail(). This function will return true for strings |
|  | \* that will be safe in all but the most obscure environments. It does assume |
|  | \* that locale has been configured correctly, both in the shell and PHP, or that |
|  | \* an ASCII-compatible charset is in use, at the very least. |
|  | \* |
|  | \* This function may allow non-Latin characters in some locales. This should |
|  | \* not present a problem on a properly configured system, or even most |
|  | \* improperly configured systems. If you need to enforce 7-bit ASCII, set the |
|  | \* current language to "C". |
|  | \* |
|  | \* Designed for POSIX (Linux, Mac, BSD) and Windows. |
|  | \* |
|  | \* @param string $string the string to be tested for shell safety |
|  | \* @param boolean $emptyIsSafe whether empty strings are to be considered |
|  | \* safe; do not enable unless you know what you're |
|  | \* doing, as this can be exploited |
|  | \* @return boolean true if the string is guaranteed safe; otherwise, false |
|  | \* @throws \LogicException if the current locale behaves in such a way that |
|  | \* security cannot be guaranteed, if the programmer |
|  | \* does something unsafe, or if PHP lacks the necessary |
|  | \* functions to perform adequate checks |
|  | \* @uses \LogicException |
|  | \* |
|  | \* @see https://gist.github.com/Zenexer/40d02da5e07f151adeaeeaa11af9ab36 |
|  | \* Detailed discussion of the underlying issue and up-to-date code. |
|  | \* @author Paul Buonopane <paul@namepros.com> |
|  | \* CTO of NamePros |
|  | \* https://github.com/Zenexer |
|  | \* @license Public doman per CC0 1.0. Attribution appreciated but not required. |
|  | \* https://creativecommons.org/publicdomain/zero/1.0/ |
|  | \*/ |
|  | function isShellSafe($string, $emptyIsSafe = false) |
|  | { |
|  | static $safeSymbols = array('@' => true, '\_' => true, '-' => true, '.' => true); |
|  | static $safeRanges = null; |
|  | if (!isset($safeRanges)) { |
|  | $safeRanges = array( |
|  | array(ord('0'), ord('9')), |
|  | array(ord('A'), ord('Z')), |
|  | array(ord('a'), ord('z')), |
|  | ); |
|  | } |
|  |  |
|  | static $asciiCompatCharsets = array( |
|  | 'C', 'POSIX', 'ASCII', |
|  | 'UTF-8', 'utf8', |
|  | 'ISO-646', |
|  | 'ISO-8859', |
|  | // Note that EUC/ISO-2022 is NOT compatible. |
|  |  |
|  | // Western |
|  | 'ISO-8859-1', 'Latin-1', 'Windows-1252', // Western European |
|  | 'ISO-8859-2', 'Latin-2', 'Windows-28592', // Eastern European |
|  | 'ISO-8859-3', 'Latin-3', 'Windows-28593', // South European |
|  | 'ISO-8859-4', 'Latin-4', 'Windows-28594', // North European |
|  | 'ISO-8859-7', 'Windows-28597', // Greek |
|  | 'ISO-8859-10', 'Latin-6', // Nordic |
|  | 'ISO-8859-13', 'Latin-7', 'Windows-28603', // Baltic Rim |
|  | 'ISO-8859-14', 'Latin-8', // Celtic |
|  | 'ISO-8859-15', 'Latin-9', 'Windows-28605', // Western European |
|  | 'ISO-8859-16', 'Latin-10', // South-Eastern European |
|  |  |
|  |  |
|  | // Cyrillic |
|  | 'ISO-8859-5', 'Latin-5', 'Windows-28595', |
|  | 'Windows-1251', |
|  | 'KOI8-R', 'Windows-20866', |
|  | 'KOI8-U', 'Windows-21866', |
|  | 'KOI-7', 'KOI7', |
|  |  |
|  | // Middle Eastern |
|  | 'ISO-8859-6', 'Windows-28596', 'Windows-38596', // Arabic |
|  | 'ISO-8859-8', 'Windows-28598', 'Windows-38598', // Hebrew |
|  | 'ISO-8859-9', 'Windows-28599', // Turkish |
|  |  |
|  | // East/South Asian |
|  | 'ISO-8859-11', 'TIS-620', 'Windows-874', // Thai |
|  | 'Shift-JIS', 'SHIFT\_JIS', 'SJIS', // Japanese |
|  | 'Windows-936', 'CP1386', // Chinese |
|  | 'GB2312', // Chinese |
|  | ); |
|  |  |
|  | // Remove this if you've read the param description and are absolutely certain you know what you're doing. |
|  | if ($emptyIsSafe) { |
|  | throw new LogicException('Are you really sure you want to do that? Please read the param description before enabling $emptyIsSafe.'); |
|  | } |
|  | // End of disclaimer |
|  |  |
|  | $string = strval($string); |
|  | $length = strlen($string); |
|  |  |
|  | if (!$length) { |
|  | return $emptyIsSafe === true; |
|  | } |
|  |  |
|  | // Future-proof |
|  | if (escapeshellcmd($string) !== $string || !in\_array(escapeshellarg($string), array("'$string'", "\"$string\""))) { |
|  | return false; |
|  | } |
|  |  |
|  | // Decide on a method. You can reprioritize these. |
|  | static $method = null; |
|  | if (!isset($method)) { |
|  | if (function\_exists('preg\_match')) { |
|  | // Most versatile |
|  | $method = 'pcre'; |
|  | } elseif (function\_exists('ctype\_alnum')) { |
|  | // May not handle stateful encodings like EUC correctly |
|  | $method = 'ctype'; |
|  | } else { |
|  | // Fallback; require ASCII, ISO-8859, or UTF-8 |
|  | $method = 'invalid'; // We'll set it to 'binary' if our tests pass |
|  |  |
|  | $locale = null; |
|  | if (function\_exists('setlocale')) { |
|  | $locale = setlocale('LC\_CTYPE', 0); |
|  | if (!$locale) { |
|  | $locale = setlocale('LC\_ALL', 0); |
|  | } |
|  | } else { |
|  | if (!empty($\_ENV['LC\_CTYPE'])) { |
|  | $locale = $\_ENV['LC\_CTYPE']; |
|  | } elseif (!empty($\_ENV['LC\_ALL'])) { |
|  | $locale = $\_ENV['LC\_ALL']; |
|  | } elseif (!empty($\_ENV['LANG'])) { |
|  | $locale = $\_ENV['LANG']; |
|  | } |
|  | } |
|  |  |
|  | if (!$locale) { |
|  | throw new LogicException('Unable to determine current locale. Ideally, PHP should be compiled with ctype or PCRE to avoid this issue.'); |
|  | } |
|  |  |
|  | // $locale could be a string with multiple vars separated by |
|  | // semicolons. We're primarily interested in the earlier vars. |
|  | $tok = explode(';', $locale, 2); |
|  | $tok = explode('=', $tok[0], 2); |
|  | $locale = end($tok); |
|  |  |
|  | // Try to extract the charset |
|  | $tok = explode('.', $locale, 2); |
|  | $charset = end($tok); |
|  |  |
|  | if (!in\_array($charset, $asciiCompatCharsets)) { |
|  | throw new LogicException("Can't be certain that the current charset is ASCII-compatible. Ideally, PHP should be compiled with ctype or PCRE to avoid this issue."); |
|  | } |
|  |  |
|  | $method = 'binary'; |
|  | } |
|  | } |
|  |  |
|  | switch ($method) { |
|  | case 'pcre': |
|  | return (bool) preg\_match('/\A[\pL\pN.\_@-]+\z/ui', $string); |
|  |  |
|  | case 'ctype': |
|  | for ($i = 0; $i < $length; $i++) { |
|  | if (!ctype\_alnum($string[$i]) && !isset($safeSymbols[$string[$i]])) { |
|  | return false; |
|  | } |
|  | } |
|  | return true; |
|  |  |
|  | case 'binary': |
|  | for ($i = 0; $i < $length; $i++) { |
|  | if (isset($safeSymbols[$string[$i]])) { |
|  | continue; // Char is valid; next |
|  | } |
|  |  |
|  | $c = ord($string[$i]); |
|  | foreach ($safeRanges as $range) { |
|  | if ($c >= $range[0] && $c <= $range[1]) { |
|  | continue 2; // Char is value; next |
|  | } |
|  | } |
|  | return false; // Char is invalid |
|  | } |
|  | return true; // End of string, all chars were valid |
|  |  |
|  | case 'invalid': |
|  | throw new LogicException('Initialization previously failed'); |
|  |  |
|  | default: |
|  | throw new LogicException('Invalid method'); |
|  | } |
|  |  |
|  | throw new LogicException('Unknown control flow error'); |
|  | } |

[![@Llbe](https://avatars.githubusercontent.com/u/1220578?s=80&v=4)](/Llbe)

Copy link

### **[Llbe](/Llbe)** commented [Dec 28, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1958627#gistcomment-1958627)

Has the long-term solution been submitted to bugs.php.net? As a single bug or as several bugs.

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1958837#gistcomment-1958837) • edited Loading

[@Llbe](https://github.com/Llbe) Not that I know of. There are [related bugs](https://bugs.php.net/search.php?cmd=display&search_for=escapeshellarg&x=0&y=0), but their status doesn't look promising. They haven't seen any activity in years despite their severity. Specific examples:

* [escapeshellarg incompatibility with shells other than sh/bash](https://bugs.php.net/bug.php?id=61706)
* [escapeshellarg buggy locale handling](https://bugs.php.net/bug.php?id=54391)
* [escapeshellarg doesn't work on Windows](https://bugs.php.net/bug.php?id=49446)--this one is from 2009!
* ["Command injection is possible through escapeshellarg"](https://bugs.php.net/bug.php?id=65755)--marked private, yet more than 3 years old

It's worth noting that none of the above bug reports that I can view fully evaluate the severity of the issues they allude to. They have security "red flags" that most security experts will pick up on, but don't necessarily discuss the security impacts of the bugs.

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1958845#gistcomment-1958845)

Sent an email to security@php.net at 3:08 AM EST on 2016-12-29 pointing them to the CVEs and this page.

Sorry, something went wrong.

[![@ibakirov](https://avatars.githubusercontent.com/u/7983476?s=80&v=4)](/ibakirov)

Copy link

### **[ibakirov](/ibakirov)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1958911#gistcomment-1958911)

+1

Sorry, something went wrong.

[![@scara](https://avatars.githubusercontent.com/u/198356?s=80&v=4)](/scara)

Copy link

### **[scara](/scara)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1958966#gistcomment-1958966)

👍

Sorry, something went wrong.

[![@glensc](https://avatars.githubusercontent.com/u/199095?s=80&v=4)](/glensc)

Copy link

### **[glensc](/glensc)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1959054#gistcomment-1959054)

just throwing this in to prevent (possible) double work:

<https://github.com/johnstevenson/winbox-args>

Sorry, something went wrong.

[![@glensc](https://avatars.githubusercontent.com/u/199095?s=80&v=4)](/glensc)

Copy link

### **[glensc](/glensc)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1959055#gistcomment-1959055)

> ```
>        return (bool) preg_match('/\A[\pl\pn._@-]+\Z/ui', $string);
>
> ```

NOTE: something to consider: `pcre` could be compiled without unicode support (`/u` flag)

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Dec 29, 2016](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1959147#gistcomment-1959147)

[@glensc](https://github.com/glensc) Thanks, but from a quick glance, it looks like it's missing a few things. I haven't tested it, though.

Yes, I meant to add a check for that, but got distracted. It's also going to need mbstring to convert from the current charset to UTF-8, unfortunately.

Sorry, something went wrong.

[![@dg](https://avatars.githubusercontent.com/u/194960?s=80&v=4)](/dg)

Copy link

### **[dg](/dg)** commented [Jan 4, 2017](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1962565#gistcomment-1962565) • edited Loading

> preg\_match('/\A[\pl\pn.\_@-]\*\Z/ui', $string);

Regular expression is invalid. `\pl` and `\pn` are [not defined](http://php.net/manual/en/regexp.reference.unicode.php), there should be `\pL` and `\pN`.

It also matches `\n` at end of `$string`. Solution is to replace `\Z` with `\z`.

Thanks for a great explanation!

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Jan 15, 2017](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1971850#gistcomment-1971850)

[@dg](https://github.com/dg) Thanks, nice catch. I'll fix that later today.

Sorry, something went wrong.

Copy link

### **[ghost](/ghost)** commented [Jan 29, 2017](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1983069#gistcomment-1983069)

Hi, thank you for putting this information together - it's helpful.

I just wanted to mention that isshellsafe.php line 169 also needs the preg\_match changes as per [@dg](https://github.com/dg).

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Feb 12, 2017](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=1995381#gistcomment-1995381)

@bryyyon Thanks, fixed. Also fixed a typo in the license that might've led to misconceptions that I was expecting attribution.

Sorry, something went wrong.

[![@cooliscool](https://avatars.githubusercontent.com/u/8917560?s=80&v=4)](/cooliscool)

Copy link

### **[cooliscool](/cooliscool)** commented [Oct 22, 2022](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=4344268#gistcomment-4344268)

[@Zenexer](https://github.com/Zenexer) thanks for the advisory.

Curious to know the state of this in 2022 currently. Did PHP address the above issues ?

Sorry, something went wrong.

[![@aiso-net](https://avatars.githubusercontent.com/u/6230601?s=80&v=4)](/aiso-net)

Copy link

### **[aiso-net](/aiso-net)** commented [Jul 29, 2023](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=4645198#gistcomment-4645198)

Me too, what happened?

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Jul 31, 2023](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=4646832#gistcomment-4646832)

No. There’s no way that PHP can fix these issues. Anything that gets sent to the shell is subject to the whims of the shell. PHP can, at best, guess how to correctly escape, but there will always be vulnerabilities no matter what they do. These functions should really be deprecated.

Sorry, something went wrong.

[![@Rixafy](https://avatars.githubusercontent.com/u/45132928?s=80&v=4)](/Rixafy)

Copy link

### **[Rixafy](/Rixafy)** commented [Jul 6, 2024](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=5113283#gistcomment-5113283)

[@Zenexer](https://github.com/Zenexer) is this safe on linux (simple replace)? <https://markushedlund.com/dev/php-escapeshellarg-with-unicodeutf-8-support/>

I'm figuring out the issue when users have files/directories in multiple encodings and I need to use that file path in exec functions (calculating directory sizes, removing directory etc.), because I'm working on a file manager.

When listing files in linux I'm getting this output

```
'Škoda UTF-8'
''$'\251''koda ISO 8859-2'
''$'\212''koda windows-1250'

```

So that means I could encode names like linux does (maybe convmv?) but PHP doesn't have such function and I want to avoid another exec. I'm just curious, why is escapeshellarg not binary-safe, is it because it can be escaped?

This was discussed here, but there isn't anything useful

<https://bugs.php.net/bug.php?id=54391>

Sorry, something went wrong.

[![@Rixafy](https://avatars.githubusercontent.com/u/45132928?s=80&v=4)](/Rixafy)

Copy link

### **[Rixafy](/Rixafy)** commented [Jul 6, 2024](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=5113293#gistcomment-5113293)

Looks like it can be byassed.. I guess this is the reason it's not binary-safe.

<https://sektioneins.de/en/advisories/advisory-032008-php-multibyte-shell-command-escaping-bypass-vulnerability.html>

```
[2] escapeshellarg()

   escapeshellarg() does not use the backslash character to escape
   shell meta characters. Instead it places the argument in single
   quotes and only escapes single quotes in the qrgument with the
   string '\'' . Because of this it is not possible to use the same
   trick. However in case there are multiple inputs it is possible
   to "eat" the terminating single quote which results in a shell
   command injection through the second argument.

   Example:
      $arg1 = chr(0xc0);
      $arg2 = "; id ; #";
      $cmd = "echo ".escapeshellarg($arg1)." ".escapeshellarg($arg2);

   In this example the 0xC0 character forms a multibyte character
   with the terminating single quote. Therefore the starting single
   quote of $arg2 will be used as terminating single quote and the
   content of $arg2 can be used to inject everything.

   NOTE: This attack works because even invalid second byte characters
         are accepted on several platforms as valid.

```

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Jul 16, 2024](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=5123569#gistcomment-5123569)

[@Rixafy](https://github.com/Rixafy) There's no safe solution that relies on the shell. You would need to use `pcntl_exec` and bypass the shell completely.

Sorry, something went wrong.

[![@Rixafy](https://avatars.githubusercontent.com/u/45132928?s=80&v=4)](/Rixafy)

Copy link

### **[Rixafy](/Rixafy)** commented [Aug 25, 2024](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=5166718#gistcomment-5166718)

Interesting, do you have some example input that could bypass `exec('ls ' . escapeshellarg($directory))`? We are using it a lot in our code to speed up processes (chmod, chown, copy), because it takes 3x longer via native php functions.

I looked at `pcntl_exec`, and it looks messy, even reading an output and exit code is done using `ob_` functions, I'm considering switching to symfony/process, <https://symfony.com/doc/current/components/process.html>, it looks awesome.

Sorry, something went wrong.

[![@Zenexer](https://avatars.githubusercontent.com/u/504130?s=80&v=4)](/Zenexer)

Copy link

Author

### **[Zenexer](/Zenexer)** commented [Oct 11, 2024](/Zenexer/40d02da5e07f151adeaeeaa11af9ab36?permalink_comment_id=5231433#gistcomment-5231433)

[@Rixafy](https://github.com/Rixafy) If `$directory` is untrusted, it doesn't matter whether you use `pcntl_exec` or `exec`--either way, it's vulnerable. You would need to pass `--` as the first argument to `ls` to make it *slightly* more robust.

If `$directory` is trusted/hardcoded, you don't need to worry too much, although it's still a good practice to pass `--` as the first argument.

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FZenexer%2F40d02da5e07f151adeaeeaa11af9ab36)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


