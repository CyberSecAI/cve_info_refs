=== Content from trac.webkit.org_b237b635_20250125_121840.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/209294/webkit "Changeset 209294")
* [Next Changeset](/changeset/209296/webkit "Changeset 209296") →

---

# Changeset 209295 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Dec 2, 2016, 10:40:37 PM
([8 years](/timeline?from=2016-12-02T22%3A40%3A37-08%3A00&precision=second "See timeline at Dec 2, 2016, 10:40:37 PM") ago)
Author:
keith\_miller@apple.com
Message:

[JSC] add additional bit to JSTokenType bitfield

[​https://bugs.webkit.org/show\_bug.cgi?id=165091](https://bugs.webkit.org/show_bug.cgi?id=165091)

Patch by Caitlin Potter <​caitp@igalia.com> on 2016-12-02

Reviewed by Geoffrey Garen.

JSTests:

* stress/bug-165091.js: Added.

(shouldThrowSyntaxError):

Source/JavaScriptCore:

Avoid overflow which causes keyword tokens to be treated as unary

tokens now that "async" is tokenized as a keyword, by granting an

additional 64 bits to be occupied by token IDs.

* parser/ParserTokens.h:

Location:
[trunk](/browser/webkit/trunk?rev=209295)
Files:

2 added
5 edited

* [JSTests/ChangeLog](/browser/webkit/trunk/JSTests/ChangeLog?rev=209295 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [JSTests/wasm/function-tests/nearest.js](/browser/webkit/trunk/JSTests/wasm/function-tests/nearest.js?rev=209295 "Show entry in browser")
  (added)
* [JSTests/wasm/function-tests/trunc.js](/browser/webkit/trunk/JSTests/wasm/function-tests/trunc.js?rev=209295 "Show entry in browser")
  (added)
* [Source/JavaScriptCore/ChangeLog](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=209295 "Show entry in browser")
  (modified)
  ([1 diff](#file3 "Show differences"))
* [Source/JavaScriptCore/assembler/MacroAssemblerARM64.h](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h?rev=209295 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h?rev=209295 "Show entry in browser")
  (modified)
  ([1 diff](#file5 "Show differences"))
* [Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp](/browser/webkit/trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp?rev=209295 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/JSTests/ChangeLog](/changeset/209295/webkit/trunk/JSTests/ChangeLog "Show the changeset 209295 restricted to trunk/JSTests/ChangeLog")

  | [r209293](/browser/webkit/trunk/JSTests/ChangeLog?rev=209293#L24 "Show revision 209293 of this file in browser") | [r209295](/browser/webkit/trunk/JSTests/ChangeLog?rev=209295#L24 "Show revision 209295 of this file in browser") |  |
  | --- | --- | --- |
  | 24 | 24 | "Unreviewed, forgot to change instruction after renaming." |
  | 25 | 25 | http://trac.webkit.org/changeset/209276 |
  |  | 26 |  |
  |  | 27 | 2016-12-02  Keith Miller  <keith\_miller@apple.com> |
  |  | 28 |  |
  |  | 29 | Add Wasm floating point nearest and trunc |
  |  | 30 | https://bugs.webkit.org/show\_bug.cgi?id=165339 |
  |  | 31 |  |
  |  | 32 | Reviewed by Saam Barati. |
  |  | 33 |  |
  |  | 34 | \* wasm/function-tests/nearest.js: Added. |
  |  | 35 | \* wasm/function-tests/trunc.js: Added. |
  | 26 | 36 |  |
  | 27 | 37 | 2016-12-02  Keith Miller  <keith\_miller@apple.com> |
* ## [trunk/Source/JavaScriptCore/ChangeLog](/changeset/209295/webkit/trunk/Source/JavaScriptCore/ChangeLog "Show the changeset 209295 restricted to trunk/Source/JavaScriptCore/ChangeLog")

  | [r209293](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=209293#L48 "Show revision 209293 of this file in browser") | [r209295](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=209295#L48 "Show revision 209295 of this file in browser") |  |
  | --- | --- | --- |
  | 48 | 48 | "Unreviewed, forgot to change instruction after renaming." |
  | 49 | 49 | http://trac.webkit.org/changeset/209276 |
  |  | 50 |  |
  |  | 51 | 2016-12-02  Keith Miller  <keith\_miller@apple.com> |
  |  | 52 |  |
  |  | 53 | Add Wasm floating point nearest and trunc |
  |  | 54 | https://bugs.webkit.org/show\_bug.cgi?id=165339 |
  |  | 55 |  |
  |  | 56 | Reviewed by Saam Barati. |
  |  | 57 |  |
  |  | 58 | This patch also allows any wasm primitive type to be passed as a |
  |  | 59 | string. |
  |  | 60 |  |
  |  | 61 | \* assembler/MacroAssemblerARM64.h: |
  |  | 62 | (JSC::MacroAssemblerARM64::nearestIntDouble): |
  |  | 63 | (JSC::MacroAssemblerARM64::nearestIntFloat): |
  |  | 64 | (JSC::MacroAssemblerARM64::truncDouble): |
  |  | 65 | (JSC::MacroAssemblerARM64::truncFloat): |
  |  | 66 | \* assembler/MacroAssemblerX86Common.h: |
  |  | 67 | (JSC::MacroAssemblerX86Common::nearestIntDouble): |
  |  | 68 | (JSC::MacroAssemblerX86Common::nearestIntFloat): |
  |  | 69 | \* jsc.cpp: |
  |  | 70 | (box): |
  |  | 71 | \* wasm/WasmB3IRGenerator.cpp: |
  |  | 72 | (JSC::Wasm::B3IRGenerator::addOp<F64ConvertUI64>): |
  |  | 73 | (JSC::Wasm::B3IRGenerator::addOp<OpType::F32ConvertUI64>): |
  |  | 74 | (JSC::Wasm::B3IRGenerator::addOp<OpType::F64Nearest>): |
  |  | 75 | (JSC::Wasm::B3IRGenerator::addOp<OpType::F32Nearest>): |
  |  | 76 | (JSC::Wasm::B3IRGenerator::addOp<OpType::F64Trunc>): |
  |  | 77 | (JSC::Wasm::B3IRGenerator::addOp<OpType::F32Trunc>): |
  |  | 78 | \* wasm/WasmFunctionParser.h: |
  |  | 79 | (JSC::Wasm::FunctionParser<Context>::parseExpression): |
  | 50 | 80 |  |
  | 51 | 81 | 2016-12-02  Keith Miller  <keith\_miller@apple.com> |
* ## [trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h](/changeset/209295/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h "Show the changeset 209295 restricted to trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h")

  | [r209283](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h?rev=209283#L1561 "Show revision 209283 of this file in browser") | [r209295](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h?rev=209295#L1561 "Show revision 209295 of this file in browser") |  |
  | --- | --- | --- |
  | 1561 | 1561 | } |
  | 1562 | 1562 |  |
  |  | 1563 | void roundTowardNearestIntDouble(FPRegisterID src, FPRegisterID dest) |
  |  | 1564 | { |
  |  | 1565 | m\_assembler.frintn<64>(dest, src); |
  |  | 1566 | } |
  |  | 1567 |  |
  |  | 1568 | void roundTowardNearestIntFloat(FPRegisterID src, FPRegisterID dest) |
  |  | 1569 | { |
  |  | 1570 | m\_assembler.frintn<32>(dest, src); |
  |  | 1571 | } |
  |  | 1572 |  |
  | 1563 | 1573 | void roundTowardZeroDouble(FPRegisterID src, FPRegisterID dest) |
  | 1564 | 1574 | { |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h?rev=209283#L1570) | […](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerARM64.h?rev=209295#L1580) |  |
  | 1570 | 1580 | m\_assembler.frintz<32>(dest, src); |
  | 1571 | 1581 | } |
  |  | 1582 |  |
  | 1572 | 1583 |  |
  | 1573 | 1584 | // Convert 'src' to an integer, and places the resulting 'dest'. |
* ## [trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h](/changeset/209295/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h "Show the changeset 209295 restricted to trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h")

  | [r209283](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h?rev=209283#L796 "Show revision 209283 of this file in browser") | [r209295](/browser/webkit/trunk/Source/JavaScriptCore/assembler/MacroAssemblerX86Common.h?rev=209295#L796 "Show revision 209295 of this file in browser") |  |
  | --- | --- | --- |
  | 796 | 796 | { |
  | 797 | 797 | m\_assembler.roundss\_mr(src.offset, src.base, dst, X86Assembler::RoundingType::TowardNegativeInfiniti); |
  |  | 798 | } |
  |  | 799 |  |
  |  | 800 | void roundTowardNearestIntDouble(FPRegisterID src, FPRegisterID dst) |
  |  | 801 | { |
  |  | 802 | m\_assembler.roundsd\_rr(src, dst, X86Assembler::RoundingType::ToNearestWithTiesToEven); |
  |  | 803 | } |
  |  | 804 |  |
  |  | 805 | void roundTowardNearestIntFloat(FPRegisterID src, FPRegisterID dst) |
  |  | 806 | { |
  |  | 807 | m\_assembler.roundss\_rr(src, dst, X86Assembler::RoundingType::ToNearestWithTiesToEven); |
  | 798 | 808 | } |
  | 799 | 809 |  |
* ## [trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp](/changeset/209295/webkit/trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp "Show the changeset 209295 restricted to trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp")

  | [r209283](/browser/webkit/trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp?rev=209283#L784 "Show revision 209283 of this file in browser") | [r209295](/browser/webkit/trunk/Source/JavaScriptCore/wasm/WasmB3IRGenerator.cpp?rev=209295#L784 "Show revision 209295 of this file in browser") |  |
  | --- | --- | --- |
  | 784 | 784 | } |
  | 785 | 785 |  |
  |  | 786 | template<> |
  |  | 787 | bool B3IRGenerator::addOp<OpType::F64Nearest>(ExpressionType arg, ExpressionType& result) |
  |  | 788 | { |
  |  | 789 | PatchpointValue\* patchpoint = m\_currentBlock->appendNew<PatchpointValue>(m\_proc, Double, Origin()); |
  |  | 790 | patchpoint->append(arg, ValueRep::SomeRegister); |
  |  | 791 | patchpoint->setGenerator([=] (CCallHelpers& jit, const StackmapGenerationParams& params) { |
  |  | 792 | jit.roundTowardNearestIntDouble(params[1].fpr(), params[0].fpr()); |
  |  | 793 | }); |
  |  | 794 | patchpoint->effects = Effects::none(); |
  |  | 795 | result = patchpoint; |
  |  | 796 | return true; |
  |  | 797 | } |
  |  | 798 |  |
  |  | 799 | template<> |
  |  | 800 | bool B3IRGenerator::addOp<OpType::F32Nearest>(ExpressionType arg, ExpressionType& result) |
  |  | 801 | { |
  |  | 802 | PatchpointValue\* patchpoint = m\_currentBlock->appendNew<PatchpointValue>(m\_proc, Float, Origin()); |
  |  | 803 | patchpoint->append(arg, ValueRep::SomeRegister); |
  |  | 804 | patchpoint->setGenerator([=] (CCallHelpers& jit, const StackmapGenerationParams& params) { |
  |  | 805 | jit.roundTowardNearestIntFloat(params[1].fpr(), params[0].fpr()); |
  |  | 806 | }); |
  |  | 807 | patchpoint->effects = Effects::none(); |
  |  | 808 | result = patchpoint; |
  |  | 809 | return true; |
  |  | 810 | } |
  |  | 811 |  |
  |  | 812 | template<> |
  |  | 813 | bool B3IRGenerator::addOp<OpType::F64Trunc>(ExpressionType arg, ExpressionType& result) |
  |  | 814 | { |
  |  | 815 | PatchpointValue\* patchpoint = m\_currentBlock->appendNew<PatchpointValue>(m\_proc, Double, Origin()); |
  |  | 816 | patchpoint->append(arg, ValueRep::SomeRegister); |
  |  | 817 | patchpoint->setGenerator([=] (CCallHelpers& jit, const StackmapGenerationParams& params) { |
  |  | 818 | jit.roundTowardZeroDouble(params[1].fpr(), params[0].fpr()); |
  |  | 819 | }); |
  |  | 820 | patchpoint->effects = Effects::none(); |
  |  | 821 | result = patchpoint; |
  |  | 822 | return true; |
  |  | 823 | } |
  |  | 824 |  |
  |  | 825 | template<> |
  |  | 826 | bool B3IRGenerator::addOp<OpType::F32Trunc>(ExpressionType arg, ExpressionType& result) |
  |  | 827 | { |
  |  | 828 | PatchpointValue\* patchpoint = m\_currentBlock->appendNew<PatchpointValue>(m\_proc, Float, Origin()); |
  |  | 829 | patchpoint->append(arg, ValueRep::SomeRegister); |
  |  | 830 | patchpoint->setGenerator([=] (CCallHelpers& jit, const StackmapGenerationParams& params) { |
  |  | 831 | jit.roundTowardZeroFloat(params[1].fpr(), params[0].fpr()); |
  |  | 832 | }); |
  |  | 833 | patchpoint->effects = Effects::none(); |
  |  | 834 | result = patchpoint; |
  |  | 835 | return true; |
  |  | 836 | } |
  |  | 837 |  |
  | 786 | 838 | } } // namespace JSC::Wasm |
  | 787 | 839 |  |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=209295)
* [Zip Archive](?format=zip&new=209295)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)



=== Content from bugs.webkit.org_f2c91cfd_20250125_121838.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=165091&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[165091](show_bug.cgi?id=165091)

REGRESSION: Reproducible crash in operatorString() on invalid code with async
```
https://bugs.webkit.org/show_bug.cgi?id=165091
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
REGRESSION: Reproducible crash in operatorString() on invalid code with async

Kamil Frankowicz

[Reported](show_bug.cgi?id=165091#c0)
2016-11-28 09:49:30 PST

Created [attachment 295490](attachment.cgi?id=295490 "POC to trigger out of bounds read (jsc)") [[details]](attachment.cgi?id=295490&action=edit "POC to trigger out of bounds read (jsc)")
POC to trigger out of bounds read (jsc)
Affected SVN revision: 208970
To reproduce the problem:
./jsc jsc\_operator\_string\_segfault.js
ASAN Output:
==27690==ERROR: AddressSanitizer: SEGV on unknown address 0x0000977537dd (pc 0x7ff9b41478f7 bp 0x7fff076ec010 sp 0x7fff076eb220 T0)
==27690==The signal is caused by a READ memory access.
#0 0x7ff9b41478f6 in WTFCrash XYZ/WebKit/Source/WTF/wtf/Assertions.cpp:322:5
#1 0x7ff9b2f9e230 in JSC::operatorString(bool, unsigned int) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:4625:5
#2 0x7ff9b2f9e230 in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseUnaryExpression<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:4675
#3 0x7ff9b2f9e230 in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseBinaryExpression<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:3658
#4 0x7ff9b2f9e230 in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseConditionalExpression<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:3614
#5 0x7ff9b2f9e230 in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseAssignmentExpression<JSC::ASTBuilder>(JSC::ASTBuilder&, JSC::Parser<JSC::Lexer<unsigned char> >::ExpressionErrorClassifier&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:3454
#6 0x7ff9b2ea0cae in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseAssignmentExpression<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:3423:12
#7 0x7ff9b2ea0cae in JSC::ASTBuilder::Expression JSC::Parser<JSC::Lexer<unsigned char> >::parseExpression<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:3385
#8 0x7ff9b301081b in JSC::ASTBuilder::Statement JSC::Parser<JSC::Lexer<unsigned char> >::parseExpressionStatement<JSC::ASTBuilder>(JSC::ASTBuilder&) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:2883:33
#9 0x7ff9b2fe070a in JSC::ASTBuilder::Statement JSC::Parser<JSC::Lexer<unsigned char> >::parseStatement<JSC::ASTBuilder>(JSC::ASTBuilder&, JSC::Identifier const\*&, unsigned int\*) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:1806:39
#10 0x7ff9b2fc3ed6 in JSC::ASTBuilder::Statement JSC::Parser<JSC::Lexer<unsigned char> >::parseStatementListItem<JSC::ASTBuilder>(JSC::ASTBuilder&, JSC::Identifier const\*&, unsigned int\*) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:669:18
#11 0x7ff9b2e083d2 in JSC::ASTBuilder::SourceElements JSC::Parser<JSC::Lexer<unsigned char> >::parseSourceElements<JSC::ASTBuilder>(JSC::ASTBuilder&, JSC::SourceElementsMode) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:410:38
#12 0x7ff9b2df5391 in JSC::Parser<JSC::Lexer<unsigned char> >::parseInner(JSC::Identifier const&, JSC::SourceParseMode) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.cpp:295:30
#13 0x7ff9afddeb20 in std::unique\_ptr<JSC::ProgramNode, std::default\_delete<JSC::ProgramNode> > JSC::Parser<JSC::Lexer<unsigned char> >::parse<JSC::ProgramNode>(JSC::ParserError&, JSC::Identifier const&, JSC::SourceParseMode) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.h:1796:25
#14 0x7ff9afdde2fc in std::unique\_ptr<JSC::ProgramNode, std::default\_delete<JSC::ProgramNode> > JSC::parse<JSC::ProgramNode>(JSC::VM\*, JSC::SourceCode const&, JSC::Identifier const&, JSC::JSParserBuiltinMode, JSC::JSParserStrictMode, JSC::JSParserScriptMode, JSC::SourceParseMode, JSC::SuperBinding, JSC::ParserError&, JSC::JSTextPosition\*, JSC::ConstructorKind, JSC::DerivedContextType, JSC::EvalContextType, JSC::DebuggerParseData\*) XYZ/WebKit/Source/JavaScriptCore/parser/Parser.h:1885:53
#15 0x7ff9b32b1937 in JSC::UnlinkedProgramCodeBlock\* JSC::generateUnlinkedCodeBlock<JSC::UnlinkedProgramCodeBlock, JSC::ProgramExecutable>(JSC::VM&, JSC::ProgramExecutable\*, JSC::SourceCode const&, JSC::JSParserStrictMode, JSC::JSParserScriptMode, JSC::DebuggerMode, JSC::ParserError&, JSC::EvalContextType, JSC::VariableEnvironment const\*) XYZ/WebKit/Source/JavaScriptCore/runtime/CodeCache.h:235:42
#16 0x7ff9b32a76d3 in JSC::UnlinkedProgramCodeBlock\* JSC::CodeCache::getUnlinkedGlobalCodeBlock<JSC::UnlinkedProgramCodeBlock, JSC::ProgramExecutable>(JSC::VM&, JSC::ProgramExecutable\*, JSC::SourceCode const&, JSC::JSParserStrictMode, JSC::JSParserScriptMode, JSC::DebuggerMode, JSC::ParserError&, JSC::EvalContextType) XYZ/WebKit/Source/JavaScriptCore/runtime/CodeCache.cpp:75:48
#17 0x7ff9b32a381f in JSC::CodeCache::getUnlinkedProgramCodeBlock(JSC::VM&, JSC::ProgramExecutable\*, JSC::SourceCode const&, JSC::JSParserStrictMode, JSC::DebuggerMode, JSC::ParserError&) XYZ/WebKit/Source/JavaScriptCore/runtime/CodeCache.cpp:85:12
#18 0x7ff9b3699f25 in JSC::JSGlobalObject::createProgramCodeBlock(JSC::ExecState\*, JSC::ProgramExecutable\*, JSC::JSObject\*\*) XYZ/WebKit/Source/JavaScriptCore/runtime/JSGlobalObject.cpp:1336:69
#19 0x7ff9b3b15a33 in JSC::ProgramExecutable::initializeGlobalProperties(JSC::VM&, JSC::ExecState\*, JSC::JSScope\*) XYZ/WebKit/Source/JavaScriptCore/runtime/ProgramExecutable.cpp:83:65
#20 0x7ff9b2814431 in JSC::Interpreter::execute(JSC::ProgramExecutable\*, JSC::ExecState\*, JSC::JSObject\*) XYZ/WebKit/Source/JavaScriptCore/interpreter/Interpreter.cpp:874:36
#21 0x7ff9b34234e5 in JSC::evaluate(JSC::ExecState\*, JSC::SourceCode const&, JSC::JSValue, WTF::NakedPtr<JSC::Exception>&) XYZ/WebKit/Source/JavaScriptCore/runtime/Completion.cpp:110:43
#22 0x4feada in runWithScripts(GlobalObject\*, WTF::Vector<Script, 0ul, WTF::CrashOnOverflow, 16ul> const&, WTF::String const&, bool, bool, bool) XYZ/WebKit/Source/JavaScriptCore/jsc.cpp:2825:35
#23 0x4feada in runJSC(JSC::VM\*, CommandLine) XYZ/WebKit/Source/JavaScriptCore/jsc.cpp:3102
#24 0x4fa755 in jscmain(int, char\*\*) XYZ/WebKit/Source/JavaScriptCore/jsc.cpp:3154:14
#25 0x4fa389 in main XYZ/WebKit/Source/JavaScriptCore/jsc.cpp:2672:15
#26 0x7ff9ac57e82f in \_\_libc\_start\_main (/lib/x86\_64-linux-gnu/libc.so.6+0x2082f)
#27 0x4249a8 in \_start (/home/kamil/Fuzzing/webkit\_jsc\_240616/jsc+0x4249a8)
AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV XYZ/WebKit/Source/WTF/wtf/Assertions.cpp:322:5 in WTFCrash
==27690==ABORTING
Regards,
Kamil Frankowicz

| Attachments | | |
| --- | --- | --- |
| [**POC to trigger out of bounds read (jsc)**](attachment.cgi?id=295490 "View the content of the attachment") (10 bytes, application/javascript)  [2016-11-28 09:49 PST](#attach_295490 "Go to the comment associated with the attachment"), Kamil Frankowicz | *no flags* | [Details](attachment.cgi?id=295490&action=edit) |
| [**Patch**](attachment.cgi?id=295961 "View the content of the attachment") (3.45 KB, patch)  [2016-12-02 10:41 PST](#attach_295961 "Go to the comment associated with the attachment"), Caitlin Potter (:caitp) | *no flags* | [Details](attachment.cgi?id=295961&action=edit)[Formatted Diff](attachment.cgi?id=295961&action=prettypatch)[Diff](attachment.cgi?id=295961&action=diff) |
| [**Patch**](attachment.cgi?id=296053 "View the content of the attachment") (1021.86 KB, patch)  [2016-12-03 10:29 PST](#attach_296053 "Go to the comment associated with the attachment"), Caitlin Potter (:caitp) | *no flags* | [Details](attachment.cgi?id=296053&action=edit)[Formatted Diff](attachment.cgi?id=296053&action=prettypatch)[Diff](attachment.cgi?id=296053&action=diff) |
| [**Patch for relanding**](attachment.cgi?id=296137 "View the content of the attachment") (3.27 KB, patch)  [2016-12-05 07:22 PST](#attach_296137 "Go to the comment associated with the attachment"), Caitlin Potter (:caitp) | *no flags* | [Details](attachment.cgi?id=296137&action=edit)[Formatted Diff](attachment.cgi?id=296137&action=prettypatch)[Diff](attachment.cgi?id=296137&action=diff) |
| [**Patch for landing**](attachment.cgi?id=296184 "View the content of the attachment") (3.21 KB, patch)  [2016-12-05 13:27 PST](#attach_296184 "Go to the comment associated with the attachment"), Caitlin Potter (:caitp) | *no flags* | [Details](attachment.cgi?id=296184&action=edit)[Formatted Diff](attachment.cgi?id=296184&action=prettypatch)[Diff](attachment.cgi?id=296184&action=diff) |
| [**Fix of test failure.**](attachment.cgi?id=296186 "View the content of the attachment") (3.22 KB, patch)  [2016-12-05 13:53 PST](#attach_296186 "Go to the comment associated with the attachment"), Caitlin Potter (:caitp) | *no flags* | [Details](attachment.cgi?id=296186&action=edit)[Formatted Diff](attachment.cgi?id=296186&action=prettypatch)[Diff](attachment.cgi?id=296186&action=diff) |
| [Show Obsolete](#a0) (3) [View All](attachment.cgi?bugid=165091&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=165091&action=enter) *proposed patch, testcase, etc.* | | |

Alexey Proskuryakov

[Comment 1](show_bug.cgi?id=165091#c1)
2016-12-01 11:10:39 PST

There are multiple issues here:
1. A release mode assertion that gets triggered for this script due to a parser bug.
This reproduces in Safari without ASan, and is a regression in trunk.
2. The port you are using has an issue that causes invalid memory access when trying to cleanly crash.
Let's track #1 in this bug, as it's a more generic issue.

Radar WebKit Bug Importer

[Comment 2](show_bug.cgi?id=165091#c2)
2016-12-01 12:07:35 PST

<rdar://problem/29464028>

Caitlin Potter (:caitp)

[Comment 3](show_bug.cgi?id=165091#c3)
2016-12-02 10:01:42 PST

Looks like a simple enough fix. Shouldn't -Wswitch-enum have caught this before landing?

Caitlin Potter (:caitp)

[Comment 4](show_bug.cgi?id=165091#c4)
2016-12-02 10:12:53 PST

Can we move the UnaryOp flag up to 256? Otherwise, there are too many "keyword" tokens.

Caitlin Potter (:caitp)

[Comment 5](show_bug.cgi?id=165091#c5)
2016-12-02 10:26:34 PST

The token flags right now are something like this:
R = right-associative bit
T = unterminated error flag
E = error flag
I = binary operator allows 'in'
P = binary operator precedence
K = keyword flag
U = unary operator flag
0b000000000RTEIIIIIIIIPPPPKUXXXXXX
Since the bitfield is 32bits to begin with, do we lose much by allowing 127 keyword / unary op tokens?

Caitlin Potter (:caitp)

[Comment 6](show_bug.cgi?id=165091#c6)
2016-12-02 10:41:17 PST

Created [attachment 295961](attachment.cgi?id=295961&action=diff "Patch") [[details]](attachment.cgi?id=295961&action=edit "Patch")
Patch

Caitlin Potter (:caitp)

[Comment 7](show_bug.cgi?id=165091#c7)
2016-12-02 11:33:12 PST

If we don't want to land this, we can roll out <https://trac.webkit.org/changeset/208933>, but I don't think landing this should hurt anything

Geoffrey Garen

[Comment 8](show_bug.cgi?id=165091#c8)
2016-12-02 11:37:34 PST

Comment on [attachment 295961](attachment.cgi?id=295961&action=diff "Patch") [[details]](attachment.cgi?id=295961&action=edit "Patch")
Patch
Is the invariant here that the max JSTokenType needs to be < UnaryOpTokenFlag? If so, can you add a static\_assert or regular ASSERT to that effect?

Caitlin Potter (:caitp)

[Comment 9](show_bug.cgi?id=165091#c9)
2016-12-02 11:50:56 PST

(In reply to [comment #8](show_bug.cgi?id=165091#c8))
> Comment on [attachment 295961](attachment.cgi?id=295961&action=diff "Patch") [[details]](attachment.cgi?id=295961&action=edit "Patch")
> Patch
>
> Is the invariant here that the max JSTokenType needs to be <
> UnaryOpTokenFlag? If so, can you add a static\_assert or regular ASSERT to
> that effect?
there isn't really an invariant like that, as many of the JSTokenType enum values explicitly include the UnaryOpTokenFlag, binary precedence flags, or otherwise.
Also, FYI, this bug reproduces with some other tokens on trunk, there are about 5 keyword tokens which wrap past the UnaryOpTokenFlag. I'm not sure what all of them are on the last STP (or Safari 9, if any), but in trunk, <https://jsfiddle.net/rc8qL6m3/> crashes the tab in the same way.
So, giving the extra bit should solve multiple problems there.

WebKit Commit Bot

[Comment 10](show_bug.cgi?id=165091#c10)
2016-12-02 19:40:05 PST

Comment on [attachment 295961](attachment.cgi?id=295961&action=diff "Patch") [[details]](attachment.cgi?id=295961&action=edit "Patch")
Patch
Clearing flags on attachment: 295961
Committed [r209293](https://commits.webkit.org/r209293): <<http://trac.webkit.org/changeset/209293>>

WebKit Commit Bot

[Comment 11](show_bug.cgi?id=165091#c11)
2016-12-02 19:40:09 PST

All reviewed patches have been landed. Closing bug.

Caitlin Potter (:caitp)

[Comment 12](show_bug.cgi?id=165091#c12)
2016-12-02 19:49:06 PST

uppp, really should have fixed the wording in that ChangeLog. There's no extra "64 bits". If the message confuses anyone, hopefully they find this comment.

Keith Miller

[Comment 13](show_bug.cgi?id=165091#c13)
2016-12-02 22:41:02 PST

Committed [r209295](https://commits.webkit.org/r209295): <<http://trac.webkit.org/changeset/209295>>

Keith Miller

[Comment 14](show_bug.cgi?id=165091#c14)
2016-12-03 08:34:23 PST

Git freaked out and I accidentally committed with this patches changelog at the top. I fix that in <https://trac.webkit.org/changeset/209296>. It also looks like this patch's test fails on the bots though (<https://build.webkit.org/builders/Apple%20El%20Capitan%20Release%20JSC%20%28Tests%29/builds/10867/steps/jscore-test/logs/stdio>)

Caitlin Potter (:caitp)

[Comment 15](show_bug.cgi?id=165091#c15)
2016-12-03 09:00:50 PST

I'll take a look at that today when I get some time.

Caitlin Potter (:caitp)

[Comment 16](show_bug.cgi?id=165091#c16)
2016-12-03 10:29:38 PST

Reopening to attach new patch.

Caitlin Potter (:caitp)

[Comment 17](show_bug.cgi?id=165091#c17)
2016-12-03 10:29:49 PST

Created [attachment 296053](attachment.cgi?id=296053&action=diff "Patch") [[details]](attachment.cgi?id=296053&action=edit "Patch")
Patch

WebKit Commit Bot

[Comment 18](show_bug.cgi?id=165091#c18)
2016-12-03 10:30:50 PST

[Attachment 296053](attachment.cgi?id=296053&action=diff "Patch") [[details]](attachment.cgi?id=296053&action=edit "Patch") did not pass style-queue:
ERROR: Source/JavaScriptCore/ChangeLog:2588: Please consider whether the use of security-sensitive phrasing could help someone exploit WebKit: fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzzing, fuzz test, malicious [changelog/unwantedsecurityterms] [3]
ERROR: JSTests/ChangeLog:1025: Please consider whether the use of security-sensitive phrasing could help someone exploit WebKit: fuzz test, malicious [changelog/unwantedsecurityterms] [3]
Total errors found: 2 in 5 files
If any of these errors are false positives, please file a bug against check-webkit-style.

Caitlin Potter (:caitp)

[Comment 19](show_bug.cgi?id=165091#c19)
2016-12-03 10:42:39 PST

So, I guess the main problem was just not reporting an error message in `parseMemberExpression` when "async" is followed by an identifier (it just marked the error as "this is probably an arrow function" and returned 0), which didn't work in unary expression contexts.
But, some keywords do wrap around and get treated as unary ops when they shouldn't. That could be a problem, but I don't have a test case that crashes due to it. So, I can solve this crash without the ParserTokens.h changes, but maybe it makes sense to have them anyway.

Caitlin Potter (:caitp)

[Comment 20](show_bug.cgi?id=165091#c20)
2016-12-05 07:22:01 PST

Created [attachment 296137](attachment.cgi?id=296137&action=diff "Patch for relanding") [[details]](attachment.cgi?id=296137&action=edit "Patch for relanding")
Patch for relanding

Caitlin Potter (:caitp)

[Comment 21](show_bug.cgi?id=165091#c21)
2016-12-05 08:10:12 PST

Comment on [attachment 296137](attachment.cgi?id=296137&action=diff "Patch for relanding") [[details]](attachment.cgi?id=296137&action=edit "Patch for relanding")
Patch for relanding
This patch fixes some problems with the previously landed one, including:
1. record error message in `parseMemberExpression` when an async arrow function is assumed (previously returned 0, causing the operatorString() path to be taken in a unary expr context)
2. bitfield comment is updated for correctness
3. changelog less confusing than it was previously
Now, when I was first debugging this, I was seeing "async" treated as a unary op, and not "minus" as the unary op, so it seemed to make sense to fix the bitfield. It looks like it's not \_strictly\_ necessary to fix the bitfield, but is probably a good idea regardless.
So, this is ready to go, but if preferred, the ParserTokens.h change should be safe to remove before landing, since the main fix is that one line in parseMemberExpression().

Alexey Proskuryakov

[Comment 22](show_bug.cgi?id=165091#c22)
2016-12-05 13:15:26 PST

I'm confused about the state of this bug.
The test added here has been failing since [r209293](https://commits.webkit.org/r209293). There is currently a "patch for relanding" up for review.
Does this mean that all or parts of the initial patch got rolled out? Does the current patch fix the test failure?
In any case, a prompt fix would be appreciated, as JSC test bots have been red for three days now.

Alexey Proskuryakov

[Comment 23](show_bug.cgi?id=165091#c23)
2016-12-05 13:16:06 PST

Link to failing tests: [https://build.webkit.org/builders/Apple%20El%20Capitan%20Release%20JSC%20(Tests)/builds/10897/steps/jscore-test/logs/stdio](https://build.webkit.org/builders/Apple%20El%20Capitan%20Release%20JSC%20%28Tests%29/builds/10897/steps/jscore-test/logs/stdio)
\*\* The following JSC stress test failures have been introduced:
stress/bug-165091.js.default
stress/bug-165091.js.dfg-eager
stress/bug-165091.js.dfg-eager-no-cjit-validate
stress/bug-165091.js.dfg-maximal-flush-validate-no-cjit
stress/bug-165091.js.ftl-eager
stress/bug-165091.js.ftl-eager-no-cjit
stress/bug-165091.js.ftl-no-cjit-no-inline-validate
stress/bug-165091.js.ftl-no-cjit-no-put-stack-validate
stress/bug-165091.js.ftl-no-cjit-small-pool
stress/bug-165091.js.ftl-no-cjit-validate-sampling-profiler
stress/bug-165091.js.no-cjit-validate-phases
stress/bug-165091.js.no-ftl
stress/bug-165091.js.no-llint

Caitlin Potter (:caitp)

[Comment 24](show_bug.cgi?id=165091#c24)
2016-12-05 13:21:37 PST

(In reply to [comment #22](show_bug.cgi?id=165091#c22))
> I'm confused about the state of this bug.
>
> The test added here has been failing since [r209293](https://commits.webkit.org/r209293). There is currently a
> "patch for relanding" up for review.
>
> Does this mean that all or parts of the initial patch got rolled out? Does
> the current patch fix the test failure?
>
> In any case, a prompt fix would be appreciated, as JSC test bots have been
> red for three days now.
You're right, this wasn't rolled out. I thought it had been. In any case, the fix for the test failure is in the latest patch.

Caitlin Potter (:caitp)

[Comment 25](show_bug.cgi?id=165091#c25)
2016-12-05 13:27:47 PST

Created [attachment 296184](attachment.cgi?id=296184&action=diff "Patch for landing") [[details]](attachment.cgi?id=296184&action=edit "Patch for landing")
Patch for landing
Fixup to not call this a reland, and better describe what gets fixed here

Mark Lam

[Comment 26](show_bug.cgi?id=165091#c26)
2016-12-05 13:50:49 PST

Comment on [attachment 296184](attachment.cgi?id=296184&action=diff "Patch for landing") [[details]](attachment.cgi?id=296184&action=edit "Patch for landing")
Patch for landing
View in context: <https://bugs.webkit.org/attachment.cgi?id=296184&action=review>
r=me
> JSTests/stress/bug-165091.js:14
> -shouldThrowSyntaxError("0/-async J", "SyntaxError: Cannot parse member expression.")
> \ No newline at end of file
> +shouldThrowSyntaxError("0/-async J", "Unexpected identifier 'J'")
Please add a new line at the end of the file. That will prevent these " \ No newline at end of file" text from showing up in the future.

Caitlin Potter (:caitp)

[Comment 27](show_bug.cgi?id=165091#c27)
2016-12-05 13:53:46 PST

Created [attachment 296186](attachment.cgi?id=296186&action=diff "Fix of test failure.") [[details]](attachment.cgi?id=296186&action=edit "Fix of test failure.")
Fix of test failure.

WebKit Commit Bot

[Comment 28](show_bug.cgi?id=165091#c28)
2016-12-05 13:54:49 PST

Comment on [attachment 296186](attachment.cgi?id=296186&action=diff "Fix of test failure.") [[details]](attachment.cgi?id=296186&action=edit "Fix of test failure.")
Fix of test failure.
Rejecting [attachment 296186](attachment.cgi?id=296186&action=diff "Fix of test failure.") [[details]](attachment.cgi?id=296186&action=edit "Fix of test failure.") from review queue.
caitp@igalia.com does not have reviewer permissions according to <http://trac.webkit.org/browser/trunk/Tools/Scripts/webkitpy/common/config/contributors.json>.
- If you do not have reviewer rights please read <http://webkit.org/coding/contributing.html> for instructions on how to use bugzilla flags.
- If you have reviewer rights please correct the error in Tools/Scripts/webkitpy/common/config/contributors.json by adding yourself to the file (no review needed). The commit-queue restarts itself every 2 hours. After restart the commit-queue will correctly respect your reviewer rights.

Mark Lam

[Comment 29](show_bug.cgi?id=165091#c29)
2016-12-05 13:58:09 PST

(In reply to [comment #28](show_bug.cgi?id=165091#c28))
> caitp@igalia.com does not have reviewer permissions according to
> <http://trac.webkit.org/browser/trunk/Tools/Scripts/webkitpy/common/config/>
> contributors.json.
For future reference, this is how you handle a patch for landing via the cq: you can change the "Reviewed by" line in the patch to the reviewer who reviewed your patch, and just cq+ the patch.

Caitlin Potter (:caitp)

[Comment 30](show_bug.cgi?id=165091#c30)
2016-12-05 14:00:27 PST

(In reply to [comment #29](show_bug.cgi?id=165091#c29))
> (In reply to [comment #28](show_bug.cgi?id=165091#c28))
> > caitp@igalia.com does not have reviewer permissions according to
> > <http://trac.webkit.org/browser/trunk/Tools/Scripts/webkitpy/common/config/>
> > contributors.json.
>
> For future reference, this is how you handle a patch for landing via the cq:
> you can change the "Reviewed by" line in the patch to the reviewer who
> reviewed your patch, and just cq+ the patch.
I think I've been told this at least twice now, sorry. Most of my work is using different conventions in Chromium, so it's hard to commit this to memory. I'll stick a post-it note by my desk for next time.

Mark Lam

[Comment 31](show_bug.cgi?id=165091#c31)
2016-12-05 14:05:50 PST

Comment on [attachment 295961](attachment.cgi?id=295961&action=diff "Patch") [[details]](attachment.cgi?id=295961&action=edit "Patch")
Patch
Un-obsoleting this patch because this was the original patch that was landed in [r209293](https://commits.webkit.org/r209293): <<http://trac.webkit.org/changeset/209293>>.
The latest patch is only a delta to fix a bug in that original patch.

WebKit Commit Bot

[Comment 32](show_bug.cgi?id=165091#c32)
2016-12-05 14:20:34 PST

Comment on [attachment 296186](attachment.cgi?id=296186&action=diff "Fix of test failure.") [[details]](attachment.cgi?id=296186&action=edit "Fix of test failure.")
Fix of test failure.
Clearing flags on attachment: 296186
Committed [r209350](https://commits.webkit.org/r209350): <<http://trac.webkit.org/changeset/209350>>

WebKit Commit Bot

[Comment 33](show_bug.cgi?id=165091#c33)
2016-12-05 14:20:39 PST

All reviewed patches have been landed. Closing bug.

Note
You need to
[log in](show_bug.cgi?id=165091&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Normal

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | WebKit Nightly Build |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |JavaScriptCore

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Caitlin Potter (:caitp)

Reported

2016-11-28 09:49 PST

Modified

2019-09-30 09:41 PDT
[History](show_activity.cgi?id=165091)

CC List

13
users
Show

ap
caitp
commit-queue
fpizlo
ggaren
keith\_miller
mariakatosvich
mark.lam
msaboff
ryanhaddad
saam
webkit-bug-importer
ysuzuki

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |InRadar

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |
None

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=165091)
* [XML](show_bug.cgi?ctype=xml&id=165091)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=165091)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)


