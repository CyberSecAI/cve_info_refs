=== Content from bugs.webkit.org_529a8fd2_20250125_162623.html ===

 [WebKit Bugzilla](./)

* [New](enter_bug.cgi)
* [Browse](describecomponents.cgi)
* Log In
  ×

  Sign in with GitHub

  or

   Remember my login
  [Create Account](/createaccount.cgi)
  ·
  [Forgot Password](show_bug.cgi?id=164123&GoAheadAndLogIn=1#forgot)

  ## Forgotten password account recovery

RESOLVED
FIXED
[164123](show_bug.cgi?id=164123)

[JSC] JSON.stringify should handle Proxy which is non JSArray but isArray is true
```
https://bugs.webkit.org/show_bug.cgi?id=164123
```

[Summary](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
[JSC] JSON.stringify should handle Proxy which is non JSArray but isArray is ...

Kamil Frankowicz

[Reported](show_bug.cgi?id=164123#c0)
2016-10-28 06:02:19 PDT

Created [attachment 293147](attachment.cgi?id=293147 "POC to trigger SEGFAULT (jsc)") [[details]](attachment.cgi?id=293147&action=edit "POC to trigger SEGFAULT (jsc)")
POC to trigger SEGFAULT (jsc)
Affected SVN revision: 208042
To reproduce the problem:
./jsc wekbit\_string\_builder.js
ASAN Output:
ASAN:DEADLYSIGNAL
=================================================================
==16295==ERROR: AddressSanitizer: SEGV on unknown address 0x6041000021a3 (pc 0x7fa5adf38ee4 bp 0x0000ffffffff sp 0x7ffd4d2f6790 T0)
==16295==The signal is caused by a READ memory access.
#0 0x7fa5adf38ee3 in WTF::StringBuilder::operator[](unsigned int) const XYZ/webkit/Source/WTF/wtf/text/StringBuilder.h:247:20
#1 0x7fa5adf38ee3 in JSC::Stringifier::Holder::appendNextProperty(JSC::Stringifier&, WTF::StringBuilder&) XYZ/webkit/Source/JavaScriptCore/runtime/JSONObject.cpp:465
#2 0x7fa5adf35501 in JSC::Stringifier::appendStringifiedValue(WTF::StringBuilder&, JSC::JSValue, JSC::JSObject\*, JSC::PropertyNameForFunctionCall const&) XYZ/webkit/Source/JavaScriptCore/runtime/JSONObject.cpp:384:37
#3 0x7fa5adf31deb in JSC::Stringifier::stringify(JSC::Handle<JSC::Unknown>) XYZ/webkit/Source/JavaScriptCore/runtime/JSONObject.cpp:262:9
#4 0x7fa5adf406c4 in JSC::JSONProtoFuncStringify(JSC::ExecState\*) XYZ/webkit/Source/JavaScriptCore/runtime/JSONObject.cpp:786:57
#5 0x7fa565afe027 (<unknown module>)
AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV XYZ/webkit/Source/WTF/wtf/text/StringBuilder.h:247:20 in WTF::StringBuilder::operator[](unsigned int) const
==16295==ABORTING
Regards,
Kamil Frankowicz

| Attachments | | |
| --- | --- | --- |
| [**POC to trigger SEGFAULT (jsc)**](attachment.cgi?id=293147 "View the content of the attachment") (71 bytes, application/javascript)  [2016-10-28 06:02 PDT](#attach_293147 "Go to the comment associated with the attachment"), Kamil Frankowicz | *no flags* | [Details](attachment.cgi?id=293147&action=edit) |
| [**Patch**](attachment.cgi?id=293328 "View the content of the attachment") (9.29 KB, patch)  [2016-10-29 22:02 PDT](#attach_293328 "Go to the comment associated with the attachment"), Yusuke Suzuki | *no flags* | [Details](attachment.cgi?id=293328&action=edit)[Formatted Diff](attachment.cgi?id=293328&action=prettypatch)[Diff](attachment.cgi?id=293328&action=diff) |
| [**Patch**](attachment.cgi?id=293335 "View the content of the attachment") (10.09 KB, patch)  [2016-10-29 23:20 PDT](#attach_293335 "Go to the comment associated with the attachment"), Yusuke Suzuki | mark.lam: review+ | [Details](attachment.cgi?id=293335&action=edit)[Formatted Diff](attachment.cgi?id=293335&action=prettypatch)[Diff](attachment.cgi?id=293335&action=diff) |
| [Show Obsolete](#a0) (1) [View All](attachment.cgi?bugid=164123&action=viewall&hide_obsolete=1)  [Add attachment](attachment.cgi?bugid=164123&action=enter) *proposed patch, testcase, etc.* | | |

Radar WebKit Bug Importer

[Comment 1](show_bug.cgi?id=164123#c1)
2016-10-29 09:49:23 PDT

<rdar://problem/29015948>

Yusuke Suzuki

[Comment 2](show_bug.cgi?id=164123#c2)
2016-10-29 20:18:34 PDT

More easy way is `JSON.parse(new Proxy([undefined], {}));`. investigating.

Yusuke Suzuki

[Comment 3](show_bug.cgi?id=164123#c3)
2016-10-29 20:21:24 PDT

s/parse/stringify/

Yusuke Suzuki

[Comment 4](show_bug.cgi?id=164123#c4)
2016-10-29 22:02:02 PDT

Created [attachment 293328](attachment.cgi?id=293328&action=diff "Patch") [[details]](attachment.cgi?id=293328&action=edit "Patch")
Patch

Mark Lam

[Comment 5](show_bug.cgi?id=164123#c5)
2016-10-29 23:00:10 PDT

Comment on [attachment 293328](attachment.cgi?id=293328&action=diff "Patch") [[details]](attachment.cgi?id=293328&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293328&action=review>
> Source/JavaScriptCore/ChangeLog:11
> + When JSON.stringify encounter the value like undefined, which results depend
> + on the context. If it is produced under the object property context, we ignore
> + that property. On the other hand, if it is produced under the array element
> + context, we produce "null".
Can you quote the relevant urls to the spec here?
> Source/JavaScriptCore/runtime/JSONObject.cpp:265
> + Holder root(Holder::RootHolder, vm, object);
Why can't you just use:
Holder root(vm, m\_exec, object);
> Source/JavaScriptCore/runtime/JSONObject.cpp:426
> + , m\_isArray(JSC::isArray(exec, object))
m\_isJSArray is uninitialized here. Is that intentional?
> Source/JavaScriptCore/runtime/JSONObject.cpp:440
> +inline Stringifier::Holder::Holder(RootHolderTag, VM& vm, JSObject\* object)
> + : m\_object(vm, object)
> + , m\_isArray(false)
> + , m\_isJSArray(false)
> , m\_index(0)
> #ifndef NDEBUG
> , m\_size(0)
Why do we need this version? Won't the Holder(VM& vm, ExecState\* exec, JSObject\* object) work just as well?

Yusuke Suzuki

[Comment 6](show_bug.cgi?id=164123#c6)
2016-10-29 23:09:50 PDT

Comment on [attachment 293328](attachment.cgi?id=293328&action=diff "Patch") [[details]](attachment.cgi?id=293328&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293328&action=review>
Thanks!
>> Source/JavaScriptCore/ChangeLog:11
>> + context, we produce "null".
>
> Can you quote the relevant urls to the spec here?
Yup! I'll include it.
<https://tc39.github.io/ecma262/#sec-serializejsonarray> we write "null".
But <https://tc39.github.io/ecma262/#sec-serializejsonobject>, we skip the property in 8-b.
>> Source/JavaScriptCore/runtime/JSONObject.cpp:265
>> + Holder root(Holder::RootHolder, vm, object);
>
> Why can't you just use:
> Holder root(vm, m\_exec, object);
I don't think using it directly is good. It calls `isArray` for the given object and isArray() could raise exceptions for some objects.
Of course, here, the exception never happens. But I would like to explicitly say that this Holder does not cause any observable behaviors.
That's why I did not include ExecState\* in this constructor.
>> Source/JavaScriptCore/runtime/JSONObject.cpp:426
>> + , m\_isArray(JSC::isArray(exec, object))
>
> m\_isJSArray is uninitialized here. Is that intentional?
Yes, that is intentional. And this function is original one and it is not changed.
This m\_isJSArray will be initialized when we call appendNextProperty for this holder.
>> Source/JavaScriptCore/runtime/JSONObject.cpp:440
>> , m\_size(0)
>
> Why do we need this version? Won't the Holder(VM& vm, ExecState\* exec, JSObject\* object) work just as well?
Yeah, it works. But I don't think it is good manner.
And since we do not call appendNextProperty for this root Holder, some of the fields (m\_isJSArray) remains uninitialized.
I don't think it is good thing.

Yusuke Suzuki

[Comment 7](show_bug.cgi?id=164123#c7)
2016-10-29 23:12:13 PDT

Notable example is,
JSON.stringify({ value: undefined }) => "{}"
JSON.stringify([undefined]) => "[null]"

Yusuke Suzuki

[Comment 8](show_bug.cgi?id=164123#c8)
2016-10-29 23:16:00 PDT

Comment on [attachment 293328](attachment.cgi?id=293328&action=diff "Patch") [[details]](attachment.cgi?id=293328&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293328&action=review>
>>> Source/JavaScriptCore/runtime/JSONObject.cpp:426
>>> + , m\_isArray(JSC::isArray(exec, object))
>>
>> m\_isJSArray is uninitialized here. Is that intentional?
>
> Yes, that is intentional. And this function is original one and it is not changed.
> This m\_isJSArray will be initialized when we call appendNextProperty for this holder.
But, I think initializing it is better. Since isJSArray() is not observable one, we can just call it here.
I'll change this part.

Yusuke Suzuki

[Comment 9](show_bug.cgi?id=164123#c9)
2016-10-29 23:20:53 PDT

Created [attachment 293335](attachment.cgi?id=293335&action=diff "Patch") [[details]](attachment.cgi?id=293335&action=edit "Patch")
Patch

Mark Lam

[Comment 10](show_bug.cgi?id=164123#c10)
2016-10-30 00:03:40 PDT

Comment on [attachment 293335](attachment.cgi?id=293335&action=diff "Patch") [[details]](attachment.cgi?id=293335&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293335&action=review>
r=me
> Source/JavaScriptCore/ChangeLog:8
> + When JSON.stringify encounter the value like undefined, which results depend
/the value like undefined/the undefined value/
/which results depend/the result depends/
> Source/JavaScriptCore/ChangeLog:14
> + // <https://tc39.github.io/ecma262/#sec-serializejsonobject>
I suggest adding "section 8.b" after the spec url above.
> Source/JavaScriptCore/ChangeLog:18
> + // <https://tc39.github.io/ecma262/#sec-serializejsonarray>
I suggest adding "section 8.b" after the spec url above.
> JSTests/stress/json-stringify-with-non-jsarray-array.js:24
> +shouldBe(JSON.stringify(new Proxy([function() { }], {})), `[null]`);
Can you also add the test case for JSON.stringify(new Proxy({ value: undefined }, {}))?

Yusuke Suzuki

[Comment 11](show_bug.cgi?id=164123#c11)
2016-10-30 00:49:05 PDT

Comment on [attachment 293335](attachment.cgi?id=293335&action=diff "Patch") [[details]](attachment.cgi?id=293335&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293335&action=review>
>> Source/JavaScriptCore/ChangeLog:8
>> + When JSON.stringify encounter the value like undefined, which results depend
>
> /the value like undefined/the undefined value/
> /which results depend/the result depends/
Oops, fixed.
>> Source/JavaScriptCore/ChangeLog:14
>> + // <https://tc39.github.io/ecma262/#sec-serializejsonobject>
>
> I suggest adding "section 8.b" after the spec url above.
Yeah, nice. Fixed.
>> Source/JavaScriptCore/ChangeLog:18
>> + // <https://tc39.github.io/ecma262/#sec-serializejsonarray>
>
> I suggest adding "section 8.b" after the spec url above.
Fixed.
>> JSTests/stress/json-stringify-with-non-jsarray-array.js:24
>> +shouldBe(JSON.stringify(new Proxy([function() { }], {})), `[null]`);
>
> Can you also add the test case for JSON.stringify(new Proxy({ value: undefined }, {}))?
Yup, added.

Yusuke Suzuki

[Comment 12](show_bug.cgi?id=164123#c12)
2016-10-30 02:17:38 PDT

Committed [r208123](https://commits.webkit.org/r208123): <<http://trac.webkit.org/changeset/208123>>

Darin Adler

[Comment 13](show_bug.cgi?id=164123#c13)
2016-10-30 15:22:49 PDT

Comment on [attachment 293335](attachment.cgi?id=293335&action=diff "Patch") [[details]](attachment.cgi?id=293335&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293335&action=review>
> Source/JavaScriptCore/runtime/JSONObject.cpp:431
> + , m\_index(0)
> +#ifndef NDEBUG
> + , m\_size(0)
> +#endif
It would be better to initialize these in the class definition.
> Source/JavaScriptCore/runtime/JSONObject.cpp:441
> + , m\_isArray(false)
> + , m\_isJSArray(false)
> , m\_index(0)
> #ifndef NDEBUG
> , m\_size(0)
It would be better to initialize these in the class definition.

Yusuke Suzuki

[Comment 14](show_bug.cgi?id=164123#c14)
2016-10-31 22:40:50 PDT

Comment on [attachment 293335](attachment.cgi?id=293335&action=diff "Patch") [[details]](attachment.cgi?id=293335&action=edit "Patch")
Patch
View in context: <https://bugs.webkit.org/attachment.cgi?id=293335&action=review>
Thanks, I'll create a follow-up patch.
>> Source/JavaScriptCore/runtime/JSONObject.cpp:431
>> +#endif
>
> It would be better to initialize these in the class definition.
Sounds nice. I'll move this function to the class definition.
And use default initialization for some members (m\_index for example).
>> Source/JavaScriptCore/runtime/JSONObject.cpp:441
>> , m\_size(0)
>
> It would be better to initialize these in the class definition.
Ditto.

Kamil Frankowicz

[Comment 15](show_bug.cgi?id=164123#c15)
2017-02-17 06:26:37 PST

This is CVE-2016-10222.

Note
You need to
[log in](show_bug.cgi?id=164123&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

 [Status](page.cgi?id=fields.html#bug_status "A bug may be in any of a number of states.") |RESOLVED

resolved as
 [Resolution](page.cgi?id=fields.html#resolution "If a bug is in a resolved state, then one of these reasons will be given for its resolution.") |FIXED

 [Priority](page.cgi?id=fields.html#priority "Engineers prioritize their bugs using this field.") |P2

 [Severity](page.cgi?id=fields.html#bug_severity "How severe the bug is, or whether it's an enhancement.") |Normal

 [Classification](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") |Unclassified

 [Version](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | WebKit Nightly Build |
 [Hardware](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [OS](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") |Unspecified

 [Product](describecomponents.cgi "Bugs are categorised into Products and Components.") |WebKit

 [Component](describecomponents.cgi?product=WebKit "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") |JavaScriptCore

 [Assignee](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") |Yusuke Suzuki

Reported

2016-10-28 06:02 PDT

Modified

2017-02-17 06:26 PST
[History](show_activity.cgi?id=164123)

CC List

10
users
Show

darin
fpizlo
ggaren
jfbastien
keith\_miller
mark.lam
msaboff
saam
webkit-bug-importer
ysuzuki

 [URL](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |
  |

 [Keywords](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |InRadar

 [Depends on](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |

 [Blocks](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |

 [See Also](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |

 [Alias](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") |
None

---

* Top of Page
* [Format For Printing](show_bug.cgi?format=multiple&id=164123)
* [XML](show_bug.cgi?ctype=xml&id=164123)
* [Clone This Bug](enter_bug.cgi?cloned_bug_id=164123)

* + [New](enter_bug.cgi)
  + [Browse](describecomponents.cgi)
  + [Reports](report.cgi)
  + [Requests](request.cgi)



=== Content from trac.webkit.org_58e6eb3f_20250125_162620.html ===


[![WebKit Trac](/chrome/site/favicon.png)](http://www.webkit.org/)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [Browse Source](/browser)
* [Search](/search)

## Context Navigation

* ← [Previous Changeset](/changeset/208122/webkit "Changeset 208122")
* [Next Changeset](/changeset/208124/webkit "Changeset 208124") →

---

# Changeset 208123 in webkit

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
Oct 30, 2016, 2:14:37 AM
([8 years](/timeline?from=2016-10-30T02%3A14%3A37-07%3A00&precision=second "See timeline at Oct 30, 2016, 2:14:37 AM") ago)
Author:
Yusuke Suzuki
Message:

[JSC] JSON.stringify should handle Proxy which is non JSArray but isArray is true

[​https://bugs.webkit.org/show\_bug.cgi?id=164123](https://bugs.webkit.org/show_bug.cgi?id=164123)

Reviewed by Mark Lam.

JSTests:

* stress/json-stringify-with-non-jsarray-array.js: Added.

(shouldBe):

(shouldBe.JSON.stringify.new.Proxy):

Source/JavaScriptCore:

When JSON.stringify encounter the undefined value, the result depends

on the context. If it is produced under the object property context, we ignore

that property. On the other hand, if it is produced under the array element

context, we produce "null".

For example,

> *[​https://tc39.github.io/ecma262/#sec-serializejsonobject](https://tc39.github.io/ecma262/#sec-serializejsonobject) section 8.b.* Skip the property that value is undefined.
>
> JSON.stringify({ value: undefined });  *=> "{}"*

> *[​https://tc39.github.io/ecma262/#sec-serializejsonarray](https://tc39.github.io/ecma262/#sec-serializejsonarray) section 8.b.* Write "null" when the element is undefined.
>
> JSON.stringify([undefined]);  *=> "[null]"*

At that time, we decide the context based on the `holder->inherits(JSArray::info())`.

But it is not correct since we have a holder that creates the array element context

but it is not JSArray subtype. ES6 Proxy to an array is one example. In that case,

`isArray(exec, proxy)` returns `true`, but `inherits(JSArray::info())` returns false.

Since we already have this `isArray()` value in Stringifier::Holder, we should reuse

this here. And this is the correct behavior in the ES6 spec.

* runtime/JSONObject.cpp:

(JSC::Stringifier::Holder::isArray):

(JSC::Stringifier::stringify):

(JSC::Stringifier::appendStringifiedValue):

(JSC::Stringifier::Holder::Holder):

(JSC::Stringifier::Holder::appendNextProperty):

Location:
[trunk](/browser/webkit/trunk?rev=208123)
Files:

1 added
3 edited

* [JSTests/ChangeLog](/browser/webkit/trunk/JSTests/ChangeLog?rev=208123 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [JSTests/stress/json-stringify-with-non-jsarray-array.js](/browser/webkit/trunk/JSTests/stress/json-stringify-with-non-jsarray-array.js?rev=208123 "Show entry in browser")
  (added)
* [Source/JavaScriptCore/ChangeLog](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=208123 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [Source/JavaScriptCore/runtime/JSONObject.cpp](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123 "Show entry in browser")
  (modified)
  ([12 diffs](#file3 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/JSTests/ChangeLog](/changeset/208123/webkit/trunk/JSTests/ChangeLog "Show the changeset 208123 restricted to trunk/JSTests/ChangeLog")

  | [r208117](/browser/webkit/trunk/JSTests/ChangeLog?rev=208117#L1 "Show revision 208117 of this file in browser") | [r208123](/browser/webkit/trunk/JSTests/ChangeLog?rev=208123#L1 "Show revision 208123 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2016-10-29  Yusuke Suzuki  <utatane.tea@gmail.com> |
  |  | 2 |  |
  |  | 3 | [JSC] JSON.stringify should handle Proxy which is non JSArray but isArray is true |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=164123 |
  |  | 5 |  |
  |  | 6 | Reviewed by Mark Lam. |
  |  | 7 |  |
  |  | 8 | \* stress/json-stringify-with-non-jsarray-array.js: Added. |
  |  | 9 | (shouldBe): |
  |  | 10 | (shouldBe.JSON.stringify.new.Proxy): |
  |  | 11 |  |
  | 1 | 12 | 2016-10-29  Saam Barati  <sbarati@apple.com> |
  | 2 | 13 |  |
* ## [trunk/Source/JavaScriptCore/ChangeLog](/changeset/208123/webkit/trunk/Source/JavaScriptCore/ChangeLog "Show the changeset 208123 restricted to trunk/Source/JavaScriptCore/ChangeLog")

  | [r208117](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=208117#L1 "Show revision 208117 of this file in browser") | [r208123](/browser/webkit/trunk/Source/JavaScriptCore/ChangeLog?rev=208123#L1 "Show revision 208123 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | 2016-10-29  Yusuke Suzuki  <utatane.tea@gmail.com> |
  |  | 2 |  |
  |  | 3 | [JSC] JSON.stringify should handle Proxy which is non JSArray but isArray is true |
  |  | 4 | https://bugs.webkit.org/show\_bug.cgi?id=164123 |
  |  | 5 |  |
  |  | 6 | Reviewed by Mark Lam. |
  |  | 7 |  |
  |  | 8 | When JSON.stringify encounter the undefined value, the result depends |
  |  | 9 | on the context. If it is produced under the object property context, we ignore |
  |  | 10 | that property. On the other hand, if it is produced under the array element |
  |  | 11 | context, we produce "null". |
  |  | 12 |  |
  |  | 13 | For example, |
  |  | 14 | // https://tc39.github.io/ecma262/#sec-serializejsonobject section 8.b. |
  |  | 15 | // Skip the property that value is undefined. |
  |  | 16 | JSON.stringify({ value: undefined });  // => "{}" |
  |  | 17 |  |
  |  | 18 | // https://tc39.github.io/ecma262/#sec-serializejsonarray section 8.b. |
  |  | 19 | // Write "null" when the element is undefined. |
  |  | 20 | JSON.stringify([undefined]);           // => "[null]" |
  |  | 21 |  |
  |  | 22 | At that time, we decide the context based on the `holder->inherits(JSArray::info())`. |
  |  | 23 | But it is not correct since we have a holder that creates the array element context |
  |  | 24 | but it is not JSArray subtype. ES6 Proxy to an array is one example. In that case, |
  |  | 25 | `isArray(exec, proxy)` returns `true`, but `inherits(JSArray::info())` returns false. |
  |  | 26 | Since we already have this `isArray()` value in Stringifier::Holder, we should reuse |
  |  | 27 | this here. And this is the correct behavior in the ES6 spec. |
  |  | 28 |  |
  |  | 29 | \* runtime/JSONObject.cpp: |
  |  | 30 | (JSC::Stringifier::Holder::isArray): |
  |  | 31 | (JSC::Stringifier::stringify): |
  |  | 32 | (JSC::Stringifier::appendStringifiedValue): |
  |  | 33 | (JSC::Stringifier::Holder::Holder): |
  |  | 34 | (JSC::Stringifier::Holder::appendNextProperty): |
  |  | 35 |  |
  | 1 | 36 | 2016-10-29  Saam Barati  <sbarati@apple.com> |
  | 2 | 37 |  |
* ## [trunk/Source/JavaScriptCore/runtime/JSONObject.cpp](/changeset/208123/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp "Show the changeset 208123 restricted to trunk/Source/JavaScriptCore/runtime/JSONObject.cpp")

  | [r207785](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L94 "Show revision 207785 of this file in browser") | [r208123](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L94 "Show revision 208123 of this file in browser") |  |
  | --- | --- | --- |
  | 94 | 94 | class Holder { |
  | 95 | 95 | public: |
  |  | 96 | enum RootHolderTag { RootHolder }; |
  | 96 | 97 | Holder(VM&, ExecState\*, JSObject\*); |
  |  | 98 | Holder(RootHolderTag, VM&, JSObject\*); |
  | 97 | 99 |  |
  | 98 | 100 | JSObject\* object() const { return m\_object.get(); } |
  |  | 101 | bool isArray() const { return m\_isArray; } |
  | 99 | 102 |  |
  | 100 | 103 | bool appendNextProperty(Stringifier&, StringBuilder&); |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L103) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L106) |  |
  | 103 | 106 | Local<JSObject> m\_object; |
  | 104 | 107 | const bool m\_isArray; |
  | 105 |  | bool m\_isJSArray; |
  |  | 108 | const bool m\_isJSArray; |
  | 106 | 109 | unsigned m\_index; |
  | 107 | 110 | unsigned m\_size; |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L115) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L118) |  |
  | 115 | 118 |  |
  | 116 | 119 | enum StringifyResult { StringifyFailed, StringifySucceeded, StringifyFailedDueToUndefinedOrSymbolValue }; |
  | 117 |  | StringifyResult appendStringifiedValue(StringBuilder&, JSValue, ~~JSObject\* holder~~, const PropertyNameForFunctionCall&); |
  |  | 120 | StringifyResult appendStringifiedValue(StringBuilder&, JSValue, const Holder&, const PropertyNameForFunctionCall&); |
  | 118 | 121 |  |
  | 119 | 122 | bool willIndent() const; |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L260) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L263) |  |
  | 260 | 263 |  |
  | 261 | 264 | StringBuilder result; |
  | 262 |  | if (appendStringifiedValue(result, value.get(), object, emptyPropertyName) != StringifySucceeded) |
  |  | 265 | Holder root(Holder::RootHolder, vm, object); |
  |  | 266 | if (appendStringifiedValue(result, value.get(), root, emptyPropertyName) != StringifySucceeded) |
  | 263 | 267 | return Local<Unknown>(vm, jsUndefined()); |
  | 264 | 268 | RETURN\_IF\_EXCEPTION(scope, Local<Unknown>(vm, jsNull())); |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L297) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L301) |  |
  | 297 | 301 | } |
  | 298 | 302 |  |
  | 299 |  | Stringifier::StringifyResult Stringifier::appendStringifiedValue(StringBuilder& builder, JSValue value, ~~JSObject\*~~ holder, const PropertyNameForFunctionCall& propertyName) |
  |  | 303 | Stringifier::StringifyResult Stringifier::appendStringifiedValue(StringBuilder& builder, JSValue value, const Holder& holder, const PropertyNameForFunctionCall& propertyName) |
  | 300 | 304 | { |
  | 301 | 305 | VM& vm = m\_exec->vm(); |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L311) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L315) |  |
  | 311 | 315 | args.append(propertyName.value(m\_exec)); |
  | 312 | 316 | args.append(value); |
  | 313 |  | value = call(m\_exec, m\_replacer.get(), m\_replacerCallType, m\_replacerCallData, holder, args); |
  |  | 317 | value = call(m\_exec, m\_replacer.get(), m\_replacerCallType, m\_replacerCallData, holder.object(), args); |
  | 314 | 318 | RETURN\_IF\_EXCEPTION(scope, StringifyFailed); |
  | 315 | 319 | } |
  | 316 | 320 |  |
  | 317 |  | if ((value.isUndefined() || value.isSymbol()) && !holder~~->inherits(JSArray::info()~~)) |
  |  | 321 | if ((value.isUndefined() || value.isSymbol()) && !holder.isArray()) |
  | 318 | 322 | return StringifyFailedDueToUndefinedOrSymbolValue; |
  | 319 | 323 |  |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L360) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L364) |  |
  | 360 | 364 | CallData callData; |
  | 361 | 365 | if (object->methodTable()->getCallData(object, callData) != CallType::None) { |
  | 362 |  | if (holder~~->inherits(JSArray::info()~~)) { |
  |  | 366 | if (holder.isArray()) { |
  | 363 | 367 | builder.appendLiteral("null"); |
  | 364 | 368 | return StringifySucceeded; |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L420) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L424) |  |
  | 420 | 424 | inline Stringifier::Holder::Holder(VM& vm, ExecState\* exec, JSObject\* object) |
  | 421 | 425 | : m\_object(vm, object) |
  | 422 |  | , m\_isArray(isArray(exec, object)) |
  |  | 426 | , m\_isArray(JSC::isArray(exec, object)) |
  |  | 427 | , m\_isJSArray(m\_isArray && isJSArray(object)) |
  | 423 | 428 | , m\_index(0) |
  | 424 | 429 | #ifndef NDEBUG |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L428) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L433) |  |
  | 428 | 433 | } |
  | 429 | 434 |  |
  |  | 435 | inline Stringifier::Holder::Holder(RootHolderTag, VM& vm, JSObject\* object) |
  |  | 436 | : m\_object(vm, object) |
  |  | 437 | , m\_isArray(false) |
  |  | 438 | , m\_isJSArray(false) |
  |  | 439 | , m\_index(0) |
  |  | 440 | #ifndef NDEBUG |
  |  | 441 | , m\_size(0) |
  |  | 442 | #endif |
  |  | 443 | { |
  |  | 444 | } |
  |  | 445 |  |
  | 430 | 446 | bool Stringifier::Holder::appendNextProperty(Stringifier& stringifier, StringBuilder& builder) |
  | 431 | 447 | { |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L439) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L455) |  |
  | 439 | 455 | if (!m\_index) { |
  | 440 | 456 | if (m\_isArray) { |
  | 441 |  | ~~m\_isJSArray = isJSArray(m\_object.get());~~ |
  | 442 | 457 | if (m\_isJSArray) |
  | 443 | 458 | m\_size = asArray(m\_object.get())->length(); |
  | 444 |  | else |
  |  | 459 | else { |
  | 445 | 460 | m\_size = m\_object->get(exec, vm.propertyNames->length).toUInt32(exec); |
  |  | 461 | RETURN\_IF\_EXCEPTION(scope, false); |
  |  | 462 | } |
  | 446 | 463 | builder.append('['); |
  | 447 | 464 | } else { |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L493) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L510) |  |
  | 493 | 510 |  |
  | 494 | 511 | // Append the stringified value. |
  | 495 |  | stringifyResult = stringifier.appendStringifiedValue(builder, value, m\_object.get(), index); |
  |  | 512 | stringifyResult = stringifier.appendStringifiedValue(builder, value, \*this, index); |
  |  | 513 | ASSERT(stringifyResult != StringifyFailedDueToUndefinedOrSymbolValue); |
  | 496 | 514 | } else { |
  | 497 | 515 | // Get the value. |
  | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=207785#L517) | […](/browser/webkit/trunk/Source/JavaScriptCore/runtime/JSONObject.cpp?rev=208123#L535) |  |
  | 517 | 535 |  |
  | 518 | 536 | // Append the stringified value. |
  | 519 |  | stringifyResult = stringifier.appendStringifiedValue(builder, value, ~~m\_object.get()~~, propertyName); |
  |  | 537 | stringifyResult = stringifier.appendStringifiedValue(builder, value, \*this, propertyName); |
  | 520 | 538 | } |
  | 521 | 539 |  |
**Note:**
See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

### Download in other formats:

* [Unified Diff](?format=diff&new=208123)
* [Zip Archive](?format=zip&new=208123)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.5.4**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Hosted by [Apple](http://www.apple.com/)


