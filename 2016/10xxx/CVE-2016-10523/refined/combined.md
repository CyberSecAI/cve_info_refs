=== Content from github.com_a4ed92e1_20250125_185431.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmqttjs%2Fmqtt-packet%2Fpull%2F8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmqttjs%2Fmqtt-packet%2Fpull%2F8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=mqttjs%2Fmqtt-packet)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mqttjs](/mqttjs)
/
**[mqtt-packet](/mqttjs/mqtt-packet)**
Public

* [Notifications](/login?return_to=%2Fmqttjs%2Fmqtt-packet) You must be signed in to change notification settings
* [Fork
  94](/login?return_to=%2Fmqttjs%2Fmqtt-packet)
* [Star
   207](/login?return_to=%2Fmqttjs%2Fmqtt-packet)

* [Code](/mqttjs/mqtt-packet)
* [Issues
  13](/mqttjs/mqtt-packet/issues)
* [Pull requests
  2](/mqttjs/mqtt-packet/pulls)
* [Actions](/mqttjs/mqtt-packet/actions)
* [Projects
  0](/mqttjs/mqtt-packet/projects)
* [Wiki](/mqttjs/mqtt-packet/wiki)
* [Security](/mqttjs/mqtt-packet/security)
* [Insights](/mqttjs/mqtt-packet/pulse)

Additional navigation options

* [Code](/mqttjs/mqtt-packet)
* [Issues](/mqttjs/mqtt-packet/issues)
* [Pull requests](/mqttjs/mqtt-packet/pulls)
* [Actions](/mqttjs/mqtt-packet/actions)
* [Projects](/mqttjs/mqtt-packet/projects)
* [Wiki](/mqttjs/mqtt-packet/wiki)
* [Security](/mqttjs/mqtt-packet/security)
* [Insights](/mqttjs/mqtt-packet/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmqttjs%2Fmqtt-packet%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmqttjs%2Fmqtt-packet%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Fixed crashing bug when parsing invalid messages #8

 Closed

[psorowka](/psorowka)
wants to merge
4
commits into
[mqttjs:master](/mqttjs/mqtt-packet/tree/master "mqttjs/mqtt-packet:master")
from
[cybusio:master](/cybusio/mqtt-packet/tree/master "cybusio/mqtt-packet:master")

 Closed

# [Fixed crashing bug when parsing invalid messages](#top) #8

[psorowka](/psorowka)
wants to merge
4
commits into
[mqttjs:master](/mqttjs/mqtt-packet/tree/master "mqttjs/mqtt-packet:master")
from
[cybusio:master](/cybusio/mqtt-packet/tree/master "cybusio/mqtt-packet:master")

[Conversation
18](/mqttjs/mqtt-packet/pull/8)
[Commits
4](/mqttjs/mqtt-packet/pull/8/commits)
[Checks
0](/mqttjs/mqtt-packet/pull/8/checks)
[Files changed](/mqttjs/mqtt-packet/pull/8/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![psorowka](https://avatars.githubusercontent.com/u/6883003?s=60&v=4)](/psorowka)

Copy link

Contributor

### @psorowka **[psorowka](/psorowka)** commented [Jan 14, 2016](#issue-126747206)

Fixes a crash that was observed in Mosca ([moscajs/mosca#393](https://github.com/moscajs/mosca/issues/393)) when starting to parse a TLS encrypted stream while assuming to parse plain MQTT data.

So what happened? The TLS connect message that arrived at mosca looked like this:

```
<Buffer 16 03 01 01 01 01 00 00 fd 03 03 00 09 9a 85 fc 19 19 fa 06 a4
8c a5 53 5d 6e c1 01 23 be 68 00 85 b9 0c 29 8b 24 87 30 09 e6 e4 00 00
80 c0 2f c0 2b ... >

```

Note the `16` at the start, this suggests that we have a regular CONNECT packet. The next byte `3` suggests a remaining length of the packet of 3 bytes which is obviously not true, but the implementation of the parser just checks if at least 3 bytes remain in the buffer before it starts processing the payload.

The parseConnect function of the parser now checks the next two bytes `01 01` which would describe the protocol identifier string length. Usually this would be 4 or 6 bytes, but here we have 257 bytes. So the next 257 bytes are consumed into a string and our parsing pointer is at buffer position 259. Unfortunately, the buffer only has 260 bytes in total. That is why the next parsing steps produce an out of range exception..

We obviously have various problems here:

* the parser does not check for plausibility when a string ought to be longer than the packet
* the parser does not check for a valid protocol identifier string at all
* the parser does not check (at some points) if the buffer has remaining length before parsing the next bytes
* the parser does not catch any (further, unexpected) exceptions in order to safe the upper layers from running into bad behavior

All of these where fixed and respective tests added.

Sorry, something went wrong.

All reactions

 Peter Sorowka
added 2 commits
[January 14, 2016 21:57](#commits-pushed-da768a7)

`[Fixed crashing bug when parsing invalid messages](/mqttjs/mqtt-packet/pull/8/commits/da768a757e7c92fd009a49c3e991c6ea6cdf0f83 "Fixed crashing bug when parsing invalid messages

Fixes a crash that was observed when starting to parse a TLS encrypted stream while assuming to parse plain MQTT data.

So what happened? The TLS connect message that arrived at looked like this:

```
<Buffer 16 03 01 01 01 01 00 00 fd 03 03 00 09 9a 85 fc 19 19 fa 06 a4
8c a5 53 5d 6e c1 01 23 be 68 00 85 b9 0c 29 8b 24 87 30 09 e6 e4 00 00
80 c0 2f c0 2b ... >
```

Note the `16` at the start, this suggests that we have a regular CONNECT packet. The next byte 3 suggests a remaining length of the packet of 3 bytes which is obviously not true, but the implementation of the parser just checks if at least 3 bytes remain in the buffer before it starts processing the payload.

The parseConnect function of the parser now checks the next two bytes `01 01` which would describe the protocol identifier string length. Usually
this would be 4 or 6 bytes, but here we have 257 bytes. So the next 257 bytes are consumed into a string and our parsing pointer is at buffer position 259. Unfortunately, the buffer only has 260 bytes in total. That is the next parsing steps produce an out of range exception..

We obviously have various problems here:

- the parser does not check for plausibility when a string ought to be longer than the packet
- the parser does not check for a valid protocol identifier string at all
- the parser does not check (at some points) if the buffer has remaining length before parsing the next bytes
- the parser does not catch any (further, unexpected) exceptions in order to safe the upper layers from running into bad behavior")`
 …

`[da768a7](/mqttjs/mqtt-packet/pull/8/commits/da768a757e7c92fd009a49c3e991c6ea6cdf0f83)`

```
Fixes a crash that was observed when starting to parse a TLS encrypted stream while assuming to parse plain MQTT data.

So what happened? The TLS connect message that arrived at looked like this:

```
<Buffer 16 03 01 01 01 01 00 00 fd 03 03 00 09 9a 85 fc 19 19 fa 06 a4
8c a5 53 5d 6e c1 01 23 be 68 00 85 b9 0c 29 8b 24 87 30 09 e6 e4 00 00
80 c0 2f c0 2b ... >
```

Note the `16` at the start, this suggests that we have a regular CONNECT packet. The next byte 3 suggests a remaining length of the packet of 3 bytes which is obviously not true, but the implementation of the parser just checks if at least 3 bytes remain in the buffer before it starts processing the payload.

The parseConnect function of the parser now checks the next two bytes `01 01` which would describe the protocol identifier string length. Usually
this would be 4 or 6 bytes, but here we have 257 bytes. So the next 257 bytes are consumed into a string and our parsing pointer is at buffer position 259. Unfortunately, the buffer only has 260 bytes in total. That is the next parsing steps produce an out of range exception..

We obviously have various problems here:

- the parser does not check for plausibility when a string ought to be longer than the packet
- the parser does not check for a valid protocol identifier string at all
- the parser does not check (at some points) if the buffer has remaining length before parsing the next bytes
- the parser does not catch any (further, unexpected) exceptions in order to safe the upper layers from running into bad behavior
```

`[Added a test for string plausibility checking](/mqttjs/mqtt-packet/pull/8/commits/2c5b0cccced6638977dcd22f1ebce51531b3a9d7 "Added a test for string plausibility checking

When a string length within a variable header would exceed the overall
packet length, the string parsing should return an error")`
 …

`[2c5b0cc](/mqttjs/mqtt-packet/pull/8/commits/2c5b0cccced6638977dcd22f1ebce51531b3a9d7)`

```
When a string length within a variable header would exceed the overall
packet length, the string parsing should return an error
```

![mcollina](https://avatars.githubusercontent.com/u/52195?s=60&v=4)

 **[mcollina](/mcollina)**
reviewed
[Jan 14, 2016](#discussion-diff-49797544)
 [View reviewed changes](/mqttjs/mqtt-packet/pull/8/files/2c5b0cccced6638977dcd22f1ebce51531b3a9d7#diff-cefe64a49764e28978f6f3bb48a9f1a40b522725cabb5609ca17de8515749c84)

[parser.js](/mqttjs/mqtt-packet/pull/8/files#diff-cefe64a49764e28978f6f3bb48a9f1a40b522725cabb5609ca17de8515749c84)

|  |  | catch (e) { |
| --- | --- | --- |
|  |  |  |
|  |  | return this.emit('error', e); |
|  |  | } |

Copy link

Member

### @mcollina **[mcollina](/mcollina)** [Jan 14, 2016](#discussion_r49797544)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

try-catch is slow, and this will really slow down everything.

Is this needed in the first place to fix this issue?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @psorowka **[psorowka](/psorowka)** [Jan 14, 2016](#discussion_r49798110)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

No it's not needed. All potental pitfalls i have spotted are checked for explicitely now.

Let's talk about that at another place, we should really introduce a catch *somewhere*, any bug within the processing should only kill the specific client connection and not the whole broker

Sorry, something went wrong.

All reactions

Copy link

Member

### @mcollina **[mcollina](/mcollina)** [Jan 14, 2016](#discussion_r49798878)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

The problem is that *any* try catch will make things slow. Moreover, any exception in node are better to crash the process anyway, as it is hard to know if you are not leaking memory/file descriptor/whatever.

Sorry, something went wrong.

All reactions

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=80&u=1f601542425d1b0d959ece993b2a3243df253c27&v=4)](/psorowka)

Copy link

Contributor

Author

### **[psorowka](/psorowka)** commented [Jan 14, 2016](#issuecomment-171807534)

| will push requested changes tomorrow |
| --- |

All reactions

Sorry, something went wrong.

![mcollina](https://avatars.githubusercontent.com/u/52195?s=60&v=4)

 **[mcollina](/mcollina)**
reviewed
[Jan 14, 2016](#discussion-diff-49798440)
 [View reviewed changes](/mqttjs/mqtt-packet/pull/8/files/2c5b0cccced6638977dcd22f1ebce51531b3a9d7#diff-cefe64a49764e28978f6f3bb48a9f1a40b522725cabb5609ca17de8515749c84)

[parser.js](/mqttjs/mqtt-packet/pull/8/files#diff-cefe64a49764e28978f6f3bb48a9f1a40b522725cabb5609ca17de8515749c84)

|  |  | @@ -163,14 +171,27 @@ Parser.prototype.\_parseConnect = function () { | |
| --- | --- | --- | --- |
|  |  | if (protocolId === null) |
|  |  | return this.emit('error', new Error('cannot parse protocol id')) |
|  |  |  |
|  |  | if (['MQTT', 'MQIsdp'].indexOf(protocolId) < 0) { |

Copy link

Member

### @mcollina **[mcollina](/mcollina)** [Jan 14, 2016](#discussion_r49798440)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

A nice and old `&&` is faster.

Sorry, something went wrong.

All reactions

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [Jan 14, 2016](#issuecomment-171808877)

| Also, would you mind splitting the long explanation among the various tests or complete it for the ones that are missing the explanation? |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [Jan 14, 2016](#issuecomment-171809025)

| Anyway, this is really a **GOOD** catch.  As soon as it lands, I'll backport it to the v3 series, so it will be catched by MQTT.js and Mosca. |
| --- |

All reactions

Sorry, something went wrong.

`[Minor changes and more elaborate test docs](/mqttjs/mqtt-packet/pull/8/commits/38e00e1150656f305836e07ad3a11cc8db69c309 "Minor changes and more elaborate test docs")`

`[38e00e1](/mqttjs/mqtt-packet/pull/8/commits/38e00e1150656f305836e07ad3a11cc8db69c309)`

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=80&u=1f601542425d1b0d959ece993b2a3243df253c27&v=4)](/psorowka)

Copy link

Contributor

Author

### **[psorowka](/psorowka)** commented [Jan 15, 2016](#issuecomment-171886752)

| Okay I have pushed everything |
| --- |

All reactions

Sorry, something went wrong.

`[Removed relict variable assignment](/mqttjs/mqtt-packet/pull/8/commits/6896f3a2809321abe01e7fcd70908d7da30ab139 "Removed relict variable assignment")`

`[6896f3a](/mqttjs/mqtt-packet/pull/8/commits/6896f3a2809321abe01e7fcd70908d7da30ab139)`

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [Jan 15, 2016](#issuecomment-171903355)

| I did that myself :P. This is released as v4.0.4. |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=40&v=4)](/mcollina)
[mcollina](/mcollina)
closed this
[Jan 15, 2016](#event-515922261)

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [Jan 15, 2016](#issuecomment-171904715)

| Also as v3.4.5. |
| --- |

All reactions

Sorry, something went wrong.

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=80&u=1f601542425d1b0d959ece993b2a3243df253c27&v=4)](/psorowka)

Copy link

Contributor

Author

### **[psorowka](/psorowka)** commented [Jan 15, 2016](#issuecomment-171905288)

| By the way, out of curiosity I have added a try/catch block to the benchmark:  ``` var mqtt    = require('../')   , parser  = mqtt.parser()   , max     = 10000000   , i   , start   = Date.now() / 1000   , time  for (i = 0; i < max; i++) {   parser.parse(new Buffer([     48, 10, // Header     0, 4, // Topic length     116, 101, 115, 116, // Topic (test)     116, 101, 115, 116 // Payload (test)   ])) }  console.log('No try/catch'); time = Date.now() / 1000 - start console.log('Total packets', max) console.log('Total time', Math.round(time * 100) / 100) console.log('Packet/s', max / time)  start   = Date.now() / 1000  for (i = 0; i < max; i++) {   try {     parser.parse(new Buffer([       48, 10, // Header       0, 4, // Topic length       116, 101, 115, 116, // Topic (test)       116, 101, 115, 116 // Payload (test)     ]))   }   catch (e) {      console.log(e);   } }  console.log('-----------'); console.log('With try/catch'); time = Date.now() / 1000 - start console.log('Total packets', max) console.log('Total time', Math.round(time * 100) / 100) console.log('Packet/s', max / time)  ```  The result does not suggest a performance dip. Only thing notable is a 15% performance difference between node 0.10 and node 4  *NODE 4*  ``` $ node benchmarks/parse.js  No try/catch Total packets 10000000 Total time 31.13 Packet/s 321192.26504089916 ----------- With try/catch Total packets 10000000 Total time 31.28 Packet/s 319662.436545051  ```  *NODE 0.10*  ``` $ node benchmarks/parse.js  No try/catch Total packets 10000000 Total time 36.96 Packet/s 270533.4921440323 ----------- With try/catch Total packets 10000000 Total time 36.57 Packet/s 273433.2274061726  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@mcollina](https://avatars.githubusercontent.com/u/52195?s=80&v=4)](/mcollina)

Copy link

Member

### **[mcollina](/mcollina)** commented [Jan 15, 2016](#issuecomment-171906701)

| This is actually different from putting it in the same function of a `while`. Performance-wise, putting it in a small function that just wraps another one is ok. |
| --- |

All reactions

Sorry, something went wrong.

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=80&u=1f601542425d1b0d959ece993b2a3243df253c27&v=4)](/psorowka)

Copy link

Contributor

Author

### **[psorowka](/psorowka)** commented [Jan 15, 2016](#issuecomment-171907942)

| i see.. in this case parseStream in mqtt-connection could be a candidate |
| --- |

All reactions

Sorry, something went wrong.

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=80&u=1f601542425d1b0d959ece993b2a3243df253c27&v=4)](/psorowka)

Copy link

Contributor

Author

### **[psorowka](/psorowka)** commented [Jan 15, 2016](#issuecomment-171909003)

| ok just to confirm that, when putting try/catch at the original position I receive `32.79s` for node4 and `42.75s` for node 0.10. So obviously node4 is also in this respect a bit better in optimizing but still slower compared to the first benchmark. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmqttjs%2Fmqtt-packet%2Fpull%2F8)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?s=52&v=4)](/psorowka) [![@mcollina](https://avatars.githubusercontent.com/u/52195?s=52&v=4)](/mcollina)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_550ef726_20250125_185428.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoscajs%2Fmosca%2Fissues%2F393)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoscajs%2Fmosca%2Fissues%2F393)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=moscajs%2Fmosca)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

This repository has been archived by the owner on Feb 11, 2020. It is now read-only.

[moscajs](/moscajs)
/
**[mosca](/moscajs/mosca)**
Public archive

* [Notifications](/login?return_to=%2Fmoscajs%2Fmosca) You must be signed in to change notification settings
* [Fork
  506](/login?return_to=%2Fmoscajs%2Fmosca)
* [Star
   3.2k](/login?return_to=%2Fmoscajs%2Fmosca)

* [Code](/moscajs/mosca)
* [Issues
  114](/moscajs/mosca/issues)
* [Pull requests
  8](/moscajs/mosca/pulls)
* [Actions](/moscajs/mosca/actions)
* [Projects
  0](/moscajs/mosca/projects)
* [Wiki](/moscajs/mosca/wiki)
* [Security](/moscajs/mosca/security)
* [Insights](/moscajs/mosca/pulse)

Additional navigation options

* [Code](/moscajs/mosca)
* [Issues](/moscajs/mosca/issues)
* [Pull requests](/moscajs/mosca/pulls)
* [Actions](/moscajs/mosca/actions)
* [Projects](/moscajs/mosca/projects)
* [Wiki](/moscajs/mosca/wiki)
* [Security](/moscajs/mosca/security)
* [Insights](/moscajs/mosca/pulse)

This repository has been archived by the owner on Feb 11, 2020. It is now read-only.

# Mosca crashes when connecting with TLS on MQTT Port #393

[Jump to bottom](#comment-composer-heading)Copy link[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Mosca crashes when connecting with TLS on MQTT Port](#top)#393Copy link[![@psorowka](https://avatars.githubusercontent.com/u/6883003?u=1f601542425d1b0d959ece993b2a3243df253c27&v=4&size=80)](/psorowka)
## Description

[![@psorowka](https://avatars.githubusercontent.com/u/6883003?u=1f601542425d1b0d959ece993b2a3243df253c27&v=4&size=48)](/psorowka)[psorowka](https://github.com/psorowka)opened [on Jan 14, 2016](https://github.com/moscajs/mosca/issues/393#issue-126683247)

By accident we have found critical behavior in Mosca:

when connecting with a TLS connection on the plain mqtt port, the whole broker simply crashes with error:

```
buffer.js:582
    throw new RangeError('Trying to access beyond buffer length');
          ^
RangeError: Trying to access beyond buffer length
    at checkOffset (buffer.js:582:11)
    at Buffer.readUInt8 (buffer.js:588:5)
    at BufferList.(anonymous function) [as readUInt8] (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/mqtt-packet/node_modules/bl/bl.js:210:58)
    at Parser._parseConnect (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/mqtt-packet/parser.js:176:33)
    at Parser._parsePayload (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/mqtt-packet/parser.js:110:14)
    at Parser.parse (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/mqtt-packet/parser.js:42:48)
    at DestroyableTransform.process [as _transform] (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/lib/parseStream.js:13:12)
    at DestroyableTransform.Transform._read (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/through2/node_modules/readable-stream/lib/_stream_transform.js:184:10)
    at DestroyableTransform.Transform._write (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/through2/node_modules/readable-stream/lib/_stream_transform.js:172:12)
    at doWrite (/home/psorowka/dev/cybus/other/mosca/node_modules/mqtt-connection/node_modules/through2/node_modules/readable-stream/lib/_stream_writable.js:237:10)

```

One-liner to reproduce this behavior (assuming standard mosca running on localhost):

```
require('mqtt').connect('mqtts://localhost:1883');

```

We will dig further into it and provide a PR if we have a fix. Meanwhile we wanted to share the bug in case somebody is quicker in spotting the solution.

## Metadata

### Assignees

No one assigned

### Labels

No labelsNo labels
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


