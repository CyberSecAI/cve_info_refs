=== Content from bugzilla.mozilla.org_902cfff5_20250125_153307.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1268034)
* [XML](/show_bug.cgi?ctype=xml&id=1268034)

Closed
[Bug 1268034](/show_bug.cgi?id=1268034)

Opened 9 years ago
Closed 9 years ago

# Assertion failure: isObject(), at dist/include/js/Value.h:1281

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: isObject(), at dist/include/js/Value.h:1281

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla49

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=unaffected) |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | --- | [verified](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=verified) |
| firefox-esr45 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 |  | unaffected |
| firefox48 |  | wontfix |
| firefox49 |  | verified |
| firefox-esr45 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: gkw, Assigned: arai)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/6b706eda3bfffb0365f10d465e37a53e?d=mm&size=40)  [arai](/user_profile?user_id=310076)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [gkw](/user_profile?user_id=132034)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

11 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[1269074](/show_bug.cgi?id=1269074 "RESOLVED FIXED - Assertion failure: !entry->shape(), at js/src/vm/Shape.cpp:591")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate")

Dependency [tree](/showdependencytree.cgi?id=1268034&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1268034)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: assertion, sec-moderate, testcase, Whiteboard: [jsbugmon:update,ignore][adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[jsbugmon:update,ignore][adv-main49+]

QA Whiteboard:

---

Has STR:

yes

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c56 "9 years ago") | + |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (6 files, 8 obsolete files)

| [Detailed Crash Information](/attachment.cgi?id=8746024)  [9 years ago](#c1)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   42.43 KB, text/plain |  | [Details](/attachment.cgi?id=8746024&action=edit) |
| --- | --- | --- |
| [OOM\_VERBOSE=1 stack from m-c rev ab0044bfa1df](/attachment.cgi?id=8746025)  [9 years ago](#c2)  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)   13.64 KB, text/plain |  | [Details](/attachment.cgi?id=8746025&action=edit) |
| [Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.](/attachment.cgi?id=8746050)  [9 years ago](#c7)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   4.00 KB, patch |  | [Details](/attachment.cgi?id=8746050&action=edit) | [Diff](/attachment.cgi?id=8746050&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746050) |
| [Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.](/attachment.cgi?id=8746056)  [9 years ago](#c8)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   4.38 KB, patch | till : [review+](#c12 "9 years ago") | [Details](/attachment.cgi?id=8746056&action=edit) | [Diff](/attachment.cgi?id=8746056&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746056) |
| [Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.](/attachment.cgi?id=8746079)  [9 years ago](#c10)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   3.93 KB, patch | till : [review+](#c11 "9 years ago") | [Details](/attachment.cgi?id=8746079&action=edit) | [Diff](/attachment.cgi?id=8746079&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079) |
| [(WIP) Part 3: Delete global property when it fails to initialize constructor.](/attachment.cgi?id=8747412)  [9 years ago](#c28)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   2.27 KB, patch | till : [feedback+](#c30 "9 years ago") | [Details](/attachment.cgi?id=8747412&action=edit) | [Diff](/attachment.cgi?id=8747412&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747412) |
| [Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.](/attachment.cgi?id=8747413)  [9 years ago](#c29)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   3.91 KB, patch | till : [review+](#c31 "9 years ago") | [Details](/attachment.cgi?id=8747413&action=edit) | [Diff](/attachment.cgi?id=8747413&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747413) |
| [(plan B, WIP) Part 3: Add GlobalObject::overrideConstructor and use it instead of GlobalObject::setConstructor when overriding.](/attachment.cgi?id=8747501)  [9 years ago](#c36)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   2.80 KB, patch |  | [Details](/attachment.cgi?id=8747501&action=edit) | [Diff](/attachment.cgi?id=8747501&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747501) |
| [(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.](/attachment.cgi?id=8747502)  [9 years ago](#c37)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   9.25 KB, patch |  | [Details](/attachment.cgi?id=8747502&action=edit) | [Diff](/attachment.cgi?id=8747502&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747502) |
| [(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.](/attachment.cgi?id=8747525)  [9 years ago](#c38)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   9.15 KB, patch |  | [Details](/attachment.cgi?id=8747525&action=edit) | [Diff](/attachment.cgi?id=8747525&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747525) |
| [WIP: Delay modifying global constructor/prototype slots for classes other than Function and Object.](/attachment.cgi?id=8748505)  [9 years ago](#c42)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   6.63 KB, patch |  | [Details](/attachment.cgi?id=8748505&action=edit) | [Diff](/attachment.cgi?id=8748505&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8748505) |
| [Part 3: Create CreateArrayFromBuffer function on demand.](/attachment.cgi?id=8749363)  [9 years ago](#c46)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   3.32 KB, patch | jorendorff : [review+](#c49 "9 years ago") | [Details](/attachment.cgi?id=8749363&action=edit) | [Diff](/attachment.cgi?id=8749363&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749363) |
| [(WIP) Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.](/attachment.cgi?id=8749365)  [9 years ago](#c47)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   6.40 KB, patch |  | [Details](/attachment.cgi?id=8749365&action=edit) | [Diff](/attachment.cgi?id=8749365&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749365) |
| [Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.](/attachment.cgi?id=8753911)  [9 years ago](#c53)  [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)   6.33 KB, patch | jorendorff : [review+](#c54 "9 years ago") | [Details](/attachment.cgi?id=8753911&action=edit) | [Diff](/attachment.cgi?id=8753911&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8753911) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1268034#c0)• 9 years ago |
|  | |

The following testcase crashes on mozilla-central revision ab0044bfa1df (build with --enable-debug --enable-more-deterministic, run with --fuzzing-safe --ion-offthread-compile=off --no-baseline --no-ion):
// Adapted from randomly chosen test: js/src/jit-test/tests/basic/[bug1236476](/show_bug.cgi?id=1236476 "RESOLVED FIXED - Assertion failure: message, at js/src/jscntxt.cpp:818 with OOM").js
oomTest(function() {
offThreadCompileScript("");
});
// jsfunfuzz-generated
"".match();
Backtrace:
For detailed crash information, see attachment.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1268034#c1)• 9 years ago |
|  | |

Attached file
[Detailed Crash Information](attachment.cgi?id=8746024)
— [Details](attachment.cgi?id=8746024&action=edit)

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1268034#c2)• 9 years ago |
|  | |

Attached file
[OOM\_VERBOSE=1 stack from m-c rev ab0044bfa1df](attachment.cgi?id=8746025)
— [Details](attachment.cgi?id=8746025&action=edit)

Not sure if this OOM\_VERBOSE=1 stack is relevant.

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1268034#c3)• 9 years ago |
|  | |

autoBisect shows this is probably related to the following changeset:
The first bad revision is:
changeset: <https://hg.mozilla.org/mozilla-central/rev/b5b06959919a>
user: Tooru Fujisawa
date: Sat Sep 05 21:55:06 2015 +0900
summary: [Bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate") - Part 9: Implement RegExp.prototype[@@match] and call it from String.prototype.match. r=till
arai-san, is [bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate") a likely regressor?Blocks: [887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate")Flags: needinfo?(arai.unmht)

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1268034#c4)• 9 years ago |
|  | |

Thread 0 Crashed:: Dispatch queue: com.apple.main-thread
0 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x0000000100022c8d JS::Value::toObject() const + 189 (Value.h:1281)
1 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x000000010004072c js::RegExpPrototypeOptimizable(JSContext\*, unsigned int, JS::Value\*) + 76 (Value.h:1765)
2 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x00000001007e3e6e js::CallJSNative(JSContext\*, bool (\*)(JSContext\*, unsigned int, JS::Value\*), JS::CallArgs const&) + 222 (jscntxtinlines.h:236)
3 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x00000001007d43fe js::InternalCallOrConstruct(JSContext\*, JS::CallArgs const&, js::MaybeConstruct) + 702 (Interpreter.cpp:468)
4 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x00000001007c9342 Interpret(JSContext\*, js::RunState&) + 48322 (Interpreter.cpp:2831)
5 js-dbg-64-dm-clang-darwin-ab0044bfa1df 0x00000001007bd5b7 js::RunScript(JSContext\*, js::RunState&) + 519 (Interpreter.cpp:426)
/snip

|  | [Benjamin Bouvier [:bbouvier] (inactive)](/user_profile?user_id=468907) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1268034#c5)• 9 years ago |
|  | |

arai asked to mark it as s-sGroup: core-security

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1268034#c6)• 9 years ago |
|  | |

Thanks :)
This is similar case as `initStringClass`, that happens in [bug 1263558](/show_bug.cgi?id=1263558 "RESOLVED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281").
<https://hg.mozilla.org/integration/mozilla-inbound/rev/b1e8dbf2f4c92666991b0a026dfbc8fa0fa26826>
This time it happens in `GlobalObject::resolveConstructor`.
<https://dxr.mozilla.org/mozilla-central/rev/fc15477ce628599519cb0055f52cc195d640dc94/js/src/vm/GlobalObject.cpp#224>
> global->setConstructor(key, ObjectValue(\*ctor));
> global->setConstructorPropertySlot(key, ObjectValue(\*ctor));
>
> // Define any specified functions and properties, unless we're a dependent
> // standard class (in which case they live on the prototype), or we're
> // operating on the self-hosting global, in which case we don't want any
> // functions and properties on the builtins and their prototypes.
> if (!StandardClassIsDependent(key) && !cx->runtime()->isSelfHostingGlobal(global)) {
> if (const JSFunctionSpec\* funs = clasp->specPrototypeFunctions()) {
> if (!JS\_DefineFunctions(cx, proto, funs))
> return false;
> }
There, `GlobalObject::setConstructor` is called but the code after that may return with failure on OOM. In that case, the constructor's `prototype` property is left `undefined`, and `RegExpProto` in the following code becomes `undefined`.
<https://dxr.mozilla.org/mozilla-central/rev/fc15477ce628599519cb0055f52cc195d640dc94/js/src/builtin/String.js#16>
> function IsStringMatchOptimizable() {
> var RegExpProto = GetBuiltinPrototype("RegExp");
> // If RegExpPrototypeOptimizable succeeds, `exec` and `@@match` are
> // guaranteed to be data properties.
> return RegExpPrototypeOptimizable(RegExpProto) &&
> RegExpProto.exec === RegExp\_prototype\_Exec &&
> RegExpProto[std\_match] === RegExpMatch;
> }
Then, this time, we cannot move `setConstructor` after defining properties.
In JSProto\_Function's case, `Function` constructor is referred from `JS\_DefineFunctions`, so we should call `setConstructor` \*before\* it to make it accessible.
Thus, we should reset constructor slot when any of operations \*after\* `setConstructor` fails.Flags: needinfo?(arai.unmht)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1268034#c7)• 9 years ago |
|  | |

Attached patch

[Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.](attachment.cgi?id=8746050&action=diff) (obsolete)
— [Details](attachment.cgi?id=8746050&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746050)

Changed all "return false" after `setConstructor` to "goto failedAfterSetConstructor", and in `failedAfterSetConstructor:` label, there `setConstructor` and `setConstructorPropertySlot` are called with `UndefinedValue()`, so that `resolveConstructor` will be called again on next time.Assignee: nobody → arai.unmht
[Attachment #8746050](/attachment.cgi?id=8746050&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: review?(till)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1268034#c8)• 9 years ago |
|  | |

Attached patch

[Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.](attachment.cgi?id=8746056&action=diff)
— [Details](attachment.cgi?id=8746056&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746056)

Also, there are some more cases that setConstructor and initBuiltinConstructor are called before defining properties.
[Attachment #8746056](/attachment.cgi?id=8746056&action=edit "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") -
Flags: review?(till)

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1268034#c9)• 9 years ago |
|  | |

Comment on [attachment 8746050](/attachment.cgi?id=8746050 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746050&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746050&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746050)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
Review of [attachment 8746050](/attachment.cgi?id=8746050 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746050&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746050&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746050):
-----------------------------------------------------------------
Hmm, do we need to use goto here? Can't we not move all the code that contains the gotos into a new function and do "if (!foo(..)) {do the reset stuff; return false;} else {return true;}?
[Attachment #8746050](/attachment.cgi?id=8746050&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: review?(till)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1268034#c10)• 9 years ago |
|  | |

Attached patch

[Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.](attachment.cgi?id=8746079&action=diff)
— [Details](attachment.cgi?id=8746079&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)

Thank you for prompt response!
Changed it to a function. Do you know any nice shorter name for the function?
[Attachment #8746050](/attachment.cgi?id=8746050&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Attachment is obsolete: true
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: review?(till)

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1268034#c11)• 9 years ago |
|  | |

Comment on [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
Review of [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079):
-----------------------------------------------------------------
Thanks, that looks much better. The name is not fantastic, but I can't think of anything better there, so let's keep it.
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: review?(till) → review+

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1268034#c12)• 9 years ago |
|  | |

Comment on [attachment 8746056](/attachment.cgi?id=8746056 "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[details]](/attachment.cgi?id=8746056&action=edit "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[diff]](/attachment.cgi?id=8746056&action=diff "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746056)
Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.
Review of [attachment 8746056](/attachment.cgi?id=8746056 "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[details]](/attachment.cgi?id=8746056&action=edit "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[diff]](/attachment.cgi?id=8746056&action=diff "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746056):
-----------------------------------------------------------------
r=me
[Attachment #8746056](/attachment.cgi?id=8746056&action=edit "Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function.") -
Flags: review?(till) → review+

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1268034#c13)• 9 years ago |
|  | |

Comment on [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
Thank you for reviewing :D
> [Security approval request comment]
> How easily could an exploit be constructed based on the patch?
This particular case (the testcase in [comment #0](/show_bug.cgi?id=1268034#c0 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281")) is not so easy, as it's just a null dereference, and it also needs testing functions that are not exposed to web content.
For underlying issue, I think everything else would also be a null dereference too, but I'm not sure how widely the issue affects.
> Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?
The testcase describes how to cause crash, but with testing functions.
> Which older supported branches are affected by this flaw?
This particular flaw affects mozilla49 (nightly) and mozilla48 (aurora).
The underlying issue affects all branches.
> If not all supported branches, which bug introduced the flaw?
[bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate") (mozilla48)
> Do you have backports for the affected branches? If not, how different, hard to create, and risky will they be?
Not yet, but it should be easily created.
Also, whole patches related to [bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate") will be backed out from aurora in [bug 1265307](/show_bug.cgi?id=1265307 "RESOLVED FIXED - Delay selfhosting regexp and ES6 regexp conformity for a release") anyway.
> How likely is this patch to cause regressions; how much testing does it need?
Less likely. Automated tests should be able to catch anything happens.
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: sec-approval?

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1268034#c14)• 9 years ago |
|  | |

If this is just a null dereference, why are you asking for sec-approval?
This bug needs a security rating but null dereferences are not normally sec-high or sec-critical, which are the only rating that require security approvals. I assume that this is a sec-low if it really is just a null dereference.
<https://wiki.mozilla.org/Security/Bug_Approval_Process>
[status-firefox47](/buglist.cgi?f1=cf_status_firefox47&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=unaffected)
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected)Flags: needinfo?(dveditz)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a124264_1689)• 9 years ago |

Flags: needinfo?(dveditz)Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1268034#c15)• 9 years ago |
|  | |

Comment on [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
Thanks!
clearing sec-approval. will land them shortly.
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: sec-approval?

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1268034#c16)• 9 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/d31171af48e4fe4e0e35e6e96b4c76504a7ee091>
[Bug 1268034](/show_bug.cgi?id=1268034 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") - Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor. r=till
<https://hg.mozilla.org/integration/mozilla-inbound/rev/05c1151be7a7821136263bb46d887bf8e99ce64d>
[Bug 1268034](/show_bug.cgi?id=1268034 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") - Part 2: Call setConstructor and initBuiltinConstructor after defining properties in all init function. r=till

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1268034#c17)• 9 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/d31171af48e4>
<https://hg.mozilla.org/mozilla-central/rev/05c1151be7a7>Status: NEW → RESOLVEDClosed: 9 years ago
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla49

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a201092_469204)• 9 years ago |

Status: RESOLVED → VERIFIED
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=verified)

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1268034#c18)• 9 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1268034#c19)• 9 years ago |
|  | |

Comment on [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
same patches are applicable to mozilla-aurora
Approval Request Comment
> [Feature/regressing bug #]
[bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate") exposed the issue, but underlying issue exists from old branches.
> [User impact if declined]
Unnecessary crash when hitting potentially-recoverable OOM, by opening certain web page.
> [Describe test coverage new/current, TreeHerder]
Tested in mozilla-central automated test.
> [Risks and why]
Low. Added recover code path for OOM.
> [String/UUID change made/needed]
None
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: approval-mozilla-aurora?

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a224589_132034)• 9 years ago |

Depends on: [1269074](/show_bug.cgi?id=1269074 "RESOLVED FIXED - Assertion failure: !entry->shape(), at js/src/vm/Shape.cpp:591")

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1268034#c20)• 9 years ago |
|  | |

Comment on [attachment 8746079](/attachment.cgi?id=8746079 "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8746079&action=diff "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8746079)
Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.
withdrawing approval, due to [bug 1269074](/show_bug.cgi?id=1269074 "RESOLVED FIXED - Assertion failure: !entry->shape(), at js/src/vm/Shape.cpp:591").
[Attachment #8746079](/attachment.cgi?id=8746079&action=edit "Part 1: Reset constructor slot of GlobalObject to undefined when it fails to initialize constructor.") -
Flags: approval-mozilla-aurora?

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1268034#c21)• 9 years ago |
|  | |

So, we should do some more steps to rollback \*all\* operations done in GlobalObject::resolveConstructor when it fails.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1268034#c22)• 9 years ago |
|  | |

at least, the following step should be rolled back, or skipped on the 2nd time
> if (clasp->specShouldDefineConstructor()) {
> if (!global->addDataProperty(cx, id, constructorPropertySlot(key), 0))
> return false;
> }
Also, the following should also be rolled back, as the prototype properties are not yet initialized.
> global->setPrototype(key, ObjectValue(\*proto));

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1268034#c23)• 9 years ago |
|  | |

and now I'm wondering if it's really recoverable.
Could it be possible that each hook (specCreateConstructorHook, specFinishInitHook) do un-recoverable operation?

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1268034#c24)• 9 years ago |
|  | |

for example, FinishObjectClassInit defines property on global object.
<https://dxr.mozilla.org/mozilla-central/rev/8c3fd523d75bd30f691ca2d6cfdad18d576392a1/js/src/builtin/Object.cpp#1194>
this specific case could be ignored tho, I'm not sure if other (and future) cases are also recoverable.
should we reduce the target of recover operation?
or perhaps, should we throw away the assumption that constructor/prototype are initialized properly, especially even if the property is non-configurable? (I hope not...)
till, can I have your opinion for [comment #21](/show_bug.cgi?id=1268034#c21 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281")-#23, and [bug 1269074](/show_bug.cgi?id=1269074 "RESOLVED FIXED - Assertion failure: !entry->shape(), at js/src/vm/Shape.cpp:591")'s case?Flags: needinfo?(till)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a231518_310076)• 9 years ago |

Status: VERIFIED → REOPENEDResolution: FIXED → ---

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a231865_469204)• 9 years ago |

Whiteboard: [jsbugmon:update] → [jsbugmon:update,ignore]

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1268034#c25)• 9 years ago |
|  | |

JSBugMon: The testcase found in this bug no longer reproduces (tried revision 2b7c421063ad).

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1268034#c26)• 9 years ago |
|  | |

So, the issue initially hit with this not-properly-initialized constructor object was [bug 1263558](/show_bug.cgi?id=1263558 "RESOLVED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"), there String.prototype was undefined.
and this bug is that RegExp.prototype was undefined.
we didn't check them because of the following assumption:
"prototype" property should always be a prototype object for each constructor, because "prototype" property is non-configurable data property
But if constructor/prototype initialization can fail with OOM and can leave something partially-initialized, those assumption breaks. This is also true for all other non-configurable properties if any (will check the spec).
Now we're going to rollback the initialization to make those partially-initialized object not-accessible from other code, and then perform the initialization again on the next time when the constructor/prototype is accessed.
So, those initialization operation should be able to be performed more than once, until the initialization completes without any error.
I'm not sure if that rule can be maintained...

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1268034#c27)• 9 years ago |
|  | |

In addition to "prototype" property, the following properties are non-configurable.
Function.prototype[@@hasInstance]
Symbol.hasInstance
Symbol.isConcatSpreadable
Symbol.iterator
Symbol.match
Symbol.prototype
Symbol.replace
Symbol.search
Symbol.species
Symbol.split
Symbol.toPrimitive
Symbol.toStringTag
Symbol.unscopables
Number.EPSILON
Number.MAX\_SAFE\_INTEGER
Number.MAX\_VALUE
Number.MIN\_SAFE\_INTEGER
Number.MIN\_VALUE
Number.NaN
Number.NEGATIVE\_INFINITY
Number.POSITIVE\_INFINITY
Math.E
Math.LN10
Math.LN2
Math.LOG10E
Math.LOG2E
Math.PI
Math.SQRT1\_2
Math.SQRT2
%TypedArray%.BYTES\_PER\_ELEMENT
%TypedArray%.prototype.BYTES\_PER\_ELEMENT
and Function and TypedArray uses InitViaClassSpec.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1268034#c28)• 9 years ago |
|  | |

Attached patch

[(WIP) Part 3: Delete global property when it fails to initialize constructor.](attachment.cgi?id=8747412&action=diff) (obsolete)
— [Details](attachment.cgi?id=8747412&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747412)

In case we should go with current approach, here's the patch that removes the constructor property from global object, so that the property is not in the global object's shape on the next time.
NativeDeleteProperty is fallible, and in failure case we cannot recover anymore, added MOZ\_CRASH there but I'm not sure what's the best way there...
[Attachment #8747412](/attachment.cgi?id=8747412&action=edit "(WIP) Part 3: Delete global property when it fails to initialize constructor.") -
Flags: feedback?(till)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1268034#c29)• 9 years ago |
|  | |

Attached patch

[Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.](attachment.cgi?id=8747413&action=diff) (obsolete)
— [Details](attachment.cgi?id=8747413&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747413)

and one more patch to reset prototype slot of global object on failure case.
[Attachment #8747413](/attachment.cgi?id=8747413&action=edit "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") -
Flags: review?(till)

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1268034#c30)• 9 years ago |
|  | |

Comment on [attachment 8747412](/attachment.cgi?id=8747412 "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8747412&action=edit "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8747412&action=diff "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747412)
(WIP) Part 3: Delete global property when it fails to initialize constructor.
Review of [attachment 8747412](/attachment.cgi?id=8747412 "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[details]](/attachment.cgi?id=8747412&action=edit "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[diff]](/attachment.cgi?id=8747412&action=diff "(WIP) Part 3: Delete global property when it fails to initialize constructor.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747412):
-----------------------------------------------------------------
r=me
[Attachment #8747412](/attachment.cgi?id=8747412&action=edit "(WIP) Part 3: Delete global property when it fails to initialize constructor.") -
Flags: feedback?(till) → feedback+

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1268034#c31)• 9 years ago |
|  | |

Comment on [attachment 8747413](/attachment.cgi?id=8747413 "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[details]](/attachment.cgi?id=8747413&action=edit "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[diff]](/attachment.cgi?id=8747413&action=diff "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747413)
Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.
Review of [attachment 8747413](/attachment.cgi?id=8747413 "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[details]](/attachment.cgi?id=8747413&action=edit "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[diff]](/attachment.cgi?id=8747413&action=diff "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747413):
-----------------------------------------------------------------
r=me
[Attachment #8747413](/attachment.cgi?id=8747413&action=edit "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") -
Flags: review?(till) → review+

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1268034#c32)• 9 years ago |
|  | |

Thank you for reviewing :)
Now checking each hook.
so far, CreateFunctionPrototype cannot be executed twice...
<https://dxr.mozilla.org/mozilla-central/rev/1461a4071341c282afcf7b72e33036412d2251d4/js/src/jsfun.cpp#832>
> static JSObject\*
> CreateFunctionPrototype(JSContext\* cx, JSProtoKey key)
> {
> Rooted<GlobalObject\*> self(cx, cx->global());
> ...
> self->setThrowTypeError(throwTypeError);
<https://dxr.mozilla.org/mozilla-central/rev/1461a4071341c282afcf7b72e33036412d2251d4/js/src/vm/GlobalObject.h#151>
> void setThrowTypeError(JSFunction\* fun) {
> MOZ\_ASSERT(getSlotRef(THROWTYPEERROR).isUndefined());
> setSlot(THROWTYPEERROR, ObjectValue(\*fun));
> }
The assertion fails.
This could happen in the following case:
1. resolve Function constructor
2. call createPrototype hook (CreateFunctionPrototype)
3. OOM happens while defining prototype property
4. tries to rollback, reset constructor slot (Part 1)
5. resolve Function constructor because constructor slot is undefined
6. call createPrototype hook (CreateFunctionPrototype) again
So we may need extra function to rollback each hook, or detect the 2nd execution inside each hook.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1268034#c33)• 9 years ago |
|  | |

Also TypedArray's finishClassInit cannot be executed twice.
> static bool
> finishClassInit(JSContext\* cx, HandleObject ctor, HandleObject proto)
> {
> ....
> cx->global()->setCreateArrayFromBuffer<NativeType>(fun);
> return true;
> }
> void setCreateArrayFromBufferHelper(uint32\_t slot, Handle<JSFunction\*> fun) {
> MOZ\_ASSERT(getSlotRef(slot).isUndefined());
> setSlot(slot, ObjectValue(\*fun));
> }
the assertion fails.
Object's FinishObjectClassInit seems to be also problematic.
> static bool
> FinishObjectClassInit(JSContext\* cx, JS::HandleObject ctor, JS::HandleObject proto)
> {
> ...
> global->setOriginalEval(evalobj);
> ...
> if (global->shouldSplicePrototype(cx)) {
> if (!global->splicePrototype(cx, global->getClass(), tagged))
> return false;
> }
> void setOriginalEval(JSObject\* evalobj) {
> MOZ\_ASSERT(getSlotRef(EVAL).isUndefined());
> setSlot(EVAL, ObjectValue(\*evalobj));
> }
the assertion in setOriginalEval fails.
> bool
> JSObject::shouldSplicePrototype(JSContext\* cx)
> {
> /\*
> \* During bootstrapping, if inference is enabled we need to make sure not
> \* to splice a new prototype in for Function.prototype or the global
> \* object if their \_\_proto\_\_ had previously been set to null, as this
> \* will change the prototype for all other objects with the same type.
> \*/
> if (getProto() != nullptr)
> return false;
> return isSingleton();
> }
I suppose `getProto() != nullptr` is different on 1st and 2nd execution.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1268034#c34)• 9 years ago |
|  | |

now I'm thinking another way.
Can't we invalidate the global once constructor/prototype initialization fails with OOM?
like, setting yet another value to the constructor/prototype slot (maybe, a magic value?), and detect it and throw InternalError every time the script (or the internal) tries to access it.
So that we won't use the partially-initialized constructor/prototype anywhere, and we won't execute resolveConstructor twice.
of course the global cannot execute any of script from there, but it happens only when it hit OOM.
I feel it's safer than trying to recover from OOM.
(of course we have to make sure that it won't fall into infinite loop of throwing error tho)

|  | [Till Schneidereit [:till]](/user_profile?user_id=292831) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1268034#c35)• 9 years ago |
|  | |

Bah, very annoying. I'm not sure the proposed solution really works. Perhaps at this point we should prevent all script execution in the affected global? I think we have the infrastructure for that.
Needinfo'ing jorendorff because I can't think of a good solution here that isn't somewhat radical.Flags: needinfo?(till) → needinfo?(jorendorff)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1268034#c36)• 9 years ago |
|  | |

Attached patch

[(plan B, WIP) Part 3: Add GlobalObject::overrideConstructor and use it instead of GlobalObject::setConstructor when overriding.](attachment.cgi?id=8747501&action=diff) (obsolete)
— [Details](attachment.cgi?id=8747501&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747501)

WIP patches for the [comment #34](/show_bug.cgi?id=1268034#c34 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") idea, based on backing out Part 1.
First, Part 3 adds GlobalObject::overrideConstructor to distinguish between "newly setting constructor" and "overriding existing constructor".

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1268034#c37)• 9 years ago |
|  | |

Attached patch

[(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.](attachment.cgi?id=8747502&action=diff) (obsolete)
— [Details](attachment.cgi?id=8747502&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747502)

Then, Part 4 adds new magic value to mark constructor/prototype slot that initialization is failed before.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1268034#c38)• 9 years ago |
|  | |

Attached patch

[(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.](attachment.cgi?id=8747525&action=diff) (obsolete)
— [Details](attachment.cgi?id=8747525&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8747525)

forgot to refresh the patch
[Attachment #8747502](/attachment.cgi?id=8747502&action=edit "(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.") -
Attachment is obsolete: true

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a435545_1689)• 9 years ago |

Group: core-security → javascript-core-security

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1268034#c39)• 9 years ago |
|  | |

The list of non-configurable properties does not seem like a problem to me. Math.PI, for example - what exactly can go wrong there?
The problem with the GlobalObject's prototypes and constructors is serious. If possible, we should always create the prototype-constructor pair and fully populate it before storing those objects in the GlobalObject. The property should be defined, and the reserved slots should be populated, only after everything else has succeeded. That way there is nothing to roll back on failure.
Arai, if I fix the %%ObjectPrototype%% and %%FunctionPrototype%% initialization, can the rest be fixed as described above?Flags: needinfo?(jorendorff) → needinfo?(arai.unmht)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1268034#c40)• 9 years ago |
|  | |

(In reply to Jason Orendorff [:jorendorff] from [comment #39](/show_bug.cgi?id=1268034#c39 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"))
> The list of non-configurable properties does not seem like a problem to me.
> Math.PI, for example - what exactly can go wrong there?
just wanted to list up possibly affected properties. if they're not problem, we just have to worry about 'prototype' property :)
Indeed, most of them won't be a problem, as those are really constants, and self-hosted code doesn't use those properties but global variables or macro like std\_iterator or MAX\_\*.
> The problem with the GlobalObject's prototypes and constructors is serious.
> If possible, we should always create the prototype-constructor pair and
> fully populate it before storing those objects in the GlobalObject. The
> property should be defined, and the reserved slots should be populated, only
> after everything else has succeeded. That way there is nothing to roll back
> on failure.
Yeah, if it's possible, it should be much better solution than rollback or invalidate.
> Arai, if I fix the %%ObjectPrototype%% and %%FunctionPrototype%%
> initialization, can the rest be fixed as described above?
Will investigate it shortly.
Thanks!

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=1268034#c41)• 9 years ago |
|  | |

For other cases than Function/Object, the issue is that the number of fallible operations that modifies global object, and we may have to perform small-rollback on failure case, or skip them on 2nd exection.
Here's the list of operations that modifies global object, done in resolveConstructor:
fallible
global->addDataProperty(cx, id, constructorPropertySlot(key), 0)
finishInit(cx, ctor, proto)
infallible
global->setConstructor(key, ObjectValue(\*ctor));
global->setConstructorPropertySlot(key, ObjectValue(\*ctor));
global->setPrototype(key, ObjectValue(\*proto));
AddTypePropertyId(cx, global, id, ObjectValue(\*ctor));
finishInit may modify global object (TypedArray's and Object's case, see [comment #32](/show_bug.cgi?id=1268034#c32 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281")), and there could be more than 1 operations inside.
for TypedArray's case, setCreateArrayFromBuffer itself is infallible, but other operations there (DefineProperty, NewNativeFunction) are fallible. Anyway, as long as there are fallible operations inside finishInit, there is no good ordering between finishInit and addDataProperty, that can avoid rollback or skip.
So, we should do either:
a) rollback addDataProperty when finishInit fails
b) do not perform addDataProperty on 2nd execution (but assert that it has exactly same property)
Also, if finishInit itself may contain more than 1 fallible operations that modifies global object, finishInit should handle the failure case.Flags: needinfo?(arai.unmht)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=1268034#c42)• 9 years ago |
|  | |

Attached patch

[WIP: Delay modifying global constructor/prototype slots for classes other than Function and Object.](attachment.cgi?id=8748505&action=diff) (obsolete)
— [Details](attachment.cgi?id=8748505&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8748505)

Here's WIP patch that modifies global slots/properties after populating/linking constructor/prototypes, for non-Function/Object.
It passes jstests and jittest, so I think everything else than Function/Object can be fixed with this way.
[Attachment #8747412](/attachment.cgi?id=8747412&action=edit "(WIP) Part 3: Delete global property when it fails to initialize constructor.") -
Attachment is obsolete: true
[Attachment #8747413](/attachment.cgi?id=8747413&action=edit "Part 4: Reset prototype slot of GlobalObject to undefined when it fails to initialize prototype.") -
Attachment is obsolete: true
[Attachment #8747501](/attachment.cgi?id=8747501&action=edit "(plan B, WIP) Part 3: Add GlobalObject::overrideConstructor and use it instead of GlobalObject::setConstructor when overriding.") -
Attachment is obsolete: true
[Attachment #8747525](/attachment.cgi?id=8747525&action=edit "(plan B, WIP) Part 4: Mark constructor/prototype slot when initialization failed with OOM.") -
Attachment is obsolete: true

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=1268034#c43)• 9 years ago |
|  | |

I think the part of typed arrays' finishClassInit hook that modifies the global object should be removed.
Instead, at the point in fromBufferWithProto where it calls cx->global()->createArrayFromBuffer<NativeType>, it should create that function on demand, and cache it on success.

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=1268034#c44)• 9 years ago |
|  | |

finishClassInit might be a bad design to begin with. The way to do a complex fallible operation is to do as much work as possible in isolation, then make it public ("commit" it) in a single step. (cf. transactions)
So having a fallible hook that's called \*after\* class initialization is committed (by defining a global property) is questionable.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=1268034#c45)• 9 years ago |
|  | |

(In reply to Jason Orendorff [:jorendorff] from [comment #43](/show_bug.cgi?id=1268034#c43 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"))
> I think the part of typed arrays' finishClassInit hook that modifies the
> global object should be removed.
>
> Instead, at the point in fromBufferWithProto where it calls
> cx->global()->createArrayFromBuffer<NativeType>, it should create that
> function on demand, and cache it on success.
Okay, will fix it first.
(In reply to Jason Orendorff [:jorendorff] from [comment #44](/show_bug.cgi?id=1268034#c44 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"))
> finishClassInit might be a bad design to begin with. The way to do a complex
> fallible operation is to do as much work as possible in isolation, then make
> it public ("commit" it) in a single step. (cf. transactions)
>
> So having a fallible hook that's called \*after\* class initialization is
> committed (by defining a global property) is questionable.
There are 2 kind of things done in finishInit hook,
A) modifies constructor or prototype object
B) modifies global object
and (A) won't be a problem, and it will make things easier,
also it can be done as a part of constructor/prototype initialization.
So, how about reducing the things can be done in finishInit hook only to (A) ?
Here's the list of things done in each prototype's finishInit hook.
Object -- FinishObjectClassInit
(B) defines global.eval
(B) stores the original eval function to global (global->setOriginalEval)
(B) install the intrinsics holder to global (GlobalObject::getIntrinsicsHolder)
(B) splice global object's prototype (global->splicePrototype)
Array -- array\_proto\_finish
(A) defines Array.prototype[@@unscopables]
Date -- FinishDateClassInit
(A) defines Date.prototype.toUTCString
(A) defines Date.prototype.toGMTString
TypedArray -- \_type##Array::finishClassInit
(A) defines ctor.BYTES\_PER\_ELEMENT
(A) defines ctor.prototype.BYTES\_PER\_ELEMENT
(B) creates `CreateArrayFromBuffer` function and stores it to global (cx->global()->setCreateArrayFromBuffer)
=> move to other place
SavedFrame -- SavedFrame::finishSavedFrameInit
(A) stores NullValue to SavedFrame.prototype's SavedFrame::JSSLOT\_SOURCE slot
(A) freezes SavedFrame.prototype
Once TypedArray's case is fixed, Object's case is only the remaining issue, and I think it should be done in different place than finishInit hook, as most of them are not related to Object prototype itself, but just a dependencies.

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=1268034#c46)• 9 years ago |
|  | |

Attached patch

[Part 3: Create CreateArrayFromBuffer function on demand.](attachment.cgi?id=8749363&action=diff)
— [Details](attachment.cgi?id=8749363&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749363)

Moved ArrayBufferObject::createTypedArrayFromBuffer function creation to dedicated function, that is called when invoking it.
`!getSlot(slot).isUndefined()` assertion in GlobalObjectGlobalObject:createArrayFromBufferHelper is removed as we need to access it to check if it's cached or not.
[Attachment #8749363](/attachment.cgi?id=8749363&action=edit "Part 3: Create CreateArrayFromBuffer function on demand.") -
Flags: review?(jorendorff)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=1268034#c47)• 9 years ago |
|  | |

Attached patch

[(WIP) Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.](attachment.cgi?id=8749365&action=diff) (obsolete)
— [Details](attachment.cgi?id=8749365&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749365)

now finishInit hook doesn't modify global for non-Object case.
moved it to initialization.
[Attachment #8748505](/attachment.cgi?id=8748505&action=edit "WIP: Delay modifying global constructor/prototype slots for classes other than Function and Object.") -
Attachment is obsolete: true

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=1268034#c48)• 9 years ago |
|  | |

Thank you for the list in [comment 45](/show_bug.cgi?id=1268034#c45 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"). That's great work.

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 49](/show_bug.cgi?id=1268034#c49)• 9 years ago |
|  | |

Comment on [attachment 8749363](/attachment.cgi?id=8749363 "Part 3: Create CreateArrayFromBuffer function on demand.") [[details]](/attachment.cgi?id=8749363&action=edit "Part 3: Create CreateArrayFromBuffer function on demand.") [[diff]](/attachment.cgi?id=8749363&action=diff "Part 3: Create CreateArrayFromBuffer function on demand.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749363)
Part 3: Create CreateArrayFromBuffer function on demand.
Review of [attachment 8749363](/attachment.cgi?id=8749363 "Part 3: Create CreateArrayFromBuffer function on demand.") [[details]](/attachment.cgi?id=8749363&action=edit "Part 3: Create CreateArrayFromBuffer function on demand.") [[diff]](/attachment.cgi?id=8749363&action=diff "Part 3: Create CreateArrayFromBuffer function on demand.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8749363):
-----------------------------------------------------------------
r=me. Thanks!
[Attachment #8749363](/attachment.cgi?id=8749363&action=edit "Part 3: Create CreateArrayFromBuffer function on demand.") -
Flags: review?(jorendorff) → review+

|  | [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)  Reporter |  |
| --- | --- | --- |
| [Comment 50](/show_bug.cgi?id=1268034#c50)• 9 years ago |
|  | |

Arai-san, what's next here?Flags: needinfo?(arai.unmht)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 51](/show_bug.cgi?id=1268034#c51)• 9 years ago |
|  | |

Thank you for reminder :)
So, the already-confirmed issues (RegExp and String prototypes) can be fixed by, backing out Part 1, and landing Part 3 and Part 4 (it needs cleanup tho),
but it leaves the issue on Object and Function prototypes.
jorendorff, what's your plan about Object and Function prototypes, regarding [comment #39](/show_bug.cgi?id=1268034#c39 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") ?
can these be left for now?Flags: needinfo?(arai.unmht) → needinfo?(jorendorff)

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 52](/show_bug.cgi?id=1268034#c52)• 9 years ago |
|  | |

If you can land a fix for everything else, land it.
Fixing Object and Function startup is a lot more work. I have a partial patch, but no time to work on it.Flags: needinfo?(jorendorff)

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 53](/show_bug.cgi?id=1268034#c53)• 9 years ago |
|  | |

Attached patch

[Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.](attachment.cgi?id=8753911&action=diff)
— [Details](attachment.cgi?id=8753911&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8753911)

Thanks :)
Reduced duplicated code.
This patch changes the order of initialization for non-Object/Function, and do operations that modifies global object after all other things.
[Attachment #8749365](/attachment.cgi?id=8749365&action=edit "(WIP) Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") -
Attachment is obsolete: true
[Attachment #8753911](/attachment.cgi?id=8753911&action=edit "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") -
Flags: review?(jorendorff)

|  | [Jason Orendorff [:jorendorff]](/user_profile?user_id=281791) |  |
| --- | --- | --- |
| [Comment 54](/show_bug.cgi?id=1268034#c54)• 9 years ago |
|  | |

Comment on [attachment 8753911](/attachment.cgi?id=8753911 "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[details]](/attachment.cgi?id=8753911&action=edit "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[diff]](/attachment.cgi?id=8753911&action=diff "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8753911)
Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.
Review of [attachment 8753911](/attachment.cgi?id=8753911 "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[details]](/attachment.cgi?id=8753911&action=edit "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[diff]](/attachment.cgi?id=8753911&action=diff "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1268034&attachment=8753911):
-----------------------------------------------------------------
Great. Thanks.
::: js/src/vm/GlobalObject.cpp
@@ +266,5 @@
> + if (!isObjectOrFunction) {
> + // Any operations that modifies global object should be placed after
> + // any other fallible operations.
> +
> + // Fallible operations that modifies global object.
Grammar nit:
// Fallible operation that modifies the global object.
@@ +272,5 @@
> + if (!global->addDataProperty(cx, id, constructorPropertySlot(key), 0))
> + return false;
> + }
> +
> + // Infallible operations that modifies global object.
// Infallible operations that modify the global object.
[Attachment #8753911](/attachment.cgi?id=8753911&action=edit "Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object.") -
Flags: review?(jorendorff) → review+

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 55](/show_bug.cgi?id=1268034#c55)• 9 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/7861d6b6c274db85036adc5496718d456e3a78c8>
Backed out changeset d31171af48e4 ([bug 1268034](/show_bug.cgi?id=1268034 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281"))
<https://hg.mozilla.org/integration/mozilla-inbound/rev/9c2a58d84d498bd8841f3bd88e6091ebcba58818>
[Bug 1268034](/show_bug.cgi?id=1268034 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") - Part 3: Create CreateArrayFromBuffer function on demand. r=jorendorff
<https://hg.mozilla.org/integration/mozilla-inbound/rev/1e198b4ccab26156c3dd6417b2ee08d53ab622dd>
[Bug 1268034](/show_bug.cgi?id=1268034 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") - Part 4: Delay modifying global constructor/prototype slots for classes other than Function and Object. r=jorendorff

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 56](/show_bug.cgi?id=1268034#c56)• 9 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/7861d6b6c274>
<https://hg.mozilla.org/mozilla-central/rev/9c2a58d84d49>
<https://hg.mozilla.org/mozilla-central/rev/1e198b4ccab2>Status: REOPENED → RESOLVEDClosed: 9 years ago → 9 years agoFlags: in-testsuite+Resolution: --- → FIXED

|  | [Tooru Fujisawa [:arai]](/user_profile?user_id=310076)  Assignee |  |
| --- | --- | --- |
| [Comment 57](/show_bug.cgi?id=1268034#c57)• 9 years ago |
|  | |

The testcase in [comment #0](/show_bug.cgi?id=1268034#c0 "VERIFIED FIXED - Assertion failure: isObject(), at dist/include/js/Value.h:1281") is specific to [bug 887016](/show_bug.cgi?id=887016 "RESOLVED FIXED - Implement ES6 RegExp.prototype methods and change String.prototype methods to delegate").
The underlying issue fixed by patches in this bug affects all branches tho, that won't be critical for other branches than m-c.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a2285044_1689)• 9 years ago |

Group: javascript-core-security → core-security-release

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a2491435_469204)• 9 years ago |

Status: RESOLVED → VERIFIED

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Comment 58](/show_bug.cgi?id=1268034#c58)• 9 years ago |
|  | |

JSBugMon: This bug has been automatically verified fixed.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a11437916_280903)• 8 years ago |

[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)Whiteboard: [jsbugmon:update,ignore] → [jsbugmon:update,ignore][adv-main49+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1268034#a24888153_1689)• 8 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1268034&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Gary Kwong [:gkw] [:nth10sd] (NOT official MoCo now)](/user_profile?user_id=132034)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_e8cebc2a_20250125_153309.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1276413)
* [XML](/show_bug.cgi?ctype=xml&id=1276413)

Closed
[Bug 1276413](/show_bug.cgi?id=1276413)

Opened 9 years ago
Closed 9 years ago

# Clear the buffer we allocate for paletted image frames

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Clear the buffer we allocate for paletted image frames

## Categories

### (Core :: Graphics: ImageLib, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20ImageLib#Graphics%3A%20ImageLib)

Graphics: ImageLib
▾

Core :: Graphics: ImageLib
ImageLib decodes GIF, JPEG and PNG images, and provides the decoded data to the Compositor for display. If Firefox or Seamonkey can display an image when loaded separately from the page, ImageLib is working, and the actual imaging bug exists elsewhere within Firefox or Seamonkey.

Examples of appropriate bugs: PNG gAMA chunk ignored; Crashes on GIF w/corrupted frame(merr-01.gif); or PNGs and JPEGs aren't displayed on FreeBSD.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20ImageLib&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20ImageLib&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20ImageLib)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla49

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=wontfix) |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=wontfix) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 |  | wontfix |
| firefox48 |  | wontfix |
| firefox49 |  | fixed |
| firefox-esr45 |  | wontfix |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: seth, Assigned: seth)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/6cf6a8d04179da2ab0f6dbc88dc5fe7b?d=mm&size=40)  [seth](/user_profile?user_id=452036)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/6cf6a8d04179da2ab0f6dbc88dc5fe7b?d=mm&size=40)  [seth](/user_profile?user_id=452036)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/0646a42110a02dd585f200f270716852?d=mm&size=40)  [tnikkel](/user_profile?user_id=255010)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

11 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1276061](/show_bug.cgi?id=1276061 "RESOLVED FIXED - Kill SurfaceFilter::WriteRows(), because it's memory unsafe and we almost never need it")

Dependency [tree](/showdependencytree.cgi?id=1276413&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1276413)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-disclosure, csectype-uninitialized, sec-moderate, Whiteboard: [adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[csectype-uninitialized](/buglist.cgi?keywords=csectype-uninitialized&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main49+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [(Part 1) - Clear paletted image frames when they're allocated.](/attachment.cgi?id=8757600)  [9 years ago](#c1)  [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)   1.36 KB, patch | eflores : [review+](#a197857_430065 "9 years ago")  abillings : [approval-mozilla-aurora+](#a394931_280903 "9 years ago")  ritu : [approval-mozilla-beta-](#c7 "9 years ago") | [Details](/attachment.cgi?id=8757600&action=edit) | [Diff](/attachment.cgi?id=8757600&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600) |
| --- | --- | --- |
| [(Part 2) - Add tests for expected state when initializing a SurfaceSink.](/attachment.cgi?id=8757602)  [9 years ago](#c2)  [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)   2.99 KB, patch | n.nethercote : [review+](#a172766_334849 "9 years ago") | [Details](/attachment.cgi?id=8757602&action=edit) | [Diff](/attachment.cgi?id=8757602&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757602) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1276413#c0)• 9 years ago |
|  | |

The new GTests I'm adding in [bug 1276061](/show_bug.cgi?id=1276061 "RESOLVED FIXED - Kill SurfaceFilter::WriteRows(), because it's memory unsafe and we almost never need it") revealed that we aren't clearing the memory for paletted image frames when we allocate them. This is a security bug waiting to happen. Let's nip this in the bud ASAP.

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1276413#c1)• 9 years ago |
|  | |

Attached patch

[(Part 1) - Clear paletted image frames when they're allocated.](attachment.cgi?id=8757600&action=diff)
— [Details](attachment.cgi?id=8757600&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600)

Here's the patch. The call to malloc is replaced with a call to calloc; that's
really it.
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: review?(edwin)

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1276413#c2)• 9 years ago |
|  | |

Attached patch

[(Part 2) - Add tests for expected state when initializing a SurfaceSink.](attachment.cgi?id=8757602&action=diff)
— [Details](attachment.cgi?id=8757602&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757602)

Here are some tests that would've caught this. They also verify a little bit of
additional initial state.
[Attachment #8757602](/attachment.cgi?id=8757602&action=edit "(Part 2) - Add tests for expected state when initializing a SurfaceSink.") -
Flags: review?(n.nethercote)

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1276413#c3)• 9 years ago |
|  | |

Comment on [attachment 8757600](/attachment.cgi?id=8757600 "(Part 1) - Clear paletted image frames when they're allocated.") [[details]](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") [[diff]](/attachment.cgi?id=8757600&action=diff "(Part 1) - Clear paletted image frames when they're allocated.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600)
(Part 1) - Clear paletted image frames when they're allocated.
Approval Request Comment
[Feature/regressing bug #]: None, really. This problem has existed since ancient times, on all branches.
[User impact if declined]: There's potential for an attacker to be able to read raw memory from JavaScript if they can find an exploit in the GIF or PNG decoders. (And historically such exploits have appeared with some frequency.) That could leak a user's private data; bad stuff.
[Describe test coverage new/current, TreeHerder]: A new test is provided in this bug.
[Risks and why]: This patch could not be any lower risk. It just replaces malloc with calloc when we allocate the buffer for paletted image frames. This is so low risk that I think we can safely uplift to beta if release management is comfortable with that.
[String/UUID change made/needed]: None.
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: approval-mozilla-beta?
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: approval-mozilla-aurora?

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1276413#c4)• 9 years ago |
|  | |

Comment on [attachment 8757600](/attachment.cgi?id=8757600 "(Part 1) - Clear paletted image frames when they're allocated.") [[details]](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") [[diff]](/attachment.cgi?id=8757600&action=diff "(Part 1) - Clear paletted image frames when they're allocated.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600)
(Part 1) - Clear paletted image frames when they're allocated.
[Security approval request comment]
How easily could an exploit be constructed based on the patch?
The problem is certainly obvious from the patch, but to exploit it you'd also need to find an exploit in the GIF or PNG decoders (to cause them to fail to write to all the pixels in the image), and the patch doesn't provide any guidance as to how to do that. Indeed, no such exploit is known to exist, but we certainly don't know that one doesn't exist.
Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?
Yes, pretty much. This patch is so trivial that it's hard to obfuscate.
Which older supported branches are affected by this flaw?
All of them.
Do you have backports for the affected branches? If not, how different, hard to create, and risky will they be?
This can be backported to any branch we care to backport it to; the patch is trivial.
How likely is this patch to cause regressions; how much testing does it need?
This patch could not be any safer. It just replaces a call to malloc with a call to calloc. The odds of regression are insanely low.
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: sec-approval?

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1276413#c5)• 9 years ago |
|  | |

Note that the tests are potentially a little harder to backport, but I think we can live without backporting those.

|  | [Nicholas Nethercote [inactive]](/user_profile?user_id=334849) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a172766_334849)• 9 years ago |

[Attachment #8757602](/attachment.cgi?id=8757602&action=edit "(Part 2) - Add tests for expected state when initializing a SurfaceSink.") -
Flags: review?(n.nethercote) → review+

|  | [Sylvestre Ledru [:Sylvestre]](/user_profile?user_id=495955) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a190533_495955)• 9 years ago |

[status-firefox47](/buglist.cgi?f1=cf_status_firefox47&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=affected)
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)

|  | [Edwin Flores [inactive from 2016-12-01] [:eflores] [:edwin]](/user_profile?user_id=430065) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a197857_430065)• 9 years ago |

[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: review?(edwin) → review+

|  | [Ritu Kothari (:ritu) (Inactive, please n-i to RyanVM, jcristau, or pascal)](/user_profile?user_id=538805) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1276413#c6)• 9 years ago |
|  | |

Hi Al, Dan, I am going to gtb RC1 in the next 2 hours. Is this something that is critical enough to be sec-approved and landed in time for RC1? Please let me know. Thanks!Flags: needinfo?(dveditz)Flags: needinfo?(abillings)

|  | [Ritu Kothari (:ritu) (Inactive, please n-i to RyanVM, jcristau, or pascal)](/user_profile?user_id=538805) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1276413#c7)• 9 years ago |
|  | |

Comment on [attachment 8757600](/attachment.cgi?id=8757600 "(Part 1) - Clear paletted image frames when they're allocated.") [[details]](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") [[diff]](/attachment.cgi?id=8757600&action=diff "(Part 1) - Clear paletted image frames when they're allocated.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600)
(Part 1) - Clear paletted image frames when they're allocated.
I spoke to abillings about this one and since this is not easily exploitable, we don't feel the urgency to uplift this in 47 during RC week (taking only release blockers from this point on).
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: approval-mozilla-beta? → approval-mozilla-beta-

|  | [Ritu Kothari (:ritu) (Inactive, please n-i to RyanVM, jcristau, or pascal)](/user_profile?user_id=538805) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a303232_538805)• 9 years ago |

[status-firefox47](/buglist.cgi?f1=cf_status_firefox47&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=wontfix)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a303738_1689)• 9 years ago |

Flags: needinfo?(dveditz)Keywords: [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[csectype-uninitialized](/buglist.cgi?keywords=csectype-uninitialized&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a309462_280903)• 9 years ago |

Flags: needinfo?(abillings)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a328929_1689)• 9 years ago |

Group: core-security → gfx-core-security

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a394931_280903)• 9 years ago |

[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: sec-approval?
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: approval-mozilla-aurora?
[Attachment #8757600](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") -
Flags: approval-mozilla-aurora+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1276413#c8)• 9 years ago |
|  | |

Comment on [attachment 8757600](/attachment.cgi?id=8757600 "(Part 1) - Clear paletted image frames when they're allocated.") [[details]](/attachment.cgi?id=8757600&action=edit "(Part 1) - Clear paletted image frames when they're allocated.") [[diff]](/attachment.cgi?id=8757600&action=diff "(Part 1) - Clear paletted image frames when they're allocated.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1276413&attachment=8757600)
(Part 1) - Clear paletted image frames when they're allocated.
Since we don't know of a second bug required complete an exploit here let's go ahead and land it: a=dveditz. OK for aurora as well. Way too late for beta as Ritu marked.

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a395082_280903)• 9 years ago |

[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=affected)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1276413#c9)• 9 years ago |
|  | |

[Tracking Requested - why for this release]:
Although this is nominally sec-moderate for now, an image decoder bug could turn this into a sec-high. Let's take this on the ESR branch after this release (Don't land now, they may not have branched) just to be on the safe side.
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
--- → [48+](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=48%2B)

|  | [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1276413#c10)• 9 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/817695430906243ef1f46f3c8df49f2b86f489ef>
[Bug 1276413](/show_bug.cgi?id=1276413 "RESOLVED FIXED - Clear the buffer we allocate for paletted image frames") (Part 1) - Clear paletted image frames when they're allocated. r=edwin
<https://hg.mozilla.org/integration/mozilla-inbound/rev/9cef1a1fa8a2d158bcd53c946462dbb62f871ee9>
[Bug 1276413](/show_bug.cgi?id=1276413 "RESOLVED FIXED - Clear the buffer we allocate for paletted image frames") (Part 2) - Add tests for expected state when initializing a SurfaceSink. r=njn

|  | [Carsten Book [:Tomcat]](/user_profile?user_id=277293) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1276413#c11)• 9 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/817695430906>
<https://hg.mozilla.org/mozilla-central/rev/9cef1a1fa8a2>Status: NEW → RESOLVEDClosed: 9 years ago
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla49

|  | [Carsten Book [:Tomcat]](/user_profile?user_id=277293) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1276413#c12)• 9 years ago |
|  | |

has problems uplifting to aurora, seth could you take a look, thanks!
merging image/imgFrame.cpp
warning: conflicts while merging image/imgFrame.cpp! (edit, then use 'hg resolve --mark')
abort: unresolved conflicts, can't continue
(use 'hg resolve' and 'hg graft --continue')Flags: needinfo?(seth)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a644622_1689)• 9 years ago |

Group: gfx-core-security → core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1276413#c13)• 8 years ago |
|  | |

[Tracking Requested - why for this release]:
Clearly this won't make Firefox 48 at this point. Given the trouble in getting even an Aurora-48 patch ([comment 12](/show_bug.cgi?id=1276413#c12 "RESOLVED FIXED - Clear the buffer we allocate for paletted image frames")) it might be worse trying to port this to ESR-45. Given [comment 4](/show_bug.cgi?id=1276413#c4 "RESOLVED FIXED - Clear the buffer we allocate for paletted image frames") maybe we can pass on it.
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
[48+](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=48%2B) → [?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a8794969_280903)• 8 years ago |

[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=wontfix)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F) → ---Whiteboard: [adv-main49+]

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a8851655_406194)• 8 years ago |

Flags: needinfo?(seth.bugzilla)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1276413#a39539836_1689)• 7 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1276413&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Seth Fowler [:seth] [:s2h]](/user_profile?user_id=452036)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from security.gentoo.org_14686fcf_20250125_153320.html ===

[![Gentoo](https://assets.gentoo.org/tyrian/v2/site-logo.png)](/ "Back to the homepage")
Security

[**Get Gentoo!**](https://get.gentoo.org/)
gentoo.org sites
[gentoo.org](https://www.gentoo.org/ "Main Gentoo website")
[Wiki](https://wiki.gentoo.org/ "Find and contribute documentation")
[Bugs](https://bugs.gentoo.org/ "Report issues and find common issues")
[Forums](https://forums.gentoo.org/ "Discuss with the community")
[Packages](https://packages.gentoo.org/ "Find software for your Gentoo")

[Planet](https://planet.gentoo.org/ "Find out what's going on in the developer community")
[Archives](https://archives.gentoo.org/ "Read up on past discussions")
[Sources](https://sources.gentoo.org/ "Browse our source code")

[Infra Status](https://infra-status.gentoo.org/ "Get updates on the services provided by Gentoo")

* [Home](/)
* [Stay informed](/subscribe)
* [Advisories](/glsa)

# Mozilla Firefox, Thunderbird: Multiple vulnerabilities — GLSA **201701-15**

Multiple vulnerabilities have been found in Mozilla Firefox and
Thunderbird the worst of which could lead to the execution of arbitrary
code.

### Affected packages

| Package | **www-client/firefox** on all architectures |
| --- | --- |
| Affected versions | < **45.6.0** |
| Unaffected versions | >= **45.6.0** |

| Package | **www-client/firefox-bin** on all architectures |
| --- | --- |
| Affected versions | < **45.6.0** |
| Unaffected versions | >= **45.6.0** |

| Package | **mail-client/thunderbird** on all architectures |
| --- | --- |
| Affected versions | < **45.6.0** |
| Unaffected versions | >= **45.6.0** |

| Package | **mail-client/thunderbird-bin** on all architectures |
| --- | --- |
| Affected versions | < **45.6.0** |
| Unaffected versions | >= **45.6.0** |

### Background

Mozilla Firefox is a cross-platform web browser from Mozilla. The
Mozilla Thunderbird mail client is a redesign of the Mozilla Mail
component. The goal is to produce a cross-platform stand-alone mail
application using XUL (XML User Interface Language).

### Description

Multiple vulnerabilities have been discovered in Mozilla Firefox and
Thunderbird. Please review the CVE identifiers referenced below for
details.

### Impact

A remote attacker could possibly execute arbitrary code with the
privileges of the process or cause a Denial of Service condition via
multiple vectors.

### Workaround

There is no known workaround at this time.

### Resolution

All Firefox users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-45.6.0"

```

All Firefox-bin users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=www-client/firefox-bin-45.6.0"

```

All Thunderbird users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose ">=mail-client/thunderbird-45.6.0"

```

All Thunderbird-bin users should upgrade to the latest version:

```
 # emerge --sync
 # emerge --ask --oneshot --verbose
 ">=mail-client/thunderbird-bin-45.6.0"

```
### References

* [CVE-2016-2804](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2804)
* [CVE-2016-2805](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2805)
* [CVE-2016-2806](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2806)
* [CVE-2016-2807](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2807)
* [CVE-2016-2808](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2808)
* [CVE-2016-2809](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2809)
* [CVE-2016-2810](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2810)
* [CVE-2016-2811](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2811)
* [CVE-2016-2812](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2812)
* [CVE-2016-2813](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2813)
* [CVE-2016-2814](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2814)
* [CVE-2016-2816](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2816)
* [CVE-2016-2817](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2817)
* [CVE-2016-2820](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2820)
* [CVE-2016-2827](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2827)
* [CVE-2016-2830](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2830)
* [CVE-2016-2835](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2835)
* [CVE-2016-2836](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2836)
* [CVE-2016-2837](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2837)
* [CVE-2016-2838](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2838)
* [CVE-2016-2839](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-2839)
* [CVE-2016-5250](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5250)
* [CVE-2016-5251](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5251)
* [CVE-2016-5252](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5252)
* [CVE-2016-5253](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5253)
* [CVE-2016-5254](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5254)
* [CVE-2016-5255](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5255)
* [CVE-2016-5256](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5256)
* [CVE-2016-5257](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5257)
* [CVE-2016-5258](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5258)
* [CVE-2016-5259](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5259)
* [CVE-2016-5260](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5260)
* [CVE-2016-5261](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5261)
* [CVE-2016-5262](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5262)
* [CVE-2016-5263](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5263)
* [CVE-2016-5264](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5264)
* [CVE-2016-5265](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5265)
* [CVE-2016-5266](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5266)
* [CVE-2016-5267](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5267)
* [CVE-2016-5268](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5268)
* [CVE-2016-5270](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5270)
* [CVE-2016-5271](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5271)
* [CVE-2016-5272](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5272)
* [CVE-2016-5273](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5273)
* [CVE-2016-5274](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5274)
* [CVE-2016-5275](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5275)
* [CVE-2016-5276](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5276)
* [CVE-2016-5277](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5277)
* [CVE-2016-5278](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5278)
* [CVE-2016-5279](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5279)
* [CVE-2016-5280](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5280)
* [CVE-2016-5281](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5281)
* [CVE-2016-5282](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5282)
* [CVE-2016-5283](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5283)
* [CVE-2016-5284](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5284)
* [CVE-2016-5290](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5290)
* [CVE-2016-5291](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5291)
* [CVE-2016-5293](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5293)
* [CVE-2016-5294](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5294)
* [CVE-2016-5296](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5296)
* [CVE-2016-5297](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-5297)
* [CVE-2016-9064](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9064)
* [CVE-2016-9066](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9066)
* [CVE-2016-9074](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9074)
* [CVE-2016-9079](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9079)
* [CVE-2016-9893](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9893)
* [CVE-2016-9895](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9895)
* [CVE-2016-9897](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9897)
* [CVE-2016-9898](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9898)
* [CVE-2016-9899](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9899)
* [CVE-2016-9900](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9900)
* [CVE-2016-9901](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9901)
* [CVE-2016-9902](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9902)
* [CVE-2016-9904](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9904)
* [CVE-2016-9905](https://nvd.nist.gov/nvd.cfm?cvename=CVE-2016-9905)

**Release date**

January 03, 2017

**Latest revision**

January 04, 2017: 2

**Severity**

normal

**Exploitable**

remote

**Bugzilla entries**

* [581326](https://bugs.gentoo.org/show_bug.cgi?id=581326)
* [590330](https://bugs.gentoo.org/show_bug.cgi?id=590330)
* [594616](https://bugs.gentoo.org/show_bug.cgi?id=594616)
* [599924](https://bugs.gentoo.org/show_bug.cgi?id=599924)
* [601320](https://bugs.gentoo.org/show_bug.cgi?id=601320)
* [602576](https://bugs.gentoo.org/show_bug.cgi?id=602576)
* [604024](https://bugs.gentoo.org/show_bug.cgi?id=604024)

### Questions or comments?

Please feel free to contact us.

**© 2001–2020 Gentoo Foundation, Inc.**



=== Content from bugzilla.mozilla.org_e40d5fbd_20250125_153317.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1296087)
* [XML](/show_bug.cgi?ctype=xml&id=1296087)

Closed
[Bug 1296087](/show_bug.cgi?id=1296087)

Opened 8 years ago
Closed 8 years ago

# IonCache getter stub may not correctly restore clobbered register

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

IonCache getter stub may not correctly restore clobbered register

## Categories

### (Core :: JavaScript Engine: JIT, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT#JavaScript%20Engine%3A%20JIT)

JavaScript Engine: JIT
▾

Core :: JavaScript Engine: JIT
JavaScript engine's JIT compilers
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine%3A%20JIT)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla51

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Priority | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | [-](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=-) | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=wontfix) |
| firefox50 | [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed) |
| firefox51 | [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 |  | wontfix |
| firefox49 | + | fixed |
| firefox-esr45 | - | wontfix |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 | + | fixed |
| firefox51 | + | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: spinda, Assigned: spinda, Mentored)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/5ba9a15111c34e6121e5f8d082d0aa04?d=mm&size=40)  [spinda](/user_profile?user_id=573040)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

![](https://secure.gravatar.com/avatar/589235fc11e48fe6ffaa98fb085b4110?d=mm&size=40)  [efaust](/user_profile?user_id=442736)

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/5ba9a15111c34e6121e5f8d082d0aa04?d=mm&size=40)  [spinda](/user_profile?user_id=573040)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: sec-moderate, Whiteboard: [post-critsmash-triage][adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main49+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c8 "8 years ago") | ? |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [incomplete\_test\_case.js](/attachment.cgi?id=8782135)  [8 years ago](#c0)  [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)   820 bytes, text/plain |  | [Details](/attachment.cgi?id=8782135&action=edit) |
| --- | --- | --- |
| [Bug 1296087: Jump to correct cache failure label](/attachment.cgi?id=8782136)  [8 years ago](#c1)  [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)   1.25 KB, patch | nbp : [review+](#a385043_422187 "8 years ago")  lizzard : [approval-mozilla-aurora+](#c14 "8 years ago")  lizzard : [approval-mozilla-beta+](#c14 "8 years ago")  Sylvestre : [approval-mozilla-esr45-](#c15 "8 years ago") | [Details](/attachment.cgi?id=8782136&action=edit) | [Diff](/attachment.cgi?id=8782136&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1296087#c0)• 8 years ago |
|  | |

Attached file
[incomplete\_test\_case.js](attachment.cgi?id=8782135)
— [Details](attachment.cgi?id=8782135&action=edit)

There's a single typo in IonCaches.cpp that means that the object (receiver) register may be left overwritten with another object or group's memory address, with the previous value left in the stack. The circumstances required to trigger this are somewhat specific:
1. A GenerateCallGetter stub must be generated in Ion code.
2. The GenerateCallGetter stub has to be using the same register for both receiver object and scratch. Since all callers pass in the output register as scratch, this means that the receiver and output register must be the same.
3. GeneratePrototypeGuards must generate at least one prototype guard. This means that at least one object from the receiver up to (but not including) the holder must have the UNCACHEABLE\_PROTO flag set. This only happens for non-singleton objects who either have had their prototype mutated in the past or were part of a prototype chain in which a downstream object's prototype was mutated.
4. The prototype of that object must be mutated after the cache stub has been generated. The next time the cache stub is used, the previously-generated guard from GeneratePrototypeGuards will fail. The problem: execution will then jump to the next stub without restoring the clobbered object register or fixing the stack.
The code is definitely incorrect, but I haven't been able to manually trigger condition (1). If I edit IonCaches.cpp to directly use the object register as scratch, the issue described above occurs. The tricky part is setting up the code so that the register allocator will reuse the receiver register as the output register. Two previous attempts at patching this area of the code demonstrate that this \*can\* happen ([https://bugzilla.mozilla.org/show\_bug.cgi?id=1033873](/show_bug.cgi?id=1033873 "RESOLVED FIXED - Differential Testing: Different output message involving __proto__") and [https://bugzilla.mozilla.org/show\_bug.cgi?id=1046597](/show_bug.cgi?id=1046597 "VERIFIED FIXED - Assertion failure: tag <= CalleeToken_Script, at jit/IonFrames.h:32 or Assertion failure: false (MOZ_ASSERT_UNREACHABLE: invalid callee token tag), at jit/IonFrames.h:72")), but both of their test cases trigger it through the global object's \_\_proto\_\_ property. Both the global object and its prototype are singletons, and both have immutable prototypes, so they can't be used to set up the UNCACHEABLE\_PROTO flag as described in condition (3).
If it \*is\* possible to trigger this in the real world, or if the fragile set of circumstances potentially preventing it from being triggered changes, the result (user code corrupting the stack and replacing a memory address held in a register) sounds pretty bad, so I'm marking this as security-sensitive. Fortunately the patch is trivial.

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1296087#c1)• 8 years ago |
|  | |

Attached patch

[Bug 1296087: Jump to correct cache failure label](attachment.cgi?id=8782136&action=diff)
— [Details](attachment.cgi?id=8782136&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)

Assignee: nobody → mismithStatus: NEW → ASSIGNED

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a1566_573040)• 8 years ago |

[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: review?(efaustbmo)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a72989_1689)• 8 years ago |

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a85317_1689)• 8 years ago |

Group: core-security → javascript-core-security

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a170126_573040)• 8 years ago |

[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: review?(efaustbmo) → review?(nicolas.b.pierron)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a385043_422187)• 8 years ago |

[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: review?(nicolas.b.pierron) → review+

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1296087#c2)• 8 years ago |
|  | |

Today, is sounds to me that this code is reachable via the NameIC [1,2], which explicitly alias the object register as being the scratch register. GetPropertyIC should not have this issue since the register allocator is not allowed to alias the output value-register with the object register.
The only I know to change the scope chain with custom object is by using the `with` keyword.
[1] <http://searchfox.org/mozilla-central/rev/f433f0dd7158d7bfc4c4607161fc6baa88b5a9f4/js/src/jit/IonCaches.cpp#4892,4902-4904>
[2] <http://searchfox.org/mozilla-central/rev/f433f0dd7158d7bfc4c4607161fc6baa88b5a9f4/js/src/jit/IonCaches.cpp#5016,5022,5024>

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1296087#c3)• 8 years ago |
|  | |

I've poked at NameIC, but it only takes this code path if |obj| is a global object [1]. This means the holder is either the global object itself or something on its prototype chain. In practice, the global object and its prototype (a) both have immutable prototypes, so a direct mutation isn't possible, and (b) are both singletons, so a mutation on something with the global object on its prototype chain won't end up propagating UNCACHEABLE\_PROTO to the global object or its prototype.
If I understand correctly, |with| doesn't help a potential attacker trigger this. Is that right?
Either way, I'll try to get this checked in following the security procedures.
[1] <http://searchfox.org/mozilla-central/rev/f433f0dd7158d7bfc4c4607161fc6baa88b5a9f4/js/src/jit/IonCaches.cpp#4920-4921>Flags: needinfo?(nicolas.b.pierron)

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1296087#c4)• 8 years ago |
|  | |

Comment on [attachment 8782136](/attachment.cgi?id=8782136 "Bug 1296087: Jump to correct cache failure label") [[details]](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") [[diff]](/attachment.cgi?id=8782136&action=diff "Bug 1296087: Jump to correct cache failure label") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"): Jump to correct cache failure label
[Security approval request comment]
> How easily could an exploit be constructed based on the patch?
As per the discussion above and my own testing, I believe it may be impossible to trigger this issue in practice. This is incidental, however, and if one of several moving parts in the system were to change it could be opened up.
Turning this from a crash into an exploit would require either careful massaging of the register allocator to take advantage of the clobbered value (hard in a running browser) or taking advantage of the misaligned stack (potentially easier).
> Do comments in the patch, the check-in comment, or tests included
> in the patch paint a bulls-eye on the security problem?
Yes, the change in the patch is a few characters long and the problem is extremely obvious.
> Which older supported branches are affected by this flaw?
This issue is present in all branches dating back to at least Firefox 33.
> If not all supported branches, which bug introduced the flaw?
[Bug 851109](/show_bug.cgi?id=851109 "RESOLVED FIXED - Investigate why sunspider validate-input is slower in the browser than in the shell") introduced the original issue found in [bug 1033873](/show_bug.cgi?id=1033873 "RESOLVED FIXED - Differential Testing: Different output message involving __proto__") and [bug 1046597](/show_bug.cgi?id=1046597 "VERIFIED FIXED - Assertion failure: tag <= CalleeToken_Script, at jit/IonFrames.h:32 or Assertion failure: false (MOZ_ASSERT_UNREACHABLE: invalid callee token tag), at jit/IonFrames.h:72"). This corrects an error in the patches for those two bugs.
> Do you have backports for the affected branches?
> If not, how different, hard to create, and risky will they be?
Trivial, it's a single typo.
> How likely is this patch to cause regressions;
> how much testing does it need?
Not likely at all, the typo fix is obviously correct.
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: sec-approval?

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1296087#c5)• 8 years ago |
|  | |

Comment on [attachment 8782136](/attachment.cgi?id=8782136 "Bug 1296087: Jump to correct cache failure label") [[details]](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") [[diff]](/attachment.cgi?id=8782136&action=diff "Bug 1296087: Jump to correct cache failure label") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"): Jump to correct cache failure label
As a sec-moderate, this doesn't need sec-approval to land on trunk. You can just land it.
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: sec-approval?

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1296087#c6)• 8 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/abe23b9940e2>

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1296087#c7)• 8 years ago |
|  | |

(In reply to Michael Smith [:mismith] from [comment #3](/show_bug.cgi?id=1296087#c3 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"))
> I've poked at NameIC, but it only takes this code path if |obj| is a global
> object [1]. […]
>
> If I understand correctly, |with| doesn't help a potential attacker trigger
> this. Is that right?
That sounds correct.
The |with| keyword is just the easiest way I know to put a random object on the environment chain (scope chain).
(In reply to Michael Smith [:mismith] from [comment #3](/show_bug.cgi?id=1296087#c3 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"))
> […] This means the holder is either the global object itself or
> something on its prototype chain. In practice, the global object and its
> prototype (a) both have immutable prototypes, so a direct mutation isn't
> possible, […]
Still, I recall we had a TI issue related to the fact that the window global object of web pages was changing prototype. Jan gave me a link to JS\_SplicePrototype [2] (servo is using JS\_SetPrototype).
But I agree, the global should still be a singleton. I don't know about the prototype chain.
[1] <http://searchfox.org/mozilla-central/rev/f80822840bc5f3d2d3cae3ece621ddbce72e7f54/js/src/jsfriendapi.cpp#98>Flags: needinfo?(nicolas.b.pierron)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1296087#c8)• 8 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/abe23b9940e2>
We should probably consider backporting this to at least some branches. Michael, can you please do the requests on that?Status: ASSIGNED → RESOLVEDClosed: 8 years ago
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=affected)
[tracking-firefox49](/buglist.cgi?f1=cf_tracking_firefox49&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%3F)
[tracking-firefox50](/buglist.cgi?f1=cf_tracking_firefox50&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%3F)
[tracking-firefox51](/buglist.cgi?f1=cf_tracking_firefox51&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%3F)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F)Flags: needinfo?(michael+bmo)Flags: in-testsuite?Resolution: --- → FIXEDTarget Milestone: --- → mozilla51

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1296087#c9)• 8 years ago |
|  | |

Tracking 51+ for this sec-moderate issue.
[tracking-firefox51](/buglist.cgi?f1=cf_tracking_firefox51&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B)

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1296087#c10)• 8 years ago |
|  | |

> We should probably consider backporting this to at least some branches. Michael, can you please do the requests on that?
Sure. How do I go about doing that? This is a new process for me.Flags: needinfo?(michael+bmo) → needinfo?(ryanvm)

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1296087#c11)• 8 years ago |
|  | |

> Still, I recall we had a TI issue related to the fact that the window global object of web pages was changing prototype. Jan gave me a link to JS\_SplicePrototype
JS\_SplicePrototype sets class and prototype directly without going through SetClassAndProto, so it won't trigger UNCACHEABLE\_PROTO. But I'm now somewhat concerned that this doesn't seem to be doing anything to invalidate ICs. Is this only used immediately after constructing objects?
> (servo is using JS\_SetPrototype).
That, on the other hand, could set UNCACHEABLE\_PROTO on non-singletons in the chain.
Do you know when/why we change the prototypes of global objects?Flags: needinfo?(nicolas.b.pierron)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1296087#c12)• 8 years ago |
|  | |

(In reply to Michael Smith [:mismith] from [comment #10](/show_bug.cgi?id=1296087#c10 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"))
> Sure. How do I go about doing that? This is a new process for me.
Click the Details link on your attached patch. Set "approval‑mozilla‑aurora" (and whatever other branches you want to nominate it for uplift to) to ? and fill out the questions that appear in the comment field. You can fill out one set of questions for all branches at the same time (rather than doing the same thing for each branch individually).Flags: needinfo?(ryanvm)

|  | [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1296087#c13)• 8 years ago |
|  | |

Comment on [attachment 8782136](/attachment.cgi?id=8782136 "Bug 1296087: Jump to correct cache failure label") [[details]](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") [[diff]](/attachment.cgi?id=8782136&action=diff "Bug 1296087: Jump to correct cache failure label") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"): Jump to correct cache failure label
> [Approval Request Comment]
> If this is not a sec:{high,crit} bug, please state case for ESR consideration:
Fixes a single typo that may not be exploitable in the wild, but if it is, could have a bad security impact.
> User impact if declined:
Risk that a way to exploit this is discovered down the road, leading to stack and register corruption with a memory address controlled by script.
> Fix Landed on Version:
Slated for Firefox 51.
> Risk to taking this patch (and alternatives if risky):
Minimal, the patch fixes a single typo.
> String or UUID changes made by this patch:
None.
> See <https://wiki.mozilla.org/Release_Management/ESR_Landing_Process> for more info.
> Approval Request Comment
> [Feature/regressing bug #]:
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register")
> [User impact if declined]:
(See above.)
> [Describe test coverage new/current, TreeHerder]:
Existing tests plus the tiny size of the patch cover the possibility of this breaking something. The issue itself that this patch protects against doesn't have a test because it may not actually be possible to trigger the bad condition in practice.
> [Risks and why]:
Little risk, the patch is a single (but important) typo fix. Worst I can think of is that, since the patch is so straightforward, it's pretty obvious what it's fixing.
> [String/UUID change made/needed]:
None.
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-esr45?
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-beta?
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-aurora?

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1296087#c14)• 8 years ago |
|  | |

Comment on [attachment 8782136](/attachment.cgi?id=8782136 "Bug 1296087: Jump to correct cache failure label") [[details]](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") [[diff]](/attachment.cgi?id=8782136&action=diff "Bug 1296087: Jump to correct cache failure label") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"): Jump to correct cache failure label
Sec fix, looks low risk, let's try this on aurora and beta 8.
I see the reasoning but not sure I would say yes to this for esr, up to sylvestre.
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-beta?
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-beta+
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-aurora?
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-aurora+

|  | [Sylvestre Ledru [:Sylvestre]](/user_profile?user_id=495955) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1296087#c15)• 8 years ago |
|  | |

Comment on [attachment 8782136](/attachment.cgi?id=8782136 "Bug 1296087: Jump to correct cache failure label") [[details]](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") [[diff]](/attachment.cgi?id=8782136&action=diff "Bug 1296087: Jump to correct cache failure label") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296087&attachment=8782136)
[Bug 1296087](/show_bug.cgi?id=1296087 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"): Jump to correct cache failure label
Doesn't match the esr criteria as it is only a sec-moderate, not taking it to esr.
[Attachment #8782136](/attachment.cgi?id=8782136&action=edit "Bug 1296087: Jump to correct cache failure label") -
Flags: approval-mozilla-esr45? → approval-mozilla-esr45-

|  | [Sylvestre Ledru [:Sylvestre]](/user_profile?user_id=495955) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a996211_495955)• 8 years ago |

[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=wontfix)
[tracking-firefox49](/buglist.cgi?f1=cf_tracking_firefox49&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B)
[tracking-firefox50](/buglist.cgi?f1=cf_tracking_firefox50&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F) → [-](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=-)

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1296087#c16)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/4aacede9f1b3>
<https://hg.mozilla.org/releases/mozilla-beta/rev/90a602a48534>
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1296087#c17)• 8 years ago |
|  | |

(In reply to Michael Smith [:mismith] from [comment #11](/show_bug.cgi?id=1296087#c11 "RESOLVED FIXED - IonCache getter stub may not correctly restore clobbered register"))
> > Still, I recall we had a TI issue related to the fact that the window global object of web pages was changing prototype. Jan gave me a link to JS\_SplicePrototype
>
> JS\_SplicePrototype sets class and prototype directly without going through
> SetClassAndProto, so it won't trigger UNCACHEABLE\_PROTO. But I'm now
> somewhat concerned that this doesn't seem to be doing anything to invalidate
> ICs.
AFAIK, we have no mechanism for "invalidating" inline caches. The only mechanism we have for cleaning-up is either to remove all of them, when we reach the limited the number of stubs, or when we garbage collect them.
> Is this [=JS\_SplicePrototype] only used immediately after constructing objects?
That's what I recall, but bz or bhackett might know better.
> > (servo is using JS\_SetPrototype).
>
> That, on the other hand, could set UNCACHEABLE\_PROTO on non-singletons in
> the chain.
>
> Do you know when/why we change the prototypes of global objects?
I do not know.Flags: needinfo?(nicolas.b.pierron)Flags: needinfo?(bzbarsky)Flags: needinfo?(bhackett1024)

|  | [Boris Zbarsky [:bzbarsky]](/user_profile?user_id=20209) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1296087#c18)• 8 years ago |
|  | |

> (servo is using JS\_SetPrototype)
Not anymore, because it totally makes performance suck, as expected. See <https://github.com/servo/servo/pull/13009> and the discussion in <https://github.com/servo/servo/issues/12979#issuecomment-241959407>
> Is this [=JS\_SplicePrototype] only used immediately after constructing objects?
Yes, JS\_SplicePrototype is meant to be used immediately after constructing objects, or at least before those objects can have escaped to script. That is the entire point of it. If only we actually wrote docs in our API headers... :(
In practice, the only users of JS\_SplicePrototype are places that create the global, and JS\_NewObjectWithUniqueType; the latter is used for singletons like DOM prototypes. In both cases the splice call happens before script should be able to get its paws on the object.
> Do you know when/why we change the prototypes of global objects?
Any time it needs to have a prototype other than Object.prototype, right? I mean, there's a chicken-and-egg problem. Say I want to create a window global on the web. It's supposed to have Window.prototype as its prototype. But to even create the Window.prototype object I need to be in the right compartment, which means I have to create the compartment, which means creating its global. And I can't specify the right prototype at this point, because it doesn't exist yet. So we end up just creating the global with Object.prototype as the proto, then creating the correct prototype, then using JS\_SplicePrototype to set things up.
Given the JS\_SetImmutablePrototype bits we do on globals now, we should be able to assume that the proto chain of a global does not mutate after that JS\_SplicePrototype call, and certainly does not mutate after we might have any JIT guards on that global.Flags: needinfo?(bzbarsky)

|  | [Brian Hackett [Laid off!]](/user_profile?user_id=346231) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1296087#c19)• 8 years ago |
|  | |

JS\_SplicePrototype should only be used on objects that haven't escaped to script yet. (There's a comment to that effect in the function's implementation, though it isn't very well written.)Flags: needinfo?(bhackett1024)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a1281910_1689)• 8 years ago |

Group: javascript-core-security → core-security-release

|  | [Matt Wobensmith [:mwobensmith][:matt:]](/user_profile?user_id=452604) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a1683113_452604)• 8 years ago |

Whiteboard: [post-critsmash-triage]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a1740395_280903)• 8 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main49+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296087#a32485093_1689)• 7 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1296087&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Naomi Smith [:spinda] (non-bmo mail: mds009@ucsd.edu)](/user_profile?user_id=573040)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_602bb1db_20250125_153311.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1282746)
* [XML](/show_bug.cgi?ctype=xml&id=1282746)

Closed
[Bug 1282746](/show_bug.cgi?id=1282746)

Opened 9 years ago
Closed 8 years ago

# Assertion failure: comp == compartment || runtime()->isAtomsCompartment(comp) || (srcKind == JS::TraceKind::Object && InCrossCompartmentMap(static\_cast<JSObject\*>(src), thing)), at js/src/jsgc.cpp:3745

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: comp == compartment || runtime()->isAtomsCompartment(comp) || (srcKind == JS::TraceKind::Object && InCrossCompartmentMap(static\_cast<JSObject\*>(src), thing)), at js/src/jsgc.cpp:3745

## Categories

### (Core :: JavaScript Engine, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%20Engine#JavaScript%20Engine)

JavaScript Engine
▾

Core :: JavaScript Engine
The interpreter engine for the core JavaScript language, independent of the browser's object model. File ONLY core JavaScript language bugs in this category. For bugs involving browser objects such as "window" and "document", use the "DOM" component. For bugs involving calls between JavaScript and C++, use the "XPConnect" component.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%20Engine&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%20Engine)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

47 Branch

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla51

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=wontfix) |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected) |
| firefox50 | [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed) |
| firefox51 | [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox47 |  | wontfix |
| firefox48 |  | wontfix |
| firefox49 | + | fixed |
| firefox-esr45 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 | + | fixed |
| firefox51 | + | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: efaust)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/589235fc11e48fe6ffaa98fb085b4110?d=mm&size=40)  [efaust](/user_profile?user_id=442736)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

16 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[888969](/show_bug.cgi?id=888969 "RESOLVED FIXED - Implement ES6 Proxy traps for getPrototypeOf and setPrototypeOf")

Dependency [tree](/showdependencytree.cgi?id=1282746&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1282746)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[1275080](/show_bug.cgi?id=1275080 "RESOLVED DUPLICATE - Crash [@ js::gc::TenuredCell::zone]"), [1280246](/show_bug.cgi?id=1280246 "RESOLVED DUPLICATE - Crash [@ void js::CheckTracedThing<js::Shape>] with [@ js::ProxyObject::trace] on the stack"), [1295172](/show_bug.cgi?id=1295172 "RESOLVED DUPLICATE - Crash [@ js::CheckTracedThing<js::Shape>] with Proxy and evalcx")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [jsbugmon:][post-critsmash-triage][adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[crash](/buglist.cgi?keywords=crash&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[jsbugmon:][post-critsmash-triage][adv-main49+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c22 "8 years ago") | ? |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [Fix](/attachment.cgi?id=8773051)  [9 years ago](#c5)  [Eric Faust [:efaust]](/user_profile?user_id=442736)   842 bytes, patch | Waldo : [review+](#c6 "9 years ago")  gchang : [approval-mozilla-aurora+](#c21 "8 years ago")  gchang : [approval-mozilla-beta+](#c21 "8 years ago")  abillings : [sec-approval+](#a2103001_280903 "9 years ago") | [Details](/attachment.cgi?id=8773051&action=edit) | [Diff](/attachment.cgi?id=8773051&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1282746#c0)• 9 years ago |
|  | |

The following testcase crashes on mozilla-central revision d87b76177b2f (build with --enable-posix-nspr-emulation --enable-valgrind --enable-gczeal --disable-tests --enable-debug --enable-optimize, run with --fuzzing-safe):
function runTestCase(testcase) {}
var lfGlobal = newGlobal();
for (lfLocal in this) {
if (!(lfLocal in lfGlobal)) {
lfGlobal[lfLocal] = this[lfLocal];
}
}
lfGlobal.offThreadCompileScript(`
var p = new Proxy({}, {});
runTestCase.prototype.\_\_proto\_\_ = p;
fullcompartmentchecks(true);
`);
lfGlobal.runOffThreadScript();
Backtrace:
received signal SIGSEGV, Segmentation fault.
0x0000000000975cd0 in CompartmentCheckTracer::onChild (this=this@entry=0x7fffffffcfd0, thing=...) at js/src/jsgc.cpp:3743
#0 0x0000000000975cd0 in CompartmentCheckTracer::onChild (this=this@entry=0x7fffffffcfd0, thing=...) at js/src/jsgc.cpp:3743
#1 0x0000000000d57c5c in JS::CallbackTracer::onShapeEdge (shapep=0x7ffff7e74648, this=0x7fffffffcfd0) at /srv/jenkins/jobs/mozilla-central-build-jsshell/workspace/arch/64/compiler/gcc/sanitizer/none/type/debug/dist/include/js/TracingAPI.h:131
#2 JS::CallbackTracer::dispatchToOnEdge (shapep=0x7ffff7e74648, this=0x7fffffffcfd0) at /srv/jenkins/jobs/mozilla-central-build-jsshell/workspace/arch/64/compiler/gcc/sanitizer/none/type/debug/dist/include/js/TracingAPI.h:209
#3 DoCallback<js::Shape\*> (trc=0x7fffffffcfd0, thingp=0x7ffff7e74648, name=<optimized out>) at js/src/gc/Tracer.cpp:51
#4 0x0000000000a09fb7 in js::ProxyObject::trace (trc=0x7fffffffcfd8, obj=0x7ffff7e74640) at js/src/proxy/Proxy.cpp:619
#5 0x000000000094546f in js::Class::doTrace (this=<optimized out>, obj=0x7ffff7e74640, trc=0x7fffffffcfd8) at /srv/jenkins/jobs/mozilla-central-build-jsshell/workspace/arch/64/compiler/gcc/sanitizer/none/type/debug/dist/include/js/Class.h:815
#6 JSObject::traceChildren (this=0x7ffff7e74640, trc=0x7fffffffcfd8) at js/src/jsobj.cpp:3890
#7 0x0000000000d3b28a in js::TraceChildren (trc=trc@entry=0x7fffffffcfd8, thing=0x7ffff7e74640, kind=kind@entry=JS::TraceKind::Object) at js/src/gc/Tracer.cpp:126
#8 0x000000000093f0ad in js::gc::GCRuntime::checkForCompartmentMismatches (this=this@entry=0x7ffff6965608) at js/src/jsgc.cpp:3769
#9 0x0000000000976608 in js::gc::GCRuntime::checkForCompartmentMismatches (this=0x7ffff6965608) at js/src/jsgc.cpp:3811
#10 js::gc::GCRuntime::beginMarkPhase (this=this@entry=0x7ffff6965608, reason=reason@entry=JS::gcreason::DESTROY\_RUNTIME, lock=...) at js/src/jsgc.cpp:3799
#11 0x000000000097b1e6 in js::gc::GCRuntime::incrementalCollectSlice (this=this@entry=0x7ffff6965608, budget=..., reason=reason@entry=JS::gcreason::DESTROY\_RUNTIME, lock=...) at js/src/jsgc.cpp:5919
#12 0x000000000097c6ef in js::gc::GCRuntime::gcCycle (this=this@entry=0x7ffff6965608, nonincrementalByAPI=nonincrementalByAPI@entry=true, budget=..., reason=reason@entry=JS::gcreason::DESTROY\_RUNTIME) at js/src/jsgc.cpp:6204
#13 0x000000000097cdb6 in js::gc::GCRuntime::collect (this=this@entry=0x7ffff6965608, nonincrementalByAPI=nonincrementalByAPI@entry=true, budget=..., reason=reason@entry=JS::gcreason::DESTROY\_RUNTIME) at js/src/jsgc.cpp:6312
#14 0x000000000097d1ab in js::gc::GCRuntime::gc (this=this@entry=0x7ffff6965608, gckind=gckind@entry=GC\_NORMAL, reason=reason@entry=JS::gcreason::DESTROY\_RUNTIME) at js/src/jsgc.cpp:6379
#15 0x0000000000b289cf in JSRuntime::destroyRuntime (this=this@entry=0x7ffff69651c8) at js/src/vm/Runtime.cpp:430
#16 0x0000000000910569 in JSContext::~JSContext (this=0x7ffff6965000, \_\_in\_chrg=<optimized out>) at js/src/jscntxt.cpp:892
#17 0x00000000009108ab in js\_delete\_poison<JSContext> (p=0x7ffff6965000) at /srv/jenkins/jobs/mozilla-central-build-jsshell/workspace/arch/64/compiler/gcc/sanitizer/none/type/debug/dist/include/js/Utility.h:392
#18 js::DestroyContext (cx=0x7ffff6965000) at js/src/jscntxt.cpp:133
#19 0x0000000000896bf7 in JS\_DestroyRuntime (rt=rt@entry=0x7ffff69651c8) at js/src/jsapi.cpp:476
#20 0x0000000000438578 in main (argc=<optimized out>, argv=<optimized out>, envp=<optimized out>) at js/src/shell/js.cpp:7452
rax 0x0 0
rbx 0x7fffffffcd30 140737488342320
rcx 0x7ffff6c28a2d 140737333332525
rdx 0x0 0
rsi 0x7ffff6ef7770 140737336276848
rdi 0x7ffff6ef6540 140737336272192
rbp 0x7fffffffcdd0 140737488342480
rsp 0x7fffffffcce0 140737488342240
r8 0x7ffff6ef7770 140737336276848
r9 0x7ffff7fdc740 140737353992000
r10 0x58 88
r11 0x7ffff6b9f750 140737332770640
r12 0x7ffff7ed1718 140737352898328
r13 0x7ffff7e74640 140737352517184
r14 0xfffa7fffffffffff -1548112371908609
r15 0xfffc000000000000 -1125899906842624
rip 0x975cd0 <CompartmentCheckTracer::onChild(JS::GCCellPtr const&)+864>
=> 0x975cd0 <CompartmentCheckTracer::onChild(JS::GCCellPtr const&)+864>: movl $0x0,0x0
0x975cdb <CompartmentCheckTracer::onChild(JS::GCCellPtr const&)+875>: ud2
This might be a dup to one of the previous GC bugs on file, but I'm not sure because the assertion here is new. Marking s-s because GC is involved.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1282746#c1)• 9 years ago |
|  | |

Maybe [bug 1275080](/show_bug.cgi?id=1275080 "RESOLVED DUPLICATE - Crash [@ js::gc::TenuredCell::zone]") because it also involves Proxy?

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a192055_469204)• 9 years ago |

Whiteboard: [jsbugmon:update,bisect] → [jsbugmon:update]

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1282746#c2)• 9 years ago |
|  | |

JSBugMon: Bisection requested, result:
=== Treeherder Build Bisection Results by autoBisect ===
The "good" changeset has the timestamp "20160427220852" and the hash "37c815005a7223bb81f947957bd80ae45c26376f".
The "bad" changeset has the timestamp "20160427224854" and the hash "3c4b7e1de6290ef6e21f2f9e17f99ee5a04f47c6".
Likely regression window: <https://hg.mozilla.org/integration/mozilla-inbound/pushloghtml?fromchange=37c815005a7223bb81f947957bd80ae45c26376f&tochange=3c4b7e1de6290ef6e21f2f9e17f99ee5a04f47c6>

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1282746#c3)• 9 years ago |
|  | |

Sounds like a compartment mismatch, so I'm marking this sec-high.
The regression window blames Waldo.Flags: needinfo?(jwalden+bmo)Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1282746#c4)• 9 years ago |
|  | |

Maybe you could look at this, Eric? Thanks.Flags: needinfo?(efaustbmo)

|  | [Eric Faust [:efaust]](/user_profile?user_id=442736)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1282746#c5)• 9 years ago |
|  | |

Attached patch

[Fix](attachment.cgi?id=8773051&action=diff)
— [Details](attachment.cgi?id=8773051&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051)

This test is pretty targeted. I suggest we hold off on landing it for a while.Assignee: nobody → efaustbmoStatus: NEW → ASSIGNEDFlags: needinfo?(jwalden+bmo)Flags: needinfo?(efaustbmo)
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: review?(jwalden+bmo)

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1282746#c6)• 9 years ago |
|  | |

Comment on [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051)
Fix
Review of [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051):
-----------------------------------------------------------------
Yes, this makes sense. Don't know why I wasn't seeing this immediately when looking at this in [bug 1280246](/show_bug.cgi?id=1280246 "RESOLVED DUPLICATE - Crash [@ void js::CheckTracedThing<js::Shape>] with [@ js::ProxyObject::trace] on the stack"), and [bug 1275080](/show_bug.cgi?id=1275080 "RESOLVED DUPLICATE - Crash [@ js::gc::TenuredCell::zone]"). :-(
(I do think the proposed fix in [bug 1275080](/show_bug.cgi?id=1275080 "RESOLVED DUPLICATE - Crash [@ js::gc::TenuredCell::zone]"), which would have addressed the problem as well, is also something we should do -- but it's not critical if we make this change, which routes around the problem in similar fashion.)
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: review?(jwalden+bmo) → review+

|  | [Jeff Walden [:Waldo]](/user_profile?user_id=83595) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1282746#c9)• 9 years ago |
|  | |

There's memory-unsafety in them thar hills.Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---) → [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [Marcia Knous [:marcia]](/user_profile?user_id=8519) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1282746#c10)• 9 years ago |
|  | |

[Tracking Requested - why for this release]: Carrying over tracking flags from dupe [Bug 1275080](/show_bug.cgi?id=1275080 "RESOLVED DUPLICATE - Crash [@ js::gc::TenuredCell::zone]"). There was an open question in the other bug as to whether this affects 48 and 45esr.
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F)
[tracking-firefox48](/buglist.cgi?f1=cf_tracking_firefox48&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox48&o1=equals&v1=%3F)
[tracking-firefox49](/buglist.cgi?f1=cf_tracking_firefox49&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B)
[tracking-firefox50](/buglist.cgi?f1=cf_tracking_firefox50&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B)

|  | [Eric Faust [:efaust]](/user_profile?user_id=442736)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1282746#c11)• 9 years ago |
|  | |

Comment on [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051)
Fix
[Security approval request comment]
How easily could an exploit be constructed based on the patch?
It's not all that complicated to discover the problem, based on the patch. It involves a stray memory write and incorrect object flags, but the particular object being set is probably not actually exploitable? Still, those side effects are pretty scary. The test, which is basically the minimal operations set to hit the bug, will not land, immediately.
Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?
Nope.
Which older supported branches are affected by this flaw?
47+
If not all supported branches, which bug introduced the flaw?
[Bug 888969](/show_bug.cgi?id=888969 "RESOLVED FIXED - Implement ES6 Proxy traps for getPrototypeOf and setPrototypeOf"). The bug was closed for milestone 49, but it was leave-open for a while.
Do you have backports for the affected branches? If not, how different, hard to create, and risky will they be?
This patch should apply cleanly.
How likely is this patch to cause regressions; how much testing does it need?
Very unlikely. This just correctly handles what was an API violation to avoid a semi-random write.
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: sec-approval?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a2102017_75935)• 9 years ago |

[status-firefox47](/buglist.cgi?f1=cf_status_firefox47&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox47&o1=equals&v1=wontfix)
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected)Version: Trunk → 47 Branch

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a2102888_469204)• 9 years ago |

Whiteboard: [jsbugmon:update] → [jsbugmon:]

|  | [Fuzzing Team](/user_profile?user_id=469204) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1282746#c12)• 9 years ago |
|  | |

JSBugMon: Cannot process bug: Error: Unsupported branch "47 Branch" required by bug

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1282746#c13)• 9 years ago |
|  | |

This is too late for the current release cycle so it will have to land two weeks into the next. I'm giving it sec-approval+ for checkin on August 16 (not before). We'll want patches for affected branches made and nominated at the same time as well.
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[tracking-firefox48](/buglist.cgi?f1=cf_tracking_firefox48&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox48&o1=equals&v1=%3F) → ---Whiteboard: [jsbugmon:] → [jsbugmon:][checkin on 8/16]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a2103001_280903)• 9 years ago |

[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: sec-approval? → sec-approval+

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a3130252_280903)• 8 years ago |

[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected)
[tracking-firefox51](/buglist.cgi?f1=cf_tracking_firefox51&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1282746#c14)• 8 years ago |
|  | |

Eric, can we land this today? That would greatly help me triaging other bugs with similar signatures. Thanks!Flags: needinfo?(efaustbmo)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1282746#c15)• 8 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/fcfbc324f389>Flags: needinfo?(efaustbmo)Whiteboard: [jsbugmon:][checkin on 8/16] → [jsbugmon:]

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1282746#c16)• 8 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/fcfbc324f389>Status: ASSIGNED → RESOLVEDClosed: 8 years ago
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla51

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a4438343_1689)• 8 years ago |

Group: javascript-core-security → core-security-release

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1282746#c18)• 8 years ago |
|  | |

Can you also request uplift as Al mentioned, for aurora and beta? We are heading into beta 8 next Monday. Thanks.Flags: needinfo?(efaustbmo)

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1282746#c19)• 8 years ago |
|  | |

This can still make beta 9. Can you request uplift? It's sec-critical and we already landed the fix on m-c two weeks ago.Flags: needinfo?(nihsanullah)Flags: needinfo?(jwalden+bmo)

|  | [Eric Faust [:efaust]](/user_profile?user_id=442736)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1282746#c20)• 8 years ago |
|  | |

Comment on [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051)
Fix
Approval Request Comment
[Feature/regressing bug #]:
[Bug 888969](/show_bug.cgi?id=888969 "RESOLVED FIXED - Implement ES6 Proxy traps for getPrototypeOf and setPrototypeOf")
[User impact if declined]:
sec-crit random write.
[Describe test coverage new/current, TreeHerder]:
Landed on central 2 weeks ago. No negative reports.
[Risks and why]: Small, no new behavior, just fixes an API violation.
[String/UUID change made/needed]: None.Flags: needinfo?(nihsanullah)Flags: needinfo?(jwalden+bmo)Flags: needinfo?(efaustbmo)
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-beta?
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-aurora?

|  | [Gerry Chang [:gchang]](/user_profile?user_id=506302) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1282746#c21)• 8 years ago |
|  | |

Comment on [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051)
Fix
Review of [attachment 8773051](/attachment.cgi?id=8773051 "Fix") [[details]](/attachment.cgi?id=8773051&action=edit "Fix") [[diff]](/attachment.cgi?id=8773051&action=diff "Fix") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1282746&attachment=8773051):
-----------------------------------------------------------------
This patch fixes a sec-critical issue. Take it in aurora and 49 beta.
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-beta?
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-beta+
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-aurora?
[Attachment #8773051](/attachment.cgi?id=8773051&action=edit "Fix") -
Flags: approval-mozilla-aurora+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1282746#c22)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/20b2e73b19df>
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)Flags: in-testsuite?

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1282746#c23)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/29375a8f7973>
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed)

|  | [Matt Wobensmith [:mwobensmith][:matt:]](/user_profile?user_id=452604) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a6036092_452604)• 8 years ago |

Whiteboard: [jsbugmon:] → [jsbugmon:][post-critsmash-triage]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a6091471_280903)• 8 years ago |

Whiteboard: [jsbugmon:][post-critsmash-triage] → [jsbugmon:][post-critsmash-triage][adv-main49+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1282746#a16460510_1689)• 8 years ago |

Blocks: [888969](/show_bug.cgi?id=888969 "RESOLVED FIXED - Implement ES6 Proxy traps for getPrototypeOf and setPrototypeOf")Group: core-security-release
You need to [log in](/show_bug.cgi?id=1282746&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Eric Faust [:efaust]](/user_profile?user_id=442736)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_3069d999_20250126_095537.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1303127)
* [XML](/show_bug.cgi?ctype=xml&id=1303127)

Closed
[Bug 1303127](/show_bug.cgi?id=1303127)
(CVE-2016-5284)

Opened 8 years ago
Closed 8 years ago

# ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites

## Categories

### (Core :: Security: PSM, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Security%3A%20PSM#Security%3A%20PSM)

Security: PSM
▾

Core :: Security: PSM
The TLS configuration layer between Gecko and NSS. Handles certificate discovery, verification, and revocation checking.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Security%3A%20PSM&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Security%3A%20PSM&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Security%3A%20PSM)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

45 Branch

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

---

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Score | --- |
| a11y-review | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | [49+](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=49%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=fixed) |
| firefox50 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed) |
| firefox51 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 |  | wontfix |
| firefox49 |  | fixed |
| firefox-esr45 | 49+ | fixed |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 |  | fixed |
| firefox51 |  | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: esmedudoit, Unassigned)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

*Unassigned*

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/e31f1fe3b204c5b9c01b0a04e847bcc0?d=mm&size=40)  [esmedudoit](/user_profile?user_id=579586)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](extensions/Gravatar/web/default.jpg)  [keeler](/user_profile?user_id=349244)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

23 people

## References

### (Depends on 2 open bugs, [URL](http://seclists.org/dailydave/2016/q3/51 "http://seclists.org/dailydave/2016/q3/51") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[1303414](/show_bug.cgi?id=1303414 "NEW - increase preloaded information lifetimes"), [1285849](/show_bug.cgi?id=1285849 "RESOLVED FIXED - hsts/hpkp/blocklist update broken on mozilla-esr45 since 2016-06-02"), [1303371](/show_bug.cgi?id=1303371 "RESOLVED FIXED - Serve the HPKP header on addons.mozilla.org"), [CVE-2016-9064](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions")

[1303183](/show_bug.cgi?id=1303183 "NEW - Add-on update metadata needs to use content-signing")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=1303127&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1303127)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[seclists.org/dailydave/2016/q3/51](http://seclists.org/dailydave/2016/q3/51 "http://seclists.org/dailydave/2016/q3/51")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: sec-high)

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2016-5284

[Keywords:](/describekeywords.cgi)

[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

---

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1303127#c0)• 8 years ago |
|  | |

User Agent: Mozilla/5.0 (Linux; Android 5.0.2; LG-D415 Build/LRX22G) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.105 Mobile Safari/537.36
Steps to reproduce:
Write a malicious extension to be payload. Have it signed by Mozilla using their automated process. Generate a forged certificate for addons.mozilla.org that validates up through any CA built in to the Firefox certificate store. MiTM traffic to addons.mozilla.org trying to update NoScript or HTTPS Everywhere. Serve your malicious extension instead of the requested update to the target.
<http://seclists.org/dailydave/2016/q3/51>
Actual results:
Said "certificate issuer is not built-in", obviously not failing due to pinning reinforcement.
Expected results:
Should have said "failed to validate pinned certificate." Mozilla doesn't use normal HPKP for certs related to their operations (like addons.mozilla.org. Mozilla using a form of static key pinning. Validations weaknesses limited to statically pinned certs.

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1303127#a165_451704)• 8 years ago |

[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
--- → [49+](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=49%2B)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1303127#c1)• 8 years ago |
|  | |

Editing bug summary to reflect the core bug rather than the results.
The "certificate issuer is not built-in" error is a red-herring: vestigial code left over from a previous hard-coded pinning prior to HPKP existing as a spec, let alone supported in Firefox. Most of that was removed; I guess not all of it, but it's effectively deadcode because "real" pinning is supposed to prevent us getting there.
Why didn't pinning help? The built-in pins have an expiration date that's supposed to be about 90 days out from the release, updated weekly. Turns out the automation was broken on the ESR branch: [bug 1285849](/show_bug.cgi?id=1285849 "RESOLVED FIXED - hsts/hpkp/blocklist update broken on mozilla-esr45 since 2016-06-02")
That means the AMO pins expired on Sept 3 in releases based on 45.3 (see last line)
<https://hg.mozilla.org/releases/mozilla-esr45/file/0a590ea8e1cc4138c9bc198ba0906f099b85c346/security/manager/ssl/StaticHPKPins.h#l1233>
If addons.mozilla.org issued an HPKP header then this default expiration would have been extended with each connection so that can be considered a second bug.URL: <http://seclists.org/dailydave/2016/q3/51>Status: UNCONFIRMED → NEW
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=unaffected)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=unaffected)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=unaffected)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=unaffected)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=fixed)Component: Untriaged → Security: PSMDepends on: [1285849](/show_bug.cgi?id=1285849 "RESOLVED FIXED - hsts/hpkp/blocklist update broken on mozilla-esr45 since 2016-06-02")Ever confirmed: trueKeywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)Product: Firefox → CoreSummary: Cross-platform RCE in Tor Browser w/bypassed certificate pinning in addons.mozilla.org → ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sitesVersion: 50 Branch → 45 Branch

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1303127#c2)• 8 years ago |
|  | |

There seems to have been an automation failure on Aurora as well. Using builds from <https://ftp.mozilla.org/pub/firefox/nightly/2016/09/2016-09-03-00-40-09-mozilla-aurora/> (referenced in the article) the pins expire on Sept 10 as can be tested with <https://pinning-test.badssl.com/> and seen at
<https://hg.mozilla.org/releases/mozilla-aurora/file/d35ac86c5271f6ad22bf1f76b1bc8adb0398e7bd/security/manager/ssl/StaticHPKPins.h#l1118>
Using the builds from <https://ftp.mozilla.org/pub/firefox/nightly/2016/09/2016-09-04-00-40-02-mozilla-aurora/> we see the expiration was updated to mid-December
<https://hg.mozilla.org/releases/mozilla-aurora/file/11228436d644eaa50c2dbfb840e309c61d2bef02/security/manager/ssl/StaticHPKPins.h#l1170>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1303127#c3)• 8 years ago |
|  | |

Confirmed that static pins are working again in ESR 45.4 using builds from
<https://archive.mozilla.org/pub/firefox/candidates/45.4.0esr-candidates/build1/>
This was, indeed, due to the preload update automation failure.Status: NEW → RESOLVEDClosed: 8 years agoResolution: --- → FIXED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1303127#c4)• 8 years ago |
|  | |

The static pins in Firefox 48.0.x expired also, on Sept 10.
<https://hg.mozilla.org/releases/mozilla-release/rev/643f46ea3eaf>
The static pins in Firefox 49 are schedule to expire on Nov 5
<https://hg.mozilla.org/releases/mozilla-release/rev/39e2e75ed0c4>
But Firefox 50 isn't scheduled to be released until Nov 8 -- they will expire again!
<https://wiki.mozilla.org/RapidRelease/Calendar#Future_branch_dates>
This process is broken. I'm reopening the bug.Status: RESOLVED → REOPENED
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=unaffected) → [affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=unaffected) → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=unaffected) → [affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=unaffected) → [affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected)Resolution: FIXED → ---

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1303127#c5)• 8 years ago |
|  | |

Unless we change how we're updating the pins in Firefox 50 will expire Dec 17, but we're not releasing Firefox 51 until January 24 -- five weeks with expired pins.
<https://hg.mozilla.org/releases/mozilla-aurora/rev/66754db69a70>

|  | [:Cykesiopka](/user_profile?user_id=462935) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1303127#c7)• 8 years ago |
|  | |

So, I guess we should at least:
1. Bump the amount of time pins are valid.
The current limit was IIRC set during the time when releases were always 6 weeks apart; releases can be delayed by a week or more now.
I seem to recall some opposition to making the validity period too long though, but maybe I'm misremembering.
2. Add a test that checks that our static pins don't prematurely expire.
If we can't get automation fixed in time, we can as a last resort just commit changes that bump the expiry time manually.
keeler: Thoughts?Flags: needinfo?(dkeeler)

|  | [Dana Keeler (she/her) (use needinfo) [:keeler]](/user_profile?user_id=349244) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1303127#c8)• 8 years ago |
|  | |

(In reply to :Cykesiopka from [comment #7](/show_bug.cgi?id=1303127#c7 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> So, I guess we should at least:
> 1. Bump the amount of time pins are valid.
> The current limit was IIRC set during the time when releases were always
> 6 weeks apart; releases can be delayed by a week or more now.
Right - I filed [bug 1303414](/show_bug.cgi?id=1303414 "NEW - increase preloaded information lifetimes") for that.
> I seem to recall some opposition to making the validity period too long
> though, but maybe I'm misremembering.
I think the concern was if a user had an old version of the browser and a site had since rolled over its keys and/or CA, it wouldn't work until the list expired. I think it's acceptable to increase the timespan on which this would be a problem from "a few days after a new release" to maybe even a month or two after a new release (or more?).
> 2. Add a test that checks that our static pins don't prematurely expire.
> If we can't get automation fixed in time, we can as a last resort just
> commit changes that bump the expiry time manually.
I think this may be more of a dashboard/external tool task. We need to answer the question "Given what's in the trees and what versions are shipping when, will any preloaded information expire before (or near to when) a new version will be available?", which would rely on a lot of external information. I filed [bug 1303415](/show_bug.cgi?id=1303415 "NEW - develop tool to increase visibility on when preloaded security information will expire in versions that have shipped/will ship") on developing this.Flags: needinfo?(dkeeler)

|  | [Brian Smith (:briansmith, :bsmith, use NEEDINFO?)](/user_profile?user_id=14661) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1303127#c9)• 8 years ago |
|  | |

> Write a malicious extension to be payload. Have it signed by Mozilla using their automated process. Generate a forged certificate for addons.mozilla.org that validates up through any CA built in to the Firefox certificate store. MiTM traffic to addons.mozilla.org trying to update NoScript or HTTPS Everywhere. Serve your malicious extension instead of the requested update to the target.
Why does Firefox overwrite one extension over another? Shouldn't it be (1) Verifying the signature of the signed extension, (2) Verifying that the signed extension's extension ID (from within the signed extension) matches the extension ID of the extension it is updating, (3) Verify that the version number in the signed extension is larger than the version number of the currently-installed version? If it isn't doing #2 and #3 then that's the real bug, IMO.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1303127#c10)• 8 years ago |
|  | |

(In reply to Brian Smith (:briansmith, :bsmith, use NEEDINFO?) from [comment #9](/show_bug.cgi?id=1303127#c9 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> Shouldn't it be (1) Verifying the signature of the signed extension,
Does that.
> (2) Verifying that the signed extension's extension ID (from within the signed extension)
> matches the extension ID of the extension it is updating,
It should indeed. [bug 1303418](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions")
> (3) Verify that the version number in the signed extension is larger than the version
> number of the currently-installed version?
We do that
<https://dxr.mozilla.org/mozilla-central/source/toolkit/mozapps/extensions/internal/XPIProvider.jsm#6872>
(although a few lines above a 'compatibility update' might be able to override that? needs more investigation)

|  | [Tom S](/user_profile?user_id=393835) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1303127#c11)• 8 years ago |
|  | |

> It should indeed. [bug 1303418](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions")
Why make this bug hidden now?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1303127#c12)• 8 years ago |
|  | |

Don't know why [bug 1303418](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions") was hidden, most likely the default "security bug" setting that we forgot to change for this public security issue. It's not hidden now.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1303127#c13)• 8 years ago |
|  | |

We don't need to leave this bug open: the immediate issue is resolved.
\* Firefox ESR 45.4 will be released Sept 20 and has an appropriate pin expiration time ([bug 1285849](/show_bug.cgi?id=1285849 "RESOLVED FIXED - hsts/hpkp/blocklist update broken on mozilla-esr45 since 2016-06-02"))
\* Firefox ESR 49 will be released Sept 20 and has an appropriate pin expiration time ([bug 1303370](/show_bug.cgi?id=1303370 "RESOLVED FIXED - Update static pin expiration time for Fx 49 release before it ships"))
\* Firefox ESR 45.3 and Firefox 48 users who make a successful addon update check will
get a HPKP header, re-establishing cert pins for that domain ([bug 1303371 comment 4](/show_bug.cgi?id=1303371#c4 "RESOLVED FIXED - Serve the HPKP header on addons.mozilla.org"))
There are a number of future changes to make this more robust tracking in other bugs
\* add HPKP to the rest of AMO and increase the expiration time ([bug 1303371](/show_bug.cgi?id=1303371 "RESOLVED FIXED - Serve the HPKP header on addons.mozilla.org"))
\* verify the downloaded package updates the right add-on ([bug 1303418](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions"))
\* content-sign the update metadata ([bug 1303183](/show_bug.cgi?id=1303183 "NEW - Add-on update metadata needs to use content-signing"))
\* make sure pre-loaded pin expiration times are long enough ([bug 1303414](/show_bug.cgi?id=1303414 "NEW - increase preloaded information lifetimes"))Status: REOPENED → RESOLVEDClosed: 8 years ago → 8 years ago
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed)Depends on: [1303414](/show_bug.cgi?id=1303414 "NEW - increase preloaded information lifetimes"), [CVE-2016-9064](/show_bug.cgi?id=1303418 "VERIFIED FIXED - Addons update must verify IDs match between current and update versions"), [1303371](/show_bug.cgi?id=1303371 "RESOLVED FIXED - Serve the HPKP header on addons.mozilla.org"), [1303183](/show_bug.cgi?id=1303183 "NEW - Add-on update metadata needs to use content-signing")Resolution: --- → FIXED

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1303127#a191146_280903)• 8 years ago |

Alias: CVE-2016-5284

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1303127#c14)• 8 years ago |
|  | |

Why was my name not listed as "reporting" the bug? Having submitted the bug report, making sure to list Ryan Duff as a link to the Researcher. Looking at the summary, I see the list shows Ryan Duff as reporting the bug to Mozilla, which actually isn't factually correct. I would appreciate an explanation. Thank you.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1303127#c15)• 8 years ago |
|  | |

<https://www.mozilla.org/en-US/security/advisories/mfsa2016-85/?utm_campaign=buffer&utm_content=buffer9fa71&utm_medium=social&utm_source=twitter.com>

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1303127#c16)• 8 years ago |
|  | |

Hi esmedudoit, sorry about that. That should be fixed shortly.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1303127#c17)• 8 years ago |
|  | |

Thank you for your prompt reply. Much appreciated.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1303127#c18)• 8 years ago |
|  | |

My name btw is Esme (first name) Dudoit (last name)
(In reply to Liz Henry (:lizzard) (needinfo? me) from [comment #16](/show_bug.cgi?id=1303127#c16 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> Hi esmedudoit, sorry about that. That should be fixed shortly.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1303127#c19)• 8 years ago |
|  | |

(In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> Why was my name not listed as "reporting" the bug?
We did not learn about the issue from this bug, we heard about the issue in online chatter (for example from Ryan's post). I searched for bugs first to avoid filing a duplicate and found yours. If my search had been better I should have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1303127#c20)• 8 years ago |
|  | |

I did not use "chatter on the internet" to report this bug. I filed this bug report within the same hour that Ryan Duff posted his research. I filed an official Mozilla bug report. Ryan did not file ANY Mozilla bug reports. Unlike Nik Ungers report I did specify that this bug affected Tor Browser. I find it very off putting and intellectually dishonest of you specifically (and not Liz Henry) that you specifically say this bug report had zero barring upon the resolution and patch. I think it is abhorrently deceitful that you published that Ryan Duff reported this specific bug (1303127 [CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284)) when it is blatantly untrue.
(In reply to Daniel Veditz [:dveditz] from [comment #19](/show_bug.cgi?id=1303127#c19 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> (In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> > Why was my name not listed as "reporting" the bug?
>
> We did not learn about the issue from this bug, we heard about the issue in
> online chatter (for example from Ryan's post). I searched for bugs first to
> avoid filing a duplicate and found yours. If my search had been better I
> should have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1303127#c21)• 8 years ago |
|  | |

Furthermore, Nik Unger filed a bug report dated September 13th, I filed a bug report September 15, with a link to Ryan Duffs research. Ryan Duff irrefutably filed zero bug reports through official bugzilla channels, yet you clearly have his name written as reporting [bug 1303127](/show_bug.cgi?id=1303127 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites") ([CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284)) which as I've already stated clearly says it was reported by me Esme Dudoit. This is insulting and demeaning and it's a lie. Why do you feel the need to lie about such an inane detail is absurd. Nils report is a duplicate. You can not randomly attach the researchers name to my bug number. That's insane.
(In reply to Daniel Veditz [:dveditz] from [comment #19](/show_bug.cgi?id=1303127#c19 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> (In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> > Why was my name not listed as "reporting" the bug?
>
> We did not learn about the issue from this bug, we heard about the issue in
> online chatter (for example from Ryan's post). I searched for bugs first to
> avoid filing a duplicate and found yours. If my search had been better I
> should have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1303127#c22)• 8 years ago |
|  | |

<https://www.mozilla.org/en-US/security/advisories/mfsa2016-85/?utm_campaign=buffer&utm_content=buffer9fa71&utm_medium=social&utm_source=twitter.com> This link notes who filed Bug Report #1303127 ([CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284)) the answer is me, Esme Dudoit. It did not list a bug report number for Nik Unger or a non-existent Bug Report # from Ryan Duff. The bug report #1303127 is Esme Dudoit. [CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284) is Esme Dudoit, it is NOT Ryan Duff. Ryan Duff was the researcher whose work i linked to in MY bug report to Mozilla dated September 15, 2016.
(In reply to Daniel Veditz [:dveditz] from [comment #19](/show_bug.cgi?id=1303127#c19 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> (In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> > Why was my name not listed as "reporting" the bug?
>
> We did not learn about the issue from this bug, we heard about the issue in
> online chatter (for example from Ryan's post). I searched for bugs first to
> avoid filing a duplicate and found yours. If my search had been better I
> should have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1303127#c23)• 8 years ago |
|  | |

"[CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284) - Add-on update site certificate pin expiration [HIGH]
Reporter: Ryan Duff
Description: Due to flaws in the process we used to update "Preloaded Public Key Pinning" in our releases, the pinning for add-on updates became ineffective in early September. An attacker who was able to get a mis-issued certificate for a Mozilla web site could send malicious add-on updates to users on networks controlled by the attacker. Users who have not installed any add-ons are not affected. [1303127]"
So this above is what's written: How can this corresponding bug report number be reported by Ryan Duff? When you click on the highlighted #1303127 - it says "reported by esmedudoit" the CVE number is attached to this specific bug report. Please make a change. If you insist upon lying, remove Ryan's name and leave it blank or use Nik Ungers bug report. But don't insult my intelligence and attach someone's name who has never filed a Mozilla bug report, to my statistically accurate bug report with my name on it.
(In reply to Daniel Veditz [:dveditz] from [comment #19](/show_bug.cgi?id=1303127#c19 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> (In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> > Why was my name not listed as "reporting" the bug?
>
> We did not learn about the issue from this bug, we heard about the issue in
> online chatter (for example from Ryan's post). I searched for bugs first to
> avoid filing a duplicate and found yours. If my search had been better I
> should have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1303127#c24)• 8 years ago |
|  | |

If my bug report #1303127 [CVE-2016-5284](https://www.cve.org/CVERecord?id=CVE-2016-5284) was not the source of learning of the issue listed in <https://www.mozilla.org/en-US/security/advisories/mfsa2016-85/?utm_campaign=buffer&utm_content=buffer9fa71&utm_medium=social&utm_source=twitter.com> can you please replace it with the correct bug report number and CVE number. Please remove my Mozilla bug report number and the CVE number that corresponds to it from your blog and bug update news. It's embarrassing that Mozilla team would attach someone else's name to a bug I reported. When in fact "my bug report was not the bug that alerted you to this issue." As you stated "we learned of it from 'online chatter'" - you should make that distinction clear in your blog. Reported by: Online Chatter
"--- [Comment #19](/show_bug.cgi?id=1303127#c19 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites") from Daniel Veditz [:dveditz] <dveditz@mozilla.com> 2016-09-21 02:11:54 PDT ---
(In reply to esmedudoit from [comment #14](/show_bug.cgi?id=1303127#c14 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> Why was my name not listed as "reporting" the bug?
We did not learn about the issue from this bug, we heard about the issue in
online chatter (for example from Ryan's post). I searched for bugs first to
avoid filing a duplicate and found yours. If my search had been better I should
have found Nik Unger's [bug 1302640](/show_bug.cgi?id=1302640 "RESOLVED DUPLICATE - security.cert_pinning.enforcement_level ignored for built-in pinsets") instead."

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1303127#c25)• 8 years ago |
|  | |

So, please get another bug report number and cve number and have that bug report and that cve number list - Reporter: Ryan Duff or Reporter: Online Chatter or Reporter: Nik Unger. But please promptly remove my bug report number and CVE number. Thank you for your consideration and expediency in this matter.

|  | [Ryan Duff](/user_profile?user_id=580003) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1303127#c26)• 8 years ago |
|  | |

For what it's worth, I did report the certificate pinning expiration piece (the actual bug) to Jeff Bryner (Director of InfoSec at Mozilla) before it was posted anywhere publicly. However, I wasn't the one who found that first (that credit goes to Nicolas Vigier at The Tor Project who privately reported it to me). Because of that, I requested my name be removed from the CVE. It's been replaced with "Multiple People" which I feel accurately reflects the situation because this was a complicated vulnerability and involved multiple pieces being reported.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1303127#c27)• 8 years ago |
|  | |

Totally agree with you Ryan. That is an excellent resolution. Thank you for your honesty , consistency and humility. "Reporter: Multiple Persons" reflects transparency on Mozilla's end.
(In reply to Ryan Duff from [comment #26](/show_bug.cgi?id=1303127#c26 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> For what it's worth, I did report the certificate pinning expiration piece
> (the actual bug) to Jeff Bryner (Director of InfoSec at Mozilla) before it
> was posted anywhere publicly. However, I wasn't the one who found that first
> (that credit goes to Nicolas Vigier at The Tor Project who privately
> reported it to me). Because of that, I requested my name be removed from the
> CVE. It's been replaced with "Multiple People" which I feel accurately
> reflects the situation because this was a complicated vulnerability and
> involved multiple pieces being reported.

|  | [Esme Chloe Kealoha Dudoit](/user_profile?user_id=579586)  Reporter |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1303127#c28)• 8 years ago |
|  | |

Totally agree with you Ryan.That is an excellent resolution.Thank you for your honesty , consistency and humility. "Reporter:Multiple People" reflects transparency on Mozilla's end.
(In reply to Ryan Duff from [comment #26](/show_bug.cgi?id=1303127#c26 "RESOLVED FIXED - ESR-45/Tor Browser certificate pinning bypass for addons.mozilla.org and other built-in sites"))
> For what it's worth, I did report the certificate pinning expiration piece
> (the actual bug) to Jeff Bryner (Director of InfoSec at Mozilla) before it
> was posted anywhere publicly. However, I wasn't the one who found that first
> (that credit goes to Nicolas Vigier at The Tor Project who privately
> reported it to me). Because of that, I requested my name be removed from the
> CVE. It's been replaced with "Multiple People" which I feel accurately
> reflects the situation because this was a complicated vulnerability and
> involved multiple pieces being reported.
You need to [log in](/show_bug.cgi?id=1303127&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑



=== Content from www.mozilla.org_cbb491a8_20250125_153304.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2016-85

## Security vulnerabilities fixed in Firefox 49

Announced
September 20, 2016
Impact
critical
Products
Firefox
Fixed in

* Firefox 49

#### [#CVE-2016-2827: Out-of-bounds read in mozilla::net::IsValidReferrerPolicy](#CVE-2016-2827)

Reporter
Atte Kettunen
Impact
low
##### Description

A content security policy (CSP) containing a `referrer` directive with no values can cause a non-exploitable crash.

##### References

* [Bug 1289085](https://bugzilla.mozilla.org/show_bug.cgi?id=1289085)

#### [#CVE-2016-5270: Heap-buffer-overflow in nsCaseTransformTextRunFactory::TransformString](#CVE-2016-5270)

Reporter
Atte Kettunen
Impact
high
##### Description

An out-of-bounds write of a boolean value during text conversion with some unicode characters

##### References

* [Bug 1291016](https://bugzilla.mozilla.org/show_bug.cgi?id=1291016)

#### [#CVE-2016-5271: Out-of-bounds read in PropertyProvider::GetSpacingInternal](#CVE-2016-5271)

Reporter
Abhishek Arya
Impact
low
##### Description

An out-of-bounds read during the processing of text runs in some pages using `display:contents`.

##### References

* [Bug 1288946](https://bugzilla.mozilla.org/show_bug.cgi?id=1288946)

#### [#CVE-2016-5272: Bad cast in nsImageGeometryMixin](#CVE-2016-5272)

Reporter
Abhishek Arya
Impact
high
##### Description

A bad cast when processing layout with `input` elements can result in a potentially exploitable crash.

##### References

* [Bug 129793](https://bugzilla.mozilla.org/show_bug.cgi?id=129793)

#### [#CVE-2016-5273: crash in mozilla::a11y::HyperTextAccessible::GetChildOffset](#CVE-2016-5273)

Reporter
Nils
Impact
high
##### Description

A potentially exploitable crash in accessibility.

##### References

* [Bug 1280387](https://bugzilla.mozilla.org/show_bug.cgi?id=1280387)

#### [#CVE-2016-5276: Heap-use-after-free in mozilla::a11y::DocAccessible::ProcessInvalidationList](#CVE-2016-5276)

Reporter
Nils
Impact
high
##### Description

A use-after-free vulnerability triggered by setting a `aria-owns` attribute.

##### References

* [Bug 1287721](https://bugzilla.mozilla.org/show_bug.cgi?id=1287721)

#### [#CVE-2016-5274: use-after-free in nsFrameManager::CaptureFrameState](#CVE-2016-5274)

Reporter
Nils
Impact
high
##### Description

A use-after-free issue in web animations during restyling.

##### References

* [Bug 1282076](https://bugzilla.mozilla.org/show_bug.cgi?id=1282076)

#### [#CVE-2016-5277: Heap-use-after-free in nsRefreshDriver::Tick](#CVE-2016-5277)

Reporter
Nils
Impact
high
##### Description

A use-after-free vulnerability with web animations when destroying a timeline.

##### References

* [Bug 1291665](https://bugzilla.mozilla.org/show_bug.cgi?id=1291665)

#### [#CVE-2016-5275: Buffer overflow in mozilla::gfx::FilterSupport::ComputeSourceNeededRegions](#CVE-2016-5275)

Reporter
Nils
Impact
critical
##### Description

A buffer overflow when working with empty filters during canvas rendering.

##### References

* [Bug 1287316](https://bugzilla.mozilla.org/show_bug.cgi?id=1287316)

#### [#CVE-2016-5278: Heap-buffer-overflow in nsBMPEncoder::AddImageFrame](#CVE-2016-5278)

Reporter
Nils
Impact
critical
##### Description

A potentially exploitable crash caused by a buffer overflow while encoding image frames to images.

##### References

* [Bug 1294677](https://bugzilla.mozilla.org/show_bug.cgi?id=1294677)

#### [#CVE-2016-5279: Full local path of files is available to web pages after drag and drop](#CVE-2016-5279)

Reporter
Rafael Gieschke
Impact
moderate
##### Description

The full path to local files is available to scripts when local files are drag and dropped into Firefox.

##### References

* [Bug 1249522](https://bugzilla.mozilla.org/show_bug.cgi?id=1249522)

#### [#CVE-2016-5280: Use-after-free in mozilla::nsTextNodeDirectionalityMap::RemoveElementFromMap](#CVE-2016-5280)

Reporter
Mei Wang
Impact
high
##### Description

Use-after-free vulnerability when changing text direction.

##### References

* [Bug 1289970](https://bugzilla.mozilla.org/show_bug.cgi?id=1289970)

#### [#CVE-2016-5281: use-after-free in DOMSVGLength](#CVE-2016-5281)

Reporter
Brian Carpenter
Impact
high
##### Description

Use-after-free vulnerability when manipulating SVG format content through script.

##### References

* [Bug 1284690](https://bugzilla.mozilla.org/show_bug.cgi?id=1284690)

#### [#CVE-2016-5282: Don't allow content to request favicons from non-whitelisted schemes](#CVE-2016-5282)

Reporter
Richard Newman
Impact
moderate
##### Description

Favicons can be loaded through non-whitelisted protocols, such as `jar:`.

##### References

* [Bug 932335](https://bugzilla.mozilla.org/show_bug.cgi?id=932335)

#### [#CVE-2016-5283: Iframe src fragment timing attack can reveal cross-origin data](#CVE-2016-5283)

Reporter
Gavin Sharp
Impact
high
##### Description

A timing attack vulnerability using iframes to potentially reveal private data using document resizes and link colors.

##### References

* [Bug 928187](https://bugzilla.mozilla.org/show_bug.cgi?id=928187)

#### [#CVE-2016-5284: Add-on update site certificate pin expiration](#CVE-2016-5284)

Reporter
Multiple people
Impact
high
##### Description

Due to [flaws in the process we used to update "Preloaded Public Key Pinning"](https://blog.mozilla.org/security/2016/09/16/update-on-add-on-pinning-vulnerability/) in our releases, the pinning for add-on updates became ineffective in early September. An attacker who was able to get a mis-issued certificate for a Mozilla web site could send malicious add-on updates to users on networks controlled by the attacker. Users who have not installed any add-ons are not affected.

##### References

* [1303127](https://bugzilla.mozilla.org/show_bug.cgi?id=1303127)

#### [#CVE-2016-5256: Memory safety bugs fixed in Firefox 49](#CVE-2016-5256)

Reporter
Mozilla developers
Impact
critical
##### Description

Mozilla developers Christoph Diehl, Christian Holler, Gary Kwong, Nathan Froyd, Honza Bambas, Seth Fowler, and Michael Smith reported memory safety bugs present in Firefox 48. Some of these bugs showed evidence of memory corruption under certain circumstances could potentially exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 49](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1290244%2C1282746%2C1268034%2C1296078%2C1297099%2C1276413%2C1296087)

#### [#CVE-2016-5257: Memory safety bugs fixed in Firefox 49 and Firefox ESR 45.4](#CVE-2016-5257)

Reporter
Mozilla developers
Impact
critical
##### Description

Mozilla developers and community members Christoph Diehl, Andrew McCreight, Dan Minor, Byron Campen, Jon Coppeard, Steve Fink, Tyson Smith, Philipp, and Carsten Book reported memory safety bugs present in Firefox 48 and Firefox ESR 45.3. Some of these bugs showed evidence of memory corruption and we presume that with enough effort at least some of these could be exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 49 and Firefox ESR 45.4](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1288588%2C1287204%2C1294407%2C1293347%2C1288780%2C1288555%2C1289280%2C1294095%2C1277213)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.2/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_cfb1a07d_20250125_153315.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1296078)
* [XML](/show_bug.cgi?ctype=xml&id=1296078)

Closed
[Bug 1296078](/show_bug.cgi?id=1296078)

Opened 8 years ago
Closed 8 years ago

# format string mismatch in CreateDXVAManagerEvent::Run()

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

format string mismatch in CreateDXVAManagerEvent::Run()

## Categories

### (Core :: Audio/Video, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Audio%2FVideo#Audio%2FVideo)

Audio/Video
▾

Core :: Audio/Video
For problems related to media (video/audio) -- especially when the reporter is not sure which area of the media stack the problem is in. This category will mostly be for untriaged video/audio issues. Bugs in this category will typically be moved to another media category during the triage process.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Audio%2FVideo)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

Windows

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

normal

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla51

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox50 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed) |
| firefox51 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 |  | wontfix |
| firefox49 |  | fixed |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 |  | fixed |
| firefox51 |  | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: froydnj, Assigned: froydnj)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](extensions/Gravatar/web/default.jpg)  [froydnj](/user_profile?user_id=417288)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [froydnj](/user_profile?user_id=417288)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](extensions/Gravatar/web/default.jpg)  [jimm](/user_profile?user_id=279663)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

5 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-wildptr, sec-moderate, Whiteboard: [post-critsmash-triage][adv-main49-])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[csectype-wildptr](/buglist.cgi?keywords=csectype-wildptr&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main49-]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c7 "8 years ago") | ? |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | ? |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [avoid passing nsCString objects to %s format string codes](/attachment.cgi?id=8782125)  [8 years ago](#c1)  [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)   3.61 KB, patch | mozbugz : [review+](#c3 "8 years ago")  lizzard : [approval-mozilla-aurora+](#c9 "8 years ago")  lizzard : [approval-mozilla-beta+](#c9 "8 years ago") | [Details](/attachment.cgi?id=8782125&action=edit) | [Diff](/attachment.cgi?id=8782125&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1296078#c0)• 8 years ago |
|  | |

CreateDXVAManagerEvent::Run has two instances of code that looks like:
const nsACString& blacklistedDLL = FindD3D9BlacklistedDLL();
if (!blacklistedDLL.IsEmpty()) {
mFailureReason.AppendPrintf("D3D9 blacklisted with DLL %s",
blacklistedDLL);
} else {
...
}
Notice that we're passing the nsACString& to the printf call, rather than the char\* contained therein. clang-cl complains about this, with dire warnings about bad things happening at runtime. I don't know what MSVC does with this code, but it's clearly wrong.
Filing as a security bug because format string mismatches can be bad, but I'm not sure how bad this one is.

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1296078#c1)• 8 years ago |
|  | |

Attached patch

[avoid passing nsCString objects to %s format string codes](attachment.cgi?id=8782125&action=diff)
— [Details](attachment.cgi?id=8782125&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125)

I took the liberty of fixing up (some of) the nsACString stuff floating around
as well.
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: review?(gsquelart)

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a109_417288)• 8 years ago |

Assignee: nobody → nfroyd

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1296078#c2)• 8 years ago |
|  | |

This kind of type confusion is potentially very bad if content could control the object, but I think this is not a huge deal because it is a preference string.Keywords: [csectype-wildptr](/buglist.cgi?keywords=csectype-wildptr&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Gerald Squelart (he/him) (not at Mozilla since 2022-09-15)](/user_profile?user_id=515575) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1296078#c3)• 8 years ago |
|  | |

Comment on [attachment 8782125](/attachment.cgi?id=8782125 "avoid passing nsCString objects to %s format string codes") [[details]](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") [[diff]](/attachment.cgi?id=8782125&action=diff "avoid passing nsCString objects to %s format string codes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125)
avoid passing nsCString objects to %s format string codes
Review of [attachment 8782125](/attachment.cgi?id=8782125 "avoid passing nsCString objects to %s format string codes") [[details]](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") [[diff]](/attachment.cgi?id=8782125&action=diff "avoid passing nsCString objects to %s format string codes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125):
-----------------------------------------------------------------
r+, thank you for the patch.
Why aren't these printf-style methods not checked through gcc/clang attributes? (Happy to have a look in a separate bug.)
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: review?(gsquelart) → review+

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1296078#c4)• 8 years ago |
|  | |

(In reply to Gerald Squelart [:gerald] from [comment #3](/show_bug.cgi?id=1296078#c3 "RESOLVED FIXED - format string mismatch in CreateDXVAManagerEvent::Run()"))
> Why aren't these printf-style methods not checked through gcc/clang
> attributes? (Happy to have a look in a separate bug.)
I think this is because this code is Windows-only, and we don't compile with gcc/clang on Windows. I believe MSVC 2015 comes with some sort of format string checking...we should probably turn that on in a separate bug.

|  | [Gerald Squelart (he/him) (not at Mozilla since 2022-09-15)](/user_profile?user_id=515575) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1296078#c5)• 8 years ago |
|  | |

(In reply to Nathan Froyd [:froydnj] from [comment #4](/show_bug.cgi?id=1296078#c4 "RESOLVED FIXED - format string mismatch in CreateDXVAManagerEvent::Run()"))
> (In reply to Gerald Squelart [:gerald] from [comment #3](/show_bug.cgi?id=1296078#c3 "RESOLVED FIXED - format string mismatch in CreateDXVAManagerEvent::Run()"))
> > Why aren't these printf-style methods not checked through gcc/clang
> > attributes? (Happy to have a look in a separate bug.)
>
> I think this is because this code is Windows-only, and we don't compile with
> gcc/clang on Windows. I believe MSVC 2015 comes with some sort of format
> string checking...we should probably turn that on in a separate bug.
Oops, of course it's Windows-only code, sorry. But it seems there are indeed such checks in MSVC too.
I've opened [bug 1296122](/show_bug.cgi?id=1296122 "RESOLVED DUPLICATE - Add compiler checks to printf-style functions") to investigate further. (With no direct link with this secure bug, to protect the guilty.)

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1296078#c6)• 8 years ago |
|  | |

It looks like this code was introduced in [bug 1273691](/show_bug.cgi?id=1273691 "RESOLVED FIXED - Use pref to indicate which DLLs&versions make D3D11 crash, to fall back to D3D9") and [bug 1271525](/show_bug.cgi?id=1271525 "RESOLVED FIXED - Crash in igdumd64.dll@0xd0ef0").
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected)
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a86764_1689)• 8 years ago |

Group: core-security → media-core-security

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1296078#c7)• 8 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/7d3bc3efebe0>Status: NEW → RESOLVEDClosed: 8 years ago
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed)Flags: in-testsuite?Resolution: --- → FIXEDTarget Milestone: --- → mozilla51

|  | [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1296078#c8)• 8 years ago |
|  | |

Comment on [attachment 8782125](/attachment.cgi?id=8782125 "avoid passing nsCString objects to %s format string codes") [[details]](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") [[diff]](/attachment.cgi?id=8782125&action=diff "avoid passing nsCString objects to %s format string codes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125)
avoid passing nsCString objects to %s format string codes
Approval Request Comment
[Feature/regressing bug #]: [bug 1273691](/show_bug.cgi?id=1273691 "RESOLVED FIXED - Use pref to indicate which DLLs&versions make D3D11 crash, to fall back to D3D9") and [bug 1271525](/show_bug.cgi?id=1271525 "RESOLVED FIXED - Crash in igdumd64.dll@0xd0ef0")
[User impact if declined]: possible weird crashes on windows; it's not clear to me what MSVC would try to do with the badly-written code.
[Describe test coverage new/current, TreeHerder]: we don't have tests for this code, AFAIK, but we do set the relevant prefs in modules/libpref/init/all.js, so we will have people hitting these codepaths.
[Risks and why]: I think this a low risk patch; it converts something that's clearly weird into something that we know works correctly.
[String/UUID change made/needed]: none.
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-beta?
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-aurora?

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1296078#c9)• 8 years ago |
|  | |

Comment on [attachment 8782125](/attachment.cgi?id=8782125 "avoid passing nsCString objects to %s format string codes") [[details]](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") [[diff]](/attachment.cgi?id=8782125&action=diff "avoid passing nsCString objects to %s format string codes") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1296078&attachment=8782125)
avoid passing nsCString objects to %s format string codes
Sec bug fix, makes sense, let's uplift this for beta 7.
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-beta?
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-beta+
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-aurora?
[Attachment #8782125](/attachment.cgi?id=8782125&action=edit "avoid passing nsCString objects to %s format string codes") -
Flags: approval-mozilla-aurora+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1296078#c10)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/45689e52b2e6>
<https://hg.mozilla.org/releases/mozilla-beta/rev/93e0f3a1c480>
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a1283373_1689)• 8 years ago |

Group: media-core-security → core-security-release

|  | [Matt Wobensmith [:mwobensmith][:matt:]](/user_profile?user_id=452604) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a1684511_452604)• 8 years ago |

Whiteboard: [post-critsmash-triage]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a1740022_280903)• 8 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main49-]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1296078#a32486555_1689)• 7 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1296078&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Nathan Froyd [:froydnj]](/user_profile?user_id=417288)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_5b59db34_20250125_153313.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1290244)
* [XML](/show_bug.cgi?ctype=xml&id=1290244)

Closed
[Bug 1290244](/show_bug.cgi?id=1290244)

Opened 8 years ago
Closed 8 years ago

# Crash: double-free [@xcb\_render\_create\_picture]

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Crash: double-free [@xcb\_render\_create\_picture]

## Categories

### (Core :: Graphics: Layers, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20Layers#Graphics%3A%20Layers)

Graphics: Layers
▾

Core :: Graphics: Layers
The graphics subsystem that implements hardware-accelerated (and software) composition of layers of content.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Layers&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Layers&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20Layers)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

macOS

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla50

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| a11y-review | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox49 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected) |
| firefox50 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=unaffected) |
| firefox51 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=unaffected) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox49 |  | fixed |
| firefox-esr45 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 |  | unaffected |
| firefox51 |  | unaffected |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: posidron, Assigned: acomminos)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/119800d1637c9d7ad9cb8bba739ff23a?d=mm&size=40)  [acomminos](/user_profile?user_id=502464)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/9e7272cd8191f064be3b2b7dcd6a8903?d=mm&size=40)  [posidron](/user_profile?user_id=368570)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/17436ade8da1b23d42b3df05b9c4fc77?d=mm&size=40)  [bhood](/user_profile?user_id=697075)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

5 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[crash](/buglist.cgi?keywords=crash&resolution=---),
[csectype-other](/buglist.cgi?keywords=csectype-other&resolution=---),
[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main49+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [Testcase](/attachment.cgi?id=8775725)  [8 years ago](#c1)  [Christoph Diehl [:posidron]](/user_profile?user_id=368570)   87.90 KB, application/octet-stream |  | [Details](/attachment.cgi?id=8775725&action=edit) |
| --- | --- | --- |
| [Remove cairo image surface fallback due to threading issues.](/attachment.cgi?id=8784534)  [8 years ago](#c16)  [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)   7.62 KB, patch | lsalzman : [review+](#a2350961_536714 "8 years ago")  lizzard : [approval-mozilla-beta+](#c18 "8 years ago") | [Details](/attachment.cgi?id=8784534&action=edit) | [Diff](/attachment.cgi?id=8784534&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1290244&attachment=8784534) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1290244#c0)• 8 years ago |
|  | |

The following testcase crashes on en-us.linux-x86\_64-asan.tar.bz2 revision 1d26ac38f26ded12a7ca0fb56a67db5eef8f2c20
See attachment.
Backtrace:
==14239==ERROR: AddressSanitizer: attempting double-free on 0x603000f08e90 in thread T0:
#0 0x4b27ce in realloc /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_malloc\_linux.cc:71:3
#1 0x7f57c579d017 in xcb\_render\_create\_picture (/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x14017)
0x603000f08e90 is located 0 bytes inside of 24-byte region [0x603000f08e90,0x603000f08ea8)
freed by thread T40 (Compositor) here:
#0 0x4b215b in \_\_interceptor\_free /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_malloc\_linux.cc:38:3
#1 0x7f57c57f34ac (/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x6a4ac)
previously allocated by thread T40 (Compositor) here:
#0 0x4b27ce in realloc /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_malloc\_linux.cc:71:3
#1 0x7f57c579d017 in xcb\_render\_create\_picture (/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x14017)
Thread T40 (Compositor) created by T0 here:
#0 0x49a839 in \_\_interceptor\_pthread\_create /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_interceptors.cc:238:3
#1 0x7f57b2ab4a1b in CreateThread /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/platform\_thread\_posix.cc:137:14
#2 0x7f57b2ab4a1b in Create /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/platform\_thread\_posix.cc:148
#3 0x7f57b2ab4a1b in base::Thread::StartWithOptions(base::Thread::Options const&) /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/thread.cc:98
#4 0x7f57b41fc5b8 in CreateCompositorThread /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:105:8
#5 0x7f57b41fc5b8 in mozilla::layers::CompositorThreadHolder::CompositorThreadHolder() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:53
#6 0x7f57b41fc70a in mozilla::layers::CompositorThreadHolder::Start() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:121:33
#7 0x7f57b430e002 in InitLayersIPC /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:882:9
#8 0x7f57b430e002 in gfxPlatform::Init() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:680
#9 0x7f57b430b7a2 in gfxPlatform::GetPlatform() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:515:9
#10 0x7f57b8b5562d in CreateVsyncRefreshTimer /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:861:5
#11 0x7f57b8b5562d in nsRefreshDriver::ChooseTimer() const /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:996
#12 0x7f57b8b5861a in nsRefreshDriver::EnsureTimerStarted(nsRefreshDriver::EnsureTimerStartedFlags) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:1213:34
#13 0x7f57b8e31c26 in PresShell::ScheduleViewManagerFlush(nsIPresShell::PaintType) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsPresShell.cpp:3663:5
#14 0x7f57b8fa535c in nsIFrame::SchedulePaint(nsIFrame::PaintType) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5710:3
#15 0x7f57b8fa3c75 in InvalidateFrameInternal(nsIFrame\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5500:5
#16 0x7f57b8f32f18 in nsIFrame::InvalidateFrameSubtree(unsigned int) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5513:3
#17 0x7f57b8c7fac7 in InvalidateCanvasIfNeeded /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsCSSFrameConstructor.cpp:8508:3
#18 0x7f57b8c7fac7 in nsCSSFrameConstructor::ContentRangeInserted(nsIContent\*, nsIContent\*, nsIContent\*, nsILayoutHistoryState\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsCSSFrameConstructor.cpp:7656
#19 0x7f57b8e1cd67 in PresShell::Initialize(int, int) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsPresShell.cpp:1726:7
#20 0x7f57b496d841 in nsContentSink::StartLayout(bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/dom/base/nsContentSink.cpp:1210:19
#21 0x7f57b3d09736 in nsHtml5TreeOpExecutor::StartLayout() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOpExecutor.cpp:612:3
#22 0x7f57b3d15e8e in nsHtml5TreeOperation::Perform(nsHtml5TreeOpExecutor\*, nsIContent\*\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOperation.cpp:990:7
#23 0x7f57b3d07087 in nsHtml5TreeOpExecutor::RunFlushLoop() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOpExecutor.cpp:448:21
#24 0x7f57b3d0bb1b in nsHtml5ExecutorFlusher::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5StreamParser.cpp:128:9
#25 0x7f57b1d57ec6 in nsThread::ProcessNextEvent(bool, bool\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/xpcom/threads/nsThread.cpp:1068:7
#26 0x7f57b1dd626c in NS\_ProcessNextEvent(nsIThread\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/xpcom/glue/nsThreadUtils.cpp:290:10
#27 0x7f57b2b228af in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/glue/MessagePump.cpp:100:21
#28 0x7f57b2a970e8 in RunInternal /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:232:3
#29 0x7f57b2a970e8 in RunHandler /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:225
#30 0x7f57b2a970e8 in MessageLoop::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:205
#31 0x7f57b84dd88f in nsBaseAppShell::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/widget/nsBaseAppShell.cpp:156:3
#32 0x7f57ba40e321 in nsAppStartup::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/components/startup/nsAppStartup.cpp:284:19
#33 0x7f57ba55b873 in XREMain::XRE\_mainRun() /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4213:10
#34 0x7f57ba55ce13 in XREMain::XRE\_main(int, char\*\*, nsXREAppData const\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4332:8
#35 0x7f57ba55dcea in XRE\_main /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4423:16
#36 0x4dfb47 in do\_main /builds/slave/m-in-l64-asan-0000000000000000/build/src/browser/app/nsBrowserApp.cpp:251:10
#37 0x4dfb47 in main /builds/slave/m-in-l64-asan-0000000000000000/build/src/browser/app/nsBrowserApp.cpp:387
#38 0x7f57cb407ec4 in \_\_libc\_start\_main (/lib/x86\_64-linux-gnu/libc.so.6+0x21ec4)
SUMMARY: AddressSanitizer: double-free /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_malloc\_linux.cc:71:3 in realloc

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1290244#c1)• 8 years ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=8775725)
— [Details](attachment.cgi?id=8775725&action=edit)

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a37_368570)• 8 years ago |

Severity: normal → critical

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1290244#c2)• 8 years ago |
|  | |

Different variant which occurred 911 times in the last days in same function:
==6568==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7fa24ae0927f bp 0x603000cdb070 sp 0x7fa21b4416e0 T40)
#0 0x7fa24ae0927e in xcb\_render\_create\_picture (/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x1427e)
AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV (/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x1427e) in xcb\_render\_create\_picture
Thread T40 (Compositor) created by T0 here:
#0 0x49a839 in \_\_interceptor\_pthread\_create /builds/slave/moz-toolchain/src/llvm/projects/compiler-rt/lib/asan/asan\_interceptors.cc:238:3
#1 0x7fa238144ebb in CreateThread /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/platform\_thread\_posix.cc:137:14
#2 0x7fa238144ebb in Create /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/platform\_thread\_posix.cc:148
#3 0x7fa238144ebb in base::Thread::StartWithOptions(base::Thread::Options const&) /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/thread.cc:98
#4 0x7fa23989b1b8 in CreateCompositorThread /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:105:8
#5 0x7fa23989b1b8 in mozilla::layers::CompositorThreadHolder::CompositorThreadHolder() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:53
#6 0x7fa23989b30a in mozilla::layers::CompositorThreadHolder::Start() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/layers/ipc/CompositorThread.cpp:121:33
#7 0x7fa2399acae2 in InitLayersIPC /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:888:9
#8 0x7fa2399acae2 in gfxPlatform::Init() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:684
#9 0x7fa2399aa282 in gfxPlatform::GetPlatform() /builds/slave/m-in-l64-asan-0000000000000000/build/src/gfx/thebes/gfxPlatform.cpp:517:9
#10 0x7fa23e22348d in CreateVsyncRefreshTimer /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:861:5
#11 0x7fa23e22348d in nsRefreshDriver::ChooseTimer() const /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:996
#12 0x7fa23e226497 in nsRefreshDriver::EnsureTimerStarted(nsRefreshDriver::EnsureTimerStartedFlags) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsRefreshDriver.cpp:1213:34
#13 0x7fa23e4ff956 in PresShell::ScheduleViewManagerFlush(nsIPresShell::PaintType) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsPresShell.cpp:3663:5
#14 0x7fa23e672859 in nsIFrame::SchedulePaint(nsIFrame::PaintType) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5698:3
#15 0x7fa23e671155 in InvalidateFrameInternal(nsIFrame\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5488:5
#16 0x7fa23e600828 in nsIFrame::InvalidateFrameSubtree(unsigned int) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/generic/nsFrame.cpp:5501:3
#17 0x7fa23e34db47 in InvalidateCanvasIfNeeded /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsCSSFrameConstructor.cpp:8508:3
#18 0x7fa23e34db47 in nsCSSFrameConstructor::ContentRangeInserted(nsIContent\*, nsIContent\*, nsIContent\*, nsILayoutHistoryState\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsCSSFrameConstructor.cpp:7656
#19 0x7fa23e4ea808 in PresShell::Initialize(int, int) /builds/slave/m-in-l64-asan-0000000000000000/build/src/layout/base/nsPresShell.cpp:1726:7
#20 0x7fa23a00b01f in nsContentSink::StartLayout(bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/dom/base/nsContentSink.cpp:1210:19
#21 0x7fa2393a8666 in nsHtml5TreeOpExecutor::StartLayout() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOpExecutor.cpp:612:3
#22 0x7fa2393b4e1e in nsHtml5TreeOperation::Perform(nsHtml5TreeOpExecutor\*, nsIContent\*\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOperation.cpp:990:7
#23 0x7fa2393a5fb7 in nsHtml5TreeOpExecutor::RunFlushLoop() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5TreeOpExecutor.cpp:448:21
#24 0x7fa2393aaaab in nsHtml5ExecutorFlusher::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/parser/html/nsHtml5StreamParser.cpp:128:9
#25 0x7fa2373e8696 in nsThread::ProcessNextEvent(bool, bool\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/xpcom/threads/nsThread.cpp:1073:7
#26 0x7fa237466a3c in NS\_ProcessNextEvent(nsIThread\*, bool) /builds/slave/m-in-l64-asan-0000000000000000/build/src/xpcom/glue/nsThreadUtils.cpp:290:10
#27 0x7fa2381b2cbf in mozilla::ipc::MessagePump::Run(base::MessagePump::Delegate\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/glue/MessagePump.cpp:100:21
#28 0x7fa238127588 in RunInternal /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:235:3
#29 0x7fa238127588 in RunHandler /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:228
#30 0x7fa238127588 in MessageLoop::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/ipc/chromium/src/base/message\_loop.cc:208
#31 0x7fa23db99aaf in nsBaseAppShell::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/widget/nsBaseAppShell.cpp:156:3
#32 0x7fa23fad82d1 in nsAppStartup::Run() /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/components/startup/nsAppStartup.cpp:284:19
#33 0x7fa23fc25db3 in XREMain::XRE\_mainRun() /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4390:10
#34 0x7fa23fc27353 in XREMain::XRE\_main(int, char\*\*, nsXREAppData const\*) /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4513:8
#35 0x7fa23fc2822a in XRE\_main /builds/slave/m-in-l64-asan-0000000000000000/build/src/toolkit/xre/nsAppRunner.cpp:4608:16
#36 0x4dfb47 in do\_main /builds/slave/m-in-l64-asan-0000000000000000/build/src/browser/app/nsBrowserApp.cpp:251:10
#37 0x4dfb47 in main /builds/slave/m-in-l64-asan-0000000000000000/build/src/browser/app/nsBrowserApp.cpp:387
#38 0x7fa250a73ec4 in \_\_libc\_start\_main (/lib/x86\_64-linux-gnu/libc.so.6+0x21ec4)Severity: critical → normal

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a67527_368570)• 8 years ago |

Severity: normal → critical

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a88238_1689)• 8 years ago |

Group: core-security → gfx-core-security

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a506683_280903)• 8 years ago |

[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected)

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1290244#c3)• 8 years ago |
|  | |

Milan, can someone on your team take a look since this is sec-critical? Thanks.
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=%3F)
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F)Flags: needinfo?(milan)

|  | [Milan Sreckovic [:milan] (needinfo for best results)](/user_profile?user_id=456486) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a1036681_456486)• 8 years ago |

Flags: needinfo?(milan)

|  | [Milan Sreckovic [:milan] (needinfo for best results)](/user_profile?user_id=456486) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1290244#c4)• 8 years ago |
|  | |

Lee, Andrew, thoughts? We expect a system cairo call here?Flags: needinfo?(lsalzman)Flags: needinfo?(andrew)

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1290244#c5)• 8 years ago |
|  | |

There shouldn't be any, no- even if XRender is enabled, we don't let system cairo create any kind of Xlib cairo surfaces.
It's worth noting that the revision used does use native cairo if X11 SHM is unavailable as a fallback, but only with image surfaces. This was replaced by my WindowSurface patches in 50. It's unlikely to be responsible for this XCB XRender call though.
<http://hg.mozilla.org/mozilla-central/file/1d26ac38f26ded12a7ca0fb56a67db5eef8f2c20/widget/gtk/nsWindow.cpp>
A stack of the offending thread would be most helpful here- I'd guess that GDK is making the call.Flags: needinfo?(andrew)

|  | [Milan Sreckovic [:milan] (needinfo for best results)](/user_profile?user_id=456486) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1290244#c6)• 8 years ago |
|  | |

Christoph, see [comment 5](/show_bug.cgi?id=1290244#c5 "RESOLVED FIXED - Crash: double-free [@xcb_render_create_picture]") ask.Flags: needinfo?(cdiehl)

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1290244#c7)• 8 years ago |
|  | |

That's all the information I am able to provide.
However, I do get a lot of null-ptr crashes with those stack signatures:
911 crashes
"xcb\_render\_create\_picture",
"\_\_interceptor\_pthread\_create",
"CreateThread",
"Create",
"base::Thread::StartWithOptions",
"CreateCompositorThread",
"mozilla::layers::CompositorThreadHolder::CompositorThreadHolder",
"mozilla::layers::CompositorThreadHolder::Start"
720 crashes
"/lib/x86\_64-linux-gnu/libc.so.6+0x152105",
"xcb\_render\_create\_picture"
15
"/usr/lib/x86\_64-linux-gnu/libcairo.so.2+0x69c63",
"\_\_interceptor\_pthread\_create",
"CreateThread",
"Create",
"base::Thread::StartWithOptions",
"CreateCompositorThread",
"mozilla::layers::CompositorThreadHolder::CompositorThreadHolder",
"mozilla::layers::CompositorThreadHolder::Start"Flags: needinfo?(cdiehl)

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1290244#c8)• 8 years ago |
|  | |

Stupid question but is it possible that 'xvfb-run' can influence such behavior?

|  | [Milan Sreckovic [:milan] (needinfo for best results)](/user_profile?user_id=456486) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1290244#c9)• 8 years ago |
|  | |

Andrew, can you dig deeper into this? At least to get to the point where we may know if it's us or GTK (Lee mentioned it could be) and get us to something actionable.Assignee: nobody → andrewFlags: needinfo?(lsalzman) → needinfo?(andrew)

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1290244#c10)• 8 years ago |
|  | |

Sure, I'll take a look. I suspect it's a drawing call made by GTK as well.
Christoph, can you provide me with your GTK version? In addition, it would be helpful if you could check the status of the GTK\_CSD environment variable- if GTK is drawing client side decorations, it \*will\* make calls to XRender.Flags: needinfo?(andrew)

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a1717570_502464)• 8 years ago |

Flags: needinfo?(cdiehl)

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1290244#c11)• 8 years ago |
|  | |

$ dpkg -s libgtk-3-0 | grep '^Version' | cut -d' ' -f2-
3.10.8-0ubuntu1.6
GTK\_CSD is empty. It's a headless system at EC2.Flags: needinfo?(cdiehl)

|  | [Christoph Diehl [:posidron]](/user_profile?user_id=368570)  Reporter |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1290244#c12)• 8 years ago |
|  | |

$ dpkg -l libgtk\* | grep -e '^i' | grep -e 'libgtk-\*[0-9]'
ii libgtk-3-0:amd64 3.10.8-0ubuntu1.6 amd64 GTK+ graphical user interface library
ii libgtk-3-0-dbg:amd64 3.10.8-0ubuntu1.6 amd64 GTK+ libraries and debugging symbols
ii libgtk-3-bin 3.10.8-0ubuntu1.6 amd64 programs for the GTK+ graphical user interface library
ii libgtk-3-common 3.10.8-0ubuntu1.6 all common files for the GTK+ graphical user interface library
ii libgtk2.0-0:amd64 2.24.23-0ubuntu1.1 amd64 GTK+ graphical user interface library
ii libgtk2.0-common 2.24.23-0ubuntu1.1 all common files for the GTK+ graphical user interface library
ii libgtk2.0-dev 2.24.23-0ubuntu1.1 amd64 development files for the GTK+ library

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1290244#c13)• 8 years ago |
|  | |

Thanks for the info. This is almost certainly a result of gdk\_cairo\_create being called to instantiate a cairo context for a GdkWindow on the compositor thread. We've had issues with the function not being thread-safe in the past, as GDK expecting it only to be called from the main thread in the "draw" handler ([bug 1285561](/show_bug.cgi?id=1285561 "RESOLVED FIXED - gdk_cairo_create is called off the main thread")). Cairo reference counting is atomic, but we can still race and perform a double-free when the main thread calls cairo\_surface\_finish (as GDK occasionally does).
The "good" news is that this path won't happen for most users- we only fall back to cairo blitting when we don't have MIT-SHM available, or if we fail to paint to the window with SHM. MIT-SHM is a widely available X extension and many applications explicitly require it.
The patch in [bug 1285561](/show_bug.cgi?id=1285561 "RESOLVED FIXED - gdk_cairo_create is called off the main thread") that solves this is rather large- it could potentially be uplifted, though. Alternatively, we could throw in our XRender drawing path instead when we don't have SHM, as we did prior to the addition of the gdk\_cairo\_create fallback.
What do you think, Milan?Flags: needinfo?(milan)

|  | [Milan Sreckovic [:milan] (needinfo for best results)](/user_profile?user_id=456486) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1290244#c14)• 8 years ago |
|  | |

Situation not being common - I'm worried about the mention of EC2 in [comment 11](/show_bug.cgi?id=1290244#c11 "RESOLVED FIXED - Crash: double-free [@xcb_render_create_picture]"), so I'm not sure we can ignore this problem on that front.
The fix is on 50, so the question is whether we need to fix this bug before November when 50 releases. The patch in [bug 1285561](/show_bug.cgi?id=1285561 "RESOLVED FIXED - gdk_cairo_create is called off the main thread") is not small, but it has been on 50 since the middle of July, and no regressions are currently linked to it.
As a first pass, I'd like to see the alternative patch (XRender path when SHM is not there), that we would uplift all the way if necessary.Flags: needinfo?(milan)

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a2241384_502464)• 8 years ago |

[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=%3F) → [affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [unaffected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=unaffected)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected) → [unaffected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=unaffected)

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1290244#c15)• 8 years ago |
|  | |

We are coming up on the beta 7 build tomorrow, so we could still take a patch if you manage to cherry pick a fix that applies to 49.

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1290244#c16)• 8 years ago |
|  | |

Attached patch

[Remove cairo image surface fallback due to threading issues.](attachment.cgi?id=8784534&action=diff)
— [Details](attachment.cgi?id=8784534&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1290244&attachment=8784534)

Here's a patch removing the image surface fallback case, reverting to XRender.
[Attachment #8784534](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") -
Flags: review?(lsalzman)

|  | [Lee Salzman [:lsalzman]](/user_profile?user_id=536714) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a2350961_536714)• 8 years ago |

[Attachment #8784534](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") -
Flags: review?(lsalzman) → review+

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1290244#c17)• 8 years ago |
|  | |

Comment on [attachment 8784534](/attachment.cgi?id=8784534 "Remove cairo image surface fallback due to threading issues.") [[details]](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") [[diff]](/attachment.cgi?id=8784534&action=diff "Remove cairo image surface fallback due to threading issues.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1290244&attachment=8784534)
Remove cairo image surface fallback due to threading issues.
Approval Request Comment
[Feature/regressing bug #]: 1015218
[User impact if declined]: Possibility for threading issues depending on the user's GTK version.
[Describe test coverage new/current, TreeHerder]: N/A
[Risks and why]: It's possible that our XRender backend may have regressed; it's unlikely, and the majority of users won't even fall back to this path.
[String/UUID change made/needed]: N/A
[Attachment #8784534](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") -
Flags: approval-mozilla-beta?

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1290244#c18)• 8 years ago |
|  | |

Comment on [attachment 8784534](/attachment.cgi?id=8784534 "Remove cairo image surface fallback due to threading issues.") [[details]](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") [[diff]](/attachment.cgi?id=8784534&action=diff "Remove cairo image surface fallback due to threading issues.") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1290244&attachment=8784534)
Remove cairo image surface fallback due to threading issues.
Fix for a sec-critical crash, let's uplift for beta 7.
[Attachment #8784534](/attachment.cgi?id=8784534&action=edit "Remove cairo image surface fallback due to threading issues.") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a2408131_502464)• 8 years ago |

Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1290244#c19)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/fe99dea1a20d>
This needs to land on esr45 too, yes?Status: NEW → RESOLVEDClosed: 8 years ago
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F)Flags: needinfo?(andrew)Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)Resolution: --- → FIXEDTarget Milestone: --- → mozilla50

|  | [Andrew Comminos [:acomminos]](/user_profile?user_id=502464)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1290244#c20)• 8 years ago |
|  | |

Nope, it's unaffected according to <https://hg.mozilla.org/releases/mozilla-esr45/file/tip/widget/gtk/nsWindow.cpp>.Flags: needinfo?(andrew)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1290244#c21)• 8 years ago |
|  | |

Ah great, thanks!
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected)
[tracking-firefox-esr45](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox_esr45&o1=equals&v1=%3F) → ---

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a3011380_1689)• 8 years ago |

Group: gfx-core-security → core-security-release

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a3467634_280903)• 8 years ago |

Whiteboard: [adv-main49+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1290244#a16918109_1689)• 8 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1290244&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Christoph Diehl [:posidron]](/user_profile?user_id=368570)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_dafc0c65_20250125_153319.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1297099)
* [XML](/show_bug.cgi?ctype=xml&id=1297099)

Closed
[Bug 1297099](/show_bug.cgi?id=1297099)

Opened 8 years ago
Closed 8 years ago

# LoadManagerSingleton weak reference used on multiple threads

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

LoadManagerSingleton weak reference used on multiple threads

## Categories

### (Core :: Audio/Video: MediaStreamGraph, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Audio%2FVideo%3A%20MediaStreamGraph#Audio%2FVideo%3A%20MediaStreamGraph)

Audio/Video: MediaStreamGraph
▾

Core :: Audio/Video: MediaStreamGraph
Any bug related to MediaStreams, MediaStreamTracks, TrackUnions and the MediaStream GraphDriver.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo%3A%20MediaStreamGraph&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Audio%2FVideo%3A%20MediaStreamGraph&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Audio%2FVideo%3A%20MediaStreamGraph)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

48 Branch

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

critical

[Rank:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rank)

10

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

mozilla51

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |
| a11y-review | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix) |
| firefox49 | [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed) |
| firefox-esr45 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected) |
| firefox50 | [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed) |
| firefox51 | [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| firefox48 |  | wontfix |
| firefox49 | + | fixed |
| firefox-esr45 |  | unaffected |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox50 | + | fixed |
| firefox51 | + | fixed |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: mayhemer, Assigned: pehrsons)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/906f005aaa08b2d109a3fa9e1b83000d?d=mm&size=40)  [pehrsons](/user_profile?user_id=489889)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](extensions/Gravatar/web/default.jpg)  [mayhemer](/user_profile?user_id=269762)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/15d034eb5ed480cb10a8a9e41e8b9f13?d=mm&size=40)  [karlt](/user_profile?user_id=274246)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

9 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[956338](/show_bug.cgi?id=956338 "RESOLVED FIXED - Add checks to WeakPtr and related classes to assert single-thread usage"), [1208371](/show_bug.cgi?id=1208371 "RESOLVED FIXED - Implement MediaStream/MediaStreamTrack.clone()")

Dependency [tree](/showdependencytree.cgi?id=1297099&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1297099)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: sec-critical, Whiteboard: [post-critsmash-triage][adv-main49+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main49+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [mwobensmith](/user_profile?user_id=452604) | [qe-verify](#a1271501_452604 "8 years ago") | - |
| --- | --- | --- |
| [mwobensmith](/user_profile?user_id=452604) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (1 file)

| [Change LoadManagerSingleton WeakPtr to RefPtr](/attachment.cgi?id=8784250)  [8 years ago](#c6)  [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)   2.85 KB, patch | jesup : [review+](#a172626_11539 "8 years ago")  lizzard : [approval-mozilla-aurora+](#c14 "8 years ago")  lizzard : [approval-mozilla-beta+](#c14 "8 years ago")  abillings : [sec-approval+](#a182433_280903 "8 years ago") | [Details](/attachment.cgi?id=8784250&action=edit) | [Diff](/attachment.cgi?id=8784250&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1297099&attachment=8784250) |
| --- | --- | --- |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Honza Bambas (:mayhemer)](/user_profile?user_id=269762)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1297099#c0)• 8 years ago |
|  | |

Introduced in <https://hg.mozilla.org/mozilla-central/rev/08e7e6ddff87>, [bug 1208371](/show_bug.cgi?id=1208371 "RESOLVED FIXED - Implement MediaStream/MediaStreamTrack.clone()").
[Bug 956338](/show_bug.cgi?id=956338 "RESOLVED FIXED - Add checks to WeakPtr and related classes to assert single-thread usage") adds assertions to check whether weak referencing is correctly used only on a single thread. For LoadManagerSingleton this fails.
<https://treeherder.mozilla.org/logviewer.html#?job_id=26046916&repo=try#L13081>
<https://treeherder.mozilla.org/#/jobs?repo=try&revision=74cbb9192861e6cbc46a615940c28b0b24c5a3d8>
tests: dom/media/tests/mochitest/test\_peerConnection\_\*
11:06:52 INFO - Assertion failure: \_empty || \_owningThread == std::this\_thread::get\_id() (WeakPtr used on multiple threads), at /builds/slave/try-lx-d-000000000000000000000/build/src/obj-firefox/dist/include/mozilla/WeakPtr.h:146
11:06:52 INFO - #01: mozilla::detail::WeakReference<mozilla::LoadManagerSingleton>::get [mfbt/WeakPtr.h:146]
11:06:52 INFO - #02: mozilla::LoadManager::NormalUsage [dom/media/systemservices/LoadManager.h:111]
11:06:52 INFO - #03: webrtc::OveruseFrameDetector::Process [media/webrtc/trunk/webrtc/video\_engine/overuse\_frame\_detector.cc:538]
11:06:52 INFO - #04: webrtc::ProcessThreadImpl::Process [media/webrtc/trunk/webrtc/modules/utility/source/process\_thread\_impl.cc:213]
11:06:52 INFO - #05: webrtc::ThreadPosix::Run [media/webrtc/trunk/webrtc/system\_wrappers/source/thread\_posix.cc:174]
This is likely a highly critical bug.Flags: needinfo?(pkerr)Flags: needinfo?(pehrson)

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a91388_489889)• 8 years ago |

Assignee: nobody → pehrsonStatus: NEW → ASSIGNEDRank: 15Flags: needinfo?(pehrson)Priority: -- → P1

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1297099#c1)• 8 years ago |
|  | |

Per mayhemer, marking as sec-critical (might be high, not sure of the failure modes for this threading issue without looking at the code for the WeakRef).Keywords: [sec-critical](/buglist.cgi?keywords=sec-critical&resolution=---)

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a91874_11539)• 8 years ago |

Rank: 15 → 10
[status-firefox-esr45](/buglist.cgi?f1=cf_status_firefox_esr45&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr45&o1=equals&v1=unaffected)

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1297099#c2)• 8 years ago |
|  | |

We check that the singleton is created and destroyed on main thread, and it's only destroyed by an xpcom-shutdown observer.
Question is how many LoadManager consumers are alive after xpcom-shutdown.

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1297099#c3)• 8 years ago |
|  | |

(In reply to Andreas Pehrson [:pehrsons] (Telenor) from [comment #2](/show_bug.cgi?id=1297099#c2 "RESOLVED FIXED - LoadManagerSingleton weak reference used on multiple threads"))
> We check that the singleton is created and destroyed on main thread, and
> it's only destroyed by an xpcom-shutdown observer.
>
> Question is how many LoadManager consumers are alive after xpcom-shutdown.
None I hope, but this isn't at xpcom-shutdown; this is flagging that the WeakRef was used from two threads, which is invalid.

|  | [Honza Bambas (:mayhemer)](/user_profile?user_id=269762)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1297099#c4)• 8 years ago |
|  | |

If you can strongly ensure that the weak referenced object over-lives all of its referrers, then you don't need support for weak referencing at all. That would be the best solution here.
The problem the added assertions in [bug 956338](/show_bug.cgi?id=956338 "RESOLVED FIXED - Add checks to WeakPtr and related classes to assert single-thread usage") try to catch is attempt to access weak ptr on one thread while the real object is just being destroyed on another thread. Hence the simple restriction to query weak ptrs only on a single thread.
Dereference of a weak ptr to the same object on more then one thread (say A and B) is \_LIKELY\_ bad, at least it's a very bad programing architecture. If you expect the real object go away on either thread A or B or even some thread X, then you cannot avoid very dangerous race conditions when referrers, still alive, keep the weak ref and try to query it.

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1297099#c5)• 8 years ago |
|  | |

Well it was added for a reason. IIRC there were intermittents at shutdown.
Isn't it less critical in this mode though? I.e., when we only reset the ptr at shutdown rather than doing it whenever?

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1297099#c6)• 8 years ago |
|  | |

Attached patch

[Change LoadManagerSingleton WeakPtr to RefPtr](attachment.cgi?id=8784250&action=diff)
— [Details](attachment.cgi?id=8784250&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1297099&attachment=8784250)

Flags: needinfo?(pkerr)
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: review?(rjesup)

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1297099#c7)• 8 years ago |
|  | |

Try push: <https://treeherder.mozilla.org/#/jobs?repo=try&revision=bce98fc244f1>

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a172626_11539)• 8 years ago |

[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: review?(rjesup) → review+

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1297099#c8)• 8 years ago |
|  | |

Comment on [attachment 8784250](/attachment.cgi?id=8784250 "Change LoadManagerSingleton WeakPtr to RefPtr") [[details]](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") [[diff]](/attachment.cgi?id=8784250&action=diff "Change LoadManagerSingleton WeakPtr to RefPtr") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1297099&attachment=8784250)
Change LoadManagerSingleton WeakPtr to RefPtr
[Security approval request comment]
How easily could an exploit be constructed based on the patch? Not easily
Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem? No
Which older supported branches are affected by this flaw? 48 onwards
If not all supported branches, which bug introduced the flaw?
Do you have backports for the affected branches? If not, how different, hard to create, and risky will they be? This should go clean on all the branches affected.
How likely is this patch to cause regressions; how much testing does it need? The only risk is a leak but initial try runs look good.
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: sec-approval?

|  | [Honza Bambas (:mayhemer)](/user_profile?user_id=269762)  Reporter |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1297099#c9)• 8 years ago |
|  | |

Thanks for fixing this so quickly!

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1297099#c10)• 8 years ago |
|  | |

sec-approval+ for trunk. Please nominate patches for Aurora and Beta as well. We need to get all of these in this week.
[status-firefox48](/buglist.cgi?f1=cf_status_firefox48&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox48&o1=equals&v1=wontfix)
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected)
[tracking-firefox49](/buglist.cgi?f1=cf_tracking_firefox49&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox49&o1=equals&v1=%2B)
[tracking-firefox50](/buglist.cgi?f1=cf_tracking_firefox50&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox50&o1=equals&v1=%2B)
[tracking-firefox51](/buglist.cgi?f1=cf_tracking_firefox51&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox51&o1=equals&v1=%2B)

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a182433_280903)• 8 years ago |

[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: sec-approval? → sec-approval+

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1297099#c11)• 8 years ago |
|  | |

Comment on [attachment 8784250](/attachment.cgi?id=8784250 "Change LoadManagerSingleton WeakPtr to RefPtr") [[details]](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") [[diff]](/attachment.cgi?id=8784250&action=diff "Change LoadManagerSingleton WeakPtr to RefPtr") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1297099&attachment=8784250)
Change LoadManagerSingleton WeakPtr to RefPtr
Approval Request Comment
[Feature/regressing bug #]: Track cloning
[User impact if declined]: Security issue would be fixed on nightly, not beta/aurora. May be very hard to exploit, even if you know where it is, since it's being released during shutdown.
[Describe test coverage new/current, TreeHerder]: Was found by Honza on a Try push I believe due to a new assertion.
[Risks and why]: Low risk - basically converting a weak ref to a strong one. Biggest risk would be a leak.
[String/UUID change made/needed]: none
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-beta?
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-aurora?

|  | [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a232166_489889)• 8 years ago |

Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1297099#c12)• 8 years ago |
|  | |

<https://hg.mozilla.org/integration/mozilla-inbound/rev/521e476f0c714ff4e92c7220e81b40e56972f58c>Keywords: [checkin-needed](/buglist.cgi?keywords=checkin-needed&resolution=---)

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1297099#c13)• 8 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/521e476f0c71>Status: ASSIGNED → RESOLVEDClosed: 8 years ago
[status-firefox51](/buglist.cgi?f1=cf_status_firefox51&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox51&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → mozilla51

|  | [Liz Henry (:lizzard) (relman/hg->git project)](/user_profile?user_id=451704) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1297099#c14)• 8 years ago |
|  | |

Comment on [attachment 8784250](/attachment.cgi?id=8784250 "Change LoadManagerSingleton WeakPtr to RefPtr") [[details]](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") [[diff]](/attachment.cgi?id=8784250&action=diff "Change LoadManagerSingleton WeakPtr to RefPtr") [[review]](/page.cgi?id=splinter.html&ignore=&bug=1297099&attachment=8784250)
Change LoadManagerSingleton WeakPtr to RefPtr
Fix for sec-critical issue, let's uplift this for beta 8.
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-beta?
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-beta+
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-aurora?
[Attachment #8784250](/attachment.cgi?id=8784250&action=edit "Change LoadManagerSingleton WeakPtr to RefPtr") -
Flags: approval-mozilla-aurora+

|  | [Wes Kocher (:KWierso) (Not reading bugmail; email directly if needed)](/user_profile?user_id=308534) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1297099#c15)• 8 years ago |
|  | |

<https://hg.mozilla.org/releases/mozilla-aurora/rev/c20fd556d065>
<https://hg.mozilla.org/releases/mozilla-beta/rev/550118c88012>
[status-firefox49](/buglist.cgi?f1=cf_status_firefox49&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox49&o1=equals&v1=fixed)
[status-firefox50](/buglist.cgi?f1=cf_status_firefox50&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox50&o1=equals&v1=fixed)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a870107_1689)• 8 years ago |

Group: core-security → core-security-release

|  | [Matt Wobensmith [:mwobensmith][:matt:]](/user_profile?user_id=452604) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a1271501_452604)• 8 years ago |

Flags: qe-verify-Whiteboard: [post-critsmash-triage]

|  | [Al Billings [:abillings - ex-MoCo]](/user_profile?user_id=280903) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a1327554_280903)• 8 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main49+]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1297099#a14776838_1689)• 8 years ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1297099&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Andreas Pehrson [:pehrsons]](/user_profile?user_id=489889)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


