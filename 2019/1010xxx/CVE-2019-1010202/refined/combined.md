=== Content from github.com_3d514db9_20250121_003141.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fthinkgem%2Fjeesite%2Fblob%2Fmaster%2Fsrc%2Fmain%2Fjava%2Fcom%2Fthinkgem%2Fjeesite%2Fmodules%2Fact%2Fservice%2FActProcessService.java)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fthinkgem%2Fjeesite%2Fblob%2Fmaster%2Fsrc%2Fmain%2Fjava%2Fcom%2Fthinkgem%2Fjeesite%2Fmodules%2Fact%2Fservice%2FActProcessService.java)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=thinkgem%2Fjeesite)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[thinkgem](/thinkgem)
/
**[jeesite](/thinkgem/jeesite)**
Public

* [Notifications](/login?return_to=%2Fthinkgem%2Fjeesite) You must be signed in to change notification settings
* [Fork
  5.7k](/login?return_to=%2Fthinkgem%2Fjeesite)
* [Star
   8k](/login?return_to=%2Fthinkgem%2Fjeesite)

* [Code](/thinkgem/jeesite/tree/master)
* [Issues
  194](/thinkgem/jeesite/issues)
* [Pull requests
  12](/thinkgem/jeesite/pulls)
* [Actions](/thinkgem/jeesite/actions)
* [Projects
  0](/thinkgem/jeesite/projects)
* [Wiki](/thinkgem/jeesite/wiki)
* [Security](/thinkgem/jeesite/security)
* [Insights](/thinkgem/jeesite/pulse)

Additional navigation options

* [Code](/thinkgem/jeesite/tree/master)
* [Issues](/thinkgem/jeesite/issues)
* [Pull requests](/thinkgem/jeesite/pulls)
* [Actions](/thinkgem/jeesite/actions)
* [Projects](/thinkgem/jeesite/projects)
* [Wiki](/thinkgem/jeesite/wiki)
* [Security](/thinkgem/jeesite/security)
* [Insights](/thinkgem/jeesite/pulse)

## Files

 master
## Breadcrumbs

1. [jeesite](/thinkgem/jeesite/tree/master)
2. /[src](/thinkgem/jeesite/tree/master/src)
3. /[main](/thinkgem/jeesite/tree/master/src/main)
4. /[java](/thinkgem/jeesite/tree/master/src/main/java)
5. /[com](/thinkgem/jeesite/tree/master/src/main/java/com)
6. /[thinkgem](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem)
7. /[jeesite](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite)
8. /[modules](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules)
9. /[act](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules/act)
10. /[service](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules/act/service)
/
# ActProcessService.java

Copy path Blame  Blame
## Latest commit

## History

[History](/thinkgem/jeesite/commits/master/src/main/java/com/thinkgem/jeesite/modules/act/service/ActProcessService.java)309 lines (257 loc) · 11.2 KB master
## Breadcrumbs

1. [jeesite](/thinkgem/jeesite/tree/master)
2. /[src](/thinkgem/jeesite/tree/master/src)
3. /[main](/thinkgem/jeesite/tree/master/src/main)
4. /[java](/thinkgem/jeesite/tree/master/src/main/java)
5. /[com](/thinkgem/jeesite/tree/master/src/main/java/com)
6. /[thinkgem](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem)
7. /[jeesite](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite)
8. /[modules](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules)
9. /[act](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules/act)
10. /[service](/thinkgem/jeesite/tree/master/src/main/java/com/thinkgem/jeesite/modules/act/service)
/
# ActProcessService.java

Top
## File metadata and controls

* Code
* Blame

309 lines (257 loc) · 11.2 KB[Raw](https://github.com/thinkgem/jeesite/raw/refs/heads/master/src/main/java/com/thinkgem/jeesite/modules/act/service/ActProcessService.java)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309/\*\* \* Copyright &copy; 2012-2016 <a href="https://github.com/thinkgem/jeesite">JeeSite</a> All rights reserved. \*/package com.thinkgem.jeesite.modules.act.service;
import java.io.File;import java.io.IOException;import java.io.InputStream;import java.io.InputStreamReader;import java.io.UnsupportedEncodingException;import java.util.ArrayList;import java.util.List;import java.util.zip.ZipInputStream;
import javax.xml.stream.XMLInputFactory;import javax.xml.stream.XMLStreamException;import javax.xml.stream.XMLStreamReader;
import org.activiti.bpmn.converter.BpmnXMLConverter;import org.activiti.bpmn.model.BpmnModel;import org.activiti.editor.constants.ModelDataJsonConstants;import org.activiti.editor.language.json.converter.BpmnJsonConverter;import org.activiti.engine.ActivitiException;import org.activiti.engine.RepositoryService;import org.activiti.engine.RuntimeService;import org.activiti.engine.repository.Deployment;import org.activiti.engine.repository.ProcessDefinition;import org.activiti.engine.repository.ProcessDefinitionQuery;import org.activiti.engine.runtime.ProcessInstance;import org.activiti.engine.runtime.ProcessInstanceQuery;import org.apache.commons.io.FileUtils;import org.apache.commons.io.FilenameUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.multipart.MultipartFile;
import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.databind.node.ObjectNode;import com.thinkgem.jeesite.common.persistence.Page;import com.thinkgem.jeesite.common.service.BaseService;import com.thinkgem.jeesite.common.utils.StringUtils;
/\*\* \* 流程定义相关Controller \* @author ThinkGem \* @version 2013-11-03 \*/@Service@Transactional(readOnly = true)public class ActProcessService extends BaseService {
 @Autowired private RepositoryService repositoryService; @Autowired private RuntimeService runtimeService;
 /\*\* \* 流程定义列表 \*/ public Page<Object[]> processList(Page<Object[]> page, String category) {
 ProcessDefinitionQuery processDefinitionQuery = repositoryService.createProcessDefinitionQuery() .latestVersion().orderByProcessDefinitionKey().asc();  if (StringUtils.isNotEmpty(category)){ processDefinitionQuery.processDefinitionCategory(category); }  page.setCount(processDefinitionQuery.count());  List<ProcessDefinition> processDefinitionList = processDefinitionQuery.listPage(page.getFirstResult(), page.getMaxResults()); for (ProcessDefinition processDefinition : processDefinitionList) { String deploymentId = processDefinition.getDeploymentId(); Deployment deployment = repositoryService.createDeploymentQuery().deploymentId(deploymentId).singleResult(); page.getList().add(new Object[]{processDefinition, deployment}); }
 return page; }
 /\*\* \* 流程定义列表 \*/ public Page<ProcessInstance> runningList(Page<ProcessInstance> page, String procInsId, String procDefKey) {
 ProcessInstanceQuery processInstanceQuery = runtimeService.createProcessInstanceQuery();
 if (StringUtils.isNotBlank(procInsId)){ processInstanceQuery.processInstanceId(procInsId); }  if (StringUtils.isNotBlank(procDefKey)){ processInstanceQuery.processDefinitionKey(procDefKey); }  page.setCount(processInstanceQuery.count()); page.setList(processInstanceQuery.listPage(page.getFirstResult(), page.getMaxResults())); return page; }  /\*\* \* 读取资源，通过部署ID \* @param processDefinitionId 流程定义ID \* @param processInstanceId 流程实例ID \* @param resourceType 资源类型(xml|image) \*/ public InputStream resourceRead(String procDefId, String proInsId, String resType) throws Exception {  if (StringUtils.isBlank(procDefId)){ ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(proInsId).singleResult(); procDefId = processInstance.getProcessDefinitionId(); } ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(procDefId).singleResult();  String resourceName = ""; if (resType.equals("image")) { resourceName = processDefinition.getDiagramResourceName(); } else if (resType.equals("xml")) { resourceName = processDefinition.getResourceName(); }  InputStream resourceAsStream = repositoryService.getResourceAsStream(processDefinition.getDeploymentId(), resourceName); return resourceAsStream; }  /\*\* \* 部署流程 - 保存 \* @param file \* @return \*/ @Transactional(readOnly = false) public String deploy(String exportDir, String category, MultipartFile file) {
 String message = "";  String fileName = file.getOriginalFilename();  try { InputStream fileInputStream = file.getInputStream(); Deployment deployment; String extension = FilenameUtils.getExtension(fileName); if (extension.equals("zip") || extension.equals("bar")) { ZipInputStream zip = new ZipInputStream(fileInputStream); deployment = repositoryService.createDeployment().addZipInputStream(zip).deploy(); } else if (extension.equals("png")) { deployment = repositoryService.createDeployment().addInputStream(fileName, fileInputStream).deploy(); } else if (fileName.indexOf("bpmn20.xml") != -1) { deployment = repositoryService.createDeployment().addInputStream(fileName, fileInputStream).deploy(); } else if (extension.equals("bpmn")) { // bpmn扩展名特殊处理，转换为bpmn20.xml String baseName = FilenameUtils.getBaseName(fileName);  deployment = repositoryService.createDeployment().addInputStream(baseName + ".bpmn20.xml", fileInputStream).deploy(); } else { message = "不支持的文件类型：" + extension; return message; }  List<ProcessDefinition> list = repositoryService.createProcessDefinitionQuery().deploymentId(deployment.getId()).list();
 // 设置流程分类 for (ProcessDefinition processDefinition : list) {// ActUtils.exportDiagramToFile(repositoryService, processDefinition, exportDir); repositoryService.setProcessDefinitionCategory(processDefinition.getId(), category); message += "部署成功，流程ID=" + processDefinition.getId() + "<br/>"; }  if (list.size() == 0){ message = "部署失败，没有流程。"; }  } catch (Exception e) { throw new ActivitiException("部署失败！", e); } return message; }  /\*\* \* 设置流程分类 \*/ @Transactional(readOnly = false) public void updateCategory(String procDefId, String category) { repositoryService.setProcessDefinitionCategory(procDefId, category); }
 /\*\* \* 挂起、激活流程实例 \*/ @Transactional(readOnly = false) public String updateState(String state, String procDefId) { if (state.equals("active")) { repositoryService.activateProcessDefinitionById(procDefId, true, null); return "已激活ID为[" + procDefId + "]的流程定义。"; } else if (state.equals("suspend")) { repositoryService.suspendProcessDefinitionById(procDefId, true, null); return "已挂起ID为[" + procDefId + "]的流程定义。"; } return "无操作"; }  /\*\* \* 将部署的流程转换为模型 \* @param procDefId \* @throws UnsupportedEncodingException \* @throws XMLStreamException \*/ @Transactional(readOnly = false) public org.activiti.engine.repository.Model convertToModel(String procDefId) throws UnsupportedEncodingException, XMLStreamException {  ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().processDefinitionId(procDefId).singleResult(); InputStream bpmnStream = repositoryService.getResourceAsStream(processDefinition.getDeploymentId(), processDefinition.getResourceName()); XMLInputFactory xif = XMLInputFactory.newInstance(); InputStreamReader in = new InputStreamReader(bpmnStream, "UTF-8"); XMLStreamReader xtr = xif.createXMLStreamReader(in); BpmnModel bpmnModel = new BpmnXMLConverter().convertToBpmnModel(xtr);  BpmnJsonConverter converter = new BpmnJsonConverter(); ObjectNode modelNode = converter.convertToJson(bpmnModel); org.activiti.engine.repository.Model modelData = repositoryService.newModel(); modelData.setKey(processDefinition.getKey()); modelData.setName(processDefinition.getResourceName()); modelData.setCategory(processDefinition.getCategory());//.getDeploymentId()); modelData.setDeploymentId(processDefinition.getDeploymentId()); modelData.setVersion(Integer.parseInt(String.valueOf(repositoryService.createModelQuery().modelKey(modelData.getKey()).count()+1)));  ObjectNode modelObjectNode = new ObjectMapper().createObjectNode(); modelObjectNode.put(ModelDataJsonConstants.MODEL\_NAME, processDefinition.getName()); modelObjectNode.put(ModelDataJsonConstants.MODEL\_REVISION, modelData.getVersion()); modelObjectNode.put(ModelDataJsonConstants.MODEL\_DESCRIPTION, processDefinition.getDescription()); modelData.setMetaInfo(modelObjectNode.toString());  repositoryService.saveModel(modelData);  repositoryService.addModelEditorSource(modelData.getId(), modelNode.toString().getBytes("utf-8"));  return modelData; }  /\*\* \* 导出图片文件到硬盘 \*/ public List<String> exportDiagrams(String exportDir) throws IOException { List<String> files = new ArrayList<String>(); List<ProcessDefinition> list = repositoryService.createProcessDefinitionQuery().list();  for (ProcessDefinition processDefinition : list) { String diagramResourceName = processDefinition.getDiagramResourceName(); String key = processDefinition.getKey(); int version = processDefinition.getVersion(); String diagramPath = "";
 InputStream resourceAsStream = repositoryService.getResourceAsStream( processDefinition.getDeploymentId(), diagramResourceName); byte[] b = new byte[resourceAsStream.available()];
 @SuppressWarnings("unused") int len = -1; resourceAsStream.read(b, 0, b.length);
 // create file if not exist String diagramDir = exportDir + "/" + key + "/" + version; File diagramDirFile = new File(diagramDir); if (!diagramDirFile.exists()) { diagramDirFile.mkdirs(); } diagramPath = diagramDir + "/" + diagramResourceName; File file = new File(diagramPath);
 // 文件存在退出 if (file.exists()) { // 文件大小相同时直接返回否则重新创建文件(可能损坏) logger.debug("diagram exist, ignore... : {}", diagramPath);  files.add(diagramPath); } else { file.createNewFile(); logger.debug("export diagram to : {}", diagramPath);
 // wirte bytes to file FileUtils.writeByteArrayToFile(file, b, true);  files.add(diagramPath); }  }  return files; }
 /\*\* \* 删除部署的流程，级联删除流程实例 \* @param deploymentId 流程部署ID \*/ @Transactional(readOnly = false) public void deleteDeployment(String deploymentId) { repositoryService.deleteDeployment(deploymentId, true); }  /\*\* \* 删除部署的流程实例 \* @param procInsId 流程实例ID \* @param deleteReason 删除原因，可为空 \*/ @Transactional(readOnly = false) public void deleteProcIns(String procInsId, String deleteReason) { runtimeService.deleteProcessInstance(procInsId, deleteReason); } }

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


