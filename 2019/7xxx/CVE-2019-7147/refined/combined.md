=== Content from bugzilla.nasm.us_bc845d4e_20250121_002243.html ===


Bugzilla – Bug 3392544
Global-buffer-overflow problem in function crc64ib in crc64.c
Last modified: 2020-08-19 01:50:52 PDT

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/en/html/using/understanding.html)
* |
  [Log In](show_bug.cgi?id=3392544&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=3392544&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

Self-registration is disabled due to spam issue (mail gorcunov@gmail.com or hpa@zytor.com to create an account)

[**Bug 3392544**](show_bug.cgi?id=3392544)
- Global-buffer-overflow problem in function crc64ib in crc64.c

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
Global-buffer-overflow problem in function crc64ib in crc64.c

| | [Status](page.cgi?id=fields.html#bug_status): | CLOSED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | NASM | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=NASM "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Assembler ([show other bugs](buglist.cgi?component=Assembler&product=NASM&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 2.15.xx | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All All | |  | | | [Importance](page.cgi?id=fields.html#importance): | Medium critical | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | nobody | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2019-01-01 21:34 PST by Cheng Wen | | --- | --- | | Modified: | 2020-08-19 01:50 PDT ([History](show_activity.cgi?id=3392544)) | | CC List: | 6 users (show)  chang.seok.bae gorcunov hpa nasm-bugs wcventure xiangzhex | |  | | | [Obtained from:](page.cgi?id=fields.html#cf_build "Please indicate where you obtained and/or built your version of NASM.") | Build from source archive using configure | | [Generated by:](page.cgi?id=fields.html#cf_robot "Was this bug report generated by an automatic tool, such as a memory leak detector or fuzzer, *without* including a human validation description or analysis of the problem?") | --- | | [Bug category:](page.cgi?id=fields.html#cf_category "The general category of this bug oor request.") |  | | [Breaks existing code:](page.cgi?id=fields.html#cf_breaks "This bug report breaks existing code in production or under development.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**POC1**](attachment.cgi?id=411697 "View the content of the attachment") (198 bytes, application/octet-stream)  [2019-01-01 21:34 PST](#attach_411697 "Go to the comment associated with the attachment"), Cheng Wen | [Details](attachment.cgi?id=411697&action=edit) | | [**POC2**](attachment.cgi?id=411698 "View the content of the attachment") (227 bytes, application/octet-stream)  [2019-01-01 21:36 PST](#attach_411698 "Go to the comment associated with the attachment"), Cheng Wen | [Details](attachment.cgi?id=411698&action=edit) | | [**POC3**](attachment.cgi?id=411699 "View the content of the attachment") (284 bytes, application/octet-stream)  [2019-01-01 21:37 PST](#attach_411699 "Go to the comment associated with the attachment"), Cheng Wen | [Details](attachment.cgi?id=411699&action=edit) | | [Add an attachment](attachment.cgi?bugid=3392544&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=3392544&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=3392544#c0)  Cheng Wen    2019-01-01 21:34:59 PST  ``` Created [attachment 411697](attachment.cgi?id=411697 "POC1") [[details]](attachment.cgi?id=411697&action=edit "POC1") POC1  Hi, there.  A global-buffer-overflow problem was discovered in function crc64ib in crc64.c, as distributed in Bento4 v1.5.1-624. A crafted input can cause segment faults and I have confirmed them with address sanitizer too.  Here are the POC files. Please use "./nasm -f bin $POC -o /dev/null" to reproduce the error.   $ git log  > commit ef4f23d76a6ce89c93b40150f48ba6803d42341e > Author: H. Peter Anvin <hpa@zytor.com> > Date:   Sat Dec 29 20:14:50 2018 -0800 >  >     tokhash.pl: zero all the fields for a not-found token >  >     Make sure we zero all the token fields if we don't find something in >     the hash. >  >     Signed-off-by: H. Peter Anvin <hpa@zytor.com>   The ASAN dumps the stack trace as follows:  > ================================================================= > ==72703==ERROR: AddressSanitizer: global-buffer-overflow on address 0x0000007589e0 at pc 0x0000006a531a bp 0x7ffd882ab4f0 sp 0x7ffd882ab4e8 > READ of size 8 at 0x0000007589e0 thread T0 >     #0 0x6a5319 in crc64ib /nasm/nasmlib/crc64.c:207:8 >     #1 0x6aba31 in hash_findib /nasm/nasmlib/hashtbl.c:124:21 >     #2 0x6ac0cd in hash_findi /nasm/nasmlib/hashtbl.c:157:12 >     #3 0x580ac3 in hash_findix /nasm/asm/preproc.c:708:9 >     #4 0x5a2890 in expand_smacro /nasm/asm/preproc.c:4140:34 >     #5 0x57c768 in pp_getline /nasm/asm/preproc.c:5176:21 >     #6 0x516481 in assemble_file /nasm/asm/nasm.c:1554:24 >     #7 0x5115d2 in main /nasm/asm/nasm.c:610:9 >     #8 0x7fba6cf5482f in __libc_start_main /build/glibc-Cl5G7W/glibc-2.23/csu/../csu/libc-start.c:291 >     #9 0x41a728 in _start (/nasm/build/bin/nasm+0x41a728) >  > 0x0000007589e0 is located 32 bytes to the left of global variable '<string literal>' defined in 'output/codeview.c:63:5' (0x758a00) of size 4 >   '<string literal>' is ascii string 'cv8' > 0x0000007589e0 is located 21 bytes to the right of global variable '<string literal>' defined in 'output/codeview.c:62:5' (0x7589c0) of size 11 >   '<string literal>' is ascii string 'Codeview 8' > SUMMARY: AddressSanitizer: global-buffer-overflow /nasm/nasmlib/crc64.c:207:8 in crc64ib > Shadow bytes around the buggy address: >   0x0000800e30e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 >   0x0000800e30f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 >   0x0000800e3100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 >   0x0000800e3110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 >   0x0000800e3120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 > =>0x0000800e3130: 00 00 00 00 00 00 00 00 00 03 f9 f9[f9]f9 f9 f9 >   0x0000800e3140: 04 f9 f9 f9 f9 f9 f9 f9 00 00 00 00 00 00 00 00 >   0x0000800e3150: 00 00 f9 f9 f9 f9 f9 f9 00 01 f9 f9 f9 f9 f9 f9 >   0x0000800e3160: 00 01 f9 f9 f9 f9 f9 f9 00 00 00 00 00 00 00 06 >   0x0000800e3170: f9 f9 f9 f9 06 f9 f9 f9 f9 f9 f9 f9 00 00 02 f9 >   0x0000800e3180: f9 f9 f9 f9 00 00 00 07 f9 f9 f9 f9 00 00 00 f9 > Shadow byte legend (one shadow byte represents 8 application bytes): >   Addressable:           00 >   Partially addressable: 01 02 03 04 05 06 07 >   Heap left redzone:       fa >   Freed heap region:       fd >   Stack left redzone:      f1 >   Stack mid redzone:       f2 >   Stack right redzone:     f3 >   Stack after return:      f5 >   Stack use after scope:   f8 >   Global redzone:          f9 >   Global init order:       f6 >   Poisoned by user:        f7 >   Container overflow:      fc >   Array cookie:            ac >   Intra object redzone:    bb >   ASan internal:           fe >   Left alloca redzone:     ca >   Right alloca redzone:    cb > ==72703==ABORTING ```  [Comment 1](show_bug.cgi?id=3392544#c1)  Cheng Wen    2019-01-01 21:36:53 PST  ``` Created [attachment 411698](attachment.cgi?id=411698 "POC2") [[details]](attachment.cgi?id=411698&action=edit "POC2") POC2  This issue was raised by NTU Cyber-Security-Lab. If you have any question, please let me know. ```  [Comment 2](show_bug.cgi?id=3392544#c2)  Cheng Wen    2019-01-01 21:37:11 PST  ``` Created [attachment 411699](attachment.cgi?id=411699 "POC3") [[details]](attachment.cgi?id=411699&action=edit "POC3") POC3 ```  [Comment 3](show_bug.cgi?id=3392544#c3)  Cheng Wen    2019-01-31 23:20:18 PST  ``` This bug got assigned CVE-2019-7147 ```  [Comment 4](show_bug.cgi?id=3392544#c4)  Alex Xu    2019-10-27 11:39:16 PDT  ``` It seems that this problem is caused by the inline function "nasm_tolower" defined in nctype.h. The return type of this function should be "unsigned char" instead of "char".   When the program uses "(uint8_t)crc ^ nasm_tolower(c)" to access crc64_tab, it seems that the machine will first sign_extend the return value of nasm_tolower(c)". ```  [Comment 5](show_bug.cgi?id=3392544#c5)  H. Peter Anvin    2019-10-27 13:42:26 PDT  ``` Oops. There should be parentheses around the cast, too. ```  [Comment 6](show_bug.cgi?id=3392544#c6)  Alex Xu    2019-10-27 14:46:07 PDT  ``` I just found that in a newer commit (23rd Oct 2019), the problem has been solved. There's an inline function named "crc64_byte" defined in file "hashtbl.h". This function seems dealing with the typecasts correctly.  ```c static inline uint64_t crc64_byte(uint64_t crc, uint8_t v) {     extern const uint64_t crc64_tab[256];     return crc64_tab[(uint8_t)(v ^ crc)] ^ (crc >> 8); } ``` ```  [Comment 7](show_bug.cgi?id=3392544#c7)  Cyrill Gorcunov    2020-08-19 01:50:52 PDT  ``` Works fine in nasm-2.15.04rc5-4-g51e23ac7 ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=3392544)
* - [XML](show_bug.cgi?ctype=xml&id=3392544)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=3392544)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/en/html/using/understanding.html)
  + |
    [Log In](show_bug.cgi?id=3392544&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=3392544&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


