```
{
  "vulnerability_information": {
    "root_cause": "The vulnerability lies in the insecure handling of user login cookies. The `nvloginhash` cookie, used for persistent login, was being unserialized, which could lead to arbitrary code execution if an attacker crafted a malicious serialized object and set it as the cookie value. Additionally, there was a vulnerability in how the cookie was being validated using `md5` which is susceptible to length extension attacks. There was also an SQL Injection vulnerability present in the banner module.",
    "weaknesses": [
      "Insecure deserialization",
      "Weak cryptographic hash function (MD5)",
      "SQL Injection"
    ],
    "impact": "Arbitrary code execution, SQL Injection allowing potential data breach or manipulation, user account compromise.",
    "attack_vectors": [
      "Setting a malicious serialized object as the `nvloginhash` cookie value.",
      "Exploiting the use of `md5` for cookie validation using length extension attacks.",
      "Crafting a SQL injection payload via the banners module."
    ],
    "required_attacker_capabilities": [
      "Ability to set and manipulate cookies in the victim's browser.",
      "Understanding of PHP object serialization and the target application's structure to craft a malicious serialized object.",
      "Ability to intercept or forge HTTP requests to inject malicious SQL queries."
    ],
    "details": "The fix includes a switch from `unserialize` to `json_decode` for handling the `nvloginhash` cookie, mitigating the risk of arbitrary code execution. It also includes changes to the user login cookie check which now uses `===` instead of `==` when comparing hashes, and fixes the SQL Injection vulnerability in the banner module. It also removes custom encryption in favor of openssl.\n\nThe vulnerable code was present in `includes/core/is_user.php`, `modules/banners/funcs/click.php` and `vendor/vinades/nukeviet/Core/Request.php`.\n\nThe fix for the insecure deserialization can be seen in the `includes/core/is_user.php` file:\n```diff\n-       $user = unserialize($user);\n-       \n        $user = json_decode($user, true);\n```\n\nThe fix for the weak cryptographic hash function can also be seen in `includes/core/is_user.php`:\n```diff\n-      if ($user['checkhash'] == md5($user['userid'] . $user['checknum'] . $global_config['sitekey'] . $client_info['browser']['key'])) {\n+      if ($user['checkhash'] === md5($user['userid'] . $user['checknum'] . $global_config['sitekey'] . $client_info['browser']['key'])) {\n```\n\nand the fix for the SQL injection can be seen in `modules/banners/funcs/click.php`:\n```diff\n-     VALUES (" . $id . ", " . NV_CURRENTTIME . ", 0, '" . $client_info['ip'] . "', '" . $client_info['country'] . "', '', '" . $browser . "', '','" . $client_info['client_os']['name'] . "','" . $client_info['referer'] . "');";\n+     VALUES (" . $id . ", " . NV_CURRENTTIME . ", 0, " . $db->quote($client_info['ip']) . ", " . $db->quote($client_info['country']) . ", '', " . $db->quote($browser) . ", '', " . $db->quote($client_info['client_os']['name']) . ", " . $db->quote($client_info['referer']) . ");";\n```\n\nThe custom encoding and decoding of the cookie was replaced with openssl implementation in `vendor/vinades/nukeviet/Core/Request.php`:\n```diff\n-    private function encodeCookie($string)\n-    {\n-        $result = '';\n-        $strlen = strlen($string);\n-        for ($i = 0; $i < $strlen; ++$i) {\n-            $char = substr($string, $i, 1);\n-            $keychar = substr($this->cookie_key, ($i % 32) - 1, 1);\n-            $result .= chr(ord($char) + ord($keychar));\n-        }\n-        return $this->base64Encode($result);\n+   private function encodeCookie($string)\n+    {\n+        $iv = substr($this->cookie_key, 0, 16);\n+        $string = openssl_encrypt($string, 'aes-256-cbc', $this->cookie_key, 0, $iv);\n+        return strtr($string, '+/=', '-_,');\n    }\n```\n```diff\n-    private function decodeCookie($string)\n-    {\n-        $result = '';\n-        $string = $this->base64Decode($string);\n-        $strlen = strlen($string);\n-        for ($i = 0; $i < $strlen; ++$i) {\n-            $char = substr($string, $i, 1);\n-            $keychar = substr($this->cookie_key, ($i % 32) - 1, 1);\n-            $result .= chr(ord($char) - ord($keychar));\n-        }\n-        return $result;\n+   private function decodeCookie($string)\n+    {\n+        $string = strtr($string, '-_,', '+/=');\n+        $iv = substr($this->cookie_key, 0, 16);\n+        return openssl_decrypt($string, 'aes-256-cbc', $this->cookie_key, 0, $iv);\n    }\n```"
  }
}
```