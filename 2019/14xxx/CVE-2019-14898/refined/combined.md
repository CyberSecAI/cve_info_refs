=== Content from bugzilla.redhat.com_537b1419_20250121_010329.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3DCVE-2019-14898)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3DCVE-2019-14898)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3DCVE-2019-14898)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 1774671

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 1774671**](show_bug.cgi?id=1774671)
(CVE-2019-14898)
- [CVE-2019-14898](https://access.redhat.com/security/cve/CVE-2019-14898) kernel: incomplete fix for race condition between mmget\_not\_zero()/get\_task\_mm() and core dumping in [CVE-2019-11599](https://access.redhat.com/security/cve/CVE-2019-11599)

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2019-14898 kernel: incomplete fix for race condition between mmget\_not\_z...

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | CLOSED ERRATA | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2019-14898 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Red Hat Product Security | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [1749763](show_bug.cgi?id=1749763) [1749766](show_bug.cgi?id=1749766) [1772263](show_bug.cgi?id=1772263) [1772264](show_bug.cgi?id=1772264) [1772265](show_bug.cgi?id=1772265) [1777351](show_bug.cgi?id=1777351) [1777352](show_bug.cgi?id=1777352) [1777353](show_bug.cgi?id=1777353) [1777354](show_bug.cgi?id=1777354) [1777356](show_bug.cgi?id=1777356) [1777357](show_bug.cgi?id=1777357) [1777358](show_bug.cgi?id=1777358) [1777359](show_bug.cgi?id=1777359) [1777389](show_bug.cgi?id=1777389) [1777390](show_bug.cgi?id=1777390) [1813038](show_bug.cgi?id=1813038) [1813039](show_bug.cgi?id=1813039) [1813040](show_bug.cgi?id=1813040) [1813041](show_bug.cgi?id=1813041) [1813042](show_bug.cgi?id=1813042) [1813043](show_bug.cgi?id=1813043) [1813044](show_bug.cgi?id=1813044) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [1774672](show_bug.cgi?id=1774672) | | TreeView+ | [depends on](buglist.cgi?bug_id=1774671&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=1774671&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2019-11-20 16:46 UTC by Marian Rehak | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-09-07 21:03 UTC ([History](show_activity.cgi?id=1774671)) | | [CC List:](page.cgi?id=fields.html#cclist) | 27 users (show)  acaringi bhu blc brdeoliv dhoward dvlasenk esammons fhrbata hkrzesin iboverma jlelli jross jshortt jstancek kernel-mgr lgoncalv matt mcressma mlangsdo mmilgram nmurray plougher qzhao rt-maint rvrbovsk vdronov williams | | Fixed In Version: |  | | | Doc Type: | If docs needed, set a value | | | Doc Text: | The fix for CVE-2019-11599 was not complete. A local user could use this flaw to obtain sensitive information, cause a denial of service, or possibly have other unspecified impacts by triggering a race condition with mmget\_not\_zero or get\_task\_mm calls. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: | 2020-02-04 14:09:49 UTC | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | |    Links | System | ID | Private | Priority | Status | Summary | Last Updated | | Red Hat Product Errata | [RHBA-2020:0454](https://access.redhat.com/errata/RHBA-2020%3A0454) | 0 | None | None | None | 2020-02-10 01:39:30 UTC | | Red Hat Product Errata | [RHBA-2020:0455](https://access.redhat.com/errata/RHBA-2020%3A0455) | 0 | None | None | None | 2020-02-10 01:49:03 UTC | | Red Hat Product Errata | [RHBA-2020:0516](https://access.redhat.com/errata/RHBA-2020%3A0516) | 0 | None | None | None | 2020-02-17 09:36:35 UTC | | Red Hat Product Errata | [RHBA-2020:0517](https://access.redhat.com/errata/RHBA-2020%3A0517) | 0 | None | None | None | 2020-02-17 09:30:38 UTC | | Red Hat Product Errata | [RHBA-2020:0518](https://access.redhat.com/errata/RHBA-2020%3A0518) | 0 | None | None | None | 2020-02-17 09:30:58 UTC | | Red Hat Product Errata | [RHBA-2020:0554](https://access.redhat.com/errata/RHBA-2020%3A0554) | 0 | None | None | None | 2020-02-19 21:45:10 UTC | | Red Hat Product Errata | [RHSA-2020:0328](https://access.redhat.com/errata/RHSA-2020%3A0328) | 0 | None | None | None | 2020-02-04 08:52:23 UTC | | Red Hat Product Errata | [RHSA-2020:0339](https://access.redhat.com/errata/RHSA-2020%3A0339) | 0 | None | None | None | 2020-02-04 13:12:14 UTC | | Red Hat Product Errata | [RHSA-2020:0374](https://access.redhat.com/errata/RHSA-2020%3A0374) | 0 | None | None | None | 2020-02-04 19:30:46 UTC | | Red Hat Product Errata | [RHSA-2020:0375](https://access.redhat.com/errata/RHSA-2020%3A0375) | 0 | None | None | None | 2020-02-04 19:30:59 UTC | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1774671#c0)  Marian Rehak    2019-11-20 16:46:32 UTC  ``` Incomplete fix for [CVE-2019-11599](https://access.redhat.com/security/cve/CVE-2019-11599), race condition between mmget_not_zero()/get_task_mm() and core dumping, in RHEL-7.   ```  [Comment 1](show_bug.cgi?id=1774671#c1)  Marian Rehak    2019-11-20 16:47:49 UTC  ``` External References:  <https://bugs.chromium.org/p/project-zero/issues/detail?id=1790> <https://cdn.kernel.org/pub/linux/kernel/v4.x/ChangeLog-4.14.114>  <https://cdn.kernel.org/pub/linux/kernel/v4.x/ChangeLog-4.19.37>  <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.0.10>   ```  [Comment 7](show_bug.cgi?id=1774671#c7)  errata-xmlrpc    2020-02-04 08:52:20 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8  Via RHSA-2020:0328 [https://access.redhat.com/errata/RHSA-2020:0328](https://access.redhat.com/errata/RHSA-2020%3A0328)   ```  [Comment 8](show_bug.cgi?id=1774671#c8)  errata-xmlrpc    2020-02-04 13:12:12 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 8  Via RHSA-2020:0339 [https://access.redhat.com/errata/RHSA-2020:0339](https://access.redhat.com/errata/RHSA-2020%3A0339)   ```  [Comment 9](show_bug.cgi?id=1774671#c9)  Product Security DevOps Team    2020-02-04 14:09:49 UTC  ``` This bug is now closed. Further updates for individual products will be reflected on the CVE page(s):  <https://access.redhat.com/security/cve/cve-2019-14898>   ```  [Comment 10](show_bug.cgi?id=1774671#c10)  errata-xmlrpc    2020-02-04 19:30:42 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 7  Via RHSA-2020:0374 [https://access.redhat.com/errata/RHSA-2020:0374](https://access.redhat.com/errata/RHSA-2020%3A0374)   ```  [Comment 11](show_bug.cgi?id=1774671#c11)  errata-xmlrpc    2020-02-04 19:30:55 UTC  ``` This issue has been addressed in the following products:    Red Hat Enterprise Linux 7  Via RHSA-2020:0375 [https://access.redhat.com/errata/RHSA-2020:0375](https://access.redhat.com/errata/RHSA-2020%3A0375)   ```  [Comment 14](show_bug.cgi?id=1774671#c14)  Petr Matousek    2020-02-20 16:45:39 UTC  ``` Acknowledgments:  Name: Vladis Dronov (Red Hat Engineering)   ```  [Comment 15](show_bug.cgi?id=1774671#c15)  Petr Matousek    2020-02-20 16:45:43 UTC  ``` Mitigation:  Mitigation for this issue is either not available or the currently available options don't meet the Red Hat Product Security criteria comprising ease of use and deployment, applicability to widespread installation base or stability.   ```  [Comment 20](show_bug.cgi?id=1774671#c20)  Petr Matousek    2020-03-18 10:08:45 UTC  ``` Statement:  The Red Hat Enterprise Linux 7  kernel versions prior to Red Hat Enterprise Linux 7.7 GA kernel (version 3.10.0-1062 released via RHSA-2019:2029) were never affected by [CVE-2019-14898](https://access.redhat.com/security/cve/CVE-2019-14898) (ie the incomplete fix for [CVE-2019-1159](https://access.redhat.com/security/cve/CVE-2019-1159)) because they never backported the incomplete fix for [CVE-2019-11599](https://access.redhat.com/security/cve/CVE-2019-11599) in the first place; [CVE-2019-11599](https://access.redhat.com/security/cve/CVE-2019-11599) was fixed there fully, ie backport consisted of both [CVE-2019-11599](https://access.redhat.com/security/cve/CVE-2019-11599) and [CVE-2019-14898](https://access.redhat.com/security/cve/CVE-2019-14898) patches.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=1774671&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



=== Content from access.redhat.com_482bf3bc_20250121_031231.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from cdn.kernel.org_b7c0e18a_20250121_010330.html ===
commit fa5941f45d7ed070118b7c209b7f2c3a034293bd
Author: Greg Kroah-Hartman
Date: Sat Apr 27 09:35:42 2019 +0200
Linux 4.14.114
commit 62c1af5fb31a72c229d17f812fa1fc37f69d4dbf
Author: Will Deacon
Date: Fri Apr 5 18:39:38 2019 -0700
kernel/sysctl.c: fix out-of-bounds access when setting file-max
commit 9002b21465fa4d829edfc94a5a441005cffaa972 upstream.
Commit 32a5ad9c2285 ("sysctl: handle overflow for file-max") hooked up
min/max values for the file-max sysctl parameter via the .extra1 and
.extra2 fields in the corresponding struct ctl\_table entry.
Unfortunately, the minimum value points at the global 'zero' variable,
which is an int. This results in a KASAN splat when accessed as a long
by proc\_doulongvec\_minmax on 64-bit architectures:
| BUG: KASAN: global-out-of-bounds in \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| Read of size 8 at addr ffff2000133d1c20 by task systemd/1
|
| CPU: 0 PID: 1 Comm: systemd Not tainted 5.1.0-rc3-00012-g40b114779944 #2
| Hardware name: linux,dummy-virt (DT)
| Call trace:
| dump\_backtrace+0x0/0x228
| show\_stack+0x14/0x20
| dump\_stack+0xe8/0x124
| print\_address\_description+0x60/0x258
| kasan\_report+0x140/0x1a0
| \_\_asan\_report\_load8\_noabort+0x18/0x20
| \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| proc\_doulongvec\_minmax+0x4c/0x78
| proc\_sys\_call\_handler.isra.19+0x144/0x1d8
| proc\_sys\_write+0x34/0x58
| \_\_vfs\_write+0x54/0xe8
| vfs\_write+0x124/0x3c0
| ksys\_write+0xbc/0x168
| \_\_arm64\_sys\_write+0x68/0x98
| el0\_svc\_common+0x100/0x258
| el0\_svc\_handler+0x48/0xc0
| el0\_svc+0x8/0xc
|
| The buggy address belongs to the variable:
| zero+0x0/0x40
|
| Memory state around the buggy address:
| ffff2000133d1b00: 00 00 00 00 00 00 00 00 fa fa fa fa 04 fa fa fa
| ffff2000133d1b80: fa fa fa fa 04 fa fa fa fa fa fa fa 04 fa fa fa
| >ffff2000133d1c00: fa fa fa fa 04 fa fa fa fa fa fa fa 00 00 00 00
| ^
| ffff2000133d1c80: fa fa fa fa 00 fa fa fa fa fa fa fa 00 00 00 00
| ffff2000133d1d00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Fix the splat by introducing a unsigned long 'zero\_ul' and using that
instead.
Link: http://lkml.kernel.org/r/20190403153409.17307-1-will.deacon@arm.com
Fixes: 32a5ad9c2285 ("sysctl: handle overflow for file-max")
Signed-off-by: Will Deacon
Acked-by: Christian Brauner
Cc: Kees Cook
Cc: Alexey Dobriyan
Cc: Matteo Croce
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 599c8a408f875477624384edd60ce0c821ff7c8a
Author: Greg Kroah-Hartman
Date: Thu Apr 25 10:00:43 2019 +0200
Revert "locking/lockdep: Add debug\_locks check in \_\_lock\_downgrade()"
This reverts commit 4a195a0bc2e954b91085d5c82eb20c51835ee7b0 which was
commit 71492580571467fb7177aade19c18ce7486267f5 upstream.
Tetsuo rightly points out that the backport here is incorrect, as it
touches the \_\_lock\_set\_class function instead of the intended
\_\_lock\_downgrade function.
Reported-by: Tetsuo Handa
Cc: Waiman Long
Cc: Peter Zijlstra (Intel)
Cc: Andrew Morton
Cc: Linus Torvalds
Cc: Paul E. McKenney
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: Will Deacon
Cc: Ingo Molnar
Cc: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit d6b11409047f4aa9b1fec4e665b5cd42fcf3bbdb
Author: Linus Torvalds
Date: Sat Oct 27 09:10:48 2018 -0700
i2c-hid: properly terminate i2c\_hid\_dmi\_desc\_override\_table[] array
commit b59dfdaef173677b0b7e10f375226c0a1114fd20 upstream.
Commit 9ee3e06610fd ("HID: i2c-hid: override HID descriptors for certain
devices") added a new dmi\_system\_id quirk table to override certain HID
report descriptors for some systems that lack them.
But the table wasn't properly terminated, causing the dmi matching to
walk off into la-la-land, and starting to treat random data as dmi
descriptor pointers, causing boot-time oopses if you were at all
unlucky.
Terminate the array.
We really should have some way to just statically check that arrays that
should be terminated by an empty entry actually are so. But the HID
people really should have caught this themselves, rather than have me
deal with an oops during the merge window. Tssk, tssk.
Cc: Julian Sax
Cc: Benjamin Tissoires
Cc: Jiri Kosina
Signed-off-by: Linus Torvalds
Cc: Ambrož Bizjak
Signed-off-by: Greg Kroah-Hartman
commit 4024e3bde13e46489634cd2734d1518b1d92aef4
Author: Darrick J. Wong
Date: Thu Dec 7 19:07:02 2017 -0800
xfs: hold xfs\_buf locked between shortform->leaf conversion and the addition of an attribute
commit 6e643cd094de3bd0f97edcc1db0089afa24d909f upstream.
The new attribute leaf buffer is not held locked across the transaction
roll between the shortform->leaf modification and the addition of the
new entry. As a result, the attribute buffer modification being made is
not atomic from an operational perspective. Hence the AIL push can grab
it in the transient state of "just created" after the initial
transaction is rolled, because the buffer has been released. This leads
to xfs\_attr3\_leaf\_verify() asserting that hdr.count is zero, treating
this as in-memory corruption, and shutting down the filesystem.
Darrick ported the original patch to 4.15 and reworked it use the
xfs\_defer\_bjoin helper and hold/join the buffer correctly across the
second transaction roll.
Signed-off-by: Alex Lyakas
Signed-off-by: Darrick J. Wong
Reviewed-by: Christoph Hellwig
Signed-off-by: Alex Lyakas
Signed-off-by: Greg Kroah-Hartman
commit 2411a27e7475273aa10179d94bb00e958f6fbec5
Author: Darrick J. Wong
Date: Thu Dec 7 19:07:02 2017 -0800
xfs: add the ability to join a held buffer to a defer\_ops
commit b7b2846fe26f2c0d7f317c874a13d3ecf22670ff upstream.
In certain cases, defer\_ops callers will lock a buffer and want to hold
the lock across transaction rolls. Similar to ijoined inodes, we want
to dirty & join the buffer with each transaction roll in defer\_finish so
that afterwards the caller still owns the buffer lock and we haven't
inadvertently pinned the log.
Signed-off-by: Darrick J. Wong
Reviewed-by: Christoph Hellwig
Signed-off-by: Alex Lyakas
Signed-off-by: Greg Kroah-Hartman
commit 4fa17fc730ba3b7f0cb69937df919a7a226067be
Author: Darrick J. Wong
Date: Mon Jan 8 10:41:39 2018 -0800
iomap: report collisions between directio and buffered writes to userspace
commit 5a9d929d6e13278df62bd9e3d3ceae8c87ad1eea upstream.
If two programs simultaneously try to write to the same part of a file
via direct IO and buffered IO, there's a chance that the post-diowrite
pagecache invalidation will fail on the dirty page. When this happens,
the dio write succeeded, which means that the page cache is no longer
coherent with the disk!
Programs are not supposed to mix IO types and this is a clear case of
data corruption, so store an EIO which will be reflected to userspace
during the next fsync. Replace the WARN\_ON with a ratelimited pr\_crit
so that the developers have /some/ kind of breadcrumb to track down the
offending program(s) and file(s) involved.
Signed-off-by: Darrick J. Wong
Reviewed-by: Liu Bo
Signed-off-by: Greg Kroah-Hartman
Cc: Zubin Mithra
commit c5e44540ca312c4bbaafb1950c825a930c9adfdf
Author: Arnaldo Carvalho de Melo
Date: Tue Sep 25 10:55:59 2018 -0300
tools include: Adopt linux/bits.h
commit ba4aa02b417f08a0bee5e7b8ed70cac788a7c854 upstream.
So that we reduce the difference of tools/include/linux/bitops.h to the
original kernel file, include/linux/bitops.h, trying to remove the need
to define BITS\_PER\_LONG, to avoid clashes with asm/bitsperlong.h.
And the things removed from tools/include/linux/bitops.h are really in
linux/bits.h, so that we can have a copy and then
tools/perf/check\_headers.sh will tell us when new stuff gets added to
linux/bits.h so that we can check if it is useful and if any adjustment
needs to be done to the tools/{include,arch}/ copies.
Cc: Adrian Hunter
Cc: Alexander Sverdlin
Cc: David Ahern
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Wang Nan
Link: https://lkml.kernel.org/n/tip-y1sqyydvfzo0bjjoj4zsl562@git.kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 47ad82a34560ea70e85d2eb56be0ada03dc4fd35
Author: Matteo Croce
Date: Mon Mar 18 02:32:36 2019 +0100
percpu: stop printing kernel addresses
commit 00206a69ee32f03e6f40837684dcbe475ea02266 upstream.
Since commit ad67b74d2469d9b8 ("printk: hash addresses printed with %p"),
at boot "\_\_\_\_ptrval\_\_\_\_" is printed instead of actual addresses:
percpu: Embedded 38 pages/cpu @(\_\_\_\_ptrval\_\_\_\_) s124376 r0 d31272 u524288
Instead of changing the print to "%px", and leaking kernel addresses,
just remove the print completely, cfr. e.g. commit 071929dbdd865f77
("arm64: Stop printing the virtual memory layout").
Signed-off-by: Matteo Croce
Signed-off-by: Dennis Zhou
Signed-off-by: Greg Kroah-Hartman
commit 216f6570d18bcd06975205b8af1708ea10a1baf6
Author: Takashi Iwai
Date: Tue Apr 16 15:25:00 2019 +0200
ALSA: info: Fix racy addition/deletion of nodes
commit 8c2f870890fd28e023b0fcf49dcee333f2c8bad7 upstream.
The ALSA proc helper manages the child nodes in a linked list, but its
addition and deletion is done without any lock. This leads to a
corruption if they are operated concurrently. Usually this isn't a
problem because the proc entries are added sequentially in the driver
probe procedure itself. But the card registrations are done often
asynchronously, and the crash could be actually reproduced with
syzkaller.
This patch papers over it by protecting the link addition and deletion
with the parent's mutex. There is "access" mutex that is used for the
file access, and this can be reused for this purpose as well.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 98ae85677ebfac2fa2243a9c954d96ea58c08e85
Author: Konstantin Khlebnikov
Date: Thu Apr 18 17:50:20 2019 -0700
mm/vmstat.c: fix /proc/vmstat format for CONFIG\_DEBUG\_TLBFLUSH=y CONFIG\_SMP=n
commit e8277b3b52240ec1caad8e6df278863e4bf42eac upstream.
Commit 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
depends on skipping vmstat entries with empty name introduced in
7aaf77272358 ("mm: don't show nr\_indirectly\_reclaimable in
/proc/vmstat") but reverted in b29940c1abd7 ("mm: rename and change
semantics of nr\_indirectly\_reclaimable\_bytes").
So skipping no longer works and /proc/vmstat has misformatted lines " 0".
This patch simply shows debug counters "nr\_tlb\_remote\_\*" for UP.
Link: http://lkml.kernel.org/r/155481488468.467.4295519102880913454.stgit@buzz
Fixes: 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
Signed-off-by: Konstantin Khlebnikov
Acked-by: Vlastimil Babka
Cc: Roman Gushchin
Cc: Jann Horn
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 80ef021be19d3cdebe162c73b13d0f249d5bd2f3
Author: Jann Horn
Date: Tue Mar 19 02:36:59 2019 +0100
device\_cgroup: fix RCU imbalance in error case
commit 0fcc4c8c044e117ac126ab6df4138ea9a67fa2a9 upstream.
When dev\_exception\_add() returns an error (due to a failed memory
allocation), make sure that we move the RCU preemption count back to where
it was before we were called. We dropped the RCU read lock inside the loop
body, so we can't just "break".
sparse complains about this, too:
$ make -s C=2 security/device\_cgroup.o
./include/linux/rcupdate.h:647:9: warning: context imbalance in
'propagate\_exception' - unexpected unlock
Fixes: d591fb56618f ("device\_cgroup: simplify cgroup tree walk in propagate\_exception()")
Cc: stable@vger.kernel.org
Signed-off-by: Jann Horn
Acked-by: Michal Hocko
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit d069fe4844f8d799d771659a745fe91870c93fda
Author: Phil Auld
Date: Tue Apr 23 19:51:06 2019 -0400
sched/fair: Limit sched\_cfs\_period\_timer() loop to avoid hard lockup
[ Upstream commit 2e8e19226398db8265a8e675fcc0118b9e80c9e8 ]
With extremely short cfs\_period\_us setting on a parent task group with a large
number of children the for loop in sched\_cfs\_period\_timer() can run until the
watchdog fires. There is no guarantee that the call to hrtimer\_forward\_now()
will ever return 0. The large number of children can make
do\_sched\_cfs\_period\_timer() take longer than the period.
NMI watchdog: Watchdog detected hard LOCKUP on cpu 24
RIP: 0010:tg\_nop+0x0/0x10
walk\_tg\_tree\_from+0x29/0xb0
unthrottle\_cfs\_rq+0xe0/0x1a0
distribute\_cfs\_runtime+0xd3/0xf0
sched\_cfs\_period\_timer+0xcb/0x160
? sched\_cfs\_slack\_timer+0xd0/0xd0
\_\_hrtimer\_run\_queues+0xfb/0x270
hrtimer\_interrupt+0x122/0x270
smp\_apic\_timer\_interrupt+0x6a/0x140
apic\_timer\_interrupt+0xf/0x20

To prevent this we add protection to the loop that detects when the loop has run
too many times and scales the period and quota up, proportionally, so that the timer
can complete before then next period expires. This preserves the relative runtime
quota while preventing the hard lockup.
A warning is issued reporting this state and the new values.
Signed-off-by: Phil Auld
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Anton Blanchard
Cc: Ben Segall
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: https://lkml.kernel.org/r/20190319130005.25492-1-pauld@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 56714d4517b45acfb3747980fda39e018deb756a
Author: Matthias Kaehlcke
Date: Tue Apr 23 12:04:22 2019 -0700
Revert "kbuild: use -Oz instead of -Os when using clang"
commit a75bb4eb9e565b9f5115e2e8c07377ce32cbe69a upstream.
The clang option -Oz enables \*aggressive\* optimization for size,
which doesn't necessarily result in smaller images, but can have
negative impact on performance. Switch back to the less aggressive
-Os.
This reverts commit 6748cb3c299de1ffbe56733647b01dbcc398c419.
Suggested-by: Peter Zijlstra
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Nick Desaulniers
Signed-off-by: Masahiro Yamada
Signed-off-by: Nathan Chancellor
Signed-off-by: Sasha Levin
commit 74cec2565b14c3bd6d1c77d5e3ef9eaffab70404
Author: Peter Oskolkov
Date: Tue Apr 23 10:48:25 2019 -0700
net: IP6 defrag: use rbtrees in nf\_conntrack\_reasm.c
[ Upstream commit 997dd96471641e147cb2c33ad54284000d0f5e35 ]
Currently, IPv6 defragmentation code drops non-last fragments that
are smaller than 1280 bytes: see
commit 0ed4229b08c1 ("ipv6: defrag: drop non-last frags smaller than min mtu")
This behavior is not specified in IPv6 RFCs and appears to break
compatibility with some IPv6 implemenations, as reported here:
https://www.spinics.net/lists/netdev/msg543846.html
This patch re-uses common IP defragmentation queueing and reassembly
code in IP6 defragmentation in nf\_conntrack, removing the 1280 byte
restriction.
Signed-off-by: Peter Oskolkov
Reported-by: Tom Herbert
Cc: Eric Dumazet
Cc: Florian Westphal
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6925083963809d53f1d5ef58c2ef8a3792908166
Author: Peter Oskolkov
Date: Tue Apr 23 10:48:24 2019 -0700
net: IP6 defrag: use rbtrees for IPv6 defrag
[ Upstream commit d4289fcc9b16b89619ee1c54f829e05e56de8b9a ]
Currently, IPv6 defragmentation code drops non-last fragments that
are smaller than 1280 bytes: see
commit 0ed4229b08c1 ("ipv6: defrag: drop non-last frags smaller than min mtu")
This behavior is not specified in IPv6 RFCs and appears to break
compatibility with some IPv6 implemenations, as reported here:
https://www.spinics.net/lists/netdev/msg543846.html
This patch re-uses common IP defragmentation queueing and reassembly
code in IPv6, removing the 1280 byte restriction.
v2: change handling of overlaps to match that of upstream.
Signed-off-by: Peter Oskolkov
Reported-by: Tom Herbert
Cc: Eric Dumazet
Cc: Florian Westphal
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5d827bfe37a5cecd1de33405afde4708657643c5
Author: Florian Westphal
Date: Tue Apr 23 10:48:23 2019 -0700
ipv6: remove dependency of nf\_defrag\_ipv6 on ipv6 module
[ Upstream commit 70b095c84326640eeacfd69a411db8fc36e8ab1a ]
IPV6=m
DEFRAG\_IPV6=m
CONNTRACK=y yields:
net/netfilter/nf\_conntrack\_proto.o: In function `nf\_ct\_netns\_do\_get':
net/netfilter/nf\_conntrack\_proto.c:802: undefined reference to `nf\_defrag\_ipv6\_enable'
net/netfilter/nf\_conntrack\_proto.o:(.rodata+0x640): undefined reference to `nf\_conntrack\_l4proto\_icmpv6'
Setting DEFRAG\_IPV6=y causes undefined references to ip6\_rhash\_params
ip6\_frag\_init and ip6\_expire\_frag\_queue so it would be needed to force
IPV6=y too.
This patch gets rid of the 'followup linker error' by removing
the dependency of ipv6.ko symbols from netfilter ipv6 defrag.
Shared code is placed into a header, then used from both.
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit ccfa73daf762f3adac3f6c0e2f09c3c74548775f
Author: Peter Oskolkov
Date: Tue Apr 23 10:48:22 2019 -0700
net: IP defrag: encapsulate rbtree defrag code into callable functions
[ Upstream commit c23f35d19db3b36ffb9e04b08f1d91565d15f84f ]
This is a refactoring patch: without changing runtime behavior,
it moves rbtree-related code from IPv4-specific files/functions
into .h/.c defrag files shared with IPv6 defragmentation code.
v2: make handling of overlapping packets match upstream.
Signed-off-by: Peter Oskolkov
Cc: Eric Dumazet
Cc: Florian Westphal
Cc: Tom Herbert
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a885a0ff776680ab6cb79cf891a81da9a2c18371
Author: Eric Dumazet
Date: Tue Apr 23 10:48:21 2019 -0700
ipv6: frags: fix a lockdep false positive
[ Upstream commit 415787d7799f4fccbe8d49cb0b8e5811be6b0389 ]
lockdep does not know that the locks used by IPv4 defrag
and IPv6 reassembly units are of different classes.
It complains because of following chains :
1) sch\_direct\_xmit() (lock txq->\_xmit\_lock)
dev\_hard\_start\_xmit()
xmit\_one()
dev\_queue\_xmit\_nit()
packet\_rcv\_fanout()
ip\_check\_defrag()
ip\_defrag()
spin\_lock() (lock frag queue spinlock)
2) ip6\_input\_finish()
ipv6\_frag\_rcv() (lock frag queue spinlock)
ip6\_frag\_queue()
icmpv6\_param\_prob() (lock txq->\_xmit\_lock at some point)
We could add lockdep annotations, but we also can make sure IPv6
calls icmpv6\_param\_prob() only after the release of the frag queue spinlock,
since this naturally makes frag queue spinlock a leaf in lock hierarchy.
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 00a22235025c6d12ee5d67cf50698ea93181b0b6
Author: Jarkko Sakkinen
Date: Fri Feb 8 18:30:59 2019 +0200
tpm/tpm\_i2c\_atmel: Return -E2BIG when the transfer is incomplete
[ Upstream commit 442601e87a4769a8daba4976ec3afa5222ca211d ]
Return -E2BIG when the transfer is incomplete. The upper layer does
not retry, so not doing that is incorrect behaviour.
Cc: stable@vger.kernel.org
Fixes: a2871c62e186 ("tpm: Add support for Atmel I2C TPMs")
Signed-off-by: Jarkko Sakkinen
Reviewed-by: Stefan Berger
Reviewed-by: Jerry Snitselaar
Signed-off-by: Sasha Levin
commit 10bd1c7ad3894bb9bf2a6d2f3669b5b674f1e59e
Author: Masahiro Yamada
Date: Thu Nov 22 13:28:42 2018 +0900
modpost: file2alias: check prototype of handler
commit f880eea68fe593342fa6e09be9bb661f3c297aec upstream.
Use specific prototype instead of an opaque pointer so that the
compiler can catch function prototype mismatch.
Signed-off-by: Masahiro Yamada
Reviewed-by: Mathieu Malaterre
Signed-off-by: Nathan Chancellor
Signed-off-by: Sasha Levin
commit 1a7fe5cb7a04ebc00cc282bb227bb8b78f52138b
Author: Masahiro Yamada
Date: Thu Nov 22 13:28:41 2018 +0900
modpost: file2alias: go back to simple devtable lookup
commit ec91e78d378cc5d4b43805a1227d8e04e5dfa17d upstream.
Commit e49ce14150c6 ("modpost: use linker section to generate table.")
was not so cool as we had expected first; it ended up with ugly section
hacks when commit dd2a3acaecd7 ("mod/file2alias: make modpost compile
on darwin again") came in.
Given a certain degree of unknowledge about the link stage of host
programs, I really want to see simple, stupid table lookup so that
this works in the same way regardless of the underlying executable
format.
Signed-off-by: Masahiro Yamada
Acked-by: Mathieu Malaterre
[nc: Omit rpmsg, sdw, tbsvc, and typec as they do not exist here]
Signed-off-by: Nathan Chancellor
Signed-off-by: Sasha Levin
commit c728ffc5150c0e7b6c895f281a3d37c1bef52a10
Author: Adrian Hunter
Date: Thu Nov 15 15:53:43 2018 +0200
mmc: sdhci: Handle auto-command errors
[ Upstream commit af849c86109d79222e549826068bbf4e7f9a2472 ]
If the host controller supports auto-commands then enable the auto-command
error interrupt and handle it. In the case of auto-CMD23, the error is
treated the same as manual CMD23 error. In the case of auto-CMD12,
commands-during-transfer are not permitted, so the error handling is
treated the same as a data error.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit 45fd8679ea86bffb352132a1df4917c3d11375aa
Author: Adrian Hunter
Date: Thu Nov 15 15:53:42 2018 +0200
mmc: sdhci: Rename SDHCI\_ACMD12\_ERR and SDHCI\_INT\_ACMD12ERR
[ Upstream commit 869f8a69bb3a4aec4eb914a330d4ba53a9eed495 ]
The SDHCI\_ACMD12\_ERR register is used for auto-CMD23 and auto-CMD12
errors, as is the SDHCI\_INT\_ACMD12ERR interrupt bit. Rename them to
SDHCI\_AUTO\_CMD\_STATUS and SDHCI\_INT\_AUTO\_CMD\_ERR respectively.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit f83cf258b928b94a908d88e692f14ef459f927db
Author: Adrian Hunter
Date: Thu Nov 15 15:53:41 2018 +0200
mmc: sdhci: Fix data command CRC error handling
[ Upstream commit 4bf780996669280171c9cd58196512849b93434e ]
Existing data command CRC error handling is non-standard and does not work
with some Intel host controllers. Specifically, the assumption that the host
controller will continue operating normally after the error interrupt,
is not valid. Change the driver to handle the error in the same manner
as a data CRC error, taking care to ensure that the data line reset is
done for single or multi-block transfers, and it is done before
unmapping DMA.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit 4cec35e8e251eb953869c199c2a33e841e422fc4
Author: Christian Lamparter
Date: Thu Apr 19 18:41:55 2018 +0200
crypto: crypto4xx - properly set IV after de- and encrypt
[ Upstream commit fc340115ffb8235c1bbd200c28855e6373d0dd1a ]
This patch fixes cts(cbc(aes)) test when cbc-aes-ppc4xx is used.
alg: skcipher: Test 1 failed (invalid result) on encryption for cts(cbc-aes-ppc4xx)
00000000: 4b 10 75 fc 2f 14 1b 6a 27 35 37 33 d1 b7 70 05
00000010: 97
alg: skcipher: Failed to load transform for cts(cbc(aes)): -2
The CTS cipher mode expect the IV (req->iv) of skcipher\_request
to contain the last ciphertext block after the {en,de}crypt
operation is complete.
Fix this issue for the AMCC Crypto4xx hardware engine.
The tcrypt test case for cts(cbc(aes)) is now correctly passed.
name : cts(cbc(aes))
driver : cts(cbc-aes-ppc4xx)
module : cts
priority : 300
refcnt : 1
selftest : passed
internal : no
type : skcipher
async : yes
blocksize : 16
min keysize : 16
max keysize : 32
ivsize : 16
chunksize : 16
walksize : 16
Signed-off-by: Christian Lamparter
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 3b921dc46fe13fa20d7bc83df3eaa7511bb2717e
Author: Thomas Gleixner
Date: Sun Apr 14 19:51:06 2019 +0200
x86/speculation: Prevent deadlock on ssb\_state::lock
commit 2f5fb19341883bb6e37da351bc3700489d8506a7 upstream.
Mikhail reported a lockdep splat related to the AMD specific ssb\_state
lock:
CPU0 CPU1
lock(&st->lock);
local\_irq\_disable();
lock(&(&sighand->siglock)->rlock);
lock(&st->lock);
lock(&(&sighand->siglock)->rlock);
\*\*\* DEADLOCK \*\*\*
The connection between sighand->siglock and st->lock comes through seccomp,
which takes st->lock while holding sighand->siglock.
Make sure interrupts are disabled when \_\_speculation\_ctrl\_update() is
invoked via prctl() -> speculation\_ctrl\_update(). Add a lockdep assert to
catch future offenders.
Fixes: 1f50ddb4f418 ("x86/speculation: Handle HT correctly on AMD")
Reported-by: Mikhail Gavrilov
Signed-off-by: Thomas Gleixner
Tested-by: Mikhail Gavrilov
Cc: Thomas Lendacky
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/alpine.DEB.2.21.1904141948200.4917@nanos.tec.linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 55e7e51f750b91adbce9784cd0283f79b6d07af3
Author: Kan Liang
Date: Tue Apr 2 12:44:58 2019 -0700
perf/x86: Fix incorrect PEBS\_REGS
commit 9d5dcc93a6ddfc78124f006ccd3637ce070ef2fc upstream.
PEBS\_REGS used as mask for the supported registers for large PEBS.
However, the mask cannot filter the sample\_regs\_user/sample\_regs\_intr
correctly.
(1ULL << PERF\_REG\_X86\_\*) should be used to replace PERF\_REG\_X86\_\*, which
is only the index.
Rename PEBS\_REGS to PEBS\_GP\_REGS, because the mask is only for general
purpose registers.
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Cc: acme@kernel.org
Cc: jolsa@kernel.org
Fixes: 2fe1bc1f501d ("perf/x86: Enable free running PEBS for REGS\_USER/INTR")
Link: https://lkml.kernel.org/r/20190402194509.2832-2-kan.liang@linux.intel.com
[ Renamed it to PEBS\_GP\_REGS - as 'GPRS' is used elsewhere ;-) ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 607d291cfc7b5df5df5194fe8a32d22ec1960aa4
Author: Andi Kleen
Date: Fri Mar 29 17:47:43 2019 -0700
x86/cpu/bugs: Use \_\_initconst for 'const' init data
commit 1de7edbb59c8f1b46071f66c5c97b8a59569eb51 upstream.
Some of the recently added const tables use \_\_initdata which causes section
attribute conflicts.
Use \_\_initconst instead.
Fixes: fa1202ef2243 ("x86/speculation: Add command line control")
Signed-off-by: Andi Kleen
Signed-off-by: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20190330004743.29541-9-andi@firstfloor.org
Signed-off-by: Greg Kroah-Hartman
commit 59809557e84e22d1ae75703a237b020a4acc9508
Author: Kim Phillips
Date: Thu Mar 21 21:15:22 2019 +0000
perf/x86/amd: Add event map for AMD Family 17h
commit 3fe3331bb285700ab2253dbb07f8e478fcea2f1b upstream.
Family 17h differs from prior families by:
- Does not support an L2 cache miss event
- It has re-enumerated PMC counters for:
- L2 cache references
- front & back end stalled cycles
So we add a new amd\_f17h\_perfmon\_event\_map[] so that the generic
perf event names will resolve to the correct h/w events on
family 17h and above processors.
Reference sections 2.1.13.3.3 (stalls) and 2.1.13.3.6 (L2):
https://www.amd.com/system/files/TechDocs/54945\_PPR\_Family\_17h\_Models\_00h-0Fh.pdf
Signed-off-by: Kim Phillips
Cc:  # v4.9+
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: H. Peter Anvin
Cc: Janakarajan Natarajan
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Martin Liška
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Pu Wen
Cc: Suravee Suthikulpanit
Cc: Thomas Gleixner
Cc: linux-kernel@vger.kernel.org
Fixes: e40ed1542dd7 ("perf/x86: Add perf support for AMD family-17h processors")
[ Improved the formatting a bit. ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 5efba8d96466b824aa9d205fe6eabcec2c6aa960
Author: Felix Fietkau
Date: Fri Mar 1 14:48:37 2019 +0100
mac80211: do not call driver wake\_tx\_queue op during reconfig
commit 4856bfd230985e43e84c26473c91028ff0a533bd upstream.
There are several scenarios in which mac80211 can call drv\_wake\_tx\_queue
after ieee80211\_restart\_hw has been called and has not yet completed.
Driver private structs are considered uninitialized until mac80211 has
uploaded the vifs, stations and keys again, so using private tx queue
data during that time is not safe.
The driver can also not rely on drv\_reconfig\_complete to figure out when
it is safe to accept drv\_wake\_tx\_queue calls again, because it is only
called after all tx queues are woken again.
To fix this, bail out early in drv\_wake\_tx\_queue if local->in\_reconfig
is set.
Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 8a80544c5e6f50e7796380381f285488af47287f
Author: Vijayakumar Durai
Date: Wed Mar 27 11:03:17 2019 +0100
rt2x00: do not increment sequence number while re-transmitting
commit 746ba11f170603bf1eaade817553a6c2e9135bbe upstream.
Currently rt2x00 devices retransmit the management frames with
incremented sequence number if hardware is assigning the sequence.
This is HW bug fixed already for non-QOS data frames, but it should
be fixed for management frames except beacon.
Without fix retransmitted frames have wrong SN:
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1648, FN=0, Flags=........C Frame is not being retransmitted 1648 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1649, FN=0, Flags=....R...C Frame is being retransmitted 1649 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1650, FN=0, Flags=....R...C Frame is being retransmitted 1650 1
With the fix SN stays correctly the same:
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=........C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
Cc: stable@vger.kernel.org
Signed-off-by: Vijayakumar Durai
[sgruszka: simplify code, change comments and changelog]
Signed-off-by: Stanislaw Gruszka
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 5e8002fb22201466d27022c03a5911b30034ff7a
Author: Masami Hiramatsu
Date: Mon Apr 15 15:01:25 2019 +0900
kprobes: Fix error check when reusing optimized probes
commit 5f843ed415581cfad4ef8fefe31c138a8346ca8a upstream.
The following commit introduced a bug in one of our error paths:
819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
it missed to handle the return value of kprobe\_optready() as
error-value. In reality, the kprobe\_optready() returns a bool
result, so "true" case must be passed instead of 0.
This causes some errors on kprobe boot-time selftests on ARM:
[ ] Beginning kprobe tests...
[ ] Probe ARM code
[ ] kprobe
[ ] kretprobe
[ ] ARM instruction simulation
[ ] Check decoding tables
[ ] Run test cases
[ ] FAIL: test\_case\_handler not run
[ ] FAIL: Test andge r10, r11, r14, asr r7
[ ] FAIL: Scenario 11
...
[ ] FAIL: Scenario 7
[ ] Total instruction simulation tests=1631, pass=1433 fail=198
[ ] kprobe tests failed
This can happen if an optimized probe is unregistered and next
kprobe is registered on same address until the previous probe
is not reclaimed.
If this happens, a hidden aggregated probe may be kept in memory,
and no new kprobe can probe same address. Also, in that case
register\_kprobe() will return "1" instead of minus error value,
which can mislead caller logic.
Signed-off-by: Masami Hiramatsu
Cc: Anil S Keshavamurthy
Cc: David S . Miller
Cc: Linus Torvalds
Cc: Naveen N . Rao
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org # v5.0+
Fixes: 819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
Link: http://lkml.kernel.org/r/155530808559.32517.539898325433642204.stgit@devnote2
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 18a0a7c1f9d5150dd6da3adf93e2275717f6c6d6
Author: Masami Hiramatsu
Date: Sun Feb 24 01:50:20 2019 +0900
kprobes: Mark ftrace mcount handler functions nokprobe
commit fabe38ab6b2bd9418350284c63825f13b8a6abba upstream.
Mark ftrace mcount handler functions nokprobe since
probing on these functions with kretprobe pushes
return address incorrectly on kretprobe shadow stack.
Reported-by: Francis Deslauriers
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Acked-by: Steven Rostedt (VMware)
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094062044.6137.6419622920568680640.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 877e9c51c96cd5ad92b45e36447e275374efc7af
Author: Masami Hiramatsu
Date: Sun Feb 24 01:49:52 2019 +0900
x86/kprobes: Verify stack frame on kretprobe
commit 3ff9c075cc767b3060bdac12da72fc94dd7da1b8 upstream.
Verify the stack frame pointer on kretprobe trampoline handler,
If the stack frame pointer does not match, it skips the wrong
entry and tries to find correct one.
This can happen if user puts the kretprobe on the function
which can be used in the path of ftrace user-function call.
Such functions should not be probed, so this adds a warning
message that reports which function should be blacklisted.
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094059185.6137.15527904013362842072.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 1f2b61e4657950b96722a5a6c6dd535347d55e8a
Author: Nathan Chancellor
Date: Wed Apr 17 00:21:21 2019 -0700
arm64: futex: Restore oldval initialization to work around buggy compilers
commit ff8acf929014b7f87315588e0daf8597c8aa9d1c upstream.
Commit 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with
non-zero result value") removed oldval's zero initialization in
arch\_futex\_atomic\_op\_inuser because it is not necessary. Unfortunately,
Android's arm64 GCC 4.9.4 [1] does not agree:
../kernel/futex.c: In function 'do\_futex':
../kernel/futex.c:1658:17: warning: 'oldval' may be used uninitialized
in this function [-Wmaybe-uninitialized]
return oldval == cmparg;
^
In file included from ../kernel/futex.c:73:0:
../arch/arm64/include/asm/futex.h:53:6: note: 'oldval' was declared here
int oldval, ret, tmp;
^
GCC fails to follow that when ret is non-zero, futex\_atomic\_op\_inuser
returns right away, avoiding the uninitialized use that it claims.
Restoring the zero initialization works around this issue.
[1]: https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/
Cc: stable@vger.kernel.org
Fixes: 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with non-zero result value")
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Nathan Chancellor
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 4de25ac0e2d22198395ae6f2ddd133fb824ea9e5
Author: Eric Biggers
Date: Sun Mar 31 13:04:11 2019 -0700
crypto: x86/poly1305 - fix overflow during partial reduction
commit 678cce4019d746da6c680c48ba9e6d417803e127 upstream.
The x86\_64 implementation of Poly1305 produces the wrong result on some
inputs because poly1305\_4block\_avx2() incorrectly assumes that when
partially reducing the accumulator, the bits carried from limb 'd4' to
limb 'h0' fit in a 32-bit integer. This is true for poly1305-generic
which processes only one block at a time. However, it's not true for
the AVX2 implementation, which processes 4 blocks at a time and
therefore can produce intermediate limbs about 4x larger.
Fix it by making the relevant calculations use 64-bit arithmetic rather
than 32-bit. Note that most of the carries already used 64-bit
arithmetic, but the d4 -> h0 carry was different for some reason.
To be safe I also made the same change to the corresponding SSE2 code,
though that only operates on 1 or 2 blocks at a time. I don't think
it's really needed for poly1305\_block\_sse2(), but it doesn't hurt
because it's already x86\_64 code. It \*might\* be needed for
poly1305\_2block\_sse2(), but overflows aren't easy to reproduce there.
This bug was originally detected by my patches that improve testmgr to
fuzz algorithms against their generic implementation. But also add a
test vector which reproduces it directly (in the AVX2 case).
Fixes: b1ccc8f4b631 ("crypto: poly1305 - Add a four block AVX2 variant for x86\_64")
Fixes: c70f4abef07a ("crypto: poly1305 - Add a SSE2 SIMD variant for x86\_64")
Cc:  # v4.3+
Cc: Martin Willi
Cc: Jason A. Donenfeld
Signed-off-by: Eric Biggers
Reviewed-by: Martin Willi
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit bb461ad8e6e0653fc6bd0f26d9173bab0aec235b
Author: Andrea Arcangeli
Date: Thu Apr 18 17:50:52 2019 -0700
coredump: fix race condition between mmget\_not\_zero()/get\_task\_mm() and core dumping
commit 04f5866e41fb70690e28397487d8bd8eea7d712a upstream.
The core dumping code has always run without holding the mmap\_sem for
writing, despite that is the only way to ensure that the entire vma
layout will not change from under it. Only using some signal
serialization on the processes belonging to the mm is not nearly enough.
This was pointed out earlier. For example in Hugh's post from Jul 2017:
https://lkml.kernel.org/r/alpine.LSU.2.11.1707191716030.2055@eggly.anvils
"Not strictly relevant here, but a related note: I was very surprised
to discover, only quite recently, how handle\_mm\_fault() may be called
without down\_read(mmap\_sem) - when core dumping. That seems a
misguided optimization to me, which would also be nice to correct"
In particular because the growsdown and growsup can move the
vm\_start/vm\_end the various loops the core dump does around the vma will
not be consistent if page faults can happen concurrently.
Pretty much all users calling mmget\_not\_zero()/get\_task\_mm() and then
taking the mmap\_sem had the potential to introduce unexpected side
effects in the core dumping code.
Adding mmap\_sem for writing around the ->core\_dump invocation is a
viable long term fix, but it requires removing all copy user and page
faults and to replace them with get\_dump\_page() for all binary formats
which is not suitable as a short term fix.
For the time being this solution manually covers the places that can
confuse the core dump either by altering the vma layout or the vma flags
while it runs. Once ->core\_dump runs under mmap\_sem for writing the
function mmget\_still\_valid() can be dropped.
Allowing mmap\_sem protected sections to run in parallel with the
coredump provides some minor parallelism advantage to the swapoff code
(which seems to be safe enough by never mangling any vma field and can
keep doing swapins in parallel to the core dumping) and to some other
corner case.
In order to facilitate the backporting I added "Fixes: 86039bd3b4e6"
however the side effect of this same race condition in /proc/pid/mem
should be reproducible since before 2.6.12-rc2 so I couldn't add any
other "Fixes:" because there's no hash beyond the git genesis commit.
Because find\_extend\_vma() is the only location outside of the process
context that could modify the "mm" structures under mmap\_sem for
reading, by adding the mmget\_still\_valid() check to it, all other cases
that take the mmap\_sem for reading don't need the new check after
mmget\_not\_zero()/get\_task\_mm(). The expand\_stack() in page fault
context also doesn't need the new check, because all tasks under core
dumping are frozen.
Link: http://lkml.kernel.org/r/20190325224949.11068-1-aarcange@redhat.com
Fixes: 86039bd3b4e6 ("userfaultfd: add new syscall to provide memory externalization")
Signed-off-by: Andrea Arcangeli
Reported-by: Jann Horn
Suggested-by: Oleg Nesterov
Acked-by: Peter Xu
Reviewed-by: Mike Rapoport
Reviewed-by: Oleg Nesterov
Reviewed-by: Jann Horn
Acked-by: Jason Gunthorpe
Acked-by: Michal Hocko
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c197e4693aca226675ffdce69ee5638842fbdfe6
Author: Suthikulpanit, Suravee
Date: Wed Mar 20 08:12:28 2019 +0000
Revert "svm: Fix AVIC incomplete IPI emulation"
commit 4a58038b9e420276157785afa0a0bbb4b9bc2265 upstream.
This reverts commit bb218fbcfaaa3b115d4cd7a43c0ca164f3a96e57.
As Oren Twaig pointed out the old discussion:
https://patchwork.kernel.org/patch/8292231/
that the change coud potentially cause an extra IPI to be sent to
the destination vcpu because the AVIC hardware already set the IRR bit
before the incomplete IPI #VMEXIT with id=1 (target vcpu is not running).
Since writting to ICR and ICR2 will also set the IRR. If something triggers
the destination vcpu to get scheduled before the emulation finishes, then
this could result in an additional IPI.
Also, the issue mentioned in the commit bb218fbcfaaa was misdiagnosed.
Cc: Radim Krčmář
Cc: Paolo Bonzini
Reported-by: Oren Twaig
Signed-off-by: Suravee Suthikulpanit
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit bc6b83db8f5ae658f1db0855bcc03c8366b9084e
Author: Saurav Kashyap
Date: Thu Apr 18 03:40:12 2019 -0700
Revert "scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO"
commit 0228034d8e5915b98c33db35a98f5e909e848ae9 upstream.
This patch clears FC\_RP\_STARTED flag during logoff, because of this
re-login(flogi) didn't happen to the switch.
This reverts commit 1550ec458e0cf1a40a170ab1f4c46e3f52860f65.
Fixes: 1550ec458e0c ("scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO")
Cc:  # v4.18+
Signed-off-by: Saurav Kashyap
Reviewed-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 49c67980e52ba3bfc7675c777d4896e9ea741efe
Author: Jaesoo Lee
Date: Tue Apr 9 17:02:22 2019 -0700
scsi: core: set result when the command cannot be dispatched
commit be549d49115422f846b6d96ee8fd7173a5f7ceb0 upstream.
When SCSI blk-mq is enabled, there is a bug in handling errors in
scsi\_queue\_rq. Specifically, the bug is not setting result field of
scsi\_request correctly when the dispatch of the command has been
failed. Since the upper layer code including the sg\_io ioctl expects to
receive any error status from result field of scsi\_request, the error is
silently ignored and this could cause data corruptions for some
applications.
Fixes: d285203cf647 ("scsi: add support for a blk-mq based I/O path.")
Cc:
Signed-off-by: Jaesoo Lee
Reviewed-by: Hannes Reinecke
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit d11a33e9ba584bb6f5cc74df9d74b26156ba9bb2
Author: Takashi Iwai
Date: Tue Apr 16 17:06:33 2019 +0200
ALSA: core: Fix card races between register and disconnect
commit 2a3f7221acddfe1caa9ff09b3a8158c39b2fdeac upstream.
There is a small race window in the card disconnection code that
allows the registration of another card with the very same card id.
This leads to a warning in procfs creation as caught by syzkaller.
The problem is that we delete snd\_cards and snd\_cards\_lock entries at
the very beginning of the disconnection procedure. This makes the
slot available to be assigned for another card object while the
disconnection procedure is being processed. Then it becomes possible
to issue a procfs registration with the existing file name although we
check the conflict beforehand.
The fix is simply to move the snd\_cards and snd\_cards\_lock clearances
at the end of the disconnection procedure. The references to these
entries are merely either from the global proc files like
/proc/asound/cards or from the card registration / disconnection, so
it should be fine to shift at the very end.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit cfb5fb042ee1c8dbfbce53016f331c97c4f29411
Author: Hui Wang
Date: Wed Apr 17 16:10:32 2019 +0800
ALSA: hda/realtek - add two more pin configuration sets to quirk table
commit b26e36b7ef36a8a3a147b1609b2505f8a4ecf511 upstream.
We have two Dell laptops which have the codec 10ec0236 and 10ec0256
respectively, the headset mic on them can't work, need to apply the
quirk of ALC255\_FIXUP\_DELL1\_MIC\_NO\_PRESENCE. So adding their pin
configurations in the pin quirk table.
Cc:
Signed-off-by: Hui Wang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 9ae4c50f5e5284808370b47e22a2d0f7dcb38e34
Author: Ian Abbott
Date: Mon Apr 15 12:43:02 2019 +0100
staging: comedi: ni\_usb6501: Fix possible double-free of ->usb\_rx\_buf
commit af4b54a2e5ba18259ff9aac445bf546dd60d037e upstream.
`ni6501\_alloc\_usb\_buffers()` is called from `ni6501\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `ni6501\_detach()` will be called from the core comedi
module code to clean up. `ni6501\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already beed freed, leading to a
double-free error. Fix it bu removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `ni6501\_alloc\_usb\_buffers()`, relying
on `ni6501\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 72cd1a3275cfc4a57d4e0799237666def6fc2510
Author: Ian Abbott
Date: Mon Apr 15 12:43:01 2019 +0100
staging: comedi: ni\_usb6501: Fix use of uninitialized mutex
commit 660cf4ce9d0f3497cc7456eaa6d74c8b71d6282c upstream.
If `ni6501\_auto\_attach()` returns an error, the core comedi module code
will call `ni6501\_detach()` to clean up. If `ni6501\_auto\_attach()`
successfully allocated the comedi device private data, `ni6501\_detach()`
assumes that a `struct mutex mut` contained in the private data has been
initialized and uses it. Unfortunately, there are a couple of places
where `ni6501\_auto\_attach()` can return an error after allocating the
device private data but before initializing the mutex, so this
assumption is invalid. Fix it by initializing the mutex just after
allocating the private data in `ni6501\_auto\_attach()` before any other
errors can be retturned. Also move the call to `usb\_set\_intfdata()`
just to keep the code a bit neater (either position for the call is
fine).
I believe this was the cause of the following syzbot crash report
:
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
usb 1-1: string descriptor 0 read error: -71
comedi comedi0: Wrong number of endpoints
ni6501 1-1:0.233: driver 'ni6501' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 585 Comm: kworker/0:3 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_mutex\_lock\_common kernel/locking/mutex.c:925 [inline]
\_\_mutex\_lock+0xfe/0x12b0 kernel/locking/mutex.c:1072
ni6501\_detach+0x5b/0x110 drivers/staging/comedi/drivers/ni\_usb6501.c:567
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+cf4f2b6c24aff0a3edf6@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 9de6de262c33c8700a2af6209ba732595eb0f94e
Author: Ian Abbott
Date: Mon Apr 15 12:52:30 2019 +0100
staging: comedi: vmk80xx: Fix possible double-free of ->usb\_rx\_buf
commit 663d294b4768bfd89e529e069bffa544a830b5bf upstream.
`vmk80xx\_alloc\_usb\_buffers()` is called from `vmk80xx\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `vmk80xx\_detach()` will be called from the core comedi
module code to clean up. `vmk80xx\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already been freed, leading to a
double-free error. Fix it by removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `vmk80xx\_alloc\_usb\_buffers()`, relying
on `vmk80xx\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 586f669a2f06818d0c509b17dbd5ab8e216c3ba0
Author: Ian Abbott
Date: Mon Apr 15 12:10:14 2019 +0100
staging: comedi: vmk80xx: Fix use of uninitialized semaphore
commit 08b7c2f9208f0e2a32159e4e7a4831b7adb10a3e upstream.
If `vmk80xx\_auto\_attach()` returns an error, the core comedi module code
will call `vmk80xx\_detach()` to clean up. If `vmk80xx\_auto\_attach()`
successfully allocated the comedi device private data,
`vmk80xx\_detach()` assumes that a `struct semaphore limit\_sem` contained
in the private data has been initialized and uses it. Unfortunately,
there are a couple of places where `vmk80xx\_auto\_attach()` can return an
error after allocating the device private data but before initializing
the semaphore, so this assumption is invalid. Fix it by initializing
the semaphore just after allocating the private data in
`vmk80xx\_auto\_attach()` before any other errors can be returned.
I believe this was the cause of the following syzbot crash report
:
usb 1-1: config 0 has no interface number 0
usb 1-1: New USB device found, idVendor=10cf, idProduct=8068, bcdDevice=e6.8d
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
vmk80xx 1-1:0.117: driver 'vmk80xx' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 12 Comm: kworker/0:1 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 [inline]
\_raw\_spin\_lock\_irqsave+0x44/0x60 kernel/locking/spinlock.c:152
down+0x12/0x80 kernel/locking/semaphore.c:58
vmk80xx\_detach+0x59/0x100 drivers/staging/comedi/drivers/vmk80xx.c:829
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+54c2f58f15fe6876b6ad@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit de970d4efc3bfb944d4c835bed5b73b8f96a10c5
Author: he, bo
Date: Wed Mar 6 10:32:20 2019 +0800
io: accel: kxcjk1013: restore the range after resume.
commit fe2d3df639a7940a125a33d6460529b9689c5406 upstream.
On some laptops, kxcjk1013 is powered off when system enters S3. We need
restore the range regiter during resume. Otherwise, the sensor doesn't
work properly after S3.
Signed-off-by: he, bo
Signed-off-by: Chen, Hu
Reviewed-by: Hans de Goede
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 0386fd65c2db218972a1965471d9c0428a4f5aba
Author: Fabrice Gasnier
Date: Mon Mar 25 14:01:23 2019 +0100
iio: core: fix a possible circular locking dependency
commit 7f75591fc5a123929a29636834d1bcb8b5c9fee3 upstream.
This fixes a possible circular locking dependency detected warning seen
with:
- CONFIG\_PROVE\_LOCKING=y
- consumer/provider IIO devices (ex: "voltage-divider" consumer of "adc")
When using the IIO consumer interface, e.g. iio\_channel\_get(), the consumer
device will likely call iio\_read\_channel\_raw() or similar that rely on
'info\_exist\_lock' mutex.
typically:
...
mutex\_lock(&chan->indio\_dev->info\_exist\_lock);
if (chan->indio\_dev->info == NULL) {
ret = -ENODEV;
goto err\_unlock;
}
ret = do\_some\_ops()
err\_unlock:
mutex\_unlock(&chan->indio\_dev->info\_exist\_lock);
return ret;
...
Same mutex is also hold in iio\_device\_unregister().
The following deadlock warning happens when:
- the consumer device has called an API like iio\_read\_channel\_raw()
at least once.
- the consumer driver is unregistered, removed (unbind from sysfs)
======================================================
WARNING: possible circular locking dependency detected
4.19.24 #577 Not tainted
------------------------------------------------------
sh/372 is trying to acquire lock:
(kn->count#30){++++}, at: kernfs\_remove\_by\_name\_ns+0x3c/0x84
but task is already holding lock:
(&dev->info\_exist\_lock){+.+.}, at: iio\_device\_unregister+0x18/0x60
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&dev->info\_exist\_lock){+.+.}:
\_\_mutex\_lock+0x70/0xa3c
mutex\_lock\_nested+0x1c/0x24
iio\_read\_channel\_raw+0x1c/0x60
iio\_read\_channel\_info+0xa8/0xb0
dev\_attr\_show+0x1c/0x48
sysfs\_kf\_seq\_show+0x84/0xec
seq\_read+0x154/0x528
\_\_vfs\_read+0x2c/0x15c
vfs\_read+0x8c/0x110
ksys\_read+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbedefb60
-> #0 (kn->count#30){++++}:
lock\_acquire+0xd8/0x268
\_\_kernfs\_remove+0x288/0x374
kernfs\_remove\_by\_name\_ns+0x3c/0x84
remove\_files+0x34/0x78
sysfs\_remove\_group+0x40/0x9c
sysfs\_remove\_groups+0x24/0x34
device\_remove\_attrs+0x38/0x64
device\_del+0x11c/0x360
cdev\_device\_del+0x14/0x2c
iio\_device\_unregister+0x24/0x60
release\_nodes+0x1bc/0x200
device\_release\_driver\_internal+0x1a0/0x230
unbind\_store+0x80/0x130
kernfs\_fop\_write+0x100/0x1e4
\_\_vfs\_write+0x2c/0x160
vfs\_write+0xa4/0x17c
ksys\_write+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbe906840
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
\*\*\* DEADLOCK \*\*\*
...
cdev\_device\_del() can be called without holding the lock. It should be safe
as info\_exist\_lock prevents kernelspace consumers to use the exported
routines during/after provider removal. cdev\_device\_del() is for userspace.
Help to reproduce:
See example: Documentation/devicetree/bindings/iio/afe/voltage-divider.txt
sysv {
compatible = "voltage-divider";
io-channels = <&adc 0>;
output-ohms = <22>;
full-ohms = <222>;
};
First, go to iio:deviceX for the "voltage-divider", do one read:
$ cd /sys/bus/iio/devices/iio:deviceX
$ cat in\_voltage0\_raw
Then, unbind the consumer driver. It triggers above deadlock warning.
$ cd /sys/bus/platform/drivers/iio-rescale/
$ echo sysv > unbind
Note I don't actually expect stable will pick this up all the
way back into IIO being in staging, but if's probably valid that
far back.
Signed-off-by: Fabrice Gasnier
Fixes: ac917a81117c ("staging:iio:core set the iio\_dev.info pointer to null on unregister")
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit fe400daf26deaf94cb182fec48b80079d305097e
Author: Georg Ottinger
Date: Wed Jan 30 14:42:02 2019 +0100
iio: adc: at91: disable adc channel interrupt in timeout case
commit 09c6bdee51183a575bf7546890c8c137a75a2b44 upstream.
Having a brief look at at91\_adc\_read\_raw() it is obvious that in the case
of a timeout the setting of AT91\_ADC\_CHDR and AT91\_ADC\_IDR registers is
omitted. If 2 different channels are queried we can end up with a
situation where two interrupts are enabled, but only one interrupt is
cleared in the interrupt handler. Resulting in a interrupt loop and a
system hang.
Signed-off-by: Georg Ottinger
Acked-by: Ludovic Desroches
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 1ae7297b737d39fe42cec4de3151e54aefec3666
Author: Lars-Peter Clausen
Date: Wed Feb 20 17:11:32 2019 +0200
iio: Fix scan mask selection
commit 20ea39ef9f2f911bd01c69519e7d69cfec79fde3 upstream.
The trialmask is expected to have all bits set to 0 after allocation.
Currently kmalloc\_array() is used which does not zero the memory and so
random bits are set. This results in random channels being enabled when
they shouldn't. Replace kmalloc\_array() with kcalloc() which has the same
interface but zeros the memory.
Note the fix is actually required earlier than the below fixes tag, but
will require a manual backport due to move from kmalloc to kmalloc\_array.
Signed-off-by: Lars-Peter Clausen
Signed-off-by: Alexandru Ardelean
Fixes commit 057ac1acdfc4 ("iio: Use kmalloc\_array() in iio\_scan\_mask\_set()").
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 8ba5d597593acc318e426d7931d32719039b5138
Author: Jean-Francois Dagenais
Date: Wed Mar 6 15:56:06 2019 -0500
iio: dac: mcp4725: add missing powerdown bits in store eeprom
commit 06003531502d06bc89d32528f6ec96bf978790f9 upstream.
When issuing the write DAC register and write eeprom command, the two
powerdown bits (PD0 and PD1) are assumed by the chip to be present in
the bytes sent. Leaving them at 0 implies "powerdown disabled" which is
a different state that the current one. By adding the current state of
the powerdown in the i2c write, the chip will correctly power-on exactly
like as it is at the moment of store\_eeprom call.
This is documented in MCP4725's datasheet, FIGURE 6-2: "Write Commands
for DAC Input Register and EEPROM" and MCP4726's datasheet, FIGURE 6-3:
"Write All Memory Command".
Signed-off-by: Jean-Francois Dagenais
Acked-by: Peter Meerwald-Stadler
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit ad0f65cd55b88f2e4d49968f9d5aba26fe3e8c1c
Author: Dragos Bogdan
Date: Tue Mar 19 12:47:00 2019 +0200
iio: ad\_sigma\_delta: select channel when reading register
commit fccfb9ce70ed4ea7a145f77b86de62e38178517f upstream.
The desired channel has to be selected in order to correctly fill the
buffer with the corresponding data.
The `ad\_sd\_write\_reg()` already does this, but for the
`ad\_sd\_read\_reg\_raw()` this was omitted.
Fixes: af3008485ea03 ("iio:adc: Add common code for ADI Sigma Delta devices")
Signed-off-by: Dragos Bogdan
Signed-off-by: Alexandru Ardelean
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 0336305753a66205f0b74ab9c7236cd436238870
Author: Gwendal Grignou
Date: Wed Mar 13 12:40:02 2019 +0100
iio: cros\_ec: Fix the maths for gyro scale calculation
commit 3d02d7082e5823598090530c3988a35f69689943 upstream.
Calculation did not use IIO\_DEGREE\_TO\_RAD and implemented a variant to
avoid precision loss as we aim a nano value. The offset added to avoid
rounding error, though, doesn't give us a close result to the expected
value. E.g.
For 1000dps, the result should be:
(1000 \* pi ) / 180 >> 15 ~= 0.000532632218
But with current calculation we get
$ cat scale
0.000547890
Fix the calculation by just doing the maths involved for a nano value
val \* pi \* 10e12 / (180 \* 2^15)
so we get a closer result.
$ cat scale
0.000532632
Fixes: c14dca07a31d ("iio: cros\_ec\_sensors: add ChromeOS EC Contiguous Sensors driver")
Signed-off-by: Gwendal Grignou
Signed-off-by: Enric Balletbo i Serra
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit f245ce44d58e88c74d37d73b23ac9617789038d2
Author: Mike Looijmans
Date: Wed Feb 13 08:41:47 2019 +0100
iio/gyro/bmg160: Use millidegrees for temperature scale
commit 40a7198a4a01037003c7ca714f0d048a61e729ac upstream.
Standard unit for temperature is millidegrees Celcius, whereas this driver
was reporting in degrees. Fix the scale factor in the driver.
Signed-off-by: Mike Looijmans
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit b7ad00c028ab8ab238cc72906b8fdb6ed3c874ea
Author: Sergey Larin
Date: Sat Mar 2 19:54:55 2019 +0300
iio: gyro: mpu3050: fix chip ID reading
commit 409a51e0a4a5f908763191fae2c29008632eb712 upstream.
According to the datasheet, the last bit of CHIP\_ID register controls
I2C bus, and the first one is unused. Handle this correctly.
Note that there are chips out there that have a value such that
the id check currently fails.
Signed-off-by: Sergey Larin
Reviewed-by: Linus Walleij
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 63aafa6501a5640032107fe9647818a930b18222
Author: Mircea Caprioru
Date: Wed Feb 20 13:08:20 2019 +0200
staging: iio: ad7192: Fix ad7193 channel address
commit 7ce0f216221856a17fc4934b39284678a5fef2e9 upstream.
This patch fixes the differential channels addresses for the ad7193.
Signed-off-by: Mircea Caprioru
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit b69e4d5f1ab43ea3c5e41ac841606eaffdc61402
Author: Leonard Pollak
Date: Wed Feb 13 11:19:52 2019 +0100
Staging: iio: meter: fixed typo
commit 0a8a29be499cbb67df79370aaf5109085509feb8 upstream.
This patch fixes an obvious typo, which will cause erroneously returning the Peak
Voltage instead of the Peak Current.
Signed-off-by: Leonard Pollak
Cc:
Acked-by: Michael Hennerich
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 8091c2ae4a1949f0f2cb8b48a6ccaf383661a76b
Author: Vitaly Kuznetsov
Date: Wed Apr 3 16:06:42 2019 +0200
KVM: x86: svm: make sure NMI is injected after nmi\_singlestep
commit 99c221796a810055974b54c02e8f53297e48d146 upstream.
I noticed that apic test from kvm-unit-tests always hangs on my EPYC 7401P,
the hanging test nmi-after-sti is trying to deliver 30000 NMIs and tracing
shows that we're sometimes able to deliver a few but never all.
When we're trying to inject an NMI we may fail to do so immediately for
various reasons, however, we still need to inject it so enable\_nmi\_window()
arms nmi\_singlestep mode. #DB occurs as expected, but we're not checking
for pending NMIs before entering the guest and unless there's a different
event to process, the NMI will never get delivered.
Make KVM\_REQ\_EVENT request on the vCPU from db\_interception() to make sure
pending NMIs are checked and possibly injected.
Signed-off-by: Vitaly Kuznetsov
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit bc1919400960a50e50ff55b0fde97342e4be621b
Author: Sean Christopherson
Date: Tue Apr 2 08:10:47 2019 -0700
KVM: x86: Don't clear EFER during SMM transitions for 32-bit vCPU
commit 8f4dc2e77cdfaf7e644ef29693fa229db29ee1de upstream.
Neither AMD nor Intel CPUs have an EFER field in the legacy SMRAM save
state area, i.e. don't save/restore EFER across SMM transitions. KVM
somewhat models this, e.g. doesn't clear EFER on entry to SMM if the
guest doesn't support long mode. But during RSM, KVM unconditionally
clears EFER so that it can get back to pure 32-bit mode in order to
start loading CRs with their actual non-SMM values.
Clear EFER only when it will be written when loading the non-SMM state
so as to preserve bits that can theoretically be set on 32-bit vCPUs,
e.g. KVM always emulates EFER\_SCE.
And because CR4.PAE is cleared only to play nice with EFER, wrap that
code in the long mode check as well. Note, this may result in a
compiler warning about cr4 being consumed uninitialized. Re-read CR4
even though it's technically unnecessary, as doing so allows for more
readable code and RSM emulation is not a performance critical path.
Fixes: 660a5d517aaab ("KVM: x86: save/load state on SMM switch")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 53fc31a4853e30d6e8f142b824f724da27ff3e40
Author: Aurelien Aptel
Date: Fri Mar 29 10:49:12 2019 +0100
CIFS: keep FileInfo handle live during oplock break
commit b98749cac4a695f084a5ff076f4510b23e353ecd upstream.
In the oplock break handler, writing pending changes from pages puts
the FileInfo handle. If the refcount reaches zero it closes the handle
and waits for any oplock break handler to return, thus causing a deadlock.
To prevent this situation:
\* We add a wait flag to cifsFileInfo\_put() to decide whether we should
wait for running/pending oplock break handlers
\* We keep an additionnal reference of the SMB FileInfo handle so that
for the rest of the handler putting the handle won't close it.
- The ref is bumped everytime we queue the handler via the
cifs\_queue\_oplock\_break() helper.
- The ref is decremented at the end of the handler
This bug was triggered by xfstest 464.
Also important fix to address the various reports of
oops in smb2\_push\_mandatory\_locks
Signed-off-by: Aurelien Aptel
Signed-off-by: Steve French
Reviewed-by: Pavel Shilovsky
CC: Stable
Signed-off-by: Greg Kroah-Hartman
commit 4a692bc1d5fa706d9170404c34b3efa190ebf039
Author: Matteo Croce
Date: Thu Apr 11 12:26:33 2019 +0200
net: thunderx: don't allow jumbo frames with XDP
[ Upstream commit 1f227d16083b2e280b7dde4ca78883d75593f2fd ]
The thunderx driver forbids to load an eBPF program if the MTU is too high,
but this can be circumvented by loading the eBPF, then raising the MTU.
Fix this by limiting the MTU if an eBPF program is already loaded.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6d5d30e03309fc22a48fc522b2e3f3c02c130092
Author: Matteo Croce
Date: Thu Apr 11 12:26:32 2019 +0200
net: thunderx: raise XDP MTU to 1508
[ Upstream commit 5ee15c101f29e0093ffb5448773ccbc786eb313b ]
The thunderx driver splits frames bigger than 1530 bytes to multiple
pages, making impossible to run an eBPF program on it.
This leads to a maximum MTU of 1508 if QinQ is in use.
The thunderx driver forbids to load an eBPF program if the MTU is higher
than 1500 bytes. Raise the limit to 1508 so it is possible to use L2
protocols which need some more headroom.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0a7e8300b7f4cf72a6f1c0c2799d92149465c414
Author: Eric Dumazet
Date: Sat Apr 13 17:32:21 2019 -0700
ipv4: ensure rcu\_read\_lock() in ipv4\_link\_failure()
[ Upstream commit c543cb4a5f07e09237ec0fc2c60c9f131b2c79ad ]
fib\_compute\_spec\_dst() needs to be called under rcu protection.
syzbot reported :
WARNING: suspicious RCU usage
5.1.0-rc4+ #165 Not tainted
include/linux/inetdevice.h:220 suspicious rcu\_dereference\_check() usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by swapper/0/0:
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: lockdep\_copy\_map include/linux/lockdep.h:170 [inline]
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: call\_timer\_fn+0xda/0x720 kernel/time/timer.c:1315
stack backtrace:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.1.0-rc4+ #165
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x172/0x1f0 lib/dump\_stack.c:113
lockdep\_rcu\_suspicious+0x153/0x15d kernel/locking/lockdep.c:5162
\_\_in\_dev\_get\_rcu include/linux/inetdevice.h:220 [inline]
fib\_compute\_spec\_dst+0xbbd/0x1030 net/ipv4/fib\_frontend.c:294
spec\_dst\_fill net/ipv4/ip\_options.c:245 [inline]
\_\_ip\_options\_compile+0x15a7/0x1a10 net/ipv4/ip\_options.c:343
ipv4\_link\_failure+0x172/0x400 net/ipv4/route.c:1195
dst\_link\_failure include/net/dst.h:427 [inline]
arp\_error\_report+0xd1/0x1c0 net/ipv4/arp.c:297
neigh\_invalidate+0x24b/0x570 net/core/neighbour.c:995
neigh\_timer\_handler+0xc35/0xf30 net/core/neighbour.c:1081
call\_timer\_fn+0x190/0x720 kernel/time/timer.c:1325
expire\_timers kernel/time/timer.c:1362 [inline]
\_\_run\_timers kernel/time/timer.c:1681 [inline]
\_\_run\_timers kernel/time/timer.c:1649 [inline]
run\_timer\_softirq+0x652/0x1700 kernel/time/timer.c:1694
\_\_do\_softirq+0x266/0x95a kernel/softirq.c:293
invoke\_softirq kernel/softirq.c:374 [inline]
irq\_exit+0x180/0x1d0 kernel/softirq.c:414
exiting\_irq arch/x86/include/asm/apic.h:536 [inline]
smp\_apic\_timer\_interrupt+0x14a/0x570 arch/x86/kernel/apic/apic.c:1062
apic\_timer\_interrupt+0xf/0x20 arch/x86/entry/entry\_64.S:807
Fixes: ed0de45a1008 ("ipv4: recompile ip options in ipv4\_link\_failure")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3d988fcddbe7b8673a231958bd2fba61b5a7ced9
Author: Stephen Suryaputra
Date: Fri Apr 12 16:19:27 2019 -0400
ipv4: recompile ip options in ipv4\_link\_failure
[ Upstream commit ed0de45a1008991fdaa27a0152befcb74d126a8b ]
Recompile IP options since IPCB may not be valid anymore when
ipv4\_link\_failure is called from arp\_error\_report.
Refer to the commit 3da1ed7ac398 ("net: avoid use IPCB in cipso\_v4\_error")
and the commit before that (9ef6b42ad6fd) for a similar issue.
Signed-off-by: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f052bafe5476347fe9ae0665c4d2297ad1301e38
Author: Jason Wang
Date: Tue Apr 9 12:10:25 2019 +0800
vhost: reject zero size iova range
[ Upstream commit 813dbeb656d6c90266f251d8bd2b02d445afa63f ]
We used to accept zero size iova range which will lead a infinite loop
in translate\_desc(). Fixing this by failing the request in this case.
Reported-by: syzbot+d21e6e297322a900c128@syzkaller.appspotmail.com
Fixes: 6b1e6cc7 ("vhost: new device IOTLB API")
Signed-off-by: Jason Wang
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b205097fae230acfe7a928e7f4875148568667bd
Author: Hangbin Liu
Date: Mon Apr 8 16:45:17 2019 +0800
team: set slave to promisc if team is already in promisc mode
[ Upstream commit 43c2adb9df7ddd6560fd3546d925b42cef92daa0 ]
After adding a team interface to bridge, the team interface will enter
promisc mode. Then if we add a new slave to team0, the slave will keep
promisc off. Fix it by setting slave to promisc on if team master is
already in promisc mode, also do the same for allmulti.
v2: add promisc and allmulti checking when delete ports
Fixes: 3d249d4ca7d0 ("net: introduce ethernet teaming device")
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 07b1747f11af7cb3ed0903cd8bf3b5a382452ec4
Author: Eric Dumazet
Date: Tue Apr 16 10:55:20 2019 -0700
tcp: tcp\_grow\_window() needs to respect tcp\_space()
[ Upstream commit 50ce163a72d817a99e8974222dcf2886d5deb1ae ]
For some reason, tcp\_grow\_window() correctly tests if enough room
is present before attempting to increase tp->rcv\_ssthresh,
but does not prevent it to grow past tcp\_space()
This is causing hard to debug issues, like failing
the (\_\_tcp\_select\_window(sk) >= tp->rcv\_wnd) test
in \_\_tcp\_ack\_snd\_check(), causing ACK delays and possibly
slow flows.
Depending on tcp\_rmem[2], MTU, skb->len/skb->truesize ratio,
we can see the problem happening on "netperf -t TCP\_RR -- -r 2000,2000"
after about 60 round trips, when the active side no longer sends
immediate acks.
This bug predates git history.
Signed-off-by: Eric Dumazet
Acked-by: Soheil Hassas Yeganeh
Acked-by: Neal Cardwell
Acked-by: Wei Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8835f1c7d0fb0faf6df93c1715f13b9ef04a9e99
Author: Lorenzo Bianconi
Date: Tue Apr 9 11:47:20 2019 +0200
net: fou: do not use guehdr after iptunnel\_pull\_offloads in gue\_udp\_recv
[ Upstream commit 988dc4a9a3b66be75b30405a5494faf0dc7cffb6 ]
gue tunnels run iptunnel\_pull\_offloads on received skbs. This can
determine a possible use-after-free accessing guehdr pointer since
the packet will be 'uncloned' running pskb\_expand\_head if it is a
cloned gso skb (e.g if the packet has been sent though a veth device)
Fixes: a09a4c8dd1ec ("tunnels: Remove encapsulation offloads on decap")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c1e7e01e2edb90678e26f100fae0dc50024d139b
Author: Nikolay Aleksandrov
Date: Thu Apr 11 15:08:25 2019 +0300
net: bridge: multicast: use rcu to access port list from br\_multicast\_start\_querier
[ Upstream commit c5b493ce192bd7a4e7bd073b5685aad121eeef82 ]
br\_multicast\_start\_querier() walks over the port list but it can be
called from a timer with only multicast\_lock held which doesn't protect
the port list, so use RCU to walk over it.
Fixes: c83b8fab06fc ("bridge: Restart queries when last querier expires")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a1a9b69e2605db1edea34bb3a6051cf845b26bc1
Author: Nikolay Aleksandrov
Date: Thu Apr 11 13:56:39 2019 +0300
net: bridge: fix per-port af\_packet sockets
[ Upstream commit 3b2e2904deb314cc77a2192f506f2fd44e3d10d0 ]
When the commit below was introduced it changed two visible things:
- the skb was no longer passed through the protocol handlers with the
original device
- the skb was passed up the stack with skb->dev = bridge
The first change broke af\_packet sockets on bridge ports. For example we
use them for hostapd which listens for ETH\_P\_PAE packets on the ports.
We discussed two possible fixes:
- create a clone and pass it through NF\_HOOK(), act on the original skb
based on the result
- somehow signal to the caller from the okfn() that it was called,
meaning the skb is ok to be passed, which this patch is trying to
implement via returning 1 from the bridge link-local okfn()
Note that we rely on the fact that NF\_QUEUE/STOLEN would return 0 and
drop/error would return < 0 thus the okfn() is called only when the
return was 1, so we signal to the caller that it was called by preserving
the return value from nf\_hook().
Fixes: 8626c56c8279 ("bridge: fix potential use-after-free when hook returns QUEUE or STOLEN verdict")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9fac50c39253b6bef74c2cfc2244a93c4d5a0896
Author: Gustavo A. R. Silva
Date: Mon Apr 15 15:57:23 2019 -0500
net: atm: Fix potential Spectre v1 vulnerabilities
[ Upstream commit 899537b73557aafbdd11050b501cf54b4f5c45af ]
arg is controlled by user-space, hence leading to a potential
exploitation of the Spectre variant 1 vulnerability.
This issue was detected with the help of Smatch:
net/atm/lec.c:715 lec\_mcast\_attach() warn: potential spectre issue 'dev\_lec' [r] (local cap)
Fix this by sanitizing arg before using it to index dev\_lec.
Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].
[1] https://lore.kernel.org/lkml/20180423164740.GY17484@dhcp22.suse.cz/
Signed-off-by: Gustavo A. R. Silva
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a1b3ec23f8884a77cd2def23ace3904d1e2d8788
Author: Sabrina Dubroca
Date: Fri Apr 12 15:04:10 2019 +0200
bonding: fix event handling for stacked bonds
[ Upstream commit 92480b3977fd3884649d404cbbaf839b70035699 ]
When a bond is enslaved to another bond, bond\_netdev\_event() only
handles the event as if the bond is a master, and skips treating the
bond as a slave.
This leads to a refcount leak on the slave, since we don't remove the
adjacency to its master and the master holds a reference on the slave.
Reproducer:
ip link add bondL type bond
ip link add bondU type bond
ip link set bondL master bondU
ip link del bondL
No "Fixes:" tag, this code is older than git history.
Signed-off-by: Sabrina Dubroca
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from cdn.kernel.org_cf5042a8_20250121_010333.html ===
commit d3da1f09fff27b3ae5908119dab312b9baec09e0
Author: Greg Kroah-Hartman
Date: Sat Apr 27 09:37:45 2019 +0200
Linux 5.0.10
commit c735a988a9caa19b752565203b8c8924202a8555
Author: Will Deacon
Date: Fri Apr 5 18:39:38 2019 -0700
kernel/sysctl.c: fix out-of-bounds access when setting file-max
commit 9002b21465fa4d829edfc94a5a441005cffaa972 upstream.
Commit 32a5ad9c2285 ("sysctl: handle overflow for file-max") hooked up
min/max values for the file-max sysctl parameter via the .extra1 and
.extra2 fields in the corresponding struct ctl\_table entry.
Unfortunately, the minimum value points at the global 'zero' variable,
which is an int. This results in a KASAN splat when accessed as a long
by proc\_doulongvec\_minmax on 64-bit architectures:
| BUG: KASAN: global-out-of-bounds in \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| Read of size 8 at addr ffff2000133d1c20 by task systemd/1
|
| CPU: 0 PID: 1 Comm: systemd Not tainted 5.1.0-rc3-00012-g40b114779944 #2
| Hardware name: linux,dummy-virt (DT)
| Call trace:
| dump\_backtrace+0x0/0x228
| show\_stack+0x14/0x20
| dump\_stack+0xe8/0x124
| print\_address\_description+0x60/0x258
| kasan\_report+0x140/0x1a0
| \_\_asan\_report\_load8\_noabort+0x18/0x20
| \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| proc\_doulongvec\_minmax+0x4c/0x78
| proc\_sys\_call\_handler.isra.19+0x144/0x1d8
| proc\_sys\_write+0x34/0x58
| \_\_vfs\_write+0x54/0xe8
| vfs\_write+0x124/0x3c0
| ksys\_write+0xbc/0x168
| \_\_arm64\_sys\_write+0x68/0x98
| el0\_svc\_common+0x100/0x258
| el0\_svc\_handler+0x48/0xc0
| el0\_svc+0x8/0xc
|
| The buggy address belongs to the variable:
| zero+0x0/0x40
|
| Memory state around the buggy address:
| ffff2000133d1b00: 00 00 00 00 00 00 00 00 fa fa fa fa 04 fa fa fa
| ffff2000133d1b80: fa fa fa fa 04 fa fa fa fa fa fa fa 04 fa fa fa
| >ffff2000133d1c00: fa fa fa fa 04 fa fa fa fa fa fa fa 00 00 00 00
| ^
| ffff2000133d1c80: fa fa fa fa 00 fa fa fa fa fa fa fa 00 00 00 00
| ffff2000133d1d00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Fix the splat by introducing a unsigned long 'zero\_ul' and using that
instead.
Link: http://lkml.kernel.org/r/20190403153409.17307-1-will.deacon@arm.com
Fixes: 32a5ad9c2285 ("sysctl: handle overflow for file-max")
Signed-off-by: Will Deacon
Acked-by: Christian Brauner
Cc: Kees Cook
Cc: Alexey Dobriyan
Cc: Matteo Croce
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 822482bff7c53312f508c8e94b424823f66d67f8
Author: Matteo Croce
Date: Mon Mar 18 02:32:36 2019 +0100
percpu: stop printing kernel addresses
commit 00206a69ee32f03e6f40837684dcbe475ea02266 upstream.
Since commit ad67b74d2469d9b8 ("printk: hash addresses printed with %p"),
at boot "\_\_\_\_ptrval\_\_\_\_" is printed instead of actual addresses:
percpu: Embedded 38 pages/cpu @(\_\_\_\_ptrval\_\_\_\_) s124376 r0 d31272 u524288
Instead of changing the print to "%px", and leaking kernel addresses,
just remove the print completely, cfr. e.g. commit 071929dbdd865f77
("arm64: Stop printing the virtual memory layout").
Signed-off-by: Matteo Croce
Signed-off-by: Dennis Zhou
Signed-off-by: Greg Kroah-Hartman
commit b2c65593ea626d28f1d20ed86281f8a8fdec2738
Author: Takashi Iwai
Date: Tue Apr 16 15:25:00 2019 +0200
ALSA: info: Fix racy addition/deletion of nodes
commit 8c2f870890fd28e023b0fcf49dcee333f2c8bad7 upstream.
The ALSA proc helper manages the child nodes in a linked list, but its
addition and deletion is done without any lock. This leads to a
corruption if they are operated concurrently. Usually this isn't a
problem because the proc entries are added sequentially in the driver
probe procedure itself. But the card registrations are done often
asynchronously, and the crash could be actually reproduced with
syzkaller.
This patch papers over it by protecting the link addition and deletion
with the parent's mutex. There is "access" mutex that is used for the
file access, and this can be reused for this purpose as well.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c3d0cf332bcde20591186a72d2de915c5bc0cc68
Author: Konstantin Khlebnikov
Date: Thu Apr 18 17:50:20 2019 -0700
mm/vmstat.c: fix /proc/vmstat format for CONFIG\_DEBUG\_TLBFLUSH=y CONFIG\_SMP=n
commit e8277b3b52240ec1caad8e6df278863e4bf42eac upstream.
Commit 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
depends on skipping vmstat entries with empty name introduced in
7aaf77272358 ("mm: don't show nr\_indirectly\_reclaimable in
/proc/vmstat") but reverted in b29940c1abd7 ("mm: rename and change
semantics of nr\_indirectly\_reclaimable\_bytes").
So skipping no longer works and /proc/vmstat has misformatted lines " 0".
This patch simply shows debug counters "nr\_tlb\_remote\_\*" for UP.
Link: http://lkml.kernel.org/r/155481488468.467.4295519102880913454.stgit@buzz
Fixes: 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
Signed-off-by: Konstantin Khlebnikov
Acked-by: Vlastimil Babka
Cc: Roman Gushchin
Cc: Jann Horn
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 4ae522890cc19038c84769d20f9ffdfc2d58a36b
Author: zhong jiang
Date: Thu Apr 18 17:50:16 2019 -0700
mm/memory\_hotplug: do not unlock after failing to take the device\_hotplug\_lock
commit 37803841c92d7b327147e0b1be3436423189e1cf upstream.
When adding memory by probing a memory block in the sysfs interface,
there is an obvious issue where we will unlock the device\_hotplug\_lock
when we failed to takes it.
That issue was introduced in 8df1d0e4a265 ("mm/memory\_hotplug: make
add\_memory() take the device\_hotplug\_lock").
We should drop out in time when failing to take the device\_hotplug\_lock.
Link: http://lkml.kernel.org/r/1554696437-9593-1-git-send-email-zhongjiang@huawei.com
Fixes: 8df1d0e4a265 ("mm/memory\_hotplug: make add\_memory() take the device\_hotplug\_lock")
Signed-off-by: zhong jiang
Reported-by: Yang yingliang
Acked-by: Michal Hocko
Reviewed-by: David Hildenbrand
Reviewed-by: Oscar Salvador
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit c138ed72186accb0dac95066118374cf6c0807ae
Author: Alexander Shishkin
Date: Fri Mar 29 11:13:38 2019 +0200
perf/ring\_buffer: Fix AUX record suppression
commit 339bc4183596e1f68c2c98a03b87aa124107c317 upstream.
The following commit:
1627314fb54a33e ("perf: Suppress AUX/OVERWRITE records")
has an unintended side-effect of also suppressing all AUX records with no flags
and non-zero size, so all the regular records in the full trace mode.
This breaks some use cases for people.
Fix this by restoring "regular" AUX records.
Reported-by: Ben Gainey
Tested-by: Ben Gainey
Signed-off-by: Alexander Shishkin
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Fixes: 1627314fb54a33e ("perf: Suppress AUX/OVERWRITE records")
Link: https://lkml.kernel.org/r/20190329091338.29999-1-alexander.shishkin@linux.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 65fce15dbd8726c9f13c7b0b240f430afdca6a2c
Author: Jann Horn
Date: Tue Mar 19 02:36:59 2019 +0100
device\_cgroup: fix RCU imbalance in error case
commit 0fcc4c8c044e117ac126ab6df4138ea9a67fa2a9 upstream.
When dev\_exception\_add() returns an error (due to a failed memory
allocation), make sure that we move the RCU preemption count back to where
it was before we were called. We dropped the RCU read lock inside the loop
body, so we can't just "break".
sparse complains about this, too:
$ make -s C=2 security/device\_cgroup.o
./include/linux/rcupdate.h:647:9: warning: context imbalance in
'propagate\_exception' - unexpected unlock
Fixes: d591fb56618f ("device\_cgroup: simplify cgroup tree walk in propagate\_exception()")
Cc: stable@vger.kernel.org
Signed-off-by: Jann Horn
Acked-by: Michal Hocko
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit 74b4ef5df5902466a9cb832c27bcead743cda822
Author: Stanislaw Gruszka
Date: Fri Apr 5 13:42:56 2019 +0200
mt76x02: avoid status\_list.lock and sta->rate\_ctrl\_lock dependency
commit bafdf85dfa59374f927ff597bc8c259193afda30 upstream.
Move ieee80211\_tx\_status\_ext() outside of status\_list lock section
in order to avoid locking dependency and possible deadlock reposed by
LOCKDEP in below warning.
Also do mt76\_tx\_status\_lock() just before it's needed.
[ 440.224832] WARNING: possible circular locking dependency detected
[ 440.224833] 5.1.0-rc2+ #22 Not tainted
[ 440.224834] ------------------------------------------------------
[ 440.224835] kworker/u16:28/2362 is trying to acquire lock:
[ 440.224836] 0000000089b8cacf (&(&q->lock)->rlock#2){+.-.}, at: mt76\_wake\_tx\_queue+0x4c/0xb0 [mt76]
[ 440.224842]
but task is already holding lock:
[ 440.224842] 000000002cfedc59 (&(&sta->lock)->rlock){+.-.}, at: ieee80211\_stop\_tx\_ba\_cb+0x32/0x1f0 [mac80211]
[ 440.224863]
which lock already depends on the new lock.
[ 440.224863]
the existing dependency chain (in reverse order) is:
[ 440.224864]
-> #3 (&(&sta->lock)->rlock){+.-.}:
[ 440.224869] \_raw\_spin\_lock\_bh+0x34/0x40
[ 440.224880] ieee80211\_start\_tx\_ba\_session+0xe4/0x3d0 [mac80211]
[ 440.224894] minstrel\_ht\_get\_rate+0x45c/0x510 [mac80211]
[ 440.224906] rate\_control\_get\_rate+0xc1/0x140 [mac80211]
[ 440.224918] ieee80211\_tx\_h\_rate\_ctrl+0x195/0x3c0 [mac80211]
[ 440.224930] ieee80211\_xmit\_fast+0x26d/0xa50 [mac80211]
[ 440.224942] \_\_ieee80211\_subif\_start\_xmit+0xfc/0x310 [mac80211]
[ 440.224954] ieee80211\_subif\_start\_xmit+0x38/0x390 [mac80211]
[ 440.224956] dev\_hard\_start\_xmit+0xb8/0x300
[ 440.224957] \_\_dev\_queue\_xmit+0x7d4/0xbb0
[ 440.224968] ip6\_finish\_output2+0x246/0x860 [ipv6]
[ 440.224978] mld\_sendpack+0x1bd/0x360 [ipv6]
[ 440.224987] mld\_ifc\_timer\_expire+0x1a4/0x2f0 [ipv6]
[ 440.224989] call\_timer\_fn+0x89/0x2a0
[ 440.224990] run\_timer\_softirq+0x1bd/0x4d0
[ 440.224992] \_\_do\_softirq+0xdb/0x47c
[ 440.224994] irq\_exit+0xfa/0x100
[ 440.224996] smp\_apic\_timer\_interrupt+0x9a/0x220
[ 440.224997] apic\_timer\_interrupt+0xf/0x20
[ 440.224999] cpuidle\_enter\_state+0xc1/0x470
[ 440.225000] do\_idle+0x21a/0x260
[ 440.225001] cpu\_startup\_entry+0x19/0x20
[ 440.225004] start\_secondary+0x135/0x170
[ 440.225006] secondary\_startup\_64+0xa4/0xb0
[ 440.225007]
-> #2 (&(&sta->rate\_ctrl\_lock)->rlock){+.-.}:
[ 440.225009] \_raw\_spin\_lock\_bh+0x34/0x40
[ 440.225022] rate\_control\_tx\_status+0x4f/0xb0 [mac80211]
[ 440.225031] ieee80211\_tx\_status\_ext+0x142/0x1a0 [mac80211]
[ 440.225035] mt76x02\_send\_tx\_status+0x2e4/0x340 [mt76x02\_lib]
[ 440.225037] mt76x02\_tx\_status\_data+0x31/0x40 [mt76x02\_lib]
[ 440.225040] mt76u\_tx\_status\_data+0x51/0xa0 [mt76\_usb]
[ 440.225042] process\_one\_work+0x237/0x5d0
[ 440.225043] worker\_thread+0x3c/0x390
[ 440.225045] kthread+0x11d/0x140
[ 440.225046] ret\_from\_fork+0x3a/0x50
[ 440.225047]
-> #1 (&(&list->lock)->rlock#8){+.-.}:
[ 440.225049] \_raw\_spin\_lock\_bh+0x34/0x40
[ 440.225052] mt76\_tx\_status\_skb\_add+0x51/0x100 [mt76]
[ 440.225054] mt76x02u\_tx\_prepare\_skb+0xbd/0x116 [mt76x02\_usb]
[ 440.225056] mt76u\_tx\_queue\_skb+0x5f/0x180 [mt76\_usb]
[ 440.225058] mt76\_tx+0x93/0x190 [mt76]
[ 440.225070] ieee80211\_tx\_frags+0x148/0x210 [mac80211]
[ 440.225081] \_\_ieee80211\_tx+0x75/0x1b0 [mac80211]
[ 440.225092] ieee80211\_tx+0xde/0x110 [mac80211]
[ 440.225105] \_\_ieee80211\_tx\_skb\_tid\_band+0x72/0x90 [mac80211]
[ 440.225122] ieee80211\_send\_auth+0x1f3/0x360 [mac80211]
[ 440.225141] ieee80211\_auth.cold.40+0x6c/0x100 [mac80211]
[ 440.225156] ieee80211\_mgd\_auth.cold.50+0x132/0x15f [mac80211]
[ 440.225171] cfg80211\_mlme\_auth+0x149/0x360 [cfg80211]
[ 440.225181] nl80211\_authenticate+0x273/0x2e0 [cfg80211]
[ 440.225183] genl\_family\_rcv\_msg+0x196/0x3a0
[ 440.225184] genl\_rcv\_msg+0x47/0x8e
[ 440.225185] netlink\_rcv\_skb+0x3a/0xf0
[ 440.225187] genl\_rcv+0x24/0x40
[ 440.225188] netlink\_unicast+0x16d/0x210
[ 440.225189] netlink\_sendmsg+0x204/0x3b0
[ 440.225191] sock\_sendmsg+0x36/0x40
[ 440.225193] \_\_\_sys\_sendmsg+0x259/0x2b0
[ 440.225194] \_\_sys\_sendmsg+0x47/0x80
[ 440.225196] do\_syscall\_64+0x60/0x1f0
[ 440.225197] entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
[ 440.225198]
-> #0 (&(&q->lock)->rlock#2){+.-.}:
[ 440.225200] lock\_acquire+0xb9/0x1a0
[ 440.225202] \_raw\_spin\_lock\_bh+0x34/0x40
[ 440.225204] mt76\_wake\_tx\_queue+0x4c/0xb0 [mt76]
[ 440.225215] ieee80211\_agg\_start\_txq+0xe8/0x2b0 [mac80211]
[ 440.225225] ieee80211\_stop\_tx\_ba\_cb+0xb8/0x1f0 [mac80211]
[ 440.225235] ieee80211\_ba\_session\_work+0x1c1/0x2f0 [mac80211]
[ 440.225236] process\_one\_work+0x237/0x5d0
[ 440.225237] worker\_thread+0x3c/0x390
[ 440.225239] kthread+0x11d/0x140
[ 440.225240] ret\_from\_fork+0x3a/0x50
[ 440.225240]
other info that might help us debug this:
[ 440.225241] Chain exists of:
&(&q->lock)->rlock#2 --> &(&sta->rate\_ctrl\_lock)->rlock --> &(&sta->lock)->rlock
[ 440.225243] Possible unsafe locking scenario:
[ 440.225244] CPU0 CPU1
[ 440.225244] ---- ----
[ 440.225245] lock(&(&sta->lock)->rlock);
[ 440.225245] lock(&(&sta->rate\_ctrl\_lock)->rlock);
[ 440.225246] lock(&(&sta->lock)->rlock);
[ 440.225247] lock(&(&q->lock)->rlock#2);
[ 440.225248]
\*\*\* DEADLOCK \*\*\*
[ 440.225249] 5 locks held by kworker/u16:28/2362:
[ 440.225250] #0: 0000000048fcd291 ((wq\_completion)phy0){+.+.}, at: process\_one\_work+0x1b5/0x5d0
[ 440.225252] #1: 00000000f1c6828f ((work\_completion)(&sta->ampdu\_mlme.work)){+.+.}, at: process\_one\_work+0x1b5/0x5d0
[ 440.225254] #2: 00000000433d2b2c (&sta->ampdu\_mlme.mtx){+.+.}, at: ieee80211\_ba\_session\_work+0x5c/0x2f0 [mac80211]
[ 440.225265] #3: 000000002cfedc59 (&(&sta->lock)->rlock){+.-.}, at: ieee80211\_stop\_tx\_ba\_cb+0x32/0x1f0 [mac80211]
[ 440.225276] #4: 000000009d7b9a44 (rcu\_read\_lock){....}, at: ieee80211\_agg\_start\_txq+0x33/0x2b0 [mac80211]
[ 440.225286]
stack backtrace:
[ 440.225288] CPU: 2 PID: 2362 Comm: kworker/u16:28 Not tainted 5.1.0-rc2+ #22
[ 440.225289] Hardware name: LENOVO 20KGS23S0P/20KGS23S0P, BIOS N23ET55W (1.30 ) 08/31/2018
[ 440.225300] Workqueue: phy0 ieee80211\_ba\_session\_work [mac80211]
[ 440.225301] Call Trace:
[ 440.225304] dump\_stack+0x85/0xc0
[ 440.225306] print\_circular\_bug.isra.38.cold.58+0x15c/0x195
[ 440.225307] check\_prev\_add.constprop.48+0x5f0/0xc00
[ 440.225309] ? check\_prev\_add.constprop.48+0x39d/0xc00
[ 440.225311] ? \_\_lock\_acquire+0x41d/0x1100
[ 440.225312] \_\_lock\_acquire+0xd98/0x1100
[ 440.225313] ? \_\_lock\_acquire+0x41d/0x1100
[ 440.225315] lock\_acquire+0xb9/0x1a0
[ 440.225317] ? mt76\_wake\_tx\_queue+0x4c/0xb0 [mt76]
[ 440.225319] \_raw\_spin\_lock\_bh+0x34/0x40
[ 440.225321] ? mt76\_wake\_tx\_queue+0x4c/0xb0 [mt76]
[ 440.225323] mt76\_wake\_tx\_queue+0x4c/0xb0 [mt76]
[ 440.225334] ieee80211\_agg\_start\_txq+0xe8/0x2b0 [mac80211]
[ 440.225344] ieee80211\_stop\_tx\_ba\_cb+0xb8/0x1f0 [mac80211]
[ 440.225354] ieee80211\_ba\_session\_work+0x1c1/0x2f0 [mac80211]
[ 440.225356] process\_one\_work+0x237/0x5d0
[ 440.225358] worker\_thread+0x3c/0x390
[ 440.225359] ? wq\_calc\_node\_cpumask+0x70/0x70
[ 440.225360] kthread+0x11d/0x140
[ 440.225362] ? kthread\_create\_on\_node+0x40/0x40
[ 440.225363] ret\_from\_fork+0x3a/0x50
Cc: stable@vger.kernel.org
Fixes: 88046b2c9f6d ("mt76: add support for reporting tx status with skb")
Signed-off-by: Stanislaw Gruszka
Acked-by: Felix Fietkau
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit edc94cb2c13b06d9f72eda5dd96fecbe3973ad96
Author: Tadeusz Struk
Date: Wed Mar 27 11:32:38 2019 -0700
tpm: fix an invalid condition in tpm\_common\_poll
[ Upstream commit 7110629263469b4664d00b38ef80a656eddf3637 ]
The poll condition should only check response\_length,
because reads should only be issued if there is data to read.
The response\_read flag only prevents double writes.
The problem was that the write set the response\_read to false,
enqued a tpm job, and returned. Then application called poll
which checked the response\_read flag and returned EPOLLIN.
Then the application called read, but got nothing.
After all that the async\_work kicked in.
Added also mutex\_lock around the poll check to prevent
other possible race conditions.
Fixes: 9488585b21bef0df12 ("tpm: add support for partial reads")
Reported-by: Mantas Mikulėnas
Tested-by: Mantas Mikulėnas
Signed-off-by: Tadeusz Struk
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
commit 6799f32fff632c0659d4385edcf8f4ce883bc5fc
Author: Phil Auld
Date: Tue Apr 23 19:51:06 2019 -0400
sched/fair: Limit sched\_cfs\_period\_timer() loop to avoid hard lockup
[ Upstream commit 2e8e19226398db8265a8e675fcc0118b9e80c9e8 ]
With extremely short cfs\_period\_us setting on a parent task group with a large
number of children the for loop in sched\_cfs\_period\_timer() can run until the
watchdog fires. There is no guarantee that the call to hrtimer\_forward\_now()
will ever return 0. The large number of children can make
do\_sched\_cfs\_period\_timer() take longer than the period.
NMI watchdog: Watchdog detected hard LOCKUP on cpu 24
RIP: 0010:tg\_nop+0x0/0x10
walk\_tg\_tree\_from+0x29/0xb0
unthrottle\_cfs\_rq+0xe0/0x1a0
distribute\_cfs\_runtime+0xd3/0xf0
sched\_cfs\_period\_timer+0xcb/0x160
? sched\_cfs\_slack\_timer+0xd0/0xd0
\_\_hrtimer\_run\_queues+0xfb/0x270
hrtimer\_interrupt+0x122/0x270
smp\_apic\_timer\_interrupt+0x6a/0x140
apic\_timer\_interrupt+0xf/0x20

To prevent this we add protection to the loop that detects when the loop has run
too many times and scales the period and quota up, proportionally, so that the timer
can complete before then next period expires. This preserves the relative runtime
quota while preventing the hard lockup.
A warning is issued reporting this state and the new values.
Signed-off-by: Phil Auld
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Anton Blanchard
Cc: Ben Segall
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: https://lkml.kernel.org/r/20190319130005.25492-1-pauld@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit fb9693679feb5e3fa9c983ec35dfa068a9ad83af
Author: Matthias Kaehlcke
Date: Tue Apr 23 12:04:26 2019 -0700
Revert "kbuild: use -Oz instead of -Os when using clang"
commit a75bb4eb9e565b9f5115e2e8c07377ce32cbe69a upstream.
The clang option -Oz enables \*aggressive\* optimization for size,
which doesn't necessarily result in smaller images, but can have
negative impact on performance. Switch back to the less aggressive
-Os.
This reverts commit 6748cb3c299de1ffbe56733647b01dbcc398c419.
Suggested-by: Peter Zijlstra
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Nick Desaulniers
Signed-off-by: Masahiro Yamada
Signed-off-by: Nathan Chancellor
Signed-off-by: Sasha Levin
commit 18636692a1b49f0c0ebf623ad29b65514886c59c
Author: Yue Haibing
Date: Tue Apr 23 16:05:18 2019 +0300
tpm: Fix the type of the return value in calc\_tpm2\_event\_size()
commit b9d0a85d6b2e76630cfd4c475ee3af4109bfd87a upstream
calc\_tpm2\_event\_size() has an invalid signature because
it returns a 'size\_t' where as its signature says that
it returns 'int'.
Cc:
Fixes: 4d23cc323cdb ("tpm: add securityfs support for TPM 2.0 firmware event log")
Suggested-by: Jarkko Sakkinen
Signed-off-by: Yue Haibing
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
commit 03c1d8f8afd8e59b67566d39416db8b0bc66668f
Author: Jarkko Sakkinen
Date: Fri Feb 8 18:30:59 2019 +0200
tpm/tpm\_i2c\_atmel: Return -E2BIG when the transfer is incomplete
[ Upstream commit 442601e87a4769a8daba4976ec3afa5222ca211d ]
Return -E2BIG when the transfer is incomplete. The upper layer does
not retry, so not doing that is incorrect behaviour.
Cc: stable@vger.kernel.org
Fixes: a2871c62e186 ("tpm: Add support for Atmel I2C TPMs")
Signed-off-by: Jarkko Sakkinen
Reviewed-by: Stefan Berger
Reviewed-by: Jerry Snitselaar
Signed-off-by: Sasha Levin
commit 4a96e63f8f7dcfc3aaae2414e7fec63aee6ab5db
Author: Dan Williams
Date: Mon Apr 22 16:08:26 2019 -0700
nfit/ars: Avoid stale ARS results
commit 78153dd45e7e0596ba32b15d02bda08e1513111e upstream.
Gate ARS result consumption on whether the OS issued start-ARS since the
previous consumption. The BIOS may only clear its result buffers after a
successful start-ARS.
Fixes: 0caeef63e6d2 ("libnvdimm: Add a poison list and export badblocks")
Cc:
Reported-by: Krzysztof Rusocki
Reported-by: Vishal Verma
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 33dcadf02c1fa08b2e247be4b0a9e5ffd3c931df
Author: Dan Williams
Date: Mon Apr 22 16:08:21 2019 -0700
nfit/ars: Allow root to busy-poll the ARS state machine
commit 5479b2757f26fe9908fc341d105b2097fe820b6f upstream.
The ARS implementation implements exponential back-off on the poll
interval to prevent high-frequency access to the DIMM / platform
interface. Depending on when the ARS completes the poll interval may
exceed the completion event by minutes. Allow root to reset the timeout
each time it probes the status. A one-second timeout is still enforced,
but root can otherwise can control the poll interval.
Fixes: bc6ba8085842 ("nfit, address-range-scrub: rework and simplify ARS...")
Cc:
Reported-by: Erwin Tsaur
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit b49a9157c3ec867af424fde0c475eb2904492daa
Author: Dan Williams
Date: Mon Apr 22 16:08:16 2019 -0700
nfit/ars: Introduce scrub\_flags
commit e34b8252a3d2893ca55c82dbfcdaa302fa03d400 upstream.
In preparation for introducing new flags to gate whether ARS results are
stale, or poll the completion state, convert the existing flags to an
unsigned long with enumerated values. This conversion allows the flags
to be atomically updated outside of ->init\_mutex.
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 2cc8e8c230e8cb047e94abaa59dd722e4c900792
Author: Dan Williams
Date: Mon Apr 22 16:08:10 2019 -0700
nfit/ars: Remove ars\_start\_flags
commit 317a992ab9266b86b774b9f6b0f87eb4f59879a1 upstream.
The ars\_start\_flags property of 'struct acpi\_nfit\_desc' is no longer
used since ARS\_REQ\_SHORT and ARS\_REQ\_LONG were added.
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 451fd88f62b9e1a684d6e6503425ee0610d755a0
Author: Chang-An Chen
Date: Fri Mar 29 10:59:09 2019 +0800
timers/sched\_clock: Prevent generic sched\_clock wrap caused by tick\_freeze()
commit 3f2552f7e9c5abef2775c53f7af66532f8bf65bc upstream.
tick\_freeze() introduced by suspend-to-idle in commit 124cf9117c5f ("PM /
sleep: Make it possible to quiesce timers during suspend-to-idle") uses
timekeeping\_suspend() instead of syscore\_suspend() during
suspend-to-idle. As a consequence generic sched\_clock will keep going
because sched\_clock\_suspend() and sched\_clock\_resume() are not invoked
during suspend-to-idle which can result in a generic sched\_clock wrap.
On a ARM system with suspend-to-idle enabled, sched\_clock is registered
as "56 bits at 13MHz, resolution 76ns, wraps every 4398046511101ns", which
means the real wrapping duration is 8796093022202ns.
[ 134.551779] suspend-to-idle suspend (timekeeping\_suspend())
[ 1204.912239] suspend-to-idle resume (timekeeping\_resume())
......
[ 1206.912239] suspend-to-idle suspend (timekeeping\_suspend())
[ 5880.502807] suspend-to-idle resume (timekeeping\_resume())
......
[ 6000.403724] suspend-to-idle suspend (timekeeping\_suspend())
[ 8035.753167] suspend-to-idle resume (timekeeping\_resume())
......
[ 8795.786684] (2)[321:charger\_thread]......
[ 8795.788387] (2)[321:charger\_thread]......
[ 0.057226] (0)[0:swapper/0]......
[ 0.061447] (2)[0:swapper/2]......
sched\_clock was not stopped during suspend-to-idle, and sched\_clock\_poll
hrtimer was not expired because timekeeping\_suspend() was invoked during
suspend-to-idle. It makes sched\_clock wrap at kernel time 8796s.
To prevent this, invoke sched\_clock\_suspend() and sched\_clock\_resume() in
tick\_freeze() together with timekeeping\_suspend() and timekeeping\_resume().
Fixes: 124cf9117c5f (PM / sleep: Make it possible to quiesce timers during suspend-to-idle)
Signed-off-by: Chang-An Chen
Signed-off-by: Thomas Gleixner
Cc: Frederic Weisbecker
Cc: Matthias Brugger
Cc: John Stultz
Cc: Kees Cook
Cc: Corey Minyard
Cc:
Cc:
Cc: Stanley Chu
Cc:
Cc:
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/1553828349-8914-1-git-send-email-chang-an.chen@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit 205c53cbe553c9e5a9fe93f63e398da7e59124b6
Author: Thomas Gleixner
Date: Sun Apr 14 19:51:06 2019 +0200
x86/speculation: Prevent deadlock on ssb\_state::lock
commit 2f5fb19341883bb6e37da351bc3700489d8506a7 upstream.
Mikhail reported a lockdep splat related to the AMD specific ssb\_state
lock:
CPU0 CPU1
lock(&st->lock);
local\_irq\_disable();
lock(&(&sighand->siglock)->rlock);
lock(&st->lock);
lock(&(&sighand->siglock)->rlock);
\*\*\* DEADLOCK \*\*\*
The connection between sighand->siglock and st->lock comes through seccomp,
which takes st->lock while holding sighand->siglock.
Make sure interrupts are disabled when \_\_speculation\_ctrl\_update() is
invoked via prctl() -> speculation\_ctrl\_update(). Add a lockdep assert to
catch future offenders.
Fixes: 1f50ddb4f418 ("x86/speculation: Handle HT correctly on AMD")
Reported-by: Mikhail Gavrilov
Signed-off-by: Thomas Gleixner
Tested-by: Mikhail Gavrilov
Cc: Thomas Lendacky
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/alpine.DEB.2.21.1904141948200.4917@nanos.tec.linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 19867049334b6cb5eb5d2c84c84b2a863cea886f
Author: Kan Liang
Date: Tue Apr 2 12:44:58 2019 -0700
perf/x86: Fix incorrect PEBS\_REGS
commit 9d5dcc93a6ddfc78124f006ccd3637ce070ef2fc upstream.
PEBS\_REGS used as mask for the supported registers for large PEBS.
However, the mask cannot filter the sample\_regs\_user/sample\_regs\_intr
correctly.
(1ULL << PERF\_REG\_X86\_\*) should be used to replace PERF\_REG\_X86\_\*, which
is only the index.
Rename PEBS\_REGS to PEBS\_GP\_REGS, because the mask is only for general
purpose registers.
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Cc: acme@kernel.org
Cc: jolsa@kernel.org
Fixes: 2fe1bc1f501d ("perf/x86: Enable free running PEBS for REGS\_USER/INTR")
Link: https://lkml.kernel.org/r/20190402194509.2832-2-kan.liang@linux.intel.com
[ Renamed it to PEBS\_GP\_REGS - as 'GPRS' is used elsewhere ;-) ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 5e34d62b59ddcba0de3835f44406a9d5bfc0a8fc
Author: Andi Kleen
Date: Fri Mar 29 17:47:43 2019 -0700
x86/cpu/bugs: Use \_\_initconst for 'const' init data
commit 1de7edbb59c8f1b46071f66c5c97b8a59569eb51 upstream.
Some of the recently added const tables use \_\_initdata which causes section
attribute conflicts.
Use \_\_initconst instead.
Fixes: fa1202ef2243 ("x86/speculation: Add command line control")
Signed-off-by: Andi Kleen
Signed-off-by: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20190330004743.29541-9-andi@firstfloor.org
Signed-off-by: Greg Kroah-Hartman
commit 35f288b72f64451461d38f46499061ed46878e37
Author: Kim Phillips
Date: Thu Mar 21 21:15:22 2019 +0000
perf/x86/amd: Add event map for AMD Family 17h
commit 3fe3331bb285700ab2253dbb07f8e478fcea2f1b upstream.
Family 17h differs from prior families by:
- Does not support an L2 cache miss event
- It has re-enumerated PMC counters for:
- L2 cache references
- front & back end stalled cycles
So we add a new amd\_f17h\_perfmon\_event\_map[] so that the generic
perf event names will resolve to the correct h/w events on
family 17h and above processors.
Reference sections 2.1.13.3.3 (stalls) and 2.1.13.3.6 (L2):
https://www.amd.com/system/files/TechDocs/54945\_PPR\_Family\_17h\_Models\_00h-0Fh.pdf
Signed-off-by: Kim Phillips
Cc:  # v4.9+
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: H. Peter Anvin
Cc: Janakarajan Natarajan
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Martin Liška
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Pu Wen
Cc: Suravee Suthikulpanit
Cc: Thomas Gleixner
Cc: linux-kernel@vger.kernel.org
Fixes: e40ed1542dd7 ("perf/x86: Add perf support for AMD family-17h processors")
[ Improved the formatting a bit. ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 22cc6e1b4fc0ac31b8a18189a06c6630e0e1af76
Author: Alex Deucher
Date: Thu Apr 11 14:54:40 2019 -0500
drm/amdgpu/gmc9: fix VM\_L2\_CNTL3 programming
commit 1925e7d3d4677e681cc2e878c2bdbeaee988c8e2 upstream.
Got accidently dropped when 2+1 level support was added.
Fixes: 6a42fd6fbf534096 ("drm/amdgpu: implement 2+1 PD support for Raven v3")
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 5b05d7d6fd5b0a15fd143137561b53ed9f80b4d1
Author: Joe Perches
Date: Thu Mar 7 15:51:45 2019 -0800
s390/mem\_detect: Use IS\_ENABLED(CONFIG\_BLK\_DEV\_INITRD)
commit 2d4ea4b95cae3133de6b18ec5d5a42ee824fa0ef upstream.
IS\_ENABLED should generally use CONFIG\_ prefaced symbols and
it doesn't appear as if there is a BLK\_DEV\_INITRD define.
Cc:  # 4.20
Signed-off-by: Joe Perches
Signed-off-by: Martin Schwidefsky
Signed-off-by: Greg Kroah-Hartman
commit b1db090fb04676a1c51accf3df76f9105a6e17e0
Author: Felix Fietkau
Date: Fri Mar 1 14:48:37 2019 +0100
mac80211: do not call driver wake\_tx\_queue op during reconfig
commit 4856bfd230985e43e84c26473c91028ff0a533bd upstream.
There are several scenarios in which mac80211 can call drv\_wake\_tx\_queue
after ieee80211\_restart\_hw has been called and has not yet completed.
Driver private structs are considered uninitialized until mac80211 has
uploaded the vifs, stations and keys again, so using private tx queue
data during that time is not safe.
The driver can also not rely on drv\_reconfig\_complete to figure out when
it is safe to accept drv\_wake\_tx\_queue calls again, because it is only
called after all tx queues are woken again.
To fix this, bail out early in drv\_wake\_tx\_queue if local->in\_reconfig
is set.
Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 9a0748c5518877db31c30e986edf976eca141ab6
Author: Vijayakumar Durai
Date: Wed Mar 27 11:03:17 2019 +0100
rt2x00: do not increment sequence number while re-transmitting
commit 746ba11f170603bf1eaade817553a6c2e9135bbe upstream.
Currently rt2x00 devices retransmit the management frames with
incremented sequence number if hardware is assigning the sequence.
This is HW bug fixed already for non-QOS data frames, but it should
be fixed for management frames except beacon.
Without fix retransmitted frames have wrong SN:
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1648, FN=0, Flags=........C Frame is not being retransmitted 1648 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1649, FN=0, Flags=....R...C Frame is being retransmitted 1649 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1650, FN=0, Flags=....R...C Frame is being retransmitted 1650 1
With the fix SN stays correctly the same:
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=........C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
Cc: stable@vger.kernel.org
Signed-off-by: Vijayakumar Durai
[sgruszka: simplify code, change comments and changelog]
Signed-off-by: Stanislaw Gruszka
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 44aa331f99b4ee0cc0713c907113109b6936e8ce
Author: Masami Hiramatsu
Date: Mon Apr 15 15:01:25 2019 +0900
kprobes: Fix error check when reusing optimized probes
commit 5f843ed415581cfad4ef8fefe31c138a8346ca8a upstream.
The following commit introduced a bug in one of our error paths:
819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
it missed to handle the return value of kprobe\_optready() as
error-value. In reality, the kprobe\_optready() returns a bool
result, so "true" case must be passed instead of 0.
This causes some errors on kprobe boot-time selftests on ARM:
[ ] Beginning kprobe tests...
[ ] Probe ARM code
[ ] kprobe
[ ] kretprobe
[ ] ARM instruction simulation
[ ] Check decoding tables
[ ] Run test cases
[ ] FAIL: test\_case\_handler not run
[ ] FAIL: Test andge r10, r11, r14, asr r7
[ ] FAIL: Scenario 11
...
[ ] FAIL: Scenario 7
[ ] Total instruction simulation tests=1631, pass=1433 fail=198
[ ] kprobe tests failed
This can happen if an optimized probe is unregistered and next
kprobe is registered on same address until the previous probe
is not reclaimed.
If this happens, a hidden aggregated probe may be kept in memory,
and no new kprobe can probe same address. Also, in that case
register\_kprobe() will return "1" instead of minus error value,
which can mislead caller logic.
Signed-off-by: Masami Hiramatsu
Cc: Anil S Keshavamurthy
Cc: David S . Miller
Cc: Linus Torvalds
Cc: Naveen N . Rao
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org # v5.0+
Fixes: 819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
Link: http://lkml.kernel.org/r/155530808559.32517.539898325433642204.stgit@devnote2
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit ca61e51567a7bb1de157ad0964b35e1673296f59
Author: Masami Hiramatsu
Date: Sun Feb 24 01:50:49 2019 +0900
x86/kprobes: Avoid kretprobe recursion bug
commit b191fa96ea6dc00d331dcc28c1f7db5e075693a0 upstream.
Avoid kretprobe recursion loop bg by setting a dummy
kprobes to current\_kprobe per-CPU variable.
This bug has been introduced with the asm-coded trampoline
code, since previously it used another kprobe for hooking
the function return placeholder (which only has a nop) and
trampoline handler was called from that kprobe.
This revives the old lost kprobe again.
With this fix, we don't see deadlock anymore.
And you can see that all inner-called kretprobe are skipped.
event\_1 235 0
event\_2 19375 19612
The 1st column is recorded count and the 2nd is missed count.
Above shows (event\_1 rec) + (event\_2 rec) ~= (event\_2 missed)
(some difference are here because the counter is racy)
Reported-by: Andrea Righi
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Fixes: c9becf58d935 ("[PATCH] kretprobe: kretprobe-booster")
Link: http://lkml.kernel.org/r/155094064889.6137.972160690963039.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 7b91f26c45b65ca77ad0e4ac1b5832c75f274ac6
Author: Masami Hiramatsu
Date: Sun Feb 24 01:50:20 2019 +0900
kprobes: Mark ftrace mcount handler functions nokprobe
commit fabe38ab6b2bd9418350284c63825f13b8a6abba upstream.
Mark ftrace mcount handler functions nokprobe since
probing on these functions with kretprobe pushes
return address incorrectly on kretprobe shadow stack.
Reported-by: Francis Deslauriers
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Acked-by: Steven Rostedt (VMware)
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094062044.6137.6419622920568680640.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit fbe6f067a3adf64e749c27832f7f6f7a6e07b988
Author: Masami Hiramatsu
Date: Sun Feb 24 01:49:52 2019 +0900
x86/kprobes: Verify stack frame on kretprobe
commit 3ff9c075cc767b3060bdac12da72fc94dd7da1b8 upstream.
Verify the stack frame pointer on kretprobe trampoline handler,
If the stack frame pointer does not match, it skips the wrong
entry and tries to find correct one.
This can happen if user puts the kretprobe on the function
which can be used in the path of ftrace user-function call.
Such functions should not be probed, so this adds a warning
message that reports which function should be blacklisted.
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094059185.6137.15527904013362842072.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit f89f9d9636f04158d31cb7cce73467a844daf0d7
Author: Nathan Chancellor
Date: Wed Apr 17 00:21:21 2019 -0700
arm64: futex: Restore oldval initialization to work around buggy compilers
commit ff8acf929014b7f87315588e0daf8597c8aa9d1c upstream.
Commit 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with
non-zero result value") removed oldval's zero initialization in
arch\_futex\_atomic\_op\_inuser because it is not necessary. Unfortunately,
Android's arm64 GCC 4.9.4 [1] does not agree:
../kernel/futex.c: In function 'do\_futex':
../kernel/futex.c:1658:17: warning: 'oldval' may be used uninitialized
in this function [-Wmaybe-uninitialized]
return oldval == cmparg;
^
In file included from ../kernel/futex.c:73:0:
../arch/arm64/include/asm/futex.h:53:6: note: 'oldval' was declared here
int oldval, ret, tmp;
^
GCC fails to follow that when ret is non-zero, futex\_atomic\_op\_inuser
returns right away, avoiding the uninitialized use that it claims.
Restoring the zero initialization works around this issue.
[1]: https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/
Cc: stable@vger.kernel.org
Fixes: 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with non-zero result value")
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Nathan Chancellor
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 508b773175c71c16f81bbaf6bc9e9be059ad545c
Author: Christian König
Date: Tue Apr 2 09:26:52 2019 +0200
drm/ttm: fix out-of-bounds read in ttm\_put\_pages() v2
commit a66477b0efe511d98dde3e4aaeb189790e6f0a39 upstream.
When ttm\_put\_pages() tries to figure out whether it's dealing with
transparent hugepages, it just reads past the bounds of the pages array
without a check.
v2: simplify the test if enough pages are left in the array (Christian).
Signed-off-by: Jann Horn
Signed-off-by: Christian König
Fixes: 5c42c64f7d54 ("drm/ttm: fix the fix for huge compound pages")
Cc: stable@vger.kernel.org
Reviewed-by: Michel Dänzer
Reviewed-by: Junwei Zhang
Reviewed-by: Huang Rui
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 8223263d7c44251e984ba982e02fc2cbb6704d3d
Author: Eric Biggers
Date: Sun Mar 31 13:04:11 2019 -0700
crypto: x86/poly1305 - fix overflow during partial reduction
commit 678cce4019d746da6c680c48ba9e6d417803e127 upstream.
The x86\_64 implementation of Poly1305 produces the wrong result on some
inputs because poly1305\_4block\_avx2() incorrectly assumes that when
partially reducing the accumulator, the bits carried from limb 'd4' to
limb 'h0' fit in a 32-bit integer. This is true for poly1305-generic
which processes only one block at a time. However, it's not true for
the AVX2 implementation, which processes 4 blocks at a time and
therefore can produce intermediate limbs about 4x larger.
Fix it by making the relevant calculations use 64-bit arithmetic rather
than 32-bit. Note that most of the carries already used 64-bit
arithmetic, but the d4 -> h0 carry was different for some reason.
To be safe I also made the same change to the corresponding SSE2 code,
though that only operates on 1 or 2 blocks at a time. I don't think
it's really needed for poly1305\_block\_sse2(), but it doesn't hurt
because it's already x86\_64 code. It \*might\* be needed for
poly1305\_2block\_sse2(), but overflows aren't easy to reproduce there.
This bug was originally detected by my patches that improve testmgr to
fuzz algorithms against their generic implementation. But also add a
test vector which reproduces it directly (in the AVX2 case).
Fixes: b1ccc8f4b631 ("crypto: poly1305 - Add a four block AVX2 variant for x86\_64")
Fixes: c70f4abef07a ("crypto: poly1305 - Add a SSE2 SIMD variant for x86\_64")
Cc:  # v4.3+
Cc: Martin Willi
Cc: Jason A. Donenfeld
Signed-off-by: Eric Biggers
Reviewed-by: Martin Willi
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 46c4f2375638122a08b7ab8af5bc19bec74d28b4
Author: Corey Minyard
Date: Wed Apr 3 15:58:16 2019 -0500
ipmi: fix sleep-in-atomic in free\_user at cleanup SRCU user->release\_barrier
commit 3b9a907223d7f6b9d1dadea29436842ae9bcd76d upstream.
free\_user() could be called in atomic context.
This patch pushed the free operation off into a workqueue.
Example:
BUG: sleeping function called from invalid context at kernel/workqueue.c:2856
in\_atomic(): 1, irqs\_disabled(): 0, pid: 177, name: ksoftirqd/27
CPU: 27 PID: 177 Comm: ksoftirqd/27 Not tainted 4.19.25-3 #1
Hardware name: AIC 1S-HV26-08/MB-DPSB04-06, BIOS IVYBV060 10/21/2015
Call Trace:
dump\_stack+0x5c/0x7b
\_\_\_might\_sleep+0xec/0x110
\_\_flush\_work+0x48/0x1f0
? try\_to\_del\_timer\_sync+0x4d/0x80
\_cleanup\_srcu\_struct+0x104/0x140
free\_user+0x18/0x30 [ipmi\_msghandler]
ipmi\_free\_recv\_msg+0x3a/0x50 [ipmi\_msghandler]
deliver\_response+0xbd/0xd0 [ipmi\_msghandler]
deliver\_local\_response+0xe/0x30 [ipmi\_msghandler]
handle\_one\_recv\_msg+0x163/0xc80 [ipmi\_msghandler]
? dequeue\_entity+0xa0/0x960
handle\_new\_recv\_msgs+0x15c/0x1f0 [ipmi\_msghandler]
tasklet\_action\_common.isra.22+0x103/0x120
\_\_do\_softirq+0xf8/0x2d7
run\_ksoftirqd+0x26/0x50
smpboot\_thread\_fn+0x11d/0x1e0
kthread+0x103/0x140
? sort\_range+0x20/0x20
? kthread\_destroy\_worker+0x40/0x40
ret\_from\_fork+0x1f/0x40
Fixes: 77f8269606bf ("ipmi: fix use-after-free of user->release\_barrier.rda")
Reported-by: Konstantin Khlebnikov
Signed-off-by: Corey Minyard
Cc: stable@vger.kernel.org # 5.0
Cc: Yang Yingliang
Signed-off-by: Greg Kroah-Hartman
commit 2f6919fdc23bc27d7170f1b2d46ebfc658f60217
Author: WANG Chao
Date: Fri Apr 12 15:55:39 2019 +0800
x86/kvm: move kvm\_load/put\_guest\_xcr0 into atomic context
commit 1811d979c71621aafc7b879477202d286f7e863b upstream.
guest xcr0 could leak into host when MCE happens in guest mode. Because
do\_machine\_check() could schedule out at a few places.
For example:
kvm\_load\_guest\_xcr0
...
kvm\_x86\_ops->run(vcpu) {
vmx\_vcpu\_run
vmx\_complete\_atomic\_exit
kvm\_machine\_check
do\_machine\_check
do\_memory\_failure
memory\_failure
lock\_page
In this case, host\_xcr0 is 0x2ff, guest vcpu xcr0 is 0xff. After schedule
out, host cpu has guest xcr0 loaded (0xff).
In \_\_switch\_to {
switch\_fpu\_finish
copy\_kernel\_to\_fpregs
XRSTORS
If any bit i in XSTATE\_BV[i] == 1 and xcr0[i] == 0, XRSTORS will
generate #GP (In this case, bit 9). Then ex\_handler\_fprestore kicks in
and tries to reinitialize fpu by restoring init fpu state. Same story as
last #GP, except we get DOUBLE FAULT this time.
Cc: stable@vger.kernel.org
Signed-off-by: WANG Chao
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 1eb719f09f7e319e79f6abf2b9e8c0dcc1c477b5
Author: Andrea Arcangeli
Date: Thu Apr 18 17:50:52 2019 -0700
coredump: fix race condition between mmget\_not\_zero()/get\_task\_mm() and core dumping
commit 04f5866e41fb70690e28397487d8bd8eea7d712a upstream.
The core dumping code has always run without holding the mmap\_sem for
writing, despite that is the only way to ensure that the entire vma
layout will not change from under it. Only using some signal
serialization on the processes belonging to the mm is not nearly enough.
This was pointed out earlier. For example in Hugh's post from Jul 2017:
https://lkml.kernel.org/r/alpine.LSU.2.11.1707191716030.2055@eggly.anvils
"Not strictly relevant here, but a related note: I was very surprised
to discover, only quite recently, how handle\_mm\_fault() may be called
without down\_read(mmap\_sem) - when core dumping. That seems a
misguided optimization to me, which would also be nice to correct"
In particular because the growsdown and growsup can move the
vm\_start/vm\_end the various loops the core dump does around the vma will
not be consistent if page faults can happen concurrently.
Pretty much all users calling mmget\_not\_zero()/get\_task\_mm() and then
taking the mmap\_sem had the potential to introduce unexpected side
effects in the core dumping code.
Adding mmap\_sem for writing around the ->core\_dump invocation is a
viable long term fix, but it requires removing all copy user and page
faults and to replace them with get\_dump\_page() for all binary formats
which is not suitable as a short term fix.
For the time being this solution manually covers the places that can
confuse the core dump either by altering the vma layout or the vma flags
while it runs. Once ->core\_dump runs under mmap\_sem for writing the
function mmget\_still\_valid() can be dropped.
Allowing mmap\_sem protected sections to run in parallel with the
coredump provides some minor parallelism advantage to the swapoff code
(which seems to be safe enough by never mangling any vma field and can
keep doing swapins in parallel to the core dumping) and to some other
corner case.
In order to facilitate the backporting I added "Fixes: 86039bd3b4e6"
however the side effect of this same race condition in /proc/pid/mem
should be reproducible since before 2.6.12-rc2 so I couldn't add any
other "Fixes:" because there's no hash beyond the git genesis commit.
Because find\_extend\_vma() is the only location outside of the process
context that could modify the "mm" structures under mmap\_sem for
reading, by adding the mmget\_still\_valid() check to it, all other cases
that take the mmap\_sem for reading don't need the new check after
mmget\_not\_zero()/get\_task\_mm(). The expand\_stack() in page fault
context also doesn't need the new check, because all tasks under core
dumping are frozen.
Link: http://lkml.kernel.org/r/20190325224949.11068-1-aarcange@redhat.com
Fixes: 86039bd3b4e6 ("userfaultfd: add new syscall to provide memory externalization")
Signed-off-by: Andrea Arcangeli
Reported-by: Jann Horn
Suggested-by: Oleg Nesterov
Acked-by: Peter Xu
Reviewed-by: Mike Rapoport
Reviewed-by: Oleg Nesterov
Reviewed-by: Jann Horn
Acked-by: Jason Gunthorpe
Acked-by: Michal Hocko
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit e58a114d07465baef1e7476242a44cbb9d108825
Author: Suthikulpanit, Suravee
Date: Wed Mar 20 08:12:28 2019 +0000
Revert "svm: Fix AVIC incomplete IPI emulation"
commit 4a58038b9e420276157785afa0a0bbb4b9bc2265 upstream.
This reverts commit bb218fbcfaaa3b115d4cd7a43c0ca164f3a96e57.
As Oren Twaig pointed out the old discussion:
https://patchwork.kernel.org/patch/8292231/
that the change coud potentially cause an extra IPI to be sent to
the destination vcpu because the AVIC hardware already set the IRR bit
before the incomplete IPI #VMEXIT with id=1 (target vcpu is not running).
Since writting to ICR and ICR2 will also set the IRR. If something triggers
the destination vcpu to get scheduled before the emulation finishes, then
this could result in an additional IPI.
Also, the issue mentioned in the commit bb218fbcfaaa was misdiagnosed.
Cc: Radim Krčmář
Cc: Paolo Bonzini
Reported-by: Oren Twaig
Signed-off-by: Suravee Suthikulpanit
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 922270b4f0182c0f00284881b2e4eb98a76d1232
Author: Vitor Soares
Date: Tue Apr 9 18:59:59 2019 +0200
i3c: Fix the verification of random PID
commit 9752c37cc89f43675e70cf9acff23519fa84b48c upstream.
The validation of random PID should be done by checking the
boardinfo->pid instead of info.pid which is empty.
Doing the change the info struture declaration is no longer necessary.
Cc: Boris Brezillon
Cc:
Fixes: 3a379bbcea0a ("i3c: Add core I3C infrastructure")
Signed-off-by: Vitor Soares
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit 33a3fff44a0f926269d46eef3e5547bf54fe77e7
Author: Vitor Soares
Date: Mon Apr 8 13:13:34 2019 +0200
i3c: dw: Fix dw\_i3c\_master\_disable controller by using correct mask
commit 907621e94d49b85cd76f13110eceb940a182c69e upstream.
The controller was being disabled incorrectly. The correct way is to clear
the DEV\_CTRL\_ENABLE bit.
Fix this by clearing this bit.
Cc: Boris Brezillon
Cc:
Fixes: 1dd728f5d4d4 ("i3c: master: Add driver for Synopsys DesignWare IP")
Signed-off-by: Vitor Soares
Signed-off-by: Boris Brezillon
Signed-off-by: Greg Kroah-Hartman
commit e6200707e648c7d82c6dc45879d20502fc901d65
Author: Saurav Kashyap
Date: Thu Apr 18 03:40:12 2019 -0700
Revert "scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO"
commit 0228034d8e5915b98c33db35a98f5e909e848ae9 upstream.
This patch clears FC\_RP\_STARTED flag during logoff, because of this
re-login(flogi) didn't happen to the switch.
This reverts commit 1550ec458e0cf1a40a170ab1f4c46e3f52860f65.
Fixes: 1550ec458e0c ("scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO")
Cc:  # v4.18+
Signed-off-by: Saurav Kashyap
Reviewed-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit ad1deea5c4c93c75b8f90bb0cef9f94d3760ea84
Author: Jaesoo Lee
Date: Tue Apr 9 17:02:22 2019 -0700
scsi: core: set result when the command cannot be dispatched
commit be549d49115422f846b6d96ee8fd7173a5f7ceb0 upstream.
When SCSI blk-mq is enabled, there is a bug in handling errors in
scsi\_queue\_rq. Specifically, the bug is not setting result field of
scsi\_request correctly when the dispatch of the command has been
failed. Since the upper layer code including the sg\_io ioctl expects to
receive any error status from result field of scsi\_request, the error is
silently ignored and this could cause data corruptions for some
applications.
Fixes: d285203cf647 ("scsi: add support for a blk-mq based I/O path.")
Cc:
Signed-off-by: Jaesoo Lee
Reviewed-by: Hannes Reinecke
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit c2116717884cf9ec6841630ea257d5c5c3a859c7
Author: Mikulas Patocka
Date: Thu Apr 4 20:53:28 2019 -0400
vt: fix cursor when clearing the screen
commit b2ecf00631362a83744e5ec249947620db5e240c upstream.
The patch a6dbe4427559 ("vt: perform safe console erase in the right
order") introduced a bug. The conditional do\_update\_region() was
replaced by a call to update\_region() that does contain the conditional
already, but with unwanted extra side effects such as restoring the cursor
drawing.
In order to reproduce the bug:
- use framebuffer console with the AMDGPU driver
- type "links" to start the console www browser
- press 'q' and space to exit links
Now the cursor will be permanently visible in the center of the
screen. It will stay there until something overwrites it.
The bug goes away if we change update\_region() back to the conditional
do\_update\_region().
[ nico: reworded changelog ]
Signed-off-by: Mikulas Patocka
Reviewed-by: Nicolas Pitre
Cc: stable@vger.kernel.org
Fixes: a6dbe4427559 ("vt: perform safe console erase in the right order")
Signed-off-by: Greg Kroah-Hartman
commit 5ae77c340c52b331e18af1a358ba7b2e3dcc3390
Author: Geert Uytterhoeven
Date: Mon Apr 1 13:25:10 2019 +0200
serial: sh-sci: Fix HSCIF RX sampling point calculation
commit ace965696da2611af759f0284e26342b7b6cec89 upstream.
There are several issues with the formula used for calculating the
deviation from the intended rate:
1. While min\_err and last\_stop are signed, srr and baud are unsigned.
Hence the signed values are promoted to unsigned, which will lead
to a bogus value of deviation if min\_err is negative,
2. Srr is the register field value, which is one less than the actual
sampling rate factor,
3. The divisions do not use rounding.
Fix this by casting unsigned variables to int, adding one to srr, and
using a single DIV\_ROUND\_CLOSEST().
Fixes: 63ba1e00f178a448 ("serial: sh-sci: Support for HSCIF RX sampling point adjustment")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Mukesh Ojha
Cc: stable
Reviewed-by: Ulrich Hecht
Signed-off-by: Greg Kroah-Hartman
commit 333a81c16e4f6aa87dce0ca8e1df0bbca787d472
Author: Geert Uytterhoeven
Date: Fri Mar 29 10:10:26 2019 +0100
serial: sh-sci: Fix HSCIF RX sampling point adjustment
commit 6b87784b53592a90d21576be8eff688b56d93cce upstream.
The calculation of the sampling point has min() and max() exchanged.
Fix this by using the clamp() helper instead.
Fixes: 63ba1e00f178a448 ("serial: sh-sci: Support for HSCIF RX sampling point adjustment")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Ulrich Hecht
Reviewed-by: Wolfram Sang
Acked-by: Dirk Behme
Cc: stable
Reviewed-by: Simon Horman
Signed-off-by: Greg Kroah-Hartman
commit 95df599f95f398b0a34d081dadfdee3126e58163
Author: KT Liao
Date: Tue Mar 26 17:28:32 2019 -0700
Input: elan\_i2c - add hardware ID for multiple Lenovo laptops
commit 738c06d0e4562e0acf9f2c7438a22b2d5afc67aa upstream.
There are many Lenovo laptops which need elan\_i2c support, this patch adds
relevant IDs to the Elan driver so that touchpads are recognized.
Signed-off-by: KT Liao
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 6ef122eb79569df65f7199c5026033250670ac85
Author: Takashi Iwai
Date: Tue Apr 16 17:06:33 2019 +0200
ALSA: core: Fix card races between register and disconnect
commit 2a3f7221acddfe1caa9ff09b3a8158c39b2fdeac upstream.
There is a small race window in the card disconnection code that
allows the registration of another card with the very same card id.
This leads to a warning in procfs creation as caught by syzkaller.
The problem is that we delete snd\_cards and snd\_cards\_lock entries at
the very beginning of the disconnection procedure. This makes the
slot available to be assigned for another card object while the
disconnection procedure is being processed. Then it becomes possible
to issue a procfs registration with the existing file name although we
check the conflict beforehand.
The fix is simply to move the snd\_cards and snd\_cards\_lock clearances
at the end of the disconnection procedure. The references to these
entries are merely either from the global proc files like
/proc/asound/cards or from the card registration / disconnection, so
it should be fine to shift at the very end.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ffd87f87a9c17b705e14b227ba6afa3248f1d7e8
Author: Hui Wang
Date: Wed Apr 17 16:10:32 2019 +0800
ALSA: hda/realtek - add two more pin configuration sets to quirk table
commit b26e36b7ef36a8a3a147b1609b2505f8a4ecf511 upstream.
We have two Dell laptops which have the codec 10ec0236 and 10ec0256
respectively, the headset mic on them can't work, need to apply the
quirk of ALC255\_FIXUP\_DELL1\_MIC\_NO\_PRESENCE. So adding their pin
configurations in the pin quirk table.
Cc:
Signed-off-by: Hui Wang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8834139083cdb486cc520d2b5fbb21bdd0e534d0
Author: Ian Abbott
Date: Mon Apr 15 12:43:02 2019 +0100
staging: comedi: ni\_usb6501: Fix possible double-free of ->usb\_rx\_buf
commit af4b54a2e5ba18259ff9aac445bf546dd60d037e upstream.
`ni6501\_alloc\_usb\_buffers()` is called from `ni6501\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `ni6501\_detach()` will be called from the core comedi
module code to clean up. `ni6501\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already beed freed, leading to a
double-free error. Fix it bu removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `ni6501\_alloc\_usb\_buffers()`, relying
on `ni6501\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 16b235e81d9d7b502fa72e579cc7796828090111
Author: Ian Abbott
Date: Mon Apr 15 12:43:01 2019 +0100
staging: comedi: ni\_usb6501: Fix use of uninitialized mutex
commit 660cf4ce9d0f3497cc7456eaa6d74c8b71d6282c upstream.
If `ni6501\_auto\_attach()` returns an error, the core comedi module code
will call `ni6501\_detach()` to clean up. If `ni6501\_auto\_attach()`
successfully allocated the comedi device private data, `ni6501\_detach()`
assumes that a `struct mutex mut` contained in the private data has been
initialized and uses it. Unfortunately, there are a couple of places
where `ni6501\_auto\_attach()` can return an error after allocating the
device private data but before initializing the mutex, so this
assumption is invalid. Fix it by initializing the mutex just after
allocating the private data in `ni6501\_auto\_attach()` before any other
errors can be retturned. Also move the call to `usb\_set\_intfdata()`
just to keep the code a bit neater (either position for the call is
fine).
I believe this was the cause of the following syzbot crash report
:
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
usb 1-1: string descriptor 0 read error: -71
comedi comedi0: Wrong number of endpoints
ni6501 1-1:0.233: driver 'ni6501' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 585 Comm: kworker/0:3 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_mutex\_lock\_common kernel/locking/mutex.c:925 [inline]
\_\_mutex\_lock+0xfe/0x12b0 kernel/locking/mutex.c:1072
ni6501\_detach+0x5b/0x110 drivers/staging/comedi/drivers/ni\_usb6501.c:567
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+cf4f2b6c24aff0a3edf6@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit a47fd7121627d66d75f401f9a610685355996330
Author: Ian Abbott
Date: Mon Apr 15 12:52:30 2019 +0100
staging: comedi: vmk80xx: Fix possible double-free of ->usb\_rx\_buf
commit 663d294b4768bfd89e529e069bffa544a830b5bf upstream.
`vmk80xx\_alloc\_usb\_buffers()` is called from `vmk80xx\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `vmk80xx\_detach()` will be called from the core comedi
module code to clean up. `vmk80xx\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already been freed, leading to a
double-free error. Fix it by removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `vmk80xx\_alloc\_usb\_buffers()`, relying
on `vmk80xx\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit bd301102144722c6fad21f8744ba481d08ca6248
Author: Ian Abbott
Date: Mon Apr 15 12:10:14 2019 +0100
staging: comedi: vmk80xx: Fix use of uninitialized semaphore
commit 08b7c2f9208f0e2a32159e4e7a4831b7adb10a3e upstream.
If `vmk80xx\_auto\_attach()` returns an error, the core comedi module code
will call `vmk80xx\_detach()` to clean up. If `vmk80xx\_auto\_attach()`
successfully allocated the comedi device private data,
`vmk80xx\_detach()` assumes that a `struct semaphore limit\_sem` contained
in the private data has been initialized and uses it. Unfortunately,
there are a couple of places where `vmk80xx\_auto\_attach()` can return an
error after allocating the device private data but before initializing
the semaphore, so this assumption is invalid. Fix it by initializing
the semaphore just after allocating the private data in
`vmk80xx\_auto\_attach()` before any other errors can be returned.
I believe this was the cause of the following syzbot crash report
:
usb 1-1: config 0 has no interface number 0
usb 1-1: New USB device found, idVendor=10cf, idProduct=8068, bcdDevice=e6.8d
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
vmk80xx 1-1:0.117: driver 'vmk80xx' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 12 Comm: kworker/0:1 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 [inline]
\_raw\_spin\_lock\_irqsave+0x44/0x60 kernel/locking/spinlock.c:152
down+0x12/0x80 kernel/locking/semaphore.c:58
vmk80xx\_detach+0x59/0x100 drivers/staging/comedi/drivers/vmk80xx.c:829
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+54c2f58f15fe6876b6ad@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit dcff1b3c1a1d2b2ec40758e26aebff4453f13c3e
Author: Christian Gromm
Date: Tue Apr 2 13:39:57 2019 +0200
staging: most: core: use device description as name
commit 131ac62253dba79daf4a6d83ab12293d2b9863d3 upstream.
This patch uses the device description to clearly identity a device
attached to the bus. It is needed as the currently useed mdevX
notation is not sufficiant in case more than one network
interface controller is being used at the same time.
Cc: stable@vger.kernel.org
Signed-off-by: Christian Gromm
Signed-off-by: Greg Kroah-Hartman
commit 68bbd7524a6fce4198e25ee481eefd6c0fcf5318
Author: he, bo
Date: Wed Mar 6 10:32:20 2019 +0800
io: accel: kxcjk1013: restore the range after resume.
commit fe2d3df639a7940a125a33d6460529b9689c5406 upstream.
On some laptops, kxcjk1013 is powered off when system enters S3. We need
restore the range regiter during resume. Otherwise, the sensor doesn't
work properly after S3.
Signed-off-by: he, bo
Signed-off-by: Chen, Hu
Reviewed-by: Hans de Goede
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 3e13bb9782f537ddbb1e6f4dad8b76960c87ac55
Author: Fabrice Gasnier
Date: Mon Mar 25 14:01:23 2019 +0100
iio: core: fix a possible circular locking dependency
commit 7f75591fc5a123929a29636834d1bcb8b5c9fee3 upstream.
This fixes a possible circular locking dependency detected warning seen
with:
- CONFIG\_PROVE\_LOCKING=y
- consumer/provider IIO devices (ex: "voltage-divider" consumer of "adc")
When using the IIO consumer interface, e.g. iio\_channel\_get(), the consumer
device will likely call iio\_read\_channel\_raw() or similar that rely on
'info\_exist\_lock' mutex.
typically:
...
mutex\_lock(&chan->indio\_dev->info\_exist\_lock);
if (chan->indio\_dev->info == NULL) {
ret = -ENODEV;
goto err\_unlock;
}
ret = do\_some\_ops()
err\_unlock:
mutex\_unlock(&chan->indio\_dev->info\_exist\_lock);
return ret;
...
Same mutex is also hold in iio\_device\_unregister().
The following deadlock warning happens when:
- the consumer device has called an API like iio\_read\_channel\_raw()
at least once.
- the consumer driver is unregistered, removed (unbind from sysfs)
======================================================
WARNING: possible circular locking dependency detected
4.19.24 #577 Not tainted
------------------------------------------------------
sh/372 is trying to acquire lock:
(kn->count#30){++++}, at: kernfs\_remove\_by\_name\_ns+0x3c/0x84
but task is already holding lock:
(&dev->info\_exist\_lock){+.+.}, at: iio\_device\_unregister+0x18/0x60
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&dev->info\_exist\_lock){+.+.}:
\_\_mutex\_lock+0x70/0xa3c
mutex\_lock\_nested+0x1c/0x24
iio\_read\_channel\_raw+0x1c/0x60
iio\_read\_channel\_info+0xa8/0xb0
dev\_attr\_show+0x1c/0x48
sysfs\_kf\_seq\_show+0x84/0xec
seq\_read+0x154/0x528
\_\_vfs\_read+0x2c/0x15c
vfs\_read+0x8c/0x110
ksys\_read+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbedefb60
-> #0 (kn->count#30){++++}:
lock\_acquire+0xd8/0x268
\_\_kernfs\_remove+0x288/0x374
kernfs\_remove\_by\_name\_ns+0x3c/0x84
remove\_files+0x34/0x78
sysfs\_remove\_group+0x40/0x9c
sysfs\_remove\_groups+0x24/0x34
device\_remove\_attrs+0x38/0x64
device\_del+0x11c/0x360
cdev\_device\_del+0x14/0x2c
iio\_device\_unregister+0x24/0x60
release\_nodes+0x1bc/0x200
device\_release\_driver\_internal+0x1a0/0x230
unbind\_store+0x80/0x130
kernfs\_fop\_write+0x100/0x1e4
\_\_vfs\_write+0x2c/0x160
vfs\_write+0xa4/0x17c
ksys\_write+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbe906840
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
\*\*\* DEADLOCK \*\*\*
...
cdev\_device\_del() can be called without holding the lock. It should be safe
as info\_exist\_lock prevents kernelspace consumers to use the exported
routines during/after provider removal. cdev\_device\_del() is for userspace.
Help to reproduce:
See example: Documentation/devicetree/bindings/iio/afe/voltage-divider.txt
sysv {
compatible = "voltage-divider";
io-channels = <&adc 0>;
output-ohms = <22>;
full-ohms = <222>;
};
First, go to iio:deviceX for the "voltage-divider", do one read:
$ cd /sys/bus/iio/devices/iio:deviceX
$ cat in\_voltage0\_raw
Then, unbind the consumer driver. It triggers above deadlock warning.
$ cd /sys/bus/platform/drivers/iio-rescale/
$ echo sysv > unbind
Note I don't actually expect stable will pick this up all the
way back into IIO being in staging, but if's probably valid that
far back.
Signed-off-by: Fabrice Gasnier
Fixes: ac917a81117c ("staging:iio:core set the iio\_dev.info pointer to null on unregister")
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 1f6b63285e2fc71d285a7d24550759f2ba27a778
Author: Georg Ottinger
Date: Wed Jan 30 14:42:02 2019 +0100
iio: adc: at91: disable adc channel interrupt in timeout case
commit 09c6bdee51183a575bf7546890c8c137a75a2b44 upstream.
Having a brief look at at91\_adc\_read\_raw() it is obvious that in the case
of a timeout the setting of AT91\_ADC\_CHDR and AT91\_ADC\_IDR registers is
omitted. If 2 different channels are queried we can end up with a
situation where two interrupts are enabled, but only one interrupt is
cleared in the interrupt handler. Resulting in a interrupt loop and a
system hang.
Signed-off-by: Georg Ottinger
Acked-by: Ludovic Desroches
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 2b70088e150909401d4f97cd6b8d0ab0af7db39a
Author: Lars-Peter Clausen
Date: Wed Feb 20 17:11:32 2019 +0200
iio: Fix scan mask selection
commit 20ea39ef9f2f911bd01c69519e7d69cfec79fde3 upstream.
The trialmask is expected to have all bits set to 0 after allocation.
Currently kmalloc\_array() is used which does not zero the memory and so
random bits are set. This results in random channels being enabled when
they shouldn't. Replace kmalloc\_array() with kcalloc() which has the same
interface but zeros the memory.
Note the fix is actually required earlier than the below fixes tag, but
will require a manual backport due to move from kmalloc to kmalloc\_array.
Signed-off-by: Lars-Peter Clausen
Signed-off-by: Alexandru Ardelean
Fixes commit 057ac1acdfc4 ("iio: Use kmalloc\_array() in iio\_scan\_mask\_set()").
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 5c526f27861fbf002f8ce0f17fbbc9b6e23804a3
Author: Jean-Francois Dagenais
Date: Wed Mar 6 15:56:06 2019 -0500
iio: dac: mcp4725: add missing powerdown bits in store eeprom
commit 06003531502d06bc89d32528f6ec96bf978790f9 upstream.
When issuing the write DAC register and write eeprom command, the two
powerdown bits (PD0 and PD1) are assumed by the chip to be present in
the bytes sent. Leaving them at 0 implies "powerdown disabled" which is
a different state that the current one. By adding the current state of
the powerdown in the i2c write, the chip will correctly power-on exactly
like as it is at the moment of store\_eeprom call.
This is documented in MCP4725's datasheet, FIGURE 6-2: "Write Commands
for DAC Input Register and EEPROM" and MCP4726's datasheet, FIGURE 6-3:
"Write All Memory Command".
Signed-off-by: Jean-Francois Dagenais
Acked-by: Peter Meerwald-Stadler
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 50bc2c022b6e218f5ce7edbc76ff1584c956af8c
Author: Dragos Bogdan
Date: Tue Mar 19 12:47:00 2019 +0200
iio: ad\_sigma\_delta: select channel when reading register
commit fccfb9ce70ed4ea7a145f77b86de62e38178517f upstream.
The desired channel has to be selected in order to correctly fill the
buffer with the corresponding data.
The `ad\_sd\_write\_reg()` already does this, but for the
`ad\_sd\_read\_reg\_raw()` this was omitted.
Fixes: af3008485ea03 ("iio:adc: Add common code for ADI Sigma Delta devices")
Signed-off-by: Dragos Bogdan
Signed-off-by: Alexandru Ardelean
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit f65207cfee337192eaee3c7c7647cd8180e28ab9
Author: Gwendal Grignou
Date: Wed Mar 13 12:40:02 2019 +0100
iio: cros\_ec: Fix the maths for gyro scale calculation
commit 3d02d7082e5823598090530c3988a35f69689943 upstream.
Calculation did not use IIO\_DEGREE\_TO\_RAD and implemented a variant to
avoid precision loss as we aim a nano value. The offset added to avoid
rounding error, though, doesn't give us a close result to the expected
value. E.g.
For 1000dps, the result should be:
(1000 \* pi ) / 180 >> 15 ~= 0.000532632218
But with current calculation we get
$ cat scale
0.000547890
Fix the calculation by just doing the maths involved for a nano value
val \* pi \* 10e12 / (180 \* 2^15)
so we get a closer result.
$ cat scale
0.000532632
Fixes: c14dca07a31d ("iio: cros\_ec\_sensors: add ChromeOS EC Contiguous Sensors driver")
Signed-off-by: Gwendal Grignou
Signed-off-by: Enric Balletbo i Serra
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit b4dd709ada6d8727f385cba8e98220ae4fc2b7d7
Author: Mike Looijmans
Date: Wed Mar 6 08:31:48 2019 +0100
iio:chemical:bme680: Fix SPI read interface
commit 73f3bc6da506711302bb67572440eb84b1ec4a2c upstream.
The SPI interface implementation was completely broken.
When using the SPI interface, there are only 7 address bits, the upper bit
is controlled by a page select register. The core needs access to both
ranges, so implement register read/write for both regions. The regmap
paging functionality didn't agree with a register that needs to be read
and modified, so I implemented a custom paging algorithm.
This fixes that the device wouldn't even probe in SPI mode.
The SPI interface then isn't different from I2C, merged them into the core,
and the I2C/SPI named registers are no longer needed.
Implemented register value caching for the registers to reduce the I2C/SPI
data transfers considerably.
The calibration set reads as all zeroes until some undefined point in time,
and I couldn't determine what makes it valid. The datasheet mentions these
registers but does not provide any hints on when they become valid, and they
aren't even enumerated in the memory map. So check the calibration and
retry reading it from the device after each measurement until it provides
something valid.
Despite the size this is suitable for a stable backport given that
it seems the SPI support never worked.
Signed-off-by: Mike Looijmans
Fixes: 1b3bd8592780 ("iio: chemical: Add support for Bosch BME680 sensor");
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit fd3c6ad2a934831ccf61f1bd1b79f7044516b3e9
Author: Mike Looijmans
Date: Wed Mar 6 08:31:47 2019 +0100
iio:chemical:bme680: Fix, report temperature in millidegrees
commit 9436f45dd53595e21566a8c6627411077dfdb776 upstream.
The standard unit for temperature is millidegrees Celcius. Adapt the
driver to report in millidegrees instead of degrees.
Signed-off-by: Mike Looijmans
Fixes: 1b3bd8592780 ("iio: chemical: Add support for Bosch BME680 sensor");
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 5527e1e580071f4b58a03212738a51d207c57eed
Author: Mike Looijmans
Date: Wed Feb 13 08:41:47 2019 +0100
iio/gyro/bmg160: Use millidegrees for temperature scale
commit 40a7198a4a01037003c7ca714f0d048a61e729ac upstream.
Standard unit for temperature is millidegrees Celcius, whereas this driver
was reporting in degrees. Fix the scale factor in the driver.
Signed-off-by: Mike Looijmans
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 9efe152f769c6195282a4c787f2b03670b77d921
Author: Sergey Larin
Date: Sat Mar 2 19:54:55 2019 +0300
iio: gyro: mpu3050: fix chip ID reading
commit 409a51e0a4a5f908763191fae2c29008632eb712 upstream.
According to the datasheet, the last bit of CHIP\_ID register controls
I2C bus, and the first one is unused. Handle this correctly.
Note that there are chips out there that have a value such that
the id check currently fails.
Signed-off-by: Sergey Larin
Reviewed-by: Linus Walleij
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 25a91f7b9810c62538fe131521f1165d5a392bb7
Author: Mircea Caprioru
Date: Wed Feb 20 13:08:20 2019 +0200
staging: iio: ad7192: Fix ad7193 channel address
commit 7ce0f216221856a17fc4934b39284678a5fef2e9 upstream.
This patch fixes the differential channels addresses for the ad7193.
Signed-off-by: Mircea Caprioru
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 80c1486b7e209f7ea571e3c31f3d1312c02205e7
Author: Leonard Pollak
Date: Wed Feb 13 11:19:52 2019 +0100
Staging: iio: meter: fixed typo
commit 0a8a29be499cbb67df79370aaf5109085509feb8 upstream.
This patch fixes an obvious typo, which will cause erroneously returning the Peak
Voltage instead of the Peak Current.
Signed-off-by: Leonard Pollak
Cc:
Acked-by: Michael Hennerich
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 739969f56e4ff486f585fe2edeb12583e7e2a46c
Author: Vitaly Kuznetsov
Date: Wed Apr 3 16:06:42 2019 +0200
KVM: x86: svm: make sure NMI is injected after nmi\_singlestep
commit 99c221796a810055974b54c02e8f53297e48d146 upstream.
I noticed that apic test from kvm-unit-tests always hangs on my EPYC 7401P,
the hanging test nmi-after-sti is trying to deliver 30000 NMIs and tracing
shows that we're sometimes able to deliver a few but never all.
When we're trying to inject an NMI we may fail to do so immediately for
various reasons, however, we still need to inject it so enable\_nmi\_window()
arms nmi\_singlestep mode. #DB occurs as expected, but we're not checking
for pending NMIs before entering the guest and unless there's a different
event to process, the NMI will never get delivered.
Make KVM\_REQ\_EVENT request on the vCPU from db\_interception() to make sure
pending NMIs are checked and possibly injected.
Signed-off-by: Vitaly Kuznetsov
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 935fef82120fe9531263c609685e85e5b58448d6
Author: Sean Christopherson
Date: Tue Apr 2 08:10:47 2019 -0700
KVM: x86: Don't clear EFER during SMM transitions for 32-bit vCPU
commit 8f4dc2e77cdfaf7e644ef29693fa229db29ee1de upstream.
Neither AMD nor Intel CPUs have an EFER field in the legacy SMRAM save
state area, i.e. don't save/restore EFER across SMM transitions. KVM
somewhat models this, e.g. doesn't clear EFER on entry to SMM if the
guest doesn't support long mode. But during RSM, KVM unconditionally
clears EFER so that it can get back to pure 32-bit mode in order to
start loading CRs with their actual non-SMM values.
Clear EFER only when it will be written when loading the non-SMM state
so as to preserve bits that can theoretically be set on 32-bit vCPUs,
e.g. KVM always emulates EFER\_SCE.
And because CR4.PAE is cleared only to play nice with EFER, wrap that
code in the long mode check as well. Note, this may result in a
compiler warning about cr4 being consumed uninitialized. Re-read CR4
even though it's technically unnecessary, as doing so allows for more
readable code and RSM emulation is not a performance critical path.
Fixes: 660a5d517aaab ("KVM: x86: save/load state on SMM switch")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit d12bcf87e6ff1a5f20aa4606c5062bb1859e3b7c
Author: Aneesh Kumar K.V
Date: Sat Mar 9 17:37:21 2019 +0530
fs/dax: Deposit pagetable even when installing zero page
commit 11cf9d863dcb583345723b0ed72173348761e9c0 upstream.
Architectures like ppc64 use the deposited page table to store hardware
page table slot information. Make sure we deposit a page table when
using zero page at the pmd level for hash.
Without this we hit
Unable to handle kernel paging request for data at address 0x00000000
Faulting instruction address: 0xc000000000082a74
Oops: Kernel access of bad area, sig: 11 [#1]
....
NIP [c000000000082a74] \_\_hash\_page\_thp+0x224/0x5b0
LR [c0000000000829a4] \_\_hash\_page\_thp+0x154/0x5b0
Call Trace:
hash\_page\_mm+0x43c/0x740
do\_hash\_page+0x2c/0x3c
copy\_from\_iter\_flushcache+0xa4/0x4a0
pmem\_copy\_from\_iter+0x2c/0x50 [nd\_pmem]
dax\_copy\_from\_iter+0x40/0x70
dax\_iomap\_actor+0x134/0x360
iomap\_apply+0xfc/0x1b0
dax\_iomap\_rw+0xac/0x130
ext4\_file\_write\_iter+0x254/0x460 [ext4]
\_\_vfs\_write+0x120/0x1e0
vfs\_write+0xd8/0x220
SyS\_write+0x6c/0x110
system\_call+0x3c/0x130
Fixes: b5beae5e224f ("powerpc/pseries: Add driver for PAPR SCM regions")
Cc:
Reviewed-by: Jan Kara
Signed-off-by: Aneesh Kumar K.V
Signed-off-by: Dan Williams
Signed-off-by: Greg Kroah-Hartman
commit f6846161e203637e39d84814f5b2006eeeddba00
Author: Ronnie Sahlberg
Date: Wed Apr 10 07:47:22 2019 +1000
cifs: fix handle leak in smb2\_query\_symlink()
commit e6d0fb7b34f264f72c33053558a360a6a734905e upstream.
If we enter smb2\_query\_symlink() for something that is not a symlink
and where the SMB2\_open() would succeed we would never end up
closing this handle and would thus leak a handle on the server.
Fix this by immediately calling SMB2\_close() on successfull open.
Signed-off-by: Ronnie Sahlberg
CC: Stable
Signed-off-by: Steve French
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit 76dbd554c2730ce0b324e54bac9d8a9056b1ffdc
Author: ZhangXiaoxu
Date: Sat Apr 6 15:47:39 2019 +0800
cifs: Fix use-after-free in SMB2\_read
commit 088aaf17aa79300cab14dbee2569c58cfafd7d6e upstream.
There is a KASAN use-after-free:
BUG: KASAN: use-after-free in SMB2\_read+0x1136/0x1190
Read of size 8 at addr ffff8880b4e45e50 by task ln/1009
Should not release the 'req' because it will use in the trace.
Fixes: eccb4422cf97 ("smb3: Add ftrace tracepoints for improved SMB3 debugging")
Signed-off-by: ZhangXiaoxu
Signed-off-by: Steve French
CC: Stable  4.18+
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit e8ac406c749ea5d2a583854667a20d8e7fe38070
Author: ZhangXiaoxu
Date: Sat Apr 6 15:47:38 2019 +0800
cifs: Fix use-after-free in SMB2\_write
commit 6a3eb3360667170988f8a6477f6686242061488a upstream.
There is a KASAN use-after-free:
BUG: KASAN: use-after-free in SMB2\_write+0x1342/0x1580
Read of size 8 at addr ffff8880b6a8e450 by task ln/4196
Should not release the 'req' because it will use in the trace.
Fixes: eccb4422cf97 ("smb3: Add ftrace tracepoints for improved SMB3 debugging")
Signed-off-by: ZhangXiaoxu
Signed-off-by: Steve French
CC: Stable  4.18+
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit 9582ba401ef08e92f328001a813835a464258e7d
Author: ZhangXiaoxu
Date: Sat Apr 6 15:30:38 2019 +0800
cifs: Fix lease buffer length error
commit b57a55e2200ede754e4dc9cce4ba9402544b9365 upstream.
There is a KASAN slab-out-of-bounds:
BUG: KASAN: slab-out-of-bounds in \_copy\_from\_iter\_full+0x783/0xaa0
Read of size 80 at addr ffff88810c35e180 by task mount.cifs/539
CPU: 1 PID: 539 Comm: mount.cifs Not tainted 4.19 #10
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
rel-1.12.0-0-ga698c8995f-prebuilt.qemu.org 04/01/2014
Call Trace:
dump\_stack+0xdd/0x12a
print\_address\_description+0xa7/0x540
kasan\_report+0x1ff/0x550
check\_memory\_region+0x2f1/0x310
memcpy+0x2f/0x80
\_copy\_from\_iter\_full+0x783/0xaa0
tcp\_sendmsg\_locked+0x1840/0x4140
tcp\_sendmsg+0x37/0x60
inet\_sendmsg+0x18c/0x490
sock\_sendmsg+0xae/0x130
smb\_send\_kvec+0x29c/0x520
\_\_smb\_send\_rqst+0x3ef/0xc60
smb\_send\_rqst+0x25a/0x2e0
compound\_send\_recv+0x9e8/0x2af0
cifs\_send\_recv+0x24/0x30
SMB2\_open+0x35e/0x1620
open\_shroot+0x27b/0x490
smb2\_open\_op\_close+0x4e1/0x590
smb2\_query\_path\_info+0x2ac/0x650
cifs\_get\_inode\_info+0x1058/0x28f0
cifs\_root\_iget+0x3bb/0xf80
cifs\_smb3\_do\_mount+0xe00/0x14c0
cifs\_do\_mount+0x15/0x20
mount\_fs+0x5e/0x290
vfs\_kern\_mount+0x88/0x460
do\_mount+0x398/0x31e0
ksys\_mount+0xc6/0x150
\_\_x64\_sys\_mount+0xea/0x190
do\_syscall\_64+0x122/0x590
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
It can be reproduced by the following step:
1. samba configured with: server max protocol = SMB2\_10
2. mount -o vers=default
When parse the mount version parameter, the 'ops' and 'vals'
was setted to smb30, if negotiate result is smb21, just
update the 'ops' to smb21, but the 'vals' is still smb30.
When add lease context, the iov\_base is allocated with smb21
ops, but the iov\_len is initiallited with the smb30. Because
the iov\_len is longer than iov\_base, when send the message,
copy array out of bounds.
we need to keep the 'ops' and 'vals' consistent.
Fixes: 9764c02fcbad ("SMB3: Add support for multidialect negotiate (SMB2.1 and later)")
Fixes: d5c7076b772a ("smb3: add smb3.1.1 to default dialect list")
Signed-off-by: ZhangXiaoxu
Signed-off-by: Steve French
CC: Stable
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit ebac4d0adf68f8962bd82fcf483936edd6ec095b
Author: Aurelien Aptel
Date: Fri Mar 29 10:49:12 2019 +0100
CIFS: keep FileInfo handle live during oplock break
commit b98749cac4a695f084a5ff076f4510b23e353ecd upstream.
In the oplock break handler, writing pending changes from pages puts
the FileInfo handle. If the refcount reaches zero it closes the handle
and waits for any oplock break handler to return, thus causing a deadlock.
To prevent this situation:
\* We add a wait flag to cifsFileInfo\_put() to decide whether we should
wait for running/pending oplock break handlers
\* We keep an additionnal reference of the SMB FileInfo handle so that
for the rest of the handler putting the handle won't close it.
- The ref is bumped everytime we queue the handler via the
cifs\_queue\_oplock\_break() helper.
- The ref is decremented at the end of the handler
This bug was triggered by xfstest 464.
Also important fix to address the various reports of
oops in smb2\_push\_mandatory\_locks
Signed-off-by: Aurelien Aptel
Signed-off-by: Steve French
Reviewed-by: Pavel Shilovsky
CC: Stable
Signed-off-by: Greg Kroah-Hartman
commit 2cf17769d6b543b262a3cd04b3fd17b2bd4e6487
Author: Toke Høiland-Jørgensen
Date: Fri Apr 5 15:01:59 2019 +0200
sch\_cake: Simplify logic in cake\_select\_tin()
[ Upstream commit 4976e3c683f328bc6f2edef555a4ffee6524486f ]
The logic in cake\_select\_tin() was getting a bit hairy, and it turns out we
can simplify it quite a bit. This also allows us to get rid of one of the
two diffserv parsing functions, which has the added benefit that
already-zeroed DSCP fields won't get re-written.
Suggested-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 5aa94a5b5641a3c2200be00c8bd9cc48ed5f6640
Author: Dan Carpenter
Date: Wed Apr 3 10:13:51 2019 +0300
nfc: nci: Potential off by one in ->pipes[] array
[ Upstream commit 6491d698396fd5da4941980a35ca7c162a672016 ]
This is similar to commit e285d5bfb7e9 ("NFC: Fix the number of pipes")
where we changed NFC\_HCI\_MAX\_PIPES from 127 to 128.
As the comment next to the define explains, the pipe identifier is 7
bits long. The highest possible pipe is 127, but the number of possible
pipes is 128. As the code is now, then there is potential for an
out of bounds array access:
net/nfc/nci/hci.c:297 nci\_hci\_cmd\_received() warn: array off by one?
'ndev->hci\_dev->pipes[pipe]' '0-127 == 127'
Fixes: 11f54f228643 ("NFC: nci: Add HCI over NCI protocol support")
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit a023c1a245a71d936c67d2c984e5789d604622e6
Author: Dan Carpenter
Date: Wed Apr 3 10:12:48 2019 +0300
NFC: nci: Add some bounds checking in nci\_hci\_cmd\_received()
[ Upstream commit d7ee81ad09f072eab1681877fc71ec05f9c1ae92 ]
This is similar to commit 674d9de02aa7 ("NFC: Fix possible memory
corruption when handling SHDLC I-Frame commands").
I'm not totally sure, but I think that commit description may have
overstated the danger. I was under the impression that this data came
from the firmware? If you can't trust your networking firmware, then
you're already in trouble.
Anyway, these days we add bounds checking where ever we can and we call
it kernel hardening. Better safe than sorry.
Fixes: 11f54f228643 ("NFC: nci: Add HCI over NCI protocol support")
Signed-off-by: Dan Carpenter
Signed-off-by: Greg Kroah-Hartman
commit d58923dac952107bcfe0fe0ad59e80d3c952cc36
Author: Toke Høiland-Jørgensen
Date: Thu Apr 4 15:01:33 2019 +0200
sch\_cake: Make sure we can write the IP header before changing DSCP bits
[ Upstream commit c87b4ecdbe8db27867a7b7f840291cd843406bd7 ]
There is not actually any guarantee that the IP headers are valid before we
access the DSCP bits of the packets. Fix this using the same approach taken
in sch\_dsmark.
Reported-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 064290d0f6c7adc4fa19f88e33bbb9f2633984fc
Author: Toke Høiland-Jørgensen
Date: Thu Apr 4 15:01:33 2019 +0200
sch\_cake: Use tc\_skb\_protocol() helper for getting packet protocol
[ Upstream commit b2100cc56fca8c51d28aa42a9f1fbcb2cf351996 ]
We shouldn't be using skb->protocol directly as that will miss cases with
hardware-accelerated VLAN tags. Use the helper instead to get the right
protocol number.
Reported-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 116ac142d2c6cccf821ef351645158ef8ba9e05e
Author: Pieter Jansen van Vuuren
Date: Mon Apr 1 19:36:34 2019 -0700
nfp: flower: remove vlan CFI bit from push vlan action
[ Upstream commit 42cd5484a22f1a1b947e21e2af65fa7dab09d017 ]
We no longer set CFI when pushing vlan tags, therefore we remove
the CFI bit from push vlan.
Fixes: 1a1e586f54bf ("nfp: add basic action capabilities to flower offloads")
Signed-off-by: Pieter Jansen van Vuuren
Signed-off-by: Louis Peens
Signed-off-by: Greg Kroah-Hartman
commit 51db0d068057040012ba9201ae0b8129fe0591f9
Author: Pieter Jansen van Vuuren
Date: Mon Apr 1 19:36:33 2019 -0700
nfp: flower: replace CFI with vlan present
[ Upstream commit f7ee799a51ddbcc205ef615fe424fb5084e9e0aa ]
Replace vlan CFI bit with a vlan present bit that indicates the
presence of a vlan tag. Previously the driver incorrectly assumed
that an vlan id of 0 is not matchable, therefore we indicate vlan
presence with a vlan present bit.
Fixes: 5571e8c9f241 ("nfp: extend flower matching capabilities")
Signed-off-by: Pieter Jansen van Vuuren
Signed-off-by: Louis Peens
Signed-off-by: Greg Kroah-Hartman
commit da86299fcccb7cd1073e927068fc2f43fe5b9f8f
Author: Jonathan Lemon
Date: Sun Apr 14 14:21:29 2019 -0700
route: Avoid crash from dereferencing NULL rt->from
[ Upstream commit 9c69a13205151c0d801de9f9d83a818e6e8f60ec ]
When \_\_ip6\_rt\_update\_pmtu() is called, rt->from is RCU dereferenced, but is
never checked for null - rt6\_flush\_exceptions() may have removed the entry.
[ 1913.989004] RIP: 0010:ip6\_rt\_cache\_alloc+0x13/0x170
[ 1914.209410] Call Trace:
[ 1914.214798]
[ 1914.219226] \_\_ip6\_rt\_update\_pmtu+0xb0/0x190
[ 1914.228649] ip6\_tnl\_xmit+0x2c2/0x970 [ip6\_tunnel]
[ 1914.239223] ? ip6\_tnl\_parse\_tlv\_enc\_lim+0x32/0x1a0 [ip6\_tunnel]
[ 1914.252489] ? \_\_gre6\_xmit+0x148/0x530 [ip6\_gre]
[ 1914.262678] ip6gre\_tunnel\_xmit+0x17e/0x3c7 [ip6\_gre]
[ 1914.273831] dev\_hard\_start\_xmit+0x8d/0x1f0
[ 1914.283061] sch\_direct\_xmit+0xfa/0x230
[ 1914.291521] \_\_qdisc\_run+0x154/0x4b0
[ 1914.299407] net\_tx\_action+0x10e/0x1f0
[ 1914.307678] \_\_do\_softirq+0xca/0x297
[ 1914.315567] irq\_exit+0x96/0xa0
[ 1914.322494] smp\_apic\_timer\_interrupt+0x68/0x130
[ 1914.332683] apic\_timer\_interrupt+0xf/0x20
[ 1914.341721]
Fixes: a68886a69180 ("net/ipv6: Make from in rt6\_info rcu protected")
Signed-off-by: Jonathan Lemon
Reviewed-by: Eric Dumazet
Reviewed-by: David Ahern
Reviewed-by: Martin KaFai Lau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6ad8c35a70ccead9118f4431320a228de4c6af66
Author: Saeed Mahameed
Date: Tue Mar 19 01:05:41 2019 -0700
net/mlx5: FPGA, tls, idr remove on flow delete
[ Upstream commit df3a8344d404a810b4aadbf19b08c8232fbaa715 ]
Flow is kfreed on mlx5\_fpga\_tls\_del\_flow but kept in the idr data
structure, this is risky and can cause use-after-free, since the
idr\_remove is delayed until tls\_send\_teardown\_cmd completion.
Instead of delaying idr\_remove, in this patch we do it on
mlx5\_fpga\_tls\_del\_flow, before actually kfree(flow).
Added synchronize\_rcu before kfree(flow)
Fixes: ab412e1dd7db ("net/mlx5: Accel, add TLS rx offload routines")
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit d3697f88a2711638cf2b93c5fd3f7e3adeeaf690
Author: Jakub Kicinski
Date: Mon Apr 8 17:59:50 2019 -0700
net/tls: prevent bad memory access in tls\_is\_sk\_tx\_device\_offloaded()
[ Upstream commit b4f47f3848eb70986f75d06112af7b48b7f5f462 ]
Unlike '&&' operator, the '&' does not have short-circuit
evaluation semantics. IOW both sides of the operator always
get evaluated. Fix the wrong operator in
tls\_is\_sk\_tx\_device\_offloaded(), which would lead to
out-of-bounds access for for non-full sockets.
Fixes: 4799ac81e52a ("tls: Add rx inline crypto offload")
Signed-off-by: Jakub Kicinski
Reviewed-by: Dirk van der Merwe
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1d9005b96dcec04ca244cf229c5e4b84f02504a4
Author: Saeed Mahameed
Date: Tue Mar 19 22:09:05 2019 -0700
net/mlx5: FPGA, tls, hold rcu read lock a bit longer
[ Upstream commit 31634bf5dcc418b5b2cacd954394c0c4620db6a2 ]
To avoid use-after-free, hold the rcu read lock until we are done copying
flow data into the command buffer.
Fixes: ab412e1dd7db ("net/mlx5: Accel, add TLS rx offload routines")
Reported-by: Eric Dumazet
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit abe4a1328a7838685aa551c1529f9d01f1fafab1
Author: Or Gerlitz
Date: Sun Mar 31 12:53:03 2019 +0000
Revert "net/mlx5e: Enable reporting checksum unnecessary also for L3 packets"
[ Upstream commit 8c8811d46d00d119ffbe039a6e52a0b504df1c2c ]
This reverts commit b820e6fb0978f9c2ac438c199d2bb2f35950e9c9.
Prior the commit we are reverting, checksum unnecessary was only set when
both the L3 OK and L4 OK bits are set on the CQE. This caused packets
of IP protocols such as SCTP which are not dealt by the current HW L4
parser (hence the L4 OK bit is not set, but the L4 header type none bit
is set) to go through the checksum none code, where currently we wrongly
report checksum unnecessary for them, a regression. Fix this by a revert.
Note that on our usual track we report checksum complete, so the revert
isn't expected to have any notable performance impact. Also, when we are
not on the checksum complete track, the L4 protocols for which we report
checksum none are not high performance ones, we will still report
checksum unnecessary for UDP/TCP.
Fixes: b820e6fb0978 ("net/mlx5e: Enable reporting checksum unnecessary also for L3 packets")
Signed-off-by: Or Gerlitz
Reported-by: Avi Urman
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit acf4d270942ad4d5e03e56e6c265594f1dc99d41
Author: Saeed Mahameed
Date: Mon Mar 25 22:10:59 2019 -0700
net/mlx5e: Rx, Check ip headers sanity
[ Upstream commit 0318a7b7fcad9765931146efa7ca3a034194737c ]
In the two places is\_last\_ethertype\_ip is being called, the caller will
be looking inside the ip header, to be safe, add ip{4,6} header sanity
check. And return true only on valid ip headers, i.e: the whole header
is contained in the linear part of the skb.
Note: Such situation is very rare and hard to reproduce, since mlx5e
allocates a large enough headroom to contain the largest header one can
imagine.
Fixes: fe1dc069990c ("net/mlx5e: don't set CHECKSUM\_COMPLETE on SCTP packets")
Reported-by: Cong Wang
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit 3ce8793e03cdf6191430955adf11be1cd7331e0f
Author: Saeed Mahameed
Date: Tue Mar 12 00:24:52 2019 -0700
net/mlx5e: Rx, Fixup skb checksum for packets with tail padding
[ Upstream commit 0aa1d18615c163f92935b806dcaff9157645233a ]
When an ethernet frame with ip payload is padded, the padding octets are
not covered by the hardware checksum.
Prior to the cited commit, skb checksum was forced to be CHECKSUM\_NONE
when padding is detected. After it, the kernel will try to trim the
padding bytes and subtract their checksum from skb->csum.
In this patch we fixup skb->csum for any ip packet with tail padding of
any size, if any padding found.
FCS case is just one special case of this general purpose patch, hence,
it is removed.
Fixes: 88078d98d1bb ("net: pskb\_trim\_rcsum() and CHECKSUM\_COMPLETE are friends"),
Cc: Eric Dumazet
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit af294d42d43e906b4634aca06262fa6cb9ada582
Author: Konstantin Khlebnikov
Date: Fri Aug 31 14:29:16 2018 +0300
net/mlx5e: Switch to Toeplitz RSS hash by default
[ Upstream commit 7ee2ace9c544a0886e02b54b625e521df8692d20 ]
Although XOR hash function can perform very well on some special use
cases, to align with all drivers, mlx5 driver should use Toeplitz hash
by default.
Toeplitz is more stable for the general use case and it is more standard
and reliable.
On top of that, since XOR (MLX5\_RX\_HASH\_FN\_INVERTED\_XOR8) gives only a
repeated 8 bits pattern. When used for udp tunneling RSS source port
manipulation it results in fixed source port, which will cause bad RSS
spread.
Fixes: 2be6967cdbc9 ("net/mlx5e: Support ETH\_RSS\_HASH\_XOR")
Signed-off-by: Konstantin Khlebnikov
Reviewed-by: Tariq Toukan
Signed-off-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit 6daad2e30e0b1fd37eee9aab7163243511c0629b
Author: Dmytro Linkin
Date: Fri Mar 29 12:50:37 2019 +0000
net/mlx5e: Protect against non-uplink representor for encap
[ Upstream commit 5e0060b1491b299b1706414e61ede0b02265680e ]
TC encap offload is supported only for the physical uplink
representor. Fail for non uplink representor.
Fixes: 3e621b19b0bb ("net/mlx5e: Support TC encapsulation offloads with upper devices")
Signed-off-by: Dmytro Linkin
Reviewed-by: Eli Britstein
Reviewed-by: Vlad Buslov
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit 58f682514cb54cef47fcfcd9e0b49c2c6213e7eb
Author: Saeed Mahameed
Date: Thu Mar 21 19:07:20 2019 -0700
net/mlx5e: XDP, Avoid checksum complete when XDP prog is loaded
[ Upstream commit 5d0bb3bac4b9f6c22280b04545626fdfd99edc6b ]
XDP programs might change packets data contents which will make the
reported skb checksum (checksum complete) invalid.
When XDP programs are loaded/unloaded set/clear rx RQs
MLX5E\_RQ\_STATE\_NO\_CSUM\_COMPLETE flag.
Fixes: 86994156c736 ("net/mlx5e: XDP fast RX drop bpf programs support")
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit 0e4b3800c0699f3ccdda30019fd7e7295a697c1b
Author: Nikolay Aleksandrov
Date: Tue Apr 16 16:15:56 2019 +0300
net: bridge: fix netlink export of vlan\_stats\_per\_port option
[ Upstream commit 600bea7dba1a72874ae0cd9bc66bf2abfe43b49d ]
Since the introduction of the vlan\_stats\_per\_port option the netlink
export of it has been broken since I made a typo and used the ifla
attribute instead of the bridge option to retrieve its state.
Sysfs export is fine, only netlink export has been affected.
Fixes: 9163a0fc1f0c0 ("net: bridge: add support for per-port vlan stats")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit adfc12451123298bc583b9922f5182ae8cf70e59
Author: Jakub Kicinski
Date: Wed Apr 10 16:23:39 2019 -0700
net/tls: fix build without CONFIG\_TLS\_DEVICE
[ Upstream commit 903f1a187776bb8d79b13618ec05b25f86318885 ]
buildbot noticed that TLS\_HW is not defined if CONFIG\_TLS\_DEVICE=n.
Wrap the cleanup branch into an ifdef, tls\_device\_free\_resources\_tx()
wouldn't be compiled either in this case.
Fixes: 35b71a34ada6 ("net/tls: don't leak partially sent record in device mode")
Signed-off-by: Jakub Kicinski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5e7171bf8db70e2f0de91d47e206bf2e0e7805cb
Author: Jakub Kicinski
Date: Wed Apr 10 11:04:32 2019 -0700
net: strparser: partially revert "strparser: Call skb\_unclone conditionally"
[ Upstream commit 4a9c2e3746e6151fd5d077259d79ce9ca86d47d7 ]
This reverts the first part of commit 4e485d06bb8c ("strparser: Call
skb\_unclone conditionally"). To build a message with multiple
fragments we need our own root of frag\_list. We can't simply
use the frag\_list of orig\_skb, because it will lead to linking
all orig\_skbs together creating very long frag chains, and causing
stack overflow on kfree\_skb() (which is called recursively on
the frag\_lists).
BUG: stack guard page was hit at 00000000d40fad41 (stack is 0000000029dde9f4..000000008cce03d5)
kernel stack overflow (double-fault): 0000 [#1] PREEMPT SMP
RIP: 0010:free\_one\_page+0x2b/0x490
Call Trace:
\_\_free\_pages\_ok+0x143/0x2c0
skb\_release\_data+0x8e/0x140
? skb\_release\_data+0xad/0x140
kfree\_skb+0x32/0xb0
[...]
skb\_release\_data+0xad/0x140
? skb\_release\_data+0xad/0x140
kfree\_skb+0x32/0xb0
skb\_release\_data+0xad/0x140
? skb\_release\_data+0xad/0x140
kfree\_skb+0x32/0xb0
skb\_release\_data+0xad/0x140
? skb\_release\_data+0xad/0x140
kfree\_skb+0x32/0xb0
skb\_release\_data+0xad/0x140
? skb\_release\_data+0xad/0x140
kfree\_skb+0x32/0xb0
skb\_release\_data+0xad/0x140
\_\_kfree\_skb+0xe/0x20
tcp\_disconnect+0xd6/0x4d0
tcp\_close+0xf4/0x430
? tcp\_check\_oom+0xf0/0xf0
tls\_sk\_proto\_close+0xe4/0x1e0 [tls]
inet\_release+0x36/0x60
\_\_sock\_release+0x37/0xa0
sock\_close+0x11/0x20
\_\_fput+0xa2/0x1d0
task\_work\_run+0x89/0xb0
exit\_to\_usermode\_loop+0x9a/0xa0
do\_syscall\_64+0xc0/0xf0
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
Let's leave the second unclone conditional, as I'm not entirely
sure what is its purpose :)
Fixes: 4e485d06bb8c ("strparser: Call skb\_unclone conditionally")
Signed-off-by: Jakub Kicinski
Reviewed-by: Dirk van der Merwe
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 96418eaa8e6aba1f4bdbdf058ea5f1d085599fd7
Author: Jakub Kicinski
Date: Wed Apr 10 11:04:31 2019 -0700
net/tls: don't leak partially sent record in device mode
[ Upstream commit 35b71a34ada62c9573847a324bf06a133fe11b11 ]
David reports that tls triggers warnings related to
sk->sk\_forward\_alloc not being zero at destruction time:
WARNING: CPU: 5 PID: 6831 at net/core/stream.c:206 sk\_stream\_kill\_queues+0x103/0x110
WARNING: CPU: 5 PID: 6831 at net/ipv4/af\_inet.c:160 inet\_sock\_destruct+0x15b/0x170
When sender fills up the write buffer and dies from
SIGPIPE. This is due to the device implementation
not cleaning up the partially\_sent\_record.
This is because commit a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
moved the partial record cleanup to the SW-only path.
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Reported-by: David Beckett
Signed-off-by: Jakub Kicinski
Reviewed-by: Dirk van der Merwe
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b30d9457b1dc79e1cad6a3ebeea9728c8e905c9d
Author: Jakub Kicinski
Date: Wed Apr 10 11:04:30 2019 -0700
net/tls: fix the IV leaks
[ Upstream commit 5a03bc73abed6ae196c15e9950afde19d48be12c ]
Commit f66de3ee2c16 ("net/tls: Split conf to rx + tx") made
freeing of IV and record sequence number conditional to SW
path only, but commit e8f69799810c ("net/tls: Add generic NIC
offload infrastructure") also allocates that state for the
device offload configuration. Remember to free it.
Fixes: e8f69799810c ("net/tls: Add generic NIC offload infrastructure")
Signed-off-by: Jakub Kicinski
Reviewed-by: Dirk van der Merwe
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ae924f4e1c4598b3d6be8c48e7f4f025e91f3661
Author: Matteo Croce
Date: Thu Apr 11 12:26:33 2019 +0200
net: thunderx: don't allow jumbo frames with XDP
[ Upstream commit 1f227d16083b2e280b7dde4ca78883d75593f2fd ]
The thunderx driver forbids to load an eBPF program if the MTU is too high,
but this can be circumvented by loading the eBPF, then raising the MTU.
Fix this by limiting the MTU if an eBPF program is already loaded.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a902fe6dd585a75168bcd8b560a498492f03e262
Author: Matteo Croce
Date: Thu Apr 11 12:26:32 2019 +0200
net: thunderx: raise XDP MTU to 1508
[ Upstream commit 5ee15c101f29e0093ffb5448773ccbc786eb313b ]
The thunderx driver splits frames bigger than 1530 bytes to multiple
pages, making impossible to run an eBPF program on it.
This leads to a maximum MTU of 1508 if QinQ is in use.
The thunderx driver forbids to load an eBPF program if the MTU is higher
than 1500 bytes. Raise the limit to 1508 so it is possible to use L2
protocols which need some more headroom.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9be4e8224cd6ba2ae515a3d6c0ad2281b1dcdb22
Author: Ido Schimmel
Date: Wed Apr 10 06:58:15 2019 +0000
mlxsw: spectrum\_router: Do not check VRF MAC address
[ Upstream commit 972fae683cbad5cf348268e76abc6d55cfb3ba87 ]
Commit 74bc99397438 ("mlxsw: spectrum\_router: Veto unsupported RIF MAC
addresses") enabled the driver to veto router interface (RIF) MAC
addresses that it cannot support.
This check should only be performed for interfaces for which the driver
actually configures a RIF. A VRF upper is not one of them, so ignore it.
Without this patch it is not possible to set an IP address on the VRF
device and use it as a loopback.
Fixes: 74bc99397438 ("mlxsw: spectrum\_router: Veto unsupported RIF MAC addresses")
Signed-off-by: Ido Schimmel
Reported-by: Alexander Petrovskiy
Tested-by: Alexander Petrovskiy
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 61647856f32ae24db9dadb2c61457adb327df281
Author: Ido Schimmel
Date: Wed Apr 10 06:58:15 2019 +0000
mlxsw: core: Do not use WQ\_MEM\_RECLAIM for mlxsw workqueue
[ Upstream commit b442fed1b724af0de087912a5718ddde1b87acbb ]
The workqueue is used to periodically update the networking stack about
activity / statistics of various objects such as neighbours and TC
actions.
It should not be called as part of memory reclaim path, so remove the
WQ\_MEM\_RECLAIM flag.
Fixes: 3d5479e92087 ("mlxsw: core: Remove deprecated create\_workqueue")
Signed-off-by: Ido Schimmel
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 87ffb893490abd1ce05c4cf84a1a00b32e143b70
Author: Ido Schimmel
Date: Wed Apr 10 06:58:14 2019 +0000
mlxsw: core: Do not use WQ\_MEM\_RECLAIM for mlxsw ordered workqueue
[ Upstream commit 4af0699782e2cc7d0d89db9eb6f8844dd3df82dc ]
The ordered workqueue is used to offload various objects such as routes
and neighbours in the order they are notified.
It should not be called as part of memory reclaim path, so remove the
WQ\_MEM\_RECLAIM flag. This can also result in a warning [1], if a worker
tries to flush a non-WQ\_MEM\_RECLAIM workqueue.
[1]
[97703.542861] workqueue: WQ\_MEM\_RECLAIM mlxsw\_core\_ordered:mlxsw\_sp\_router\_fib6\_event\_work [mlxsw\_spectrum] is flushing !WQ\_MEM\_RECLAIM events:rht\_deferred\_worker
[97703.542884] WARNING: CPU: 1 PID: 32492 at kernel/workqueue.c:2605 check\_flush\_dependency+0xb5/0x130
...
[97703.542988] Hardware name: Mellanox Technologies Ltd. MSN3700C/VMOD0008, BIOS 5.11 10/10/2018
[97703.543049] Workqueue: mlxsw\_core\_ordered mlxsw\_sp\_router\_fib6\_event\_work [mlxsw\_spectrum]
[97703.543061] RIP: 0010:check\_flush\_dependency+0xb5/0x130
...
[97703.543071] RSP: 0018:ffffb3f08137bc00 EFLAGS: 00010086
[97703.543076] RAX: 0000000000000000 RBX: ffff96e07740ae00 RCX: 0000000000000000
[97703.543080] RDX: 0000000000000094 RSI: ffffffff82dc1934 RDI: 0000000000000046
[97703.543084] RBP: ffffb3f08137bc20 R08: ffffffff82dc18a0 R09: 00000000000225c0
[97703.543087] R10: 0000000000000000 R11: 0000000000007eec R12: ffffffff816e4ee0
[97703.543091] R13: ffff96e06f6a5c00 R14: ffff96e077ba7700 R15: ffffffff812ab0c0
[97703.543097] FS: 0000000000000000(0000) GS:ffff96e077a80000(0000) knlGS:0000000000000000
[97703.543101] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[97703.543104] CR2: 00007f8cd135b280 CR3: 00000001e860e003 CR4: 00000000003606e0
[97703.543109] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[97703.543112] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[97703.543115] Call Trace:
[97703.543129] \_\_flush\_work+0xbd/0x1e0
[97703.543137] ? \_\_cancel\_work\_timer+0x136/0x1b0
[97703.543145] ? pwq\_dec\_nr\_in\_flight+0x49/0xa0
[97703.543154] \_\_cancel\_work\_timer+0x136/0x1b0
[97703.543175] ? mlxsw\_reg\_trans\_bulk\_wait+0x145/0x400 [mlxsw\_core]
[97703.543184] cancel\_work\_sync+0x10/0x20
[97703.543191] rhashtable\_free\_and\_destroy+0x23/0x140
[97703.543198] rhashtable\_destroy+0xd/0x10
[97703.543254] mlxsw\_sp\_fib\_destroy+0xb1/0xf0 [mlxsw\_spectrum]
[97703.543310] mlxsw\_sp\_vr\_put+0xa8/0xc0 [mlxsw\_spectrum]
[97703.543364] mlxsw\_sp\_fib\_node\_put+0xbf/0x140 [mlxsw\_spectrum]
[97703.543418] ? mlxsw\_sp\_fib6\_entry\_destroy+0xe8/0x110 [mlxsw\_spectrum]
[97703.543475] mlxsw\_sp\_router\_fib6\_event\_work+0x6cd/0x7f0 [mlxsw\_spectrum]
[97703.543484] process\_one\_work+0x1fd/0x400
[97703.543493] worker\_thread+0x34/0x410
[97703.543500] kthread+0x121/0x140
[97703.543507] ? process\_one\_work+0x400/0x400
[97703.543512] ? kthread\_park+0x90/0x90
[97703.543523] ret\_from\_fork+0x35/0x40
Fixes: a3832b31898f ("mlxsw: core: Create an ordered workqueue for FIB offload")
Signed-off-by: Ido Schimmel
Reported-by: Semion Lisyansky
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 565e18a0be1051935f7e36cf470c87c6badbc36e
Author: Ido Schimmel
Date: Wed Apr 10 06:58:13 2019 +0000
mlxsw: core: Do not use WQ\_MEM\_RECLAIM for EMAD workqueue
[ Upstream commit a8c133b06183c529c51cd0d54eb57d6b7078370c ]
The EMAD workqueue is used to handle retransmission of EMAD packets that
contain configuration data for the device's firmware.
Given the workers need to allocate these packets and that the code is
not called as part of memory reclaim path, remove the WQ\_MEM\_RECLAIM
flag.
Fixes: d965465b60ba ("mlxsw: core: Fix possible deadlock")
Signed-off-by: Ido Schimmel
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6f180e411c3e551ef905c9424982d90b9bb26f6a
Author: Ido Schimmel
Date: Wed Apr 10 06:58:12 2019 +0000
mlxsw: spectrum\_switchdev: Add MDB entries in prepare phase
[ Upstream commit d4d0e40977ac450f32f2db5e4d8e23c9d2578899 ]
The driver cannot guarantee in the prepare phase that it will be able to
write an MDB entry to the device. In case the driver returned success
during the prepare phase, but then failed to add the entry in the commit
phase, a WARNING [1] will be generated by the switchdev core.
Fix this by doing the work in the prepare phase instead.
[1]
[ 358.544486] swp12s0: Commit of object (id=2) failed.
[ 358.550061] WARNING: CPU: 0 PID: 30 at net/switchdev/switchdev.c:281 switchdev\_port\_obj\_add\_now+0x9b/0xe0
[ 358.560754] CPU: 0 PID: 30 Comm: kworker/0:1 Not tainted 5.0.0-custom-13382-gf2449babf221 #1350
[ 358.570472] Hardware name: Mellanox Technologies Ltd. MSN2100-CB2FO/SA001017, BIOS 5.6.5 06/07/2016
[ 358.580582] Workqueue: events switchdev\_deferred\_process\_work
[ 358.587001] RIP: 0010:switchdev\_port\_obj\_add\_now+0x9b/0xe0
...
[ 358.614109] RSP: 0018:ffffa6b900d6fe18 EFLAGS: 00010286
[ 358.619943] RAX: 0000000000000000 RBX: ffff8b00797ff000 RCX: 0000000000000000
[ 358.627912] RDX: ffff8b00b7a1d4c0 RSI: ffff8b00b7a152e8 RDI: ffff8b00b7a152e8
[ 358.635881] RBP: ffff8b005c3f5bc0 R08: 000000000000022b R09: 0000000000000000
[ 358.643850] R10: 0000000000000000 R11: ffffa6b900d6fcc8 R12: 0000000000000000
[ 358.651819] R13: dead000000000100 R14: ffff8b00b65a23c0 R15: 0ffff8b00b7a2200
[ 358.659790] FS: 0000000000000000(0000) GS:ffff8b00b7a00000(0000) knlGS:0000000000000000
[ 358.668820] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 358.675228] CR2: 00007f00aad90de0 CR3: 00000001ca80d000 CR4: 00000000001006f0
[ 358.683188] Call Trace:
[ 358.685918] switchdev\_port\_obj\_add\_deferred+0x13/0x60
[ 358.691655] switchdev\_deferred\_process+0x6b/0xf0
[ 358.696907] switchdev\_deferred\_process\_work+0xa/0x10
[ 358.702548] process\_one\_work+0x1f5/0x3f0
[ 358.707022] worker\_thread+0x28/0x3c0
[ 358.711099] ? process\_one\_work+0x3f0/0x3f0
[ 358.715768] kthread+0x10d/0x130
[ 358.719369] ? \_\_kthread\_create\_on\_node+0x180/0x180
[ 358.724815] ret\_from\_fork+0x35/0x40
Fixes: 3a49b4fde2a1 ("mlxsw: Adding layer 2 multicast support")
Signed-off-by: Ido Schimmel
Reported-by: Alex Kushnarov
Tested-by: Alex Kushnarov
Acked-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ed112abe6795d646db5445fd19016afc30a6ba18
Author: Eric Dumazet
Date: Sat Apr 13 17:32:21 2019 -0700
ipv4: ensure rcu\_read\_lock() in ipv4\_link\_failure()
[ Upstream commit c543cb4a5f07e09237ec0fc2c60c9f131b2c79ad ]
fib\_compute\_spec\_dst() needs to be called under rcu protection.
syzbot reported :
WARNING: suspicious RCU usage
5.1.0-rc4+ #165 Not tainted
include/linux/inetdevice.h:220 suspicious rcu\_dereference\_check() usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by swapper/0/0:
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: lockdep\_copy\_map include/linux/lockdep.h:170 [inline]
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: call\_timer\_fn+0xda/0x720 kernel/time/timer.c:1315
stack backtrace:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.1.0-rc4+ #165
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x172/0x1f0 lib/dump\_stack.c:113
lockdep\_rcu\_suspicious+0x153/0x15d kernel/locking/lockdep.c:5162
\_\_in\_dev\_get\_rcu include/linux/inetdevice.h:220 [inline]
fib\_compute\_spec\_dst+0xbbd/0x1030 net/ipv4/fib\_frontend.c:294
spec\_dst\_fill net/ipv4/ip\_options.c:245 [inline]
\_\_ip\_options\_compile+0x15a7/0x1a10 net/ipv4/ip\_options.c:343
ipv4\_link\_failure+0x172/0x400 net/ipv4/route.c:1195
dst\_link\_failure include/net/dst.h:427 [inline]
arp\_error\_report+0xd1/0x1c0 net/ipv4/arp.c:297
neigh\_invalidate+0x24b/0x570 net/core/neighbour.c:995
neigh\_timer\_handler+0xc35/0xf30 net/core/neighbour.c:1081
call\_timer\_fn+0x190/0x720 kernel/time/timer.c:1325
expire\_timers kernel/time/timer.c:1362 [inline]
\_\_run\_timers kernel/time/timer.c:1681 [inline]
\_\_run\_timers kernel/time/timer.c:1649 [inline]
run\_timer\_softirq+0x652/0x1700 kernel/time/timer.c:1694
\_\_do\_softirq+0x266/0x95a kernel/softirq.c:293
invoke\_softirq kernel/softirq.c:374 [inline]
irq\_exit+0x180/0x1d0 kernel/softirq.c:414
exiting\_irq arch/x86/include/asm/apic.h:536 [inline]
smp\_apic\_timer\_interrupt+0x14a/0x570 arch/x86/kernel/apic/apic.c:1062
apic\_timer\_interrupt+0xf/0x20 arch/x86/entry/entry\_64.S:807
Fixes: ed0de45a1008 ("ipv4: recompile ip options in ipv4\_link\_failure")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6bd1ee0a993fc9574ae43c1994c54a60cb23a380
Author: Stephen Suryaputra
Date: Fri Apr 12 16:19:27 2019 -0400
ipv4: recompile ip options in ipv4\_link\_failure
[ Upstream commit ed0de45a1008991fdaa27a0152befcb74d126a8b ]
Recompile IP options since IPCB may not be valid anymore when
ipv4\_link\_failure is called from arp\_error\_report.
Refer to the commit 3da1ed7ac398 ("net: avoid use IPCB in cipso\_v4\_error")
and the commit before that (9ef6b42ad6fd) for a similar issue.
Signed-off-by: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8cc6c4767e499c2a3e50b90cee4036a23839d7c9
Author: Jason Wang
Date: Tue Apr 9 12:10:25 2019 +0800
vhost: reject zero size iova range
[ Upstream commit 813dbeb656d6c90266f251d8bd2b02d445afa63f ]
We used to accept zero size iova range which will lead a infinite loop
in translate\_desc(). Fixing this by failing the request in this case.
Reported-by: syzbot+d21e6e297322a900c128@syzkaller.appspotmail.com
Fixes: 6b1e6cc7 ("vhost: new device IOTLB API")
Signed-off-by: Jason Wang
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e35fa001678806e1424c7469bebeced5c6c96478
Author: Hoang Le
Date: Tue Apr 9 14:59:24 2019 +0700
tipc: missing entries in name table of publications
[ Upstream commit d1841533e54876f152a30ac398a34f47ad6590b1 ]
When binding multiple services with specific type 1Ki, 2Ki..,
this leads to some entries in the name table of publications
missing when listed out via 'tipc name show'.
The problem is at identify zero last\_type conditional provided
via netlink. The first is initial 'type' when starting name table
dummping. The second is continuously with zero type (node state
service type). Then, lookup function failure to finding node state
service type in next iteration.
To solve this, adding more conditional to marked as dirty type and
lookup correct service type for the next iteration instead of select
the first service as initial 'type' zero.
Acked-by: Jon Maloy
Signed-off-by: Hoang Le
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit aad7db2b23c1275360ba8f5dff32ab36f8428bf1
Author: Hangbin Liu
Date: Mon Apr 8 16:45:17 2019 +0800
team: set slave to promisc if team is already in promisc mode
[ Upstream commit 43c2adb9df7ddd6560fd3546d925b42cef92daa0 ]
After adding a team interface to bridge, the team interface will enter
promisc mode. Then if we add a new slave to team0, the slave will keep
promisc off. Fix it by setting slave to promisc on if team master is
already in promisc mode, also do the same for allmulti.
v2: add promisc and allmulti checking when delete ports
Fixes: 3d249d4ca7d0 ("net: introduce ethernet teaming device")
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8aa965e92750828202567a26a0072f596d5e6d99
Author: Eric Dumazet
Date: Tue Apr 16 10:55:20 2019 -0700
tcp: tcp\_grow\_window() needs to respect tcp\_space()
[ Upstream commit 50ce163a72d817a99e8974222dcf2886d5deb1ae ]
For some reason, tcp\_grow\_window() correctly tests if enough room
is present before attempting to increase tp->rcv\_ssthresh,
but does not prevent it to grow past tcp\_space()
This is causing hard to debug issues, like failing
the (\_\_tcp\_select\_window(sk) >= tp->rcv\_wnd) test
in \_\_tcp\_ack\_snd\_check(), causing ACK delays and possibly
slow flows.
Depending on tcp\_rmem[2], MTU, skb->len/skb->truesize ratio,
we can see the problem happening on "netperf -t TCP\_RR -- -r 2000,2000"
after about 60 round trips, when the active side no longer sends
immediate acks.
This bug predates git history.
Signed-off-by: Eric Dumazet
Acked-by: Soheil Hassas Yeganeh
Acked-by: Neal Cardwell
Acked-by: Wei Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1274905c8e1b9cfb631fdb428307a6e55161d785
Author: Lorenzo Bianconi
Date: Tue Apr 9 11:47:20 2019 +0200
net: fou: do not use guehdr after iptunnel\_pull\_offloads in gue\_udp\_recv
[ Upstream commit 988dc4a9a3b66be75b30405a5494faf0dc7cffb6 ]
gue tunnels run iptunnel\_pull\_offloads on received skbs. This can
determine a possible use-after-free accessing guehdr pointer since
the packet will be 'uncloned' running pskb\_expand\_head if it is a
cloned gso skb (e.g if the packet has been sent though a veth device)
Fixes: a09a4c8dd1ec ("tunnels: Remove encapsulation offloads on decap")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 49f472ba481bcbd6f0c98345a08876b01a0f7b7d
Author: Yuya Kusakabe
Date: Tue Apr 16 10:22:28 2019 +0900
net: Fix missing meta data in skb with vlan packet
[ Upstream commit d85e8be2a5a02869f815dd0ac2d743deb4cd7957 ]
skb\_reorder\_vlan\_header() should move XDP meta data with ethernet header
if XDP meta data exists.
Fixes: de8f3a83b0a0 ("bpf: add meta pointer for direct access")
Signed-off-by: Yuya Kusakabe
Signed-off-by: Takeru Hayasaka
Co-developed-by: Takeru Hayasaka
Reviewed-by: Toshiaki Makita
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a7a3382b15648c792264f664eb2d4cecf9c622d5
Author: Andy Duan
Date: Tue Apr 9 03:40:56 2019 +0000
net: fec: manage ahb clock in runtime pm
[ Upstream commit d7c3a206e6338e4ccdf030719dec028e26a521d5 ]
Some SOC like i.MX6SX clock have some limits:
- ahb clock should be disabled before ipg.
- ahb and ipg clocks are required for MAC MII bus.
So, move the ahb clock to runtime management together with
ipg clock.
Signed-off-by: Fugang Duan
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 88f561ab1bd4915b67cadd960c7a7339473d3ed6
Author: Nikolay Aleksandrov
Date: Thu Apr 11 15:08:25 2019 +0300
net: bridge: multicast: use rcu to access port list from br\_multicast\_start\_querier
[ Upstream commit c5b493ce192bd7a4e7bd073b5685aad121eeef82 ]
br\_multicast\_start\_querier() walks over the port list but it can be
called from a timer with only multicast\_lock held which doesn't protect
the port list, so use RCU to walk over it.
Fixes: c83b8fab06fc ("bridge: Restart queries when last querier expires")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 88c58435304bc68a549b8a4db51b35f7dd887049
Author: Nikolay Aleksandrov
Date: Thu Apr 11 13:56:39 2019 +0300
net: bridge: fix per-port af\_packet sockets
[ Upstream commit 3b2e2904deb314cc77a2192f506f2fd44e3d10d0 ]
When the commit below was introduced it changed two visible things:
- the skb was no longer passed through the protocol handlers with the
original device
- the skb was passed up the stack with skb->dev = bridge
The first change broke af\_packet sockets on bridge ports. For example we
use them for hostapd which listens for ETH\_P\_PAE packets on the ports.
We discussed two possible fixes:
- create a clone and pass it through NF\_HOOK(), act on the original skb
based on the result
- somehow signal to the caller from the okfn() that it was called,
meaning the skb is ok to be passed, which this patch is trying to
implement via returning 1 from the bridge link-local okfn()
Note that we rely on the fact that NF\_QUEUE/STOLEN would return 0 and
drop/error would return < 0 thus the okfn() is called only when the
return was 1, so we signal to the caller that it was called by preserving
the return value from nf\_hook().
Fixes: 8626c56c8279 ("bridge: fix potential use-after-free when hook returns QUEUE or STOLEN verdict")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 11ba95c4503b09247b6940280aecd975ab842e4c
Author: Gustavo A. R. Silva
Date: Mon Apr 15 15:57:23 2019 -0500
net: atm: Fix potential Spectre v1 vulnerabilities
[ Upstream commit 899537b73557aafbdd11050b501cf54b4f5c45af ]
arg is controlled by user-space, hence leading to a potential
exploitation of the Spectre variant 1 vulnerability.
This issue was detected with the help of Smatch:
net/atm/lec.c:715 lec\_mcast\_attach() warn: potential spectre issue 'dev\_lec' [r] (local cap)
Fix this by sanitizing arg before using it to index dev\_lec.
Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].
[1] https://lore.kernel.org/lkml/20180423164740.GY17484@dhcp22.suse.cz/
Signed-off-by: Gustavo A. R. Silva
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b633f6580b6265d4d160cbfad39bd3abbfda0196
Author: Si-Wei Liu
Date: Mon Apr 8 19:45:27 2019 -0400
failover: allow name change on IFF\_UP slave interfaces
[ Upstream commit 8065a779f17e94536a1c4dcee4f9d88011672f97 ]
When a netdev appears through hot plug then gets enslaved by a failover
master that is already up and running, the slave will be opened
right away after getting enslaved. Today there's a race that userspace
(udev) may fail to rename the slave if the kernel (net\_failover)
opens the slave earlier than when the userspace rename happens.
Unlike bond or team, the primary slave of failover can't be renamed by
userspace ahead of time, since the kernel initiated auto-enslavement is
unable to, or rather, is never meant to be synchronized with the rename
request from userspace.
As the failover slave interfaces are not designed to be operated
directly by userspace apps: IP configuration, filter rules with
regard to network traffic passing and etc., should all be done on master
interface. In general, userspace apps only care about the
name of master interface, while slave names are less important as long
as admin users can see reliable names that may carry
other information describing the netdev. For e.g., they can infer that
"ens3nsby" is a standby slave of "ens3", while for a
name like "eth0" they can't tell which master it belongs to.
Historically the name of IFF\_UP interface can't be changed because
there might be admin script or management software that is already
relying on such behavior and assumes that the slave name can't be
changed once UP. But failover is special: with the in-kernel
auto-enslavement mechanism, the userspace expectation for device
enumeration and bring-up order is already broken. Previously initramfs
and various userspace config tools were modified to bypass failover
slaves because of auto-enslavement and duplicate MAC address. Similarly,
in case that users care about seeing reliable slave name, the new type
of failover slaves needs to be taken care of specifically in userspace
anyway.
It's less risky to lift up the rename restriction on failover slave
which is already UP. Although it's possible this change may potentially
break userspace component (most likely configuration scripts or
management software) that assumes slave name can't be changed while
UP, it's relatively a limited and controllable set among all userspace
components, which can be fixed specifically to listen for the rename
events on failover slaves. Userspace component interacting with slaves
is expected to be changed to operate on failover master interface
instead, as the failover slave is dynamic in nature which may come and
go at any point. The goal is to make the role of failover slaves less
relevant, and userspace components should only deal with failover master
in the long run.
Fixes: 30c8bd5aa8b2 ("net: Introduce generic failover module")
Signed-off-by: Si-Wei Liu
Reviewed-by: Liran Alon
Acked-by: Sridhar Samudrala
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7e2c712830d63c3f8c3691829cd19a40295856f1
Author: Sabrina Dubroca
Date: Fri Apr 12 15:04:10 2019 +0200
bonding: fix event handling for stacked bonds
[ Upstream commit 92480b3977fd3884649d404cbbaf839b70035699 ]
When a bond is enslaved to another bond, bond\_netdev\_event() only
handles the event as if the bond is a master, and skips treating the
bond as a slave.
This leads to a refcount leak on the slave, since we don't remove the
adjacency to its master and the master holds a reference on the slave.
Reproducer:
ip link add bondL type bond
ip link add bondU type bond
ip link set bondL master bondU
ip link del bondL
No "Fixes:" tag, this code is older than git history.
Signed-off-by: Sabrina Dubroca
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from access.redhat.com_1d8d65db_20250121_031232.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from security.netapp.com_41a9e947_20250121_010334.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [May 2020 Linux Kernel Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20200608-0001)

## May 2020 Linux Kernel Vulnerabilities in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20200608-0001 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20200608-0001 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20200608-0001 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20200608-0001 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20200608-0001
**Version:**
20.0

**Last updated:**
02/07/2023

**Status:**
Interim.

**CVEs:** CVE-2020-10711, CVE-2020-13143, CVE-2020-12888, CVE-2020-12826, CVE-2020-12771, CVE-2020-12770, CVE-2020-12769, CVE-2019-20794, CVE-2019-14898, CVE-2020-12659, CVE-2020-12657, CVE-2020-12655, CVE-2020-12653, CVE-2020-12654, CVE-2020-12652, CVE-2020-12114, CVE-2020-12465, CVE-2020-12464, CVE-2020-11884, CVE-2019-11599, CVE-2020-10690

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 5.7 are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2019-11599](https://nvd.nist.gov/vuln/detail/CVE-2019-11599) | 7.0 (HIGH) | CVSS:3.0/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-14898](https://nvd.nist.gov/vuln/detail/CVE-2019-14898) | 7.0 (HIGH) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-20794](https://nvd.nist.gov/vuln/detail/CVE-2019-20794) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-10690](https://nvd.nist.gov/vuln/detail/CVE-2020-10690) | 6.4 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-10711](https://nvd.nist.gov/vuln/detail/CVE-2020-10711) | 7.5 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-11884](https://nvd.nist.gov/vuln/detail/CVE-2020-11884) | 7.0 (HIGH) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12114](https://nvd.nist.gov/vuln/detail/CVE-2020-12114) | 4.7 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12464](https://nvd.nist.gov/vuln/detail/CVE-2020-12464) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12465](https://nvd.nist.gov/vuln/detail/CVE-2020-12465) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12652](https://nvd.nist.gov/vuln/detail/CVE-2020-12652) | 6.4 (MEDIUM) | CVSS:3.1/AV:L/AC:H/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12653](https://nvd.nist.gov/vuln/detail/CVE-2020-12653) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12654](https://nvd.nist.gov/vuln/detail/CVE-2020-12654) | 9.8 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12655](https://nvd.nist.gov/vuln/detail/CVE-2020-12655) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12657](https://nvd.nist.gov/vuln/detail/CVE-2020-12657) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12659](https://nvd.nist.gov/vuln/detail/CVE-2020-12659) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12769](https://nvd.nist.gov/vuln/detail/CVE-2020-12769) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12770](https://nvd.nist.gov/vuln/detail/CVE-2020-12770) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-12771](https://nvd.nist.gov/vuln/detail/CVE-2020-12771) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-12826](https://nvd.nist.gov/vuln/detail/CVE-2020-12826) | 8.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H |
| [CVE-2020-12888](https://nvd.nist.gov/vuln/detail/CVE-2020-12888) | 6.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:N/I:N/A:H |
| [CVE-2020-13143](https://nvd.nist.gov/vuln/detail/CVE-2020-13143) | 6.5 (MEDIUM) | CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

#### References

* <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.6.7>

Affected Products
#### Affected Products

* AFF Baseboard Management Controller (BMC) - A700s
* Active IQ Unified Manager for VMware vSphere
* NetApp Cloud Backup (formerly AltaVault)
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp SolidFire Baseboard Management Controller (BMC)
* NetApp SteelStore Cloud Integrated Storage

#### Products Not Affected

* 7-Mode Transition Tool
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Trident
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Insights Acquisition Unit
* Cloud Insights Telegraf Agent
* Cloud Secure Agent
* Cloud Volumes ONTAP Mediator
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Storage Manager
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Python SDK
* FAS/AFF BIOS - 8300/8700/A400
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400
* FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800
* FAS/AFF Service Processor - 8080/8060/8040/8020
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* Inventory Collect Tool
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* NetApp BlueXP
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Performance Analyzer
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SMI-S Provider
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp Storage Services Connector for SAP Landscape Management
* NetApp VASA Provider for Clustered Data ONTAP 9.7 and above
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* OnCommand Insight
* OnCommand Workflow Automation
* SAS Firmware
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* Storage Replication Adapter for Clustered Data ONTAP for VMware vSphere 9.7 and above
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID Baseboard Management Controller (BMC)
* StorageGRID9 (9.x and prior)
* System Manager 9.x
* Virtual Storage Console for VMware vSphere 9.7 and above

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.12> |
| **AFF Baseboard Management Controller (BMC) - A700s** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1323875. First fixed versions include the following: 1.87 |
| **NetApp Cloud Backup (formerly AltaVault)** | NetApp Cloud Backup (formerly AltaVault) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2880179.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H410C** | NetApp HCI Baseboard Management Controller (BMC) - H410C has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2884466.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610S** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle/downloads> <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/Storage_Firmware_Bundle/downloads> First fixed in storage firmware version 2.76. |
| **NetApp HCI Baseboard Management Controller (BMC) - H615C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp SolidFire & HCI Management Node** | <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/12.5> <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/1.10> |
| **NetApp SolidFire Baseboard Management Controller (BMC)** | NetApp SolidFire Baseboard Management Controller (BMC) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2847476.html%20) for more information. |
| **NetApp SteelStore Cloud Integrated Storage** | NetApp SteelStore Cloud Integrated Storage has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2397079.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20200608-0001>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20200608 | Initial Public Release |
| 2.0 | 20200611 | AFF Baseboard Management Controller (BMC) - A700s moved to Affected Products and Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 3.0 | 20200616 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above moved to Affected Products |
| 4.0 | 20200618 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above moved to Affected Products |
| 5.0 | 20200619 | After additional review FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved from Affected Products to Products Not Affected |
| 6.0 | 20200717 | NetApp Converged Systems Advisor Agent moved to Products Not Affected |
| 7.0 | 20200722 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 8.0 | 20200730 | NetApp HCI Baseboard Management Controller (BMC) - H610C, NetApp HCI Baseboard Management Controller (BMC) - H610S, and NetApp HCI Baseboard Management Controller (BMC) - H615C moved to Affected Products |
| 9.0 | 20200731 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S, and NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 10.0 | 20200901 | NetApp SteelStore Cloud Integrated Storage moved to Won't Fix status |
| 11.0 | 20210205 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 12.0 | 20210209 | NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Affected Products |
| 13.0 | 20210414 | NetApp HCI Baseboard Management Controller (BMC) - H610S added to Software Versions and Fixes |
| 14.0 | 20210816 | AFF Baseboard Management Controller (BMC) - A700s added to Software Versions and Fixes |
| 15.0 | 20211012 | NetApp HCI Baseboard Management Controller (BMC) - H410C and NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S moved to Won't Fix status |
| 16.0 | 20211101 | NetApp SolidFire Baseboard Management Controller (BMC) moved to Won't Fix status |
| 17.0 | 20220106 | NetApp Cloud Backup (formerly AltaVault) moved to Won't Fix status |
| 18.0 | 20220527 | NetApp SolidFire & HCI Management Node added to Software Versions and Fixes |
| 19.0 | 20220701 | NetApp HCI Baseboard Management Controller (BMC) - H610C and NetApp HCI Baseboard Management Controller (BMC) - H615C added to Software Versions and Fixes |
| 20.0 | 20230207 | Active IQ Unified Manager for VMware vSphere added to Software Versions and Fixes |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from access.redhat.com_a6c7b914_20250121_031231.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2025 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from cdn.kernel.org_a2db6c3f_20250121_010331.html ===
commit 19bb613acb9ad8e57593cad5118acaee117cc303
Author: Greg Kroah-Hartman
Date: Sat Apr 27 09:36:41 2019 +0200
Linux 4.19.37
commit cdd369fe0f98c29d01b310f7ee1c89e43eecbd8c
Author: Will Deacon
Date: Fri Apr 5 18:39:38 2019 -0700
kernel/sysctl.c: fix out-of-bounds access when setting file-max
commit 9002b21465fa4d829edfc94a5a441005cffaa972 upstream.
Commit 32a5ad9c2285 ("sysctl: handle overflow for file-max") hooked up
min/max values for the file-max sysctl parameter via the .extra1 and
.extra2 fields in the corresponding struct ctl\_table entry.
Unfortunately, the minimum value points at the global 'zero' variable,
which is an int. This results in a KASAN splat when accessed as a long
by proc\_doulongvec\_minmax on 64-bit architectures:
| BUG: KASAN: global-out-of-bounds in \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| Read of size 8 at addr ffff2000133d1c20 by task systemd/1
|
| CPU: 0 PID: 1 Comm: systemd Not tainted 5.1.0-rc3-00012-g40b114779944 #2
| Hardware name: linux,dummy-virt (DT)
| Call trace:
| dump\_backtrace+0x0/0x228
| show\_stack+0x14/0x20
| dump\_stack+0xe8/0x124
| print\_address\_description+0x60/0x258
| kasan\_report+0x140/0x1a0
| \_\_asan\_report\_load8\_noabort+0x18/0x20
| \_\_do\_proc\_doulongvec\_minmax+0x5d8/0x6a0
| proc\_doulongvec\_minmax+0x4c/0x78
| proc\_sys\_call\_handler.isra.19+0x144/0x1d8
| proc\_sys\_write+0x34/0x58
| \_\_vfs\_write+0x54/0xe8
| vfs\_write+0x124/0x3c0
| ksys\_write+0xbc/0x168
| \_\_arm64\_sys\_write+0x68/0x98
| el0\_svc\_common+0x100/0x258
| el0\_svc\_handler+0x48/0xc0
| el0\_svc+0x8/0xc
|
| The buggy address belongs to the variable:
| zero+0x0/0x40
|
| Memory state around the buggy address:
| ffff2000133d1b00: 00 00 00 00 00 00 00 00 fa fa fa fa 04 fa fa fa
| ffff2000133d1b80: fa fa fa fa 04 fa fa fa fa fa fa fa 04 fa fa fa
| >ffff2000133d1c00: fa fa fa fa 04 fa fa fa fa fa fa fa 00 00 00 00
| ^
| ffff2000133d1c80: fa fa fa fa 00 fa fa fa fa fa fa fa 00 00 00 00
| ffff2000133d1d00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Fix the splat by introducing a unsigned long 'zero\_ul' and using that
instead.
Link: http://lkml.kernel.org/r/20190403153409.17307-1-will.deacon@arm.com
Fixes: 32a5ad9c2285 ("sysctl: handle overflow for file-max")
Signed-off-by: Will Deacon
Acked-by: Christian Brauner
Cc: Kees Cook
Cc: Alexey Dobriyan
Cc: Matteo Croce
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ac54bc121e1f491b70d71ac234b8e0f76f79d7ad
Author: Greg Kroah-Hartman
Date: Thu Apr 25 10:00:43 2019 +0200
Revert "locking/lockdep: Add debug\_locks check in \_\_lock\_downgrade()"
This reverts commit 0e0f7b30721233ce610bde2395a8e58ff7771475 which was
commit 71492580571467fb7177aade19c18ce7486267f5 upstream.
Tetsuo rightly points out that the backport here is incorrect, as it
touches the \_\_lock\_set\_class function instead of the intended
\_\_lock\_downgrade function.
Reported-by: Tetsuo Handa
Cc: Waiman Long
Cc: Peter Zijlstra (Intel)
Cc: Andrew Morton
Cc: Linus Torvalds
Cc: Paul E. McKenney
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: Will Deacon
Cc: Ingo Molnar
Cc: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit 9c1862566176250bae343a5cee617a5ce41efa54
Author: Linus Torvalds
Date: Sat Oct 27 09:10:48 2018 -0700
i2c-hid: properly terminate i2c\_hid\_dmi\_desc\_override\_table[] array
commit b59dfdaef173677b0b7e10f375226c0a1114fd20 upstream.
Commit 9ee3e06610fd ("HID: i2c-hid: override HID descriptors for certain
devices") added a new dmi\_system\_id quirk table to override certain HID
report descriptors for some systems that lack them.
But the table wasn't properly terminated, causing the dmi matching to
walk off into la-la-land, and starting to treat random data as dmi
descriptor pointers, causing boot-time oopses if you were at all
unlucky.
Terminate the array.
We really should have some way to just statically check that arrays that
should be terminated by an empty entry actually are so. But the HID
people really should have caught this themselves, rather than have me
deal with an oops during the merge window. Tssk, tssk.
Cc: Julian Sax
Cc: Benjamin Tissoires
Cc: Jiri Kosina
Signed-off-by: Linus Torvalds
Cc: Ambrož Bizjak
Signed-off-by: Greg Kroah-Hartman
commit 52dde1160f17c42bca85f1365227a69b2c6aa9e8
Author: Katsuhiro Suzuki
Date: Tue Sep 11 01:39:32 2018 +0900
ASoC: rockchip: add missing INTERLEAVED PCM attribute
commit 24d6638302b48328a58c13439276d4531af4ca7d upstream.
This patch adds SNDRV\_PCM\_INFO\_INTERLEAVED into PCM hardware info.
Signed-off-by: Katsuhiro Suzuki
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit a782f8475715d6dc61f892127d4fb8e5f0775ac4
Author: Arnaldo Carvalho de Melo
Date: Tue Sep 25 10:55:59 2018 -0300
tools include: Adopt linux/bits.h
commit ba4aa02b417f08a0bee5e7b8ed70cac788a7c854 upstream.
So that we reduce the difference of tools/include/linux/bitops.h to the
original kernel file, include/linux/bitops.h, trying to remove the need
to define BITS\_PER\_LONG, to avoid clashes with asm/bitsperlong.h.
And the things removed from tools/include/linux/bitops.h are really in
linux/bits.h, so that we can have a copy and then
tools/perf/check\_headers.sh will tell us when new stuff gets added to
linux/bits.h so that we can check if it is useful and if any adjustment
needs to be done to the tools/{include,arch}/ copies.
Cc: Adrian Hunter
Cc: Alexander Sverdlin
Cc: David Ahern
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Wang Nan
Link: https://lkml.kernel.org/n/tip-y1sqyydvfzo0bjjoj4zsl562@git.kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 6580376fe81093d3a796b7e8b8c3c0f9e620f89c
Author: Matteo Croce
Date: Mon Mar 18 02:32:36 2019 +0100
percpu: stop printing kernel addresses
commit 00206a69ee32f03e6f40837684dcbe475ea02266 upstream.
Since commit ad67b74d2469d9b8 ("printk: hash addresses printed with %p"),
at boot "\_\_\_\_ptrval\_\_\_\_" is printed instead of actual addresses:
percpu: Embedded 38 pages/cpu @(\_\_\_\_ptrval\_\_\_\_) s124376 r0 d31272 u524288
Instead of changing the print to "%px", and leaking kernel addresses,
just remove the print completely, cfr. e.g. commit 071929dbdd865f77
("arm64: Stop printing the virtual memory layout").
Signed-off-by: Matteo Croce
Signed-off-by: Dennis Zhou
Signed-off-by: Greg Kroah-Hartman
commit 8a6f2ea0c3dd3de75cc344fe8d216457287a2ab2
Author: Takashi Iwai
Date: Tue Apr 16 15:25:00 2019 +0200
ALSA: info: Fix racy addition/deletion of nodes
commit 8c2f870890fd28e023b0fcf49dcee333f2c8bad7 upstream.
The ALSA proc helper manages the child nodes in a linked list, but its
addition and deletion is done without any lock. This leads to a
corruption if they are operated concurrently. Usually this isn't a
problem because the proc entries are added sequentially in the driver
probe procedure itself. But the card registrations are done often
asynchronously, and the crash could be actually reproduced with
syzkaller.
This patch papers over it by protecting the link addition and deletion
with the parent's mutex. There is "access" mutex that is used for the
file access, and this can be reused for this purpose as well.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 1343fd8f9629ef1e040bdb84626ae69382272741
Author: Konstantin Khlebnikov
Date: Thu Apr 18 17:50:20 2019 -0700
mm/vmstat.c: fix /proc/vmstat format for CONFIG\_DEBUG\_TLBFLUSH=y CONFIG\_SMP=n
commit e8277b3b52240ec1caad8e6df278863e4bf42eac upstream.
Commit 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
depends on skipping vmstat entries with empty name introduced in
7aaf77272358 ("mm: don't show nr\_indirectly\_reclaimable in
/proc/vmstat") but reverted in b29940c1abd7 ("mm: rename and change
semantics of nr\_indirectly\_reclaimable\_bytes").
So skipping no longer works and /proc/vmstat has misformatted lines " 0".
This patch simply shows debug counters "nr\_tlb\_remote\_\*" for UP.
Link: http://lkml.kernel.org/r/155481488468.467.4295519102880913454.stgit@buzz
Fixes: 58bc4c34d249 ("mm/vmstat.c: skip NR\_TLB\_REMOTE\_FLUSH\* properly")
Signed-off-by: Konstantin Khlebnikov
Acked-by: Vlastimil Babka
Cc: Roman Gushchin
Cc: Jann Horn
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 628c99a836dde71a4e415859359b7ebecdb3d363
Author: Jann Horn
Date: Tue Mar 19 02:36:59 2019 +0100
device\_cgroup: fix RCU imbalance in error case
commit 0fcc4c8c044e117ac126ab6df4138ea9a67fa2a9 upstream.
When dev\_exception\_add() returns an error (due to a failed memory
allocation), make sure that we move the RCU preemption count back to where
it was before we were called. We dropped the RCU read lock inside the loop
body, so we can't just "break".
sparse complains about this, too:
$ make -s C=2 security/device\_cgroup.o
./include/linux/rcupdate.h:647:9: warning: context imbalance in
'propagate\_exception' - unexpected unlock
Fixes: d591fb56618f ("device\_cgroup: simplify cgroup tree walk in propagate\_exception()")
Cc: stable@vger.kernel.org
Signed-off-by: Jann Horn
Acked-by: Michal Hocko
Signed-off-by: Tejun Heo
Signed-off-by: Greg Kroah-Hartman
commit c3edd427d5389ca46734c343662cdba1b3048f12
Author: Phil Auld
Date: Tue Apr 23 19:51:06 2019 -0400
sched/fair: Limit sched\_cfs\_period\_timer() loop to avoid hard lockup
[ Upstream commit 2e8e19226398db8265a8e675fcc0118b9e80c9e8 ]
With extremely short cfs\_period\_us setting on a parent task group with a large
number of children the for loop in sched\_cfs\_period\_timer() can run until the
watchdog fires. There is no guarantee that the call to hrtimer\_forward\_now()
will ever return 0. The large number of children can make
do\_sched\_cfs\_period\_timer() take longer than the period.
NMI watchdog: Watchdog detected hard LOCKUP on cpu 24
RIP: 0010:tg\_nop+0x0/0x10
walk\_tg\_tree\_from+0x29/0xb0
unthrottle\_cfs\_rq+0xe0/0x1a0
distribute\_cfs\_runtime+0xd3/0xf0
sched\_cfs\_period\_timer+0xcb/0x160
? sched\_cfs\_slack\_timer+0xd0/0xd0
\_\_hrtimer\_run\_queues+0xfb/0x270
hrtimer\_interrupt+0x122/0x270
smp\_apic\_timer\_interrupt+0x6a/0x140
apic\_timer\_interrupt+0xf/0x20

To prevent this we add protection to the loop that detects when the loop has run
too many times and scales the period and quota up, proportionally, so that the timer
can complete before then next period expires. This preserves the relative runtime
quota while preventing the hard lockup.
A warning is issued reporting this state and the new values.
Signed-off-by: Phil Auld
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Anton Blanchard
Cc: Ben Segall
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Link: https://lkml.kernel.org/r/20190319130005.25492-1-pauld@redhat.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit c21bcc2352e954202798588c41cd76c43073d207
Author: Matthias Kaehlcke
Date: Tue Apr 23 12:04:23 2019 -0700
Revert "kbuild: use -Oz instead of -Os when using clang"
commit a75bb4eb9e565b9f5115e2e8c07377ce32cbe69a upstream.
The clang option -Oz enables \*aggressive\* optimization for size,
which doesn't necessarily result in smaller images, but can have
negative impact on performance. Switch back to the less aggressive
-Os.
This reverts commit 6748cb3c299de1ffbe56733647b01dbcc398c419.
Suggested-by: Peter Zijlstra
Signed-off-by: Matthias Kaehlcke
Reviewed-by: Nick Desaulniers
Signed-off-by: Masahiro Yamada
Signed-off-by: Nathan Chancellor
Signed-off-by: Sasha Levin
commit 1c36862e8be8e45094024e7384a7b441779f34cb
Author: Yue Haibing
Date: Tue Apr 23 16:05:18 2019 +0300
tpm: Fix the type of the return value in calc\_tpm2\_event\_size()
commit b9d0a85d6b2e76630cfd4c475ee3af4109bfd87a upstream
calc\_tpm2\_event\_size() has an invalid signature because
it returns a 'size\_t' where as its signature says that
it returns 'int'.
Cc:
Fixes: 4d23cc323cdb ("tpm: add securityfs support for TPM 2.0 firmware event log")
Suggested-by: Jarkko Sakkinen
Signed-off-by: Yue Haibing
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: James Morris
Signed-off-by: Sasha Levin
commit 18af9b7b91380825ac398ff3b94fac4e0621c5cc
Author: Jarkko Sakkinen
Date: Fri Feb 8 18:30:59 2019 +0200
tpm/tpm\_i2c\_atmel: Return -E2BIG when the transfer is incomplete
[ Upstream commit 442601e87a4769a8daba4976ec3afa5222ca211d ]
Return -E2BIG when the transfer is incomplete. The upper layer does
not retry, so not doing that is incorrect behaviour.
Cc: stable@vger.kernel.org
Fixes: a2871c62e186 ("tpm: Add support for Atmel I2C TPMs")
Signed-off-by: Jarkko Sakkinen
Reviewed-by: Stefan Berger
Reviewed-by: Jerry Snitselaar
Signed-off-by: Sasha Levin
commit 7de43cb71116ab13adaf1f57a72edb6757ca57d0
Author: Masahiro Yamada
Date: Thu Nov 22 13:28:42 2018 +0900
modpost: file2alias: check prototype of handler
[ Upstream commit f880eea68fe593342fa6e09be9bb661f3c297aec ]
Use specific prototype instead of an opaque pointer so that the
compiler can catch function prototype mismatch.
Signed-off-by: Masahiro Yamada
Reviewed-by: Mathieu Malaterre
Signed-off-by: Sasha Levin
commit aa0e8cc9d7a89bb0c23435ec1b62eac46b1f4984
Author: Masahiro Yamada
Date: Thu Nov 22 13:28:41 2018 +0900
modpost: file2alias: go back to simple devtable lookup
[ Upstream commit ec91e78d378cc5d4b43805a1227d8e04e5dfa17d ]
Commit e49ce14150c6 ("modpost: use linker section to generate table.")
was not so cool as we had expected first; it ended up with ugly section
hacks when commit dd2a3acaecd7 ("mod/file2alias: make modpost compile
on darwin again") came in.
Given a certain degree of unknowledge about the link stage of host
programs, I really want to see simple, stupid table lookup so that
this works in the same way regardless of the underlying executable
format.
Signed-off-by: Masahiro Yamada
Acked-by: Mathieu Malaterre
Signed-off-by: Sasha Levin
commit 87eadc0b8c2a574c3e48aa0d15e1318a6a24f654
Author: Adrian Hunter
Date: Thu Nov 15 15:53:43 2018 +0200
mmc: sdhci: Handle auto-command errors
[ Upstream commit af849c86109d79222e549826068bbf4e7f9a2472 ]
If the host controller supports auto-commands then enable the auto-command
error interrupt and handle it. In the case of auto-CMD23, the error is
treated the same as manual CMD23 error. In the case of auto-CMD12,
commands-during-transfer are not permitted, so the error handling is
treated the same as a data error.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit ba8a6c055677ef22c43fd31b6ac0b27998be36f9
Author: Adrian Hunter
Date: Thu Nov 15 15:53:42 2018 +0200
mmc: sdhci: Rename SDHCI\_ACMD12\_ERR and SDHCI\_INT\_ACMD12ERR
[ Upstream commit 869f8a69bb3a4aec4eb914a330d4ba53a9eed495 ]
The SDHCI\_ACMD12\_ERR register is used for auto-CMD23 and auto-CMD12
errors, as is the SDHCI\_INT\_ACMD12ERR interrupt bit. Rename them to
SDHCI\_AUTO\_CMD\_STATUS and SDHCI\_INT\_AUTO\_CMD\_ERR respectively.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit b2be40b73b29921e5c7f2e3a11ceaa31c508326c
Author: Adrian Hunter
Date: Thu Nov 15 15:53:41 2018 +0200
mmc: sdhci: Fix data command CRC error handling
[ Upstream commit 4bf780996669280171c9cd58196512849b93434e ]
Existing data command CRC error handling is non-standard and does not work
with some Intel host controllers. Specifically, the assumption that the host
controller will continue operating normally after the error interrupt,
is not valid. Change the driver to handle the error in the same manner
as a data CRC error, taking care to ensure that the data line reset is
done for single or multi-block transfers, and it is done before
unmapping DMA.
Signed-off-by: Adrian Hunter
Signed-off-by: Ulf Hansson
Signed-off-by: Sasha Levin
commit be608583d9c4910877d7553d4240e998818c2d70
Author: Dan Williams
Date: Mon Apr 22 16:08:26 2019 -0700
nfit/ars: Avoid stale ARS results
commit 78153dd45e7e0596ba32b15d02bda08e1513111e upstream.
Gate ARS result consumption on whether the OS issued start-ARS since the
previous consumption. The BIOS may only clear its result buffers after a
successful start-ARS.
Fixes: 0caeef63e6d2 ("libnvdimm: Add a poison list and export badblocks")
Cc:
Reported-by: Krzysztof Rusocki
Reported-by: Vishal Verma
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 40221d56ae28eb0b3e86a482063b0e303903e397
Author: Dan Williams
Date: Mon Apr 22 16:08:21 2019 -0700
nfit/ars: Allow root to busy-poll the ARS state machine
commit 5479b2757f26fe9908fc341d105b2097fe820b6f upstream.
The ARS implementation implements exponential back-off on the poll
interval to prevent high-frequency access to the DIMM / platform
interface. Depending on when the ARS completes the poll interval may
exceed the completion event by minutes. Allow root to reset the timeout
each time it probes the status. A one-second timeout is still enforced,
but root can otherwise can control the poll interval.
Fixes: bc6ba8085842 ("nfit, address-range-scrub: rework and simplify ARS...")
Cc:
Reported-by: Erwin Tsaur
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit bc18c2593635364f0c71f76f8fc395bee33954ab
Author: Dan Williams
Date: Mon Apr 22 16:08:16 2019 -0700
nfit/ars: Introduce scrub\_flags
commit e34b8252a3d2893ca55c82dbfcdaa302fa03d400 upstream.
In preparation for introducing new flags to gate whether ARS results are
stale, or poll the completion state, convert the existing flags to an
unsigned long with enumerated values. This conversion allows the flags
to be atomically updated outside of ->init\_mutex.
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit 82a13a006ed5412fd817419e60113b7c922b21ff
Author: Dan Williams
Date: Mon Apr 22 16:08:10 2019 -0700
nfit/ars: Remove ars\_start\_flags
commit 317a992ab9266b86b774b9f6b0f87eb4f59879a1 upstream.
The ars\_start\_flags property of 'struct acpi\_nfit\_desc' is no longer
used since ARS\_REQ\_SHORT and ARS\_REQ\_LONG were added.
Reviewed-by: Toshi Kani
Signed-off-by: Dan Williams
Signed-off-by: Sasha Levin
commit cd37fd46b4857a787571c3153bfa64d0ae28a407
Author: Chang-An Chen
Date: Fri Mar 29 10:59:09 2019 +0800
timers/sched\_clock: Prevent generic sched\_clock wrap caused by tick\_freeze()
commit 3f2552f7e9c5abef2775c53f7af66532f8bf65bc upstream.
tick\_freeze() introduced by suspend-to-idle in commit 124cf9117c5f ("PM /
sleep: Make it possible to quiesce timers during suspend-to-idle") uses
timekeeping\_suspend() instead of syscore\_suspend() during
suspend-to-idle. As a consequence generic sched\_clock will keep going
because sched\_clock\_suspend() and sched\_clock\_resume() are not invoked
during suspend-to-idle which can result in a generic sched\_clock wrap.
On a ARM system with suspend-to-idle enabled, sched\_clock is registered
as "56 bits at 13MHz, resolution 76ns, wraps every 4398046511101ns", which
means the real wrapping duration is 8796093022202ns.
[ 134.551779] suspend-to-idle suspend (timekeeping\_suspend())
[ 1204.912239] suspend-to-idle resume (timekeeping\_resume())
......
[ 1206.912239] suspend-to-idle suspend (timekeeping\_suspend())
[ 5880.502807] suspend-to-idle resume (timekeeping\_resume())
......
[ 6000.403724] suspend-to-idle suspend (timekeeping\_suspend())
[ 8035.753167] suspend-to-idle resume (timekeeping\_resume())
......
[ 8795.786684] (2)[321:charger\_thread]......
[ 8795.788387] (2)[321:charger\_thread]......
[ 0.057226] (0)[0:swapper/0]......
[ 0.061447] (2)[0:swapper/2]......
sched\_clock was not stopped during suspend-to-idle, and sched\_clock\_poll
hrtimer was not expired because timekeeping\_suspend() was invoked during
suspend-to-idle. It makes sched\_clock wrap at kernel time 8796s.
To prevent this, invoke sched\_clock\_suspend() and sched\_clock\_resume() in
tick\_freeze() together with timekeeping\_suspend() and timekeeping\_resume().
Fixes: 124cf9117c5f (PM / sleep: Make it possible to quiesce timers during suspend-to-idle)
Signed-off-by: Chang-An Chen
Signed-off-by: Thomas Gleixner
Cc: Frederic Weisbecker
Cc: Matthias Brugger
Cc: John Stultz
Cc: Kees Cook
Cc: Corey Minyard
Cc:
Cc:
Cc: Stanley Chu
Cc:
Cc:
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/1553828349-8914-1-git-send-email-chang-an.chen@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit 5680b0635cdab1a1afb4f2078226584e008008b0
Author: Thomas Gleixner
Date: Sun Apr 14 19:51:06 2019 +0200
x86/speculation: Prevent deadlock on ssb\_state::lock
commit 2f5fb19341883bb6e37da351bc3700489d8506a7 upstream.
Mikhail reported a lockdep splat related to the AMD specific ssb\_state
lock:
CPU0 CPU1
lock(&st->lock);
local\_irq\_disable();
lock(&(&sighand->siglock)->rlock);
lock(&st->lock);
lock(&(&sighand->siglock)->rlock);
\*\*\* DEADLOCK \*\*\*
The connection between sighand->siglock and st->lock comes through seccomp,
which takes st->lock while holding sighand->siglock.
Make sure interrupts are disabled when \_\_speculation\_ctrl\_update() is
invoked via prctl() -> speculation\_ctrl\_update(). Add a lockdep assert to
catch future offenders.
Fixes: 1f50ddb4f418 ("x86/speculation: Handle HT correctly on AMD")
Reported-by: Mikhail Gavrilov
Signed-off-by: Thomas Gleixner
Tested-by: Mikhail Gavrilov
Cc: Thomas Lendacky
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/alpine.DEB.2.21.1904141948200.4917@nanos.tec.linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 90e17512f1e43a67008082d0380bdc8a689c6c9b
Author: Kan Liang
Date: Tue Apr 2 12:44:58 2019 -0700
perf/x86: Fix incorrect PEBS\_REGS
commit 9d5dcc93a6ddfc78124f006ccd3637ce070ef2fc upstream.
PEBS\_REGS used as mask for the supported registers for large PEBS.
However, the mask cannot filter the sample\_regs\_user/sample\_regs\_intr
correctly.
(1ULL << PERF\_REG\_X86\_\*) should be used to replace PERF\_REG\_X86\_\*, which
is only the index.
Rename PEBS\_REGS to PEBS\_GP\_REGS, because the mask is only for general
purpose registers.
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc:
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Cc: acme@kernel.org
Cc: jolsa@kernel.org
Fixes: 2fe1bc1f501d ("perf/x86: Enable free running PEBS for REGS\_USER/INTR")
Link: https://lkml.kernel.org/r/20190402194509.2832-2-kan.liang@linux.intel.com
[ Renamed it to PEBS\_GP\_REGS - as 'GPRS' is used elsewhere ;-) ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 293926b37013c0b9204d110eaaad9a4a5467d24b
Author: Andi Kleen
Date: Fri Mar 29 17:47:43 2019 -0700
x86/cpu/bugs: Use \_\_initconst for 'const' init data
commit 1de7edbb59c8f1b46071f66c5c97b8a59569eb51 upstream.
Some of the recently added const tables use \_\_initdata which causes section
attribute conflicts.
Use \_\_initconst instead.
Fixes: fa1202ef2243 ("x86/speculation: Add command line control")
Signed-off-by: Andi Kleen
Signed-off-by: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20190330004743.29541-9-andi@firstfloor.org
Signed-off-by: Greg Kroah-Hartman
commit f45829e6250a84350e38402cc4dc2b5e3a9ea82e
Author: Kim Phillips
Date: Thu Mar 21 21:15:22 2019 +0000
perf/x86/amd: Add event map for AMD Family 17h
commit 3fe3331bb285700ab2253dbb07f8e478fcea2f1b upstream.
Family 17h differs from prior families by:
- Does not support an L2 cache miss event
- It has re-enumerated PMC counters for:
- L2 cache references
- front & back end stalled cycles
So we add a new amd\_f17h\_perfmon\_event\_map[] so that the generic
perf event names will resolve to the correct h/w events on
family 17h and above processors.
Reference sections 2.1.13.3.3 (stalls) and 2.1.13.3.6 (L2):
https://www.amd.com/system/files/TechDocs/54945\_PPR\_Family\_17h\_Models\_00h-0Fh.pdf
Signed-off-by: Kim Phillips
Cc:  # v4.9+
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: H. Peter Anvin
Cc: Janakarajan Natarajan
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Martin Liška
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Pu Wen
Cc: Suravee Suthikulpanit
Cc: Thomas Gleixner
Cc: linux-kernel@vger.kernel.org
Fixes: e40ed1542dd7 ("perf/x86: Add perf support for AMD family-17h processors")
[ Improved the formatting a bit. ]
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit ba407222f563af8cfc69c5ae5607899a039f8be2
Author: Alex Deucher
Date: Thu Apr 11 14:54:40 2019 -0500
drm/amdgpu/gmc9: fix VM\_L2\_CNTL3 programming
commit 1925e7d3d4677e681cc2e878c2bdbeaee988c8e2 upstream.
Got accidently dropped when 2+1 level support was added.
Fixes: 6a42fd6fbf534096 ("drm/amdgpu: implement 2+1 PD support for Raven v3")
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 39cad03c4360b72d4d4adda4be1b718c24d0af44
Author: Felix Fietkau
Date: Fri Mar 1 14:48:37 2019 +0100
mac80211: do not call driver wake\_tx\_queue op during reconfig
commit 4856bfd230985e43e84c26473c91028ff0a533bd upstream.
There are several scenarios in which mac80211 can call drv\_wake\_tx\_queue
after ieee80211\_restart\_hw has been called and has not yet completed.
Driver private structs are considered uninitialized until mac80211 has
uploaded the vifs, stations and keys again, so using private tx queue
data during that time is not safe.
The driver can also not rely on drv\_reconfig\_complete to figure out when
it is safe to accept drv\_wake\_tx\_queue calls again, because it is only
called after all tx queues are woken again.
To fix this, bail out early in drv\_wake\_tx\_queue if local->in\_reconfig
is set.
Cc: stable@vger.kernel.org
Signed-off-by: Felix Fietkau
Signed-off-by: Johannes Berg
Signed-off-by: Greg Kroah-Hartman
commit 852de0d53d1443404b00c6e7dc6f15adc68aec1d
Author: Vijayakumar Durai
Date: Wed Mar 27 11:03:17 2019 +0100
rt2x00: do not increment sequence number while re-transmitting
commit 746ba11f170603bf1eaade817553a6c2e9135bbe upstream.
Currently rt2x00 devices retransmit the management frames with
incremented sequence number if hardware is assigning the sequence.
This is HW bug fixed already for non-QOS data frames, but it should
be fixed for management frames except beacon.
Without fix retransmitted frames have wrong SN:
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1648, FN=0, Flags=........C Frame is not being retransmitted 1648 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1649, FN=0, Flags=....R...C Frame is being retransmitted 1649 1
AlphaNet\_e8:fb:36 Vivotek\_52:31:51 Authentication, SN=1650, FN=0, Flags=....R...C Frame is being retransmitted 1650 1
With the fix SN stays correctly the same:
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=........C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
88:6a:e3:e8:f9:a2 8c:f5:a3:88:76:87 Authentication, SN=1450, FN=0, Flags=....R...C
Cc: stable@vger.kernel.org
Signed-off-by: Vijayakumar Durai
[sgruszka: simplify code, change comments and changelog]
Signed-off-by: Stanislaw Gruszka
Signed-off-by: Kalle Valo
Signed-off-by: Greg Kroah-Hartman
commit 23a926e5edd940b7311e0c511caa4b45eaf6b59f
Author: Masami Hiramatsu
Date: Mon Apr 15 15:01:25 2019 +0900
kprobes: Fix error check when reusing optimized probes
commit 5f843ed415581cfad4ef8fefe31c138a8346ca8a upstream.
The following commit introduced a bug in one of our error paths:
819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
it missed to handle the return value of kprobe\_optready() as
error-value. In reality, the kprobe\_optready() returns a bool
result, so "true" case must be passed instead of 0.
This causes some errors on kprobe boot-time selftests on ARM:
[ ] Beginning kprobe tests...
[ ] Probe ARM code
[ ] kprobe
[ ] kretprobe
[ ] ARM instruction simulation
[ ] Check decoding tables
[ ] Run test cases
[ ] FAIL: test\_case\_handler not run
[ ] FAIL: Test andge r10, r11, r14, asr r7
[ ] FAIL: Scenario 11
...
[ ] FAIL: Scenario 7
[ ] Total instruction simulation tests=1631, pass=1433 fail=198
[ ] kprobe tests failed
This can happen if an optimized probe is unregistered and next
kprobe is registered on same address until the previous probe
is not reclaimed.
If this happens, a hidden aggregated probe may be kept in memory,
and no new kprobe can probe same address. Also, in that case
register\_kprobe() will return "1" instead of minus error value,
which can mislead caller logic.
Signed-off-by: Masami Hiramatsu
Cc: Anil S Keshavamurthy
Cc: David S . Miller
Cc: Linus Torvalds
Cc: Naveen N . Rao
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org # v5.0+
Fixes: 819319fc9346 ("kprobes: Return error if we fail to reuse kprobe instead of BUG\_ON()")
Link: http://lkml.kernel.org/r/155530808559.32517.539898325433642204.stgit@devnote2
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 426e2a8024c23b3a664250b46e2ab0604c0a0a09
Author: Masami Hiramatsu
Date: Sun Feb 24 01:50:20 2019 +0900
kprobes: Mark ftrace mcount handler functions nokprobe
commit fabe38ab6b2bd9418350284c63825f13b8a6abba upstream.
Mark ftrace mcount handler functions nokprobe since
probing on these functions with kretprobe pushes
return address incorrectly on kretprobe shadow stack.
Reported-by: Francis Deslauriers
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Acked-by: Steven Rostedt (VMware)
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094062044.6137.6419622920568680640.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 1fab567a270b8fb2f2b80c00b5c8c8106d377be8
Author: Masami Hiramatsu
Date: Sun Feb 24 01:49:52 2019 +0900
x86/kprobes: Verify stack frame on kretprobe
commit 3ff9c075cc767b3060bdac12da72fc94dd7da1b8 upstream.
Verify the stack frame pointer on kretprobe trampoline handler,
If the stack frame pointer does not match, it skips the wrong
entry and tries to find correct one.
This can happen if user puts the kretprobe on the function
which can be used in the path of ftrace user-function call.
Such functions should not be probed, so this adds a warning
message that reports which function should be blacklisted.
Tested-by: Andrea Righi
Signed-off-by: Masami Hiramatsu
Acked-by: Steven Rostedt
Cc: Linus Torvalds
Cc: Mathieu Desnoyers
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/155094059185.6137.15527904013362842072.stgit@devbox
Signed-off-by: Ingo Molnar
Signed-off-by: Greg Kroah-Hartman
commit 5105fc758bdc4f7bb330248f1e2d2ea3b704421d
Author: Nathan Chancellor
Date: Wed Apr 17 00:21:21 2019 -0700
arm64: futex: Restore oldval initialization to work around buggy compilers
commit ff8acf929014b7f87315588e0daf8597c8aa9d1c upstream.
Commit 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with
non-zero result value") removed oldval's zero initialization in
arch\_futex\_atomic\_op\_inuser because it is not necessary. Unfortunately,
Android's arm64 GCC 4.9.4 [1] does not agree:
../kernel/futex.c: In function 'do\_futex':
../kernel/futex.c:1658:17: warning: 'oldval' may be used uninitialized
in this function [-Wmaybe-uninitialized]
return oldval == cmparg;
^
In file included from ../kernel/futex.c:73:0:
../arch/arm64/include/asm/futex.h:53:6: note: 'oldval' was declared here
int oldval, ret, tmp;
^
GCC fails to follow that when ret is non-zero, futex\_atomic\_op\_inuser
returns right away, avoiding the uninitialized use that it claims.
Restoring the zero initialization works around this issue.
[1]: https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/
Cc: stable@vger.kernel.org
Fixes: 045afc24124d ("arm64: futex: Fix FUTEX\_WAKE\_OP atomic ops with non-zero result value")
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Nathan Chancellor
Signed-off-by: Catalin Marinas
Signed-off-by: Greg Kroah-Hartman
commit 96800ba9e565ab752774cd88328f96aed28a1436
Author: Christian König
Date: Tue Apr 2 09:26:52 2019 +0200
drm/ttm: fix out-of-bounds read in ttm\_put\_pages() v2
commit a66477b0efe511d98dde3e4aaeb189790e6f0a39 upstream.
When ttm\_put\_pages() tries to figure out whether it's dealing with
transparent hugepages, it just reads past the bounds of the pages array
without a check.
v2: simplify the test if enough pages are left in the array (Christian).
Signed-off-by: Jann Horn
Signed-off-by: Christian König
Fixes: 5c42c64f7d54 ("drm/ttm: fix the fix for huge compound pages")
Cc: stable@vger.kernel.org
Reviewed-by: Michel Dänzer
Reviewed-by: Junwei Zhang
Reviewed-by: Huang Rui
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit fbe5cff932295f2468524bf6ffe109a9d0849178
Author: Eric Biggers
Date: Sun Mar 31 13:04:11 2019 -0700
crypto: x86/poly1305 - fix overflow during partial reduction
commit 678cce4019d746da6c680c48ba9e6d417803e127 upstream.
The x86\_64 implementation of Poly1305 produces the wrong result on some
inputs because poly1305\_4block\_avx2() incorrectly assumes that when
partially reducing the accumulator, the bits carried from limb 'd4' to
limb 'h0' fit in a 32-bit integer. This is true for poly1305-generic
which processes only one block at a time. However, it's not true for
the AVX2 implementation, which processes 4 blocks at a time and
therefore can produce intermediate limbs about 4x larger.
Fix it by making the relevant calculations use 64-bit arithmetic rather
than 32-bit. Note that most of the carries already used 64-bit
arithmetic, but the d4 -> h0 carry was different for some reason.
To be safe I also made the same change to the corresponding SSE2 code,
though that only operates on 1 or 2 blocks at a time. I don't think
it's really needed for poly1305\_block\_sse2(), but it doesn't hurt
because it's already x86\_64 code. It \*might\* be needed for
poly1305\_2block\_sse2(), but overflows aren't easy to reproduce there.
This bug was originally detected by my patches that improve testmgr to
fuzz algorithms against their generic implementation. But also add a
test vector which reproduces it directly (in the AVX2 case).
Fixes: b1ccc8f4b631 ("crypto: poly1305 - Add a four block AVX2 variant for x86\_64")
Fixes: c70f4abef07a ("crypto: poly1305 - Add a SSE2 SIMD variant for x86\_64")
Cc:  # v4.3+
Cc: Martin Willi
Cc: Jason A. Donenfeld
Signed-off-by: Eric Biggers
Reviewed-by: Martin Willi
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit dacdbc115d23f1e4dbc091440bd5cdcdc01173b6
Author: Corey Minyard
Date: Wed Apr 3 15:58:16 2019 -0500
ipmi: fix sleep-in-atomic in free\_user at cleanup SRCU user->release\_barrier
commit 3b9a907223d7f6b9d1dadea29436842ae9bcd76d upstream.
free\_user() could be called in atomic context.
This patch pushed the free operation off into a workqueue.
Example:
BUG: sleeping function called from invalid context at kernel/workqueue.c:2856
in\_atomic(): 1, irqs\_disabled(): 0, pid: 177, name: ksoftirqd/27
CPU: 27 PID: 177 Comm: ksoftirqd/27 Not tainted 4.19.25-3 #1
Hardware name: AIC 1S-HV26-08/MB-DPSB04-06, BIOS IVYBV060 10/21/2015
Call Trace:
dump\_stack+0x5c/0x7b
\_\_\_might\_sleep+0xec/0x110
\_\_flush\_work+0x48/0x1f0
? try\_to\_del\_timer\_sync+0x4d/0x80
\_cleanup\_srcu\_struct+0x104/0x140
free\_user+0x18/0x30 [ipmi\_msghandler]
ipmi\_free\_recv\_msg+0x3a/0x50 [ipmi\_msghandler]
deliver\_response+0xbd/0xd0 [ipmi\_msghandler]
deliver\_local\_response+0xe/0x30 [ipmi\_msghandler]
handle\_one\_recv\_msg+0x163/0xc80 [ipmi\_msghandler]
? dequeue\_entity+0xa0/0x960
handle\_new\_recv\_msgs+0x15c/0x1f0 [ipmi\_msghandler]
tasklet\_action\_common.isra.22+0x103/0x120
\_\_do\_softirq+0xf8/0x2d7
run\_ksoftirqd+0x26/0x50
smpboot\_thread\_fn+0x11d/0x1e0
kthread+0x103/0x140
? sort\_range+0x20/0x20
? kthread\_destroy\_worker+0x40/0x40
ret\_from\_fork+0x1f/0x40
Fixes: 77f8269606bf ("ipmi: fix use-after-free of user->release\_barrier.rda")
Reported-by: Konstantin Khlebnikov
Signed-off-by: Corey Minyard
Cc: stable@vger.kernel.org # 5.0
Cc: Yang Yingliang
Signed-off-by: Greg Kroah-Hartman
commit 6ff17bc5936e5fab33de8064dc0690f6c8c789ca
Author: Andrea Arcangeli
Date: Thu Apr 18 17:50:52 2019 -0700
coredump: fix race condition between mmget\_not\_zero()/get\_task\_mm() and core dumping
commit 04f5866e41fb70690e28397487d8bd8eea7d712a upstream.
The core dumping code has always run without holding the mmap\_sem for
writing, despite that is the only way to ensure that the entire vma
layout will not change from under it. Only using some signal
serialization on the processes belonging to the mm is not nearly enough.
This was pointed out earlier. For example in Hugh's post from Jul 2017:
https://lkml.kernel.org/r/alpine.LSU.2.11.1707191716030.2055@eggly.anvils
"Not strictly relevant here, but a related note: I was very surprised
to discover, only quite recently, how handle\_mm\_fault() may be called
without down\_read(mmap\_sem) - when core dumping. That seems a
misguided optimization to me, which would also be nice to correct"
In particular because the growsdown and growsup can move the
vm\_start/vm\_end the various loops the core dump does around the vma will
not be consistent if page faults can happen concurrently.
Pretty much all users calling mmget\_not\_zero()/get\_task\_mm() and then
taking the mmap\_sem had the potential to introduce unexpected side
effects in the core dumping code.
Adding mmap\_sem for writing around the ->core\_dump invocation is a
viable long term fix, but it requires removing all copy user and page
faults and to replace them with get\_dump\_page() for all binary formats
which is not suitable as a short term fix.
For the time being this solution manually covers the places that can
confuse the core dump either by altering the vma layout or the vma flags
while it runs. Once ->core\_dump runs under mmap\_sem for writing the
function mmget\_still\_valid() can be dropped.
Allowing mmap\_sem protected sections to run in parallel with the
coredump provides some minor parallelism advantage to the swapoff code
(which seems to be safe enough by never mangling any vma field and can
keep doing swapins in parallel to the core dumping) and to some other
corner case.
In order to facilitate the backporting I added "Fixes: 86039bd3b4e6"
however the side effect of this same race condition in /proc/pid/mem
should be reproducible since before 2.6.12-rc2 so I couldn't add any
other "Fixes:" because there's no hash beyond the git genesis commit.
Because find\_extend\_vma() is the only location outside of the process
context that could modify the "mm" structures under mmap\_sem for
reading, by adding the mmget\_still\_valid() check to it, all other cases
that take the mmap\_sem for reading don't need the new check after
mmget\_not\_zero()/get\_task\_mm(). The expand\_stack() in page fault
context also doesn't need the new check, because all tasks under core
dumping are frozen.
Link: http://lkml.kernel.org/r/20190325224949.11068-1-aarcange@redhat.com
Fixes: 86039bd3b4e6 ("userfaultfd: add new syscall to provide memory externalization")
Signed-off-by: Andrea Arcangeli
Reported-by: Jann Horn
Suggested-by: Oleg Nesterov
Acked-by: Peter Xu
Reviewed-by: Mike Rapoport
Reviewed-by: Oleg Nesterov
Reviewed-by: Jann Horn
Acked-by: Jason Gunthorpe
Acked-by: Michal Hocko
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3e1b3e4d3c83a925e9c6fcd5aeed8713225b4a37
Author: Suthikulpanit, Suravee
Date: Wed Mar 20 08:12:28 2019 +0000
Revert "svm: Fix AVIC incomplete IPI emulation"
commit 4a58038b9e420276157785afa0a0bbb4b9bc2265 upstream.
This reverts commit bb218fbcfaaa3b115d4cd7a43c0ca164f3a96e57.
As Oren Twaig pointed out the old discussion:
https://patchwork.kernel.org/patch/8292231/
that the change coud potentially cause an extra IPI to be sent to
the destination vcpu because the AVIC hardware already set the IRR bit
before the incomplete IPI #VMEXIT with id=1 (target vcpu is not running).
Since writting to ICR and ICR2 will also set the IRR. If something triggers
the destination vcpu to get scheduled before the emulation finishes, then
this could result in an additional IPI.
Also, the issue mentioned in the commit bb218fbcfaaa was misdiagnosed.
Cc: Radim Krčmář
Cc: Paolo Bonzini
Reported-by: Oren Twaig
Signed-off-by: Suravee Suthikulpanit
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit ee4b8e266229b061ff8d03f0ed8764ac5f8098b6
Author: Saurav Kashyap
Date: Thu Apr 18 03:40:12 2019 -0700
Revert "scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO"
commit 0228034d8e5915b98c33db35a98f5e909e848ae9 upstream.
This patch clears FC\_RP\_STARTED flag during logoff, because of this
re-login(flogi) didn't happen to the switch.
This reverts commit 1550ec458e0cf1a40a170ab1f4c46e3f52860f65.
Fixes: 1550ec458e0c ("scsi: fcoe: clear FC\_RP\_STARTED flags when receiving a LOGO")
Cc:  # v4.18+
Signed-off-by: Saurav Kashyap
Reviewed-by: Hannes Reinecke
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 1aa2682d0a98bb025f8dd29df11f978a249a81ba
Author: Jaesoo Lee
Date: Tue Apr 9 17:02:22 2019 -0700
scsi: core: set result when the command cannot be dispatched
commit be549d49115422f846b6d96ee8fd7173a5f7ceb0 upstream.
When SCSI blk-mq is enabled, there is a bug in handling errors in
scsi\_queue\_rq. Specifically, the bug is not setting result field of
scsi\_request correctly when the dispatch of the command has been
failed. Since the upper layer code including the sg\_io ioctl expects to
receive any error status from result field of scsi\_request, the error is
silently ignored and this could cause data corruptions for some
applications.
Fixes: d285203cf647 ("scsi: add support for a blk-mq based I/O path.")
Cc:
Signed-off-by: Jaesoo Lee
Reviewed-by: Hannes Reinecke
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 8f2ef0e8f9670f83b3fe7e620eb7ae98910ff627
Author: Mikulas Patocka
Date: Thu Apr 4 20:53:28 2019 -0400
vt: fix cursor when clearing the screen
commit b2ecf00631362a83744e5ec249947620db5e240c upstream.
The patch a6dbe4427559 ("vt: perform safe console erase in the right
order") introduced a bug. The conditional do\_update\_region() was
replaced by a call to update\_region() that does contain the conditional
already, but with unwanted extra side effects such as restoring the cursor
drawing.
In order to reproduce the bug:
- use framebuffer console with the AMDGPU driver
- type "links" to start the console www browser
- press 'q' and space to exit links
Now the cursor will be permanently visible in the center of the
screen. It will stay there until something overwrites it.
The bug goes away if we change update\_region() back to the conditional
do\_update\_region().
[ nico: reworded changelog ]
Signed-off-by: Mikulas Patocka
Reviewed-by: Nicolas Pitre
Cc: stable@vger.kernel.org
Fixes: a6dbe4427559 ("vt: perform safe console erase in the right order")
Signed-off-by: Greg Kroah-Hartman
commit 38b7f09a9e83da3d8d786429520aace041e1d29e
Author: Geert Uytterhoeven
Date: Mon Apr 1 13:25:10 2019 +0200
serial: sh-sci: Fix HSCIF RX sampling point calculation
commit ace965696da2611af759f0284e26342b7b6cec89 upstream.
There are several issues with the formula used for calculating the
deviation from the intended rate:
1. While min\_err and last\_stop are signed, srr and baud are unsigned.
Hence the signed values are promoted to unsigned, which will lead
to a bogus value of deviation if min\_err is negative,
2. Srr is the register field value, which is one less than the actual
sampling rate factor,
3. The divisions do not use rounding.
Fix this by casting unsigned variables to int, adding one to srr, and
using a single DIV\_ROUND\_CLOSEST().
Fixes: 63ba1e00f178a448 ("serial: sh-sci: Support for HSCIF RX sampling point adjustment")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Mukesh Ojha
Cc: stable
Reviewed-by: Ulrich Hecht
Signed-off-by: Greg Kroah-Hartman
commit de6d6b8902fb2d26a46d266841364c3bfa70dc41
Author: Geert Uytterhoeven
Date: Fri Mar 29 10:10:26 2019 +0100
serial: sh-sci: Fix HSCIF RX sampling point adjustment
commit 6b87784b53592a90d21576be8eff688b56d93cce upstream.
The calculation of the sampling point has min() and max() exchanged.
Fix this by using the clamp() helper instead.
Fixes: 63ba1e00f178a448 ("serial: sh-sci: Support for HSCIF RX sampling point adjustment")
Signed-off-by: Geert Uytterhoeven
Reviewed-by: Ulrich Hecht
Reviewed-by: Wolfram Sang
Acked-by: Dirk Behme
Cc: stable
Reviewed-by: Simon Horman
Signed-off-by: Greg Kroah-Hartman
commit ec96f65e121459eda46de186750a7e9646306288
Author: KT Liao
Date: Tue Mar 26 17:28:32 2019 -0700
Input: elan\_i2c - add hardware ID for multiple Lenovo laptops
commit 738c06d0e4562e0acf9f2c7438a22b2d5afc67aa upstream.
There are many Lenovo laptops which need elan\_i2c support, this patch adds
relevant IDs to the Elan driver so that touchpads are recognized.
Signed-off-by: KT Liao
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit b50e435df2d8b9a1d3e956e1c767dfc7e30a441b
Author: Takashi Iwai
Date: Tue Apr 16 17:06:33 2019 +0200
ALSA: core: Fix card races between register and disconnect
commit 2a3f7221acddfe1caa9ff09b3a8158c39b2fdeac upstream.
There is a small race window in the card disconnection code that
allows the registration of another card with the very same card id.
This leads to a warning in procfs creation as caught by syzkaller.
The problem is that we delete snd\_cards and snd\_cards\_lock entries at
the very beginning of the disconnection procedure. This makes the
slot available to be assigned for another card object while the
disconnection procedure is being processed. Then it becomes possible
to issue a procfs registration with the existing file name although we
check the conflict beforehand.
The fix is simply to move the snd\_cards and snd\_cards\_lock clearances
at the end of the disconnection procedure. The references to these
entries are merely either from the global proc files like
/proc/asound/cards or from the card registration / disconnection, so
it should be fine to shift at the very end.
Reported-by: syzbot+48df349490c36f9f54ab@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 4171b6ee932828ad2c8258f4a0a84a2d1c05c896
Author: Hui Wang
Date: Wed Apr 17 16:10:32 2019 +0800
ALSA: hda/realtek - add two more pin configuration sets to quirk table
commit b26e36b7ef36a8a3a147b1609b2505f8a4ecf511 upstream.
We have two Dell laptops which have the codec 10ec0236 and 10ec0256
respectively, the headset mic on them can't work, need to apply the
quirk of ALC255\_FIXUP\_DELL1\_MIC\_NO\_PRESENCE. So adding their pin
configurations in the pin quirk table.
Cc:
Signed-off-by: Hui Wang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 4e78a1fb8d1d0948aafac07465779e821d9dda2e
Author: Ian Abbott
Date: Mon Apr 15 12:43:02 2019 +0100
staging: comedi: ni\_usb6501: Fix possible double-free of ->usb\_rx\_buf
commit af4b54a2e5ba18259ff9aac445bf546dd60d037e upstream.
`ni6501\_alloc\_usb\_buffers()` is called from `ni6501\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `ni6501\_detach()` will be called from the core comedi
module code to clean up. `ni6501\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already beed freed, leading to a
double-free error. Fix it bu removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `ni6501\_alloc\_usb\_buffers()`, relying
on `ni6501\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 09f9bacae11874c6abe368fab7b093dd33ef11ea
Author: Ian Abbott
Date: Mon Apr 15 12:43:01 2019 +0100
staging: comedi: ni\_usb6501: Fix use of uninitialized mutex
commit 660cf4ce9d0f3497cc7456eaa6d74c8b71d6282c upstream.
If `ni6501\_auto\_attach()` returns an error, the core comedi module code
will call `ni6501\_detach()` to clean up. If `ni6501\_auto\_attach()`
successfully allocated the comedi device private data, `ni6501\_detach()`
assumes that a `struct mutex mut` contained in the private data has been
initialized and uses it. Unfortunately, there are a couple of places
where `ni6501\_auto\_attach()` can return an error after allocating the
device private data but before initializing the mutex, so this
assumption is invalid. Fix it by initializing the mutex just after
allocating the private data in `ni6501\_auto\_attach()` before any other
errors can be retturned. Also move the call to `usb\_set\_intfdata()`
just to keep the code a bit neater (either position for the call is
fine).
I believe this was the cause of the following syzbot crash report
:
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
usb 1-1: string descriptor 0 read error: -71
comedi comedi0: Wrong number of endpoints
ni6501 1-1:0.233: driver 'ni6501' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 585 Comm: kworker/0:3 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_mutex\_lock\_common kernel/locking/mutex.c:925 [inline]
\_\_mutex\_lock+0xfe/0x12b0 kernel/locking/mutex.c:1072
ni6501\_detach+0x5b/0x110 drivers/staging/comedi/drivers/ni\_usb6501.c:567
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+cf4f2b6c24aff0a3edf6@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit edf2f548baa959e90f1a2f0fce737e18701070d5
Author: Ian Abbott
Date: Mon Apr 15 12:52:30 2019 +0100
staging: comedi: vmk80xx: Fix possible double-free of ->usb\_rx\_buf
commit 663d294b4768bfd89e529e069bffa544a830b5bf upstream.
`vmk80xx\_alloc\_usb\_buffers()` is called from `vmk80xx\_auto\_attach()` to
allocate RX and TX buffers for USB transfers. It allocates
`devpriv->usb\_rx\_buf` followed by `devpriv->usb\_tx\_buf`. If the
allocation of `devpriv->usb\_tx\_buf` fails, it frees
`devpriv->usb\_rx\_buf`, leaving the pointer set dangling, and returns an
error. Later, `vmk80xx\_detach()` will be called from the core comedi
module code to clean up. `vmk80xx\_detach()` also frees both
`devpriv->usb\_rx\_buf` and `devpriv->usb\_tx\_buf`, but
`devpriv->usb\_rx\_buf` may have already been freed, leading to a
double-free error. Fix it by removing the call to
`kfree(devpriv->usb\_rx\_buf)` from `vmk80xx\_alloc\_usb\_buffers()`, relying
on `vmk80xx\_detach()` to free the memory.
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 1f01a970b8c2de057c7c1cf3afce3d116fb6645b
Author: Ian Abbott
Date: Mon Apr 15 12:10:14 2019 +0100
staging: comedi: vmk80xx: Fix use of uninitialized semaphore
commit 08b7c2f9208f0e2a32159e4e7a4831b7adb10a3e upstream.
If `vmk80xx\_auto\_attach()` returns an error, the core comedi module code
will call `vmk80xx\_detach()` to clean up. If `vmk80xx\_auto\_attach()`
successfully allocated the comedi device private data,
`vmk80xx\_detach()` assumes that a `struct semaphore limit\_sem` contained
in the private data has been initialized and uses it. Unfortunately,
there are a couple of places where `vmk80xx\_auto\_attach()` can return an
error after allocating the device private data but before initializing
the semaphore, so this assumption is invalid. Fix it by initializing
the semaphore just after allocating the private data in
`vmk80xx\_auto\_attach()` before any other errors can be returned.
I believe this was the cause of the following syzbot crash report
:
usb 1-1: config 0 has no interface number 0
usb 1-1: New USB device found, idVendor=10cf, idProduct=8068, bcdDevice=e6.8d
usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0
usb 1-1: config 0 descriptor??
vmk80xx 1-1:0.117: driver 'vmk80xx' failed to auto-configure device.
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 0 PID: 12 Comm: kworker/0:1 Not tainted 5.1.0-rc4-319354-g9a33b36 #3
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: usb\_hub\_wq hub\_event
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xe8/0x16e lib/dump\_stack.c:113
assign\_lock\_key kernel/locking/lockdep.c:786 [inline]
register\_lock\_class+0x11b8/0x1250 kernel/locking/lockdep.c:1095
\_\_lock\_acquire+0xfb/0x37c0 kernel/locking/lockdep.c:3582
lock\_acquire+0x10d/0x2f0 kernel/locking/lockdep.c:4211
\_\_raw\_spin\_lock\_irqsave include/linux/spinlock\_api\_smp.h:110 [inline]
\_raw\_spin\_lock\_irqsave+0x44/0x60 kernel/locking/spinlock.c:152
down+0x12/0x80 kernel/locking/semaphore.c:58
vmk80xx\_detach+0x59/0x100 drivers/staging/comedi/drivers/vmk80xx.c:829
comedi\_device\_detach+0xed/0x800 drivers/staging/comedi/drivers.c:204
comedi\_device\_cleanup.part.0+0x68/0x140 drivers/staging/comedi/comedi\_fops.c:156
comedi\_device\_cleanup drivers/staging/comedi/comedi\_fops.c:187 [inline]
comedi\_free\_board\_dev.part.0+0x16/0x90 drivers/staging/comedi/comedi\_fops.c:190
comedi\_free\_board\_dev drivers/staging/comedi/comedi\_fops.c:189 [inline]
comedi\_release\_hardware\_device+0x111/0x140 drivers/staging/comedi/comedi\_fops.c:2880
comedi\_auto\_config.cold+0x124/0x1b0 drivers/staging/comedi/drivers.c:1068
usb\_probe\_interface+0x31d/0x820 drivers/usb/core/driver.c:361
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_set\_configuration+0xdf7/0x1740 drivers/usb/core/message.c:2021
generic\_probe+0xa2/0xda drivers/usb/core/generic.c:210
usb\_probe\_device+0xc0/0x150 drivers/usb/core/driver.c:266
really\_probe+0x2da/0xb10 drivers/base/dd.c:509
driver\_probe\_device+0x21d/0x350 drivers/base/dd.c:671
\_\_device\_attach\_driver+0x1d8/0x290 drivers/base/dd.c:778
bus\_for\_each\_drv+0x163/0x1e0 drivers/base/bus.c:454
\_\_device\_attach+0x223/0x3a0 drivers/base/dd.c:844
bus\_probe\_device+0x1f1/0x2a0 drivers/base/bus.c:514
device\_add+0xad2/0x16e0 drivers/base/core.c:2106
usb\_new\_device.cold+0x537/0xccf drivers/usb/core/hub.c:2534
hub\_port\_connect drivers/usb/core/hub.c:5089 [inline]
hub\_port\_connect\_change drivers/usb/core/hub.c:5204 [inline]
port\_event drivers/usb/core/hub.c:5350 [inline]
hub\_event+0x138e/0x3b00 drivers/usb/core/hub.c:5432
process\_one\_work+0x90f/0x1580 kernel/workqueue.c:2269
worker\_thread+0x9b/0xe20 kernel/workqueue.c:2415
kthread+0x313/0x420 kernel/kthread.c:253
ret\_from\_fork+0x3a/0x50 arch/x86/entry/entry\_64.S:352
Reported-by: syzbot+54c2f58f15fe6876b6ad@syzkaller.appspotmail.com
Signed-off-by: Ian Abbott
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit a1da981f66432d1d38c91cff0b19490b3bf7aace
Author: Christian Gromm
Date: Tue Apr 2 13:39:57 2019 +0200
staging: most: core: use device description as name
commit 131ac62253dba79daf4a6d83ab12293d2b9863d3 upstream.
This patch uses the device description to clearly identity a device
attached to the bus. It is needed as the currently useed mdevX
notation is not sufficiant in case more than one network
interface controller is being used at the same time.
Cc: stable@vger.kernel.org
Signed-off-by: Christian Gromm
Signed-off-by: Greg Kroah-Hartman
commit b007c64d860f55db1064e4e7a56cbbabe87d1cc9
Author: he, bo
Date: Wed Mar 6 10:32:20 2019 +0800
io: accel: kxcjk1013: restore the range after resume.
commit fe2d3df639a7940a125a33d6460529b9689c5406 upstream.
On some laptops, kxcjk1013 is powered off when system enters S3. We need
restore the range regiter during resume. Otherwise, the sensor doesn't
work properly after S3.
Signed-off-by: he, bo
Signed-off-by: Chen, Hu
Reviewed-by: Hans de Goede
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit bbe0bed4647ccc135a31c378b1257e9af6f9c4e9
Author: Fabrice Gasnier
Date: Mon Mar 25 14:01:23 2019 +0100
iio: core: fix a possible circular locking dependency
commit 7f75591fc5a123929a29636834d1bcb8b5c9fee3 upstream.
This fixes a possible circular locking dependency detected warning seen
with:
- CONFIG\_PROVE\_LOCKING=y
- consumer/provider IIO devices (ex: "voltage-divider" consumer of "adc")
When using the IIO consumer interface, e.g. iio\_channel\_get(), the consumer
device will likely call iio\_read\_channel\_raw() or similar that rely on
'info\_exist\_lock' mutex.
typically:
...
mutex\_lock(&chan->indio\_dev->info\_exist\_lock);
if (chan->indio\_dev->info == NULL) {
ret = -ENODEV;
goto err\_unlock;
}
ret = do\_some\_ops()
err\_unlock:
mutex\_unlock(&chan->indio\_dev->info\_exist\_lock);
return ret;
...
Same mutex is also hold in iio\_device\_unregister().
The following deadlock warning happens when:
- the consumer device has called an API like iio\_read\_channel\_raw()
at least once.
- the consumer driver is unregistered, removed (unbind from sysfs)
======================================================
WARNING: possible circular locking dependency detected
4.19.24 #577 Not tainted
------------------------------------------------------
sh/372 is trying to acquire lock:
(kn->count#30){++++}, at: kernfs\_remove\_by\_name\_ns+0x3c/0x84
but task is already holding lock:
(&dev->info\_exist\_lock){+.+.}, at: iio\_device\_unregister+0x18/0x60
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (&dev->info\_exist\_lock){+.+.}:
\_\_mutex\_lock+0x70/0xa3c
mutex\_lock\_nested+0x1c/0x24
iio\_read\_channel\_raw+0x1c/0x60
iio\_read\_channel\_info+0xa8/0xb0
dev\_attr\_show+0x1c/0x48
sysfs\_kf\_seq\_show+0x84/0xec
seq\_read+0x154/0x528
\_\_vfs\_read+0x2c/0x15c
vfs\_read+0x8c/0x110
ksys\_read+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbedefb60
-> #0 (kn->count#30){++++}:
lock\_acquire+0xd8/0x268
\_\_kernfs\_remove+0x288/0x374
kernfs\_remove\_by\_name\_ns+0x3c/0x84
remove\_files+0x34/0x78
sysfs\_remove\_group+0x40/0x9c
sysfs\_remove\_groups+0x24/0x34
device\_remove\_attrs+0x38/0x64
device\_del+0x11c/0x360
cdev\_device\_del+0x14/0x2c
iio\_device\_unregister+0x24/0x60
release\_nodes+0x1bc/0x200
device\_release\_driver\_internal+0x1a0/0x230
unbind\_store+0x80/0x130
kernfs\_fop\_write+0x100/0x1e4
\_\_vfs\_write+0x2c/0x160
vfs\_write+0xa4/0x17c
ksys\_write+0x4c/0xac
ret\_fast\_syscall+0x0/0x28
0xbe906840
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
lock(&dev->info\_exist\_lock);
lock(kn->count#30);
\*\*\* DEADLOCK \*\*\*
...
cdev\_device\_del() can be called without holding the lock. It should be safe
as info\_exist\_lock prevents kernelspace consumers to use the exported
routines during/after provider removal. cdev\_device\_del() is for userspace.
Help to reproduce:
See example: Documentation/devicetree/bindings/iio/afe/voltage-divider.txt
sysv {
compatible = "voltage-divider";
io-channels = <&adc 0>;
output-ohms = <22>;
full-ohms = <222>;
};
First, go to iio:deviceX for the "voltage-divider", do one read:
$ cd /sys/bus/iio/devices/iio:deviceX
$ cat in\_voltage0\_raw
Then, unbind the consumer driver. It triggers above deadlock warning.
$ cd /sys/bus/platform/drivers/iio-rescale/
$ echo sysv > unbind
Note I don't actually expect stable will pick this up all the
way back into IIO being in staging, but if's probably valid that
far back.
Signed-off-by: Fabrice Gasnier
Fixes: ac917a81117c ("staging:iio:core set the iio\_dev.info pointer to null on unregister")
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 98171e1947b6ce06fb7a439c0d8c599e0c090fcd
Author: Georg Ottinger
Date: Wed Jan 30 14:42:02 2019 +0100
iio: adc: at91: disable adc channel interrupt in timeout case
commit 09c6bdee51183a575bf7546890c8c137a75a2b44 upstream.
Having a brief look at at91\_adc\_read\_raw() it is obvious that in the case
of a timeout the setting of AT91\_ADC\_CHDR and AT91\_ADC\_IDR registers is
omitted. If 2 different channels are queried we can end up with a
situation where two interrupts are enabled, but only one interrupt is
cleared in the interrupt handler. Resulting in a interrupt loop and a
system hang.
Signed-off-by: Georg Ottinger
Acked-by: Ludovic Desroches
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 36971130bb2f815fddae17cfe02ae5fed9b3ff56
Author: Lars-Peter Clausen
Date: Wed Feb 20 17:11:32 2019 +0200
iio: Fix scan mask selection
commit 20ea39ef9f2f911bd01c69519e7d69cfec79fde3 upstream.
The trialmask is expected to have all bits set to 0 after allocation.
Currently kmalloc\_array() is used which does not zero the memory and so
random bits are set. This results in random channels being enabled when
they shouldn't. Replace kmalloc\_array() with kcalloc() which has the same
interface but zeros the memory.
Note the fix is actually required earlier than the below fixes tag, but
will require a manual backport due to move from kmalloc to kmalloc\_array.
Signed-off-by: Lars-Peter Clausen
Signed-off-by: Alexandru Ardelean
Fixes commit 057ac1acdfc4 ("iio: Use kmalloc\_array() in iio\_scan\_mask\_set()").
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 0e47edde91325efde88e937e1ccc5883c32b5a31
Author: Jean-Francois Dagenais
Date: Wed Mar 6 15:56:06 2019 -0500
iio: dac: mcp4725: add missing powerdown bits in store eeprom
commit 06003531502d06bc89d32528f6ec96bf978790f9 upstream.
When issuing the write DAC register and write eeprom command, the two
powerdown bits (PD0 and PD1) are assumed by the chip to be present in
the bytes sent. Leaving them at 0 implies "powerdown disabled" which is
a different state that the current one. By adding the current state of
the powerdown in the i2c write, the chip will correctly power-on exactly
like as it is at the moment of store\_eeprom call.
This is documented in MCP4725's datasheet, FIGURE 6-2: "Write Commands
for DAC Input Register and EEPROM" and MCP4726's datasheet, FIGURE 6-3:
"Write All Memory Command".
Signed-off-by: Jean-Francois Dagenais
Acked-by: Peter Meerwald-Stadler
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 5ad173ea6c3a906c80c9e1afb3960c859d9ab037
Author: Dragos Bogdan
Date: Tue Mar 19 12:47:00 2019 +0200
iio: ad\_sigma\_delta: select channel when reading register
commit fccfb9ce70ed4ea7a145f77b86de62e38178517f upstream.
The desired channel has to be selected in order to correctly fill the
buffer with the corresponding data.
The `ad\_sd\_write\_reg()` already does this, but for the
`ad\_sd\_read\_reg\_raw()` this was omitted.
Fixes: af3008485ea03 ("iio:adc: Add common code for ADI Sigma Delta devices")
Signed-off-by: Dragos Bogdan
Signed-off-by: Alexandru Ardelean
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 42eae0cff22a75823abfe198fce4418461b7cc6b
Author: Gwendal Grignou
Date: Wed Mar 13 12:40:02 2019 +0100
iio: cros\_ec: Fix the maths for gyro scale calculation
commit 3d02d7082e5823598090530c3988a35f69689943 upstream.
Calculation did not use IIO\_DEGREE\_TO\_RAD and implemented a variant to
avoid precision loss as we aim a nano value. The offset added to avoid
rounding error, though, doesn't give us a close result to the expected
value. E.g.
For 1000dps, the result should be:
(1000 \* pi ) / 180 >> 15 ~= 0.000532632218
But with current calculation we get
$ cat scale
0.000547890
Fix the calculation by just doing the maths involved for a nano value
val \* pi \* 10e12 / (180 \* 2^15)
so we get a closer result.
$ cat scale
0.000532632
Fixes: c14dca07a31d ("iio: cros\_ec\_sensors: add ChromeOS EC Contiguous Sensors driver")
Signed-off-by: Gwendal Grignou
Signed-off-by: Enric Balletbo i Serra
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit adfb0f0b17a3b1bdef44a5249def720534d7ac33
Author: Mike Looijmans
Date: Wed Mar 6 08:31:48 2019 +0100
iio:chemical:bme680: Fix SPI read interface
commit 73f3bc6da506711302bb67572440eb84b1ec4a2c upstream.
The SPI interface implementation was completely broken.
When using the SPI interface, there are only 7 address bits, the upper bit
is controlled by a page select register. The core needs access to both
ranges, so implement register read/write for both regions. The regmap
paging functionality didn't agree with a register that needs to be read
and modified, so I implemented a custom paging algorithm.
This fixes that the device wouldn't even probe in SPI mode.
The SPI interface then isn't different from I2C, merged them into the core,
and the I2C/SPI named registers are no longer needed.
Implemented register value caching for the registers to reduce the I2C/SPI
data transfers considerably.
The calibration set reads as all zeroes until some undefined point in time,
and I couldn't determine what makes it valid. The datasheet mentions these
registers but does not provide any hints on when they become valid, and they
aren't even enumerated in the memory map. So check the calibration and
retry reading it from the device after each measurement until it provides
something valid.
Despite the size this is suitable for a stable backport given that
it seems the SPI support never worked.
Signed-off-by: Mike Looijmans
Fixes: 1b3bd8592780 ("iio: chemical: Add support for Bosch BME680 sensor");
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit a3117576a73f6b2df88d96fb6ae0402bba0c24b3
Author: Mike Looijmans
Date: Wed Mar 6 08:31:47 2019 +0100
iio:chemical:bme680: Fix, report temperature in millidegrees
commit 9436f45dd53595e21566a8c6627411077dfdb776 upstream.
The standard unit for temperature is millidegrees Celcius. Adapt the
driver to report in millidegrees instead of degrees.
Signed-off-by: Mike Looijmans
Fixes: 1b3bd8592780 ("iio: chemical: Add support for Bosch BME680 sensor");
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit f7ee6890caa59f71c4af92814afd4b4cb7dafcc9
Author: Mike Looijmans
Date: Wed Feb 13 08:41:47 2019 +0100
iio/gyro/bmg160: Use millidegrees for temperature scale
commit 40a7198a4a01037003c7ca714f0d048a61e729ac upstream.
Standard unit for temperature is millidegrees Celcius, whereas this driver
was reporting in degrees. Fix the scale factor in the driver.
Signed-off-by: Mike Looijmans
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 8bd3fd46ec23375740e7f29bafce4a11f6cff1d2
Author: Sergey Larin
Date: Sat Mar 2 19:54:55 2019 +0300
iio: gyro: mpu3050: fix chip ID reading
commit 409a51e0a4a5f908763191fae2c29008632eb712 upstream.
According to the datasheet, the last bit of CHIP\_ID register controls
I2C bus, and the first one is unused. Handle this correctly.
Note that there are chips out there that have a value such that
the id check currently fails.
Signed-off-by: Sergey Larin
Reviewed-by: Linus Walleij
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 6f3e66b155f02dd90a30c9307f4900256eafa3f1
Author: Mircea Caprioru
Date: Wed Feb 20 13:08:20 2019 +0200
staging: iio: ad7192: Fix ad7193 channel address
commit 7ce0f216221856a17fc4934b39284678a5fef2e9 upstream.
This patch fixes the differential channels addresses for the ad7193.
Signed-off-by: Mircea Caprioru
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit c54d1258c637ac4318cab995be0965b866cb8e3b
Author: Leonard Pollak
Date: Wed Feb 13 11:19:52 2019 +0100
Staging: iio: meter: fixed typo
commit 0a8a29be499cbb67df79370aaf5109085509feb8 upstream.
This patch fixes an obvious typo, which will cause erroneously returning the Peak
Voltage instead of the Peak Current.
Signed-off-by: Leonard Pollak
Cc:
Acked-by: Michael Hennerich
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit c9e34935a3514d083cc2787f874fee786c775c6c
Author: Vitaly Kuznetsov
Date: Wed Apr 3 16:06:42 2019 +0200
KVM: x86: svm: make sure NMI is injected after nmi\_singlestep
commit 99c221796a810055974b54c02e8f53297e48d146 upstream.
I noticed that apic test from kvm-unit-tests always hangs on my EPYC 7401P,
the hanging test nmi-after-sti is trying to deliver 30000 NMIs and tracing
shows that we're sometimes able to deliver a few but never all.
When we're trying to inject an NMI we may fail to do so immediately for
various reasons, however, we still need to inject it so enable\_nmi\_window()
arms nmi\_singlestep mode. #DB occurs as expected, but we're not checking
for pending NMIs before entering the guest and unless there's a different
event to process, the NMI will never get delivered.
Make KVM\_REQ\_EVENT request on the vCPU from db\_interception() to make sure
pending NMIs are checked and possibly injected.
Signed-off-by: Vitaly Kuznetsov
Cc: stable@vger.kernel.org
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 18cf09a817714d7702f4dfa0956abefd4b4e2f63
Author: Sean Christopherson
Date: Tue Apr 2 08:10:47 2019 -0700
KVM: x86: Don't clear EFER during SMM transitions for 32-bit vCPU
commit 8f4dc2e77cdfaf7e644ef29693fa229db29ee1de upstream.
Neither AMD nor Intel CPUs have an EFER field in the legacy SMRAM save
state area, i.e. don't save/restore EFER across SMM transitions. KVM
somewhat models this, e.g. doesn't clear EFER on entry to SMM if the
guest doesn't support long mode. But during RSM, KVM unconditionally
clears EFER so that it can get back to pure 32-bit mode in order to
start loading CRs with their actual non-SMM values.
Clear EFER only when it will be written when loading the non-SMM state
so as to preserve bits that can theoretically be set on 32-bit vCPUs,
e.g. KVM always emulates EFER\_SCE.
And because CR4.PAE is cleared only to play nice with EFER, wrap that
code in the long mode check as well. Note, this may result in a
compiler warning about cr4 being consumed uninitialized. Re-read CR4
even though it's technically unnecessary, as doing so allows for more
readable code and RSM emulation is not a performance critical path.
Fixes: 660a5d517aaab ("KVM: x86: save/load state on SMM switch")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 2fcee5eaae6ee1c2ccbe629ffd46c6674a98824c
Author: Ronnie Sahlberg
Date: Wed Apr 10 07:47:22 2019 +1000
cifs: fix handle leak in smb2\_query\_symlink()
commit e6d0fb7b34f264f72c33053558a360a6a734905e upstream.
If we enter smb2\_query\_symlink() for something that is not a symlink
and where the SMB2\_open() would succeed we would never end up
closing this handle and would thus leak a handle on the server.
Fix this by immediately calling SMB2\_close() on successfull open.
Signed-off-by: Ronnie Sahlberg
CC: Stable
Signed-off-by: Steve French
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit c69330a855ab4342d304f67f8c1e7d1fa2686bec
Author: ZhangXiaoxu
Date: Sat Apr 6 15:47:39 2019 +0800
cifs: Fix use-after-free in SMB2\_read
commit 088aaf17aa79300cab14dbee2569c58cfafd7d6e upstream.
There is a KASAN use-after-free:
BUG: KASAN: use-after-free in SMB2\_read+0x1136/0x1190
Read of size 8 at addr ffff8880b4e45e50 by task ln/1009
Should not release the 'req' because it will use in the trace.
Fixes: eccb4422cf97 ("smb3: Add ftrace tracepoints for improved SMB3 debugging")
Signed-off-by: ZhangXiaoxu
Signed-off-by: Steve French
CC: Stable  4.18+
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit 8fb89b43b65fcd35f15d982712904b96fc64c68a
Author: ZhangXiaoxu
Date: Sat Apr 6 15:47:38 2019 +0800
cifs: Fix use-after-free in SMB2\_write
commit 6a3eb3360667170988f8a6477f6686242061488a upstream.
There is a KASAN use-after-free:
BUG: KASAN: use-after-free in SMB2\_write+0x1342/0x1580
Read of size 8 at addr ffff8880b6a8e450 by task ln/4196
Should not release the 'req' because it will use in the trace.
Fixes: eccb4422cf97 ("smb3: Add ftrace tracepoints for improved SMB3 debugging")
Signed-off-by: ZhangXiaoxu
Signed-off-by: Steve French
CC: Stable  4.18+
Reviewed-by: Pavel Shilovsky
Signed-off-by: Greg Kroah-Hartman
commit 8092ecc306d81186a64cda42411121f4d35aaff4
Author: Aurelien Aptel
Date: Fri Mar 29 10:49:12 2019 +0100
CIFS: keep FileInfo handle live during oplock break
commit b98749cac4a695f084a5ff076f4510b23e353ecd upstream.
In the oplock break handler, writing pending changes from pages puts
the FileInfo handle. If the refcount reaches zero it closes the handle
and waits for any oplock break handler to return, thus causing a deadlock.
To prevent this situation:
\* We add a wait flag to cifsFileInfo\_put() to decide whether we should
wait for running/pending oplock break handlers
\* We keep an additionnal reference of the SMB FileInfo handle so that
for the rest of the handler putting the handle won't close it.
- The ref is bumped everytime we queue the handler via the
cifs\_queue\_oplock\_break() helper.
- The ref is decremented at the end of the handler
This bug was triggered by xfstest 464.
Also important fix to address the various reports of
oops in smb2\_push\_mandatory\_locks
Signed-off-by: Aurelien Aptel
Signed-off-by: Steve French
Reviewed-by: Pavel Shilovsky
CC: Stable
Signed-off-by: Greg Kroah-Hartman
commit 6e2081f29392f878aa9e1bd19b976c7c8b82bad3
Author: Peter Oskolkov
Date: Tue Apr 23 10:25:33 2019 -0700
net: IP6 defrag: use rbtrees in nf\_conntrack\_reasm.c
[ Upstream commit 997dd96471641e147cb2c33ad54284000d0f5e35 ]
Currently, IPv6 defragmentation code drops non-last fragments that
are smaller than 1280 bytes: see
commit 0ed4229b08c1 ("ipv6: defrag: drop non-last frags smaller than min mtu")
This behavior is not specified in IPv6 RFCs and appears to break
compatibility with some IPv6 implemenations, as reported here:
https://www.spinics.net/lists/netdev/msg543846.html
This patch re-uses common IP defragmentation queueing and reassembly
code in IP6 defragmentation in nf\_conntrack, removing the 1280 byte
restriction.
Signed-off-by: Peter Oskolkov
Reported-by: Tom Herbert
Cc: Eric Dumazet
Cc: Florian Westphal
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 684685326ab0cf8d71ae83ff614c748876f24938
Author: Peter Oskolkov
Date: Tue Apr 23 10:25:32 2019 -0700
net: IP6 defrag: use rbtrees for IPv6 defrag
[ Upstream commit d4289fcc9b16b89619ee1c54f829e05e56de8b9a ]
Currently, IPv6 defragmentation code drops non-last fragments that
are smaller than 1280 bytes: see
commit 0ed4229b08c1 ("ipv6: defrag: drop non-last frags smaller than min mtu")
This behavior is not specified in IPv6 RFCs and appears to break
compatibility with some IPv6 implemenations, as reported here:
https://www.spinics.net/lists/netdev/msg543846.html
This patch re-uses common IP defragmentation queueing and reassembly
code in IPv6, removing the 1280 byte restriction.
v2: change handling of overlaps to match that of upstream.
Signed-off-by: Peter Oskolkov
Reported-by: Tom Herbert
Cc: Eric Dumazet
Cc: Florian Westphal
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 702ddf862d9d74e670849df659b8706fd6878205
Author: Peter Oskolkov
Date: Tue Apr 23 10:25:31 2019 -0700
net: IP defrag: encapsulate rbtree defrag code into callable functions
[ Upstream commit c23f35d19db3b36ffb9e04b08f1d91565d15f84f ]
This is a refactoring patch: without changing runtime behavior,
it moves rbtree-related code from IPv4-specific files/functions
into .h/.c defrag files shared with IPv6 defragmentation code.
v2: make handling of overlapping packets match upstream.
Signed-off-by: Peter Oskolkov
Cc: Eric Dumazet
Cc: Florian Westphal
Cc: Tom Herbert
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e24be8e38cd7fcc85174595690b20d153f8e204d
Author: Toke Høiland-Jørgensen
Date: Fri Apr 5 15:01:59 2019 +0200
sch\_cake: Simplify logic in cake\_select\_tin()
[ Upstream commit 4976e3c683f328bc6f2edef555a4ffee6524486f ]
The logic in cake\_select\_tin() was getting a bit hairy, and it turns out we
can simplify it quite a bit. This also allows us to get rid of one of the
two diffserv parsing functions, which has the added benefit that
already-zeroed DSCP fields won't get re-written.
Suggested-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 8d9051a4680abf7316b440278fe52b9437503e90
Author: Pieter Jansen van Vuuren
Date: Mon Apr 1 19:36:34 2019 -0700
nfp: flower: remove vlan CFI bit from push vlan action
[ Upstream commit 42cd5484a22f1a1b947e21e2af65fa7dab09d017 ]
We no longer set CFI when pushing vlan tags, therefore we remove
the CFI bit from push vlan.
Fixes: 1a1e586f54bf ("nfp: add basic action capabilities to flower offloads")
Signed-off-by: Pieter Jansen van Vuuren
Signed-off-by: Louis Peens
Signed-off-by: Greg Kroah-Hartman
commit 06f7d2182f9d850e762a8870633d10e99cfc10a8
Author: Pieter Jansen van Vuuren
Date: Mon Apr 1 19:36:33 2019 -0700
nfp: flower: replace CFI with vlan present
[ Upstream commit f7ee799a51ddbcc205ef615fe424fb5084e9e0aa ]
Replace vlan CFI bit with a vlan present bit that indicates the
presence of a vlan tag. Previously the driver incorrectly assumed
that an vlan id of 0 is not matchable, therefore we indicate vlan
presence with a vlan present bit.
Fixes: 5571e8c9f241 ("nfp: extend flower matching capabilities")
Signed-off-by: Pieter Jansen van Vuuren
Signed-off-by: Louis Peens
Signed-off-by: Greg Kroah-Hartman
commit cbce0413f783a5a9d49005a2187201df8eb15a38
Author: Toke Høiland-Jørgensen
Date: Thu Apr 4 15:01:33 2019 +0200
sch\_cake: Make sure we can write the IP header before changing DSCP bits
[ Upstream commit c87b4ecdbe8db27867a7b7f840291cd843406bd7 ]
There is not actually any guarantee that the IP headers are valid before we
access the DSCP bits of the packets. Fix this using the same approach taken
in sch\_dsmark.
Reported-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 490532225e20f2c3ef763c7da2c4e090ac42318a
Author: Toke Høiland-Jørgensen
Date: Thu Apr 4 15:01:33 2019 +0200
sch\_cake: Use tc\_skb\_protocol() helper for getting packet protocol
[ Upstream commit b2100cc56fca8c51d28aa42a9f1fbcb2cf351996 ]
We shouldn't be using skb->protocol directly as that will miss cases with
hardware-accelerated VLAN tags. Use the helper instead to get the right
protocol number.
Reported-by: Kevin Darbyshire-Bryant
Signed-off-by: Toke Høiland-Jørgensen
Signed-off-by: Greg Kroah-Hartman
commit 5f72cb2ab51d242158b6b963365d70f88844b983
Author: Jonathan Lemon
Date: Sun Apr 14 14:21:29 2019 -0700
route: Avoid crash from dereferencing NULL rt->from
[ Upstream commit 9c69a13205151c0d801de9f9d83a818e6e8f60ec ]
When \_\_ip6\_rt\_update\_pmtu() is called, rt->from is RCU dereferenced, but is
never checked for null - rt6\_flush\_exceptions() may have removed the entry.
[ 1913.989004] RIP: 0010:ip6\_rt\_cache\_alloc+0x13/0x170
[ 1914.209410] Call Trace:
[ 1914.214798]
[ 1914.219226] \_\_ip6\_rt\_update\_pmtu+0xb0/0x190
[ 1914.228649] ip6\_tnl\_xmit+0x2c2/0x970 [ip6\_tunnel]
[ 1914.239223] ? ip6\_tnl\_parse\_tlv\_enc\_lim+0x32/0x1a0 [ip6\_tunnel]
[ 1914.252489] ? \_\_gre6\_xmit+0x148/0x530 [ip6\_gre]
[ 1914.262678] ip6gre\_tunnel\_xmit+0x17e/0x3c7 [ip6\_gre]
[ 1914.273831] dev\_hard\_start\_xmit+0x8d/0x1f0
[ 1914.283061] sch\_direct\_xmit+0xfa/0x230
[ 1914.291521] \_\_qdisc\_run+0x154/0x4b0
[ 1914.299407] net\_tx\_action+0x10e/0x1f0
[ 1914.307678] \_\_do\_softirq+0xca/0x297
[ 1914.315567] irq\_exit+0x96/0xa0
[ 1914.322494] smp\_apic\_timer\_interrupt+0x68/0x130
[ 1914.332683] apic\_timer\_interrupt+0xf/0x20
[ 1914.341721]
Fixes: a68886a69180 ("net/ipv6: Make from in rt6\_info rcu protected")
Signed-off-by: Jonathan Lemon
Reviewed-by: Eric Dumazet
Reviewed-by: David Ahern
Reviewed-by: Martin KaFai Lau
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1d2499b0860024c7cd973a8dee375105ffd34156
Author: Saeed Mahameed
Date: Tue Mar 19 01:05:41 2019 -0700
net/mlx5: FPGA, tls, idr remove on flow delete
[ Upstream commit df3a8344d404a810b4aadbf19b08c8232fbaa715 ]
Flow is kfreed on mlx5\_fpga\_tls\_del\_flow but kept in the idr data
structure, this is risky and can cause use-after-free, since the
idr\_remove is delayed until tls\_send\_teardown\_cmd completion.
Instead of delaying idr\_remove, in this patch we do it on
mlx5\_fpga\_tls\_del\_flow, before actually kfree(flow).
Added synchronize\_rcu before kfree(flow)
Fixes: ab412e1dd7db ("net/mlx5: Accel, add TLS rx offload routines")
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit 785833b9eee027c0d31dfe96225e243f13110939
Author: Jakub Kicinski
Date: Mon Apr 8 17:59:50 2019 -0700
net/tls: prevent bad memory access in tls\_is\_sk\_tx\_device\_offloaded()
[ Upstream commit b4f47f3848eb70986f75d06112af7b48b7f5f462 ]
Unlike '&&' operator, the '&' does not have short-circuit
evaluation semantics. IOW both sides of the operator always
get evaluated. Fix the wrong operator in
tls\_is\_sk\_tx\_device\_offloaded(), which would lead to
out-of-bounds access for for non-full sockets.
Fixes: 4799ac81e52a ("tls: Add rx inline crypto offload")
Signed-off-by: Jakub Kicinski
Reviewed-by: Dirk van der Merwe
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7cfddb81a81727362e0e4d3aea03af7d7d96d73f
Author: Saeed Mahameed
Date: Tue Mar 19 22:09:05 2019 -0700
net/mlx5: FPGA, tls, hold rcu read lock a bit longer
[ Upstream commit 31634bf5dcc418b5b2cacd954394c0c4620db6a2 ]
To avoid use-after-free, hold the rcu read lock until we are done copying
flow data into the command buffer.
Fixes: ab412e1dd7db ("net/mlx5: Accel, add TLS rx offload routines")
Reported-by: Eric Dumazet
Signed-off-by: Saeed Mahameed
Signed-off-by: Greg Kroah-Hartman
commit d1785bea2f3419507827b009b483a53fde80b928
Author: Matteo Croce
Date: Thu Apr 11 12:26:33 2019 +0200
net: thunderx: don't allow jumbo frames with XDP
[ Upstream commit 1f227d16083b2e280b7dde4ca78883d75593f2fd ]
The thunderx driver forbids to load an eBPF program if the MTU is too high,
but this can be circumvented by loading the eBPF, then raising the MTU.
Fix this by limiting the MTU if an eBPF program is already loaded.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9de22b997fe40a0f783db73df5574d20242c6f09
Author: Matteo Croce
Date: Thu Apr 11 12:26:32 2019 +0200
net: thunderx: raise XDP MTU to 1508
[ Upstream commit 5ee15c101f29e0093ffb5448773ccbc786eb313b ]
The thunderx driver splits frames bigger than 1530 bytes to multiple
pages, making impossible to run an eBPF program on it.
This leads to a maximum MTU of 1508 if QinQ is in use.
The thunderx driver forbids to load an eBPF program if the MTU is higher
than 1500 bytes. Raise the limit to 1508 so it is possible to use L2
protocols which need some more headroom.
Fixes: 05c773f52b96e ("net: thunderx: Add basic XDP support")
Signed-off-by: Matteo Croce
Acked-by: Jesper Dangaard Brouer
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7ba5ec69e1a7ecfc662050b55e77078208dea9cc
Author: Eric Dumazet
Date: Sat Apr 13 17:32:21 2019 -0700
ipv4: ensure rcu\_read\_lock() in ipv4\_link\_failure()
[ Upstream commit c543cb4a5f07e09237ec0fc2c60c9f131b2c79ad ]
fib\_compute\_spec\_dst() needs to be called under rcu protection.
syzbot reported :
WARNING: suspicious RCU usage
5.1.0-rc4+ #165 Not tainted
include/linux/inetdevice.h:220 suspicious rcu\_dereference\_check() usage!
other info that might help us debug this:
rcu\_scheduler\_active = 2, debug\_locks = 1
1 lock held by swapper/0/0:
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: lockdep\_copy\_map include/linux/lockdep.h:170 [inline]
#0: 0000000051b67925 ((&n->timer)){+.-.}, at: call\_timer\_fn+0xda/0x720 kernel/time/timer.c:1315
stack backtrace:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.1.0-rc4+ #165
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x172/0x1f0 lib/dump\_stack.c:113
lockdep\_rcu\_suspicious+0x153/0x15d kernel/locking/lockdep.c:5162
\_\_in\_dev\_get\_rcu include/linux/inetdevice.h:220 [inline]
fib\_compute\_spec\_dst+0xbbd/0x1030 net/ipv4/fib\_frontend.c:294
spec\_dst\_fill net/ipv4/ip\_options.c:245 [inline]
\_\_ip\_options\_compile+0x15a7/0x1a10 net/ipv4/ip\_options.c:343
ipv4\_link\_failure+0x172/0x400 net/ipv4/route.c:1195
dst\_link\_failure include/net/dst.h:427 [inline]
arp\_error\_report+0xd1/0x1c0 net/ipv4/arp.c:297
neigh\_invalidate+0x24b/0x570 net/core/neighbour.c:995
neigh\_timer\_handler+0xc35/0xf30 net/core/neighbour.c:1081
call\_timer\_fn+0x190/0x720 kernel/time/timer.c:1325
expire\_timers kernel/time/timer.c:1362 [inline]
\_\_run\_timers kernel/time/timer.c:1681 [inline]
\_\_run\_timers kernel/time/timer.c:1649 [inline]
run\_timer\_softirq+0x652/0x1700 kernel/time/timer.c:1694
\_\_do\_softirq+0x266/0x95a kernel/softirq.c:293
invoke\_softirq kernel/softirq.c:374 [inline]
irq\_exit+0x180/0x1d0 kernel/softirq.c:414
exiting\_irq arch/x86/include/asm/apic.h:536 [inline]
smp\_apic\_timer\_interrupt+0x14a/0x570 arch/x86/kernel/apic/apic.c:1062
apic\_timer\_interrupt+0xf/0x20 arch/x86/entry/entry\_64.S:807
Fixes: ed0de45a1008 ("ipv4: recompile ip options in ipv4\_link\_failure")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Cc: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8a430e56a6485267a1b2d3747209d26c54d1a34b
Author: Stephen Suryaputra
Date: Fri Apr 12 16:19:27 2019 -0400
ipv4: recompile ip options in ipv4\_link\_failure
[ Upstream commit ed0de45a1008991fdaa27a0152befcb74d126a8b ]
Recompile IP options since IPCB may not be valid anymore when
ipv4\_link\_failure is called from arp\_error\_report.
Refer to the commit 3da1ed7ac398 ("net: avoid use IPCB in cipso\_v4\_error")
and the commit before that (9ef6b42ad6fd) for a similar issue.
Signed-off-by: Stephen Suryaputra
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b82df42059fb90862505eb071dd0dd225a2791df
Author: Jason Wang
Date: Tue Apr 9 12:10:25 2019 +0800
vhost: reject zero size iova range
[ Upstream commit 813dbeb656d6c90266f251d8bd2b02d445afa63f ]
We used to accept zero size iova range which will lead a infinite loop
in translate\_desc(). Fixing this by failing the request in this case.
Reported-by: syzbot+d21e6e297322a900c128@syzkaller.appspotmail.com
Fixes: 6b1e6cc7 ("vhost: new device IOTLB API")
Signed-off-by: Jason Wang
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 242e5746cb477bdb4c59d0f2d3c5a3e1c0a10629
Author: Hoang Le
Date: Tue Apr 9 14:59:24 2019 +0700
tipc: missing entries in name table of publications
[ Upstream commit d1841533e54876f152a30ac398a34f47ad6590b1 ]
When binding multiple services with specific type 1Ki, 2Ki..,
this leads to some entries in the name table of publications
missing when listed out via 'tipc name show'.
The problem is at identify zero last\_type conditional provided
via netlink. The first is initial 'type' when starting name table
dummping. The second is continuously with zero type (node state
service type). Then, lookup function failure to finding node state
service type in next iteration.
To solve this, adding more conditional to marked as dirty type and
lookup correct service type for the next iteration instead of select
the first service as initial 'type' zero.
Acked-by: Jon Maloy
Signed-off-by: Hoang Le
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit a60a47206a31b92af27ca65b66089b21c5b66d78
Author: Hangbin Liu
Date: Mon Apr 8 16:45:17 2019 +0800
team: set slave to promisc if team is already in promisc mode
[ Upstream commit 43c2adb9df7ddd6560fd3546d925b42cef92daa0 ]
After adding a team interface to bridge, the team interface will enter
promisc mode. Then if we add a new slave to team0, the slave will keep
promisc off. Fix it by setting slave to promisc on if team master is
already in promisc mode, also do the same for allmulti.
v2: add promisc and allmulti checking when delete ports
Fixes: 3d249d4ca7d0 ("net: introduce ethernet teaming device")
Signed-off-by: Hangbin Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 6728c6174a47b8a04ceec89aca9e1195dee7ff6b
Author: Eric Dumazet
Date: Tue Apr 16 10:55:20 2019 -0700
tcp: tcp\_grow\_window() needs to respect tcp\_space()
[ Upstream commit 50ce163a72d817a99e8974222dcf2886d5deb1ae ]
For some reason, tcp\_grow\_window() correctly tests if enough room
is present before attempting to increase tp->rcv\_ssthresh,
but does not prevent it to grow past tcp\_space()
This is causing hard to debug issues, like failing
the (\_\_tcp\_select\_window(sk) >= tp->rcv\_wnd) test
in \_\_tcp\_ack\_snd\_check(), causing ACK delays and possibly
slow flows.
Depending on tcp\_rmem[2], MTU, skb->len/skb->truesize ratio,
we can see the problem happening on "netperf -t TCP\_RR -- -r 2000,2000"
after about 60 round trips, when the active side no longer sends
immediate acks.
This bug predates git history.
Signed-off-by: Eric Dumazet
Acked-by: Soheil Hassas Yeganeh
Acked-by: Neal Cardwell
Acked-by: Wei Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1cd8788368226016b70af2c1e7d46c1bdb4756c6
Author: Lorenzo Bianconi
Date: Tue Apr 9 11:47:20 2019 +0200
net: fou: do not use guehdr after iptunnel\_pull\_offloads in gue\_udp\_recv
[ Upstream commit 988dc4a9a3b66be75b30405a5494faf0dc7cffb6 ]
gue tunnels run iptunnel\_pull\_offloads on received skbs. This can
determine a possible use-after-free accessing guehdr pointer since
the packet will be 'uncloned' running pskb\_expand\_head if it is a
cloned gso skb (e.g if the packet has been sent though a veth device)
Fixes: a09a4c8dd1ec ("tunnels: Remove encapsulation offloads on decap")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2804598764f984a8c5cdee377a73e0bf86dc5dd4
Author: Yuya Kusakabe
Date: Tue Apr 16 10:22:28 2019 +0900
net: Fix missing meta data in skb with vlan packet
[ Upstream commit d85e8be2a5a02869f815dd0ac2d743deb4cd7957 ]
skb\_reorder\_vlan\_header() should move XDP meta data with ethernet header
if XDP meta data exists.
Fixes: de8f3a83b0a0 ("bpf: add meta pointer for direct access")
Signed-off-by: Yuya Kusakabe
Signed-off-by: Takeru Hayasaka
Co-developed-by: Takeru Hayasaka
Reviewed-by: Toshiaki Makita
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 97fd88e04c8d724301839129b63ef663e9397a65
Author: Nikolay Aleksandrov
Date: Thu Apr 11 15:08:25 2019 +0300
net: bridge: multicast: use rcu to access port list from br\_multicast\_start\_querier
[ Upstream commit c5b493ce192bd7a4e7bd073b5685aad121eeef82 ]
br\_multicast\_start\_querier() walks over the port list but it can be
called from a timer with only multicast\_lock held which doesn't protect
the port list, so use RCU to walk over it.
Fixes: c83b8fab06fc ("bridge: Restart queries when last querier expires")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 08b0b4f28008ae81fa8fdf06d679a9edd6005d88
Author: Nikolay Aleksandrov
Date: Thu Apr 11 13:56:39 2019 +0300
net: bridge: fix per-port af\_packet sockets
[ Upstream commit 3b2e2904deb314cc77a2192f506f2fd44e3d10d0 ]
When the commit below was introduced it changed two visible things:
- the skb was no longer passed through the protocol handlers with the
original device
- the skb was passed up the stack with skb->dev = bridge
The first change broke af\_packet sockets on bridge ports. For example we
use them for hostapd which listens for ETH\_P\_PAE packets on the ports.
We discussed two possible fixes:
- create a clone and pass it through NF\_HOOK(), act on the original skb
based on the result
- somehow signal to the caller from the okfn() that it was called,
meaning the skb is ok to be passed, which this patch is trying to
implement via returning 1 from the bridge link-local okfn()
Note that we rely on the fact that NF\_QUEUE/STOLEN would return 0 and
drop/error would return < 0 thus the okfn() is called only when the
return was 1, so we signal to the caller that it was called by preserving
the return value from nf\_hook().
Fixes: 8626c56c8279 ("bridge: fix potential use-after-free when hook returns QUEUE or STOLEN verdict")
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bcb964012d1b17544f80a096bb4d6f8cfd32357b
Author: Gustavo A. R. Silva
Date: Mon Apr 15 15:57:23 2019 -0500
net: atm: Fix potential Spectre v1 vulnerabilities
[ Upstream commit 899537b73557aafbdd11050b501cf54b4f5c45af ]
arg is controlled by user-space, hence leading to a potential
exploitation of the Spectre variant 1 vulnerability.
This issue was detected with the help of Smatch:
net/atm/lec.c:715 lec\_mcast\_attach() warn: potential spectre issue 'dev\_lec' [r] (local cap)
Fix this by sanitizing arg before using it to index dev\_lec.
Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].
[1] https://lore.kernel.org/lkml/20180423164740.GY17484@dhcp22.suse.cz/
Signed-off-by: Gustavo A. R. Silva
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fae6053d761122b272bdd5bca81561d7da306812
Author: Si-Wei Liu
Date: Mon Apr 8 19:45:27 2019 -0400
failover: allow name change on IFF\_UP slave interfaces
[ Upstream commit 8065a779f17e94536a1c4dcee4f9d88011672f97 ]
When a netdev appears through hot plug then gets enslaved by a failover
master that is already up and running, the slave will be opened
right away after getting enslaved. Today there's a race that userspace
(udev) may fail to rename the slave if the kernel (net\_failover)
opens the slave earlier than when the userspace rename happens.
Unlike bond or team, the primary slave of failover can't be renamed by
userspace ahead of time, since the kernel initiated auto-enslavement is
unable to, or rather, is never meant to be synchronized with the rename
request from userspace.
As the failover slave interfaces are not designed to be operated
directly by userspace apps: IP configuration, filter rules with
regard to network traffic passing and etc., should all be done on master
interface. In general, userspace apps only care about the
name of master interface, while slave names are less important as long
as admin users can see reliable names that may carry
other information describing the netdev. For e.g., they can infer that
"ens3nsby" is a standby slave of "ens3", while for a
name like "eth0" they can't tell which master it belongs to.
Historically the name of IFF\_UP interface can't be changed because
there might be admin script or management software that is already
relying on such behavior and assumes that the slave name can't be
changed once UP. But failover is special: with the in-kernel
auto-enslavement mechanism, the userspace expectation for device
enumeration and bring-up order is already broken. Previously initramfs
and various userspace config tools were modified to bypass failover
slaves because of auto-enslavement and duplicate MAC address. Similarly,
in case that users care about seeing reliable slave name, the new type
of failover slaves needs to be taken care of specifically in userspace
anyway.
It's less risky to lift up the rename restriction on failover slave
which is already UP. Although it's possible this change may potentially
break userspace component (most likely configuration scripts or
management software) that assumes slave name can't be changed while
UP, it's relatively a limited and controllable set among all userspace
components, which can be fixed specifically to listen for the rename
events on failover slaves. Userspace component interacting with slaves
is expected to be changed to operate on failover master interface
instead, as the failover slave is dynamic in nature which may come and
go at any point. The goal is to make the role of failover slaves less
relevant, and userspace components should only deal with failover master
in the long run.
Fixes: 30c8bd5aa8b2 ("net: Introduce generic failover module")
Signed-off-by: Si-Wei Liu
Reviewed-by: Liran Alon
Acked-by: Sridhar Samudrala
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 2a458eddc4c270a435c26f0d22c46da36cbf00d2
Author: Sabrina Dubroca
Date: Fri Apr 12 15:04:10 2019 +0200
bonding: fix event handling for stacked bonds
[ Upstream commit 92480b3977fd3884649d404cbbaf839b70035699 ]
When a bond is enslaved to another bond, bond\_netdev\_event() only
handles the event as if the bond is a master, and skips treating the
bond as a slave.
This leads to a refcount leak on the slave, since we don't remove the
adjacency to its master and the master holds a reference on the slave.
Reproducer:
ip link add bondL type bond
ip link add bondU type bond
ip link set bondL master bondU
ip link del bondL
No "Fixes:" tag, this code is older than git history.
Signed-off-by: Sabrina Dubroca
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from bugs.chromium.org_9b0b8e50_20250121_010328.html ===


