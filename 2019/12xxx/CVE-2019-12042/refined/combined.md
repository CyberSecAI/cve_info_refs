=== Content from www.pandasecurity.com_88977a2b_20250121_000813.html ===


Hello!

You’re about to visit our web page in **Español**
 Would you like to continue?

Yes, I want to visit the web page in Español
No, I want to visit the web page in

If this is not what you’re looking for,

[Visit our Welcome Page!](https://www.pandasecurity.com)

* Protection
* [Panda Dome](https://www.pandasecurity.com/en/homeusers/)
* [Panda Dome Essential](https://www.pandasecurity.com/en/dome/essential/)
* [Panda Dome Advanced](https://www.pandasecurity.com/en/dome/advanced/)
* [Panda Dome Complete](https://www.pandasecurity.com/en/dome/complete/)
* [Panda Dome Premium](https://www.pandasecurity.com/en/dome/premium/)
* [Panda Dome Family](https://www.pandasecurity.com/en/homeusers/dome-family/)
* [Panda Dome for Android](https://www.pandasecurity.com/en/homeusers/android-antivirus/)
* [Panda Dome Free](https://www.pandasecurity.com/en/homeusers/free-antivirus/)

* Privacy
* [Panda VPN](https://www.pandasecurity.com/en/homeusers/vpn/)
* [Panda Dome Passwords](https://www.pandasecurity.com/en/homeusers/dome-passwords/)
* [Free password generator](https://www.pandasecurity.com/en/homeusers/password-generator/)
* [Dark Web Scanner](https://www.pandasecurity.com/en/dark-web-scanner/)

* Performance
* [Panda Cleanup](https://www.pandasecurity.com/en/homeusers/cleanup/)
* [Panda Cloud Cleaner](https://www.pandasecurity.com/en/homeusers/cloud-cleaner/)
* [Panda Total Care](https://www.pandasecurity.com/en/homeusers/premium-services/)

* Protection
* [Anti-malware](https://www.pandasecurity.com/en/features/antimalware/)
* [Anti-ransomware](https://www.pandasecurity.com/en/features/antiransomware/)
* [Antivirus](https://www.pandasecurity.com/en/features/antivirus/)
* [Antivirus for Mac](https://www.pandasecurity.com/en/homeusers/antivirus-for-mac/)
* [Antivirus for Windows](https://www.pandasecurity.com/en/homeusers/windows-antivirus/)
* [Firewall](https://www.pandasecurity.com/en/features/firewall/)
* [Parental Control](https://www.pandasecurity.com/en/features/parental-control/)
* [Safe Browsing](https://www.pandasecurity.com/en/features/safe-browsing/)

* Privacy
* [File Encryptor](https://www.pandasecurity.com/en/features/file-encryptor/)
* [File Shredder](https://www.pandasecurity.com/en/features/file-shredder/)
* [Password Manager](https://www.pandasecurity.com/en/features/password-manager/)
* [VPN for Android](https://www.pandasecurity.com/en/homeusers/android-vpn/)
* [Wi-fi Protection](https://www.pandasecurity.com/en/features/wifi-protection/)

* Performance
* [Gaming/Multimedia Mode](https://www.pandasecurity.com/en/features/gaming-multimedia-mode/)
* [Perfomance Optimization](https://www.pandasecurity.com/en/features/performance-optimization/)
* [Update Manager](https://www.pandasecurity.com/en/features/update-manager/)

* Protection
* [Cybersecurity solutions for Windows](https://www.pandasecurity.com/en/platforms/windows/)
* [Cybersecurity solutions for Android](https://www.pandasecurity.com/en/platforms/android/)
* [Cybersecurity solutions for Mac](https://www.pandasecurity.com/en/platforms/mac/)
* [Cybersecurity solutions for iOS](https://www.pandasecurity.com/en/platforms/ios/)

[![Panda Dome](/rfilescms/Logos/panda/panda_watchguard.webp)](https://www.pandasecurity.com/)

* [Windows Antivirus](https://www.pandasecurity.com/en/homeusers/windows-antivirus/)
* [Mac Antivirus](https://www.pandasecurity.com/en/homeusers/antivirus-for-mac/)
* [Downloads](https://www.pandasecurity.com/en/homeusers/downloads/)
* [Partners](https://www.pandasecurity.com/en/partners/)

* [Products](https://www.pandasecurity.com/en/homeusers/)
* Features
* Platforms
* [Blog](https://www.pandasecurity.com/en/mediacenter/)
* [Security Info](https://www.pandasecurity.com/en/security-info/)
* [Support](https://www.pandasecurity.com/en/support/)
* [Compare our plans](https://www.pandasecurity.com/en/homeusers/)

My Account

[![Panda Dome](/rfilescms/Logos/panda/panda_watchguard.webp)](https://www.pandasecurity.com/)

[Compare our plans](https://www.pandasecurity.com/en/homeusers/)

Products

Features

Platforms

[Blog](https://www.pandasecurity.com/en/mediacenter/)

[Security Info](https://www.pandasecurity.com/en/security-info/)

[Support](https://www.pandasecurity.com/en/support/)

[Windows Antivirus](https://www.pandasecurity.com/en/homeusers/windows-antivirus/)

[Mac Antivirus](https://www.pandasecurity.com/en/homeusers/antivirus-for-mac/)

[Downloads](https://www.pandasecurity.com/en/homeusers/downloads/)

[Partners](https://www.pandasecurity.com/en/partners/)

Products

Protection
Privacy
Performance

Features

Protection
Privacy
Performance

Platforms

Protection

Protection

[Panda Dome](https://www.pandasecurity.com/en/homeusers/)
[Panda Dome Essential](https://www.pandasecurity.com/en/dome/essential/)
[Panda Dome Advanced](https://www.pandasecurity.com/en/dome/advanced/)
[Panda Dome Complete](https://www.pandasecurity.com/en/dome/complete/)
[Panda Dome Premium](https://www.pandasecurity.com/en/dome/premium/)
[Panda Dome Family](https://www.pandasecurity.com/en/homeusers/dome-family/)
[Panda Dome for Android](https://www.pandasecurity.com/en/homeusers/android-antivirus/)
[Panda Dome Free](https://www.pandasecurity.com/en/homeusers/free-antivirus/)

Privacy

[Panda VPN](https://www.pandasecurity.com/en/homeusers/vpn/)
[Panda Dome Passwords](https://www.pandasecurity.com/en/homeusers/dome-passwords/)
[Free password generator](https://www.pandasecurity.com/en/homeusers/password-generator/)
[Dark Web Scanner](https://www.pandasecurity.com/en/dark-web-scanner/)

Performance

[Panda Cleanup](https://www.pandasecurity.com/en/homeusers/cleanup/)
[Panda Cloud Cleaner](https://www.pandasecurity.com/en/homeusers/cloud-cleaner/)
[Panda Total Care](https://www.pandasecurity.com/en/homeusers/premium-services/)

Protection

[Anti-malware](https://www.pandasecurity.com/en/features/antimalware/)
[Anti-ransomware](https://www.pandasecurity.com/en/features/antiransomware/)
[Antivirus](https://www.pandasecurity.com/en/features/antivirus/)
[Antivirus for Mac](https://www.pandasecurity.com/en/homeusers/antivirus-for-mac/)
[Antivirus for Windows](https://www.pandasecurity.com/en/homeusers/windows-antivirus/)
[Firewall](https://www.pandasecurity.com/en/features/firewall/)
[Parental Control](https://www.pandasecurity.com/en/features/parental-control/)
[Safe Browsing](https://www.pandasecurity.com/en/features/safe-browsing/)

Privacy

[File Encryptor](https://www.pandasecurity.com/en/features/file-encryptor/)
[File Shredder](https://www.pandasecurity.com/en/features/file-shredder/)
[Password Manager](https://www.pandasecurity.com/en/features/password-manager/)
[VPN for Android](https://www.pandasecurity.com/en/homeusers/android-vpn/)
[Wi-fi Protection](https://www.pandasecurity.com/en/features/wifi-protection/)

Performance

[Gaming/Multimedia Mode](https://www.pandasecurity.com/en/features/gaming-multimedia-mode/)
[Perfomance Optimization](https://www.pandasecurity.com/en/features/performance-optimization/)
[Update Manager](https://www.pandasecurity.com/en/features/update-manager/)

Protection

[Cybersecurity solutions for Windows](https://www.pandasecurity.com/en/platforms/windows/)
[Cybersecurity solutions for Android](https://www.pandasecurity.com/en/platforms/android/)
[Cybersecurity solutions for Mac](https://www.pandasecurity.com/en/platforms/mac/)
[Cybersecurity solutions for iOS](https://www.pandasecurity.com/en/platforms/ios/)

# **Hello! How can we help you?**

[Contact us through the web form](https://www.pandasecurity.com/en/support/contact.html?lng=2)      [Visit the Business Support website](https://www.pandasecurity.com/en/support/enterprise/)

![image](/rfilescms/pageWEBP/SUPPORT/DESKTOP/pandasecurity_support_hero_desktop.webp)
![image](/rfilescms/pageWEBP/SUPPORT/TABLET/pandasecurity_support_hero_tablet.webp)

![image](/rfilescms/pageWEBP/SUPPORT/MOBILE/pandasecurity_support_hero_mobile.webp)

### **Learn about the Help Center and about the most recurrent topics**

##### Getting started

Download and install your product fast.

[Everything on how to get started with your product](https://www.pandasecurity.com/en/support/get-started/)

##### Help Center

Help articles about how your product works.

[Access your Help Center](https://www.pandasecurity.com/homeusers/downloads/docs/product/help/pd/en/index.htm#t=10.htm)

##### My Panda

Personal area to manage your products and services, access to Support, promotions, and a lot more…

[Learn more about My Panda](https://www.pandasecurity.com/en/support/how-to-manage-your-account/)

### **Need information about a specific product?**

![logo](/rfilescms/Logos/ICON-LOGO-WEB/pandasecurity-icon-logo-dome.svg)

Browse and buy online safely and protect your Wi-Fi network.

**[Panda Dome](https://www.pandasecurity.com/en/support/panda-dome/)**

![logo](/rfilescms/Logos/pandasecurity-icon-logo-passwords-center.svg)

Manage your passwords and safeguard your personal information.

**[Panda Dome Passwords](https://www.pandasecurity.com/en/support/dome-passwords/)**

![logo](/rfilescms/Logos/pandasecurity-icon-logo-family-center.svg)

Protect and supervise your children's digital life with more than just parental control.

**[Panda Dome Family](https://www.pandasecurity.com/en/support/panda-family/)**

![logo](/rfilescms/Logos/pandasecurity-icon-logo-vpn-center.svg)

Protect and ensure your privacy and online security.

**[Panda Dome VPN](https://www.pandasecurity.com/en/support/vpn/)**

![logo](/rfilescms/Logos/pandasecurity-icon-logo-android-center.svg)

Protect your Android devices from virus, malware or spyware.

**[Panda Dome for Android](https://www.pandasecurity.com/en/support/android-antivirus/)**

### You can also contact our Support team through these channels:

##### **Web form**

Send us your questions through the web form.

[Access the web form](https://www.pandasecurity.com/en/support/contact.html?lng=2)

##### **Forum**

Join our community to keep up-to-date or to solve queries.

[Access the forum](https://support.pandasecurity.com/forum/)

### **Check our FAQs**

* [What is the Activation Code and where to find it?](https://www.pandasecurity.com/homeusers/downloads/docs/product/help/pd/en/index.htm#t=013.htm)
* [Error codes when activating Panda Dome products](https://techsearch.pandasecurity.com/pandakbview?id=kA16S000000bz3CSAQ)
* [How to transfer a Panda Dome license to another device](https://techsearch.pandasecurity.com/pandakbview?id=kA16S000000bz3KSAQ)
* [How to install the protection on Windows, macOS, Android, and iOS devices](https://www.pandasecurity.com/homeusers/downloads/docs/product/help/pd/en/index.htm#t=98.htm)
* [How to delete your account from Panda Dome Passwords](https://www.pandasecurity.com/homeusers/downloads/docs/product/help/pd/en/index.htm#t=012.htm)
* [What are the installation requirements of Panda Dome products?](https://www.pandasecurity.com/homeusers/downloads/docs/product/help/pd/en/index.htm#t=160.htm)

#### **Check out the latest cybersecurity news and get the best expert advice to stay protected and up to date**

[Visit our blog](https://www.pandasecurity.com/en/mediacenter/)

[![](https://www.pandasecurity.com/en/mediacenter/src/uploads/2025/01/pandasecurity-how-much-does-your-electric-car-know-about-you-360x160.webp)

January 20, 2025

##### How much does your electric car know about you?

Electric cars went mainstream this century. And like most recent inventions, new shiny EVs are packed with smart tech that collects all sorts of data...

[Read more](https://www.pandasecurity.com/en/mediacenter/how-much-does-your-electric-car-know-about-you/)](https://www.pandasecurity.com/en/mediacenter/how-much-does-your-electric-car-know-about-you/)

[![](https://www.pandasecurity.com/en/mediacenter/src/uploads/2025/01/pandasecurity-9-airbnb-scams-and-how-to-avoid-them-360x160.webp)

January 17, 2025

##### 9 Airbnb scams and how to avoid them

Airbnb is a hugely popular accommodation provider. With the option to rent apartments, houses and rooms on a short-term basis, travelers have a useful (and...

[Read more](https://www.pandasecurity.com/en/mediacenter/9-airbnb-scams-and-how-to-avoid-them/)](https://www.pandasecurity.com/en/mediacenter/9-airbnb-scams-and-how-to-avoid-them/)

[![](https://www.pandasecurity.com/en/mediacenter/src/uploads/2025/01/pandasecurity-toll-road-scams-are-on-the-rise-360x160.webp)

January 15, 2025

##### Toll road scams are on the rise

Toll road scams have been on the rise for months. This increase even triggered a statement from California’s Attorney General Rob Bonta. In a press...

[Read more](https://www.pandasecurity.com/en/mediacenter/toll-road-scams-are-on-the-rise/)](https://www.pandasecurity.com/en/mediacenter/toll-road-scams-are-on-the-rise/)

![logo](/rfilescms/Logos/panda/pandasecurity-panda_watchguard@2x.png)
Panda Security, a WatchGuard Technologies brand, offers the most advanced protection for your family and business. Its Panda Dome range provides maximum security against viruses, ransomware and computer espionage, and is compatible with [Windows](https://www.pandasecurity.com/en/platforms/windows), [Mac](https://www.pandasecurity.com/en/platforms/mac), [Android](https://www.pandasecurity.com/en/platforms/android) and [iOS](https://www.pandasecurity.com/en/platforms/ios).

##### About Panda

[Company Info](https://www.pandasecurity.com/en/company-profile/)
[Reviews](https://www.pandasecurity.com/en/reviews/)
[Awards and certifications](https://www.pandasecurity.com/en/awards/)
 [Panda Worldwide](https://www.pandasecurity.com/en/office-locator/)
[Blog](https://www.pandasecurity.com/en/mediacenter/)
[Security Info](https://www.pandasecurity.com/en/security-info/)

##### Home Users

[Panda Dome portfolio](https://www.pandasecurity.com/en/homeusers/)
[Customer Login Page](https://www.pandasecurity.com/en/renewal/)
[Online Antivirus](https://www.pandasecurity.com/en/homeusers/online-antivirus/)
[Downloads](https://www.pandasecurity.com/en/homeusers/downloads/)
[Free Antivirus](https://www.pandasecurity.com/en/homeusers/free-antivirus/)
[Free VPN](https://www.pandasecurity.com/en/homeusers/vpn/)
[Offers](https://www.pandasecurity.com/en/homeusers/offers/)

##### Business - WatchGuard Technologies

[WatchGuard](https://www.watchguard.com/)
[Endpoint Security](https://www.watchguard.com/wgrd-products/endpoint-security/)
[Network Security](https://www.watchguard.com/wgrd-products/network-security/)
[Authpoint MFA](https://www.watchguard.com/wgrd-products/authpoint/)
[Secure Wi-Fi](https://www.watchguard.com/wgrd-products/secure-wifi/)
[Partners](https://www.watchguard.com/wgrd-partners/)

![Visa](/rfilescms/Payments/visa.png "Visa")
![Master Card](/rfilescms/Payments/mastercard.png "Master Card")
![Maestro](/rfilescms/Payments/maestro.png "Maestro")
![Pay Pal](/rfilescms/Payments/paypal.png "Pay Pal")
![Apple Pay](/rfilescms/Payments/applepay.png "Apple Pay")

![Bank Transfer](/rfilescms/Payments/banktransfer.png "Bank Transfer")
![iDeal](/rfilescms/Payments/ideal.png "iDeal")
![Klarna](/rfilescms/Payments/klarna.png "Klarna")

[Privacy Policy](https://www.pandasecurity.com/en/homeusers/media/legal-notice/#e10)
[Legal Notice](https://www.pandasecurity.com/en/homeusers/media/legal-notice/)
[Cookie Policy](https://www.pandasecurity.com/en/homeusers/media/cookies-policy/)
[Return Policy](https://www.pandasecurity.com/en/homeusers/media/legal-notice/refund.htm)



=== Content from rce4fun.blogspot.com_ba10d81a_20250121_000810.html ===


# [Reverse Engineering 0x4 Fun](https://rce4fun.blogspot.com/)

Reverse Engineering & Windows Internals.

## Tuesday, May 14, 2019

### Panda Antivirus - Local Privilege Escalation (CVE-2019-12042)

Hello,

This blogpost is about a vulnerability that I found in Panda Antivirus that leads to privilege escalation from an unprivileged account to SYSTEM.

The affected products are : Versions < 18.07.03 of Panda Dome,
Panda Internet Security, Panda Antivirus Pro, Panda Global Protection,
Panda Gold Protection, and old versions of Panda Antivirus >= 15.0.4.

The vulnerability was fixed in the latest version : 18.07.03
####

#### The Vulnerability:

The vulnerable system service is *AgentSvc.exe*. This service creates a global section object and a corresponding global event that is signaled whenever a process that writes to the shared memory wants the data to be processed by the service. The vulnerability lies in the weak permissions that are affected to both these objects allowing "Everyone" including unprivileged users to manipulate the shared memory and the event.

|  |
| --- |
| (Click to zoom) |

####

####

####

####

|  |
| --- |
| (Click to zoom) |

#### Reverse Engineering and Exploitation :

The service creates a thread that waits indefinitely on the memory change event and parses the contents of the memory when the event is signaled. We'll briefly describe what the service expects the contents of the memory to be and how they're interpreted.

When the second *word* from the start of the shared memory isn't zero, a call is made to the function shown below with a pointer to the address of the head of a list.

|  |
| --- |
| (Click to zoom) |

The structure of a list element looks like this, we'll see what that string should be representing shortly :

*typedef struct StdList\_Event*

*{*

*struct StdList\_Event\* Next;*

*struct StdList\_Event\* Previous;*

*struct c\_string*

*{*

*union*

*{*

*char\* pStr;*

*char str[16];*

*};*

*unsigned int Length;*

*unsigned int InStructureStringMaxLen;*

*} DipsatcherEventString;*

*//..*

*};*

As shown below, the code expects a unicode string at offset 2 of the shared memory. It instantiates a "wstring" object with the string and converts the string to ANSI in a "string" object. Moreover, a string is initialized on line 50 with "3sa342ZvSfB68aEq" and passed to the function "DecodeAndDecryptData" along with the attacker's controlled ANSI string and a pointer to an output string object.

|  |
| --- |
| (Click to zoom) |

The function simply decodes the string from base64 and decrypts the result using RC2 with the key "3sa342ZvSfB68aEq". So whatever we supply in the shared memory must be RC2 encrypted and then base64 encoded.

|  |
| --- |
| (Click to zoom) |

When returning from the above function, the decoded data is converted to a "wstring" (indicating the nature of the decrypted data). The do-while loop extracts the sub-strings delimited by '|' and inserts each one of them in the list that was passed in the arguments.

|  |
| --- |
| (Click to zoom) |

When returning from this function, we're back at the thread's main function (code below) where the list is traversed and the strings are passed to the method *InsertEvent* of the *CDispatcher* class present in ***Dispatcher.dll***. We'll see in a second what an event stands for in this context.

|  |
| --- |
| (Click to zoom) |  |

In ***Dispatcher.dll*** we examine the *CDispatcher::InsertEvent* method and see that it inserts the event string in a *CQueue* queue.

|  |
| --- |
| (Click to zoom) |  |

The queue elements are processed in the ***CDispatcher::Run*** method running in a separate thread as shown in the disassembly below.

|  |
| --- |
| (Click to zoom) |  |  |

The ***CRegisterPlugin::ProcessEvent*** method does parsing of the attacker controlled string; Looking at the debug error messages, we find that we're dealing with an open-source JSON parser : <https://github.com/udp/json-parser>

|  |
| --- |
| (Click to zoom) |  |

Now that we know what the service expects us to send it as data, we need to know the JSON properties that we should supply.

The method **CDispatcher::Initialize** calls an interesting method **CRegisterPlugins::LoadAllPlugins** that reads the path where ***Panda*** is installed from the registry then accesses the "Plugins" folder and loads all the DLLs there.

A DLL that caught my attention immediately was ***Plugin\_Commands.dll*** and it appears that it executes command-line commands.

|  |
| --- |
| (Click to zoom) |  |

Since these DLLs have debugging error messages, they make locating methods pretty easy. It only takes a few seconds to find the *Run* method shown below in *Plugin\_Commands.dll*.

|  |
| --- |
| (Click to zoom) |

In this function we find the queried JSON properties from the input :

|  |
| --- |
| (Click to zoom) |

It also didn't hurt to intercept some of these JSON messages from the kernel debugger (it took me a few minutes to intercept a command-line execute event).

|  |
| --- |
| (Click to zoom) |

The *ExeName* field is present as we saw in the disassembly, an URL, and two md5 hashes. By then, I was wondering if it was possible to execute something from disk and what properties were mandatory and which were optional.

Tracking the *SourcePath* property in the *Run* method's disassembly we find a function that parses the value of this property and determines whether it points to an URL or to a file on disk. So it seems that it is possible to execute a file from disk by using the *file://* URI.

|  |
| --- |
| (Click to zoom) |

Looking for the mandatory properties, we find that we must supply at minimum these two : *ExeName* and *SourcePath* (as shown below).

|  |
| --- |
| Fails (JZ fail) if the property ExeName is absent |

|  |
| --- |
| Fails if the property SourcePath is absent |

However when we queue a "*CmdLineExecute*" event with only these two fields set, our process isn't created. While debugging this, I found that the "*ExeMD5*" property is also mandatory and it should contain a valid MD5 hash of the executable to run.

The function *CheckMD5Match* dynamically calculates the file hash and compares it to the one we supply in the JSON property.

|  |
| --- |
| (Click to zoom) |

And if successful the execution flow takes as to "CreateProcessW".

|  |
| --- |
| (Click to zoom) |

Testing with the following JSON (RC2 + Base64 encoded) we see that we successfully executed cmd.exe as SYSTEM :

> *{
>     "CmdLineExecute":
>     {
>         "ExeName": "cmd.exe",
>         "SourcePath": "file://C:\\Windows\\System32",
>         "ExeMD5": "fef8118edf7918d3c795d6ef03800519"
>     }
> }*

|  |
| --- |
| (Click to zoom) |

However when we try to supply an executable of our own, Panda will detect it as malware and delete it, even if the file is benign.

There is a simple bypass for this in which we tell *cmd.exe* to start our process for us instead. The final JSON would look like something like this :

> *{
>     "CmdLineExecute":
>     {
>         "ExeName": "cmd.exe",
>         "Parameters": "/c start C:\\Users\\VM\\Desktop\\run\_me\_as\_system.exe",
>         "SourcePath": "file://C:\\Windows\\System32",
>         "ExeMD5": "fef8118edf7918d3c795d6ef03800519" //MD5 hash of CMD.EXE
>     }
> }*

The final exploit drops a file from the resource section to disk, calculates the MD5 hash of *cmd.exe* present on the machine, builds the JSON, encrypts then encodes it, and finally writes the result to the shared memory prior to signaling the event.

Also note that the exploit works without recompiling on all the products affected under all supported Windows versions.

|  |
| --- |
| (Click to zoom) |

**The exploit's source code is on my GitHub page, here is a link to the repository :** <https://github.com/SouhailHammou/Panda-Antivirus-LPE>

Thanks for reading and until another time :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[8:22 PM](https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html "permanent link")

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=6272124231222852461&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=pinterest "Share to Pinterest")

#### No comments:

#### Post a Comment

[Newer Post](https://rce4fun.blogspot.com/2019/08/comodo-antivirus-sandbox-race-condition.html "Newer Post")

[Older Post](https://rce4fun.blogspot.com/2019/04/circumventing-windows-defender-atps.html "Older Post")

[Home](https://rce4fun.blogspot.com/)

Subscribe to:
[Post Comments (Atom)](https://rce4fun.blogspot.com/feeds/6272124231222852461/comments/default)

## About Me

[![My photo](//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRP2EB6FmvVo5hGAuMUTz6tUD7V6lY4KHdiEi3fL6SQ_oXnw194JLga3ZNLAukMPe26FOn8i4irGAe8HzYyqfdkgPcGUXNujFPgqj8vuR7CQKcnCaEnCt7b5x_ugtVVg/s1600/5301567%3Fs%3D400%26u%3Dee68f7175f61c22ec316b2d366d97a68d33f0685%26v%3D4)](https://www.blogger.com/profile/05531641153833567407)
[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407)

[View my complete profile](https://www.blogger.com/profile/05531641153833567407)

## Blog Archive

* ▼
  [2019](https://rce4fun.blogspot.com/2019/)
  (5)
  + ►
    [August](https://rce4fun.blogspot.com/2019/08/)
    (1)
  + ▼
    [May](https://rce4fun.blogspot.com/2019/05/)
    (1)
    - [Panda Antivirus - Local Privilege Escalation (CVE-...](https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html)
  + ►
    [April](https://rce4fun.blogspot.com/2019/04/)
    (1)
  + ►
    [March](https://rce4fun.blogspot.com/2019/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2019/02/)
    (1)

* ►
  [2018](https://rce4fun.blogspot.com/2018/)
  (3)
  + ►
    [October](https://rce4fun.blogspot.com/2018/10/)
    (1)
  + ►
    [September](https://rce4fun.blogspot.com/2018/09/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2018/02/)
    (1)

* ►
  [2017](https://rce4fun.blogspot.com/2017/)
  (6)
  + ►
    [November](https://rce4fun.blogspot.com/2017/11/)
    (3)
  + ►
    [June](https://rce4fun.blogspot.com/2017/06/)
    (1)
  + ►
    [May](https://rce4fun.blogspot.com/2017/05/)
    (1)
  + ►
    [April](https://rce4fun.blogspot.com/2017/04/)
    (1)

* ►
  [2015](https://rce4fun.blogspot.com/2015/)
  (2)
  + ►
    [March](https://rce4fun.blogspot.com/2015/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2015/02/)
    (1)

* ►
  [2014](https://rce4fun.blogspot.com/2014/)
  (19)
  + ►
    [November](https://rce4fun.blogspot.com/2014/11/)
    (2)
  + ►
    [October](https://rce4fun.blogspot.com/2014/10/)
    (1)
  + ►
    [September](https://rce4fun.blogspot.com/2014/09/)
    (4)
  + ►
    [August](https://rce4fun.blogspot.com/2014/08/)
    (1)
  + ►
    [July](https://rce4fun.blogspot.com/2014/07/)
    (1)
  + ►
    [May](https://rce4fun.blogspot.com/2014/05/)
    (1)
  + ►
    [April](https://rce4fun.blogspot.com/2014/04/)
    (1)
  + ►
    [March](https://rce4fun.blogspot.com/2014/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2014/02/)
    (2)
  + ►
    [January](https://rce4fun.blogspot.com/2014/01/)
    (5)

* ►
  [2013](https://rce4fun.blogspot.com/2013/)
  (2)
  + ►
    [December](https://rce4fun.blogspot.com/2013/12/)
    (1)
  + ►
    [November](https://rce4fun.blogspot.com/2013/11/)
    (1)

## Blog Roll

* ![]()

  [Kami Blog](https://kami.ma/)

  [Hello world!](http://kami.ma/hello-world/)
* ![]()

  [waliedassar](http://waleedassar.blogspot.com/)

  [Call64, Bypassing Wow64 Emulation Layer](http://waleedassar.blogspot.com/2013/01/call64-no-wow64-emulation-layer.html)

|  |  |
| --- | --- |

Simple theme. Powered by [Blogger](https://www.blogger.com).



=== Content from rce4fun.blogspot.com_cca796ef_20250121_021605.html ===


# Reverse Engineering 0x4 Fun

Reverse Engineering & Windows Internals.

## Tuesday, August 13, 2019

### [Comodo Antivirus - Sandbox Race Condition Use-After-Free (CVE-2019-14694)](https://rce4fun.blogspot.com/2019/08/comodo-antivirus-sandbox-race-condition.html)

Hello,

In this blogpost I'm going to share an analysis of a recent finding in yet another Antivirus, this time in Comodo AV. After reading this [awesome research](https://medium.com/tenable-techblog/comodo-from-sandbox-to-system-cve-2019-3969-b6a34cc85e67) by Tenable, I decided to give it a look myself and play a bit with the sandbox.

I ended up finding a vulnerability by accident in the kernel-mode part of the sandbox implemented in the minifilter driver **cmdguard.sys**. Although the impact is just a BSOD (Blue Screen of Death), I have found the vulnerability quite interesting and worthy of a write-up.

Comodo's sandbox filters file I/O allowing contained processes to read from the volume normally but redirects all writes to '\VTRoot\HarddiskVolume#\' located at the root of the volume on which Windows is installed.

For each file or directory opened (IRP\_MJ\_CREATE) by a contained process, the preoperation callback allocates an internal structure where multiple fields are initialized.

The callbacks for the minifilter's data queue, a cancel-safe IRP queue, are initialized at offset 0x140 of the structure as the disassembly below shows. In addition, the queue list head is initialized at offset 0x1C0, and the first QWORD of the same struct is set to 0xB5C0B5C0B5C0B5C.

|  |
| --- |
| (Figure 1) |

Next, a stream handle context is set for the file object and a pointer to the previously discussed internal structure is stored at offset 0x28 of the context.

Keep in mind that a stream handle context is unique per file object (user-mode handle).

|  |
| --- |
| (Figure 2) |

The only minifilter callback which queues IRPs to the data queue is present in the IRP\_MJ\_DIRECTORY\_CONTROL preoperation callback for the minor function IRP\_MN\_NOTIFY\_CHANGE\_DIRECTORY.

Before the IRP\_MJ\_DIRECTORY\_CONTROL checks the minor function, it first verifies whether a stream handle context is available and whether a data queue is already present within. It checks if the pointer at offset 0x28 is valid and whether the magic value 0xB5C0B5C0B5C0B5C is present.

|  |
| --- |
| **(Figure 3) : Click to Zoom** |

Before the call to FltCbdqInsertIo, the stream handle context is retrieved and a non-paged pool allocation of size 0xE0 is made of which the pointer is stored in RDI as shown below.

|  |
| --- |
| (Figure 4) |

Later on, this structure is stored inside the FilterContext array of the FLT\_CALLBACK\_DATA structure for this request and is passed as a context to the insert routine.

|  |
| --- |
| (Figure 5) |

FltCbdqInsertIo will eventually call the InsertIoCallback (seen initialized on Figure 1). Examining this routine we see that it queues the callback data structure to the data queue and then invokes FltQueueDeferredIoWorkItem to insert a work item that will be dispatched in a system thread later on.

As you can see from the disassembly below, the work item's dispatch routine (DeferredWorkItemRoutine) receives the newly allocated non-paged memory (Figure 4) as a context.

|  |
| --- |
| **(Figure 6) : Click To Zoom** |

Here is a quick recap of what we saw until now :

* For every file/directory open, a data queue is initialized and stored at offset 0x140 of an internal structure.
* A context is allocated in which a pointer to the previous structure is stored at offset 0x28. This context is set as a stream handle context.
* IRP\_MJ\_DIRECTORY\_CONTROL checks if the minor function is IRP\_MN\_NOTIFY\_CHANGE\_DIRECTORY.
* If that's the case, a non-paged pool allocation of size 0xE0 is made and initialized.
* The allocation is stored inside the FLT\_CALLBACK\_DATA and is passed to FltCbdqInsertIo as a context.
* FltCbdqInsertIo ends up calling the insert callback (InsertIoCallback) with the non-paged pool allocation as a context.
* The insert callback inserts the request into the queue, queues a deferred work item with the same allocation as a context.

It is very simple for a sandboxed user-mode process to make the minifilter take this code path, it only needs to call the API **FindFirstChangeNotificationA** on an arbitrary directory.

Let's carry on.

So, the work item's context (non-paged pool allocation made by IRP\_MJ\_DIRECTORY\_CONTROL for the directory change notification request) must be freed somewhere, right ? This is accomplished by IRP\_MJ\_CLEANUP 's preoperation routine.

As you might already know, IRP\_MJ\_CLEANUP is sent when the last handle of a file object is closed, so the callback must perform the janitor's work at this stage.

In this instance, The stream handle context is retrieved similarly to what we saw earlier. Next, the queue is disabled so no new requests are queued, and then the queue cleanup is done by "DoCleanup".

|  |
| --- |
| (Figure 8) |

As shown below this sub-routine dequeues the pended requests from the data queue, retrieves the saved context structure in FLT\_CALLBACK\_DATA, completes the operation, and then goes on to free the context.

|  |
| --- |
| (Figure 9) |

We can trigger what we've seen until now from a contained process by :

* Calling FindFirstChangeNotificationA on an arbitrary directory e.g. "C:\" : Sends IRP\_MJ\_DIRECTORY\_CONTROL and causes the delayed work item to be queued.
* Closing the handle : Sends IRP\_MJ\_CLEANUP.

What can go wrong here ? The answer to that is freeing the context before the delayed work item is dispatched which would eventually receive a freed context and use it (use-after-free).

In other words, we have to make the minifilter receive an IRP\_MJ\_CLEANUP request before the delayed work item queued in IRP\_MJ\_DIRECTORY\_CONTROL is dispatched for execution.

When trying to reproduce the vulnerability with a single thread, I noticed that the work item is always dispatched before IRP\_MJ\_CLEANUP is received. This makes sense in my opinion since the work item queue doesn't contain many items and dispatching a work item would take less time than all the work the subsequent call to CloseHandle does.

So the idea here was to create multiple threads that infinitely call :

***CloseHandle(FindFirstChangeNotificationA(..))*** to saturate the work item queue as much as possible and delay the dispatching of work items until the contexts are freed. A crash occurs once a work item accesses a freed context's pool allocation that was corrupted by some new allocation.

Below is the proof of concept to reproduce the vulnerability :

And here is a small Windbg trace to see what happens in practice (inside parentheses is the address of the context) :
> 1. [...]
>
>        QueueWorkItem(fffffa8062dc6f20)
>
>        DeferredWorkItem(fffffa8062dc6f20)
>
>        ExFreePoolWithTag(fffffa8062dc6f20)
>
>        [...]
>
>     2. QueueWorkItem(**fffffa80635d2ea0**)
>
>        ExFreePoolWithTag(**fffffa80635d2ea0**)
>
>        QueueWorkItem(fffffa8062dd5c10)
>
>        ExFreePoolWithTag(fffffa8062dd5c10)
>
>        QueueWorkItem(fffffa8062dd6890)
>
>        ExFreePoolWithTag(fffffa8062dd6890)
>
>        QueueWorkItem(fffffa8062ddac80)
>
>        ExFreePoolWithTag(fffffa8062ddac80)
>
>        QueueWorkItem(fffffa80624cd5e0)
>
>        [...]
>
>     3. DeferredWorkItem(**fffffa80635d2ea0**)

In (1.) everything is normal, the work item is queued, dispatched and then the pool allocation it uses is freed.

In (2.) things start going wrong, the work item is queued but before it is dispatched the context is freed.

In (3.) the deferred work item is dispatched with freed and corrupted memory in its context causing an access violation and thus a BSOD.

We see in this case that the freed pool allocation was entirely repurposed and is now part of a file object :

|  |
| --- |
| **(Figure 10) : Click to Zoom** |

Reproducing the bug, you will encounter an access violation at this part of the code:

|  |
| --- |
| (Figure 11) |

And as we can see, it expects multiple pointers to be valid including a resource pointer which makes exploitation non-trivial.

That's all for this article, until next time :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[5:14 PM](https://rce4fun.blogspot.com/2019/08/comodo-antivirus-sandbox-race-condition.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2019/08/comodo-antivirus-sandbox-race-condition.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=2283046817055356337&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2283046817055356337&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2283046817055356337&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2283046817055356337&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2283046817055356337&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2283046817055356337&target=pinterest "Share to Pinterest")

## Tuesday, May 14, 2019

### [Panda Antivirus - Local Privilege Escalation (CVE-2019-12042)](https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html)

Hello,

This blogpost is about a vulnerability that I found in Panda Antivirus that leads to privilege escalation from an unprivileged account to SYSTEM.

The affected products are : Versions < 18.07.03 of Panda Dome,
Panda Internet Security, Panda Antivirus Pro, Panda Global Protection,
Panda Gold Protection, and old versions of Panda Antivirus >= 15.0.4.

The vulnerability was fixed in the latest version : 18.07.03
####

#### The Vulnerability:

The vulnerable system service is *AgentSvc.exe*. This service creates a global section object and a corresponding global event that is signaled whenever a process that writes to the shared memory wants the data to be processed by the service. The vulnerability lies in the weak permissions that are affected to both these objects allowing "Everyone" including unprivileged users to manipulate the shared memory and the event.

|  |
| --- |
| (Click to zoom) |

####

####

####

####

|  |
| --- |
| (Click to zoom) |

#### Reverse Engineering and Exploitation :

The service creates a thread that waits indefinitely on the memory change event and parses the contents of the memory when the event is signaled. We'll briefly describe what the service expects the contents of the memory to be and how they're interpreted.

When the second *word* from the start of the shared memory isn't zero, a call is made to the function shown below with a pointer to the address of the head of a list.

|  |
| --- |
| (Click to zoom) |

The structure of a list element looks like this, we'll see what that string should be representing shortly :

*typedef struct StdList\_Event*

*{*

*struct StdList\_Event\* Next;*

*struct StdList\_Event\* Previous;*

*struct c\_string*

*{*

*union*

*{*

*char\* pStr;*

*char str[16];*

*};*

*unsigned int Length;*

*unsigned int InStructureStringMaxLen;*

*} DipsatcherEventString;*

*//..*

*};*

As shown below, the code expects a unicode string at offset 2 of the shared memory. It instantiates a "wstring" object with the string and converts the string to ANSI in a "string" object. Moreover, a string is initialized on line 50 with "3sa342ZvSfB68aEq" and passed to the function "DecodeAndDecryptData" along with the attacker's controlled ANSI string and a pointer to an output string object.

|  |
| --- |
| (Click to zoom) |

The function simply decodes the string from base64 and decrypts the result using RC2 with the key "3sa342ZvSfB68aEq". So whatever we supply in the shared memory must be RC2 encrypted and then base64 encoded.

|  |
| --- |
| (Click to zoom) |

When returning from the above function, the decoded data is converted to a "wstring" (indicating the nature of the decrypted data). The do-while loop extracts the sub-strings delimited by '|' and inserts each one of them in the list that was passed in the arguments.

|  |
| --- |
| (Click to zoom) |

When returning from this function, we're back at the thread's main function (code below) where the list is traversed and the strings are passed to the method *InsertEvent* of the *CDispatcher* class present in ***Dispatcher.dll***. We'll see in a second what an event stands for in this context.

|  |
| --- |
| (Click to zoom) |  |

In ***Dispatcher.dll*** we examine the *CDispatcher::InsertEvent* method and see that it inserts the event string in a *CQueue* queue.

|  |
| --- |
| (Click to zoom) |  |

The queue elements are processed in the ***CDispatcher::Run*** method running in a separate thread as shown in the disassembly below.

|  |
| --- |
| (Click to zoom) |  |  |

The ***CRegisterPlugin::ProcessEvent*** method does parsing of the attacker controlled string; Looking at the debug error messages, we find that we're dealing with an open-source JSON parser : <https://github.com/udp/json-parser>

|  |
| --- |
| (Click to zoom) |  |

Now that we know what the service expects us to send it as data, we need to know the JSON properties that we should supply.

The method **CDispatcher::Initialize** calls an interesting method **CRegisterPlugins::LoadAllPlugins** that reads the path where ***Panda*** is installed from the registry then accesses the "Plugins" folder and loads all the DLLs there.

A DLL that caught my attention immediately was ***Plugin\_Commands.dll*** and it appears that it executes command-line commands.

|  |
| --- |
| (Click to zoom) |  |

Since these DLLs have debugging error messages, they make locating methods pretty easy. It only takes a few seconds to find the *Run* method shown below in *Plugin\_Commands.dll*.

|  |
| --- |
| (Click to zoom) |

In this function we find the queried JSON properties from the input :

|  |
| --- |
| (Click to zoom) |

It also didn't hurt to intercept some of these JSON messages from the kernel debugger (it took me a few minutes to intercept a command-line execute event).

|  |
| --- |
| (Click to zoom) |

The *ExeName* field is present as we saw in the disassembly, an URL, and two md5 hashes. By then, I was wondering if it was possible to execute something from disk and what properties were mandatory and which were optional.

Tracking the *SourcePath* property in the *Run* method's disassembly we find a function that parses the value of this property and determines whether it points to an URL or to a file on disk. So it seems that it is possible to execute a file from disk by using the *file://* URI.

|  |
| --- |
| (Click to zoom) |

Looking for the mandatory properties, we find that we must supply at minimum these two : *ExeName* and *SourcePath* (as shown below).

|  |
| --- |
| Fails (JZ fail) if the property ExeName is absent |

|  |
| --- |
| Fails if the property SourcePath is absent |

However when we queue a "*CmdLineExecute*" event with only these two fields set, our process isn't created. While debugging this, I found that the "*ExeMD5*" property is also mandatory and it should contain a valid MD5 hash of the executable to run.

The function *CheckMD5Match* dynamically calculates the file hash and compares it to the one we supply in the JSON property.

|  |
| --- |
| (Click to zoom) |

And if successful the execution flow takes as to "CreateProcessW".

|  |
| --- |
| (Click to zoom) |

Testing with the following JSON (RC2 + Base64 encoded) we see that we successfully executed cmd.exe as SYSTEM :

> *{
>     "CmdLineExecute":
>     {
>         "ExeName": "cmd.exe",
>         "SourcePath": "file://C:\\Windows\\System32",
>         "ExeMD5": "fef8118edf7918d3c795d6ef03800519"
>     }
> }*

|  |
| --- |
| (Click to zoom) |

However when we try to supply an executable of our own, Panda will detect it as malware and delete it, even if the file is benign.

There is a simple bypass for this in which we tell *cmd.exe* to start our process for us instead. The final JSON would look like something like this :

> *{
>     "CmdLineExecute":
>     {
>         "ExeName": "cmd.exe",
>         "Parameters": "/c start C:\\Users\\VM\\Desktop\\run\_me\_as\_system.exe",
>         "SourcePath": "file://C:\\Windows\\System32",
>         "ExeMD5": "fef8118edf7918d3c795d6ef03800519" //MD5 hash of CMD.EXE
>     }
> }*

The final exploit drops a file from the resource section to disk, calculates the MD5 hash of *cmd.exe* present on the machine, builds the JSON, encrypts then encodes it, and finally writes the result to the shared memory prior to signaling the event.

Also note that the exploit works without recompiling on all the products affected under all supported Windows versions.

|  |
| --- |
| (Click to zoom) |

**The exploit's source code is on my GitHub page, here is a link to the repository :** <https://github.com/SouhailHammou/Panda-Antivirus-LPE>

Thanks for reading and until another time :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[8:22 PM](https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=6272124231222852461&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=6272124231222852461&target=pinterest "Share to Pinterest")

## Saturday, April 6, 2019

### [Circumventing Windows Defender ATP's user-mode APC Injection sensor from Kernel-mode](https://rce4fun.blogspot.com/2019/04/circumventing-windows-defender-atps.html)

In this blogpost, I will share a simple technique to circumvent the check that was introduced in Windows 10 build 1809 to detect user-mode APC injection. This technique will only allow us to "bypass" the sensor when we're running code from kernel-mode, i.e., queuing a user-mode APC to a remote thread from user-mode will still be logged. For more information about this new feature, please check out my previous [blogpost](http://rce4fun.blogspot.com/2019/03/examining-user-mode-apc-injection.html).

In short, the sensor will log any user-mode APCs queued to a remote thread, be it from user-mode or kernel-mode. The most important check is implemented in the kernel function : *EtwTiLogQueueApcThread* as shown below.

|  |
| --- |
| (Click to zoom) |

So queuing a user-mode APC to a thread in a process other than ours is considered suspicious and will be logged. However, when having code execution in kernel-mode we can queue a kernel-mode APC that will run in the context of the target process and from there we can queue a user-mode APC. This way, the check when *KeInsertQueueApc* is called from the kernel-mode APC will always yield (UserApc->Thread->Process  == CurrentThread->Process).

I have written a simple driver to test this out : <https://github.com/SouhailHammou/Drivers/tree/master/Apc-Injection-ATP-Bypass>

* The driver registers a *CreateThreadNotifyRoutine* in its *DriverEntry*.
* *CreateThreadNotifyRoutine* queues a kernel-mode APC to a newly created thread.
* The kernel-mode APC is delivered as soon as the IRQL drops below APC\_LEVEL in the target thread in which we allocate executable memory in user-space, copy the shellcode, then queue the user-mode APC.
* The user-mode APC is delivered in user-mode.

The only issue here is that Windows Defender's ATP will still log the allocation of executable memory thanks to another sensor.

Thanks for your time :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[7:23 PM](https://rce4fun.blogspot.com/2019/04/circumventing-windows-defender-atps.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2019/04/circumventing-windows-defender-atps.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=2314209747569903483&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2314209747569903483&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2314209747569903483&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2314209747569903483&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2314209747569903483&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=2314209747569903483&target=pinterest "Share to Pinterest")

## Wednesday, March 27, 2019

### [Examining the user-mode APC injection sensor introduced in Windows 10 build 1809](https://rce4fun.blogspot.com/2019/03/examining-user-mode-apc-injection.html)

Yesterday I've read Microsoft's blog post about the new ATP kernel sensors added to log injection of user-mode APCs. That got me curious and I went to examine the changes in *KeInsertQueueApc*.

The instrumentation code invokes the function *EtwTiLogQueueApcThread* to log the event. The function's prototype looks like this :
> VOID EtwTiLogQueueApcThread(
>
>     BYTE PreviousMode,
>
>     PKTHREAD ApcThread, //Apc->Thread
>
>     PVOID NormalRoutine,
>
>     PVOID NormalContext,
>
>     PVOID SystemArgument1,
>
>     PVOID SystemArgument2);

*EtwTiLogQueueApcThread* is only called when the queued APC is a user-mode APC and if *KeInsertQueueApc* successfully inserted the APC into the queue (Thread->ApcQueueable && !Apc->Inserted).

*EtwTiLogQueueApcThread* first checks whether the user-mode APC has been queued to a remote process or not and only logs the event in the former case.

It also distinguishes between remotely queued APCs from user-mode (*NtQueueApcThread(Ex))* and those queued from kernel-mode; The former is used to detect user-mode injection techniques like [this one](https://www.securitynewspaper.com/2018/04/17/new-early-bird-code-injection-technique/).

As shown below, two event descriptors exist and the one to log is determined using the current thread's previous mode to know whether the APC was queued by a user process or by a kernel driver.

|  |
| --- |
| (Click to zoom) |

Looking at where the event provider registration handle *EtwThreatIntProvRegHandle* is referenced, we see that not only remote user-mode APC injection is logged but also a bunch of events that are commonly used by threats.

|  |
| --- |
| (Click to zoom) |

Thanks for reading and until another time :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[6:26 PM](https://rce4fun.blogspot.com/2019/03/examining-user-mode-apc-injection.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2019/03/examining-user-mode-apc-injection.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=3735784426318963354&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=3735784426318963354&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=3735784426318963354&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=3735784426318963354&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=3735784426318963354&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=3735784426318963354&target=pinterest "Share to Pinterest")

## Tuesday, February 5, 2019

### [VirtualProtectEx to bypass ASLR : A specific case study](https://rce4fun.blogspot.com/2019/02/virtualprotectex-to-bypass-aslr.html)

More than a year ago, I developed a local privilege escalation exploit for a product (that I cannot disclose unfortunately) in which I had to bypass ASLR.

For the record, these are the protections enabled in the targeted service's binary, it is a 32-bit executable running under Wow64 on 64-bit systems.

[![](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiGNb8UB5SVVtJOgn5vZ33ADAycgTJlvPIwOBQuVb-RAPHhvfT_8VGK3Q2u-Dxu2jNktd1YT2mqHvQRuxoZ0-PgBLW67-xpe1URU65rnpq9FxFueR84yxLnTDg7_AKeCoacBJwZov-oBfdh/s320/Capture.PNG)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiGNb8UB5SVVtJOgn5vZ33ADAycgTJlvPIwOBQuVb-RAPHhvfT_8VGK3Q2u-Dxu2jNktd1YT2mqHvQRuxoZ0-PgBLW67-xpe1URU65rnpq9FxFueR84yxLnTDg7_AKeCoacBJwZov-oBfdh/s1600/Capture.PNG)

Basically, I was able to communicate through IPC with the system service and tell it to execute a function in its address space by pointer (it's a bit more tricky than this but you get the point). Actually, this would have been impossible if *CFG* was enabled.

Within the main module, I have located a function that invokes "*system()*" with an argument that I control. At this point, it was just a matter of bypassing ASLR in order to get that function's address and elevate privileges on the machine. However, I couldn't trigger any leaks through the IPC channel to get or deduce the main module's base.

But as luck would have it, the service exposed some other functionalities through IPC and one of them was the ability to call *VirtualProtectEx* and letting us supply a PID, the address, the size, and the new protection. The service was also kind enough to return the old protection of the region to our process via IPC.

Bypassing ASLR should be obvious by now knowing these two crucial points :

* The function that we want to invoke resides in the main module.
* On Windows the main executable's module of a process is the first module, with the lowest address in the user address space.

It is now only a matter of writing code to communicate with the service and to brute-force the location of the main module; we do that by looking for the first ***executable*** page in the address space and then calculating the main module's base : generally by subtracting 0x1000 from that page since the .text section is the first section.

The pseudo-code below shows an example of how this was done :

Launching a new process with SYSTEM privileges was easy at this point.

Thank you for reading and until another time :)

You can follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[3:06 PM](https://rce4fun.blogspot.com/2019/02/virtualprotectex-to-bypass-aslr.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2019/02/virtualprotectex-to-bypass-aslr.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=648131807606424305&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=648131807606424305&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=648131807606424305&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=648131807606424305&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=648131807606424305&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=648131807606424305&target=pinterest "Share to Pinterest")

## Saturday, October 6, 2018

### [Flare-On 5 CTF - Challenge 12 Writeup](https://rce4fun.blogspot.com/2018/10/flare-on-5-ctf-challenge-12-writeup.html)

Flare-on was a blast this year ! All challenges were great but I enjoyed solving the last one the most, although it was somewhat frustrating.

Due to my tight schedule, I won't go over all the details involved in solving the challenge. But I'll do my best to paint a complete picture of what's going on and how I approached the problem.

We start we a floppy disk image that you can download from [here](https://mega.nz/#!QVwyiYpL!XSI9vgvmes6DVOvgxu3Gy7eFlPrImS31VGXnlq_h0-Y) (PW : infected) :

![](data:image/png;base64...)

When we boot the floppy using bochs, we see that it automatically executes infohelp.exe that asks us for a password.
Entering an arbitrary password, the message "Welcome to FLARE..." prints slowly on the screen and the password checks are performed.

![](data:image/png;base64...)

What I did after this, is I mounted the floppy on my Ubuntu virtual machine and extracted the files in bold.

> souhail@ubuntu:/mnt/floppy$ ls
> AUTOEXEC.BAT  EGA2.CPI      IO.SYS        KEYBRD3.SYS  MODE.COM
> COMMAND.COM   EGA3.CPI      KEYB.COM      KEYBRD4.SYS  MSDOS.SYS
> CONFIG.SYS    EGA.CPI       KEYBOARD.SYS  **key.dat**      **TMP.DAT**
> DISPLAY.SYS   **infohelp.exe**  KEYBRD2.SYS   **message.dat**
> souhail@ubuntu:/mnt/floppy$

Both key.dat and message.dat contain nothing interesting. However, TMP.DAT appeared to contain the welcome message we see after typing the password and some funny strings like : "NICK RULES" and "BE SURE TO DRINK YOUR OVALTINE".

What I did next is I threw infohelp.exe into IDA to examine its behavior. To my surprise, I found that it does nothing but writes the supplied password to **key.dat** and then reads the contents of **message.dat** and prints them to the screen.

Here I thought that there should be some hooks involved that redirect execution to somewhere else when **message.dat** is opened or read. To confirm my suspicions, I executed the "type" command on message.dat; Lo and behold, the password check is performed.

![](data:image/png;base64...)

Next, I opened TMP.DAT in IDA and found that it contains some code that seems to be our hook. So I attached IDA to bochs and started debugging.

To locate the hook within memory, I took advantage of the fact that the message is printed in a slow fashion so what I did is pause execution while stuff was still printing. I found myself in a loop implementing the ***subleq VM***.

The caller supplies a pointer to the bytecode, its size, and the offset to the instruction where execution should start.

![](data:image/png;base64...)

Each instruction is 6 bytes and has the following format :

struct inst {
    WORD src\_index;
    WORD dest\_index;
    WORD branch\_index;
};

The type of the subleq bytecode array is WORD\*, so the VM views that its instruction size is 3 while it is 6 actually. This realization comes in handy when building an IDA processor module for the subleq.

As I did with last year's binary, I re-implemented the subleq VM with C to output each executed instruction to a file. However, I had an impossible-to-analyze file with over 1 GB. So what I did, is only print the subleq for the instructions that perform the password checks; That way I had a 30 MB-ish file that I could examine looking for patterns.

The way I had the emulated instructions printed was the following :

![](data:image/png;base64...)

IP : sub [dest\_index], [src\_index] ; subtraction = result

The only thing that was visible on the fly is that the subleq starts by doing some initialization in the beginning and then enters a loop that keeps executing until the end. Here where suspicions of a second VM started to arise in my mind (OMG !).

I tried to locate the password characters inside the subleq and tried to figure out what operations were done on them but it was not clear at all.

I also did some text diffing between iterations and saw that the code was modifying itself. In these instances, the self-modification was done in order to dereference VM pointers and use their values as indexes in subsequent operations.

So, what I decided to do here is write a very minimal processor module that would allow me to view the subleq in a neat graph.

The module's source code is available [here](https://github.com/SouhailHammou/CTF/blob/master/Flare-on%205%20-%202018/Challenge%2012/subleq_ida_proc.py).

The file I extracted contains bytecode starting from IP : 0x5. So here's how you load it into IDA :

- Choose the subleq bytecode processor module and make sure to disable auto-analysis. It ruins everything when enabled.

![](data:image/png;base64...)

-  Change the ROM start address to 0xA and the input file loading address to the same : 0x5 \* sizeof(WORD) == 0xA.

![](data:image/png;base64...)

The bytecode will be loaded without being analyzed.

![](data:image/png;base64...)

- Press 'P' at 0xA to convert into code and automatically into a function. You should have a beautiful graph as a result.

![](data:image/png;base64...)

![](data:image/png;base64...)

Well, it is not quite as beautiful as you might think, since we still have to deal with self-modifying code (knowing what exactly is modified) and also understanding the code as a whole.

It is quite hard to understand what subleq does by only reading "subleq" instructions, so the next thing that came to mind is to convert the subleq to MOV and ADD instructions without wasting too much time.

IDAPYTHON TO THE RESCUE !

I wrote a minimal script that looks for ADD and MOV patterns in the subleq and comments these instructions. First of all, the script intentionally skips the instructions that will be self-modified and doesn't comment the SUB since it's already there.

And the result was this :

![](data:image/png;base64...)

More understandable ... still, not so much.

So what I did next is decompile this manually into C and then simplify the code.

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_
> *WORD\* ptr = vm\_code;
>
>     int i = 0;
>
>     while ( ptr[0] < 0x4B6E )
>     {
>         WORD op\_addr = ptr[ ptr[0] ];
>         WORD res;
>
>         if ( op\_addr == -2 )
>         {
>             break; //Exit
>         }
>
>         if ( op\_addr == -1 )
>         {
>             ptr[0]++;
>         }
>         else
>         {
>             res = ptr[op\_addr] - ptr[1]; //SUB op, ACCUM
>
>             ptr[1] = res; //ACCUM
>
>             if ( op\_addr != 2 )
>             {
>                 ptr[op\_addr] = res;
>             }
>
>             if ( res < 0 )
>             {
>                 ptr[0]++;
>             }
>
>             ptr[0]++;
>         }
>
>         if ( ptr[6] == 1 )
>         {
>             printf("%c", ptr[4]);
>             ptr[6] = ptr[4] = 0;
>         }*

> *if ( ptr[5] == 1 )
>         {
>             ptr[5] = 0;
>             scanf("%c", &ptr[3]);
>         }*

> *}*

\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_

So it is indeed another VM interpreted by the subleq. The nature of the VM was unknown to me until later when someone told me that it was RSSB. But I was able, however, to solve the challenge without needing that information.

Now, this RSSB VM executes bytecode that starts at offset 0xFEC from the start of the subleq or at offset 0x1250 of the TMP.DAT file.

If you dumped the bytecode from memory as I did, you'd find that the password you typed was written inside the RSSB VM at offset 0x21C (circled in red).

![](data:image/png;base64...)
So far so good. I copied the whole RSSB bytecode and added it as an array and modified the C emulator code to print the "sub" instructions while executing the VM; the same way I did with the subleq.

The result looked like this :

![](data:image/png;base64...)
IP : p[dest\_index], ACCUM ; operation

Reading the code, I found out that a sum is calculated for the characters in the password. In addition to that, the number of characters in the password must be 64. I knew that by examining a variable that gets decremented from 64 at each iteration of the sum calculation.

![](data:image/png;base64...)

For information, the sum is stored at : p[0b47].

So I patched the memory to store a 64 byte string and then I looked up where the first character of the input was read apart from where the sum was calculated. I performed a search for [010e] ( 0x21C / 2 == 0x010E).

![](data:image/png;base64...)
65 in dec == 0x41 in hex

Long story short, the algorithm works in a loop, in each iteration *two characters* of the password are used to calculate a value. The sum of all characters is then added to that value as shown in the figure below (sum : in red, value : in green).

![](data:image/png;base64...)

A few instructions later, a hardcoded value at [0a79] is subtracted from the resulting value of the previous operation.

![](data:image/png;base64...)

We can see that the resulting value of the next two characters for example is compared against the next hardcoded value at [0a7a] and so on until the 30th character.

So, we have a password of 64 bytes but from which only the first 30 bytes are checked !
Let's leave that aside for now and ask : what makes a check correct ? Maybe the result of the subtraction must be zero ?

I quickly added a check onto my C emulator that did the following :

> *res = ptr[op\_addr] - ptr[1];
>
>             if ( ptr[0] == 0x203d ) //IP of the check, see figure above
>             {
>                 res = 0;
>             }*

This will simply patch the result to zero in the check at 0x203d. I ran the program and it showed that the password was correct, so I knew I was on the right path.

![](data:image/png;base64...)

I also observed (based on a single test case) that in each iteration the calculated value depends on the position of the two characters. So even if we have the same two characters at different places the calculated value will be different.

**Solution :** *Here I am going to describe how I solved the challenge during the CTF. Surely this is not the best solution out there, but I'd like to show my line of thought and how I came to solve this level.*

We know that the same sum is used in all the operations, and that there can be only one sum (or a handful as we'll get to see later) that will satisfy all the checks.

We can run a bruteforce attack where we let the VM calculate the value for two given characters (by patching the characters at run-time) then run the check on all possible sums (by patching the sum at run-time too). The first check will give us a lot of sums that we'll use to bruteforce the second check. In its turn, this check will filter out invalid sums that we'll eliminate from the third check and so on until we do all 15 of them. (30 characters / 2 characters per check == 15 checks).

At the end, we'll get the valid sums from which we can easily deduce the characters that generated them in each check.

The problem I had with this approach was performance. For each combination of two characters, and for each sum, I was running the VM all over again which, if I left like that, would take a huge amount of time : printing the welcome message, calculating the sum for junk characters ... over and over again each time !

What I ended up doing is "snapshotting" the VM in multiple states.

**Snapshot 1** : Where the first character of the two is read (depending on the iteration we're in).
**Snapshot 2** : For each two characters, take a snapshot after the value that depends on both of them is calculated and right at the address where the sum is read and added to the calculated value (IP == 0x1ff7).

The optimization here is that we execute what we only need to execute and nothing more. We patch the two characters by the ones we're currently bruteforcing at Snapshot 1 and then after the value is calculated for those two we take Snapshot 2 and we only get to patch the sum. When each iteration is over, we re-initialize the snapshots to their original states.

Here's the overall algorithm involved in pseudo-code (*this is not C nor anything close*) :

> *sums [xxx] = {...};*
> *new\_sums [yyy] = {0};*
>
> *for ( i = 0; i < 15; i++)*
> *{*
> *memcpy(initial\_state\_tmp, initial\_state);*
> *snapshot\_1 = take\_snapshot\_1(initial\_state\_tmp, i); //i is passed to go to the corresponding check*
>
> *for ( c1 = 0x20; c1 <= 0x7F; c1++ )*
> *{*
> *for ( c2 = 0x20; c2 <= 0x7F; c2++)*
> *{*
> *memcpy(snapshot\_1\_tmp, snapshot\_1);*
> *write\_characters\_to\_mem\_at\_offset(snapshot\_1\_tmp ,c1 , c2 , i);*
>
>
> *snapshot\_2 = take\_snapshot\_2(snapshot\_1\_tmp);*
> *for ( sum in sums )*
> *{*
> *memcpy(snapshot\_2\_tmp, snapshot\_2);*
> *write\_sum\_to\_mem(snapshot\_2\_tmp ,sum);*

//Execute the subtraction check and return a boolean

*if ( execute\_check(snapshot\_2\_tmp) )*
> *{*
> *append(new\_sums, sum); //valid sum, append it*
> *}*
> *}*
> *}*
> *}*
> *sums = new\_sums;*
> *new\_sums = [0];*
> *}*
>
> *print sums;*

At the end we'll get the valid sums that resulted in the check being equal to 0.

Here's the full C script implementing this (a bit messy) :

After the 15 checks are done, the script gives us files containing the valid sums that passed each of the checks. We're only interested in the last file (4KB in size) highlighted below :

![](data:image/png;base64...)

![](data:image/png;base64...)
Contents of array\_14

I actually forgot to include the characters that generated the sum for each check. And I had to do it separately.

This requires some modifications of the code above : we initialize the sums array with the contents of ***array\_14*** and for each sum bruteforce the two characters that pass each check. To optimize, I listed the first four characters (two first checks) for each one of these sums.

And one of them was particularly interesting. The sum ***0xd15e*** resulted in these four characters "Av0c".

Running the same script for this single sum while bruteforcing all of the characters gives us the flag :

[![](data:image/png;base64...)](https://www.blogger.com/blogger.g?blogID=2397431924465699816)

Flag : **Av0cad0\_Love\_2018@flare-on.com**

Well in the end, this one really deserved being the 12th, it was time consuming, frustrating and above all FUN !

Thanks for bearing with me and until another time guys - take care :)

Follow me on Twitter : [here](https://twitter.com/Dark_Puzzle)

Posted by

[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407 "author profile")

at

[1:05 AM](https://rce4fun.blogspot.com/2018/10/flare-on-5-ctf-challenge-12-writeup.html "permanent link")

[No comments:](https://rce4fun.blogspot.com/2018/10/flare-on-5-ctf-challenge-12-writeup.html#comment-form)

[![](https://resources.blogblog.com/img/icon18_edit_allbkg.gif)](https://www.blogger.com/post-edit.g?blogID=2397431924465699816&postID=1513781546304254617&from=pencil "Edit Post")

[Email This](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=1513781546304254617&target=email "Email This")[BlogThis!](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=1513781546304254617&target=blog "BlogThis!")[Share to X](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=1513781546304254617&target=twitter "Share to X")[Share to Facebook](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=1513781546304254617&target=facebook "Share to Facebook")[Share to Pinterest](https://www.blogger.com/share-post.g?blogID=2397431924465699816&postID=1513781546304254617&target=pinterest "Share to Pinterest")

[Older Posts](https://rce4fun.blogspot.com/search?updated-max=2018-10-06T01:05:00%2B01:00&max-results=7 "Older Posts")

[Home](https://rce4fun.blogspot.com/)

Subscribe to:
[Posts (Atom)](https://rce4fun.blogspot.com/feeds/posts/default)

## About Me

[![My photo](//blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRP2EB6FmvVo5hGAuMUTz6tUD7V6lY4KHdiEi3fL6SQ_oXnw194JLga3ZNLAukMPe26FOn8i4irGAe8HzYyqfdkgPcGUXNujFPgqj8vuR7CQKcnCaEnCt7b5x_ugtVVg/s1600/5301567%3Fs%3D400%26u%3Dee68f7175f61c22ec316b2d366d97a68d33f0685%26v%3D4)](https://www.blogger.com/profile/05531641153833567407)
[Souhail Hammou](https://www.blogger.com/profile/05531641153833567407)

[View my complete profile](https://www.blogger.com/profile/05531641153833567407)

## Blog Archive

* ▼
  [2019](https://rce4fun.blogspot.com/2019/)
  (5)
  + ▼
    [August](https://rce4fun.blogspot.com/2019/08/)
    (1)
    - [Comodo Antivirus - Sandbox Race Condition Use-Afte...](https://rce4fun.blogspot.com/2019/08/comodo-antivirus-sandbox-race-condition.html)
  + ►
    [May](https://rce4fun.blogspot.com/2019/05/)
    (1)
  + ►
    [April](https://rce4fun.blogspot.com/2019/04/)
    (1)
  + ►
    [March](https://rce4fun.blogspot.com/2019/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2019/02/)
    (1)

* ►
  [2018](https://rce4fun.blogspot.com/2018/)
  (3)
  + ►
    [October](https://rce4fun.blogspot.com/2018/10/)
    (1)
  + ►
    [September](https://rce4fun.blogspot.com/2018/09/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2018/02/)
    (1)

* ►
  [2017](https://rce4fun.blogspot.com/2017/)
  (6)
  + ►
    [November](https://rce4fun.blogspot.com/2017/11/)
    (3)
  + ►
    [June](https://rce4fun.blogspot.com/2017/06/)
    (1)
  + ►
    [May](https://rce4fun.blogspot.com/2017/05/)
    (1)
  + ►
    [April](https://rce4fun.blogspot.com/2017/04/)
    (1)

* ►
  [2015](https://rce4fun.blogspot.com/2015/)
  (2)
  + ►
    [March](https://rce4fun.blogspot.com/2015/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2015/02/)
    (1)

* ►
  [2014](https://rce4fun.blogspot.com/2014/)
  (19)
  + ►
    [November](https://rce4fun.blogspot.com/2014/11/)
    (2)
  + ►
    [October](https://rce4fun.blogspot.com/2014/10/)
    (1)
  + ►
    [September](https://rce4fun.blogspot.com/2014/09/)
    (4)
  + ►
    [August](https://rce4fun.blogspot.com/2014/08/)
    (1)
  + ►
    [July](https://rce4fun.blogspot.com/2014/07/)
    (1)
  + ►
    [May](https://rce4fun.blogspot.com/2014/05/)
    (1)
  + ►
    [April](https://rce4fun.blogspot.com/2014/04/)
    (1)
  + ►
    [March](https://rce4fun.blogspot.com/2014/03/)
    (1)
  + ►
    [February](https://rce4fun.blogspot.com/2014/02/)
    (2)
  + ►
    [January](https://rce4fun.blogspot.com/2014/01/)
    (5)

* ►
  [2013](https://rce4fun.blogspot.com/2013/)
  (2)
  + ►
    [December](https://rce4fun.blogspot.com/2013/12/)
    (1)
  + ►
    [November](https://rce4fun.blogspot.com/2013/11/)
    (1)

## Blog Roll

* ![]()

  [Kami Blog](https://kami.ma/)

  [Hello world!](http://kami.ma/hello-world/)
* ![]()

  [waliedassar](http://waleedassar.blogspot.com/)

  [Call64, Bypassing Wow64 Emulation Layer](http://waleedassar.blogspot.com/2013/01/call64-no-wow64-emulation-layer.html)

|  |  |
| --- | --- |

Simple theme. Powered by [Blogger](https://www.blogger.com).



=== Content from github.com_8c20096f_20250121_000810.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSouhailHammou%2FPanda-Antivirus-LPE)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FSouhailHammou%2FPanda-Antivirus-LPE)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=SouhailHammou%2FPanda-Antivirus-LPE)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[SouhailHammou](/SouhailHammou)
/
**[Panda-Antivirus-LPE](/SouhailHammou/Panda-Antivirus-LPE)**
Public

* [Notifications](/login?return_to=%2FSouhailHammou%2FPanda-Antivirus-LPE) You must be signed in to change notification settings
* [Fork
  13](/login?return_to=%2FSouhailHammou%2FPanda-Antivirus-LPE)
* [Star
   36](/login?return_to=%2FSouhailHammou%2FPanda-Antivirus-LPE)

The exploit for Panda AV LPE

[36
stars](/SouhailHammou/Panda-Antivirus-LPE/stargazers) [13
forks](/SouhailHammou/Panda-Antivirus-LPE/forks) [Branches](/SouhailHammou/Panda-Antivirus-LPE/branches) [Tags](/SouhailHammou/Panda-Antivirus-LPE/tags) [Activity](/SouhailHammou/Panda-Antivirus-LPE/activity)
 [Star](/login?return_to=%2FSouhailHammou%2FPanda-Antivirus-LPE)

 [Notifications](/login?return_to=%2FSouhailHammou%2FPanda-Antivirus-LPE) You must be signed in to change notification settings

* [Code](/SouhailHammou/Panda-Antivirus-LPE)
* [Issues
  0](/SouhailHammou/Panda-Antivirus-LPE/issues)
* [Pull requests
  0](/SouhailHammou/Panda-Antivirus-LPE/pulls)
* [Actions](/SouhailHammou/Panda-Antivirus-LPE/actions)
* [Projects
  0](/SouhailHammou/Panda-Antivirus-LPE/projects)
* [Security](/SouhailHammou/Panda-Antivirus-LPE/security)
* [Insights](/SouhailHammou/Panda-Antivirus-LPE/pulse)

Additional navigation options

* [Code](/SouhailHammou/Panda-Antivirus-LPE)
* [Issues](/SouhailHammou/Panda-Antivirus-LPE/issues)
* [Pull requests](/SouhailHammou/Panda-Antivirus-LPE/pulls)
* [Actions](/SouhailHammou/Panda-Antivirus-LPE/actions)
* [Projects](/SouhailHammou/Panda-Antivirus-LPE/projects)
* [Security](/SouhailHammou/Panda-Antivirus-LPE/security)
* [Insights](/SouhailHammou/Panda-Antivirus-LPE/pulse)

# SouhailHammou/Panda-Antivirus-LPE

    master[Branches](/SouhailHammou/Panda-Antivirus-LPE/branches)[Tags](/SouhailHammou/Panda-Antivirus-LPE/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[23 Commits](/SouhailHammou/Panda-Antivirus-LPE/commits/master/) | | |
| [bin](/SouhailHammou/Panda-Antivirus-LPE/tree/master/bin "bin") | | [bin](/SouhailHammou/Panda-Antivirus-LPE/tree/master/bin "bin") |  |  |
| [README.md](/SouhailHammou/Panda-Antivirus-LPE/blob/master/README.md "README.md") | | [README.md](/SouhailHammou/Panda-Antivirus-LPE/blob/master/README.md "README.md") |  |  |
| [base64.c](/SouhailHammou/Panda-Antivirus-LPE/blob/master/base64.c "base64.c") | | [base64.c](/SouhailHammou/Panda-Antivirus-LPE/blob/master/base64.c "base64.c") |  |  |
| [base64.h](/SouhailHammou/Panda-Antivirus-LPE/blob/master/base64.h "base64.h") | | [base64.h](/SouhailHammou/Panda-Antivirus-LPE/blob/master/base64.h "base64.h") |  |  |
| [exploit.c](/SouhailHammou/Panda-Antivirus-LPE/blob/master/exploit.c "exploit.c") | | [exploit.c](/SouhailHammou/Panda-Antivirus-LPE/blob/master/exploit.c "exploit.c") |  |  |
| [poc.png](/SouhailHammou/Panda-Antivirus-LPE/blob/master/poc.png "poc.png") | | [poc.png](/SouhailHammou/Panda-Antivirus-LPE/blob/master/poc.png "poc.png") |  |  |
| [resource.h](/SouhailHammou/Panda-Antivirus-LPE/blob/master/resource.h "resource.h") | | [resource.h](/SouhailHammou/Panda-Antivirus-LPE/blob/master/resource.h "resource.h") |  |  |
| View all files | | |

## Repository files navigation

* README
# Panda Antivirus - Local Privilege Escalation (CVE-2019-12042)

This is the exploit for a vulnerability I found in Panda Antivirus leading to escalation of privileges to SYSTEM.

The affected products are : Versions < 18.07.03 of Panda Dome, Panda Internet Security, Panda Antivirus Pro, Panda Global Protection, Panda Gold Protection, and old versions of Panda Antivirus >= 15.0.4.

The issue has been fixed in version 18.07.03.

A compiled x86 exploit can be found under the [bin](/SouhailHammou/Panda-Antivirus-LPE/blob/master/bin) directory, it executes as SYSTEM a dummy program that loops indefinitely. The compiled exploit is universal to all Windows versions and to all the products above.

Link to advisory : <https://www.pandasecurity.com/usa/support/card?id=100063>

## Technical write-up

<https://rce4fun.blogspot.com/2019/05/panda-antivirus-local-privilege.html>

#### Poc image (Windows 10 x64)

[![PoC](/SouhailHammou/Panda-Antivirus-LPE/raw/master/poc.png)](/SouhailHammou/Panda-Antivirus-LPE/blob/master/poc.png)

## About

The exploit for Panda AV LPE

### Resources

[Readme](#readme-ov-file)

[Activity](/SouhailHammou/Panda-Antivirus-LPE/activity)
### Stars

[**36**
stars](/SouhailHammou/Panda-Antivirus-LPE/stargazers)
### Watchers

[**5**
watching](/SouhailHammou/Panda-Antivirus-LPE/watchers)
### Forks

[**13**
forks](/SouhailHammou/Panda-Antivirus-LPE/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2FSouhailHammou%2FPanda-Antivirus-LPE&report=SouhailHammou+%28user%29)

## [Releases](/SouhailHammou/Panda-Antivirus-LPE/releases)

No releases published

## [Packages 0](/users/SouhailHammou/packages?repo_name=Panda-Antivirus-LPE)

No packages published

## Languages

* [C
  100.0%](/SouhailHammou/Panda-Antivirus-LPE/search?l=c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


