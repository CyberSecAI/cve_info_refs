=== Content from talosintelligence.com_f3c64d79_20250121_002559.html ===


* [Cisco Login](/users/auth/saml)

* [Intelligence Center](/reputation)

  + [# Intelligence Center](/reputation)
  + BACK
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* [Vulnerability Research](/vulnerability_info)

  + [# Vulnerability Research](/vulnerability_info)
  + BACK
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* [Incident Response](/incident_response)

  + [# Incident Response](/incident_response)
  + BACK
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* [Blog](https://blog.talosintelligence.com)
* [Support](https://support.talosintelligence.com)

More

* Security Resources

  # Security Resources

  + BACK
  Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* Media

  # Media

  + BACK
  Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* Company

  # Company

  + BACK
  Company
  + [About Talos](/about)
  + [Careers](/careers)

* Under Attack?
* [Cisco Login](/users/auth/saml)

## Contact Cisco Talos Incident Response

×

Close

This form is for Incident Response service inquiries only, including emergency network security needs.

For reputation or categorization inquiries, visit the [Talos Support site](/support).
For emergency DDoS mitigation assistance, please contact the [Cisco Secure DDoS Protection Team](https://www.cisco.com/c/en/us/products/collateral/security/ddos-emergency-attack-mitigation-aag.pdf).

Name

Company (optional)

Email address

Phone number

Preferred communication:

Email

Phone

What Incident Response Service are you interested in?
General Talos IR services and retainer information
Emergency Response
IR Plan
IR Playbooks
IR Readiness Assessment
Tabletop Exercises
Compromise Assessment
Threat Hunting
Cyber Range Training
Intelligence on Demand

Please provide as much detail as possible so we can best address your needs

I acknowledge that this is an inquiry for Incident Response services and that any other use of this form will not receive a response.

Send Email
Cancel

# Talos Vulnerability Report

### TALOS-2019-0878

## xcftools flattenIncrementally tiles walk code execution vulnerability

##### November 21, 2019

##### CVE Number

CVE-2019-5086

### Summary

An exploitable integer overflow vulnerability exists in the flattenIncrementally function in the xcf2png and xcf2pnm binaries of xcftools, version 1.0.7. An integer overflow can occur while walking through tiles that could be exploited to corrupt memory and execute arbitrary code. In order to trigger this vulnerability, a victim would need to open a specially crafted XCF file.

### Tested Versions

xcftools 1.0.7

### Product URLs

http://henning.makholm.net/xcftools/

### CVSSv3 Score

7.5 - CVSS:3.0/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H

### CWE

CWE-680: Integer Overflow to Buffer Overflow

### Details

Xcftools is a set of tools for handling Gimp’s XCF files. It provides an `xcfinfo` tool for extracting information from an XCF file, and `xcf2png` and `xcf2pnm` for converting an XCF to PNG or PNM format.

When converting an XCF, the utilities first parse the file using the function `getBasicXcfInfo`. For each XCF layer, the function `computeDimensions` is called:

```
struct tileDimensions {
  struct rect c ;
  unsigned width, height ;
  unsigned tilesx, tilesy ;
  unsigned ntiles ;
};

struct rect {
  int t, b, l, r ;
};

void
computeDimensions(struct tileDimensions *d)
{
  d->c.r = d->c.l + d->width ;                            // [1]
  d->c.b = d->c.t + d->height ;                           // [2]
  d->tilesx = (d->width+TILE_WIDTH-1)/TILE_WIDTH ;
  d->tilesy = (d->height+TILE_HEIGHT-1)/TILE_HEIGHT ;
  d->ntiles = d->tilesx * d->tilesy ;
}

```

The function takes a structure containing some information about the layer: width, height, horizontal and vertical offset. These values are all gathered from the input file. The code calculates the bounds of the layer by filling the `rect` structure.

As we can see at [1], the “horizontal offset” (`d->c.l`) is used together with the layer width, to calculate the “right” field of the rectangle. Similarly, the code calculates the “bottom” position at [2].

Note that when autocrop is enabled (command line switch “-C”), the window’s dimensions are computed from the layers rather than from the canvas itself. When the `flattenIncrementally` function is called, rows are populated by reading the `spec` structure (previously populated by `complete_flatspec`):

```
#define TILE_LEFT(x) ((x) & -TILE_WIDTH)       // & 0xffffffc0
#define TILE_WIDTH (1<<TILE_SHIFT)             // 64
#define TILE_SHIFT 6

flattenIncrementally(struct FlattenSpec *spec,lineCallback callback)
{
  rgba *rows[TILE_HEIGHT] ;
  unsigned i, y, nrows, ncols ;
  struct rect where ;
  struct Tile *tile ;
  static struct Tile toptile ;

  toptile.count = TILE_HEIGHT * TILE_WIDTH ;
  fillTile(&toptile,0);

  for( where.t = spec->dim.c.t; where.t < spec->dim.c.b; where.t=where.b ) {     // [3]
    where.b = TILE_TOP(where.t)+TILE_HEIGHT ;
    if( where.b > spec->dim.c.b ) where.b = spec->dim.c.b ;
    nrows = where.b - where.t ;
    for( y = 0; y < nrows ; y++ )
      rows[y] = xcfmalloc(4*(spec->dim.c.r-spec->dim.c.l));

    for( where.l = spec->dim.c.l; where.l < spec->dim.c.r; where.l=where.r ) {   // [4]
      where.r = TILE_LEFT(where.l)+TILE_WIDTH ;                                  // [5]
      if( where.r > spec->dim.c.r ) where.r = spec->dim.c.r ;
      ncols = where.r - where.l ;
      ...
      for( y = 0 ; y < nrows ; y++ )
        memcpy(rows[y] + (where.l - spec->dim.c.l),                              // [6]
               tile->pixels + y * ncols, ncols*4);
      ...

```

At [3] and [4], the code loops for each tile in the layer and copies the data in `rows`. Since tiles are aligned, at [5] the horizontal limit (“right”) of the current tile is computed. This command however doesn’t take integer overflows into account: for example, assuming that all dimensions in `spec` are positive, if `where.l` was 0x7fffffe0, `where.r` would become 0x80000000, which is negative since the fields in the `rect` structure are signed. At this point, when the cycle loops at [4], `where.l` will have the value 0x80000000 assigned, and the loop termination condition `where.l < spec->dim.c.r` won’t be met, since `where.l` is negative.

This makes the for loop at [4] to cycle unexpectedly, which could be exploited to corrupt the heap at [6], leading to arbitrary code execution.

### Crash Information

```
$ ./xcf2png -o test poc -C
Warning: XCF version 3 not supported (trying anyway...)
=================================================================
==13592==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xf2e02e7c at pc 0xf797543b bp 0xfffddc98 sp 0xfffdd868
WRITE of size 128 at 0xf2e02e7c thread T0
    #0 0xf797543a in __interceptor_memcpy /build/gcc/src/gcc/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:790
    #1 0x56672c26 in flattenIncrementally /src_1.0.7/flatten.c:647
    #2 0x56653a2b in main /src_1.0.7/xcf2png.c:417
    #3 0xf76da7d0 in __libc_start_main (/usr/lib32/libc.so.6+0x1e7d0)
    #4 0x56656e40 in _start (/src_1.0.7/xcf2png+0xae40)

0xf2e02e7c is located 0 bytes to the right of 124-byte region [0xf2e02e00,0xf2e02e7c)
allocated by thread T0 here:
    #0 0xf79ed3e9 in __interceptor_malloc /build/gcc/src/gcc/libsanitizer/asan/asan_malloc_linux.cc:144
    #1 0x56661468 in xcfmalloc /src_1.0.7/utils.c:103

SUMMARY: AddressSanitizer: heap-buffer-overflow /build/gcc/src/gcc/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:790 in __interceptor_memcpy
Shadow bytes around the buggy address:
  0x3e5c0570: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0580: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0590: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x3e5c05c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00[04]
  0x3e5c05d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0600: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0610: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==13592==ABORTING

```
### Timeline

2019-07-31 - Initial contact

2019-08-07 - Plain text file sent

2019-10-02 - 60+ day follow up

2019-10-21 - 90 day notice

2019-11-21 - Public release

##### Credit

Discovered by Claudio Bozzato of Cisco Talos.

---

[Vulnerability Reports](/vulnerability_reports) [Next Report

TALOS-2019-0921](/vulnerability_reports/TALOS-2019-0921) [Previous Report

TALOS-2019-0861](/vulnerability_reports/TALOS-2019-0861)

* + ###### [Intelligence Center](/reputation)
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* + ###### [Vulnerability Research](/vulnerability_info)
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* + ###### [Incident Response](/incident_response)
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* + ###### Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* + ###### Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* + ###### Support
  + [Support Documentation](https://support.talosintelligence.com)
* + ###### Company
  + [About Talos](/about)
  + [Careers](/careers)
  + [Cisco Security](https://www.cisco.com/c/en/us/products/security/product-listing.html)

###### Follow us

[![Cisco](/assets/logo_cisco_white-d87b7f7d3152ad412e48aad924a972cc5b802b7a53cb56b0792a4456c9b7b3a5.svg)](http://tools.cisco.com/security/center/home.x)

©
2025
Cisco Systems, Inc. and/or its affiliates. All rights
reserved. View our
[Privacy Policy.](http://www.cisco.com/web/siteassets/legal/privacy_full.html)



=== Content from lists.debian.org_4d8bf088_20250121_002558.html ===


---

[[Date Prev](msg00013.html)][[Date Next](msg00015.html)]
[[Thread Prev](msg00013.html)][[Thread Next](msg00015.html)]
[[Date Index](maillist.html#00014)]
[[Thread Index](threads.html#00014)]

# [SECURITY] [DLA 2553-1] xcftools security update

---

* *To*: debian-lts-announce <debian-lts-announce@lists.debian.org>
* *Cc*: debian-lts <debian-lts@lists.debian.org>
* *Subject*: [SECURITY] [DLA 2553-1] xcftools security update
* *From*: Markus Koschany <apo@debian.org>
* *Date*: Wed, 10 Feb 2021 01:32:07 +0100
* *Message-id*: <[[🔎]](/msgid-search/c30232b242f539860c60bfed9b62adb8a101d28c.camel%40debian.org) [c30232b242f539860c60bfed9b62adb8a101d28c.camel@debian.org](msg00014.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-2553-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                      Markus Koschany
February 09, 2021                             <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : xcftools
Version        : 1.0.7-6+deb9u1
CVE ID         : CVE-2019-5086 CVE-2019-5087
Debian Bug     : 945317

Claudio Bozzato of Cisco Talos discovered an exploitable integer overflow
vulnerability in the flattenIncrementally function in the xcf2png and xcf2pnm
binaries of xcftools. An integer overflow can occur while walking through tiles
that could be exploited to corrupt memory and execute arbitrary code. In order
to trigger this vulnerability, a victim would need to open a specially crafted
XCF file.

For Debian 9 stretch, these problems have been fixed in version
1.0.7-6+deb9u1.

We recommend that you upgrade your xcftools packages.

For the detailed security status of xcftools please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/xcftools>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpHyfxZZHwop.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from wiki.debian.org_8d48714b_20250121_023305.html ===

[![Debian](https://www.debian.org/Pics/openlogo-50.png)](https://www.debian.org "Debian Homepage")

[Wiki](/FrontPage "Debian Wiki Homepage")

[Login](/LTS?action=login)

* [FrontPage](/FrontPage)
* [RecentChanges](/RecentChanges)
* [FindPage](/FindPage)
* [HelpContents](/HelpContents)
* [LTS](/LTS)

Search:

[![Debian](https://www.debian.org/Pics/openlogo-50.png)](https://www.debian.org "Debian Homepage")
[Wiki](/FrontPage "Debian Wiki Homepage")/

* [Login](/LTS?action=login)
* Comments
* [Info](/LTS?action=info)
* [Attachments](/LTS?action=AttachFile)
* More Actions:
  Raw Text
  Print View
  Render as Docbook
  Delete Cache
  ------------------------
  Check Spelling
  Like Pages
  Local Site Map
  ------------------------
  Rename Page
  Delete Page
  ------------------------
  Subscribe User
  ------------------------
  Remove Spam
  Revert to this revision
  Package Pages
  ------------------------
  Load
  Save
  SlideShow

# * [LTS](/LTS)

[Translation(s)](/DebianWiki/EditorGuide#translation): [English](/LTS) - [Deutsch](/de/LTS) - [Español](/es/LTS) - [Français](/fr/LTS) - [Italiano](/it/LTS) - [한국어](/ko/LTS) - [Português](/pt/LTS) - [Português (Brasil)](/pt_BR/LTS) - [Русский](/ru/LTS)

# Debian Long Term Support

Debian Long Term Support (LTS) is a project to extend the lifetime of all Debian stable releases to (at least) 5 years. Debian LTS is not handled by the Debian Security and Release teams, but by a separate group of volunteers and companies interested in making it a success.

Thus the Debian LTS team takes over security maintenance of the various releases once the Debian Security team stops its work.

![/!\](/htdocs/debwiki/img/alert.png "/!\")

LTS ([last modified 2024-08-15 02:46:47](/LTS?action=info))

* Debian [privacy policy](https://www.debian.org/legal/privacy), Wiki [team](/Teams/DebianWiki), [bugs](https://bugs.debian.org/wiki.debian.org) and [config](https://salsa.debian.org/debian/wiki.debian.org).
* Powered by [MoinMoin](https://moinmo.in/ "This site uses the MoinMoin Wiki software.") and [Python](https://moinmo.in/Python "MoinMoin is written in Python."), with hosting provided by [Metropolitan Area Network Darmstadt](https://www.man-da.de/).



=== Content from lists.debian.org_8b4620ea_20250121_002558.html ===


---

[[Date Prev](msg00007.html)][[Date Next](msg00009.html)]
[[Thread Prev](msg00007.html)][[Thread Next](msg00009.html)]
[[Date Index](maillist.html#00008)]
[[Thread Index](threads.html#00008)]

# [SECURITY] [DLA 2553-2] xcftools regression update

---

* *To*: debian-lts-announce <debian-lts-announce@lists.debian.org>
* *Subject*: [SECURITY] [DLA 2553-2] xcftools regression update
* *From*: Markus Koschany <apo@debian.org>
* *Date*: Mon, 08 Mar 2021 11:05:50 +0100
* *Message-id*: <[[🔎]](/msgid-search/bc168b0f4a980573e558bd1ffbd810892e1f63d4.camel%40debian.org) [bc168b0f4a980573e558bd1ffbd810892e1f63d4.camel@debian.org](msg00008.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-2553-2                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                      Markus Koschany
March 08, 2021                                <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : xcftools
Version        : 1.0.7-6+deb9u2
CVE ID         : CVE-2019-5086 CVE-2019-5087
Debian Bug     : 945317

The patch to address CVE-2019-5086 and CVE-2019-5087 was not portable and did
not work on 32 bit processor architectures. This update fixes the problem. For
reference, the original advisory text follows.

Claudio Bozzato of Cisco Talos discovered an exploitable integer overflow
vulnerability in the flattenIncrementally function in the xcf2png and xcf2pnm
binaries of xcftools. An integer overflow can occur while walking through tiles
that could be exploited to corrupt memory and execute arbitrary code. In order
to trigger this vulnerability, a victim would need to open a specially crafted
XCF file.

For Debian 9 stretch, this problem has been fixed in version
1.0.7-6+deb9u2.

We recommend that you upgrade your xcftools packages.

For the detailed security status of xcftools please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/xcftools>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpHO8f_kMYXe.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from www.talosintelligence.com_1d11980f_20250121_002559.html ===


* [Cisco Login](/users/auth/saml)

* [Intelligence Center](/reputation)

  + [# Intelligence Center](/reputation)
  + BACK
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* [Vulnerability Research](/vulnerability_info)

  + [# Vulnerability Research](/vulnerability_info)
  + BACK
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* [Incident Response](/incident_response)

  + [# Incident Response](/incident_response)
  + BACK
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* [Blog](https://blog.talosintelligence.com)
* [Support](https://support.talosintelligence.com)

More

* Security Resources

  # Security Resources

  + BACK
  Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* Media

  # Media

  + BACK
  Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* Company

  # Company

  + BACK
  Company
  + [About Talos](/about)
  + [Careers](/careers)

* Under Attack?
* [Cisco Login](/users/auth/saml)

## Contact Cisco Talos Incident Response

×

Close

This form is for Incident Response service inquiries only, including emergency network security needs.

For reputation or categorization inquiries, visit the [Talos Support site](/support).
For emergency DDoS mitigation assistance, please contact the [Cisco Secure DDoS Protection Team](https://www.cisco.com/c/en/us/products/collateral/security/ddos-emergency-attack-mitigation-aag.pdf).

Name

Company (optional)

Email address

Phone number

Preferred communication:

Email

Phone

What Incident Response Service are you interested in?
General Talos IR services and retainer information
Emergency Response
IR Plan
IR Playbooks
IR Readiness Assessment
Tabletop Exercises
Compromise Assessment
Threat Hunting
Cyber Range Training
Intelligence on Demand

Please provide as much detail as possible so we can best address your needs

I acknowledge that this is an inquiry for Incident Response services and that any other use of this form will not receive a response.

Send Email
Cancel

# Talos Vulnerability Report

### TALOS-2019-0878

## xcftools flattenIncrementally tiles walk code execution vulnerability

##### November 21, 2019

##### CVE Number

CVE-2019-5086

### Summary

An exploitable integer overflow vulnerability exists in the flattenIncrementally function in the xcf2png and xcf2pnm binaries of xcftools, version 1.0.7. An integer overflow can occur while walking through tiles that could be exploited to corrupt memory and execute arbitrary code. In order to trigger this vulnerability, a victim would need to open a specially crafted XCF file.

### Tested Versions

xcftools 1.0.7

### Product URLs

http://henning.makholm.net/xcftools/

### CVSSv3 Score

7.5 - CVSS:3.0/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:H/A:H

### CWE

CWE-680: Integer Overflow to Buffer Overflow

### Details

Xcftools is a set of tools for handling Gimp’s XCF files. It provides an `xcfinfo` tool for extracting information from an XCF file, and `xcf2png` and `xcf2pnm` for converting an XCF to PNG or PNM format.

When converting an XCF, the utilities first parse the file using the function `getBasicXcfInfo`. For each XCF layer, the function `computeDimensions` is called:

```
struct tileDimensions {
  struct rect c ;
  unsigned width, height ;
  unsigned tilesx, tilesy ;
  unsigned ntiles ;
};

struct rect {
  int t, b, l, r ;
};

void
computeDimensions(struct tileDimensions *d)
{
  d->c.r = d->c.l + d->width ;                            // [1]
  d->c.b = d->c.t + d->height ;                           // [2]
  d->tilesx = (d->width+TILE_WIDTH-1)/TILE_WIDTH ;
  d->tilesy = (d->height+TILE_HEIGHT-1)/TILE_HEIGHT ;
  d->ntiles = d->tilesx * d->tilesy ;
}

```

The function takes a structure containing some information about the layer: width, height, horizontal and vertical offset. These values are all gathered from the input file. The code calculates the bounds of the layer by filling the `rect` structure.

As we can see at [1], the “horizontal offset” (`d->c.l`) is used together with the layer width, to calculate the “right” field of the rectangle. Similarly, the code calculates the “bottom” position at [2].

Note that when autocrop is enabled (command line switch “-C”), the window’s dimensions are computed from the layers rather than from the canvas itself. When the `flattenIncrementally` function is called, rows are populated by reading the `spec` structure (previously populated by `complete_flatspec`):

```
#define TILE_LEFT(x) ((x) & -TILE_WIDTH)       // & 0xffffffc0
#define TILE_WIDTH (1<<TILE_SHIFT)             // 64
#define TILE_SHIFT 6

flattenIncrementally(struct FlattenSpec *spec,lineCallback callback)
{
  rgba *rows[TILE_HEIGHT] ;
  unsigned i, y, nrows, ncols ;
  struct rect where ;
  struct Tile *tile ;
  static struct Tile toptile ;

  toptile.count = TILE_HEIGHT * TILE_WIDTH ;
  fillTile(&toptile,0);

  for( where.t = spec->dim.c.t; where.t < spec->dim.c.b; where.t=where.b ) {     // [3]
    where.b = TILE_TOP(where.t)+TILE_HEIGHT ;
    if( where.b > spec->dim.c.b ) where.b = spec->dim.c.b ;
    nrows = where.b - where.t ;
    for( y = 0; y < nrows ; y++ )
      rows[y] = xcfmalloc(4*(spec->dim.c.r-spec->dim.c.l));

    for( where.l = spec->dim.c.l; where.l < spec->dim.c.r; where.l=where.r ) {   // [4]
      where.r = TILE_LEFT(where.l)+TILE_WIDTH ;                                  // [5]
      if( where.r > spec->dim.c.r ) where.r = spec->dim.c.r ;
      ncols = where.r - where.l ;
      ...
      for( y = 0 ; y < nrows ; y++ )
        memcpy(rows[y] + (where.l - spec->dim.c.l),                              // [6]
               tile->pixels + y * ncols, ncols*4);
      ...

```

At [3] and [4], the code loops for each tile in the layer and copies the data in `rows`. Since tiles are aligned, at [5] the horizontal limit (“right”) of the current tile is computed. This command however doesn’t take integer overflows into account: for example, assuming that all dimensions in `spec` are positive, if `where.l` was 0x7fffffe0, `where.r` would become 0x80000000, which is negative since the fields in the `rect` structure are signed. At this point, when the cycle loops at [4], `where.l` will have the value 0x80000000 assigned, and the loop termination condition `where.l < spec->dim.c.r` won’t be met, since `where.l` is negative.

This makes the for loop at [4] to cycle unexpectedly, which could be exploited to corrupt the heap at [6], leading to arbitrary code execution.

### Crash Information

```
$ ./xcf2png -o test poc -C
Warning: XCF version 3 not supported (trying anyway...)
=================================================================
==13592==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xf2e02e7c at pc 0xf797543b bp 0xfffddc98 sp 0xfffdd868
WRITE of size 128 at 0xf2e02e7c thread T0
    #0 0xf797543a in __interceptor_memcpy /build/gcc/src/gcc/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:790
    #1 0x56672c26 in flattenIncrementally /src_1.0.7/flatten.c:647
    #2 0x56653a2b in main /src_1.0.7/xcf2png.c:417
    #3 0xf76da7d0 in __libc_start_main (/usr/lib32/libc.so.6+0x1e7d0)
    #4 0x56656e40 in _start (/src_1.0.7/xcf2png+0xae40)

0xf2e02e7c is located 0 bytes to the right of 124-byte region [0xf2e02e00,0xf2e02e7c)
allocated by thread T0 here:
    #0 0xf79ed3e9 in __interceptor_malloc /build/gcc/src/gcc/libsanitizer/asan/asan_malloc_linux.cc:144
    #1 0x56661468 in xcfmalloc /src_1.0.7/utils.c:103

SUMMARY: AddressSanitizer: heap-buffer-overflow /build/gcc/src/gcc/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:790 in __interceptor_memcpy
Shadow bytes around the buggy address:
  0x3e5c0570: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0580: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0590: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x3e5c05c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00[04]
  0x3e5c05d0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05e0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c05f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0600: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x3e5c0610: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==13592==ABORTING

```
### Timeline

2019-07-31 - Initial contact

2019-08-07 - Plain text file sent

2019-10-02 - 60+ day follow up

2019-10-21 - 90 day notice

2019-11-21 - Public release

##### Credit

Discovered by Claudio Bozzato of Cisco Talos.

---

[Vulnerability Reports](/vulnerability_reports) [Next Report

TALOS-2019-0921](/vulnerability_reports/TALOS-2019-0921) [Previous Report

TALOS-2019-0861](/vulnerability_reports/TALOS-2019-0861)

* + ###### [Intelligence Center](/reputation)
  + [Intelligence Search](/reputation_center)
  + [Email & Spam Trends](/reputation_center/email_rep)
* + ###### [Vulnerability Research](/vulnerability_info)
  + [Vulnerability Reports](/vulnerability_reports)
  + [Microsoft Advisories](/ms_advisories)
* + ###### [Incident Response](/incident_response)
  + [Reactive Services](/incident_response/services#reactive-services)
  + [Proactive Services](/incident_response/services#proactive-services)
  + Emergency Support
* + ###### Security Resources
  + [Open Source Security Tools](/software)
  + [Intelligence Categories Reference](/categories)
  + [Secure Endpoint Naming Reference](/secure-endpoint-naming)
* + ###### Media
  + [Talos Intelligence Blog](https://blog.talosintelligence.com)
  + [Threat Source Newsletter](https://blog.talosintelligence.com/category/threat-source-newsletter/)
  + [Beers with Talos Podcast](/podcasts/shows/beers_with_talos)
  + [Talos Takes Podcast](/podcasts/shows/talos_takes)
  + [Talos Videos](https://www.youtube.com/channel/UCPZ1DtzQkStYBSG3GTNoyfg/featured)
* + ###### Support
  + [Support Documentation](https://support.talosintelligence.com)
* + ###### Company
  + [About Talos](/about)
  + [Careers](/careers)
  + [Cisco Security](https://www.cisco.com/c/en/us/products/security/product-listing.html)

###### Follow us

[![Cisco](/assets/logo_cisco_white-d87b7f7d3152ad412e48aad924a972cc5b802b7a53cb56b0792a4456c9b7b3a5.svg)](http://tools.cisco.com/security/center/home.x)

©
2025
Cisco Systems, Inc. and/or its affiliates. All rights
reserved. View our
[Privacy Policy.](http://www.cisco.com/web/siteassets/legal/privacy_full.html)


