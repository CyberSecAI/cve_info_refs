- **Root cause of vulnerability**: An integer overflow occurs in the `WeaveMessageLayer::DecodeMessageWithLength` function when parsing the message length field from a Weave packet. The function reads a 16-bit message length, adds 2, and stores the result in another 16-bit variable. By providing a message length close to the maximum value (0xFFFF or 0xFFFE), the addition overflows, leading to an incorrect frame length calculation.

- **Weaknesses/vulnerabilities present**:
    - **Integer Overflow:** The core vulnerability lies in the integer overflow, which is then used in subsequent buffer length checks.
    - **Information Disclosure:** Incorrect frame length calculation bypasses the buffer length check, resulting in the `SetDataLength` function operating on a value that is larger than it should, leading to the reuse of PacketBuffer data.
    - **Lack of Buffer Clearing**:  PacketBuffer allocation and freeing doesn't clear existing data.

- **Impact of exploitation**:
    - **Information Disclosure**: An attacker can read data from previous packets, including potentially sensitive information like fabric configurations, network configurations, or data sent over encrypted channels such as PASE or CASE sessions.
    - **Denial of Service**: Potentially, replaying encrypted packets with modified message IDs could disrupt existing encrypted sessions with a third party.

- **Attack vectors**:
    - The attacker sends a specially crafted Weave packet over TCP.
    - The packet's message length field is manipulated to cause an integer overflow.

- **Required attacker capabilities/position**:
    - The attacker needs to be able to send packets to the target device that is using the vulnerable version of Openweave.
    - No authentication is required.
    - The attacker can be on the same network or have network access to the target.

**Additional Notes**:
- The vulnerability only affects TCP packets. UDP packets use a different code path.
- The vulnerability occurs when `msgBuf->SetDataLength(msgLen)` is called. If msgLen is greater than max size of a PacketBuffer (~0x62F),  the buffer length is set to the maximum size left in the buffer (example: if 0x300 bytes is left, `SetDataLength(0xFFFF)` will result in buffer length = 0x300).
- The most useful packet to trigger the vulnerability is `kMsgType_EchoRequest` which can be used to read out the last sent packet by any other party.
- Encrypted message data is also stored in the packet buffer before decryption and after encryption and can potentially be exposed by this vulnerability.