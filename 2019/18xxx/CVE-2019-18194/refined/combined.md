=== Content from bogner.sh_b18ae147_20250120_231815.html ===

## [#bogner.sh](https://bogner.sh)

# [#AVGater: Getting Local Admin by Abusing the Anti-Virus Quarantine](https://bogner.sh/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/ "#AVGater: Getting Local Admin by Abusing the Anti-Virus Quarantine")

 [Security](https://bogner.sh/category/security/), [Software](https://bogner.sh/category/software/)
 [Add comments](#respond)

Nov 102017

As you may have noticed, it has been quite still here for a while. This was related to the preparations for this release: A post disclosing a new type of vulnerability, affecting multiple Anti-Virus solutions. To summaries: **Today, I’m disclosing an issue, that can be exploited by any local user to gain full control over the endpoint by abusing the restore from quarantine Anti-Virus feature.**

And because every new vulnerability needs its own name and logo, I want to introduce you to #AVGater:

[![](https://bogner.sh/wp-content/uploads/2017/10/logo_small-copy.png)](https://bogner.sh/wp-content/uploads/2017/10/logo_small-copy.png)

# The Basics

But let’s get back on track, by discussing a few Anti-Virus basics. The following diagram shows the inner workings of a typical AV from an unprivileged user’s point of view. There are three different access domains: The kernel mode, the privileged user mode (SYSTEM) and the unprivileged user mode. As shown in the following image, the different components have widely different duties:

[![](https://bogner.sh/wp-content/uploads/2017/10/Screen-Shot-2017-10-25-at-10.33.47.png)](https://bogner.sh/wp-content/uploads/2017/10/Screen-Shot-2017-10-25-at-10.33.47.png)

Within the context of the unprivileged user there is only the AV user interface. By itself, it has no real power, because its executing within a limited user session. However, by talking to the AV Windows service it can do many things a normal user would not be able too. For example it may be allowed to restore files from the virus quarantine (*This could be a hint – Couldn’t it?*). Additionally there is kernel component. Most likely it’s doing the real work of checking objects for known threat identifiers.

# The Idea

So what’s the real point here? Well, if a non-privileged user would be able to manipulate any of the communication channels that cross security boundaries (unprivileged user mode to privileged user mode or privileged user mode to kernel mode) he could escalate his privileges. But how to do that?

In the case of #AVGater, the answer to this question is: **By manipulating the restore process from the virus quarantine**:

As shown in the above video, #AVGater can be used to restore a previously quarantined file to any arbitrary filesystem location. This is possible because the restore process is most often carried out by the privileged AV Windows user mode service. Hence, file system ACLs can be circumvented (as they don’t really count for the SYSTEM user). This type of issue is called a privileged file write vulnerability and can be used to place a malicious DLL anywhere on the system. The goal is to side load this library for a legitimate Windows servers by abusing the [DLL Search Order](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396):

[![](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-08-at-20.54.53.png)](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-08-at-20.54.53.png)

If this succeeds, arbitrary code can be executed with the help of the [DLLMain entry point](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682583%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396).

But there is still one very important question still unanswered: How is it possible to tamper with the restore process? The solution are [NTFS directory junctions](https://msdn.microsoft.com/en-us/library/windows/desktop/aa365006%28v%3Dvs.85%29.aspx). They are basically symbolic links for directories that can be created by anyone with the help of [mklink](https://technet.microsoft.com/en-us/library/cc753194%28v%3Dws.11%29.aspx?f=255&MSPPError=-2147217396).

[![](https://bogner.sh/wp-content/uploads/2017/10/Picture1.png)](https://bogner.sh/wp-content/uploads/2017/10/Picture1.png)

**#AVGater in plain english:** By abusing NTFS directory junctions, the AV quarantine restore process can be manipulated, so that previously quarantined files can be written to arbitrary file system locations.

# Putting it all together

With all this knowledge, we can now paint a complete attack scenario: First a malicious library is moved to the AV quarantine. Then, by abusing directory junctions the original source path is redirected to another destination. Most likely a folder within C:\Program Files or C:\Windows. By restoring the previously quarantined file, the SYSTEM permissions of the AV Windows user mode service are misused, and the malicious library is placed in a folder where the currently signed in user is unable to write to under normal conditions. Because of how the [DLL search order](https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586%28v%3Dvs.85%29.aspx?f=255&MSPPError=-2147217396) works, it is finally loaded by another privileged Windows process. Thereby the code within the DLLMain of the malicious library is executed. Hence, a local non-admin attacker gained full control over the affected endpoint.

Here’s a diagram illustrating the whole process:[![](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-05-at-15.41.49.png)](https://bogner.sh/wp-content/uploads/2017/11/Screen-Shot-2017-11-05-at-15.41.49.png)

# Who is/was affected?

During the preparation for this public disclosure, several different product have been checked for #AVGater.

The following vendors have already released their fix. However, there are a few more to come!

|  |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |

If anyone finds additional vulnerable products, please contact me. I will report them and update this list as soon as they fixed the issue.

# Getting our hands dirty

If you want to know more about how to exploit #AVGator in a real life scenario, I have a good news for you: I already fully documented two exploit vectors:

* [Local Privilege Escalation in Emsisoft Anti-Malware by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-emsisoft-anti-malware-by-abusing-ntfs-directory-junctions-avgater/)
* [Local Privilege Escalation in Malwarebytes 3 by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-malwarebytes-3-by-abusing-ntfs-directory-junctions-avgater/)

Additionally, here are the slides of my talk “When your anti virus turns against you” from the [IT SECX conference](https://itsecx.fhstp.ac.at/).

# How to protect myself?

Generally, it’s pretty simple: Always install updates in a timely manner. However, as some vendors still need a few more days to release their fix, it may take a little till everyone is protected.

Furthermore, as #AVGator can only be exploited if the user is allowed to restore previously quarantined file, I recommend everyone within a corporate environment to block normal users from restoring identified threats. This is wise in any way.

 Posted by [florian](https://bogner.sh/author/florian/) at 08:34
### Leave a Reply [Cancel reply](/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/#respond)

Your Comment

You may use these HTML tags and attributes: `<a href="" title=""> <abbr title=""> <acronym title=""> <b> <blockquote cite=""> <cite> <code> <del datetime=""> <em> <i> <q cite=""> <s> <strike> <strong>`

Name
 (required)

E-mail
 (required)

URI

 Notify me of followup comments via e-mail. You can also [subscribe](https://bogner.sh/comment-subscriptions/?srp=2740&srk=3b2a5787f990ce082d1e3fca55cfaa47&sra=s&srsrc=f) without commenting.

| [Local Privilege Escalation in Emsisoft Anti-Malware by abusing NTFS Directory Junctions #AVGater](https://bogner.sh/2017/11/local-privilege-escalation-in-emsisoft-anti-malware-by-abusing-ntfs-directory-junctions-avgater/) | [Local Privilege Escalation in CrashPlan’s Windows Client](https://bogner.sh/2018/02/local-privilege-escalation-in-crashplans-windows-client/) |
| --- | --- |

### Search

### Pages

* [About Me](https://bogner.sh/about-me/)
  + [Curriculum Vitae](https://bogner.sh/wp-content/uploads/2017/11/Florian-Bogner-CV-20171126-NP.pdf#new_tab)
  + [LinkedIn Profile](https://www.linkedin.com/profile/view?id=368904276#new_tab)
  + [XING Profile](https://www.xing.com/profile/Florian_Bogner9#new_tab)
* [Donate](https://bogner.sh/donate1/)
* [Privacy Policy](https://bogner.sh/privacy-policy/)
* [Projects](https://bogner.sh/projects/)
* [References](https://bogner.sh/references/)
### Categories

* [Hardware](https://bogner.sh/category/hardware/) (4)
* [Linux](https://bogner.sh/category/linux/) (10)
* [Mac OS X](https://bogner.sh/category/mac-os-x/) (41)
* [Network](https://bogner.sh/category/network/) (6)
* [Security](https://bogner.sh/category/security/) (39)
* [Software](https://bogner.sh/category/software/) (34)
* [Tipps](https://bogner.sh/category/tipps/) (60)
* [Tools](https://bogner.sh/category/tools/) (21)
* [UAC Technikum Vienna](https://bogner.sh/category/uac-technikum-vienna/) (2)
* [Uncategorized](https://bogner.sh/category/uncategorized/) (18)
* [Web Security](https://bogner.sh/category/web-security/) (2)
* [Windows](https://bogner.sh/category/windows/) (27)

### Recent Posts

* [G DATA Anti-Virus: Abusing OpenSSL to get local admin](https://bogner.sh/2021/10/g-data-anti-virus-abusing-openssl-to-get-local-admin/)
* [CVE-2021-35523: Local Privilege Escalation in Securepoint SSL VPN Client 2.0.30](https://bogner.sh/2021/06/local-privilege-escalation-in-securepoint-ssl-vpn-client-2-0-30/)
* [TeslaRVNG2 meets HAFNIUM Exchange Exploit](https://bogner.sh/2021/05/teslarvng2-meets-hafnium-exchange-exploit/)
* [Dirty Offline Bulk IP Geolocation](https://bogner.sh/2021/01/dirty-offline-bulk-ip-geolocation/)
* [Egregor Post-Incident Monitor / Protector Script](https://bogner.sh/2020/12/egregor-post-incident-monitor-protector-script/)
### Meta

* [Log in](https://bogner.sh/wp-login.php)
* [Entries feed](https://bogner.sh/feed/)
* [Comments feed](https://bogner.sh/comments/feed/)
* [WordPress.org](https://wordpress.org/)

| © 2012 [bogner.sh](http://bogner.sh) |  | [Suffusion theme by Sayontan Sinha](http://aquoid.com/news/themes/suffusion/) |
| --- | --- | --- |


