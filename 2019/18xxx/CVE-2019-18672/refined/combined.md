=== Content from medium.com_5a2fb2d6_20250121_031602.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F6f7d2ec78065&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fkeepkey-release-notes-v-6f7d2ec78065&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fkeepkey-release-notes-v-6f7d2ec78065&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# KeepKey Release Notes — v6.2.2

## Download the latest KeepKey Client and Firmware Updates.

[![ShapeShift](https://miro.medium.com/v2/resize:fill:88:88/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---byline--6f7d2ec78065--------------------------------)

[ShapeShift](/%40ShapeShift.com?source=post_page---byline--6f7d2ec78065--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ee4b8323e7a&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fkeepkey-release-notes-v-6f7d2ec78065&user=ShapeShift&userId=5ee4b8323e7a&source=post_page-5ee4b8323e7a--byline--6f7d2ec78065---------------------post_header-----------)

1 min read·Sep 19, 2019

--

Listen

Share

![]()
## **Updated KeepKey Client and Firmware — Update Now!**

Today ShapeShift released an update **v6.2.2** to the [KeepKey Client](https://chrome.google.com/webstore/detail/keepkey-client/idgiipeogajjpkgheijapngmlbohdhjg?hl=en-US) that resolves the *“Could not connect to KeepKey”* issue that recently began affecting our devices. A recent update to Google Chrome changed the way applications like KeepKey Client connect to devices like KeepKey.

In addition, ShapeShift is taking this opportunity to release a new firmware for KeepKey that provides a variety of security enhancements for the device. We will release more information about these security enhancements in the near future.

Until then, we urge all KeepKey users to install the latest [KeepKey Client](https://chrome.google.com/webstore/detail/keepkey-client/idgiipeogajjpkgheijapngmlbohdhjg?hl=en-US) and firmware **ASAP** to ensure they are able to continue connecting to their wallets and to ensure their experience is a secure one.

## To the moon,

The ShapeShift Team

# >> Recommended Reading <<

[## MakerDAO on KeepKey: Discover DeFi

### KeepKey users can now complete MakerDAO contract actions.

medium.com](/shapeshift-stories/makerdao-on-keepkey-discover-defi-3d53986c1d14?source=post_page-----6f7d2ec78065--------------------------------)[## KeepKey’s Integration with MyEtherWallet

### Use our promo code to get 35% off a KeepKey.

medium.com](/shapeshift-stories/keepkeys-integration-with-myetherwallet-93ba365a67de?source=post_page-----6f7d2ec78065--------------------------------)[## An Open Letter to KeepKey Users

### From Erik Voorhees, CEO, ShapeShift

medium.com](/shapeshift-stories/an-open-letter-to-keepkey-users-7bef6379865?source=post_page-----6f7d2ec78065--------------------------------)[Bitcoin](/tag/bitcoin?source=post_page-----6f7d2ec78065--------------------------------)[Keepkey](/tag/keepkey?source=post_page-----6f7d2ec78065--------------------------------)[Technology](/tag/technology?source=post_page-----6f7d2ec78065--------------------------------)[Finance](/tag/finance?source=post_page-----6f7d2ec78065--------------------------------)

--

--

[![ShapeShift](https://miro.medium.com/v2/resize:fill:96:96/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---post_author_info--6f7d2ec78065--------------------------------)[![ShapeShift](https://miro.medium.com/v2/resize:fill:128:128/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---post_author_info--6f7d2ec78065--------------------------------)Follow[## Written by ShapeShift](/%40ShapeShift.com?source=post_page---post_author_info--6f7d2ec78065--------------------------------)[5.9K Followers](/%40ShapeShift.com/followers?source=post_page---post_author_info--6f7d2ec78065--------------------------------)·[1.3K Following](/%40ShapeShift.com/following?source=post_page---post_author_info--6f7d2ec78065--------------------------------)

Accelerate onchain: [shapeshift.com](http://shapeshift.com)

Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----6f7d2ec78065--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----6f7d2ec78065--------------------------------)[About](/about?autoplay=1&source=post_page-----6f7d2ec78065--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----6f7d2ec78065--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----6f7d2ec78065--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----6f7d2ec78065--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----6f7d2ec78065--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----6f7d2ec78065--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----6f7d2ec78065--------------------------------)[Teams](/business?source=post_page-----6f7d2ec78065--------------------------------)



=== Content from blog.inhq.net_69021590_20250121_010659.html ===
![](https://mato.inhq.net/m?rec=1&bots=1&idsite=1)[invd blog](/)

[Archive](/archive/)[CVEs](/cve/)[Consulting](/consulting/)[About](/about/)

# KeepKey Key Erasure Vulnerability (CVE-2019-18672)

Feb 23, 2020
â¢
Christian Reitter
ID:
CVE-2019-18672

Related articles:
[KeepKey Memory Exfiltration Vulnerability (CVE-2023-27892)](/posts/keepkey-CVE-2023-27892/)
â¢ [KeepKey Supervisor Vulnerabilities (CVE-2022-30330)](/posts/keepkey-CVE-2022-30330/)
â¢ [KeepKey Message State Handling Vulnerability (VULN-22003)](/posts/keepkey-VULN-22003/)

The article describes a vulnerability in the KeepKey hardware wallet which allows an attacker to **erase a cryptographic key** and **compromise the U2F 2nd factor protection** of the KeepKey. I discovered this issue by fuzzing a custom KeepKey emulator setup with libFuzzer and AddressSanitizer. The vulnerability was fixed with firmware **v6.2.2** in September 2019.

See the [CVE-2019-18671](/posts/keepkey-CVE-2019-18671/) article for another KeepKey vulnerability that I reported during the same disclosure process.

***Please note:** As with other articles, this is going to be a technical deep-dive into the specific details that are relevant for the issue.

Correspondingly, the article is written for technical readers with IT security and coding experience.*

## Contents

* [Technical background](#technical-background)
* [The vulnerability](#the-vulnerability)
  + [Related issue](#related-issue)
  + [The fix](#the-fix)
  + [Attack scenario and security implications](#attack-scenario-and-security-implications)
* [Coordinated disclosure](#coordinated-disclosure)
  + [Relevant product](#relevant-product)
  + [Detailed timeline](#detailed-timeline)
  + [Bug bounty](#bug-bounty)
## Consulting

*Iâm a freelance Security Consultant and currently available for new projects.
If you are looking for assistance to secure your projects or organization, [contact me](/consulting).*

## Technical background

As explained in a previous [Trezor One vulnerability](/posts/trezor-one-dry-run-recovery-stack-overflow/) article, the private key at the heart of a cryptocurrency hardware wallet is usually encoded as a human-readable **seed phrase** of standardized English words in accordance with the [BIP39](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki) standard. The secret key is normally generated **on the device** in a random fashion during the initial wallet initialization and only displayed **once** to the user.
Among other things, this ensures that the owner can create an appropriate backup of the key (*e.g. on paper or another analog medium*) and **restore** the wallet later in case of issues or migration between devices.

At the request of the user, the KeepKey can be initialized directly from such a **pre-existing** BIP39 seed phrase to **import** the wallet(s) associated with this private key. This workflow is called **recovery**.

In my opinion, this flexibility and ownership over the private key is an important and advantageous design property of a hardware wallet. However, this functionality exposes an interesting attack surface for adversaries (*handling of sensitive data, flash writes*) and has to be secured against misuse.

Unfortunately, some parts of the KeepKey recovery functionality were not correctly protected.

## The vulnerability

During fuzzing-based research, interesting discoveries often begin with sanitizer warnings, in this case with memory corruption:

```

==16601==ERROR: AddressSanitizer: global-buffer-overflow on address
0x000001a2049f at pc 0x00000055d7b1 bp 0x7fffa1f850f0 sp 0x7fffa1f850e8
WRITE of size 1 at 0x000001a2049f thread T0
    #0 0x55d7b0 in recovery_cipher_finalize
[...]

```

Digging into the function backtrace, one can see the following code path:

`usbPoll` -> `handle_usb_rx` -> `usb_rx_helper` -> `dispatch` -> `fsm_msgCharacterAck` -> `recovery_cipher_finalize`

This path makes sense *in general* since **CharacterAck** messages are used to enter individual parts of the seed words during the KeepKey recovery procedure which uses a specific character entry combined with a substitution matrix shown on the display.

Closer inspection shows that the problematic fuzzing input consists of a **single USB packet**. Why is `recovery_cipher_finalize` called after processing the **first** `MessageType_MessageType_CharacterAck` protobuf message?

Code analysis shows that it is indeed possible to jump from the `fsm_msgCharacterAck` function directly to the `recovery_cipher_finalize` function if the decoded protobuf message has the `msg->has_done` and `msg->done` flags set:

```
void fsm_msgCharacterAck(CharacterAck *msg)
{
  if (msg->has_delete && msg->del) {
    recovery_delete_character();
  } else if(msg->has_done && msg->done) {
    recovery_cipher_finalize();
```

[fsm\_msg\_common.h](https://github.com/keepkey/keepkey-firmware/blob/dccc1518476bfb5936a4c0253ff59ee78c48f05c/lib/firmware/fsm_msg_common.h#L521-L526)

In the ânormalâ workflow, `recovery_cipher_finalize` is called on an **uninitialized** (*brand-new or âwipedâ*) device after a number of seed words **have been entered**. However, it appears that all relevant security checks in `recovery_cipher_init()` can be circumvented by an attacker by simply calling `recovery_cipher_finalize` without doing the initialization.

There are no checks at all to prevent this call on an **initialized** device (*that is in active use and has a valid secret key*). Even worse, it can be done on a device in **locked** state (*without PIN checks*) and **without physical button interaction**.

The beginning of the `recovery_cipher_finalize()` function looks like this:

```
void recovery_cipher_finalize(void)
{
    static char CONFIDENTIAL new_mnemonic[MNEMONIC_BUF] = "";
    static char CONFIDENTIAL temp_word[CURRENT_WORD_BUF];
    volatile bool auto_completed = true;
```

[recovery\_cipher.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/recovery_cipher.c#L449-L453)

`new_mnemonic` is the target buffer for the new ârecoveredâ secret seed phrase that should be stored in the device flash by the recovery operation.

The code expects the related `mnemonic` variable to be filled with space-separated words by the regular recovery steps. However, the attacker can skip those steps by not sending the messages, so `mnemonic` it is still at itâs initial `0x00` state:

```

(gdb) print mnemonic
$1 = '\000' <repeats 287 times>

```

Correspondingly, `char *tok = strtok(mnemonic, " ");` only assigns a `NULL` pointer because there is no space-separated word left in `mnemonic` and so the string copy routine that copies words from `mnemonic` to `new_mnemonic` is **skipped** completely.

Interestingly, this also keeps `auto_completed` at its previous value of **true** and so the following error handling is **not** executed:

```
if (!auto_completed && !enforce_wordlist) {
  if (!dry_run) {
    storage_reset();
  }
  fsm_sendFailure(FailureType_Failure_SyntaxError,
                 "Words were not entered correctly. Make sure you are using the substitution cipher.");
  awaiting_character = false;
  layoutHome();
  return;
}
```

[recovery\_cipher.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/recovery_cipher.c#L470-L479)

Since `new_mnemonic` is still an empty string at this point, its `strlen(new_mnemonic)` value is **0**, which makes the following assignment an **out of bounds write** before the buffer:

```
new_mnemonic[strlen(new_mnemonic) - 1] = '\0';
```

[recovery\_cipher.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/recovery_cipher.c#L482)

This is the global-buffer-overflow one byte out-of-bounds write that the Address Sanitizer complained about as shown in the beginning of the article.

Depending on the data that is saved in the buffer before `new_mnemonic` and how it is accessed, this out of bounds write would be an interesting memory corruption issue on its own under different circumstances, but in this case, it is largely irrelevant due to the steps that follow it.
A relevant aspect here is that the protections of the microcontroller will **not** detect any issues with this statement and the execution continues normally (*since the out of bounds write before the buffer is in the .bss segment*).

The next code lines are crucial:

```
if (!dry_run && (!enforce_wordlist || mnemonic_check(new_mnemonic))) {
  storage_setMnemonic(new_mnemonic);
  memzero(new_mnemonic, sizeof(new_mnemonic));
  if (!enforce_wordlist) {
    // not enforcing => mark storage as imported
    storage_setImported(true);
  }
  storage_commit();
  fsm_sendSuccess("Device recovered");
```

[recovery\_cipher.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/recovery_cipher.c#L484-L492)

Despite the broken state and empty `new_mnemonic` buffer, it appears that the `recovery_cipher_finalize` actually tries to overwrite device secrets in the flash!

`storage_setMnemonic(new_mnemonic);` replaces the RAM copy of the existing private key in `shadow_config.storage.sec.mnemonic` with `0x00` data bytes:

```
void storage_setMnemonic(const char *m)
{
  memset(shadow_config.storage.sec.mnemonic, 0,
       sizeof(shadow_config.storage.sec.mnemonic));
  strlcpy(shadow_config.storage.sec.mnemonic, m,
       sizeof(shadow_config.storage.sec.mnemonic));
```

[storage.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/storage.c#L1414-L1419)

The second half of `storage_setMnemonic()` derives the secret key of the U2F second factor authentication mechanism directly from the private key and stores it in a separate variable. *This is a deliberate design decision since the U2F key is needed in different security contexts than the main private key. In particular, the secret U2F key needs to be available directly after device startup before the secure section of the storage can be decrypted with the correct PIN as entered by the user.*

During the problematic call, the U2F private key will be derived directly from the null mnemonic that was just set and so a static U2F key that is **completely known to the attacker** will be written to flash:

```
  storage_compute_u2froot(&session, shadow_config.storage.sec.mnemonic,
                        &shadow_config.storage.pub.u2froot);
  shadow_config.storage.pub.has_u2froot = true;
}
```

[storage.c](https://github.com/keepkey/keepkey-firmware/blob/c65b1b73ee37ca3dfaf49c5837f3da90625ab905/lib/firmware/storage.c#L1427-L1430)

As a final step, `storage_commit();` is called.

Unfortunately for the attacker, it appears that the changes to `storage.sec` are not actually applied or persisted to flash by `storage_commit()` although no exception is thrown and some other changes are persisted. So far, **no** changes to the wallet private key could be observed in practice under the device conditions that were tested.

The U2F secret key is stored in the `storage.pub` area (*which is âeasierâ to write to*) and **is** persisted to flash according to my observations.

### Related issue

It is possible to call `recovery_delete_character()` on initialized devices without authentication. As far as I can see, this misses any actual security impact since `storage_reset()` is not reachable.

### The fix

The main [patch](https://github.com/keepkey/keepkey-firmware/commit/769714fcb569e7a4faff9530a2d9ac1f9d6e5680) changes the finite state machine logic to reject the problematic messages if the recovery had not been started properly. This is done by introducing a `recovery_started` state flag which enforces that the necessary protections and checks are performed through `recovery_cipher_init()`.

### Attack scenario and security implications

Itâs clear there should be no way for USB packets from local programs to overwrite important device secrets in this way, regardless of the exact failure scenario. To make things worse, this issue can be triggered **remotely via WebUSB** by malicious JavaScript after the user agrees to an unspecific permission dialog. There is either no visual indication or only a brief animation on the OLED display and the device appears to work as before, which makes this attack very hard to detect.

Due to the particular behavior described in the analysis section, this issue is mainly interesting for attacks on U2F.

After the vulnerability has been exploited, the U2F secret key is set to a new, static and well-known value, which is used for future registration and authentication operations:

* U2F-secured logins configured **before** the attack no longer work (*SW\_COND\_NOT\_SAT*)
* U2F-secured logins configured **after** the attack âworkâ, but are based on a very insecure key

**Scenario I:**

Remotely exploit the vulnerability from a malicious webpage with the goal of invalidating existing U2F login configurations and cause the user inconvenience (persistent denial of service). *Fallback methods such as site-specific recovery codes have to be used to regain access to the login in question. The U2F key can be recovered by re-importing the BIP39 seed, but this is not obvious to the user.*

**Scenario II:**

Malware on the host computer could perform this attack to effectively remove the U2F protections of important high-value logins secured with a vulnerable KeepKey (*such as a cryptocurrency exchange service*). This allows an attacker to access the account in question with just the regular password credentials (*obtained for example by a keylogger*) and knowledge of the new static U2F secret key.
This would only work with U2F-secured logins registered after the attack, but I think it is plausible that at least some users will re-register the U2F key for existing logins or can be tricked into doing so.

#### Proof of concept

As described in the analysis, only one USB packet is required to trigger the vulnerability:

```

# 1x CharacterAck message with flags set
?##\x00Q\x00\x00\x00\x02\x18\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00

```

If successful, the answer will look like this:

```

0040   3f 23 23 00 02 00 00 00 12 0a 10 44 65 76 69 63   ?##........Devic
0050   65 20 72 65 63 6f 76 65 72 65 64 00 00 00 00 00   e recovered.....
0060   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0070   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................

```
#### Existing countermeasures and mitigating factors

None of the regular security mechanisms prevents this issue:

* PIN check and physical button confirmation for dangerous operations are circumvented
* the device flash is normally locked against accidental writes, but the problematic code unlocks it explicitly
* the incidental out of bounds write is not detected by the stack protection or memory protection unit

#### Affected versions

The issue was discovered with firmware v6.2.0. The problematic state machine behavior was confirmed for previous firmware versions v6.0.0 and v4.0.0 as well. Looking at the [patch history](https://github.com/keepkey/keepkey-firmware/commits/769714fcb569e7a4faff9530a2d9ac1f9d6e5680/lib/firmware/recovery_cipher.c) of the recovery logic, I think it is plausible that most or all recent firmware versions are similarly affected in terms of the general logic bug.

Note: not all firmware versions in question have U2F capabilities enabled and WebUSB is unavailable for older firmware versions.

## Coordinated disclosure

The disclosure process is described in the âCoordinated disclosureâ section of the [CVE-2019-18671](/posts/keepkey-CVE-2019-18671/) article, which covers all relevant aspects of this disclosure as well.

Itâs noteworthy that this issue was fixed by ShapeShift with a firmware update after **just 9 days**.

### Relevant product

| product | source | fixed version | vendor references | CVE |
| --- | --- | --- | --- | --- |
| ShapeShift KeepKey | [GitHub](https://github.com/keepkey/keepkey-firmware/) | **v6.2.2** via [patch](https://github.com/keepkey/keepkey-firmware/commit/769714fcb569e7a4faff9530a2d9ac1f9d6e5680) | [disclosure post](https://medium.com/shapeshift-stories/shapeshift-security-update-8ec89bb1b4e3), [release notes](https://medium.com/shapeshift-stories/keepkey-release-notes-v-6f7d2ec78065) , VULN-1971 | [CVE-2019-18672](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18672) |

### Detailed timeline

| Date | info |
| --- | --- |
| 2019-09-11 | Confidential disclosure to ShapeShift |
| 2019-09-12 | ShapeShift assigns VULN-1971 |
| 2019-09-15 | ShapeShift proposes a patch |
| 2019-09-19 | ShapeShift releases firmware v6.2.2 |
| 2019-09-19 | ShapeShift publishes v6.2.2 release announcement |
| 2019-11-02 | CVE requested from MITRE |
| 2019-11-02 | MITRE assigns CVE-2019-18672 |
| 2019-12-04 | ShapeShift publishes disclosure post for v6.2.2 |
| 2019-12-04 | The CVE-2019-18672 details are published |

*Note: previous versions of this timeline included the wrong year.*

### Bug bounty

ShapeShift provided a bug bounty for this issue.

* **Christian Reitter**

Information security and other interests.



=== Content from mato.inhq.net_399b90bd_20250121_031603.html ===
GIF89a  �        !�    ,       D ;

=== Content from medium.com_63ef106b_20250121_031603.html ===
[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F8ec89bb1b4e3&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fshapeshift-security-update-8ec89bb1b4e3&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fshapeshift-security-update-8ec89bb1b4e3&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)![]()
# ShapeShift Security Update

## Our update on the KeepKey Vulnerability Disclosure.

[![ShapeShift](https://miro.medium.com/v2/resize:fill:88:88/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---byline--8ec89bb1b4e3--------------------------------)

[ShapeShift](/%40ShapeShift.com?source=post_page---byline--8ec89bb1b4e3--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F5ee4b8323e7a&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40ShapeShift.com%2Fshapeshift-security-update-8ec89bb1b4e3&user=ShapeShift&userId=5ee4b8323e7a&source=post_page-5ee4b8323e7a--byline--8ec89bb1b4e3---------------------post_header-----------)

2 min read·Dec 4, 2019

--

Listen

Share

On September 19th, 2019 we released [an update to KeepKey’s firmware](/shapeshift-stories/keepkey-release-notes-v-6f7d2ec78065). Firmware version 6.2.2 contains fixes for 9 different vulnerabilities that were reported by researcher Christian Reitter via [ShapeShift’s Responsible Disclosure Program](https://shapeshift.com/responsible-disclosure-program). Two of these vulnerabilities are described in the following CVEs:

* [CVE-2019–18671](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18671) — USB Packet Handling Bug could allow out-of-bound writes in device memory.
* [CVE-2019–18672](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-18672) — Mnemonic Wipe Bug could allow the mnemonic seed to be wiped from a KeepKey, causing the device to derive addresses from the well-known “null” mnemonic seed and U2F websites to fail to authenticate.

You can read more details about the two vulnerabilities on MITRE’s website once they’re fully published. All 9 vulnerabilities were fixed in KeepKey Firmware 6.2.2 which was released on September 19th, 2019.

# Update to KeepKey Firmware 6.2.2

In the meantime, to ensure KeepKey can keep your coins as safe as possible, always make sure you’re using the latest version of KeepKey’s firmware. [Instructions for doing this](https://keepkey.zendesk.com/hc/en-us/articles/360001449230-How-to-Update-Firmware) are available on our website.

[## How to Update Firmware

### KeepKey will periodically prompt you to update the device's firmware. Before you begin a firmware update, make sure you…

keepkey.zendesk.com](https://keepkey.zendesk.com/hc/en-us/articles/360001449230-How-to-Update-Firmware?source=post_page-----8ec89bb1b4e3--------------------------------)
# Our Responsible Disclosure Program

If you’re a security researcher who has found what you believe to be a bug or vulnerability in any of ShapeShift’s products or services, don’t hesitate to submit it to ShapeShift’s Security Team via our [Responsible Disclosure Program](https://shapeshift.com/responsible-disclosure-program).

## Recommended Reading:

[## KeepKey Release Notes — v6.2.0.3

### Download the latest KeepKey Client and Firmware Updates.

medium.com](/shapeshift-stories/keepkey-release-notes-v-6f7d2ec78065?source=post_page-----8ec89bb1b4e3--------------------------------)[## Responsible Disclosure Program

### ‍ At ShapeShift, we take security seriously. We encourage independent security researchers to contact us in order to…

shapeshift.com](https://shapeshift.com/responsible-disclosure-program?source=post_page-----8ec89bb1b4e3--------------------------------)[## ShapeShift Security Update

### Our response to the disclosed KeepKey vulnerability.

medium.com](/shapeshift-stories/shapeshift-security-update-5b0dd45c93db?source=post_page-----8ec89bb1b4e3--------------------------------)[Security](/tag/security?source=post_page-----8ec89bb1b4e3--------------------------------)[Bitcoin](/tag/bitcoin?source=post_page-----8ec89bb1b4e3--------------------------------)[Cryptocurrency](/tag/cryptocurrency?source=post_page-----8ec89bb1b4e3--------------------------------)[Technology](/tag/technology?source=post_page-----8ec89bb1b4e3--------------------------------)

--

--

[![ShapeShift](https://miro.medium.com/v2/resize:fill:96:96/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---post_author_info--8ec89bb1b4e3--------------------------------)[![ShapeShift](https://miro.medium.com/v2/resize:fill:128:128/1*FzndpkUoyKGPqf563A2dBw.png)](/%40ShapeShift.com?source=post_page---post_author_info--8ec89bb1b4e3--------------------------------)Follow[## Written by ShapeShift](/%40ShapeShift.com?source=post_page---post_author_info--8ec89bb1b4e3--------------------------------)[5.9K Followers](/%40ShapeShift.com/followers?source=post_page---post_author_info--8ec89bb1b4e3--------------------------------)·[1.3K Following](/%40ShapeShift.com/following?source=post_page---post_author_info--8ec89bb1b4e3--------------------------------)

Accelerate onchain: [shapeshift.com](http://shapeshift.com)

Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----8ec89bb1b4e3--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----8ec89bb1b4e3--------------------------------)[About](/about?autoplay=1&source=post_page-----8ec89bb1b4e3--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----8ec89bb1b4e3--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----8ec89bb1b4e3--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----8ec89bb1b4e3--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----8ec89bb1b4e3--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----8ec89bb1b4e3--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----8ec89bb1b4e3--------------------------------)[Teams](/business?source=post_page-----8ec89bb1b4e3--------------------------------)



=== Content from github.com_e53621ab_20250121_010659.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fcommit%2F769714fcb569e7a4faff9530a2d9ac1f9d6e5680)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fcommit%2F769714fcb569e7a4faff9530a2d9ac1f9d6e5680)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=keepkey%2Fkeepkey-firmware)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[keepkey](/keepkey)
/
**[keepkey-firmware](/keepkey/keepkey-firmware)**
Public

* [Notifications](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware) You must be signed in to change notification settings
* [Fork
  103](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)
* [Star
   157](/login?return_to=%2Fkeepkey%2Fkeepkey-firmware)

* [Code](/keepkey/keepkey-firmware)
* [Issues
  12](/keepkey/keepkey-firmware/issues)
* [Pull requests
  0](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

Additional navigation options

* [Code](/keepkey/keepkey-firmware)
* [Issues](/keepkey/keepkey-firmware/issues)
* [Pull requests](/keepkey/keepkey-firmware/pulls)
* [Actions](/keepkey/keepkey-firmware/actions)
* [Security](/keepkey/keepkey-firmware/security)
* [Insights](/keepkey/keepkey-firmware/pulse)

## Commit

[Permalink](/keepkey/keepkey-firmware/commit/769714fcb569e7a4faff9530a2d9ac1f9d6e5680)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

firmware: stronger recovery state machine checks

[Browse files](/keepkey/keepkey-firmware/tree/769714fcb569e7a4faff9530a2d9ac1f9d6e5680)
Browse the repository at this point in the history

* Loading branch information

[![@keepkeyjon](https://avatars.githubusercontent.com/u/35975617?s=40&v=4)](/keepkeyjon)

[keepkeyjon](/keepkey/keepkey-firmware/commits?author=keepkeyjon "View all commits by keepkeyjon")
committed
Sep 18, 2019

1 parent
[b222c66](/keepkey/keepkey-firmware/commit/b222c66cdd7c3203d917c80ba615082d309d80c3)

commit 769714f

Showing
**1 changed file**
with
**28 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

30 changes: 28 additions & 2 deletions

30
[lib/firmware/recovery\_cipher.c](#diff-6a0aaf45458ecd719ccc9e1c5c542b8e3ee9c46b03083ed026ea165527528a7c "lib/firmware/recovery_cipher.c")

Show comments

[View file](/keepkey/keepkey-firmware/blob/769714fcb569e7a4faff9530a2d9ac1f9d6e5680/lib/firmware/recovery_cipher.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,6 +36,7 @@ |
|  |  |  |
|  |  | #define MAX\_UNCYPHERED\_WORDS (3) |
|  |  |  |
|  |  | static bool recovery\_started = false; |
|  |  | static bool enforce\_wordlist; |
|  |  | static bool dry\_run; |
|  |  | static bool awaiting\_character; |
| Expand All | | @@ -56,6 +57,7 @@ static void recovery\_abort(void) { |
|  |  | storage\_reset(); |
|  |  | } |
|  |  |  |
|  |  | recovery\_started = false; |
|  |  | awaiting\_character = false; |
|  |  | memzero(mnemonic, sizeof(mnemonic)); |
|  |  | memzero(cipher, sizeof(cipher)); |
| Expand Down  Expand Up | | @@ -270,6 +272,7 @@ void recovery\_cipher\_init(bool passphrase\_protection, bool pin\_protection, |
|  |  |  |
|  |  | /\* Set to recovery cipher mode and generate and show next cipher \*/ |
|  |  | awaiting\_character = true; |
|  |  | recovery\_started = true; |
|  |  | next\_character(); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -283,6 +286,13 @@ void recovery\_cipher\_init(bool passphrase\_protection, bool pin\_protection, |
|  |  | \*/ |
|  |  | void next\_character(void) |
|  |  | { |
|  |  | if (!recovery\_started) { |
|  |  | recovery\_abort(); |
|  |  | fsm\_sendFailure(FailureType\_Failure\_UnexpectedMessage, "Not in Recovery mode"); |
|  |  | layoutHome(); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | /\* Scramble cipher \*/ |
|  |  | strlcpy(cipher, english\_alphabet, ENGLISH\_ALPHABET\_BUF); |
|  |  | random\_permute\_char(cipher, strlen(cipher)); |
| Expand Down  Expand Up | | @@ -341,7 +351,7 @@ void next\_character(void) |
|  |  | \*/ |
|  |  | void recovery\_character(const char \*character) |
|  |  | { |
|  |  | if (!awaiting\_character) { |
|  |  | if (!awaiting\_character || !recovery\_started) { |
|  |  | recovery\_abort(); |
|  |  | fsm\_sendFailure(FailureType\_Failure\_UnexpectedMessage, "Not in Recovery mode"); |
|  |  | layoutHome(); |
| Expand Down  Expand Up | | @@ -430,6 +440,13 @@ void recovery\_character(const char \*character) |
|  |  | \*/ |
|  |  | void recovery\_delete\_character(void) |
|  |  | { |
|  |  | if (!recovery\_started) { |
|  |  | recovery\_abort(); |
|  |  | fsm\_sendFailure(FailureType\_Failure\_UnexpectedMessage, "Not in Recovery mode"); |
|  |  | layoutHome(); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | if(strlen(mnemonic) > 0) |
|  |  | { |
|  |  | mnemonic[strlen(mnemonic) - 1] = '\0'; |
| Expand All | | @@ -448,6 +465,13 @@ void recovery\_delete\_character(void) |
|  |  | \*/ |
|  |  | void recovery\_cipher\_finalize(void) |
|  |  | { |
|  |  | if (!recovery\_started) { |
|  |  | recovery\_abort(); |
|  |  | fsm\_sendFailure(FailureType\_Failure\_UnexpectedMessage, "Not in Recovery mode"); |
|  |  | layoutHome(); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | static char CONFIDENTIAL new\_mnemonic[MNEMONIC\_BUF] = ""; |
|  |  | static char CONFIDENTIAL temp\_word[CURRENT\_WORD\_BUF]; |
|  |  | volatile bool auto\_completed = true; |
| Expand Down  Expand Up | | @@ -479,7 +503,7 @@ void recovery\_cipher\_finalize(void) |
|  |  | } |
|  |  |  |
|  |  | /\* Truncate additional space at the end \*/ |
|  |  | new\_mnemonic[strlen(new\_mnemonic) - 1] = '\0'; |
|  |  | new\_mnemonic[MAX(0u, strnlen(new\_mnemonic, sizeof(new\_mnemonic)) - 1)] = '\0'; |
|  |  |  |
|  |  | if (!dry\_run && (!enforce\_wordlist || mnemonic\_check(new\_mnemonic))) { |
|  |  | storage\_setMnemonic(new\_mnemonic); |
| Expand Down  Expand Up | | @@ -532,6 +556,8 @@ void recovery\_cipher\_finalize(void) |
|  |  | \*/ |
|  |  | bool recovery\_cipher\_abort(void) |
|  |  | { |
|  |  | recovery\_started = false; |
|  |  |  |
|  |  | if (awaiting\_character) { |
|  |  | awaiting\_character = false; |
|  |  | return true; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `769714f`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkeepkey%2Fkeepkey-firmware%2Fcommit%2F769714fcb569e7a4faff9530a2d9ac1f9d6e5680) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


