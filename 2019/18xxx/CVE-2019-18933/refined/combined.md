=== Content from github.com_83bde7b0_20250121_023636.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=zulip%2Fzulip)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[zulip](/zulip)
/
**[zulip](/zulip/zulip)**
Public

* [Notifications](/login?return_to=%2Fzulip%2Fzulip) You must be signed in to change notification settings
* [Fork
  8.1k](/login?return_to=%2Fzulip%2Fzulip)
* [Star
   22k](/login?return_to=%2Fzulip%2Fzulip)

* [Code](/zulip/zulip)
* [Issues
  1.6k](/zulip/zulip/issues)
* [Pull requests
  918](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects
  2](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

Additional navigation options

* [Code](/zulip/zulip)
* [Issues](/zulip/zulip/issues)
* [Pull requests](/zulip/zulip/pulls)
* [Actions](/zulip/zulip/actions)
* [Projects](/zulip/zulip/projects)
* [Security](/zulip/zulip/security)
* [Insights](/zulip/zulip/pulse)

## Commit

[Permalink](/zulip/zulip/commit/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[CVE-2019-18933](https://github.com/advisories/GHSA-8c73-4mfq-f8m8 "CVE-2019-18933"): Fix insecure account creation via social authentication.

[Browse files](/zulip/zulip/tree/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)
Browse the repository at this point in the history

```
A bug in Zulip's new user signup process meant that users who
registered their account using social authentication (e.g. GitHub or
Google SSO) in an organization that also allows password
authentication could have their personal API key stolen by an
unprivileged attacker, allowing nearly full access to the user's
account.

Zulip versions between 1.7.0 and 2.0.6 were affected.

This commit fixes the original bug and also contains a database
migration to fix any users with corrupt `password` fields in the
database as a result of the bug.

Out of an abundance of caution (and to protect the users of any
installations that delay applying this commit), the migration also
resets the API keys of any users where Zulip's logs cannot prove the
user's API key was not previously stolen via this bug.  Resetting
those API keys will be inconvenient for users:

* Users of the Zulip mobile and terminal apps whose API keys are reset
  will be logged out and need to login again.
* Users using their personal API keys for any other reason will need
  to re-fetch their personal API key.

We discovered this bug internally and don't believe it was disclosed
prior to our publishing it through this commit.  Because the algorithm
for determining which users might have been affected is very
conservative, many users who were never at risk will have their API
keys reset by this migration.

To avoid this on self-hosted installations that have always used
e.g. LDAP authentication, we skip resetting API keys on installations
that don't have password authentication enabled.  System
administrators on installations that used to have email authentication
enabled, but no longer do, should temporarily enable EmailAuthBackend
before applying this migration.

The migration also records which users had their passwords or API keys
reset in the usual RealmAuditLog table.
```

* Loading branch information

[![@mateuszmandera](https://avatars.githubusercontent.com/u/45007152?s=40&v=4)](/mateuszmandera) [![@timabbott](https://avatars.githubusercontent.com/u/2746074?s=40&v=4)](/timabbott)

[mateuszmandera](/zulip/zulip/commits?author=mateuszmandera "View all commits by mateuszmandera")
authored and
[timabbott](/zulip/zulip/commits?author=timabbott "View all commits by timabbott")
committed
Nov 21, 2019

1 parent
[16ea89a](/zulip/zulip/commit/16ea89ad89910f4bdcf0dd9771deb4b52b03cb35)

commit 0c2cc41

 Show file tree

 Hide file tree

Showing
**7 changed files**
with
**283 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* tools/linter\_lib

  + tools/linter\_lib/custom\_check.py
    [custom\_check.py](#diff-b35c2679beedecd833d0347e7e32ab3e97e2b5e80f2bd6f68400cfcd9ae353c8)
* zerver

  + migrations

    - zerver/migrations/0209\_user\_profile\_no\_empty\_password.py
      [0209\_user\_profile\_no\_empty\_password.py](#diff-770a390e0692a107beb448fa7062a253e2aa3b0c27e92886c3247b5dbc749265)
    - zerver/migrations/0254\_merge\_0209\_0253.py
      [0254\_merge\_0209\_0253.py](#diff-90a11687603ed564268b1871300d2a7be5d8699e81b32d3daf115870c178b430)
  + tests

    - zerver/tests/test\_auth\_backends.py
      [test\_auth\_backends.py](#diff-965665c0c4e79910f8cc6370a2c01c9e747616b05120b938f824f1c3f801e56e)
  + views

    - zerver/views/registration.py
      [registration.py](#diff-ef438982c0e0813a344af6f2022cad723baf88ca5b43807014e095ed9282bf84)
    - zerver/views/users.py
      [users.py](#diff-3dd861192e32ce9a61a7a57882274c1ac8a1b40baf0c55a1ef301e8f6f27bbfa)
* zproject

  + zproject/backends.py
    [backends.py](#diff-bf4305f6fd53f364673ac5ae96896a5dfa5e1fd39a69716394345c2e1cd08b2e)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[tools/linter\_lib/custom\_check.py](#diff-b35c2679beedecd833d0347e7e32ab3e97e2b5e80f2bd6f68400cfcd9ae353c8 "tools/linter_lib/custom_check.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/tools/linter_lib/custom_check.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -416,6 +416,7 @@ |
|  |  | 'zerver/migrations/0060\_move\_avatars\_to\_be\_uid\_based.py', |
|  |  | 'zerver/migrations/0104\_fix\_unreads.py', |
|  |  | 'zerver/migrations/0206\_stream\_rendered\_description.py', |
|  |  | 'zerver/migrations/0209\_user\_profile\_no\_empty\_password.py', |
|  |  | 'pgroonga/migrations/0002\_html\_escape\_subject.py', |
|  |  | ]), |
|  |  | 'description': "Don't import models or other code in migrations; see docs/subsystems/schema-migrations.md", |
| Expand Down | |  |

234 changes: 234 additions & 0 deletions

234
[zerver/migrations/0209\_user\_profile\_no\_empty\_password.py](#diff-770a390e0692a107beb448fa7062a253e2aa3b0c27e92886c3247b5dbc749265 "zerver/migrations/0209_user_profile_no_empty_password.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zerver/migrations/0209_user_profile_no_empty_password.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,234 @@ |
|  |  | # -\*- coding: utf-8 -\*- |
|  |  | # Generated by Django 1.11.24 on 2019-10-16 22:48 |
|  |  | from \_\_future\_\_ import unicode\_literals |
|  |  |  |
|  |  | from django.conf import settings |
|  |  | from django.contrib.auth import get\_backends |
|  |  | from django.db import migrations |
|  |  | from django.db.backends.postgresql\_psycopg2.schema import DatabaseSchemaEditor |
|  |  | from django.db.migrations.state import StateApps |
|  |  | from django.contrib.auth.hashers import check\_password, make\_password |
|  |  | from django.utils.timezone import now as timezone\_now |
|  |  |  |
|  |  | from zerver.lib.cache import cache\_delete, user\_profile\_by\_api\_key\_cache\_key |
|  |  | from zerver.lib.queue import queue\_json\_publish |
|  |  | from zerver.lib.utils import generate\_api\_key |
|  |  | from zproject.backends import EmailAuthBackend |
|  |  |  |
|  |  | from typing import Any, Set, Union |
|  |  |  |
|  |  | import ujson |
|  |  |  |
|  |  | def ensure\_no\_empty\_passwords(apps: StateApps, schema\_editor: DatabaseSchemaEditor) -> None: |
|  |  | """With CVE-2019-18933, it was possible for certain users created |
|  |  | using social login (e.g. Google/GitHub auth) to have the empty |
|  |  | string as their password in the Zulip database, rather than |
|  |  | Django's "unusable password" (i.e. no password at all). This was a |
|  |  | serious security issue for organizations with both password and |
|  |  | Google/GitHub authentication enabled. |
|  |  |  |
|  |  | Combined with the code changes to prevent new users from entering |
|  |  | this buggy state, this migration sets the intended "no password" |
|  |  | state for any users who are in this buggy state, as had been |
|  |  | intended. |
|  |  |  |
|  |  | While this bug was discovered by our own development team and we |
|  |  | believe it hasn't been exploited in the wild, out of an abundance |
|  |  | of caution, this migration also resets the personal API keys for |
|  |  | all users where Zulip's database-level logging cannot \*\*prove\*\* |
|  |  | that user's current personal API key was never accessed using this |
|  |  | bug. |
|  |  |  |
|  |  | There are a few ways this can be proven: (1) the user's password |
|  |  | has never been changed and is not the empty string, |
|  |  | or (2) the user's personal API key has changed since that user last |
|  |  | changed their password (which is not ''). Both constitute proof |
|  |  | because this bug cannot be used to gain the access required to change |
|  |  | or reset a user's password. |
|  |  |  |
|  |  | Resetting those API keys has the effect of logging many users out |
|  |  | of the Zulip mobile and terminal apps unnecessarily (e.g. because |
|  |  | the user changed their password at any point in the past, even |
|  |  | though the user never was affected by the bug), but we're |
|  |  | comfortable with that cost for ensuring that this bug is |
|  |  | completely fixed. |
|  |  |  |
|  |  | To avoid this inconvenience for self-hosted servers which don't |
|  |  | even have EmailAuthBackend enabled, we skip resetting any API keys |
|  |  | if the server doesn't have EmailAuthBackend configured. |
|  |  | """ |
|  |  |  |
|  |  | UserProfile = apps.get\_model('zerver', 'UserProfile') |
|  |  | RealmAuditLog = apps.get\_model('zerver', 'RealmAuditLog') |
|  |  |  |
|  |  | # Because we're backporting this migration to the Zulip 2.0.x |
|  |  | # series, we've given it migration number 0209, which is a |
|  |  | # duplicate with an existing migration already merged into Zulip |
|  |  | # master. Migration 0247\_realmauditlog\_event\_type\_to\_int.py |
|  |  | # changes the format of RealmAuditLog.event\_type, so we need the |
|  |  | # following conditional block to determine what values to use when |
|  |  | # searching for the relevant events in that log. |
|  |  | event\_type\_class = RealmAuditLog.\_meta.get\_field('event\_type').get\_internal\_type() |
|  |  | if event\_type\_class == 'CharField': |
|  |  | USER\_PASSWORD\_CHANGED = 'user\_password\_changed' # type: Union[int, str] |
|  |  | USER\_API\_KEY\_CHANGED = 'user\_api\_key\_changed' # type: Union[int, str] |
|  |  | else: |
|  |  | USER\_PASSWORD\_CHANGED = 122 |
|  |  | USER\_API\_KEY\_CHANGED = 127 |
|  |  |  |
|  |  | # First, we do some bulk queries to collect data we'll find useful |
|  |  | # in the loop over all users below. |
|  |  |  |
|  |  | # Users who changed their password at any time since account |
|  |  | # creation. These users could theoretically have started with an |
|  |  | # empty password, but set a password later via the password reset |
|  |  | # flow. If their API key has changed since they changed their |
|  |  | # password, we can prove their current API key cannot have been |
|  |  | # exposed; we store those users in |
|  |  | # password\_change\_user\_ids\_no\_reset\_needed. |
|  |  | password\_change\_user\_ids = set(RealmAuditLog.objects.filter( |
|  |  | event\_type=USER\_PASSWORD\_CHANGED).values\_list("modified\_user\_id", flat=True)) |
|  |  | password\_change\_user\_ids\_api\_key\_reset\_needed = set() # type: Set[int] |
|  |  | password\_change\_user\_ids\_no\_reset\_needed = set() # type: Set[int] |
|  |  |  |
|  |  | for user\_id in password\_change\_user\_ids: |
|  |  | # Here, we check the timing for users who have changed |
|  |  | # their password. |
|  |  |  |
|  |  | # We check if the user changed their API key since their first password change. |
|  |  | query = RealmAuditLog.objects.filter( |
|  |  | modified\_user=user\_id, event\_type\_\_in=[USER\_PASSWORD\_CHANGED, |
|  |  | USER\_API\_KEY\_CHANGED] |
|  |  | ).order\_by("event\_time") |
|  |  |  |
|  |  | earliest\_password\_change = query.filter(event\_type=USER\_PASSWORD\_CHANGED).first() |
|  |  | # Since these users are in password\_change\_user\_ids, this must not be None. |
|  |  | assert earliest\_password\_change is not None |
|  |  |  |
|  |  | latest\_api\_key\_change = query.filter(event\_type=USER\_API\_KEY\_CHANGED).last() |
|  |  | if latest\_api\_key\_change is None: |
|  |  | # This user has never changed their API key. As a |
|  |  | # result, even though it's very likely this user never |
|  |  | # had an empty password, they have changed their |
|  |  | # password, and we have no record of the password's |
|  |  | # original hash, so we can't prove the user's API key |
|  |  | # was never affected. We schedule this user's API key |
|  |  | # to be reset. |
|  |  | password\_change\_user\_ids\_api\_key\_reset\_needed.add(user\_id) |
|  |  | elif earliest\_password\_change.event\_time <= latest\_api\_key\_change.event\_time: |
|  |  | # This user has changed their password before |
|  |  | # generating their current personal API key, so we can |
|  |  | # prove their current personal API key could not have |
|  |  | # been exposed by this bug. |
|  |  | password\_change\_user\_ids\_no\_reset\_needed.add(user\_id) |
|  |  | else: |
|  |  | password\_change\_user\_ids\_api\_key\_reset\_needed.add(user\_id) |
|  |  |  |
|  |  | if password\_change\_user\_ids\_no\_reset\_needed and settings.PRODUCTION: |
|  |  | # We record in this log file users whose current API key was |
|  |  | # generated after a real password was set, so there's no need |
|  |  | # to reset their API key, but because they've changed their |
|  |  | # password, we don't know whether or not they originally had a |
|  |  | # buggy password. |
|  |  | # |
|  |  | # In theory, this list can be recalculated using the above |
|  |  | # algorithm modified to only look at events before the time |
|  |  | # this migration was installed, but it's helpful to log it as well. |
|  |  | with open("/var/log/zulip/0209\_password\_migration.log", "w") as log\_file: |
|  |  | line = "No reset needed, but changed password: {}\n" |
|  |  | log\_file.write(line.format(password\_change\_user\_ids\_no\_reset\_needed)) |
|  |  |  |
|  |  | AFFECTED\_USER\_TYPE\_EMPTY\_PASSWORD = 'empty\_password' |
|  |  | AFFECTED\_USER\_TYPE\_CHANGED\_PASSWORD = 'changed\_password' |
|  |  | MIGRATION\_ID = '0209\_user\_profile\_no\_empty\_password' |
|  |  |  |
|  |  | def write\_realm\_audit\_log\_entry(user\_profile: Any, |
|  |  | event\_time: Any, event\_type: Any, |
|  |  | affected\_user\_type: str) -> None: |
|  |  | RealmAuditLog.objects.create( |
|  |  | realm=user\_profile.realm, |
|  |  | modified\_user=user\_profile, |
|  |  | event\_type=event\_type, |
|  |  | event\_time=event\_time, |
|  |  | extra\_data=ujson.dumps({ |
|  |  | 'migration\_id': MIGRATION\_ID, |
|  |  | 'affected\_user\_type': affected\_user\_type, |
|  |  | }) |
|  |  | ) |
|  |  |  |
|  |  | # If Zulip's built-in password authentication is not enabled on |
|  |  | # the server level, then we plan to skip resetting any users' API |
|  |  | # keys, since the bug requires EmailAuthBackend. |
|  |  | email\_auth\_enabled = any(isinstance(backend, EmailAuthBackend) |
|  |  | for backend in get\_backends()) |
|  |  |  |
|  |  | # A quick note: This query could in theory exclude users with |
|  |  | # is\_active=False, is\_bot=True, or realm\_\_deactivated=True here to |
|  |  | # accessing only active human users in non-deactivated realms. |
|  |  | # But it's better to just be thorough; users can be reactivated, |
|  |  | # and e.g. a server admin could manually edit the database to |
|  |  | # change a bot into a human user if they really wanted to. And |
|  |  | # there's essentially no harm in rewriting state for a deactivated |
|  |  | # account. |
|  |  | for user\_profile in UserProfile.objects.all(): |
|  |  | event\_time = timezone\_now() |
|  |  | if check\_password('', user\_profile.password): |
|  |  | # This user currently has the empty string as their password. |
|  |  |  |
|  |  | # Change their password and record that we did so. |
|  |  | user\_profile.password = make\_password(None) |
|  |  | update\_fields = ["password"] |
|  |  | write\_realm\_audit\_log\_entry(user\_profile, event\_time, |
|  |  | USER\_PASSWORD\_CHANGED, |
|  |  | AFFECTED\_USER\_TYPE\_EMPTY\_PASSWORD) |
|  |  |  |
|  |  | if email\_auth\_enabled and not user\_profile.is\_bot: |
|  |  | # As explained above, if the built-in password authentication |
|  |  | # is enabled, reset the API keys. We can skip bot accounts here, |
|  |  | # because the `password` attribute on a bot user is useless. |
|  |  | reset\_user\_api\_key(user\_profile) |
|  |  | update\_fields.append("api\_key") |
|  |  |  |
|  |  | event\_time = timezone\_now() |
|  |  | write\_realm\_audit\_log\_entry(user\_profile, event\_time, |
|  |  | USER\_API\_KEY\_CHANGED, |
|  |  | AFFECTED\_USER\_TYPE\_EMPTY\_PASSWORD) |
|  |  |  |
|  |  | user\_profile.save(update\_fields=update\_fields) |
|  |  | continue |
|  |  |  |
|  |  | elif email\_auth\_enabled and \ |
|  |  | user\_profile.id in password\_change\_user\_ids\_api\_key\_reset\_needed: |
|  |  | # For these users, we just need to reset the API key. |
|  |  | reset\_user\_api\_key(user\_profile) |
|  |  | user\_profile.save(update\_fields=["api\_key"]) |
|  |  |  |
|  |  | write\_realm\_audit\_log\_entry(user\_profile, event\_time, |
|  |  | USER\_API\_KEY\_CHANGED, |
|  |  | AFFECTED\_USER\_TYPE\_CHANGED\_PASSWORD) |
|  |  |  |
|  |  | def reset\_user\_api\_key(user\_profile: Any) -> None: |
|  |  | old\_api\_key = user\_profile.api\_key |
|  |  | user\_profile.api\_key = generate\_api\_key() |
|  |  | cache\_delete(user\_profile\_by\_api\_key\_cache\_key(old\_api\_key)) |
|  |  |  |
|  |  | # Like with any API key change, we need to clear any server-side |
|  |  | # state for sending push notifications to mobile app clients that |
|  |  | # could have been registered with the old API key. Fortunately, |
|  |  | # we can just write to the queue processor that handles sending |
|  |  | # those notices to the push notifications bouncer service. |
|  |  | event = {'type': 'clear\_push\_device\_tokens', |
|  |  | 'user\_profile\_id': user\_profile.id} |
|  |  | queue\_json\_publish("deferred\_work", event) |
|  |  |  |
|  |  | class Migration(migrations.Migration): |
|  |  | atomic = False |
|  |  |  |
|  |  | dependencies = [ |
|  |  | ('zerver', '0208\_add\_realm\_night\_logo\_fields'), |
|  |  | ] |
|  |  |  |
|  |  | operations = [ |
|  |  | migrations.RunPython(ensure\_no\_empty\_passwords, |
|  |  | reverse\_code=migrations.RunPython.noop), |
|  |  | ] |

16 changes: 16 additions & 0 deletions

16
[zerver/migrations/0254\_merge\_0209\_0253.py](#diff-90a11687603ed564268b1871300d2a7be5d8699e81b32d3daf115870c178b430 "zerver/migrations/0254_merge_0209_0253.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zerver/migrations/0254_merge_0209_0253.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,16 @@ |
|  |  | # -\*- coding: utf-8 -\*- |
|  |  | # Generated by Django 1.11.26 on 2019-11-21 01:47 |
|  |  | from \_\_future\_\_ import unicode\_literals |
|  |  |  |
|  |  | from django.db import migrations |
|  |  | from typing import Any, List |
|  |  |  |
|  |  | class Migration(migrations.Migration): |
|  |  |  |
|  |  | dependencies = [ |
|  |  | ('zerver', '0253\_userprofile\_wildcard\_mentions\_notify'), |
|  |  | ('zerver', '0209\_user\_profile\_no\_empty\_password'), |
|  |  | ] |
|  |  |  |
|  |  | operations = [ |
|  |  | ] # type: List[Any] |

20 changes: 20 additions & 0 deletions

20
[zerver/tests/test\_auth\_backends.py](#diff-965665c0c4e79910f8cc6370a2c01c9e747616b05120b938f824f1c3f801e56e "zerver/tests/test_auth_backends.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zerver/tests/test_auth_backends.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -212,6 +212,26 @@ def test\_email\_auth\_backend(self) -> None: |
|  |  | realm=get\_realm('zephyr'), |
|  |  | return\_data=dict())) |
|  |  |  |
|  |  | def test\_email\_auth\_backend\_empty\_password(self) -> None: |
|  |  | user\_profile = self.example\_user('hamlet') |
|  |  | password = "testpassword" |
|  |  | user\_profile.set\_password(password) |
|  |  | user\_profile.save() |
|  |  |  |
|  |  | # First, verify authentication works with the a nonempty |
|  |  | # password so we know we've set up the test correctly. |
|  |  | self.assertIsNotNone(EmailAuthBackend().authenticate(username=self.example\_email('hamlet'), |
|  |  | password=password, |
|  |  | realm=get\_realm("zulip"))) |
|  |  |  |
|  |  | # Now do the same test with the empty string as the password. |
|  |  | password = "" |
|  |  | user\_profile.set\_password(password) |
|  |  | user\_profile.save() |
|  |  | self.assertIsNone(EmailAuthBackend().authenticate(username=self.example\_email('hamlet'), |
|  |  | password=password, |
|  |  | realm=get\_realm("zulip"))) |
|  |  |  |
|  |  | def test\_email\_auth\_backend\_disabled\_password\_auth(self) -> None: |
|  |  | user\_profile = self.example\_user('hamlet') |
|  |  | password = "testpassword" |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[zerver/views/registration.py](#diff-ef438982c0e0813a344af6f2022cad723baf88ca5b43807014e095ed9282bf84 "zerver/views/registration.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zerver/views/registration.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -199,10 +199,14 @@ def accounts\_register(request: HttpRequest) -> HttpResponse: |
|  |  | form['password'].field.required = False |
|  |  |  |
|  |  | if form.is\_valid(): |
|  |  | if password\_auth\_enabled(realm): |
|  |  | if password\_auth\_enabled(realm) and form['password'].field.required: |
|  |  | password = form.cleaned\_data['password'] |
|  |  | else: |
|  |  | # SSO users don't need no passwords |
|  |  | # If the user wasn't prompted for a password when |
|  |  | # completing the authentication form (because they're |
|  |  | # signing up with SSO and no password is required), set |
|  |  | # the password field to `None` (Which causes Django to |
|  |  | # create an unusable password). |
|  |  | password = None |
|  |  |  |
|  |  | if realm\_creation: |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[zerver/views/users.py](#diff-3dd861192e32ce9a61a7a57882274c1ac8a1b40baf0c55a1ef301e8f6f27bbfa "zerver/views/users.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zerver/views/users.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -328,7 +328,7 @@ def add\_bot\_backend( |
|  |  | if bot\_type in (UserProfile.INCOMING\_WEBHOOK\_BOT, UserProfile.EMBEDDED\_BOT) and service\_name: |
|  |  | check\_valid\_bot\_config(bot\_type, service\_name, config\_data) |
|  |  |  |
|  |  | bot\_profile = do\_create\_user(email=email, password='', |
|  |  | bot\_profile = do\_create\_user(email=email, password=None, |
|  |  | realm=user\_profile.realm, full\_name=full\_name, |
|  |  | short\_name=short\_name, |
|  |  | bot\_type=bot\_type, |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[zproject/backends.py](#diff-bf4305f6fd53f364673ac5ae96896a5dfa5e1fd39a69716394345c2e1cd08b2e "zproject/backends.py")

Show comments

[View file](/zulip/zulip/blob/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6/zproject/backends.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -212,6 +212,11 @@ def authenticate(self, \*, username: str, password: str, |
|  |  | if return\_data is not None: |
|  |  | return\_data['email\_auth\_disabled'] = True |
|  |  | return None |
|  |  | if password == "": |
|  |  | # Never allow an empty password. This is defensive code; |
|  |  | # a user having password "" should only be possible |
|  |  | # through a bug somewhere else. |
|  |  | return None |
|  |  |  |
|  |  | user\_profile = common\_get\_active\_user(username, realm, return\_data=return\_data) |
|  |  | if user\_profile is None: |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0c2cc41`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fzulip%2Fzulip%2Fcommit%2F0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_edbd215b_20250121_023634.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-8c73-4mfq-f8m8)

**CVE-2019-18933**

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadvisories%2FGHSA-8c73-4mfq-f8m8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2Fadvisories%2F%3Cid%3E&source=header)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

1. [GitHub Advisory Database](/advisories)
2. [Unreviewed](/advisories?query=type%3Aunreviewed)
3. [CVE-2019-18933](/advisories/GHSA-8c73-4mfq-f8m8)

## In Zulip Server versions from 1.7.0 to before 2.0.7, a...

Critical severity

Unreviewed

Published
May 24, 2022
to the GitHub Advisory Database
•
Updated Apr 4, 2024

## Package

No package listed—
[Suggest a package](/advisories/GHSA-8c73-4mfq-f8m8/improve)

## Affected versions

Unknown

## Patched versions

Unknown

## Description

In Zulip Server versions from 1.7.0 to before 2.0.7, a bug in the new user signup process meant that users who registered their account using social authentication (e.g., GitHub or Google SSO) in an organization that also allows password authentication could have their personal API key stolen by an unprivileged attacker, allowing nearly full access to the user's account.

### References

* <https://nvd.nist.gov/vuln/detail/CVE-2019-18933>
* [zulip/zulip@0c2cc41](https://github.com/zulip/zulip/commit/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)
* <https://blog.zulip.org/2019/11/21/zulip-2-0-7-security-release>

Published by the [National Vulnerability Database](https://nvd.nist.gov/vuln/detail/CVE-2019-18933)
Nov 21, 2019

Published to the GitHub Advisory Database
May 24, 2022

Last updated
Apr 4, 2024

### Severity

Critical

9.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

### [EPSS score](https://www.first.org/epss/user-guide)

0.319%
 (70th percentile)

### Weaknesses

No CWEs

### CVE ID

CVE-2019-18933

### GHSA ID

GHSA-8c73-4mfq-f8m8

### Source code

No known source code

Dependabot alerts are not supported on this advisory because it does not have a package from a supported ecosystem with an affected and fixed version.

[Learn more about GitHub language support](https://docs.github.com/get-started/learning-about-github/github-language-support#about-supported-languages)

 Loading

Checking history

See something to contribute?
[Suggest improvements for this vulnerability](/advisories/GHSA-8c73-4mfq-f8m8/improve).

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from blog.zulip.org_ef269d88_20250121_002919.html ===
    ![Zulip](/_astro/zulip-logo.BWWbWTcB.svg)

* [Zulip homepage](https://zulip.com)
* [GitHub](https://github.com/zulip)

    [Subscribe](https://groups.google.com/g/zulip-announce/about)      [Release announcements](tag/release-announcements/), [Security](tag/security/)
# Zulip 2.0.7 security release

  [![](/_astro/tabbott.Y0j5haym_Z1qaMxj.webp)](author/tabbott/)  [Tim Abbott](author/tabbott/)   Nov 21, 2019 • 3 min read

We released Zulip Server 2.0.7 today. This is a security release, containing a
handful of cherry-picked changes since Zulip 2.0.6.

## What’s new

This release fixes an important security bug in previous versions of Zulip.
Quoting from
[the commit](https://github.com/zulip/zulip/commit/0c2cc41d2e40807baa5ee2c72987ebfb64ea2eb6)
fixing it:

```
CVE-2019-18933: Fix insecure account creation via social authentication.

A bug in Zulip's new user signup process meant that users who
registered their account using social authentication (e.g. GitHub or
Google SSO) in an organization that also allows password
authentication could have their personal API key stolen by an
unprivileged attacker, allowing nearly full access to the user's
account.

Zulip versions between 1.7.0 and 2.0.6 were affected.

This commit fixes the original bug and also contains a database
migration to fix any users with corrupt `password` fields in the
database as a result of the bug.

Out of an abundance of caution (and to protect the users of any
installations that delay applying this commit), the migration also
resets the API keys of any users where Zulip's logs cannot prove the
user's API key was not previously stolen via this bug.  Resetting
those API keys will be inconvenient for users:

* Users of the Zulip mobile and terminal apps whose API keys are reset
  will be logged out and need to login again.
* Users using their personal API keys for any other reason will need
  to re-fetch their personal API key.

We discovered this bug internally and don't believe it was disclosed
prior to our publishing it through this commit.  Because the algorithm
for determining which users might have been affected is very
conservative, many users who were never at risk will have their API
keys reset by this migration.

To avoid this on self-hosted installations that have always used
e.g. LDAP authentication, we skip resetting API keys on installations
that don't have password authentication enabled.  System
administrators on installations that used to have email authentication
enabled, but no longer do, should temporarily enable EmailAuthBackend
before applying this migration.
```

Installations with certain common configurations of `AUTHENTICATION_BACKENDS`
(in `/etc/zulip/settings.py`) are not affected by this vulnerability. In
particular, this issue does not affect installations where:

* `EmailAuthBackend` is not enabled in `AUTHENTICATION_BACKENDS`.
* `EmailAuthBackend` is the only backend enabled in `AUTHENTICATION_BACKENDS`.

Other installations should upgrade promptly.

This release also contains some hardening changes to help prevent bugs like this
from being introduced in the future.

As a sidenote, we expect Zulip 2.1 to be released soon after Thanksgiving, with
hundreds of new features and other changes.

## Upgrading

All installations should upgrade promptly to secure their installations. See the
[upgrade instructions](https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-a-release)
in the Zulip documentation.

If you’re upgrading from 2.0.x, then the code changes are small and there are no
migrations or dependency changes, so the risk of unexpected disruption is low.
If you’re upgrading from an older version, we recommend upgrading directly to
this latest release.

If you’re running a fork of master, you will need to
[rebase your fork](https://zulip.readthedocs.io/en/latest/production/upgrade-or-modify.html#upgrading-to-future-releases)
to get these fixes.

If you need help, best-effort support is available on
[chat.zulip.org, the Zulip community chat server](https://zulip.readthedocs.io/en/latest/contributing/chat-zulip-org.html).

## Community

We love feedback from the Zulip user community. Here are a few ways you can
connect:

* Join
  [chat.zulip.org, the Zulip community Zulip server](https://zulip.readthedocs.io/en/latest/contributing/chat-zulip-org.html).
  Several streams have user feedback and discussion as their primary purpose.
* [Follow us on Twitter](https://twitter.com/zulip), or join our
  [announcement mailing list](https://groups.google.com/g/zulip-announce).

## Read more from Zulip.

Check out other posts on the Zulip Blog, or
[sign up](https://groups.google.com/g/zulip-announce/about) to receive
emails about new posts and other Zulip announcements.

    Copyright © Kandra Labs, Inc. Built with Astro
