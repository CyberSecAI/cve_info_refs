=== Content from github.com_73e9a7d6_20250121_001026.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjbouse-debian%2Flibesmtp%2Fblob%2Fca5bd0800ef1da234315da4c59716568eb5e6402%2Fntlm%2Fntlmstruct.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjbouse-debian%2Flibesmtp%2Fblob%2Fca5bd0800ef1da234315da4c59716568eb5e6402%2Fntlm%2Fntlmstruct.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=jbouse-debian%2Flibesmtp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[jbouse-debian](/jbouse-debian)
/
**[libesmtp](/jbouse-debian/libesmtp)**
Public

* [Notifications](/login?return_to=%2Fjbouse-debian%2Flibesmtp) You must be signed in to change notification settings
* [Fork
  3](/login?return_to=%2Fjbouse-debian%2Flibesmtp)
* [Star
   3](/login?return_to=%2Fjbouse-debian%2Flibesmtp)

* [Code](/jbouse-debian/libesmtp)
* [Pull requests
  0](/jbouse-debian/libesmtp/pulls)
* [Actions](/jbouse-debian/libesmtp/actions)
* [Projects
  0](/jbouse-debian/libesmtp/projects)
* [Wiki](/jbouse-debian/libesmtp/wiki)
* [Security](/jbouse-debian/libesmtp/security)
* [Insights](/jbouse-debian/libesmtp/pulse)

Additional navigation options

* [Code](/jbouse-debian/libesmtp)
* [Pull requests](/jbouse-debian/libesmtp/pulls)
* [Actions](/jbouse-debian/libesmtp/actions)
* [Projects](/jbouse-debian/libesmtp/projects)
* [Wiki](/jbouse-debian/libesmtp/wiki)
* [Security](/jbouse-debian/libesmtp/security)
* [Insights](/jbouse-debian/libesmtp/pulse)

## Files

 ca5bd08
## Breadcrumbs

1. [libesmtp](/jbouse-debian/libesmtp/tree/ca5bd0800ef1da234315da4c59716568eb5e6402)
2. /[ntlm](/jbouse-debian/libesmtp/tree/ca5bd0800ef1da234315da4c59716568eb5e6402/ntlm)
/
# ntlmstruct.c

Copy path Blame  Blame
## Latest commit

## History

[History](/jbouse-debian/libesmtp/commits/ca5bd0800ef1da234315da4c59716568eb5e6402/ntlm/ntlmstruct.c)331 lines (299 loc) · 8.55 KB ca5bd08
## Breadcrumbs

1. [libesmtp](/jbouse-debian/libesmtp/tree/ca5bd0800ef1da234315da4c59716568eb5e6402)
2. /[ntlm](/jbouse-debian/libesmtp/tree/ca5bd0800ef1da234315da4c59716568eb5e6402/ntlm)
/
# ntlmstruct.c

Top
## File metadata and controls

* Code
* Blame

331 lines (299 loc) · 8.55 KB[Raw](https://github.com/jbouse-debian/libesmtp/raw/ca5bd0800ef1da234315da4c59716568eb5e6402/ntlm/ntlmstruct.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330/\* \* Authentication module for the Micr$oft NTLM mechanism. \* \* This file is part of libESMTP, a library for submission of RFC 2822 \* formatted electronic mail messages using the SMTP protocol described \* in RFC 2821. \* \* Copyright (C) 2002 Brian Stafford <brian@stafford.uklinux.net> \* \* This library is free software; you can redistribute it and/or \* modify it under the terms of the GNU Lesser General Public \* License as published by the Free Software Foundation; either \* version 2.1 of the License, or (at your option) any later version. \* \* This library is distributed in the hope that it will be useful, \* but WITHOUT ANY WARRANTY; without even the implied warranty of \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU \* Lesser General Public License for more details. \* \* You should have received a copy of the GNU Lesser General Public \* License along with this library; if not, write to the Free Software \* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA \*/#if HAVE\_CONFIG\_H#include <config.h>#endif
#include <stdlib.h>#include <string.h>#include <assert.h>
#include "ntlm.h"
/\* Must have at least 32 bits in an int (at least pending a more thorough code review - this module is still experimental) \*/#if SIZEOF\_UNSIGNED\_INT < 32 / 8# error "unsigned int is less than 32 bits wide"#endif
#if SIZEOF\_UNSIGNED\_SHORT == 16 / 8typedef unsigned short unsigned16\_t;#else#include <sys/types.h>typedef uint16 unsigned16\_t;#endif
#if SIZEOF\_UNSIGNED\_INT == 32 / 8typedef unsigned int unsigned32\_t;#elif SIZEOF\_UNSIGNED\_LONG == 32 / 8typedef unsigned long unsigned32\_t;#else#include <sys/types.h>typedef uint32 unsigned32\_t;#endif
#ifdef WORDS\_BIGENDIAN/\* Everything in NTLM is little endian binary, therefore byte swapping is needed on big endian platforms. For simplicity, always provide byte swapping functions rather than trying to detect the local platform's support. These functions make no effort to be efficient since this code doesn't require efficient byte swapping. \*/
#define SWAP(a,b) do { unsigned char s = u.swap[(a)]; \ u.swap[(a)] = u.swap[(b)]; \ u.swap[(b)] = s; } while (0)
static unsigned16\_tbswap\_16 (unsigned16\_t value){ union { unsigned16\_t val; unsigned char swap[2]; } u;
 u.val = value; SWAP(0,1); return u.val;}
static unsigned32\_tbswap\_32 (unsigned32\_t value){ union u32 { unsigned32\_t val; unsigned char swap[4]; } u;
 u.val = value; SWAP(0,3); SWAP(1,2); return u.val;}
#undef SWAP#endif
static voidwrite\_uint16 (char \*buf, size\_t offset, unsigned int value){ unsigned16\_t i16 = value;
 assert (sizeof i16 == 2);#ifdef WORDS\_BIGENDIAN i16 = bswap\_16 (i16);#endif memcpy (buf + offset, &i16, sizeof i16);}
static inline voidwrite\_uint32 (char \*buf, size\_t offset, unsigned int value){ unsigned32\_t i32 = value;
 assert (sizeof i32 == 4);#ifdef WORDS\_BIGENDIAN i32 = bswap\_32 (i32);#endif memcpy (buf + offset, &i32, sizeof i32);}
static inline unsigned intread\_uint16 (const char \*buf, size\_t offset){ unsigned16\_t i16;
 assert (sizeof i16 == 2); memcpy (&i16, buf + offset, sizeof i16);#ifdef WORDS\_BIGENDIAN i16 = bswap\_16 (i16);#endif return i16;}
static inline unsigned intread\_uint32 (const char \*buf, size\_t offset){ unsigned32\_t i32;
 assert (sizeof i32 == 4); memcpy (&i32, buf + offset, sizeof i32);#ifdef WORDS\_BIGENDIAN i32 = bswap\_32 (i32);#endif return i32;}
static inline voidwrite\_string (char \*buf, size\_t offset, size\_t \*str\_offset, const void \*data, size\_t len){ if (data == NULL) len = 0; write\_uint16 (buf, offset, len); write\_uint16 (buf, offset + 2, len); write\_uint32 (buf, offset + 4, \*str\_offset); if (len > 0) memcpy (buf + \*str\_offset, data, len); \*str\_offset += len;}
/\* Offsets into on-the-wire NTLM structures \*/#define PROTOCOL 0 /\* "NTLMSSP" \*/#define MSGTYPE 8 /\* 1..3 \*//\* Type 1 fields \*/#define T1FLAGS 12 /\* 0xb203 \*/#define T1DOMAIN 16 /\* domain to authenticate in \*/#define T1WKSTN 24 /\* client workstation name \*/#define T1SIZE 32/\* Type 2 fields \*/#define T2AUTHTARGET 12 /\* domain/server \*/#define T2FLAGS 20 /\* 0x8201 \*/#define T2NONCE 24 /\* server challenge \*/#define T2RESERVED 32#define T2SIZE 40/\* Type 3 fields \*/#define T3LMRESPONSE 12 /\* lanmanager hash \*/#define T3NTRESPONSE 20 /\* nt hash \*/#define T3DOMAIN 28 /\* domain to authenticate against \*/#define T3USER 36 /\* user name \*/#define T3WKSTN 44 /\* client workstation name \*/#define T3SESSIONKEY 52 /\* client workstation name \*/#define T3FLAGS 60 /\* 0xb203 \*/#define T3SIZE 64
static const char NTLMSSP[] = "NTLMSSP";
/\* Build a NTLM type 1 structure in the buffer. domain - the NT domain the workstation belongs to workstation - the NT (netbios) name of the workstation \*/size\_tntlm\_build\_type\_1 (char \*buf, size\_t buflen, unsigned int flags, const char \*domain, const char \*workstation){ size\_t offset = T1SIZE; size\_t len; unsigned char \*up; char string[256];
 if (buflen < offset) return 0; memcpy (buf, NTLMSSP, 8); write\_uint32 (buf, MSGTYPE, 1); write\_uint32 (buf, T1FLAGS, flags); up = NULL; len = 0; if (domain != NULL) { len = strlen (domain); if (offset + len > buflen) return 0; lm\_uccpy (string, len, domain); } write\_string (buf, T1DOMAIN, &offset, string, len); up = NULL; len = 0; if (workstation != NULL) { len = strlen (workstation); if (offset + len > buflen) return 0; lm\_uccpy (string, len, workstation); } write\_string (buf, T1WKSTN, &offset, string, len); return offset;}
/\* Build a NTLM type 2 structure in the buffer \*/size\_tntlm\_build\_type\_2 (char \*buf, size\_t buflen, unsigned int flags, const unsigned char \*nonce, const char \*domain){ size\_t offset = T2SIZE; size\_t len; char string[256]; unsigned char \*up;
 if (buflen < offset) return 0; memcpy (buf, NTLMSSP, 8); write\_uint32 (buf, MSGTYPE, 2); up = NULL; len = 0; if (domain != NULL) { len = strlen (domain); if (offset + 2 \* len > buflen) return 0; up = nt\_unicode (lm\_uccpy (string, len, domain), 2 \* len); } write\_string (buf, T2AUTHTARGET, &offset, up, len); if (up != NULL) free (up); write\_uint32 (buf, T2FLAGS, flags); memcpy (buf + T2NONCE, nonce, 8); memset (buf + T2RESERVED, 0, 8); return offset;}
/\* Build a NTLM type 3 structure in the buffer \*/size\_tntlm\_build\_type\_3 (char \*buf, size\_t buflen, unsigned int flags, const unsigned char \*lm\_resp, const unsigned char \*nt\_resp, const char \*domain, const char \*user, const char \*workstation){ size\_t offset = T3SIZE; size\_t len; char string[256]; unsigned char \*up;
 if (buflen + 24 + 24 < offset) return 0; memcpy (buf, NTLMSSP, 8); write\_uint32 (buf, MSGTYPE, 3); write\_string (buf, T3LMRESPONSE, &offset, lm\_resp, 24); write\_string (buf, T3NTRESPONSE, &offset, nt\_resp, 24); up = NULL; len = 0; if (domain != NULL) { len = strlen (domain); if (offset + 2 \* len > buflen) return 0; up = nt\_unicode (lm\_uccpy (string, len, domain), 2 \* len); } write\_string (buf, T3DOMAIN, &offset, up, 2 \* len); if (up != NULL) free (up); up = NULL; len = 0; if (user != NULL) { len = strlen (user); if (offset + 2 \* len > buflen) return 0; up = nt\_unicode (lm\_uccpy (string, len, user), 2 \* len); } write\_string (buf, T3USER, &offset, up, 2 \* len); if (up != NULL) free (up); up = NULL; len = 0; if (workstation != NULL) { len = strlen (workstation); if (offset + 2 \* len > buflen) return 0; up = nt\_unicode (lm\_uccpy (string, len, workstation), 2 \* len); } write\_string (buf, T3WKSTN, &offset, up, 2 \* len); if (up != NULL) free (up); write\_string (buf, T3SESSIONKEY, &offset, NULL, 0); write\_uint32 (buf, T3FLAGS, flags); return offset;}
/\*\*\*\*/
/\* Parse a NTLM type 2 structure in the buffer (partial implementation). Verify that the packet is a type 2 structure and copy the nonce to the supplied buffer (which must be eight bytes long) \*/size\_tntlm\_parse\_type\_2 (const char \*buf, size\_t buflen, unsigned int \*flags, unsigned char \*nonce, char \*\*domain){ if (buflen < T2SIZE) return 0; if (memcmp (buf, NTLMSSP, 8) != 0) return 0; if (read\_uint32 (buf, MSGTYPE) != 2) return 0; \*flags = read\_uint32 (buf, T2FLAGS); \*domain = NULL; memcpy (nonce, buf + T2NONCE, 8); return 1;}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from web.archive.org_6fe17cb3_20250121_001029.html ===


[![Wayback Machine](/_static/images/toolbar/wayback-toolbar-logo-200.png)](/web/ "Wayback Machine home page")

[48 captures](/web/20190528215510%2A/http%3A//brianstafford.info/libesmtp/ "See a list of every capture for this URL")
19 Jun 2018 - 27 May 2024

| [**Apr**](https://web.archive.org/web/20190427171420/http%3A//brianstafford.info%3A80/libesmtp/ "27 Apr 2019") | MAY | [**Jul**](https://web.archive.org/web/20190730173439/http%3A//brianstafford.info%3A80/libesmtp "30 Jul 2019") |
| [Previous capture](https://web.archive.org/web/20190427171420/http%3A//brianstafford.info%3A80/libesmtp/ "17:14:20 Apr 27, 2019") | 28 | [Next capture](https://web.archive.org/web/20190615072051/http%3A//brianstafford.info%3A80/libesmtp/ "07:20:51 Jun 15, 2019") |
| 2018 | 2019 | [**2022**](https://web.archive.org/web/20220330042831/http%3A//brianstafford.info/libesmtp/ "30 Mar 2022") |

success
fail

 [About this capture](#expand)

COLLECTED BY

Organization: [Alexa Crawls](https://archive.org/details/alexacrawls)

Starting in 1996, [Alexa Internet](http://www.alexa.com/) has been donating their crawl data to the Internet Archive. Flowing in every day, these data are added to the [Wayback Machine](http://web.archive.org/) after an embargo period.

Collection: [Alexa Crawls](https://archive.org/details/alexacrawls)

Starting in 1996, [Alexa Internet](http://www.alexa.com/) has been donating their crawl data to the Internet Archive. Flowing in every day, these data are added to the [Wayback Machine](http://web.archive.org/) after an embargo period.

TIMESTAMPS

![loading](/_static/images/loading.gif)

The Wayback Machine - https://web.archive.org/web/20190528215510/http://brianstafford.info:80/libesmtp/

# libESMTP logolibESMTP - A Library for Posting Electronic Mail

---

[Home](index.html)
[NEWS](news.html)
[Download](download.html)
[Licensing & Support](support.html)
[API](api.html)
[FAQ](faq.html)
[Bug Reporting](bugreport.html)
[Rationale](rationale.html)

**libESMTP** is an SMTP client which manages posting (or submission of)
electronic mail via a preconfigured Mail Transport Agent (MTA). It may be
used as part of a Mail User Agent (MUA) or other program that must be able to
post electronic mail where mail functionality may not be that program's
primary purpose.

The availability of a reliable, lightweight and thread-safe
SMTP client eases the task of coding for
software authors thus improving the quality of the resulting code.

## Features

**libESMTP** supports many SMTP extensions,
notably PIPELINING (RFC 2920), DSN
(RFC 1891) and SASL authentication (RFC 2554).

**libESMTP** is
efficient. Because it buffers all
network traffic, when used in conjunction with a pipelining SMTP
server **libESMTP**
significantly increases network performance, especially on slow connections
or those with high latency. Even without a pipelining server **libESMTP**
offers much better performance than would be expected with a simple client.

**libESMTP** is not intended for
use as part of a program that implements a Mail Transport Agent.
This is not because the code is unsuitable for use in an MTA,
in fact the protocol engine is significantly better than those in many MTAs.
Rather, by eliminating the need for MX lookup and next-hop determination,
the design of **libESMTP** is simplified; thus goals are made achievable.
Besides, such features are undesirable in a program that is not an MTA,
particularly if the client is behind a firewall which blocks access to
port 25 on the Internet.

## Author

**libESMTP**'s principal
author is [Brian Stafford](https://web.archive.org/web/20190528215510/https%3A//www.facebook.com/brian.stafford60) who may be contacted at
[contact *at* brianstafford.info](https://web.archive.org/web/20190528215510/mailto%3Acontact%40brianstafford.info).

## Licence

**libESMTP** is licensed under the [GNU Lesser General Public
License](https://web.archive.org/web/20190528215510/http%3A//www.gnu.org/copyleft/lesser.html) and the example programs are under the [GNU General Public
Licence](https://web.archive.org/web/20190528215510/http%3A//www.gnu.org/copyleft/gpl.html). Refer to [Licensing & Support](support.html)
for more details.

**libESMTP** is distributed in the hope that it will
be useful.


