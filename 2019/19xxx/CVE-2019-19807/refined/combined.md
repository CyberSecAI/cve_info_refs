=== Content from usn.ubuntu.com_78c31c9c_20250120_233847.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4227-2: Linux kernel (Azure) vulnerabilities

7 January 2020

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux-azure](/security/cves?package=linux-azure) - Linux kernel for Microsoft Azure Cloud systems

## Details

USN-4227-1 fixed vulnerabilities in the Linux kernel for Ubuntu

18.04 LTS. This update provides the corresponding updates for the

Linux kernel for Microsoft Azure Cloud systems for Ubuntu 14.04 ESM.

It was discovered that a heap-based buffer overflow existed in the Marvell

WiFi-Ex Driver for the Linux kernel. A physically proximate attacker could

use this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-14895](/security/CVE-2019-14895), [CVE-2019-14901](/security/CVE-2019-14901))

It was discovered that a heap-based buffer overflow existed in the Marvell

Libertas WLAN Driver for the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2019-14896](/security/CVE-2019-14896), [CVE-2019-14897](/security/CVE-2019-14897))

It was discovered that the Fujitsu ES network device driver for the Linux

kernel did not properly check for errors in some situations, leading to a

NULL pointer dereference. A local attacker could use this to cause a denial

of service. ([CVE-2019-16231](/security/CVE-2019-16231))

It was discovered that the QLogic Fibre Channel driver in the Linux kernel

did not properly check for error, leading to a NULL pointer dereference. A

local attacker could possibly use this to cause a denial of service (system

crash). ([CVE-2019-16233](/security/CVE-2019-16233))

Anthony Steinhauser discovered that the Linux kernel did not properly

perform Spectre\_RSB mitigations to all processors for PowerPC architecture

systems in some situations. A local attacker could use this to expose

sensitive information. ([CVE-2019-18660](/security/CVE-2019-18660))

It was discovered that the Mellanox Technologies Innova driver in the Linux

kernel did not properly deallocate memory in certain failure conditions. A

local attacker could use this to cause a denial of service (kernel memory

exhaustion). ([CVE-2019-19045](/security/CVE-2019-19045))

It was discovered that Geschwister Schneider USB CAN interface driver in

the Linux kernel did not properly deallocate memory in certain failure

conditions. A physically proximate attacker could use this to cause a

denial of service (kernel memory exhaustion). ([CVE-2019-19052](/security/CVE-2019-19052))

It was discovered that the AMD Display Engine Driver in the Linux kernel

did not properly deallocate memory in certain error conditions. A local

attack could use this to cause a denial of service (memory exhaustion).

([CVE-2019-19083](/security/CVE-2019-19083))

It was discovered that the driver for memoryless force-feedback input

devices in the Linux kernel contained a use-after-free vulnerability. A

physically proximate attacker could possibly use this to cause a denial of

service (system crash) or execute arbitrary code. ([CVE-2019-19524](/security/CVE-2019-19524))

It was discovered that the Microchip CAN BUS Analyzer driver in the Linux

kernel contained a use-after-free vulnerability on device disconnect. A

physically proximate attacker could use this to cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2019-19529](/security/CVE-2019-19529))

It was discovered that the PEAK-System Technik USB driver in the Linux

kernel did not properly sanitize memory before sending it to the device. A

physically proximate attacker could use this to expose sensitive

information (kernel memory). ([CVE-2019-19534](/security/CVE-2019-19534))

Tristan Madani discovered that the ALSA timer implementation in the Linux

kernel contained a use-after-free vulnerability. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-19807](/security/CVE-2019-19807))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 14.04

* [linux-image-azure](https://launchpad.net/ubuntu/%2Bsource/linux-azure)
  -
  [4.15.0.1066.52](https://launchpad.net/ubuntu/%2Bsource/linux-azure/4.15.0-1066.71~14.04.1)
* [linux-image-4.15.0-1066-azure](https://launchpad.net/ubuntu/%2Bsource/linux-azure)
  -
  [4.15.0-1066.71~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-azure/4.15.0-1066.71~14.04.1)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2019-14895](/security/CVE-2019-14895)
* [CVE-2019-14896](/security/CVE-2019-14896)
* [CVE-2019-14897](/security/CVE-2019-14897)
* [CVE-2019-14901](/security/CVE-2019-14901)
* [CVE-2019-18660](/security/CVE-2019-18660)
* [CVE-2019-19083](/security/CVE-2019-19083)
* [CVE-2019-19807](/security/CVE-2019-19807)
* [CVE-2019-16231](/security/CVE-2019-16231)
* [CVE-2019-16233](/security/CVE-2019-16233)
* [CVE-2019-19045](/security/CVE-2019-19045)
* [CVE-2019-19052](/security/CVE-2019-19052)
* [CVE-2019-19524](/security/CVE-2019-19524)
* [CVE-2019-19529](/security/CVE-2019-19529)
* [CVE-2019-19534](/security/CVE-2019-19534)

## Related notices

* [USN-4226-1](/security/notices/USN-4226-1)
* [USN-4227-1](/security/notices/USN-4227-1)
* [USN-4225-1](/security/notices/USN-4225-1)
* [USN-4225-2](/security/notices/USN-4225-2)
* [USN-4228-1](/security/notices/USN-4228-1)
* [USN-4228-2](/security/notices/USN-4228-2)
* [USN-4208-1](/security/notices/USN-4208-1)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-4346-1](/security/notices/USN-4346-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from cdn.kernel.org_8d79e314_20250120_233840.html ===
commit dada86c5aaa8f2305bf8a8bf9014b60603f9f013
Author: Greg Kroah-Hartman
Date: Tue Nov 12 19:28:31 2019 +0100
Linux 5.3.11
commit a46ee66f47837a36a1eaa48920601db6e05a1c56
Author: Junaid Shahid
Date: Fri Nov 1 00:14:14 2019 +0100
kvm: x86: mmu: Recovery of shattered NX large pages
commit 1aa9b9572b10529c2e64e2b8f44025d86e124308 upstream.
The page table pages corresponding to broken down large pages are zapped in
FIFO order, so that the large page can potentially be recovered, if it is
not longer being used for execution. This removes the performance penalty
for walking deeper EPT page tables.
By default, one large page will last about one hour once the guest
reaches a steady state.
Signed-off-by: Junaid Shahid
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 4ad894b92932c8d1518d634994b1928db6033e19
Author: Junaid Shahid
Date: Fri Nov 1 00:14:08 2019 +0100
kvm: Add helper function for creating VM worker threads
commit c57c80467f90e5504c8df9ad3555d2c78800bf94 upstream.
Add a function to create a kernel thread associated with a given VM. In
particular, it ensures that the worker thread inherits the priority and
cgroups of the calling thread.
Signed-off-by: Junaid Shahid
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 78ffa84f00ff6b19f00c0e6dfe1870aba0db4025
Author: Paolo Bonzini
Date: Mon Nov 4 12:22:02 2019 +0100
kvm: mmu: ITLB\_MULTIHIT mitigation
commit b8e8c8303ff28c61046a4d0f6ea99aea609a7dc0 upstream.
With some Intel processors, putting the same virtual address in the TLB
as both a 4 KiB and 2 MiB page can confuse the instruction fetch unit
and cause the processor to issue a machine check resulting in a CPU lockup.
Unfortunately when EPT page tables use huge pages, it is possible for a
malicious guest to cause this situation.
Add a knob to mark huge pages as non-executable. When the nx\_huge\_pages
parameter is enabled (and we are using EPT), all huge pages are marked as
NX. If the guest attempts to execute in one of those pages, the page is
broken down into 4K pages, which are then marked executable.
This is not an issue for shadow paging (except nested EPT), because then
the host is in control of TLB flushes and the problematic situation cannot
happen. With nested EPT, again the nested guest can cause problems shadow
and direct EPT is treated in the same way.
[ tglx: Fixup default to auto and massage wording a bit ]
Originally-by: Junaid Shahid
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 1655a277fe4aed4cab0590fa712961993d56e936
Author: Paolo Bonzini
Date: Fri Oct 11 11:59:48 2019 +0200
kvm: x86, powerpc: do not allow clearing largepages debugfs entry
commit 833b45de69a6016c4b0cebe6765d526a31a81580 upstream.
The largepages debugfs entry is incremented/decremented as shadow
pages are created or destroyed. Clearing it will result in an
underflow, which is harmless to KVM but ugly (and could be
misinterpreted by tools that use debugfs information), so make
this particular statistic read-only.
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Cc: kvm-ppc@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 1af2cfe692941116565396065d6c86e203564fcd
Author: Gomez Iglesias, Antonio
Date: Mon Nov 4 12:22:03 2019 +0100
Documentation: Add ITLB\_MULTIHIT documentation
commit 7f00cc8d4a51074eb0ad4c3f16c15757b1ddfb7d upstream.
Add the initial ITLB\_MULTIHIT documentation.
[ tglx: Add it to the index so it gets actually built. ]
Signed-off-by: Antonio Gomez Iglesias
Signed-off-by: Nelson D'Souza
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit d068ec1dca619fdaf37351424dbba21429644f64
Author: Tyler Hicks
Date: Mon Nov 4 12:22:02 2019 +0100
cpu/speculation: Uninline and export CPU mitigations helpers
commit 731dc9df975a5da21237a18c3384f811a7a41cc6 upstream.
A kernel module may need to check the value of the "mitigations=" kernel
command line parameter as part of its setup when the module needs
to perform software mitigations for a CPU flaw.
Uninline and export the helper functions surrounding the cpu\_mitigations
enum to allow for their usage from a module.
Lastly, privatize the enum and cpu\_mitigations variable since the value of
cpu\_mitigations can be checked with the exported helper functions.
Signed-off-by: Tyler Hicks
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 034967e8bd7d7f9dfd9c1348463906f0372fc999
Author: Pawan Gupta
Date: Mon Nov 4 12:22:01 2019 +0100
x86/cpu: Add Tremont to the cpu vulnerability whitelist
commit cad14885a8d32c1c0d8eaa7bf5c0152a22b6080e upstream.
Add the new cpu family ATOM\_TREMONT\_D to the cpu vunerability
whitelist. ATOM\_TREMONT\_D is not affected by X86\_BUG\_ITLB\_MULTIHIT.
ATOM\_TREMONT\_D might have mitigations against other issues as well, but
only the ITLB multihit mitigation is confirmed at this point.
Signed-off-by: Pawan Gupta
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit 8e79a48022f5f861e39babf31ee62f55328b8e09
Author: Vineela Tummalapalli
Date: Mon Nov 4 12:22:01 2019 +0100
x86/bugs: Add ITLB\_MULTIHIT bug infrastructure
commit db4d30fbb71b47e4ecb11c4efa5d8aad4b03dfae upstream.
Some processors may incur a machine check error possibly resulting in an
unrecoverable CPU lockup when an instruction fetch encounters a TLB
multi-hit in the instruction TLB. This can occur when the page size is
changed along with either the physical address or cache type. The relevant
erratum can be found here:
https://bugzilla.kernel.org/show\_bug.cgi?id=205195
There are other processors affected for which the erratum does not fully
disclose the impact.
This issue affects both bare-metal x86 page tables and EPT.
It can be mitigated by either eliminating the use of large pages or by
using careful TLB invalidations when changing the page size in the page
tables.
Just like Spectre, Meltdown, L1TF and MDS, a new bit has been allocated in
MSR\_IA32\_ARCH\_CAPABILITIES (PSCHANGE\_MC\_NO) and will be set on CPUs which
are mitigated against this issue.
Signed-off-by: Vineela Tummalapalli
Co-developed-by: Pawan Gupta
Signed-off-by: Pawan Gupta
Signed-off-by: Paolo Bonzini
Signed-off-by: Thomas Gleixner
Signed-off-by: Greg Kroah-Hartman
commit a413f8c8637f8dba5ef94dd10f0ca894a553021d
Author: Josh Poimboeuf
Date: Wed Nov 6 20:26:46 2019 -0600
x86/speculation/taa: Fix printing of TAA\_MSG\_SMT on IBRS\_ALL CPUs
commit 012206a822a8b6ac09125bfaa210a95b9eb8f1c1 upstream.
For new IBRS\_ALL CPUs, the Enhanced IBRS check at the beginning of
cpu\_bugs\_smt\_update() causes the function to return early, unintentionally
skipping the MDS and TAA logic.
This is not a problem for MDS, because there appears to be no overlap
between IBRS\_ALL and MDS-affected CPUs. So the MDS mitigation would be
disabled and nothing would need to be done in this function anyway.
But for TAA, the TAA\_MSG\_SMT string will never get printed on Cascade
Lake and newer.
The check is superfluous anyway: when 'spectre\_v2\_enabled' is
SPECTRE\_V2\_IBRS\_ENHANCED, 'spectre\_v2\_user' is always
SPECTRE\_V2\_USER\_NONE, and so the 'spectre\_v2\_user' switch statement
handles it appropriately by doing nothing. So just remove the check.
Fixes: 1b42f017415b ("x86/speculation/taa: Add mitigation for TSX Async Abort")
Signed-off-by: Josh Poimboeuf
Signed-off-by: Thomas Gleixner
Reviewed-by: Tyler Hicks
Reviewed-by: Borislav Petkov
Signed-off-by: Greg Kroah-Hartman
commit 4943a4097ed4d32d2d996306c7b0350a21991380
Author: Michal Hocko
Date: Wed Oct 23 12:35:50 2019 +0200
x86/tsx: Add config options to set tsx=on|off|auto
commit db616173d787395787ecc93eef075fa975227b10 upstream.
There is a general consensus that TSX usage is not largely spread while
the history shows there is a non trivial space for side channel attacks
possible. Therefore the tsx is disabled by default even on platforms
that might have a safe implementation of TSX according to the current
knowledge. This is a fair trade off to make.
There are, however, workloads that really do benefit from using TSX and
updating to a newer kernel with TSX disabled might introduce a
noticeable regressions. This would be especially a problem for Linux
distributions which will provide TAA mitigations.
Introduce config options X86\_INTEL\_TSX\_MODE\_OFF, X86\_INTEL\_TSX\_MODE\_ON
and X86\_INTEL\_TSX\_MODE\_AUTO to control the TSX feature. The config
setting can be overridden by the tsx cmdline options.
[ bp: Text cleanups from Josh. ]
Suggested-by: Borislav Petkov
Signed-off-by: Michal Hocko
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 3bd7d98dae592f2eca8e460b74d9f1df0891ac2c
Author: Pawan Gupta
Date: Wed Oct 23 12:32:55 2019 +0200
x86/speculation/taa: Add documentation for TSX Async Abort
commit a7a248c593e4fd7a67c50b5f5318fe42a0db335e upstream.
Add the documenation for TSX Async Abort. Include the description of
the issue, how to check the mitigation state, control the mitigation,
guidance for system administrators.
[ bp: Add proper SPDX tags, touch ups by Josh and me. ]
Co-developed-by: Antonio Gomez Iglesias
Signed-off-by: Pawan Gupta
Signed-off-by: Antonio Gomez Iglesias
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-by: Mark Gross
Reviewed-by: Tony Luck
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 7fb8160ccd4a8ee015e10bebe2d02819696b6215
Author: Pawan Gupta
Date: Wed Oct 23 12:28:57 2019 +0200
x86/tsx: Add "auto" option to the tsx= cmdline parameter
commit 7531a3596e3272d1f6841e0d601a614555dc6b65 upstream.
Platforms which are not affected by X86\_BUG\_TAA may want the TSX feature
enabled. Add "auto" option to the TSX cmdline parameter. When tsx=auto
disable TSX when X86\_BUG\_TAA is present, otherwise enable TSX.
More details on X86\_BUG\_TAA can be found here:
https://www.kernel.org/doc/html/latest/admin-guide/hw-vuln/tsx\_async\_abort.html
[ bp: Extend the arg buffer to accommodate "auto\0". ]
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-by: Tony Luck
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 0bfef6e0fa43dde5718d7d47f45400e390b3f175
Author: Pawan Gupta
Date: Wed Oct 23 12:23:33 2019 +0200
kvm/x86: Export MDS\_NO=0 to guests when TSX is enabled
commit e1d38b63acd843cfdd4222bf19a26700fd5c699e upstream.
Export the IA32\_ARCH\_CAPABILITIES MSR bit MDS\_NO=0 to guests on TSX
Async Abort(TAA) affected hosts that have TSX enabled and updated
microcode. This is required so that the guests don't complain,
"Vulnerable: Clear CPU buffers attempted, no microcode"
when the host has the updated microcode to clear CPU buffers.
Microcode update also adds support for MSR\_IA32\_TSX\_CTRL which is
enumerated by the ARCH\_CAP\_TSX\_CTRL bit in IA32\_ARCH\_CAPABILITIES MSR.
Guests can't do this check themselves when the ARCH\_CAP\_TSX\_CTRL bit is
not exported to the guests.
In this case export MDS\_NO=0 to the guests. When guests have
CPUID.MD\_CLEAR=1, they deploy MDS mitigation which also mitigates TAA.
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Tested-by: Neelima Krishnan
Reviewed-by: Tony Luck
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 3087c94f2194269e6e3efb87ee88daa74dbcf8fc
Author: Pawan Gupta
Date: Wed Oct 23 12:19:51 2019 +0200
x86/speculation/taa: Add sysfs reporting for TSX Async Abort
commit 6608b45ac5ecb56f9e171252229c39580cc85f0f upstream.
Add the sysfs reporting file for TSX Async Abort. It exposes the
vulnerability and the mitigation state similar to the existing files for
the other hardware vulnerabilities.
Sysfs file path is:
/sys/devices/system/cpu/vulnerabilities/tsx\_async\_abort
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Tested-by: Neelima Krishnan
Reviewed-by: Mark Gross
Reviewed-by: Tony Luck
Reviewed-by: Greg Kroah-Hartman
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 981d3a01c29b03b512604f21196af3ec7a14987f
Author: Pawan Gupta
Date: Wed Oct 23 11:30:45 2019 +0200
x86/speculation/taa: Add mitigation for TSX Async Abort
commit 1b42f017415b46c317e71d41c34ec088417a1883 upstream.
TSX Async Abort (TAA) is a side channel vulnerability to the internal
buffers in some Intel processors similar to Microachitectural Data
Sampling (MDS). In this case, certain loads may speculatively pass
invalid data to dependent operations when an asynchronous abort
condition is pending in a TSX transaction.
This includes loads with no fault or assist condition. Such loads may
speculatively expose stale data from the uarch data structures as in
MDS. Scope of exposure is within the same-thread and cross-thread. This
issue affects all current processors that support TSX, but do not have
ARCH\_CAP\_TAA\_NO (bit 8) set in MSR\_IA32\_ARCH\_CAPABILITIES.
On CPUs which have their IA32\_ARCH\_CAPABILITIES MSR bit MDS\_NO=0,
CPUID.MD\_CLEAR=1 and the MDS mitigation is clearing the CPU buffers
using VERW or L1D\_FLUSH, there is no additional mitigation needed for
TAA. On affected CPUs with MDS\_NO=1 this issue can be mitigated by
disabling the Transactional Synchronization Extensions (TSX) feature.
A new MSR IA32\_TSX\_CTRL in future and current processors after a
microcode update can be used to control the TSX feature. There are two
bits in that MSR:
\* TSX\_CTRL\_RTM\_DISABLE disables the TSX sub-feature Restricted
Transactional Memory (RTM).
\* TSX\_CTRL\_CPUID\_CLEAR clears the RTM enumeration in CPUID. The other
TSX sub-feature, Hardware Lock Elision (HLE), is unconditionally
disabled with updated microcode but still enumerated as present by
CPUID(EAX=7).EBX{bit4}.
The second mitigation approach is similar to MDS which is clearing the
affected CPU buffers on return to user space and when entering a guest.
Relevant microcode update is required for the mitigation to work. More
details on this approach can be found here:
https://www.kernel.org/doc/html/latest/admin-guide/hw-vuln/mds.html
The TSX feature can be controlled by the "tsx" command line parameter.
If it is force-enabled then "Clear CPU buffers" (MDS mitigation) is
deployed. The effective mitigation state can be read from sysfs.
[ bp:
- massage + comments cleanup
- s/TAA\_MITIGATION\_TSX\_DISABLE/TAA\_MITIGATION\_TSX\_DISABLED/g - Josh.
- remove partial TAA mitigation in update\_mds\_branch\_idle() - Josh.
- s/tsx\_async\_abort\_cmdline/tsx\_async\_abort\_parse\_cmdline/g
]
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 1b0f6c35a0d3b08369ddafb6498fbf18ffc436cb
Author: Pawan Gupta
Date: Wed Oct 23 11:01:53 2019 +0200
x86/cpu: Add a "tsx=" cmdline option with TSX disabled by default
commit 95c5824f75f3ba4c9e8e5a4b1a623c95390ac266 upstream.
Add a kernel cmdline parameter "tsx" to control the Transactional
Synchronization Extensions (TSX) feature. On CPUs that support TSX
control, use "tsx=on|off" to enable or disable TSX. Not specifying this
option is equivalent to "tsx=off". This is because on certain processors
TSX may be used as a part of a speculative side channel attack.
Carve out the TSX controlling functionality into a separate compilation
unit because TSX is a CPU feature while the TSX async abort control
machinery will go to cpu/bugs.c.
[ bp: - Massage, shorten and clear the arg buffer.
- Clarifications of the tsx= possible options - Josh.
- Expand on TSX\_CTRL availability - Pawan. ]
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 0d6c39a641b7b527b12c16459ad0b42d7b4ba7a1
Author: Pawan Gupta
Date: Wed Oct 23 10:52:35 2019 +0200
x86/cpu: Add a helper function x86\_read\_arch\_cap\_msr()
commit 286836a70433fb64131d2590f4bf512097c255e1 upstream.
Add a helper function to read the IA32\_ARCH\_CAPABILITIES MSR.
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Tested-by: Neelima Krishnan
Reviewed-by: Mark Gross
Reviewed-by: Tony Luck
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit b5b1f0297258207ac438525fe81d97a6f9ab1363
Author: Pawan Gupta
Date: Wed Oct 23 10:45:50 2019 +0200
x86/msr: Add the IA32\_TSX\_CTRL MSR
commit c2955f270a84762343000f103e0640d29c7a96f3 upstream.
Transactional Synchronization Extensions (TSX) may be used on certain
processors as part of a speculative side channel attack. A microcode
update for existing processors that are vulnerable to this attack will
add a new MSR - IA32\_TSX\_CTRL to allow the system administrator the
option to disable TSX as one of the possible mitigations.
The CPUs which get this new MSR after a microcode upgrade are the ones
which do not set MSR\_IA32\_ARCH\_CAPABILITIES.MDS\_NO (bit 5) because those
CPUs have CPUID.MD\_CLEAR, i.e., the VERW implementation which clears all
CPU buffers takes care of the TAA case as well.
[ Note that future processors that are not vulnerable will also
support the IA32\_TSX\_CTRL MSR. ]
Add defines for the new IA32\_TSX\_CTRL MSR and its bits.
TSX has two sub-features:
1. Restricted Transactional Memory (RTM) is an explicitly-used feature
where new instructions begin and end TSX transactions.
2. Hardware Lock Elision (HLE) is implicitly used when certain kinds of
"old" style locks are used by software.
Bit 7 of the IA32\_ARCH\_CAPABILITIES indicates the presence of the
IA32\_TSX\_CTRL MSR.
There are two control bits in IA32\_TSX\_CTRL MSR:
Bit 0: When set, it disables the Restricted Transactional Memory (RTM)
sub-feature of TSX (will force all transactions to abort on the
XBEGIN instruction).
Bit 1: When set, it disables the enumeration of the RTM and HLE feature
(i.e. it will make CPUID(EAX=7).EBX{bit4} and
CPUID(EAX=7).EBX{bit11} read as 0).
The other TSX sub-feature, Hardware Lock Elision (HLE), is
unconditionally disabled by the new microcode but still enumerated
as present by CPUID(EAX=7).EBX{bit4}, unless disabled by
IA32\_TSX\_CTRL\_MSR[1] - TSX\_CTRL\_CPUID\_CLEAR.
Signed-off-by: Pawan Gupta
Signed-off-by: Borislav Petkov
Signed-off-by: Thomas Gleixner
Tested-by: Neelima Krishnan
Reviewed-by: Mark Gross
Reviewed-by: Tony Luck
Reviewed-by: Josh Poimboeuf
Signed-off-by: Greg Kroah-Hartman
commit 0a4f236d3ad245824e8571d15338c38eea71fae0
Author: Ben Hutchings
Date: Mon Nov 11 08:13:24 2019 -0800
drm/i915/cmdparser: Fix jump whitelist clearing
commit ea0b163b13ffc52818c079adb00d55e227a6da6f upstream.
When a jump\_whitelist bitmap is reused, it needs to be cleared.
Currently this is done with memset() and the size calculation assumes
bitmaps are made of 32-bit words, not longs. So on 64-bit
architectures, only the first half of the bitmap is cleared.
If some whitelist bits are carried over between successive batches
submitted on the same context, this will presumably allow embedding
the rogue instructions that we're trying to reject.
Use bitmap\_zero() instead, which gets the calculation right.
Fixes: f8c08d8faee5 ("drm/i915/cmdparser: Add support for backward jumps")
Signed-off-by: Ben Hutchings
Signed-off-by: Jon Bloomfield
Signed-off-by: Greg Kroah-Hartman
commit d4360736a7c0a6326e3bbdf7d41181f6ed03d9a6
Author: Imre Deak
Date: Mon Jul 9 18:24:27 2018 +0300
drm/i915/gen8+: Add RC6 CTX corruption WA
commit 7e34f4e4aad3fd34c02b294a3cf2321adf5b4438 upstream.
In some circumstances the RC6 context can get corrupted. We can detect
this and take the required action, that is disable RC6 and runtime PM.
The HW recovers from the corrupted state after a system suspend/resume
cycle, so detect the recovery and re-enable RC6 and runtime PM.
v2: rebase (Mika)
v3:
- Move intel\_suspend\_gt\_powersave() to the end of the GEM suspend
sequence.
- Add commit message.
v4:
- Rebased on intel\_uncore\_forcewake\_put(i915->uncore, ...) API
change.
v5: rebased on gem/gt split (Mika)
Signed-off-by: Imre Deak
Signed-off-by: Mika Kuoppala
Signed-off-by: Greg Kroah-Hartman
commit 343c1b3bb8284af4dccd5c47a9818eb40be8c39a
Author: Uma Shankar
Date: Tue Aug 7 21:15:35 2018 +0530
drm/i915: Lower RM timeout to avoid DSI hard hangs
commit 1d85a299c4db57c55e0229615132c964d17aa765 upstream.
In BXT/APL, device 2 MMIO reads from MIPI controller requires its PLL
to be turned ON. When MIPI PLL is turned off (MIPI Display is not
active or connected), and someone (host or GT engine) tries to read
MIPI registers, it causes hard hang. This is a hardware restriction
or limitation.
Driver by itself doesn't read MIPI registers when MIPI display is off.
But any userspace application can submit unprivileged batch buffer for
execution. In that batch buffer there can be mmio reads. And these
reads are allowed even for unprivileged applications. If these
register reads are for MIPI DSI controller and MIPI display is not
active during that time, then the MMIO read operation causes system
hard hang and only way to recover is hard reboot. A genuine
process/application won't submit batch buffer like this and doesn't
cause any issue. But on a compromised system, a malign userspace
process/app can generate such batch buffer and can trigger system
hard hang (denial of service attack).
The fix is to lower the internal MMIO timeout value to an optimum
value of 950us as recommended by hardware team. If the timeout is
beyond 1ms (which will hit for any value we choose if MMIO READ on a
DSI specific register is performed without PLL ON), it causes the
system hang. But if the timeout value is lower than it will be below
the threshold (even if timeout happens) and system will not get into
a hung state. This will avoid a system hang without losing any
programming or GT interrupts, taking the worst case of lowest CDCLK
frequency and early DC5 abort into account.
Signed-off-by: Uma Shankar
Reviewed-by: Jon Bloomfield
Signed-off-by: Greg Kroah-Hartman
commit bdb4e778f43a07e0d51354c4b9a8a17306ec4b85
Author: Jon Bloomfield
Date: Thu Sep 20 09:45:10 2018 -0700
drm/i915/cmdparser: Ignore Length operands during command matching
commit 926abff21a8f29ef159a3ac893b05c6e50e043c3 upstream.
Some of the gen instruction macros (e.g. MI\_DISPLAY\_FLIP) have the
length directly encoded in them. Since these are used directly in
the tables, the Length becomes part of the comparison used for
matching during parsing. Thus, if the cmd being parsed has a
different length to that in the table, it is not matched and the
cmd is accepted via the default variable length path.
Fix by masking out everything except the Opcode in the cmd tables
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Jon Bloomfield
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 1a3aabb5f347d18ad446f2126dba24e02e320ae8
Author: Jon Bloomfield
Date: Thu Sep 20 09:58:36 2018 -0700
drm/i915/cmdparser: Add support for backward jumps
commit f8c08d8faee5567803c8c533865296ca30286bbf upstream.
To keep things manageable, the pre-gen9 cmdparser does not
attempt to track any form of nested BB\_START's. This did not
prevent usermode from using nested starts, or even chained
batches because the cmdparser is not strictly enforced pre gen9.
Instead, the existence of a nested BB\_START would cause the batch
to be emitted in insecure mode, and any privileged capabilities
would not be available.
For Gen9, the cmdparser becomes mandatory (for BCS at least), and
so not providing any form of nested BB\_START support becomes
overly restrictive. Any such batch will simply not run.
We make heavy use of backward jumps in igt, and it is much easier
to add support for this restricted subset of nested jumps, than to
rewrite the whole of our test suite to avoid them.
Add the required logic to support limited backward jumps, to
instructions that have already been validated by the parser.
Note that it's not sufficient to simply approve any BB\_START
that jumps backwards in the buffer because this would allow an
attacker to embed a rogue instruction sequence within the
operand words of a harmless instruction (say LRI) and jump to
that.
We introduce a bit array to track every instr offset successfully
validated, and test the target of BB\_START against this. If the
target offset hits, it is re-written to the same offset in the
shadow buffer and the BB\_START cmd is allowed.
Note: This patch deliberately ignores checkpatch issues in the
cmdtables, in order to match the style of the surrounding code.
We'll correct the entire file in one go in a later patch.
v2: set dispatch secure late (Mika)
v3: rebase (Mika)
v4: Clear whitelist on each parse
Minor review updates (Chris)
v5: Correct backward jump batching
v6: fix compilation error due to struct eb shuffle (Mika)
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Jon Bloomfield
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 77fc9100fc5768ca01ca2dd2cc5a515a4723a58a
Author: Jon Bloomfield
Date: Thu Sep 27 10:23:17 2018 -0700
drm/i915/cmdparser: Use explicit goto for error paths
commit 0546a29cd884fb8184731c79ab008927ca8859d0 upstream.
In the next patch we will be adding a second valid
termination condition which will require a small
amount of refactoring to share logic with the BB\_END
case.
Refactor all error conditions to jump to a dedicated
exit path, with 'break' reserved only for a successful
parse.
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Jon Bloomfield
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 4b75b05cb098b15658a91fae3be29a58a1cfa2a1
Author: Jon Bloomfield
Date: Mon Apr 23 11:12:15 2018 -0700
drm/i915: Add gen9 BCS cmdparsing
commit 0f2f39758341df70202ae1c42d5a1e4ee392b6d3 upstream.
For gen9 we enable cmdparsing on the BCS ring, specifically
to catch inadvertent accesses to sensitive registers
Unlike gen7/hsw, we use the parser only to block certain
registers. We can rely on h/w to block restricted commands,
so the command tables only provide enough info to allow the
parser to delineate each command, and identify commands that
access registers.
Note: This patch deliberately ignores checkpatch issues in
favour of matching the style of the surrounding code. We'll
correct the entire file in one go in a later patch.
v3: rebase (Mika)
v4: Add RING\_TIMESTAMP registers to whitelist (Jon)
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 41e79b82c420f88c709f53dd2f3e61e0c01d511b
Author: Jon Bloomfield
Date: Wed Aug 1 09:45:50 2018 -0700
drm/i915: Allow parsing of unsized batches
commit 435e8fc059dbe0eec823a75c22da2972390ba9e0 upstream.
In "drm/i915: Add support for mandatory cmdparsing" we introduced the
concept of mandatory parsing. This allows the cmdparser to be invoked
even when user passes batch\_len=0 to the execbuf ioctl's.
However, the cmdparser needs to know the extents of the buffer being
scanned. Refactor the code to ensure the cmdparser uses the actual
object size, instead of the incoming length, if user passes 0.
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 78340a6f2ec06a4f851ad82dd2b1787280c389de
Author: Jon Bloomfield
Date: Tue May 22 13:59:06 2018 -0700
drm/i915: Support ro ppgtt mapped cmdparser shadow buffers
commit 4f7af1948abcb18b4772fe1bcd84d7d27d96258c upstream.
For Gen7, the original cmdparser motive was to permit limited
use of register read/write instructions in unprivileged BB's.
This worked by copying the user supplied bb to a kmd owned
bb, and running it in secure mode, from the ggtt, only if
the scanner finds no unsafe commands or registers.
For Gen8+ we can't use this same technique because running bb's
from the ggtt also disables access to ppgtt space. But we also
do not actually require 'secure' execution since we are only
trying to reduce the available command/register set. Instead we
will copy the user buffer to a kmd owned read-only bb in ppgtt,
and run in the usual non-secure mode.
Note that ro pages are only supported by ppgtt (not ggtt), but
luckily that's exactly what we need.
Add the required paths to map the shadow buffer to ppgtt ro for Gen8+
v2: IS\_GEN7/IS\_GEN (Mika)
v3: rebase
v4: rebase
v5: rebase
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 110416def1d659f815103c77ccca70936ec2636c
Author: Jon Bloomfield
Date: Wed Aug 1 09:33:59 2018 -0700
drm/i915: Add support for mandatory cmdparsing
commit 311a50e76a33d1e029563c24b2ff6db0c02b5afe upstream.
The existing cmdparser for gen7 can be bypassed by specifying
batch\_len=0 in the execbuf call. This is safe because bypassing
simply reduces the cmd-set available.
In a later patch we will introduce cmdparsing for gen9, as a
security measure, which must be strictly enforced since without
it we are vulnerable to DoS attacks.
Introduce the concept of 'required' cmd parsing that cannot be
bypassed by submitting zero-length bb's.
v2: rebase (Mika)
v2: rebase (Mika)
v3: fix conflict on engine flags (Mika)
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 7819546459c63b98fe14d43137ef8e4eebeb78f4
Author: Jon Bloomfield
Date: Fri Jun 8 10:05:26 2018 -0700
drm/i915: Remove Master tables from cmdparser
commit 66d8aba1cd6db34af10de465c0d52af679288cb6 upstream.
The previous patch has killed support for secure batches
on gen6+, and hence the cmdparsers master tables are
now dead code. Remove them.
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit b5ccff64277dab16ace19034b5a45666b28babb9
Author: Jon Bloomfield
Date: Fri Jun 8 08:53:46 2018 -0700
drm/i915: Disable Secure Batches for gen6+
commit 44157641d448cbc0c4b73c5231d2b911f0cb0427 upstream.
Retroactively stop reporting support for secure batches
through the api for gen6+ so that older binaries trigger
the fallback path instead.
Older binaries use secure batches pre gen6 to access resources
that are not available to normal usermode processes. However,
all known userspace explicitly checks for HAS\_SECURE\_BATCHES
before relying on the secure batch feature.
Since there are no known binaries relying on this for newer gens
we can kill secure batches from gen6, via I915\_PARAM\_HAS\_SECURE\_BATCHES.
v2: rebase (Mika)
v3: rebase (Mika)
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit 0d185a9932c9e42344106af1ce8287d8f2b6c4ec
Author: Jon Bloomfield
Date: Fri Apr 20 14:26:01 2018 -0700
drm/i915: Rename gen7 cmdparser tables
commit 0a2f661b6c21815a7fa60e30babe975fee8e73c6 upstream.
We're about to introduce some new tables for later gens, and the
current naming for the gen7 tables will no longer make sense.
v2: rebase
Signed-off-by: Jon Bloomfield
Cc: Tony Luck
Cc: Dave Airlie
Cc: Takashi Iwai
Cc: Tyler Hicks
Signed-off-by: Mika Kuoppala
Reviewed-by: Chris Wilson
Signed-off-by: Greg Kroah-Hartman
commit edd4b3e558a3a6baea6c891288b0c0222b59842b
Author: Juliet Kim
Date: Fri Sep 20 16:11:22 2019 -0400
net/ibmvnic: unlock rtnl\_lock in reset so linkwatch\_event can run
[ Upstream commit b27507bb59ed504d7fa4d6a35f25a8cc39903b54 ]
Commit a5681e20b541 ("net/ibmnvic: Fix deadlock problem in reset")
made the change to hold the RTNL lock during a reset to avoid deadlock
but linkwatch\_event is fired during the reset and needs the RTNL lock.
That keeps linkwatch\_event process from proceeding until the reset
is complete. The reset process cannot tolerate the linkwatch\_event
processing after reset completes, so release the RTNL lock during the
process to allow a chance for linkwatch\_event to run during reset.
This does not guarantee that the linkwatch\_event will be processed as
soon as link state changes, but is an improvement over the current code
where linkwatch\_event processing is always delayed, which prevents
transmissions on the device from being deactivated leading transmit
watchdog timer to time-out.
Release the RTNL lock before link state change and re-acquire after
the link state change to allow linkwatch\_event to grab the RTNL lock
and run during the reset.
Fixes: a5681e20b541 ("net/ibmnvic: Fix deadlock problem in reset")
Signed-off-by: Juliet Kim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 922accb4d259d4aa0ba2d9fab7af840fda5b51d1
Author: Thierry Reding
Date: Mon Sep 23 11:12:29 2019 +0200
arm64: errata: Update stale comment
[ Upstream commit 7a292b6c7c9c35afee01ce3b2248f705869d0ff1 ]
Commit 73f381660959 ("arm64: Advertise mitigation of Spectre-v2, or lack
thereof") renamed the caller of the install\_bp\_hardening\_cb() function
but forgot to update a comment, which can be confusing when trying to
follow the code flow.
Fixes: 73f381660959 ("arm64: Advertise mitigation of Spectre-v2, or lack thereof")
Signed-off-by: Thierry Reding
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 6d715f31f5fbefe7f4441e9b812149dcf7e97a2c
Author: Stefano Brivio
Date: Thu Oct 10 19:18:14 2019 +0200
netfilter: ipset: Copy the right MAC address in hash:ip,mac IPv6 sets
[ Upstream commit 97664bc2c77e2b65cdedddcae2643fc93291d958 ]
Same as commit 1b4a75108d5b ("netfilter: ipset: Copy the right MAC
address in bitmap:ip,mac and hash:ip,mac sets"), another copy and paste
went wrong in commit 8cc4ccf58379 ("netfilter: ipset: Allow matching on
destination MAC address for mac and ipmac sets").
When I fixed this for IPv4 in 1b4a75108d5b, I didn't realise that
hash:ip,mac sets also support IPv6 as family, and this is covered by a
separate function, hash\_ipmac6\_kadt().
In hash:ip,mac sets, the first dimension is the IP address, and the
second dimension is the MAC address: check the IPSET\_DIM\_TWO\_SRC flag
in flags while deciding which MAC address to copy, destination or
source.
This way, mixing source and destination matches for the two dimensions
of ip,mac hash type works as expected, also for IPv6. With this setup:
ip netns add A
ip link add veth1 type veth peer name veth2 netns A
ip addr add 2001:db8::1/64 dev veth1
ip -net A addr add 2001:db8::2/64 dev veth2
ip link set veth1 up
ip -net A link set veth2 up
dst=$(ip netns exec A cat /sys/class/net/veth2/address)
ip netns exec A ipset create test\_hash hash:ip,mac family inet6
ip netns exec A ipset add test\_hash 2001:db8::1,${dst}
ip netns exec A ip6tables -A INPUT -p icmpv6 --icmpv6-type 135 -j ACCEPT
ip netns exec A ip6tables -A INPUT -m set ! --match-set test\_hash src,dst -j DROP
ipset now correctly matches a test packet:
# ping -c1 2001:db8::2 >/dev/null
# echo $?
0
Reported-by: Chen, Yi
Fixes: 8cc4ccf58379 ("netfilter: ipset: Allow matching on destination MAC address for mac and ipmac sets")
Signed-off-by: Stefano Brivio
Signed-off-by: Jozsef Kadlecsik
Signed-off-by: Sasha Levin
commit 36ff8a445ab6c674ae45427b0cb3cb99545221cf
Author: Taehee Yoo
Date: Tue Oct 29 09:12:32 2019 +0000
bonding: fix using uninitialized mode\_lock
[ Upstream commit ad9bd8daf2f9938572b0604e1280fefa8f338581 ]
When a bonding interface is being created, it setups its mode and options.
At that moment, it uses mode\_lock so mode\_lock should be initialized
before that moment.
rtnl\_newlink()
rtnl\_create\_link()
alloc\_netdev\_mqs()
->setup() //bond\_setup()
->newlink //bond\_newlink
bond\_changelink()
register\_netdevice()
->ndo\_init() //bond\_init()
After commit 089bca2caed0 ("bonding: use dynamic lockdep key instead of
subclass"), mode\_lock is initialized in bond\_init().
So in the bond\_changelink(), un-initialized mode\_lock can be used.
mode\_lock should be initialized in bond\_setup().
This patch partially reverts commit 089bca2caed0 ("bonding: use dynamic
lockdep key instead of subclass")
Test command:
ip link add bond0 type bond mode 802.3ad lacp\_rate 0
Splat looks like:
[ 60.615127] INFO: trying to register non-static key.
[ 60.615900] the code is fine but needs lockdep annotation.
[ 60.616697] turning off the locking correctness validator.
[ 60.617490] CPU: 1 PID: 957 Comm: ip Not tainted 5.4.0-rc3+ #109
[ 60.618350] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
[ 60.619481] Call Trace:
[ 60.619918] dump\_stack+0x7c/0xbb
[ 60.620453] register\_lock\_class+0x1215/0x14d0
[ 60.621131] ? alloc\_netdev\_mqs+0x7b3/0xcc0
[ 60.621771] ? is\_bpf\_text\_address+0x86/0xf0
[ 60.622416] ? is\_dynamic\_key+0x230/0x230
[ 60.623032] ? unwind\_get\_return\_address+0x5f/0xa0
[ 60.623757] ? create\_prof\_cpu\_mask+0x20/0x20
[ 60.624408] ? arch\_stack\_walk+0x83/0xb0
[ 60.625023] \_\_lock\_acquire+0xd8/0x3de0
[ 60.625616] ? stack\_trace\_save+0x82/0xb0
[ 60.626225] ? stack\_trace\_consume\_entry+0x160/0x160
[ 60.626957] ? deactivate\_slab.isra.80+0x2c5/0x800
[ 60.627668] ? register\_lock\_class+0x14d0/0x14d0
[ 60.628380] ? alloc\_netdev\_mqs+0x7b3/0xcc0
[ 60.629020] ? save\_stack+0x69/0x80
[ 60.629574] ? save\_stack+0x19/0x80
[ 60.630121] ? \_\_kasan\_kmalloc.constprop.4+0xa0/0xd0
[ 60.630859] ? \_\_kmalloc\_node+0x16f/0x480
[ 60.631472] ? alloc\_netdev\_mqs+0x7b3/0xcc0
[ 60.632121] ? rtnl\_create\_link+0x2ed/0xad0
[ 60.634388] ? \_\_rtnl\_newlink+0xad4/0x11b0
[ 60.635024] lock\_acquire+0x164/0x3b0
[ 60.635608] ? bond\_3ad\_update\_lacp\_rate+0x91/0x200 [bonding]
[ 60.636463] \_raw\_spin\_lock\_bh+0x38/0x70
[ 60.637084] ? bond\_3ad\_update\_lacp\_rate+0x91/0x200 [bonding]
[ 60.637930] bond\_3ad\_update\_lacp\_rate+0x91/0x200 [bonding]
[ 60.638753] ? bond\_3ad\_lacpdu\_recv+0xb30/0xb30 [bonding]
[ 60.639552] ? bond\_opt\_get\_val+0x180/0x180 [bonding]
[ 60.640307] ? \_\_\_slab\_alloc+0x5aa/0x610
[ 60.640925] bond\_option\_lacp\_rate\_set+0x71/0x140 [bonding]
[ 60.641751] \_\_bond\_opt\_set+0x1ff/0xbb0 [bonding]
[ 60.643217] ? kasan\_unpoison\_shadow+0x30/0x40
[ 60.643924] bond\_changelink+0x9a4/0x1700 [bonding]
[ 60.644653] ? memset+0x1f/0x40
[ 60.742941] ? bond\_slave\_changelink+0x1a0/0x1a0 [bonding]
[ 60.752694] ? alloc\_netdev\_mqs+0x8ea/0xcc0
[ 60.753330] ? rtnl\_create\_link+0x2ed/0xad0
[ 60.753964] bond\_newlink+0x1e/0x60 [bonding]
[ 60.754612] \_\_rtnl\_newlink+0xb9f/0x11b0
[ ... ]
Reported-by: syzbot+8da67f407bcba2c72e6e@syzkaller.appspotmail.com
Reported-by: syzbot+0d083911ab18b710da71@syzkaller.appspotmail.com
Fixes: 089bca2caed0 ("bonding: use dynamic lockdep key instead of subclass")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8603233ea82ba893bf48f39095e4f8119327bc26
Author: Suwan Kim
Date: Tue Oct 22 18:30:17 2019 +0900
usbip: Fix free of unallocated memory in vhci tx
[ Upstream commit d4d8257754c3300ea2a465dadf8d2b02c713c920 ]
iso\_buffer should be set to NULL after use and free in the while loop.
In the case of isochronous URB in the while loop, iso\_buffer is
allocated and after sending it to server, buffer is deallocated. And
then, if the next URB in the while loop is not a isochronous pipe,
iso\_buffer still holds the previously deallocated buffer address and
kfree tries to free wrong buffer address.
Fixes: ea44d190764b ("usbip: Implement SG support to vhci-hcd and stub driver")
Reported-by: kbuild test robot
Reported-by: Julia Lawall
Signed-off-by: Suwan Kim
Reviewed-by: Julia Lawall
Acked-by: Shuah Khan
Link: https://lore.kernel.org/r/20191022093017.8027-1-suwan.kim027@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit f5c0fa62ddab7696cd3f42b637e450f4b8caf4e8
Author: Keyon Jie
Date: Fri Oct 25 17:15:38 2019 -0500
ASoC: SOF: Intel: hda-stream: fix the CONFIG\_ prefix missing
[ Upstream commit f792bd173a6fd51d1a4dde04263085ce67486aa3 ]
We are missing the 'CONFIG\_' prefix when using the kernel configure item
SND\_SOC\_SOF\_HDA\_ALWAYS\_ENABLE\_DMI\_L1, here correct them.
Fixes: 43b2ab9009b13b ('ASoC: SOF: Intel: hda: Disable DMI L1 entry during capture')
Signed-off-by: Keyon Jie
Signed-off-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20191025221538.6668-1-pierre-louis.bossart@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit e74a78cf2f699385ca043f781f50ec0e8e69fed5
Author: Amelie Delaunay
Date: Mon Nov 4 11:55:29 2019 +0100
ARM: dts: stm32: change joystick pinctrl definition on stm32mp157c-ev1
[ Upstream commit f4d6e0f79bcde7810890563bac8e0f3479fe6d03 ]
Pins used for joystick are all configured as input. "push-pull" is not a
valid setting for an input pin.
Fixes: a502b343ebd0 ("pinctrl: stmfx: update pinconf settings")
Signed-off-by: Alexandre Torgue
Signed-off-by: Amelie Delaunay
Signed-off-by: Alexandre Torgue
Signed-off-by: Sasha Levin
commit 4e967af04ec0e2894b91d8e3e0bddd2f17937005
Author: Tejun Heo
Date: Fri Nov 8 12:18:29 2019 -0800
cgroup,writeback: don't switch wbs immediately on dead wbs if the memcg is dead
commit 65de03e251382306a4575b1779c57c87889eee49 upstream.
cgroup writeback tries to refresh the associated wb immediately if the
current wb is dead. This is to avoid keeping issuing IOs on the stale
wb after memcg - blkcg association has changed (ie. when blkcg got
disabled / enabled higher up in the hierarchy).
Unfortunately, the logic gets triggered spuriously on inodes which are
associated with dead cgroups. When the logic is triggered on dead
cgroups, the attempt fails only after doing quite a bit of work
allocating and initializing a new wb.
While c3aab9a0bd91 ("mm/filemap.c: don't initiate writeback if mapping
has no dirty pages") alleviated the issue significantly as it now only
triggers when the inode has dirty pages. However, the condition can
still be triggered before the inode is switched to a different cgroup
and the logic simply doesn't make sense.
Skip the immediate switching if the associated memcg is dying.
This is a simplified version of the following two patches:
\* https://lore.kernel.org/linux-mm/20190513183053.GA73423@dennisz-mbp/
\* http://lkml.kernel.org/r/156355839560.2063.5265687291430814589.stgit@buzz
Cc: Konstantin Khlebnikov
Fixes: e8a7abf5a5bd ("writeback: disassociate inodes from dying bdi\_writebacks")
Acked-by: Dennis Zhou
Signed-off-by: Tejun Heo
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit f4bdb2697ccc9cecf1a9de86905c309ad901da4c
Author: Konstantin Khlebnikov
Date: Mon Sep 23 15:34:45 2019 -0700
mm/filemap.c: don't initiate writeback if mapping has no dirty pages
commit c3aab9a0bd91b696a852169479b7db1ece6cbf8c upstream.
Functions like filemap\_write\_and\_wait\_range() should do nothing if inode
has no dirty pages or pages currently under writeback. But they anyway
construct struct writeback\_control and this does some atomic operations if
CONFIG\_CGROUP\_WRITEBACK=y - on fast path it locks inode->i\_lock and
updates state of writeback ownership, on slow path might be more work.
Current this path is safely avoided only when inode mapping has no pages.
For example generic\_file\_read\_iter() calls filemap\_write\_and\_wait\_range()
at each O\_DIRECT read - pretty hot path.
This patch skips starting new writeback if mapping has no dirty tags set.
If writeback is already in progress filemap\_write\_and\_wait\_range() will
wait for it.
Link: http://lkml.kernel.org/r/156378816804.1087.8607636317907921438.stgit@buzz
Signed-off-by: Konstantin Khlebnikov
Reviewed-by: Jan Kara
Cc: Tejun Heo
Cc: Jens Axboe
Cc: Johannes Weiner
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ab3664eabfa765e8fabcc106e23f7382ded518cb
Author: Huacai Chen
Date: Thu Oct 24 11:28:29 2019 +0800
timekeeping/vsyscall: Update VDSO data unconditionally
[ Upstream commit 52338415cf4d4064ae6b8dd972dadbda841da4fa ]
The update of the VDSO data is depending on \_\_arch\_use\_vsyscall() returning
True. This is a leftover from the attempt to map the features of various
architectures 1:1 into generic code.
The usage of \_\_arch\_use\_vsyscall() in the actual vsyscall implementations
got dropped and replaced by the requirement for the architecture code to
return U64\_MAX if the global clocksource is not usable in the VDSO.
But the \_\_arch\_use\_vsyscall() check in the update code stayed which causes
the VDSO data to be stale or invalid when an architecture actually
implements that function and returns False when the current clocksource is
not usable in the VDSO.
As a consequence the VDSO implementations of clock\_getres(), time(),
clock\_gettime(CLOCK\_.\*\_COARSE) operate on invalid data and return bogus
information.
Remove the \_\_arch\_use\_vsyscall() check from the VDSO update function and
update the VDSO data unconditionally.
[ tglx: Massaged changelog and removed the now useless implementations in
asm-generic/ARM64/MIPS ]
Fixes: 44f57d788e7deecb50 ("timekeeping: Provide a generic update\_vsyscall() implementation")
Signed-off-by: Huacai Chen
Signed-off-by: Thomas Gleixner
Cc: Andy Lutomirski
Cc: Vincenzo Frascino
Cc: Arnd Bergmann
Cc: Paul Burton
Cc: linux-mips@vger.kernel.org
Cc: linux-arm-kernel@lists.infradead.org
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/1571887709-11447-1-git-send-email-chenhc@lemote.com
Signed-off-by: Sasha Levin
commit 58578eabf8f9fb0530d5eb2da0dc14477918ebdf
Author: Leonard Crestez
Date: Tue Oct 22 22:21:28 2019 +0300
clk: imx8m: Use SYS\_PLL1\_800M as intermediate parent of CLK\_ARM
[ Upstream commit b234fe9558615098d8d62516e7041ad7f99ebcea ]
During cpu frequency switching the main "CLK\_ARM" is reparented to an
intermediate "step" clock. On imx8mm and imx8mn the 24M oscillator is
used for this purpose but it is extremely slow, increasing wakeup
latencies to the point that i2c transactions can timeout and system
becomes unresponsive.
Fix by switching the "step" clk to SYS\_PLL1\_800M, matching the behavior
of imx8m cpufreq drivers in imx vendor tree.
This bug was not immediately apparent because upstream arm64 defconfig
uses the "performance" governor by default so no cpufreq transitions
happen.
Fixes: ba5625c3e272 ("clk: imx: Add clock driver support for imx8mm")
Fixes: 96d6392b54db ("clk: imx: Add support for i.MX8MN clock driver")
Cc: stable@vger.kernel.org
Signed-off-by: Leonard Crestez
Link: https://lkml.kernel.org/r/f5d2b9c53f1ed5ccb1dd3c6624f56759d92e1689.1571771777.git.leonard.crestez@nxp.com
Acked-by: Shawn Guo
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 99cfd79a9ca8eee83db54f74225ab2f8f3d2dc05
Author: Hans de Goede
Date: Fri Oct 18 11:08:42 2019 +0200
pinctrl: cherryview: Fix irq\_valid\_mask calculation
[ Upstream commit 63bdef6cd6941917c823b9cc9aa0219d19fcb716 ]
Commit 03c4749dd6c7 ("gpio / ACPI: Drop unnecessary ACPI GPIO to Linux
GPIO translation") has made the cherryview gpio numbers sparse, to get
a 1:1 mapping between ACPI pin numbers and gpio numbers in Linux.
This has greatly simplified things, but the code setting the
irq\_valid\_mask was not updated for this, so the valid mask is still in
the old "compressed" numbering with the gaps in the pin numbers skipped,
which is wrong as irq\_valid\_mask needs to be expressed in gpio numbers.
This results in the following error on devices using pin 24 (0x0018) on
the north GPIO controller as an ACPI event source:
[ 0.422452] cherryview-pinctrl INT33FF:01: Failed to translate GPIO to IRQ
This has been reported (by email) to be happening on a Caterpillar CAT T20
tablet and I've reproduced this myself on a Medion Akoya e2215t 2-in-1.
This commit uses the pin number instead of the compressed index into
community->pins to clear the correct bits in irq\_valid\_mask for GPIOs
using GPEs for interrupts, fixing these errors and in case of the
Medion Akoya e2215t also fixing the LID switch not working.
Cc: stable@vger.kernel.org
Fixes: 03c4749dd6c7 ("gpio / ACPI: Drop unnecessary ACPI GPIO to Linux GPIO translation")
Signed-off-by: Hans de Goede
Reviewed-by: Andy Shevchenko
Signed-off-by: Mika Westerberg
Signed-off-by: Sasha Levin
commit 8e02baf62a63109d2cc6bac5333e56a74572350d
Author: Shuning Zhang
Date: Tue Nov 5 21:16:34 2019 -0800
ocfs2: protect extent tree in ocfs2\_prepare\_inode\_for\_write()
[ Upstream commit e74540b285569d2b1e14fe7aee92297078f235ce ]
When the extent tree is modified, it should be protected by inode
cluster lock and ip\_alloc\_sem.
The extent tree is accessed and modified in the
ocfs2\_prepare\_inode\_for\_write, but isn't protected by ip\_alloc\_sem.
The following is a case. The function ocfs2\_fiemap is accessing the
extent tree, which is modified at the same time.
kernel BUG at fs/ocfs2/extent\_map.c:475!
invalid opcode: 0000 [#1] SMP
Modules linked in: tun ocfs2 ocfs2\_nodemanager configfs ocfs2\_stackglue [...]
CPU: 16 PID: 14047 Comm: o2info Not tainted 4.1.12-124.23.1.el6uek.x86\_64 #2
Hardware name: Oracle Corporation ORACLE SERVER X7-2L/ASM, MB MECH, X7-2L, BIOS 42040600 10/19/2018
task: ffff88019487e200 ti: ffff88003daa4000 task.ti: ffff88003daa4000
RIP: ocfs2\_get\_clusters\_nocache.isra.11+0x390/0x550 [ocfs2]
Call Trace:
ocfs2\_fiemap+0x1e3/0x430 [ocfs2]
do\_vfs\_ioctl+0x155/0x510
SyS\_ioctl+0x81/0xa0
system\_call\_fastpath+0x18/0xd8
Code: 18 48 c7 c6 60 7f 65 a0 31 c0 bb e2 ff ff ff 48 8b 4a 40 48 8b 7a 28 48 c7 c2 78 2d 66 a0 e8 38 4f 05 00 e9 28 fe ff ff 0f 1f 00 <0f> 0b 66 0f 1f 44 00 00 bb 86 ff ff ff e9 13 fe ff ff 66 0f 1f
RIP ocfs2\_get\_clusters\_nocache.isra.11+0x390/0x550 [ocfs2]
---[ end trace c8aa0c8180e869dc ]---
Kernel panic - not syncing: Fatal exception
Kernel Offset: disabled
This issue can be reproduced every week in a production environment.
This issue is related to the usage mode. If others use ocfs2 in this
mode, the kernel will panic frequently.
[akpm@linux-foundation.org: coding style fixes]
[Fix new warning due to unused function by removing said function - Linus ]
Link: http://lkml.kernel.org/r/1568772175-2906-2-git-send-email-sunny.s.zhang@oracle.com
Signed-off-by: Shuning Zhang
Reviewed-by: Junxiao Bi
Reviewed-by: Gang He
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Joseph Qi
Cc: Changwei Ge
Cc: Jun Piao
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 4cfb09554b03fc18d12de2f6082e3fa857f21542
Author: Yangchun Fu
Date: Fri Nov 1 10:09:56 2019 -0700
gve: Fixes DMA synchronization.
[ Upstream commit 9cfeeb576d49a7b5e643b8066ba64a55e8417c5d ]
Synces the DMA buffer properly in order for CPU and device to see
the most up-to-data data.
Signed-off-by: Yangchun Fu
Reviewed-by: Catherine Sullivan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit e6b52728673436b9728aa004a3efe34b06a86e7d
Author: Wenwen Wang
Date: Mon Aug 12 00:59:21 2019 -0500
e1000: fix memory leaks
[ Upstream commit 8472ba62154058b64ebb83d5f57259a352d28697 ]
In e1000\_set\_ringparam(), 'tx\_old' and 'rx\_old' are not deallocated if
e1000\_up() fails, leading to memory leaks. Refactor the code to fix this
issue.
Signed-off-by: Wenwen Wang
Tested-by: Aaron Brown
Signed-off-by: Jeff Kirsher
Signed-off-by: Sasha Levin
commit cce557f667a3b0513facaf6d510a74978cf0121d
Author: Manfred Rudigier
Date: Thu Aug 15 13:55:20 2019 -0700
igb: Fix constant media auto sense switching when no cable is connected
[ Upstream commit 8d5cfd7f76a2414e23c74bb8858af7540365d985 ]
At least on the i350 there is an annoying behavior that is maybe also
present on 82580 devices, but was probably not noticed yet as MAS is not
widely used.
If no cable is connected on both fiber/copper ports the media auto sense
code will constantly swap between them as part of the watchdog task and
produce many unnecessary kernel log messages.
The swap code responsible for this behavior (switching to fiber) should
not be executed if the current media type is copper and there is no signal
detected on the fiber port. In this case we can safely wait until the
AUTOSENSE\_EN bit is cleared.
Signed-off-by: Manfred Rudigier
Tested-by: Aaron Brown
Signed-off-by: Jeff Kirsher
Signed-off-by: Sasha Levin
commit fd4babace756ef6bfa8b3ba1b0398bc1a4e1333f
Author: Chuhong Yuan
Date: Fri Nov 1 20:17:25 2019 +0800
net: ethernet: arc: add the missed clk\_disable\_unprepare
[ Upstream commit 4202e219edd6cc164c042e16fa327525410705ae ]
The remove misses to disable and unprepare priv->macclk like what is done
when probe fails.
Add the missed call in remove.
Signed-off-by: Chuhong Yuan
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5beaffd786a5cb964a52309b4377aed5a496b7b4
Author: Trond Myklebust
Date: Thu Oct 31 18:40:32 2019 -0400
NFSv4: Don't allow a cached open with a revoked delegation
[ Upstream commit be3df3dd4c70ee020587a943a31b98a0fb4b6424 ]
If the delegation is marked as being revoked, we must not use it
for cached opens.
Fixes: 869f9dfa4d6d ("NFSv4: Fix races between nfs\_remove\_bad\_delegation() and delegation return")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 5dea19d1663ab8af2671f235653670248312c4cb
Author: Florian Fainelli
Date: Thu Oct 31 14:47:25 2019 -0700
arm64: apply ARM64\_ERRATUM\_843419 workaround for Brahma-B53 core
[ Upstream commit 1cf45b8fdbb87040e1d1bd793891089f4678aa41 ]
The Broadcom Brahma-B53 core is susceptible to the issue described by
ARM64\_ERRATUM\_843419 so this commit enables the workaround to be applied
when executing on that core.
Since there are now multiple entries to match, we must convert the
existing ARM64\_ERRATUM\_843419 into an erratum list and use
cpucap\_multi\_entry\_cap\_matches to match our entries.
Signed-off-by: Florian Fainelli
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 70d0628ba2f6efd41bd641ef8735a0be157c123b
Author: Florian Fainelli
Date: Thu Oct 31 14:47:24 2019 -0700
arm64: Brahma-B53 is SSB and spectre v2 safe
[ Upstream commit e059770cb1cdfbcbe3f1748f76005861cc79dd1a ]
Add the Brahma-B53 CPU (all versions) to the whitelists of CPUs for the
SSB and spectre v2 mitigations.
Signed-off-by: Florian Fainelli
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 11b0106d93e1846fc65270e41309f22e3c81e69e
Author: Doug Berger
Date: Thu Oct 31 14:47:23 2019 -0700
arm64: apply ARM64\_ERRATUM\_845719 workaround for Brahma-B53 core
[ Upstream commit bfc97f9f199cb041cf897af3af096540948cc705 ]
The Broadcom Brahma-B53 core is susceptible to the issue described by
ARM64\_ERRATUM\_845719 so this commit enables the workaround to be applied
when executing on that core.
Since there are now multiple entries to match, we must convert the
existing ARM64\_ERRATUM\_845719 into an erratum list.
Signed-off-by: Doug Berger
Signed-off-by: Florian Fainelli
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 4dfac7277898c9bfb48337a0dd7d90f7e53cbcbb
Author: Felipe Balbi
Date: Thu Oct 31 11:07:13 2019 +0200
usb: dwc3: gadget: fix race when disabling ep with cancelled xfers
[ Upstream commit d8eca64eec7103ab1fbabc0a187dbf6acfb2af93 ]
When disabling an endpoint which has cancelled requests, we should
make sure to giveback requests that are currently pending in the
cancelled list, otherwise we may fall into a situation where command
completion interrupt fires after endpoint has been disabled, therefore
causing a splat.
Fixes: fec9095bdef4 "usb: dwc3: gadget: remove wait\_end\_transfer"
Reported-by: Roger Quadros
Signed-off-by: Felipe Balbi
Link: https://lore.kernel.org/r/20191031090713.1452818-1-felipe.balbi@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 2eb29fde247a1b5c773faceda0e31488da03505f
Author: Bjorn Andersson
Date: Tue Oct 29 16:27:38 2019 -0700
arm64: cpufeature: Enable Qualcomm Falkor errata 1009 for Kryo
[ Upstream commit 36c602dcdd872e9f9b91aae5266b6d7d72b69b96 ]
The Kryo cores share errata 1009 with Falkor, so add their model
definitions and enable it for them as well.
Signed-off-by: Bjorn Andersson
[will: Update entry in silicon-errata.rst]
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 84c64c69b02c95dedb2154c3f98f1c67398a7fa0
Author: Kairui Song
Date: Tue Oct 29 18:37:54 2019 +0100
x86, efi: Never relocate kernel below lowest acceptable address
[ Upstream commit 220dd7699c46d5940115bd797b01b2ab047c87b8 ]
Currently, kernel fails to boot on some HyperV VMs when using EFI.
And it's a potential issue on all x86 platforms.
It's caused by broken kernel relocation on EFI systems, when below three
conditions are met:
1. Kernel image is not loaded to the default address (LOAD\_PHYSICAL\_ADDR)
by the loader.
2. There isn't enough room to contain the kernel, starting from the
default load address (eg. something else occupied part the region).
3. In the memmap provided by EFI firmware, there is a memory region
starts below LOAD\_PHYSICAL\_ADDR, and suitable for containing the
kernel.
EFI stub will perform a kernel relocation when condition 1 is met. But
due to condition 2, EFI stub can't relocate kernel to the preferred
address, so it fallback to ask EFI firmware to alloc lowest usable memory
region, got the low region mentioned in condition 3, and relocated
kernel there.
It's incorrect to relocate the kernel below LOAD\_PHYSICAL\_ADDR. This
is the lowest acceptable kernel relocation address.
The first thing goes wrong is in arch/x86/boot/compressed/head\_64.S.
Kernel decompression will force use LOAD\_PHYSICAL\_ADDR as the output
address if kernel is located below it. Then the relocation before
decompression, which move kernel to the end of the decompression buffer,
will overwrite other memory region, as there is no enough memory there.
To fix it, just don't let EFI stub relocate the kernel to any address
lower than lowest acceptable address.
[ ardb: introduce efi\_low\_alloc\_above() to reduce the scope of the change ]
Signed-off-by: Kairui Song
Signed-off-by: Ard Biesheuvel
Acked-by: Jarkko Sakkinen
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-efi@vger.kernel.org
Link: https://lkml.kernel.org/r/20191029173755.27149-6-ardb@kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit e20db7964d3e95e91cb147b4f02f38fd1bb35e10
Author: Ard Biesheuvel
Date: Tue Oct 29 18:37:53 2019 +0100
efi: libstub/arm: Account for firmware reserved memory at the base of RAM
[ Upstream commit 41cd96fa149b29684ebd38759fefb07f9c7d5276 ]
The EFI stubloader for ARM starts out by allocating a 32 MB window
at the base of RAM, in order to ensure that the decompressor (which
blindly copies the uncompressed kernel into that window) does not
overwrite other allocations that are made while running in the context
of the EFI firmware.
In some cases, (e.g., U-Boot running on the Raspberry Pi 2), this is
causing boot failures because this initial allocation conflicts with
a page of reserved memory at the base of RAM that contains the SMP spin
tables and other pieces of firmware data and which was put there by
the bootloader under the assumption that the TEXT\_OFFSET window right
below the kernel is only used partially during early boot, and will be
left alone once the memory reservations are processed and taken into
account.
So let's permit reserved memory regions to exist in the region starting
at the base of RAM, and ending at TEXT\_OFFSET - 5 \* PAGE\_SIZE, which is
the window below the kernel that is not touched by the early boot code.
Tested-by: Guillaume Gardet
Signed-off-by: Ard Biesheuvel
Acked-by: Chester Lin
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-efi@vger.kernel.org
Link: https://lkml.kernel.org/r/20191029173755.27149-5-ardb@kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 95c085ef6057f86f11ccf40aed294e3c47992e1b
Author: Jerry Snitselaar
Date: Tue Oct 29 18:37:51 2019 +0100
efi/tpm: Return -EINVAL when determining tpm final events log size fails
[ Upstream commit 2bb6a81633cb47dcba4c9f75605cbe49e6b73d60 ]
Currently nothing checks the return value of efi\_tpm\_eventlog\_init(),
but in case that changes in the future make sure an error is
returned when it fails to determine the tpm final events log
size.
Suggested-by: Dan Carpenter
Signed-off-by: Jerry Snitselaar
Signed-off-by: Ard Biesheuvel
Reviewed-by: Jarkko Sakkinen
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: linux-efi@vger.kernel.org
Fixes: e658c82be556 ("efi/tpm: Only set 'efi\_tpm\_final\_log\_size' after ...")
Link: https://lkml.kernel.org/r/20191029173755.27149-3-ardb@kernel.org
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit cf0ccb042e9ea3e6a156b753292b4d3e80bfeef9
Author: Haiyang Zhang
Date: Wed Oct 30 15:32:13 2019 +0000
hv\_netvsc: Fix error handling in netvsc\_attach()
[ Upstream commit 719b85c336ed35565d0f3982269d6f684087bb00 ]
If rndis\_filter\_open() fails, we need to remove the rndis device created
in earlier steps, before returning an error code. Otherwise, the retry of
netvsc\_attach() from its callers will fail and hang.
Fixes: 7b2ee50c0cd5 ("hv\_netvsc: common detach logic")
Signed-off-by: Haiyang Zhang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7fc9c5338bf43ba2cd80e4d704f6923bbad60a83
Author: Trond Myklebust
Date: Thu Oct 17 09:02:21 2019 -0400
SUNRPC: Destroy the back channel when we destroy the host transport
[ Upstream commit 669996add4c92476e0f8d6b4cd2bb308d1939fd7 ]
When we're destroying the host transport mechanism, we should ensure
that we do not leak memory by failing to release any back channel
slots that might still exist.
Reported-by: Neil Brown
Reported-by: kbuild test robot
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit cca654e699b1a94e39a6783309683721f7be2dea
Author: Trond Myklebust
Date: Thu Oct 17 09:02:20 2019 -0400
SUNRPC: The RDMA back channel mustn't disappear while requests are outstanding
[ Upstream commit 9edb455e6797bb50aa38ef71e62668966065ede8 ]
If there are RDMA back channel requests being processed by the
server threads, then we should hold a reference to the transport
to ensure it doesn't get freed from underneath us.
Reported-by: Neil Brown
Fixes: 63cae47005af ("xprtrdma: Handle incoming backward direction RPC calls")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit 7079affac73b588229dd2be4e45e862a18ad000f
Author: Trond Myklebust
Date: Thu Oct 17 09:02:19 2019 -0400
SUNRPC: The TCP back channel mustn't disappear while requests are outstanding
[ Upstream commit 875f0706accd6501c3209bb99df8573171fb5d75 ]
If there are TCP back channel requests being processed by the
server threads, then we should hold a reference to the transport
to ensure it doesn't get freed from underneath us.
Reported-by: Neil Brown
Fixes: 2ea24497a1b3 ("SUNRPC: RPC callbacks may be split across several..")
Signed-off-by: Trond Myklebust
Signed-off-by: Anna Schumaker
Signed-off-by: Sasha Levin
commit acac5c944e516e1a271b9728acf3fccb7eb0d3ec
Author: zhongshiqi
Date: Wed Oct 23 16:32:23 2019 +0800
dc.c:use kzalloc without test
[ Upstream commit 364593f3ee5fdefc6efd89475e1804c928b4e6ba ]
dc.c:583:null check is needed after using kzalloc function
Reviewed-by: Harry Wentland
Signed-off-by: zhongshiqi
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit bc027c6960a12a392ffde7124ccb27183d681651
Author: Michael Strauss
Date: Thu Oct 3 11:54:15 2019 -0400
drm/amd/display: Passive DP->HDMI dongle detection fix
[ Upstream commit bc2fde42e2418808dbfc04de1a6da91d7d31cf1a ]
[WHY]
i2c\_read is called to differentiate passive DP->HDMI and DP->DVI-D dongles
The call is expected to fail in DVI-D case but pass in HDMI case
Some HDMI dongles have a chance to fail as well, causing misdetection as DVI-D
[HOW]
Retry i2c\_read to ensure failed result is valid
Signed-off-by: Michael Strauss
Reviewed-by: Tony Cheng
Acked-by: Leo Li
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 3119fd1d045b7777e652b78d3ae96d01f1b4d9c2
Author: Jun Lei
Date: Thu Sep 19 17:43:45 2019 -0400
drm/amd/display: add 50us buffer as WA for pstate switch in active
[ Upstream commit 7c37d399c2b84d4b79de4d512a38373f1d71ab90 ]
Signed-off-by: Jun Lei
Reviewed-by: Aric Cyr
Acked-by: Leo Li
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit b71b3f975f438b96ef4a03f0f3db1223d4d80d25
Author: Jun Lei
Date: Thu Oct 3 15:09:53 2019 -0400
drm/amd/display: do not synchronize "drr" displays
[ Upstream commit 8775e89fa7121535d2da738c95167b8c65aa6e90 ]
[why]
A display that supports DRR can never really be considered
"synchronized" with any other display because we can dynamically
enable DRR (i.e. without modeset). this will cause their
relative CRTC positions to drift and lose sync. this will disrupt
features such as MCLK switching that assume and depend on
their permanent alignment (that can only change with modeset)
[how]
check for ignore\_msa in stream when considered synchronizability
this ignore\_msa is basically actually implemented as "supports drr"
Signed-off-by: Jun Lei
Reviewed-by: Yongqiang Sun
Acked-by: Anthony Koo
Acked-by: Leo Li
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit b46eeb109b26defa78c292cfeaddc37c4d24e889
Author: Andrey Grodzovsky
Date: Thu Oct 24 15:44:10 2019 -0400
drm/amdgpu: If amdgpu\_ib\_schedule fails return back the error.
[ Upstream commit 57c0f58e9f562089de5f0b60da103677d232374c ]
Use ERR\_PTR to return back the error happened during amdgpu\_ib\_schedule.
Signed-off-by: Andrey Grodzovsky
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit e8dc41bdb82911e657277cb8f7c1ea933b9fef70
Author: Andrey Grodzovsky
Date: Thu Oct 24 15:39:06 2019 -0400
drm/sched: Set error to s\_fence if HW job submission failed.
[ Upstream commit 167bf96014a095753053595f3224fcdeb49ac3c8 ]
Problem:
When run\_job fails and HW fence returned is NULL we still signal
the s\_fence to avoid hangs but the user has no way of knowing if
the actual HW job was ran and finished.
Fix:
Allow .run\_job implementations to return ERR\_PTR in the fence pointer
returned and then set this error for s\_fence->finished fence so whoever
wait on this fence can inspect the signaled fence for an error.
Signed-off-by: Andrey Grodzovsky
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 2b4be0c276c16b9a8036dd7b87ba7a7b188b7400
Author: Pierre-Eric Pelloux-Prayer
Date: Tue Oct 22 19:22:11 2019 +0200
drm/amdgpu/sdma5: do not execute 0-sized IBs (v2)
[ Upstream commit 9bdf63d3579e36942f4b91d3558a90da8116bb40 ]
This seems to help with https://bugs.freedesktop.org/show\_bug.cgi?id=111481.
v2: insert a NOP instead of skipping all 0-sized IBs to avoid breaking older hw
Signed-off-by: Pierre-Eric Pelloux-Prayer
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit bb3d9654cec1e0a05f9ded57fcf48e17bd32abde
Author: Lorenzo Bianconi
Date: Sun Oct 27 20:53:09 2019 +0100
mt76: dma: fix buffer unmap with non-linear skbs
[ Upstream commit 7bd0650be63cbb9e45e394d689c81365fe48e495 ]
mt76 dma layer is supposed to unmap skb data buffers while keep txwi
mapped on hw dma ring. At the moment mt76 wrongly unmap txwi or does
not unmap data fragments in even positions for non-linear skbs. This
issue may result in hw hangs with A-MSDU if the system relies on IOMMU
or SWIOTLB. Fix this behaviour properly unmapping data fragments on
non-linear skbs.
Fixes: 17f1de56df05 ("mt76: add common code shared between multiple chipsets")
Signed-off-by: Lorenzo Bianconi
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
commit c919e17850302e5d927865a973a780015106541e
Author: Takashi Iwai
Date: Mon Oct 21 17:17:21 2019 +0200
iommu/amd: Apply the same IVRS IOAPIC workaround to Acer Aspire A315-41
[ Upstream commit ad3e8da2d422c63c13819a53d3c5ea9312cc0b9d ]
Acer Aspire A315-41 requires the very same workaround as the existing
quirk for Dell Latitude 5495. Add the new entry for that.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1137799
Signed-off-by: Takashi Iwai
Signed-off-by: Joerg Roedel
Signed-off-by: Sasha Levin
commit 3be8cfe95d59538228a7379868b831f523d147ea
Author: Vladimir Oltean
Date: Sat Oct 26 21:04:27 2019 +0300
net: mscc: ocelot: refuse to overwrite the port's native vlan
[ Upstream commit b9cd75e6689560140dadaed98eb4b41aad75d55d ]
The switch driver keeps a "vid" variable per port, which signifies \_the\_
VLAN ID that is stripped on that port's egress (aka the native VLAN on a
trunk port).
That is the way the hardware is designed (mostly). The port->vid is
programmed into REW:PORT:PORT\_VLAN\_CFG:PORT\_VID and the rewriter is told
to send all traffic as tagged except the one having port->vid.
There exists a possibility of finer-grained egress untagging decisions:
using the VCAP IS1 engine, one rule can be added to match every
VLAN-tagged frame whose VLAN should be untagged, and set POP\_CNT=1 as
action. However, the IS1 can hold at most 512 entries, and the VLANs are
in the order of 6 \* 4096.
So the code is fine for now. But this sequence of commands:
$ bridge vlan add dev swp0 vid 1 pvid untagged
$ bridge vlan add dev swp0 vid 2 untagged
makes untagged and pvid-tagged traffic be sent out of swp0 as tagged
with VID 1, despite user's request.
Prevent that from happening. The user should temporarily remove the
existing untagged VLAN (1 in this case), add it back as tagged, and then
add the new untagged VLAN (2 in this case).
Cc: Antoine Tenart
Cc: Alexandre Belloni
Fixes: 7142529f1688 ("net: mscc: ocelot: add VLAN filtering")
Signed-off-by: Vladimir Oltean
Reviewed-by: Florian Fainelli
Acked-by: Alexandre Belloni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d29fe4a5e5d70c77c40b159ad94292f75b31cdc0
Author: Vladimir Oltean
Date: Sat Oct 26 21:04:26 2019 +0300
net: mscc: ocelot: fix vlan\_filtering when enslaving to bridge before link is up
[ Upstream commit 1c44ce560b4de639f237b458be1729489ff44d0a ]
Background information: the driver operates the hardware in a mode where
a single VLAN can be transmitted as untagged on a particular egress
port. That is the "native VLAN on trunk port" use case. Its value is
held in port->vid.
Consider the following command sequence (no network manager, all
interfaces are down, debugging prints added by me):
$ ip link add dev br0 type bridge vlan\_filtering 1
$ ip link set dev swp0 master br0
Kernel code path during last command:
br\_add\_slave -> ocelot\_netdevice\_port\_event (NETDEV\_CHANGEUPPER):
[ 21.401901] ocelot\_vlan\_port\_apply: port 0 vlan aware 0 pvid 0 vid 0
br\_add\_slave -> nbp\_vlan\_init -> switchdev\_port\_attr\_set -> ocelot\_port\_attr\_set (SWITCHDEV\_ATTR\_ID\_BRIDGE\_VLAN\_FILTERING):
[ 21.413335] ocelot\_vlan\_port\_apply: port 0 vlan aware 1 pvid 0 vid 0
br\_add\_slave -> nbp\_vlan\_init -> nbp\_vlan\_add -> br\_switchdev\_port\_vlan\_add -> switchdev\_port\_obj\_add -> ocelot\_port\_obj\_add -> ocelot\_vlan\_vid\_add
[ 21.667421] ocelot\_vlan\_port\_apply: port 0 vlan aware 1 pvid 1 vid 1
So far so good. The bridge has replaced the driver's default pvid used
in standalone mode (0) with its own default\_pvid (1). The port's vid
(native VLAN) has also changed from 0 to 1.
$ ip link set dev swp0 up
[ 31.722956] 8021q: adding VLAN 0 to HW filter on device swp0
do\_setlink -> dev\_change\_flags -> vlan\_vid\_add -> ocelot\_vlan\_rx\_add\_vid -> ocelot\_vlan\_vid\_add:
[ 31.728700] ocelot\_vlan\_port\_apply: port 0 vlan aware 1 pvid 1 vid 0
The 8021q module uses the .ndo\_vlan\_rx\_add\_vid API on .ndo\_open to make
ports be able to transmit and receive 802.1p-tagged traffic by default.
This API is supposed to offload a VLAN sub-interface, which for a switch
port means to add a VLAN that is not a pvid, and tagged on egress.
But the driver implementation of .ndo\_vlan\_rx\_add\_vid is wrong: it adds
back vid 0 as "egress untagged". Now back to the initial paragraph:
there is a single untagged VID that the driver keeps track of, and that
has just changed from 1 (the pvid) to 0. So this breaks the bridge
core's expectation, because it has changed vid 1 from untagged to
tagged, when what the user sees is.
$ bridge vlan
port vlan ids
swp0 1 PVID Egress Untagged
br0 1 PVID Egress Untagged
But curiously, instead of manifesting itself as "untagged and
pvid-tagged traffic gets sent as tagged on egress", the bug:
- is hidden when vlan\_filtering=0
- manifests as dropped traffic when vlan\_filtering=1, due to this setting:
if (port->vlan\_aware && !port->vid)
/\* If port is vlan-aware and tagged, drop untagged and priority
\* tagged frames.
\*/
val |= ANA\_PORT\_DROP\_CFG\_DROP\_UNTAGGED\_ENA |
ANA\_PORT\_DROP\_CFG\_DROP\_PRIO\_S\_TAGGED\_ENA |
ANA\_PORT\_DROP\_CFG\_DROP\_PRIO\_C\_TAGGED\_ENA;
which would have made sense if it weren't for this bug. The setting's
intention was "this is a trunk port with no native VLAN, so don't accept
untagged traffic". So the driver was never expecting to set VLAN 0 as
the value of the native VLAN, 0 was just encoding for "invalid".
So the fix is to not send 802.1p traffic as untagged, because that would
change the port's native vlan to 0, unbeknownst to the bridge, and
trigger unexpected code paths in the driver.
Cc: Antoine Tenart
Cc: Alexandre Belloni
Fixes: 7142529f1688 ("net: mscc: ocelot: add VLAN filtering")
Signed-off-by: Vladimir Oltean
Reviewed-by: Florian Fainelli
Acked-by: Alexandre Belloni
Reviewed-by: Horatiu Vultur
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cb89b0ed2a2dc651aa306fb0c48bc59da70d772c
Author: Navid Emamdoost
Date: Fri Oct 25 23:53:30 2019 -0500
wimax: i2400: Fix memory leak in i2400m\_op\_rfkill\_sw\_toggle
[ Upstream commit 6f3ef5c25cc762687a7341c18cbea5af54461407 ]
In the implementation of i2400m\_op\_rfkill\_sw\_toggle() the allocated
buffer for cmd should be released before returning. The
documentation for i2400m\_msg\_to\_dev() says when it returns the buffer
can be reused. Meaning cmd should be released in either case. Move
kfree(cmd) before return to be reached by all execution paths.
Fixes: 2507e6ab7a9a ("wimax: i2400: fix memory leak")
Signed-off-by: Navid Emamdoost
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a3f674ed434f467d7587f0225c2a4a99c19caa22
Author: Jiangfeng Xiao
Date: Fri Oct 25 21:48:22 2019 +0800
net: hisilicon: Fix "Trying to free already-free IRQ"
[ Upstream commit 63a41746827cb16dc6ad0d4d761ab4e7dda7a0c3 ]
When rmmod hip04\_eth.ko, we can get the following warning:
Task track: rmmod(1623)>bash(1591)>login(1581)>init(1)
------------[ cut here ]------------
WARNING: CPU: 0 PID: 1623 at kernel/irq/manage.c:1557 \_\_free\_irq+0xa4/0x2ac()
Trying to free already-free IRQ 200
Modules linked in: ping(O) pramdisk(O) cpuinfo(O) rtos\_snapshot(O) interrupt\_ctrl(O) mtdblock mtd\_blkdevrtfs nfs\_acl nfs lockd grace sunrpc xt\_tcpudp ipt\_REJECT iptable\_filter ip\_tables x\_tables nf\_reject\_ipv
CPU: 0 PID: 1623 Comm: rmmod Tainted: G O 4.4.193 #1
Hardware name: Hisilicon A15
[] (rtos\_unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0xa0/0xd8)
[] (dump\_stack) from [] (warn\_slowpath\_common+0x84/0xb0)
[] (warn\_slowpath\_common) from [] (warn\_slowpath\_fmt+0x3c/0x68)
[] (warn\_slowpath\_fmt) from [] (\_\_free\_irq+0xa4/0x2ac)
[] (\_\_free\_irq) from [] (free\_irq+0x60/0x7c)
[] (free\_irq) from [] (release\_nodes+0x1c4/0x1ec)
[] (release\_nodes) from [] (\_\_device\_release\_driver+0xa8/0x104)
[] (\_\_device\_release\_driver) from [] (driver\_detach+0xd0/0xf8)
[] (driver\_detach) from [] (bus\_remove\_driver+0x64/0x8c)
[] (bus\_remove\_driver) from [] (SyS\_delete\_module+0x198/0x1e0)
[] (SyS\_delete\_module) from [] (\_\_sys\_trace\_return+0x0/0x10)
---[ end trace bb25d6123d849b44 ]---
Currently "rmmod hip04\_eth.ko" call free\_irq more than once
as devres\_release\_all and hip04\_remove both call free\_irq.
This results in a 'Trying to free already-free IRQ' warning.
To solve the problem free\_irq has been moved out of hip04\_remove.
Signed-off-by: Jiangfeng Xiao
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9fb4fd110885c90944c7cc1b88414590e489a209
Author: Will Deacon
Date: Fri Oct 25 12:06:02 2019 +0100
fjes: Handle workqueue allocation failure
[ Upstream commit 85ac30fa2e24f628e9f4f9344460f4015d33fd7d ]
In the highly unlikely event that we fail to allocate either of the
"/txrx" or "/control" workqueues, we should bail cleanly rather than
blindly march on with NULL queue pointer(s) installed in the
'fjes\_adapter' instance.
Cc: "David S. Miller"
Reported-by: Nicolas Waisman
Link: https://lore.kernel.org/lkml/CADJ\_3a8WFrs5NouXNqS5WYe7rebFP+\_A5CheeqAyD\_p7DFJJcg@mail.gmail.com/
Signed-off-by: Will Deacon
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7593ffa645e57be9f8869e7dbb0e74a5e0916ae5
Author: Anton Eidelman
Date: Fri Oct 18 11:32:50 2019 -0700
nvme-multipath: fix possible io hang after ctrl reconnect
[ Upstream commit af8fd0424713a2adb812d10d55e86718152cf656 ]
The following scenario results in an IO hang:
1) ctrl completes a request with NVME\_SC\_ANA\_TRANSITION.
NVME\_NS\_ANA\_PENDING bit in ns->flags is set and ana\_work is triggered.
2) ana\_work: nvme\_read\_ana\_log() tries to get the ANA log page from the ctrl.
This fails because ctrl disconnects.
Therefore nvme\_update\_ns\_ana\_state() is not called
and NVME\_NS\_ANA\_PENDING bit in ns->flags is not cleared.
3) ctrl reconnects: nvme\_mpath\_init(ctrl,...) calls
nvme\_read\_ana\_log(ctrl, groups\_only=true).
However, nvme\_update\_ana\_state() does not update namespaces
because nr\_nsids = 0 (due to groups\_only mode).
4) scan\_work calls nvme\_validate\_ns() finds the ns and re-validates OK.
Result:
The ctrl is now live but NVME\_NS\_ANA\_PENDING bit in ns->flags is still set.
Consequently ctrl will never be considered a viable path by \_\_nvme\_find\_path().
IO will hang if ctrl is the only or the last path to the namespace.
More generally, while ctrl is reconnecting, its ANA state may change.
And because nvme\_mpath\_init() requests ANA log in groups\_only mode,
these changes are not propagated to the existing ctrl namespaces.
This may result in a mal-function or an IO hang.
Solution:
nvme\_mpath\_init() will nvme\_read\_ana\_log() with groups\_only set to false.
This will not harm the new ctrl case (no namespaces present),
and will make sure the ANA state of namespaces gets updated after reconnect.
Note: Another option would be for nvme\_mpath\_init() to invoke
nvme\_parse\_ana\_log(..., nvme\_set\_ns\_ana\_state) for each existing namespace.
Reviewed-by: Sagi Grimberg
Signed-off-by: Anton Eidelman
Signed-off-by: Keith Busch
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit a3b3730b3fd25f816b39c61332b67004b2ae7606
Author: Valentin Schneider
Date: Wed Oct 23 16:37:45 2019 +0100
sched/topology: Allow sched\_asym\_cpucapacity to be disabled
[ Upstream commit e284df705cf1eeedb5ec3a66ed82d17a64659150 ]
While the static key is correctly initialized as being disabled, it will
remain forever enabled once turned on. This means that if we start with an
asymmetric system and hotplug out enough CPUs to end up with an SMP system,
the static key will remain set - which is obviously wrong. We should detect
this and turn off things like misfit migration and capacity aware wakeups.
As Quentin pointed out, having separate root domains makes this slightly
trickier. We could have exclusive cpusets that create an SMP island - IOW,
the domains within this root domain will not see any asymmetry. This means
we can't just disable the key on domain destruction, we need to count how
many asymmetric root domains we have.
Consider the following example using Juno r0 which is 2+4 big.LITTLE, where
two identical cpusets are created: they both span both big and LITTLE CPUs:
asym0 asym1
[ ][ ]
L L B L L B
$ cgcreate -g cpuset:asym0
$ cgset -r cpuset.cpus=0,1,3 asym0
$ cgset -r cpuset.mems=0 asym0
$ cgset -r cpuset.cpu\_exclusive=1 asym0
$ cgcreate -g cpuset:asym1
$ cgset -r cpuset.cpus=2,4,5 asym1
$ cgset -r cpuset.mems=0 asym1
$ cgset -r cpuset.cpu\_exclusive=1 asym1
$ cgset -r cpuset.sched\_load\_balance=0 .
(the CPU numbering may look odd because on the Juno LITTLEs are CPUs 0,3-5
and bigs are CPUs 1-2)
If we make one of those SMP (IOW remove asymmetry) by e.g. hotplugging its
big core, we would end up with an SMP cpuset and an asymmetric cpuset - the
static key must remain set, because we still have one asymmetric root domain.
With the above example, this could be done with:
$ echo 0 > /sys/devices/system/cpu/cpu2/online
Which would result in:
asym0 asym1
[ ][ ]
L L B L L
When both SMP and asymmetric cpusets are present, all CPUs will observe
sched\_asym\_cpucapacity being set (it is system-wide), but not all CPUs
observe asymmetry in their sched domain hierarchy:
per\_cpu(sd\_asym\_cpucapacity, ) ==
per\_cpu(sd\_asym\_cpucapacity, ) == NULL
Change the simple key enablement to an increment, and decrement the key
counter when destroying domains that cover asymmetric CPUs.
Signed-off-by: Valentin Schneider
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Dietmar Eggemann
Cc: Dietmar.Eggemann@arm.com
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: hannes@cmpxchg.org
Cc: lizefan@huawei.com
Cc: morten.rasmussen@arm.com
Cc: qperret@google.com
Cc: tj@kernel.org
Cc: vincent.guittot@linaro.org
Fixes: df054e8445a4 ("sched/topology: Add static\_key for asymmetric CPU capacity optimizations")
Link: https://lkml.kernel.org/r/20191023153745.19515-3-valentin.schneider@arm.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 0fe1731113eb760065dd7df6ec9ad54ecc62854f
Author: Valentin Schneider
Date: Wed Oct 23 16:37:44 2019 +0100
sched/topology: Don't try to build empty sched domains
[ Upstream commit cd1cb3350561d2bf544ddfef76fbf0b1c9c7178f ]
Turns out hotplugging CPUs that are in exclusive cpusets can lead to the
cpuset code feeding empty cpumasks to the sched domain rebuild machinery.
This leads to the following splat:
Internal error: Oops: 96000004 [#1] PREEMPT SMP
Modules linked in:
CPU: 0 PID: 235 Comm: kworker/5:2 Not tainted 5.4.0-rc1-00005-g8d495477d62e #23
Hardware name: ARM Juno development board (r0) (DT)
Workqueue: events cpuset\_hotplug\_workfn
pstate: 60000005 (nZCv daif -PAN -UAO)
pc : build\_sched\_domains (./include/linux/arch\_topology.h:23 kernel/sched/topology.c:1898 kernel/sched/topology.c:1969)
lr : build\_sched\_domains (kernel/sched/topology.c:1966)
Call trace:
build\_sched\_domains (./include/linux/arch\_topology.h:23 kernel/sched/topology.c:1898 kernel/sched/topology.c:1969)
partition\_sched\_domains\_locked (kernel/sched/topology.c:2250)
rebuild\_sched\_domains\_locked (./include/linux/bitmap.h:370 ./include/linux/cpumask.h:538 kernel/cgroup/cpuset.c:955 kernel/cgroup/cpuset.c:978 kernel/cgroup/cpuset.c:1019)
rebuild\_sched\_domains (kernel/cgroup/cpuset.c:1032)
cpuset\_hotplug\_workfn (kernel/cgroup/cpuset.c:3205 (discriminator 2))
process\_one\_work (./arch/arm64/include/asm/jump\_label.h:21 ./include/linux/jump\_label.h:200 ./include/trace/events/workqueue.h:114 kernel/workqueue.c:2274)
worker\_thread (./include/linux/compiler.h:199 ./include/linux/list.h:268 kernel/workqueue.c:2416)
kthread (kernel/kthread.c:255)
ret\_from\_fork (arch/arm64/kernel/entry.S:1167)
Code: f860dae2 912802d6 aa1603e1 12800000 (f8616853)
The faulty line in question is:
cap = arch\_scale\_cpu\_capacity(cpumask\_first(cpu\_map));
and we're not checking the return value against nr\_cpu\_ids (we shouldn't
have to!), which leads to the above.
Prevent generate\_sched\_domains() from returning empty cpumasks, and add
some assertion in build\_sched\_domains() to scream bloody murder if it
happens again.
The above splat was obtained on my Juno r0 with the following reproducer:
$ cgcreate -g cpuset:asym
$ cgset -r cpuset.cpus=0-3 asym
$ cgset -r cpuset.mems=0 asym
$ cgset -r cpuset.cpu\_exclusive=1 asym
$ cgcreate -g cpuset:smp
$ cgset -r cpuset.cpus=4-5 smp
$ cgset -r cpuset.mems=0 smp
$ cgset -r cpuset.cpu\_exclusive=1 smp
$ cgset -r cpuset.sched\_load\_balance=0 .
$ echo 0 > /sys/devices/system/cpu/cpu4/online
$ echo 0 > /sys/devices/system/cpu/cpu5/online
Signed-off-by: Valentin Schneider
Signed-off-by: Peter Zijlstra (Intel)
Cc: Dietmar.Eggemann@arm.com
Cc: Linus Torvalds
Cc: Peter Zijlstra
Cc: Thomas Gleixner
Cc: hannes@cmpxchg.org
Cc: lizefan@huawei.com
Cc: morten.rasmussen@arm.com
Cc: qperret@google.com
Cc: tj@kernel.org
Cc: vincent.guittot@linaro.org
Fixes: 05484e098448 ("sched/topology: Add SD\_ASYM\_CPUCAPACITY flag detection")
Link: https://lkml.kernel.org/r/20191023153745.19515-2-valentin.schneider@arm.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 4a600e39a56babf0ba569126d1ba61823c4d4bd9
Author: Nicholas Piggin
Date: Thu Oct 24 16:38:04 2019 +1000
scsi: qla2xxx: stop timer in shutdown path
[ Upstream commit d3566abb1a1e7772116e4d50fb6a58d19c9802e5 ]
In shutdown/reboot paths, the timer is not stopped:
qla2x00\_shutdown
pci\_device\_shutdown
device\_shutdown
kernel\_restart\_prepare
kernel\_restart
sys\_reboot
This causes lockups (on powerpc) when firmware config space access calls
are interrupted by smp\_send\_stop later in reboot.
Fixes: e30d1756480dc ("[SCSI] qla2xxx: Addition of shutdown callback handler.")
Link: https://lore.kernel.org/r/20191024063804.14538-1-npiggin@gmail.com
Signed-off-by: Nicholas Piggin
Acked-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit c07a91d1800d509eca575d190025770510a842ae
Author: Nicolin Chen
Date: Mon Oct 21 17:59:22 2019 -0700
hwmon: (ina3221) Fix read timeout issue
[ Upstream commit 2ccb4f16d013a0954459061d38172b1c53553ba6 ]
After introducing "samples" to the calculation of wait time, the
driver might timeout at the regmap\_field\_read\_poll\_timeout call,
because the wait time could be longer than the 100000 usec limit
due to a large "samples" number.
So this patch sets the timeout limit to 2 times of the wait time
in order to fix this issue.
Fixes: 5c090abf945b ("hwmon: (ina3221) Add averaging mode support")
Signed-off-by: Nicolin Chen
Link: https://lore.kernel.org/r/20191022005922.30239-1-nicoleotsuka@gmail.com
Signed-off-by: Guenter Roeck
Signed-off-by: Sasha Levin
commit 46c654504ae1b02fe82955a5c32cb6615ed6e249
Author: Lijun Ou
Date: Sat Oct 26 14:56:35 2019 +0800
RDMA/hns: Prevent memory leaks of eq->buf\_list
[ Upstream commit b681a0529968d2261aa15d7a1e78801b2c06bb07 ]
eq->buf\_list->buf and eq->buf\_list should also be freed when eqe\_hop\_num
is set to 0, or there will be memory leaks.
Fixes: a5073d6054f7 ("RDMA/hns: Add eq support of hip08")
Link: https://lore.kernel.org/r/1572072995-11277-3-git-send-email-liweihang@hisilicon.com
Signed-off-by: Lijun Ou
Signed-off-by: Weihang Li
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 6c68e48b30f4a4db07c7e9a5ebb4ab34651e0104
Author: Potnuri Bharat Teja
Date: Fri Oct 25 18:04:40 2019 +0530
RDMA/iw\_cxgb4: Avoid freeing skb twice in arp failure case
[ Upstream commit d4934f45693651ea15357dd6c7c36be28b6da884 ]
\_put\_ep\_safe() and \_put\_pass\_ep\_safe() free the skb before it is freed by
process\_work(). fix double free by freeing the skb only in process\_work().
Fixes: 1dad0ebeea1c ("iw\_cxgb4: Avoid touch after free error in ARP failure handlers")
Link: https://lore.kernel.org/r/1572006880-5800-1-git-send-email-bharat@chelsio.com
Signed-off-by: Dakshaja Uppalapati
Signed-off-by: Potnuri Bharat Teja
Reviewed-by: Jason Gunthorpe
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 754a946d139cf05a8caab32e7456a72df6fa8c69
Author: GwanYeong Kim
Date: Fri Oct 18 03:22:23 2019 +0000
usbip: tools: Fix read\_usb\_vudc\_device() error path handling
[ Upstream commit 28df0642abbf6d66908a2858922a7e4b21cdd8c2 ]
This isn't really accurate right. fread() doesn't always
return 0 in error. It could return < number of elements
and set errno.
Signed-off-by: GwanYeong Kim
Acked-by: Shuah Khan
Link: https://lore.kernel.org/r/20191018032223.4644-1-gy741.kim@gmail.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 0f6ecd07120ee715df60e188e87ae46e6ab3cfdc
Author: Johan Hovold
Date: Tue Oct 22 16:32:03 2019 +0200
USB: ldusb: use unsigned size format specifiers
[ Upstream commit 88f6bf3846ee90bf33aa1ce848cd3bfb3229f4a4 ]
A recent info-leak bug manifested itself along with warning about a
negative buffer overflow:
ldusb 1-1:0.28: Read buffer overflow, -131383859965943 bytes dropped
when it was really a rather large positive one.
A sanity check that prevents this has now been put in place, but let's
fix up the size format specifiers, which should all be unsigned.
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20191022143203.5260-3-johan@kernel.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 47aaab6377204cdbcd16f52a23c584f994fd0d15
Author: Alan Stern
Date: Mon Oct 28 10:52:35 2019 -0400
USB: Skip endpoints with 0 maxpacket length
[ Upstream commit d482c7bb0541d19dea8bff437a9f3c5563b5b2d2 ]
Endpoints with a maxpacket length of 0 are probably useless. They
can't transfer any data, and it's not at all unlikely that an HCD will
crash or hang when trying to handle an URB for such an endpoint.
Currently the USB core does not check for endpoints having a maxpacket
value of 0. This patch adds a check, printing a warning and skipping
over any endpoints it catches.
Now, the USB spec does not rule out endpoints having maxpacket = 0.
But since they wouldn't have any practical use, there doesn't seem to
be any good reason for us to accept them.
Signed-off-by: Alan Stern
Link: https://lore.kernel.org/r/Pine.LNX.4.44L0.1910281050420.1485-100000@iolanthe.rowland.org
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 242858fac866030872c889692f2c0be2e831d304
Author: Kan Liang
Date: Fri Oct 25 07:43:13 2019 -0700
perf/x86/uncore: Fix event group support
[ Upstream commit 75be6f703a141b048590d659a3954c4fedd30bba ]
The events in the same group don't start or stop simultaneously.
Here is the ftrace when enabling event group for uncore\_iio\_0:
# perf stat -e "{uncore\_iio\_0/event=0x1/,uncore\_iio\_0/event=0xe/}"
-0 [000] d.h. 8959.064832: read\_msr: a41, value
b2b0b030 //Read counter reg of IIO unit0 counter0
-0 [000] d.h. 8959.064835: write\_msr: a48, value
400001 //Write Ctrl reg of IIO unit0 counter0 to enable
counter0. <------ Although counter0 is enabled, Unit Ctrl is still
freezed. Nothing will count. We are still good here.
-0 [000] d.h. 8959.064836: read\_msr: a40, value
30100 //Read Unit Ctrl reg of IIO unit0
-0 [000] d.h. 8959.064838: write\_msr: a40, value
30000 //Write Unit Ctrl reg of IIO unit0 to enable all
counters in the unit by clear Freeze bit <------Unit0 is un-freezed.
Counter0 has been enabled. Now it starts counting. But counter1 has not
been enabled yet. The issue starts here.
-0 [000] d.h. 8959.064846: read\_msr: a42, value 0
//Read counter reg of IIO unit0 counter1
-0 [000] d.h. 8959.064847: write\_msr: a49, value
40000e //Write Ctrl reg of IIO unit0 counter1 to enable
counter1. <------ Now, counter1 just starts to count. Counter0 has
been running for a while.
Current code un-freezes the Unit Ctrl right after the first counter is
enabled. The subsequent group events always loses some counter values.
Implement pmu\_enable and pmu\_disable support for uncore, which can help
to batch hardware accesses.
No one uses uncore\_enable\_box and uncore\_disable\_box. Remove them.
Signed-off-by: Kan Liang
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Cc: linux-drivers-review@eclists.intel.com
Cc: linux-perf@eclists.intel.com
Fixes: 087bfbb03269 ("perf/x86: Add generic Intel uncore PMU support")
Link: https://lkml.kernel.org/r/1572014593-31591-1-git-send-email-kan.liang@linux.intel.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit c6b71b6427f99269bdf52bfb3f313c4cdca36983
Author: Kim Phillips
Date: Wed Oct 23 10:09:55 2019 -0500
perf/x86/amd/ibs: Handle erratum #420 only on the affected CPU family (10h)
[ Upstream commit e431e79b60603079d269e0c2a5177943b95fa4b6 ]
This saves us writing the IBS control MSR twice when disabling the
event.
I searched revision guides for all families since 10h, and did not
find occurrence of erratum #420, nor anything remotely similar:
so we isolate the secondary MSR write to family 10h only.
Also unconditionally update the count mask for IBS Op implementations
that have read & writeable current count (CurCnt) fields in addition
to the MaxCnt field. These bits were reserved on prior
implementations, and therefore shouldn't have negative impact.
Signed-off-by: Kim Phillips
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: H. Peter Anvin
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Fixes: c9574fe0bdb9 ("perf/x86-ibs: Implement workaround for IBS erratum #420")
Link: https://lkml.kernel.org/r/20191023150955.30292-2-kim.phillips@amd.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 04e9a34d5b5822a98c48dcc09737233acacda399
Author: Kim Phillips
Date: Wed Oct 23 10:09:54 2019 -0500
perf/x86/amd/ibs: Fix reading of the IBS OpData register and thus precise RIP validity
[ Upstream commit 317b96bb14303c7998dbcd5bc606bd8038fdd4b4 ]
The loop that reads all the IBS MSRs into \*buf stopped one MSR short of
reading the IbsOpData register, which contains the RipInvalid status bit.
Fix the offset\_max assignment so the MSR gets read, so the RIP invalid
evaluation is based on what the IBS h/w output, instead of what was
left in memory.
Signed-off-by: Kim Phillips
Signed-off-by: Peter Zijlstra (Intel)
Cc: Alexander Shishkin
Cc: Arnaldo Carvalho de Melo
Cc: Arnaldo Carvalho de Melo
Cc: Borislav Petkov
Cc: H. Peter Anvin
Cc: Jiri Olsa
Cc: Linus Torvalds
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Stephane Eranian
Cc: Thomas Gleixner
Cc: Vince Weaver
Fixes: d47e8238cd76 ("perf/x86-ibs: Take instruction pointer from ibs sample")
Link: https://lkml.kernel.org/r/20191023150955.30292-1-kim.phillips@amd.com
Signed-off-by: Ingo Molnar
Signed-off-by: Sasha Levin
commit 4111c2641e54fd2772cf71422dacd4c2deee4ff0
Author: Yinbo Zhu
Date: Mon Jul 29 14:46:07 2019 +0800
usb: dwc3: remove the call trace of USBx\_GFLADJ
[ Upstream commit a7d9874c6f3fbc8d25cd9ceba35b6822612c4ebf ]
layerscape board sometimes reported some usb call trace, that is due to
kernel sent LPM tokerns automatically when it has no pending transfers
and think that the link is idle enough to enter L1, which procedure will
ask usb register has a recovery,then kernel will compare USBx\_GFLADJ and
set GFLADJ\_30MHZ, GFLADJ\_30MHZ\_REG until GFLADJ\_30MHZ is equal 0x20, if
the conditions were met then issue occur, but whatever the conditions
whether were met that usb is all need keep GFLADJ\_30MHZ of value is 0x20
(xhci spec ask use GFLADJ\_30MHZ to adjust any offset from clock source
that generates the clock that drives the SOF counter, 0x20 is default
value of it)That is normal logic, so need remove the call trace.
Signed-off-by: Yinbo Zhu
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit c4ed98374f764ee217ecf0bf6dcc98347e1b6023
Author: Peter Chen
Date: Mon Aug 26 15:10:55 2019 -0400
usb: gadget: configfs: fix concurrent issue between composite APIs
[ Upstream commit 1a1c851bbd706ea9f3a9756c2d3db28523506d3b ]
We meet several NULL pointer issues if configfs\_composite\_unbind
and composite\_setup (or composite\_disconnect) are running together.
These issues occur when do the function switch stress test, the
configfs\_compsoite\_unbind is called from user mode by
echo "" to /sys/../UDC entry, and meanwhile, the setup interrupt
or disconnect interrupt occurs by hardware. The composite\_setup
will get the cdev from get\_gadget\_data, but configfs\_composite\_unbind
will set gadget data as NULL, so the NULL pointer issue occurs.
This concurrent is hard to reproduce by native kernel, but can be
reproduced by android kernel.
In this commit, we introduce one spinlock belongs to structure
gadget\_info since we can't use the same spinlock in usb\_composite\_dev
due to exclusive running together between composite\_setup and
configfs\_composite\_unbind. And one bit flag 'unbind' to indicate the
code is at unbind routine, this bit is needed due to we release the
lock at during configfs\_composite\_unbind sometimes, and composite\_setup
may be run at that time.
Several oops:
oops 1:
android\_work: sent uevent USB\_STATE=CONNECTED
configfs-gadget gadget: super-speed config #1: b
android\_work: sent uevent USB\_STATE=CONFIGURED
init: Received control message 'start' for 'adbd' from pid: 3515 (system\_server)
Unable to handle kernel NULL pointer dereference at virtual address 0000002a
init: Received control message 'stop' for 'adbd' from pid: 3375 (/vendor/bin/hw/android.hardware.usb@1.1-servic)
Mem abort info:
Exception class = DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
Data abort info:
ISV = 0, ISS = 0x00000004
CM = 0, WnR = 0
user pgtable: 4k pages, 48-bit VAs, pgd = ffff8008f1b7f000
[000000000000002a] \*pgd=0000000000000000
Internal error: Oops: 96000004 [#1] PREEMPT SMP
Modules linked in:
CPU: 4 PID: 2457 Comm: irq/125-5b11000 Not tainted 4.14.98-07846-g0b40a9b-dirty #16
Hardware name: Freescale i.MX8QM MEK (DT)
task: ffff8008f2a98000 task.stack: ffff00000b7b8000
PC is at composite\_setup+0x44/0x1508
LR is at android\_setup+0xb8/0x13c
pc : [] lr : [] pstate: 800001c5
sp : ffff00000b7bbb80
x29: ffff00000b7bbb80 x28: ffff8008f2a3c010
x27: 0000000000000001 x26: 0000000000000000 [1232/1897]
audit: audit\_lost=25791 audit\_rate\_limit=5 audit\_backlog\_limit=64
x25: 00000000ffffffa1 x24: ffff8008f2a3c010
audit: rate limit exceeded
x23: 0000000000000409 x22: ffff000009c8e000
x21: ffff8008f7a8b428 x20: ffff00000afae000
x19: ffff0000089ff000 x18: 0000000000000000
x17: 0000000000000000 x16: ffff0000082b7c9c
x15: 0000000000000000 x14: f1866f5b952aca46
x13: e35502e30d44349c x12: 0000000000000008
x11: 0000000000000008 x10: 0000000000000a30
x9 : ffff00000b7bbd00 x8 : ffff8008f2a98a90
x7 : ffff8008f27a9c90 x6 : 0000000000000001
x5 : 0000000000000000 x4 : 0000000000000001
x3 : 0000000000000000 x2 : 0000000000000006
x1 : ffff0000089ff8d0 x0 : 732a010310b9ed00
X7: 0xffff8008f27a9c10:
9c10 00000002 00000000 00000001 00000000 13110000 ffff0000 00000002 00208040
9c30 00000000 00000000 00000000 00000000 00000000 00000005 00000029 00000000
9c50 00051778 00000001 f27a8e00 ffff8008 00000005 00000000 00000078 00000078
9c70 00000078 00000000 09031d48 ffff0000 00100000 00000000 00400000 00000000
9c90 00000001 00000000 00000000 00000000 00000000 00000000 ffefb1a0 ffff8008
9cb0 f27a9ca8 ffff8008 00000000 00000000 b9d88037 00000173 1618a3eb 00000001
9cd0 870a792a 0000002e 16188fe6 00000001 0000242b 00000000 00000000 00000000
using random self ethernet address
9cf0 019a4646 00000000 000547f3 00000000 ecfd6c33 00000002 00000000
using random host ethernet address
00000000
X8: 0xffff8008f2a98a10:
8a10 00000000 00000000 f7788d00 ffff8008 00000001 00000000 00000000 00000000
8a30 eb218000 ffff8008 f2a98000 ffff8008 f2a98000 ffff8008 09885000 ffff0000
8a50 f34df480 ffff8008 00000000 00000000 f2a98648 ffff8008 09c8e000 ffff0000
8a70 fff2c800 ffff8008 09031d48 ffff0000 0b7bbd00 ffff0000 0b7bbd00 ffff0000
8a90 080861bc ffff0000 00000000 00000000 00000000 00000000 00000000 00000000
8ab0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
8ad0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
8af0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
X21: 0xffff8008f7a8b3a8:
b3a8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
b3c8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
b3e8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
b408 00000000 00000000 00000000 00000000 00000000 00000000 00000001 00000000
b428 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
b448 0053004d 00540046 00300031 00010030 eb07b520 ffff8008 20011201 00000003
b468 e418d109 0104404e 00010302 00000000 eb07b558 ffff8008 eb07b558 ffff8008
b488 f7a8b488 ffff8008 f7a8b488 ffff8008 f7a8b300 ffff8008 00000000 00000000
X24: 0xffff8008f2a3bf90:
bf90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bfb0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bfd0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bff0 00000000 00000000 00000000 00000000 f76c8010 ffff8008 f76c8010 ffff8008
c010 00000000 00000000 f2a3c018 ffff8008 f2a3c018 ffff8008 08a067dc ffff0000
c030 f2a5a000 ffff8008 091c3650 ffff0000 f716fd18 ffff8008 f716fe30 ffff8008
c050 f2ce4a30 ffff8008 00000000 00000005 00000000 00000000 095d1568 ffff0000
c070 f76c8010 ffff8008 f2ce4b00 ffff8008 095cac68 ffff0000 f2a5a028 ffff8008
X28: 0xffff8008f2a3bf90:
bf90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bfb0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bfd0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
bff0 00000000 00000000 00000000 00000000 f76c8010 ffff8008 f76c8010 ffff8008
c010 00000000 00000000 f2a3c018 ffff8008 f2a3c018 ffff8008 08a067dc ffff0000
c030 f2a5a000 ffff8008 091c3650 ffff0000 f716fd18 ffff8008 f716fe30 ffff8008
c050 f2ce4a30 ffff8008 00000000 00000005 00000000 00000000 095d1568 ffff0000
c070 f76c8010 ffff8008 f2ce4b00 ffff8008 095cac68 ffff0000 f2a5a028 ffff8008
Process irq/125-5b11000 (pid: 2457, stack limit = 0xffff00000b7b8000)
Call trace:
Exception stack(0xffff00000b7bba40 to 0xffff00000b7bbb80)
ba40: 732a010310b9ed00 ffff0000089ff8d0 0000000000000006 0000000000000000
ba60: 0000000000000001 0000000000000000 0000000000000001 ffff8008f27a9c90
ba80: ffff8008f2a98a90 ffff00000b7bbd00 0000000000000a30 0000000000000008
baa0: 0000000000000008 e35502e30d44349c f1866f5b952aca46 0000000000000000
bac0: ffff0000082b7c9c 0000000000000000 0000000000000000 ffff0000089ff000
bae0: ffff00000afae000 ffff8008f7a8b428 ffff000009c8e000 0000000000000409
bb00: ffff8008f2a3c010 00000000ffffffa1 0000000000000000 0000000000000001
bb20: ffff8008f2a3c010 ffff00000b7bbb80 ffff000008a032fc ffff00000b7bbb80
bb40: ffff0000089ffb3c 00000000800001c5 ffff00000b7bbb80 732a010310b9ed00
bb60: ffffffffffffffff ffff0000080f777c ffff00000b7bbb80 ffff0000089ffb3c
[] composite\_setup+0x44/0x1508
[] android\_setup+0xb8/0x13c
[] cdns3\_ep0\_delegate\_req+0x44/0x70
[] cdns3\_check\_ep0\_interrupt\_proceed+0x33c/0x654
[] cdns3\_device\_thread\_irq\_handler+0x4b0/0x4bc
[] cdns3\_thread\_irq+0x48/0x68
[] irq\_thread\_fn+0x28/0x88
[] irq\_thread+0x13c/0x228
[] kthread+0x104/0x130
[] ret\_from\_fork+0x10/0x18
oops2:
composite\_disconnect: Calling disconnect on a Gadget that is not connected
android\_work: did not send uevent (0 0 (null))
init: Received control message 'stop' for 'adbd' from pid: 3359 (/vendor/bin/hw/android.hardware.usb@1.1-service.imx)
init: Sending signal 9 to service 'adbd' (pid 22343) process group...
------------[ cut here ]------------
audit: audit\_lost=180038 audit\_rate\_limit=5 audit\_backlog\_limit=64
audit: rate limit exceeded
WARNING: CPU: 0 PID: 3468 at kernel\_imx/drivers/usb/gadget/composite.c:2009 composite\_disconnect+0x80/0x88
Modules linked in:
CPU: 0 PID: 3468 Comm: HWC-UEvent-Thre Not tainted 4.14.98-07846-g0b40a9b-dirty #16
Hardware name: Freescale i.MX8QM MEK (DT)
task: ffff8008f2349c00 task.stack: ffff00000b0a8000
PC is at composite\_disconnect+0x80/0x88
LR is at composite\_disconnect+0x80/0x88
pc : [] lr : [] pstate: 600001c5
sp : ffff000008003dd0
x29: ffff000008003dd0 x28: ffff8008f2349c00
x27: ffff000009885018 x26: ffff000008004000
Timeout for IPC response!
x25: ffff000009885018 x24: ffff000009c8e280
x23: ffff8008f2d98010 x22: 00000000000001c0
x21: ffff8008f2d98394 x20: ffff8008f2d98010
x19: 0000000000000000 x18: 0000e3956f4f075a
fxos8700 4-001e: i2c block read acc failed
x17: 0000e395735727e8 x16: ffff00000829f4d4
x15: ffffffffffffffff x14: 7463656e6e6f6320
x13: 746f6e2009090920 x12: 7369207461687420
x11: 7465676461472061 x10: 206e6f207463656e
x9 : 6e6f637369642067 x8 : ffff000009c8e280
x7 : ffff0000086ca6cc x6 : ffff000009f15e78
x5 : 0000000000000000 x4 : 0000000000000000
x3 : ffffffffffffffff x2 : c3f28b86000c3900
x1 : c3f28b86000c3900 x0 : 000000000000004e
X20: 0xffff8008f2d97f90:
7f90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
7fb0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
libprocessgroup: Failed to kill process cgroup uid 0 pid 22343 in 215ms, 1 processes remain
7fd0
Timeout for IPC response!
00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
using random self ethernet address
7ff0 00000000 00000000 00000000 00000000 f76c8010 ffff8008 f76c8010 ffff8008
8010 00000100 00000000 f2d98018 ffff8008 f2d98018 ffff8008 08a067dc
using random host ethernet address
ffff0000
8030 f206d800 ffff8008 091c3650 ffff0000 f7957b18 ffff8008 f7957730 ffff8008
8050 f716a630 ffff8008 00000000 00000005 00000000 00000000 095d1568 ffff0000
8070 f76c8010 ffff8008 f716a800 ffff8008 095cac68 ffff0000 f206d828 ffff8008
X21: 0xffff8008f2d98314:
8314 ffff8008 00000000 00000000 00000000 00000000 00000000 00000000 00000000
8334 00000000 00000000 00000000 00000000 00000000 08a04cf4 ffff0000 00000000
8354 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
8374 00000000 00000000 00000000 00001001 00000000 00000000 00000000 00000000
8394 e4bbe4bb 0f230000 ffff0000 0afae000 ffff0000 ae001000 00000000 f206d400
Timeout for IPC response!
83b4 ffff8008 00000000 00000000 f7957b18 ffff8008 f7957718 ffff8008 f7957018
83d4 ffff8008 f7957118 ffff8008 f7957618 ffff8008 f7957818 ffff8008 f7957918
83f4 ffff8008 f7957d18 ffff8008 00000000 00000000 00000000 00000000 00000000
X23: 0xffff8008f2d97f90:
7f90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
7fb0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
7fd0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
7ff0 00000000 00000000 00000000 00000000 f76c8010 ffff8008 f76c8010 ffff8008
8010 00000100 00000000 f2d98018 ffff8008 f2d98018 ffff8008 08a067dc ffff0000
8030 f206d800 ffff8008 091c3650 ffff0000 f7957b18 ffff8008 f7957730 ffff8008
8050 f716a630 ffff8008 00000000 00000005 00000000 00000000 095d1568 ffff0000
8070 f76c8010 ffff8008 f716a800 ffff8008 095cac68 ffff0000 f206d828 ffff8008
X28: 0xffff8008f2349b80:
9b80 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9ba0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9bc0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9be0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
9c00 00000022 00000000 ffffffff ffffffff 00010001 00000000 00000000 00000000
9c20 0b0a8000 ffff0000 00000002 00404040 00000000 00000000 00000000 00000000
9c40 00000001 00000000 00000001 00000000 001ebd44 00000001 f390b800 ffff8008
9c60 00000000 00000001 00000070 00000070 00000070 00000000 09031d48 ffff0000
Call trace:
Exception stack(0xffff000008003c90 to 0xffff000008003dd0)
3c80: 000000000000004e c3f28b86000c3900
3ca0: c3f28b86000c3900 ffffffffffffffff 0000000000000000 0000000000000000
3cc0: ffff000009f15e78 ffff0000086ca6cc ffff000009c8e280 6e6f637369642067
3ce0: 206e6f207463656e 7465676461472061 7369207461687420 746f6e2009090920
3d00: 7463656e6e6f6320 ffffffffffffffff ffff00000829f4d4 0000e395735727e8
3d20: 0000e3956f4f075a 0000000000000000 ffff8008f2d98010 ffff8008f2d98394
3d40: 00000000000001c0 ffff8008f2d98010 ffff000009c8e280 ffff000009885018
3d60: ffff000008004000 ffff000009885018 ffff8008f2349c00 ffff000008003dd0
3d80: ffff0000089ff9b0 ffff000008003dd0 ffff0000089ff9b0 00000000600001c5
3da0: ffff8008f33f2cd8 0000000000000000 0000ffffffffffff 0000000000000000
init: Received control message 'start' for 'adbd' from pid: 3359 (/vendor/bin/hw/android.hardware.usb@1.1-service.imx)
3dc0: ffff000008003dd0 ffff0000089ff9b0
[] composite\_disconnect+0x80/0x88
[] android\_disconnect+0x3c/0x68
[] cdns3\_device\_irq\_handler+0xfc/0x2c8
[] cdns3\_irq+0x44/0x94
[] \_\_handle\_irq\_event\_percpu+0x60/0x24c
[] handle\_irq\_event+0x58/0xc0
[] handle\_fasteoi\_irq+0x98/0x180
[] generic\_handle\_irq+0x24/0x38
[] \_\_handle\_domain\_irq+0x60/0xac
[] gic\_handle\_irq+0xd4/0x17c
Signed-off-by: Peter Chen
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 65b4a421e657ed09d3585a5bf75d4b2625aa1ba6
Author: Navid Emamdoost
Date: Sun Sep 29 21:41:45 2019 -0500
usb: dwc3: pci: prevent memory leak in dwc3\_pci\_probe
[ Upstream commit 9bbfceea12a8f145097a27d7c7267af25893c060 ]
In dwc3\_pci\_probe a call to platform\_device\_alloc allocates a device
which is correctly put in case of error except one case: when the call to
platform\_device\_add\_properties fails it directly returns instead of
going to error handling. This commit replaces return with the goto.
Fixes: 1a7b12f69a94 ("usb: dwc3: pci: Supply device properties via driver data")
Signed-off-by: Navid Emamdoost
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit ced537d6e7947aafca457ac858b35669c7ab0037
Author: Chandana Kishori Chiluveru
Date: Tue Oct 1 13:16:48 2019 +0530
usb: gadget: composite: Fix possible double free memory bug
[ Upstream commit 1c20c89b0421b52b2417bb0f62a611bc669eda1d ]
composite\_dev\_cleanup call from the failure of configfs\_composite\_bind
frees up the cdev->os\_desc\_req and cdev->req. If the previous calls of
bind and unbind is successful these will carry stale values.
Consider the below sequence of function calls:
configfs\_composite\_bind()
composite\_dev\_prepare()
- Allocate cdev->req, cdev->req->buf
composite\_os\_desc\_req\_prepare()
- Allocate cdev->os\_desc\_req, cdev->os\_desc\_req->buf
configfs\_composite\_unbind()
composite\_dev\_cleanup()
- free the cdev->os\_desc\_req->buf and cdev->req->buf
Next composition switch
configfs\_composite\_bind()
- If it fails goto err\_comp\_cleanup will call the
composite\_dev\_cleanup() function
composite\_dev\_cleanup()
- calls kfree up with the stale values of cdev->req->buf and
cdev->os\_desc\_req from the previous configfs\_composite\_bind
call. The free call on these stale values leads to double free.
Hence, Fix this issue by setting request and buffer pointer to NULL after
kfree.
Signed-off-by: Chandana Kishori Chiluveru
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit a1856034dca52eccbd663cf15793b3ed0de234ec
Author: Cristian Birsan
Date: Fri Oct 4 20:10:54 2019 +0300
usb: gadget: udc: atmel: Fix interrupt storm in FIFO mode.
[ Upstream commit ba3a1a915c49cc3023e4ddfc88f21e7514e82aa4 ]
Fix interrupt storm generated by endpoints when working in FIFO mode.
The TX\_COMPLETE interrupt is used only by control endpoints processing.
Do not enable it for other types of endpoints.
Fixes: 914a3f3b3754 ("USB: add atmel\_usba\_udc driver")
Signed-off-by: Cristian Birsan
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 8426e6559e00fb3ab11b29b87eda94b4e69b8749
Author: Nikhil Badola
Date: Mon Oct 21 18:21:51 2019 +0800
usb: fsl: Check memory resource before releasing it
[ Upstream commit bc1e3a2dd0c9954fd956ac43ca2876bbea018c01 ]
Check memory resource existence before releasing it to avoid NULL
pointer dereference
Signed-off-by: Nikhil Badola
Reviewed-by: Ran Wang
Reviewed-by: Peter Chen
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 42bc4412969e8983142ffd28dd2bb4e82b0b4f1e
Author: Arnd Bergmann
Date: Mon Oct 21 16:18:36 2019 +0200
usb: dwc3: select CONFIG\_REGMAP\_MMIO
[ Upstream commit a51bab592fbbef10f0e42a8aed86adfbf6a68fa7 ]
After many randconfig builds, one configuration caused a link
error with dwc3-meson-g12a lacking the regmap-mmio code:
drivers/usb/dwc3/dwc3-meson-g12a.o: In function `dwc3\_meson\_g12a\_probe':
dwc3-meson-g12a.c:(.text+0x9f): undefined reference to `\_\_devm\_regmap\_init\_mmio\_clk'
Add the select statement that we have for all other users
of that dependency.
Fixes: c99993376f72 ("usb: dwc3: Add Amlogic G12A DWC3 glue")
Acked-by: Neil Armstrong
Signed-off-by: Arnd Bergmann
Signed-off-by: Felipe Balbi
Signed-off-by: Sasha Levin
commit 37d4de65b10959894411fff6e8d3fbc9f4abc150
Author: Xiang Chen
Date: Tue Oct 22 14:27:08 2019 +0800
scsi: sd: define variable dif as unsigned int instead of bool
[ Upstream commit 0cf9f4e547cebb5f5d2d046437c71ddcc8ea4a39 ]
Variable dif in function sd\_setup\_read\_write\_cmnd() is the return value of
function scsi\_host\_dif\_capable() which returns dif capability of disks. If
define it as bool, even for the disks which support DIF3, the function
still return dif=1, which causes IO error. So define variable dif as
unsigned int instead of bool.
Fixes: e249e42d277e ("scsi: sd: Clean up sd\_setup\_read\_write\_cmnd()")
Link: https://lore.kernel.org/r/1571725628-132736-1-git-send-email-chenxiang66@hisilicon.com
Signed-off-by: Xiang Chen
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 9b414f0c95f08e3c1e8193f31a1a5c6f94f661c2
Author: Taehee Yoo
Date: Mon Oct 21 18:47:59 2019 +0000
virt\_wifi: fix refcnt leak in module exit routine
[ Upstream commit 1962f86b42ed06ea6af9ff09390243b99d9eb83a ]
virt\_wifi\_newlink() calls netdev\_upper\_dev\_link() and it internally
holds reference count of lower interface.
Current code does not release a reference count of the lower interface
when the lower interface is being deleted.
So, reference count leaks occur.
Test commands:
ip link add dummy0 type dummy
ip link add vw1 link dummy0 type virt\_wifi
ip link del dummy0
Splat looks like:
[ 133.787526][ T788] WARNING: CPU: 1 PID: 788 at net/core/dev.c:8274 rollback\_registered\_many+0x835/0xc80
[ 133.788355][ T788] Modules linked in: virt\_wifi cfg80211 dummy team af\_packet sch\_fq\_codel ip\_tables x\_tables unix
[ 133.789377][ T788] CPU: 1 PID: 788 Comm: ip Not tainted 5.4.0-rc3+ #96
[ 133.790069][ T788] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
[ 133.791167][ T788] RIP: 0010:rollback\_registered\_many+0x835/0xc80
[ 133.791906][ T788] Code: 00 4d 85 ff 0f 84 b5 fd ff ff ba c0 0c 00 00 48 89 de 4c 89 ff e8 9b 58 04 00 48 89 df e8 30
[ 133.794317][ T788] RSP: 0018:ffff88805ba3f338 EFLAGS: 00010202
[ 133.795080][ T788] RAX: ffff88805e57e801 RBX: ffff88805ba34000 RCX: ffffffffa9294723
[ 133.796045][ T788] RDX: 1ffff1100b746816 RSI: 0000000000000008 RDI: ffffffffabcc4240
[ 133.797006][ T788] RBP: ffff88805ba3f4c0 R08: fffffbfff5798849 R09: fffffbfff5798849
[ 133.797993][ T788] R10: 0000000000000001 R11: fffffbfff5798848 R12: dffffc0000000000
[ 133.802514][ T788] R13: ffff88805ba3f440 R14: ffff88805ba3f400 R15: ffff88805ed622c0
[ 133.803237][ T788] FS: 00007f2e9608c0c0(0000) GS:ffff88806cc00000(0000) knlGS:0000000000000000
[ 133.804002][ T788] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 133.804664][ T788] CR2: 00007f2e95610603 CR3: 000000005f68c004 CR4: 00000000000606e0
[ 133.805363][ T788] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 133.806073][ T788] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 133.806787][ T788] Call Trace:
[ 133.807069][ T788] ? generic\_xdp\_install+0x310/0x310
[ 133.807612][ T788] ? lock\_acquire+0x164/0x3b0
[ 133.808077][ T788] ? is\_bpf\_text\_address+0x5/0xf0
[ 133.808640][ T788] ? deref\_stack\_reg+0x9c/0xd0
[ 133.809138][ T788] ? \_\_nla\_validate\_parse+0x98/0x1ab0
[ 133.809944][ T788] unregister\_netdevice\_many.part.122+0x13/0x1b0
[ 133.810599][ T788] rtnl\_delete\_link+0xbc/0x100
[ 133.811073][ T788] ? rtnl\_af\_register+0xc0/0xc0
[ 133.811672][ T788] rtnl\_dellink+0x30e/0x8a0
[ 133.812205][ T788] ? is\_bpf\_text\_address+0x5/0xf0
[ ... ]
[ 144.110530][ T788] unregister\_netdevice: waiting for dummy0 to become free. Usage count = 1
This patch adds notifier routine to delete upper interface before deleting
lower interface.
Fixes: c7cdba31ed8b ("mac80211-next: rtnetlink wifi simulation device")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b0add6db3d5ec4561cab257358871a9d3df7f0a3
Author: Taehee Yoo
Date: Mon Oct 21 18:47:55 2019 +0000
macsec: fix refcnt leak in module exit routine
[ Upstream commit 2bce1ebed17da54c65042ec2b962e3234bad5b47 ]
When a macsec interface is created, it increases a refcnt to a lower
device(real device). when macsec interface is deleted, the refcnt is
decreased in macsec\_free\_netdev(), which is ->priv\_destructor() of
macsec interface.
The problem scenario is this.
When nested macsec interfaces are exiting, the exit routine of the
macsec module makes refcnt leaks.
Test commands:
ip link add dummy0 type dummy
ip link add macsec0 link dummy0 type macsec
ip link add macsec1 link macsec0 type macsec
modprobe -rv macsec
[ 208.629433] unregister\_netdevice: waiting for macsec0 to become free. Usage count = 1
Steps of exit routine of macsec module are below.
1. Calls ->dellink() in \_\_rtnl\_link\_unregister().
2. Checks refcnt and wait refcnt to be 0 if refcnt is not 0 in
netdev\_run\_todo().
3. Calls ->priv\_destruvtor() in netdev\_run\_todo().
Step2 checks refcnt, but step3 decreases refcnt.
So, step2 waits forever.
This patch makes the macsec module do not hold a refcnt of the lower
device because it already holds a refcnt of the lower device with
netdev\_upper\_dev\_link().
Fixes: c09440f7dcb3 ("macsec: introduce IEEE 802.1AE driver")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 80688a6fd6f60b679b69a00f538ce4b14fa4e585
Author: Taehee Yoo
Date: Mon Oct 21 18:47:53 2019 +0000
bonding: use dynamic lockdep key instead of subclass
[ Upstream commit 089bca2caed0d0dea7da235ce1fe245808f5ec02 ]
All bonding device has same lockdep key and subclass is initialized with
nest\_level.
But actual nest\_level value can be changed when a lower device is attached.
And at this moment, the subclass should be updated but it seems to be
unsafe.
So this patch makes bonding use dynamic lockdep key instead of the
subclass.
Test commands:
ip link add bond0 type bond
for i in {1..5}
do
let A=$i-1
ip link add bond$i type bond
ip link set bond$i master bond$A
done
ip link set bond5 master bond0
Splat looks like:
[ 307.992912] WARNING: possible recursive locking detected
[ 307.993656] 5.4.0-rc3+ #96 Tainted: G W
[ 307.994367] --------------------------------------------
[ 307.995092] ip/761 is trying to acquire lock:
[ 307.995710] ffff8880513aac60 (&(&bond->stats\_lock)->rlock#2/2){+.+.}, at: bond\_get\_stats+0xb8/0x500 [bonding]
[ 307.997045]
but task is already holding lock:
[ 307.997923] ffff88805fcbac60 (&(&bond->stats\_lock)->rlock#2/2){+.+.}, at: bond\_get\_stats+0xb8/0x500 [bonding]
[ 307.999215]
other info that might help us debug this:
[ 308.000251] Possible unsafe locking scenario:
[ 308.001137] CPU0
[ 308.001533] ----
[ 308.001915] lock(&(&bond->stats\_lock)->rlock#2/2);
[ 308.002609] lock(&(&bond->stats\_lock)->rlock#2/2);
[ 308.003302]
\*\*\* DEADLOCK \*\*\*
[ 308.004310] May be due to missing lock nesting notation
[ 308.005319] 3 locks held by ip/761:
[ 308.005830] #0: ffffffff9fcc42b0 (rtnl\_mutex){+.+.}, at: rtnetlink\_rcv\_msg+0x466/0x8a0
[ 308.006894] #1: ffff88805fcbac60 (&(&bond->stats\_lock)->rlock#2/2){+.+.}, at: bond\_get\_stats+0xb8/0x500 [bonding]
[ 308.008243] #2: ffffffff9f9219c0 (rcu\_read\_lock){....}, at: bond\_get\_stats+0x9f/0x500 [bonding]
[ 308.009422]
stack backtrace:
[ 308.010124] CPU: 0 PID: 761 Comm: ip Tainted: G W 5.4.0-rc3+ #96
[ 308.011097] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
[ 308.012179] Call Trace:
[ 308.012601] dump\_stack+0x7c/0xbb
[ 308.013089] \_\_lock\_acquire+0x269d/0x3de0
[ 308.013669] ? register\_lock\_class+0x14d0/0x14d0
[ 308.014318] lock\_acquire+0x164/0x3b0
[ 308.014858] ? bond\_get\_stats+0xb8/0x500 [bonding]
[ 308.015520] \_raw\_spin\_lock\_nested+0x2e/0x60
[ 308.016129] ? bond\_get\_stats+0xb8/0x500 [bonding]
[ 308.017215] bond\_get\_stats+0xb8/0x500 [bonding]
[ 308.018454] ? bond\_arp\_rcv+0xf10/0xf10 [bonding]
[ 308.019710] ? rcu\_read\_lock\_held+0x90/0xa0
[ 308.020605] ? rcu\_read\_lock\_sched\_held+0xc0/0xc0
[ 308.021286] ? bond\_get\_stats+0x9f/0x500 [bonding]
[ 308.021953] dev\_get\_stats+0x1ec/0x270
[ 308.022508] bond\_get\_stats+0x1d1/0x500 [bonding]
Fixes: d3fff6c443fe ("net: add netdev\_lockdep\_set\_classes() helper")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 56ed4805453febf9f4f341b2f694c4b6f6779c82
Author: Taehee Yoo
Date: Mon Oct 21 18:47:52 2019 +0000
bonding: fix unexpected IFF\_BONDING bit unset
[ Upstream commit 65de65d9033750d2cf1b336c9d6e9da3a8b5cc6e ]
The IFF\_BONDING means bonding master or bonding slave device.
->ndo\_add\_slave() sets IFF\_BONDING flag and ->ndo\_del\_slave() unsets
IFF\_BONDING flag.
bond0<--bond1
Both bond0 and bond1 are bonding device and these should keep having
IFF\_BONDING flag until they are removed.
But bond1 would lose IFF\_BONDING at ->ndo\_del\_slave() because that routine
do not check whether the slave device is the bonding type or not.
This patch adds the interface type check routine before removing
IFF\_BONDING flag.
Test commands:
ip link add bond0 type bond
ip link add bond1 type bond
ip link set bond1 master bond0
ip link set bond1 nomaster
ip link del bond1 type bond
ip link add bond1 type bond
Splat looks like:
[ 226.665555] proc\_dir\_entry 'bonding/bond1' already registered
[ 226.666440] WARNING: CPU: 0 PID: 737 at fs/proc/generic.c:361 proc\_register+0x2a9/0x3e0
[ 226.667571] Modules linked in: bonding af\_packet sch\_fq\_codel ip\_tables x\_tables unix
[ 226.668662] CPU: 0 PID: 737 Comm: ip Not tainted 5.4.0-rc3+ #96
[ 226.669508] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
[ 226.670652] RIP: 0010:proc\_register+0x2a9/0x3e0
[ 226.671612] Code: 89 fa 48 c1 ea 03 80 3c 02 00 0f 85 39 01 00 00 48 8b 04 24 48 89 ea 48 c7 c7 a0 0b 14 9f 48 8b b0 e
0 00 00 00 e8 07 e7 88 ff <0f> 0b 48 c7 c7 40 2d a5 9f e8 59 d6 23 01 48 8b 4c 24 10 48 b8 00
[ 226.675007] RSP: 0018:ffff888050e17078 EFLAGS: 00010282
[ 226.675761] RAX: dffffc0000000008 RBX: ffff88805fdd0f10 RCX: ffffffff9dd344e2
[ 226.676757] RDX: 0000000000000001 RSI: 0000000000000008 RDI: ffff88806c9f6b8c
[ 226.677751] RBP: ffff8880507160f3 R08: ffffed100d940019 R09: ffffed100d940019
[ 226.678761] R10: 0000000000000001 R11: ffffed100d940018 R12: ffff888050716008
[ 226.679757] R13: ffff8880507160f2 R14: dffffc0000000000 R15: ffffed100a0e2c1e
[ 226.680758] FS: 00007fdc217cc0c0(0000) GS:ffff88806c800000(0000) knlGS:0000000000000000
[ 226.681886] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 226.682719] CR2: 00007f49313424d0 CR3: 0000000050e46001 CR4: 00000000000606f0
[ 226.683727] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 226.684725] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 226.685681] Call Trace:
[ 226.687089] proc\_create\_seq\_private+0xb3/0xf0
[ 226.687778] bond\_create\_proc\_entry+0x1b3/0x3f0 [bonding]
[ 226.691458] bond\_netdev\_event+0x433/0x970 [bonding]
[ 226.692139] ? \_\_module\_text\_address+0x13/0x140
[ 226.692779] notifier\_call\_chain+0x90/0x160
[ 226.693401] register\_netdevice+0x9b3/0xd80
[ 226.694010] ? alloc\_netdev\_mqs+0x854/0xc10
[ 226.694629] ? netdev\_change\_features+0xa0/0xa0
[ 226.695278] ? rtnl\_create\_link+0x2ed/0xad0
[ 226.695849] bond\_newlink+0x2a/0x60 [bonding]
[ 226.696422] \_\_rtnl\_newlink+0xb9f/0x11b0
[ 226.696968] ? rtnl\_link\_unregister+0x220/0x220
[ ... ]
Fixes: 0b680e753724 ("[PATCH] bonding: Add priv\_flag to avoid event mishandling")
Signed-off-by: Taehee Yoo
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4c61d399b81e5ddb3aa61f43f60e8c40897f32e3
Author: Mark Zhang
Date: Sun Oct 20 09:28:00 2019 +0300
RDMA/nldev: Skip counter if port doesn't match
[ Upstream commit a15542bb72a48042f5df7475893d46f725f5f9fb ]
The counter resource should return -EAGAIN if it was requested for a
different port, this is similar to how QP works if the users provides a
port filter.
Otherwise port filtering in netlink will return broken counter nests.
Fixes: c4ffee7c9bdb ("RDMA/netlink: Implement counter dumpit calback")
Link: https://lore.kernel.org/r/20191020062800.8065-1-leon@kernel.org
Signed-off-by: Mark Zhang
Signed-off-by: Leon Romanovsky
Reviewed-by: Jason Gunthorpe
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit fa1ba958cd0c8fa9976ec2c854d81c17c6ee02a2
Author: wenxu
Date: Thu Oct 24 15:52:45 2019 +0800
netfilter: nft\_payload: fix missing check for matching length in offloads
[ Upstream commit a69a85da458f79088c38a38db034a4d64d9c32c3 ]
Payload offload rule should also check the length of the match.
Moreover, check for unsupported link-layer fields:
nft --debug=netlink add rule firewall zones vlan id 100
...
[ payload load 2b @ link header + 0 => reg 1 ]
this loads 2byte base on ll header and offset 0.
This also fixes unsupported raw payload match.
Fixes: 92ad6325cb89 ("netfilter: nf\_tables: add hardware offload support")
Signed-off-by: wenxu
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 0df80c1a109a88565f38961631dd7aba5d738405
Author: Eric Dumazet
Date: Wed Oct 23 09:53:03 2019 -0700
ipvs: move old\_secure\_tcp into struct netns\_ipvs
[ Upstream commit c24b75e0f9239e78105f81c5f03a751641eb07ef ]
syzbot reported the following issue :
BUG: KCSAN: data-race in update\_defense\_level / update\_defense\_level
read to 0xffffffff861a6260 of 4 bytes by task 3006 on cpu 1:
update\_defense\_level+0x621/0xb30 net/netfilter/ipvs/ip\_vs\_ctl.c:177
defense\_work\_handler+0x3d/0xd0 net/netfilter/ipvs/ip\_vs\_ctl.c:225
process\_one\_work+0x3d4/0x890 kernel/workqueue.c:2269
worker\_thread+0xa0/0x800 kernel/workqueue.c:2415
kthread+0x1d4/0x200 drivers/block/aoe/aoecmd.c:1253
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:352
write to 0xffffffff861a6260 of 4 bytes by task 7333 on cpu 0:
update\_defense\_level+0xa62/0xb30 net/netfilter/ipvs/ip\_vs\_ctl.c:205
defense\_work\_handler+0x3d/0xd0 net/netfilter/ipvs/ip\_vs\_ctl.c:225
process\_one\_work+0x3d4/0x890 kernel/workqueue.c:2269
worker\_thread+0xa0/0x800 kernel/workqueue.c:2415
kthread+0x1d4/0x200 drivers/block/aoe/aoecmd.c:1253
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:352
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 7333 Comm: kworker/0:5 Not tainted 5.4.0-rc3+ #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Workqueue: events defense\_work\_handler
Indeed, old\_secure\_tcp is currently a static variable, while it
needs to be a per netns variable.
Fixes: a0840e2e165a ("IPVS: netns, ip\_vs\_ctl local vars moved to ipvs struct.")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: Simon Horman
Signed-off-by: Sasha Levin
commit 529c302d6470c76c18982bd8b61a3c9c1efd7c07
Author: Davide Caratti
Date: Sat Oct 19 17:34:35 2019 +0200
ipvs: don't ignore errors in case refcounting ip\_vs module fails
[ Upstream commit 62931f59ce9cbabb934a431f48f2f1f441c605ac ]
if the IPVS module is removed while the sync daemon is starting, there is
a small gap where try\_module\_get() might fail getting the refcount inside
ip\_vs\_use\_count\_inc(). Then, the refcounts of IPVS module are unbalanced,
and the subsequent call to stop\_sync\_thread() causes the following splat:
WARNING: CPU: 0 PID: 4013 at kernel/module.c:1146 module\_put.part.44+0x15b/0x290
Modules linked in: ip\_vs(-) nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 veth ip6table\_filter ip6\_tables iptable\_filter binfmt\_misc intel\_rapl\_msr intel\_rapl\_common crct10dif\_pclmul crc32\_pclmul ext4 mbcache jbd2 ghash\_clmulni\_intel snd\_hda\_codec\_generic ledtrig\_audio snd\_hda\_intel snd\_intel\_nhlt snd\_hda\_codec snd\_hda\_core snd\_hwdep snd\_seq snd\_seq\_device snd\_pcm aesni\_intel crypto\_simd cryptd glue\_helper joydev pcspkr snd\_timer virtio\_balloon snd soundcore i2c\_piix4 nfsd auth\_rpcgss nfs\_acl lockd grace sunrpc ip\_tables xfs libcrc32c ata\_generic pata\_acpi virtio\_net net\_failover virtio\_blk failover virtio\_console qxl drm\_kms\_helper syscopyarea sysfillrect sysimgblt fb\_sys\_fops ata\_piix ttm crc32c\_intel serio\_raw drm virtio\_pci libata virtio\_ring virtio floppy dm\_mirror dm\_region\_hash dm\_log dm\_mod [last unloaded: nf\_defrag\_ipv6]
CPU: 0 PID: 4013 Comm: modprobe Tainted: G W 5.4.0-rc1.upstream+ #741
Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011
RIP: 0010:module\_put.part.44+0x15b/0x290
Code: 04 25 28 00 00 00 0f 85 18 01 00 00 48 83 c4 68 5b 5d 41 5c 41 5d 41 5e 41 5f c3 89 44 24 28 83 e8 01 89 c5 0f 89 57 ff ff ff <0f> 0b e9 78 ff ff ff 65 8b 1d 67 83 26 4a 89 db be 08 00 00 00 48
RSP: 0018:ffff888050607c78 EFLAGS: 00010297
RAX: 0000000000000003 RBX: ffffffffc1420590 RCX: ffffffffb5db0ef9
RDX: 0000000000000000 RSI: 0000000000000004 RDI: ffffffffc1420590
RBP: 00000000ffffffff R08: fffffbfff82840b3 R09: fffffbfff82840b3
R10: 0000000000000001 R11: fffffbfff82840b2 R12: 1ffff1100a0c0f90
R13: ffffffffc1420200 R14: ffff88804f533300 R15: ffff88804f533ca0
FS: 00007f8ea9720740(0000) GS:ffff888053800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f3245abe000 CR3: 000000004c28a006 CR4: 00000000001606f0
Call Trace:
stop\_sync\_thread+0x3a3/0x7c0 [ip\_vs]
ip\_vs\_sync\_net\_cleanup+0x13/0x50 [ip\_vs]
ops\_exit\_list.isra.5+0x94/0x140
unregister\_pernet\_operations+0x29d/0x460
unregister\_pernet\_device+0x26/0x60
ip\_vs\_cleanup+0x11/0x38 [ip\_vs]
\_\_x64\_sys\_delete\_module+0x2d5/0x400
do\_syscall\_64+0xa5/0x4e0
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x7f8ea8bf0db7
Code: 73 01 c3 48 8b 0d b9 80 2c 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 00 b8 b0 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 89 80 2c 00 f7 d8 64 89 01 48
RSP: 002b:00007ffcd38d2fe8 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
RAX: ffffffffffffffda RBX: 0000000002436240 RCX: 00007f8ea8bf0db7
RDX: 0000000000000000 RSI: 0000000000000800 RDI: 00000000024362a8
RBP: 0000000000000000 R08: 00007f8ea8eba060 R09: 00007f8ea8c658a0
R10: 00007ffcd38d2a60 R11: 0000000000000206 R12: 0000000000000000
R13: 0000000000000001 R14: 00000000024362a8 R15: 0000000000000000
irq event stamp: 4538
hardirqs last enabled at (4537): [] quarantine\_put+0x9e/0x170
hardirqs last disabled at (4538): [] trace\_hardirqs\_off\_thunk+0x1a/0x20
softirqs last enabled at (4522): [] sk\_common\_release+0x169/0x2d0
softirqs last disabled at (4520): [] sk\_common\_release+0xbe/0x2d0
Check the return value of ip\_vs\_use\_count\_inc() and let its caller return
proper error. Inside do\_ip\_vs\_set\_ctl() the module is already refcounted,
we don't need refcount/derefcount there. Finally, in register\_ip\_vs\_app()
and start\_sync\_thread(), take the module refcount earlier and ensure it's
released in the error path.
Change since v1:
- better return values in case of failure of ip\_vs\_use\_count\_inc(),
thanks to Julian Anastasov
- no need to increase/decrease the module refcount in ip\_vs\_set\_ctl(),
thanks to Julian Anastasov
Signed-off-by: Davide Caratti
Signed-off-by: Julian Anastasov
Signed-off-by: Simon Horman
Signed-off-by: Sasha Levin
commit e7e6965cdefe21f6947e3368f573ef574f5818e7
Author: Martin Fuzzey
Date: Wed Oct 23 11:44:24 2019 +0200
net: phy: smsc: LAN8740: add PHY\_RST\_AFTER\_CLK\_EN flag
[ Upstream commit 76db2d466f6a929a04775f0f87d837e3bcba44e8 ]
The LAN8740, like the 8720, also requires a reset after enabling clock.
The datasheet [1] 3.8.5.1 says:
"During a Hardware reset, an external clock must be supplied
to the XTAL1/CLKIN signal."
I have observed this issue on a custom i.MX6 based board with
the LAN8740A.
[1] http://ww1.microchip.com/downloads/en/DeviceDoc/8740a.pdf
Signed-off-by: Martin Fuzzey
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 16e024372ba3d563da9b5ab394a3e7e33535ee81
Author: Magnus Karlsson
Date: Mon Oct 21 10:16:58 2019 +0200
xsk: Fix registration of Rx-only sockets
[ Upstream commit 2afd23f78f39da84937006ecd24aa664a4ab052b ]
Having Rx-only AF\_XDP sockets can potentially lead to a crash in the
system by a NULL pointer dereference in xsk\_umem\_consume\_tx(). This
function iterates through a list of all sockets tied to a umem and
checks if there are any packets to send on the Tx ring. Rx-only
sockets do not have a Tx ring, so this will cause a NULL pointer
dereference. This will happen if you have registered one or more
Rx-only sockets to a umem and the driver is checking the Tx ring even
on Rx, or if the XDP\_SHARED\_UMEM mode is used and there is a mix of
Rx-only and other sockets tied to the same umem.
Fixed by only putting sockets with a Tx component on the list that
xsk\_umem\_consume\_tx() iterates over.
Fixes: ac98d8aab61b ("xsk: wire upp Tx zero-copy functions")
Reported-by: Kal Cutter Conley
Signed-off-by: Magnus Karlsson
Signed-off-by: Alexei Starovoitov
Acked-by: Jonathan Lemon
Link: https://lore.kernel.org/bpf/1571645818-16244-1-git-send-email-magnus.karlsson@intel.com
Signed-off-by: Sasha Levin
commit 43ed09d84c7def99b38075b4f553d543b68afcd7
Author: Navid Emamdoost
Date: Mon Oct 21 13:52:49 2019 -0500
drm/v3d: Fix memory leak in v3d\_submit\_cl\_ioctl
[ Upstream commit 29cd13cfd7624726d9e6becbae9aa419ef35af7f ]
In the impelementation of v3d\_submit\_cl\_ioctl() there are two memory
leaks. One is when allocation for bin fails, and the other is when bin
initialization fails. If kcalloc fails to allocate memory for bin then
render->base should be put. Also, if v3d\_job\_init() fails to initialize
bin->base then allocated memory for bin should be released.
Fixes: a783a09ee76d ("drm/v3d: Refactor job management.")
Signed-off-by: Navid Emamdoost
Reviewed-by: Eric Anholt
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20191021185250.26130-1-navid.emamdoost@gmail.com
Signed-off-by: Sasha Levin
commit 4df6b9f49d3c6e9c6b658f4f01b896bce7698bca
Author: Pablo Neira Ayuso
Date: Mon Oct 14 11:03:15 2019 +0200
netfilter: nf\_flow\_table: set timeout before insertion into hashes
[ Upstream commit daf61b026f4686250e6afa619e6d7b49edc61df7 ]
Other garbage collector might remove an entry not fully set up yet.
[570953.958293] RIP: 0010:memcmp+0x9/0x50
[...]
[570953.958567] flow\_offload\_hash\_cmp+0x1e/0x30 [nf\_flow\_table]
[570953.958585] flow\_offload\_lookup+0x8c/0x110 [nf\_flow\_table]
[570953.958606] nf\_flow\_offload\_ip\_hook+0x135/0xb30 [nf\_flow\_table]
[570953.958624] nf\_flow\_offload\_inet\_hook+0x35/0x37 [nf\_flow\_table\_inet]
[570953.958646] nf\_hook\_slow+0x3c/0xb0
[570953.958664] \_\_netif\_receive\_skb\_core+0x90f/0xb10
[570953.958678] ? ip\_rcv\_finish+0x82/0xa0
[570953.958692] \_\_netif\_receive\_skb\_one\_core+0x3b/0x80
[570953.958711] \_\_netif\_receive\_skb+0x18/0x60
[570953.958727] netif\_receive\_skb\_internal+0x45/0xf0
[570953.958741] napi\_gro\_receive+0xcd/0xf0
[570953.958764] ixgbe\_clean\_rx\_irq+0x432/0xe00 [ixgbe]
[570953.958782] ixgbe\_poll+0x27b/0x700 [ixgbe]
[570953.958796] net\_rx\_action+0x284/0x3c0
[570953.958817] \_\_do\_softirq+0xcc/0x27c
[570953.959464] irq\_exit+0xe8/0x100
[570953.960097] do\_IRQ+0x59/0xe0
[570953.960734] common\_interrupt+0xf/0xf
Fixes: 43c8f131184f ("netfilter: nf\_flow\_table: fix missing error check for rhashtable\_insert\_fast")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit d4c27320c89be036cd6a31b6a2fec010c6f17822
Author: Luca Coelho
Date: Sat Oct 19 13:03:31 2019 +0300
iwlwifi: pcie: 0x2720 is qu and 0x30DC is not
[ Upstream commit 17c216ed6b9eef34e647192063f6149d33eff579 ]
When converting the wrong qu configurations in an earlier commit, I
accidentally swapped 0x2720 and 0x30DC. Instead of converting 0x2720,
I converted 0x30DC. Undo 0x30DC and convert 0x2720.
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
commit b6a33a44d7fa0b7a55f511d3c0ec9bd70e82a055
Author: Luca Coelho
Date: Sat Oct 19 13:03:28 2019 +0300
iwlwifi: pcie: fix all 9460 entries for qnj
[ Upstream commit e55890150a961944e861a46efc8599f80f25de76 ]
A bunch of the entries for qnj were wrong. The 9460 device doesn't
exist, so update them to 9461 and 9462. There are still a bunch of
other occurrences of 9460, but that will be fixed separately.
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
commit 19be57ee528ed93d8fc25779332e2c196f0d10bd
Author: Luca Coelho
Date: Sat Oct 19 13:03:27 2019 +0300
iwlwifi: pcie: fix PCI ID 0x2720 configs that should be soc
[ Upstream commit 6dea7da7019aa04c02edf1878c9c2e59d6cb75a5 ]
Some entries for PCI ID 0x2720 were using iwl9260\_2ac\_cfg, but the
correct is to use iwl9260\_2ac\_cfg\_soc. Fix that.
Signed-off-by: Luca Coelho
Signed-off-by: Kalle Valo
Signed-off-by: Sasha Levin
commit 4ab5cba443278b2605fcb51b9c3c8d4c1966d622
Author: Daniel Borkmann
Date: Tue Oct 22 23:30:38 2019 +0200
bpf: Fix use after free in bpf\_get\_prog\_name
[ Upstream commit 3b4d9eb2ee74dd5ea7fa36cffb0ca7f5bc4924da ]
There is one more problematic case I noticed while recently fixing BPF kallsyms
handling in cd7455f1013e ("bpf: Fix use after free in subprog's jited symbol
removal") and that is bpf\_get\_prog\_name().
If BTF has been attached to the prog, then we may be able to fetch the function
signature type id in kallsyms through prog->aux->func\_info[prog->aux->func\_idx].type\_id.
However, while the BTF object itself is torn down via RCU callback, the prog's
aux->func\_info is immediately freed via kvfree(prog->aux->func\_info) once the
prog's refcount either hit zero or when subprograms were already exposed via
kallsyms and we hit the error path added in 5482e9a93c83 ("bpf: Fix memleak in
aux->func\_info and aux->btf").
This violates RCU as well since kallsyms could be walked in parallel where we
could access aux->func\_info. Hence, defer kvfree() to after RCU grace period.
Looking at ba64e7d85252 ("bpf: btf: support proper non-jit func info") there
is no reason/dependency where we couldn't defer the kvfree(aux->func\_info) into
the RCU callback.
Fixes: 5482e9a93c83 ("bpf: Fix memleak in aux->func\_info and aux->btf")
Fixes: ba64e7d85252 ("bpf: btf: support proper non-jit func info")
Signed-off-by: Daniel Borkmann
Signed-off-by: Alexei Starovoitov
Acked-by: Yonghong Song
Cc: Martin KaFai Lau
Link: https://lore.kernel.org/bpf/875f2906a7c1a0691f2d567b4d8e4ea2739b1e88.1571779205.git.daniel@iogearbox.net
Signed-off-by: Sasha Levin
commit 912bcdcac4f3ae2bb76f0ec1556513eaca77322c
Author: Himanshu Madhani
Date: Tue Oct 22 12:36:42 2019 -0700
scsi: qla2xxx: Initialized mailbox to prevent driver load failure
[ Upstream commit c2ff2a36eff60efb5e123c940115216d6bf65684 ]
This patch fixes issue with Gen7 adapter in a blade environment where one
of the ports will not be detected by driver. Firmware expects mailbox 11 to
be set or cleared by driver for newer ISP.
Following message is seen in the log file:
[ 18.810892] qla2xxx [0000:d8:00.0]-1820:1: \*\*\*\* Failed=102 mb[0]=4005 mb[1]=37 mb[2]=20 mb[3]=8
[ 18.819596] cmd=2 \*\*\*\*
[mkp: typos]
Link: https://lore.kernel.org/r/20191022193643.7076-2-hmadhani@marvell.com
Signed-off-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 3c7a8ffd9d0759ff99c41850544f217a7f48b9aa
Author: Daniel Wagner
Date: Tue Oct 22 09:21:12 2019 +0200
scsi: lpfc: Honor module parameter lpfc\_use\_adisc
[ Upstream commit 0fd103ccfe6a06e40e2d9d8c91d96332cc9e1239 ]
The initial lpfc\_desc\_set\_adisc implementation in commit
dea3101e0a5c ("lpfc: add Emulex FC driver version 8.0.28") enabled ADISC if
cfg\_use\_adisc && RSCN\_MODE && FCP\_2\_DEVICE
In commit 92d7f7b0cde3 ("[SCSI] lpfc: NPIV: add NPIV support on top of
SLI-3") this changed to
(cfg\_use\_adisc && RSC\_MODE) || FCP\_2\_DEVICE
and later in commit ffc954936b13 ("[SCSI] lpfc 8.3.13: FC Discovery Fixes
and enhancements.") to
(cfg\_use\_adisc && RSC\_MODE) || (FCP\_2\_DEVICE && FCP\_TARGET)
A customer reports that after a devloss, an ADISC failure is logged. It
turns out the ADISC flag is set even the user explicitly set lpfc\_use\_adisc
= 0.
[Sat Dec 22 22:55:58 2018] lpfc 0000:82:00.0: 2:(0):0203 Devloss timeout on WWPN 50:01:43:80:12:8e:40:20 NPort x05df00 Data: x82000000 x8 xa
[Sat Dec 22 23:08:20 2018] lpfc 0000:82:00.0: 2:(0):2755 ADISC failure DID:05DF00 Status:x9/x70000
[mkp: fixed Hannes' email]
Fixes: 92d7f7b0cde3 ("[SCSI] lpfc: NPIV: add NPIV support on top of SLI-3")
Cc: Dick Kennedy
Cc: James Smart
Link: https://lore.kernel.org/r/20191022072112.132268-1-dwagner@suse.de
Reviewed-by: Hannes Reinecke
Reviewed-by: James Smart
Signed-off-by: Daniel Wagner
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 46f8579b63edba8d1d64a959aecdb68b3e15c6ca
Author: Hillf Danton
Date: Mon Oct 21 12:01:57 2019 +0200
net: openvswitch: free vport unless register\_netdevice() succeeds
[ Upstream commit 9464cc37f3671ee69cb1c00662b5e1f113a96b23 ]
syzbot found the following crash on:
HEAD commit: 1e78030e Merge tag 'mmc-v5.3-rc1' of git://git.kernel.org/..
git tree: upstream
console output: https://syzkaller.appspot.com/x/log.txt?x=148d3d1a600000
kernel config: https://syzkaller.appspot.com/x/.config?x=30cef20daf3e9977
dashboard link: https://syzkaller.appspot.com/bug?extid=13210896153522fe1ee5
compiler: gcc (GCC) 9.0.0 20181231 (experimental)
syz repro: https://syzkaller.appspot.com/x/repro.syz?x=136aa8c4600000
C reproducer: https://syzkaller.appspot.com/x/repro.c?x=109ba792600000
=====================================================================
BUG: memory leak
unreferenced object 0xffff8881207e4100 (size 128):
comm "syz-executor032", pid 7014, jiffies 4294944027 (age 13.830s)
hex dump (first 32 bytes):
00 70 16 18 81 88 ff ff 80 af 8c 22 81 88 ff ff .p........."....
00 b6 23 17 81 88 ff ff 00 00 00 00 00 00 00 00 ..#.............
backtrace:
[<000000000eb78212>] kmemleak\_alloc\_recursive include/linux/kmemleak.h:43 [inline]
[<000000000eb78212>] slab\_post\_alloc\_hook mm/slab.h:522 [inline]
[<000000000eb78212>] slab\_alloc mm/slab.c:3319 [inline]
[<000000000eb78212>] kmem\_cache\_alloc\_trace+0x145/0x2c0 mm/slab.c:3548
[<00000000006ea6c6>] kmalloc include/linux/slab.h:552 [inline]
[<00000000006ea6c6>] kzalloc include/linux/slab.h:748 [inline]
[<00000000006ea6c6>] ovs\_vport\_alloc+0x37/0xf0 net/openvswitch/vport.c:130
[<00000000f9a04a7d>] internal\_dev\_create+0x24/0x1d0 net/openvswitch/vport-internal\_dev.c:164
[<0000000056ee7c13>] ovs\_vport\_add+0x81/0x190 net/openvswitch/vport.c:199
[<000000005434efc7>] new\_vport+0x19/0x80 net/openvswitch/datapath.c:194
[<00000000b7b253f1>] ovs\_dp\_cmd\_new+0x22f/0x410 net/openvswitch/datapath.c:1614
[<00000000e0988518>] genl\_family\_rcv\_msg+0x2ab/0x5b0 net/netlink/genetlink.c:629
[<00000000d0cc9347>] genl\_rcv\_msg+0x54/0x9c net/netlink/genetlink.c:654
[<000000006694b647>] netlink\_rcv\_skb+0x61/0x170 net/netlink/af\_netlink.c:2477
[<0000000088381f37>] genl\_rcv+0x29/0x40 net/netlink/genetlink.c:665
[<00000000dad42a47>] netlink\_unicast\_kernel net/netlink/af\_netlink.c:1302 [inline]
[<00000000dad42a47>] netlink\_unicast+0x1ec/0x2d0 net/netlink/af\_netlink.c:1328
[<0000000067e6b079>] netlink\_sendmsg+0x270/0x480 net/netlink/af\_netlink.c:1917
[<00000000aab08a47>] sock\_sendmsg\_nosec net/socket.c:637 [inline]
[<00000000aab08a47>] sock\_sendmsg+0x54/0x70 net/socket.c:657
[<000000004cb7c11d>] \_\_\_sys\_sendmsg+0x393/0x3c0 net/socket.c:2311
[<00000000c4901c63>] \_\_sys\_sendmsg+0x80/0xf0 net/socket.c:2356
[<00000000c10abb2d>] \_\_do\_sys\_sendmsg net/socket.c:2365 [inline]
[<00000000c10abb2d>] \_\_se\_sys\_sendmsg net/socket.c:2363 [inline]
[<00000000c10abb2d>] \_\_x64\_sys\_sendmsg+0x23/0x30 net/socket.c:2363
BUG: memory leak
unreferenced object 0xffff88811723b600 (size 64):
comm "syz-executor032", pid 7014, jiffies 4294944027 (age 13.830s)
hex dump (first 32 bytes):
01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 02 00 00 00 05 35 82 c1 .............5..
backtrace:
[<00000000352f46d8>] kmemleak\_alloc\_recursive include/linux/kmemleak.h:43 [inline]
[<00000000352f46d8>] slab\_post\_alloc\_hook mm/slab.h:522 [inline]
[<00000000352f46d8>] slab\_alloc mm/slab.c:3319 [inline]
[<00000000352f46d8>] \_\_do\_kmalloc mm/slab.c:3653 [inline]
[<00000000352f46d8>] \_\_kmalloc+0x169/0x300 mm/slab.c:3664
[<000000008e48f3d1>] kmalloc include/linux/slab.h:557 [inline]
[<000000008e48f3d1>] ovs\_vport\_set\_upcall\_portids+0x54/0xd0 net/openvswitch/vport.c:343
[<00000000541e4f4a>] ovs\_vport\_alloc+0x7f/0xf0 net/openvswitch/vport.c:139
[<00000000f9a04a7d>] internal\_dev\_create+0x24/0x1d0 net/openvswitch/vport-internal\_dev.c:164
[<0000000056ee7c13>] ovs\_vport\_add+0x81/0x190 net/openvswitch/vport.c:199
[<000000005434efc7>] new\_vport+0x19/0x80 net/openvswitch/datapath.c:194
[<00000000b7b253f1>] ovs\_dp\_cmd\_new+0x22f/0x410 net/openvswitch/datapath.c:1614
[<00000000e0988518>] genl\_family\_rcv\_msg+0x2ab/0x5b0 net/netlink/genetlink.c:629
[<00000000d0cc9347>] genl\_rcv\_msg+0x54/0x9c net/netlink/genetlink.c:654
[<000000006694b647>] netlink\_rcv\_skb+0x61/0x170 net/netlink/af\_netlink.c:2477
[<0000000088381f37>] genl\_rcv+0x29/0x40 net/netlink/genetlink.c:665
[<00000000dad42a47>] netlink\_unicast\_kernel net/netlink/af\_netlink.c:1302 [inline]
[<00000000dad42a47>] netlink\_unicast+0x1ec/0x2d0 net/netlink/af\_netlink.c:1328
[<0000000067e6b079>] netlink\_sendmsg+0x270/0x480 net/netlink/af\_netlink.c:1917
[<00000000aab08a47>] sock\_sendmsg\_nosec net/socket.c:637 [inline]
[<00000000aab08a47>] sock\_sendmsg+0x54/0x70 net/socket.c:657
[<000000004cb7c11d>] \_\_\_sys\_sendmsg+0x393/0x3c0 net/socket.c:2311
[<00000000c4901c63>] \_\_sys\_sendmsg+0x80/0xf0 net/socket.c:2356
BUG: memory leak
unreferenced object 0xffff8881228ca500 (size 128):
comm "syz-executor032", pid 7015, jiffies 4294944622 (age 7.880s)
hex dump (first 32 bytes):
00 f0 27 18 81 88 ff ff 80 ac 8c 22 81 88 ff ff ..'........"....
40 b7 23 17 81 88 ff ff 00 00 00 00 00 00 00 00 @.#.............
backtrace:
[<000000000eb78212>] kmemleak\_alloc\_recursive include/linux/kmemleak.h:43 [inline]
[<000000000eb78212>] slab\_post\_alloc\_hook mm/slab.h:522 [inline]
[<000000000eb78212>] slab\_alloc mm/slab.c:3319 [inline]
[<000000000eb78212>] kmem\_cache\_alloc\_trace+0x145/0x2c0 mm/slab.c:3548
[<00000000006ea6c6>] kmalloc include/linux/slab.h:552 [inline]
[<00000000006ea6c6>] kzalloc include/linux/slab.h:748 [inline]
[<00000000006ea6c6>] ovs\_vport\_alloc+0x37/0xf0 net/openvswitch/vport.c:130
[<00000000f9a04a7d>] internal\_dev\_create+0x24/0x1d0 net/openvswitch/vport-internal\_dev.c:164
[<0000000056ee7c13>] ovs\_vport\_add+0x81/0x190 net/openvswitch/vport.c:199
[<000000005434efc7>] new\_vport+0x19/0x80 net/openvswitch/datapath.c:194
[<00000000b7b253f1>] ovs\_dp\_cmd\_new+0x22f/0x410 net/openvswitch/datapath.c:1614
[<00000000e0988518>] genl\_family\_rcv\_msg+0x2ab/0x5b0 net/netlink/genetlink.c:629
[<00000000d0cc9347>] genl\_rcv\_msg+0x54/0x9c net/netlink/genetlink.c:654
[<000000006694b647>] netlink\_rcv\_skb+0x61/0x170 net/netlink/af\_netlink.c:2477
[<0000000088381f37>] genl\_rcv+0x29/0x40 net/netlink/genetlink.c:665
[<00000000dad42a47>] netlink\_unicast\_kernel net/netlink/af\_netlink.c:1302 [inline]
[<00000000dad42a47>] netlink\_unicast+0x1ec/0x2d0 net/netlink/af\_netlink.c:1328
[<0000000067e6b079>] netlink\_sendmsg+0x270/0x480 net/netlink/af\_netlink.c:1917
[<00000000aab08a47>] sock\_sendmsg\_nosec net/socket.c:637 [inline]
[<00000000aab08a47>] sock\_sendmsg+0x54/0x70 net/socket.c:657
[<000000004cb7c11d>] \_\_\_sys\_sendmsg+0x393/0x3c0 net/socket.c:2311
[<00000000c4901c63>] \_\_sys\_sendmsg+0x80/0xf0 net/socket.c:2356
[<00000000c10abb2d>] \_\_do\_sys\_sendmsg net/socket.c:2365 [inline]
[<00000000c10abb2d>] \_\_se\_sys\_sendmsg net/socket.c:2363 [inline]
[<00000000c10abb2d>] \_\_x64\_sys\_sendmsg+0x23/0x30 net/socket.c:2363
=====================================================================
The function in net core, register\_netdevice(), may fail with vport's
destruction callback either invoked or not. After commit 309b66970ee2
("net: openvswitch: do not free vport if register\_netdevice() is failed."),
the duty to destroy vport is offloaded from the driver OTOH, which ends
up in the memory leak reported.
It is fixed by releasing vport unless device is registered successfully.
To do that, the callback assignment is defered until device is registered.
Reported-by: syzbot+13210896153522fe1ee5@syzkaller.appspotmail.com
Fixes: 309b66970ee2 ("net: openvswitch: do not free vport if register\_netdevice() is failed.")
Cc: Taehee Yoo
Cc: Greg Rose
Cc: Eric Dumazet
Cc: Marcelo Ricardo Leitner
Cc: Ying Xue
Cc: Andrey Konovalov
Signed-off-by: Hillf Danton
Acked-by: Pravin B Shelar
[sbrivio: this was sent to dev@openvswitch.org and never made its way
to netdev -- resending original patch]
Signed-off-by: Stefano Brivio
Reviewed-by: Greg Rose
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9fd8ecf10b9cf44efc6d70791df3e1857598fb76
Author: yuqi jin
Date: Mon Oct 21 11:27:34 2019 +0800
net: stmmac: Fix the problem of tso\_xmit
[ Upstream commit 34c15202896d11e3974788daf9005a84ec45f7a2 ]
When the address width of DMA is greater than 32, the packet header occupies
a BD descriptor. The starting address of the data should be added to the
header length.
Fixes: a993db88d17d ("net: stmmac: Enable support for > 32 Bits addressing in XGMAC")
Cc: Eric Dumazet
Cc: Giuseppe Cavallaro
Cc: Alexandre Torgue
Cc: Jose Abreu
Cc: "David S. Miller"
Cc: Maxime Coquelin
Signed-off-by: yuqi jin
Signed-off-by: Shaokun Zhang
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit ddb34ab36bad09885de9dad21e74b9b80b3c324c
Author: Daniel Borkmann
Date: Tue Oct 22 15:57:23 2019 +0200
bpf: Fix use after free in subprog's jited symbol removal
[ Upstream commit cd7455f1013ef96d5cbf5c05d2b7c06f273810a6 ]
syzkaller managed to trigger the following crash:
[...]
BUG: unable to handle page fault for address: ffffc90001923030
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD aa551067 P4D aa551067 PUD aa552067 PMD a572b067 PTE 80000000a1173163
Oops: 0000 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 7982 Comm: syz-executor912 Not tainted 5.4.0-rc3+ #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:bpf\_jit\_binary\_hdr include/linux/filter.h:787 [inline]
RIP: 0010:bpf\_get\_prog\_addr\_region kernel/bpf/core.c:531 [inline]
RIP: 0010:bpf\_tree\_comp kernel/bpf/core.c:600 [inline]
RIP: 0010:\_\_lt\_find include/linux/rbtree\_latch.h:115 [inline]
RIP: 0010:latch\_tree\_find include/linux/rbtree\_latch.h:208 [inline]
RIP: 0010:bpf\_prog\_kallsyms\_find kernel/bpf/core.c:674 [inline]
RIP: 0010:is\_bpf\_text\_address+0x184/0x3b0 kernel/bpf/core.c:709
[...]
Call Trace:
kernel\_text\_address kernel/extable.c:147 [inline]
\_\_kernel\_text\_address+0x9a/0x110 kernel/extable.c:102
unwind\_get\_return\_address+0x4c/0x90 arch/x86/kernel/unwind\_frame.c:19
arch\_stack\_walk+0x98/0xe0 arch/x86/kernel/stacktrace.c:26
stack\_trace\_save+0xb6/0x150 kernel/stacktrace.c:123
save\_stack mm/kasan/common.c:69 [inline]
set\_track mm/kasan/common.c:77 [inline]
\_\_kasan\_kmalloc+0x11c/0x1b0 mm/kasan/common.c:510
kasan\_slab\_alloc+0xf/0x20 mm/kasan/common.c:518
slab\_post\_alloc\_hook mm/slab.h:584 [inline]
slab\_alloc mm/slab.c:3319 [inline]
kmem\_cache\_alloc+0x1f5/0x2e0 mm/slab.c:3483
getname\_flags+0xba/0x640 fs/namei.c:138
getname+0x19/0x20 fs/namei.c:209
do\_sys\_open+0x261/0x560 fs/open.c:1091
\_\_do\_sys\_open fs/open.c:1115 [inline]
\_\_se\_sys\_open fs/open.c:1110 [inline]
\_\_x64\_sys\_open+0x87/0x90 fs/open.c:1110
do\_syscall\_64+0xf7/0x1c0 arch/x86/entry/common.c:290
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
[...]
After further debugging it turns out that we walk kallsyms while in parallel
we tear down a BPF program which contains subprograms that have been JITed
though the program itself has not been fully exposed and is eventually bailing
out with error.
The bpf\_prog\_kallsyms\_del\_subprogs() in bpf\_prog\_load()'s error path removes
the symbols, however, bpf\_prog\_free() tears down the JIT memory too early via
scheduled work. Instead, it needs to properly respect RCU grace period as the
kallsyms walk for BPF is under RCU.
Fix it by refactoring \_\_bpf\_prog\_put()'s tear down and reuse it in our error
path where we defer final destruction when we have subprogs in the program.
Fixes: 7d1982b4e335 ("bpf: fix panic in prog load calls cleanup")
Fixes: 1c2a088a6626 ("bpf: x64: add JIT support for multi-function programs")
Reported-by: syzbot+710043c5d1d5b5013bc7@syzkaller.appspotmail.com
Signed-off-by: Daniel Borkmann
Signed-off-by: Alexei Starovoitov
Tested-by: syzbot+710043c5d1d5b5013bc7@syzkaller.appspotmail.com
Link: https://lore.kernel.org/bpf/55f6367324c2d7e9583fa9ccf5385dcbba0d7a6e.1571752452.git.daniel@iogearbox.net
Signed-off-by: Sasha Levin
commit 0c18bcfc793a30dada2b8343b9b5a3fc70c742de
Author: Dan Carpenter
Date: Fri Oct 11 16:34:19 2019 +0300
RDMA/uverbs: Prevent potential underflow
[ Upstream commit a9018adfde809d44e71189b984fa61cc89682b5e ]
The issue is in drivers/infiniband/core/uverbs\_std\_types\_cq.c in the
UVERBS\_HANDLER(UVERBS\_METHOD\_CQ\_CREATE) function. We check that:
if (attr.comp\_vector >= attrs->ufile->device->num\_comp\_vectors) {
But we don't check if "attr.comp\_vector" is negative. It could
potentially lead to an array underflow. My concern would be where
cq->vector is used in the create\_cq() function from the cxgb4 driver.
And really "attr.comp\_vector" is appears as a u32 to user space so that's
the right type to use.
Fixes: 9ee79fce3642 ("IB/core: Add completion queue (cq) object actions")
Link: https://lore.kernel.org/r/20191011133419.GA22905@mwanda
Signed-off-by: Dan Carpenter
Reviewed-by: Jason Gunthorpe
Signed-off-by: Jason Gunthorpe
Signed-off-by: Sasha Levin
commit 40e8486c143eeaae6f7b7e3454e2f4e0e628801b
Author: Eugeniy Paltsev
Date: Fri Oct 18 14:11:25 2019 +0300
ARC: [plat-hsdk]: Enable on-board SPI NOR flash IC
[ Upstream commit 8ca8fa7f22dcb0a3265490a690b0c3e27de681f9 ]
HSDK board has sst26wf016b SPI NOR flash IC installed, enable it.
Acked-by: Alexey Brodkin
Signed-off-by: Eugeniy Paltsev
Signed-off-by: Vineet Gupta
Signed-off-by: Sasha Levin
commit 24665ff0d06a6bdf3e9abe1b558d1efb38c38c33
Author: Avri Altman
Date: Thu Oct 10 11:31:07 2019 +0300
scsi: ufs-bsg: Wake the device before sending raw upiu commands
[ Upstream commit 74e5e468b664d3739b2872d54764af97ac38e795 ]
The scsi async probe process is calling blk\_pm\_runtime\_init for each lun,
and then those request queues are monitored by the block layer pm
engine (blk-pm.c). This is however, not the case for scsi-passthrough
queues, created by bsg\_setup\_queue().
So the ufs-bsg driver might send various commands, disregarding the pm
status of the device. This is wrong, regardless if its request queue is
pm-aware or not.
Fixes: df032bf27a41 (scsi: ufs: Add a bsg endpoint that supports UPIUs)
Link: https://lore.kernel.org/r/1570696267-8487-1-git-send-email-avri.altman@wdc.com
Reported-by: Yuliy Izrailov
Signed-off-by: Avri Altman
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 7153621da5cd0dc1be00fb5caa63e24d18782914
Author: Daniel Wagner
Date: Fri Oct 18 18:21:11 2019 +0200
scsi: lpfc: Check queue pointer before use
[ Upstream commit 535fb49e730a6fe1e9f11af4ae67ef4228ff4287 ]
The queue pointer might not be valid. The rest of the code checks the
pointer before accessing it. lpfc\_sli4\_process\_missed\_mbox\_completions is
the only place where the check is missing.
Fixes: 657add4e5e15 ("scsi: lpfc: Fix poor use of hardware queues if fewer irq vectors")
Cc: James Smart
Link: https://lore.kernel.org/r/20191018162111.8798-1-dwagner@suse.de
Signed-off-by: Daniel Wagner
Reviewed-by: James Smart
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit cce90d648943e311e4d06f15a35e754c5f53914f
Author: Hannes Reinecke
Date: Fri Oct 18 16:04:58 2019 +0200
scsi: qla2xxx: fixup incorrect usage of host\_byte
[ Upstream commit 66cf50e65b183c863825f5c28a818e3f47a72e40 ]
DRIVER\_ERROR is a a driver byte setting, not a host byte. The qla2xxx
driver should rather return DID\_ERROR here to be in line with the other
drivers.
Link: https://lore.kernel.org/r/20191018140458.108278-1-hare@suse.de
Signed-off-by: Hannes Reinecke
Acked-by: Himanshu Madhani
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 690a68940a8ba50fd4bbae6976d181039a83547c
Author: Jiri Benc
Date: Fri Oct 18 14:00:42 2019 +0200
selftests/bpf: More compatible nc options in test\_tc\_edt
[ Upstream commit 11875ba7f251c52effb2b924e04c2ddefa9856ef ]
Out of the three nc implementations widely in use, at least two (BSD netcat
and nmap-ncat) do not support -l combined with -s. Modify the nc invocation
to be accepted by all of them.
Fixes: 7df5e3db8f63 ("selftests: bpf: tc-bpf flow shaping with EDT")
Signed-off-by: Jiri Benc
Signed-off-by: Daniel Borkmann
Acked-by: Peter Oskolkov
Link: https://lore.kernel.org/bpf/f5bf07dccd8b552a76c84d49e80b86c5aa071122.1571400024.git.jbenc@redhat.com
Signed-off-by: Sasha Levin
commit 38dc6b5959af978740b50a50ca229f73f701b578
Author: Navid Emamdoost
Date: Fri Sep 27 17:37:28 2019 -0500
net/mlx5: fix memory leak in mlx5\_fw\_fatal\_reporter\_dump
[ Upstream commit c7ed6d0183d5ea9bc31bcaeeba4070bd62546471 ]
In mlx5\_fw\_fatal\_reporter\_dump if mlx5\_crdump\_collect fails the
allocated memory for cr\_data must be released otherwise there will be
memory leak. To fix this, this commit changes the return instruction
into goto error handling.
Fixes: 9b1f29823605 ("net/mlx5: Add support for FW fatal reporter dump")
Signed-off-by: Navid Emamdoost
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 666adb04e4f98a073017e9b3f5a0483a326b9587
Author: Navid Emamdoost
Date: Tue Sep 24 22:20:34 2019 -0500
net/mlx5: prevent memory leak in mlx5\_fpga\_conn\_create\_cq
[ Upstream commit c8c2a057fdc7de1cd16f4baa51425b932a42eb39 ]
In mlx5\_fpga\_conn\_create\_cq if mlx5\_vector2eqn fails the allocated
memory should be released.
Fixes: 537a50574175 ("net/mlx5: FPGA, Add high-speed connection routines")
Signed-off-by: Navid Emamdoost
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 8e24313f70e789166ff8e64fd8ce6ff4591dc742
Author: Tariq Toukan
Date: Tue Sep 24 11:29:09 2019 +0300
net/mlx5e: TX, Fix consumer index of error cqe dump
[ Upstream commit 61ea02d2c13106116c6e4916ac5d9dd41151c959 ]
The completion queue consumer index increments upon a call to
mlx5\_cqwq\_pop().
When dumping an error CQE, the index is already incremented.
Decrease one for the print command.
Fixes: 16cc14d81733 ("net/mlx5e: Dump xmit error completions")
Signed-off-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 7bf82947c2a79aef7e561ce654b276d753a05483
Author: Tariq Toukan
Date: Wed Sep 18 13:45:38 2019 +0300
net/mlx5e: kTLS, Release reference on DUMPed fragments in shutdown flow
[ Upstream commit 2c559361389b452ca23494080d0c65ab812706c1 ]
A call to kTLS completion handler was missing in the TXQSQ release
flow. Add it.
Fixes: d2ead1f360e8 ("net/mlx5e: Add kTLS TX HW offload support")
Signed-off-by: Tariq Toukan
Reviewed-by: Eran Ben Elisha
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 0dc9c29cfad04129fcc33af89fa274941d8c61d8
Author: Tariq Toukan
Date: Mon Sep 16 17:43:33 2019 +0300
net/mlx5e: Tx, Fix assumption of single WQEBB of NOP in cleanup flow
[ Upstream commit 0c258dec8d98af15b34dbffdb89c008b6da01ff8 ]
Cited patch removed the assumption only in datapath.
Here we remove it also form control/cleanup flow.
Fixes: 9ab0233728ca ("net/mlx5e: Tx, Don't implicitly assume SKB-less wqe has one WQEBB")
Signed-off-by: Tariq Toukan
Reviewed-by: Eran Ben Elisha
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 40599d1a46afc43a340b8f5aa1659dafedc47fd1
Author: Parav Pandit
Date: Wed Oct 2 15:17:50 2019 +0300
IB/core: Use rdma\_read\_gid\_l2\_fields to compare GID L2 fields
[ Upstream commit 777a8b32bc0f9bb25848a025f72a9febc30d9033 ]
Current code tries to derive VLAN ID and compares it with GID
attribute for matching entry. This raw search fails on macvlan
netdevice as its not a VLAN device, but its an upper device of a VLAN
netdevice.
Due to this limitation, incoming QP1 packets fail to match in the
GID table. Such packets are dropped.
Hence, to support it, use the existing rdma\_read\_gid\_l2\_fields()
that takes care of diffferent device types.
Fixes: dbf727de7440 ("IB/core: Use GID table in AH creation and dmac resolution")
Signed-off-by: Parav Pandit
Signed-off-by: Leon Romanovsky
Link: https://lore.kernel.org/r/20191002121750.17313-1-leon@kernel.org
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit 4a3cf2bc157d63918d28a98f149c4087b60d871e
Author: Kamal Heib
Date: Tue Oct 8 00:07:30 2019 +0300
RDMA/qedr: Fix reported firmware version
[ Upstream commit b806c94ee44e53233b8ce6c92d9078d9781786a5 ]
Remove spaces from the reported firmware version string.
Actual value:
$ cat /sys/class/infiniband/qedr0/fw\_ver
8. 37. 7. 0
Expected value:
$ cat /sys/class/infiniband/qedr0/fw\_ver
8.37.7.0
Fixes: ec72fce401c6 ("qedr: Add support for RoCE HW init")
Signed-off-by: Kamal Heib
Acked-by: Michal Kalderon
Link: https://lore.kernel.org/r/20191007210730.7173-1-kamalheib1@gmail.com
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit ddf04b2db94fda7e8f5bbacb091be05eb2fef757
Author: Krishnamraju Eraparaju
Date: Mon Oct 7 16:12:29 2019 +0530
RDMA/siw: free siw\_base\_qp in kref release routine
[ Upstream commit e17fa5c95ef2434a08e0be217969d246d037f0c2 ]
As siw\_free\_qp() is the last routine to access 'siw\_base\_qp' structure,
freeing this structure early in siw\_destroy\_qp() could cause
touch-after-free issue.
Hence, moved kfree(siw\_base\_qp) from siw\_destroy\_qp() to siw\_free\_qp().
Fixes: 303ae1cdfdf7 ("rdma/siw: application interface")
Signed-off-by: Krishnamraju Eraparaju
Link: https://lore.kernel.org/r/20191007104229.29412-1-krishna2@chelsio.com
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit d9156df7660a555b6684162221d4f8af1f2483ce
Author: Potnuri Bharat Teja
Date: Thu Oct 3 16:13:53 2019 +0530
iw\_cxgb4: fix ECN check on the passive accept
[ Upstream commit 612e0486ad0845c41ac10492e78144f99e326375 ]
pass\_accept\_req() is using the same skb for handling accept request and
sending accept reply to HW. Here req and rpl structures are pointing to
same skb->data which is over written by INIT\_TP\_WR() and leads to
accessing corrupt req fields in accept\_cr() while checking for ECN flags.
Reordered code in accept\_cr() to fetch correct req fields.
Fixes: 92e7ae7172 ("iw\_cxgb4: Choose appropriate hw mtu index and ISS for iWARP connections")
Signed-off-by: Potnuri Bharat Teja
Link: https://lore.kernel.org/r/20191003104353.11590-1-bharat@chelsio.com
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit bc3eef2144b4f560ad7d5f1761f5c11c0d40ee73
Author: Rafi Wiener
Date: Wed Oct 2 15:02:43 2019 +0300
RDMA/mlx5: Clear old rate limit when closing QP
[ Upstream commit c8973df2da677f375f8b12b6eefca2f44c8884d5 ]
Before QP is closed it changes to ERROR state, when this happens
the QP was left with old rate limit that was already removed from
the table.
Fixes: 7d29f349a4b9 ("IB/mlx5: Properly adjust rate limit on QP state transitions")
Signed-off-by: Rafi Wiener
Signed-off-by: Oleg Kuporosov
Signed-off-by: Leon Romanovsky
Link: https://lore.kernel.org/r/20191002120243.16971-1-leon@kernel.org
Signed-off-by: Doug Ledford
Signed-off-by: Sasha Levin
commit 3b7811ded97635032c26bab49de36048c2c5f2b5
Author: Christophe Leroy
Date: Mon Oct 14 16:51:28 2019 +0000
powerpc/32s: fix allow/prevent\_user\_access() when crossing segment boundaries.
[ Upstream commit d10f60ae27d26d811e2a1bb39ded47df96d7499f ]
Make sure starting addr is aligned to segment boundary so that when
incrementing the segment, the starting address of the new segment is
below the end address. Otherwise the last segment might get missed.
Fixes: a68c31fc01ef ("powerpc/32s: Implement Kernel Userspace Access Protection")
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://lore.kernel.org/r/067a1b09f15f421d40797c2d04c22d4049a1cee8.1571071875.git.christophe.leroy@c-s.fr
Signed-off-by: Sasha Levin
commit 21c3168b7332ed657974d0edcedee8278b38687c
Author: Zhang Lixu
Date: Wed Oct 16 08:15:59 2019 +0800
HID: intel-ish-hid: fix wrong error handling in ishtp\_cl\_alloc\_tx\_ring()
[ Upstream commit 16ff7bf6dbcc6f77d2eec1ac9120edf44213c2f1 ]
When allocating tx ring buffers failed, should free tx buffers, not rx buffers.
Signed-off-by: Zhang Lixu
Acked-by: Srinivas Pandruvada
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 339ff30eb7b82fec239fd466e215303974ac4867
Author: Baolin Wang
Date: Wed Oct 9 17:11:30 2019 +0800
dmaengine: sprd: Fix the possible memory leak issue
[ Upstream commit ec1ac309596a7bdf206743b092748205f6cd5720 ]
If we terminate the channel to free all descriptors associated with this
channel, we will leak the memory of current descriptor if the current
descriptor is not completed, since it had been deteled from the desc\_issued
list and have not been added into the desc\_completed list.
Thus we should check if current descriptor is completed or not, when freeing
the descriptors associated with one channel, if not, we should free it to
avoid this issue.
Fixes: 9b3b8171f7f4 ("dmaengine: sprd: Add Spreadtrum DMA driver")
Reported-by: Zhenfang Wang
Tested-by: Zhenfang Wang
Signed-off-by: Baolin Wang
Link: https://lore.kernel.org/r/170dbbc6d5366b6fa974ce2d366652e23a334251.1570609788.git.baolin.wang@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit aba285e5f5ca7f14d24aa0ecdc88a5179c54be27
Author: Radhey Shyam Pandey
Date: Thu Sep 26 16:20:58 2019 +0530
dmaengine: xilinx\_dma: Fix control reg update in vdma\_channel\_set\_config
[ Upstream commit 6c6de1ddb1be3840f2ed5cc9d009a622720940c9 ]
In vdma\_channel\_set\_config clear the delay, frame count and master mask
before updating their new values. It avoids programming incorrect state
when input parameters are different from default.
Signed-off-by: Radhey Shyam Pandey
Acked-by: Appana Durga Kedareswara rao
Signed-off-by: Michal Simek
Link: https://lore.kernel.org/r/1569495060-18117-3-git-send-email-radhey.shyam.pandey@xilinx.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit fc97c00f9d987de6e97c36ed8eb24133e9df3696
Author: Radhey Shyam Pandey
Date: Thu Sep 26 16:20:57 2019 +0530
dmaengine: xilinx\_dma: Fix 64-bit simple AXIDMA transfer
[ Upstream commit 68fe2b520cee829ed518b4b1f64d2a557bcbffe1 ]
In AXI DMA simple mode also pass MSB bits of source and destination
address to xilinx\_write function. It fixes simple AXI DMA operation
mode using 64-bit addressing.
Signed-off-by: Radhey Shyam Pandey
Link: https://lore.kernel.org/r/1569495060-18117-2-git-send-email-radhey.shyam.pandey@xilinx.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 84cc17f40d1f4cd9ca821295a48d190e178200f1
Author: Jiri Benc
Date: Wed Oct 9 10:31:24 2019 +0200
bpf: lwtunnel: Fix reroute supplying invalid dst
[ Upstream commit 9e8acd9c44a0dd52b2922eeb82398c04e356c058 ]
The dst in bpf\_input() has lwtstate field set. As it is of the
LWTUNNEL\_ENCAP\_BPF type, lwtstate->data is struct bpf\_lwt. When the bpf
program returns BPF\_LWT\_REROUTE, ip\_route\_input\_noref is directly called on
this skb. This causes invalid memory access, as ip\_route\_input\_slow calls
skb\_tunnel\_info(skb) that expects the dst->lwstate->data to be
struct ip\_tunnel\_info. This results to struct bpf\_lwt being accessed as
struct ip\_tunnel\_info.
Drop the dst before calling the IP route input functions (both for IPv4 and
IPv6).
Reported by KASAN.
Fixes: 3bd0b15281af ("bpf: add handling of BPF\_LWT\_REROUTE to lwt\_bpf.c")
Signed-off-by: Jiri Benc
Signed-off-by: Alexei Starovoitov
Acked-by: Peter Oskolkov
Link: https://lore.kernel.org/bpf/111664d58fe4e9dd9c8014bb3d0b2dab93086a9e.1570609794.git.jbenc@redhat.com
Signed-off-by: Sasha Levin
commit bd75b8300a76962bf4064c9ae1f9e3fc9d5cdde7
Author: Zhenfang Wang
Date: Thu Sep 12 13:47:18 2019 +0800
dmaengine: sprd: Fix the link-list pointer register configuration issue
[ Upstream commit 8b6bc5fd71e677864d1a3b896b3069a6e0c5e214 ]
We will set the link-list pointer register point to next link-list
configuration's physical address, which can load DMA configuration
from the link-list node automatically.
But the link-list node's physical address can be larger than 32bits,
and now Spreadtrum DMA driver only supports 32bits physical address,
which may cause loading a incorrect DMA configuration when starting
the link-list transfer mode. According to the DMA datasheet, we can
use SRC\_BLK\_STEP register (bit28 - bit31) to save the high bits of the
link-list node's physical address to fix this issue.
Fixes: 4ac695464763 ("dmaengine: sprd: Support DMA link-list mode")
Signed-off-by: Zhenfang Wang
Signed-off-by: Baolin Wang
Link: https://lore.kernel.org/r/eadfe9295499efa003e1c344e67e2890f9d1d780.1568267061.git.baolin.wang@linaro.org
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit fa2177d1b22bc396a6c568146aa6d89479f8fd81
Author: Nicolas Boichat
Date: Thu Oct 3 11:17:59 2019 +0800
HID: google: add magnemite/masterball USB ids
[ Upstream commit 9e4dbc4646a84b2562ea7c64a542740687ff7daf ]
Add 2 additional hammer-like devices.
Signed-off-by: Nicolas Boichat
Signed-off-by: Jiri Kosina
Signed-off-by: Sasha Levin
commit 9d18c267df63f4f5cb227af0e7e4c23b311ad89a
Author: Suwan Kim
Date: Wed Aug 28 12:27:41 2019 +0900
usbip: Implement SG support to vhci-hcd and stub driver
commit ea44d190764b4422af4d1c29eaeb9e69e353b406 upstream.
There are bugs on vhci with usb 3.0 storage device. In USB, each SG
list entry buffer should be divisible by the bulk max packet size.
But with native SG support, this problem doesn't matter because the
SG buffer is treated as contiguous buffer. But without native SG
support, USB storage driver breaks SG list into several URBs and the
error occurs because of a buffer size of URB that cannot be divided
by the bulk max packet size. The error situation is as follows.
When USB Storage driver requests 31.5 KB data and has SG list which
has 3584 bytes buffer followed by 7 4096 bytes buffer for some
reason. USB Storage driver splits this SG list into several URBs
because VHCI doesn't support SG and sends them separately. So the
first URB buffer size is 3584 bytes. When receiving data from device,
USB 3.0 device sends data packet of 1024 bytes size because the max
packet size of BULK pipe is 1024 bytes. So device sends 4096 bytes.
But the first URB buffer has only 3584 bytes buffer size. So host
controller terminates the transfer even though there is more data to
receive. So, vhci needs to support SG transfer to prevent this error.
In this patch, vhci supports SG regardless of whether the server's
host controller supports SG or not, because stub driver splits SG
list into several URBs if the server's host controller doesn't
support SG.
To support SG, vhci sets URB\_DMA\_MAP\_SG flag in urb->transfer\_flags
if URB has SG list and this flag will tell stub driver to use SG
list. After receiving urb from stub driver, vhci clear URB\_DMA\_MAP\_SG
flag to avoid unnecessary DMA unmapping in HCD.
vhci sends each SG list entry to stub driver. Then, stub driver sees
the total length of the buffer and allocates SG table and pages
according to the total buffer length calling sgl\_alloc(). After stub
driver receives completed URB, it again sends each SG list entry to
vhci.
If the server's host controller doesn't support SG, stub driver
breaks a single SG request into several URBs and submits them to
the server's host controller. When all the split URBs are completed,
stub driver reassembles the URBs into a single return command and
sends it to vhci.
Moreover, in the situation where vhci supports SG, but stub driver
does not, or vice versa, usbip works normally. Because there is no
protocol modification, there is no problem in communication between
server and client even if the one has a kernel without SG support.
In the case of vhci supports SG and stub driver doesn't, because
vhci sends only the total length of the buffer to stub driver as
it did before the patch applied, stub driver only needs to allocate
the required length of buffers using only kmalloc() regardless of
whether vhci supports SG or not. But stub driver has to allocate
buffer with kmalloc() as much as the total length of SG buffer which
is quite huge when vhci sends SG request, so it has overhead in
buffer allocation in this situation.
If stub driver needs to send data buffer to vhci because of IN pipe,
stub driver also sends only total length of buffer as metadata and
then sends real data as vhci does. Then vhci receive data from stub
driver and store it to the corresponding buffer of SG list entry.
And for the case of stub driver supports SG and vhci doesn't, since
the USB storage driver checks that vhci doesn't support SG and sends
the request to stub driver by splitting the SG list into multiple
URBs, stub driver allocates a buffer for each URB with kmalloc() as
it did before this patch.
\* Test environment
Test uses two difference machines and two different kernel version
to make mismatch situation between the client and the server where
vhci supports SG, but stub driver does not, or vice versa. All tests
are conducted in both full SG support that both vhci and stub support
SG and half SG support that is the mismatch situation. Test kernel
version is 5.3-rc6 with commit "usb: add a HCD\_DMA flag instead of
guestimating DMA capabilities" to avoid unnecessary DMA mapping and
unmapping.
- Test kernel version
- 5.3-rc6 with SG support
- 5.1.20-200.fc29.x86\_64 without SG support
\* SG support test
- Test devices
- Super-speed storage device - SanDisk Ultra USB 3.0
- High-speed storage device - SMI corporation USB 2.0 flash drive
- Test description
Test read and write operation of mass storage device that uses the
BULK transfer. In test, the client reads and writes files whose size
is over 1G and it works normally.
\* Regression test
- Test devices
- Super-speed device - Logitech Brio webcam
- High-speed device - Logitech C920 HD Pro webcam
- Full-speed device - Logitech bluetooth mouse
- Britz BR-Orion speaker
- Low-speed device - Logitech wired mouse
- Test description
Moving and click test for mouse. To test the webcam, use gnome-cheese.
To test the speaker, play music and video on the client. All works
normally.
\* VUDC compatibility test
VUDC also works well with this patch. Tests are done with two USB
gadget created by CONFIGFS USB gadget. Both use the BULK pipe.
1. Serial gadget
2. Mass storage gadget
- Serial gadget test
Serial gadget on the host sends and receives data using cat command
on the /dev/ttyGS. The client uses minicom to communicate with
the serial gadget.
- Mass storage gadget test
After connecting the gadget with vhci, use "dd" to test read and
write operation on the client side.
Read - dd if=/dev/sd iflag=direct of=/dev/null bs=1G count=1
Write - dd if= iflag=direct of=/dev/sd bs=1G count=1
Signed-off-by: Suwan Kim
Acked-by: Shuah khan
Link: https://lore.kernel.org/r/20190828032741.12234-1-suwan.kim027@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit d2f49f58b40e1680650bc36f9b5d3de626f57b09
Author: Takashi Iwai
Date: Tue Oct 22 17:45:14 2019 +0200
ALSA: usb-audio: Fix copy&paste error in the validator
commit ba8bf0967a154796be15c4983603aad0b05c3138 upstream.
The recently introduced USB-audio descriptor validator had a stupid
copy&paste error that may lead to an unexpected overlook of too short
descriptors for processing and extension units. It's likely the cause
of the report triggered by syzkaller fuzzer. Let's fix it.
Fixes: 57f8770620e9 ("ALSA: usb-audio: More validations of descriptor units")
Reported-by: syzbot+0620f79a1978b1133fd7@syzkaller.appspotmail.com
Link: https://lore.kernel.org/r/s5hsgnkdbsl.wl-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit aa07532bc86bd94b7cdafd3042d3e268a34f4cbe
Author: Dan Carpenter
Date: Mon Aug 26 16:45:50 2019 +0300
ALSA: usb-audio: remove some dead code
commit b39e077fcb283dd96dd251a3abeba585402c61fe upstream.
We recently cleaned up the error handling in commit 52c3e317a857 ("ALSA:
usb-audio: Unify the release of usb\_mixer\_elem\_info objects") but
accidentally left this stray return.
Fixes: 52c3e317a857 ("ALSA: usb-audio: Unify the release of usb\_mixer\_elem\_info objects")
Signed-off-by: Dan Carpenter
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ee3f9007c2e85ee99c5efb2a8a4da60c2b758d7a
Author: Takashi Iwai
Date: Mon Aug 26 13:55:21 2019 +0200
ALSA: usb-audio: Fix possible NULL dereference at create\_yamaha\_midi\_quirk()
commit 60849562a5db4a1eee2160167e4dce4590d3eafe upstream.
The previous addition of descriptor validation may lead to a NULL
dereference at create\_yamaha\_midi\_quirk() when either injd or outjd is
NULL. Add proper non-NULL checks.
Fixes: 57f8770620e9 ("ALSA: usb-audio: More validations of descriptor units")
Reported-by: Dan Carpenter
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c07240f4150bb16193d1fd977f702671cf3d1ff3
Author: Takashi Iwai
Date: Fri Aug 23 12:38:07 2019 +0200
ALSA: usb-audio: Clean up check\_input\_term()
commit e0ccdef92653f8867e2d1667facfd3c23699f540 upstream.
The primary changes in this patch are cleanups of \_\_check\_input\_term()
and move to a non-nested switch-case block by evaluating the pair of
UAC version and the unit type, as we've done for parse\_audio\_unit().
Also each parser is split into the function for readability.
Now, a slight behavior change by this cleanup is the handling of
processing and extension units. Formerly we've dealt with them
differently between UAC1/2 and UAC3; the latter returns an error if no
input sources are available, while the former continues to parse.
In this patch, unify the behavior in all cases: when input sources are
available, it parses recursively, then override the type and the id,
as well as channel information if not provided yet.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 3b17a13b687ae99939dc94a4ae01fbc34f68decc
Author: Takashi Iwai
Date: Thu Aug 22 09:25:27 2019 +0200
ALSA: usb-audio: Remove superfluous bLength checks
commit b8e4f1fdfa422398c2d6c47bfb7d1feb3046d70a upstream.
Now that we got the more comprehensive validation code for USB-audio
descriptors, the check of overflow in each descriptor unit parser
became superfluous. Drop some of the obvious cases.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit bcf43f13ca33daa2196d5570c1b8416c62e982a5
Author: Takashi Iwai
Date: Thu Aug 22 08:23:10 2019 +0200
ALSA: usb-audio: Unify the release of usb\_mixer\_elem\_info objects
commit 52c3e317a857091fd746e15179a637f32be4d337 upstream.
Instead of the direct kfree() calls, introduce a new local helper to
release the usb\_mixer\_elem\_info object. This will be extended to do
more than a single kfree() in the later patches.
Also, use the standard goto instead of multiple calls in
parse\_audio\_selector\_unit() error paths.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 09400c7b28fd9f665dd8592df60604e376fb9cd8
Author: Takashi Iwai
Date: Thu Aug 15 16:30:39 2019 +0200
ALSA: usb-audio: Simplify parse\_audio\_unit()
commit 68e9fde245591d18200f8a9054cac22339437adb upstream.
Minor code refactoring by combining the UAC version and the type in
the switch-case flow, so that we reduce the indentation and
redundancy. One good bonus is that the duplicated definition of the
same type value (e.g. UAC2\_EFFECT\_UNIT) can be handled more cleanly.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit bf74a46aebb1b5ab5e5f25bafa4ae0a453ba813a
Author: Takashi Iwai
Date: Tue Aug 20 17:17:09 2019 +0200
ALSA: usb-audio: More validations of descriptor units
commit 57f8770620e9b51c61089751f0b5ad3dbe376ff2 upstream.
Introduce a new helper to validate each audio descriptor unit before
and check the unit before actually accessing it. This should harden
against the OOB access cases with malformed descriptors that have been
recently frequently reported by fuzzers.
The existing descriptor checks are still kept although they become
superfluous after this patch. They'll be cleaned up eventually
later.
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 858c35c6ad0f049f6c13853b874c59165499f7df
Author: Al Viro
Date: Sat Aug 3 11:51:18 2019 -0400
configfs: fix a deadlock in configfs\_symlink()
commit 351e5d869e5ac10cb40c78b5f2d7dfc816ad4587 upstream.
Configfs abuses symlink(2). Unlike the normal filesystems, it
wants the target resolved at symlink(2) time, like link(2) would've
done. The problem is that ->symlink() is called with the parent
directory locked exclusive, so resolving the target inside the
->symlink() is easily deadlocked.
Short of really ugly games in sys\_symlink() itself, all we can
do is to unlock the parent before resolving the target and
relock it after. However, that invalidates the checks done
by the caller of ->symlink(), so we have to
\* check that dentry is still where it used to be
(it couldn't have been moved, but it could've been unhashed)
\* recheck that it's still negative (somebody else
might've successfully created a symlink with the same name
while we were looking the target up)
\* recheck the permissions on the parent directory.
Cc: stable@vger.kernel.org
Signed-off-by: Al Viro
Signed-off-by: Christoph Hellwig
Signed-off-by: Greg Kroah-Hartman
commit 29dd281d2d6c6bf135e2bf8d3bc93f3568668cdd
Author: Johan Hovold
Date: Wed Oct 23 10:27:05 2019 +0200
can: peak\_usb: fix slab info leak
commit f7a1337f0d29b98733c8824e165fca3371d7d4fd upstream.
Fix a small slab info leak due to a failure to clear the command buffer
at allocation.
The first 16 bytes of the command buffer are always sent to the device
in pcan\_usb\_send\_cmd() even though only the first two may have been
initialised in case no argument payload is provided (e.g. when waiting
for a response).
Fixes: bb4785551f64 ("can: usb: PEAK-System Technik USB adapters driver core")
Cc: stable  # 3.4
Reported-by: syzbot+863724e7128e14b26732@syzkaller.appspotmail.com
Signed-off-by: Johan Hovold
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit a681359a9c01041282bffeabc23ef1d760dd40da
Author: Johan Hovold
Date: Tue Oct 1 12:29:13 2019 +0200
can: mcba\_usb: fix use-after-free on disconnect
commit 4d6636498c41891d0482a914dd570343a838ad79 upstream.
The driver was accessing its driver data after having freed it.
Fixes: 51f3baad7de9 ("can: mcba\_usb: Add support for Microchip CAN BUS Analyzer")
Cc: stable  # 4.12
Cc: Remigiusz Kołłątaj
Reported-by: syzbot+e29b17e5042bbc56fae9@syzkaller.appspotmail.com
Signed-off-by: Johan Hovold
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit d8eed5c83042a0a35c65ca4e605a6bce90be9810
Author: Wen Yang
Date: Sat Sep 28 22:29:05 2019 +0800
can: dev: add missing of\_node\_put() after calling of\_get\_child\_by\_name()
commit db9ee384f6f71f7c5296ce85b7c1a2a2527e7c72 upstream.
of\_node\_put() needs to be called when the device node which is got
from of\_get\_child\_by\_name() finished using.
Fixes: 2290aefa2e90 ("can: dev: Add support for limiting configured bitrate")
Cc: Franklin S Cooper Jr
Signed-off-by: Wen Yang
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 55b11d219350255d2afef08716bf08821c4486d5
Author: Navid Emamdoost
Date: Thu Sep 19 21:44:38 2019 -0500
can: gs\_usb: gs\_can\_open(): prevent memory leak
commit fb5be6a7b4863ecc44963bb80ca614584b6c7817 upstream.
In gs\_can\_open() if usb\_submit\_urb() fails the allocated urb should be
released.
Fixes: d08e973a77d1 ("can: gs\_usb: Added support for the GS\_USB CAN devices")
Cc: linux-stable
Signed-off-by: Navid Emamdoost
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 363e780f784da2e704fa2d9bb8ee2347e68ddf5b
Author: Marc Kleine-Budde
Date: Wed Oct 9 15:48:48 2019 +0200
can: rx-offload: can\_rx\_offload\_queue\_sorted(): fix error handling, avoid skb mem leak
commit ca913f1ac024559ebc17f0b599af262f0ad997c9 upstream.
If the rx-offload skb\_queue is full can\_rx\_offload\_queue\_sorted() will
not queue the skb and return with an error.
None of the callers of this function, issue a kfree\_skb() to free the
not queued skb. This results in a memory leak.
This patch fixes the problem by freeing the skb in case of a full queue.
The return value is adjusted to -ENOBUFS to better reflect the actual
problem.
The device stats handling is left to the callers, as this function might
be used in both the rx and tx path.
Fixes: 55059f2b7f86 ("can: rx-offload: introduce can\_rx\_offload\_get\_echo\_skb() and can\_rx\_offload\_queue\_sorted() functions")
Cc: linux-stable
Cc: Martin Hundebøll
Reported-by: Martin Hundebøll
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit e7300d0ed2e22d2f0a021b3ee6fcb88e52c21b1d
Author: Stephane Grosjean
Date: Tue Oct 8 10:35:44 2019 +0200
can: peak\_usb: fix a potential out-of-sync while decoding packets
commit de280f403f2996679e2607384980703710576fed upstream.
When decoding a buffer received from PCAN-USB, the first timestamp read in
a packet is a 16-bit coded time base, and the next ones are an 8-bit
offset to this base, regardless of the type of packet read.
This patch corrects a potential loss of synchronization by using a
timestamp index read from the buffer, rather than an index of received
data packets, to determine on the sizeof the timestamp to be read from the
packet being decoded.
Signed-off-by: Stephane Grosjean
Fixes: 46be265d3388 ("can: usb: PEAK-System Technik PCAN-USB specific part")
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 0651ea4fc7971f9db6f013cb52973b972461019b
Author: Kurt Van Dijck
Date: Tue Oct 1 09:40:36 2019 +0200
can: c\_can: c\_can\_poll(): only read status register after status IRQ
commit 3cb3eaac52c0f145d895f4b6c22834d5f02b8569 upstream.
When the status register is read without the status IRQ pending, the
chip may not raise the interrupt line for an upcoming status interrupt
and the driver may miss a status interrupt.
It is critical that the BUSOFF status interrupt is forwarded to the
higher layers, since no more interrupts will follow without
intervention.
Thanks to Wolfgang and Joe for bringing up the first idea.
Signed-off-by: Kurt Van Dijck
Cc: Wolfgang Grandegger
Cc: Joe Burmeister
Fixes: fa39b54ccf28 ("can: c\_can: Get rid of pointless interrupts")
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 52a61a7c2beef59340d83b736c18f055c7ba9d9e
Author: Joakim Zhang
Date: Thu Aug 15 08:00:26 2019 +0000
can: flexcan: disable completely the ECC mechanism
commit 5e269324db5adb2f5f6ec9a93a9c7b0672932b47 upstream.
The ECC (memory error detection and correction) mechanism can be
activated or not, controlled by the ECCDIS bit in CAN\_MECR. When
disabled, updates on indications and reporting registers are stopped.
So if want to disable ECC completely, had better assert ECCDIS bit, not
just mask the related interrupts.
Fixes: cdce844865be ("can: flexcan: add vf610 support for FlexCAN")
Signed-off-by: Joakim Zhang
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 484f18282e87ac2a8932cc3566b560a6c147bf0d
Author: Johan Hovold
Date: Tue Oct 1 12:29:14 2019 +0200
can: usb\_8dev: fix use-after-free on disconnect
commit 3759739426186a924675651b388d1c3963c5710e upstream.
The driver was accessing its driver data after having freed it.
Fixes: 0024d8ad1639 ("can: usb\_8dev: Add support for USB2CAN interface from 8 devices")
Cc: stable  # 3.9
Cc: Bernd Krumboeck
Cc: Wolfgang Grandegger
Signed-off-by: Johan Hovold
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit f37d35c165a15e7b0379e1a05968d33d571df308
Author: Pavel Shilovsky
Date: Wed Nov 6 13:58:15 2019 -0800
SMB3: Fix persistent handles reconnect
commit d243af7ab9feb49f11f2c0050d2077e2d9556f9b upstream.
When the client hits a network reconnect, it re-opens every open
file with a create context to reconnect a persistent handle. All
create context types should be 8-bytes aligned but the padding
was missed for that one. As a result, some servers don't allow
us to reconnect handles and return an error. The problem occurs
when the problematic context is not at the end of the create
request packet. Fix this by adding a proper padding at the end
of the reconnect persistent handle context.
Cc: Stable  # 4.19.x
Signed-off-by: Pavel Shilovsky
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit dcc0bed1d344aa4428467ec494cd11ff4da7de42
Author: Jan Beulich
Date: Tue Oct 29 10:34:19 2019 +0100
x86/apic/32: Avoid bogus LDR warnings
commit fe6f85ca121e9c74e7490fe66b0c5aae38e332c3 upstream.
The removal of the LDR initialization in the bigsmp\_32 APIC code unearthed
a problem in setup\_local\_APIC().
The code checks unconditionally for a mismatch of the logical APIC id by
comparing the early APIC id which was initialized in get\_smp\_config() with
the actual LDR value in the APIC.
Due to the removal of the bogus LDR initialization the check now can
trigger on bigsmp\_32 APIC systems emitting a warning for every booting
CPU. This is of course a false positive because the APIC is not using
logical destination mode.
Restrict the check and the possibly resulting fixup to systems which are
actually using the APIC in logical destination mode.
[ tglx: Massaged changelog and added Cc stable ]
Fixes: bae3a8d3308 ("x86/apic: Do not initialize LDR and DFR for bigsmp")
Signed-off-by: Jan Beulich
Signed-off-by: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/666d8f91-b5a8-1afd-7add-821e72a35f03@suse.com
Signed-off-by: Greg Kroah-Hartman
commit 1f76565c1d5a6080eee4d5c9493d74b72f17239a
Author: Thomas Gleixner
Date: Wed Oct 23 20:05:49 2019 +0200
x86/dumpstack/64: Don't evaluate exception stacks before setup
commit e361362b08cab1098b64b0e5fd8c879f086b3f46 upstream.
Cyrill reported the following crash:
BUG: unable to handle page fault for address: 0000000000001ff0
#PF: supervisor read access in kernel mode
RIP: 0010:get\_stack\_info+0xb3/0x148
It turns out that if the stack tracer is invoked before the exception stack
mappings are initialized in\_exception\_stack() can erroneously classify an
invalid address as an address inside of an exception stack:
begin = this\_cpu\_read(cea\_exception\_stacks); <- 0
end = begin + sizeof(exception stacks);
i.e. any address between 0 and end will be considered as exception stack
address and the subsequent code will then try to derefence the resulting
stack frame at a non mapped address.
end = begin + (unsigned long)ep->size;
==> end = 0x2000
regs = (struct pt\_regs \*)end - 1;
==> regs = 0x2000 - sizeof(struct pt\_regs \*) = 0x1ff0
info->next\_sp = (unsigned long \*)regs->sp;
==> Crashes due to accessing 0x1ff0
Prevent this by checking the validity of the cea\_exception\_stack base
address and bailing out if it is zero.
Fixes: afcd21dad88b ("x86/dumpstack/64: Use cpu\_entry\_area instead of orig\_ist")
Reported-by: Cyrill Gorcunov
Signed-off-by: Thomas Gleixner
Tested-by: Cyrill Gorcunov
Acked-by: Josh Poimboeuf
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/alpine.DEB.2.21.1910231950590.1852@nanos.tec.linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 01e15002a3ab79d82d2cc7f6f1faff0a32c6adcd
Author: Alexander Shishkin
Date: Mon Oct 28 09:06:51 2019 +0200
intel\_th: pci: Add Jasper Lake PCH support
commit 9d55499d8da49e9261e95a490f3fda41d955f505 upstream.
This adds support for Intel TH on Jasper Lake PCH.
Signed-off-by: Alexander Shishkin
Reviewed-by: Andy Shevchenko
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20191028070651.9770-8-alexander.shishkin@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit bd3d05f8c5a45ca2d2bfda97c1102395dc45a1a1
Author: Alexander Shishkin
Date: Mon Oct 28 09:06:50 2019 +0200
intel\_th: pci: Add Comet Lake PCH support
commit 3adbb5718dd5264666ddbc2b9b43799d292e9cb6 upstream.
This adds support for Intel TH on Comet Lake PCH.
Signed-off-by: Alexander Shishkin
Reviewed-by: Andy Shevchenko
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20191028070651.9770-7-alexander.shishkin@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 1af578f231039227d0150d912ab4ab699030d367
Author: Alexander Shishkin
Date: Mon Oct 28 09:06:45 2019 +0200
intel\_th: gth: Fix the window switching sequence
commit 87c0b9c79ec136ea76a14a88d675a746bc6a87f9 upstream.
Commit 8116db57cf16 ("intel\_th: Add switch triggering support") added
a trigger assertion of the CTS, but forgot to de-assert it at the end
of the sequence. This results in window switches randomly not happening.
Fix that by de-asserting the trigger at the end of the window switch
sequence.
Signed-off-by: Alexander Shishkin
Reviewed-by: Andy Shevchenko
Fixes: 8116db57cf16 ("intel\_th: Add switch triggering support")
Cc: stable
Link: https://lore.kernel.org/r/20191028070651.9770-2-alexander.shishkin@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 12de7b98969ad749aadeba381822b86a5226ea57
Author: Dan Carpenter
Date: Sat Aug 24 17:49:55 2019 +0300
netfilter: ipset: Fix an error code in ip\_set\_sockfn\_get()
commit 30b7244d79651460ff114ba8f7987ed94c86b99a upstream.
The copy\_to\_user() function returns the number of bytes remaining to be
copied. In this code, that positive return is checked at the end of the
function and we return zero/success. What we should do instead is
return -EFAULT.
Fixes: a7b4f989a629 ("netfilter: ipset: IP set core support")
Signed-off-by: Dan Carpenter
Signed-off-by: Jozsef Kadlecsik
Signed-off-by: Greg Kroah-Hartman
commit 24fa1fd6050600b10c8f91bbdc50ce7a658c316a
Author: Lukas Wunner
Date: Thu Oct 31 11:06:24 2019 +0100
netfilter: nf\_tables: Align nft\_expr private data to 64-bit
commit 250367c59e6ba0d79d702a059712d66edacd4a1a upstream.
Invoking the following commands on a 32-bit architecture with strict
alignment requirements (such as an ARMv7-based Raspberry Pi) results
in an alignment exception:
# nft add table ip test-ip4
# nft add chain ip test-ip4 output { type filter hook output priority 0; }
# nft add rule ip test-ip4 output quota 1025 bytes
Alignment trap: not handling instruction e1b26f9f at [<7f4473f8>]
Unhandled fault: alignment exception (0x001) at 0xb832e824
Internal error: : 1 [#1] PREEMPT SMP ARM
Hardware name: BCM2835
[<7f4473fc>] (nft\_quota\_do\_init [nft\_quota])
[<7f447448>] (nft\_quota\_init [nft\_quota])
[<7f4260d0>] (nf\_tables\_newrule [nf\_tables])
[<7f4168dc>] (nfnetlink\_rcv\_batch [nfnetlink])
[<7f416bd0>] (nfnetlink\_rcv [nfnetlink])
[<8078b334>] (netlink\_unicast)
[<8078b664>] (netlink\_sendmsg)
[<8071b47c>] (sock\_sendmsg)
[<8071bd18>] (\_\_\_sys\_sendmsg)
[<8071ce3c>] (\_\_sys\_sendmsg)
[<8071ce94>] (sys\_sendmsg)
The reason is that nft\_quota\_do\_init() calls atomic64\_set() on an
atomic64\_t which is only aligned to 32-bit, not 64-bit, because it
succeeds struct nft\_expr in memory which only contains a 32-bit pointer.
Fix by aligning the nft\_expr private data to 64-bit.
Fixes: 96518518cc41 ("netfilter: add nftables")
Signed-off-by: Lukas Wunner
Cc: stable@vger.kernel.org # v3.13+
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit cef6a188b185c14abfd8230df96ad3c010904a32
Author: Christian Brauner
Date: Thu Oct 31 12:36:08 2019 +0100
clone3: validate stack arguments
commit fa729c4df558936b4a1a7b3e2234011f44ede28b upstream.
Validate the stack arguments and setup the stack depening on whether or not
it is growing down or up.
Legacy clone() required userspace to know in which direction the stack is
growing and pass down the stack pointer appropriately. To make things more
confusing microblaze uses a variant of the clone() syscall selected by
CONFIG\_CLONE\_BACKWARDS3 that takes an additional stack\_size argument.
IA64 has a separate clone2() syscall which also takes an additional
stack\_size argument. Finally, parisc has a stack that is growing upwards.
Userspace therefore has a lot nasty code like the following:
#define \_\_STACK\_SIZE (8 \* 1024 \* 1024)
pid\_t sys\_clone(int (\*fn)(void \*), void \*arg, int flags, int \*pidfd)
{
pid\_t ret;
void \*stack;
stack = malloc(\_\_STACK\_SIZE);
if (!stack)
return -ENOMEM;
#ifdef \_\_ia64\_\_
ret = \_\_clone2(fn, stack, \_\_STACK\_SIZE, flags | SIGCHLD, arg, pidfd);
#elif defined(\_\_parisc\_\_) /\* stack grows up \*/
ret = clone(fn, stack, flags | SIGCHLD, arg, pidfd);
#else
ret = clone(fn, stack + \_\_STACK\_SIZE, flags | SIGCHLD, arg, pidfd);
#endif
return ret;
}
or even crazier variants such as [3].
With clone3() we have the ability to validate the stack. We can check that
when stack\_size is passed, the stack pointer is valid and the other way
around. We can also check that the memory area userspace gave us is fine to
use via access\_ok(). Furthermore, we probably should not require
userspace to know in which direction the stack is growing. It is easy
for us to do this in the kernel and I couldn't find the original
reasoning behind exposing this detail to userspace.
/\* Intentional user visible API change \*/
clone3() was released with 5.3. Currently, it is not documented and very
unclear to userspace how the stack and stack\_size argument have to be
passed. After talking to glibc folks we concluded that trying to change
clone3() to setup the stack instead of requiring userspace to do this is
the right course of action.
Note, that this is an explicit change in user visible behavior we introduce
with this patch. If it breaks someone's use-case we will revert! (And then
e.g. place the new behavior under an appropriate flag.)
Breaking someone's use-case is very unlikely though. First, neither glibc
nor musl currently expose a wrapper for clone3(). Second, there is no real
motivation for anyone to use clone3() directly since it does not provide
features that legacy clone doesn't. New features for clone3() will first
happen in v5.5 which is why v5.4 is still a good time to try and make that
change now and backport it to v5.3. Searches on [4] did not reveal any
packages calling clone3().
[1]: https://lore.kernel.org/r/CAG48ez3q=BeNcuVTKBN79kJui4vC6nw0Bfq6xc-i0neheT17TA@mail.gmail.com
[2]: https://lore.kernel.org/r/20191028172143.4vnnjpdljfnexaq5@wittgenstein
[3]: https://github.com/systemd/systemd/blob/5238e9575906297608ff802a27e2ff9effa3b338/src/basic/raw-clone.h#L31
[4]: https://codesearch.debian.net
Fixes: 7f192e3cd316 ("fork: add clone3")
Cc: Kees Cook
Cc: Jann Horn
Cc: David Howells
Cc: Ingo Molnar
Cc: Oleg Nesterov
Cc: Linus Torvalds
Cc: Florian Weimer
Cc: Peter Zijlstra
Cc: linux-api@vger.kernel.org
Cc: linux-kernel@vger.kernel.org
Cc:  # 5.3
Cc: GNU C Library
Signed-off-by: Christian Brauner
Acked-by: Arnd Bergmann
Acked-by: Aleksa Sarai
Link: https://lore.kernel.org/r/20191031113608.20713-1-christian.brauner@ubuntu.com
Signed-off-by: Greg Kroah-Hartman
commit 246a5a18920c533ba5819f9bfff20a03388d0cd9
Author: Srinivas Pandruvada
Date: Thu Oct 31 12:26:20 2019 -0700
cpufreq: intel\_pstate: Fix invalid EPB setting
commit c31432fa7f825de0e19838f1ac7746381c509ec4 upstream.
The max value of EPB can only be 0x0F. Attempting to set more than that
triggers an "unchecked MSR access error" warning which happens in
intel\_pstate\_hwp\_force\_min\_perf() called via cpufreq stop\_cpu().
However, it is not even necessary to touch the EPB from intel\_pstate,
because it is restored on every CPU online by the intel\_epb.c code,
so let that code do the right thing and drop the redundant (and
incorrect) EPB update from intel\_pstate.
Fixes: af3b7379e2d70 ("cpufreq: intel\_pstate: Force HWP min perf before offline")
Reported-by: Qian Cai
Cc: 5.2+  # 5.2+
Signed-off-by: Srinivas Pandruvada
[ rjw: Changelog ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 6972f6cdf9b4d1367df7e45e4471d9e1124a0b85
Author: Adam Ford
Date: Wed Oct 16 09:40:05 2019 -0500
ARM: dts: imx6-logicpd: Re-enable SNVS power key
commit cabe5f85e63626c00f3b879a670ec27325056a2d upstream.
The baseboard of the Logic PD i.MX6 development kit has a power
button routed which can both power down and power up the board.
It can also wake the board from sleep. This functionality was
marked as disabled by default in imx6qdl.dtsi, so it needs to
be explicitly enabled for each board.
This patch enables the snvs power key again.
Signed-off-by: Adam Ford
Fixes: 770856f0da5d ("ARM: dts: imx6qdl: Enable SNVS power key according to board design")
Cc: stable  #5.3+
Signed-off-by: Shawn Guo
Signed-off-by: Greg Kroah-Hartman
commit 88fd55d3dd2537a8c0f0b60f8ed43396c96b4ca8
Author: Ondrej Jirman
Date: Mon Oct 28 22:49:14 2019 +0100
ARM: sunxi: Fix CPU powerdown on A83T
commit e690053e97e7a9c968df9a97cef9089dfa8e6a44 upstream.
PRCM\_PWROFF\_GATING\_REG has CPU0 at bit 4 on A83T. So without this
patch, instead of gating the CPU0, the whole cluster was power gated,
when shutting down first CPU in the cluster.
Fixes: 6961275e72a8c1 ("ARM: sun8i: smp: Add support for A83T")
Signed-off-by: Ondrej Jirman
Acked-by: Chen-Yu Tsai
Cc: stable@vger.kernel.org
Signed-off-by: Maxime Ripard
Signed-off-by: Greg Kroah-Hartman
commit 77f0f55cb8e9b0fc30c66794a8c85c78295206b5
Author: Andreas Klinger
Date: Sun Oct 6 16:29:56 2019 +0200
iio: srf04: fix wrong limitation in distance measuring
commit 431f7667bd6889a274913162dfd19cce9d84848e upstream.
The measured time value in the driver is limited to the maximum distance
which can be read by the sensor. This limitation was wrong and is fixed
by this patch.
It also takes into account that we are supporting a variety of sensors
today and that the recently added sensors have a higher maximum
distance range.
Changes in v2:
- Added a Tested-by
Suggested-by: Zbyněk Kocur
Tested-by: Zbyněk Kocur
Signed-off-by: Andreas Klinger
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 32a0a542bb83eab6bf918a78b6964bd88f72fa63
Author: Jean-Baptiste Maneyrol
Date: Wed Oct 16 14:43:28 2019 +0000
iio: imu: inv\_mpu6050: fix no data on MPU6050
commit 6e82ae6b8d11b948b74e71396efd8e074c415f44 upstream.
Some chips have a fifo overflow bit issue where the bit is always
set. The result is that every data is dropped.
Change fifo overflow management by checking fifo count against
a maximum value.
Add fifo size in chip hardware set of values.
Fixes: f5057e7b2dba ("iio: imu: inv\_mpu6050: better fifo overflow handling")
Cc: stable@vger.kernel.org
Signed-off-by: Jean-Baptiste Maneyrol
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 6f682347b80ca51ac73c85052972f06d63198803
Author: Alexandru Ardelean
Date: Tue Oct 8 17:15:37 2019 +0300
iio: imu: adis16480: make sure provided frequency is positive
commit 24e1eb5c0d78cfb9750b690bbe997d4d59170258 upstream.
It could happen that either `val` or `val2` [provided from userspace] is
negative. In that case the computed frequency could get a weird value.
Fix this by checking that neither of the 2 variables is negative, and check
that the computed result is not-zero.
Fixes: e4f959390178 ("iio: imu: adis16480 switch sampling frequency attr to core support")
Signed-off-by: Alexandru Ardelean
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 4d958a6b9e490e4e48d693812d47a5b3c55478d9
Author: Fabrice Gasnier
Date: Fri Oct 25 17:04:20 2019 +0200
iio: adc: stm32-adc: fix stopping dma
commit e6afcf6c598d6f3a0c9c408bfeddb3f5730608b0 upstream.
There maybe a race when using dmaengine\_terminate\_all(). The predisable
routine may call iio\_triggered\_buffer\_predisable() prior to a pending DMA
callback.
Adopt dmaengine\_terminate\_sync() to ensure there's no pending DMA request
before calling iio\_triggered\_buffer\_predisable().
Fixes: 2763ea0585c9 ("iio: adc: stm32: add optional dma support")
Signed-off-by: Fabrice Gasnier
Cc:
Signed-off-by: Jonathan Cameron
Signed-off-by: Greg Kroah-Hartman
commit 520158f465cdd48d57b57a70ed33a707547b8aea
Author: Luis Henriques
Date: Thu Oct 31 11:49:39 2019 +0000
ceph: don't allow copy\_file\_range when stripe\_count != 1
commit a3a0819388b2bf15e7eafe38ff6aacfc27b12df0 upstream.
copy\_file\_range tries to use the OSD 'copy-from' operation, which simply
performs a full object copy. Unfortunately, the implementation of this
system call assumes that stripe\_count is always set to 1 and doesn't take
into account that the data may be striped across an object set. If the
file layout has stripe\_count different from 1, then the destination file
data will be corrupted.
For example:
Consider a 8 MiB file with 4 MiB object size, stripe\_count of 2 and
stripe\_size of 2 MiB; the first half of the file will be filled with 'A's
and the second half will be filled with 'B's:
0 4M 8M Obj1 Obj2
+------+------+ +----+ +----+
file: | AAAA | BBBB | | AA | | AA |
+------+------+ |----| |----|
| BB | | BB |
+----+ +----+
If we copy\_file\_range this file into a new file (which needs to have the
same file layout!), then it will start by copying the object starting at
file offset 0 (Obj1). And then it will copy the object starting at file
offset 4M -- which is Obj1 again.
Unfortunately, the solution for this is to not allow remote object copies
to be performed when the file layout stripe\_count is not 1 and simply
fallback to the default (VFS) copy\_file\_range implementation.
Cc: stable@vger.kernel.org
Signed-off-by: Luis Henriques
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 2c825c8fd68650b8cb0934a4aa96e96382adc865
Author: Jeff Layton
Date: Wed Oct 30 12:15:10 2019 -0400
ceph: don't try to handle hashed dentries in non-O\_CREAT atomic\_open
commit 5bb5e6ee6f5c557dcd19822eccd7bcced1e1a410 upstream.
If ceph\_atomic\_open is handed a !d\_in\_lookup dentry, then that means
that it already passed d\_revalidate so we \*know\* that it's negative (or
at least was very recently). Just return -ENOENT in that case.
This also addresses a subtle bug in dentry handling. Non-O\_CREAT opens
call atomic\_open with the parent's i\_rwsem shared, but calling
d\_splice\_alias on a hashed dentry requires the exclusive lock.
If ceph\_atomic\_open receives a hashed, negative dentry on a non-O\_CREAT
open, and another client were to race in and create the file before we
issue our OPEN, ceph\_fill\_trace could end up calling d\_splice\_alias on
the dentry with the new inode with insufficient locks.
Cc: stable@vger.kernel.org
Reported-by: Al Viro
Signed-off-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit a037d92302e10c7c0e5c0f7208363b9fc9671a04
Author: Al Viro
Date: Tue Oct 29 13:53:29 2019 +0000
ceph: add missing check in d\_revalidate snapdir handling
commit 1f08529c84cfecaf1261ed9b7e17fab18541c58f upstream.
We should not play with dcache without parent locked...
Cc: stable@vger.kernel.org
Signed-off-by: Al Viro
Signed-off-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 1fe37abb1e8f97d7f3407c8d82f24240940f315a
Author: Al Viro
Date: Tue Oct 29 13:50:19 2019 +0000
ceph: fix RCU case handling in ceph\_d\_revalidate()
commit aa8dd816732b2bab28c54bc4d2ccf3fc8a6e0892 upstream.
For RCU case ->d\_revalidate() is called with rcu\_read\_lock() and
without pinning the dentry passed to it. Which means that it
can't rely upon ->d\_inode remaining stable; that's the reason
for d\_inode\_rcu(), actually.
Make sure we don't reload ->d\_inode there.
Cc: stable@vger.kernel.org
Signed-off-by: Al Viro
Signed-off-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 28589859743a65a6c623a71d906dd7de3aa55d6b
Author: Luis Henriques
Date: Fri Oct 25 14:05:24 2019 +0100
ceph: fix use-after-free in \_\_ceph\_remove\_cap()
commit ea60ed6fcf29eebc78f2ce91491e6309ee005a01 upstream.
KASAN reports a use-after-free when running xfstest generic/531, with the
following trace:
[ 293.903362] kasan\_report+0xe/0x20
[ 293.903365] rb\_erase+0x1f/0x790
[ 293.903370] \_\_ceph\_remove\_cap+0x201/0x370
[ 293.903375] \_\_ceph\_remove\_caps+0x4b/0x70
[ 293.903380] ceph\_evict\_inode+0x4e/0x360
[ 293.903386] evict+0x169/0x290
[ 293.903390] \_\_dentry\_kill+0x16f/0x250
[ 293.903394] dput+0x1c6/0x440
[ 293.903398] \_\_fput+0x184/0x330
[ 293.903404] task\_work\_run+0xb9/0xe0
[ 293.903410] exit\_to\_usermode\_loop+0xd3/0xe0
[ 293.903413] do\_syscall\_64+0x1a0/0x1c0
[ 293.903417] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
This happens because \_\_ceph\_remove\_cap() may queue a cap release
(\_\_ceph\_queue\_cap\_release) which can be scheduled before that cap is
removed from the inode list with
rb\_erase(&cap->ci\_node, &ci->i\_caps);
And, when this finally happens, the use-after-free will occur.
This can be fixed by removing the cap from the inode list before being
removed from the session list, and thus eliminating the risk of an UAF.
Cc: stable@vger.kernel.org
Signed-off-by: Luis Henriques
Reviewed-by: Jeff Layton
Signed-off-by: Ilya Dryomov
Signed-off-by: Greg Kroah-Hartman
commit 820e180cf4468bf54fab856f28ac9a0693e8b02c
Author: Jiada Wang
Date: Tue Oct 22 20:54:29 2019 +0200
ASoC: rsnd: dma: fix SSI9 4/5/6/7 busif dma address
commit d10be65f87fc9d98ad3cbdc406e86745fe8c59e2 upstream.
Currently each SSI unit's busif dma address is calculated by
following calculation formula:
0xec540000 + 0x1000 \* id + busif / 4 \* 0xA000 + busif % 4 \* 0x400
But according to R-Car3 HW manual 41.1.4 Register Configuration,
ssi9 4/5/6/7 busif data register address
(SSI9\_4\_BUSIF/SSI9\_5\_BUSIF/SSI9\_6\_BUSIF/SSI9\_7\_BUSIF)
are out of this rule.
This patch updates the calculation formula to correct
ssi9 4/5/6/7 busif data register address.
Fixes: 5e45a6fab3b9 ("ASoc: rsnd: dma: Calculate dma address with consider of BUSIF")
Signed-off-by: Jiada Wang
Signed-off-by: Timo Wischer
[erosca: minor improvements in commit description]
Cc: Andrew Gabbasov
Cc: stable@vger.kernel.org # v4.20+
Signed-off-by: Eugeniu Rosca
Acked-by: Kuninori Morimoto
Link: https://lore.kernel.org/r/20191022185429.12769-1-erosca@de.adit-jv.com
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit ee3f3e6fe3f640b6d06fabe0423c8cebe22d7d27
Author: Catalin Marinas
Date: Wed Nov 6 15:41:05 2019 +0000
arm64: Do not mask out PTE\_RDONLY in pte\_same()
commit 6767df245f4736d0cf0c6fb7cf9cf94b27414245 upstream.
Following commit 73e86cb03cf2 ("arm64: Move PTE\_RDONLY bit handling out
of set\_pte\_at()"), the PTE\_RDONLY bit is no longer managed by
set\_pte\_at() but built into the PAGE\_\* attribute definitions.
Consequently, pte\_same() must include this bit when checking two PTEs
for equality.
Remove the arm64-specific pte\_same() function, practically reverting
commit 747a70e60b72 ("arm64: Fix copy-on-write referencing in HugeTLB")
Fixes: 73e86cb03cf2 ("arm64: Move PTE\_RDONLY bit handling out of set\_pte\_at()")
Cc:  # 4.14.x-
Cc: Will Deacon
Cc: Steve Capper
Reported-by: John Stultz
Signed-off-by: Catalin Marinas
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit f3386e45be13564d87bf8907361df096e581d676
Author: Tejun Heo
Date: Tue Nov 5 08:09:51 2019 -0800
blkcg: make blkcg\_print\_stat() print stats only for online blkgs
commit b0814361a25cba73a224548843ed92d8ea78715a upstream.
blkcg\_print\_stat() iterates blkgs under RCU and doesn't test whether
the blkg is online. This can call into pd\_stat\_fn() on a pd which is
still being initialized leading to an oops.
The heaviest operation - recursively summing up rwstat counters - is
already done while holding the queue\_lock. Expand queue\_lock to cover
the other operations and skip the blkg if it isn't online yet. The
online state is protected by both blkcg and queue locks, so this
guarantees that only online blkgs are processed.
Signed-off-by: Tejun Heo
Reported-by: Roman Gushchin
Cc: Josef Bacik
Fixes: 903d23f0a354 ("blk-cgroup: allow controllers to output their own stats")
Cc: stable@vger.kernel.org # v4.19+
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 0b5dd4f48bbd7b9ce138bb027f73bc81b54f5760
Author: Bard Liao
Date: Fri Aug 30 02:11:35 2019 +0800
soundwire: bus: set initial value to port\_status
commit f1fac63af678b2fc1044ca71fedf1f2ae8bf7c3b upstream.
port\_status[port\_num] are assigned for each port\_num in some if
conditions. So some of the port\_status may not be initialized.
Signed-off-by: Bard Liao
Reviewed-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20190829181135.16049-1-yung-chuan.liao@linux.intel.com
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 0f2a6868ecd28ff70d770043e4d7b832b6cc028b
Author: Michal Suchanek
Date: Thu Oct 3 12:13:55 2019 +0200
soundwire: depend on ACPI || OF
commit 0f8c0f8a7782178c40157b2feb6a532493cbadd3 upstream.
Now devicetree is supported for probing soundwire as well.
On platforms built with !ACPI !OF (ie s390x) the device still cannot be
probed and gives a build warning.
Cc: stable@vger.kernel.org
Fixes: a2e484585ad3 ("soundwire: core: add device tree support for slave devices")
Signed-off-by: Michal Suchanek
Link: https://lore.kernel.org/r/0b89b4ea16a93f523105c81a2f718b0cd7ec66f2.1570097621.git.msuchanek@suse.de
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit 9bc2e8c5f0d506a9ef2d76871d012510c46299a9
Author: Michal Suchanek
Date: Thu Oct 3 12:13:54 2019 +0200
soundwire: depend on ACPI
commit 52eb063d153ac310058fbaa91577a72c0e7a7169 upstream.
The device cannot be probed on !ACPI and gives this warning:
drivers/soundwire/slave.c:16:12: warning: ‘sdw\_slave\_add’ defined but
not used [-Wunused-function]
static int sdw\_slave\_add(struct sdw\_bus \*bus,
^~~~~~~~~~~~~
Cc: stable@vger.kernel.org
Fixes: 7c3cd189b86d ("soundwire: Add Master registration")
Signed-off-by: Michal Suchanek
Link: https://lore.kernel.org/r/bd685232ea511251eeb9554172f1524eabf9a46e.1570097621.git.msuchanek@suse.de
Signed-off-by: Vinod Koul
Signed-off-by: Greg Kroah-Hartman
commit aaae532d532a74ca29e7e910f0261592ca54641d
Author: Ville Syrjälä
Date: Tue Nov 5 21:16:48 2019 -0800
mm/khugepaged: fix might\_sleep() warn with CONFIG\_HIGHPTE=y
commit ec649c9d454ea372dcf16cccf48250994f1d7788 upstream.
I got some khugepaged spew on a 32bit x86:
BUG: sleeping function called from invalid context at include/linux/mmu\_notifier.h:346
in\_atomic(): 1, irqs\_disabled(): 0, non\_block: 0, pid: 25, name: khugepaged
INFO: lockdep is turned off.
CPU: 1 PID: 25 Comm: khugepaged Not tainted 5.4.0-rc5-elk+ #206
Hardware name: System manufacturer P5Q-EM/P5Q-EM, BIOS 2203 07/08/2009
Call Trace:
dump\_stack+0x66/0x8e
\_\_\_might\_sleep.cold.96+0x95/0xa6
\_\_might\_sleep+0x2e/0x80
collapse\_huge\_page.isra.51+0x5ac/0x1360
khugepaged+0x9a9/0x20f0
kthread+0xf5/0x110
ret\_from\_fork+0x2e/0x38
Looks like it's due to CONFIG\_HIGHPTE=y pte\_offset\_map()->kmap\_atomic()
vs. mmu\_notifier\_invalidate\_range\_start(). Let's do the naive approach
and just reorder the two operations.
Link: http://lkml.kernel.org/r/20191029201513.GG1208@intel.com
Fixes: 810e24e009cf71 ("mm/mmu\_notifiers: annotate with might\_sleep()")
Signed-off-by: Ville Syrjl
Reviewed-by: Andrew Morton
Acked-by: Kirill A. Shutemov
Cc: Thomas Gleixner
Cc: Ingo Molnar
Cc: Borislav Petkov
Cc: "H. Peter Anvin"
Cc: Jérôme Glisse
Cc: Ralph Campbell
Cc: Ira Weiny
Cc: Jason Gunthorpe
Cc: Daniel Vetter
Cc: Andrea Arcangeli
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 33fbcf3c0e42f4ece0e2beb9d21064d6cf05ba1d
Author: Jason Gerecke
Date: Wed Nov 6 11:59:46 2019 -0800
HID: wacom: generic: Treat serial number and related fields as unsigned
commit ff479731c3859609530416a18ddb3db5db019b66 upstream.
The HID descriptors for most Wacom devices oddly declare the serial
number and other related fields as signed integers. When these numbers
are ingested by the HID subsystem, they are automatically sign-extended
into 32-bit integers. We treat the fields as unsigned elsewhere in the
kernel and userspace, however, so this sign-extension causes problems.
In particular, the sign-extended tool ID sent to userspace as ABS\_MISC
does not properly match unsigned IDs used by xf86-input-wacom and libwacom.
We introduce a function 'wacom\_s32tou' that can undo the automatic sign
extension performed by 'hid\_snto32'. We call this function when processing
the serial number and related fields to ensure that we are dealing with
and reporting the unsigned form. We opt to use this method rather than
adding a descriptor fixup in 'wacom\_hid\_usage\_quirk' since it should be
more robust in the face of future devices.
Ref: https://github.com/linuxwacom/input-wacom/issues/134
Fixes: f85c9dc678 ("HID: wacom: generic: Support tool ID and additional tool types")
CC:  # v4.10+
Signed-off-by: Jason Gerecke
Reviewed-by: Aaron Armstrong Skomra
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 146cd2869859c2d4a14a1f6b63fac3f6b40a1334
Author: Alex Deucher
Date: Wed Oct 30 10:21:28 2019 -0400
drm/radeon: fix si\_enable\_smc\_cac() failed issue
commit 2c409ba81be25516afe05ae27a4a15da01740b01 upstream.
Need to set the dte flag on this asic.
Port the fix from amdgpu:
5cb818b861be114 ("drm/amd/amdgpu: fix si\_enable\_smc\_cac() failed issue")
Reviewed-by: Yong Zhao
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit d845c88c9eabfad99f4e9c35b497e327e736f021
Author: John Keeping
Date: Thu Aug 15 11:01:44 2019 +0100
perf map: Use zalloc for map\_groups
commit ab6cd0e5276e24403751e0b3b8ed807738a8571f upstream.
In the next commit we will add new fields to map\_groups and we need
these to be null if no value is assigned. The simplest way to achieve
this is to request zeroed memory from the allocator.
Signed-off-by: John Keeping
Reviewed-by: Jiri Olsa
Cc: Alexander Shishkin
Cc: Konstantin Khlebnikov
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: john keeping
Link: http://lkml.kernel.org/r/20190815100146.28842-1-john@metanate.com
Signed-off-by: Arnaldo Carvalho de Melo
Cc: Andres Freund
Signed-off-by: Greg Kroah-Hartman
commit c4e1a0f9c711068fd6ca373ab7525c4905f818e4
Author: Jiri Olsa
Date: Tue Nov 5 00:27:11 2019 +0100
perf tools: Fix time sorting
commit 722ddfde366fd46205456a9c5ff9b3359dc9a75e upstream.
The final sort might get confused when the comparison is done over
bigger numbers than int like for -s time.
Check the following report for longer workloads:
$ perf report -s time -F time,overhead --stdio
Fix hist\_entry\_\_sort() to properly return int64\_t and not possible cut
int.
Fixes: 043ca389a318 ("perf tools: Use hpp formats to sort final output")
Signed-off-by: Jiri Olsa
Reviewed-by: Andi Kleen
Cc: Alexander Shishkin
Cc: Michael Petlan
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: stable@vger.kernel.org # v3.16+
Link: http://lore.kernel.org/lkml/20191104232711.16055-1-jolsa@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit a967331e5c8b41f0986dab0fde09546b7390aefa
Author: Andy Shevchenko
Date: Mon Oct 14 12:51:04 2019 +0300
pinctrl: intel: Avoid potential glitches if pin is in GPIO mode
commit 29c2c6aa32405dfee4a29911a51ba133edcedb0f upstream.
When consumer requests a pin, in order to be on the safest side,
we switch it first to GPIO mode followed by immediate transition
to the input state. Due to posted writes it's luckily to be a single
I/O transaction.
However, if firmware or boot loader already configures the pin
to the GPIO mode, user expects no glitches for the requested pin.
We may check if the pin is pre-configured and leave it as is
till the actual consumer toggles its state to avoid glitches.
Fixes: 7981c0015af2 ("pinctrl: intel: Add Intel Sunrisepoint pin controller and GPIO support")
Depends-on: f5a26acf0162 ("pinctrl: intel: Initialize GPIO properly when used through irqchip")
Cc: stable@vger.kernel.org
Cc: fei.yang@intel.com
Reported-by: Oliver Barta
Reported-by: Malin Jonsson
Signed-off-by: Andy Shevchenko
Signed-off-by: Mika Westerberg
Signed-off-by: Greg Kroah-Hartman
commit 61a928dff6ea8f576e7ff9f2141a3c68425e22fc
Author: Shuah Khan
Date: Thu Sep 26 19:16:41 2019 -0600
tools: gpio: Use !building\_out\_of\_srctree to determine srctree
commit 4a6a6f5c4aeedb72db871d60bfcca89835f317aa upstream.
make TARGETS=gpio kselftest fails with:
Makefile:23: tools/build/Makefile.include: No such file or directory
When the gpio tool make is invoked from tools Makefile, srctree is
cleared and the current logic check for srctree equals to empty
string to determine srctree location from CURDIR.
When the build in invoked from selftests/gpio Makefile, the srctree
is set to "." and the same logic used for srctree equals to empty is
needed to determine srctree.
Check building\_out\_of\_srctree undefined as the condition for both
cases to fix "make TARGETS=gpio kselftest" build failure.
Cc: stable@vger.kernel.org
Signed-off-by: Shuah Khan
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 49a9b4896e2e6424346ca175543874d7b4797edb
Author: Josef Bacik
Date: Fri Oct 11 09:03:54 2019 -0400
btrfs: save i\_size to avoid double evaluation of i\_size\_read in compress\_file\_range
commit d98da49977f67394db492f06c00b1fb1cc090c05 upstream.
We hit a regression while rolling out 5.2 internally where we were
hitting the following panic
kernel BUG at mm/page-writeback.c:2659!
RIP: 0010:clear\_page\_dirty\_for\_io+0xe6/0x1f0
Call Trace:
\_\_process\_pages\_contig+0x25a/0x350
? extent\_clear\_unlock\_delalloc+0x43/0x70
submit\_compressed\_extents+0x359/0x4d0
normal\_work\_helper+0x15a/0x330
process\_one\_work+0x1f5/0x3f0
worker\_thread+0x2d/0x3d0
? rescuer\_thread+0x340/0x340
kthread+0x111/0x130
? kthread\_create\_on\_node+0x60/0x60
ret\_from\_fork+0x1f/0x30
This is happening because the page is not locked when doing
clear\_page\_dirty\_for\_io. Looking at the core dump it was because our
async\_extent had a ram\_size of 24576 but our async\_chunk range only
spanned 20480, so we had a whole extra page in our ram\_size for our
async\_extent.
This happened because we try not to compress pages outside of our
i\_size, however a cleanup patch changed us to do
actual\_end = min\_t(u64, i\_size\_read(inode), end + 1);
which is problematic because i\_size\_read() can evaluate to different
values in between checking and assigning. So either an expanding
truncate or a fallocate could increase our i\_size while we're doing
writeout and actual\_end would end up being past the range we have
locked.
I confirmed this was what was happening by installing a debug kernel
that had
actual\_end = min\_t(u64, i\_size\_read(inode), end + 1);
if (actual\_end > end + 1) {
printk(KERN\_ERR "KABOOM\n");
actual\_end = end + 1;
}
and installing it onto 500 boxes of the tier that had been seeing the
problem regularly. Last night I got my debug message and no panic,
confirming what I expected.
[ dsterba: the assembly confirms a tiny race window:
mov 0x20(%rsp),%rax
cmp %rax,0x48(%r15) # read
movl $0x0,0x18(%rsp)
mov %rax,%r12
mov %r14,%rax
cmovbe 0x48(%r15),%r12 # eval
Where r15 is inode and 0x48 is offset of i\_size.
The original fix was to revert 62b37622718c that would do an
intermediate assignment and this would also avoid the doulble
evaluation but is not future-proof, should the compiler merge the
stores and call i\_size\_read anyway.
There's a patch adding READ\_ONCE to i\_size\_read but that's not being
applied at the moment and we need to fix the bug. Instead, emulate
READ\_ONCE by two barrier()s that's what effectively happens. The
assembly confirms single evaluation:
mov 0x48(%rbp),%rax # read once
mov 0x20(%rsp),%rcx
mov $0x20,%edx
cmp %rax,%rcx
cmovbe %rcx,%rax
mov %rax,(%rsp)
mov %rax,%rcx
mov %r14,%rax
Where 0x48(%rbp) is inode->i\_size stored to %eax.
]
Fixes: 62b37622718c ("btrfs: Remove isize local variable in compress\_file\_range")
CC: stable@vger.kernel.org # v5.1+
Reviewed-by: Filipe Manana
Signed-off-by: Josef Bacik
Reviewed-by: David Sterba
[ changelog updated ]
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 05f3325f582f1686387767ec10399ef4c97d71e1
Author: Qu Wenruo
Date: Wed Aug 28 10:33:13 2019 +0800
btrfs: tree-checker: Fix wrong check on max devid
commit 8bb177d18f114358a57d8ae7e206861b48b8b4de upstream.
[BUG]
The following script will cause false alert on devid check.
#!/bin/bash
dev1=/dev/test/test
dev2=/dev/test/scratch1
mnt=/mnt/btrfs
umount $dev1 &> /dev/null
umount $dev2 &> /dev/null
umount $mnt &> /dev/null
mkfs.btrfs -f $dev1
mount $dev1 $mnt
\_fail()
{
echo "!!! FAILED !!!"
exit 1
}
for ((i = 0; i < 4096; i++)); do
btrfs dev add -f $dev2 $mnt || \_fail
btrfs dev del $dev1 $mnt || \_fail
dev\_tmp=$dev1
dev1=$dev2
dev2=$dev\_tmp
done
[CAUSE]
Tree-checker uses BTRFS\_MAX\_DEVS() and BTRFS\_MAX\_DEVS\_SYS\_CHUNK() as
upper limit for devid. But we can have devid holes just like above
script.
So the check for devid is incorrect and could cause false alert.
[FIX]
Just remove the whole devid check. We don't have any hard requirement
for devid assignment.
Furthermore, even devid could get corrupted by a bitflip, we still have
dev extents verification at mount time, so corrupted data won't sneak
in.
This fixes fstests btrfs/194.
Reported-by: Anand Jain
Fixes: ab4ba2e13346 ("btrfs: tree-checker: Verify dev item")
CC: stable@vger.kernel.org # 5.2+
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 5e0d169b7f2518cee6c824238bcdb46024ed5609
Author: Qu Wenruo
Date: Wed Aug 28 10:33:12 2019 +0800
btrfs: Consider system chunk array size for new SYSTEM chunks
commit c17add7a1c61a15578e4071ed7bfd460fd041c43 upstream.
For SYSTEM chunks, despite the regular chunk item size limit, there is
another limit due to system chunk array size.
The extra limit was removed in a refactoring, so add it back.
Fixes: e3ecdb3fdecf ("btrfs: factor out devs\_max setting in \_\_btrfs\_alloc\_chunk")
CC: stable@vger.kernel.org # 5.3+
Reviewed-by: Nikolay Borisov
Reviewed-by: Anand Jain
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 8d16e0502ade195f0aa1e9f9c51c76e4a70b0d3a
Author: Roman Gushchin
Date: Tue Nov 5 21:17:03 2019 -0800
mm: slab: make page\_cgroup\_ino() to recognize non-compound slab pages properly
commit 221ec5c0a46c1a1740f34fb36fc661a5284d01b0 upstream.
page\_cgroup\_ino() doesn't return a valid memcg pointer for non-compound
slab pages, because it depends on PgHead AND PgSlab flags to be set to
determine the memory cgroup from the kmem\_cache. It's correct for
compound pages, but not for generic small pages. Those don't have PgHead
set, so it ends up returning zero.
Fix this by replacing the condition to PageSlab() && !PageTail().
Before this patch:
[root@localhost ~]# ./page-types -c /sys/fs/cgroup/user.slice/user-0.slice/user@0.service/ | grep slab
0x0000000000000080 38 0 \_\_\_\_\_\_\_S\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ slab
After this patch:
[root@localhost ~]# ./page-types -c /sys/fs/cgroup/user.slice/user-0.slice/user@0.service/ | grep slab
0x0000000000000080 147 0 \_\_\_\_\_\_\_S\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_\_ slab
Also, hwpoison\_filter\_task() uses output of page\_cgroup\_ino() in order
to filter error injection events based on memcg. So if
page\_cgroup\_ino() fails to return memcg pointer, we just fail to inject
memory error. Considering that hwpoison filter is for testing, affected
users are limited and the impact should be marginal.
[n-horiguchi@ah.jp.nec.com: changelog additions]
Link: http://lkml.kernel.org/r/20191031012151.2722280-1-guro@fb.com
Fixes: 4d96ba353075 ("mm: memcg/slab: stop setting page->mem\_cgroup pointer for slab pages")
Signed-off-by: Roman Gushchin
Reviewed-by: Shakeel Butt
Acked-by: David Rientjes
Cc: Vladimir Davydov
Cc: Daniel Jordan
Cc: Naoya Horiguchi
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 76e81b48fec824c40512194fa38551edf6d8c3de
Author: Kevin Hao
Date: Tue Nov 5 21:16:57 2019 -0800
dump\_stack: avoid the livelock of the dump\_lock
commit 5cbf2fff3bba8d3c6a4d47c1754de1cf57e2b01f upstream.
In the current code, we use the atomic\_cmpxchg() to serialize the output
of the dump\_stack(), but this implementation suffers the thundering herd
problem. We have observed such kind of livelock on a Marvell cn96xx
board(24 cpus) when heavily using the dump\_stack() in a kprobe handler.
Actually we can let the competitors to wait for the releasing of the
lock before jumping to atomic\_cmpxchg(). This will definitely mitigate
the thundering herd problem. Thanks Linus for the suggestion.
[akpm@linux-foundation.org: fix comment]
Link: http://lkml.kernel.org/r/20191030031637.6025-1-haokexin@gmail.com
Fixes: b58d977432c8 ("dump\_stack: serialize the output from dump\_stack()")
Signed-off-by: Kevin Hao
Suggested-by: Linus Torvalds
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 775e7a9b82903e957b693c97f464e333e6146b29
Author: Michal Hocko
Date: Tue Nov 5 21:16:40 2019 -0800
mm, vmstat: hide /proc/pagetypeinfo from normal users
commit abaed0112c1db08be15a784a2c5c8a8b3063cdd3 upstream.
/proc/pagetypeinfo is a debugging tool to examine internal page
allocator state wrt to fragmentation. It is not very useful for any
other use so normal users really do not need to read this file.
Waiman Long has noticed that reading this file can have negative side
effects because zone->lock is necessary for gathering data and that a)
interferes with the page allocator and its users and b) can lead to hard
lockups on large machines which have very long free\_list.
Reduce both issues by simply not exporting the file to regular users.
Link: http://lkml.kernel.org/r/20191025072610.18526-2-mhocko@kernel.org
Fixes: 467c996c1e19 ("Print out statistics in relation to fragmentation avoidance to /proc/pagetypeinfo")
Signed-off-by: Michal Hocko
Reported-by: Waiman Long
Acked-by: Mel Gorman
Acked-by: Vlastimil Babka
Acked-by: Waiman Long
Acked-by: Rafael Aquini
Acked-by: David Rientjes
Reviewed-by: Andrew Morton
Cc: David Hildenbrand
Cc: Johannes Weiner
Cc: Roman Gushchin
Cc: Konstantin Khlebnikov
Cc: Jann Horn
Cc: Song Liu
Cc: Greg Kroah-Hartman
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d1bbad9c45eba3f650d4b1d41713b7d1d407e9c0
Author: Yang Shi
Date: Tue Nov 5 21:16:30 2019 -0800
mm: thp: handle page cache THP correctly in PageTransCompoundMap
commit 169226f7e0d275c1879551f37484ef6683579a5c upstream.
We have a usecase to use tmpfs as QEMU memory backend and we would like
to take the advantage of THP as well. But, our test shows the EPT is
not PMD mapped even though the underlying THP are PMD mapped on host.
The number showed by /sys/kernel/debug/kvm/largepage is much less than
the number of PMD mapped shmem pages as the below:
7f2778200000-7f2878200000 rw-s 00000000 00:14 262232 /dev/shm/qemu\_back\_mem.mem.Hz2hSf (deleted)
Size: 4194304 kB
[snip]
AnonHugePages: 0 kB
ShmemPmdMapped: 579584 kB
[snip]
Locked: 0 kB
cat /sys/kernel/debug/kvm/largepages
12
And some benchmarks do worse than with anonymous THPs.
By digging into the code we figured out that commit 127393fbe597 ("mm:
thp: kvm: fix memory corruption in KVM with THP enabled") checks if
there is a single PTE mapping on the page for anonymous THP when setting
up EPT map. But the \_mapcount < 0 check doesn't work for page cache THP
since every subpage of page cache THP would get \_mapcount inc'ed once it
is PMD mapped, so PageTransCompoundMap() always returns false for page
cache THP. This would prevent KVM from setting up PMD mapped EPT entry.
So we need handle page cache THP correctly. However, when page cache
THP's PMD gets split, kernel just remove the map instead of setting up
PTE map like what anonymous THP does. Before KVM calls get\_user\_pages()
the subpages may get PTE mapped even though it is still a THP since the
page cache THP may be mapped by other processes at the mean time.
Checking its \_mapcount and whether the THP has PTE mapped or not.
Although this may report some false negative cases (PTE mapped by other
processes), it looks not trivial to make this accurate.
With this fix /sys/kernel/debug/kvm/largepage would show reasonable
pages are PMD mapped by EPT as the below:
7fbeaee00000-7fbfaee00000 rw-s 00000000 00:14 275464 /dev/shm/qemu\_back\_mem.mem.SKUvat (deleted)
Size: 4194304 kB
[snip]
AnonHugePages: 0 kB
ShmemPmdMapped: 557056 kB
[snip]
Locked: 0 kB
cat /sys/kernel/debug/kvm/largepages
271
And the benchmarks are as same as anonymous THPs.
[yang.shi@linux.alibaba.com: v4]
Link: http://lkml.kernel.org/r/1571865575-42913-1-git-send-email-yang.shi@linux.alibaba.com
Link: http://lkml.kernel.org/r/1571769577-89735-1-git-send-email-yang.shi@linux.alibaba.com
Fixes: dd78fedde4b9 ("rmap: support file thp")
Signed-off-by: Yang Shi
Reported-by: Gang Deng
Tested-by: Gang Deng
Suggested-by: Hugh Dickins
Acked-by: Kirill A. Shutemov
Cc: Andrea Arcangeli
Cc: Matthew Wilcox
Cc:  [4.8+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 6e4a6a887f1cea99d8f237ebfc6bd848f3719080
Author: Mel Gorman
Date: Tue Nov 5 21:16:27 2019 -0800
mm, meminit: recalculate pcpu batch and high limits after init completes
commit 3e8fc0075e24338b1117cdff6a79477427b8dbed upstream.
Deferred memory initialisation updates zone->managed\_pages during the
initialisation phase but before that finishes, the per-cpu page
allocator (pcpu) calculates the number of pages allocated/freed in
batches as well as the maximum number of pages allowed on a per-cpu
list. As zone->managed\_pages is not up to date yet, the pcpu
initialisation calculates inappropriately low batch and high values.
This increases zone lock contention quite severely in some cases with
the degree of severity depending on how many CPUs share a local zone and
the size of the zone. A private report indicated that kernel build
times were excessive with extremely high system CPU usage. A perf
profile indicated that a large chunk of time was lost on zone->lock
contention.
This patch recalculates the pcpu batch and high values after deferred
initialisation completes for every populated zone in the system. It was
tested on a 2-socket AMD EPYC 2 machine using a kernel compilation
workload -- allmodconfig and all available CPUs.
mmtests configuration: config-workload-kernbench-max Configuration was
modified to build on a fresh XFS partition.
kernbench
5.4.0-rc3 5.4.0-rc3
vanilla resetpcpu-v2
Amean user-256 13249.50 ( 0.00%) 16401.31 \* -23.79%\*
Amean syst-256 14760.30 ( 0.00%) 4448.39 \* 69.86%\*
Amean elsp-256 162.42 ( 0.00%) 119.13 \* 26.65%\*
Stddev user-256 42.97 ( 0.00%) 19.15 ( 55.43%)
Stddev syst-256 336.87 ( 0.00%) 6.71 ( 98.01%)
Stddev elsp-256 2.46 ( 0.00%) 0.39 ( 84.03%)
5.4.0-rc3 5.4.0-rc3
vanilla resetpcpu-v2
Duration User 39766.24 49221.79
Duration System 44298.10 13361.67
Duration Elapsed 519.11 388.87
The patch reduces system CPU usage by 69.86% and total build time by
26.65%. The variance of system CPU usage is also much reduced.
Before, this was the breakdown of batch and high values over all zones
was:
256 batch: 1
256 batch: 63
512 batch: 7
256 high: 0
256 high: 378
512 high: 42
512 pcpu pagesets had a batch limit of 7 and a high limit of 42. After
the patch:
256 batch: 1
768 batch: 63
256 high: 0
768 high: 378
[mgorman@techsingularity.net: fix merge/linkage snafu]
Link: http://lkml.kernel.org/r/20191023084705.GD3016@techsingularity.netLink: http://lkml.kernel.org/r/20191021094808.28824-2-mgorman@techsingularity.net
Signed-off-by: Mel Gorman
Acked-by: Michal Hocko
Acked-by: Vlastimil Babka
Acked-by: David Hildenbrand
Cc: Matt Fleming
Cc: Thomas Gleixner
Cc: Borislav Petkov
Cc: Qian Cai
Cc:  [4.1+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d459ceb9f7113fec063aee7393df46781393d506
Author: Johannes Weiner
Date: Tue Nov 5 21:17:13 2019 -0800
mm: memcontrol: fix network errors from failing \_\_GFP\_ATOMIC charges
commit 869712fd3de5a90b7ba23ae1272278cddc66b37b upstream.
While upgrading from 4.16 to 5.2, we noticed these allocation errors in
the log of the new kernel:
SLUB: Unable to allocate memory on node -1, gfp=0xa20(GFP\_ATOMIC)
cache: tw\_sock\_TCPv6(960:helper-logs), object size: 232, buffer size: 240, default order: 1, min order: 0
node 0: slabs: 5, objs: 170, free: 0
slab\_out\_of\_memory+1
\_\_\_slab\_alloc+969
\_\_slab\_alloc+14
kmem\_cache\_alloc+346
inet\_twsk\_alloc+60
tcp\_time\_wait+46
tcp\_fin+206
tcp\_data\_queue+2034
tcp\_rcv\_state\_process+784
tcp\_v6\_do\_rcv+405
\_\_release\_sock+118
tcp\_close+385
inet\_release+46
\_\_sock\_release+55
sock\_close+17
\_\_fput+170
task\_work\_run+127
exit\_to\_usermode\_loop+191
do\_syscall\_64+212
entry\_SYSCALL\_64\_after\_hwframe+68
accompanied by an increase in machines going completely radio silent
under memory pressure.
One thing that changed since 4.16 is e699e2c6a654 ("net, mm: account
sock objects to kmemcg"), which made these slab caches subject to cgroup
memory accounting and control.
The problem with that is that cgroups, unlike the page allocator, do not
maintain dedicated atomic reserves. As a cgroup's usage hovers at its
limit, atomic allocations - such as done during network rx - can fail
consistently for extended periods of time. The kernel is not able to
operate under these conditions.
We don't want to revert the culprit patch, because it indeed tracks a
potentially substantial amount of memory used by a cgroup.
We also don't want to implement dedicated atomic reserves for cgroups.
There is no point in keeping a fixed margin of unused bytes in the
cgroup's memory budget to accomodate a consumer that is impossible to
predict - we'd be wasting memory and get into configuration headaches,
not unlike what we have going with min\_free\_kbytes. We do this for
physical mem because we have to, but cgroups are an accounting game.
Instead, account these privileged allocations to the cgroup, but let
them bypass the configured limit if they have to. This way, we get the
benefits of accounting the consumed memory and have it exert pressure on
the rest of the cgroup, but like with the page allocator, we shift the
burden of reclaimining on behalf of atomic allocations onto the regular
allocations that can block.
Link: http://lkml.kernel.org/r/20191022233708.365764-1-hannes@cmpxchg.org
Fixes: e699e2c6a654 ("net, mm: account sock objects to kmemcg")
Signed-off-by: Johannes Weiner
Reviewed-by: Shakeel Butt
Cc: Suleiman Souhlal
Cc: Michal Hocko
Cc:  [4.18+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit acbeba2a7d5296ccec9b73ab596dc01fdb3a4430
Author: Shakeel Butt
Date: Tue Nov 5 21:16:21 2019 -0800
mm: memcontrol: fix NULL-ptr deref in percpu stats flush
commit 7961eee3978475fd9e8626137f88595b1ca05856 upstream.
\_\_mem\_cgroup\_free() can be called on the failure path in
mem\_cgroup\_alloc(). However memcg\_flush\_percpu\_vmstats() and
memcg\_flush\_percpu\_vmevents() which are called from \_\_mem\_cgroup\_free()
access the fields of memcg which can potentially be null if called from
failure path from mem\_cgroup\_alloc(). Indeed syzbot has reported the
following crash:
kasan: CONFIG\_KASAN\_INLINE enabled
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] PREEMPT SMP KASAN
CPU: 0 PID: 30393 Comm: syz-executor.1 Not tainted 5.4.0-rc2+ #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:memcg\_flush\_percpu\_vmstats+0x4ae/0x930 mm/memcontrol.c:3436
Code: 05 41 89 c0 41 0f b6 04 24 41 38 c7 7c 08 84 c0 0f 85 5d 03 00 00 44 3b 05 33 d5 12 08 0f 83 e2 00 00 00 4c 89 f0 48 c1 e8 03 <42> 80 3c 28 00 0f 85 91 03 00 00 48 8b 85 10 fe ff ff 48 8b b0 90
RSP: 0018:ffff888095c27980 EFLAGS: 00010206
RAX: 0000000000000012 RBX: ffff888095c27b28 RCX: ffffc90008192000
RDX: 0000000000040000 RSI: ffffffff8340fae7 RDI: 0000000000000007
RBP: ffff888095c27be0 R08: 0000000000000000 R09: ffffed1013f0da33
R10: ffffed1013f0da32 R11: ffff88809f86d197 R12: fffffbfff138b760
R13: dffffc0000000000 R14: 0000000000000090 R15: 0000000000000007
FS: 00007f5027170700(0000) GS:ffff8880ae800000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000710158 CR3: 00000000a7b18000 CR4: 00000000001406f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
\_\_mem\_cgroup\_free+0x1a/0x190 mm/memcontrol.c:5021
mem\_cgroup\_free mm/memcontrol.c:5033 [inline]
mem\_cgroup\_css\_alloc+0x3a1/0x1ae0 mm/memcontrol.c:5160
css\_create kernel/cgroup/cgroup.c:5156 [inline]
cgroup\_apply\_control\_enable+0x44d/0xc40 kernel/cgroup/cgroup.c:3119
cgroup\_mkdir+0x899/0x11b0 kernel/cgroup/cgroup.c:5401
kernfs\_iop\_mkdir+0x14d/0x1d0 fs/kernfs/dir.c:1124
vfs\_mkdir+0x42e/0x670 fs/namei.c:3807
do\_mkdirat+0x234/0x2a0 fs/namei.c:3830
\_\_do\_sys\_mkdir fs/namei.c:3846 [inline]
\_\_se\_sys\_mkdir fs/namei.c:3844 [inline]
\_\_x64\_sys\_mkdir+0x5c/0x80 fs/namei.c:3844
do\_syscall\_64+0xfa/0x760 arch/x86/entry/common.c:290
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
Fixing this by moving the flush to mem\_cgroup\_free as there is no need
to flush anything if we see failure in mem\_cgroup\_alloc().
Link: http://lkml.kernel.org/r/20191018165231.249872-1-shakeelb@google.com
Fixes: bb65f89b7d3d ("mm: memcontrol: flush percpu vmevents before releasing memcg")
Fixes: c350a99ea2b1 ("mm: memcontrol: flush percpu vmstats before releasing memcg")
Signed-off-by: Shakeel Butt
Reported-by: syzbot+515d5bcfe179cdf049b2@syzkaller.appspotmail.com
Reviewed-by: Roman Gushchin
Cc: Michal Hocko
Cc: Johannes Weiner
Cc: Vladimir Davydov
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3e76678e3237f09ed791ba1d8b0f1195816d1b46
Author: Takashi Iwai
Date: Tue Nov 5 14:43:16 2019 +0100
ALSA: hda/ca0132 - Fix possible workqueue stall
commit 15c2b3cc09a31620914955cb2a89c277c18ee999 upstream.
The unsolicited event handler for the headphone jack on CA0132 codec
driver tries to reschedule the another delayed work with
cancel\_delayed\_work\_sync(). It's no good idea, unfortunately,
especially after we changed the work queue to the standard global
one; this may lead to a stall because both works are using the same
global queue.
Fix it by dropping the \_sync but does call cancel\_delayed\_work()
instead.
Fixes: 993884f6a26c ("ALSA: hda/ca0132 - Delay HP amp turnon.")
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1155836
Cc:
Link: https://lore.kernel.org/r/20191105134316.19294-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ade96d0d8008f1a696b1bf41e6f36d54ddabb94c
Author: Takashi Sakamoto
Date: Sun Nov 3 00:09:20 2019 +0900
ALSA: bebob: fix to detect configured source of sampling clock for Focusrite Saffire Pro i/o series
commit 706ad6746a66546daf96d4e4a95e46faf6cf689a upstream.
For Focusrite Saffire Pro i/o, the lowest 8 bits of register represents
configured source of sampling clock. The next lowest 8 bits represents
whether the configured source is actually detected or not just after
the register is changed for the source.
Current implementation evaluates whole the register to detect configured
source. This results in failure due to the next lowest 8 bits when the
source is connected in advance.
This commit fixes the bug.
Fixes: 25784ec2d034 ("ALSA: bebob: Add support for Focusrite Saffire/SaffirePro series")
Cc:  # v3.16+
Signed-off-by: Takashi Sakamoto
Link: https://lore.kernel.org/r/20191102150920.20367-1-o-takashi@sakamocchi.jp
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b6acd3013c1c705dbc9af9ef47d76f7110f5d450
Author: Takashi Iwai
Date: Wed Nov 6 17:55:47 2019 +0100
ALSA: timer: Fix incorrectly assigned timer instance
commit e7af6307a8a54f0b873960b32b6a644f2d0fbd97 upstream.
The clean up commit 41672c0c24a6 ("ALSA: timer: Simplify error path in
snd\_timer\_open()") unified the error handling code paths with the
standard goto, but it introduced a subtle bug: the timer instance is
stored in snd\_timer\_open() incorrectly even if it returns an error.
This may eventually lead to UAF, as spotted by fuzzer.
The culprit is the snd\_timer\_open() code checks the
SNDRV\_TIMER\_IFLG\_EXCLUSIVE flag with the common variable timeri.
This variable is supposed to be the newly created instance, but we
(ab-)used it for a temporary check before the actual creation of a
timer instance. After that point, there is another check for the max
number of instances, and it bails out if over the threshold. Before
the refactoring above, it worked fine because the code returned
directly from that point. After the refactoring, however, it jumps to
the unified error path that stores the timeri variable in return --
even if it returns an error. Unfortunately this stored value is kept
in the caller side (snd\_timer\_user\_tselect()) in tu->timeri. This
causes inconsistency later, as if the timer was successfully
assigned.
In this patch, we fix it by not re-using timeri variable but a
temporary variable for testing the exclusive connection, so timeri
remains NULL at that point.
Fixes: 41672c0c24a6 ("ALSA: timer: Simplify error path in snd\_timer\_open()")
Reported-and-tested-by: Tristan Madani
Cc:
Link: https://lore.kernel.org/r/20191106165547.23518-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 9aa247c24ca4671cb40a9fd5f9e21d574119c14a
Author: Heiner Kallweit
Date: Wed Nov 6 21:51:31 2019 +0100
r8169: fix page read in r8168g\_mdio\_read
[ Upstream commit 9c6850fea3edefef6e7153b2c466f09155399882 ]
Functions like phy\_modify\_paged() read the current page, on Realtek
PHY's this means reading the value of register 0x1f. Add special
handling for reading this register, similar to what we do already
in r8168g\_mdio\_write(). Currently we read a random value that by
chance seems to be 0 always.
Fixes: a2928d28643e ("r8169: use paged versions of phylib MDIO access functions")
Signed-off-by: Heiner Kallweit
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8e9b5e8d8ffe8613fb7f460c10d1d38b3e528206
Author: Stefano Garzarella
Date: Fri Nov 8 17:08:50 2019 +0100
vsock/virtio: fix sock refcnt holding during the shutdown
[ Upstream commit ad8a7220355d39cddce8eac1cea9677333e8b821 ]
The "42f5cda5eaf4" commit rightly set SOCK\_DONE on peer shutdown,
but there is an issue if we receive the SHUTDOWN(RDWR) while the
virtio\_transport\_close\_timeout() is scheduled.
In this case, when the timeout fires, the SOCK\_DONE is already
set and the virtio\_transport\_close\_timeout() will not call
virtio\_transport\_reset() and virtio\_transport\_do\_close().
This causes that both sockets remain open and will never be released,
preventing the unloading of [virtio|vhost]\_transport modules.
This patch fixes this issue, calling virtio\_transport\_reset() and
virtio\_transport\_do\_close() when we receive the SHUTDOWN(RDWR)
and there is nothing left to read.
Fixes: 42f5cda5eaf4 ("vsock/virtio: set SOCK\_DONE on peer shutdown")
Cc: Stephen Barber
Signed-off-by: Stefano Garzarella
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e8ac0e74005f476cbadec7d0f076c44de8ea0e96
Author: Ursula Braun
Date: Wed Nov 6 10:49:57 2019 +0100
net/smc: fix ethernet interface refcounting
[ Upstream commit 98f3375505b8d6517bd6710bc6d4f6289eeb30aa ]
If a pnet table entry is to be added mentioning a valid ethernet
interface, but an invalid infiniband or ISM device, the dev\_put()
operation for the ethernet interface is called twice, resulting
in a negative refcount for the ethernet interface, which disables
removal of such a network interface.
This patch removes one of the dev\_put() calls.
Fixes: 890a2cb4a966 ("net/smc: rework pnet table")
Signed-off-by: Ursula Braun
Signed-off-by: Karsten Graul
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 16f4842ab3250157ca5aa79bb0ed87ef3ece367b
Author: John Hurley
Date: Sat Nov 2 14:17:47 2019 +0000
net: sched: prevent duplicate flower rules from tcf\_proto destroy race
[ Upstream commit 59eb87cb52c9f7164804bc8639c4d03ba9b0c169 ]
When a new filter is added to cls\_api, the function
tcf\_chain\_tp\_insert\_unique() looks up the protocol/priority/chain to
determine if the tcf\_proto is duplicated in the chain's hashtable. It then
creates a new entry or continues with an existing one. In cls\_flower, this
allows the function fl\_ht\_insert\_unque to determine if a filter is a
duplicate and reject appropriately, meaning that the duplicate will not be
passed to drivers via the offload hooks. However, when a tcf\_proto is
destroyed it is removed from its chain before a hardware remove hook is
hit. This can lead to a race whereby the driver has not received the
remove message but duplicate flows can be accepted. This, in turn, can
lead to the offload driver receiving incorrect duplicate flows and out of
order add/delete messages.
Prevent duplicates by utilising an approach suggested by Vlad Buslov. A
hash table per block stores each unique chain/protocol/prio being
destroyed. This entry is only removed when the full destroy (and hardware
offload) has completed. If a new flow is being added with the same
identiers as a tc\_proto being detroyed, then the add request is replayed
until the destroy is complete.
Fixes: 8b64678e0af8 ("net: sched: refactor tp insert/delete for concurrent execution")
Signed-off-by: John Hurley
Signed-off-by: Vlad Buslov
Reviewed-by: Simon Horman
Reported-by: Louis Peens
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e6ba303408632e7cd680ed48a7b1a62fc977e244
Author: Eric Dumazet
Date: Mon Nov 4 21:38:43 2019 -0800
net: prevent load/store tearing on sk->sk\_stamp
[ Upstream commit f75359f3ac855940c5718af10ba089b8977bf339 ]
Add a couple of READ\_ONCE() and WRITE\_ONCE() to prevent
load-tearing and store-tearing in sock\_read\_timestamp()
and sock\_write\_timestamp()
This might prevent another KCSAN report.
Fixes: 3a0ed3e96197 ("sock: Make sock->sk\_stamp thread-safe")
Signed-off-by: Eric Dumazet
Cc: Deepa Dinamani
Acked-by: Deepa Dinamani
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7060f71ffaf5ff3245e7940a29285d713f80a987
Author: Salil Mehta
Date: Thu Nov 7 17:09:53 2019 +0000
net: hns: Fix the stray netpoll locks causing deadlock in NAPI path
[ Upstream commit bf5a6b4c474c589244dc25ee1af2c3c829228ef8 ]
This patch fixes the problem of the spin locks, originally
meant for the netpoll path of hns driver, causing deadlock in
the normal NAPI poll path. The issue happened due to the presence
of the stray leftover spin lock code related to the netpoll,
whose support was earlier removed from the HNS[1], got activated
due to enabling of NET\_POLL\_CONTROLLER switch.
Earlier background:
The netpoll handling code originally had this bug(as identified
by Marc Zyngier[2]) of wrong spin lock API being used which did
not disable the interrupts and hence could cause locking issues.
i.e. if the lock were first acquired in context to thread like
'ip' util and this lock if ever got later acquired again in
context to the interrupt context like TX/RX (Interrupts could
always pre-empt the lock holding task and acquire the lock again)
and hence could cause deadlock.
Proposed Solution:
1. If the netpoll was enabled in the HNS driver, which is not
right now, we could have simply used spin\_[un]lock\_irqsave()
2. But as netpoll is disabled, therefore, it is best to get rid
of the existing locks and stray code for now. This should
solve the problem reported by Marc.
[1] https://git.kernel.org/torvalds/c/4bd2c03be7
[2] https://patchwork.ozlabs.org/patch/1189139/
Fixes: 4bd2c03be707 ("net: hns: remove ndo\_poll\_controller")
Cc: lipeng
Cc: Yisen Zhuang
Cc: Eric Dumazet
Cc: David S. Miller
Reported-by: Marc Zyngier
Acked-by: Marc Zyngier
Tested-by: Marc Zyngier
Signed-off-by: Salil Mehta
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0f29865aaf3d227eeffcbd3f810355b1a1866cf5
Author: Eric Dumazet
Date: Thu Nov 7 09:26:19 2019 -0800
ipv6: fixes rt6\_probe() and fib6\_nh->last\_probe init
[ Upstream commit 1bef4c223b8588cf50433bdc2c6953d82949b3b3 ]
While looking at a syzbot KCSAN report [1], I found multiple
issues in this code :
1) fib6\_nh->last\_probe has an initial value of 0.
While probably okay on 64bit kernels, this causes an issue
on 32bit kernels since the time\_after(jiffies, 0 + interval)
might be false ~24 days after boot (for HZ=1000)
2) The data-race found by KCSAN
I could use READ\_ONCE() and WRITE\_ONCE(), but we also can
take the opportunity of not piling-up too many rt6\_probe\_deferred()
works by using instead cmpxchg() so that only one cpu wins the race.
[1]
BUG: KCSAN: data-race in find\_match / find\_match
write to 0xffff8880bb7aabe8 of 8 bytes by interrupt on cpu 1:
rt6\_probe net/ipv6/route.c:663 [inline]
find\_match net/ipv6/route.c:757 [inline]
find\_match+0x5bd/0x790 net/ipv6/route.c:733
\_\_find\_rr\_leaf+0xe3/0x780 net/ipv6/route.c:831
find\_rr\_leaf net/ipv6/route.c:852 [inline]
rt6\_select net/ipv6/route.c:896 [inline]
fib6\_table\_lookup+0x383/0x650 net/ipv6/route.c:2164
ip6\_pol\_route+0xee/0x5c0 net/ipv6/route.c:2200
ip6\_pol\_route\_output+0x48/0x60 net/ipv6/route.c:2452
fib6\_rule\_lookup+0x3d6/0x470 net/ipv6/fib6\_rules.c:117
ip6\_route\_output\_flags\_noref+0x16b/0x230 net/ipv6/route.c:2484
ip6\_route\_output\_flags+0x50/0x1a0 net/ipv6/route.c:2497
ip6\_dst\_lookup\_tail+0x25d/0xc30 net/ipv6/ip6\_output.c:1049
ip6\_dst\_lookup\_flow+0x68/0x120 net/ipv6/ip6\_output.c:1150
inet6\_csk\_route\_socket+0x2f7/0x420 net/ipv6/inet6\_connection\_sock.c:106
inet6\_csk\_xmit+0x91/0x1f0 net/ipv6/inet6\_connection\_sock.c:121
\_\_tcp\_transmit\_skb+0xe81/0x1d60 net/ipv4/tcp\_output.c:1169
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1185 [inline]
tcp\_xmit\_probe\_skb+0x19b/0x1d0 net/ipv4/tcp\_output.c:3735
read to 0xffff8880bb7aabe8 of 8 bytes by interrupt on cpu 0:
rt6\_probe net/ipv6/route.c:657 [inline]
find\_match net/ipv6/route.c:757 [inline]
find\_match+0x521/0x790 net/ipv6/route.c:733
\_\_find\_rr\_leaf+0xe3/0x780 net/ipv6/route.c:831
find\_rr\_leaf net/ipv6/route.c:852 [inline]
rt6\_select net/ipv6/route.c:896 [inline]
fib6\_table\_lookup+0x383/0x650 net/ipv6/route.c:2164
ip6\_pol\_route+0xee/0x5c0 net/ipv6/route.c:2200
ip6\_pol\_route\_output+0x48/0x60 net/ipv6/route.c:2452
fib6\_rule\_lookup+0x3d6/0x470 net/ipv6/fib6\_rules.c:117
ip6\_route\_output\_flags\_noref+0x16b/0x230 net/ipv6/route.c:2484
ip6\_route\_output\_flags+0x50/0x1a0 net/ipv6/route.c:2497
ip6\_dst\_lookup\_tail+0x25d/0xc30 net/ipv6/ip6\_output.c:1049
ip6\_dst\_lookup\_flow+0x68/0x120 net/ipv6/ip6\_output.c:1150
inet6\_csk\_route\_socket+0x2f7/0x420 net/ipv6/inet6\_connection\_sock.c:106
inet6\_csk\_xmit+0x91/0x1f0 net/ipv6/inet6\_connection\_sock.c:121
\_\_tcp\_transmit\_skb+0xe81/0x1d60 net/ipv4/tcp\_output.c:1169
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 18894 Comm: udevd Not tainted 5.4.0-rc3+ #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Fixes: cc3a86c802f0 ("ipv6: Change rt6\_probe to take a fib6\_nh")
Fixes: f547fac624be ("ipv6: rate-limit probes for neighbourless routes")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d83d1cb178385055ac949bfda8fc2fea0a6d750a
Author: Jakub Kicinski
Date: Tue Nov 5 14:24:36 2019 -0800
selftests/tls: add test for concurrent recv and send
[ Upstream commit 41098af59d8d753aa8d3bb4310cc4ecb61fc82c7 ]
Add a test which spawns 16 threads and performs concurrent
send and recv calls on the same socket.
Signed-off-by: Jakub Kicinski
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c8d6817345f4ba228d07380e571676405e112872
Author: Jakub Kicinski
Date: Tue Nov 5 14:24:35 2019 -0800
net/tls: add a TX lock
[ Upstream commit 79ffe6087e9145d2377385cac48d0d6a6b4225a5 ]
TLS TX needs to release and re-acquire the socket lock if send buffer
fills up.
TLS SW TX path currently depends on only allowing one thread to enter
the function by the abuse of sk\_write\_pending. If another writer is
already waiting for memory no new ones are allowed in.
This has two problems:
- writers don't wake other threads up when they leave the kernel;
meaning that this scheme works for single extra thread (second
application thread or delayed work) because memory becoming
available will send a wake up request, but as Mallesham and
Pooja report with larger number of threads it leads to threads
being put to sleep indefinitely;
- the delayed work does not get \_scheduled\_ but it may \_run\_ when
other writers are present leading to crashes as writers don't
expect state to change under their feet (same records get pushed
and freed multiple times); it's hard to reliably bail from the
work, however, because the mere presence of a writer does not
guarantee that the writer will push pending records before exiting.
Ensuring wakeups always happen will make the code basically open
code a mutex. Just use a mutex.
The TLS HW TX path does not have any locking (not even the
sk\_write\_pending hack), yet it uses a per-socket sg\_tx\_data
array to push records.
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Reported-by: Mallesham Jatharakonda
Reported-by: Pooja Trivedi
Signed-off-by: Jakub Kicinski
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 55d2cda3f982a81fd4dcc9f0f2af7fe14cc5c8aa
Author: Jakub Kicinski
Date: Tue Nov 5 14:24:34 2019 -0800
net/tls: don't pay attention to sk\_write\_pending when pushing partial records
[ Upstream commit 02b1fa07bb58f5d1f349b5b09eb936739a7b20fc ]
sk\_write\_pending being not zero does not guarantee that partial
record will be pushed. If the thread waiting for memory times out
the pending record may get stuck.
In case of tls\_device there is no path where parial record is
set and writer present in the first place. Partial record is
set only in tls\_push\_sg() and tls\_push\_sg() will return an
error immediately. All tls\_device callers of tls\_push\_sg()
will return (and not wait for memory) if it failed.
Fixes: a42055e8d2c3 ("net/tls: Add support for async encryption of records for performance")
Signed-off-by: Jakub Kicinski
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit ffa40969e500ced9140ad83066dd31b40d6751f2
Author: Claudiu Manoil
Date: Tue Nov 5 23:50:14 2019 +0200
net: mscc: ocelot: fix NULL pointer on LAG slave removal
[ Upstream commit 3b3eed8eec47259939ee6c3d58aea1c311ddee3b ]
lag\_upper\_info may be NULL on slave removal.
Fixes: dc96ee3730fc ("net: mscc: ocelot: add bonding support")
Signed-off-by: Claudiu Manoil
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 94b6375049d22737dd4dfeb84fb8b81761bed1cb
Author: Claudiu Manoil
Date: Tue Nov 5 23:50:13 2019 +0200
net: mscc: ocelot: don't handle netdev events for other netdevs
[ Upstream commit 7afb3e575e5aa9f5a200a3eb3f45d8130f6d6601 ]
The check that the event is actually for this device should be moved
from the "port" handler to the net device handler.
Otherwise the port handler will deny bonding configuration for other
net devices in the same system (like enetc in the LS1028A) that don't
have the lag\_upper\_info->tx\_type restriction that ocelot has.
Fixes: dc96ee3730fc ("net: mscc: ocelot: add bonding support")
Signed-off-by: Claudiu Manoil
Signed-off-by: Vladimir Oltean
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d67f9a20b857c5b1090eb18d6cb60e28347feb22
Author: Manish Chopra
Date: Fri Nov 8 02:42:30 2019 -0800
qede: fix NULL pointer deref in \_\_qede\_remove()
[ Upstream commit deabc87111c690097c03765ea017cd500f7376fc ]
While rebooting the system with SR-IOV vfs enabled leads
to below crash due to recurrence of \_\_qede\_remove() on the VF
devices (first from .shutdown() flow of the VF itself and
another from PF's .shutdown() flow executing pci\_disable\_sriov())
This patch adds a safeguard in \_\_qede\_remove() flow to fix this,
so that driver doesn't attempt to remove "already removed" devices.
[ 194.360134] BUG: unable to handle kernel NULL pointer dereference at 00000000000008dc
[ 194.360227] IP: [] \_\_qede\_remove+0x24/0x130 [qede]
[ 194.360304] PGD 0
[ 194.360325] Oops: 0000 [#1] SMP
[ 194.360360] Modules linked in: tcp\_lp fuse tun bridge stp llc devlink bonding ip\_set nfnetlink ib\_isert iscsi\_target\_mod ib\_srpt target\_core\_mod ib\_srp scsi\_transport\_srp scsi\_tgt ib\_ipoib ib\_umad rpcrdma sunrpc rdma\_ucm ib\_uverbs ib\_iser rdma\_cm iw\_cm ib\_cm libiscsi scsi\_transport\_iscsi dell\_smbios iTCO\_wdt iTCO\_vendor\_support dell\_wmi\_descriptor dcdbas vfat fat pcc\_cpufreq skx\_edac intel\_powerclamp coretemp intel\_rapl iosf\_mbi kvm\_intel kvm irqbypass crc32\_pclmul ghash\_clmulni\_intel aesni\_intel lrw gf128mul glue\_helper ablk\_helper cryptd qedr ib\_core pcspkr ses enclosure joydev ipmi\_ssif sg i2c\_i801 lpc\_ich mei\_me mei wmi ipmi\_si ipmi\_devintf ipmi\_msghandler tpm\_crb acpi\_pad acpi\_power\_meter xfs libcrc32c sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_pclmul crct10dif\_common crc32c\_intel mgag200
[ 194.361044] qede i2c\_algo\_bit drm\_kms\_helper qed syscopyarea sysfillrect nvme sysimgblt fb\_sys\_fops ttm nvme\_core mpt3sas crc8 ptp drm pps\_core ahci raid\_class scsi\_transport\_sas libahci libata drm\_panel\_orientation\_quirks nfit libnvdimm dm\_mirror dm\_region\_hash dm\_log dm\_mod [last unloaded: ip\_tables]
[ 194.361297] CPU: 51 PID: 7996 Comm: reboot Kdump: loaded Not tainted 3.10.0-1062.el7.x86\_64 #1
[ 194.361359] Hardware name: Dell Inc. PowerEdge MX840c/0740HW, BIOS 2.4.6 10/15/2019
[ 194.361412] task: ffff9cea9b360000 ti: ffff9ceabebdc000 task.ti: ffff9ceabebdc000
[ 194.361463] RIP: 0010:[] [] \_\_qede\_remove+0x24/0x130 [qede]
[ 194.361534] RSP: 0018:ffff9ceabebdfac0 EFLAGS: 00010282
[ 194.361570] RAX: 0000000000000000 RBX: ffff9cd013846098 RCX: 0000000000000000
[ 194.361621] RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff9cd013846098
[ 194.361668] RBP: ffff9ceabebdfae8 R08: 0000000000000000 R09: 0000000000000000
[ 194.361715] R10: 00000000bfe14201 R11: ffff9ceabfe141e0 R12: 0000000000000000
[ 194.361762] R13: ffff9cd013846098 R14: 0000000000000000 R15: ffff9ceab5e48000
[ 194.361810] FS: 00007f799c02d880(0000) GS:ffff9ceacb0c0000(0000) knlGS:0000000000000000
[ 194.361865] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 194.361903] CR2: 00000000000008dc CR3: 0000001bdac76000 CR4: 00000000007607e0
[ 194.361953] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 194.362002] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 194.362051] PKRU: 55555554
[ 194.362073] Call Trace:
[ 194.362109] [] qede\_remove+0x10/0x20 [qede]
[ 194.362180] [] pci\_device\_remove+0x3e/0xc0
[ 194.362240] [] \_\_device\_release\_driver+0x82/0xf0
[ 194.362285] [] device\_release\_driver+0x23/0x30
[ 194.362343] [] pci\_stop\_bus\_device+0x84/0xa0
[ 194.362388] [] pci\_stop\_and\_remove\_bus\_device+0x12/0x20
[ 194.362450] [] pci\_iov\_remove\_virtfn+0xaf/0x160
[ 194.362496] [] sriov\_disable+0x3c/0xf0
[ 194.362534] [] pci\_disable\_sriov+0x23/0x30
[ 194.362599] [] qed\_sriov\_disable+0x5e3/0x650 [qed]
[ 194.362658] [] ? kfree+0x106/0x140
[ 194.362709] [] ? qed\_free\_stream\_mem+0x70/0x90 [qed]
[ 194.362754] [] ? kfree+0x106/0x140
[ 194.362803] [] qed\_slowpath\_stop+0x1a9/0x1d0 [qed]
[ 194.362854] [] \_\_qede\_remove+0xae/0x130 [qede]
[ 194.362904] [] qede\_shutdown+0x10/0x20 [qede]
[ 194.362956] [] pci\_device\_shutdown+0x3a/0x60
[ 194.363010] [] device\_shutdown+0xfb/0x1f0
[ 194.363066] [] kernel\_restart\_prepare+0x36/0x40
[ 194.363107] [] kernel\_restart+0x12/0x60
[ 194.363146] [] SYSC\_reboot+0x229/0x260
[ 194.363196] [] ? handle\_mm\_fault+0x39d/0x9b0
[ 194.363253] [] ? \_\_switch\_to+0x151/0x580
[ 194.363304] [] ? \_\_schedule+0x448/0x9c0
[ 194.363343] [] SyS\_reboot+0xe/0x10
[ 194.363387] [] system\_call\_fastpath+0x25/0x2a
[ 194.363430] Code: f9 e9 37 ff ff ff 90 0f 1f 44 00 00 55 48 89 e5 41 57 41 56 41 55 4c 8d af 98 00 00 00 41 54 4c 89 ef 41 89 f4 53 e8 4c e4 55 f9 <80> b8 dc 08 00 00 01 48 89 c3 4c 8d b8 c0 08 00 00 4c 8b b0 c0
[ 194.363712] RIP [] \_\_qede\_remove+0x24/0x130 [qede]
[ 194.363764] RSP
[ 194.363791] CR2: 00000000000008dc
Signed-off-by: Manish Chopra
Signed-off-by: Ariel Elior
Signed-off-by: Sudarsana Kalluru
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit df3addccc88cf943d75c9485edfbfb437ac3c485
Author: Pan Bian
Date: Thu Nov 7 09:33:20 2019 +0800
NFC: st21nfca: fix double free
[ Upstream commit 99a8efbb6e30b72ac98cecf81103f847abffb1e5 ]
The variable nfcid\_skb is not changed in the callee nfc\_hci\_get\_param()
if error occurs. Consequently, the freed variable nfcid\_skb will be
freed again, resulting in a double free bug. Set nfcid\_skb to NULL after
releasing it to fix the bug.
Signed-off-by: Pan Bian
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8e9b0ae6bec8fc9c7e6a02c03c5ae668c08004b1
Author: Pan Bian
Date: Thu Nov 7 14:29:50 2019 +0800
nfc: netlink: fix double device reference drop
[ Upstream commit 025ec40b81d785a98f76b8bdb509ac10773b4f12 ]
The function nfc\_put\_device(dev) is called twice to drop the reference
to dev when there is no associated local llcp. Remove one of them to fix
the bug.
Fixes: 52feb444a903 ("NFC: Extend netlink interface for LTO, RW, and MIUX parameters support")
Fixes: d9b8d8e19b07 ("NFC: llcp: Service Name Lookup netlink interface")
Signed-off-by: Pan Bian
Reviewed-by: Johan Hovold
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 20859d12090362cf344d4ec5c633d69c1eaada40
Author: Pan Bian
Date: Tue Nov 5 16:34:07 2019 +0800
NFC: fdp: fix incorrect free object
[ Upstream commit 517ce4e93368938b204451285e53014549804868 ]
The address of fw\_vsc\_cfg is on stack. Releasing it with devm\_kfree() is
incorrect, which may result in a system crash or other security impacts.
The expected object to free is \*fw\_vsc\_cfg.
Signed-off-by: Pan Bian
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit c076d78844658b5d33e4c7d603c5ca6f6898e18d
Author: Aleksander Morgado
Date: Thu Nov 7 11:57:01 2019 +0100
net: usb: qmi\_wwan: add support for DW5821e with eSIM support
[ Upstream commit e497df686e8fed8c1dd69179010656362858edb3 ]
Exactly same layout as the default DW5821e module, just a different
vid/pid.
The QMI interface is exposed in USB configuration #1:
P: Vendor=413c ProdID=81e0 Rev=03.18
S: Manufacturer=Dell Inc.
S: Product=DW5821e-eSIM Snapdragon X20 LTE
S: SerialNumber=0123456789ABCDEF
C: #Ifs= 6 Cfg#= 1 Atr=a0 MxPwr=500mA
I: If#=0x0 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=qmi\_wwan
I: If#=0x1 Alt= 0 #EPs= 1 Cls=03(HID ) Sub=00 Prot=00 Driver=usbhid
I: If#=0x2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=option
I: If#=0x5 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=option
Signed-off-by: Aleksander Morgado
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit b33115512984b263ef69476e1137e6485a6fcd09
Author: Jakub Kicinski
Date: Mon Nov 4 15:36:57 2019 -0800
net/tls: fix sk\_msg trim on fallback to copy mode
[ Upstream commit 683916f6a84023407761d843048f1aea486b2612 ]
sk\_msg\_trim() tries to only update curr pointer if it falls into
the trimmed region. The logic, however, does not take into the
account pointer wrapping that sk\_msg\_iter\_var\_prev() does nor
(as John points out) the fact that msg->sg is a ring buffer.
This means that when the message was trimmed completely, the new
curr pointer would have the value of MAX\_MSG\_FRAGS - 1, which is
neither smaller than any other value, nor would it actually be
correct.
Special case the trimming to 0 length a little bit and rework
the comparison between curr and end to take into account wrapping.
This bug caused the TLS code to not copy all of the message, if
zero copy filled in fewer sg entries than memcopy would need.
Big thanks to Alexander Potapenko for the non-KMSAN reproducer.
v2:
- take into account that msg->sg is a ring buffer (John).
Link: https://lore.kernel.org/netdev/20191030160542.30295-1-jakub.kicinski@netronome.com/ (v1)
Fixes: d829e9c4112b ("tls: convert to generic sk\_msg interface")
Reported-by: syzbot+f8495bff23a879a6d0bd@syzkaller.appspotmail.com
Reported-by: syzbot+6f50c99e8f6194bf363f@syzkaller.appspotmail.com
Co-developed-by: John Fastabend
Signed-off-by: Jakub Kicinski
Signed-off-by: John Fastabend
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3c8593ad56dee97d177e1db3cf77de842c74974e
Author: Sean Tranchetti
Date: Mon Nov 4 17:54:22 2019 -0700
net: qualcomm: rmnet: Fix potential UAF when unregistering
[ Upstream commit e7a86c687e64ab24f88330ad24ecc9442ce40c5a ]
During the exit/unregistration process of the RmNet driver, the function
rmnet\_unregister\_real\_device() is called to handle freeing the driver's
internal state and removing the RX handler on the underlying physical
device. However, the order of operations this function performs is wrong
and can lead to a use after free of the rmnet\_port structure.
Before calling netdev\_rx\_handler\_unregister(), this port structure is
freed with kfree(). If packets are received on any RmNet devices before
synchronize\_net() completes, they will attempt to use this already-freed
port structure when processing the packet. As such, before cleaning up any
other internal state, the RX handler must be unregistered in order to
guarantee that no further packets will arrive on the device.
Fixes: ceed73a2cf4a ("drivers: net: ethernet: qualcomm: rmnet: Initial implementation")
Signed-off-by: Sean Tranchetti
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d9f19b54f771ee8449ceacbe9250bd42b386ba33
Author: Eric Dumazet
Date: Thu Nov 7 20:08:19 2019 -0800
net: fix data-race in neigh\_event\_send()
[ Upstream commit 1b53d64435d56902fc234ff2507142d971a09687 ]
KCSAN reported the following data-race [1]
The fix will also prevent the compiler from optimizing out
the condition.
[1]
BUG: KCSAN: data-race in neigh\_resolve\_output / neigh\_resolve\_output
write to 0xffff8880a41dba78 of 8 bytes by interrupt on cpu 1:
neigh\_event\_send include/net/neighbour.h:443 [inline]
neigh\_resolve\_output+0x78/0x480 net/core/neighbour.c:1474
neigh\_output include/net/neighbour.h:511 [inline]
ip\_finish\_output2+0x4af/0xe40 net/ipv4/ip\_output.c:228
\_\_ip\_finish\_output net/ipv4/ip\_output.c:308 [inline]
\_\_ip\_finish\_output+0x23a/0x490 net/ipv4/ip\_output.c:290
ip\_finish\_output+0x41/0x160 net/ipv4/ip\_output.c:318
NF\_HOOK\_COND include/linux/netfilter.h:294 [inline]
ip\_output+0xdf/0x210 net/ipv4/ip\_output.c:432
dst\_output include/net/dst.h:436 [inline]
ip\_local\_out+0x74/0x90 net/ipv4/ip\_output.c:125
\_\_ip\_queue\_xmit+0x3a8/0xa40 net/ipv4/ip\_output.c:532
ip\_queue\_xmit+0x45/0x60 include/net/ip.h:237
\_\_tcp\_transmit\_skb+0xe81/0x1d60 net/ipv4/tcp\_output.c:1169
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1185 [inline]
\_\_tcp\_retransmit\_skb+0x4bd/0x15f0 net/ipv4/tcp\_output.c:2976
tcp\_retransmit\_skb+0x36/0x1a0 net/ipv4/tcp\_output.c:2999
tcp\_retransmit\_timer+0x719/0x16d0 net/ipv4/tcp\_timer.c:515
tcp\_write\_timer\_handler+0x42d/0x510 net/ipv4/tcp\_timer.c:598
tcp\_write\_timer+0xd1/0xf0 net/ipv4/tcp\_timer.c:618
read to 0xffff8880a41dba78 of 8 bytes by interrupt on cpu 0:
neigh\_event\_send include/net/neighbour.h:442 [inline]
neigh\_resolve\_output+0x57/0x480 net/core/neighbour.c:1474
neigh\_output include/net/neighbour.h:511 [inline]
ip\_finish\_output2+0x4af/0xe40 net/ipv4/ip\_output.c:228
\_\_ip\_finish\_output net/ipv4/ip\_output.c:308 [inline]
\_\_ip\_finish\_output+0x23a/0x490 net/ipv4/ip\_output.c:290
ip\_finish\_output+0x41/0x160 net/ipv4/ip\_output.c:318
NF\_HOOK\_COND include/linux/netfilter.h:294 [inline]
ip\_output+0xdf/0x210 net/ipv4/ip\_output.c:432
dst\_output include/net/dst.h:436 [inline]
ip\_local\_out+0x74/0x90 net/ipv4/ip\_output.c:125
\_\_ip\_queue\_xmit+0x3a8/0xa40 net/ipv4/ip\_output.c:532
ip\_queue\_xmit+0x45/0x60 include/net/ip.h:237
\_\_tcp\_transmit\_skb+0xe81/0x1d60 net/ipv4/tcp\_output.c:1169
tcp\_transmit\_skb net/ipv4/tcp\_output.c:1185 [inline]
\_\_tcp\_retransmit\_skb+0x4bd/0x15f0 net/ipv4/tcp\_output.c:2976
tcp\_retransmit\_skb+0x36/0x1a0 net/ipv4/tcp\_output.c:2999
tcp\_retransmit\_timer+0x719/0x16d0 net/ipv4/tcp\_timer.c:515
tcp\_write\_timer\_handler+0x42d/0x510 net/ipv4/tcp\_timer.c:598
Reported by Kernel Concurrency Sanitizer on:
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.4.0-rc3+ #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 11c6dd3bd60ad547ab2f1e0716c08c8562ebb008
Author: Alexander Sverdlin
Date: Fri Nov 8 10:00:44 2019 +0000
net: ethernet: octeon\_mgmt: Account for second possible VLAN header
[ Upstream commit e4dd5608033efe7b6030cde359bfdbaeb73bc22d ]
Octeon's input ring-buffer entry has 14 bits-wide size field, so to account
for second possible VLAN header max\_mtu must be further reduced.
Fixes: 109cc16526c6d ("ethernet/cavium: use core min/max MTU checking")
Signed-off-by: Alexander Sverdlin
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 07deb878eaea0959d145f6c53991d09ae8a7fe6b
Author: David Ahern
Date: Thu Nov 7 18:29:52 2019 +0000
ipv4: Fix table id reference in fib\_sync\_down\_addr
[ Upstream commit e0a312629fefa943534fc46f7bfbe6de3fdaf463 ]
Hendrik reported routes in the main table using source address are not
removed when the address is removed. The problem is that fib\_sync\_down\_addr
does not account for devices in the default VRF which are associated
with the main table. Fix by updating the table id reference.
Fixes: 5a56a0b3a45d ("net: Don't delete routes in different VRFs")
Reported-by: Hendrik Donner
Signed-off-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 679fd22c868409cb6c74f7d0887f46c4f14f7f75
Author: Oliver Neukum
Date: Thu Nov 7 09:48:01 2019 +0100
CDC-NCM: handle incomplete transfer of MTU
[ Upstream commit 332f989a3b0041b810836c5c3747e59aad7e9d0b ]
A malicious device may give half an answer when asked
for its MTU. The driver will proceed after this with
a garbage MTU. Anything but a complete answer must be treated
as an error.
V2: used sizeof as request by Alexander
Reported-and-tested-by: syzbot+0631d878823ce2411636@syzkaller.appspotmail.com
Signed-off-by: Oliver Neukum
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f6a3a22757204466af7960226d2c26e42f7d219e
Author: Jay Vosburgh
Date: Fri Nov 1 21:56:42 2019 -0700
bonding: fix state transition issue in link monitoring
[ Upstream commit 1899bb325149e481de31a4f32b59ea6f24e176ea ]
Since de77ecd4ef02 ("bonding: improve link-status update in
mii-monitoring"), the bonding driver has utilized two separate variables
to indicate the next link state a particular slave should transition to.
Each is used to communicate to a different portion of the link state
change commit logic; one to the bond\_miimon\_commit function itself, and
another to the state transition logic.
Unfortunately, the two variables can become unsynchronized,
resulting in incorrect link state transitions within bonding. This can
cause slaves to become stuck in an incorrect link state until a
subsequent carrier state transition.
The issue occurs when a special case in bond\_slave\_netdev\_event
sets slave->link directly to BOND\_LINK\_FAIL. On the next pass through
bond\_miimon\_inspect after the slave goes carrier up, the BOND\_LINK\_FAIL
case will set the proposed next state (link\_new\_state) to BOND\_LINK\_UP,
but the new\_link to BOND\_LINK\_DOWN. The setting of the final link state
from new\_link comes after that from link\_new\_state, and so the slave
will end up incorrectly in \_DOWN state.
Resolve this by combining the two variables into one.
Reported-by: Aleksei Zakharov
Reported-by: Sha Zhang
Cc: Mahesh Bandewar
Fixes: de77ecd4ef02 ("bonding: improve link-status update in mii-monitoring")
Signed-off-by: Jay Vosburgh
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman


=== Content from security.netapp.com_f0c8e7d1_20250120_233842.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [December 2019 Linux Kernel Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20200103-0001)

## December 2019 Linux Kernel Vulnerabilities in NetApp Products

circle-check-alt

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20200103-0001 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20200103-0001 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20200103-0001 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20200103-0001 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20200103-0001
**Version:**
23.0

**Last updated:**
06/09/2022

**Status:**
Final.

**CVEs:** CVE-2019-14815, CVE-2019-19227, CVE-2019-10220, CVE-2019-19318, CVE-2019-14896, CVE-2019-19252, CVE-2019-18660, CVE-2019-19319, CVE-2019-10207, CVE-2019-18675, CVE-2019-19602, CVE-2019-19378, CVE-2019-19377, CVE-2019-19447, CVE-2019-19448, CVE-2019-19449, CVE-2019-19768, CVE-2019-19769, CVE-2019-19770, CVE-2019-19767, CVE-2019-19807, CVE-2019-19241, CVE-2019-19815, CVE-2019-19814, CVE-2019-19816, CVE-2019-19813

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions prior to 5.4.2 are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

Brocade Fabric Operating System Firmware affected only by CVE-2019-19767.

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2019-10207](https://nvd.nist.gov/vuln/detail/CVE-2019-10207) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-10220](https://nvd.nist.gov/vuln/detail/CVE-2019-10220) | 8.8 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-14815](https://nvd.nist.gov/vuln/detail/CVE-2019-14815) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-14896](https://nvd.nist.gov/vuln/detail/CVE-2019-14896) | 9.8 (CRITICAL) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-18660](https://nvd.nist.gov/vuln/detail/CVE-2019-18660) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N |
| [CVE-2019-18675](https://nvd.nist.gov/vuln/detail/CVE-2019-18675) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-19227](https://nvd.nist.gov/vuln/detail/CVE-2019-19227) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-19241](https://nvd.nist.gov/vuln/detail/CVE-2019-19241) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-19252](https://nvd.nist.gov/vuln/detail/CVE-2019-19252) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-19318](https://nvd.nist.gov/vuln/detail/CVE-2019-19318) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H |
| [CVE-2019-19319](https://nvd.nist.gov/vuln/detail/CVE-2019-19319) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19377](https://nvd.nist.gov/vuln/detail/CVE-2019-19377) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19378](https://nvd.nist.gov/vuln/detail/CVE-2019-19378) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19447](https://nvd.nist.gov/vuln/detail/CVE-2019-19447) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19448](https://nvd.nist.gov/vuln/detail/CVE-2019-19448) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19449](https://nvd.nist.gov/vuln/detail/CVE-2019-19449) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19602](https://nvd.nist.gov/vuln/detail/CVE-2019-19602) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2019-19767](https://nvd.nist.gov/vuln/detail/CVE-2019-19767) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H |
| [CVE-2019-19768](https://nvd.nist.gov/vuln/detail/CVE-2019-19768) | 7.5 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-19769](https://nvd.nist.gov/vuln/detail/CVE-2019-19769) | 7.5 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-19770](https://nvd.nist.gov/vuln/detail/CVE-2019-19770) | 7.5 (HIGH) | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-19807](https://nvd.nist.gov/vuln/detail/CVE-2019-19807) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2019-19813](https://nvd.nist.gov/vuln/detail/CVE-2019-19813) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19814](https://nvd.nist.gov/vuln/detail/CVE-2019-19814) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |
| [CVE-2019-19815](https://nvd.nist.gov/vuln/detail/CVE-2019-19815) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H |
| [CVE-2019-19816](https://nvd.nist.gov/vuln/detail/CVE-2019-19816) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* AFF Baseboard Management Controller (BMC) - A700s
* Active IQ Unified Manager for VMware vSphere
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400
* NetApp Cloud Backup (formerly AltaVault)
* NetApp Data Availability Services
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire Baseboard Management Controller (BMC)
* NetApp SteelStore Cloud Integrated Storage

#### Products Not Affected

* 7-Mode Transition Tool
* ATTO FibreBridge - 6500N
* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ mobile app
* Astra Trident
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Insights Telegraf Agent
* Cloud Manager
* Cloud Secure Agent
* Cloud Volumes ONTAP Mediator
* Clustered Data ONTAP
* Clustered Data ONTAP Antivirus Connector
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Storage Manager
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element HealthTools
* Element Plug-in for vCenter Server
* FAS/AFF BIOS
* FAS/AFF Baseboard Management Controller (BMC) - A320/C190/A220/FAS2720/FAS2750/A800
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* MetroCluster Tiebreaker for clustered Data ONTAP
* NetApp Cloud Backup OST Plug-in (formerly AltaVault OST Plug-in)
* NetApp Converged Systems Advisor Agent
* NetApp E-Series Performance Analyzer
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Nodes
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp SANtricity SMI-S Provider
* NetApp SMI-S Provider
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp SolidFire, Enterprise SDS & HCI Storage Node (Element Software)
* NetApp VASA Provider for Clustered Data ONTAP 9.7 and above
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* OnCommand Insight
* OnCommand Workflow Automation
* Open Systems SnapVault Agent
* SAS Firmware
* Service Processor
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere
* SnapDrive for Unix
* SnapManager for Hyper-V
* SnapManager for Oracle
* SnapManager for SAP
* SolidFire Storage Replication Adapter
* Storage Replication Adapter for Clustered Data ONTAP for VMware vSphere 9.7 and above
* Storage Services Connector
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID Baseboard Management Controller (BMC)
* StorageGRID9 (9.x and prior)
* System Manager 9.x
* Virtual Storage Console for VMware vSphere 9.7 and above

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **AFF Baseboard Management Controller (BMC) - A700s** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> The first fixed version is 1.81. To download the patch, choose âService Imageâ from the AFF\_A700s âSystem Firmware + Diagnostics Downloadâ page. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610S** | <https://mysupport.netapp.com/site/products/all/details/5d9f1108e01d9c0001ee51dd/downloads-tab/download/62542/Compute_Firmware_Bundle> <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/Storage_Firmware_Bundle> First included in Compute Firmware Bundle version 2.27. |
| **NetApp Cloud Backup (formerly AltaVault)** | NetApp Cloud Backup (formerly AltaVault) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2880179.html) for more information. |
| **FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1289797. First fixed versions include the following: 13.3 |
| **NetApp SolidFire Baseboard Management Controller (BMC)** | NetApp SolidFire Baseboard Management Controller (BMC) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2847476.html%20) for more information. |
| **NetApp SolidFire & HCI Management Node** | <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/12.5> <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/1.10> |
| **NetApp Data Availability Services** | NetApp Data Availability Services has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2870808.html) for more information. |
| **NetApp SteelStore Cloud Integrated Storage** | NetApp SteelStore Cloud Integrated Storage has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2397079.html) for more information. |
| **Active IQ Unified Manager for VMware vSphere** | <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/downloads-tab/download/62791/9.7P1/downloads> <https://mysupport.netapp.com/site/products/all/details/activeiq-unified-manager/about-tab/download/62791/9.7P1> |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Final.**

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20200103-0001>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20200103 | Initial Public Release |
| 2.0 | 20200106 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above moved to Affected Products |
| 3.0 | 20200127 | Cloud Volumes ONTAP Mediator moved to Products Not Affected |
| 4.0 | 20200205 | E-Series SANtricity OS Controller Baseboard Management Controller (BMC) - EF600A moved to Products Not Affected |
| 5.0 | 20200207 | AFF Baseboard Management Controller (BMC) - A700s moved to Affected Products |
| 6.0 | 20200211 | NetApp Data Availability Services moved to Affected Products |
| 7.0 | 20200219 | Element Software (formerly SolidFire Element OS), NetApp HCI Compute Nodes, NetApp HCI Storage Nodes moved to Products Not Affected and Element Software Management Node moved to Affected Products |
| 8.0 | 20200311 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S moved to Products Not Affected |
| 9.0 | 20200324 | FAS/AFF Baseboard Management Controller (BMC) and Service Processor moved to Products Not Affected |
| 10.0 | 20200423 | Host Utilities - SAN for Linux moved to Products Not Affected |
| 11.0 | 20200424 | Host Utilities - SAN for Unix moved to Products Not Affected |
| 12.0 | 20200504 | FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved to Affected Products |
| 13.0 | 20200618 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above added to Software Versions and Fixes |
| 14.0 | 20200724 | NetApp Data Availability Services moved to Won't Fix status |
| 15.0 | 20200901 | NetApp SteelStore Cloud Integrated Storage moved to Won't Fix status |
| 16.0 | 20201012 | NetApp HCI Baseboard Management Controller (BMC) - H610S added to Software Versions and Fixes |
| 17.0 | 20201112 | AFF Baseboard Management Controller (BMC) - A700s added to Software Versions and Fixes |
| 18.0 | 20210414 | Brocade Fabric Operating System Firmware moved to Affected Products |
| 19.0 | 20210421 | FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 added to Software Versions and Fixes |
| 20.0 | 20211101 | NetApp SolidFire Baseboard Management Controller (BMC) moved to Won't Fix status |
| 21.0 | 20220106 | NetApp Cloud Backup (formerly AltaVault) moved to Won't Fix status |
| 22.0 | 20220527 | NetApp SolidFire & HCI Management Node added to Software Versions and Fixes |
| 23.0 | 20220609 | After additional review Brocade Fabric Operating System Firmware moved to Products Not Affected, Final status |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from git.kernel.org_e5340693_20250120_233840.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Takashi Iwai <tiwai@suse.de> | 2019-11-06 17:55:47 +0100 |
| --- | --- | --- |
| committer | Takashi Iwai <tiwai@suse.de> | 2019-11-06 17:58:28 +0100 |
| commit | [e7af6307a8a54f0b873960b32b6a644f2d0fbd97](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)) | |
| tree | [241493383c1423255e4669297ccb5c9065aad5b3](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97) | |
| parent | [9a11ba7388f165762549903492fc34d29bbb3c04](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9a11ba7388f165762549903492fc34d29bbb3c04) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97&id2=9a11ba7388f165762549903492fc34d29bbb3c04)) | |
| download | [linux-e7af6307a8a54f0b873960b32b6a644f2d0fbd97.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-e7af6307a8a54f0b873960b32b6a644f2d0fbd97.tar.gz) | |

ALSA: timer: Fix incorrectly assigned timer instanceThe clean up commit 41672c0c24a6 ("ALSA: timer: Simplify error path in
snd\_timer\_open()") unified the error handling code paths with the
standard goto, but it introduced a subtle bug: the timer instance is
stored in snd\_timer\_open() incorrectly even if it returns an error.
This may eventually lead to UAF, as spotted by fuzzer.
The culprit is the snd\_timer\_open() code checks the
SNDRV\_TIMER\_IFLG\_EXCLUSIVE flag with the common variable timeri.
This variable is supposed to be the newly created instance, but we
(ab-)used it for a temporary check before the actual creation of a
timer instance. After that point, there is another check for the max
number of instances, and it bails out if over the threshold. Before
the refactoring above, it worked fine because the code returned
directly from that point. After the refactoring, however, it jumps to
the unified error path that stores the timeri variable in return --
even if it returns an error. Unfortunately this stored value is kept
in the caller side (snd\_timer\_user\_tselect()) in tu->timeri. This
causes inconsistency later, as if the timer was successfully
assigned.
In this patch, we fix it by not re-using timeri variable but a
temporary variable for testing the exclusive connection, so timeri
remains NULL at that point.
Fixes: 41672c0c24a6 ("ALSA: timer: Simplify error path in snd\_timer\_open()")
Reported-and-tested-by: Tristan Madani <tristmd@gmail.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/r/20191106165547.23518-1-tiwai@suse.de](https://lore.kernel.org/r/20191106165547.23518-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)

| -rw-r--r-- | [sound/core/timer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/sound/core/timer.c?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/sound/core/timer.c b/sound/core/timer.cindex 6b724d2ee2de9b..59ae21b0bb936c 100644--- a/[sound/core/timer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/sound/core/timer.c?id=9a11ba7388f165762549903492fc34d29bbb3c04)+++ b/[sound/core/timer.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/sound/core/timer.c?id=e7af6307a8a54f0b873960b32b6a644f2d0fbd97)@@ -284,11 +284,11 @@ int snd\_timer\_open(struct snd\_timer\_instance \*\*ti, goto unlock; } if (!list\_empty(&timer->open\_list\_head)) {- timeri = list\_entry(timer->open\_list\_head.next,+ struct snd\_timer\_instance \*t =+ list\_entry(timer->open\_list\_head.next, struct snd\_timer\_instance, open\_list);- if (timeri->flags & SNDRV\_TIMER\_IFLG\_EXCLUSIVE) {+ if (t->flags & SNDRV\_TIMER\_IFLG\_EXCLUSIVE) { err = -EBUSY;- timeri = NULL; goto unlock; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-20 23:37:17 +0000



=== Content from usn.ubuntu.com_3bad1cad_20250120_233844.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4225-1: Linux kernel vulnerabilities

7 January 2020

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 19.10](/security/notices?release=eoan)
* [Ubuntu 18.04 ESM](/security/notices?release=bionic)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-azure](/security/cves?package=linux-azure) - Linux kernel for Microsoft Azure Cloud systems
* [linux-azure-5.3](/security/cves?package=linux-azure-5.3) - Linux kernel for Microsoft Azure Cloud systems
* [linux-gcp](/security/cves?package=linux-gcp) - Linux kernel for Google Cloud Platform (GCP) systems
* [linux-gcp-5.3](/security/cves?package=linux-gcp-5.3) - Linux kernel for Google Cloud Platform (GCP) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-oracle](/security/cves?package=linux-oracle) - Linux kernel for Oracle Cloud systems
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2

## Details

It was discovered that a heap-based buffer overflow existed in the Marvell

WiFi-Ex Driver for the Linux kernel. A physically proximate attacker could

use this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-14895](/security/CVE-2019-14895), [CVE-2019-14901](/security/CVE-2019-14901))

It was discovered that a heap-based buffer overflow existed in the Marvell

Libertas WLAN Driver for the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2019-14896](/security/CVE-2019-14896), [CVE-2019-14897](/security/CVE-2019-14897))

It was discovered that the Fujitsu ES network device driver for the Linux

kernel did not properly check for errors in some situations, leading to a

NULL pointer dereference. A local attacker could use this to cause a denial

of service. ([CVE-2019-16231](/security/CVE-2019-16231))

Anthony Steinhauser discovered that the Linux kernel did not properly

perform Spectre\_RSB mitigations to all processors for PowerPC architecture

systems in some situations. A local attacker could use this to expose

sensitive information. ([CVE-2019-18660](/security/CVE-2019-18660))

It was discovered that the Broadcom V3D DRI driver in the Linux kernel did

not properly deallocate memory in certain error conditions. A local

attacker could possibly use this to cause a denial of service (kernel

memory exhaustion). ([CVE-2019-19044](/security/CVE-2019-19044))

It was discovered that the Mellanox Technologies Innova driver in the Linux

kernel did not properly deallocate memory in certain failure conditions. A

local attacker could use this to cause a denial of service (kernel memory

exhaustion). ([CVE-2019-19045](/security/CVE-2019-19045))

It was discovered that the Mellanox Technologies ConnectX driver in the

Linux kernel did not properly deallocate memory in certain failure

conditions. A local attacker could use this to cause a denial of service

(kernel memory exhaustion). ([CVE-2019-19047](/security/CVE-2019-19047))

It was discovered that the Intel WiMAX 2400 driver in the Linux kernel did

not properly deallocate memory in certain situations. A local attacker

could use this to cause a denial of service (kernel memory exhaustion).

([CVE-2019-19051](/security/CVE-2019-19051))

It was discovered that Geschwister Schneider USB CAN interface driver in

the Linux kernel did not properly deallocate memory in certain failure

conditions. A physically proximate attacker could use this to cause a

denial of service (kernel memory exhaustion). ([CVE-2019-19052](/security/CVE-2019-19052))

It was discovered that the netlink-based 802.11 configuration interface in

the Linux kernel did not deallocate memory in certain error conditions. A

local attacker could possibly use this to cause a denial of service (kernel

memory exhaustion). ([CVE-2019-19055](/security/CVE-2019-19055))

It was discovered that the event tracing subsystem of the Linux kernel did

not properly deallocate memory in certain error conditions. A local

attacker could use this to cause a denial of service (kernel memory

exhaustion). ([CVE-2019-19072](/security/CVE-2019-19072))

It was discovered that the driver for memoryless force-feedback input

devices in the Linux kernel contained a use-after-free vulnerability. A

physically proximate attacker could possibly use this to cause a denial of

service (system crash) or execute arbitrary code. ([CVE-2019-19524](/security/CVE-2019-19524))

It was discovered that the Microchip CAN BUS Analyzer driver in the Linux

kernel contained a use-after-free vulnerability on device disconnect. A

physically proximate attacker could use this to cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2019-19529](/security/CVE-2019-19529))

It was discovered that the PEAK-System Technik USB driver in the Linux

kernel did not properly sanitize memory before sending it to the device. A

physically proximate attacker could use this to expose sensitive

information (kernel memory). ([CVE-2019-19534](/security/CVE-2019-19534))

Tristan Madani discovered that the ALSA timer implementation in the Linux

kernel contained a use-after-free vulnerability. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-19807](/security/CVE-2019-19807))

It was discovered that the DesignWare USB3 controller driver in the Linux

kernel did not properly deallocate memory in some error conditions. A local

attacker could possibly use this to cause a denial of service (memory

exhaustion). ([CVE-2019-18813](/security/CVE-2019-18813))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 19.10

* [linux-image-5.3.0-1008-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle)
  -
  [5.3.0-1008.9](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle/5.3.0-1008.9)
* [linux-image-5.3.0-1009-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [5.3.0-1009.10](https://launchpad.net/ubuntu/%2Bsource/linux-aws/5.3.0-1009.10)
* [linux-image-5.3.0-1009-azure](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure)
  -
  [5.3.0-1009.10](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure/5.3.0-1009.10)
* [linux-image-5.3.0-1009-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [5.3.0-1009.10](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/5.3.0-1009.10)
* [linux-image-5.3.0-1011-gcp](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp)
  -
  [5.3.0-1011.12](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp/5.3.0-1011.12)
* [linux-image-5.3.0-1015-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [5.3.0-1015.17](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/5.3.0-1015.17)
* [linux-image-5.3.0-26-generic](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [5.3.0-26.28](https://launchpad.net/ubuntu/%2Bsource/linux-signed/5.3.0-26.28)
* [linux-image-5.3.0-26-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [5.3.0-26.28](https://launchpad.net/ubuntu/%2Bsource/linux/5.3.0-26.28)
* [linux-image-5.3.0-26-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [5.3.0-26.28](https://launchpad.net/ubuntu/%2Bsource/linux-signed/5.3.0-26.28)
* [linux-image-5.3.0-26-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [5.3.0-26.28](https://launchpad.net/ubuntu/%2Bsource/linux-signed/5.3.0-26.28)
* [linux-image-aws](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws)
  -
  [5.3.0.1009.11](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws/5.3.0.1009.11)
* [linux-image-azure](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure)
  -
  [5.3.0.1009.27](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure/5.3.0.1009.27)
* [linux-image-gcp](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp)
  -
  [5.3.0.1011.12](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp/5.3.0.1011.12)
* [linux-image-generic](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [5.3.0.26.30](https://launchpad.net/ubuntu/%2Bsource/linux-meta/5.3.0.26.30)
* [linux-image-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [5.3.0.26.30](https://launchpad.net/ubuntu/%2Bsource/linux-meta/5.3.0.26.30)
* [linux-image-gke](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp)
  -
  [5.3.0.1011.12](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp/5.3.0.1011.12)
* [linux-image-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm)
  -
  [5.3.0.1009.11](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm/5.3.0.1009.11)
* [linux-image-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [5.3.0.26.30](https://launchpad.net/ubuntu/%2Bsource/linux-meta/5.3.0.26.30)
* [linux-image-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle)
  -
  [5.3.0.1008.9](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle/5.3.0.1008.9)
* [linux-image-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2)
  -
  [5.3.0.1015.12](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2/5.3.0.1015.12)
* [linux-image-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [5.3.0.26.30](https://launchpad.net/ubuntu/%2Bsource/linux-meta/5.3.0.26.30)
* [linux-image-virtual](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [5.3.0.26.30](https://launchpad.net/ubuntu/%2Bsource/linux-meta/5.3.0.26.30)

##### Ubuntu 18.04

* [linux-image-5.3.0-1009-azure](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure-5.3)
  -
  [5.3.0-1009.10~18.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure-5.3/5.3.0-1009.10~18.04.1)
* [linux-image-5.3.0-1010-gcp](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp-5.3)
  -
  [5.3.0-1010.11~18.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp-5.3/5.3.0-1010.11~18.04.1)
* [linux-image-azure-edge](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure-5.3)
  -
  [5.3.0.1009.9](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure-5.3/5.3.0.1009.9)
* [linux-image-gcp-edge](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp-5.3)
  -
  [5.3.0.1010.10](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp-5.3/5.3.0.1010.10)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2019-14895](/security/CVE-2019-14895)
* [CVE-2019-14896](/security/CVE-2019-14896)
* [CVE-2019-14897](/security/CVE-2019-14897)
* [CVE-2019-14901](/security/CVE-2019-14901)
* [CVE-2019-16231](/security/CVE-2019-16231)
* [CVE-2019-18660](/security/CVE-2019-18660)
* [CVE-2019-18813](/security/CVE-2019-18813)
* [CVE-2019-19044](/security/CVE-2019-19044)
* [CVE-2019-19045](/security/CVE-2019-19045)
* [CVE-2019-19047](/security/CVE-2019-19047)
* [CVE-2019-19051](/security/CVE-2019-19051)
* [CVE-2019-19052](/security/CVE-2019-19052)
* [CVE-2019-19055](/security/CVE-2019-19055)
* [CVE-2019-19072](/security/CVE-2019-19072)
* [CVE-2019-19524](/security/CVE-2019-19524)
* [CVE-2019-19529](/security/CVE-2019-19529)
* [CVE-2019-19534](/security/CVE-2019-19534)
* [CVE-2019-19807](/security/CVE-2019-19807)

## Related notices

* [USN-4226-1](/security/notices/USN-4226-1)
* [USN-4227-2](/security/notices/USN-4227-2)
* [USN-4227-1](/security/notices/USN-4227-1)
* [USN-4225-2](/security/notices/USN-4225-2)
* [USN-4228-1](/security/notices/USN-4228-1)
* [USN-4228-2](/security/notices/USN-4228-2)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-4344-1](/security/notices/USN-4344-1)
* [USN-4286-1](/security/notices/USN-4286-1)
* [USN-4286-2](/security/notices/USN-4286-2)
* [USN-4302-1](/security/notices/USN-4302-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from github.com_a32e2982_20250120_233841.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe7af6307a8a54f0b873960b32b6a644f2d0fbd97)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe7af6307a8a54f0b873960b32b6a644f2d0fbd97)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  436](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/e7af6307a8a54f0b873960b32b6a644f2d0fbd97)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

ALSA: timer: Fix incorrectly assigned timer instance

[Browse files](/torvalds/linux/tree/e7af6307a8a54f0b873960b32b6a644f2d0fbd97)
Browse the repository at this point in the history

```
The clean up commit [41672c0](https://github.com/torvalds/linux/commit/41672c0c24a62699d20aab53b98d843b16483053) ("ALSA: timer: Simplify error path in
snd_timer_open()") unified the error handling code paths with the
standard goto, but it introduced a subtle bug: the timer instance is
stored in snd_timer_open() incorrectly even if it returns an error.
This may eventually lead to UAF, as spotted by fuzzer.

The culprit is the snd_timer_open() code checks the
SNDRV_TIMER_IFLG_EXCLUSIVE flag with the common variable timeri.
This variable is supposed to be the newly created instance, but we
(ab-)used it for a temporary check before the actual creation of a
timer instance.  After that point, there is another check for the max
number of instances, and it bails out if over the threshold.  Before
the refactoring above, it worked fine because the code returned
directly from that point.  After the refactoring, however, it jumps to
the unified error path that stores the timeri variable in return --
even if it returns an error.  Unfortunately this stored value is kept
in the caller side (snd_timer_user_tselect()) in tu->timeri.  This
causes inconsistency later, as if the timer was successfully
assigned.

In this patch, we fix it by not re-using timeri variable but a
temporary variable for testing the exclusive connection, so timeri
remains NULL at that point.

Fixes: [41672c0](https://github.com/torvalds/linux/commit/41672c0c24a62699d20aab53b98d843b16483053) ("ALSA: timer: Simplify error path in snd_timer_open()")
Reported-and-tested-by: Tristan Madani <tristmd@gmail.com>
Cc: <stable@vger.kernel.org>
Link: [https://lore.kernel.org/r/20191106165547.23518-1-tiwai@suse.de](https://lore.kernel.org/r/20191106165547.23518-1-tiwai%40suse.de)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
```

* Loading branch information

[![@tiwai](https://avatars.githubusercontent.com/u/306482?s=40&v=4)](/tiwai)

[tiwai](/torvalds/linux/commits?author=tiwai "View all commits by tiwai")
committed
Nov 6, 2019

1 parent
[9a11ba7](/torvalds/linux/commit/9a11ba7388f165762549903492fc34d29bbb3c04)

commit e7af630

Showing
**1 changed file**
with
**3 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 3 additions & 3 deletions

6
[sound/core/timer.c](#diff-f98273917c41fa96556256884f0d4c9732de2d01eb0b423d29ef6011db007c45 "sound/core/timer.c")

Show comments

[View file](/torvalds/linux/blob/e7af6307a8a54f0b873960b32b6a644f2d0fbd97/sound/core/timer.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -284,11 +284,11 @@ int snd\_timer\_open(struct snd\_timer\_instance \*\*ti, |
|  |  | goto unlock; |
|  |  | } |
|  |  | if (!list\_empty(&timer->open\_list\_head)) { |
|  |  | timeri = list\_entry(timer->open\_list\_head.next, |
|  |  | struct snd\_timer\_instance \*t = |
|  |  | list\_entry(timer->open\_list\_head.next, |
|  |  | struct snd\_timer\_instance, open\_list); |
|  |  | if (timeri->flags & SNDRV\_TIMER\_IFLG\_EXCLUSIVE) { |
|  |  | if (t->flags & SNDRV\_TIMER\_IFLG\_EXCLUSIVE) { |
|  |  | err = -EBUSY; |
|  |  | timeri = NULL; |
|  |  | goto unlock; |
|  |  | } |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `e7af630`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fe7af6307a8a54f0b873960b32b6a644f2d0fbd97) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from usn.ubuntu.com_283a533a_20250120_233845.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4227-1: Linux kernel vulnerabilities

7 January 2020

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 18.04 ESM](/security/notices?release=bionic)
* [Ubuntu 16.04 ESM](/security/notices?release=xenial)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-aws-hwe](/security/cves?package=linux-aws-hwe) - Linux kernel for Amazon Web Services (AWS-HWE) systems
* [linux-azure](/security/cves?package=linux-azure) - Linux kernel for Microsoft Azure Cloud systems
* [linux-gcp](/security/cves?package=linux-gcp) - Linux kernel for Google Cloud Platform (GCP) systems
* [linux-gke-4.15](/security/cves?package=linux-gke-4.15) - Linux kernel for Google Container Engine (GKE) systems
* [linux-hwe](/security/cves?package=linux-hwe) - Linux hardware enablement (HWE) kernel
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-oem](/security/cves?package=linux-oem) - Linux kernel for OEM processors
* [linux-oracle](/security/cves?package=linux-oracle) - Linux kernel for Oracle Cloud systems
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi 2
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Snapdragon processors

## Details

It was discovered that a heap-based buffer overflow existed in the Marvell

WiFi-Ex Driver for the Linux kernel. A physically proximate attacker could

use this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-14895](/security/CVE-2019-14895), [CVE-2019-14901](/security/CVE-2019-14901))

It was discovered that a heap-based buffer overflow existed in the Marvell

Libertas WLAN Driver for the Linux kernel. A physically proximate attacker

could use this to cause a denial of service (system crash) or possibly

execute arbitrary code. ([CVE-2019-14896](/security/CVE-2019-14896), [CVE-2019-14897](/security/CVE-2019-14897))

It was discovered that the Fujitsu ES network device driver for the Linux

kernel did not properly check for errors in some situations, leading to a

NULL pointer dereference. A local attacker could use this to cause a denial

of service. ([CVE-2019-16231](/security/CVE-2019-16231))

It was discovered that the QLogic Fibre Channel driver in the Linux kernel

did not properly check for error, leading to a NULL pointer dereference. A

local attacker could possibly use this to cause a denial of service (system

crash). ([CVE-2019-16233](/security/CVE-2019-16233))

Anthony Steinhauser discovered that the Linux kernel did not properly

perform Spectre\_RSB mitigations to all processors for PowerPC architecture

systems in some situations. A local attacker could use this to expose

sensitive information. ([CVE-2019-18660](/security/CVE-2019-18660))

It was discovered that the Mellanox Technologies Innova driver in the Linux

kernel did not properly deallocate memory in certain failure conditions. A

local attacker could use this to cause a denial of service (kernel memory

exhaustion). ([CVE-2019-19045](/security/CVE-2019-19045))

It was discovered that Geschwister Schneider USB CAN interface driver in

the Linux kernel did not properly deallocate memory in certain failure

conditions. A physically proximate attacker could use this to cause a

denial of service (kernel memory exhaustion). ([CVE-2019-19052](/security/CVE-2019-19052))

It was discovered that the AMD Display Engine Driver in the Linux kernel

did not properly deallocate memory in certain error conditions. A local

attack could use this to cause a denial of service (memory exhaustion).

([CVE-2019-19083](/security/CVE-2019-19083))

It was discovered that the driver for memoryless force-feedback input

devices in the Linux kernel contained a use-after-free vulnerability. A

physically proximate attacker could possibly use this to cause a denial of

service (system crash) or execute arbitrary code. ([CVE-2019-19524](/security/CVE-2019-19524))

It was discovered that the Microchip CAN BUS Analyzer driver in the Linux

kernel contained a use-after-free vulnerability on device disconnect. A

physically proximate attacker could use this to cause a denial of service

(system crash) or possibly execute arbitrary code. ([CVE-2019-19529](/security/CVE-2019-19529))

It was discovered that the PEAK-System Technik USB driver in the Linux

kernel did not properly sanitize memory before sending it to the device. A

physically proximate attacker could use this to expose sensitive

information (kernel memory). ([CVE-2019-19534](/security/CVE-2019-19534))

Tristan Madani discovered that the ALSA timer implementation in the Linux

kernel contained a use-after-free vulnerability. A local attacker could use

this to cause a denial of service (system crash) or possibly execute

arbitrary code. ([CVE-2019-19807](/security/CVE-2019-19807))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 18.04

* [linux-image-4.15.0-1031-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle)
  -
  [4.15.0-1031.34](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle/4.15.0-1031.34)
* [linux-image-4.15.0-1050-gke](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gke-4.15)
  -
  [4.15.0-1050.53](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gke-4.15/4.15.0-1050.53)
* [linux-image-4.15.0-1052-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.15.0-1052.52](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.15.0-1052.52)
* [linux-image-4.15.0-1053-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.15.0-1053.57](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.15.0-1053.57)
* [linux-image-4.15.0-1057-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.15.0-1057.59](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.15.0-1057.59)
* [linux-image-4.15.0-1066-oem](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oem)
  -
  [4.15.0-1066.76](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oem/4.15.0-1066.76)
* [linux-image-4.15.0-1070-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.15.0-1070.77](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.15.0-1070.77)
* [linux-image-4.15.0-74-generic](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [4.15.0-74.84](https://launchpad.net/ubuntu/%2Bsource/linux-signed/4.15.0-74.84)
* [linux-image-4.15.0-74-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.15.0-74.84](https://launchpad.net/ubuntu/%2Bsource/linux/4.15.0-74.84)
* [linux-image-4.15.0-74-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [4.15.0-74.84](https://launchpad.net/ubuntu/%2Bsource/linux-signed/4.15.0-74.84)
* [linux-image-aws](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws)
  -
  [4.15.0.1057.58](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws/4.15.0.1057.58)
* [linux-image-aws-lts-18.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws)
  -
  [4.15.0.1057.58](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws/4.15.0.1057.58)
* [linux-image-generic](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.15.0.74.76](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.15.0.74.76)
* [linux-image-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.15.0.74.76](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.15.0.74.76)
* [linux-image-gke](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gke-4.15)
  -
  [4.15.0.1050.53](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gke-4.15/4.15.0.1050.53)
* [linux-image-gke-4.15](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gke-4.15)
  -
  [4.15.0.1050.53](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gke-4.15/4.15.0.1050.53)
* [linux-image-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm)
  -
  [4.15.0.1052.52](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm/4.15.0.1052.52)
* [linux-image-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.15.0.74.76](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.15.0.74.76)
* [linux-image-oem](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oem)
  -
  [4.15.0.1066.70](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oem/4.15.0.1066.70)
* [linux-image-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle)
  -
  [4.15.0.1031.36](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle/4.15.0.1031.36)
* [linux-image-oracle-lts-18.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle)
  -
  [4.15.0.1031.36](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle/4.15.0.1031.36)
* [linux-image-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2)
  -
  [4.15.0.1053.51](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2/4.15.0.1053.51)
* [linux-image-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-meta-snapdragon)
  -
  [4.15.0.1070.73](https://launchpad.net/ubuntu/%2Bsource/linux-meta-snapdragon/4.15.0.1070.73)
* [linux-image-virtual](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.15.0.74.76](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.15.0.74.76)

##### Ubuntu 16.04

* [linux-image-4.15.0-1031-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle)
  -
  [4.15.0-1031.34~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-oracle/4.15.0-1031.34~16.04.1)
* [linux-image-4.15.0-1052-gcp](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp)
  -
  [4.15.0-1052.56](https://launchpad.net/ubuntu/%2Bsource/linux-signed-gcp/4.15.0-1052.56)
* [linux-image-4.15.0-1057-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws-hwe)
  -
  [4.15.0-1057.59~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-aws-hwe/4.15.0-1057.59~16.04.1)
* [linux-image-4.15.0-1066-azure](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure)
  -
  [4.15.0-1066.71](https://launchpad.net/ubuntu/%2Bsource/linux-signed-azure/4.15.0-1066.71)
* [linux-image-4.15.0-74-generic](https://launchpad.net/ubuntu/%2Bsource/linux-signed-hwe)
  -
  [4.15.0-74.83~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-hwe/4.15.0-74.83~16.04.1)
* [linux-image-4.15.0-74-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-hwe)
  -
  [4.15.0-74.83~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-hwe/4.15.0-74.83~16.04.1)
* [linux-image-4.15.0-74-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-signed-hwe)
  -
  [4.15.0-74.83~16.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-hwe/4.15.0-74.83~16.04.1)
* [linux-image-aws-hwe](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws-hwe)
  -
  [4.15.0.1057.57](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws-hwe/4.15.0.1057.57)
* [linux-image-azure](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure)
  -
  [4.15.0.1066.69](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure/4.15.0.1066.69)
* [linux-image-azure-edge](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure)
  -
  [4.15.0.1066.69](https://launchpad.net/ubuntu/%2Bsource/linux-meta-azure/4.15.0.1066.69)
* [linux-image-gcp](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp)
  -
  [4.15.0.1052.66](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp/4.15.0.1052.66)
* [linux-image-generic-hwe-16.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe)
  -
  [4.15.0.74.94](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe/4.15.0.74.94)
* [linux-image-generic-lpae-hwe-16.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe)
  -
  [4.15.0.74.94](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe/4.15.0.74.94)
* [linux-image-gke](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp)
  -
  [4.15.0.1052.66](https://launchpad.net/ubuntu/%2Bsource/linux-meta-gcp/4.15.0.1052.66)
* [linux-image-lowlatency-hwe-16.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe)
  -
  [4.15.0.74.94](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe/4.15.0.74.94)
* [linux-image-oem](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe)
  -
  [4.15.0.74.94](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe/4.15.0.74.94)
* [linux-image-oracle](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle)
  -
  [4.15.0.1031.24](https://launchpad.net/ubuntu/%2Bsource/linux-meta-oracle/4.15.0.1031.24)
* [linux-image-virtual-hwe-16.04](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe)
  -
  [4.15.0.74.94](https://launchpad.net/ubuntu/%2Bsource/linux-meta-hwe/4.15.0.74.94)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2019-14895](/security/CVE-2019-14895)
* [CVE-2019-14896](/security/CVE-2019-14896)
* [CVE-2019-14897](/security/CVE-2019-14897)
* [CVE-2019-14901](/security/CVE-2019-14901)
* [CVE-2019-16231](/security/CVE-2019-16231)
* [CVE-2019-16233](/security/CVE-2019-16233)
* [CVE-2019-18660](/security/CVE-2019-18660)
* [CVE-2019-19045](/security/CVE-2019-19045)
* [CVE-2019-19052](/security/CVE-2019-19052)
* [CVE-2019-19083](/security/CVE-2019-19083)
* [CVE-2019-19524](/security/CVE-2019-19524)
* [CVE-2019-19529](/security/CVE-2019-19529)
* [CVE-2019-19534](/security/CVE-2019-19534)
* [CVE-2019-19807](/security/CVE-2019-19807)

## Related notices

* [USN-4226-1](/security/notices/USN-4226-1)
* [USN-4227-2](/security/notices/USN-4227-2)
* [USN-4225-1](/security/notices/USN-4225-1)
* [USN-4225-2](/security/notices/USN-4225-2)
* [USN-4228-1](/security/notices/USN-4228-1)
* [USN-4228-2](/security/notices/USN-4228-2)
* [USN-4904-1](/security/notices/USN-4904-1)
* [USN-4346-1](/security/notices/USN-4346-1)
* [USN-4208-1](/security/notices/USN-4208-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page


