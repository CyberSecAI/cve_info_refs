=== Content from www.illumos.org_0a537004_20250121_005616.html ===


Search

### Project

### General

### Profile

* [Sign in](/login)
* [Register](/account/register)

* [Home](/)
* [Projects](/projects)
* [Help](https://www.redmine.org/guide)

[Search](/projects/illumos-gate/search?scope=subprojects):

 illumos gate[All Projects](/projects?jump=issues)
# illumos gate

* [Overview](/projects/illumos-gate)
* [Activity](/projects/illumos-gate/activity)
* [Issues](/projects/illumos-gate/issues)

### Custom queries

* [All unresolved bugs](/projects/illumos-gate/issues?query_id=4)
* [Bite-sized Bugs](/projects/illumos-gate/issues?query_id=31)
* [Documentation and locale issues](/projects/illumos-gate/issues?query_id=16)

Actions
Copy link
## Bug #11556

closed
![](https://www.gravatar.com/avatar/470fd8bffbb3220b1e6b56386b053e8dfdfcf86c8155b0f83598cc7f535d4b8a?rating=PG&size=50&default= "Author: Dan McDonald")
![](https://www.gravatar.com/avatar/470fd8bffbb3220b1e6b56386b053e8dfdfcf86c8155b0f83598cc7f535d4b8a?rating=PG&size=22&default= "Assignee: Dan McDonald")

### ip\_attr.c functions need to not dereference conn\_ixa directly after lock drop

Added by [Dan McDonald](/users/1335) [over 5 years](/projects/illumos-gate/activity?from=2019-08-15 "2019-08-15 01:09 AM") ago.
Updated [over 5 years](/projects/illumos-gate/activity?from=2019-08-15 "2019-08-15 06:38 PM") ago.

Status:ClosedPriority:NormalAssignee:[Dan McDonald](/users/1335)Category:networkingStart date:Due date:% Done:

|  |
| --- |

100%

Estimated time:
Difficulty:HardTags:Gerrit CR:External Bug:

---

**Description**

There's an antipattern in two places in ip\_attr.c.

```
        mutex_enter(&conn->conn_lock);
        /* manipulate lock-protected conn_ixa pointer, even refholding it... */
        IXA_REFHOLD(conn->conn_ixa);
        mutex_exit(&conn->conn_lock);
        IXA_REFRELE(conn->conn_ixa);  /* XXX KEBE SAYS THIS IS WRONG! */

```

After conn\_lock is dropped, conn\_ixa MAY be replaced. You may be refrele-ing a different conn\_ixa than you refheld inside the mutex!!!

A better pattern is:

```
        ip_xmit_attr_t *oldixa;

        mutex_enter(&conn->conn_lock);
        /* manipulate lock-protected conn_ixa pointer, even refholding it... */
        oldixa = conn->conn_ixa;
        IXA_REFHOLD(oldixa);
        mutex_exit(&conn->conn_lock);
        IXA_REFRELE(oldixa);  /* XXX KEBE SAYS MUCH BETTER! */

```

There is other TCP/IP code that does ixa\_refrele(conn->conn\_ixa), but they are all under squeue exclusivity OR part of conn\_t destruction post-detachment.

This bug manifests like a use-after-free on non-DEBUG kernels and blows an ASSERT in ixa\_inactive (refcnt is not necessarily 1).

* [History](/issues/11556?tab=history)
* [Notes](/issues/11556?tab=notes)
* [Property changes](/issues/11556?tab=properties)

ActionsCopy link
[#1](#note-1)
#### Updated by [Dan McDonald](/users/1335) [over 5 years](/projects/illumos-gate/activity?from=2019-08-15 "2019-08-15 04:45 PM") ago

Not mentioned eariler, the IXA\_REFRELE macro evaluates its argument multiple times. This exacerbates the problem because connp->conn\_ixa can change in the middle of the macro. IXA\_REF{hold,rele} must not have an argument that evaluates multiple times. It's one reason why these aren't used in header files, and instead we have the lowercased function versions.

ActionsCopy link
[#2](#note-2)
#### Updated by [Dan McDonald](/users/1335) [over 5 years](/projects/illumos-gate/activity?from=2019-08-15 "2019-08-15 04:46 PM") ago

Bug can be reproduced by an application that uses multiple threads that each call sendmsg(3xnet) concurrently over a single socket on a loaded system. Each distinct sendmsg(3xnet) call references-and-clones the conn\_ixa. The go network tests are effective here. I ran this on a DEBUG OmniOS to trigger the bug (assertion failure). Then I applied the fix, and tried again with no panics on the post-fix run.

ActionsCopy link
[#3](#note-3)
#### Updated by [Electric Monk](/users/2769) [over 5 years](/projects/illumos-gate/activity?from=2019-08-15 "2019-08-15 06:38 PM") ago

* **Status** changed from *New* to *Closed*
* **% Done** changed from *0* to *100*

[git commit 79940ff6ac581ff9431c474dcfa18c78f1cb7a50](https://github.com/illumos/illumos-gate/commit/79940ff6ac581ff9431c474dcfa18c78f1cb7a50)
```
commit  79940ff6ac581ff9431c474dcfa18c78f1cb7a50
Author: Dan McDonald <danmcd@joyent.com>
Date:   2019-08-15T18:35:49.000Z

    11556 ip_attr.c functions need to not dereference conn_ixa directly after lock drop
    Reviewed by: Jason King <jbk@joyent.com>
    Reviewed by: Mike Gerdts <mgerdts@joyent.com>
    Reviewed by: Andy Fiddaman <andy@omniosce.org>
    Approved by: Gordon Ross <gwr@nexenta.com>

```

Actions
Copy link

Also available in: [Atom](/issues/11556.atom)
[PDF](/issues/11556.pdf)

Powered by [Redmine](https://www.redmine.org/) © 2006-2024 Jean-Philippe Lang

Loading...



=== Content from omniosce.org_a48cc7e2_20250121_005615.html ===


* [Home](/)
* [News](/news/)
* [Upgrading OmniOS](/upgrade.html)
* [Commercial Support](/invoice.html)
* [Contribute to OmniOS](/joinus.html)
* [Donate](/patron.html)
* [Release Notes](/releasenotes.html)
* [Release Schedule](/schedule.html)
* [Downloads](/download.html)
* About OmniOS
  + [About](/about/about.html)
  + [Privacy Policy](/about/privacy.html)
  + [Contact Us](/about/contact.html)
  + [Minimalist Principle](/about/kysty.html)
  + [Stable vs. Bloody](/about/stablevsbloody.html)
* OmniOS Setup
  + [Switch to OmniOSce](/setup/switch.html)
  + [Installation Walk-through](/setup/freshinstall.html)
  + [Serial Console over SSH](/setup/serial_console.html)
  + [Creating a simple zone](/setup/firstzone.html)
  + [Installation via PXE Boot](/setup/pxe.html)
  + [Kayak Client Configuration](/setup/kayakoptions.html)
  + [Active Directory Integration](/setup/ad-connect.html)
  + [zadm walk-through series](/setup/zadm.html)
* OmniOS Operation
  + [Getting Started](/info/getstarted.html)
  + [bhyve Hypervisor](/info/bhyve.html)
  + [bhyve and KVM branded zones](/info/bhyve_kvm_brand.html)
  + [Migrate KVM to bhyve](/info/bhyve_migrate.html)
  + [IP Filter](/info/ipfilter.html)
  + [IPS Repositories](/info/ipsrepos.html)
  + [ISC DHCP](/info/isc-dhcp.html)
  + [Mitigating Meltdown (KPTI)](/info/kpti.html)
  + [Linked Image Zones](/info/linked_images.html)
  + [BSD Loader](/info/loader.html)
  + [LX Branded Zones](/info/lxzones.html)
  + [Migrate entire pool to new pool](/info/migrate_entire_pool.html)
  + [Migrate rpool to new disk(s)](/info/migrate_rpool.html)
  + [Advanced migrate rpool to new disk(s)](/info/migrate_rpool_advanced.html)
  + [OpenLDAP Client Authentication](/info/openldap-client-auth.html)
  + [OpenLDAP Quick Start Guide](/info/openldap.html)
  + [Deprecating SunSSH Options](/info/sunssh.html)
  + [Virtual Machines with KVM](/info/virtualmachineskvm.html)
  + [ZRepl Quick Start Guide](/info/zrepl.html)
* OmniOS Development
  + [Building OmniOS](/dev/build_instructions.html)
  + [Creating an EC2 AMI](/dev/ec2.html)
  + [Building illumos-gate](/dev/gate.html)
  + [Cutting a Release](/dev/release.html)
* The Making Of
  + [OmniOSce CA Config](/makingof/caconfig.html)
  + [Nginx for depotd](/makingof/nginxconfig.html)
  + [Setup restricted SFTP](/makingof/serversetup.html)
  + [pkg(5) Repo Setup](/makingof/setuprepo.html)

Documentation
[![Home](/OmniOSce_logo.svg)](/)

* [Commercial Support](/invoice.html)
* [Donate](/patron.html)
* [Release Notes](/releasenotes.html)
* [Downloads](/download.html)

# OmniOS Community Edition r151030y, r151028ay, r151022dwPublished at October 21, 2019 OmniOS Community Edition weekly releases for w/c 21st of October 2019 are now available. The following updates are available for **all supported releases**: * Upgrade `sudo` package to 1.8.28p1, fixing [CVE-2019-14287](https://www.sudo.ws/alerts/minus_1_uid.html) Additionally, for **r151030** only: * Update Intel Microcode to 20190918 * Update timezone and hardware databases * CIFS: Windows usernames are now treated case-insensitively * Improvements to AMD processor topology detection * Improved compatibility with Linux getsockopt() in lx zones * Fix for bad ARP behaviour after long uptimes - [illumos 11378](https://www.illumos.org/issues/11378) * Fix (rare) kernel crash problem exposed by Go testsuite [illumos 11556](https://www.illumos.org/issues/11556) For further details, please see [https://omnios.org/releasenotes](/releasenotes.html) â Any problems or questions, please [get in touch](/about/contact.html).

### OmniOS Newsletter

Subscribe to our newsletter, to keep up to date with new releases of OmniOS and major security updates!

Subscribe Now!

Don't ask again

Close

##### Links

* [Get in touch](/about/contact.html)
* [GitHub](https://github.com/omniosorg)
* [FaceBook](https://fb.me/omniosce)
* [Twitter](https://twitter.com/omniosce)
* [Mailing List](https://illumos.topicbox.com/groups/omnios-discuss)
* [Newsletter Subscription](https://list.omnios.org/subscription/form)

##### OmniOS Community Edition

* [About OmniOS](/about/about.html)
* [Privacy Policy](/about/privacy.html)
* [Atom Feed](/feed.xml)

illumos based server OS with ZFS, DTrace, Crossbow, SMF, Bhyve, KVM and Linux zone support


