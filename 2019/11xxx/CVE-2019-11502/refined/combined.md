=== Content from www.openwall.com_701a7b48_20250120_233252.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](3) [[next>]](5) [[thread-next>]](../../../2019/04/25/7) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20190418104355.GD9248@f195.suse.de>
Date: Thu, 18 Apr 2019 12:43:55 +0200
From: Matthias Gerstner <mgerstner@...e.de>
To: oss-security@...ts.openwall.com
Subject: Security issues in snapcraft snap-confine set*id binary

Hello,

a couple of security issues have been found in the snapcraft package
manager [1] during the course of a security review for inclusion of
snapcraft in openSUSE [2]. The basis for this review was upstream
version 2.37.4.

snapcraft uses a setuid/setgid root program called `snap-confine` to
setup namespace based containers for snap packages. While the program's
code is generally of good quality the following moderate security issues
have been found:

1) Up and including to version 2.37.4 the /tmp directory within a snap
  container was owned by the first user that entered the container. Since
  snap containers can be used by multiple users at the same time or a
  privileged program or daemon may run in a container, the security of
  files and directories in /tmp is compromised.  An attacker can remove
  or replace files and directories belonging to other users within the
  container's /tmp to achieve an unspecified impact.

  This issue was recently fixed by upstream via commit [3].

2) The `sc_join_preserved_ns()` function along with a number of other
  function remembers the current working directory (CWD) of the calling
  user outside of the container and attempts to restore this CWD again
  within the container. The `chdir()` operation to restore the CWD is
  performed with root privileges within the container and is prone to
  symlink attacks. Therefore an unprivileged user can enter arbitrary
  directories within the container. Example PoC:

  ```
  user1 $ snap run --shell opera
    user1 $ cd /tmp
    user1 $ umask 077
    user1 $ mkdir user1_private
    user1 $ cd user1_private
    user1 $ umask 022
    user1 $ mkdir subdir
    user1 $ cd subdir
    user1 $ echo secret >file

  user2 $ cd /tmp
  user2 $ mkdir -p user1_private/subdir
  user2 $ ln -s /tmp/user1_private/subdir user2_private
  user2 $ cd user2_private
  user2 $ snap run --shell opera
    user2 $ /tmp/user1_private/subdir
    user2 $ cat file
    secret
  ```

  In this example user2 enters the public sub-directories of a private
  tmp directory of user1 within the application container. Basically
  this can also be used to enter /root or /var/lib/snapd/hostfs/root/.config
  and so on.

  The severity of this issue is reduced, because snap-confine employs
  extensive AppArmor profiles that prevent many file system accesses
  beyond classic DAC permission checks.

  This issue is addressed by an upstream PR [4].

3) In function `sc_parse_mountinfo_entry()` the pseudo file
  /proc/self/mountinfo is parsed. In the subsequently called helper
  function `parse_next_string_field()` most of the content of each line
  from that file is parsed. This helper function uses `sscanf()` with a
  "%s%n" format. %s in `sscanf()` extracts a whitespace delimited
  string. While the kernel protects e.g. against newlines found in
  directory names by encoding them specially in the mountinfo file,
  there are whitespace characters that are not protected against.
  Unprivileged users can use mechanisms like FUSE based file systems
  like sshfs to mount file systems onto such strangely named
  directories:

  ```
  user $ cd /tmp
  user $ mkdir `echo -e "strange\rdir"`
  user $ sshfs localhost:/tmp strange?dir
  ```

  The result will be an entry in /proc/self/mountinfo that looks like
  this:

  ```
  111 107 0:49 / /tmp/strange\rdir rw,nosuid,nodev,relatime shared:59 - fuse.sshfs localhost:/tmp/ rw,user_id=1000,group_id=100\n
  ```

  The parsing logic in snap-confine will wrongly treat "/tmp/strange" as
  the `mount_dir` and continue parsing "the next field" after the
  carriage return.  Basically this allows the attacker to provide the
  rest of the fields parsed by snap-confine via the directory name. In
  my tests no failure was detected by `sc_parse_mountinfo()`, since
  parsing "%s" always works as long there is data left to parse.

  I don't see any viable attack vector here at the moment. To actually
  control the behaviour of snap-confine we'd need to control the field
  (4) of the mountinfo file. This field is only available to
  unprivileged users if they can perform a bind mount. Maybe there is a
  setuid tool around that allows such things, then it would be a tool to
  further influence what snap-confine does. In such a case it could e.g.
  be used to force triggering of the discard-ns logic of snap-confine.

  This issue is addressed by an upstream PR [5].

I've asked upstream to assign CVEs for issues 1) and 2) but they're not
available yet.

Best Regards

Matthias

[1]: <https://snapcraft.io/>
[2]: <https://bugzilla.suse.com/show_bug.cgi?id=1127368>
[3]: <https://github.com/snapcore/snapd/commit/bdbfeebef03245176ae0dc323392bb0522a339b1>
[4]: <https://github.com/snapcore/snapd/pull/6642>
[5]: <https://github.com/snapcore/snapd/pull/6605>

--
Matthias Gerstner <matthias.gerstner@...e.de>
Dipl.-Wirtsch.-Inf. (FH), Security Engineer
<https://www.suse.com/security>
Phone: +49 911 740 53 290
GPG Key ID: 0x14C405C971923553

SUSE Linux GmbH
GF: Felix Imendörffer, Mary Higgins, Sri Rasiah
HRB 21284 (AG Nuernberg)

Download attachment "[signature.asc](4/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_09fe223a_20250120_233251.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2Fbdbfeebef03245176ae0dc323392bb0522a339b1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2Fbdbfeebef03245176ae0dc323392bb0522a339b1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=canonical%2Fsnapd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[snapd](/canonical/snapd)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fsnapd) You must be signed in to change notification settings
* [Fork
  594](/login?return_to=%2Fcanonical%2Fsnapd)
* [Star
   1.9k](/login?return_to=%2Fcanonical%2Fsnapd)

* [Code](/canonical/snapd)
* [Pull requests
  147](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects
  0](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

Additional navigation options

* [Code](/canonical/snapd)
* [Pull requests](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

## Commit

[Permalink](/canonical/snapd/commit/bdbfeebef03245176ae0dc323392bb0522a339b1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

cmd/snap-confine: chown private /tmp parent to root.root

[Browse files](/canonical/snapd/tree/bdbfeebef03245176ae0dc323392bb0522a339b1)
Browse the repository at this point in the history

```
When snap-confine creates a private /tmp directory for a given snap it
first creates a temporary directory in /tmp/ named after the snap, along
with a random name. Inside that directory it creates a /tmp directory
with permissions appropriate for a future /tmp, namely 1777.

Up until recently the that directory was owned by the user who first
invoked snap-confine. Since the directory is reused by all the users on
the system this logic makes no sense.

This patch changes the related logic so that the private /tmp directory
is owned by root, just like the real one.

Signed-off-by: Zygmunt Krynicki <zygmunt.krynicki@canonical.com>
```

* Loading branch information

[![@zyga](https://avatars.githubusercontent.com/u/784262?s=40&v=4)](/zyga)

[zyga](/canonical/snapd/commits?author=zyga "View all commits by zyga")
committed
Mar 4, 2019

1 parent
[1d7b5d8](/canonical/snapd/commit/1d7b5d8bea96139d3d9b301e6c06534d8fc95eff)

commit bdbfeeb

Showing
**1 changed file**
with
**1 addition**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

4 changes: 1 addition & 3 deletions

4
[cmd/snap-confine/mount-support.c](#diff-873235435b32bdec83fa69bddac35d88b80edbf85a28090b851c16065ea6a86b "cmd/snap-confine/mount-support.c")

Show comments

[View file](/canonical/snapd/blob/bdbfeebef03245176ae0dc323392bb0522a339b1/cmd/snap-confine/mount-support.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -62,8 +62,6 @@ |
|  |  | // TODO: fold this into bootstrap |
|  |  | static void setup\_private\_mount(const char \*snap\_name) |
|  |  | { |
|  |  | uid\_t uid = getuid(); |
|  |  | gid\_t gid = getgid(); |
|  |  | char tmpdir[MAX\_BUF] = { 0 }; |
|  |  |  |
|  |  | // Create a 0700 base directory, this is the base dir that is |
| Expand Down  Expand Up | | @@ -98,7 +96,7 @@ static void setup\_private\_mount(const char \*snap\_name) |
|  |  | // MS\_PRIVATE needs linux > 2.6.11 |
|  |  | sc\_do\_mount("none", "/tmp", NULL, MS\_PRIVATE, NULL); |
|  |  | // do the chown after the bind mount to avoid potential shenanigans |
|  |  | if (chown("/tmp/", uid, gid) < 0) { |
|  |  | if (chown("/tmp/", 0, 0) < 0) { |
|  |  | die("cannot change ownership of /tmp"); |
|  |  | } |
|  |  | // chdir to original directory |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `bdbfeeb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2Fbdbfeebef03245176ae0dc323392bb0522a339b1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_6587b13a_20250120_233250.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Follow @Openwall on Twitter for new release announcements and other news](https://twitter.com/openwall) | | --- | |
| --- | --- |

[[<prev]](6) [[next>]](8) [[<thread-prev]](../../../2019/04/18/4) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20190425133024.GE13360@iolanthe>
Date: Thu, 25 Apr 2019 08:30:24 -0500
From: Jamie Strandboge <jamie@...onical.com>
To: oss-security@...ts.openwall.com
Cc: Matthias Gerstner <matthias.gerstner@...e.de>,
	Zygmunt Krynicki <zygmunt.krynicki@...onical.com>
Subject: Re: Security issues in snapcraft snap-confine set*id
 binary

On Thu, 18 Apr 2019, Matthias Gerstner wrote:

> 1) Up and including to version 2.37.4 the /tmp directory within a snap
>   container was owned by the first user that entered the container. Since
>   snap containers can be used by multiple users at the same time or a
>   privileged program or daemon may run in a container, the security of
>   files and directories in /tmp is compromised.  An attacker can remove
>   or replace files and directories belonging to other users within the
>   container's /tmp to achieve an unspecified impact.
>
>   This issue was recently fixed by upstream via commit [3].

This is CVE-2019-11502

> 2) The `sc_join_preserved_ns()` function along with a number of other
>   function remembers the current working directory (CWD) of the calling
>   user outside of the container and attempts to restore this CWD again
>   within the container. The `chdir()` operation to restore the CWD is
>   performed with root privileges within the container and is prone to
>   symlink attacks. Therefore an unprivileged user can enter arbitrary
>   directories within the container. Example PoC:

This is CVE-2019-11503

> 3) In function `sc_parse_mountinfo_entry()` the pseudo file
...
>   I don't see any viable attack vector here at the moment. To actually
>   control the behaviour of snap-confine we'd need to control the field
>   (4) of the mountinfo file. This field is only available to
>   unprivileged users if they can perform a bind mount.

I agree, this is a legitimate bug that the snapd team will fix but because an
unprivileged user can't gain privileges or other wise cross privilege
boundaries, I did not request a CVE. We can revisit as necessary.

> Best Regards
>
> Matthias

Thank you for the review!

--
Jamie Strandboge             | <http://www.canonical.com>

Download attachment "[signature.asc](7/1)" of type "application/pgp-signature" (834 bytes)

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).


