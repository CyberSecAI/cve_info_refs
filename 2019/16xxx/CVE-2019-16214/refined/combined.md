=== Content from blog.openzeppelin.com_d08a08ec_20250121_004711.html ===


[![OpenZeppelin](https://blog.openzeppelin.com/hubfs/oz-nav.svg)](https://openzeppelin.com)
[![OpenZeppelin](https://blog.openzeppelin.com/hubfs/oz-logo-white.svg)](https://openzeppelin.com)

* Products
  Open Source Tools
  [![](https://blog.openzeppelin.com/hubfs/contracts-library-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/contracts-library-dark.svg)
  Contracts Library

  Secure smart contract templates](https://www.openzeppelin.com/solidity-contracts)
  [![](https://blog.openzeppelin.com/hubfs/contracts-wizard-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/wizard-dark.svg)
  Contracts Wizard

  Interactive smart contract generator](https://wizard.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/upgrade-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/upgrades-dark.svg)
  Upgrades Plugin

  Safe and easy smart contract upgrades](https://docs.openzeppelin.com/upgrades-plugins/1.x/)

  [Defender Cloud Services](https://www.openzeppelin.com/defender)
  [![](https://blog.openzeppelin.com/hubfs/relayers-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/relayers-dark.svg)
  Relayers

  Send reliable transactions via API](https://www.openzeppelin.com/defender#secure-operations)
  [![](https://blog.openzeppelin.com/hubfs/monitor-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/monitor-dark.svg)
  Monitor

  Gain visibility into your smart contracts](https://www.openzeppelin.com/defender#secure-operations)
  [![](https://blog.openzeppelin.com/hubfs/actions-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/actions-dark.svg)
  Actions

  Automate smart contract operations](https://www.openzeppelin.com/defender#actions)
  [![](https://blog.openzeppelin.com/hubfs/access-control-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/acces-control-dark.svg)
  Access Control

  Manage contract roles and permissions](https://access-manager.openzeppelin.com/explorer/11155111)

  [![](https://blog.openzeppelin.com/hubfs/code-inspector-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/code-inspector-dark.svg)
  Code Inspector

  Find and resolve smart contract vulnerabilities](https://www.openzeppelin.com/defender#secure-code)
  [![](https://blog.openzeppelin.com/hubfs/deploy-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/deploy-dark.svg)
  Deploy

  Launch and upgrade smart contracts safely](https://www.openzeppelin.com/defender#secure-deploy)
  [![](https://blog.openzeppelin.com/hubfs/transaction-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/transaction-proposals-dark.svg)
  Transaction Proposals

  Interactive transaction builder](https://www.openzeppelin.com/defender#secure-operations)

  [Defender Pricing ->](https://www.openzeppelin.com/pricing)
* Services
  Services
  [![](https://blog.openzeppelin.com/hubfs/sa-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/sa-nav-1.svg)
  Smart Contract Security Audit

  Industry standard for securing smart contracts](https://www.openzeppelin.com/security-audits)
  [![](https://blog.openzeppelin.com/hubfs/er-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/er-nav-1.svg)
  Emergency Response

  React with expertise and speed](https://www.openzeppelin.com/emergency-response)
  [![](https://blog.openzeppelin.com/hubfs/zkp-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/zkp-nav-1.svg)
  ZKP Practice

  Scalability, Privacy, and Security](https://www.openzeppelin.com/zkp)

  Solutions
  [![](https://blog.openzeppelin.com/hubfs/es-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/es-nav-1.svg)
  Ecosystem Stack

  Developer acquisition, accelerated](https://www.openzeppelin.com/ecosystems)
* Resources
  Resources
  [![](https://blog.openzeppelin.com/hubfs/docs-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/docs-nav-1.svg)
  Documentation](https://docs.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/blog-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/blog-nav-1.svg)
  Blog](https://blog.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/forum-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/forum-nav-1.svg)
  Forum](https://forum.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/ethernaut-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-1.svg)
  Ethernaut CTF](https://ethernaut.openzeppelin.com/)

  Company
  [About us](https://www.openzeppelin.com/about)
  [Careers](https://www.openzeppelin.com/careers)
  [Security Center](https://contracts.openzeppelin.com/security)

[Login](https://defender.openzeppelin.com/v2/#/auth/sign-in)
[Talk to an Expert](https://www.openzeppelin.com/request?id=talk_to_an_expert-navbar)
[Sign Up](https://defender.openzeppelin.com/v2/#/auth/sign-up?)

* [Talk to an Expert](https://www.openzeppelin.com/request?id=talk_to_an_expert-navbar)
* [Sign Up](https://defender.openzeppelin.com/v2/#/auth/sign-up?)
* Products
  + Open Source Tools
  + [![](https://blog.openzeppelin.com/hubfs/contracts-library-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/contracts-library-mobile.svg)Contracts Library](https://www.openzeppelin.com/solidity-contracts)
  + [![](https://blog.openzeppelin.com/hubfs/wizard-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/wizard-mobile.svg)Contracts Wizard](https://wizard.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/plugins-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/plugins-mobile.svg)Upgrades Plugins](https://docs.openzeppelin.com/upgrades-plugins/1.x/)
  + [Defender Cloud Services](https://www.openzeppelin.com/defender)
  + [![](https://blog.openzeppelin.com/hubfs/relayers-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/relayers-mobile.svg)Relayers](https://www.openzeppelin.com/defender#secure-operations)
  + [![](https://blog.openzeppelin.com/hubfs/monitor-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/monitor-mobile.svg)Monitor](https://www.openzeppelin.com/defender#secure-operations)
  + [![](https://blog.openzeppelin.com/hubfs/actions-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/actions-mobile.svg)Actions](https://www.openzeppelin.com/defender#actions)
  + [![](https://blog.openzeppelin.com/hubfs/accescontrol-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/accescontrol-mobile.svg)Access Control](https://access-manager.openzeppelin.com/explorer/11155111)
  + [![](https://blog.openzeppelin.com/hubfs/inspector-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/inspector-mobile.svg)Code Inspector](https://www.openzeppelin.com/defender#secure-code)
  + [![](https://blog.openzeppelin.com/hubfs/deploy-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/deploy-mobile.svg)Deploy](https://www.openzeppelin.com/defender#secure-deploy)
  + [![](https://blog.openzeppelin.com/hubfs/transaction-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/transaction-mobile.svg)Transaction Proposals](https://www.openzeppelin.com/defender#secure-operations)
  + [Defender Pricing](https://www.openzeppelin.com/pricing)
* Services
  + [![](https://blog.openzeppelin.com/hubfs/sa-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/sa-nav-mobile.svg)Smart Contract Security Audit](https://www.openzeppelin.com/security-audits)
  + [![](https://blog.openzeppelin.com/hubfs/er-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/er-nav-mobile.svg)Emergency Response](https://www.openzeppelin.com/emergency-response)
  + [![](https://blog.openzeppelin.com/hubfs/zkp-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/zkp-nav-mobile.svg)ZKP Practice](https://www.openzeppelin.com/zkp)
  + Solutions
  + [![](https://blog.openzeppelin.com/hubfs/es-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/es-nav-mobile.svg)Ecosystem Stack](https://www.openzeppelin.com/ecosystems)
* Resources
  + [![](https://blog.openzeppelin.com/hubfs/docs-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/docs-nav-mobile.svg)Documentation](https://docs.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/blog-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/blog-nav-mobile.svg)Blog](https://blog.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/forum-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/forum-nav-mobile.svg)Forum](https://forum.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-mobile.svg)Ethernaut CTF](https://ethernaut.openzeppelin.com/)
* Company
  + [About us](https://www.openzeppelin.com/about)
  + [Careers](https://www.openzeppelin.com/careers)
  + [Security Center](https://contracts.openzeppelin.com/security)

# OpenZeppelin Uncovers Vulnerability in Libra’s Move IR Compiler

OpenZeppelin Security |
September 9, 2019

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)

SAN FRANCISCO, September 10, 2019 – OpenZeppelin, a leader in blockchain infrastructure security, today announced that its research team discovered a vulnerability in Libra’s Move IR compiler. The company found a problem in Libra’s intermediate representation language compiler, the Move IR, that could allow cybercriminals to exploit the yet-to-be-launched cryptocurrency network. After being alerted, the Libra team applied a patch to avert an issue that could have affected millions of Libra users once the network is launched.

The newly discovered vulnerability could allow malicious actors to publish deceitful Move modules that would look one way to a user but behave in a different manner. For example, a digital wallet could look like it has frozen new deposits and would release them after a prescribed length of time. But those funds would never be released or worse, would be diverted.

According to OpenZeppelin’s research team, the vulnerability could let malicious actors write inline comments that could act like executable code. This issue would render the Move IR module source files with inline comments untrustworthy— a liability in a blockchain setting where auditability substitutes for trust.

“As cryptocurrency continues to grow in popularity, it is vital for companies to audit and ensure that their networks are secure,” said Demian Brener, OpenZeppelin CEO. “Libra is groundbreaking, and it’s great how they involve the community by open sourcing their code early in the process. Because of this, we were able to find this vulnerability before the Libra network went live, averting potentially damaging effects. Our team shared several exploit scenarios with the Libra team that illustrated why they needed to address this issue quickly.”

OpenZeppelin alerted the Libra Association to the issue. The organization addressed the vulnerability and released a patch. For a more detailed look at what the OpenZeppelin found, read their technical description in the OpenZeppelin [blog](https://blog.openzeppelin.com/libra-vulnerability-summary/).

**About OpenZeppelin**

OpenZeppelin builds developer tools and performs security audits for decentralized systems that power multimillion-dollar economies. The leader in blockchain infrastructure security, OpenZeppelin has set industry standards for building secure, decentralized systems and has gained the trust from industry leaders including Brave, Coinbase, Ethereum Foundation, Compound and Augur. OpenZeppelin built and maintains the world’s leading Open Source library for smart contract development with more than one million downloads and 180 contributors. Follow OpenZeppelin on [Twitter](http://twitter.com/OpenZeppelin) and our [blog](https://blog.openzeppelin.com).

## Related Posts

[![Forta Firewall Incremental Audit Featured Image](https://blog.openzeppelin.com/hubfs/Forta%20Firewall%20Incremental%20Audit.png)](https://blog.openzeppelin.com/forta-firewall-incremental-audit "Forta Firewall Incremental Audit")
## [Forta Firewall Incremental Audit](https://blog.openzeppelin.com/forta-firewall-incremental-audit "Forta Firewall Incremental Audit")

We performed an incremental audit on the forta-network/forta-firewall-contracts repository between...

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Origin OUSD Audit Featured Image](https://blog.openzeppelin.com/hubfs/Group%201000003816-1.png)](https://blog.openzeppelin.com/origin-ousd-audit "Origin OUSD Audit")
## [Origin OUSD Audit](https://blog.openzeppelin.com/origin-ousd-audit "Origin OUSD Audit")

We audited the OriginProtocol/origin-dollar repository at commit 4495130. Smart Contract Audit.

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Sonic Gateway Audit Featured Image](https://blog.openzeppelin.com/hubfs/Group%201000003816.png)](https://blog.openzeppelin.com/sonic-gateway-audit "Sonic Gateway Audit")
## [Sonic Gateway Audit](https://blog.openzeppelin.com/sonic-gateway-audit "Sonic Gateway Audit")

We audited the Fantom-foundation/Bridge repository at commit 558465d. Smart Contract Audit.

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Openzeppelin](https://blog.openzeppelin.com/hubfs/iso-openzeppelin.svg)](https://www.openzeppelin.com/)

[![Openzeppelin](https://blog.openzeppelin.com/hubfs/iso-openzeppelin.svg)](https://www.openzeppelin.com/)

©  Zeppelin Group Ltd
[Service Level Agreement](https://www.openzeppelin.com/service-level-agreement)
[Terms of Service](https://www.openzeppelin.com/tos)
[Privacy Policy](https://www.openzeppelin.com/privacy)

Products

* [Contracts Library](https://openzeppelin.com/contracts)
* [Contracts Wizard](https://wizard.openzeppelin.com/)
* [Upgrade Plugins](https://docs.openzeppelin.com/upgrades-plugins/1.x/)
* [Defender Cloud Services](https://www.openzeppelin.com/defender)

Services

* [Smart Contract Security Audit](https://www.openzeppelin.com/security-audits)
* [Emergency Response](https://www.openzeppelin.com/emergency-response)
* [ZKP Practice](https://www.openzeppelin.com/zkp)
* [Ecosystem Stack](https://www.openzeppelin.com/ecosystems)

Resources

* [Documentation](https://docs.openzeppelin.com/)
* [Blog](https://blog.openzeppelin.com/)
* [Forum](https://forum.openzeppelin.com/)
* [Ethernaut CTF](https://ethernaut.openzeppelin.com/)

Company

* [About us](https://www.openzeppelin.com/about)
* [Careers](https://www.openzeppelin.com/careers)
* [Brand Kit](https://www.openzeppelin.com/brand-kit)
* [Trust](https://trust.openzeppelin.com/)



=== Content from github.com_715177de_20250121_004713.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiem%2Fdiem%2Fcommit%2F7efb0221989f17fdf7f8486730898ed947a1e19e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiem%2Fdiem%2Fcommit%2F7efb0221989f17fdf7f8486730898ed947a1e19e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=diem%2Fdiem)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[diem](/diem)
/
**[diem](/diem/diem)**
Public

* [Notifications](/login?return_to=%2Fdiem%2Fdiem) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fdiem%2Fdiem)
* [Star
   16.7k](/login?return_to=%2Fdiem%2Fdiem)

* [Code](/diem/diem)
* [Issues
  357](/diem/diem/issues)
* [Pull requests
  5](/diem/diem/pulls)
* [Actions](/diem/diem/actions)
* [Projects
  0](/diem/diem/projects)
* [Security](/diem/diem/security)
* [Insights](/diem/diem/pulse)

Additional navigation options

* [Code](/diem/diem)
* [Issues](/diem/diem/issues)
* [Pull requests](/diem/diem/pulls)
* [Actions](/diem/diem/actions)
* [Projects](/diem/diem/projects)
* [Security](/diem/diem/security)
* [Insights](/diem/diem/pulse)

## Commit

[Permalink](/diem/diem/commit/7efb0221989f17fdf7f8486730898ed947a1e19e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[language] Restrict character classes allowed in IR

[Browse files](/diem/diem/tree/7efb0221989f17fdf7f8486730898ed947a1e19e)
Browse the repository at this point in the history

```
This PR restricts the character classes that are allowed in IR files to
either be:
* ASCII printable (space through ~).
* \n for newlines
* \t for tabs
All other characters anywhere in the file will result in an error being
raised before the string is even passed to the parser.
```

* Loading branch information

[![@tzakian](https://avatars.githubusercontent.com/u/2895723?s=40&v=4)](/tzakian)

Tim Zakian
authored and
[tzakian](/diem/diem/commits?author=tzakian "View all commits by tzakian")
committed
Sep 3, 2019

1 parent
[f7577df](/diem/diem/commit/f7577dfc5ab264bde4a70e1b70559eb95ee4f38b)

commit 7efb022

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**147 additions**
and
**17 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* language/compiler/ir\_to\_bytecode

  + language/compiler/ir\_to\_bytecode/Cargo.toml
    [Cargo.toml](#diff-489126ed055fac2d281827fc33b27c8158ab0c655755796157fa3c901382cf6c)
  + src

    - language/compiler/ir\_to\_bytecode/src/parser.rs
      [parser.rs](#diff-38420665db9b260e0d2a26306af1e773d34042ad1a4c6dce4322b21975ab9802)

## There are no files selected for viewing

1 change: 0 additions & 1 deletion

1
[language/compiler/ir\_to\_bytecode/Cargo.toml](#diff-489126ed055fac2d281827fc33b27c8158ab0c655755796157fa3c901382cf6c "language/compiler/ir_to_bytecode/Cargo.toml")

Show comments

[View file](/diem/diem/blob/7efb0221989f17fdf7f8486730898ed947a1e19e/language/compiler/ir_to_bytecode/Cargo.toml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,7 +15,6 @@ lalrpop-util = "0.16.3" |
|  |  | log = "0.4.7" |
|  |  | codespan = "0.1.3" |
|  |  | codespan-reporting = "0.1.4" |
|  |  | regex = "1.2.1" |
|  |  |  |
|  |  | [dev-dependencies] |
|  |  | types = { path = "../../../types", features = ["testing"] } |

163 changes: 147 additions & 16 deletions

163
[language/compiler/ir\_to\_bytecode/src/parser.rs](#diff-38420665db9b260e0d2a26306af1e773d34042ad1a4c6dce4322b21975ab9802 "language/compiler/ir_to_bytecode/src/parser.rs")

Show comments

[View file](/diem/diem/blob/7efb0221989f17fdf7f8486730898ed947a1e19e/language/compiler/ir_to_bytecode/src/parser.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,6 @@ use codespan\_reporting::{emit, termcolor::Buffer, Diagnostic, Label, Severity}; |
|  |  | use failure::\*; |
|  |  | use ir\_to\_bytecode\_syntax::syntax; |
|  |  | use lalrpop\_util::ParseError; |
|  |  | use regex::Regex; |
|  |  | use std::{ |
|  |  | collections::hash\_map::DefaultHasher, |
|  |  | hash::{Hash, Hasher}, |
| Expand All | | @@ -16,13 +15,69 @@ use types::account\_address::AccountAddress; |
|  |  | // Re-export this to make it convenient for other crates. |
|  |  | pub use ir\_to\_bytecode\_syntax::ast; |
|  |  |  |
|  |  | // Since lalrpop can't handle comments without a custom lexer, we somewhat hackily remove all the |
|  |  | // comments from the input string before passing it off to lalrpop. We only support single line |
|  |  | // comments for now. Will later on add in other comment types. |
|  |  | fn strip\_comments(string: &str) -> String { |
|  |  | // Remove line comments |
|  |  | let line\_comments = Regex::new(r"(?m)//.\*$").unwrap(); |
|  |  | line\_comments.replace\_all(string, "$1").into\_owned() |
|  |  | /// Determine if a character is an allowed eye-visible (printable) character. |
|  |  | /// |
|  |  | /// The only allowed printable characters are the printable ascii characters (SPACE through ~) and |
|  |  | /// tabs. All other characters are invalid and we return false. |
|  |  | pub fn is\_permitted\_printable\_char(c: char) -> bool { |
|  |  | let x = c as u32; |
|  |  | let is\_above\_space = x >= 0x20; // Don't allow meta characters |
|  |  | let is\_below\_tilde = x <= 0x7E; // Don't allow DEL meta character |
|  |  | let is\_tab = x == 0x09; // Allow tabs |
|  |  | (is\_above\_space && is\_below\_tilde) || is\_tab |
|  |  | } |
|  |  |  |
|  |  | /// Determine if a character is a permitted newline character. |
|  |  | /// |
|  |  | /// The only permitted newline character is \n. All others are invalid. |
|  |  | pub fn is\_permitted\_newline\_char(c: char) -> bool { |
|  |  | let x = c as u32; |
|  |  | x == 0x0A |
|  |  | } |
|  |  |  |
|  |  | /// Determine if a character is permitted character. |
|  |  | /// |
|  |  | /// A permitted character is either a permitted printable character, or a permitted |
|  |  | /// newline. Any other characters are disallowed from appearing in the file. |
|  |  | pub fn is\_permitted\_char(c: char) -> bool { |
|  |  | is\_permitted\_printable\_char(c) || is\_permitted\_newline\_char(c) |
|  |  | } |
|  |  |  |
|  |  | fn verify\_string(string: &str) -> Result<()> { |
|  |  | match string.chars().find(|c| !is\_permitted\_char(\*c)) { |
|  |  | None => Ok(()), |
|  |  | Some(chr) => bail!( |
|  |  | "Parser Error: invalid character {} found when reading file.\ |
|  |  | Only ascii printable, tabs (\\t), and \\n line ending characters are permitted.", |
|  |  | chr |
|  |  | ), |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn strip\_comments(source: &str) -> String { |
|  |  | const SLASH: char = '/'; |
|  |  | const SPACE: char = ' '; |
|  |  |  |
|  |  | let mut in\_comment = false; |
|  |  | let mut acc = String::with\_capacity(source.len()); |
|  |  | let mut char\_iter = source.chars().peekable(); |
|  |  |  |
|  |  | while let Some(chr) = char\_iter.next() { |
|  |  | let at\_newline = is\_permitted\_newline\_char(chr); |
|  |  | let at\_or\_after\_slash\_slash = |
|  |  | in\_comment || (chr == SLASH && char\_iter.peek().map(|c| \*c == SLASH).unwrap\_or(false)); |
|  |  | in\_comment = !at\_newline && at\_or\_after\_slash\_slash; |
|  |  | acc.push(if in\_comment { SPACE } else { chr }); |
|  |  | } |
|  |  |  |
|  |  | acc |
|  |  | } |
|  |  |  |
|  |  | // We restrict strings to only ascii visual characters (0x20 <= c <= 0x7E) or a permitted newline |
|  |  | // character--\n--or a tab--\t. |
|  |  | fn strip\_comments\_and\_verify(string: &str) -> Result<String> { |
|  |  | verify\_string(string)?; |
|  |  | Ok(strip\_comments(string)) |
|  |  | } |
|  |  |  |
|  |  | /// Given the raw input of a file, creates a `ScriptOrModule` enum |
| Expand All | | @@ -39,44 +94,44 @@ pub fn parse\_script\_or\_module(s: &str) -> Result<ast::ScriptOrModule> { |
|  |  | /// Given the raw input of a file, creates a `Program` struct |
|  |  | /// Fails with `Err(\_)` if the text cannot be parsed |
|  |  | pub fn parse\_program(program\_str: &str) -> Result<ast::Program> { |
|  |  | let stripped\_string = &strip\_comments(program\_str); |
|  |  | let stripped\_string = &strip\_comments\_and\_verify(program\_str)?; |
|  |  | let parser = syntax::ProgramParser::new(); |
|  |  | match parser.parse(stripped\_string) { |
|  |  | Ok(program) => Ok(program), |
|  |  | Err(e) => handle\_error(e, program\_str), |
|  |  | Err(e) => handle\_error(e, stripped\_string), |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Given the raw input of a file, creates a `Script` struct |
|  |  | /// Fails with `Err(\_)` if the text cannot be parsed |
|  |  | pub fn parse\_script(script\_str: &str) -> Result<ast::Script> { |
|  |  | let stripped\_string = &strip\_comments(script\_str); |
|  |  | let stripped\_string = &strip\_comments\_and\_verify(script\_str)?; |
|  |  | let parser = syntax::ScriptParser::new(); |
|  |  | match parser.parse(stripped\_string) { |
|  |  | Ok(script) => Ok(script), |
|  |  | Err(e) => handle\_error(e, script\_str), |
|  |  | Err(e) => handle\_error(e, stripped\_string), |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Given the raw input of a file, creates a single `ModuleDefinition` struct |
|  |  | /// Fails with `Err(\_)` if the text cannot be parsed |
|  |  | pub fn parse\_module(modules\_str: &str) -> Result<ast::ModuleDefinition> { |
|  |  | let stripped\_string = &strip\_comments(modules\_str); |
|  |  | let stripped\_string = &strip\_comments\_and\_verify(modules\_str)?; |
|  |  | let parser = syntax::ModuleParser::new(); |
|  |  | match parser.parse(stripped\_string) { |
|  |  | Ok(module) => Ok(module), |
|  |  | Err(e) => handle\_error(e, modules\_str), |
|  |  | Err(e) => handle\_error(e, stripped\_string), |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Given the raw input of a file, creates a single `Cmd` struct |
|  |  | /// Fails with `Err(\_)` if the text cannot be parsed |
|  |  | pub fn parse\_cmd(cmd\_str: &str, \_sender\_address: AccountAddress) -> Result<ast::Cmd> { |
|  |  | let stripped\_string = &strip\_comments(cmd\_str); |
|  |  | let stripped\_string = &strip\_comments\_and\_verify(cmd\_str)?; |
|  |  | let parser = syntax::CmdParser::new(); |
|  |  | match parser.parse(stripped\_string) { |
|  |  | Ok(cmd) => Ok(cmd), |
|  |  | Err(e) => handle\_error(e, cmd\_str), |
|  |  | Err(e) => handle\_error(e, stripped\_string), |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -124,3 +179,79 @@ where |
|  |  | println!("{}", msg); |
|  |  | bail!("ParserError: {}", e) |
|  |  | } |
|  |  |  |
|  |  | #[cfg(test)] |
|  |  | mod tests { |
|  |  | #[test] |
|  |  | fn verify\_character\_whitelist() { |
|  |  | let mut good\_chars = (0x20..=0x7E).collect::<Vec<u8>>(); |
|  |  | good\_chars.push(0x0A); |
|  |  | good\_chars.push(0x09); |
|  |  |  |
|  |  | let mut bad\_chars = (0x0..0x09).collect::<Vec<\_>>(); |
|  |  | bad\_chars.append(&mut (0x0B..=0x1F).collect::<Vec<\_>>()); |
|  |  | bad\_chars.push(0x7F); |
|  |  |  |
|  |  | // Test to make sure that all the characters that are in the whitelist pass. |
|  |  | { |
|  |  | let s = std::str::from\_utf8(&good\_chars) |
|  |  | .expect("Failed to construct string containing an invalid character. This shouldn't happen."); |
|  |  | assert!(super::verify\_string(s).is\_ok()); |
|  |  | } |
|  |  |  |
|  |  | // Test to make sure that we fail for all characters not in the whitelist. |
|  |  | for bad\_char in bad\_chars { |
|  |  | good\_chars.push(bad\_char); |
|  |  | let s = std::str::from\_utf8(&good\_chars) |
|  |  | .expect("Failed to construct string containing an invalid character. This shouldn't happen."); |
|  |  | assert!(super::verify\_string(s).is\_err()); |
|  |  | good\_chars.pop(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | #[test] |
|  |  | fn test\_strip\_comments() { |
|  |  | let mut good\_chars = (0x20..=0x7E).map(|x: u8| x as char).collect::<String>(); |
|  |  | good\_chars.push(0x09 as char); |
|  |  | good\_chars.push(0x0A as char); |
|  |  | good\_chars.insert(0, 0x2F as char); |
|  |  | good\_chars.insert(0, 0x2F as char); |
|  |  |  |
|  |  | { |
|  |  | let x = super::strip\_comments(&good\_chars); |
|  |  | assert!(x.chars().all(|x| x == ' ' || x == '\t' || x == '\n')); |
|  |  | } |
|  |  |  |
|  |  | // Remove the \n at the end of the line |
|  |  | good\_chars.pop(); |
|  |  |  |
|  |  | let bad\_chars: Vec<u8> = vec![ |
|  |  | 0x0B, // VT |
|  |  | 0x0C, // FF |
|  |  | 0x0D, // CR |
|  |  | 0x0D, 0x0A, // CRLF |
|  |  | 0xC2, 0x85, // NEL |
|  |  | 0xE2, 0x80, 0xA8, // LS |
|  |  | 0xE2, 0x80, 0xA9, // PS |
|  |  | 0x1E, // RS |
|  |  | 0x15, // NL |
|  |  | 0x76, // NEWLINE |
|  |  | ]; |
|  |  |  |
|  |  | let bad\_chars = std::str::from\_utf8(&bad\_chars).expect( |
|  |  | "Failed to construct string containing an invalid character. This shouldn't happen.", |
|  |  | ); |
|  |  | for bad\_char in bad\_chars.chars() { |
|  |  | good\_chars.push(bad\_char); |
|  |  | good\_chars.push('\n'); |
|  |  | good\_chars.push('a'); |
|  |  | let x = super::strip\_comments(&good\_chars); |
|  |  | assert!(x |
|  |  | .chars() |
|  |  | .all(|c| c == ' ' || c == '\t' || c == '\n' || c == 'a')); |
|  |  | good\_chars.pop(); |
|  |  | good\_chars.pop(); |
|  |  | good\_chars.pop(); |
|  |  | } |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7efb022`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdiem%2Fdiem%2Fcommit%2F7efb0221989f17fdf7f8486730898ed947a1e19e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from blog.openzeppelin.com_38e1c672_20250121_004711.html ===


[![OpenZeppelin](https://blog.openzeppelin.com/hubfs/oz-nav.svg)](https://openzeppelin.com)
[![OpenZeppelin](https://blog.openzeppelin.com/hubfs/oz-logo-white.svg)](https://openzeppelin.com)

* Products
  Open Source Tools
  [![](https://blog.openzeppelin.com/hubfs/contracts-library-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/contracts-library-dark.svg)
  Contracts Library

  Secure smart contract templates](https://www.openzeppelin.com/solidity-contracts)
  [![](https://blog.openzeppelin.com/hubfs/contracts-wizard-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/wizard-dark.svg)
  Contracts Wizard

  Interactive smart contract generator](https://wizard.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/upgrade-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/upgrades-dark.svg)
  Upgrades Plugin

  Safe and easy smart contract upgrades](https://docs.openzeppelin.com/upgrades-plugins/1.x/)

  [Defender Cloud Services](https://www.openzeppelin.com/defender)
  [![](https://blog.openzeppelin.com/hubfs/relayers-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/relayers-dark.svg)
  Relayers

  Send reliable transactions via API](https://www.openzeppelin.com/defender#secure-operations)
  [![](https://blog.openzeppelin.com/hubfs/monitor-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/monitor-dark.svg)
  Monitor

  Gain visibility into your smart contracts](https://www.openzeppelin.com/defender#secure-operations)
  [![](https://blog.openzeppelin.com/hubfs/actions-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/actions-dark.svg)
  Actions

  Automate smart contract operations](https://www.openzeppelin.com/defender#actions)
  [![](https://blog.openzeppelin.com/hubfs/access-control-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/acces-control-dark.svg)
  Access Control

  Manage contract roles and permissions](https://access-manager.openzeppelin.com/explorer/11155111)

  [![](https://blog.openzeppelin.com/hubfs/code-inspector-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/code-inspector-dark.svg)
  Code Inspector

  Find and resolve smart contract vulnerabilities](https://www.openzeppelin.com/defender#secure-code)
  [![](https://blog.openzeppelin.com/hubfs/deploy-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/deploy-dark.svg)
  Deploy

  Launch and upgrade smart contracts safely](https://www.openzeppelin.com/defender#secure-deploy)
  [![](https://blog.openzeppelin.com/hubfs/transaction-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/transaction-proposals-dark.svg)
  Transaction Proposals

  Interactive transaction builder](https://www.openzeppelin.com/defender#secure-operations)

  [Defender Pricing ->](https://www.openzeppelin.com/pricing)
* Services
  Services
  [![](https://blog.openzeppelin.com/hubfs/sa-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/sa-nav-1.svg)
  Smart Contract Security Audit

  Industry standard for securing smart contracts](https://www.openzeppelin.com/security-audits)
  [![](https://blog.openzeppelin.com/hubfs/er-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/er-nav-1.svg)
  Emergency Response

  React with expertise and speed](https://www.openzeppelin.com/emergency-response)
  [![](https://blog.openzeppelin.com/hubfs/zkp-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/zkp-nav-1.svg)
  ZKP Practice

  Scalability, Privacy, and Security](https://www.openzeppelin.com/zkp)

  Solutions
  [![](https://blog.openzeppelin.com/hubfs/es-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/es-nav-1.svg)
  Ecosystem Stack

  Developer acquisition, accelerated](https://www.openzeppelin.com/ecosystems)
* Resources
  Resources
  [![](https://blog.openzeppelin.com/hubfs/docs-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/docs-nav-1.svg)
  Documentation](https://docs.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/blog-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/blog-nav-1.svg)
  Blog](https://blog.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/forum-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/forum-nav-1.svg)
  Forum](https://forum.openzeppelin.com/)
  [![](https://blog.openzeppelin.com/hubfs/ethernaut-nav.svg)
  ![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-1.svg)
  Ethernaut CTF](https://ethernaut.openzeppelin.com/)

  Company
  [About us](https://www.openzeppelin.com/about)
  [Careers](https://www.openzeppelin.com/careers)
  [Security Center](https://contracts.openzeppelin.com/security)

[Login](https://defender.openzeppelin.com/v2/#/auth/sign-in)
[Talk to an Expert](https://www.openzeppelin.com/request?id=talk_to_an_expert-navbar)
[Sign Up](https://defender.openzeppelin.com/v2/#/auth/sign-up?)

* [Talk to an Expert](https://www.openzeppelin.com/request?id=talk_to_an_expert-navbar)
* [Sign Up](https://defender.openzeppelin.com/v2/#/auth/sign-up?)
* Products
  + Open Source Tools
  + [![](https://blog.openzeppelin.com/hubfs/contracts-library-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/contracts-library-mobile.svg)Contracts Library](https://www.openzeppelin.com/solidity-contracts)
  + [![](https://blog.openzeppelin.com/hubfs/wizard-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/wizard-mobile.svg)Contracts Wizard](https://wizard.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/plugins-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/plugins-mobile.svg)Upgrades Plugins](https://docs.openzeppelin.com/upgrades-plugins/1.x/)
  + [Defender Cloud Services](https://www.openzeppelin.com/defender)
  + [![](https://blog.openzeppelin.com/hubfs/relayers-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/relayers-mobile.svg)Relayers](https://www.openzeppelin.com/defender#secure-operations)
  + [![](https://blog.openzeppelin.com/hubfs/monitor-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/monitor-mobile.svg)Monitor](https://www.openzeppelin.com/defender#secure-operations)
  + [![](https://blog.openzeppelin.com/hubfs/actions-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/actions-mobile.svg)Actions](https://www.openzeppelin.com/defender#actions)
  + [![](https://blog.openzeppelin.com/hubfs/accescontrol-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/accescontrol-mobile.svg)Access Control](https://access-manager.openzeppelin.com/explorer/11155111)
  + [![](https://blog.openzeppelin.com/hubfs/inspector-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/inspector-mobile.svg)Code Inspector](https://www.openzeppelin.com/defender#secure-code)
  + [![](https://blog.openzeppelin.com/hubfs/deploy-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/deploy-mobile.svg)Deploy](https://www.openzeppelin.com/defender#secure-deploy)
  + [![](https://blog.openzeppelin.com/hubfs/transaction-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/transaction-mobile.svg)Transaction Proposals](https://www.openzeppelin.com/defender#secure-operations)
  + [Defender Pricing](https://www.openzeppelin.com/pricing)
* Services
  + [![](https://blog.openzeppelin.com/hubfs/sa-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/sa-nav-mobile.svg)Smart Contract Security Audit](https://www.openzeppelin.com/security-audits)
  + [![](https://blog.openzeppelin.com/hubfs/er-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/er-nav-mobile.svg)Emergency Response](https://www.openzeppelin.com/emergency-response)
  + [![](https://blog.openzeppelin.com/hubfs/zkp-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/zkp-nav-mobile.svg)ZKP Practice](https://www.openzeppelin.com/zkp)
  + Solutions
  + [![](https://blog.openzeppelin.com/hubfs/es-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/es-nav-mobile.svg)Ecosystem Stack](https://www.openzeppelin.com/ecosystems)
* Resources
  + [![](https://blog.openzeppelin.com/hubfs/docs-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/docs-nav-mobile.svg)Documentation](https://docs.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/blog-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/blog-nav-mobile.svg)Blog](https://blog.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/forum-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/forum-nav-mobile.svg)Forum](https://forum.openzeppelin.com/)
  + [![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-mobile-dark.svg)
    ![](https://blog.openzeppelin.com/hubfs/ethernaut-nav-mobile.svg)Ethernaut CTF](https://ethernaut.openzeppelin.com/)
* Company
  + [About us](https://www.openzeppelin.com/about)
  + [Careers](https://www.openzeppelin.com/careers)
  + [Security Center](https://contracts.openzeppelin.com/security)

# Libra’s Move IR Compiler Vulnerability

OpenZeppelin Security |
September 9, 2019

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)

We describe a vulnerability in the Move IR compiler whereby inline comments can be disguised as executable code. This is due to the Move IR parser failing to recognize some Unicode line break characters at the end of inline comments. In particular, while the code intends to parse the common \r, \n and \r\n, it fails to parse \r correctly. Additionally, other valid Unicode line break characters are ignored entirely by the parser.

The potential impact of the vulnerability can vary greatly and depend on i) the business logic of each specific module and its use cases, ii) current and future features of the Move IR language, and iii) the developer platform being used to submit bytecode to the Libra network. Some potential exploiting scenarios one can think of are:

* A faucet that mints assets (Libra Coins or any other asset on the Libra network) in exchange for a fee can deploy a malicious module that takes a fee but never actually provide the possibility of minting such asset to the user.
* A wallet that claims to keep deposits frozen and release them after a period of time may actually never release such funds.
* A payment splitter module that appears to divide some asset and forward it to multiple parties may actually never send the corresponding part to some of them.
* A module that takes sensitive data and applies some kind of cryptographic operation to obscure it (e.g. hashing or encrypting operations) may actually never apply such operation.

By crafting modules with specific line break characters different from `\n` at the end of inline comments, malicious module publishers can deceive users that trust their apparent source code. This is especially important in the blockchain setting, where trust is replaced by auditability. A related vulnerability was previously found by our team in the [Solidity compiler audit](https://blog.openzeppelin.com/solidity-compiler-audit-8cfc0316a420/) on Nov 1st, 2018.

**The events timeline is as follows:**

* August 6th: We disclosed the vulnerability to the Libra team, who acknowledged our notification.
* August 8th: The Libra team introduced a change to the line of code where we had pinpointed the vulnerability. The vulnerability was still present after this change. Upon checking in with them, they stated that the code change was unrelated to the vulnerability, and acknowledged that it didn’t fix the problem. We provide a technical description of the vulnerability in the patched code in the **Code change** section.
* September 3rd: The Libra team pushed a fix for the vulnerability and notified us about it.
* September 4th: We reviewed the patch, confirming that the vulnerability has been fixed. We provide details about this patch in **The fix** section.

## **Details**

We first explain where the vulnerability is, to then introduce two critical scenarios under which it could be exploited to disguise inline comments as executable code. The exploit relies on the fact that different text editors interpret and render line breaks in different ways. This could be leveraged by malicious actors entitled to publish Move modules in the Libra network to deceive users, who would then interact with modules behaving in unexpected ways.

While this feature is restricted to a set of trusted users today, it could potentially be open, public and permissionless in the future. In **The exploit** section we showcase a simple proof-of-concept Move module with a single resource declaration; more dangerous cases can be thought of in modules that handle valuable assets.

### **The vulnerability**

In the Move IR compiler code at commit [8ea3329](https://github.com/libra/libra/tree/8ea33298678117748f1c75112f35a9fbc05b2172), within the [strip\_comments function](https://github.com/libra/libra/blob/8ea33298678117748f1c75112f35a9fbc05b2172/language/compiler/ir_to_bytecode/src/parser.rs#L22), the parser module tries to identify inline comments [with a simple regular expression](https://github.com/libra/libra/blob/8ea33298678117748f1c75112f35a9fbc05b2172/language/compiler/ir_to_bytecode/src/parser.rs#L24) intended to match comments that end in `\r`, `\n` or `\r\n`:

```
fn strip_comments(string: &str) -> String {   // Remove line comments   let line_comments = Regex::new(r"//.*(\r\n|\n|\r)").unwrap();   line_comments.replace_all(string, "$1").into_owned() }
```

We have identified two cases where the parser fails:

1. The above function silently fails at detecting the end of an inline comment marked with the `\r` character.
2. The above function ignores several other Unicode characters lawfully representing line breaks.

#### Case 1

The Move IR parser uses a regular expression from the [regex](https://docs.rs/regex/1.1.9/regex) [Rust crate](https://docs.rs/regex/1.1.9/regex) to detect inline comments in the code of Move modules. It attempts to match inline comments ending with `\r\n`, `\n` or `\r` using:

```
Regex::new(r"//.*(\r\n|\n|\r)")
```

However, the regular expression does not actually behave as expected, as it **does not actually detect the end of inline comments marked by the** `\r` **line break character**.

In order to understand the exact behavior of the erroneous regular expression, we explain each of its components individually.

1. The `r` before the double quotes is a Rust feature to identify a [“raw string literal”](https://doc.rust-lang.org/rust-by-example/std/str.html#literals-and-escapes), used just as a convenient way to write the regex string as-is without having to escape special characters.
2. `//`: matches the start of the Move IR inline comment syntax.
3. `.*`: matches zero or more characters except for the line break character `\n`.This is due to [historic reasons](https://www.regular-expressions.info/dot.html), as regexes were originally used in line-based tools. The behavior is [documented](https://docs.rs/regex/1.1.9/regex/#unicode) in the `regex` Rust crate as follows:  *“[The character] . will match any valid UTF-8 encoded Unicode scalar value except for* `\n`*“.*
4. `(\r\n|\n|\r)`: is a capturing group matching characters `\r\n`,  `\n`, or `\r`, attempting to identify the end of the inline comment.

In general, a regex engine walks through the regular expression attempting to match the next token in the regex to the next character in the string. If a match is found, the engine advances through the regex and the subject string. In our case, every character in a Move IR inline comment will be first matched by the `.*` expression except for `\n`, as explained in point 3. Crucially, however, the `\r` character will be among those matched by `.*`. When the engine finally finds a `\n` in the string, it will stop consuming further characters.

What this entails is that the parser will only identify `\n` as the end of the inline comment, silently failing to identify `\r` as a line terminator. In other words, just as any other regular character, `\r` is considered as part of the comment instead of as its ending.

In **The exploit – Case 1** section we show a proof-of-concept case of a malicious Module that takes advantage of how a major editor renders the `\r` character.

#### Case 2

The Move IR parser intends to handle the most common line break characters CR (`\r`), LF (`\n`) and CRLF (`\r\n`). Besides failing to parse `\r` correctly, as described in **The vulnerability – Case 1**, there are several other [Unicode characters representing line breaks](https://en.wikipedia.org/wiki/Newline#Unicode) that the parser does not even attempt to detect. The complete set of Unicode line break characters is:

* LF (`\n` or `0x0A` in hex)
* VT (`\v` or `0x0B` in hex)
* FF (`0x0C` in hex)
* CR (`\r` or `0x0D` in hex)
* CRLF (`\r\n` or `0x0D0A` in hex)
* NEL (`0xC285` in hex)
* LS (`0xE280A8` in hex)
* PS (`0xE280A9` in hex)

Characters LF, CR and CRLF are the most widely recognized line breaks. Yet several code editors, the popular Visual Studio IDE among them, still properly render some of the less common line break characters such as NEL, LS or PS. As in Case 1, this can lead to malicious Move Modules that are hard to detect. Such examples are showcased in **The exploit – Case 2** section.

### **The exploit**

Any malicious actor entitled to deploy a module to the Libra network can leverage the described vulnerability. By crafting malicious modules with specific line break characters different from `\n` at the end of inline comments, they can deceive users that trust the apparent source code of the module, tricking them into executing undesired actions. This is especially important in the blockchain setting, where trust is replaced by auditability.

The nature of the deception can vary greatly and depend on i) the business logic of each specific module and its use cases and ii) current and future features of the Move IR language. Some potential exploiting scenarios one can think of are listed in the **Summary** section.

As a proof of concept, we now present two cases of malicious modules that respectively take advantage of both cases described in **The vulnerability** section. All test files referenced in this write up can be found in a private repository: <https://github.com/OpenZeppelin/move-compiler-vulnerability>.

#### Case 1: `\r`

Several code editors and renderers (e.g. Visual Studio Code, Sublime Text, Gedit, GitHub) consider the `\r` character (`0x0d` in hex) a valid line break. This means that these editors will show an inline comment and the following instruction in two different lines when separated by a `\r`. For example, [the following Move module](https://github.com/OpenZeppelin/move-compiler-vulnerability/blob/master/modules/Module_CR.mvir), as rendered by GitHub, appears to be declaring a resource.

![](https://blog.openzeppelin.com/hubfs/Imported_Blog_Media/_zKTLJNkIQerGK40PX5tA08hp7kl7gi0ABNek5KFemRsFY5j_xobgwcOf2yMWYt_cvyCTCNTFnf-zcK7BGy8W8anpXUOgT8ETZiL1IkBcIZPSH7EYrVAHRzPXj6EpEvF4GuPcFM-1.png)

But at the end of the inline comment there is an invisible `\r` line break character, which can be detected via inspection of the file’s hexdump:

```
$ xxd Module_CR.mvir  00000000: 6d6f 6475 6c65 204d 207b 0a20 2020 202f module M {. / 00000010: 2f20 536f 6d65 2063 6f6d 6d65 6e74 0d20 / Some comment.  00000020: 2020 2072 6573 6f75 7263 6520 417b 783a   resource A{x: 00000030: 2075 3634 7d0a 7d0a                     u64}.}.
```

As explained in **The vulnerability – Case 1** section, the above module will actually be compiled as an empty module.

In the **Validating with the Move IR compiler output** section we demonstrate the scenario with a more in-depth comparison of the compiler’s bytecode produced for regular and malicious Move modules.

#### Case 2: other line break characters

The most commonly accepted line break characters are `\n`, `\r` and `\r\n`. But as we already stated, the way in which text editors render line break characters differ from editor to editor. Here is how the [Visual Studio IDE](https://visualstudio.microsoft.com/vs/) editor (widely used by software developers) renders a very simple Move module with the common `\n` line break between the inline comment and the resource declaration:

##

But this editor interprets not only LF as a valid line break, [but also CRLF, NEL, LS and PS](https://docs.microsoft.com/en-us/visualstudio/ide/encodings-and-line-breaks?view=vs-2019).

Following we show how Visual Studio IDE shows the same simple module but with PS, NEL and LS line breaks respectively:

##

A user reading Move module’s code from any of these three last files using the Visual Studio IDE can be tricked into believing that the M module is declaring a resource, whereas the Move IR compiler will consider that instruction as part of the inline comment.

As exhibited in the screenshots included in the [images folder](https://github.com/OpenZeppelin/move-compiler-vulnerability/tree/master/images), the Unix command line `cat` as well as GNOME’s Gedit also display a similar behavior, unlike other major editors such as Visual Studio Code, Atom, Sublime Text, or the GitHub online editor.

### **Validating the Move IR compiler output**

For the sake of simplicity, we showcase the compiler’s output using two simple proof-of-concept modules, each corresponding to the cases 1 and 2 described previously. Yet, the following can be reproduced for all other line break characters that the Move IR parser fails to detect. The compiler we used was built from the latest commit to the date, [8ea33298678117748f1c75112f35a9fbc05b2172](https://github.com/libra/libra/tree/8ea33298678117748f1c75112f35a9fbc05b2172).

First, compile a simple non-malicious Move module with an inline comment and a resource declaration where all line breaks are `\n` (see [Module\_LF.mvir](https://github.com/OpenZeppelin/move-compiler-vulnerability/blob/master/modules/Module_LF.mvir)):

```
$ ./compiler Module_LF.mvir --module --output lf-output
```

The output in this case is:

```
$ xxd -ps lf-output  4c49425241564d0a0100080153000000020000000255000000040000000b 59000000020000000d5b00000002000000055d0000000600000004630000 002000000008830000000400000009870000000300000000000001010001 020300014d01410178000000000000000000000000000000000000000000 000000000000000000000000020100000200
```

Now compile a non-malicious Move module *without* a resource declaration (see [Module\_Commented.mvir](https://github.com/OpenZeppelin/move-compiler-vulnerability/blob/master/modules/Module_Commented.mvir)):

```
$ ./compiler Module_Commented.mvir --module --output commented-output
```
```
$ xxd -ps commented-output  4c49425241564d0a010004012f000000020000000d310000000200000005 330000000200000004350000002000000000000300014d00000000000000 00000000000000000000000000000000000000000000000000
```

Let’s now compile two different malicious Move modules that disguise an inline comment as executable code. First, corresponding to [Case 1](https://docs.google.com/document/d/1_L2aS2XCzrZQ1jME8BIAbMDgCdgdCKn_oDgYSQ7mGZg/edit#heading=h.gk9j48odzs3f), the line break between the inline comment and the resource declaration will be the CR character (`\r` or `0x0D` in hex; see [Module\_CR.mvir](https://github.com/OpenZeppelin/move-compiler-vulnerability/blob/master/modules/Module_CR.mvir)):

```
$ ./compiler Module_CR.mvir --module --output cr-output
```

The output in this case is:

```
$ xxd -ps cr-output  4c49425241564d0a010004012f000000020000000d310000000200000005 330000000200000004350000002000000000000300014d00000000000000 00000000000000000000000000000000000000000000000000
```

Next, as an instance of [Case 2](https://docs.google.com/document/d/1_L2aS2XCzrZQ1jME8BIAbMDgCdgdCKn_oDgYSQ7mGZg/edit#heading=h.pnomon5g0m0i), the line break between the inline comment and the resource declaration will be the PS character (`0xE280A9` in hex; see [Module\_PS.mvir](https://github.com/OpenZeppelin/move-compiler-vulnerability/blob/master/modules/Module_PS.mvir)).

```
$ ./compiler Module_PS.mvir --module --output ps-output
```

Similarly, the output in this case is:

```
$ xxd -ps ps-output  4c49425241564d0a010004012f000000020000000d310000000200000005 330000000200000004350000002000000000000300014d00000000000000 00000000000000000000000000000000000000000000000000
```

Note that the bytecode produced in both cases is identical to the bytecode produced in the case of a module *without* a resource declaration. This demonstrates that the compiler indeed misses the resource declaration in modules where comments are terminated with the CR and PS line break characters.

## **Code change**

In commit [5fb715e](https://github.com/libra/libra/commit/1acec930f3417d6ba75cf5b25f0fa2f0d5fb715e), the Libra team introduced changes to the lines of code affected by the vulnerability and modified the regex used to identify inline comments within the [`strip_comments_function`](https://github.com/libra/libra/blob/06958e69fdedc6cea6e96502b668b8c75ef10ec9/language/compiler/ir_to_bytecode/src/parser.rs#L22). The improved code results in a more concise way to match comments that end with a newline (`\n`) character, but is still vulnerable to the possibility of disguising inline comments as executable code. Let’s take a closer look to the code:

```
fn strip_comments(string: &str) -> String {   // Remove line comments   let line_comments = Regex::new(r"(?m)//.*$").unwrap();   line_comments.replace_all(string, "$1").into_owned() }
```

The regular expression which is used to match inline comments works fine when using `\n` as a line break character, but, as was the case with the original one, lacks the ability to **detect the end of inline comments marked by** `\r`**or other Unicode line break characters**.

In order to understand the exact behavior of the new erroneous regular expression, we explain each of its components individually:

1. As before, the `r` before the double quotes is a Rust feature to identify a [“raw string literal”](https://doc.rust-lang.org/rust-by-example/std/str.html#literals-and-escapes), used just as a convenient way to write the regex string as-is without having to escape special characters.
2. The `(?m)` flag symbolizes the multi-line mode, which means that the `^` and `$` no longer match just the beginning/end of the input, but the beginning/end of lines.
3. As before, `//` matches the start of the Move IR inline comment syntax.
4. As before, `.*` matches zero or more characters except for the line break character \n.
5. `$` is a special character that matches the newline (`\n`) character. Is it [explicitly explained in the documentation of the regex crate](https://docs.rs/regex/1.2.1/regex/#unicode) that this character does not match other Unicode line break characters, including the `\r` line break.

To summarize, this regular expression works exactly as the previous one in terms of not matching any other line break except from the `\n` character, resulting in the same attack vectors  and exploitation explained on the original report, based on the [same Move IR modules](https://github.com/OpenZeppelin/move-compiler-vulnerability) originally used to illustrate the vulnerability.

## **The fix**

In commit [7efb022](https://github.com/libra/libra/commit/7efb0221989f17fdf7f8486730898ed947a1e19e) the Libra team fixed the vulnerability by introducing a [`strip_comments_and_verify`](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L78) function, which in turn calls the [`verify_string`](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L46) function before actually stripping the comments. This function makes sure that all characters in the string are permitted characters through the [`is_permitted_printable_char`](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L22) and [`is_permitted_newline_char`](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L33) functions. These functions validate the characters by making sure they lie within a limited range of the whole character set. In particular, the [only newline character explicitly allowed](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L35) is `\n` (`0x0A`), and the `\r` and other more esoteric newline characters are [outside the range](https://github.com/libra/libra/blob/00da9f3c845b81b924d643eac3b678443f2ba0d4/language/compiler/ir_to_bytecode/src/parser.rs#L24) defined in the `is_permitted_printable_char` function.

We have validated this fix with all our new line character test cases. Apart from the `\n` case, which works as expected, all other test modules now give rise to a compile time parser error.

## **Conclusion**

We demonstrated that **Move modules could disguise inline comments as executable code**, due to a vulnerability in the language’s parser. Malicious actors entitled to publish Move modules in the Libra network could deceive users who would interact with modules behaving differently than expected. We conclude that **no Move IR module file with inline comments could be trusted** to behave as expected without a deeper analysis of the file’s real content or the actual bytecode produced after compilation as long as the vulnerability is not fixed.

Two scenarios were explored, the most critical one being how the source code of the Move IR parser can deceive developers and auditors into believing that a widely-used line break character is recognized as a valid inline comment ending, while it is actually not. To fix the vulnerability, we recommended that Move’s development team modified the regex in the [`strip_comments function`](https://github.com/libra/libra/blob/8ea33298678117748f1c75112f35a9fbc05b2172/language/compiler/ir_to_bytecode/src/parser.rs#L22) so as to correctly parse the `\r` character along with all other Unicode characters that represent a line break. To increase the software’s transparency, thorough and extensive unit testing considering Move modules with all different line breaks was also recommended.

After a code change unrelated to the issue, the vulnerability was fixed by the Libra team in commit [7efb022](https://github.com/libra/libra/commit/7efb0221989f17fdf7f8486730898ed947a1e19e).

## Related Posts

[![Forta Firewall Incremental Audit Featured Image](https://blog.openzeppelin.com/hubfs/Forta%20Firewall%20Incremental%20Audit.png)](https://blog.openzeppelin.com/forta-firewall-incremental-audit "Forta Firewall Incremental Audit")
## [Forta Firewall Incremental Audit](https://blog.openzeppelin.com/forta-firewall-incremental-audit "Forta Firewall Incremental Audit")

We performed an incremental audit on the forta-network/forta-firewall-contracts repository between...

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Origin OUSD Audit Featured Image](https://blog.openzeppelin.com/hubfs/Group%201000003816-1.png)](https://blog.openzeppelin.com/origin-ousd-audit "Origin OUSD Audit")
## [Origin OUSD Audit](https://blog.openzeppelin.com/origin-ousd-audit "Origin OUSD Audit")

We audited the OriginProtocol/origin-dollar repository at commit 4495130. Smart Contract Audit.

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Sonic Gateway Audit Featured Image](https://blog.openzeppelin.com/hubfs/Group%201000003816.png)](https://blog.openzeppelin.com/sonic-gateway-audit "Sonic Gateway Audit")
## [Sonic Gateway Audit](https://blog.openzeppelin.com/sonic-gateway-audit "Sonic Gateway Audit")

We audited the Fantom-foundation/Bridge repository at commit 558465d. Smart Contract Audit.

[Security Audits](https://blog.openzeppelin.com/tag/security-audits)
[Solidity](https://blog.openzeppelin.com/tag/solidity)

[![Openzeppelin](https://blog.openzeppelin.com/hubfs/iso-openzeppelin.svg)](https://www.openzeppelin.com/)

[![Openzeppelin](https://blog.openzeppelin.com/hubfs/iso-openzeppelin.svg)](https://www.openzeppelin.com/)

©  Zeppelin Group Ltd
[Service Level Agreement](https://www.openzeppelin.com/service-level-agreement)
[Terms of Service](https://www.openzeppelin.com/tos)
[Privacy Policy](https://www.openzeppelin.com/privacy)

Products

* [Contracts Library](https://openzeppelin.com/contracts)
* [Contracts Wizard](https://wizard.openzeppelin.com/)
* [Upgrade Plugins](https://docs.openzeppelin.com/upgrades-plugins/1.x/)
* [Defender Cloud Services](https://www.openzeppelin.com/defender)

Services

* [Smart Contract Security Audit](https://www.openzeppelin.com/security-audits)
* [Emergency Response](https://www.openzeppelin.com/emergency-response)
* [ZKP Practice](https://www.openzeppelin.com/zkp)
* [Ecosystem Stack](https://www.openzeppelin.com/ecosystems)

Resources

* [Documentation](https://docs.openzeppelin.com/)
* [Blog](https://blog.openzeppelin.com/)
* [Forum](https://forum.openzeppelin.com/)
* [Ethernaut CTF](https://ethernaut.openzeppelin.com/)

Company

* [About us](https://www.openzeppelin.com/about)
* [Careers](https://www.openzeppelin.com/careers)
* [Brand Kit](https://www.openzeppelin.com/brand-kit)
* [Trust](https://trust.openzeppelin.com/)


