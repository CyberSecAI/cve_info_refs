=== Content from amonitoring.ru_21617c8b_20250120_235302.html ===
![](/8c528003abe70b319a120129a04e9cfb.gif)

[![](/local/templates/amonitoring/img/logo.png)](/)

ПЕРСПЕКТИВНЫЙ
МОНИТОРИНГ

[Сообщить об инциденте](/incident/)

Найти

 +7 495 737-61-97

 info@amonitoring.ru

* [Компания](/about/)
* [Новости](/news/)
* [Услуги](/service/)
* [Продукты](/product/)
* [Статьи](/article/)
* [Карьера](/vacancy/)
* [Контакты](/contact/)

Сообщить об инциденте

Найти

 +7 495 737-61-97

 info@amonitoring.ru

#

[Статьи](/article/)
 > One more Steam Windows Client Local Privilege Escalation 0day
![](/upload/iblock/9ad/a62d2d9039df4829ee6e772fa2be28c2.svg)

20.08.2019
# One more Steam Windows Client Local Privilege Escalation 0day

## Previously on Privilege Escalation

Not long ago I [published an article](/article/steamclient-0day/) about Steam vulnerability. I received a lot of feedback. But Valve didn’t say a single word, HackerOne sent a huge letter and, mostly, kept silence. Eventually things escalated with Valve and I got banned by them on HackerOne — I can no longer participate in their vulnerability rejection program (the rest of H1 is still available though).

![steameoph1.png](/upload/medialibrary/502/steameoph1.png "steameoph1.png")

You can read the story in more detail in previous article, here is a couple of words about current situation.

And it’s sad and simple — Valve keeps failing. Last patch, that should have solved the problem, can be easily bypassed (<https://twitter.com/general_nfs/status/1162067274443833344>) so the vulnerability still exists. Yes, I’ve checked, it works like a charm.

But this article is not about an old vulnerability, it’s about new one. Since Valve decided to read a public report instead of private report one more time, I won’t take that pleasure away from them.

## Short vulnerability description

Vulnerability exploitation is quite simple and consists of three steps:

1)      Preparing the exploitation environment (you’ve got two ways via different weaknesses).

2)      Making Steam copy and run our DLL.

3)      DLL has to match some requirements.

Any of these actions could be performed by any OS user, more precisely — any program on computer. As a result any code code could be executed with maximum privileges, this vulnerability class is called «escalation of privileges» (eop) or «local privilege escalation» (lpe). Despite any application itself could be harmful, achieving maximum privileges can lead to much more disastrous consequences. For example, disabling firewall and antivirus, rootkit installation, concealing of process-miner, theft any PC user’s private data — is just a small portion of what could be done.

## Theoretical minimum

It was very funny to read comments to previous article, where community wrote “user can’t write to HKLM registry keys” or “you need administrator rights to create a symlink”. What’s interesting is that checking this statements takes almost as long as writing such comment. And yes, just in case, both statements are false. Because of this I decided to write a small section in this article, where I describe some difficult steps of exploitation.

1)      “User can’t write to HKLM registry section”.

There is no such general rule. There are specific security rules for specific registry keys. Valve gives full control to all users on HKLM\SOFTWARE\Wow6432Node\Valve\steam branch, so any user can do whatever he wants with it.

2)      “It’s not possible to start or stop service without administrator rights”.

There is no such general rule. There are specific security rules for specific services. Valve gave any user permissions to start and stop Steam Client Service.

3)      “You need administrator rights to create a symlink”.

This statement is funny itself, because there are five general types of links in Windows and only one and a half require such rights. Let me introduce you to: file symbolic link, object directory symbolic link, hard link, NTFS reparse point and reg\_link. Administrator rights are necessary only to create file symbolic link and for permanent object directory symbolic link (temporary object directory symbolic link lives as long as lives the session, where it was created, most commonly until reboot, and doesn’t require any special rights).

4)      “Folder to folder symlink”.

This is called NTFS reparse point or NTFS mount point. The name isn’t really important, the point is, this thing allows to use one directory as a link to another one. Could be created by user from an empty folder, if user has write permissions for it. Use CreateMountPoint.exe from symboliclink testing tools package (<https://github.com/googleprojectzero/symboliclink-testing-tools/>) to create it.

5)      Opportunistic Lock

Opportunistic Lock or OpLock (<https://docs.microsoft.com/ru-ru/windows/win32/fileio/opportunistic-locks>) is a special mechanism that allows to temporarily block access to a certain file. There are many details about OpLocks, that could be described here, like features of working with files and different types of access. In short, the program can “catch” an event of access to a certain file and temporarily hold it. OpLocks could be set with SetOpLock.exe utility from the same symboliclink testing tools package (<https://github.com/googleprojectzero/symboliclink-testing-tools/>). Launch of this utility sets the needed oplock; when access to oplocked file occurs, the utility prints a message; oplock is released by pressing “Enter”.

6)      BaitAndSwitch

It’s a name of a technique, that combines creation of links and oplocks to win TOCTOU (time of check\time of use). This method is simpler described with an example:

Imagine a program that does something like this:

*ReadContentFromFile(“C:\test\myfile.txt”);*

*ReadContentFromFile(“C:\test\myfile.txt”);*

It’s just a reading of the same file twice in a row. Is there always the same information read? No, not necessarily.

First, we create two folders with “C:\test1\myfile.txt” and “C:\test2\myfile.txt” files. Next, we empty “C:\test” and create a reparse point to “C:\test1” from it. Then we set oplock to the file from the first folder and run a program. As soon as it opens the file, oplock is being triggered. We change the reparse point, so “C:\test” links to “C:\test2”. Now, after oplock is released, program will read information for a second time from another file.

Where is it applicable? It’s easy to answer — there are quite typical situations, where firstly file is being checked (first read) and then executed (second read). That’s how you give one file for a check and the other for execution.

Now we’re all set for exploitation.

## Exploitation 1. Preparing the environment

It’s necessary to prepare the working environment. Firstly, we need to obtain CreateMountPoint.exe and SetOpLock.exe files.

Now it’s needed to make some small changes to Steam file structure. Our goal is to have folder with Steam.exe and steamclient.dll, and without “bin” folder. There are two ways to do this.

**Way 1**

Rename\remove bin folder from Steam root folder. That’s it, you’re gorgeous (Steam gives every user permissions for everything in it’s folder).

**Way 2**

Change InstallPath value to path to any of our folders in HKLM\SOFTWARE\Wow6432Node\Valve\steam registry key. Copy Steam.exe and steamclient.dll to that folder from original Steam folder.

So, we’ve prepared C:\Steam folder (there could be any path, but I will use this in examples) with any of the ways. Now we have to create b1, b2, b3 and b4 folders in it. Let’s copy steamservice.dll in the first three of them (originally located in bin folder of Steam package), and copy specially crafted library with the same name — steamservice.dll — in b4. More specifically on library preparing in Exploitation 3.

Open two console windows. Now environment preparation is complete.

## Exploitation 2. Switching the file

I think that it’s clear from preparations that it’s going to be something like BaitAndSwitch, described earlier.

ProcMon screenshot:

![steameopprocmon.png](/upload/medialibrary/0a2/steameopprocmon.png "steameopprocmon.png")

Above is a fragment of typical Steam Client Service start log. Take a look at the part, where firstly dll is being copied to C:\Program Files (x86)\Common Files\Steam and then is being loaded. We will make Steam copy our library from C:\Steam\b4 instead. Unfortunately, at first there are checks, among them the library signature is being checked to prevent dll hijacking (oh, irony).

So, I’ll describe exploitation step by step. Steps are combined in groups of similar actions. For each step there is noted what to execute, where to do it and what happens after it (the names of console windows are “cmd1” and “cmd2”).

1)      Create  C:\Steam\bin folder and execute the following command in cmd1:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b1

2)      Set oplock in cmd1:

SetOpLock.exe C:\Steam\b1\steamservice.dll

3)      Run Steam Client Service. In cmd1 you can see that the access to the file has been caught.

4)      Remove C:\Steam\bin, create C:\Steam\bin folder in it’s place and execute the following in cmd2:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b2

5)      Set oplock in cmd2:

SetOpLock.exe C:\Steam\b2\steamservice.dll

6)      Release oplock in cmd1. You can see that you’ve caught an access to file in cmd2.

7)      Remove C:\Steam\bin, create C:\Steam\bin folder in it’s place and execute the following in cmd1:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b3

8)      Set oplock in cmd1:

SetOpLock.exe C:\Steam\b3\steamservice.dll

9)      Release oplock in cmd2. In cmd1 you can see that you’ve caught access to file.

10)   Remove C:\Steam\bin, create C:\Steam\bin folder in it’s place and execute the following in cmd2:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b2

11)   Set oplock in cmd2:

SetOpLock.exe C:\Steam\b2\steamservice.dll

12)   Release oplock in cmd1. You can see that you’ve caught access to file in cmd2.

13)   Remove C:\Steam\bin, create C:\Steam\bin in it’s place and execute the following in cmd1:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b3

14)   Set oplock in cmd1:

SetOpLock.exe C:\Steam\b3\steamservice.dll

15)   Release oplock in cmd2. In cmd1 you can see that you’ve caught access to file .

16)   Remove C:\Steam\bin, create C:\Steam\bin folder in it’s place and execute the following in cmd2:

CreateMountPoint.exe С:\Steam\bin C:\Steam\b4

17)   Release oplock in cmd1.

It might look complicated, but the idea is quite simple: redirect first 5 (out of 6) accesses to C:\Steam\bin\steamservice.dll to the original file from different folders was given (in the access order: b1, b2, b3, b2, b3), and at the 6th access redirect to our payload.

Here is schematic description:

![steameopscheme.png](/upload/medialibrary/0cf/steameopscheme.png "steameopscheme.png")

On the left is a normal behavior of application, on the right is behavior during exploitation.

## Exploitation 3. Injectable library

First I tried to use my most common dll, which creates interactive console in DllEntry, as a payload. Since the dll code is being executed within Steam Client Service, it will be executed with the service’s permissions — NT AUTHORITY\SYSTEM. But in the end of exploitation the console didn’t show up.

After loading, Steam service figures out that it’s being tricked and shuts down before payload in my dll is being executed.

I had to reverse a little bit and it turned out that the service checks the existence of

*int WINAPI SteamService\_RunMainLoop()*

*void WINAPI SteamService\_Stop()*

functions in library after dll loads. Moreover, service calls the first function, where I decided to place my payload (running of interactive console with service permissions — NT AUTHORITY\SYSTEM). That’s all, I repeat all actions and gain the console with maximum permissions.

## Conclusion

All of it could be wrapped in exe-file, but I don’t really want to bother. I think the demo videos would be enough (registry way (<https://www.youtube.com/watch?v=ZCHrjP0cMew>), filesystem way (<https://www.youtube.com/watch?v=I93aH86BUaE>)).

I will not copy «Speculations» section from the previous article here. The facts are: the old vulnerability is relevant; you have just read about new one, and Valve still don’t want to hear about any problems.

## Update (Aug 22, 2019)

Two hot news:

1) Beta Client got update with fix (<https://steamcommunity.com/groups/SteamClientBeta#announcements/detail/1599262071399843693)>. I'll check it when main client get this update.

2) Valve change their policy of LPE on h1 (<https://hackerone.com/valve/policy_versions>). Great news!

## Update (Aug 27, 2019)

Good news.

Main client got update with fixes ([https://store.steampowered.com/news/53677/)](https://store.steampowered.com/news/53677/%29).

I was unbanned on H1 and got reward.

## About author

Vasily Kravets, Lead Expert

mailto:xi-tauw@xi-tauw.info

mailto:Vasily.Kravets@amonitoring.ru

<https://twitter.com/PsiDragon>

<https://t.me/xitauw>

 Теги:
[steam](/article/?tag=steam)
[0day](/article/?tag=0day)
[public](/article/?tag=public)
[disclosure](/article/?tag=disclosure)
[уязвимость](/article/?tag=уязвимость)
[уязвимость нулевого дня](/article/?tag=уязвимость нулевого дня)
[повышение привилегий](/article/?tag=повышение привилегий)
[eop](/article/?tag=eop)
[lpe](/article/?tag=lpe)

Поделиться статьей в:

Рекомендуемые статьи
![](/upload/iblock/9ad/a62d2d9039df4829ee6e772fa2be28c2.svg)

20.08.2019
One more Steam Windows Client Local Privilege Escalation 0day
[Читать](/article/onemore_steam_eop_0day/)

![](/upload/iblock/828/a62d2d9039df4829ee6e772fa2be28c2.svg)

07.08.2019 09:44:00
Steam Windows Client Local Privilege Escalation 0day
[Читать](/article/steamclient-0day/)

![](/upload/iblock/960/a62d2d9039df4829ee6e772fa2be28c2.svg)

29.05.2019
Анализ поверхности атаки для банков и организаций кредитно-финансовой сферы
[Читать](/article/attack-surface/)

[О нас](/about/)

* [Компания](/about/)
* [Вакансии](/vacancy/)
* [Контакты](/contact/)
* [Скачать результаты СОУТ](/about/%D0%A0%D0%B5%D0%B7%D1%83%D0%BB%D1%8C%D1%82%D0%B0%D1%82%D1%8B%20%D0%A1%D0%9E%D0%A3%D0%A2_%20%D0%90%D0%9E_%D0%9F%D0%9C_2022%D0%B3..pdf)

Услуги

* [Центр мониторинга компьютерных атак](/service/security-operation-center/)
* [Разработка правил Snort IDS](/service/snort/)
* [Расследование компьютерных инцидентов](/service/forensics/)
* [Соответствие требованиям по ИБ](/service/compliance/)
* [Анализ защищённости](/service/security-analysis/)
* [Пентесты](/service/pentest/)
* [Управление инцидентами ИБ](/service/incident-management/)
* [ГосСОПКА](/service/gossopka/)

Написать нам

Имя

Email

Письмо

Введите код с картинки   ![CAPTCHA](/bitrix/tools/captcha.php?captcha_sid=06d933daa80f2b2b9eca6bd181eae6b1)

Отправляя данную форму вы соглашаетесь с [политикой конфиденциальности](/privacy-policy/)

 2025

\*Мы не спамим и не подписываем на рассылку

Быстро ответим только с 9 до 18 по Москве.

В противном случае — на следующий день.

Введите код с картинки

![CAPTCHA](/bitrix/tools/captcha.php?captcha_sid=0264a9ad55bdee299fcf6597c1a01616)

Отправляя данную форму вы соглашаетесь

Сообщение отправлено.

Спасибо, мы с вами обязательно свяжемся.

OK

![](https://mc.yandex.ru/watch/15525343)



=== Content from habr.com_6de02b11_20250120_235303.html ===

[Хабр](/ru/)βОткрыть список[Как стать автором](/ru/sandbox/start/)[Моя лента](/ru/feed/)[Все потоки](/ru/articles/)[Разработка](/ru/flows/develop/)[Администрирование](/ru/flows/admin/)[Дизайн](/ru/flows/design/)[Менеджмент](/ru/flows/management/)[Маркетинг](/ru/flows/marketing/)[Научпоп](/ru/flows/popsci/)[Поиск](/ru/search/)Написать публикациюНастройки[Войти](https://habr.com/kek/v1/auth/habrahabr/?back=/ru/companies/pm/articles/464367/&hl=ru)Обновить[![](//habrastorage.org/getpro/habr/company/08d/44e/4b5/08d44e4b5fe243f4b59b05b2139569fb.png)](/ru/companies/pm/profile/)59.79Рейтинг[Перспективный мониторинг](/ru/companies/pm/profile/)Подписаться[![](https://assets.habr.com/habr-web/img/avatars/120.png)](/ru/users/xi-tauw/ "xi-tauw")[xi-tauw](/ru/users/xi-tauw/) 20 авг 2019 в 17:10
# И ещё один Steam Windows Client Local Privilege Escalation 0day

Время на прочтение7 минКоличество просмотров21K[Блог компании Перспективный мониторинг](/ru/companies/pm/articles/)[Информационная безопасность\*](/ru/hubs/infosecurity/)
## В предыдущей серии

Не так давно [я опубликовал](https://habr.com/ru/company/pm/blog/462479/) описание уязвимости для Steam. Я получил много отзывов от читателей. Valve не проронили ни слова, а HackerOne прислал огромное слезливое письмо и, в основном, молчал. В итоге меня забанили Valve на H1 — я не могу участвовать в их программе по отклонению уязвимостей (остальной H1 мне доступен).

![](https://habrastorage.org/r/w1560/webt/9q/zi/ll/9qzillbsgxcwcro6sevsct00vjg.png)Теги:

* [steam](/ru/search/?target_type=posts&order=relevance&q=[steam])
* [0day](/ru/search/?target_type=posts&order=relevance&q=[0day])
* [public](/ru/search/?target_type=posts&order=relevance&q=[public])
* [disclosure](/ru/search/?target_type=posts&order=relevance&q=[disclosure])
* [уязвимость](/ru/search/?target_type=posts&order=relevance&q=[%D1%83%D1%8F%D0%B7%D0%B2%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C])
* [уязвимость нулевого дня](/ru/search/?target_type=posts&order=relevance&q=[%D1%83%D1%8F%D0%B7%D0%B2%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D1%8C+%D0%BD%D1%83%D0%BB%D0%B5%D0%B2%D0%BE%D0%B3%D0%BE+%D0%B4%D0%BD%D1%8F])
* [повышение привилегий](/ru/search/?target_type=posts&order=relevance&q=[%D0%BF%D0%BE%D0%B2%D1%8B%D1%88%D0%B5%D0%BD%D0%B8%D0%B5+%D0%BF%D1%80%D0%B8%D0%B2%D0%B8%D0%BB%D0%B5%D0%B3%D0%B8%D0%B9])
* [eop](/ru/search/?target_type=posts&order=relevance&q=[eop])
* [lpe](/ru/search/?target_type=posts&order=relevance&q=[lpe])
Хабы:

* [Блог компании Перспективный мониторинг](/ru/companies/pm/articles/)
* [Информационная безопасность](/ru/hubs/infosecurity/)
Всего голосов 86: ↑84 и ↓2+82Добавить в закладки50[Комментарии92](/ru/companies/pm/articles/464367/comments/)[![](//habrastorage.org/getpro/habr/company/08d/44e/4b5/08d44e4b5fe243f4b59b05b2139569fb.png)](/ru/companies/pm/profile/)[Перспективный мониторинг](/ru/companies/pm/profile/)Компания[Сайт](https://amonitoring.ru)[Сайт](https://ampire.team)[Telegram](https://telegram.me/pm_public)[Сайт](https://www.youtube.com/%40AMonitoring)[![](https://assets.habr.com/habr-web/img/avatars/120.png)](/ru/users/xi-tauw/)105Карма0.1РейтингКравец Василий [@xi-tauw](/ru/users/xi-tauw/)

Windows Privilege Escalator

ПодписатьсяОтправить сообщение[ВКонтакте](https://vk.com/xitauw)[Telegram](https://telegram.me/xitauw)[Комментарии Комментарии 92](/ru/companies/pm/articles/464367/comments/)
## Публикации

Лучшие за суткиПохожие

## Информация

Сайт[amonitoring.ru](https://amonitoring.ru)Дата регистрации5 апреля 2017Дата основания11 декабря 2011Численность101–200 человекМестоположениеРоссия
## Истории

Ваш аккаунт

* [Войти](/kek/v1/auth/habrahabr/?back=/ru/companies/pm/articles/464367/&hl=ru)
* [Регистрация](/kek/v1/auth/habrahabr-register/?back=/ru/companies/pm/articles/464367/&hl=ru)

Разделы

* [Статьи](/ru/articles/)
* [Новости](/ru/news/)
* [Хабы](/ru/hubs/)
* [Компании](/ru/companies/)
* [Авторы](/ru/users/)
* [Песочница](/ru/sandbox/)

Информация

* [Устройство сайта](/ru/docs/help/)
* [Для авторов](/ru/docs/authors/codex/)
* [Для компаний](/ru/docs/companies/corpblogs/)
* [Документы](/ru/docs/docs/transparency/)
* [Соглашение](https://account.habr.com/info/agreement/?hl=ru_RU)
* [Конфиденциальность](https://account.habr.com/info/confidential/?hl=ru_RU)

Услуги

* [Корпоративный блог](https://company.habr.com/ru/corporate-blogs/)
* [Медийная реклама](https://company.habr.com/ru/advertising/)
* [Нативные проекты](https://company.habr.com/ru/native-special/)
* [Образовательные программы](https://company.habr.com/ru/education-programs/)
* [Стартапам](https://company.habr.com/ru/hello-startup/)
[Facebook](https://www.facebook.com/habrahabr.ru)[Twitter](https://twitter.com/habr_com)[VK](https://vk.com/habr)[Telegram](https://telegram.me/habr_com)[Youtube](https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w)[Яндекс Дзен](https://dzen.ru/habr) Настройка языка[Техническая поддержка](/ru/feedback/)© 2006–2025, [Habr](https://company.habr.com/)

![](https://mc.yandex.ru/watch/24049213)


