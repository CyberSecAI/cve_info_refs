=== Content from github.com_2fd60bc3_20250120_231812.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fissues%2F8520)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fissues%2F8520)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.9k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  148](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

# CVE-2019-15226 #8520

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[CVE-2019-15226](#top)#8520Copy linkAssignees [![asraa](https://avatars.githubusercontent.com/u/5194569?s=64&u=f7434e64e439c0a6534a4e77cebb842499736cc3&v=4)](/asraa)Labels[area/security](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22area%2Fsecurity%22)[bug](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22bug%22)[cveSecurity CVE issues](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22cve%22)Security CVE issues![@asraa](https://avatars.githubusercontent.com/u/5194569?u=f7434e64e439c0a6534a4e77cebb842499736cc3&v=4&size=80)
## Description

![@asraa](https://avatars.githubusercontent.com/u/5194569?u=f7434e64e439c0a6534a4e77cebb842499736cc3&v=4&size=48)[asraa](https://github.com/asraa)opened [on Oct 7, 2019](https://github.com/envoyproxy/envoy/issues/8520#issue-503653255)

See [GHSA-mxrr-6x92-4x7v](https://github.com/envoyproxy/envoy/security/advisories/GHSA-mxrr-6x92-4x7v "GHSA-mxrr-6x92-4x7v")

## Metadata

### Assignees

* [![@asraa](https://avatars.githubusercontent.com/u/5194569?s=64&u=f7434e64e439c0a6534a4e77cebb842499736cc3&v=4)asraa](/asraa)
### Labels

[area/security](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22area%2Fsecurity%22)[bug](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22bug%22)[cveSecurity CVE issues](https://github.com/envoyproxy/envoy/issues?q=state%3Aopen%20label%3A%22cve%22)Security CVE issues
### Type

No type
### Projects

No projects
### Milestone

No milestone

### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_68e690b9_20250120_231810.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fafc39bea36fd436e54262f150c009e8d72db5014)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fafc39bea36fd436e54262f150c009e8d72db5014)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.9k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  148](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

## Commit

[Permalink](/envoyproxy/envoy/commit/afc39bea36fd436e54262f150c009e8d72db5014)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Track byteSize of HeaderMap internally.

[Browse files](/envoyproxy/envoy/tree/afc39bea36fd436e54262f150c009e8d72db5014)
Browse the repository at this point in the history

```
Introduces a cached byte size updated internally in HeaderMap. The value
is stored as an optional, and is cleared whenever a non-const pointer or
reference to a HeaderEntry is accessed. The cached value can be set with
refreshByteSize() which performs an iteration over the HeaderMap to sum
the size of each key and value in the HeaderMap.

Signed-off-by: Asra Ali <asraa@google.com>
```

* Loading branch information

[![@asraa](https://avatars.githubusercontent.com/u/5194569?s=40&v=4)](/asraa) [![@htuch](https://avatars.githubusercontent.com/u/10914751?s=40&v=4)](/htuch)

[asraa](/envoyproxy/envoy/commits?author=asraa "View all commits by asraa")
authored and
[htuch](/envoyproxy/envoy/commits?author=htuch "View all commits by htuch")
committed
Oct 8, 2019

1 parent
[9c682f8](/envoyproxy/envoy/commit/9c682f815ec70da374c4c5d2e24fd7a46f868bfb)

commit afc39be

 Show file tree

 Hide file tree

Showing
**21 changed files**
with
**397 additions**
and
**89 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/root/intro

  + docs/root/intro/version\_history.rst
    [version\_history.rst](#diff-02cdc1a64b58714360c0cbdf245da06616364b110af4acd72ca364a524021eed)
* include/envoy

  + access\_log

    - include/envoy/access\_log/access\_log.h
      [access\_log.h](#diff-1d5d7b865b54e620aa29c07369c76b42f18b123ab2ff61c7fbe7a582c45188e1)
  + http

    - include/envoy/http/header\_map.h
      [header\_map.h](#diff-80f1111d614f7f9d5268706e59520ff358484af5537fbf4359f892b9afc809c2)
* source

  + common

    - http

      * source/common/http/conn\_manager\_impl.cc
        [conn\_manager\_impl.cc](#diff-7cfd594a6eff3119b0382311e215145da49b9c2e5e776e83453c44dfcf2b6be3)
      * source/common/http/header\_map\_impl.cc
        [header\_map\_impl.cc](#diff-2920212df144c38f64da08a4094a67b3c897669460307a6ed0147461fa2d4907)
      * source/common/http/header\_map\_impl.h
        [header\_map\_impl.h](#diff-8524e9355805efd7fc6718472d204c063acef398a3d71dc58554239d23a454b5)
      * http1

        + source/common/http/http1/codec\_impl.cc
          [codec\_impl.cc](#diff-8d3b9d0a839b05612561930ee8c58bf1b0ff0adc55cf27d79a7e3bbfbd81965e)
      * http2

        + source/common/http/http2/codec\_impl.cc
          [codec\_impl.cc](#diff-a23f05b05850c7080b5183f630e0d71c26320a0f7a5ab9e1d2c1bedde0e912e9)
    - router

      * source/common/router/router.cc
        [router.cc](#diff-e3584a650478334f7373c0df344c85d499b5123f5237ce2bbabaad5ee53b899e)
  + extensions

    - access\_loggers

      * common

        + source/extensions/access\_loggers/common/access\_log\_base.h
          [access\_log\_base.h](#diff-f78dc52c33e038d33d594df2b6ec13baa7ec7bca3b47be91cd8e4f65267666c9)
      * grpc

        + source/extensions/access\_loggers/grpc/http\_grpc\_access\_log\_impl.cc
          [http\_grpc\_access\_log\_impl.cc](#diff-84bf122eb53191a1acffea82bc1a0769b01efd11a45dfe9e05a8da82ef5840c2)
    - filters

      * common/expr

        + source/extensions/filters/common/expr/context.cc
          [context.cc](#diff-c31221cbb0d3df5220008626ebe4060bac52cc79ea978c1e318dbdce09e55584)
      * http/rbac

        + source/extensions/filters/http/rbac/rbac\_filter.cc
          [rbac\_filter.cc](#diff-c002a365d0710e04a9ade13e3eef7a4c94ce925090045a7fbbdb17fc178af6da)
* test

  + common/http

    - test/common/http/conn\_manager\_impl\_test.cc
      [conn\_manager\_impl\_test.cc](#diff-bd131ee9f4338cb9dbc5104d99a6e62e9e41007a3759b95346753f7bd6a287e3)
    - test/common/http/header\_map\_impl\_speed\_test.cc
      [header\_map\_impl\_speed\_test.cc](#diff-71dc297e612e27f9dd8c026797309931b7fbfef96965fc2ff5839a564af2ea19)
    - test/common/http/header\_map\_impl\_test.cc
      [header\_map\_impl\_test.cc](#diff-3c215ec38a696921f104a1297ef639d01c76663b1c022e7772c57bc4c2fee5af)
    - http2

      * test/common/http/http2/codec\_impl\_test.cc
        [codec\_impl\_test.cc](#diff-6844886ff4ec8c34616c95c65a5150664dd32ffc8547f7fdf5d07e12a17fa9c4)
  + integration

    - test/integration/http2\_integration\_test.cc
      [http2\_integration\_test.cc](#diff-7248bbf419b4bed59248e0f46ae959896d172b2ded957f4da8607e8d16b924e0)
    - test/integration/http\_integration.cc
      [http\_integration.cc](#diff-8e768fa8b2a194d09414fa6572b201d58caf7e973c5535b0fc35c2304ca9198c)
    - test/integration/http\_integration.h
      [http\_integration.h](#diff-421bb92af4551eb1d05607c403d6670e60dfbb727cd66346362124470e4f2c25)
    - test/integration/protocol\_integration\_test.cc
      [protocol\_integration\_test.cc](#diff-478cdae3dba52e78ed6d1a2e4e4eb4a1aba3e80178b6c8d14707501fc1fb2ddb)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[docs/root/intro/version\_history.rst](#diff-02cdc1a64b58714360c0cbdf245da06616364b110af4acd72ca364a524021eed "docs/root/intro/version_history.rst")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/docs/root/intro/version_history.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -85,6 +85,10 @@ Version history |
|  |  | \* upstream: added :ref:`fail\_traffic\_on\_panic <envoy\_api\_field\_Cluster.CommonLbConfig.ZoneAwareLbConfig.fail\_traffic\_on\_panic>` to allow failing all requests to a cluster during panic state. |
|  |  | \* zookeeper: parse responses and emit latency stats. |
|  |  |  |
|  |  | 1.11.2 (October 8, 2019) |
|  |  | ======================== |
|  |  | \* http: fixed CVE-2019-15226 by adding a cached byte size in HeaderMap. |
|  |  |  |
|  |  | 1.11.1 (August 13, 2019) |
|  |  | ======================== |
|  |  | \* http: added mitigation of client initiated attacks that result in flooding of the downstream HTTP/2 connections. Those attacks can be logged at the "warning" level when the runtime feature `http.connection\_manager.log\_flood\_exception` is enabled. The runtime setting defaults to disabled to avoid log spam when under attack. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[include/envoy/access\_log/access\_log.h](#diff-1d5d7b865b54e620aa29c07369c76b42f18b123ab2ff61c7fbe7a582c45188e1 "include/envoy/access_log/access_log.h")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/include/envoy/access_log/access_log.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -78,6 +78,10 @@ class Instance { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Log a completed request. |
|  |  | \* Prior to logging, call refreshByteSize() on HeaderMaps to ensure that an accurate byte size |
|  |  | \* count is logged. |
|  |  | \* TODO(asraa): Remove refreshByteSize() requirement when entries in HeaderMap can no longer be |
|  |  | \* modified by reference and headerMap holds an accurate internal byte size count. |
|  |  | \* @param request\_headers supplies the incoming request headers after filtering. |
|  |  | \* @param response\_headers supplies response headers. |
|  |  | \* @param response\_trailers supplies response trailers. |
| Expand Down | |  |

34 changes: 33 additions & 1 deletion

34
[include/envoy/http/header\_map.h](#diff-80f1111d614f7f9d5268706e59520ff358484af5537fbf4359f892b9afc809c2 "include/envoy/http/header_map.h")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/include/envoy/http/header_map.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -457,9 +457,41 @@ class HeaderMap { |
|  |  | virtual void setReferenceKey(const LowerCaseString& key, const std::string& value) PURE; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* HeaderMap contains an internal byte size count, updated as entries are added, removed, or |
|  |  | \* modified through the HeaderMap interface. However, HeaderEntries can be accessed and modified |
|  |  | \* by reference so that the HeaderMap can no longer accurately update the internal byte size |
|  |  | \* count. |
|  |  | \* |
|  |  | \* Calling byteSize before a HeaderEntry is accessed will return the internal byte size count. The |
|  |  | \* value is cleared when a HeaderEntry is accessed, and the value is updated and set again when |
|  |  | \* refreshByteSize is called. |
|  |  | \* |
|  |  | \* To guarantee an accurate byte size count, call refreshByteSize. |
|  |  | \* |
|  |  | \* @return uint64\_t the approximate size of the header map in bytes if valid. |
|  |  | \*/ |
|  |  | virtual absl::optional<uint64\_t> byteSize() const PURE; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This returns the sum of the byte sizes of the keys and values in the HeaderMap. This also |
|  |  | \* updates and sets the byte size count. |
|  |  | \* |
|  |  | \* To guarantee an accurate byte size count, use this. If it is known HeaderEntries have not been |
|  |  | \* manipulated since a call to refreshByteSize, it is safe to use byteSize. |
|  |  | \* |
|  |  | \* @return uint64\_t the approximate size of the header map in bytes. |
|  |  | \*/ |
|  |  | virtual uint64\_t refreshByteSize() PURE; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* This returns the sum of the byte sizes of the keys and values in the HeaderMap. |
|  |  | \* |
|  |  | \* This iterates over the HeaderMap to calculate size and should only be called directly when the |
|  |  | \* user wants an explicit recalculation of the byte size. |
|  |  | \* |
|  |  | \* @return uint64\_t the approximate size of the header map in bytes. |
|  |  | \*/ |
|  |  | virtual uint64\_t byteSize() const PURE; |
|  |  | virtual uint64\_t byteSizeInternal() const PURE; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get a header by key. |
| Expand Down | |  |

20 changes: 12 additions & 8 deletions

20
[source/common/http/conn\_manager\_impl.cc](#diff-7cfd594a6eff3119b0382311e215145da49b9c2e5e776e83453c44dfcf2b6be3 "source/common/http/conn_manager_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/source/common/http/conn_manager_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -506,6 +506,18 @@ ConnectionManagerImpl::ActiveStream::~ActiveStream() { |
|  |  | } |
|  |  |  |
|  |  | connection\_manager\_.stats\_.named\_.downstream\_rq\_active\_.dec(); |
|  |  | // Refresh byte sizes of the HeaderMaps before logging. |
|  |  | // TODO(asraa): Remove this when entries in HeaderMap can no longer be modified by reference and |
|  |  | // HeaderMap holds an accurate internal byte size count. |
|  |  | if (request\_headers\_ != nullptr) { |
|  |  | request\_headers\_->refreshByteSize(); |
|  |  | } |
|  |  | if (response\_headers\_ != nullptr) { |
|  |  | response\_headers\_->refreshByteSize(); |
|  |  | } |
|  |  | if (response\_trailers\_ != nullptr) { |
|  |  | response\_trailers\_->refreshByteSize(); |
|  |  | } |
|  |  | for (const AccessLog::InstanceSharedPtr& access\_log : connection\_manager\_.config\_.accessLogs()) { |
|  |  | access\_log->log(request\_headers\_.get(), response\_headers\_.get(), response\_trailers\_.get(), |
|  |  | stream\_info\_); |
| Expand Down  Expand Up | | @@ -719,14 +731,6 @@ void ConnectionManagerImpl::ActiveStream::decodeHeaders(HeaderMapPtr&& headers, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | ASSERT(connection\_manager\_.config\_.maxRequestHeadersKb() > 0); |
|  |  | if (request\_headers\_->byteSize() > (connection\_manager\_.config\_.maxRequestHeadersKb() \* 1024)) { |
|  |  | sendLocalReply(Grpc::Common::hasGrpcContentType(\*request\_headers\_), |
|  |  | Code::RequestHeaderFieldsTooLarge, "", nullptr, is\_head\_request\_, absl::nullopt, |
|  |  | StreamInfo::ResponseCodeDetails::get().RequestHeadersTooLarge); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | // Currently we only support relative paths at the application layer. We expect the codec to have |
|  |  | // broken the path into pieces if applicable. NOTE: Currently the HTTP/1.1 codec only does this |
|  |  | // when the allow\_absolute\_url flag is enabled on the HCM. |
| Expand Down | |  |

63 changes: 54 additions & 9 deletions

63
[source/common/http/header\_map\_impl.cc](#diff-2920212df144c38f64da08a4094a67b3c897669460307a6ed0147461fa2d4907 "source/common/http/header_map_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/source/common/http/header_map_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -295,14 +295,17 @@ struct HeaderMapImpl::StaticLookupTable : public TrieLookupTable<EntryCb> { |
|  |  | } |
|  |  | }; |
|  |  |  |
|  |  | void HeaderMapImpl::appendToHeader(HeaderString& header, absl::string\_view data) { |
|  |  | uint64\_t HeaderMapImpl::appendToHeader(HeaderString& header, absl::string\_view data) { |
|  |  | if (data.empty()) { |
|  |  | return; |
|  |  | return 0; |
|  |  | } |
|  |  | uint64\_t byte\_size = 0; |
|  |  | if (!header.empty()) { |
|  |  | header.append(",", 1); |
|  |  | byte\_size += 1; |
|  |  | } |
|  |  | header.append(data.data(), data.size()); |
|  |  | return data.size() + byte\_size; |
|  |  | } |
|  |  |  |
|  |  | HeaderMapImpl::HeaderMapImpl() { memset(&inline\_headers\_, 0, sizeof(inline\_headers\_)); } |
| Expand All | | @@ -319,6 +322,20 @@ HeaderMapImpl::HeaderMapImpl( |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void HeaderMapImpl::addSize(uint64\_t size) { |
|  |  | // Adds size to cached\_byte\_size\_ if it exists. |
|  |  | if (cached\_byte\_size\_.has\_value()) { |
|  |  | cached\_byte\_size\_.value() += size; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void HeaderMapImpl::subtractSize(uint64\_t size) { |
|  |  | if (cached\_byte\_size\_.has\_value()) { |
|  |  | ASSERT(cached\_byte\_size\_ >= size); |
|  |  | cached\_byte\_size\_.value() -= size; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void HeaderMapImpl::copyFrom(const HeaderMap& header\_map) { |
|  |  | header\_map.iterate( |
|  |  | [](const HeaderEntry& header, void\* context) -> HeaderMap::Iterate { |
| Expand Down  Expand Up | | @@ -359,10 +376,13 @@ void HeaderMapImpl::insertByKey(HeaderString&& key, HeaderString&& value) { |
|  |  | if (\*ref\_lookup\_response.entry\_ == nullptr) { |
|  |  | maybeCreateInline(ref\_lookup\_response.entry\_, \*ref\_lookup\_response.key\_, std::move(value)); |
|  |  | } else { |
|  |  | appendToHeader((\*ref\_lookup\_response.entry\_)->value(), value.getStringView()); |
|  |  | const uint64\_t added\_size = |
|  |  | appendToHeader((\*ref\_lookup\_response.entry\_)->value(), value.getStringView()); |
|  |  | addSize(added\_size); |
|  |  | value.clear(); |
|  |  | } |
|  |  | } else { |
|  |  | addSize(key.size() + value.size()); |
|  |  | std::list<HeaderEntryImpl>::iterator i = headers\_.insert(std::move(key), std::move(value)); |
|  |  | i->entry\_ = i; |
|  |  | } |
| Expand All | | @@ -373,7 +393,8 @@ void HeaderMapImpl::addViaMove(HeaderString&& key, HeaderString&& value) { |
|  |  | // the existing value. |
|  |  | auto\* entry = getExistingInline(key.getStringView()); |
|  |  | if (entry != nullptr) { |
|  |  | appendToHeader(entry->value(), value.getStringView()); |
|  |  | const uint64\_t added\_size = appendToHeader(entry->value(), value.getStringView()); |
|  |  | addSize(added\_size); |
|  |  | key.clear(); |
|  |  | value.clear(); |
|  |  | } else { |
| Expand Down  Expand Up | | @@ -408,7 +429,8 @@ void HeaderMapImpl::addCopy(const LowerCaseString& key, uint64\_t value) { |
|  |  | if (entry != nullptr) { |
|  |  | char buf[32]; |
|  |  | StringUtil::itoa(buf, sizeof(buf), value); |
|  |  | appendToHeader(entry->value(), buf); |
|  |  | const uint64\_t added\_size = appendToHeader(entry->value(), buf); |
|  |  | addSize(added\_size); |
|  |  | return; |
|  |  | } |
|  |  | HeaderString new\_key; |
| Expand All | | @@ -423,7 +445,8 @@ void HeaderMapImpl::addCopy(const LowerCaseString& key, uint64\_t value) { |
|  |  | void HeaderMapImpl::addCopy(const LowerCaseString& key, const std::string& value) { |
|  |  | auto\* entry = getExistingInline(key.get()); |
|  |  | if (entry != nullptr) { |
|  |  | appendToHeader(entry->value(), value); |
|  |  | const uint64\_t added\_size = appendToHeader(entry->value(), value); |
|  |  | addSize(added\_size); |
|  |  | return; |
|  |  | } |
|  |  | HeaderString new\_key; |
| Expand Down  Expand Up | | @@ -451,13 +474,24 @@ void HeaderMapImpl::setReferenceKey(const LowerCaseString& key, const std::strin |
|  |  | ASSERT(new\_value.empty()); // NOLINT(bugprone-use-after-move) |
|  |  | } |
|  |  |  |
|  |  | uint64\_t HeaderMapImpl::byteSize() const { |
|  |  | absl::optional<uint64\_t> HeaderMapImpl::byteSize() const { return cached\_byte\_size\_; } |
|  |  |  |
|  |  | uint64\_t HeaderMapImpl::refreshByteSize() { |
|  |  | if (!cached\_byte\_size\_.has\_value()) { |
|  |  | // In this case, the cached byte size is not valid, and the byte size is computed via an |
|  |  | // iteration over the HeaderMap. The cached byte size is updated. |
|  |  | cached\_byte\_size\_ = byteSizeInternal(); |
|  |  | } |
|  |  | return cached\_byte\_size\_.value(); |
|  |  | } |
|  |  |  |
|  |  | uint64\_t HeaderMapImpl::byteSizeInternal() const { |
|  |  | // Computes the total byte size by summing the byte size of the keys and values. |
|  |  | uint64\_t byte\_size = 0; |
|  |  | for (const HeaderEntryImpl& header : headers\_) { |
|  |  | byte\_size += header.key().size(); |
|  |  | byte\_size += header.value().size(); |
|  |  | } |
|  |  |  |
|  |  | return byte\_size; |
|  |  | } |
|  |  |  |
| Expand All | | @@ -474,6 +508,7 @@ const HeaderEntry\* HeaderMapImpl::get(const LowerCaseString& key) const { |
|  |  | HeaderEntry\* HeaderMapImpl::get(const LowerCaseString& key) { |
|  |  | for (HeaderEntryImpl& header : headers\_) { |
|  |  | if (header.key() == key.get().c\_str()) { |
|  |  | cached\_byte\_size\_.reset(); |
|  |  | return &header; |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -528,6 +563,7 @@ void HeaderMapImpl::remove(const LowerCaseString& key) { |
|  |  | } else { |
|  |  | for (auto i = headers\_.begin(); i != headers\_.end();) { |
|  |  | if (i->key() == key.get().c\_str()) { |
|  |  | subtractSize(i->key().size() + i->value().size()); |
|  |  | i = headers\_.erase(i); |
|  |  | } else { |
|  |  | ++i; |
| Expand All | | @@ -537,7 +573,7 @@ void HeaderMapImpl::remove(const LowerCaseString& key) { |
|  |  | } |
|  |  |  |
|  |  | void HeaderMapImpl::removePrefix(const LowerCaseString& prefix) { |
|  |  | headers\_.remove\_if([&](const HeaderEntryImpl& entry) { |
|  |  | headers\_.remove\_if([&prefix, this](const HeaderEntryImpl& entry) { |
|  |  | bool to\_remove = absl::StartsWith(entry.key().getStringView(), prefix.get()); |
|  |  | if (to\_remove) { |
|  |  | // If this header should be removed, make sure any references in the |
| Expand All | | @@ -546,8 +582,13 @@ void HeaderMapImpl::removePrefix(const LowerCaseString& prefix) { |
|  |  | if (cb) { |
|  |  | StaticLookupResponse ref\_lookup\_response = cb(\*this); |
|  |  | if (ref\_lookup\_response.entry\_) { |
|  |  | const uint32\_t key\_value\_size = (\*ref\_lookup\_response.entry\_)->key().size() + |
|  |  | (\*ref\_lookup\_response.entry\_)->value().size(); |
|  |  | subtractSize(key\_value\_size); |
|  |  | \*ref\_lookup\_response.entry\_ = nullptr; |
|  |  | } |
|  |  | } else { |
|  |  | subtractSize(entry.key().size() + entry.value().size()); |
|  |  | } |
|  |  | } |
|  |  | return to\_remove; |
| Expand All | | @@ -570,6 +611,7 @@ void HeaderMapImpl::dumpState(std::ostream& os, int indent\_level) const { |
|  |  |  |
|  |  | HeaderMapImpl::HeaderEntryImpl& HeaderMapImpl::maybeCreateInline(HeaderEntryImpl\*\* entry, |
|  |  | const LowerCaseString& key) { |
|  |  | cached\_byte\_size\_.reset(); |
|  |  | if (\*entry) { |
|  |  | return \*\*entry; |
|  |  | } |
| Expand All | | @@ -588,6 +630,7 @@ HeaderMapImpl::HeaderEntryImpl& HeaderMapImpl::maybeCreateInline(HeaderEntryImpl |
|  |  | return \*\*entry; |
|  |  | } |
|  |  |  |
|  |  | addSize(key.get().size() + value.size()); |
|  |  | std::list<HeaderEntryImpl>::iterator i = headers\_.insert(key, std::move(value)); |
|  |  | i->entry\_ = i; |
|  |  | \*entry = &(\*i); |
| Expand All | | @@ -609,6 +652,8 @@ void HeaderMapImpl::removeInline(HeaderEntryImpl\*\* ptr\_to\_entry) { |
|  |  | } |
|  |  |  |
|  |  | HeaderEntryImpl\* entry = \*ptr\_to\_entry; |
|  |  | const uint64\_t size\_to\_subtract = entry->entry\_->key().size() + entry->entry\_->value().size(); |
|  |  | subtractSize(size\_to\_subtract); |
|  |  | \*ptr\_to\_entry = nullptr; |
|  |  | headers\_.erase(entry->entry\_); |
|  |  | } |
| Expand Down | |  |

23 changes: 20 additions & 3 deletions

23
[source/common/http/header\_map\_impl.h](#diff-8524e9355805efd7fc6718472d204c063acef398a3d71dc58554239d23a454b5 "source/common/http/header_map_impl.h")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/source/common/http/header_map_impl.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,12 +16,21 @@ namespace Http { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* These are definitions of all of the inline header access functions described inside header\_map.h |
|  |  | \* |
|  |  | \* When a non-const reference or pointer to a HeaderEntry is returned, the internal byte size count |
|  |  | \* will be cleared, since HeaderMap will no longer be able to accurately update the size of that |
|  |  | \* HeaderEntry. |
|  |  | \* TODO(asraa): Remove functions with a non-const HeaderEntry return value. |
|  |  | \*/ |
|  |  | #define DEFINE\_INLINE\_HEADER\_FUNCS(name) \ |
|  |  | public: \ |
|  |  | const HeaderEntry\* name() const override { return inline\_headers\_.name##\_; } \ |
|  |  | HeaderEntry\* name() override { return inline\_headers\_.name##\_; } \ |
|  |  | HeaderEntry\* name() override { \ |
|  |  | cached\_byte\_size\_.reset(); \ |
|  |  | return inline\_headers\_.name##\_; \ |
|  |  | } \ |
|  |  | HeaderEntry& insert##name() override { \ |
|  |  | cached\_byte\_size\_.reset(); \ |
|  |  | return maybeCreateInline(&inline\_headers\_.name##\_, Headers::get().name); \ |
|  |  | } \ |
|  |  | void remove##name() override { removeInline(&inline\_headers\_.name##\_); } |
| Expand All | | @@ -43,7 +52,7 @@ class HeaderMapImpl : public HeaderMap, NonCopyable { |
|  |  | \* @param header the header to append to. |
|  |  | \* @param data to append to the header. |
|  |  | \*/ |
|  |  | static void appendToHeader(HeaderString& header, absl::string\_view data); |
|  |  | static uint64\_t appendToHeader(HeaderString& header, absl::string\_view data); |
|  |  |  |
|  |  | HeaderMapImpl(); |
|  |  | explicit HeaderMapImpl( |
| Expand Down  Expand Up | | @@ -71,7 +80,9 @@ class HeaderMapImpl : public HeaderMap, NonCopyable { |
|  |  | void addCopy(const LowerCaseString& key, const std::string& value) override; |
|  |  | void setReference(const LowerCaseString& key, const std::string& value) override; |
|  |  | void setReferenceKey(const LowerCaseString& key, const std::string& value) override; |
|  |  | uint64\_t byteSize() const override; |
|  |  | absl::optional<uint64\_t> byteSize() const override; |
|  |  | uint64\_t refreshByteSize() override; |
|  |  | uint64\_t byteSizeInternal() const override; |
|  |  | const HeaderEntry\* get(const LowerCaseString& key) const override; |
|  |  | HeaderEntry\* get(const LowerCaseString& key) override; |
|  |  | void iterate(ConstIterateCb cb, void\* context) const override; |
| Expand Down  Expand Up | | @@ -195,10 +206,16 @@ class HeaderMapImpl : public HeaderMap, NonCopyable { |
|  |  | HeaderEntryImpl\* getExistingInline(absl::string\_view key); |
|  |  |  |
|  |  | void removeInline(HeaderEntryImpl\*\* entry); |
|  |  | void addSize(uint64\_t size); |
|  |  | void subtractSize(uint64\_t size); |
|  |  |  |
|  |  | AllInlineHeaders inline\_headers\_; |
|  |  | HeaderList headers\_; |
|  |  |  |
|  |  | // When present, this holds the internal byte size of the HeaderMap. The value is removed once an |
|  |  | // inline header entry is accessed and updated when refreshByteSize() is called. |
|  |  | absl::optional<uint64\_t> cached\_byte\_size\_ = 0; |
|  |  |  |
|  |  | ALL\_INLINE\_HEADERS(DEFINE\_INLINE\_HEADER\_FUNCS) |
|  |  | }; |
|  |  |  |
| Expand Down | |  |

10 changes: 8 additions & 2 deletions

10
[source/common/http/http1/codec\_impl.cc](#diff-8d3b9d0a839b05612561930ee8c58bf1b0ff0adc55cf27d79a7e3bbfbd81965e "source/common/http/http1/codec_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/source/common/http/http1/codec_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -460,8 +460,10 @@ void ConnectionImpl::onHeaderValue(const char\* data, size\_t length) { |
|  |  | header\_parsing\_state\_ = HeaderParsingState::Value; |
|  |  | current\_header\_value\_.append(data, length); |
|  |  |  |
|  |  | const uint32\_t total = |
|  |  | current\_header\_field\_.size() + current\_header\_value\_.size() + current\_header\_map\_->byteSize(); |
|  |  | // Verify that the cached value in byte size exists. |
|  |  | ASSERT(current\_header\_map\_->byteSize().has\_value()); |
|  |  | const uint32\_t total = current\_header\_field\_.size() + current\_header\_value\_.size() + |
|  |  | current\_header\_map\_->byteSize().value(); |
|  |  | if (total > (max\_request\_headers\_kb\_ \* 1024)) { |
|  |  | error\_code\_ = Http::Code::RequestHeaderFieldsTooLarge; |
|  |  | sendProtocolError(); |
| Expand All | | @@ -472,6 +474,10 @@ void ConnectionImpl::onHeaderValue(const char\* data, size\_t length) { |
|  |  | int ConnectionImpl::onHeadersCompleteBase() { |
|  |  | ENVOY\_CONN\_LOG(trace, "headers complete", connection\_); |
|  |  | completeLastHeader(); |
|  |  | // Validate that the completed HeaderMap's cached byte size exists and is correct. |
|  |  | // This assert iterates over the HeaderMap. |
|  |  | ASSERT(current\_header\_map\_->byteSize().has\_value() && |
|  |  | current\_header\_map\_->byteSize() == current\_header\_map\_->byteSizeInternal()); |
|  |  | if (!(parser\_.http\_major == 1 && parser\_.http\_minor == 1)) { |
|  |  | // This is not necessarily true, but it's good enough since higher layers only care if this is |
|  |  | // HTTP/1.1 or not. |
| Expand Down | |  |

15 changes: 13 additions & 2 deletions

15
[source/common/http/http2/codec\_impl.cc](#diff-a23f05b05850c7080b5183f630e0d71c26320a0f7a5ab9e1d2c1bedde0e912e9 "source/common/http/http2/codec_impl.cc")

Show comments

[View file](/envoyproxy/envoy/blob/afc39bea36fd436e54262f150c009e8d72db5014/source/common/http/http2/codec_impl.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -509,6 +509,10 @@ int ConnectionImpl::onFrameReceived(const nghttp2\_frame\* frame) { |
|  |  |  |
|  |  | switch (frame->hd.type) { |
|  |  | case NGHTTP2\_HEADERS: { |
|  |  | // Verify that the final HeaderMap's byte size is under the limit before decoding headers. |
|  |  | // This assert iterates over the HeaderMap. |
|  |  | ASSERT(stream->headers\_->byteSize().has\_value() && |
|  |  | stream->headers\_->byteSize().value() == stream->headers\_->byteSizeInternal()); |
|  |  | stream->remote\_end\_stream\_ = frame->hd.flags & NGHTTP2\_FLAG\_END\_STREAM; |
|  |  | if (!stream->cookies\_.empty()) { |
|  |  | HeaderString key(Headers::get().Cookie); |
| Expand Down  Expand Up | | @@ -620,6 +624,12 @@ int ConnectionImpl::onFrameSend(const nghttp2\_frame\* frame) { |
|  |  | case NGHTTP2\_HEADERS: |
|  |  | case NGHTTP2\_DATA: { |
|  |  | StreamImpl\* stream = getStream(frame->hd.stream\_id); |
|  |  | if (stream->headers\_) { |
|  |  | // Verify that the final HeaderMap's byte size is under the limit before sending frames. |
|  |  | // This assert iterates over the HeaderMap. |
|  |  | ASSERT(stream->headers\_->byteSize().has\_value() && |
|  |  | stream->headers\_->byteSize().value() == stream->headers\_->byteSizeInternal()); |
|  |  | } |
|  |  | stream->local\_end\_stream\_sent\_ = frame->hd.flags & NGHTTP2\_FLAG\_END\_STREAM; |
|  |  | break; |
|  |  | } |
| Expand Down  Expand Up | | @@ -808,9 +818,10 @@ int ConnectionImpl::saveHeader(const nghttp2\_frame\* frame, HeaderString&& name, |
|  |  | stats\_.headers\_cb\_no\_stream\_.inc(); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | stream->saveHeader(std::move(name), std::move(value)); |
|  |  | if (stream->headers\_->byteSize() > max\_request\_headers\_kb\_ \* 1024) { |
|  |  | // Verify that the cached value in byte size exists. |
|  |  | ASSERT(stream->headers\_->byteSize().has\_value()); |
|  |  | if (stream->headers\_->byteSize().value() > max\_request\_headers\_kb\_ \* 1024) { |
|  |  | // This will cause the library to reset/close the stream. |
|  |  | stats\_.header\_overflow\_.inc(); |
|  |  | return NGHTTP2\_ERR\_TEMPORAL\_CALLBACK\_FAILURE; |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `afc39be`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2Fafc39bea36fd436e54262f150c009e8d72db5014) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_47f71868_20250120_231811.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommits%2Fmaster)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommits%2Fmaster)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fcommits%2Fshow&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.9k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  148](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

# Commits

## Branch selector

 master
## User selector

All users
## Datepicker

All time
## No commits history

There isn't any commit history to show here

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from avatars.githubusercontent.com_36566453_20250121_012058.html ===
���� �  

 $.' ",#(7),01444'9=82<.342 
2!!22222222222222222222222222222222222222222222222222��  @ @" ���          
   } !1AQa"q2���#B��R��$3br�
%&'()\*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz�������������������������������������������������������������������������       
  w !1AQaq"2�B���� #3R�br�
$4�%�&'()\*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz��������������������������������������������������������������������������   ? ���,�9P�Fv��v�X�.� 3pCB�h�YRJ�y�����("�G�M�x˹�c�������sV�n\�\�b�^�����{������Q��h�q�w��k>�R�ӭ�i�D"5e@�q�w��]c�q�Z
��>i`FH����0={Tَ䚕���f�<�P뽁\*23�zףh��7�\*��g���x���ş��W[��A� U;��I�����&���rѹP�s�9�g-㩺�V��G��>�[�$�m��L�\*9�"x���ׁe\*�j��8�3���}�}Oo��6��r\A)r�G^�vW���"�m�a�R���°��]��𵸓R�L���3�![���O����B�x�k�Y� ���� ׮��[�"CoqB��vƁA>[s�XK��>h� �`�k����鸻nr~$�{�P#�Z8�@�����.&��S�bU���\*��Y�X�Yۂ���2>���[�ִV�6i�u�x���H�Kh��K�8'ǽ{G�!��!w# ל�6;��[%D��g��=��{Ws�\ܖ ����'�;(�vS�܎�R�m���.�� �\F��Q��>z����v�i��Ʈf�FG(��5�^#�KX#��]nB;`s��M5c$�vw%�rҳ;gl�q�r�w{cڤnb�kK;��pu�ʻN~b����:��� 2�1��K�Sq�Mi�{O��]dr\_���}���6�
�ׂ�n�-�����0q��\_�G�V�4�\_&X������7I/3�I�5�����n�K�X�o��{J�� ^ڰȔaO98��}�[��?/�Fۻ#�{����.,&8�?ָ\*�T��n���8j���� KM�r�� ���,fԞ+H� b@�ӷ?�z����=2E8���ι�ʺ�縹\*�c# s����ԕGkX��E^�0��H7c= <�?x�=M3ˇ��أ�.}��\*����#qԑ^}��?�<L�BA�F'#`<�=� ­>`iGdO�=6��Z��0�|ɤ�7]���+�񆴺��c�S�C��A��4�>{-'O���2�F0��O�y��u�\_�A\_|v��%ݝ������WRd�� ��1'���#+\*8��״h�������G��c�zm���lK$��z{��ף{h�xQ�I�J����MZ�A,Q�H$3�k&$��V��a\[H ea�2q�+���n!�9� ~��������4E���03��:z��ܕ���
