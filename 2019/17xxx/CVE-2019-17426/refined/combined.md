=== Content from github.com_7e08c9d7_20250120_234621.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fcommit%2Ff3eca5b94d822225c04e96cbeed9f095afb3c31c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fcommit%2Ff3eca5b94d822225c04e96cbeed9f095afb3c31c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Automattic%2Fmongoose)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Automattic](/Automattic)
/
**[mongoose](/Automattic/mongoose)**
Public

* [Notifications](/login?return_to=%2FAutomattic%2Fmongoose) You must be signed in to change notification settings
* [Fork
  3.9k](/login?return_to=%2FAutomattic%2Fmongoose)
* [Star
   27k](/login?return_to=%2FAutomattic%2Fmongoose)

* [Code](/Automattic/mongoose)
* [Issues
  224](/Automattic/mongoose/issues)
* [Pull requests
  1](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects
  0](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

Additional navigation options

* [Code](/Automattic/mongoose)
* [Issues](/Automattic/mongoose/issues)
* [Pull requests](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

## Commit

[Permalink](/Automattic/mongoose/commit/f3eca5b94d822225c04e96cbeed9f095afb3c31c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(query): delete top-level `_bsontype` property in queries to preve…

[Browse files](/Automattic/mongoose/tree/f3eca5b94d822225c04e96cbeed9f095afb3c31c)
Browse the repository at this point in the history

```
…nt silent empty queries

Fix [#8222](https://github.com/Automattic/mongoose/issues/8222)
```

* Loading branch information

[![@vkarpov15](https://avatars.githubusercontent.com/u/1620265?s=40&v=4)](/vkarpov15)

[vkarpov15](/Automattic/mongoose/commits?author=vkarpov15 "View all commits by vkarpov15")
committed
Oct 9, 2019

1 parent
[cc10e0d](/Automattic/mongoose/commit/cc10e0dc441f469330c1af2822d171fcd6fa8f89)

commit f3eca5b

Showing
**1 changed file**
with
**6 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[lib/cast.js](#diff-5078cdf8af89c694947cdcb5e60fcd3e29dda608e62642ecf5fc3eeb97e43ce1 "lib/cast.js")

Show comments

[View file](/Automattic/mongoose/blob/f3eca5b94d822225c04e96cbeed9f095afb3c31c/lib/cast.js)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -27,6 +27,12 @@ module.exports = function cast(schema, obj, options, context) { |
|  |  | throw new Error('Query filter must be an object, got an array ', util.inspect(obj)); |
|  |  | } |
|  |  |  |
|  |  | // bson 1.x has the unfortunate tendency to remove filters that have a top-level |
|  |  | // `\_bsontype` property. Should remove this when we upgrade to bson 4.x. See gh-8222 |
|  |  | if (obj.hasOwnProperty('\_bsontype')) { |
|  |  | delete obj.\_bsontype; |
|  |  | } |
|  |  |  |
|  |  | const paths = Object.keys(obj); |
|  |  | let i = paths.length; |
|  |  | let \_keys; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f3eca5b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fcommit%2Ff3eca5b94d822225c04e96cbeed9f095afb3c31c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_71ed15fe_20250120_234622.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fissues%2F8222)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FAutomattic%2Fmongoose%2Fissues%2F8222)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=Automattic%2Fmongoose)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Automattic](/Automattic)
/
**[mongoose](/Automattic/mongoose)**
Public

* [Notifications](/login?return_to=%2FAutomattic%2Fmongoose) You must be signed in to change notification settings
* [Fork
  3.9k](/login?return_to=%2FAutomattic%2Fmongoose)
* [Star
   27k](/login?return_to=%2FAutomattic%2Fmongoose)

* [Code](/Automattic/mongoose)
* [Issues
  224](/Automattic/mongoose/issues)
* [Pull requests
  1](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects
  0](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

Additional navigation options

* [Code](/Automattic/mongoose)
* [Issues](/Automattic/mongoose/issues)
* [Pull requests](/Automattic/mongoose/pulls)
* [Discussions](/Automattic/mongoose/discussions)
* [Actions](/Automattic/mongoose/actions)
* [Projects](/Automattic/mongoose/projects)
* [Wiki](/Automattic/mongoose/wiki)
* [Security](/Automattic/mongoose/security)
* [Insights](/Automattic/mongoose/pulse)

# Mongoose query condition abuse vulnerability. #8222

[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy link[New issue](/login?return_to=)[Jump to bottom](#comment-composer-heading)Copy linkClosedClosed[Mongoose query condition abuse vulnerability.](#top)#8222Copy linkLabels[confirmed-bugWe've confirmed this is a bug in Mongoose and will fix it.](https://github.com/Automattic/mongoose/issues?q=state%3Aopen%20label%3A%22confirmed-bug%22)We've confirmed this is a bug in Mongoose and will fix it.Milestone[5.7.5](https://github.com/Automattic/mongoose/milestone/334)![@xiaofen9](https://avatars.githubusercontent.com/u/20917869?u=5c2e1010cc9057e642092136074bd2ba5235d351&v=4&size=80)
## Description

![@xiaofen9](https://avatars.githubusercontent.com/u/20917869?u=5c2e1010cc9057e642092136074bd2ba5235d351&v=4&size=48)[xiaofen9](https://github.com/xiaofen9)opened [on Oct 7, 2019](https://github.com/Automattic/mongoose/issues/8222#issue-503592619)

**Do you want to request a *feature* or report a *bug*?**

Vulnerability

**What is the current behavior?**

With this vulnerability, an attacker might steal sensitive data/bypass authentication in nodejs applications that use mongoose as front end.

When injecting "\_bsontype" attribute to a query object (e.g., id in find(id)), Mongoose will directly ignore the query object. This can be abused since most nodejs applications treat user input as an object. For example, an attacker can force the query filter condition to be null by adding another attribute (\_bsontype) to the user-input data. By doing this, an attacker can log into other users' accounts or bypass the token verification logics during password reset[1]. Even though Mongoose checks the query object according to the scheme when querying in the form of findOne(id:id\_object), the vulnerability can still be exploited if developers do queries like findOne(id).

Similar issues are also found it Mongodb, and we have reported it. However, just to be safe, my suggestion is that mongoose should also filter \_bsontype before invoking mongodb since \_bsontype is an internal attribute used by mongodb.

[1] <https://github.com/Jerenaux/phaserquest/blob/a7ea970c7ef965adcdde29907a872c104b9f8508/js/server/GameServer.js#L278>

**If the current behavior is a bug, please provide the steps to reproduce.**

Proof of Concept

```
const mongoose = require('mongoose');
mongoose.connect('mongodb://localhost/bsontype', {useNewUrlParser: true});

const Schema = mongoose.Schema;
const ObjectId = Schema.ObjectId;

const userSchema = new Schema({
	  author: ObjectId,
	  username: String,
	  password: String,
	  token: String
},);

const users = mongoose.model('users', userSchema);
token = {"t":"wrongToken","_bsontype":"a"};
users.findOne(token, function (err, res) {
	console.log(res);
});

```

**What are the versions of Node.js, Mongoose and MongoDB you are using? Note that "latest" is not a version.**

Mongoose 5.7.3

## Metadata

### Assignees

No one assigned

### Labels

[confirmed-bugWe've confirmed this is a bug in Mongoose and will fix it.](https://github.com/Automattic/mongoose/issues?q=state%3Aopen%20label%3A%22confirmed-bug%22)We've confirmed this is a bug in Mongoose and will fix it.
### Type

No type
### Projects

No projects
### Milestone

* [5.7.5](https://github.com/Automattic/mongoose/milestone/334)
### Relationships

None yet
### Development

No branches or pull requests
## Issue actions

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


