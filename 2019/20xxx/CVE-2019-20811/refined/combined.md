=== Content from www.debian.org_1990dfb1_20250121_010855.html ===


---

[[Date Prev](msg00101.html)][[Date Next](msg00103.html)]
[[Thread Prev](msg00101.html)][[Thread Next](msg00103.html)]
[[Date Index](maillist.html#00102)]
[[Thread Index](threads.html#00102)]

# [SECURITY] [DSA 4698-1] linux security update

---

* *To*: debian-security-announce@lists.debian.org
* *Subject*: [SECURITY] [DSA 4698-1] linux security update
* *From*: Salvatore Bonaccorso <carnil@debian.org>
* *Date*: Tue, 09 Jun 2020 19:44:16 +0000
* *Message-id*: <[[🔎]](/msgid-search/E1jikAS-0001HJ-13%40seger.debian.org) [E1jikAS-0001HJ-13@seger.debian.org](msg00102.html)>
* *Reply-to*: debian-security-announce-request@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian Security Advisory DSA-4698-1                   security@debian.org
<https://www.debian.org/security/>                            Ben Hutchings
June 09, 2020                         <https://www.debian.org/security/faq>
- -------------------------------------------------------------------------

Package        : linux
CVE ID         : CVE-2019-2182 CVE-2019-5108 CVE-2019-19319 CVE-2019-19462
                 CVE-2019-19768 CVE-2019-20806 CVE-2019-20811 CVE-2020-0543
                 CVE-2020-2732 CVE-2020-8428 CVE-2020-8647 CVE-2020-8648
                 CVE-2020-8649 CVE-2020-9383 CVE-2020-10711 CVE-2020-10732
                 CVE-2020-10751 CVE-2020-10757 CVE-2020-10942 CVE-2020-11494
                 CVE-2020-11565 CVE-2020-11608 CVE-2020-11609 CVE-2020-11668
                 CVE-2020-12114 CVE-2020-12464 CVE-2020-12652 CVE-2020-12653
                 CVE-2020-12654 CVE-2020-12770 CVE-2020-13143
Debian Bug     : 952660

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2019-2182

    Hanjun Guo and Lei Li reported a race condition in the arm64
    virtual memory management code, which could lead to an information
    disclosure, denial of service (crash), or possibly privilege
    escalation.

CVE-2019-5108

    Mitchell Frank of Cisco discovered that when the IEEE 802.11
    (WiFi) stack was used in AP mode with roaming, it would trigger
    roaming for a newly associated station before the station was
    authenticated.  An attacker within range of the AP could use this
    to cause a denial of service, either by filling up a switching
    table or by redirecting traffic away from other stations.

CVE-2019-19319

    Jungyeon discovered that a crafted filesystem can cause the ext4
    implementation to deallocate or reallocate journal blocks.  A user
    permitted to mount filesystems could use this to cause a denial of
    service (crash), or possibly for privilege escalation.

CVE-2019-19462

    The syzbot tool found a missing error check in the 'relay'
    library used to implement various files under debugfs.  A local
    user permitted to access debugfs could use this to cause a denial
    of service (crash) or possibly for privilege escalation.

CVE-2019-19768

    Tristan Madani reported a race condition in the blktrace debug
    facility that could result in a use-after-free.  A local user able
    to trigger removal of block devices could possibly use this to
    cause a denial of service (crash) or for privilege escalation.

CVE-2019-20806

    A potential null pointer dereference was discovered in the tw5864
    media driver.  The security impact of this is unclear.

CVE-2019-20811

    The Hulk Robot tool found a reference-counting bug in an error
    path in the network subsystem.  The security impact of this is
    unclear.

CVE-2020-0543

    Researchers at VU Amsterdam discovered that on some Intel CPUs
    supporting the RDRAND and RDSEED instructions, part of a random
    value generated by these instructions may be used in a later
    speculative execution on any core of the same physical CPU.
    Depending on how these instructions are used by applications, a
    local user or VM guest could use this to obtain sensitive
    information such as cryptographic keys from other users or VMs.

    This vulnerability can be mitigated by a microcode update, either
    as part of system firmware (BIOS) or through the intel-microcode
    package in Debian's non-free archive section.  This kernel update
    only provides reporting of the vulnerability and the option to
    disable the mitigation if it is not needed.

CVE-2020-2732

    Paulo Bonzini discovered that the KVM implementation for Intel
    processors did not properly handle instruction emulation for L2
    guests when nested virtualization is enabled. This could allow an
    L2 guest to cause privilege escalation, denial of service, or
    information leaks in the L1 guest.

CVE-2020-8428

    Al Viro discovered a potential use-after-free in the filesystem
    core (vfs).  A local user could exploit this to cause a denial of
    service (crash) or possibly to obtain sensitive information from
    the kernel.

CVE-2020-8647, CVE-2020-8649

    The Hulk Robot tool found a potential MMIO out-of-bounds access in
    the vgacon driver.  A local user permitted to access a virtual
    terminal (/dev/tty1 etc.) on a system using the vgacon driver
    could use this to cause a denial of service (crash or memory
    corruption) or possibly for privilege escalation.

CVE-2020-8648

    The syzbot tool found a race condition in the the virtual terminal
    driver, which could result in a use-after-free.  A local user
    permitted to access a virtual terminal could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-9383

    Jordy Zomer reported an incorrect range check in the floppy driver
    which could lead to a static out-of-bounds access.  A local user
    permitted to access a floppy drive could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-10711

    Matthew Sheets reported NULL pointer dereference issues in the
    SELinux subsystem while receiving CIPSO packet with null category. A
    remote attacker can take advantage of this flaw to cause a denial of
    service (crash). Note that this issue does not affect the binary
    packages distributed in Debian as CONFIG_NETLABEL is not enabled.

CVE-2020-10732

    An information leak of kernel private memory to userspace was found
    in the kernel's implementation of core dumping userspace processes.

CVE-2020-10751

    Dmitry Vyukov reported that the SELinux subsystem did not properly
    handle validating multiple messages, which could allow a privileged
    attacker to bypass SELinux netlink restrictions.

CVE-2020-10757

    Fan Yang reported a flaw in the way mremap handled DAX hugepages,
    allowing a local user to escalate their privileges

CVE-2020-10942

    It was discovered that the vhost_net driver did not properly
    validate the type of sockets set as back-ends. A local user
    permitted to access /dev/vhost-net could use this to cause a stack
    corruption via crafted system calls, resulting in denial of
    service (crash) or possibly privilege escalation.

CVE-2020-11494

    It was discovered that the slcan (serial line CAN) network driver
    did not fully initialise CAN headers for received packets,
    resulting in an information leak from the kernel to user-space or
    over the CAN network.

CVE-2020-11565

    Entropy Moe reported that the shared memory filesystem (tmpfs) did
    not correctly handle an "mpol" mount option specifying an empty
    node list, leading to a stack-based out-of-bounds write. If user
    namespaces are enabled, a local user could use this to cause a
    denial of service (crash) or possibly for privilege escalation.

CVE-2020-11608, CVE-2020-11609, CVE-2020-11668

    It was discovered that the ov519, stv06xx, and xirlink_cit media
    drivers did not properly validate USB device descriptors.  A
    physically present user with a specially constructed USB device
    could use this to cause a denial-of-service (crash) or possibly
    for privilege escalation.

CVE-2020-12114

    Piotr Krysiuk discovered a race condition between the umount and
    pivot_root operations in the filesystem core (vfs).  A local user
    with the CAP_SYS_ADMIN capability in any user namespace could use
    this to cause a denial of service (crash).

CVE-2020-12464

    Kyungtae Kim reported a race condition in the USB core that can
    result in a use-after-free.  It is not clear how this can be
    exploited, but it could result in a denial of service (crash or
    memory corruption) or privilege escalation.

CVE-2020-12652

    Tom Hatskevich reported a bug in the mptfusion storage drivers.
    An ioctl handler fetched a parameter from user memory twice,
    creating a race condition which could result in incorrect locking
    of internal data structures.  A local user permitted to access
    /dev/mptctl could use this to cause a denial of service (crash or
    memory corruption) or for privilege escalation.

CVE-2020-12653

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate scan requests, resulting a potential heap
    buffer overflow.  A local user with CAP_NET_ADMIN capability could
    use this to cause a denial of service (crash or memory corruption)
    or possibly for privilege escalation.

CVE-2020-12654

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate WMM parameters received from an access point
    (AP), resulting a potential heap buffer overflow.  A malicious AP
    could use this to cause a denial of service (crash or memory
    corruption) or possibly to execute code on a vulnerable system.

CVE-2020-12770

    It was discovered that the sg (SCSI generic) driver did not
    correctly release internal resources in a particular error case.
    A local user permitted to access an sg device could possibly use
    this to cause a denial of service (resource exhaustion).

CVE-2020-13143

    Kyungtae Kim reported a potential heap out-of-bounds write in
    the USB gadget subsystem.  A local user permitted to write to
    the gadget configuration filesystem could use this to cause a
    denial of service (crash or memory corruption) or potentially
    for privilege escalation.

For the oldstable distribution (stretch), these problems have been
fixed in version 4.9.210-1+deb9u1.  This version also fixes some
related bugs that do not have their own CVE IDs, and a regression in
the macvlan driver introduced in the previous point release (bug
#952660).

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to its security
tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian Security Advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://www.debian.org/security/>

Mailing list: debian-security-announce@lists.debian.org
-----BEGIN PGP SIGNATURE-----

iQKTBAEBCgB9FiEERkRAmAjBceBVMd3uBUy48xNDz0QFAl7f5blfFIAAAAAALgAo
aXNzdWVyLWZwckBub3RhdGlvbnMub3BlbnBncC5maWZ0aGhvcnNlbWFuLm5ldDQ2
NDQ0MDk4MDhDMTcxRTA1NTMxRERFRTA1NENCOEYzMTM0M0NGNDQACgkQBUy48xND
z0Sh5RAAmfLUcD69AFSfY6hVPLCvTHS0gVYHUk57NSP7vHaUqQPWXMv4lV6pJ1sp
I6sB7tuDW8MWERVy9lBuZrLhnhlhAfqhzkJ+F/yh6ze703QCf1mMoHBAI44yXGtB
fZDV2vxreXpJ4LfoBfGP2+yFiJXBBCRASgyNEtiBoHYG0yt1gfqXP5OjlaRJ5p1I
yElJ5Uj0MkclVj3nbupUmPs7V/2o4tPavOgTyLplTHTDfOMkK1Z86M0fUfh7fS97
ffwJutFObQuxrkO/2vtzTvaXPnqHh5DUIEQzq5xKhK10+GUlkppqHvId1c//0krF
Wd1gZc2RXLkREQShh21BUaI2XxRTcOw7f6Nmz2QnwN/Q/dXGeWeCjPUGslna3BQs
d/pToA0OpbFNxkNKsbg+ovzMrB9C9aP03aDpSztbf/ZLReR+yOf74s9ypdeadGLC
qKmHcFRWP25ct/ZOxNnTquEwd2NT6qDc9Iu6VNdXb2ndRz1zFU/OZlZ3oEPkrCIp
FxJ+j8jpMFJsluE09UjAxH4AhyNAPjPcCr3M+fkgG+WPgzxSHdKComDN06O53iVi
kWbN/AQPXiLlWHuKpCWbS87dZUyT1K1Wf+7mJbsAUfrrd+1mgWSHTRw1QNii74CR
bD91B+70LVu2UCKKxtnOIJ3+iUiUwBNPYw70B0cc3vZTv9O7q7k=
=WzfN
-----END PGP SIGNATURE-----

```

---



=== Content from usn.ubuntu.com_ccbf89fd_20250121_010854.html ===


Your submission was sent successfully!
*Close*

Thank you for contacting us. A member of our team will be in touch shortly.
*Close*

You have successfully unsubscribed!
*Close*

Thank you for signing up for our newsletter!

In these regular emails you will find the latest updates about
Ubuntu and upcoming events where you can meet our team.*Close*

Your preferences have been successfully updated. *Close*

[Canonical Ubuntu](/)

* [Menu](/navigation)

* [Products](/navigation#products-navigation)
* [Use cases](/navigation#use-case-navigation)
* [Support](/navigation#support-navigation)
* [Community](/navigation#community-navigation)
* [Get Ubuntu](/navigation#get-ubuntu-navigation)

[![](https://assets.ubuntu.com/v1/82818827-CoF_white.svg)

Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

# USN-4527-1: Linux kernel vulnerabilities

24 September 2020

Several security issues were fixed in the Linux kernel.

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Releases

* [Ubuntu 16.04 ESM](/security/notices?release=xenial)
* [Ubuntu 14.04 ESM](/security/notices?release=trusty)

## Packages

* [linux](/security/cves?package=linux) - Linux kernel
* [linux-aws](/security/cves?package=linux-aws) - Linux kernel for Amazon Web Services (AWS) systems
* [linux-kvm](/security/cves?package=linux-kvm) - Linux kernel for cloud environments
* [linux-lts-xenial](/security/cves?package=linux-lts-xenial) - Linux hardware enablement kernel from Xenial for Trusty
* [linux-raspi2](/security/cves?package=linux-raspi2) - Linux kernel for Raspberry Pi (V8) systems
* [linux-snapdragon](/security/cves?package=linux-snapdragon) - Linux kernel for Qualcomm Snapdragon processors

## Details

It was discovered that the Conexant 23885 TV card device driver for the

Linux kernel did not properly deallocate memory in some error conditions. A

local attacker could use this to cause a denial of service (memory

exhaustion). ([CVE-2019-19054](/security/CVE-2019-19054))

It was discovered that the Atheros HTC based wireless driver in the Linux

kernel did not properly deallocate in certain error conditions. A local

attacker could use this to cause a denial of service (memory exhaustion).

([CVE-2019-19073](/security/CVE-2019-19073), [CVE-2019-19074](/security/CVE-2019-19074))

Yue Haibing discovered that the Linux kernel did not properly handle

reference counting in sysfs for network devices in some situations. A local

attacker could possibly use this to cause a denial of service.

([CVE-2019-20811](/security/CVE-2019-20811))

It was discovered that the F2FS file system in the Linux kernel did not

properly perform bounds checking in some situations, leading to an out-of-

bounds read. A local attacker could possibly use this to expose sensitive

information (kernel memory). ([CVE-2019-9445](/security/CVE-2019-9445))

It was discovered that the F2FS file system in the Linux kernel did not

properly validate xattr meta data in some situations, leading to an out-of-

bounds read. An attacker could use this to construct a malicious F2FS image

that, when mounted, could expose sensitive information (kernel memory).

([CVE-2019-9453](/security/CVE-2019-9453))

It was discovered that the F2FS file system implementation in the Linux

kernel did not properly perform bounds checking on xattrs in some

situations. A local attacker could possibly use this to expose sensitive

information (kernel memory). ([CVE-2020-0067](/security/CVE-2020-0067))

It was discovered that the NFS client implementation in the Linux kernel

did not properly perform bounds checking before copying security labels in

some situations. A local attacker could use this to cause a denial of

service (system crash) or possibly execute arbitrary code. ([CVE-2020-25212](/security/CVE-2020-25212))

### Reduce your security exposure

Ubuntu Pro provides ten-year security coverage to 25,000+ packages in Main and Universe repositories, and it is free for up to five machines.

[Learn more about Ubuntu Pro](/pro)

## Update instructions

The problem can be corrected by updating your system to the following package versions:

##### Ubuntu 16.04

* [linux-image-4.4.0-1080-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-kvm)
  -
  [4.4.0-1080.87](https://launchpad.net/ubuntu/%2Bsource/linux-kvm/4.4.0-1080.87)
* [linux-image-4.4.0-1114-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1114.127](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1114.127)
* [linux-image-4.4.0-1139-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2)
  -
  [4.4.0-1139.148](https://launchpad.net/ubuntu/%2Bsource/linux-raspi2/4.4.0-1139.148)
* [linux-image-4.4.0-1143-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon)
  -
  [4.4.0-1143.152](https://launchpad.net/ubuntu/%2Bsource/linux-snapdragon/4.4.0-1143.152)
* [linux-image-4.4.0-190-generic](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux-signed/4.4.0-190.220)
* [linux-image-4.4.0-190-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-190.220)
* [linux-image-4.4.0-190-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-signed)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux-signed/4.4.0-190.220)
* [linux-image-4.4.0-190-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-190.220)
* [linux-image-4.4.0-190-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-190.220)
* [linux-image-4.4.0-190-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-190.220)
* [linux-image-4.4.0-190-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux)
  -
  [4.4.0-190.220](https://launchpad.net/ubuntu/%2Bsource/linux/4.4.0-190.220)
* [linux-image-aws](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws)
  -
  [4.4.0.1114.119](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws/4.4.0.1114.119)
* [linux-image-generic](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-kvm](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm)
  -
  [4.4.0.1080.78](https://launchpad.net/ubuntu/%2Bsource/linux-meta-kvm/4.4.0.1080.78)
* [linux-image-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)
* [linux-image-raspi2](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2)
  -
  [4.4.0.1139.139](https://launchpad.net/ubuntu/%2Bsource/linux-meta-raspi2/4.4.0.1139.139)
* [linux-image-snapdragon](https://launchpad.net/ubuntu/%2Bsource/linux-meta-snapdragon)
  -
  [4.4.0.1143.135](https://launchpad.net/ubuntu/%2Bsource/linux-meta-snapdragon/4.4.0.1143.135)
* [linux-image-virtual](https://launchpad.net/ubuntu/%2Bsource/linux-meta)
  -
  [4.4.0.190.196](https://launchpad.net/ubuntu/%2Bsource/linux-meta/4.4.0.190.196)

##### Ubuntu 14.04

* [linux-image-4.4.0-1078-aws](https://launchpad.net/ubuntu/%2Bsource/linux-aws)
  -
  [4.4.0-1078.82](https://launchpad.net/ubuntu/%2Bsource/linux-aws/4.4.0-1078.82)
* [linux-image-4.4.0-190-generic](https://launchpad.net/ubuntu/%2Bsource/linux-signed-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-generic-lpae](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-lowlatency](https://launchpad.net/ubuntu/%2Bsource/linux-signed-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-signed-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-powerpc-e500mc](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-powerpc-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-powerpc64-emb](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-4.4.0-190-powerpc64-smp](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial)
  -
  [4.4.0-190.220~14.04.1](https://launchpad.net/ubuntu/%2Bsource/linux-lts-xenial/4.4.0-190.220~14.04.1)
* [linux-image-aws](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws)
  -
  [4.4.0.1078.75](https://launchpad.net/ubuntu/%2Bsource/linux-meta-aws/4.4.0.1078.75)
* [linux-image-generic-lpae-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-generic-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-lowlatency-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-powerpc-e500mc-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-powerpc-smp-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-powerpc64-emb-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-powerpc64-smp-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)
* [linux-image-virtual-lts-xenial](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial)
  -
  [4.4.0.190.166](https://launchpad.net/ubuntu/%2Bsource/linux-meta-lts-xenial/4.4.0.190.166)

After a standard system update you need to reboot your computer to make

all the necessary changes.

ATTENTION: Due to an unavoidable ABI change the kernel updates have

been given a new version number, which requires you to recompile and

reinstall all third party kernel modules you might have installed.

Unless you manually uninstalled the standard kernel metapackages

(e.g. linux-generic, linux-generic-lts-RELEASE, linux-virtual,

linux-powerpc), a standard system upgrade will automatically perform

this as well.

## References

* [CVE-2019-19054](/security/CVE-2019-19054)
* [CVE-2019-19073](/security/CVE-2019-19073)
* [CVE-2019-19074](/security/CVE-2019-19074)
* [CVE-2019-20811](/security/CVE-2019-20811)
* [CVE-2019-9445](/security/CVE-2019-9445)
* [CVE-2019-9453](/security/CVE-2019-9453)
* [CVE-2020-0067](/security/CVE-2020-0067)
* [CVE-2020-25212](/security/CVE-2020-25212)

## Related notices

* [USN-4525-1](/security/notices/USN-4525-1)
* [USN-4526-1](/security/notices/USN-4526-1)
* [USN-4387-1](/security/notices/USN-4387-1)
* [USN-4390-1](/security/notices/USN-4390-1)
* [USN-4389-1](/security/notices/USN-4389-1)
* [USN-4388-1](/security/notices/USN-4388-1)
* [LSN-0072-1](/security/notices/LSN-0072-1)
* [USN-4578-1](/security/notices/USN-4578-1)
* [USN-4752-1](/security/notices/USN-4752-1)

### Join the discussion

* [Ubuntu security updates mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-hardened)
* [Security announcements mailing list](https://lists.ubuntu.com/mailman/listinfo/ubuntu-security-announce)

### Need help with your security needs?

Ubuntu Pro provides up to ten-year security coverage for over 23,000 open-source packages within the Ubuntu Main and Universe repositories.

[Talk to an expert to find out what would work best for you](/contact-us/form?product=pro)

### Further reading

* *Loading...*

---

## [OpenStack](/openstack) [OpenStack](/openstack)

* [What is OpenStack](/openstack/what-is-openstack)
* [Features](/openstack/features)
* [Managed](/openstack/managed)
* [Consulting](/openstack/consulting)
* [Install](/openstack/install)
* [Support](/openstack/support)

---

## [Ceph](/ceph) [Ceph](/ceph)

* [What is Ceph](/ceph/what-is-ceph)
* [Managed](/ceph/managed)
* [Consulting](/ceph/consulting)
* [Docs](/ceph/docs)
* [Install](/ceph/install)

---

## [Kubernetes](/kubernetes) [Kubernetes](/kubernetes)

* [What is Kubernetes](/kubernetes/what-is-kubernetes)
* [Charmed Kubernetes](/kubernetes/charmed-k8s)
* [Managed](/kubernetes/managed)
* [Install](/kubernetes/install)
* [Docs](/kubernetes/docs)
* [Resources](/kubernetes/resources)

---

## [Managed Services](/managed) [Managed Services](/managed)

* [OpenStack](/openstack/managed)
* [Kubernetes](/kubernetes/managed)
* [Ceph](/ceph/managed)
* [Apps](/managed/apps)
* [Observability](/observability/managed)
* [Firefighting](/managed/firefighting-support)

---

## [AI / ML](/ai) [AI / ML](/ai)

* [MLOps](/ai/mlops)
* [Kubeflow](/ai/what-is-kubeflow)
* [MLflow](/ai/mlflow)
* [Consulting](/ai/consulting)
* [Data Science](/ai/data-science)
* [MLOps workshop](/ai/mlops-workshop)

---

## [Robotics](/robotics) [Robotics](/robotics)

* [What is ROS](/robotics/what-is-ros)
* [ROS ESM](/robotics/ros-esm)
* [Community](/robotics/community)
* [Docs](/robotics/docs)

---

## [IoT](/internet-of-things) [IoT](/internet-of-things)

* [App store](/internet-of-things/appstore)
* [Embedded Linux](/embedded)
* [Management](/internet-of-things/management)

---

## [Ubuntu Core](/core) [Ubuntu Core](/core)

* [Features](/core/features)
* [Success stories](/core/stories)
* [Services](/core/services)
* [Docs](/core/docs)

---

## [Ubuntu Desktop](/desktop) [Ubuntu Desktop](/desktop)

* [Organisations](/desktop/organisations)
* [Developers](/desktop/developers)
* [Flavours](/desktop/flavours)
* [WSL](/desktop/wsl)

---

## [Ubuntu Server](/server) [Ubuntu Server](/server)

* [Hyperscale](/server/hyperscale)
* [Docs](/server/docs)

---

## [Cloud](/cloud) [Cloud](/cloud)

* [What is cloud computing](/cloud/cloud-computing)
* [What is private cloud](/cloud/private-cloud)
* [What is hybrid cloud](/cloud/hybrid-cloud)
* [What is multi-cloud](/cloud/multi-cloud)
* [Public cloud](/cloud/public-cloud)

---

## [Security](/security) [Security](/security)

* [ESM](/security/esm)
* [Livepatch](/security/livepatch)
* [Certifications & Hardening](/security/compliance-automation)
* [CVEs](/security/cves)
* [Notices](/security/notices)
* [Docker Images](/security/docker-images)

---

## [Landscape](/landscape) [Landscape](/landscape)

* [Features](/landscape/features)
* [Managed](/landscape/managed)
* [Compare](/landscape/compare)
* [Install](/landscape/docs/quickstart-deployment)
* [Docs](/landscape/docs)
* [Log in to Landscape](https://landscape.canonical.com/)

---

## [Containers](/containers) [Containers](/containers)

* [What are containers](/containers/what-are-containers)
* [Chiseled Ubuntu](/containers/chiseled)
* [Chiseled and .NET](/containers/chiseled/dotnet)

---

## [Downloads](/download) [Downloads](/download)

* [Desktop](/download/desktop)
* [Server](/download/server)
* [Core](/download/core)
* [Cloud](/download/cloud)

---

## [Support](/support) [Support](/support)

* [Your subscriptions](/pro/dashboard)
* [Account users](/pro/users)
* [Pricing](/pricing/pro)
* [Discourse](https://discourse.ubuntu.com/c/project/ubuntu-pro/116/)

---

## [Observability](/observability) [Observability](/observability)

* [What is observability](/observability/what-is-observability)
* [Managed](/observability/managed)

---

## [Pricing](/pricing) [Pricing](/pricing)

* [Consulting](/pricing/consulting)
* [Desktops](/pricing/desktop)
* [Devices](/pricing/devices)

---

## Solutions

* [AI](https://canonical.com/solutions/ai)
* [Data](https://canonical.com/data)
* [Infrastructure](https://canonical.com/solutions/infrastructure)
* [Secure open source](https://canonical.com/solutions/secure-open-source)

---

## Sectors

* [Automotive](/automotive)
* [Industrial](/industrial)
* [Government](/gov)
* [Telco](/telco)
* [Finance](/financial-services)

---

[Contact us](/contact-us)

* [About us](/about)
* [Community](/community)
* [Careers](https://www.canonical.com/careers)
* [Blog](/blog)
* [Resources](/engage)
* [Press centre](/blog/press-centre)

---

© 2025 Canonical Ltd.

Ubuntu and Canonical are registered trademarks of Canonical Ltd.

---

* [Legal information](/legal)
* [Data privacy](/legal/data-privacy)
* Manage your tracker settings
* [Report a bug on this site](https://github.com/canonical/ubuntu.com/issues/new?template=ISSUE_TEMPLATE.yaml)

Back to top

Go to the top of the page



=== Content from git.kernel.org_5c4a571c_20250121_010850.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | YueHaibing <yuehaibing@huawei.com> | 2019-03-19 10:16:53 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2019-03-19 13:45:58 -0700 |
| commit | [a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)) | |
| tree | [18873532e319e52799711a7bfc4bd1e8d69787c4](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e) | |
| parent | [223a960c01227e4dbcb6f9fa06b47d73bda21274](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=223a960c01227e4dbcb6f9fa06b47d73bda21274) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e&id2=223a960c01227e4dbcb6f9fa06b47d73bda21274)) | |
| download | [linux-a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e.tar.gz) | |

net-sysfs: call dev\_hold if kobject\_init\_and\_add successIn netdev\_queue\_add\_kobject and rx\_queue\_add\_kobject,
if sysfs\_create\_group failed, kobject\_put will call
netdev\_queue\_release to decrease dev refcont, however
dev\_hold has not be called. So we will see this while
unregistering dev:
unregister\_netdevice: waiting for bcsh0 to become free. Usage count = -1
Reported-by: Hulk Robot <hulkci@huawei.com>
Fixes: d0d668371679 ("net: don't decrement kobj reference count on init failure")
Signed-off-by: YueHaibing <yuehaibing@huawei.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)

| -rw-r--r-- | [net/core/net-sysfs.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/core/net-sysfs.c?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 2 deletions

| diff --git a/net/core/net-sysfs.c b/net/core/net-sysfs.cindex 4ff661f6f989ae..8f8b7b6c2945a7 100644--- a/[net/core/net-sysfs.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/net-sysfs.c?id=223a960c01227e4dbcb6f9fa06b47d73bda21274)+++ b/[net/core/net-sysfs.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/core/net-sysfs.c?id=a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e)@@ -928,6 +928,8 @@ static int rx\_queue\_add\_kobject(struct net\_device \*dev, int index) if (error) return error; + dev\_hold(queue->dev);+ if (dev->sysfs\_rx\_queue\_group) { error = sysfs\_create\_group(kobj, dev->sysfs\_rx\_queue\_group); if (error) {@@ -937,7 +939,6 @@ static int rx\_queue\_add\_kobject(struct net\_device \*dev, int index) }  kobject\_uevent(kobj, KOBJ\_ADD);- dev\_hold(queue->dev);  return error; }@@ -1464,6 +1465,8 @@ static int netdev\_queue\_add\_kobject(struct net\_device \*dev, int index) if (error) return error; + dev\_hold(queue->dev);+ #ifdef CONFIG\_BQL error = sysfs\_create\_group(kobj, &dql\_group); if (error) {@@ -1473,7 +1476,6 @@ static int netdev\_queue\_add\_kobject(struct net\_device \*dev, int index) #endif  kobject\_uevent(kobj, KOBJ\_ADD);- dev\_hold(queue->dev);  return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-21 01:07:28 +0000



=== Content from lists.debian.org_6dc6af3c_20250121_010851.html ===


---

[[Date Prev](msg00011.html)][[Date Next](msg00013.html)]
[[Thread Prev](msg00011.html)][[Thread Next](msg00013.html)]
[[Date Index](maillist.html#00012)]
[[Thread Index](threads.html#00012)]

# [SECURITY] [DLA 2242-1] linux-4.9 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 2242-1] linux-4.9 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Wed, 10 Jun 2020 11:48:38 +0100
* *Message-id*: <[[🔎]](/msgid-search/789691b3720bbdbc7eaedacb5385bc248bffac7a.camel%40debian.org) [789691b3720bbdbc7eaedacb5385bc248bffac7a.camel@debian.org](msg00012.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux-4.9
Version        : 4.9.210-1+deb9u1~deb8u1
CVE ID         : CVE-2019-2182 CVE-2019-5108 CVE-2019-19319 CVE-2019-19462
                 CVE-2019-19768 CVE-2019-20806 CVE-2019-20811 CVE-2020-0543
                 CVE-2020-2732 CVE-2020-8428 CVE-2020-8647 CVE-2020-8648
                 CVE-2020-8649 CVE-2020-9383 CVE-2020-10711 CVE-2020-10732
                 CVE-2020-10751 CVE-2020-10757 CVE-2020-10942 CVE-2020-11494
                 CVE-2020-11565 CVE-2020-11608 CVE-2020-11609 CVE-2020-11668
                 CVE-2020-12114 CVE-2020-12464 CVE-2020-12652 CVE-2020-12653
                 CVE-2020-12654 CVE-2020-12770 CVE-2020-13143
Debian Bug     : 952660

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2019-2182

    Hanjun Guo and Lei Li reported a race condition in the arm64
    virtual memory management code, which could lead to an information
    disclosure, denial of service (crash), or possibly privilege
    escalation.

CVE-2019-5108

    Mitchell Frank of Cisco discovered that when the IEEE 802.11
    (WiFi) stack was used in AP mode with roaming, it would trigger
    roaming for a newly associated station before the station was
    authenticated.  An attacker within range of the AP could use this
    to cause a denial of service, either by filling up a switching
    table or by redirecting traffic away from other stations.

CVE-2019-19319

    Jungyeon discovered that a crafted filesystem can cause the ext4
    implementation to deallocate or reallocate journal blocks.  A user
    permitted to mount filesystems could use this to cause a denial of
    service (crash), or possibly for privilege escalation.

CVE-2019-19462

    The syzbot tool found a missing error check in the 'relay'
    library used to implement various files under debugfs.  A local
    user permitted to access debugfs could use this to cause a denial
    of service (crash) or possibly for privilege escalation.

CVE-2019-19768

    Tristan Madani reported a race condition in the blktrace debug
    facility that could result in a use-after-free.  A local user able
    to trigger removal of block devices could possibly use this to
    cause a denial of service (crash) or for privilege escalation.

CVE-2019-20806

    A potential null pointer dereference was discovered in the tw5864
    media driver.  The security impact of this is unclear.

CVE-2019-20811

    The Hulk Robot tool found a reference-counting bug in an error
    path in the network subsystem.  The security impact of this is
    unclear.

CVE-2020-0543

    Researchers at VU Amsterdam discovered that on some Intel CPUs
    supporting the RDRAND and RDSEED instructions, part of a random
    value generated by these instructions may be used in a later
    speculative execution on any core of the same physical CPU.
    Depending on how these instructions are used by applications, a
    local user or VM guest could use this to obtain sensitive
    information such as cryptographic keys from other users or VMs.

    This vulnerability can be mitigated by a microcode update, either
    as part of system firmware (BIOS) or through the intel-microcode
    package in Debian's non-free archive section.  This kernel update
    only provides reporting of the vulnerability and the option to
    disable the mitigation if it is not needed.

CVE-2020-2732

    Paulo Bonzini discovered that the KVM implementation for Intel
    processors did not properly handle instruction emulation for L2
    guests when nested virtualization is enabled. This could allow an
    L2 guest to cause privilege escalation, denial of service, or
    information leaks in the L1 guest.

CVE-2020-8428

    Al Viro discovered a potential use-after-free in the filesystem
    core (vfs).  A local user could exploit this to cause a denial of
    service (crash) or possibly to obtain sensitive information from
    the kernel.

CVE-2020-8647, CVE-2020-8649

    The Hulk Robot tool found a potential MMIO out-of-bounds access in
    the vgacon driver.  A local user permitted to access a virtual
    terminal (/dev/tty1 etc.) on a system using the vgacon driver
    could use this to cause a denial of service (crash or memory
    corruption) or possibly for privilege escalation.

CVE-2020-8648

    The syzbot tool found a race condition in the the virtual terminal
    driver, which could result in a use-after-free.  A local user
    permitted to access a virtual terminal could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-9383

    Jordy Zomer reported an incorrect range check in the floppy driver
    which could lead to a static out-of-bounds access.  A local user
    permitted to access a floppy drive could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-10711

    Matthew Sheets reported NULL pointer dereference issues in the
    SELinux subsystem while receiving CIPSO packet with null category. A
    remote attacker can take advantage of this flaw to cause a denial of
    service (crash). Note that this issue does not affect the binary
    packages distributed in Debian as CONFIG_NETLABEL is not enabled.

CVE-2020-10732

    An information leak of kernel private memory to userspace was found
    in the kernel's implementation of core dumping userspace processes.

CVE-2020-10751

    Dmitry Vyukov reported that the SELinux subsystem did not properly
    handle validating multiple messages, which could allow a privileged
    attacker to bypass SELinux netlink restrictions.

CVE-2020-10757

    Fan Yang reported a flaw in the way mremap handled DAX hugepages,
    allowing a local user to escalate their privileges

CVE-2020-10942

    It was discovered that the vhost_net driver did not properly
    validate the type of sockets set as back-ends. A local user
    permitted to access /dev/vhost-net could use this to cause a stack
    corruption via crafted system calls, resulting in denial of
    service (crash) or possibly privilege escalation.

CVE-2020-11494

    It was discovered that the slcan (serial line CAN) network driver
    did not fully initialise CAN headers for received packets,
    resulting in an information leak from the kernel to user-space or
    over the CAN network.

CVE-2020-11565

    Entropy Moe reported that the shared memory filesystem (tmpfs) did
    not correctly handle an "mpol" mount option specifying an empty
    node list, leading to a stack-based out-of-bounds write. If user
    namespaces are enabled, a local user could use this to cause a
    denial of service (crash) or possibly for privilege escalation.

CVE-2020-11608, CVE-2020-11609, CVE-2020-11668

    It was discovered that the ov519, stv06xx, and xirlink_cit media
    drivers did not properly validate USB device descriptors.  A
    physically present user with a specially constructed USB device
    could use this to cause a denial-of-service (crash) or possibly
    for privilege escalation.

CVE-2020-12114

    Piotr Krysiuk discovered a race condition between the umount and
    pivot_root operations in the filesystem core (vfs).  A local user
    with the CAP_SYS_ADMIN capability in any user namespace could use
    this to cause a denial of service (crash).

CVE-2020-12464

    Kyungtae Kim reported a race condition in the USB core that can
    result in a use-after-free.  It is not clear how this can be
    exploited, but it could result in a denial of service (crash or
    memory corruption) or privilege escalation.

CVE-2020-12652

    Tom Hatskevich reported a bug in the mptfusion storage drivers.
    An ioctl handler fetched a parameter from user memory twice,
    creating a race condition which could result in incorrect locking
    of internal data structures.  A local user permitted to access
    /dev/mptctl could use this to cause a denial of service (crash or
    memory corruption) or for privilege escalation.

CVE-2020-12653

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate scan requests, resulting a potential heap
    buffer overflow.  A local user with CAP_NET_ADMIN capability could
    use this to cause a denial of service (crash or memory corruption)
    or possibly for privilege escalation.

CVE-2020-12654

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate WMM parameters received from an access point
    (AP), resulting a potential heap buffer overflow.  A malicious AP
    could use this to cause a denial of service (crash or memory
    corruption) or possibly to execute code on a vulnerable system.

CVE-2020-12770

    It was discovered that the sg (SCSI generic) driver did not
    correctly release internal resources in a particular error case.
    A local user permitted to access an sg device could possibly use
    this to cause a denial of service (resource exhaustion).

CVE-2020-13143

    Kyungtae Kim reported a potential heap out-of-bounds write in
    the USB gadget subsystem.  A local user permitted to write to
    the gadget configuration filesystem could use this to cause a
    denial of service (crash or memory corruption) or potentially
    for privilege escalation.

For Debian 8 "Jessie", these problems have been fixed in version
4.9.210-1+deb9u1~deb8u1.  This version also fixes some related bugs
that do not have their own CVE IDs, and a regression in the macvlan
driver introduced in the previous security update (bug #952660).

We recommend that you upgrade your linux-4.9 packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams

```

**Attachment:
[signature.asc](pgpeI_h2IKIqu.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from cdn.kernel.org_23736826_20250121_010850.html ===
commit 820c1fa515010d280551075da59fc2668ba8b3ae
Author: Greg Kroah-Hartman
Date: Wed Apr 3 06:27:39 2019 +0200
Linux 5.0.6
commit debaa517c16c65247ec753324e16ccd7c26e858c
Author: Stanislaw Gruszka
Date: Mon Feb 11 09:16:14 2019 +0100
mt76x02u: use usb\_bulk\_msg to upload firmware
commit 5de4db8fcb6d6fc7d9064c22841211790c0ab81b upstream.
We don't need to send firmware data asynchronously, much simpler is just
use synchronous usb\_bulk\_msg().
[ stable note: this patch was originally developed as cleanup, but it
remove incorrect usage of page\_frag\_alloc(): alloc more than PAGE\_SIZE
and create not ARCH\_DMA\_MINALIGN dma buffers needed at least for
performance reason. Was tested on 5.0 and 4.20, see
https://bugzilla.kernel.org/show\_bug.cgi?id=202673 and
https://bugzilla.kernel.org/show\_bug.cgi?id=202241 ]
Tested-by: Lorenzo Bianconi
Signed-off-by: Stanislaw Gruszka
Signed-off-by: Felix Fietkau
Signed-off-by: Greg Kroah-Hartman
commit 046098f056e2ac1a2e4fe5545b66a7024ef8a306
Author: Xu Yu
Date: Thu Mar 21 18:00:35 2019 +0800
bpf: do not restore dst\_reg when cur\_state is freed
commit 0803278b0b4d8eeb2b461fb698785df65a725d9e upstream.
Syzkaller hit 'KASAN: use-after-free Write in sanitize\_ptr\_alu' bug.
Call trace:
dump\_stack+0xbf/0x12e
print\_address\_description+0x6a/0x280
kasan\_report+0x237/0x360
sanitize\_ptr\_alu+0x85a/0x8d0
adjust\_ptr\_min\_max\_vals+0x8f2/0x1ca0
adjust\_reg\_min\_max\_vals+0x8ed/0x22e0
do\_check+0x1ca6/0x5d00
bpf\_check+0x9ca/0x2570
bpf\_prog\_load+0xc91/0x1030
\_\_se\_sys\_bpf+0x61e/0x1f00
do\_syscall\_64+0xc8/0x550
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
Fault injection trace:
 kfree+0xea/0x290
 free\_func\_state+0x4a/0x60
 free\_verifier\_state+0x61/0xe0
 push\_stack+0x216/0x2f0 <- inject failslab
 sanitize\_ptr\_alu+0x2b1/0x8d0
 adjust\_ptr\_min\_max\_vals+0x8f2/0x1ca0
 adjust\_reg\_min\_max\_vals+0x8ed/0x22e0
 do\_check+0x1ca6/0x5d00
 bpf\_check+0x9ca/0x2570
 bpf\_prog\_load+0xc91/0x1030
 \_\_se\_sys\_bpf+0x61e/0x1f00
 do\_syscall\_64+0xc8/0x550
 entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
When kzalloc() fails in push\_stack(), free\_verifier\_state() will free
current verifier state. As push\_stack() returns, dst\_reg was restored
if ptr\_is\_dst\_reg is false. However, as member of the cur\_state,
dst\_reg is also freed, and error occurs when dereferencing dst\_reg.
Simply fix it by testing ret of push\_stack() before restoring dst\_reg.
Fixes: 979d63d50c0c ("bpf: prevent out of bounds speculation on pointer arithmetic")
Signed-off-by: Xu Yu
Signed-off-by: Daniel Borkmann
Signed-off-by: Greg Kroah-Hartman
commit b54f0c4976e7fbf89246e3d298042992e7186c7c
Author: Sean Christopherson
Date: Mon Mar 11 20:01:05 2019 -0700
KVM: x86: update %rip after emulating IO
commit 45def77ebf79e2e8942b89ed79294d97ce914fa0 upstream.
Most (all?) x86 platforms provide a port IO based reset mechanism, e.g.
OUT 92h or CF9h. Userspace may emulate said mechanism, i.e. reset a
vCPU in response to KVM\_EXIT\_IO, without explicitly announcing to KVM
that it is doing a reset, e.g. Qemu jams vCPU state and resumes running.
To avoid corruping %rip after such a reset, commit 0967b7bf1c22 ("KVM:
Skip pio instruction when it is emulated, not executed") changed the
behavior of PIO handlers, i.e. today's "fast" PIO handling to skip the
instruction prior to exiting to userspace. Full emulation doesn't need
such tricks becase re-emulating the instruction will naturally handle
%rip being changed to point at the reset vector.
Updating %rip prior to executing to userspace has several drawbacks:
- Userspace sees the wrong %rip on the exit, e.g. if PIO emulation
fails it will likely yell about the wrong address.
- Single step exits to userspace for are effectively dropped as
KVM\_EXIT\_DEBUG is overwritten with KVM\_EXIT\_IO.
- Behavior of PIO emulation is different depending on whether it
goes down the fast path or the slow path.
Rather than skip the PIO instruction before exiting to userspace,
snapshot the linear %rip and cancel PIO completion if the current
value does not match the snapshot. For a 64-bit vCPU, i.e. the most
common scenario, the snapshot and comparison has negligible overhead
as VMCS.GUEST\_RIP will be cached regardless, i.e. there is no extra
VMREAD in this case.
All other alternatives to snapshotting the linear %rip that don't
rely on an explicit reset announcenment suffer from one corner case
or another. For example, canceling PIO completion on any write to
%rip fails if userspace does a save/restore of %rip, and attempting to
avoid that issue by canceling PIO only if %rip changed then fails if PIO
collides with the reset %rip. Attempting to zero in on the exact reset
vector won't work for APs, which means adding more hooks such as the
vCPU's MP\_STATE, and so on and so forth.
Checking for a linear %rip match technically suffers from corner cases,
e.g. userspace could theoretically rewrite the underlying code page and
expect a different instruction to execute, or the guest hardcodes a PIO
reset at 0xfffffff0, but those are far, far outside of what can be
considered normal operation.
Fixes: 432baf60eee3 ("KVM: VMX: use kvm\_fast\_pio\_in for handling IN I/O")
Cc:
Reported-by: Jim Mattson
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit cc3f680dd076706dd19c19af4a40f007ac55a2da
Author: Sean Christopherson
Date: Thu Mar 7 15:43:02 2019 -0800
KVM: x86: Emulate MSR\_IA32\_ARCH\_CAPABILITIES on AMD hosts
commit 0cf9135b773bf32fba9dd8e6699c1b331ee4b749 upstream.
The CPUID flag ARCH\_CAPABILITIES is unconditioinally exposed to host
userspace for all x86 hosts, i.e. KVM advertises ARCH\_CAPABILITIES
regardless of hardware support under the pretense that KVM fully
emulates MSR\_IA32\_ARCH\_CAPABILITIES. Unfortunately, only VMX hosts
handle accesses to MSR\_IA32\_ARCH\_CAPABILITIES (despite KVM\_GET\_MSRS
also reporting MSR\_IA32\_ARCH\_CAPABILITIES for all hosts).
Move the MSR\_IA32\_ARCH\_CAPABILITIES handling to common x86 code so
that it's emulated on AMD hosts.
Fixes: 1eaafe91a0df4 ("kvm: x86: IA32\_ARCH\_CAPABILITIES is always supported")
Cc: stable@vger.kernel.org
Reported-by: Xiaoyao Li
Cc: Jim Mattson
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit d50d46e303d49c7a7283c94cac1e576e479e4a27
Author: Sean Christopherson
Date: Fri Feb 15 12:48:39 2019 -0800
KVM: Reject device ioctls from processes other than the VM's creator
commit ddba91801aeb5c160b660caed1800eb3aef403f8 upstream.
KVM's API requires thats ioctls must be issued from the same process
that created the VM. In other words, userspace can play games with a
VM's file descriptors, e.g. fork(), SCM\_RIGHTS, etc..., but only the
creator can do anything useful. Explicitly reject device ioctls that
are issued by a process other than the VM's creator, and update KVM's
API documentation to extend its requirements to device ioctls.
Fixes: 852b6d57dc7f ("kvm: add device control API")
Cc:
Signed-off-by: Sean Christopherson
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 8c0823aa123b7b4cd5ebc9fbed324dbe4a37755d
Author: Thomas Gleixner
Date: Tue Mar 26 17:36:06 2019 +0100
x86/smp: Enforce CONFIG\_HOTPLUG\_CPU when SMP=y
commit bebd024e4815b1a170fcd21ead9c2222b23ce9e6 upstream.
The SMT disable 'nosmt' command line argument is not working properly when
CONFIG\_HOTPLUG\_CPU is disabled. The teardown of the sibling CPUs which are
required to be brought up due to the MCE issues, cannot work. The CPUs are
then kept in a half dead state.
As the 'nosmt' functionality has become popular due to the speculative
hardware vulnerabilities, the half torn down state is not a proper solution
to the problem.
Enforce CONFIG\_HOTPLUG\_CPU=y when SMP is enabled so the full operation is
possible.
Reported-by: Tianyu Lan
Signed-off-by: Thomas Gleixner
Acked-by: Greg Kroah-Hartman
Cc: Konrad Wilk
Cc: Josh Poimboeuf
Cc: Mukesh Ojha
Cc: Peter Zijlstra
Cc: Jiri Kosina
Cc: Rik van Riel
Cc: Andy Lutomirski
Cc: Micheal Kelley
Cc: "K. Y. Srinivasan"
Cc: Linus Torvalds
Cc: Borislav Petkov
Cc: K. Y. Srinivasan
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20190326163811.598166056@linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit c3bcf031466592a5d58eafae1d8df5bc4448122c
Author: Thomas Gleixner
Date: Tue Mar 26 17:36:05 2019 +0100
cpu/hotplug: Prevent crash when CPU bringup fails on CONFIG\_HOTPLUG\_CPU=n
commit 206b92353c839c0b27a0b9bec24195f93fd6cf7a upstream.
Tianyu reported a crash in a CPU hotplug teardown callback when booting a
kernel which has CONFIG\_HOTPLUG\_CPU disabled with the 'nosmt' boot
parameter.
It turns out that the SMP=y CONFIG\_HOTPLUG\_CPU=n case has been broken
forever in case that a bringup callback fails. Unfortunately this issue was
not recognized when the CPU hotplug code was reworked, so the shortcoming
just stayed in place.
When a bringup callback fails, the CPU hotplug code rolls back the
operation and takes the CPU offline.
The 'nosmt' command line argument uses a bringup failure to abort the
bringup of SMT sibling CPUs. This partial bringup is required due to the
MCE misdesign on Intel CPUs.
With CONFIG\_HOTPLUG\_CPU=y the rollback works perfectly fine, but
CONFIG\_HOTPLUG\_CPU=n lacks essential mechanisms to exercise the low level
teardown of a CPU including the synchronizations in various facilities like
RCU, NOHZ and others.
As a consequence the teardown callbacks which must be executed on the
outgoing CPU within stop machine with interrupts disabled are executed on
the control CPU in interrupt enabled and preemptible context causing the
kernel to crash and burn. The pre state machine code has a different
failure mode which is more subtle and resulting in a less obvious use after
free crash because the control side frees resources which are still in use
by the undead CPU.
But this is not a x86 only problem. Any architecture which supports the
SMP=y HOTPLUG\_CPU=n combination suffers from the same issue. It's just less
likely to be triggered because in 99.99999% of the cases all bringup
callbacks succeed.
The easy solution of making HOTPLUG\_CPU mandatory for SMP is not working on
all architectures as the following architectures have either no hotplug
support at all or not all subarchitectures support it:
alpha, arc, hexagon, openrisc, riscv, sparc (32bit), mips (partial).
Crashing the kernel in such a situation is not an acceptable state
either.
Implement a minimal rollback variant by limiting the teardown to the point
where all regular teardown callbacks have been invoked and leave the CPU in
the 'dead' idle state. This has the following consequences:
- the CPU is brought down to the point where the stop\_machine takedown
would happen.
- the CPU stays there forever and is idle
- The CPU is cleared in the CPU active mask, but not in the CPU online
mask which is a legit state.
- Interrupts are not forced away from the CPU
- All facilities which only look at online mask would still see it, but
that is the case during normal hotplug/unplug operations as well. It's
just a (way) longer time frame.
This will expose issues, which haven't been exposed before or only seldom,
because now the normally transient state of being non active but online is
a permanent state. In testing this exposed already an issue vs. work queues
where the vmstat code schedules work on the almost dead CPU which ends up
in an unbound workqueue and triggers 'preemtible context' warnings. This is
not a problem of this change, it merily exposes an already existing issue.
Still this is better than crashing fully without a chance to debug it.
This is mainly thought as workaround for those architectures which do not
support HOTPLUG\_CPU. All others should enforce HOTPLUG\_CPU for SMP.
Fixes: 2e1a3483ce74 ("cpu/hotplug: Split out the state walk into functions")
Reported-by: Tianyu Lan
Signed-off-by: Thomas Gleixner
Tested-by: Tianyu Lan
Acked-by: Greg Kroah-Hartman
Cc: Konrad Wilk
Cc: Josh Poimboeuf
Cc: Mukesh Ojha
Cc: Peter Zijlstra
Cc: Jiri Kosina
Cc: Rik van Riel
Cc: Andy Lutomirski
Cc: Micheal Kelley
Cc: "K. Y. Srinivasan"
Cc: Linus Torvalds
Cc: Borislav Petkov
Cc: K. Y. Srinivasan
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20190326163811.503390616@linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 53464ca9130be5466ada7b9dd653059c3a26cad9
Author: Thomas Gleixner
Date: Tue Mar 26 22:51:02 2019 +0100
watchdog: Respect watchdog cpumask on CPU hotplug
commit 7dd47617114921fdd8c095509e5e7b4373cc44a1 upstream.
The rework of the watchdog core to use cpu\_stop\_work broke the watchdog
cpumask on CPU hotplug.
The watchdog\_enable/disable() functions are now called unconditionally from
the hotplug callback, i.e. even on CPUs which are not in the watchdog
cpumask. As a consequence the watchdog can become unstoppable.
Only invoke them when the plugged CPU is in the watchdog cpumask.
Fixes: 9cf57731b63e ("watchdog/softlockup: Replace "watchdog/%u" threads with cpu\_stop\_work")
Reported-by: Maxime Coquelin
Signed-off-by: Thomas Gleixner
Tested-by: Maxime Coquelin
Cc: Peter Zijlstra
Cc: Oleg Nesterov
Cc: Michael Ellerman
Cc: Nicholas Piggin
Cc: Don Zickus
Cc: Ricardo Neri
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/alpine.DEB.2.21.1903262245490.1789@nanos.tec.linutronix.de
Signed-off-by: Greg Kroah-Hartman
commit 1a0ecfd4e633a3fb2e8914f73e599fbb775ad1d5
Author: Mahesh Salgaonkar
Date: Tue Mar 26 18:00:31 2019 +0530
powerpc/pseries/mce: Fix misleading print for TLB mutlihit
commit 6f845ebec2706841d15831fab3ffffcfd9e676fa upstream.
On pseries, TLB multihit are reported as D-Cache Multihit. This is because
the wrongly populated mc\_err\_types[] array. Per PAPR, TLB error type is 0x04
and mc\_err\_types[4] points to "D-Cache" instead of "TLB" string. Fixup the
mc\_err\_types[] array.
Machine check error type per PAPR:
0x00 = Uncorrectable Memory Error (UE)
0x01 = SLB error
0x02 = ERAT Error
0x04 = TLB error
0x05 = D-Cache error
0x07 = I-Cache error
Fixes: 8f0b80561f21 ("powerpc/pseries: Display machine check error details.")
Cc: stable@vger.kernel.org # v4.20+
Reported-by: Aneesh Kumar K.V
Signed-off-by: Mahesh Salgaonkar
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 4a2b2d5dc8fae21a52f86f9abc0857dfe6c88cb4
Author: Michael Ellerman
Date: Fri Mar 22 23:37:24 2019 +1100
powerpc/64: Fix memcmp reading past the end of src/dest
commit d9470757398a700d9450a43508000bcfd010c7a4 upstream.
Chandan reported that fstests' generic/026 test hit a crash:
BUG: Unable to handle kernel data access at 0xc00000062ac40000
Faulting instruction address: 0xc000000000092240
Oops: Kernel access of bad area, sig: 11 [#1]
LE SMP NR\_CPUS=2048 DEBUG\_PAGEALLOC NUMA pSeries
CPU: 0 PID: 27828 Comm: chacl Not tainted 5.0.0-rc2-next-20190115-00001-g6de6dba64dda #1
NIP: c000000000092240 LR: c00000000066a55c CTR: 0000000000000000
REGS: c00000062c0c3430 TRAP: 0300 Not tainted (5.0.0-rc2-next-20190115-00001-g6de6dba64dda)
MSR: 8000000002009033  CR: 44000842 XER: 20000000
CFAR: 00007fff7f3108ac DAR: c00000062ac40000 DSISR: 40000000 IRQMASK: 0
GPR00: 0000000000000000 c00000062c0c36c0 c0000000017f4c00 c00000000121a660
GPR04: c00000062ac3fff9 0000000000000004 0000000000000020 00000000275b19c4
GPR08: 000000000000000c 46494c4500000000 5347495f41434c5f c0000000026073a0
GPR12: 0000000000000000 c0000000027a0000 0000000000000000 0000000000000000
GPR16: 0000000000000000 0000000000000000 0000000000000000 0000000000000000
GPR20: c00000062ea70020 c00000062c0c38d0 0000000000000002 0000000000000002
GPR24: c00000062ac3ffe8 00000000275b19c4 0000000000000001 c00000062ac30000
GPR28: c00000062c0c38d0 c00000062ac30050 c00000062ac30058 0000000000000000
NIP memcmp+0x120/0x690
LR xfs\_attr3\_leaf\_lookup\_int+0x53c/0x5b0
Call Trace:
xfs\_attr3\_leaf\_lookup\_int+0x78/0x5b0 (unreliable)
xfs\_da3\_node\_lookup\_int+0x32c/0x5a0
xfs\_attr\_node\_addname+0x170/0x6b0
xfs\_attr\_set+0x2ac/0x340
\_\_xfs\_set\_acl+0xf0/0x230
xfs\_set\_acl+0xd0/0x160
set\_posix\_acl+0xc0/0x130
posix\_acl\_xattr\_set+0x68/0x110
\_\_vfs\_setxattr+0xa4/0x110
\_\_vfs\_setxattr\_noperm+0xac/0x240
vfs\_setxattr+0x128/0x130
setxattr+0x248/0x600
path\_setxattr+0x108/0x120
sys\_setxattr+0x28/0x40
system\_call+0x5c/0x70
Instruction dump:
7d201c28 7d402428 7c295040 38630008 38840008 408201f0 4200ffe8 2c050000
4182ff6c 20c50008 54c61838 7d201c28 <7d402428> 7d293436 7d4a3436 7c295040
The instruction dump decodes as:
subfic r6,r5,8
rlwinm r6,r6,3,0,28
ldbrx r9,0,r3
ldbrx r10,0,r4 <-
Which shows us doing an 8 byte load from c00000062ac3fff9, which
crosses the page boundary at c00000062ac40000 and faults.
It's not OK for memcmp to read past the end of the source or
destination buffers if that would cross a page boundary, because we
don't know that the next page is mapped.
As pointed out by Segher, we can read past the end of the source or
destination as long as we don't cross a 4K boundary, because that's
our minimum page size on all platforms.
The bug is in the code at the .Lcmp\_rest\_lt8bytes label. When we get
there we know that s1 is 8-byte aligned and we have at least 1 byte to
read, so a single 8-byte load won't read past the end of s1 and cross
a page boundary.
But we have to be more careful with s2. So check if it's within 8
bytes of a 4K boundary and if so go to the byte-by-byte loop.
Fixes: 2d9ee327adce ("powerpc/64: Align bytes before fall back to .Lshort in powerpc64 memcmp()")
Cc: stable@vger.kernel.org # v4.19+
Reported-by: Chandan Rajendra
Signed-off-by: Michael Ellerman
Reviewed-by: Segher Boessenkool
Tested-by: Chandan Rajendra
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit e92932ef286281c11d40b75b5a6cd64107ac8e8e
Author: Gautham R. Shenoy
Date: Fri Mar 8 21:03:24 2019 +0530
powerpc/pseries/energy: Use OF accessor functions to read ibm,drc-indexes
commit ce9afe08e71e3f7d64f337a6e932e50849230fc2 upstream.
In cpu\_to\_drc\_index() in the case when FW\_FEATURE\_DRC\_INFO is absent,
we currently use of\_read\_property() to obtain the pointer to the array
corresponding to the property "ibm,drc-indexes". The elements of this
array are of type \_\_be32, but are accessed without any conversion to
the OS-endianness, which is buggy on a Little Endian OS.
Fix this by using of\_property\_read\_u32\_index() accessor function to
safely read the elements of the array.
Fixes: e83636ac3334 ("pseries/drc-info: Search DRC properties for CPU indexes")
Cc: stable@vger.kernel.org # v4.16+
Reported-by: Pavithra R. Prakash
Signed-off-by: Gautham R. Shenoy
Reviewed-by: Vaidyanathan Srinivasan
[mpe: Make the WARN\_ON a WARN\_ON\_ONCE so it's not retriggerable]
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit 8f84f7daabb2fddfc5f81e9257e8c465b2a0caef
Author: Rolf Eike Beer
Date: Tue Mar 26 12:48:39 2019 -0500
objtool: Query pkg-config for libelf location
commit 056d28d135bca0b1d0908990338e00e9dadaf057 upstream.
If it is not in the default location, compilation fails at several points.
Signed-off-by: Rolf Eike Beer
Signed-off-by: Josh Poimboeuf
Signed-off-by: Thomas Gleixner
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/91a25e992566a7968fedc89ec80e7f4c83ad0548.1553622500.git.jpoimboe@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit a0de19f1c307e8e82add7660632857759a4ab814
Author: Adrian Hunter
Date: Mon Mar 25 15:51:35 2019 +0200
perf intel-pt: Fix TSC slip
commit f3b4e06b3bda759afd042d3d5fa86bea8f1fe278 upstream.
A TSC packet can slip past MTC packets so that the timestamp appears to
go backwards. One estimate is that can be up to about 40 CPU cycles,
which is certainly less than 0x1000 TSC ticks, but accept slippage an
order of magnitude more to be on the safe side.
Signed-off-by: Adrian Hunter
Cc: Jiri Olsa
Cc: stable@vger.kernel.org
Fixes: 79b58424b821c ("perf tools: Add Intel PT support for decoding MTC packets")
Link: http://lkml.kernel.org/r/20190325135135.18348-1-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit c9418d0addb0ddd91d14f3f86ce826af77945c3b
Author: Kan Liang
Date: Fri Mar 15 11:00:14 2019 -0700
perf pmu: Fix parser error for uncore event alias
commit e94d6b7f615e6dfbaf9fba7db6011db561461d0c upstream.
Perf fails to parse uncore event alias, for example:
# perf stat -e unc\_m\_clockticks -a --no-merge sleep 1
event syntax error: 'unc\_m\_clockticks'
\\_\_\_ parser error
Current code assumes that the event alias is from one specific PMU.
To find the PMU, perf strcmps the PMU name of event alias with the real
PMU name on the system.
However, the uncore event alias may be from multiple PMUs with common
prefix. The PMU name of uncore event alias is the common prefix.
For example, UNC\_M\_CLOCKTICKS is clock event for iMC, which include 6
PMUs with the same prefix "uncore\_imc" on a skylake server.
The real PMU names on the system for iMC are uncore\_imc\_0 ...
uncore\_imc\_5.
The strncmp is used to only check the common prefix for uncore event
alias.
With the patch:
# perf stat -e unc\_m\_clockticks -a --no-merge sleep 1
Performance counter stats for 'system wide':
723,594,722 unc\_m\_clockticks [uncore\_imc\_5]
724,001,954 unc\_m\_clockticks [uncore\_imc\_3]
724,042,655 unc\_m\_clockticks [uncore\_imc\_1]
724,161,001 unc\_m\_clockticks [uncore\_imc\_4]
724,293,713 unc\_m\_clockticks [uncore\_imc\_2]
724,340,901 unc\_m\_clockticks [uncore\_imc\_0]
1.002090060 seconds time elapsed
Signed-off-by: Kan Liang
Acked-by: Jiri Olsa
Cc: Andi Kleen
Cc: Thomas Richter
Cc: stable@vger.kernel.org
Fixes: ea1fa48c055f ("perf stat: Handle different PMU names with common prefix")
Link: http://lkml.kernel.org/r/1552672814-156173-1-git-send-email-kan.liang@linux.intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 8ad454a831e0da58230d4e2a1cd8c685f50f3d46
Author: Lars Persson
Date: Thu Mar 28 20:44:28 2019 -0700
mm/migrate.c: add missing flush\_dcache\_page for non-mapped page migrate
commit d2b2c6dd227ba5b8a802858748ec9a780cb75b47 upstream.
Our MIPS 1004Kc SoCs were seeing random userspace crashes with SIGILL
and SIGSEGV that could not be traced back to a userspace code bug. They
had all the magic signs of an I/D cache coherency issue.
Now recently we noticed that the /proc/sys/vm/compact\_memory interface
was quite efficient at provoking this class of userspace crashes.
Studying the code in mm/migrate.c there is a distinction made between
migrating a page that is mapped at the instant of migration and one that
is not mapped. Our problem turned out to be the non-mapped pages.
For the non-mapped page the code performs a copy of the page content and
all relevant meta-data of the page without doing the required D-cache
maintenance. This leaves dirty data in the D-cache of the CPU and on
the 1004K cores this data is not visible to the I-cache. A subsequent
page-fault that triggers a mapping of the page will happily serve the
process with potentially stale code.
What about ARM then, this bug should have seen greater exposure? Well
ARM became immune to this flaw back in 2010, see commit c01778001a4f
("ARM: 6379/1: Assume new page cache pages have dirty D-cache").
My proposed fix moves the D-cache maintenance inside move\_to\_new\_page to
make it common for both cases.
Link: http://lkml.kernel.org/r/20190315083502.11849-1-larper@axis.com
Fixes: 97ee0524614 ("flush cache before installing new page at migraton")
Signed-off-by: Lars Persson
Reviewed-by: Paul Burton
Acked-by: Mel Gorman
Cc: Ralf Baechle
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8a86a416c9483d8d08a90f7e8916ced7694941d9
Author: Qian Cai
Date: Thu Mar 28 20:44:21 2019 -0700
mm/page\_isolation.c: fix a wrong flag in set\_migratetype\_isolate()
commit f5777bc2d9cf0712554228b1a7927b6f13f5c1f0 upstream.
Due to has\_unmovable\_pages() taking an incorrect irqsave flag instead of
the isolation flag in set\_migratetype\_isolate(), there are issues with
HWPOSION and error reporting where dump\_page() is not called when there
is an unmovable page.
Link: http://lkml.kernel.org/r/20190320204941.53731-1-cai@lca.pw
Fixes: d381c54760dc ("mm: only report isolation failures when offlining memory")
Acked-by: Michal Hocko
Reviewed-by: Oscar Salvador
Signed-off-by: Qian Cai
Cc:  [5.0.x]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 77a5258a57e76fa444c018ef796e67eeee334128
Author: Qian Cai
Date: Thu Mar 28 20:44:16 2019 -0700
mm/memory\_hotplug.c: fix notification in offline error path
commit c4efe484b5f0d768e23c9731082fec827723e738 upstream.
When start\_isolate\_page\_range() returned -EBUSY in \_\_offline\_pages(), it
calls memory\_notify(MEM\_CANCEL\_OFFLINE, &arg) with an uninitialized
"arg". As the result, it triggers warnings below. Also, it is only
necessary to notify MEM\_CANCEL\_OFFLINE after MEM\_GOING\_OFFLINE.
page:ffffea0001200000 count:1 mapcount:0 mapping:0000000000000000
index:0x0
flags: 0x3fffe000001000(reserved)
raw: 003fffe000001000 ffffea0001200008 ffffea0001200008 0000000000000000
raw: 0000000000000000 0000000000000000 00000001ffffffff 0000000000000000
page dumped because: unmovable page
WARNING: CPU: 25 PID: 1665 at mm/kasan/common.c:665
kasan\_mem\_notifier+0x34/0x23b
CPU: 25 PID: 1665 Comm: bash Tainted: G W 5.0.0+ #94
Hardware name: HP ProLiant DL180 Gen9/ProLiant DL180 Gen9, BIOS U20
10/25/2017
RIP: 0010:kasan\_mem\_notifier+0x34/0x23b
RSP: 0018:ffff8883ec737890 EFLAGS: 00010206
RAX: 0000000000000246 RBX: ff10f0f4435f1000 RCX: f887a7a21af88000
RDX: dffffc0000000000 RSI: 0000000000000020 RDI: ffff8881f221af88
RBP: ffff8883ec737898 R08: ffff888000000000 R09: ffffffffb0bddcd0
R10: ffffed103e857088 R11: ffff8881f42b8443 R12: dffffc0000000000
R13: 00000000fffffff9 R14: dffffc0000000000 R15: 0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000560fbd31d730 CR3: 00000004049c6003 CR4: 00000000001606a0
Call Trace:
notifier\_call\_chain+0xbf/0x130
\_\_blocking\_notifier\_call\_chain+0x76/0xc0
blocking\_notifier\_call\_chain+0x16/0x20
memory\_notify+0x1b/0x20
\_\_offline\_pages+0x3e2/0x1210
offline\_pages+0x11/0x20
memory\_block\_action+0x144/0x300
memory\_subsys\_offline+0xe5/0x170
device\_offline+0x13f/0x1e0
state\_store+0xeb/0x110
dev\_attr\_store+0x3f/0x70
sysfs\_kf\_write+0x104/0x150
kernfs\_fop\_write+0x25c/0x410
\_\_vfs\_write+0x66/0x120
vfs\_write+0x15a/0x4f0
ksys\_write+0xd2/0x1b0
\_\_x64\_sys\_write+0x73/0xb0
do\_syscall\_64+0xeb/0xb78
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
RIP: 0033:0x7f14f75cc3b8
RSP: 002b:00007ffe84d01d68 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
RAX: ffffffffffffffda RBX: 0000000000000008 RCX: 00007f14f75cc3b8
RDX: 0000000000000008 RSI: 0000563f8e433d70 RDI: 0000000000000001
RBP: 0000563f8e433d70 R08: 000000000000000a R09: 00007ffe84d018f0
R10: 000000000000000a R11: 0000000000000246 R12: 00007f14f789e780
R13: 0000000000000008 R14: 00007f14f7899740 R15: 0000000000000008
Link: http://lkml.kernel.org/r/20190320204255.53571-1-cai@lca.pw
Fixes: 7960509329c2 ("mm, memory\_hotplug: print reason for the offlining failure")
Reviewed-by: Oscar Salvador
Acked-by: Michal Hocko
Signed-off-by: Qian Cai
Reviewed-by: Andrew Morton
Cc:  [5.0.x]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 2b57282beb606fc14ff67ff569bf0280cf0eb9c4
Author: Oscar Salvador
Date: Thu Mar 28 20:44:01 2019 -0700
mm/debug.c: fix \_\_dump\_page when mapping->host is not set
commit 5ae2efb1dea9f537453e841714e3ee2757595aec upstream.
While debugging something, I added a dump\_page() into do\_swap\_page(),
and I got the splat from below. The issue happens when dereferencing
mapping->host in \_\_dump\_page():
...
else if (mapping) {
pr\_warn("%ps ", mapping->a\_ops);
if (mapping->host->i\_dentry.first) {
struct dentry \*dentry;
dentry = container\_of(mapping->host->i\_dentry.first, struct dentry, d\_u.d\_alias);
pr\_warn("name:\"%pd\" ", dentry);
}
}
...
Swap address space does not contain an inode information, and so
mapping->host equals NULL.
Although the dump\_page() call was added artificially into
do\_swap\_page(), I am not sure if we can hit this from any other path, so
it looks worth fixing it. We can easily do that by checking
mapping->host first.
Link: http://lkml.kernel.org/r/20190318072931.29094-1-osalvador@suse.de
Fixes: 1c6fb1d89e73c ("mm: print more information about mapping in \_\_dump\_page")
Signed-off-by: Oscar Salvador
Acked-by: Michal Hocko
Acked-by: Hugh Dickins
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 8b2f31de5d159d93cd8c1bf7491c2fcc0e9b4777
Author: Yang Shi
Date: Thu Mar 28 20:43:55 2019 -0700
mm: mempolicy: make mbind() return -EIO when MPOL\_MF\_STRICT is specified
commit a7f40cfe3b7ada57af9b62fd28430eeb4a7cfcb7 upstream.
When MPOL\_MF\_STRICT was specified and an existing page was already on a
node that does not follow the policy, mbind() should return -EIO. But
commit 6f4576e3687b ("mempolicy: apply page table walker on
queue\_pages\_range()") broke the rule.
And commit c8633798497c ("mm: mempolicy: mbind and migrate\_pages support
thp migration") didn't return the correct value for THP mbind() too.
If MPOL\_MF\_STRICT is set, ignore vma\_migratable() to make sure it
reaches queue\_pages\_to\_pte\_range() or queue\_pages\_pmd() to check if an
existing page was already on a node that does not follow the policy.
And, non-migratable vma may be used, return -EIO too if MPOL\_MF\_MOVE or
MPOL\_MF\_MOVE\_ALL was specified.
Tested with https://github.com/metan-ucw/ltp/blob/master/testcases/kernel/syscalls/mbind/mbind02.c
[akpm@linux-foundation.org: tweak code comment]
Link: http://lkml.kernel.org/r/1553020556-38583-1-git-send-email-yang.shi@linux.alibaba.com
Fixes: 6f4576e3687b ("mempolicy: apply page table walker on queue\_pages\_range()")
Signed-off-by: Yang Shi
Signed-off-by: Oscar Salvador
Reported-by: Cyril Hrubis
Suggested-by: Kirill A. Shutemov
Acked-by: Rafael Aquini
Reviewed-by: Oscar Salvador
Acked-by: David Rientjes
Cc: Vlastimil Babka
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 467c01f2deea01553509f687bd29148d73f7bb8d
Author: Nicolas Boichat
Date: Thu Mar 28 20:43:46 2019 -0700
iommu/io-pgtable-arm-v7s: request DMA32 memory, and improve debugging
commit 0a352554da69b02f75ca3389c885c741f1f63235 upstream.
IOMMUs using ARMv7 short-descriptor format require page tables (level 1
and 2) to be allocated within the first 4GB of RAM, even on 64-bit
systems.
For level 1/2 pages, ensure GFP\_DMA32 is used if CONFIG\_ZONE\_DMA32 is
defined (e.g. on arm64 platforms).
For level 2 pages, allocate a slab cache in SLAB\_CACHE\_DMA32. Note that
we do not explicitly pass GFP\_DMA[32] to kmem\_cache\_zalloc, as this is
not strictly necessary, and would cause a warning in mm/sl\*b.c, as we
did not update GFP\_SLAB\_BUG\_MASK.
Also, print an error when the physical address does not fit in
32-bit, to make debugging easier in the future.
Link: http://lkml.kernel.org/r/20181210011504.122604-3-drinkcat@chromium.org
Fixes: ad67f5a6545f ("arm64: replace ZONE\_DMA with ZONE\_DMA32")
Signed-off-by: Nicolas Boichat
Acked-by: Will Deacon
Cc: Christoph Hellwig
Cc: Christoph Lameter
Cc: David Rientjes
Cc: Hsin-Yi Wang
Cc: Huaisheng Ye
Cc: Joerg Roedel
Cc: Joonsoo Kim
Cc: Matthew Wilcox
Cc: Matthias Brugger
Cc: Mel Gorman
Cc: Michal Hocko
Cc: Mike Rapoport
Cc: Pekka Enberg
Cc: Robin Murphy
Cc: Sasha Levin
Cc: Tomasz Figa
Cc: Vlastimil Babka
Cc: Yingjoe Chen
Cc: Yong Wu
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit ed3886c7d9f214a55bf0410bbca3c77001236b5d
Author: Nicolas Boichat
Date: Thu Mar 28 20:43:42 2019 -0700
mm: add support for kmem caches in DMA32 zone
commit 6d6ea1e967a246f12cfe2f5fb743b70b2e608d4a upstream.
Patch series "iommu/io-pgtable-arm-v7s: Use DMA32 zone for page tables",
v6.
This is a followup to the discussion in [1], [2].
IOMMUs using ARMv7 short-descriptor format require page tables (level 1
and 2) to be allocated within the first 4GB of RAM, even on 64-bit
systems.
For L1 tables that are bigger than a page, we can just use
\_\_get\_free\_pages with GFP\_DMA32 (on arm64 systems only, arm would still
use GFP\_DMA).
For L2 tables that only take 1KB, it would be a waste to allocate a full
page, so we considered 3 approaches:
1. This series, adding support for GFP\_DMA32 slab caches.
2. genalloc, which requires pre-allocating the maximum number of L2 page
tables (4096, so 4MB of memory).
3. page\_frag, which is not very memory-efficient as it is unable to reuse
freed fragments until the whole page is freed. [3]
This series is the most memory-efficient approach.
stable@ note:
We confirmed that this is a regression, and IOMMU errors happen on 4.19
and linux-next/master on MT8173 (elm, Acer Chromebook R13). The issue
most likely starts from commit ad67f5a6545f ("arm64: replace ZONE\_DMA
with ZONE\_DMA32"), i.e. 4.15, and presumably breaks a number of Mediatek
platforms (and maybe others?).
[1] https://lists.linuxfoundation.org/pipermail/iommu/2018-November/030876.html
[2] https://lists.linuxfoundation.org/pipermail/iommu/2018-December/031696.html
[3] https://patchwork.codeaurora.org/patch/671639/
This patch (of 3):
IOMMUs using ARMv7 short-descriptor format require page tables to be
allocated within the first 4GB of RAM, even on 64-bit systems. On arm64,
this is done by passing GFP\_DMA32 flag to memory allocation functions.
For IOMMU L2 tables that only take 1KB, it would be a waste to allocate
a full page using get\_free\_pages, so we considered 3 approaches:
1. This patch, adding support for GFP\_DMA32 slab caches.
2. genalloc, which requires pre-allocating the maximum number of L2
page tables (4096, so 4MB of memory).
3. page\_frag, which is not very memory-efficient as it is unable
to reuse freed fragments until the whole page is freed.
This change makes it possible to create a custom cache in DMA32 zone using
kmem\_cache\_create, then allocate memory using kmem\_cache\_alloc.
We do not create a DMA32 kmalloc cache array, as there are currently no
users of kmalloc(..., GFP\_DMA32). These calls will continue to trigger a
warning, as we keep GFP\_DMA32 in GFP\_SLAB\_BUG\_MASK.
This implies that calls to kmem\_cache\_\*alloc on a SLAB\_CACHE\_DMA32
kmem\_cache must \_not\_ use GFP\_DMA32 (it is anyway redundant and
unnecessary).
Link: http://lkml.kernel.org/r/20181210011504.122604-2-drinkcat@chromium.org
Signed-off-by: Nicolas Boichat
Acked-by: Vlastimil Babka
Acked-by: Will Deacon
Cc: Robin Murphy
Cc: Joerg Roedel
Cc: Christoph Lameter
Cc: Pekka Enberg
Cc: David Rientjes
Cc: Joonsoo Kim
Cc: Michal Hocko
Cc: Mel Gorman
Cc: Sasha Levin
Cc: Huaisheng Ye
Cc: Mike Rapoport
Cc: Yong Wu
Cc: Matthias Brugger
Cc: Tomasz Figa
Cc: Yingjoe Chen
Cc: Christoph Hellwig
Cc: Matthew Wilcox
Cc: Hsin-Yi Wang
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit eef9dbbad03f3d83ea3bbfb3da249c60d6798a41
Author: Qian Cai
Date: Thu Mar 28 20:43:34 2019 -0700
mm/hotplug: fix offline undo\_isolate\_page\_range()
commit 9b7ea46a82b31c74a37e6ff1c2a1df7d53e392ab upstream.
Commit f1dd2cd13c4b ("mm, memory\_hotplug: do not associate hotadded
memory to zones until online") introduced move\_pfn\_range\_to\_zone() which
calls memmap\_init\_zone() during onlining a memory block.
memmap\_init\_zone() will reset pagetype flags and makes migrate type to
be MOVABLE.
However, in \_\_offline\_pages(), it also call undo\_isolate\_page\_range()
after offline\_isolated\_pages() to do the same thing. Due to commit
2ce13640b3f4 ("mm: \_\_first\_valid\_page skip over offline pages") changed
\_\_first\_valid\_page() to skip offline pages, undo\_isolate\_page\_range()
here just waste CPU cycles looping around the offlining PFN range while
doing nothing, because \_\_first\_valid\_page() will return NULL as
offline\_isolated\_pages() has already marked all memory sections within
the pfn range as offline via offline\_mem\_sections().
Also, after calling the "useless" undo\_isolate\_page\_range() here, it
reaches the point of no returning by notifying MEM\_OFFLINE. Those pages
will be marked as MIGRATE\_MOVABLE again once onlining. The only thing
left to do is to decrease the number of isolated pageblocks zone counter
which would make some paths of the page allocation slower that the above
commit introduced.
Even if alloc\_contig\_range() can be used to isolate 16GB-hugetlb pages
on ppc64, an "int" should still be enough to represent the number of
pageblocks there. Fix an incorrect comment along the way.
[cai@lca.pw: v4]
Link: http://lkml.kernel.org/r/20190314150641.59358-1-cai@lca.pw
Link: http://lkml.kernel.org/r/20190313143133.46200-1-cai@lca.pw
Fixes: 2ce13640b3f4 ("mm: \_\_first\_valid\_page skip over offline pages")
Signed-off-by: Qian Cai
Acked-by: Michal Hocko
Reviewed-by: Oscar Salvador
Cc: Vlastimil Babka
Cc:  [4.13+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit d26254c4e7cac57dba44b8f3091bbda098a9bc32
Author: Gustavo A. R. Silva
Date: Mon Mar 18 16:18:30 2019 -0500
usb: typec: Fix unchecked return value
commit e82adc1074a7356f1158233551df9e86b7ebfb82 upstream.
Currently there is no check on platform\_get\_irq() return value
in case it fails, hence never actually reporting any errors and
causing unexpected behavior when using such value as argument
for function regmap\_irq\_get\_virq().
Fix this by adding a proper check, a message error and return
\*irq\* in case platform\_get\_irq() fails.
Addresses-Coverity-ID: 1443899 ("Improper use of negative value")
Fixes: d2061f9cc32d ("usb: typec: add driver for Intel Whiskey Cove PMIC USB Type-C PHY")
Cc: stable@vger.kernel.org
Signed-off-by: Gustavo A. R. Silva
Reviewed-by: Guenter Roeck
Acked-by: Heikki Krogerus
Signed-off-by: Greg Kroah-Hartman
commit a3bed8b549ec88b0cb39fb901cbd6dd3addb6566
Author: Hans de Goede
Date: Sat Mar 16 16:57:12 2019 +0100
usb: typec: tcpm: Try PD-2.0 if sink does not respond to 3.0 source-caps
commit 976daf9d1199932df80e7b04546d1a1bd4ed5ece upstream.
PD 2.0 sinks are supposed to accept src-capabilities with a 3.0 header and
simply ignore any src PDOs which the sink does not understand such as PPS
but some 2.0 sinks instead ignore the entire PD\_DATA\_SOURCE\_CAP message,
causing contract negotiation to fail.
This commit fixes such sinks not working by re-trying the contract
negotiation with PD-2.0 source-caps messages if we don't have a contract
after PD\_N\_HARD\_RESET\_COUNT hard-reset attempts.
The problem fixed by this commit was noticed with a Type-C to VGA dongle.
Signed-off-by: Hans de Goede
Reviewed-by: Guenter Roeck
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 402f57808b9ab2e0183c8a7feb7a74f090a12395
Author: Romain Izard
Date: Fri Mar 22 16:53:02 2019 +0100
usb: cdc-acm: fix race during wakeup blocking TX traffic
commit 93e1c8a638308980309e009cc40b5a57ef87caf1 upstream.
When the kernel is compiled with preemption enabled, the URB completion
handler can run in parallel with the work responsible for waking up the
tty layer. If the URB handler sets the EVENT\_TTY\_WAKEUP bit during the
call to tty\_port\_tty\_wakeup() to signal that there is room for additional
input, it will be cleared at the end of this call. As a result, TX traffic
on the upper layer will be blocked.
This can be seen with a kernel configured with CONFIG\_PREEMPT, and a fast
modem connected with PPP running over a USB CDC-ACM port.
Use test\_and\_clear\_bit() instead, which ensures that each wakeup requested
by the URB completion code will trigger a call to tty\_port\_tty\_wakeup().
Fixes: 1aba579f3cf5 cdc-acm: handle read pipe errors
Signed-off-by: Romain Izard
Cc: stable
Acked-by: Oliver Neukum
Signed-off-by: Greg Kroah-Hartman
commit c7a5ef0d64f42d09843e023a82d5ed1e4a495d6e
Author: Mathias Nyman
Date: Fri Mar 22 17:50:17 2019 +0200
xhci: Don't let USB3 ports stuck in polling state prevent suspend
commit d92f2c59cc2cbca6bfb2cc54882b58ba76b15fd4 upstream.
Commit 2f31a67f01a8 ("usb: xhci: Prevent bus suspend if a port connect
change or polling state is detected") was intended to prevent ports that
were still link training from being forced to U3 suspend state mid
enumeration.
This solved enumeration issues for devices with slow link training.
Turns out some devices are stuck in the link training/polling state,
and thus that patch will prevent suspend completely for these devices.
This is seen with USB3 card readers in some MacBooks.
Instead of preventing suspend, give some time to complete the link
training. On successful training the port will end up as connected
and enabled.
If port instead is stuck in link training the bus suspend will continue
suspending after 360ms (10 \* 36ms) timeout (tPollingLFPSTimeout).
Original patch was sent to stable, this one should go there as well
Fixes: 2f31a67f01a8 ("usb: xhci: Prevent bus suspend if a port connect change or polling state is detected")
Cc: stable@vger.kernel.org
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 448c39c360ef7493a6d4aecd1f1650a80c754081
Author: Mathias Nyman
Date: Fri Mar 22 17:50:16 2019 +0200
usb: xhci: dbc: Don't free all memory with spinlock held
commit 8867ea262196a6945c24a0fb739575af646ec0e9 upstream.
The xhci debug capability (DbC) feature did its memory cleanup with
spinlock held. dma\_free\_coherent() warns if called with interrupts
disabled
move the memory cleanup outside the spinlock
Cc: stable
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit c08a998dec55453b0e2f649d97ce5704dceeb4d4
Author: Mathias Nyman
Date: Fri Mar 22 17:50:15 2019 +0200
xhci: Fix port resume done detection for SS ports with LPM enabled
commit 6cbcf596934c8e16d6288c7cc62dfb7ad8eadf15 upstream.
A suspended SS port in U3 link state will go to U0 when resumed, but
can almost immediately after that enter U1 or U2 link power save
states before host controller driver reads the port status.
Host controller driver only checks for U0 state, and might miss
the finished resume, leaving flags unclear and skip notifying usb
code of the wake.
Add U1 and U2 to the possible link states when checking for finished
port resume.
Cc: stable
Signed-off-by: Mathias Nyman
Signed-off-by: Greg Kroah-Hartman
commit 8e70eae1816b96cee4b4ea35c2efed79a3f671fd
Author: Yasushi Asano
Date: Mon Feb 18 11:26:34 2019 +0100
usb: host: xhci-rcar: Add XHCI\_TRUST\_TX\_LENGTH quirk
commit 40fc165304f0faaae78b761f8ee30b5d216b1850 upstream.
When plugging BUFFALO LUA4-U3-AGT USB3.0 to Gigabit Ethernet LAN
Adapter, warning messages filled up dmesg.
[ 101.098287] xhci-hcd ee000000.usb: WARN Successful completion on short TX for slot 1 ep 4: needs XHCI\_TRUST\_TX\_LENGTH quirk?
[ 101.117463] xhci-hcd ee000000.usb: WARN Successful completion on short TX for slot 1 ep 4: needs XHCI\_TRUST\_TX\_LENGTH quirk?
[ 101.136513] xhci-hcd ee000000.usb: WARN Successful completion on short TX for slot 1 ep 4: needs XHCI\_TRUST\_TX\_LENGTH quirk?
Adding the XHCI\_TRUST\_TX\_LENGTH quirk resolves the issue.
Signed-off-by: Yasushi Asano
Signed-off-by: Spyridon Papageorgiou
Acked-by: Yoshihiro Shimoda
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 40b8282f9009a97c87c453ec9da4274ad4f761a9
Author: Jan Kara
Date: Thu Mar 28 20:43:19 2019 -0700
mm/memory.c: fix modifying of page protection by insert\_pfn()
commit cae85cb8add35f678cf487139d05e083ce2f570a upstream.
Aneesh has reported that PPC triggers the following warning when
excercising DAX code:
IP set\_pte\_at+0x3c/0x190
LR insert\_pfn+0x208/0x280
Call Trace:
insert\_pfn+0x68/0x280
dax\_iomap\_pte\_fault.isra.7+0x734/0xa40
\_\_xfs\_filemap\_fault+0x280/0x2d0
do\_wp\_page+0x48c/0xa40
\_\_handle\_mm\_fault+0x8d0/0x1fd0
handle\_mm\_fault+0x140/0x250
\_\_do\_page\_fault+0x300/0xd60
handle\_page\_fault+0x18
Now that is WARN\_ON in set\_pte\_at which is
VM\_WARN\_ON(pte\_hw\_valid(\*ptep) && !pte\_protnone(\*ptep));
The problem is that on some architectures set\_pte\_at() cannot cope with
a situation where there is already some (different) valid entry present.
Use ptep\_set\_access\_flags() instead to modify the pfn which is built to
deal with modifying existing PTE.
Link: http://lkml.kernel.org/r/20190311084537.16029-1-jack@suse.cz
Fixes: b2770da64254 "mm: add vm\_insert\_mixed\_mkwrite()"
Signed-off-by: Jan Kara
Reported-by: "Aneesh Kumar K.V"
Reviewed-by: Aneesh Kumar K.V
Acked-by: Dan Williams
Cc: Chandan Rajendra
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 08213ad7465f5b91937370d1e2b32d9c0425fe7f
Author: Fabrizio Castro
Date: Fri Mar 1 11:05:45 2019 +0000
usb: common: Consider only available nodes for dr\_mode
commit 238e0268c82789e4c107a37045d529a6dbce51a9 upstream.
There are cases where multiple device tree nodes point to the
same phy node by means of the "phys" property, but we should
only consider those nodes that are marked as available rather
than just any node.
Fixes: 98bfb3946695 ("usb: of: add an api to get dr\_mode by the phy node")
Cc: stable@vger.kernel.org # v4.4+
Signed-off-by: Fabrizio Castro
Signed-off-by: Greg Kroah-Hartman
commit 80ff12631ba5589cbfbfa8ee8b965cc1787cb0e0
Author: Radoslav Gerganov
Date: Tue Mar 5 10:10:34 2019 +0000
USB: gadget: f\_hid: fix deadlock in f\_hidg\_write()
commit 072684e8c58d17e853f8e8b9f6d9ce2e58d2b036 upstream.
In f\_hidg\_write() the write\_spinlock is acquired before calling
usb\_ep\_queue() which causes a deadlock when dummy\_hcd is being used.
This is because dummy\_queue() callbacks into f\_hidg\_req\_complete() which
tries to acquire the same spinlock. This is (part of) the backtrace when
the deadlock occurs:
0xffffffffc06b1410 in f\_hidg\_req\_complete
0xffffffffc06a590a in usb\_gadget\_giveback\_request
0xffffffffc06cfff2 in dummy\_queue
0xffffffffc06a4b96 in usb\_ep\_queue
0xffffffffc06b1eb6 in f\_hidg\_write
0xffffffff8127730b in \_\_vfs\_write
0xffffffff812774d1 in vfs\_write
0xffffffff81277725 in SYSC\_write
Fix this by releasing the write\_spinlock before calling usb\_ep\_queue()
Reviewed-by: James Bottomley
Tested-by: James Bottomley
Cc: stable@vger.kernel.org # 4.11+
Fixes: 749494b6bdbb ("usb: gadget: f\_hid: fix: Move IN request allocation to set\_alt()")
Signed-off-by: Radoslav Gerganov
Signed-off-by: Felipe Balbi
Signed-off-by: Greg Kroah-Hartman
commit 8f00b32d3991124e31212f32791ed9024fb26b56
Author: Arnd Bergmann
Date: Mon Mar 25 14:54:30 2019 +0100
usb: mtu3: fix EXTCON dependency
commit 3d54d10c6afed34fd45b852bf76f55e8da31d8ef upstream.
When EXTCON is a loadable module, mtu3 fails to link as built-in:
drivers/usb/mtu3/mtu3\_plat.o: In function `mtu3\_probe':
mtu3\_plat.c:(.text+0x690): undefined reference to `extcon\_get\_edev\_by\_phandle'
Add a Kconfig dependency to force mtu3 also to be a loadable module
if extconn is, but still allow it to be built without extcon.
Fixes: d0ed062a8b75 ("usb: mtu3: dual-role mode support")
Signed-off-by: Arnd Bergmann
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit dbc206874d67cd713103bac0124974e34311aad1
Author: Chen-Yu Tsai
Date: Fri Mar 22 16:51:07 2019 +0800
phy: sun4i-usb: Support set\_mode to USB\_HOST for non-OTG PHYs
commit 1396929e8a903db80425343cacca766a18ad6409 upstream.
While only the first PHY supports mode switching, the remaining PHYs
work in USB host mode. They should support set\_mode with mode=USB\_HOST
instead of failing. This is especially needed now that the USB core does
set\_mode for all USB ports, which was added in commit b97a31348379 ("usb:
core: comply to PHY framework").
Make set\_mode with mode=USB\_HOST a no-op instead of failing for the
non-OTG USB PHYs.
Fixes: 6ba43c291961 ("phy-sun4i-usb: Add support for phy\_set\_mode")
Signed-off-by: Chen-Yu Tsai
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 494d26aa39158a67e6cb4af4a7aa11f1d172dac9
Author: Axel Lin
Date: Mon Mar 11 21:29:37 2019 +0800
gpio: adnp: Fix testing wrong value in adnp\_gpio\_direction\_input
commit c5bc6e526d3f217ed2cc3681d256dc4a2af4cc2b upstream.
Current code test wrong value so it does not verify if the written
data is correctly read back. Fix it.
Also make it return -EPERM if read value does not match written bit,
just like it done for adnp\_gpio\_direction\_output().
Fixes: 5e969a401a01 ("gpio: Add Avionic Design N-bit GPIO expander support")
Cc:
Signed-off-by: Axel Lin
Reviewed-by: Thierry Reding
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit aa2250dec6ee534dc977d24557c27de80e5604ad
Author: Kangjie Lu
Date: Fri Mar 8 22:07:57 2019 -0600
gpio: exar: add a check for the return value of ida\_simple\_get fails
commit 7ecced0934e574b528a1ba6c237731e682216a74 upstream.
ida\_simple\_get may fail and return a negative error number.
The fix checks its return value; if it fails, go to err\_destroy.
Cc:
Signed-off-by: Kangjie Lu
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Greg Kroah-Hartman
commit 673bc99a67087ef7189724ae59cc73da16ccb65c
Author: Manasi Navare
Date: Tue Mar 19 15:18:47 2019 -0700
drm/i915/icl: Fix the TRANS\_DDI\_FUNC\_CTL2 bitfield macro
commit 69903dfae0310afe8a15f5cd4e376ebb7c6da1d2 upstream.
This patch fixes the PORT\_SYNC\_MODE\_MASTER\_SELECT macro
to correctly do the left shifting to set the port sync
master select correctly.
I have tested this fix on ICL.
Fixes: 49edbd49786e ("drm/i915/icl: Define TRANS\_DDI\_FUNC\_CTL DSI registers")
Cc: Madhav Chauhan
Cc: Jani Nikula
Cc:  # v5.0+
Signed-off-by: Manasi Navare
Reviewed-by: Jani Nikula
Link: https://patchwork.freedesktop.org/patch/msgid/20190319221847.21311-1-manasi.d.navare@intel.com
(cherry picked from commit 7264aebb81d15aa6bbed650c816bba90f026bc35)
Signed-off-by: Rodrigo Vivi
Signed-off-by: Greg Kroah-Hartman
commit 25c939a9a594a1afd4de1dfc85a22cd9de0b73be
Author: Zhenyu Wang
Date: Wed Feb 20 16:25:04 2019 +0800
drm/i915/gvt: Fix MI\_FLUSH\_DW parsing with correct index check
commit 13bcb80b7ee79431fce361e060611134cb19e209 upstream.
When MI\_FLUSH\_DW post write hw status page in index mode, the index
value is in dword step and turned into address offset in cmd dword1.
As status page size is 4K, so can't exceed that.
This fixed upper bound check in cmd parser code which incorrectly
stopped VM for reason of invalid MI\_FLUSH\_DW write index.
v2:
- Fix upper bound as 4K page size because index value is address offset.
Fixes: be1da7070aea ("drm/i915/gvt: vGPU command scanner")
Cc: stable@vger.kernel.org # v4.10+
Cc: "Zhao, Yan Y"
Reviewed-by: Yan Zhao
Signed-off-by: Zhenyu Wang
Signed-off-by: Greg Kroah-Hartman
commit 9241bd9b6401d901f29c2625a00cf6df18d45fc9
Author: Ville Syrjälä
Date: Fri Mar 22 22:49:44 2019 +0200
drm/i915: Mark AML 0x87CA as ULX
commit 4b9a3932e7ba929baa231231e61874c7a56f8959 upstream.
If I'm reading the spec right AML 0x87CA is a Y SKU, so it
should be marked as ULX in our old style terminology.
Cc: stable@vger.kernel.org
Cc: José Roberto de Souza
Cc: Rodrigo Vivi
Cc: Tvrtko Ursulin
Fixes: c0c46ca461f1 ("drm/i915/aml: Add new Amber Lake PCI ID")
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20190322204944.23613-1-ville.syrjala@linux.intel.com
Reviewed-by: José Roberto de Souza
(cherry picked from commit 57b1c4460dc46a00f6ec439f3f11d670736b0209)
Signed-off-by: Jani Nikula
Signed-off-by: Greg Kroah-Hartman
commit 0baddc2099dd1a7f6f5a8696da46f3839faf04a4
Author: Eric Biggers
Date: Tue Feb 26 14:08:58 2019 -0800
drm/vkms: fix use-after-free when drm\_gem\_handle\_create() fails
commit 36b6c9ed45afe89045973e8dee1b004dd5372d40 upstream.
If drm\_gem\_handle\_create() fails in vkms\_gem\_create(), then the
vkms\_gem\_object is freed twice: once when the reference is dropped by
drm\_gem\_object\_put\_unlocked(), and again by the extra calls to
drm\_gem\_object\_release() and kfree().
Fix it by skipping the second release and free.
This bug was originally found in the vgem driver by syzkaller using
fault injection, but I noticed it's also present in the vkms driver.
Fixes: 559e50fd34d1 ("drm/vkms: Add dumb operations")
Cc: Rodrigo Siqueira
Cc: Haneen Mohammed
Cc: Daniel Vetter
Cc: Chris Wilson
Cc: stable@vger.kernel.org
Signed-off-by: Eric Biggers
Reviewed-by: Chris Wilson
Reviewed-by: Rodrigo Siqueira
Signed-off-by: Rodrigo Siqueira
Link: https://patchwork.freedesktop.org/patch/msgid/20190226220858.214438-1-ebiggers@kernel.org
Signed-off-by: Maxime Ripard
Signed-off-by: Greg Kroah-Hartman
commit 18e8f0f379a58a7d5aa61da50e201861dfe8554d
Author: Eric Biggers
Date: Tue Feb 26 13:44:51 2019 -0800
drm/vgem: fix use-after-free when drm\_gem\_handle\_create() fails
commit 21d2b122732318b48c10b7262e15595ce54511d3 upstream.
If drm\_gem\_handle\_create() fails in vgem\_gem\_create(), then the
drm\_vgem\_gem\_object is freed twice: once when the reference is dropped
by drm\_gem\_object\_put\_unlocked(), and again by \_\_vgem\_gem\_destroy().
This was hit by syzkaller using fault injection.
Fix it by skipping the second free.
Reported-by: syzbot+e73f2fb5ed5a5df36d33@syzkaller.appspotmail.com
Fixes: af33a9190d02 ("drm/vgem: Enable dmabuf import interfaces")
Reviewed-by: Chris Wilson
Cc: Laura Abbott
Cc: Daniel Vetter
Cc: stable@vger.kernel.org
Signed-off-by: Eric Biggers
Acked-by: Laura Abbott
Signed-off-by: Rodrigo Siqueira
Link: https://patchwork.freedesktop.org/patch/msgid/20190226214451.195123-1-ebiggers@kernel.org
Signed-off-by: Maxime Ripard
Signed-off-by: Greg Kroah-Hartman
commit 5f0bf5cd357db62bbbd2b7ba046dbf8b95ea47b6
Author: Vincent Stehlé
Date: Wed Mar 27 23:06:42 2019 +0100
cpufreq: scpi: Fix use after free
commit 31d4c528cea4023cf36f6148c03bb960cedefeef upstream.
Free the priv structure only after we are done using it.
Fixes: 1690d8bb91e370ab ("cpufreq: scpi/scmi: Fix freeing of dynamic OPPs")
Signed-off-by: Vincent Stehlé
Cc: 4.20+  # 4.20+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 7466a2abe75765daf7d00ada675d2f082f5ece2c
Author: Srinivas Pandruvada
Date: Mon Mar 25 09:04:40 2019 -0700
cpufreq: intel\_pstate: Also use CPPC nominal\_perf for base\_frequency
commit 92a3e426ec06e72b1c363179c79d30712447ff76 upstream.
The ACPI specification states that if the "Guaranteed Performance
Register" is not implemented, the OSPM assumes guaranteed performance
to always be equal to nominal performance.
So for invalid or unimplemented guaranteed performance register, use
nominal performance as guaranteed performance.
This change will fall back to nominal\_perf when guranteed\_perf is
invalid. If nominal\_perf is also invalid or not present, fall back
to the existing implementation, which is to read from HWP Capabilities
MSR.
Fixes: 86d333a8cc7f ("cpufreq: intel\_pstate: Add base\_frequency attribute")
Suggested-by: Rafael J. Wysocki
Signed-off-by: Srinivas Pandruvada
Cc: 4.20+  # 4.20+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 0dcb45879a5f6bbb412e232adf2d29a98119c889
Author: Jens Axboe
Date: Mon Mar 25 12:34:10 2019 -0600
blk-mq: fix sbitmap ws\_active for shared tags
commit e861857545567adec8da3bdff728efdf7db12285 upstream.
We now wrap sbitmap waitqueues in an active counter, so we can avoid
iterating wakeups unless we have waiters there. This works as long as
everyone that's manipulating the waitqueues use the proper helpers. For
the tag wait case for shared tags, however, we add ourselves to the
waitqueue without incrementing/decrementing the ->ws\_active count. This
means that wakeups can take a long time to happen.
Fix this by manually doing the inc/dec as needed for the wait queue
handling.
Reported-by: Michael Leun
Tested-by: Michael Leun
Cc: stable@vger.kernel.org
Reviewed-by: Omar Sandoval
Fixes: 5d2ee7122c73 ("sbitmap: optimize wakeup check")
Signed-off-by: Jens Axboe
Signed-off-by: Greg Kroah-Hartman
commit 50076360f4a068e019576d60615b452d314e5c11
Author: Minchan Kim
Date: Thu Mar 28 20:44:24 2019 -0700
drivers/block/zram/zram\_drv.c: fix idle/writeback string compare
commit 0bc9f5d14a93971c6cd9c0d81b0fc154fc54c65d upstream.
Makoto report a below KASAN error: zram does out-of-bounds read. Because
strscpy copies from source up to count bytes unconditionally. It could
cause out-of-bounds read on next object in slab.
To prevent it, use strlcpy which checks source's length automatically.
BUG: KASAN: slab-out-of-bounds in strscpy+0x68/0x154
Read of size 8 at addr ffffffc0c3495a00 by task system\_server/1314
..
Call trace:
strscpy+0x68/0x154
idle\_store+0xc4/0x34c
dev\_attr\_store+0x50/0x6c
sysfs\_kf\_write+0x98/0xb4
kernfs\_fop\_write+0x198/0x260
\_\_vfs\_write+0x10c/0x338
vfs\_write+0x114/0x238
SyS\_write+0xc8/0x168
\_\_sys\_trace\_return+0x0/0x4
Allocated by task 1314:
\_\_kmalloc+0x280/0x318
kernfs\_fop\_write+0xac/0x260
\_\_vfs\_write+0x10c/0x338
vfs\_write+0x114/0x238
SyS\_write+0xc8/0x168
\_\_sys\_trace\_return+0x0/0x4
Freed by task 2855:
kfree+0x138/0x630
kernfs\_put\_open\_node+0x10c/0x124
kernfs\_fop\_release+0xd8/0x114
\_\_fput+0x130/0x2a4
\_\_\_\_fput+0x1c/0x28
task\_work\_run+0x16c/0x1c8
do\_notify\_resume+0x2bc/0x107c
work\_pending+0x8/0x10
The buggy address belongs to the object at ffffffc0c3495a00
which belongs to the cache kmalloc-128 of size 128
The buggy address is located 0 bytes inside of
128-byte region [ffffffc0c3495a00, ffffffc0c3495a80)
The buggy address belongs to the page:
page:ffffffbf030d2500 count:1 mapcount:0 mapping: (null) index:0x0 compound\_mapcount: 0
flags: 0x4000000000010200(slab|head)
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffffffc0c3495900: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
ffffffc0c3495980: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
>ffffffc0c3495a00: 04 fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
^
ffffffc0c3495a80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
ffffffc0c3495b00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Link: http://lkml.kernel.org/r/20190319231911.145968-1-minchan@kernel.org
Cc:  [5.0]
Signed-off-by: Minchan Kim
Reported-by: Makoto Wu
Reviewed-by: Sergey Senozhatsky
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 79d8bdf334d6079133133c7f45135980e38c0196
Author: YueHaibing
Date: Thu Mar 28 20:44:40 2019 -0700
fs/proc/proc\_sysctl.c: fix NULL pointer dereference in put\_links
commit 23da9588037ecdd4901db76a5b79a42b529c4ec3 upstream.
Syzkaller reports:
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] SMP KASAN PTI
CPU: 1 PID: 5373 Comm: syz-executor.0 Not tainted 5.0.0-rc8+ #3
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
RIP: 0010:put\_links+0x101/0x440 fs/proc/proc\_sysctl.c:1599
Code: 00 0f 85 3a 03 00 00 48 8b 43 38 48 89 44 24 20 48 83 c0 38 48 89 c2 48 89 44 24 28 48 b8 00 00 00 00 00 fc ff df 48 c1 ea 03 <80> 3c 02 00 0f 85 fe 02 00 00 48 8b 74 24 20 48 c7 c7 60 2a 9d 91
RSP: 0018:ffff8881d828f238 EFLAGS: 00010202
RAX: dffffc0000000000 RBX: ffff8881e01b1140 RCX: ffffffff8ee98267
RDX: 0000000000000007 RSI: ffffc90001479000 RDI: ffff8881e01b1178
RBP: dffffc0000000000 R08: ffffed103ee27259 R09: ffffed103ee27259
R10: 0000000000000001 R11: ffffed103ee27258 R12: fffffffffffffff4
R13: 0000000000000006 R14: ffff8881f59838c0 R15: dffffc0000000000
FS: 00007f072254f700(0000) GS:ffff8881f7100000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007fff8b286668 CR3: 00000001f0542002 CR4: 00000000007606e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
drop\_sysctl\_table+0x152/0x9f0 fs/proc/proc\_sysctl.c:1629
get\_subdir fs/proc/proc\_sysctl.c:1022 [inline]
\_\_register\_sysctl\_table+0xd65/0x1090 fs/proc/proc\_sysctl.c:1335
br\_netfilter\_init+0xbc/0x1000 [br\_netfilter]
do\_one\_initcall+0xfa/0x5ca init/main.c:887
do\_init\_module+0x204/0x5f6 kernel/module.c:3460
load\_module+0x66b2/0x8570 kernel/module.c:3808
\_\_do\_sys\_finit\_module+0x238/0x2a0 kernel/module.c:3902
do\_syscall\_64+0x147/0x600 arch/x86/entry/common.c:290
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x462e99
Code: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f072254ec58 EFLAGS: 00000246 ORIG\_RAX: 0000000000000139
RAX: ffffffffffffffda RBX: 000000000073bf00 RCX: 0000000000462e99
RDX: 0000000000000000 RSI: 0000000020000280 RDI: 0000000000000003
RBP: 00007f072254ec70 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00007f072254f6bc
R13: 00000000004bcefa R14: 00000000006f6fb0 R15: 0000000000000004
Modules linked in: br\_netfilter(+) dvb\_usb\_dibusb\_mc\_common dib3000mc dibx000\_common dvb\_usb\_dibusb\_common dvb\_usb\_dw2102 dvb\_usb classmate\_laptop palmas\_regulator cn videobuf2\_v4l2 v4l2\_common snd\_soc\_bd28623 mptbase snd\_usb\_usx2y snd\_usbmidi\_lib snd\_rawmidi wmi libnvdimm lockd sunrpc grace rc\_kworld\_pc150u rc\_core rtc\_da9063 sha1\_ssse3 i2c\_cros\_ec\_tunnel adxl34x\_spi adxl34x nfnetlink lib80211 i5500\_temp dvb\_as102 dvb\_core videobuf2\_common videodev media videobuf2\_vmalloc videobuf2\_memops udc\_core lnbp22 leds\_lp3952 hid\_roccat\_ryos s1d13xxxfb mtd vport\_geneve openvswitch nf\_conncount nf\_nat\_ipv6 nsh geneve udp\_tunnel ip6\_udp\_tunnel snd\_soc\_mt6351 sis\_agp phylink snd\_soc\_adau1761\_spi snd\_soc\_adau1761 snd\_soc\_adau17x1 snd\_soc\_core snd\_pcm\_dmaengine ac97\_bus snd\_compress snd\_soc\_adau\_utils snd\_soc\_sigmadsp\_regmap snd\_soc\_sigmadsp raid\_class hid\_roccat\_konepure hid\_roccat\_common hid\_roccat c2port\_duramar2150 core mdio\_bcm\_unimac iptable\_security iptable\_raw iptable\_mangle
iptable\_nat nf\_nat\_ipv4 nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 iptable\_filter bpfilter ip6\_vti ip\_vti ip\_gre ipip sit tunnel4 ip\_tunnel hsr veth netdevsim devlink vxcan batman\_adv cfg80211 rfkill chnl\_net caif nlmon dummy team bonding vcan bridge stp llc ip6\_gre gre ip6\_tunnel tunnel6 tun crct10dif\_pclmul crc32\_pclmul crc32c\_intel ghash\_clmulni\_intel joydev mousedev ide\_pci\_generic piix aesni\_intel aes\_x86\_64 ide\_core crypto\_simd atkbd cryptd glue\_helper serio\_raw ata\_generic pata\_acpi i2c\_piix4 floppy sch\_fq\_codel ip\_tables x\_tables ipv6 [last unloaded: lm73]
Dumping ftrace buffer:
(ftrace buffer empty)
---[ end trace 770020de38961fd0 ]---
A new dir entry can be created in get\_subdir and its 'header->parent' is
set to NULL. Only after insert\_header success, it will be set to 'dir',
otherwise 'header->parent' is set to NULL and drop\_sysctl\_table is called.
However in err handling path of get\_subdir, drop\_sysctl\_table also be
called on 'new->header' regardless its value of parent pointer. Then
put\_links is called, which triggers NULL-ptr deref when access member of
header->parent.
In fact we have multiple error paths which call drop\_sysctl\_table() there,
upon failure on insert\_links() we also call drop\_sysctl\_table().And even
in the successful case on \_\_register\_sysctl\_table() we still always call
drop\_sysctl\_table().This patch fix it.
Link: http://lkml.kernel.org/r/20190314085527.13244-1-yuehaibing@huawei.com
Fixes: 0e47c99d7fe25 ("sysctl: Replace root\_list with links between sysctl\_table\_sets")
Signed-off-by: YueHaibing
Reported-by: Hulk Robot
Acked-by: Luis Chamberlain
Cc: Kees Cook
Cc: Alexey Dobriyan
Cc: Alexei Starovoitov
Cc: Daniel Borkmann
Cc: Al Viro
Cc: Eric W. Biederman
Cc:  [3.4+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit e44461a50380741d6c5f7df7f524a3b30a98afab
Author: Wentao Wang
Date: Wed Mar 20 15:30:39 2019 +0000
Disable kgdboc failed by echo space to /sys/module/kgdboc/parameters/kgdboc
commit 3ec8002951ea173e24b466df1ea98c56b7920e63 upstream.
Echo "" to /sys/module/kgdboc/parameters/kgdboc will fail with "No such
device” error.
This is caused by function "configure\_kgdboc" who init err to ENODEV
when the config is empty (legal input) the code go out with ENODEV
returned.
Fixes: 2dd453168643 ("kgdboc: Fix restrict error")
Signed-off-by: Wentao Wang
Cc: stable
Acked-by: Daniel Thompson
Signed-off-by: Greg Kroah-Hartman
commit c6ed8bf0ad03458ae156c9ea6d3a94be67beebd5
Author: Srinivas Pandruvada
Date: Mon Mar 25 09:04:39 2019 -0700
ACPI / CPPC: Fix guaranteed performance handling
commit edef1ef134180149694b86386277076f566d165c upstream.
As per the ACPI specification, "Guaranteed Performance Register" is
a "Buffer" field and it cannot be "Integer", so treat the "Integer"
type for "Guaranteed Performance Register" field as invalid and
ignore its value in that case.
Also save one cpc\_read() call when "Guaranteed Performance Register"
is not present, which means a register defined as:
"Register(SystemMemory, 0, 0, 0, 0)".
Fixes: 29523f095397 ("ACPI / CPPC: Add support for guaranteed performance")
Suggested-by: Rafael J. Wysocki
Signed-off-by: Srinivas Pandruvada
Cc: 4.20+  # 4.20+
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 72c1487ea0a446443556aa0fe6716df760aeb8e6
Author: Bjørn Mork
Date: Wed Mar 27 15:25:32 2019 +0100
USB: serial: option: add Olicard 600
commit 84f3b43f7378b98b7e3096d5499de75183d4347c upstream.
This is a Qualcomm based device with a QMI function on interface 4.
It is mode switched from 2020:2030 using a standard eject message.
T: Bus=01 Lev=01 Prnt=01 Port=00 Cnt=01 Dev#= 6 Spd=480 MxCh= 0
D: Ver= 2.00 Cls=00(>ifc ) Sub=00 Prot=00 MxPS=64 #Cfgs= 1
P: Vendor=2020 ProdID=2031 Rev= 2.32
S: Manufacturer=Mobile Connect
S: Product=Mobile Connect
S: SerialNumber=0123456789ABCDEF
C:\* #Ifs= 6 Cfg#= 1 Atr=80 MxPwr=500mA
I:\* If#= 0 Alt= 0 #EPs= 2 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E: Ad=81(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=01(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 1 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=(none)
E: Ad=83(I) Atr=03(Int.) MxPS= 10 Ivl=32ms
E: Ad=82(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=02(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 2 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=(none)
E: Ad=85(I) Atr=03(Int.) MxPS= 10 Ivl=32ms
E: Ad=84(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=03(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 3 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=00 Prot=00 Driver=(none)
E: Ad=87(I) Atr=03(Int.) MxPS= 10 Ivl=32ms
E: Ad=86(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=04(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 4 Alt= 0 #EPs= 3 Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)
E: Ad=89(I) Atr=03(Int.) MxPS= 8 Ivl=32ms
E: Ad=88(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=05(O) Atr=02(Bulk) MxPS= 512 Ivl=0ms
I:\* If#= 5 Alt= 0 #EPs= 2 Cls=08(stor.) Sub=06 Prot=50 Driver=(none)
E: Ad=8a(I) Atr=02(Bulk) MxPS= 512 Ivl=0ms
E: Ad=06(O) Atr=02(Bulk) MxPS= 512 Ivl=125us
Cc: stable@vger.kernel.org
Signed-off-by: Bjørn Mork
[ johan: use tabs to align comments in adjacent lines ]
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 623533deabb1808473ab8b7560e148287031f257
Author: Kristian Evensen
Date: Sat Mar 2 13:35:53 2019 +0100
USB: serial: option: add support for Quectel EM12
commit d1252f0237238b912c3e7a51bf237acf34c97983 upstream.
The Quectel EM12 is a Cat. 12 LTE modem. It behaves in the exactly the
same way as the EP06 (including the dynamic configuration behavior), so
the same checks on reserved interfaces, etc. are needed.
Signed-off-by: Kristian Evensen
Cc: stable
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit b7a0e2163e0dc57b200d366d70f8b8b14e938ca3
Author: Mans Rullgard
Date: Tue Feb 26 17:07:10 2019 +0000
USB: serial: option: set driver\_info for SIM5218 and compatibles
commit f8df5c2c3e2df5ffaf9fb5503da93d477a8c7db4 upstream.
The SIMCom SIM5218 and compatible devices have 5 USB interfaces, only 4
of which are serial ports. The fifth is a network interface supported
by the qmi-wwan driver. Furthermore, the serial ports do not support
modem control signals. Add driver\_info flags to reflect this.
Signed-off-by: Mans Rullgard
Fixes: ec0cd94d881c ("usb: option: add SIMCom SIM5218")
Cc: stable  # 3.2
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 4503b17ed4963c8aa727e2b2601f3cc72b911538
Author: Lin Yi
Date: Wed Mar 20 19:04:56 2019 +0800
USB: serial: mos7720: fix mos\_parport refcount imbalance on error path
commit 2908b076f5198d231de62713cb2b633a3a4b95ac upstream.
The write\_parport\_reg\_nonblock() helper takes a reference to the struct
mos\_parport, but failed to release it in a couple of error paths after
allocation failures, leading to a memory leak.
Johan said that move the kref\_get() and mos\_parport assignment to the
end of urbtrack initialisation is a better way, so move it. and
mos\_parport do not used until urbtrack initialisation.
Signed-off-by: Lin Yi
Fixes: b69578df7e98 ("USB: usbserial: mos7720: add support for parallel port on moschip 7715")
Cc: stable  # 2.6.35
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 639f52d2901236cd74e32576a0513d3e2581b514
Author: George McCollister
Date: Tue Mar 5 16:05:03 2019 -0600
USB: serial: ftdi\_sio: add additional NovaTech products
commit 422c2537ba9d42320f8ab6573940269f87095320 upstream.
Add PIDs for the NovaTech OrionLX+ and Orion I/O so they can be
automatically detected.
Signed-off-by: George McCollister
Cc: stable
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 7790bb1039fbd402ab40cf0e92e56de3d812cb72
Author: Greg Kroah-Hartman
Date: Wed Mar 27 10:11:14 2019 +0900
USB: serial: cp210x: add new device id
commit a595ecdd5f60b2d93863cebb07eec7f935839b54 upstream.
Lorenz Messtechnik has a device that is controlled by the cp210x driver,
so add the device id to the driver. The device id was provided by
Silicon-Labs for the devices from this vendor.
Reported-by: Uli
Signed-off-by: Greg Kroah-Hartman
Cc: stable
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 4fc867dd92cbdc3f40e719bad3680892cce37be0
Author: Hoan Nguyen An
Date: Mon Mar 18 18:26:32 2019 +0900
serial: sh-sci: Fix setting SCSCR\_TIE while transferring data
commit 93bcefd4c6bad4c69dbc4edcd3fbf774b24d930d upstream.
We disable transmission interrupt (clear SCSCR\_TIE) after all data has been transmitted
(if uart\_circ\_empty(xmit)). While transmitting, if the data is still in the tty buffer,
re-enable the SCSCR\_TIE bit, which was done at sci\_start\_tx().
This is unnecessary processing, wasting CPU operation if the data transmission length is large.
And further, transmit end, FIFO empty bits disabling have also been performed in the step above.
Signed-off-by: Hoan Nguyen An
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit e39ecf48678ee4a7445c68c17b0228b6d047a5c0
Author: Aditya Pakki
Date: Mon Mar 18 18:50:56 2019 -0500
serial: mvebu-uart: Fix to avoid a potential NULL pointer dereference
commit 32f47179833b63de72427131169809065db6745e upstream.
of\_match\_device on failure to find a matching device can return a NULL
pointer. The patch checks for such a scenrio and passes the error upstream.
Signed-off-by: Aditya Pakki
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 763eafe0dbf56e5ec2bbdf21c6106d37e6af9724
Author: Aditya Pakki
Date: Mon Mar 18 18:44:14 2019 -0500
serial: max310x: Fix to avoid potential NULL pointer dereference
commit 3a10e3dd52e80b9a97a3346020024d17b2c272d6 upstream.
of\_match\_device can return a NULL pointer when matching device is not
found. This patch avoids a scenario causing NULL pointer derefernce.
Signed-off-by: Aditya Pakki
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 198b7b7fb6b627044286513349b03391d0adf18e
Author: Gao Xiang
Date: Fri Mar 29 04:14:58 2019 +0800
staging: erofs: keep corrupted fs from crashing kernel in erofs\_readdir()
commit 33bac912840fe64dbc15556302537dc6a17cac63 upstream.
After commit 419d6efc50e9, kernel cannot be crashed in the namei
path. However, corrupted nameoff can do harm in the process of
readdir for scenerios without dm-verity as well. Fix it now.
Fixes: 3aa8ec716e52 ("staging: erofs: add directory operations")
Cc:  # 4.19+
Signed-off-by: Gao Xiang
Reviewed-by: Chao Yu
Signed-off-by: Greg Kroah-Hartman
commit 22a76cf6a5eb13428034ed6f05da44c7b0e0870c
Author: Gao Xiang
Date: Mon Mar 25 11:40:07 2019 +0800
staging: erofs: fix error handling when failed to read compresssed data
commit b6391ac73400eff38377a4a7364bd3df5efb5178 upstream.
Complete read error handling paths for all three kinds of
compressed pages:
1) For cache-managed pages, PG\_uptodate will be checked since
read\_endio will unlock and SetPageUptodate for these pages;
2) For inplaced pages, read\_endio cannot SetPageUptodate directly
since it should be used to mark the final decompressed data,
PG\_error will be set with page locked for IO error instead;
3) For staging pages, PG\_error is used, which is similar to
what we do for inplaced pages.
Fixes: 3883a79abd02 ("staging: erofs: introduce VLE decompression support")
Cc:  # 4.19+
Reviewed-by: Chao Yu
Signed-off-by: Gao Xiang
Signed-off-by: Greg Kroah-Hartman
commit a0fdd9036176202418a84641165adc0fbcc894b2
Author: Chao Yu
Date: Mon Mar 11 23:10:10 2019 +0800
staging: erofs: fix to handle error path of erofs\_vmap()
commit 8bce6dcede65139a087ff240127e3f3c01363eed upstream.
erofs\_vmap() wrapped vmap() and vm\_map\_ram() to return virtual
continuous memory, but both of them can failed due to a lot of
reason, previously, erofs\_vmap()'s callers didn't handle them,
which can potentially cause NULL pointer access, fix it.
Fixes: 3883a79abd02 ("staging: erofs: introduce VLE decompression support")
Fixes: 0d40d6e399c1 ("staging: erofs: add a generic z\_erofs VLE decompressor")
Cc:  # 4.19+
Signed-off-by: Gao Xiang
Signed-off-by: Chao Yu
Signed-off-by: Greg Kroah-Hartman
commit be3d49395af04f7909ec575e9f82e3a7d4a40093
Author: Malcolm Priestley
Date: Sun Mar 24 18:53:49 2019 +0000
staging: vt6655: Fix interrupt race condition on device start up.
commit 3b9c2f2e0e99bb67c96abcb659b3465efe3bee1f upstream.
It appears on some slower systems that the driver can find its way
out of the workqueue while the interrupt is disabled by continuous polling
by it.
Move MACvIntEnable to vnt\_interrupt\_work so that it is always enabled
on all routes out of vnt\_interrupt\_process.
Move MACvIntDisable so that the device doesn't keep polling the system
while the workqueue is being processed.
Signed-off-by: Malcolm Priestley
CC: stable@vger.kernel.org # v4.2+
Signed-off-by: Greg Kroah-Hartman
commit 37fc532d4d58871e6f6b55eda7e1b70f8f62ee88
Author: Malcolm Priestley
Date: Wed Mar 27 18:45:26 2019 +0000
staging: vt6655: Remove vif check from vnt\_interrupt
commit cc26358f89c3e493b54766b1ca56cfc6b14db78a upstream.
A check for vif is made in vnt\_interrupt\_work.
There is a small chance of leaving interrupt disabled while vif
is NULL and the work hasn't been scheduled.
Signed-off-by: Malcolm Priestley
CC: stable@vger.kernel.org # v4.2+
Signed-off-by: Greg Kroah-Hartman
commit 7d9cd1961a505bf718367f547afed12ef32ff5cc
Author: Samuel Thibault
Date: Thu Mar 7 23:06:57 2019 +0100
staging: speakup\_soft: Fix alternate speech with other synths
commit 45ac7b31bc6c4af885cc5b5d6c534c15bcbe7643 upstream.
When switching from speakup\_soft to another synth, speakup\_soft would
keep calling synth\_buffer\_getc() from softsynthx\_read.
Let's thus make synth.c export the knowledge of the current synth, so
that speakup\_soft can determine whether it should be running.
speakup\_soft also needs to set itself alive, otherwise the switch would
let it remain silent.
Signed-off-by: Samuel Thibault
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit de6283bc5cafe7ba95e7fdfb1cc68547b152fdf8
Author: Arnd Bergmann
Date: Mon Mar 4 20:42:33 2019 +0100
staging: olpc\_dcon\_xo\_1: add missing 'const' qualifier
commit ae0a6d2017f733781dcc938a471ccc2d05f9bee6 upstream.
gcc noticed a mismatch between the type qualifiers after a recent
cleanup:
drivers/staging/olpc\_dcon/olpc\_dcon\_xo\_1.c: In function 'dcon\_init\_xo\_1':
drivers/staging/olpc\_dcon/olpc\_dcon\_xo\_1.c:48:26: error: initialization discards 'const' qualifier from pointer target type [-Werror=discarded-qualifiers]
Add the 'const' keyword that should have been there all along.
Fixes: 2159fb372929 ("staging: olpc\_dcon: olpc\_dcon\_xo\_1.c: Switch to the gpio descriptor interface")
Signed-off-by: Arnd Bergmann
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit da418a0b0963b7899a60a8fe5754da2f08b50aac
Author: Ian Abbott
Date: Mon Mar 4 14:33:54 2019 +0000
staging: comedi: ni\_mio\_common: Fix divide-by-zero for DIO cmdtest
commit bafd9c64056cd034a1174dcadb65cd3b294ff8f6 upstream.
`ni\_cdio\_cmdtest()` validates Comedi asynchronous commands for the DIO
subdevice (subdevice 2) of supported National Instruments M-series
cards. It is called when handling the `COMEDI\_CMD` and `COMEDI\_CMDTEST`
ioctls for this subdevice. There are two causes for a possible
divide-by-zero error when validating that the `stop\_arg` member of the
passed-in command is not too large.
The first cause for the divide-by-zero is that calls to
`comedi\_bytes\_per\_scan()` are only valid once the command has been
copied to `s->async->cmd`, but that copy is only done for the
`COMEDI\_CMD` ioctl. For the `COMEDI\_CMDTEST` ioctl, it will use
whatever was left there by the previous `COMEDI\_CMD` ioctl, if any.
(This is very likely, as it is usual for the application to use
`COMEDI\_CMDTEST` before `COMEDI\_CMD`.) If there has been no previous,
valid `COMEDI\_CMD` for this subdevice, then `comedi\_bytes\_per\_scan()`
will return 0, so the subsequent division in `ni\_cdio\_cmdtest()` of
`s->async->prealloc\_bufsz / comedi\_bytes\_per\_scan(s)` will be a
divide-by-zero error. To fix this error, call a new function
`comedi\_bytes\_per\_scan\_cmd(s, cmd)`, based on the existing
`comedi\_bytes\_per\_scan(s)` but using a specified `struct comedi\_cmd` for
its calculations. (Also refactor `comedi\_bytes\_per\_scan()` to call the
new function.)
Once the first cause for the divide-by-zero has been fixed, the second
cause is that `comedi\_bytes\_per\_scan\_cmd()` can legitimately return 0 if
the `scan\_end\_arg` member of the `struct comedi\_cmd` being tested is 0.
Fix it by only performing the division (and validating that `stop\_arg`
is no more than the maximum value) if `comedi\_bytes\_per\_scan\_cmd()`
returns a non-zero value.
The problem was reported on the COMEDI mailing list here:
https://groups.google.com/forum/#!topic/comedi\_list/4t9WlHzMhKM
Reported-by: Ivan Vasilyev
Tested-by: Ivan Vasilyev
Fixes: f164cbf98fa8 ("staging: comedi: ni\_mio\_common: add finite regeneration to dio output")
Cc:  # 4.6+
Cc: Spencer E. Olson
Signed-off-by: Ian Abbott
Signed-off-by: Greg Kroah-Hartman
commit 5bff7cb2bc8950c9882a07563ce9d87591597ce3
Author: Nathan Chancellor
Date: Fri Mar 8 11:37:44 2019 -0700
tty: serial: qcom\_geni\_serial: Initialize baud in qcom\_geni\_console\_setup
commit c5cbc78acf693f5605d4a85b1327fa7933daf092 upstream.
When building with -Wsometimes-uninitialized, Clang warns:
drivers/tty/serial/qcom\_geni\_serial.c:1079:6: warning: variable 'baud'
is used uninitialized whenever 'if' condition is false
[-Wsometimes-uninitialized]
It's not wrong; when options is NULL, baud has no default value. Use
9600 as that is a sane default.
Link: https://github.com/ClangBuiltLinux/linux/issues/395
Suggested-by: Greg Kroah-Hartman
Signed-off-by: Nathan Chancellor
Reviewed-by: Nick Desaulniers
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 36e47853d0e9dad0ef94bc7a611a485e24a4e775
Author: Kangjie Lu
Date: Fri Mar 15 12:16:06 2019 -0500
tty: atmel\_serial: fix a potential NULL pointer dereference
commit c85be041065c0be8bc48eda4c45e0319caf1d0e5 upstream.
In case dmaengine\_prep\_dma\_cyclic fails, the fix returns a proper
error code to avoid NULL pointer dereference.
Signed-off-by: Kangjie Lu
Fixes: 34df42f59a60 ("serial: at91: add rx dma support")
Acked-by: Richard Genoud
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit ade797815046ab53487b3e927415d3e053634b67
Author: Kangjie Lu
Date: Thu Mar 14 02:21:51 2019 -0500
tty: mxs-auart: fix a potential NULL pointer dereference
commit 6734330654dac550f12e932996b868c6d0dcb421 upstream.
In case ioremap fails, the fix returns -ENOMEM to avoid NULL
pointer dereferences.
Multiple places use port.membase.
Signed-off-by: Kangjie Lu
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 35070431105fd409d7e46588bec105cf11cee579
Author: Razvan Stefanescu
Date: Tue Mar 19 15:20:35 2019 +0200
tty/serial: atmel: RS485 HD w/DMA: enable RX after TX is stopped
commit 69646d7a3689fbe1a65ae90397d22ac3f1b8d40f upstream.
In half-duplex operation, RX should be started after TX completes.
If DMA is used, there is a case when the DMA transfer completes but the
TX FIFO is not emptied, so the RX cannot be restarted just yet.
Use a boolean variable to store this state and rearm TX interrupt mask
to be signaled again that the transfer finished. In interrupt transmit
handler this variable is used to start RX. A warning message is generated
if RX is activated before TX fifo is cleared.
Fixes: b389f173aaa1 ("tty/serial: atmel: RS485 half duplex w/DMA: enable
RX after TX is done")
Signed-off-by: Razvan Stefanescu
Acked-by: Richard Genoud
Cc: stable
Signed-off-by: Greg Kroah-Hartman
commit 70691073d296ff48ef03a7236da48489dcd8a532
Author: Razvan Stefanescu
Date: Tue Mar 19 15:20:34 2019 +0200
tty/serial: atmel: Add is\_half\_duplex helper
commit f3040983132bf3477acd45d2452a906e67c2fec9 upstream.
Use a helper function to check that a port needs to use half duplex
communication, replacing several occurrences of multi-line bit checking.
Fixes: b389f173aaa1 ("tty/serial: atmel: RS485 half duplex w/DMA: enable RX after TX is done")
Cc: stable
Signed-off-by: Razvan Stefanescu
Acked-by: Richard Genoud
Signed-off-by: Greg Kroah-Hartman
commit d5845d77e9e1cbfc0a0478b9b542c65ba8ba78c2
Author: Jonas Karlman
Date: Wed Feb 20 22:40:06 2019 +0000
drm/rockchip: vop: reset scale mode when win is disabled
commit e9abc611a941d4051cde1d94b2ab7473fdb50102 upstream.
NV12 framebuffers produced by the VPU shows distorted on RK3288
after win has been disabled when scaling is active.
This issue can be reproduced using a 1080p modeset by:
- Scale a 1280x720 NV12 framebuffer to 1920x1080 on win0
- Disable win0
- Display a 1920x1080 NV12 framebuffer without scaling on win0
- Output will now show the framebuffer distorted
And by:
- Scale a 1280x720 NV12 framebuffer to 1920x1080
- Change to a 720p modeset (win gets disabled and scaling reset to none)
- Output will now show the framebuffer distorted
Fix this by setting scale mode to none when win is disabled.
Fixes: 4c156c21c794 ("drm/rockchip: vop: support plane scale")
Cc: stable@vger.kernel.org
Signed-off-by: Jonas Karlman
Signed-off-by: Heiko Stuebner
Link: https://patchwork.freedesktop.org/patch/msgid/AM3PR03MB0966DE3E19BACE07328CD637AC7D0@AM3PR03MB0966.eurprd03.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 631d09fd085668db774f17c4fa363f2cb4d3f8dc
Author: Steffen Maier
Date: Tue Mar 26 14:36:59 2019 +0100
scsi: zfcp: fix scsi\_eh host reset with port\_forced ERP for non-NPIV FCP devices
commit 242ec1455151267fe35a0834aa9038e4c4670884 upstream.
Suppose more than one non-NPIV FCP device is active on the same channel.
Send I/O to storage and have some of the pending I/O run into a SCSI
command timeout, e.g. due to bit errors on the fibre. Now the error
situation stops. However, we saw FCP requests continue to timeout in the
channel. The abort will be successful, but the subsequent TUR fails.
Scsi\_eh starts. The LUN reset fails. The target reset fails. The host
reset only did an FCP device recovery. However, for non-NPIV FCP devices,
this does not close and reopen ports on the SAN-side if other non-NPIV FCP
device(s) share the same open ports.
In order to resolve the continuing FCP request timeouts, we need to
explicitly close and reopen ports on the SAN-side.
This was missing since the beginning of zfcp in v2.6.0 history commit
ea127f975424 ("[PATCH] s390 (7/7): zfcp host adapter.").
Note: The FSF requests for forced port reopen could run into FSF request
timeouts due to other reasons. This would trigger an internal FCP device
recovery. Pending forced port reopen recoveries would get dismissed. So
some ports might not get fully reopened during this host reset handler.
However, subsequent I/O would trigger the above described escalation and
eventually all ports would be forced reopen to resolve any continuing FCP
request timeouts due to earlier bit errors.
Signed-off-by: Steffen Maier
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Cc:  #3.0+
Reviewed-by: Jens Remus
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit e188df7644069f0994591406f1fa36f70202be57
Author: Steffen Maier
Date: Tue Mar 26 14:36:58 2019 +0100
scsi: zfcp: fix rport unblock if deleted SCSI devices on Scsi\_Host
commit fe67888fc007a76b81e37da23ce5bd8fb95890b0 upstream.
An already deleted SCSI device can exist on the Scsi\_Host and remain there
because something still holds a reference. A new SCSI device with the same
H:C:T:L and FCP device, target port WWPN, and FCP LUN can be created. When
we try to unblock an rport, we still find the deleted SCSI device and
return early because the zfcp\_scsi\_dev of that SCSI device is not
ZFCP\_STATUS\_COMMON\_UNBLOCKED. Hence we miss to unblock the rport, even if
the new proper SCSI device would be in good state.
Therefore, skip deleted SCSI devices when iterating the sdevs of the shost.
[cf. \_\_scsi\_device\_lookup{\_by\_target}() or scsi\_device\_get()]
The following abbreviated trace sequence can indicate such problem:
Area : REC
Tag : ersfs\_3
LUN : 0x4045400300000000
WWPN : 0x50050763031bd327
LUN status : 0x40000000 not ZFCP\_STATUS\_COMMON\_UNBLOCKED
Ready count : n not incremented yet
Running count : 0x00000000
ERP want : 0x01
ERP need : 0xc1 ZFCP\_ERP\_ACTION\_NONE
Area : REC
Tag : ersfs\_3
LUN : 0x4045400300000000
WWPN : 0x50050763031bd327
LUN status : 0x41000000
Ready count : n+1
Running count : 0x00000000
ERP want : 0x01
ERP need : 0x01
...
Area : REC
Level : 4 only with increased trace level
Tag : ertru\_l
LUN : 0x4045400300000000
WWPN : 0x50050763031bd327
LUN status : 0x40000000
Request ID : 0x0000000000000000
ERP status : 0x01800000
ERP step : 0x1000
ERP action : 0x01
ERP count : 0x00
NOT followed by a trace record with tag "scpaddy"
for WWPN 0x50050763031bd327.
Signed-off-by: Steffen Maier
Fixes: 6f2ce1c6af37 ("scsi: zfcp: fix rport unblock race with LUN recovery")
Cc:  #2.6.32+
Reviewed-by: Jens Remus
Reviewed-by: Benjamin Block
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 143982417ad32d854b127b758057c3098e19c851
Author: Martin K. Petersen
Date: Wed Mar 27 12:11:52 2019 -0400
scsi: sd: Quiesce warning if device does not report optimal I/O size
commit 1d5de5bd311be7cd54f02f7cd164f0349a75c876 upstream.
Commit a83da8a4509d ("scsi: sd: Optimal I/O size should be a multiple
of physical block size") split one conditional into several separate
statements in an effort to provide more accurate warning messages when
a device reports a nonsensical value. However, this reorganization
accidentally dropped the precondition of the reported value being
larger than zero. This lead to a warning getting emitted on devices
that do not report an optimal I/O size at all.
Remain silent if a device does not report an optimal I/O size.
Fixes: a83da8a4509d ("scsi: sd: Optimal I/O size should be a multiple of physical block size")
Cc: Randy Dunlap
Cc:
Reported-by: Hussam Al-Tayeb
Tested-by: Hussam Al-Tayeb
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 98163d192bc5050f88fee16754e9c01e7d1d6def
Author: Bart Van Assche
Date: Mon Mar 25 10:01:46 2019 -0700
scsi: sd: Fix a race between closing an sd device and sd I/O
commit c14a57264399efd39514a2329c591a4b954246d8 upstream.
The scsi\_end\_request() function calls scsi\_cmd\_to\_driver() indirectly and
hence needs the disk->private\_data pointer. Avoid that that pointer is
cleared before all affected I/O requests have finished. This patch avoids
that the following crash occurs:
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
Call trace:
scsi\_mq\_uninit\_cmd+0x1c/0x30
scsi\_end\_request+0x7c/0x1b8
scsi\_io\_completion+0x464/0x668
scsi\_finish\_command+0xbc/0x160
scsi\_eh\_flush\_done\_q+0x10c/0x170
sas\_scsi\_recover\_host+0x84c/0xa98 [libsas]
scsi\_error\_handler+0x140/0x5b0
kthread+0x100/0x12c
ret\_from\_fork+0x10/0x18
Cc: Christoph Hellwig
Cc: Ming Lei
Cc: Hannes Reinecke
Cc: Johannes Thumshirn
Cc: Jason Yan
Cc:
Signed-off-by: Bart Van Assche
Reported-by: Jason Yan
Reviewed-by: Christoph Hellwig
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 310891a84396d072588e577694b3c20290b38079
Author: Darrick J. Wong
Date: Thu Mar 28 20:43:38 2019 -0700
ocfs2: fix inode bh swapping mixup in ocfs2\_reflink\_inodes\_lock
commit e6a9467ea14bae8691b0f72c500510c42ea8edb8 upstream.
ocfs2\_reflink\_inodes\_lock() can swap the inode1/inode2 variables so that
we always grab cluster locks in order of increasing inode number.
Unfortunately, we forget to swap the inode record buffer head pointers
when we've done this, which leads to incorrect bookkeepping when we're
trying to make the two inodes have the same refcount tree.
This has the effect of causing filesystem shutdowns if you're trying to
reflink data from inode 100 into inode 97, where inode 100 already has a
refcount tree attached and inode 97 doesn't. The reflink code decides
to copy the refcount tree pointer from 100 to 97, but uses inode 97's
inode record to open the tree root (which it doesn't have) and blows up.
This issue causes filesystem shutdowns and metadata corruption!
Link: http://lkml.kernel.org/r/20190312214910.GK20533@magnolia
Fixes: 29ac8e856cb369 ("ocfs2: implement the VFS clone\_range, copy\_range, and dedupe\_range features")
Signed-off-by: Darrick J. Wong
Reviewed-by: Joseph Qi
Cc: Mark Fasheh
Cc: Joel Becker
Cc: Junxiao Bi
Cc: Joseph Qi
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit f2391e6767a6a54fd7c7ba928ec8ff0d4aa08fea
Author: Tetsuo Handa
Date: Thu Mar 28 20:43:30 2019 -0700
fs/open.c: allow opening only regular files during execve()
commit 73601ea5b7b18eb234219ae2adf77530f389da79 upstream.
syzbot is hitting lockdep warning [1] due to trying to open a fifo
during an execve() operation. But we don't need to open non regular
files during an execve() operation, for all files which we will need are
the executable file itself and the interpreter programs like /bin/sh and
ld-linux.so.2 .
Since the manpage for execve(2) says that execve() returns EACCES when
the file or a script interpreter is not a regular file, and the manpage
for uselib(2) says that uselib() can return EACCES, and we use
FMODE\_EXEC when opening for execve()/uselib(), we can bail out if a non
regular file is requested with FMODE\_EXEC set.
Since this deadlock followed by khungtaskd warnings is trivially
reproducible by a local unprivileged user, and syzbot's frequent crash
due to this deadlock defers finding other bugs, let's workaround this
deadlock until we get a chance to find a better solution.
[1] https://syzkaller.appspot.com/bug?id=b5095bfec44ec84213bac54742a82483aad578ce
Link: http://lkml.kernel.org/r/1552044017-7890-1-git-send-email-penguin-kernel@I-love.SAKURA.ne.jp
Reported-by: syzbot
Fixes: 8924feff66f35fe2 ("splice: lift pipe\_lock out of splice\_to\_pipe()")
Signed-off-by: Tetsuo Handa
Acked-by: Kees Cook
Cc: Al Viro
Cc: Eric Biggers
Cc: Dmitry Vyukov
Cc:  [4.9+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 95d78fc939430d77b1545b2290fa5c3bf1ddc68b
Author: Fredrik Noring
Date: Wed Mar 27 19:12:50 2019 +0100
kbuild: modversions: Fix relative CRC byte order interpretation
commit 54a7151b1496cddbb7a83546b7998103e98edc88 upstream.
Fix commit 56067812d5b0 ("kbuild: modversions: add infrastructure for
emitting relative CRCs") where CRCs are interpreted in host byte order
rather than proper kernel byte order. The bug is conditional on
CONFIG\_MODULE\_REL\_CRCS.
For example, when loading a BE module into a BE kernel compiled with a LE
system, the error "disagrees about version of symbol module\_layout" is
produced. A message such as "Found checksum D7FA6856 vs module 5668FAD7"
will be given with debug enabled, which indicates an obvious endian
problem within \_\_kcrctab within the kernel image.
The general solution is to use the macro TO\_NATIVE, as is done in
similar cases throughout modpost.c. With this correction it has been
verified that a BE kernel compiled with a LE system accepts BE modules.
This change has also been verified with a LE kernel compiled with a LE
system, in which case TO\_NATIVE returns its value unmodified since the
byte orders match. This is by far the common case.
Fixes: 56067812d5b0 ("kbuild: modversions: add infrastructure for emitting relative CRCs")
Signed-off-by: Fredrik Noring
Cc: stable@vger.kernel.org
Signed-off-by: Masahiro Yamada
Signed-off-by: Greg Kroah-Hartman
commit a6c74dcb59091b7c246f378b7b68ec65a825a85c
Author: Bernhard Rosenkraenzer
Date: Tue Mar 5 00:38:19 2019 +0100
ALSA: hda/realtek - Fix speakers on Acer Predator Helios 500 Ryzen laptops
commit e2a829b3da01b9b32c4d0291d042b8a6e2a98ca3 upstream.
On an Acer Predator Helios 500 (Ryzen version), the laptop's speakers
don't work out of the box.
The problem can be worked around with hdajackretask, remapping the
"Black Headphone, Right side" pin (0x21) to the Internal speaker.
This patch adds a quirk to change this mapping by default.
[ corrected ALC299\_FIXUP\_PREDATOR\_SPK definition and adapted for the
latest tree by tiwai ]
Signed-off-by: Bernhard Rosenkraenzer
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit f2b1bfbc173a22e0c6e1865b1fa2a7e88eddad25
Author: Jian-Hong Pan
Date: Fri Mar 22 11:37:22 2019 +0800
ALSA: hda/realtek: Enable headset MIC of ASUS X430UN and X512DK with ALC256
commit 6ac371aa1a74240fb910c98aa3484d5ece8473d3 upstream.
The ASUS X430UN and X512DK with ALC256 cannot detect the headset MIC
until ALC256\_FIXUP\_ASUS\_MIC\_NO\_PRESENCE quirk applied.
Signed-off-by: Jian-Hong Pan
Signed-off-by: Daniel Drake
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c03c547b07d973eb014f005992dba2b133311b0a
Author: Chris Chiu
Date: Fri Mar 22 11:37:20 2019 +0800
ALSA: hda/realtek: Enable headset mic of ASUS P5440FF with ALC256
commit a806ef1cf3bbc0baadc6cdeb11f12b5dd27e91c2 upstream.
The ASUS laptop P5440FF with ALC256 can't detect the headset microphone
until ALC256\_FIXUP\_ASUS\_MIC\_NO\_PRESENCE quirk applied.
Signed-off-by: Chris Chiu
Signed-off-by: Daniel Drake
Signed-off-by: Jian-Hong Pan
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit dd1774f3d0cdecd422daab2504a9acb70f8ec4c4
Author: Jian-Hong Pan
Date: Fri Mar 22 11:37:18 2019 +0800
ALSA: hda/realtek: Enable ASUS X441MB and X705FD headset MIC with ALC256
commit e1037354a0a75acdea2b27043c0a371ed85cf262 upstream.
The ASUS laptop X441MB and X705FD with ALC256 cannot detect the headset
MIC until ALC256\_FIXUP\_ASUS\_MIC\_NO\_PRESENCE quirk applied.
Signed-off-by: Chris Chiu
Signed-off-by: Daniel Drake
Signed-off-by: Jian-Hong Pan
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c672af11fbb0614c49a40aeeaa54408e84a8d091
Author: Chris Chiu
Date: Thu Mar 21 17:17:31 2019 +0800
ALSA: hda/realtek - Add support for Acer Aspire E5-523G/ES1-432 headset mic
commit c7531e31c8a440b5fe6bd62664def5bcb6262f96 upstream.
The Acer laptop Aspire E5-523G and ES1-432 with ALC255 can't detect
the headset microphone until ALC255\_FIXUP\_ACER\_MIC\_NO\_PRESENCE quirk
applied.
Signed-off-by: Chris Chiu
Signed-off-by: Daniel Drake
Signed-off-by: Jian-Hong Pan
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 12af8b3d94eb8df0ef0dd509f17a74c5444a9470
Author: Jian-Hong Pan
Date: Thu Mar 21 16:39:04 2019 +0800
ALSA: hda/realtek: Enable headset MIC of Acer Aspire Z24-890 with ALC286
commit 2733ccebf4a937a0858e7d05a4a003b89715033f upstream.
The Acer Aspire Z24-890 cannot detect the headset MIC until
ALC286\_FIXUP\_ACER\_AIO\_HEADSET\_MIC quirk applied.
Signed-off-by: Jian-Hong Pan
Signed-off-by: Daniel Drake
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 9635b3bf1a5fbbc8d115a769f03d1735f3911974
Author: Jian-Hong Pan
Date: Fri Mar 15 17:51:09 2019 +0800
ALSA: hda/realtek: Enable headset MIC of Acer AIO with ALC286
commit 667a8f73753908c4d0171e52b71774f9be5d6713 upstream.
Some Acer AIO desktops like Veriton Z6860G, Z4860G and Z4660G cannot
record sound from headset MIC. This patch adds the
ALC286\_FIXUP\_ACER\_AIO\_HEADSET\_MIC quirk to fix this issue.
Fixes: 9f8aefed9623 ("ALSA: hda/realtek: Fix mic issue on Acer AIO Veriton Z4660G")
Fixes: b72f936f6b32 ("ALSA: hda/realtek: Fix mic issue on Acer AIO Veriton Z4860G/Z6860G")
Signed-off-by: Jian-Hong Pan
Reviewed-by: Kailang Yang
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b6de98dcc02e5a3ec6ecf2aeb6ae5a13dcbeefae
Author: Kailang Yang
Date: Thu Mar 14 15:50:59 2019 +0800
ALSA: hda/realtek - Add support headset mode for New DELL WYSE NB
commit da484d00f020af3dd7cfcc6c4b69a7f856832883 upstream.
Enable headset mode support for new WYSE NB platform.
Signed-off-by: Kailang Yang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 8da540f343aa36f711103e3bce8b40c617e97293
Author: Kailang Yang
Date: Thu Mar 14 16:22:45 2019 +0800
ALSA: hda/realtek - Add support headset mode for DELL WYSE AIO
commit 136824efaab2c095fc911048f7c7ddeda258c965 upstream.
This patch will enable WYSE AIO for Headset mode.
Signed-off-by: Kailang Yang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 545d1fe70648a4797e5b797f871544b23c98a506
Author: Jaroslav Kysela
Date: Thu Mar 14 09:21:08 2019 +0100
ALSA: hda/realtek: merge alc\_fixup\_headset\_jack to alc295\_fixup\_chromebook
commit c8a9afa632f0fd45731d3353525faf1fdb362c89 upstream.
The ALC225\_FIXUP\_HEADSET\_JACK fixup can be merged to alc295\_fixup\_chromebook.
There are no other users for ALC225\_FIXUP\_HEADSET\_JACK other than
the chromebook hardware.
Fixes: 10f5b1b85ed1 ("ALSA: hda/realtek - Fixed Headset Mic JD not stable")
Cc: Kailang Yang
Signed-off-by: Jaroslav Kysela
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c87a0bb99b8393641cf416bd5c57d82fa86040a6
Author: Kailang Yang
Date: Thu Feb 21 16:10:22 2019 +0800
ALSA: hda/realtek - Fixed Headset Mic JD not stable
commit 10f5b1b85ed10a80d45bc2db450e65bd792efaad upstream.
It will be lose Mic JD state when Chrome OS boot and headset was plugged.
Implement of reset combo jack JD. It will show normally.
Fixes: e854747d7593 ("ALSA: hda/realtek - Enable headset button support for new codec")
Signed-off-by: Kailang Yang
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 56e3785b579b8dfb4d70f96b38d6fda68eb813f8
Author: Takashi Iwai
Date: Mon Mar 25 10:38:58 2019 +0100
ALSA: pcm: Don't suspend stream in unrecoverable PCM state
commit 113ce08109f8e3b091399e7cc32486df1cff48e7 upstream.
Currently PCM core sets each opened stream forcibly to SUSPENDED state
via snd\_pcm\_suspend\_all() call, and the user-space is responsible for
re-triggering the resume manually either via snd\_pcm\_resume() or
prepare call. The scheme works fine usually, but there are corner
cases where the stream can't be resumed by that call: the streams
still in OPEN state before finishing hw\_params. When they are
suspended, user-space cannot perform resume or prepare because they
haven't been set up yet. The only possible recovery is to re-open the
device, which isn't nice at all. Similarly, when a stream is in
DISCONNECTED state, it makes no sense to change it to SUSPENDED
state. Ditto for in SETUP state; which you can re-prepare directly.
So, this patch addresses these issues by filtering the PCM streams to
be suspended by checking the PCM state. When a stream is in either
OPEN, SETUP or DISCONNECTED as well as already SUSPENDED, the suspend
action is skipped.
To be noted, this problem was originally reported for the PCM runtime
PM on HD-audio. And, the runtime PM problem itself was already
addressed (although not intended) by the code refactoring commits
3d21ef0b49f8 ("ALSA: pcm: Suspend streams globally via device type PM
ops") and 17bc4815de58 ("ALSA: pci: Remove superfluous
snd\_pcm\_suspend\*() calls"). These commits eliminated the
snd\_pcm\_suspend\*() calls from the runtime PM suspend callback code
path, hence the racy OPEN state won't appear while runtime PM.
(FWIW, the race window is between snd\_pcm\_open\_substream() and the
first power up in azx\_pcm\_open().)
Although the runtime PM issue was already "fixed", the same problem is
still present for the system PM, hence this patch is still needed.
And for stable trees, this patch alone should suffice for fixing the
runtime PM problem, too.
Reported-and-tested-by: Jon Hunter
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 94176d2a1d2b6f25286ee6a4b2e19655467b99ae
Author: Takashi Iwai
Date: Fri Mar 22 16:00:54 2019 +0100
ALSA: pcm: Fix possible OOB access in PCM oss plugins
commit ca0214ee2802dd47239a4e39fb21c5b00ef61b22 upstream.
The PCM OSS emulation converts and transfers the data on the fly via
"plugins". The data is converted over the dynamically allocated
buffer for each plugin, and recently syzkaller caught OOB in this
flow.
Although the bisection by syzbot pointed out to the commit
65766ee0bf7f ("ALSA: oss: Use kvzalloc() for local buffer
allocations"), this is merely a commit to replace vmalloc() with
kvmalloc(), hence it can't be the cause. The further debug action
revealed that this happens in the case where a slave PCM doesn't
support only the stereo channels while the OSS stream is set up for a
mono channel. Below is a brief explanation:
At each OSS parameter change, the driver sets up the PCM hw\_params
again in snd\_pcm\_oss\_change\_params\_lock(). This is also the place
where plugins are created and local buffers are allocated. The
problem is that the plugins are created before the final hw\_params is
determined. Namely, two snd\_pcm\_hw\_param\_near() calls for setting the
period size and periods may influence on the final result of channels,
rates, etc, too, while the current code has already created plugins
beforehand with the premature values. So, the plugin believes that
channels=1, while the actual I/O is with channels=2, which makes the
driver reading/writing over the allocated buffer size.
The fix is simply to move the plugin allocation code after the final
hw\_params call.
Reported-by: syzbot+d4503ae45b65c5bc1194@syzkaller.appspotmail.com
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit a30c0ff829c63ebf8fe399e0860f32db0bd7acfe
Author: Gustavo A. R. Silva
Date: Wed Mar 20 18:42:01 2019 -0500
ALSA: seq: oss: Fix Spectre v1 vulnerability
commit c709f14f0616482b67f9fbcb965e1493a03ff30b upstream.
dev is indirectly controlled by user-space, hence leading to
a potential exploitation of the Spectre variant 1 vulnerability.
This issue was detected with the help of Smatch:
sound/core/seq/oss/seq\_oss\_synth.c:626 snd\_seq\_oss\_synth\_make\_info() warn: potential spectre issue 'dp->synths' [w] (local cap)
Fix this by sanitizing dev before using it to index dp->synths.
Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].
[1] https://lore.kernel.org/lkml/20180423164740.GY17484@dhcp22.suse.cz/
Cc: stable@vger.kernel.org
Signed-off-by: Gustavo A. R. Silva
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit abe5b0a76de91133b38bd66ec8d2b7316eb7cb4b
Author: Gustavo A. R. Silva
Date: Wed Mar 20 16:15:24 2019 -0500
ALSA: rawmidi: Fix potential Spectre v1 vulnerability
commit 2b1d9c8f87235f593826b9cf46ec10247741fff9 upstream.
info->stream is indirectly controlled by user-space, hence leading to
a potential exploitation of the Spectre variant 1 vulnerability.
This issue was detected with the help of Smatch:
sound/core/rawmidi.c:604 \_\_snd\_rawmidi\_info\_select() warn: potential spectre issue 'rmidi->streams' [r] (local cap)
Fix this by sanitizing info->stream before using it to index
rmidi->streams.
Notice that given that speculation windows are large, the policy is
to kill the speculation on the first load and not worry if it can be
completed with a dependent load/store [1].
[1] https://lore.kernel.org/lkml/20180423164740.GY17484@dhcp22.suse.cz/
Cc: stable@vger.kernel.org
Signed-off-by: Gustavo A. R. Silva
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit ce1ae80cacf7948bbdac9999c30e7cc6ca143f62
Author: Christian Lamparter
Date: Fri Mar 22 01:05:02 2019 +0100
net: dsa: qca8k: remove leftover phy accessors
commit 1eec7151ae0e134bd42e3f128066b2ff8da21393 upstream.
This belated patch implements Andrew Lunn's request of
"remove the phy\_read() and phy\_write() functions."

While seemingly harmless, this causes the switch's user
port PHYs to get registered twice. This is because the
DSA subsystem will create a slave mdio-bus not knowing
that the qca8k\_phy\_(read|write) accessors operate on
the external mdio-bus. So the same "bus" gets effectively
duplicated.
Cc: stable@vger.kernel.org
Fixes: 6b93fb46480a ("net-next: dsa: add new driver for qca8xxx family")
Signed-off-by: Christian Lamparter
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0110524398bb210d1f31f3ccd06064be2af858ea
Author: Olga Kornievskaia
Date: Tue Mar 19 12:12:13 2019 -0400
NFSv4.1 don't free interrupted slot on open
commit 0cb98abb5bd13b9a636bde603d952d722688b428 upstream.
Allow the async rpc task for finish and update the open state if needed,
then free the slot. Otherwise, the async rpc unable to decode the reply.
Signed-off-by: Olga Kornievskaia
Fixes: ae55e59da0e4 ("pnfs: Don't release the sequence slot...")
Cc: stable@vger.kernel.org # v4.18+
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit e37c15d77d68cf8f4f5af368f431d61372ce2f22
Author: NeilBrown
Date: Tue Mar 19 11:33:24 2019 +1100
NFS: fix mount/umount race in nlmclnt.
commit 4a9be28c45bf02fa0436808bb6c0baeba30e120e upstream.
If the last NFSv3 unmount from a given host races with a mount from the
same host, we can destroy an nlm\_host that is still in use.
Specifically nlmclnt\_lookup\_host() can increment h\_count on
an nlm\_host that nlmclnt\_release\_host() has just successfully called
refcount\_dec\_and\_test() on.
Once nlmclnt\_lookup\_host() drops the mutex, nlm\_destroy\_host\_lock()
will be called to destroy the nlmclnt which is now in use again.
The cause of the problem is that the dec\_and\_test happens outside the
locked region. This is easily fixed by using
refcount\_dec\_and\_mutex\_lock().
Fixes: 8ea6ecc8b075 ("lockd: Create client-side nlm\_host cache")
Cc: stable@vger.kernel.org (v2.6.38+)
Signed-off-by: NeilBrown
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit 7a4cdaf977c2c3636f3bb4d11fcfc498ec3475c8
Author: Catalin Marinas
Date: Mon Mar 18 17:00:28 2019 +0000
NFS: Fix nfs4\_lock\_state refcounting in nfs4\_alloc\_{lock,unlock}data()
commit 3028efe03be9c8c4cd7923f0f3c39b2871cc8a8f upstream.
Commit 7b587e1a5a6c ("NFS: use locks\_copy\_lock() to copy locks.")
changed the lock copying from memcpy() to the dedicated
locks\_copy\_lock() function. The latter correctly increments the
nfs4\_lock\_state.ls\_count via nfs4\_fl\_copy\_lock(), however, this refcount
has already been incremented in the nfs4\_alloc\_{lock,unlock}data().
Kmemleak subsequently reports an unreferenced nfs4\_lock\_state object as
below (arm64 platform):
unreferenced object 0xffff8000fce0b000 (size 256):
comm "systemd-sysuser", pid 1608, jiffies 4294892825 (age 32.348s)
hex dump (first 32 bytes):
20 57 4c fb 00 80 ff ff 20 57 4c fb 00 80 ff ff WL..... WL.....
00 57 4c fb 00 80 ff ff 01 00 00 00 00 00 00 00 .WL.............
backtrace:
[<000000000d15010d>] kmem\_cache\_alloc+0x178/0x208
[<00000000d7c1d264>] nfs4\_set\_lock\_state+0x124/0x1f0
[<000000009c867628>] nfs4\_proc\_lock+0x90/0x478
[<000000001686bd74>] do\_setlk+0x64/0xe8
[<00000000e01500d4>] nfs\_lock+0xe8/0x1f0
[<000000004f387d8d>] vfs\_lock\_file+0x18/0x40
[<00000000656ab79b>] do\_lock\_file\_wait+0x68/0xf8
[<00000000f17c4a4b>] fcntl\_setlk+0x224/0x280
[<0000000052a242c6>] do\_fcntl+0x418/0x730
[<000000004f47291a>] \_\_arm64\_sys\_fcntl+0x84/0xd0
[<00000000d6856e01>] el0\_svc\_common+0x80/0xf0
[<000000009c4bd1df>] el0\_svc\_handler+0x2c/0x80
[<00000000b1a0d479>] el0\_svc+0x8/0xc
[<0000000056c62a0f>] 0xffffffffffffffff
This patch removes the original refcount\_inc(&lsp->ls\_count) that was
paired with the memcpy() lock copying.
Fixes: 7b587e1a5a6c ("NFS: use locks\_copy\_lock() to copy locks.")
Cc:  # 5.0.x-
Cc: NeilBrown
Signed-off-by: Catalin Marinas
Signed-off-by: Trond Myklebust
Signed-off-by: Greg Kroah-Hartman
commit bd01ab90e8a5fd84aa91839ea9b96f5edf0842d2
Author: Cornelia Huck
Date: Mon Mar 11 10:59:53 2019 +0100
vfio: ccw: only free cp on final interrupt
commit 50b7f1b7236bab08ebbbecf90521e84b068d7a17 upstream.
When we get an interrupt for a channel program, it is not
necessarily the final interrupt; for example, the issuing
guest may request an intermediate interrupt by specifying
the program-controlled-interrupt flag on a ccw.
We must not switch the state to idle if the interrupt is not
yet final; even more importantly, we must not free the translated
channel program if the interrupt is not yet final, or the host
can crash during cp rewind.
Fixes: e5f84dbaea59 ("vfio: ccw: return I/O results asynchronously")
Cc: stable@vger.kernel.org # v4.12+
Reviewed-by: Eric Farman
Signed-off-by: Cornelia Huck
Signed-off-by: Greg Kroah-Hartman
commit 73d6cb88453261d77a95b219d39c543cca46c115
Author: Naveen N. Rao
Date: Fri Mar 15 20:21:19 2019 +0530
powerpc: bpf: Fix generation of load/store DW instructions
commit 86be36f6502c52ddb4b85938145324fd07332da1 upstream.
Yauheni Kaliuta pointed out that PTR\_TO\_STACK store/load verifier test
was failing on powerpc64 BE, and rightfully indicated that the PPC\_LD()
macro is not masking away the last two bits of the offset per the ISA,
resulting in the generation of 'lwa' instruction instead of the intended
'ld' instruction.
Segher also pointed out that we can't simply mask away the last two bits
as that will result in loading/storing from/to a memory location that
was not intended.
This patch addresses this by using ldx/stdx if the offset is not
word-aligned. We load the offset into a temporary register (TMP\_REG\_2)
and use that as the index register in a subsequent ldx/stdx. We fix
PPC\_LD() macro to mask off the last two bits, but enhance PPC\_BPF\_LL()
and PPC\_BPF\_STL() to factor in the offset value and generate the proper
instruction sequence. We also convert all existing users of PPC\_LD() and
PPC\_STD() to use these macros. All existing uses of these macros have
been audited to ensure that TMP\_REG\_2 can be clobbered.
Fixes: 156d0e290e96 ("powerpc/ebpf/jit: Implement JIT compiler for extended BPF")
Cc: stable@vger.kernel.org # v4.9+
Reported-by: Yauheni Kaliuta
Signed-off-by: Naveen N. Rao
Signed-off-by: Daniel Borkmann
Signed-off-by: Greg Kroah-Hartman
commit a2216e2d0751100397a90422695c6211247b0592
Author: Kohji Okuno
Date: Tue Feb 26 11:34:13 2019 +0900
ARM: imx6q: cpuidle: fix bug that CPU might not wake up at expected time
commit 91740fc8242b4f260cfa4d4536d8551804777fae upstream.
In the current cpuidle implementation for i.MX6q, the CPU that sets
'WAIT\_UNCLOCKED' and the CPU that returns to 'WAIT\_CLOCKED' are always
the same. While the CPU that sets 'WAIT\_UNCLOCKED' is in IDLE state of
"WAIT", if the other CPU wakes up and enters IDLE state of "WFI"
istead of "WAIT", this CPU can not wake up at expired time.
Because, in the case of "WFI", the CPU must be waked up by the local
timer interrupt. But, while 'WAIT\_UNCLOCKED' is set, the local timer
is stopped, when all CPUs execute "wfi" instruction. As a result, the
local timer interrupt is not fired.
In this situation, this CPU will wake up by IRQ different from local
timer. (e.g. broacast timer)
So, this fix changes CPU to return to 'WAIT\_CLOCKED'.
Signed-off-by: Kohji Okuno
Fixes: e5f9dec8ff5f ("ARM: imx6q: support WAIT mode using cpuidle")
Cc:
Signed-off-by: Shawn Guo
Signed-off-by: Greg Kroah-Hartman
commit 8bf47766a9f9f4a716ad83158ccf5272fe3b0b54
Author: Frank Rowand
Date: Thu Mar 21 23:58:20 2019 -0700
tracing: initialize variable in create\_dyn\_event()
commit 3dee10da2e9ff220e054a8f158cc296c797fbe81 upstream.
Fix compile warning in create\_dyn\_event(): 'ret' may be used uninitialized
in this function [-Wuninitialized].
Link: http://lkml.kernel.org/r/1553237900-8555-1-git-send-email-frowand.list@gmail.com
Cc: Masami Hiramatsu
Cc: Ingo Molnar
Cc: Tom Zanussi
Cc: Ravi Bangoria
Cc: stable@vger.kernel.org
Fixes: 5448d44c3855 ("tracing: Add unified dynamic event framework")
Signed-off-by: Frank Rowand
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 7bcb002431ba3d0a2d5c646219a8100914cb3a9d
Author: Jeff Layton
Date: Mon Mar 25 08:15:14 2019 -0400
locks: wake any locks blocked on request before deadlock check
commit 945ab8f6de94430c23a82f3cf2e3f6d6f2945ff7 upstream.
Andreas reported that he was seeing the tdbtorture test fail in some
cases with -EDEADLCK when it wasn't before. Some debugging showed that
deadlock detection was sometimes discovering the caller's lock request
itself in a dependency chain.
While we remove the request from the blocked\_lock\_hash prior to
reattempting to acquire it, any locks that are blocked on that request
will still be present in the hash and will still have their fl\_blocker
pointer set to the current request.
This causes posix\_locks\_deadlock to find a deadlock dependency chain
when it shouldn't, as a lock request cannot block itself.
We are going to end up waking all of those blocked locks anyway when we
go to reinsert the request back into the blocked\_lock\_hash, so just do
it prior to checking for deadlocks. This ensures that any lock blocked
on the current request will no longer be part of any blocked request
chain.
URL: https://bugzilla.kernel.org/show\_bug.cgi?id=202975
Fixes: 5946c4319ebb ("fs/locks: allow a lock request to block other requests.")
Cc: stable@vger.kernel.org
Reported-by: Andreas Schneider
Signed-off-by: Neil Brown
Signed-off-by: Jeff Layton
Signed-off-by: Greg Kroah-Hartman
commit 3ba84d2d75810cd64d4841867ad301e52e4522df
Author: Filipe Manana
Date: Tue Mar 19 17:18:13 2019 +0000
Btrfs: fix assertion failure on fsync with NO\_HOLES enabled
commit 0ccc3876e4b2a1559a4dbe3126dda4459d38a83b upstream.
Back in commit a89ca6f24ffe4 ("Btrfs: fix fsync after truncate when
no\_holes feature is enabled") I added an assertion that is triggered when
an inline extent is found to assert that the length of the (uncompressed)
data the extent represents is the same as the i\_size of the inode, since
that is true most of the time I couldn't find or didn't remembered about
any exception at that time. Later on the assertion was expanded twice to
deal with a case of a compressed inline extent representing a range that
matches the sector size followed by an expanding truncate, and another
case where fallocate can update the i\_size of the inode without adding
or updating existing extents (if the fallocate range falls entirely within
the first block of the file). These two expansion/fixes of the assertion
were done by commit 7ed586d0a8241 ("Btrfs: fix assertion on fsync of
regular file when using no-holes feature") and commit 6399fb5a0b69a
("Btrfs: fix assertion failure during fsync in no-holes mode").
These however missed the case where an falloc expands the i\_size of an
inode to exactly the sector size and inline extent exists, for example:
$ mkfs.btrfs -f -O no-holes /dev/sdc
$ mount /dev/sdc /mnt
$ xfs\_io -f -c "pwrite -S 0xab 0 1096" /mnt/foobar
wrote 1096/1096 bytes at offset 0
1 KiB, 1 ops; 0.0002 sec (4.448 MiB/sec and 4255.3191 ops/sec)
$ xfs\_io -c "falloc 1096 3000" /mnt/foobar
$ xfs\_io -c "fsync" /mnt/foobar
Segmentation fault
$ dmesg
[701253.602385] assertion failed: len == i\_size || (len == fs\_info->sectorsize && btrfs\_file\_extent\_compression(leaf, extent) != BTRFS\_COMPRESS\_NONE) || (len < i\_size && i\_size < fs\_info->sectorsize), file: fs/btrfs/tree-log.c, line: 4727
[701253.602962] ------------[ cut here ]------------
[701253.603224] kernel BUG at fs/btrfs/ctree.h:3533!
[701253.603503] invalid opcode: 0000 [#1] SMP DEBUG\_PAGEALLOC PTI
[701253.603774] CPU: 2 PID: 7192 Comm: xfs\_io Tainted: G W 5.0.0-rc8-btrfs-next-45 #1
[701253.604054] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.11.2-0-gf9626ccb91-prebuilt.qemu-project.org 04/01/2014
[701253.604650] RIP: 0010:assfail.constprop.23+0x18/0x1a [btrfs]
(...)
[701253.605591] RSP: 0018:ffffbb48c186bc48 EFLAGS: 00010286
[701253.605914] RAX: 00000000000000de RBX: ffff921d0a7afc08 RCX: 0000000000000000
[701253.606244] RDX: 0000000000000000 RSI: ffff921d36b16868 RDI: ffff921d36b16868
[701253.606580] RBP: ffffbb48c186bcf0 R08: 0000000000000000 R09: 0000000000000000
[701253.606913] R10: 0000000000000003 R11: 0000000000000000 R12: ffff921d05d2de18
[701253.607247] R13: ffff921d03b54000 R14: 0000000000000448 R15: ffff921d059ecf80
[701253.607769] FS: 00007f14da906700(0000) GS:ffff921d36b00000(0000) knlGS:0000000000000000
[701253.608163] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[701253.608516] CR2: 000056087ea9f278 CR3: 00000002268e8001 CR4: 00000000003606e0
[701253.608880] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[701253.609250] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[701253.609608] Call Trace:
[701253.609994] btrfs\_log\_inode+0xdfb/0xe40 [btrfs]
[701253.610383] btrfs\_log\_inode\_parent+0x2be/0xa60 [btrfs]
[701253.610770] ? do\_raw\_spin\_unlock+0x49/0xc0
[701253.611150] btrfs\_log\_dentry\_safe+0x4a/0x70 [btrfs]
[701253.611537] btrfs\_sync\_file+0x3b2/0x440 [btrfs]
[701253.612010] ? do\_sysinfo+0xb0/0xf0
[701253.612552] do\_fsync+0x38/0x60
[701253.612988] \_\_x64\_sys\_fsync+0x10/0x20
[701253.613360] do\_syscall\_64+0x60/0x1b0
[701253.613733] entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
[701253.614103] RIP: 0033:0x7f14da4e66d0
(...)
[701253.615250] RSP: 002b:00007fffa670fdb8 EFLAGS: 00000246 ORIG\_RAX: 000000000000004a
[701253.615647] RAX: ffffffffffffffda RBX: 0000000000000001 RCX: 00007f14da4e66d0
[701253.616047] RDX: 000056087ea9c260 RSI: 000056087ea9c260 RDI: 0000000000000003
[701253.616450] RBP: 0000000000000001 R08: 0000000000000020 R09: 0000000000000010
[701253.616854] R10: 000000000000009b R11: 0000000000000246 R12: 000056087ea9c260
[701253.617257] R13: 000056087ea9c240 R14: 0000000000000000 R15: 000056087ea9dd10
(...)
[701253.619941] ---[ end trace e088d74f132b6da5 ]---
Updating the assertion again to allow for this particular case would result
in a meaningless assertion, plus there is currently no risk of logging
content that would result in any corruption after a log replay if the size
of the data encoded in an inline extent is greater than the inode's i\_size
(which is not currently possibe either with or without compression),
therefore just remove the assertion.
CC: stable@vger.kernel.org # 4.4+
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 84104398e6f33bc8d1e64177bd4e205e355dce42
Author: Nikolay Borisov
Date: Mon Mar 18 17:45:20 2019 +0200
btrfs: Avoid possible qgroup\_rsv\_size overflow in btrfs\_calculate\_inode\_block\_rsv\_size
commit 139a56170de67101791d6e6c8e940c6328393fe9 upstream.
qgroup\_rsv\_size is calculated as the product of
outstanding\_extent \* fs\_info->nodesize. The product is calculated with
32 bit precision since both variables are defined as u32. Yet
qgroup\_rsv\_size expects a 64 bit result.
Avoid possible multiplication overflow by casting outstanding\_extent to
u64. Such overflow would in the worst case (64K nodesize) require more
than 65536 extents, which is quite large and i'ts not likely that it
would happen in practice.
Fixes-coverity-id: 1435101
Fixes: ff6bc37eb7f6 ("btrfs: qgroup: Use independent and accurate per inode qgroup rsv")
CC: stable@vger.kernel.org # 4.19+
Reviewed-by: Qu Wenruo
Signed-off-by: Nikolay Borisov
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit e3a605636a80164fa90f0a8b97a033ae790d9509
Author: Nikolay Borisov
Date: Mon Mar 18 17:45:19 2019 +0200
btrfs: Fix bound checking in qgroup\_trace\_new\_subtree\_blocks
commit 7ff2c2a1a71e83f74574b8001ea88deb3c166ad7 upstream.
If 'cur\_level' is 7 then the bound checking at the top of the function
will actually pass. Later on, it's possible to dereference
ds\_path->nodes[cur\_level+1] which will be an out of bounds.
The correct check will be cur\_level >= BTRFS\_MAX\_LEVEL - 1 .
Fixes-coverty-id: 1440918
Fixes-coverty-id: 1440911
Fixes: ea49f3e73c4b ("btrfs: qgroup: Introduce function to find all new tree blocks of reloc tree")
CC: stable@vger.kernel.org # 4.20+
Reviewed-by: Qu Wenruo
Signed-off-by: Nikolay Borisov
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 4a0584a21542fe8000f72258a3884bfc65668a7e
Author: Andrea Righi
Date: Thu Mar 14 08:56:28 2019 +0100
btrfs: raid56: properly unmap parity page in finish\_parity\_scrub()
commit 3897b6f0a859288c22fb793fad11ec2327e60fcd upstream.
Parity page is incorrectly unmapped in finish\_parity\_scrub(), triggering
a reference counter bug on i386, i.e.:
[ 157.662401] kernel BUG at mm/highmem.c:349!
[ 157.666725] invalid opcode: 0000 [#1] SMP PTI
The reason is that kunmap(p\_page) was completely left out, so we never
did an unmap for the p\_page and the loop unmapping the rbio page was
iterating over the wrong number of stripes: unmapping should be done
with nr\_data instead of rbio->real\_stripes.
Test case to reproduce the bug:
- create a raid5 btrfs filesystem:
# mkfs.btrfs -m raid5 -d raid5 /dev/sdb /dev/sdc /dev/sdd /dev/sde
- mount it:
# mount /dev/sdb /mnt
- run btrfs scrub in a loop:
# while :; do btrfs scrub start -BR /mnt; done
BugLink: https://bugs.launchpad.net/bugs/1812845
Fixes: 5a6ac9eacb49 ("Btrfs, raid56: support parity scrub on raid56")
CC: stable@vger.kernel.org # 4.4+
Reviewed-by: Johannes Thumshirn
Signed-off-by: Andrea Righi
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit da2dea634c2223ce6a3492dd3aaa06aa43c1a6d1
Author: David Sterba
Date: Thu Mar 7 15:40:50 2019 +0100
btrfs: don't report readahead errors and don't update statistics
commit 0cc068e6ee59c1fffbfa977d8bf868b7551d80ac upstream.
As readahead is an optimization, all errors are usually filtered out,
but still properly handled when the real read call is done. The commit
5e9d398240b2 ("btrfs: readpages() should submit IO as read-ahead") added
REQ\_RAHEAD to readpages() because that's only used for readahead
(despite what one would expect from the callback name).
This causes a flood of messages and inflated read error stats, so skip
reporting in case it's readahead.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=202403
Reported-by: LimeTech
Fixes: 5e9d398240b2 ("btrfs: readpages() should submit IO as read-ahead")
CC: stable@vger.kernel.org # 4.19+
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 70c88bf99441e63087f64c614bd2ff1d81bcdcdf
Author: Josef Bacik
Date: Wed Mar 6 17:13:04 2019 -0500
btrfs: remove WARN\_ON in log\_dir\_items
commit 2cc8334270e281815c3850c3adea363c51f21e0d upstream.
When Filipe added the recursive directory logging stuff in
2f2ff0ee5e430 ("Btrfs: fix metadata inconsistencies after directory
fsync") he specifically didn't take the directory i\_mutex for the
children directories that we need to log because of lockdep. This is
generally fine, but can lead to this WARN\_ON() tripping if we happen to
run delayed deletion's in between our first search and our second search
of dir\_item/dir\_indexes for this directory. We expect this to happen,
so the WARN\_ON() isn't necessary. Drop the WARN\_ON() and add a comment
so we know why this case can happen.
CC: stable@vger.kernel.org # 4.4+
Reviewed-by: Filipe Manana
Signed-off-by: Josef Bacik
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit ab0600d45dd9faf6a27ae75caa08ac02b3b0a723
Author: Filipe Manana
Date: Mon Mar 4 14:06:12 2019 +0000
Btrfs: fix incorrect file size after shrinking truncate and fsync
commit bf504110bc8aa05df48b0e5f0aa84bfb81e0574b upstream.
If we do a shrinking truncate against an inode which is already present
in the respective log tree and then rename it, as part of logging the new
name we end up logging an inode item that reflects the old size of the
file (the one which we previously logged) and not the new smaller size.
The decision to preserve the size previously logged was added by commit
1a4bcf470c886b ("Btrfs: fix fsync data loss after adding hard link to
inode") in order to avoid data loss after replaying the log. However that
decision is only needed for the case the logged inode size is smaller then
the current size of the inode, as explained in that commit's change log.
If the current size of the inode is smaller then the previously logged
size, we know a shrinking truncate happened and therefore need to use
that smaller size.
Example to trigger the problem:
$ mkfs.btrfs -f /dev/sdb
$ mount /dev/sdb /mnt
$ xfs\_io -f -c "pwrite -S 0xab 0 8000" /mnt/foo
$ xfs\_io -c "fsync" /mnt/foo
$ xfs\_io -c "truncate 3000" /mnt/foo
$ mv /mnt/foo /mnt/bar
$ xfs\_io -c "fsync" /mnt/bar
$ mount /dev/sdb /mnt
$ od -t x1 -A d /mnt/bar
0000000 ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab ab
\*
0008000
Once we rename the file, we log its name (and inode item), and because
the inode was already logged before in the current transaction, we log it
with a size of 8000 bytes because that is the size we previously logged
(with the first fsync). As part of the rename, besides logging the inode,
we do also sync the log, which is done since commit d4682ba03ef618
("Btrfs: sync log after logging new name"), so the next fsync against our
inode is effectively a no-op, since no new changes happened since the
rename operation. Even if did not sync the log during the rename
operation, the same problem (fize size of 8000 bytes instead of 3000
bytes) would be visible after replaying the log if the log ended up
getting synced to disk through some other means, such as for example by
fsyncing some other modified file. In the example above the fsync after
the rename operation is there just because not every filesystem may
guarantee logging/journalling the inode (and syncing the log/journal)
during the rename operation, for example it is needed for f2fs, but not
for ext4 and xfs.
Fix this scenario by, when logging a new name (which is triggered by
rename and link operations), using the current size of the inode instead
of the previously logged inode size.
A test case for fstests follows soon.
Bugzilla: https://bugzilla.kernel.org/show\_bug.cgi?id=202695
CC: stable@vger.kernel.org # 4.4+
Reported-by: Seulbae Kim
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 0253563b8be5358ada3907f008a6642a1f326470
Author: Christophe Leroy
Date: Tue Feb 26 18:18:48 2019 +0000
powerpc/fsl: Fix the flush of branch predictor.
commit 27da80719ef132cf8c80eb406d5aeb37dddf78cc upstream.
The commit identified below adds MC\_BTB\_FLUSH macro only when
CONFIG\_PPC\_FSL\_BOOK3E is defined. This results in the following error
on some configs (seen several times with kisskb randconfig\_defconfig)
arch/powerpc/kernel/exceptions-64e.S:576: Error: Unrecognized opcode: `mc\_btb\_flush'
make[3]: \*\*\* [scripts/Makefile.build:367: arch/powerpc/kernel/exceptions-64e.o] Error 1
make[2]: \*\*\* [scripts/Makefile.build:492: arch/powerpc/kernel] Error 2
make[1]: \*\*\* [Makefile:1043: arch/powerpc] Error 2
make: \*\*\* [Makefile:152: sub-make] Error 2
This patch adds a blank definition of MC\_BTB\_FLUSH for other cases.
Fixes: 10c5e83afd4a ("powerpc/fsl: Flush the branch predictor at each kernel entry (64bit)")
Cc: Diana Craciun
Signed-off-by: Christophe Leroy
Reviewed-by: Daniel Axtens
Reviewed-by: Diana Craciun
Signed-off-by: Michael Ellerman
Signed-off-by: Greg Kroah-Hartman
commit bb06073a9cad930f5c8bb5f433dcd478c26608dd
Author: Eric Dumazet
Date: Sat Mar 16 13:09:53 2019 -0700
tun: add a missing rcu\_read\_unlock() in error path
commit 9180bb4f046064dfa4541488102703b402bb04e1 upstream.
In my latest patch I missed one rcu\_read\_unlock(), in case
device is down.
Fixes: 4477138fa0ae ("tun: properly test for IFF\_UP")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d01bf3762e290a58d7f1941a42b13322f7803564
Author: Herbert Xu
Date: Tue Mar 26 13:50:14 2019 +0800
ila: Fix rhashtable walker list corruption
[ Upstream commit b5f9bd15b88563b55a99ed588416881367a0ce5f ]
ila\_xlat\_nl\_cmd\_flush uses rhashtable walkers allocated from the
stack but it never frees them. This corrupts the walker list of
the hash table.
This patch fixes it.
Reported-by: syzbot+dae72a112334aa65a159@syzkaller.appspotmail.com
Fixes: b6e71bdebb12 ("ila: Flush netlink command to clear xlat...")
Signed-off-by: Herbert Xu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 4951fc65d9153deded3d066ab371a61977c96e8a
Author: Heiner Kallweit
Date: Fri Mar 22 07:39:35 2019 +0100
r8169: fix cable re-plugging issue
[ Upstream commit 23c78343ec36990709b636a9e02bad814f4384ad ]
Bartek reported that after few cable unplug/replug cycles suddenly
replug isn't detected any longer. His system uses a RTL8106, I wasn't
able to reproduce the issue with RTL8168g. According to his bisect
the referenced commit caused the regression. As Realtek doesn't
release datasheets or errata it's hard to say what's the actual root
cause, but this change was reported to fix the issue.
Fixes: 38caff5a445b ("r8169: handle all interrupt events in the hard irq handler")
Reported-by: Bartosz Skrzypczak
Suggested-by: Bartosz Skrzypczak
Tested-by: Bartosz Skrzypczak
Signed-off-by: Heiner Kallweit
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit fc8f36de77111bf925d19f347c21134542941a3c
Author: Heiner Kallweit
Date: Fri Mar 22 20:00:20 2019 +0100
net: phy: don't clear BMCR in genphy\_soft\_reset
[ Upstream commit d29f5aa0bc0c321e1b9e4658a2a7e08e885da52a ]
So far we effectively clear the BMCR register. Some PHY's can deal
with this (e.g. because they reset BMCR to a default as part of a
soft-reset) whilst on others this causes issues because e.g. the
autoneg bit is cleared. Marvell is an example, see also thread [0].
So let's be a little bit more gentle and leave all bits we're not
interested in as-is. This change is needed for PHY drivers to
properly deal with the original patch.
[0] https://marc.info/?t=155264050700001&r=1&w=2
Fixes: 6e2d85ec0559 ("net: phy: Stop with excessive soft reset")
Tested-by: Phil Reid
Tested-by: liweihang
Signed-off-by: Heiner Kallweit
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit aa3f1b029e4b664330a7f00ff80d8713f26921dc
Author: Claudiu Manoil
Date: Tue Mar 26 11:48:57 2019 +0200
net: mii: Fix PAUSE cap advertisement from linkmode\_adv\_to\_lcl\_adv\_t() helper
[ Upstream commit 7f07e5f1f778605e98cf2156d4db1ff3a3a1a74a ]
With a recent link mode advertisement code update this helper
providing local pause capability translation used for flow
control link mode negotiation got broken.
For eth drivers using this helper, the issue is apparent only
if either PAUSE or ASYM\_PAUSE is being advertised.
Fixes: 3c1bcc8614db ("net: ethernet: Convert phydev advertize and supported from u32 to link mode")
Signed-off-by: Claudiu Manoil
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d9c13ecbf7c571775cb82bf59fbee2d9908cab80
Author: Heiner Kallweit
Date: Sat Mar 23 19:41:32 2019 +0100
net: dsa: mv88e6xxx: fix few issues in mv88e6390x\_port\_set\_cmode
[ Upstream commit 5ceaeb99ffb4dc002d20f6ac243c19a85e2c7a76 ]
This patches fixes few issues in mv88e6390x\_port\_set\_cmode().
1. When entering the function the old cmode may be 0, in this case
mv88e6390x\_serdes\_get\_lane() returns -ENODEV. As result we bail
out and have no chance to set a new mode. Therefore deal properly
with -ENODEV.
2. Once we have disabled power and irq, let's set the cached cmode to 0.
This reflects the actual status and is cleaner if we bail out with an
error in the following function calls.
3. The cached cmode is used by mv88e6390x\_serdes\_get\_lane(),
mv88e6390\_serdes\_power\_lane() and mv88e6390\_serdes\_irq\_enable().
Currently we set the cached mode to the new one at the very end of
the function only, means until then we use the old one what may be
wrong.
4. When calling mv88e6390\_serdes\_irq\_enable() we use the lane value
belonging to the old cmode. Get the lane belonging to the new cmode
before calling this function.
It's hard to provide a good "Fixes" tag because quite a few smaller
changes have been done to the code in question recently.
Fixes: d235c48b40d3 ("net: dsa: mv88e6xxx: power serdes on/off for 10G interfaces on 6390X")
Signed-off-by: Heiner Kallweit
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 98bfc778c5d962a8505a08569c42f849d3aa80d8
Author: Dean Nelson
Date: Tue Mar 26 11:53:26 2019 -0400
thunderx: eliminate extra calls to put\_page() for pages held for recycling
[ Upstream commit cd35ef91490ad8049dd180bb060aff7ee192eda9 ]
For the non-XDP case, commit 773225388dae15e72790 ("net: thunderx: Optimize
page recycling for XDP") added code to nicvf\_free\_rbdr() that, when releasing
the additional receive buffer page reference held for recycling, repeatedly
calls put\_page() until the page's \_refcount goes to zero. Which results in
the page being freed.
This is not okay if the page's \_refcount was greater than 1 (in the non-XDP
case), because nicvf\_free\_rbdr() should not be subtracting more than what
nicvf\_alloc\_page() had previously added to the page's \_refcount, which was
only 1 (in the non-XDP case).
This can arise if a received packet is still being processed and the receive
buffer (i.e., skb->head) has not yet been freed via skb\_free\_head() when
nicvf\_free\_rbdr() is spinning through the aforementioned put\_page() loop.
If this should occur, when the received packet finishes processing and
skb\_free\_head() is called, various problems can ensue. Exactly what, depends on
whether the page has already been reallocated or not, anything from "BUG: Bad
page state ... ", to "Unable to handle kernel NULL pointer dereference ..." or
"Unable to handle kernel paging request...".
So this patch changes nicvf\_free\_rbdr() to only call put\_page() once for pages
held for recycling (in the non-XDP case).
Fixes: 773225388dae ("net: thunderx: Optimize page recycling for XDP")
Signed-off-by: Dean Nelson
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 10792c33d060090ff6f44aaa20f8db2d35632b56
Author: Dean Nelson
Date: Tue Mar 26 11:53:19 2019 -0400
thunderx: enable page recycling for non-XDP case
[ Upstream commit b3e208069477588c06f4d5d986164b435bb06e6d ]
Commit 773225388dae15e72790 ("net: thunderx: Optimize page recycling for XDP")
added code to nicvf\_alloc\_page() that inadvertently disables receive buffer
page recycling for the non-XDP case by always NULL'ng the page pointer.
This patch corrects two if-conditionals to allow for the recycling of non-XDP
mode pages by only setting the page pointer to NULL when the page is not ready
for recycling.
Fixes: 773225388dae ("net: thunderx: Optimize page recycling for XDP")
Signed-off-by: Dean Nelson
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 0c421524c1f161999144c98af0fecdcee6dbc73f
Author: Zhiqiang Liu
Date: Sat Mar 16 17:02:54 2019 +0800
vxlan: Don't call gro\_cells\_destroy() before device is unregistered
[ Upstream commit cc4807bb609230d8959fd732b0bf3bd4c2de8eac ]
Commit ad6c9986bcb62 ("vxlan: Fix GRO cells race condition between
receive and link delete") fixed a race condition for the typical case a vxlan
device is dismantled from the current netns. But if a netns is dismantled,
vxlan\_destroy\_tunnels() is called to schedule a unregister\_netdevice\_queue()
of all the vxlan tunnels that are related to this netns.
In vxlan\_destroy\_tunnels(), gro\_cells\_destroy() is called and finished before
unregister\_netdevice\_queue(). This means that the gro\_cells\_destroy() call is
done too soon, for the same reasons explained in above commit.
So we need to fully respect the RCU rules, and thus must remove the
gro\_cells\_destroy() call or risk use after-free.
Fixes: 58ce31cca1ff ("vxlan: GRO support at tunnel layer")
Signed-off-by: Suanming.Mou
Suggested-by: Eric Dumazet
Reviewed-by: Stefano Brivio
Reviewed-by: Zhiqiang Liu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1a44391e1d03a310261aff9fe83abd963ddb2c2e
Author: Sabrina Dubroca
Date: Tue Mar 26 18:22:16 2019 +0100
vrf: prevent adding upper devices
[ Upstream commit 1017e0987117c32783ba7c10fe2e7ff1456ba1dc ]
VRF devices don't work with upper devices. Currently, it's possible to
add a VRF device to a bridge or team, and to create macvlan, macsec, or
ipvlan devices on top of a VRF (bond and vlan are prevented respectively
by the lack of an ndo\_set\_mac\_address op and the NETIF\_F\_VLAN\_CHALLENGED
feature flag).
Fix this by setting the IFF\_NO\_RX\_HANDLER flag (introduced in commit
f5426250a6ec ("net: introduce IFF\_NO\_RX\_HANDLER")).
Cc: David Ahern
Fixes: 193125dbd8eb ("net: Introduce VRF device driver")
Signed-off-by: Sabrina Dubroca
Acked-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e269f5f55c063cc8e7f7be1231dcb2c51ccebc71
Author: Eric Dumazet
Date: Thu Mar 14 20:19:47 2019 -0700
tun: properly test for IFF\_UP
[ Upstream commit 4477138fa0ae4e1b699786ef0600863ea6e6c61c ]
Same reasons than the ones explained in commit 4179cb5a4c92
("vxlan: test dev->flags & IFF\_UP before calling netif\_rx()")
netif\_rx\_ni() or napi\_gro\_frags() must be called under a strict contract.
At device dismantle phase, core networking clears IFF\_UP
and flush\_all\_backlogs() is called after rcu grace period
to make sure no incoming packet might be in a cpu backlog
and still referencing the device.
A similar protocol is used for gro layer.
Most drivers call netif\_rx() from their interrupt handler,
and since the interrupts are disabled at device dismantle,
netif\_rx() does not have to check dev->flags & IFF\_UP
Virtual drivers do not have this guarantee, and must
therefore make the check themselves.
Fixes: 1bd4978a88ac ("tun: honor IFF\_UP in tun\_get\_user()")
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 9868ffd44b2554253c1377a0577aea67ea8b7ca4
Author: Erik Hugne
Date: Thu Mar 21 09:11:59 2019 +0100
tipc: fix cancellation of topology subscriptions
[ Upstream commit 33872d79f5d1cbedaaab79669cc38f16097a9450 ]
When cancelling a subscription, we have to clear the cancel bit in the
request before iterating over any established subscriptions with memcmp.
Otherwise no subscription will ever be found, and it will not be
possible to explicitly unsubscribe individual subscriptions.
Fixes: 8985ecc7c1e0 ("tipc: simplify endianness handling in topology subscriber")
Signed-off-by: Erik Hugne
Signed-off-by: Jon Maloy
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit e13fbdf6e872a3bbd4c2d727e746a5f83b793b28
Author: Xin Long
Date: Sun Mar 24 00:48:22 2019 +0800
tipc: change to check tipc\_own\_id to return in tipc\_net\_stop
[ Upstream commit 9926cb5f8b0f0aea535735185600d74db7608550 ]
When running a syz script, a panic occurred:
[ 156.088228] BUG: KASAN: use-after-free in tipc\_disc\_timeout+0x9c9/0xb20 [tipc]
[ 156.094315] Call Trace:
[ 156.094844]
[ 156.095306] dump\_stack+0x7c/0xc0
[ 156.097346] print\_address\_description+0x65/0x22e
[ 156.100445] kasan\_report.cold.3+0x37/0x7a
[ 156.102402] tipc\_disc\_timeout+0x9c9/0xb20 [tipc]
[ 156.106517] call\_timer\_fn+0x19a/0x610
[ 156.112749] run\_timer\_softirq+0xb51/0x1090
It was caused by the netns freed without deleting the discoverer timer,
while later on the netns would be accessed in the timer handler.
The timer should have been deleted by tipc\_net\_stop() when cleaning up a
netns. However, tipc has been able to enable a bearer and start d->timer
without the local node\_addr set since Commit 52dfae5c85a4 ("tipc: obtain
node identity from interface by default"), which caused the timer not to
be deleted in tipc\_net\_stop() then.
So fix it in tipc\_net\_stop() by changing to check local node\_id instead
of local node\_addr, as Jon suggested.
While at it, remove the calling of tipc\_nametbl\_withdraw() there, since
tipc\_nametbl\_stop() will take of the nametbl's freeing after.
Fixes: 52dfae5c85a4 ("tipc: obtain node identity from interface by default")
Reported-by: syzbot+a25307ad099309f1c2b9@syzkaller.appspotmail.com
Signed-off-by: Xin Long
Acked-by: Ying Xue
Acked-by: Jon Maloy
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 30e2a9a38d0c07af07eddc0db2a685a9e2b89af6
Author: Erik Hugne
Date: Sun Mar 17 18:46:42 2019 +0100
tipc: allow service ranges to be connect()'ed on RDM/DGRAM
[ Upstream commit ea239314fe42ace880bdd834256834679346c80e ]
We move the check that prevents connecting service ranges to after
the RDM/DGRAM check, and move address sanity control to a separate
function that also validates the service range.
Fixes: 23998835be98 ("tipc: improve address sanity check in tipc\_connect()")
Signed-off-by: Erik Hugne
Signed-off-by: Jon Maloy
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 632f3ed848bcadece46e1494f149c0d28a277205
Author: Eric Dumazet
Date: Tue Mar 19 05:45:35 2019 -0700
tcp: do not use ipv6 header for ipv4 flow
[ Upstream commit 89e4130939a20304f4059ab72179da81f5347528 ]
When a dual stack tcp listener accepts an ipv4 flow,
it should not attempt to use an ipv6 header or tcp\_v6\_iif() helper.
Fixes: 1397ed35f22d ("ipv6: add flowinfo for tcp6 pkt\_options for all cases")
Fixes: df3687ffc665 ("ipv6: add the IPV6\_FL\_F\_REFLECT flag to IPV6\_FL\_A\_GET")
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 118ad2c7de1d1d91bebec1430b4c47e3f5ebaa99
Author: Xin Long
Date: Wed Mar 20 14:49:38 2019 +0800
sctp: use memdup\_user instead of vmemdup\_user
[ Upstream commit ef82bcfa671b9a635bab5fa669005663d8b177c5 ]
In sctp\_setsockopt\_bindx()/\_\_sctp\_setsockopt\_connectx(), it allocates
memory with addrs\_size which is passed from userspace. We used flag
GFP\_USER to put some more restrictions on it in Commit cacc06215271
("sctp: use GFP\_USER for user-controlled kmalloc").
However, since Commit c981f254cc82 ("sctp: use vmemdup\_user() rather
than badly open-coding memdup\_user()"), vmemdup\_user() has been used,
which doesn't check GFP\_USER flag when goes to vmalloc\_\*(). So when
addrs\_size is a huge value, it could exhaust memory and even trigger
oom killer.
This patch is to use memdup\_user() instead, in which GFP\_USER would
work to limit the memory allocation with a huge addrs\_size.
Note we can't fix it by limiting 'addrs\_size', as there's no demand
for it from RFC.
Reported-by: syzbot+ec1b7575afef85a0e5ca@syzkaller.appspotmail.com
Fixes: c981f254cc82 ("sctp: use vmemdup\_user() rather than badly open-coding memdup\_user()")
Signed-off-by: Xin Long
Acked-by: Neil Horman
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit d2af0ce54b1cbc82813b388b759877a2c6e53265
Author: Xin Long
Date: Mon Mar 18 19:47:00 2019 +0800
sctp: get sctphdr by offset in sctp\_compute\_cksum
[ Upstream commit 273160ffc6b993c7c91627f5a84799c66dfe4dee ]
sctp\_hdr(skb) only works when skb->transport\_header is set properly.
But in Netfilter, skb->transport\_header for ipv6 is not guaranteed
to be right value for sctphdr. It would cause to fail to check the
checksum for sctp packets.
So fix it by using offset, which is always right in all places.
v1->v2:
- Fix the changelog.
Fixes: e6d8b64b34aa ("net: sctp: fix and consolidate SCTP checksumming code")
Reported-by: Li Shuang
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 5a336f69cfa0cf9c2abf2e865b01458ef4a9ebbd
Author: Herbert Xu
Date: Thu Mar 21 09:39:52 2019 +0800
rhashtable: Still do rehash when we get EEXIST
[ Upstream commit 408f13ef358aa5ad56dc6230c2c7deb92cf462b1 ]
As it stands if a shrink is delayed because of an outstanding
rehash, we will go into a rescheduling loop without ever doing
the rehash.
This patch fixes this by still carrying out the rehash and then
rescheduling so that we can shrink after the completion of the
rehash should it still be necessary.
The return value of EEXIST captures this case and other cases
(e.g., another thread expanded/rehashed the table at the same
time) where we should still proceed with the rehash.
Fixes: da20420f83ea ("rhashtable: Add nested tables")
Reported-by: Josh Elsasser
Signed-off-by: Herbert Xu
Tested-by: Josh Elsasser
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 278c7d7e4ecbfd9feb62492a4a98c21c7941faa8
Author: Maxime Chevallier
Date: Sat Mar 16 14:41:30 2019 +0100
packets: Always register packet sk in the same order
[ Upstream commit a4dc6a49156b1f8d6e17251ffda17c9e6a5db78a ]
When using fanouts with AF\_PACKET, the demux functions such as
fanout\_demux\_cpu will return an index in the fanout socket array, which
corresponds to the selected socket.
The ordering of this array depends on the order the sockets were added
to a given fanout group, so for FANOUT\_CPU this means sockets are bound
to cpus in the order they are configured, which is OK.
However, when stopping then restarting the interface these sockets are
bound to, the sockets are reassigned to the fanout group in the reverse
order, due to the fact that they were inserted at the head of the
interface's AF\_PACKET socket list.
This means that traffic that was directed to the first socket in the
fanout group is now directed to the last one after an interface restart.
In the case of FANOUT\_CPU, traffic from CPU0 will be directed to the
socket that used to receive traffic from the last CPU after an interface
restart.
This commit introduces a helper to add a socket at the tail of a list,
then uses it to register AF\_PACKET sockets.
Note that this changes the order in which sockets are listed in /proc and
with sock\_diag.
Fixes: dc99f600698d ("packet: Add fanout support")
Signed-off-by: Maxime Chevallier
Acked-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 970d4fb2a2318961b4d981358fd12d8d415aa42d
Author: Dmitry Bezrukov
Date: Sat Mar 23 13:59:53 2019 +0000
net: usb: aqc111: Extend HWID table by QNAP device
[ Upstream commit b7ebee2f95fb0fa2862d5ed2de707f872c311393 ]
New device of QNAP based on aqc111u
Add this ID to blacklist of cdc\_ether driver as well
Signed-off-by: Dmitry Bezrukov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 566e793d051fe42834ba5e80c573f6c65506c7b9
Author: YueHaibing
Date: Tue Mar 19 10:16:53 2019 +0800
net-sysfs: call dev\_hold if kobject\_init\_and\_add success
[ Upstream commit a3e23f719f5c4a38ffb3d30c8d7632a4ed8ccd9e ]
In netdev\_queue\_add\_kobject and rx\_queue\_add\_kobject,
if sysfs\_create\_group failed, kobject\_put will call
netdev\_queue\_release to decrease dev refcont, however
dev\_hold has not be called. So we will see this while
unregistering dev:
unregister\_netdevice: waiting for bcsh0 to become free. Usage count = -1
Reported-by: Hulk Robot
Fixes: d0d668371679 ("net: don't decrement kobj reference count on init failure")
Signed-off-by: YueHaibing
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 1b925f484028db4adf8922c493c8bae2f8f9567f
Author: Aaro Koskinen
Date: Mon Mar 18 23:36:08 2019 +0200
net: stmmac: fix memory corruption with large MTUs
[ Upstream commit 223a960c01227e4dbcb6f9fa06b47d73bda21274 ]
When using 16K DMA buffers and ring mode, the DES3 refill is not working
correctly as the function is using a bogus pointer for checking the
private data. As a result stale pointers will remain in the RX descriptor
ring, so DMA will now likely overwrite/corrupt some already freed memory.
As simple reproducer, just receive some UDP traffic:
# ifconfig eth0 down; ifconfig eth0 mtu 9000; ifconfig eth0 up
# iperf3 -c 192.168.253.40 -u -b 0 -R
If you didn't crash by now check the RX descriptors to find non-contiguous
RX buffers:
cat /sys/kernel/debug/stmmaceth/eth0/descriptors\_status
[...]
1 [0x2be5020]: 0xa3220321 0x9ffc1ffc 0x72d70082 0x130e207e
^^^^^^^^^^^^^^^^^^^^^
2 [0x2be5040]: 0xa3220321 0x9ffc1ffc 0x72998082 0x1311a07e
^^^^^^^^^^^^^^^^^^^^^
A simple ping test will now report bad data:
# ping -s 8200 192.168.253.40
PING 192.168.253.40 (192.168.253.40) 8200(8228) bytes of data.
8208 bytes from 192.168.253.40: icmp\_seq=1 ttl=64 time=1.00 ms
wrong data byte #8144 should be 0xd0 but was 0x88
Fix the wrong pointer. Also we must refill DES3 only if the DMA buffer
size is 16K.
Fixes: 54139cf3bb33 ("net: stmmac: adding multiple buffers for rx")
Signed-off-by: Aaro Koskinen
Acked-by: Jose Abreu
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8cf288b55da92dc5ea87cf51a6bbddc09f8cdb22
Author: Eric Dumazet
Date: Fri Mar 15 10:41:14 2019 -0700
net: rose: fix a possible stack overflow
[ Upstream commit e5dcc0c3223c45c94100f05f28d8ef814db3d82c ]
rose\_write\_internal() uses a temp buffer of 100 bytes, but a manual
inspection showed that given arbitrary input, rose\_create\_facilities()
can fill up to 110 bytes.
Lets use a tailroom of 256 bytes for peace of mind, and remove
the bounce buffer : we can simply allocate a big enough skb
and adjust its length as needed.
syzbot report :
BUG: KASAN: stack-out-of-bounds in memcpy include/linux/string.h:352 [inline]
BUG: KASAN: stack-out-of-bounds in rose\_create\_facilities net/rose/rose\_subr.c:521 [inline]
BUG: KASAN: stack-out-of-bounds in rose\_write\_internal+0x597/0x15d0 net/rose/rose\_subr.c:116
Write of size 7 at addr ffff88808b1ffbef by task syz-executor.0/24854
CPU: 0 PID: 24854 Comm: syz-executor.0 Not tainted 5.0.0+ #97
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0x172/0x1f0 lib/dump\_stack.c:113
print\_address\_description.cold+0x7c/0x20d mm/kasan/report.c:187
kasan\_report.cold+0x1b/0x40 mm/kasan/report.c:317
check\_memory\_region\_inline mm/kasan/generic.c:185 [inline]
check\_memory\_region+0x123/0x190 mm/kasan/generic.c:191
memcpy+0x38/0x50 mm/kasan/common.c:131
memcpy include/linux/string.h:352 [inline]
rose\_create\_facilities net/rose/rose\_subr.c:521 [inline]
rose\_write\_internal+0x597/0x15d0 net/rose/rose\_subr.c:116
rose\_connect+0x7cb/0x1510 net/rose/af\_rose.c:826
\_\_sys\_connect+0x266/0x330 net/socket.c:1685
\_\_do\_sys\_connect net/socket.c:1696 [inline]
\_\_se\_sys\_connect net/socket.c:1693 [inline]
\_\_x64\_sys\_connect+0x73/0xb0 net/socket.c:1693
do\_syscall\_64+0x103/0x610 arch/x86/entry/common.c:290
entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
RIP: 0033:0x458079
Code: ad b8 fb ff c3 66 2e 0f 1f 84 00 00 00 00 00 66 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 0f 83 7b b8 fb ff c3 66 2e 0f 1f 84 00 00 00 00
RSP: 002b:00007f47b8d9dc78 EFLAGS: 00000246 ORIG\_RAX: 000000000000002a
RAX: ffffffffffffffda RBX: 0000000000000003 RCX: 0000000000458079
RDX: 000000000000001c RSI: 0000000020000040 RDI: 0000000000000004
RBP: 000000000073bf00 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00007f47b8d9e6d4
R13: 00000000004be4a4 R14: 00000000004ceca8 R15: 00000000ffffffff
The buggy address belongs to the page:
page:ffffea00022c7fc0 count:0 mapcount:0 mapping:0000000000000000 index:0x0
flags: 0x1fffc0000000000()
raw: 01fffc0000000000 0000000000000000 ffffffff022c0101 0000000000000000
raw: 0000000000000000 0000000000000000 00000000ffffffff 0000000000000000
page dumped because: kasan: bad access detected
Memory state around the buggy address:
ffff88808b1ffa80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
ffff88808b1ffb00: 00 00 00 00 00 00 00 00 f1 f1 f1 f1 00 00 00 03
>ffff88808b1ffb80: f2 f2 00 00 00 00 00 00 00 00 00 00 00 00 04 f3
^
ffff88808b1ffc00: f3 f3 f3 f3 00 00 00 00 00 00 00 00 00 00 00 00
ffff88808b1ffc80: 00 00 00 00 00 00 00 f1 f1 f1 f1 f1 f1 01 f2 01
Signed-off-by: Eric Dumazet
Reported-by: syzbot
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit baa14468e57d26cf23c058af3c89edf59b3cabec
Author: Jerome Brunet
Date: Thu Mar 14 14:49:45 2019 +0100
net: phy: meson-gxl: fix interrupt support
[ Upstream commit daa5c4d0167a308306525fd5ab9a5e18e21f4f74 ]
If an interrupt is already pending when the interrupt is enabled on the
GXL phy, no IRQ will ever be triggered.
The fix is simply to make sure pending IRQs are cleared before setting
up the irq mask.
Fixes: cf127ff20af1 ("net: phy: meson-gxl: add interrupt support")
Signed-off-by: Jerome Brunet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3ca86ad4e57a84262f2386e5b06302ebc4c8b5d4
Author: Christoph Paasch
Date: Mon Mar 18 23:14:52 2019 -0700
net/packet: Set \_\_GFP\_NOWARN upon allocation in alloc\_pg\_vec
[ Upstream commit 398f0132c14754fcd03c1c4f8e7176d001ce8ea1 ]
Since commit fc62814d690c ("net/packet: fix 4gb buffer limit due to overflow check")
one can now allocate packet ring buffers >= UINT\_MAX. However, syzkaller
found that that triggers a warning:
[ 21.100000] WARNING: CPU: 2 PID: 2075 at mm/page\_alloc.c:4584 \_\_alloc\_pages\_nod0
[ 21.101490] Modules linked in:
[ 21.101921] CPU: 2 PID: 2075 Comm: syz-executor.0 Not tainted 5.0.0 #146
[ 21.102784] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 0.5.1 01/01/2011
[ 21.103887] RIP: 0010:\_\_alloc\_pages\_nodemask+0x2a0/0x630
[ 21.104640] Code: fe ff ff 65 48 8b 04 25 c0 de 01 00 48 05 90 0f 00 00 41 bd 01 00 00 00 48 89 44 24 48 e9 9c fe 3
[ 21.107121] RSP: 0018:ffff88805e1cf920 EFLAGS: 00010246
[ 21.107819] RAX: 0000000000000000 RBX: ffffffff85a488a0 RCX: 0000000000000000
[ 21.108753] RDX: 0000000000000000 RSI: dffffc0000000000 RDI: 0000000000000000
[ 21.109699] RBP: 1ffff1100bc39f28 R08: ffffed100bcefb67 R09: ffffed100bcefb67
[ 21.110646] R10: 0000000000000001 R11: ffffed100bcefb66 R12: 000000000000000d
[ 21.111623] R13: 0000000000000000 R14: ffff88805e77d888 R15: 000000000000000d
[ 21.112552] FS: 00007f7c7de05700(0000) GS:ffff88806d100000(0000) knlGS:0000000000000000
[ 21.113612] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 21.114405] CR2: 000000000065c000 CR3: 000000005e58e006 CR4: 00000000001606e0
[ 21.115367] Call Trace:
[ 21.115705] ? \_\_alloc\_pages\_slowpath+0x21c0/0x21c0
[ 21.116362] alloc\_pages\_current+0xac/0x1e0
[ 21.116923] kmalloc\_order+0x18/0x70
[ 21.117393] kmalloc\_order\_trace+0x18/0x110
[ 21.117949] packet\_set\_ring+0x9d5/0x1770
[ 21.118524] ? packet\_rcv\_spkt+0x440/0x440
[ 21.119094] ? lock\_downgrade+0x620/0x620
[ 21.119646] ? \_\_might\_fault+0x177/0x1b0
[ 21.120177] packet\_setsockopt+0x981/0x2940
[ 21.120753] ? \_\_fget+0x2fb/0x4b0
[ 21.121209] ? packet\_release+0xab0/0xab0
[ 21.121740] ? sock\_has\_perm+0x1cd/0x260
[ 21.122297] ? selinux\_secmark\_relabel\_packet+0xd0/0xd0
[ 21.123013] ? \_\_fget+0x324/0x4b0
[ 21.123451] ? selinux\_netlbl\_socket\_setsockopt+0x101/0x320
[ 21.124186] ? selinux\_netlbl\_sock\_rcv\_skb+0x3a0/0x3a0
[ 21.124908] ? \_\_lock\_acquire+0x529/0x3200
[ 21.125453] ? selinux\_socket\_setsockopt+0x5d/0x70
[ 21.126075] ? \_\_sys\_setsockopt+0x131/0x210
[ 21.126533] ? packet\_release+0xab0/0xab0
[ 21.127004] \_\_sys\_setsockopt+0x131/0x210
[ 21.127449] ? kernel\_accept+0x2f0/0x2f0
[ 21.127911] ? ret\_from\_fork+0x8/0x50
[ 21.128313] ? do\_raw\_spin\_lock+0x11b/0x280
[ 21.128800] \_\_x64\_sys\_setsockopt+0xba/0x150
[ 21.129271] ? lockdep\_hardirqs\_on+0x37f/0x560
[ 21.129769] do\_syscall\_64+0x9f/0x450
[ 21.130182] entry\_SYSCALL\_64\_after\_hwframe+0x49/0xbe
We should allocate with \_\_GFP\_NOWARN to handle this.
Cc: Kal Conley
Cc: Andrey Konovalov
Fixes: fc62814d690c ("net/packet: fix 4gb buffer limit due to overflow check")
Signed-off-by: Christoph Paasch
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 475af63497f85c452cbc7546e4f091456498de5c
Author: Paolo Abeni
Date: Mon Mar 25 14:18:06 2019 +0100
net: datagram: fix unbounded loop in \_\_skb\_try\_recv\_datagram()
[ Upstream commit 0b91bce1ebfc797ff3de60c8f4a1e6219a8a3187 ]
Christoph reported a stall while peeking datagram with an offset when
busy polling is enabled. \_\_skb\_try\_recv\_datagram() uses as the loop
termination condition 'queue empty'. When peeking, the socket
queue can be not empty, even when no additional packets are received.
Address the issue explicitly checking for receive queue changes,
as currently done by \_\_skb\_wait\_for\_more\_packets().
Fixes: 2b5cd0dfa384 ("net: Change return type of sk\_busy\_loop from bool to void")
Reported-and-tested-by: Christoph Paasch
Signed-off-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 017c90da5d8ff1bc8e8d9be41eab18f8633e682f
Author: Dmitry Bogdanov
Date: Sat Mar 16 08:28:18 2019 +0000
net: aquantia: fix rx checksum offload for UDP/TCP over IPv6
[ Upstream commit a7faaa0c5dc7d091cc9f72b870d7edcdd6f43f12 ]
TCP/UDP checksum validity was propagated to skb
only if IP checksum is valid.
But for IPv6 there is no validity as there is no checksum in IPv6.
This patch propagates TCP/UDP checksum validity regardless of IP checksum.
Fixes: 018423e90bee ("net: ethernet: aquantia: Add ring support code")
Signed-off-by: Igor Russkikh
Signed-off-by: Nikita Danilov
Signed-off-by: Dmitry Bogdanov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3e5c1acf0637855cb9a057cdbae277a64bbff7d9
Author: Bjorn Helgaas
Date: Mon Mar 18 08:51:06 2019 -0500
mISDN: hfcpci: Test both vendor & device ID for Digium HFC4S
[ Upstream commit fae846e2b7124d4b076ef17791c73addf3b26350 ]
The device ID alone does not uniquely identify a device. Test both the
vendor and device ID to make sure we don't mistakenly think some other
vendor's 0xB410 device is a Digium HFC4S. Also, instead of the bare hex
ID, use the same constant (PCI\_DEVICE\_ID\_DIGIUM\_HFC4S) used in the device
ID table.
No functional change intended.
Signed-off-by: Bjorn Helgaas
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 780e62a6a021bb136a8e297dd3f432eb2dda3361
Author: Finn Thain
Date: Sat Mar 16 14:21:19 2019 +1100
mac8390: Fix mmio access size probe
[ Upstream commit bb9e5c5bcd76f4474eac3baf643d7a39f7bac7bb ]
The bug that Stan reported is as follows. After a restart, a 16-bit NIC
may be incorrectly identified as a 32-bit NIC and stop working.
mac8390 slot.E: Memory length resource not found, probing
mac8390 slot.E: Farallon EtherMac II-C (type farallon)
mac8390 slot.E: MAC 00:00:c5:30:c2:99, IRQ 61, 32 KB shared memory at 0xfeed0000, 32-bit access.
The bug never arises after a cold start and only intermittently after a
warm start. (I didn't investigate why the bug is intermittent.)
It turns out that memcpy\_toio() is deprecated and memcmp\_withio() also
has issues. Replacing these calls with mmio accessors fixes the problem.
Reported-and-tested-by: Stan Johnson
Fixes: 2964db0f5904 ("m68k: Mac DP8390 update")
Signed-off-by: Finn Thain
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 282c70c23454fd62d4571a1a6f6482900b3e5ee4
Author: Xin Long
Date: Wed Mar 20 14:45:48 2019 +0800
ipv6: make ip6\_create\_rt\_rcu return ip6\_null\_entry instead of NULL
[ Upstream commit 1c87e79a002f6a159396138cd3f3ab554a2a8887 ]
Jianlin reported a crash:
[ 381.484332] BUG: unable to handle kernel NULL pointer dereference at 0000000000000068
[ 381.619802] RIP: 0010:fib6\_rule\_lookup+0xa3/0x160
[ 382.009615] Call Trace:
[ 382.020762]
[ 382.030174] ip6\_route\_redirect.isra.52+0xc9/0xf0
[ 382.050984] ip6\_redirect+0xb6/0xf0
[ 382.066731] icmpv6\_notify+0xca/0x190
[ 382.083185] ndisc\_redirect\_rcv+0x10f/0x160
[ 382.102569] ndisc\_rcv+0xfb/0x100
[ 382.117725] icmpv6\_rcv+0x3f2/0x520
[ 382.133637] ip6\_input\_finish+0xbf/0x460
[ 382.151634] ip6\_input+0x3b/0xb0
[ 382.166097] ipv6\_rcv+0x378/0x4e0
It was caused by the lookup function \_\_ip6\_route\_redirect() returns NULL in
fib6\_rule\_lookup() when ip6\_create\_rt\_rcu() returns NULL.
So we fix it by simply making ip6\_create\_rt\_rcu() return ip6\_null\_entry
instead of NULL.
v1->v2:
- move down 'fallback:' to make it more readable.
Fixes: e873e4b9cc7e ("ipv6: use fib6\_info\_hold\_safe() when necessary")
Reported-by: Jianlin Shi
Suggested-by: Paolo Abeni
Signed-off-by: Xin Long
Reviewed-by: David Ahern
Acked-by: Wei Wang
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 8122233e877a4d4632885e466f00144fea54acb3
Author: Matteo Croce
Date: Sat Mar 16 01:00:50 2019 +0100
gtp: change NET\_UDP\_TUNNEL dependency to select
[ Upstream commit c22da36688d6298f2e546dcc43fdc1ad35036467 ]
Similarly to commit a7603ac1fc8c ("geneve: change NET\_UDP\_TUNNEL
dependency to select"), GTP has a dependency on NET\_UDP\_TUNNEL which
makes impossible to compile it if no other protocol depending on
NET\_UDP\_TUNNEL is selected.
Fix this by changing the depends to a select, and drop NET\_IP\_TUNNEL from
the select list, as it already depends on NET\_UDP\_TUNNEL.
Signed-off-by: Matteo Croce
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit bd60a788b10b6b10cc7d53a41a8a53a300705690
Author: YueHaibing
Date: Thu Mar 21 15:02:50 2019 +0800
genetlink: Fix a memory leak on error path
[ Upstream commit ceabee6c59943bdd5e1da1a6a20dc7ee5f8113a2 ]
In genl\_register\_family(), when idr\_alloc() fails,
we forget to free the memory we possibly allocate for
family->attrbuf.
Reported-by: Hulk Robot
Fixes: 2ae0f17df1cd ("genetlink: use idr to track families")
Signed-off-by: YueHaibing
Reviewed-by: Kirill Tkhai
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 3b58f24bdfec7d0297da4c304107364d95271607
Author: Eric Dumazet
Date: Tue Mar 19 05:46:18 2019 -0700
dccp: do not use ipv6 header for ipv4 flow
[ Upstream commit e0aa67709f89d08c8d8e5bdd9e0b649df61d0090 ]
When a dual stack dccp listener accepts an ipv4 flow,
it should not attempt to use an ipv6 header or
inet6\_iif() helper.
Fixes: 3df80d9320bc ("[DCCP]: Introduce DCCPv6")
Signed-off-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 400dded59397da860e31f42810c027c115067dcb
Author: Pablo Neira Ayuso
Date: Fri Mar 8 00:58:53 2019 +0100
netfilter: nf\_tables: fix set double-free in abort path
[ Upstream commit 40ba1d9b4d19796afc9b7ece872f5f3e8f5e2c13 ]
The abort path can cause a double-free of an anonymous set.
Added-and-to-be-aborted rule looks like this:
udp dport { 137, 138 } drop
The to-be-aborted transaction list looks like this:
newset
newsetelem
newsetelem
rule
This gets walked in reverse order, so first pass disables the rule, the
set elements, then the set.
After synchronize\_rcu(), we then destroy those in same order: rule, set
element, set element, newset.
Problem is that the anonymous set has already been bound to the rule, so
the rule (lookup expression destructor) already frees the set, when then
cause use-after-free when trying to delete the elements from this set,
then try to free the set again when handling the newset expression.
Rule releases the bound set in first place from the abort path, this
causes the use-after-free on set element removal when undoing the new
element transactions. To handle this, skip new element transaction if
set is bound from the abort path.
This is still causes the use-after-free on set element removal. To
handle this, remove transaction from the list when the set is already
bound.
Joint work with Florian Westphal.
Fixes: f6ac85858976 ("netfilter: nf\_tables: unbind set in rule from commit path")
Bugzilla: https://bugzilla.netfilter.org/show\_bug.cgi?id=1325
Acked-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
Signed-off-by: Greg Kroah-Hartman
commit a556547bae00528f24b42786b41a14047db14b84
Author: Marcel Holtmann
Date: Fri Jan 18 13:43:19 2019 +0100
Bluetooth: Verify that l2cap\_get\_conf\_opt provides large enough buffer
commit 7c9cbd0b5e38a1672fcd137894ace3b042dfbf69 upstream.
The function l2cap\_get\_conf\_opt will return L2CAP\_CONF\_OPT\_SIZE + opt->len
as length value. The opt->len however is in control over the remote user
and can be used by an attacker to gain access beyond the bounds of the
actual packet.
To prevent any potential leak of heap memory, it is enough to check that
the resulting len calculation after calling l2cap\_get\_conf\_opt is not
below zero. A well formed packet will always return >= 0 here and will
end with the length value being zero after the last option has been
parsed. In case of malformed packets messing with the opt->len field the
length value will become negative. If that is the case, then just abort
and ignore the option.
In case an attacker uses a too short opt->len value, then garbage will
be parsed, but that is protected by the unknown option handling and also
the option parameter size checks.
Signed-off-by: Marcel Holtmann
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Johan Hedberg
Signed-off-by: Greg Kroah-Hartman
commit 8dac9b8d27b504734429cb0be541425a216ccba2
Author: Marcel Holtmann
Date: Fri Jan 18 12:56:20 2019 +0100
Bluetooth: Check L2CAP option sizes returned from l2cap\_get\_conf\_opt
commit af3d5d1c87664a4f150fcf3534c6567cb19909b0 upstream.
When doing option parsing for standard type values of 1, 2 or 4 octets,
the value is converted directly into a variable instead of a pointer. To
avoid being tricked into being a pointer, check that for these option
types that sizes actually match. In L2CAP every option is fixed size and
thus it is prudent anyway to ensure that the remote side sends us the
right option size along with option paramters.
If the option size is not matching the option type, then that option is
silently ignored. It is a protocol violation and instead of trying to
give the remote attacker any further hints just pretend that option is
not present and proceed with the default values. Implementation
following the specification and its qualification procedures will always
use the correct size and thus not being impacted here.
To keep the code readable and consistent accross all options, a few
cosmetic changes were also required.
Signed-off-by: Marcel Holtmann
Reviewed-by: Greg Kroah-Hartman
Signed-off-by: Johan Hedberg
Signed-off-by: Greg Kroah-Hartman

