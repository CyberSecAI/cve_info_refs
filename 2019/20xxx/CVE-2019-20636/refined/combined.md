=== Content from lists.debian.org_e8a44d58_20250121_010149.html ===


---

[[Date Prev](msg00010.html)][[Date Next](msg00012.html)]
[[Thread Prev](msg00010.html)][[Thread Next](msg00012.html)]
[[Date Index](maillist.html#00011)]
[[Thread Index](threads.html#00011)]

# [SECURITY] [DLA 2241-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 2241-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Tue, 09 Jun 2020 22:29:32 +0100
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/1747f9196b0ccb9346b57f15681d74c04217c837.camel%40debian.org)Â [1747f9196b0ccb9346b57f15681d74c04217c837.camel@debian.org](msg00011.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux
Version        : 3.16.84-1
CVE ID         : CVE-2015-8839 CVE-2018-14610 CVE-2018-14611 CVE-2018-14612
                 CVE-2018-14613 CVE-2019-5108 CVE-2019-19319 CVE-2019-19447
                 CVE-2019-19768 CVE-2019-20636 CVE-2020-0009 CVE-2020-0543
                 CVE-2020-1749 CVE-2020-2732 CVE-2020-8647 CVE-2020-8648
                 CVE-2020-8649 CVE-2020-9383 CVE-2020-10690 CVE-2020-10751
                 CVE-2020-10942 CVE-2020-11494 CVE-2020-11565 CVE-2020-11608
                 CVE-2020-11609 CVE-2020-11668 CVE-2020-12114 CVE-2020-12464
                 CVE-2020-12652 CVE-2020-12653 CVE-2020-12654 CVE-2020-12769
                 CVE-2020-12770 CVE-2020-12826 CVE-2020-13143

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2015-8839

    A race condition was found in the ext4 filesystem implementation.
    A local user could exploit this to cause a denial of service
    (filesystem corruption).

CVE-2018-14610, CVE-2018-14611, CVE-2018-14612, CVE-2018-14613

    Wen Xu from SSLab at Gatech reported that crafted Btrfs volumes
    could trigger a crash (Oops) and/or out-of-bounds memory access.
    An attacker able to mount such a volume could use this to cause a
    denial of service or possibly for privilege escalation.

CVE-2019-5108

    Mitchell Frank of Cisco discovered that when the IEEE 802.11
    (WiFi) stack was used in AP mode with roaming, it would trigger
    roaming for a newly associated station before the station was
    authenticated.  An attacker within range of the AP could use this
    to cause a denial of service, either by filling up a switching
    table or by redirecting traffic away from other stations.

CVE-2019-19319

    Jungyeon discovered that a crafted filesystem can cause the ext4
    implementation to deallocate or reallocate journal blocks.  A user
    permitted to mount filesystems could use this to cause a denial of
    service (crash), or possibly for privilege escalation.

CVE-2019-19447

    It was discovered that the ext4 filesystem driver did not safely
    handle unlinking of an inode that, due to filesystem corruption,
    already has a link count of 0.  An attacker able to mount
    arbitrary ext4 volumes could use this to cause a denial of service
    (memory corruption or crash) or possibly for privilege escalation.

CVE-2019-19768

    Tristan Madani reported a race condition in the blktrace debug
    facility that could result in a use-after-free.  A local user able
    to trigger removal of block devices could possibly use this to
    cause a denial of service (crash) or for privilege escalation.

CVE-2019-20636

    The syzbot tool found that the input subsystem did not fully
    validate keycode changes, which could result in a heap
    out-of-bounds write.  A local user permitted to access the device
    node for an input or VT device could possibly use this to cause a
    denial of service (crash or memory corruption) or for privilege
    escalation.

CVE-2020-0009

    Jann Horn reported that the Android ashmem driver did not prevent
    read-only files from being memory-mapped and then remapped as
    read-write.  However, Android drivers are not enabled in Debian
    kernel configurations.

CVE-2020-0543

    Researchers at VU Amsterdam discovered that on some Intel CPUs
    supporting the RDRAND and RDSEED instructions, part of a random
    value generated by these instructions may be used in a later
    speculative execution on any core of the same physical CPU.
    Depending on how these instructions are used by applications, a
    local user or VM guest could use this to obtain sensitive
    information such as cryptographic keys from other users or VMs.

    This vulnerability can be mitigated by a microcode update, either
    as part of system firmware (BIOS) or through the intel-microcode
    package in Debian's non-free archive section.  This kernel update
    only provides reporting of the vulnerability and the option to
    disable the mitigation if it is not needed.

CVE-2020-1749

    Xiumei Mu reported that some network protocols that can run on top
    of IPv6 would bypass the Transformation (XFRM) layer used by
    IPsec, IPcomp/IPcomp6, IPIP, and IPv6 Mobility.  This could result
    in disclosure of information over the network, since it would not
    be encrypted or routed according to the system policy.

CVE-2020-2732

    Paulo Bonzini discovered that the KVM implementation for Intel
    processors did not properly handle instruction emulation for L2
    guests when nested virtualization is enabled. This could allow an
    L2 guest to cause privilege escalation, denial of service, or
    information leaks in the L1 guest.

CVE-2020-8647, CVE-2020-8649

    The Hulk Robot tool found a potential MMIO out-of-bounds access in
    the vgacon driver.  A local user permitted to access a virtual
    terminal (/dev/tty1 etc.) on a system using the vgacon driver
    could use this to cause a denial of service (crash or memory
    corruption) or possibly for privilege escalation.

CVE-2020-8648

    The syzbot tool found a race condition in the the virtual terminal
    driver, which could result in a use-after-free.  A local user
    permitted to access a virtual terminal could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-9383

    Jordy Zomer reported an incorrect range check in the floppy driver
    which could lead to a static out-of-bounds access.  A local user
    permitted to access a floppy drive could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-10690

    It was discovered that the PTP hardware clock subsystem did not
    properly manage device lifetimes.  Removing a PTP hardware clock
    from the system while a user process was using it could lead to a
    use-after-free.  The security impact of this is unclear.

CVE-2020-10751

    Dmitry Vyukov reported that the SELinux subsystem did not properly
    handle validating multiple messages, which could allow a privileged
    attacker to bypass SELinux netlink restrictions.

CVE-2020-10942

    It was discovered that the vhost_net driver did not properly
    validate the type of sockets set as back-ends. A local user
    permitted to access /dev/vhost-net could use this to cause a stack
    corruption via crafted system calls, resulting in denial of
    service (crash) or possibly privilege escalation.

CVE-2020-11494

    It was discovered that the slcan (serial line CAN) network driver
    did not fully initialise CAN headers for received packets,
    resulting in an information leak from the kernel to user-space or
    over the CAN network.

CVE-2020-11565

    Entropy Moe reported that the shared memory filesystem (tmpfs) did
    not correctly handle an "mpol" mount option specifying an empty
    node list, leading to a stack-based out-of-bounds write. If user
    namespaces are enabled, a local user could use this to cause a
    denial of service (crash) or possibly for privilege escalation.

CVE-2020-11608, CVE-2020-11609, CVE-2020-11668

    It was discovered that the ov519, stv06xx, and xirlink_cit media
    drivers did not properly validate USB device descriptors.  A
    physically present user with a specially constructed USB device
    could use this to cause a denial-of-service (crash) or possibly
    for privilege escalation.

CVE-2020-12114

    Piotr Krysiuk discovered a race condition between the umount and
    pivot_root operations in the filesystem core (vfs).  A local user
    with the CAP_SYS_ADMIN capability in any user namespace could use
    this to cause a denial of service (crash).

CVE-2020-12464

    Kyungtae Kim reported a race condition in the USB core that can
    result in a use-after-free.  It is not clear how this can be
    exploited, but it could result in a denial of service (crash or
    memory corruption) or privilege escalation.

CVE-2020-12652

    Tom Hatskevich reported a bug in the mptfusion storage drivers.
    An ioctl handler fetched a parameter from user memory twice,
    creating a race condition which could result in incorrect locking
    of internal data structures.  A local user permitted to access
    /dev/mptctl could use this to cause a denial of service (crash or
    memory corruption) or for privilege escalation.

CVE-2020-12653

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate scan requests, resulting a potential heap
    buffer overflow.  A local user with CAP_NET_ADMIN capability could
    use this to cause a denial of service (crash or memory corruption)
    or possibly for privilege escalation.

CVE-2020-12654

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate WMM parameters received from an access point
    (AP), resulting a potential heap buffer overflow.  A malicious AP
    could use this to cause a denial of service (crash or memory
    corruption) or possibly to execute code on a vulnerable system.

CVE-2020-12769

    It was discovered that the spi-dw SPI host driver did not properly
    serialise access to its internal state.  The security impact of
    this is unclear, and this driver is not included in Debian's
    binary packages.

CVE-2020-12770

    It was discovered that the sg (SCSI generic) driver did not
    correctly release internal resources in a particular error case.
    A local user permitted to access an sg device could possibly use
    this to cause a denial of service (resource exhaustion).

CVE-2020-12826

    Adam Zabrocki reported a weakness in the signal subsystem's
    permission checks.  A parent process can choose an arbitary signal
    for a child process to send when it exits, but if the parent has
    executed a new program then the default SIGCHLD signal is sent.  A
    local user permitted to run a program for several days could
    bypass this check, execute a setuid program, and then send an
    arbitrary signal to it.  Depending on the setuid programs
    installed, this could have some security impact.

CVE-2020-13143

    Kyungtae Kim reported a potential heap out-of-bounds write in
    the USB gadget subsystem.  A local user permitted to write to
    the gadget configuration filesystem could use this to cause a
    denial of service (crash or memory corruption) or potentially
    for privilege escalation.

For Debian 8 "Jessie", these problems have been fixed in version
3.16.84-1.

We recommend that you upgrade your linux packages.  Binary packages for
the EABI ARM (armel) architecture are not yet available, and a separate
announcement will be made when they are.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams

```

**Attachment:
[signature.asc](pgpvpMY1PuWto.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from lists.debian.org_4f0c4dca_20250121_010149.html ===


---

[[Date Prev](msg00012.html)][[Date Next](msg00014.html)]
[[Thread Prev](msg00012.html)][[Thread Next](msg00014.html)]
[[Date Index](maillist.html#00013)]
[[Thread Index](threads.html#00013)]

# [SECURITY] [DLA 2241-2] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 2241-2] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Wed, 10 Jun 2020 11:55:23 +0100
* *Message-id*: <[[ðŸ”Ž]](/msgid-search/fa69a9353152b3507fa4914c112f33c44983ef5e.camel%40debian.org)Â [fa69a9353152b3507fa4914c112f33c44983ef5e.camel@debian.org](msg00013.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
Package        : linux
Version        : 3.16.84-1
CVE ID         : CVE-2015-8839 CVE-2018-14610 CVE-2018-14611 CVE-2018-14612
                 CVE-2018-14613 CVE-2019-5108 CVE-2019-19319 CVE-2019-19447
                 CVE-2019-19768 CVE-2019-20636 CVE-2020-0009 CVE-2020-0543
                 CVE-2020-1749 CVE-2020-2732 CVE-2020-8647 CVE-2020-8648
                 CVE-2020-8649 CVE-2020-9383 CVE-2020-10690 CVE-2020-10751
                 CVE-2020-10942 CVE-2020-11494 CVE-2020-11565 CVE-2020-11608
                 CVE-2020-11609 CVE-2020-11668 CVE-2020-12114 CVE-2020-12464
                 CVE-2020-12652 CVE-2020-12653 CVE-2020-12654 CVE-2020-12769
                 CVE-2020-12770 CVE-2020-12826 CVE-2020-13143

This update is now available for all supported architectures.  For
reference the original advisory text follows.

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2015-8839

    A race condition was found in the ext4 filesystem implementation.
    A local user could exploit this to cause a denial of service
    (filesystem corruption).

CVE-2018-14610, CVE-2018-14611, CVE-2018-14612, CVE-2018-14613

    Wen Xu from SSLab at Gatech reported that crafted Btrfs volumes
    could trigger a crash (Oops) and/or out-of-bounds memory access.
    An attacker able to mount such a volume could use this to cause a
    denial of service or possibly for privilege escalation.

CVE-2019-5108

    Mitchell Frank of Cisco discovered that when the IEEE 802.11
    (WiFi) stack was used in AP mode with roaming, it would trigger
    roaming for a newly associated station before the station was
    authenticated.  An attacker within range of the AP could use this
    to cause a denial of service, either by filling up a switching
    table or by redirecting traffic away from other stations.

CVE-2019-19319

    Jungyeon discovered that a crafted filesystem can cause the ext4
    implementation to deallocate or reallocate journal blocks.  A user
    permitted to mount filesystems could use this to cause a denial of
    service (crash), or possibly for privilege escalation.

CVE-2019-19447

    It was discovered that the ext4 filesystem driver did not safely
    handle unlinking of an inode that, due to filesystem corruption,
    already has a link count of 0.  An attacker able to mount
    arbitrary ext4 volumes could use this to cause a denial of service
    (memory corruption or crash) or possibly for privilege escalation.

CVE-2019-19768

    Tristan Madani reported a race condition in the blktrace debug
    facility that could result in a use-after-free.  A local user able
    to trigger removal of block devices could possibly use this to
    cause a denial of service (crash) or for privilege escalation.

CVE-2019-20636

    The syzbot tool found that the input subsystem did not fully
    validate keycode changes, which could result in a heap
    out-of-bounds write.  A local user permitted to access the device
    node for an input or VT device could possibly use this to cause a
    denial of service (crash or memory corruption) or for privilege
    escalation.

CVE-2020-0009

    Jann Horn reported that the Android ashmem driver did not prevent
    read-only files from being memory-mapped and then remapped as
    read-write.  However, Android drivers are not enabled in Debian
    kernel configurations.

CVE-2020-0543

    Researchers at VU Amsterdam discovered that on some Intel CPUs
    supporting the RDRAND and RDSEED instructions, part of a random
    value generated by these instructions may be used in a later
    speculative execution on any core of the same physical CPU.
    Depending on how these instructions are used by applications, a
    local user or VM guest could use this to obtain sensitive
    information such as cryptographic keys from other users or VMs.

    This vulnerability can be mitigated by a microcode update, either
    as part of system firmware (BIOS) or through the intel-microcode
    package in Debian's non-free archive section.  This kernel update
    only provides reporting of the vulnerability and the option to
    disable the mitigation if it is not needed.

CVE-2020-1749

    Xiumei Mu reported that some network protocols that can run on top
    of IPv6 would bypass the Transformation (XFRM) layer used by
    IPsec, IPcomp/IPcomp6, IPIP, and IPv6 Mobility.  This could result
    in disclosure of information over the network, since it would not
    be encrypted or routed according to the system policy.

CVE-2020-2732

    Paulo Bonzini discovered that the KVM implementation for Intel
    processors did not properly handle instruction emulation for L2
    guests when nested virtualization is enabled. This could allow an
    L2 guest to cause privilege escalation, denial of service, or
    information leaks in the L1 guest.

CVE-2020-8647, CVE-2020-8649

    The Hulk Robot tool found a potential MMIO out-of-bounds access in
    the vgacon driver.  A local user permitted to access a virtual
    terminal (/dev/tty1 etc.) on a system using the vgacon driver
    could use this to cause a denial of service (crash or memory
    corruption) or possibly for privilege escalation.

CVE-2020-8648

    The syzbot tool found a race condition in the the virtual terminal
    driver, which could result in a use-after-free.  A local user
    permitted to access a virtual terminal could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-9383

    Jordy Zomer reported an incorrect range check in the floppy driver
    which could lead to a static out-of-bounds access.  A local user
    permitted to access a floppy drive could use this to cause a
    denial of service (crash or memory corruption) or possibly for
    privilege escalation.

CVE-2020-10690

    It was discovered that the PTP hardware clock subsystem did not
    properly manage device lifetimes.  Removing a PTP hardware clock
    from the system while a user process was using it could lead to a
    use-after-free.  The security impact of this is unclear.

CVE-2020-10751

    Dmitry Vyukov reported that the SELinux subsystem did not properly
    handle validating multiple messages, which could allow a privileged
    attacker to bypass SELinux netlink restrictions.

CVE-2020-10942

    It was discovered that the vhost_net driver did not properly
    validate the type of sockets set as back-ends. A local user
    permitted to access /dev/vhost-net could use this to cause a stack
    corruption via crafted system calls, resulting in denial of
    service (crash) or possibly privilege escalation.

CVE-2020-11494

    It was discovered that the slcan (serial line CAN) network driver
    did not fully initialise CAN headers for received packets,
    resulting in an information leak from the kernel to user-space or
    over the CAN network.

CVE-2020-11565

    Entropy Moe reported that the shared memory filesystem (tmpfs) did
    not correctly handle an "mpol" mount option specifying an empty
    node list, leading to a stack-based out-of-bounds write. If user
    namespaces are enabled, a local user could use this to cause a
    denial of service (crash) or possibly for privilege escalation.

CVE-2020-11608, CVE-2020-11609, CVE-2020-11668

    It was discovered that the ov519, stv06xx, and xirlink_cit media
    drivers did not properly validate USB device descriptors.  A
    physically present user with a specially constructed USB device
    could use this to cause a denial-of-service (crash) or possibly
    for privilege escalation.

CVE-2020-12114

    Piotr Krysiuk discovered a race condition between the umount and
    pivot_root operations in the filesystem core (vfs).  A local user
    with the CAP_SYS_ADMIN capability in any user namespace could use
    this to cause a denial of service (crash).

CVE-2020-12464

    Kyungtae Kim reported a race condition in the USB core that can
    result in a use-after-free.  It is not clear how this can be
    exploited, but it could result in a denial of service (crash or
    memory corruption) or privilege escalation.

CVE-2020-12652

    Tom Hatskevich reported a bug in the mptfusion storage drivers.
    An ioctl handler fetched a parameter from user memory twice,
    creating a race condition which could result in incorrect locking
    of internal data structures.  A local user permitted to access
    /dev/mptctl could use this to cause a denial of service (crash or
    memory corruption) or for privilege escalation.

CVE-2020-12653

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate scan requests, resulting a potential heap
    buffer overflow.  A local user with CAP_NET_ADMIN capability could
    use this to cause a denial of service (crash or memory corruption)
    or possibly for privilege escalation.

CVE-2020-12654

    It was discovered that the mwifiex WiFi driver did not
    sufficiently validate WMM parameters received from an access point
    (AP), resulting a potential heap buffer overflow.  A malicious AP
    could use this to cause a denial of service (crash or memory
    corruption) or possibly to execute code on a vulnerable system.

CVE-2020-12769

    It was discovered that the spi-dw SPI host driver did not properly
    serialise access to its internal state.  The security impact of
    this is unclear, and this driver is not included in Debian's
    binary packages.

CVE-2020-12770

    It was discovered that the sg (SCSI generic) driver did not
    correctly release internal resources in a particular error case.
    A local user permitted to access an sg device could possibly use
    this to cause a denial of service (resource exhaustion).

CVE-2020-12826

    Adam Zabrocki reported a weakness in the signal subsystem's
    permission checks.  A parent process can choose an arbitary signal
    for a child process to send when it exits, but if the parent has
    executed a new program then the default SIGCHLD signal is sent.  A
    local user permitted to run a program for several days could
    bypass this check, execute a setuid program, and then send an
    arbitrary signal to it.  Depending on the setuid programs
    installed, this could have some security impact.

CVE-2020-13143

    Kyungtae Kim reported a potential heap out-of-bounds write in
    the USB gadget subsystem.  A local user permitted to write to
    the gadget configuration filesystem could use this to cause a
    denial of service (crash or memory corruption) or potentially
    for privilege escalation.

For Debian 8 "Jessie", these problems have been fixed in version
3.16.84-1.

We recommend that you upgrade your linux packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

--
Ben Hutchings - Debian developer, member of kernel, installer and LTS teams

```

**Attachment:
[signature.asc](pgprA4TYV0cOI.pgp)**

*Description:* This is a digitally signed message part

---



=== Content from security.netapp.com_97af6a77_20250121_010150.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
Ã¦Â—Â¥Ã¦ÂœÂ¬Ã¨ÂªÂž

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [April 2020 Linux Kernel Vulnerabilities in NetApp Products](https://security.netapp.com/advisory/ntap-20200430-0004)

## April 2020 Linux Kernel Vulnerabilities in NetApp Products

circle-check-alt

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close Ã—

#### Subscribe to NTAP-20200430-0004 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20200430-0004 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close Ã—

#### Unsubscribe from NTAP-20200430-0004 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20200430-0004 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20200430-0004
**Version:**
22.0

**Last updated:**
05/01/2024

**Status:**
Final.

**CVEs:** CVE-2019-20636, CVE-2020-11494, CVE-2020-11608, CVE-2020-11609, CVE-2020-11668, CVE-2020-8832, CVE-2020-8835

Overview
#### Summary

Multiple NetApp products incorporate Linux kernel. Linux kernel versions through 5.6.2 are susceptible to vulnerabilities which when successfully exploited could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Impact

Successful exploitation of these vulnerabilities could lead to disclosure of sensitive information, addition or modification of data, or Denial of Service (DoS).

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2019-20636](https://nvd.nist.gov/vuln/detail/CVE-2019-20636) | 6.7 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H |
| [CVE-2020-11494](https://nvd.nist.gov/vuln/detail/CVE-2020-11494) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N |
| [CVE-2020-11608](https://nvd.nist.gov/vuln/detail/CVE-2020-11608) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-11609](https://nvd.nist.gov/vuln/detail/CVE-2020-11609) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H |
| [CVE-2020-11668](https://nvd.nist.gov/vuln/detail/CVE-2020-11668) | 7.1 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H |
| [CVE-2020-8832](https://nvd.nist.gov/vuln/detail/CVE-2020-8832) | 5.5 (MEDIUM) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N |
| [CVE-2020-8835](https://nvd.nist.gov/vuln/detail/CVE-2020-8835) | 7.8 (HIGH) | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

#### References

* <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.4.12>
* <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.6.1>
* <https://cdn.kernel.org/pub/linux/kernel/v5.x/ChangeLog-5.6.2>

Affected Products
#### Affected Products

* AFF Baseboard Management Controller (BMC) - A700s
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* NetApp Cloud Backup (formerly AltaVault)
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire Baseboard Management Controller (BMC)
* NetApp SteelStore Cloud Integrated Storage

#### Products Not Affected

* Active IQ Unified Manager for Linux
* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* Active IQ mobile app
* Astra Trident
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Insights Acquisition Unit
* Cloud Insights Storage Workload Security Agent
* Cloud Insights Telegraf Agent
* Cloud Volumes ONTAP Mediator
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element HealthTools
* Element Plug-in for vCenter Server
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF Service Processor - 8080/8060/8040/8020
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM6 SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster Tiebreaker for clustered Data ONTAP
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Compute Node (Bootstrap OS)
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* NetApp VASA Provider for Clustered Data ONTAP 9.7 and above
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP 9 (formerly Clustered Data ONTAP)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* OnCommand Insight
* OnCommand Workflow Automation
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* Storage Replication Adapter for Clustered Data ONTAP for VMware vSphere 9.7 and above
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID Baseboard Management Controller (BMC)
* StorageGRID9 (9.x and prior)
* System Manager 9.x
* Virtual Storage Console for VMware vSphere 9.7 and above

Remediation
#### Software Versions and Fixes

NetApp's currently available patches are listed below.

| **Product** | **First Fixed in Release** |
| --- | --- |
| **AFF Baseboard Management Controller (BMC) - A700s** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1316622. First fixed versions include the following: 1.87 |
| **FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1316624. First fixed versions include the following: 10.5, 11.6, 12.3 |
| **FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400** | <https://mysupport.netapp.com/site/downloads/firmware/system-firmware-diagnostics> Fixed by bug 1316631. First fixed versions include the following: 13.3 |
| **NetApp Cloud Backup (formerly AltaVault)** | NetApp Cloud Backup (formerly AltaVault) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2880179.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S** | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2876227.html) for more information. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp HCI Baseboard Management Controller (BMC) - H610S** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle/downloads> <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/Storage_Firmware_Bundle/downloads> First fixed in storage firmware version 2.76. |
| **NetApp HCI Baseboard Management Controller (BMC) - H615C** | <https://mysupport.netapp.com/site/products/all/details/netapp-hci/downloads-tab/download/62542/Compute_Firmware_Bundle> First included in Compute Firmware Bundle version 2.146.2-12.5.74. |
| **NetApp SolidFire & HCI Management Node** | <https://mysupport.netapp.com/site/products/all/details/element-software/downloads-tab/download/62654/12.5/> |
| **NetApp SolidFire Baseboard Management Controller (BMC)** | NetApp SolidFire Baseboard Management Controller (BMC) has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2847476.html%20) for more information. |
| **NetApp SteelStore Cloud Integrated Storage** | NetApp SteelStore Cloud Integrated Storage has no plans to address this vulnerability. See the [EOA announcement](https://mysupport.netapp.com/info/communications/ECMLP2397079.html) for more information. |

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

Revision History
#### Status of This Notice

**Final.**

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20200430-0004>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20200430 | Initial Public Release |
| 2.0 | 20200505 | NetApp HCI Baseboard Management Controller (BMC) - H610C, NetApp HCI Baseboard Management Controller (BMC) - H610S, and NetApp HCI Baseboard Management Controller (BMC) - H615C moved to Affected Products and E-Series SANtricity OS Controller Baseboard Management Controller (BMC) - EF600A moved to Products Not Affected |
| 3.0 | 20200507 | Active IQ Unified Manager (formerly OnCommand Unified Manager) for VMware vSphere 9.5 and above, and Cloud Volumes ONTAP Mediator moved to Products Not Affected and FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 moved to Affected Products |
| 4.0 | 20200508 | NetApp HCI Compute Node (Bootstrap OS), NetApp SolidFire & HCI Storage Node (Element Software) moved to Products Not Affected and NetApp SolidFire & HCI Management Node moved to Affected Products |
| 5.0 | 20200515 | AFF Baseboard Management Controller (BMC) - A700s moved to Affected Products |
| 6.0 | 20200522 | FAS/AFF Baseboard Management Controller (BMC), and Service Processor moved to Affected Products |
| 7.0 | 20200618 | NetApp Converged Systems Advisor Agent, and NetApp HCI Baseboard Management Controller (BMC) - H410C moved to Products Not Affected |
| 8.0 | 20200731 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S moved to Affected Products |
| 9.0 | 20200901 | NetApp SteelStore Cloud Integrated Storage moved to Won't Fix status |
| 10.0 | 20201022 | Brocade Fabric Operating System Firmware moved to Products Not Affected |
| 11.0 | 20210414 | FAS/AFF Baseboard Management Controller (BMC), NetApp HCI Baseboard Management Controller (BMC) - H610S added to Software Versions and Fixes, and Service Processor moved to Affected Products |
| 12.0 | 20210421 | FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400 added to Software Versions and Fixes |
| 13.0 | 20210508 | Service Processor moved to Won't Fix status |
| 14.0 | 20210614 | After additional review Service Processor moved from Affected Products to Products Not Affected |
| 15.0 | 20210816 | AFF Baseboard Management Controller (BMC) - A700s added to Software Versions and Fixes |
| 16.0 | 20211012 | NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H300E/H500E/H700E/H410S moved to Won't Fix status |
| 17.0 | 20211101 | NetApp SolidFire Baseboard Management Controller (BMC) moved to Won't Fix status |
| 18.0 | 20220106 | NetApp Cloud Backup (formerly AltaVault) moved to Won't Fix status |
| 19.0 | 20220527 | NetApp SolidFire & HCI Management Node added to Software Versions and Fixes |
| 20.0 | 20220701 | NetApp HCI Baseboard Management Controller (BMC) - H610C and NetApp HCI Baseboard Management Controller (BMC) - H615C added to Software Versions and Fixes, Final status |
| 21.0 | 20221201 | NetApp SolidFire & HCI Management Node removed from Software Versions and Fixes, Interim status |
| 22.0 | 20240501 | NetApp SolidFire & HCI Management Node added to Software Versions and Fixes, Final status |

This document is provided solely for informational purposes. All information is based upon NetAppÃ¢Â€Â™s current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Ã‚Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 Â©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from git.kernel.org_5a7f21bd_20250121_010148.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=cb222aed03d798fc074be55e59d9a112338ee784)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=cb222aed03d798fc074be55e59d9a112338ee784)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cb222aed03d798fc074be55e59d9a112338ee784)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=cb222aed03d798fc074be55e59d9a112338ee784)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dmitry Torokhov <dmitry.torokhov@gmail.com> | 2019-12-13 14:56:16 -0800 |
| --- | --- | --- |
| committer | Dmitry Torokhov <dmitry.torokhov@gmail.com> | 2019-12-13 15:00:42 -0800 |
| commit | [cb222aed03d798fc074be55e59d9a112338ee784](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cb222aed03d798fc074be55e59d9a112338ee784) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=cb222aed03d798fc074be55e59d9a112338ee784)) | |
| tree | [a94ae6b93178d73d0cee45ed20c1a085c17b1f5c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=cb222aed03d798fc074be55e59d9a112338ee784) | |
| parent | [f729a1b0f8df7091cea3729fc0e414f5326e1163](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f729a1b0f8df7091cea3729fc0e414f5326e1163) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=cb222aed03d798fc074be55e59d9a112338ee784&id2=f729a1b0f8df7091cea3729fc0e414f5326e1163)) | |
| download | [linux-cb222aed03d798fc074be55e59d9a112338ee784.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-cb222aed03d798fc074be55e59d9a112338ee784.tar.gz) | |

Input: add safety guards to input\_set\_keycode()If we happen to have a garbage in input device's keycode table with values
too big we'll end up doing clear\_bit() with offset way outside of our
bitmaps, damaging other objects within an input device or even outside of
it. Let's add sanity checks to the returned old keycodes.
Reported-by: syzbot+c769968809f9359b07aa@syzkaller.appspotmail.com
Reported-by: syzbot+76f3a30e88d256644c78@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/r/20191207212757.GA245964@dtor-ws](https://lore.kernel.org/r/20191207212757.GA245964%40dtor-ws)
Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=cb222aed03d798fc074be55e59d9a112338ee784)

| -rw-r--r-- | [drivers/input/input.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/input/input.c?id=cb222aed03d798fc074be55e59d9a112338ee784) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 10 deletions

| diff --git a/drivers/input/input.c b/drivers/input/input.cindex 55086279d044e7..ee6c3234df3634 100644--- a/[drivers/input/input.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/input/input.c?id=f729a1b0f8df7091cea3729fc0e414f5326e1163)+++ b/[drivers/input/input.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/input/input.c?id=cb222aed03d798fc074be55e59d9a112338ee784)@@ -878,16 +878,18 @@ static int input\_default\_setkeycode(struct input\_dev \*dev, } } - \_\_clear\_bit(\*old\_keycode, dev->keybit);- \_\_set\_bit(ke->keycode, dev->keybit);-- for (i = 0; i < dev->keycodemax; i++) {- if (input\_fetch\_keycode(dev, i) == \*old\_keycode) {- \_\_set\_bit(\*old\_keycode, dev->keybit);- break; /\* Setting the bit twice is useless, so break \*/+ if (\*old\_keycode <= KEY\_MAX) {+ \_\_clear\_bit(\*old\_keycode, dev->keybit);+ for (i = 0; i < dev->keycodemax; i++) {+ if (input\_fetch\_keycode(dev, i) == \*old\_keycode) {+ \_\_set\_bit(\*old\_keycode, dev->keybit);+ /\* Setting the bit twice is useless, so break \*/+ break;+ } } } + \_\_set\_bit(ke->keycode, dev->keybit); return 0; } @@ -943,9 +945,13 @@ int input\_set\_keycode(struct input\_dev \*dev, \* Simulate keyup event if keycode is not present \* in the keymap anymore \*/- if (test\_bit(EV\_KEY, dev->evbit) &&- !is\_event\_supported(old\_keycode, dev->keybit, KEY\_MAX) &&- \_\_test\_and\_clear\_bit(old\_keycode, dev->key)) {+ if (old\_keycode > KEY\_MAX) {+ dev\_warn(dev->dev.parent ?: &dev->dev,+ "%s: got too big old keycode %#x\n",+ \_\_func\_\_, old\_keycode);+ } else if (test\_bit(EV\_KEY, dev->evbit) &&+ !is\_event\_supported(old\_keycode, dev->keybit, KEY\_MAX) &&+ \_\_test\_and\_clear\_bit(old\_keycode, dev->key)) { struct input\_value vals[] = { { EV\_KEY, old\_keycode, 0 }, input\_value\_sync |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-21 01:00:25 +0000



=== Content from github.com_aa081d64_20250121_010149.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fcb222aed03d798fc074be55e59d9a112338ee784)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  + [Nonprofits](/solutions/industry/nonprofits)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fcb222aed03d798fc074be55e59d9a112338ee784)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  436](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/cb222aed03d798fc074be55e59d9a112338ee784)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Input: add safety guards to input\_set\_keycode()

[Browse files](/torvalds/linux/tree/cb222aed03d798fc074be55e59d9a112338ee784)
Browse the repository at this point in the history

```
If we happen to have a garbage in input device's keycode table with values
too big we'll end up doing clear_bit() with offset way outside of our
bitmaps, damaging other objects within an input device or even outside of
it. Let's add sanity checks to the returned old keycodes.

Reported-by: syzbot+c769968809f9359b07aa@syzkaller.appspotmail.com
Reported-by: syzbot+76f3a30e88d256644c78@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/r/20191207212757.GA245964@dtor-ws](https://lore.kernel.org/r/20191207212757.GA245964%40dtor-ws)
Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
```

* Loading branch information

[![@dtor](https://avatars.githubusercontent.com/u/1047950?s=40&v=4)](/dtor)

[dtor](/torvalds/linux/commits?author=dtor "View all commits by dtor")
committed
Dec 13, 2019

1 parent
[f729a1b](/torvalds/linux/commit/f729a1b0f8df7091cea3729fc0e414f5326e1163)

commit cb222ae

Showing
**1 changed file**
with
**16 additions**
and
**10 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

26 changes: 16 additions & 10 deletions

26
[drivers/input/input.c](#diff-f012d304aaee646647823ef3cede77ff8a0a3a984cdea0276416348eaa1fb441 "drivers/input/input.c")

Show comments

[View file](/torvalds/linux/blob/cb222aed03d798fc074be55e59d9a112338ee784/drivers/input/input.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -878,16 +878,18 @@ static int input\_default\_setkeycode(struct input\_dev \*dev, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | \_\_clear\_bit(\*old\_keycode, dev->keybit); |
|  |  | \_\_set\_bit(ke->keycode, dev->keybit); |
|  |  |  |
|  |  | for (i = 0; i < dev->keycodemax; i++) { |
|  |  | if (input\_fetch\_keycode(dev, i) == \*old\_keycode) { |
|  |  | \_\_set\_bit(\*old\_keycode, dev->keybit); |
|  |  | break; /\* Setting the bit twice is useless, so break \*/ |
|  |  | if (\*old\_keycode <= KEY\_MAX) { |
|  |  | \_\_clear\_bit(\*old\_keycode, dev->keybit); |
|  |  | for (i = 0; i < dev->keycodemax; i++) { |
|  |  | if (input\_fetch\_keycode(dev, i) == \*old\_keycode) { |
|  |  | \_\_set\_bit(\*old\_keycode, dev->keybit); |
|  |  | /\* Setting the bit twice is useless, so break \*/ |
|  |  | break; |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | \_\_set\_bit(ke->keycode, dev->keybit); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -943,9 +945,13 @@ int input\_set\_keycode(struct input\_dev \*dev, |
|  |  | \* Simulate keyup event if keycode is not present |
|  |  | \* in the keymap anymore |
|  |  | \*/ |
|  |  | if (test\_bit(EV\_KEY, dev->evbit) && |
|  |  | !is\_event\_supported(old\_keycode, dev->keybit, KEY\_MAX) && |
|  |  | \_\_test\_and\_clear\_bit(old\_keycode, dev->key)) { |
|  |  | if (old\_keycode > KEY\_MAX) { |
|  |  | dev\_warn(dev->dev.parent ?: &dev->dev, |
|  |  | "%s: got too big old keycode %#x\n", |
|  |  | \_\_func\_\_, old\_keycode); |
|  |  | } else if (test\_bit(EV\_KEY, dev->evbit) && |
|  |  | !is\_event\_supported(old\_keycode, dev->keybit, KEY\_MAX) && |
|  |  | \_\_test\_and\_clear\_bit(old\_keycode, dev->key)) { |
|  |  | struct input\_value vals[] = { |
|  |  | { EV\_KEY, old\_keycode, 0 }, |
|  |  | input\_value\_sync |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `cb222ae`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2Fcb222aed03d798fc074be55e59d9a112338ee784) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.



=== Content from cdn.kernel.org_4d331203_20250121_010148.html ===
commit adc0acf587768b7db6ca1d7c395a9116865c9e07
Author: Greg Kroah-Hartman
Date: Tue Jan 14 20:08:40 2020 +0100
Linux 5.4.12
commit 53b9bd37af59d1def99b20707536105857eb9bd0
Author: Akeem G Abodunrin
Date: Wed Jan 8 09:34:16 2020 -0800
drm/i915/gen9: Clear residual context state on context switch
commit bc8a76a152c5f9ef3b48104154a65a68a8b76946 upstream.
Intel ID: PSIRT-TA-201910-001
CVEID: CVE-2019-14615
Intel GPU Hardware prior to Gen11 does not clear EU state
during a context switch. This can result in information
leakage between contexts.
For Gen8 and Gen9, hardware provides a mechanism for
fast cleardown of the EU state, by issuing a PIPE\_CONTROL
with bit 27 set. We can use this in a context batch buffer
to explicitly cleardown the state on every context switch.
As this workaround is already in place for gen8, we can borrow
the code verbatim for Gen9.
Signed-off-by: Mika Kuoppala
Signed-off-by: Akeem G Abodunrin
Cc: Kumar Valsan Prathap
Cc: Chris Wilson
Cc: Balestrieri Francesco
Cc: Bloomfield Jon
Cc: Dutt Sudeep
Signed-off-by: Greg Kroah-Hartman
commit f58642c1bc7946c315d8617d61916f754d90583f
Author: Florian Westphal
Date: Wed Jan 8 10:59:38 2020 +0100
netfilter: ipset: avoid null deref when IPSET\_ATTR\_LINENO is present
commit 22dad713b8a5ff488e07b821195270672f486eb2 upstream.
The set uadt functions assume lineno is never NULL, but it is in
case of ip\_set\_utest().
syzkaller managed to generate a netlink message that calls this with
LINENO attr present:
general protection fault: 0000 [#1] PREEMPT SMP KASAN
RIP: 0010:hash\_mac4\_uadt+0x1bc/0x470 net/netfilter/ipset/ip\_set\_hash\_mac.c:104
Call Trace:
ip\_set\_utest+0x55b/0x890 net/netfilter/ipset/ip\_set\_core.c:1867
nfnetlink\_rcv\_msg+0xcf2/0xfb0 net/netfilter/nfnetlink.c:229
netlink\_rcv\_skb+0x177/0x450 net/netlink/af\_netlink.c:2477
nfnetlink\_rcv+0x1ba/0x460 net/netfilter/nfnetlink.c:563
pass a dummy lineno storage, its easier than patching all set
implementations.
This seems to be a day-0 bug.
Cc: Jozsef Kadlecsik
Reported-by: syzbot+34bd2369d38707f3f4a7@syzkaller.appspotmail.com
Fixes: a7b4f989a6294 ("netfilter: ipset: IP set core support")
Signed-off-by: Florian Westphal
Acked-by: Jozsef Kadlecsik
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 99a55d8a7fa4c788afc74d6e5ded8903d1712d1a
Author: Florian Westphal
Date: Mon Jan 6 23:34:17 2020 +0100
netfilter: conntrack: dccp, sctp: handle null timeout argument
commit 1d9a7acd3d1e74c2d150d8934f7f55bed6d70858 upstream.
The timeout pointer can be NULL which means we should modify the
per-nets timeout instead.
All do this, except sctp and dccp which instead give:
general protection fault: 0000 [#1] PREEMPT SMP KASAN
net/netfilter/nf\_conntrack\_proto\_dccp.c:682
ctnl\_timeout\_parse\_policy+0x150/0x1d0 net/netfilter/nfnetlink\_cttimeout.c:67
cttimeout\_default\_set+0x150/0x1c0 net/netfilter/nfnetlink\_cttimeout.c:368
nfnetlink\_rcv\_msg+0xcf2/0xfb0 net/netfilter/nfnetlink.c:229
netlink\_rcv\_skb+0x177/0x450 net/netlink/af\_netlink.c:2477
Reported-by: syzbot+46a4ad33f345d1dd346e@syzkaller.appspotmail.com
Fixes: c779e849608a8 ("netfilter: conntrack: remove get\_timeout() indirection")
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 503ff0dcfba7519b86a04e82b6954dc73df80aac
Author: Florian Westphal
Date: Fri Dec 27 01:33:10 2019 +0100
netfilter: arp\_tables: init netns pointer in xt\_tgchk\_param struct
commit 1b789577f655060d98d20ed0c6f9fbd469d6ba63 upstream.
We get crash when the targets checkentry function tries to make
use of the network namespace pointer for arptables.
When the net pointer got added back in 2010, only ip/ip6/ebtables were
changed to initialize it, so arptables has this set to NULL.
This isn't a problem for normal arptables because no existing
arptables target has a checkentry function that makes use of par->net.
However, direct users of the setsockopt interface can provide any
target they want as long as its registered for ARP or UNPSEC protocols.
syzkaller managed to send a semi-valid arptables rule for RATEEST target
which is enough to trigger NULL deref:
kasan: GPF could be caused by NULL-ptr deref or user memory access
general protection fault: 0000 [#1] PREEMPT SMP KASAN
RIP: xt\_rateest\_tg\_checkentry+0x11d/0xb40 net/netfilter/xt\_RATEEST.c:109
[..]
xt\_check\_target+0x283/0x690 net/netfilter/x\_tables.c:1019
check\_target net/ipv4/netfilter/arp\_tables.c:399 [inline]
find\_check\_entry net/ipv4/netfilter/arp\_tables.c:422 [inline]
translate\_table+0x1005/0x1d70 net/ipv4/netfilter/arp\_tables.c:572
do\_replace net/ipv4/netfilter/arp\_tables.c:977 [inline]
do\_arpt\_set\_ctl+0x310/0x640 net/ipv4/netfilter/arp\_tables.c:1456
Fixes: add67461240c1d ("netfilter: add struct net \* to target parameters")
Reported-by: syzbot+d7358a458d8a81aee898@syzkaller.appspotmail.com
Signed-off-by: Florian Westphal
Acked-by: Cong Wang
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Greg Kroah-Hartman
commit 2deeba3623429a84103b26297a402634b7221973
Author: Tony Lindgren
Date: Sun Dec 22 10:00:19 2019 -0800
phy: cpcap-usb: Fix flakey host idling and enumerating of devices
commit 049226b9fd7442149dcbcf55f15408f5973cceda upstream.
We must let the USB host idle things properly before we switch to debug
UART mode. Otherwise the USB host may never idle after disconnecting
devices, and that causes the next enumeration to be flakey.
Cc: Jacopo Mondi
Cc: Marcel Partap
Cc: Merlijn Wajer
Cc: Michael Scott
Cc: NeKit
Cc: Pavel Machek
Cc: Sebastian Reichel
Acked-by: Pavel Machek
Fixes: 6d6ce40f63af ("phy: cpcap-usb: Add CPCAP PMIC USB support")
Signed-off-by: Tony Lindgren
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Greg Kroah-Hartman
commit 73681018f00c980fc512b46074e8fbee02471bee
Author: Tony Lindgren
Date: Fri Dec 20 16:21:40 2019 +0530
phy: cpcap-usb: Fix error path when no host driver is loaded
commit 4acb0200ab2b07843e3ef5599add3454c7440f03 upstream.
If musb\_mailbox() returns an error, we must still continue to finish
configuring the phy.
Otherwise the phy state may end up only half initialized, and this can
cause the debug serial console to stop working. And this will happen if the
usb driver musb controller is not loaded.
Let's fix the issue by adding helper for cpcap\_usb\_try\_musb\_mailbox().
Fixes: 6d6ce40f63af ("phy: cpcap-usb: Add CPCAP PMIC USB support")
Cc: Merlijn Wajer
Cc: Pavel Machek
Cc: Sebastian Reichel
Signed-off-by: Tony Lindgren
Signed-off-by: Kishon Vijay Abraham I
Signed-off-by: Greg Kroah-Hartman
commit 3fcaac70d298fc69d4c63f5bc5494bab30ec4ee1
Author: Alan Stern
Date: Mon Jan 6 10:43:42 2020 -0500
USB: Fix: Don't skip endpoint descriptors with maxpacket=0
commit 2548288b4fb059b2da9ceada172ef763077e8a59 upstream.
It turns out that even though endpoints with a maxpacket length of 0
aren't useful for data transfer, the descriptors do serve other
purposes. In particular, skipping them will also skip over other
class-specific descriptors for classes such as UVC. This unexpected
side effect has caused some UVC cameras to stop working.
In addition, the USB spec requires that when isochronous endpoint
descriptors are present in an interface's altsetting 0 (which is true
on some devices), the maxpacket size \_must\_ be set to 0. Warning
about such things seems like a bad idea.
This patch updates an earlier commit which would log a warning and
skip these endpoint descriptors. Now we only log a warning, and we
don't even do that for isochronous endpoints in altsetting 0.
We don't need to worry about preventing endpoints with maxpacket = 0
from ever being used for data transfers; usb\_submit\_urb() already
checks for this.
Reported-and-tested-by: Roger Whittaker
Fixes: d482c7bb0541 ("USB: Skip endpoints with 0 maxpacket length")
Signed-off-by: Alan Stern
CC: Laurent Pinchart
Link: https://marc.info/?l=linux-usb&m=157790377329882&w=2
Link: https://lore.kernel.org/r/Pine.LNX.4.44L0.2001061040270.1514-100000@iolanthe.rowland.org
Signed-off-by: Greg Kroah-Hartman
commit 1ea36fba56ef33475b0b95276062ea242ffd53d4
Author: Dmitry Torokhov
Date: Tue Dec 17 14:50:21 2019 -0800
HID: hiddev: fix mess in hiddev\_open()
commit 18a1b06e5b91d47dc86c0a66a762646ea7c5d141 upstream.
The open method of hiddev handler fails to bring the device out of
autosuspend state as was promised in 0361a28d3f9a, as it actually has 2
blocks that try to start the transport (call hid\_hw\_open()) with both
being guarded by the "open" counter, so the 2nd block is never executed as
the first block increments the counter so it is never at 0 when we check
it for the second block.
Additionally hiddev\_open() was leaving counter incremented on errors,
causing the device to never be reopened properly if there was ever an
error.
Let's fix all of this by factoring out code that creates client structure
and powers up the device into a separate function that is being called
from usbhid\_open() with the "existancelock" being held.
Fixes: 0361a28d3f9a ("HID: autosuspend support for USB HID")
Signed-off-by: Dmitry Torokhov
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit ad1e0d1976b9061bf2aca99249b0187c9bbd3334
Author: Navid Emamdoost
Date: Thu Sep 19 20:36:26 2019 -0500
ath10k: fix memory leak
commit b8d17e7d93d2beb89e4f34c59996376b8b544792 upstream.
In ath10k\_usb\_hif\_tx\_sg the allocated urb should be released if
usb\_submit\_urb fails.
Signed-off-by: Navid Emamdoost
Signed-off-by: Kalle Valo
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit e380d974731502d24e0353df36a883fe232c866b
Author: Navid Emamdoost
Date: Thu Sep 19 22:00:41 2019 -0500
rtl8xxxu: prevent leaking urb
commit a2cdd07488e666aa93a49a3fc9c9b1299e27ef3c upstream.
In rtl8xxxu\_submit\_int\_urb if usb\_submit\_urb fails the allocated urb
should be released.
Signed-off-by: Navid Emamdoost
Reviewed-by: Chris Chiu
Signed-off-by: Kalle Valo
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 448fe0b67c68d36cb45c09444c6b8298130d4c5e
Author: Navid Emamdoost
Date: Tue Sep 10 18:44:15 2019 -0500
scsi: bfa: release allocated memory in case of error
commit 0e62395da2bd5166d7c9e14cbc7503b256a34cb0 upstream.
In bfad\_im\_get\_stats if bfa\_port\_get\_stats fails, allocated memory needs to
be released.
Link: https://lore.kernel.org/r/20190910234417.22151-1-navid.emamdoost@gmail.com
Signed-off-by: Navid Emamdoost
Signed-off-by: Martin K. Petersen
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 5bbe72cf486c3b983f739b3e1d98b61c8a205795
Author: Navid Emamdoost
Date: Mon Sep 16 22:31:23 2019 -0500
rpmsg: char: release allocated memory
commit bbe692e349e2a1edf3fe0a29a0e05899c9c94d51 upstream.
In rpmsg\_eptdev\_write\_iter, if copy\_from\_iter\_full fails the allocated
buffer needs to be released.
Signed-off-by: Navid Emamdoost
Signed-off-by: Bjorn Andersson
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit 3fe1ced40e189e31c21f6723fbe4bdf8d2731922
Author: Navid Emamdoost
Date: Fri Oct 4 15:08:52 2019 -0500
mwifiex: pcie: Fix memory leak in mwifiex\_pcie\_alloc\_cmdrsp\_buf
commit db8fd2cde93227e566a412cf53173ffa227998bc upstream.
In mwifiex\_pcie\_alloc\_cmdrsp\_buf, a new skb is allocated which should be
released if mwifiex\_map\_pci\_memory() fails. The release is added.
Fixes: fc3314609047 ("mwifiex: use pci\_alloc/free\_consistent APIs for PCIe")
Signed-off-by: Navid Emamdoost
Acked-by: Ganapathi Bhat
Signed-off-by: Kalle Valo
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit cbd6a85021a38ce3071fc50f2e11b709b0add8c7
Author: Ganapathi Bhat
Date: Thu Nov 21 21:34:38 2019 +0530
mwifiex: fix possible heap overflow in mwifiex\_process\_country\_ie()
commit 3d94a4a8373bf5f45cf5f939e88b8354dbf2311b upstream.
mwifiex\_process\_country\_ie() function parse elements of bss
descriptor in beacon packet. When processing WLAN\_EID\_COUNTRY
element, there is no upper limit check for country\_ie\_len before
calling memcpy. The destination buffer domain\_info->triplet is an
array of length MWIFIEX\_MAX\_TRIPLET\_802\_11D(83). The remote
attacker can build a fake AP with the same ssid as real AP, and
send malicous beacon packet with long WLAN\_EID\_COUNTRY elemen
(country\_ie\_len > 83). Attacker can force STA connect to fake AP
on a different channel. When the victim STA connects to fake AP,
will trigger the heap buffer overflow. Fix this by checking for
length and if found invalid, don not connect to the AP.
This fix addresses CVE-2019-14895.
Reported-by: huangwen
Signed-off-by: Ganapathi Bhat
Signed-off-by: Kalle Valo
Cc: Ben Hutchings
Signed-off-by: Greg Kroah-Hartman
commit fa2bdff31cbf5a6e9beb67fba5e8cd59cc9ecfae
Author: Malcolm Priestley
Date: Fri Dec 20 21:15:33 2019 +0000
staging: vt6656: remove bool from vnt\_radio\_power\_on ret
commit 07f59f180ee083c48c32a1e69ae1d0091444d212 upstream.
The driver uses logical only error checking a bool true would flag error.
Signed-off-by: Malcolm Priestley
Link: https://lore.kernel.org/r/cc52b67c-9ef8-3e57-815a-44d10701919e@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 8c9ff5c7ddcb6230fbb5b8224733a0a6250b6904
Author: Amanieu d'Antras
Date: Sat Jan 4 13:39:30 2020 +0100
um: Implement copy\_thread\_tls
commit 457677c70c7672a4586b0b8abc396cc1ecdd376d upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-um@lists.infradead.org
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200104123928.1048822-1-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 4f43cdc72331bdbf3562d266969779aed7a834af
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:13 2020 +0100
clone3: ensure copy\_thread\_tls is implemented
commit dd499f7a7e34270208350a849ef103c0b3ae477f upstream.
copy\_thread implementations handle CLONE\_SETTLS by reading the TLS
value from the registers containing the syscall arguments for
clone. This doesn't work with clone3 since the TLS value is passed
in clone\_args instead.
Signed-off-by: Amanieu d'Antras
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200102172413.654385-8-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 3981d85a91824e529de5ee5128ec0b5bb63d1a42
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:12 2020 +0100
xtensa: Implement copy\_thread\_tls
commit c346b94f8c5d1b7d637522c908209de93305a8eb upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-xtensa@linux-xtensa.org
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200102172413.654385-7-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 0b6a32ef88530dc2f55adf4a5e8a16453c33b0ff
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:11 2020 +0100
riscv: Implement copy\_thread\_tls
commit 20bda4ed62f507ed72e30e817b43c65fdba60be7 upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-riscv@lists.infradead.org
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200102172413.654385-6-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 0bdd4e601a9a7b0e80ab30ebcb7bea827b7c9871
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:10 2020 +0100
parisc: Implement copy\_thread\_tls
commit d2f36c787b2181561d8b95814f8cdad64b348ad7 upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-parisc@vger.kernel.org
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200102172413.654385-5-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit ca7bbad38dd16cdb645a56984730e15f9850e9eb
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:09 2020 +0100
arm: Implement copy\_thread\_tls
commit 167ee0b82429cb5df272808c7a21370b7c961ab2 upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-arm-kernel@lists.infradead.org
Cc:  # 5.3.x
Link: https://lore.kernel.org/r/20200102172413.654385-4-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit 472f8a5821acb6c2c869fbc35dc52ed0df90ab0d
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:08 2020 +0100
arm64: Implement copy\_thread\_tls
commit a4376f2fbcc8084832f2f114577c8d68234c7903 upstream.
This is required for clone3 which passes the TLS value through a
struct rather than a register.
Signed-off-by: Amanieu d'Antras
Cc: linux-arm-kernel@lists.infradead.org
Cc:  # 5.3.x
Acked-by: Will Deacon
Link: https://lore.kernel.org/r/20200102172413.654385-3-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit bac641643c70d1ec4a4146bfc5665a1a51efb2e7
Author: Amanieu d'Antras
Date: Thu Jan 2 18:24:07 2020 +0100
arm64: Move \_\_ARCH\_WANT\_SYS\_CLONE3 definition to uapi headers
commit 3e3c8ca5a351350031f0f3d5ecedf7048b1b9008 upstream.
Previously this was only defined in the internal headers which
resulted in \_\_NR\_clone3 not being defined in the user headers.
Signed-off-by: Amanieu d'Antras
Cc: linux-arm-kernel@lists.infradead.org
Cc:  # 5.3.x
Reviewed-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20200102172413.654385-2-amanieu@gmail.com
Signed-off-by: Christian Brauner
Signed-off-by: Greg Kroah-Hartman
commit d32d6d2bee55168dc27cda2e401793d0c19dbe21
Author: Sudip Mukherjee
Date: Fri Dec 27 17:44:34 2019 +0000
tty: always relink the port
commit 273f632912f1b24b642ba5b7eb5022e43a72f3b5 upstream.
If the serial device is disconnected and reconnected, it re-enumerates
properly but does not link it. fwiw, linking means just saving the port
index, so allow it always as there is no harm in saving the same value
again even if it tries to relink with the same port.
Fixes: fb2b90014d78 ("tty: link tty and port before configuring it as console")
Reported-by: Kenneth R. Crudup
Signed-off-by: Sudip Mukherjee
Cc: stable
Link: https://lore.kernel.org/r/20191227174434.12057-1-sudipm.mukherjee@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 46e4035d558dfe85d2adf5159cdcd1c1155a3109
Author: Sudip Mukherjee
Date: Thu Dec 12 13:16:02 2019 +0000
tty: link tty and port before configuring it as console
commit fb2b90014d782d80d7ebf663e50f96d8c507a73c upstream.
There seems to be a race condition in tty drivers and I could see on
many boot cycles a NULL pointer dereference as tty\_init\_dev() tries to
do 'tty->port->itty = tty' even though tty->port is NULL.
'tty->port' will be set by the driver and if the driver has not yet done
it before we open the tty device we can get to this situation. By adding
some extra debug prints, I noticed that:
6.650130: uart\_add\_one\_port
6.663849: register\_console
6.664846: tty\_open
6.674391: tty\_init\_dev
6.675456: tty\_port\_link\_device
uart\_add\_one\_port() registers the console, as soon as it registers, the
userspace tries to use it and that leads to tty\_open() but
uart\_add\_one\_port() has not yet done tty\_port\_link\_device() and so
tty->port is not yet configured when control reaches tty\_init\_dev().
Further look into the code and tty\_port\_link\_device() is done by
uart\_add\_one\_port(). After registering the console uart\_add\_one\_port()
will call tty\_port\_register\_device\_attr\_serdev() and
tty\_port\_link\_device() is called from this.
Call add tty\_port\_link\_device() before uart\_configure\_port() is done and
add a check in tty\_port\_link\_device() so that it only links the port if
it has not been done yet.
Suggested-by: Jiri Slaby
Signed-off-by: Sudip Mukherjee
Cc: stable
Link: https://lore.kernel.org/r/20191212131602.29504-1-sudipm.mukherjee@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit d12d10211b4cc7b253e26fb9ebd3ae3fa9fb6a00
Author: Patrick Steinhardt
Date: Fri Dec 27 00:56:18 2019 +0100
iommu/vt-d: Fix adding non-PCI devices to Intel IOMMU
commit 4a350a0ee5b0a14f826fcdf60dd1a3199cafbfd6 upstream.
Starting with commit fa212a97f3a3 ("iommu/vt-d: Probe DMA-capable ACPI
name space devices"), we now probe DMA-capable ACPI name
space devices. On Dell XPS 13 9343, which has an Intel LPSS platform
device INTL9C60 enumerated via ACPI, this change leads to the following
warning:
------------[ cut here ]------------
WARNING: CPU: 1 PID: 1 at pci\_device\_group+0x11a/0x130
CPU: 1 PID: 1 Comm: swapper/0 Tainted: G T 5.5.0-rc3+ #22
Hardware name: Dell Inc. XPS 13 9343/0310JH, BIOS A20 06/06/2019
RIP: 0010:pci\_device\_group+0x11a/0x130
Code: f0 ff ff 48 85 c0 49 89 c4 75 c4 48 8d 74 24 10 48 89 ef e8 48 ef ff ff 48 85 c0 49 89 c4 75 af e8 db f7 ff ff 49 89 c4 eb a5 <0f> 0b 49 c7 c4 ea ff ff ff eb 9a e8 96 1e c7 ff 66 0f 1f 44 00 00
RSP: 0000:ffffc0d6c0043cb0 EFLAGS: 00010202
RAX: 0000000000000000 RBX: ffffa3d1d43dd810 RCX: 0000000000000000
RDX: ffffa3d1d4fecf80 RSI: ffffa3d12943dcc0 RDI: ffffa3d1d43dd810
RBP: ffffa3d1d43dd810 R08: 0000000000000000 R09: ffffa3d1d4c04a80
R10: ffffa3d1d4c00880 R11: ffffa3d1d44ba000 R12: 0000000000000000
R13: ffffa3d1d4383b80 R14: ffffa3d1d4c090d0 R15: ffffa3d1d4324530
FS: 0000000000000000(0000) GS:ffffa3d1d6700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000000 CR3: 000000000460a001 CR4: 00000000003606e0
Call Trace:
? iommu\_group\_get\_for\_dev+0x81/0x1f0
? intel\_iommu\_add\_device+0x61/0x170
? iommu\_probe\_device+0x43/0xd0
? intel\_iommu\_init+0x1fa2/0x2235
? pci\_iommu\_init+0x52/0xe7
? e820\_\_memblock\_setup+0x15c/0x15c
? do\_one\_initcall+0xcc/0x27e
? kernel\_init\_freeable+0x169/0x259
? rest\_init+0x95/0x95
? kernel\_init+0x5/0xeb
? ret\_from\_fork+0x35/0x40
---[ end trace 28473e7abc25b92c ]---
DMAR: ACPI name space devices didn't probe correctly
The bug results from the fact that while we now enumerate ACPI devices,
we aren't able to handle any non-PCI device when generating the device
group. Fix the issue by implementing an Intel-specific callback that
returns `pci\_device\_group` only if the device is a PCI device.
Otherwise, it will return a generic device group.
Fixes: fa212a97f3a3 ("iommu/vt-d: Probe DMA-capable ACPI name space devices")
Signed-off-by: Patrick Steinhardt
Cc: stable@vger.kernel.org # v5.3+
Acked-by: Lu Baolu
Signed-off-by: Joerg Roedel
Signed-off-by: Greg Kroah-Hartman
commit d6ac466168aa4b1a6217e4b023d3fe23a8bcafe7
Author: Punit Agrawal
Date: Thu Dec 19 19:03:45 2019 +0900
serdev: Don't claim unsupported ACPI serial devices
commit c5ee0b3104e0b292d353e63fd31cb8c692645d8c upstream.
Serdev sub-system claims all ACPI serial devices that are not already
initialised. As a result, no device node is created for serial ports
on certain boards such as the Apollo Lake based UP2. This has the
unintended consequence of not being able to raise the login prompt via
serial connection.
Introduce a blacklist to reject ACPI serial devices that should not be
claimed by serdev sub-system. Add the peripheral ids for Intel HS UART
to the blacklist to bring back serial port on SoCs carrying them.
Cc: stable@vger.kernel.org
Signed-off-by: Punit Agrawal
Acked-by: Hans de Goede
Acked-by: Johan Hovold
Cc: Rob Herring
Link: https://lore.kernel.org/r/20191219100345.911093-1-punit1.agrawal@toshiba.co.jp
Signed-off-by: Greg Kroah-Hartman
commit e7fecc2112fad78e1a1912f3714412c912d406ee
Author: Michael Straube
Date: Sat Dec 28 15:37:25 2019 +0100
staging: rtl8188eu: Add device code for TP-Link TL-WN727N v5.21
commit 58dcc5bf4030cab548d5c98cd4cd3632a5444d5a upstream.
This device was added to the stand-alone driver on github.
Add it to the staging driver as well.
Link: https://github.com/lwfinger/rtl8188eu/commit/b9b537aa25a8
Signed-off-by: Michael Straube
Cc: stable
Link: https://lore.kernel.org/r/20191228143725.24455-1-straube.linux@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit de8757801ef0920b4114c430125b8c02fedbc828
Author: Malcolm Priestley
Date: Fri Dec 20 21:15:24 2019 +0000
staging: vt6656: limit reg output to block size
commit 69cc1f925e1aa74b96e2ace67e3453a50d091d2f upstream.
vnt\_control\_out appears to fail when BBREG is greater than 64 writes.
Create new function that will relay an array in no larger than
the indicated block size.
It appears that this command has always failed but was ignored by
driver until the introduction of error checking.
Cc: stable  # v5.3+
Signed-off-by: Malcolm Priestley
Link: https://lore.kernel.org/r/a41f0601-df46-ce6e-ab7c-35e697946e2a@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 42609009ea1f0768f4e065c4cfa76c650c6ea2f3
Author: Malcolm Priestley
Date: Fri Dec 20 21:15:09 2019 +0000
staging: vt6656: correct return of vnt\_init\_registers.
commit 7de6155c8968a3342d1bef3f7a2084d31ae6e4be upstream.
The driver standard error returns remove bool false conditions.
Cc: stable  # v5.3+
Signed-off-by: Malcolm Priestley
Link: https://lore.kernel.org/r/072ec0b3-425f-277e-130c-1e3a116c90d6@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 23533ddf9e4f8155e8952e5e2e2635a8488db592
Author: Ian Abbott
Date: Fri Dec 27 17:00:54 2019 +0000
staging: comedi: adv\_pci1710: fix AI channels 16-31 for PCI-1713
commit a9d3a9cedc1330c720e0ddde1978a8e7771da5ab upstream.
The Advantech PCI-1713 has 32 analog input channels, but an incorrect
bit-mask in the definition of the `PCI171X\_MUX\_CHANH(x)` and
PCI171X\_MUX\_CHANL(x)` macros is causing channels 16 to 31 to be aliases
of channels 0 to 15. Change the bit-mask value from 0xf to 0xff to fix
it. Note that the channel numbers will have been range checked already,
so the bit-mask isn't really needed.
Fixes: 92c65e5553ed ("staging: comedi: adv\_pci1710: define the mux control register bits")
Reported-by: Dmytro Fil
Cc:  # v4.5+
Signed-off-by: Ian Abbott
Link: https://lore.kernel.org/r/20191227170054.32051-1-abbotti@mev.co.uk
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Greg Kroah-Hartman
commit 26219c6befa15a79250cf40026918ab9c4ae0200
Author: Paul Cercueil
Date: Mon Dec 16 10:18:43 2019 -0600
usb: musb: dma: Correct parameter passed to IRQ handler
commit c80d0f4426c7fdc7efd6ae8d8b021dcfc89b4254 upstream.
The IRQ handler was passed a pointer to a struct dma\_controller, but the
argument was then casted to a pointer to a struct musb\_dma\_controller.
Fixes: 427c4f333474 ("usb: struct device - replace bus\_id with dev\_name(), dev\_set\_name()")
Signed-off-by: Paul Cercueil
Tested-by: Artur Rojek
Cc: stable@vger.kernel.org
Signed-off-by: Bin Liu
Link: https://lore.kernel.org/r/20191216161844.772-2-b-liu@ti.com
Signed-off-by: Greg Kroah-Hartman
commit 25eecc1f14754071a61fbbd0ed32d1cf7309e0ab
Author: Paul Cercueil
Date: Tue Jan 7 09:26:25 2020 -0600
usb: musb: Disable pullup at init
commit 96a0c12843109e5c4d5eb1e09d915fdd0ce31d25 upstream.
The pullup may be already enabled before the driver is initialized. This
happens for instance on JZ4740.
It has to be disabled at init time, as we cannot guarantee that a gadget
driver will be bound to the UDC.
Signed-off-by: Paul Cercueil
Suggested-by: Bin Liu
Cc: stable@vger.kernel.org
Signed-off-by: Bin Liu
Link: https://lore.kernel.org/r/20200107152625.857-3-b-liu@ti.com
Signed-off-by: Greg Kroah-Hartman
commit 32199ac31d263eaaebc7139894277ca5e88d22da
Author: Tony Lindgren
Date: Tue Jan 7 09:26:24 2020 -0600
usb: musb: fix idling for suspend after disconnect interrupt
commit 5fbf7a2534703fd71159d3d71504b0ad01b43394 upstream.
When disconnected as USB B-device, suspend interrupt should come before
diconnect interrupt, because the DP/DM pins are shorter than the
VBUS/GND pins on the USB connectors. But we sometimes get a suspend
interrupt after disconnect interrupt. In that case we have devctl set to
99 with VBUS still valid and musb\_pm\_runtime\_check\_session() wrongly
thinks we have an active session. We have no other interrupts after
disconnect coming in this case at least with the omap2430 glue.
Let's fix the issue by checking the interrupt status again with
delayed work for the devctl 99 case. In the suspend after disconnect
case the devctl session bit has cleared by then and musb can idle.
For a typical USB B-device connect case we just continue with normal
interrupts.
Fixes: 467d5c980709 ("usb: musb: Implement session bit based runtime PM for musb-core")
Cc: Merlijn Wajer
Cc: Pavel Machek
Cc: Sebastian Reichel
Cc: stable@vger.kernel.org
Signed-off-by: Tony Lindgren
Signed-off-by: Bin Liu
Link: https://lore.kernel.org/r/20200107152625.857-2-b-liu@ti.com
Signed-off-by: Greg Kroah-Hartman
commit 855e2d927f41febe8af04dc8fb11807ab72165dc
Author: Daniele Palmas
Date: Thu Dec 19 11:07:07 2019 +0100
USB: serial: option: add ZLP support for 0x1bc7/0x9010
commit 2438c3a19dec5e98905fd3ffcc2f24716aceda6b upstream.
Telit FN980 flashing device 0x1bc7/0x9010 requires zero packet
to be sent if out data size is is equal to the endpoint max size.
Signed-off-by: Daniele Palmas
[ johan: switch operands in conditional ]
Cc: stable
Signed-off-by: Johan Hovold
Signed-off-by: Greg Kroah-Hartman
commit 2989d2209f2e639caf824edb711f031491e35ccb
Author: Douglas Gilbert
Date: Sun Dec 29 22:35:44 2019 -0500
USB-PD tcpm: bad warning+size, PPS adapters
commit c215e48e97d232249a33849fc46fc50311043e11 upstream.
Augmented Power Delivery Objects (A)PDO\_s are used by USB-C
PD power adapters to advertize the voltages and currents
they support. There can be up to 7 PDO\_s but before PPS
(programmable power supply) there were seldom more than 4
or 5. Recently Samsung released an optional PPS 45 Watt power
adapter (EP-TA485) that has 7 PDO\_s. It is for the Galaxy 10+
tablet and charges it quicker than the adapter supplied at
purchase. The EP-TA485 causes an overzealous WARN\_ON to soil
the log plus it miscalculates the number of bytes to read.
So this bug has been there for some time but goes
undetected for the majority of USB-C PD power adapters on
the market today that have 6 or less PDO\_s. That may soon
change as more USB-C PD adapters with PPS come to market.
Tested on a EP-TA485 and an older Lenovo PN: SA10M13950
USB-C 65 Watt adapter (without PPS and has 4 PDO\_s) plus
several other PD power adapters.
Signed-off-by: Douglas Gilbert
Reviewed-by: Guenter Roeck
Cc: stable
Link: https://lore.kernel.org/r/20191230033544.1809-1-dgilbert@interlog.com
Signed-off-by: Greg Kroah-Hartman
commit 21e327468ea1adbaeb19ef6cb788e905d045c381
Author: Colin Ian King
Date: Tue Jan 7 12:39:01 2020 +0000
usb: ohci-da8xx: ensure error return on variable error is set
commit ba9b40810bb43e6bf73b395012b98633c03f7f59 upstream.
Currently when an error occurs when calling devm\_gpiod\_get\_optional or
calling gpiod\_to\_irq it causes an uninitialized error return in variable
'error' to be returned. Fix this by ensuring the error variable is set
from da8xx\_ohci->oc\_gpio and oc\_irq.
Thanks to Dan Carpenter for spotting the uninitialized error in the
gpiod\_to\_irq failure case.
Addresses-Coverity: ("Uninitialized scalar variable")
Fixes: d193abf1c913 ("usb: ohci-da8xx: add vbus and overcurrent gpios")
Signed-off-by: Colin Ian King
Cc: stable
Acked-by: Alan Stern
Link: https://lore.kernel.org/r/20200107123901.101190-1-colin.king@canonical.com
Signed-off-by: Greg Kroah-Hartman
commit f1fcfe22933bdef1d5c25fdee81adb7abda5dd1a
Author: Peter Chen
Date: Fri Dec 27 17:10:04 2019 +0800
usb: cdns3: should not use the same dev\_id for shared interrupt handler
commit af58e1fca9840192f14b6f03c59595d64bff9127 upstream.
Both drd and gadget interrupt handler use the struct cdns3 pointer as
dev\_id, it causes devm\_free\_irq at cdns3\_gadget\_exit doesn't free
gadget's interrupt handler, it freed drd's handler. So, when the
host interrupt occurs, the gadget's interrupt hanlder is still
called, and causes below oops. To fix it, we use gadget's private
data priv\_dev as interrupt dev\_id for gadget.
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000380
Mem abort info:
ESR = 0x96000006
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
Data abort info:
ISV = 0, ISS = 0x00000006
CM = 0, WnR = 0
user pgtable: 4k pages, 48-bit VAs, pgdp=0000000971d79000
[0000000000000380] pgd=0000000971d6f003, pud=0000000971d6e003, pmd=0000000000000000
Internal error: Oops: 96000006 [#1] PREEMPT SMP
Modules linked in: mxc\_jpeg\_encdec crct10dif\_ce fsl\_imx8\_ddr\_perf
CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.4.0-03486-g69f4e7d9c54a-dirty #254
Hardware name: Freescale i.MX8QM MEK (DT)
pstate: 00000085 (nzcv daIf -PAN -UAO)
pc : cdns3\_device\_irq\_handler+0x1c/0xb8
lr : \_\_handle\_irq\_event\_percpu+0x78/0x2c0
sp : ffff800010003e30
x29: ffff800010003e30 x28: ffff8000129bb000
x27: ffff8000126e9000 x26: ffff0008f61b5600
x25: ffff800011fe1018 x24: ffff8000126ea120
x23: ffff800010003f04 x22: 0000000000000000
x21: 0000000000000093 x20: ffff0008f61b5600
x19: ffff0008f5061a80 x18: 0000000000000000
x17: 0000000000000000 x16: 0000000000000000
x15: 0000000000000000 x14: 003d090000000000
x13: 00003d0900000000 x12: 0000000000000000
x11: 00003d0900000000 x10: 0000000000000040
x9 : ffff800012708cb8 x8 : ffff800012708cb0
x7 : ffff0008f7c7a9d0 x6 : 0000000000000000
x5 : ffff0008f7c7a910 x4 : ffff8008ed359000
x3 : ffff800010003f40 x2 : 0000000000000000
x1 : ffff0008f5061a80 x0 : ffff800010161a60
Call trace:
cdns3\_device\_irq\_handler+0x1c/0xb8
\_\_handle\_irq\_event\_percpu+0x78/0x2c0
handle\_irq\_event\_percpu+0x40/0x98
handle\_irq\_event+0x4c/0xd0
handle\_fasteoi\_irq+0xbc/0x168
generic\_handle\_irq+0x34/0x50
\_\_handle\_domain\_irq+0x6c/0xc0
gic\_handle\_irq+0xd4/0x174
el1\_irq+0xb8/0x180
arch\_cpu\_idle+0x3c/0x230
default\_idle\_call+0x38/0x40
do\_idle+0x20c/0x298
cpu\_startup\_entry+0x28/0x48
rest\_init+0xdc/0xe8
arch\_call\_rest\_init+0x14/0x1c
start\_kernel+0x48c/0x4b8
Code: aa0103f3 aa1e03e0 d503201f f9409662 (f941c040)
---[ end trace 091dcf4dee011b0e ]---
Kernel panic - not syncing: Fatal exception in interrupt
SMP: stopping secondary CPUs
Kernel Offset: disabled
CPU features: 0x0002,2100600c
Memory Limit: none
---[ end Kernel panic - not syncing: Fatal exception in interrupt ]---
Fixes: 7733f6c32e36 ("usb: cdns3: Add Cadence USB3 DRD Driver")
Cc:  #v5.4
Signed-off-by: Peter Chen
Link: https://lore.kernel.org/r/1577437804-18146-1-git-send-email-peter.chen@nxp.com
Signed-off-by: Greg Kroah-Hartman
commit b062fb0ca0aa5ddb195133164e6e135bb51a0c79
Author: Malcolm Priestley
Date: Fri Dec 20 21:14:59 2019 +0000
staging: vt6656: Fix non zero logical return of, usb\_control\_msg
commit 58c3e681b04dd57c70d0dcb7b69fe52d043ff75a upstream.
Starting with commit 59608cb1de1856
("staging: vt6656: clean function's error path in usbpipe.c")
the usb control functions have returned errors throughout driver
with only logical variable checking.
However, usb\_control\_msg return the amount of bytes transferred
this means that normal operation causes errors.
Correct the return function so only return zero when transfer
is successful.
Cc: stable  # v5.3+
Signed-off-by: Malcolm Priestley
Link: https://lore.kernel.org/r/08e88842-6f78-a2e3-a7a0-139fec960b2b@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit f2a6955c9b74cf20f471ab8a33b2aa6d257af013
Author: Malcolm Priestley
Date: Fri Dec 20 21:15:59 2019 +0000
staging: vt6656: set usb\_set\_intfdata on driver fail.
commit c0bcf9f3f5b661d4ace2a64a79ef661edd2a4dc8 upstream.
intfdata will contain stale pointer when the device is detached after
failed initialization when referenced in vt6656\_disconnect
Provide driver access to it here and NULL it.
Cc: stable
Signed-off-by: Malcolm Priestley
Link: https://lore.kernel.org/r/6de448d7-d833-ef2e-dd7b-3ef9992fee0e@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit c617a3b777b92a0e80ceff2dffaae9350d4c3850
Author: Kees Cook
Date: Wed Jan 8 10:06:54 2020 -0800
pstore/ram: Regularize prz label allocation lifetime
commit e163fdb3f7f8c62dccf194f3f37a7bcb3c333aa8 upstream.
In my attempt to fix a memory leak, I introduced a double-free in the
pstore error path. Instead of trying to manage the allocation lifetime
between persistent\_ram\_new() and its callers, adjust the logic so
persistent\_ram\_new() always takes a kstrdup() copy, and leaves the
caller's allocation lifetime up to the caller. Therefore callers are
\_always\_ responsible for freeing their label. Before, it only needed
freeing when the prz itself failed to allocate, and not in any of the
other prz failure cases, which callers would have no visibility into,
which is the root design problem that lead to both the leak and now
double-free bugs.
Reported-by: Cengiz Can
Link: https://lore.kernel.org/lkml/d4ec59002ede4aaf9928c7f7526da87c@kernel.wtf
Fixes: 8df955a32a73 ("pstore/ram: Fix error-path memory leak in persistent\_ram\_new() callers")
Cc: stable@vger.kernel.org
Signed-off-by: Kees Cook
Signed-off-by: Greg Kroah-Hartman
commit 85b60d32210ae5c57999b94ff26c0120a47f9fe4
Author: Hans de Goede
Date: Sun Jan 5 17:03:57 2020 +0100
gpiolib: acpi: Add honor\_wakeup module-option + quirk mechanism
commit aa23ca3d98f756d5b1e503fb140665fb24a41a38 upstream.
On some laptops enabling wakeup on the GPIO interrupts used for ACPI \_AEI
event handling causes spurious wakeups.
This commit adds a new honor\_wakeup option, defaulting to true (our current
behavior), which can be used to disable wakeup on troublesome hardware
to avoid these spurious wakeups.
This is a workaround for an architectural problem with s2idle under Linux
where we do not have any mechanism to immediately go back to sleep after
wakeup events, other then for embedded-controller events using the standard
ACPI EC interface, for details see:
https://lore.kernel.org/linux-acpi/61450f9b-cbc6-0c09-8b3a-aff6bf9a0b3c@redhat.com/
One series of laptops which is not able to suspend without this workaround
is the HP x2 10 Cherry Trail models, this commit adds a DMI based quirk
which makes sets honor\_wakeup to false on these models.
Cc: stable@vger.kernel.org
Reviewed-by: Andy Shevchenko
Acked-by: Mika Westerberg
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20200105160357.97154-3-hdegoede@redhat.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit 5d09934c8c3a45085e14cb47328b1fa37a3b260b
Author: Hans de Goede
Date: Sun Jan 5 17:03:56 2020 +0100
gpiolib: acpi: Turn dmi\_system\_id table into a generic quirk table
commit 1ad1b54099c231aed8f6f257065c1b322583f264 upstream.
Turn the existing run\_edge\_events\_on\_boot\_blacklist dmi\_system\_id table
into a generic quirk table, storing the quirks in the driver\_data ptr.
This is a preparation patch for adding other types of (DMI based) quirks.
Cc: stable@vger.kernel.org
Reviewed-by: Andy Shevchenko
Acked-by: Mika Westerberg
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20200105160357.97154-2-hdegoede@redhat.com
Signed-off-by: Linus Walleij
Signed-off-by: Greg Kroah-Hartman
commit a0dbd93fb148764c5ccc099307bba0b68e7fda4d
Author: Oliver Hartkopp
Date: Sat Dec 7 19:34:18 2019 +0100
can: can\_dropped\_invalid\_skb(): ensure an initialized headroom in outgoing CAN sk\_buffs
commit e7153bf70c3496bac00e7e4f395bb8d8394ac0ea upstream.
KMSAN sysbot detected a read access to an untinitialized value in the
headroom of an outgoing CAN related sk\_buff. When using CAN sockets this
area is filled appropriately - but when using a packet socket this
initialization is missing.
The problematic read access occurs in the CAN receive path which can
only be triggered when the sk\_buff is sent through a (virtual) CAN
interface. So we check in the sending path whether we need to perform
the missing initializations.
Fixes: d3b58c47d330d ("can: replace timestamp as unique skb attribute")
Reported-by: syzbot+b02ff0707a97e4e79ebb@syzkaller.appspotmail.com
Signed-off-by: Oliver Hartkopp
Tested-by: Oliver Hartkopp
Cc: linux-stable  # >= v4.1
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 584b8299f7250b69396138823b5a94f33016340f
Author: Florian Faber
Date: Thu Dec 26 19:51:24 2019 +0100
can: mscan: mscan\_rx\_poll(): fix rx path lockup when returning from polling to irq mode
commit 2d77bd61a2927be8f4e00d9478fe6996c47e8d45 upstream.
Under load, the RX side of the mscan driver can get stuck while TX still
works. Restarting the interface locks up the system. This behaviour
could be reproduced reliably on a MPC5121e based system.
The patch fixes the return value of the NAPI polling function (should be
the number of processed packets, not constant 1) and the condition under
which IRQs are enabled again after polling is finished.
With this patch, no more lockups were observed over a test period of ten
days.
Fixes: afa17a500a36 ("net/can: add driver for mscan family & mpc52xx\_mscan")
Signed-off-by: Florian Faber
Cc: linux-stable
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 1ad3ee211d331cdc60260952c3b3c61ddda4ed64
Author: Sean Nyekjaer
Date: Wed Dec 11 14:58:52 2019 +0100
can: tcan4x5x: tcan4x5x\_can\_probe(): get the device out of standby before register access
commit 3069ce620daed85e4ef2b0c087dca2509f809470 upstream.
The m\_can tries to detect if Non ISO Operation is available while in
standby mode, this function results in the following error:
| tcan4x5x spi2.0 (unnamed net\_device) (uninitialized): Failed to init module
| tcan4x5x spi2.0: m\_can device registered (irq=84, version=32)
| tcan4x5x spi2.0 can2: TCAN4X5X successfully initialized.
When the tcan device comes out of reset it goes in standby mode. The
m\_can driver tries to access the control register but fails due to the
device being in standby mode.
So this patch will put the tcan device in normal mode before the m\_can
driver does the initialization.
Fixes: 5443c226ba91 ("can: tcan4x5x: Add tcan4x5x driver to the kernel")
Cc: stable@vger.kernel.org
Signed-off-by: Sean Nyekjaer
Acked-by: Dan Murphy
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit a05b169456468190549af475076e6d6b630b172a
Author: Johan Hovold
Date: Tue Dec 10 12:32:31 2019 +0100
can: gs\_usb: gs\_usb\_probe(): use descriptors of current altsetting
commit 2f361cd9474ab2c4ab9ac8db20faf81e66c6279b upstream.
Make sure to always use the descriptors of the current alternate setting
to avoid future issues when accessing fields that may differ between
settings.
Signed-off-by: Johan Hovold
Fixes: d08e973a77d1 ("can: gs\_usb: Added support for the GS\_USB CAN devices")
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit e791b56a298b3d17a880a0d875e2787d17fa0d59
Author: Johan Hovold
Date: Tue Dec 10 12:32:30 2019 +0100
can: kvaser\_usb: fix interface sanity check
commit 5660493c637c9d83786f1c9297f403eae44177b6 upstream.
Make sure to use the current alternate setting when verifying the
interface descriptors to avoid binding to an invalid interface.
Failing to do so could cause the driver to misbehave or trigger a WARN()
in usb\_submit\_urb() that kernels with panic\_on\_warn set would choke on.
Fixes: aec5fb2268b7 ("can: kvaser\_usb: Add support for Kvaser USB hydra family")
Cc: stable  # 4.19
Cc: Jimmy Assarsson
Cc: Christer Beskow
Cc: Nicklas Johansson
Cc: Martin Henriksson
Signed-off-by: Johan Hovold
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 578ab7d4d9477c89d494c7beaf815de003290078
Author: Kaike Wan
Date: Thu Dec 19 18:19:20 2019 -0500
IB/hfi1: Adjust flow PSN with the correct resync\_psn
commit b2ff0d510182eb5cc05a65d1b2371af62c4b170c upstream.
When a TID RDMA ACK to RESYNC request is received, the flow PSNs for
pending TID RDMA WRITE segments will be adjusted with the next flow
generation number, based on the resync\_psn value extracted from the flow
PSN of the TID RDMA ACK packet. The resync\_psn value indicates the last
flow PSN for which a TID RDMA WRITE DATA packet has been received by the
responder and the requester should resend TID RDMA WRITE DATA packets,
starting from the next flow PSN.
However, if resync\_psn points to the last flow PSN for a segment and the
next segment flow PSN starts with a new generation number, use of the old
resync\_psn to adjust the flow PSN for the next segment will lead to
miscalculation, resulting in WARN\_ON and sge rewinding errors:
WARNING: CPU: 4 PID: 146961 at /nfs/site/home/phcvs2/gitrepo/ifs-all/components/Drivers/tmp/rpmbuild/BUILD/ifs-kernel-updates-3.10.0\_957.el7.x86\_64/hfi1/tid\_rdma.c:4764 hfi1\_rc\_rcv\_tid\_rdma\_ack+0x8f6/0xa90 [hfi1]
Modules linked in: ib\_ipoib(OE) hfi1(OE) rdmavt(OE) rpcsec\_gss\_krb5 auth\_rpcgss nfsv4 dns\_resolver nfsv3 nfs\_acl nfs lockd grace fscache iTCO\_wdt iTCO\_vendor\_support skx\_edac intel\_powerclamp coretemp intel\_rapl iosf\_mbi kvm irqbypass crc32\_pclmul ghash\_clmulni\_intel ib\_isert iscsi\_target\_mod target\_core\_mod aesni\_intel lrw gf128mul glue\_helper ablk\_helper cryptd rpcrdma sunrpc opa\_vnic ast ttm ib\_iser libiscsi drm\_kms\_helper scsi\_transport\_iscsi ipmi\_ssif syscopyarea sysfillrect sysimgblt fb\_sys\_fops drm joydev ipmi\_si pcspkr sg drm\_panel\_orientation\_quirks ipmi\_devintf lpc\_ich i2c\_i801 ipmi\_msghandler wmi rdma\_ucm ib\_ucm ib\_uverbs acpi\_cpufreq acpi\_power\_meter ib\_umad rdma\_cm ib\_cm iw\_cm ip\_tables ext4 mbcache jbd2 sd\_mod crc\_t10dif crct10dif\_generic crct10dif\_pclmul i2c\_algo\_bit crct10dif\_common
crc32c\_intel e1000e ib\_core ahci libahci ptp libata pps\_core nfit libnvdimm [last unloaded: rdmavt]
CPU: 4 PID: 146961 Comm: kworker/4:0H Kdump: loaded Tainted: G W OE ------------ 3.10.0-957.el7.x86\_64 #1
Hardware name: Intel Corporation S2600WFT/S2600WFT, BIOS SE5C620.86B.0X.02.0117.040420182310 04/04/2018
Workqueue: hfi0\_0 \_hfi1\_do\_tid\_send [hfi1]
Call Trace:
 [] dump\_stack+0x19/0x1b
[] \_\_warn+0xd8/0x100
[] warn\_slowpath\_null+0x1d/0x20
[] hfi1\_rc\_rcv\_tid\_rdma\_ack+0x8f6/0xa90 [hfi1]
[] hfi1\_kdeth\_eager\_rcv+0x1dc/0x210 [hfi1]
[] ? hfi1\_kdeth\_expected\_rcv+0x1ef/0x210 [hfi1]
[] kdeth\_process\_eager+0x35/0x90 [hfi1]
[] handle\_receive\_interrupt\_nodma\_rtail+0x17a/0x2b0 [hfi1]
[] receive\_context\_interrupt+0x23/0x40 [hfi1]
[] \_\_handle\_irq\_event\_percpu+0x44/0x1c0
[] handle\_irq\_event\_percpu+0x32/0x80
[] handle\_irq\_event+0x3c/0x60
[] handle\_edge\_irq+0x7f/0x150
[] handle\_irq+0xe4/0x1a0
[] do\_IRQ+0x4d/0xf0
[] common\_interrupt+0x162/0x162
 [] ? swiotlb\_map\_page+0x49/0x150
[] hfi1\_verbs\_send\_dma+0x291/0xb70 [hfi1]
[] ? hfi1\_wait\_kmem+0xf0/0xf0 [hfi1]
[] hfi1\_verbs\_send+0x126/0x2b0 [hfi1]
[] \_hfi1\_do\_tid\_send+0x1d3/0x320 [hfi1]
[] process\_one\_work+0x17f/0x440
[] worker\_thread+0x126/0x3c0
[] ? manage\_workers.isra.25+0x2a0/0x2a0
[] kthread+0xd1/0xe0
[] ? insert\_kthread\_work+0x40/0x40
[] ret\_from\_fork\_nospec\_begin+0x7/0x21
[] ? insert\_kthread\_work+0x40/0x40
This patch fixes the issue by adjusting the resync\_psn first if the flow
generation has been advanced for a pending segment.
Fixes: 9e93e967f7b4 ("IB/hfi1: Add a function to receive TID RDMA ACK packet")
Link: https://lore.kernel.org/r/20191219231920.51069.37147.stgit@awfm-01.aw.intel.com
Cc:
Reviewed-by: Mike Marciniszyn
Signed-off-by: Kaike Wan
Signed-off-by: Dennis Dalessandro
Signed-off-by: Jason Gunthorpe
Signed-off-by: Greg Kroah-Hartman
commit e1a17ea063a8bf0d735dbd477694857a1b3f4690
Author: Chris Wilson
Date: Mon Jan 6 12:39:21 2020 +0000
drm/i915/gt: Mark up virtual engine uabi\_instance
commit 1325008f5c8dbc84aa835d98af8447fa0569bc4d upstream.
Be sure to initialise the uabi\_instance on the virtual engine to the
special invalid value, just in case we ever peek at it from the uAPI.
Reported-by: Tvrtko Ursulin
Fixes: 750e76b4f9f6 ("drm/i915/gt: Move the [class][inst] lookup for engines onto the GT")
Signed-off-by: Chris Wilson
Cc: Tvrtko Ursulin
Cc:  # v5.4+
Reviewed-by: Tvrtko Ursulin
Link: https://patchwork.freedesktop.org/patch/msgid/20200106123921.2543886-1-chris@chris-wilson.co.uk
(cherry picked from commit f75fc37b5e70b75f21550410f88e2379648120e2)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 843f6795576ee240e05f53ffbf2353d677268d4b
Author: Matt Roper
Date: Tue Dec 31 11:07:13 2019 -0800
drm/i915: Add Wa\_1407352427:icl,ehl
commit 25b79ad51bf04a8aa67b5bccd631fc05f963b8e0 upstream.
The workaround database now indicates we need to disable psdunit clock
gating as well.
v3:
- Rebase on top of other workarounds that have landed.
- Restrict cc:stable tag to 5.2+ since that's when ICL was first
officially supported.
Bspec: 32354
Bspec: 33450
Bspec: 33451
Suggested-by: Lionel Landwerlin
Cc: stable@vger.kernel.org # v5.2+
Cc: Lionel Landwerlin
Cc: Lucas De Marchi
Cc: Matt Atwood
Signed-off-by: Matt Roper
Acked-by: Lionel Landwerlin
Link: https://patchwork.freedesktop.org/patch/msgid/20191231190713.1549533-1-matthew.d.roper@intel.com
(cherry picked from commit 1cd21a7c5679015352e8a6f46813aced51d71bb8)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 59aa28fcf770605911f176a0715fe4c840e84f8a
Author: Wayne Lin
Date: Fri Jan 3 13:50:01 2020 +0800
drm/dp\_mst: correct the shifting in DP\_REMOTE\_I2C\_READ
commit c4e4fccc5d52d881afaac11d3353265ef4eccb8b upstream.
[Why]
According to DP spec, it should shift left 4 digits for NO\_STOP\_BIT
in REMOTE\_I2C\_READ message. Not 5 digits.
In current code, NO\_STOP\_BIT is always set to zero which means I2C
master is always generating a I2C stop at the end of each I2C write
transaction while handling REMOTE\_I2C\_READ sideband message. This issue
might have the generated I2C signal not meeting the requirement. Take
random read in I2C for instance, I2C master should generate a repeat
start to start to read data after writing the read address. This issue
will cause the I2C master to generate a stop-start rather than a
re-start which is not expected in I2C random read.
[How]
Correct the shifting value of NO\_STOP\_BIT for DP\_REMOTE\_I2C\_READ case in
drm\_dp\_encode\_sideband\_req().
Changes since v1:(https://patchwork.kernel.org/patch/11312667/)
\* Add more descriptions in commit and cc to stable
Fixes: ad7f8a1f9ced ("drm/helper: add Displayport multi-stream helper (v0.6)")
Reviewed-by: Harry Wentland
Signed-off-by: Wayne Lin
Cc: stable@vger.kernel.org
Signed-off-by: Lyude Paul
Link: https://patchwork.freedesktop.org/patch/msgid/20200103055001.10287-1-Wayne.Lin@amd.com
Signed-off-by: Greg Kroah-Hartman
commit 03eb90320651d91c62f69116b604d6834242fb8f
Author: Geert Uytterhoeven
Date: Mon Dec 30 14:27:34 2019 +0100
drm/fb-helper: Round up bits\_per\_pixel if possible
commit f30e27779d3031a092c2a177b7fb76adccc45241 upstream.
When userspace requests a video mode parameter value that is not
supported, frame buffer device drivers should round it up to a supported
value, if possible, instead of just rejecting it. This allows
applications to quickly scan for supported video modes.
Currently this rule is not followed for the number of bits per pixel,
causing e.g. "fbset -depth N" to fail, if N is smaller than the current
number of bits per pixel.
Fix this by returning an error only if bits per pixel is too large, and
setting it to the current value otherwise.
See also Documentation/fb/framebuffer.rst, Section 2 (Programmer's View
of /dev/fb\*").
Fixes: 865afb11949e5bf4 ("drm/fb-helper: reject any changes to the fbdev")
Cc: stable@vger.kernel.org
Signed-off-by: Geert Uytterhoeven
Signed-off-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20191230132734.4538-1-geert+renesas@glider.be
Signed-off-by: Greg Kroah-Hartman
commit c001b900caa6ddafd5becf09fef7614141cf583e
Author: Chen-Yu Tsai
Date: Tue Jan 7 15:01:13 2020 +0800
drm/sun4i: tcon: Set RGB DCLK min. divider based on hardware model
commit 4396393fb96449c56423fb4b351f76e45a6bcaf6 upstream.
In commit 0b8e7bbde5e7 ("drm/sun4i: tcon: Set min division of TCON0\_DCLK
to 1.") it was assumed that all TCON variants support a minimum divider
of 1 if only DCLK was used.
However, the oldest generation of hardware only supports minimum divider
of 4 if only DCLK is used. If a divider of 1 was used on this old
hardware, some scrolling artifact would appear. A divider of 2 seemed
OK, but a divider of 3 had artifacts as well.
Set the minimum divider when outputing to parallel RGB based on the
hardware model, with a minimum of 4 for the oldest (A10/A10s/A13/A20)
hardware, and a minimum of 1 for the rest. A value is not set for the
TCON variants lacking channel 0.
This fixes the scrolling artifacts seen on my A13 tablet.
Fixes: 0b8e7bbde5e7 ("drm/sun4i: tcon: Set min division of TCON0\_DCLK to 1.")
Cc:  # 5.4.x
Signed-off-by: Chen-Yu Tsai
Signed-off-by: Maxime Ripard
Link: https://patchwork.freedesktop.org/patch/msgid/20200107070113.28951-1-wens@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 825fb807747b5f19e30e8c8fcd08e065fb609ddd
Author: Alex Deucher
Date: Mon Jan 6 15:24:47 2020 -0500
Revert "drm/amdgpu: Set no-retry as default."
commit 7aec9ec1cf324d5c5a8d17b9c78a34c388e5f17b upstream.
This reverts commit 51bfac71cade386966791a8db87a5912781d249f.
This causes stability issues on some raven boards. Revert
for now until a proper fix is completed.
Bug: https://gitlab.freedesktop.org/drm/amd/issues/934
Bug: https://bugzilla.kernel.org/show\_bug.cgi?id=206017
Reviewed-by: Felix Kuehling
Reviewed-by: Christian KÃ¶nig
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 4f1fa1164ddfd339d961c9ff563e11f77e6bd514
Author: Matt Roper
Date: Mon Dec 23 17:20:25 2019 -0800
drm/i915: Add Wa\_1408615072 and Wa\_1407596294 to icl,ehl
commit a7f3ad37f80d0d5eec9dad156964c0dac800a80e upstream.
Workaround database indicates we should disable clock gating of both the
vsunit and hsunit.
Bspec: 33450
Bspec: 33451
Cc: stable@kernel.vger.org
Cc: Lucas De Marchi
Cc: Matt Atwood
Cc: Radhakrishna Sripada
Signed-off-by: Matt Roper
Link: https://patchwork.freedesktop.org/patch/msgid/20191224012026.3157766-3-matthew.d.roper@intel.com
Reviewed-by: Lucas De Marchi
(cherry picked from commit b9cf9dac3dac4c1d2a47d34f30ec53c0423cecf8)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 854ac5dee5be03a280faf1a4f7907b4e9a4b3be1
Author: Arnd Bergmann
Date: Fri Dec 13 14:06:58 2019 -0800
Input: input\_event - fix struct padding on sparc64
commit f729a1b0f8df7091cea3729fc0e414f5326e1163 upstream.
Going through all uses of timeval, I noticed that we screwed up
input\_event in the previous attempts to fix it:
The time fields now match between kernel and user space, but all following
fields are in the wrong place.
Add the required padding that is implied by the glibc timeval definition
to fix the layout, and use a struct initializer to avoid leaking kernel
stack data.
Fixes: 141e5dcaa735 ("Input: input\_event - fix the CONFIG\_SPARC64 mixup")
Fixes: 2e746942ebac ("Input: input\_event - provide override for sparc64")
Signed-off-by: Arnd Bergmann
Link: https://lore.kernel.org/r/20191213204936.3643476-2-arnd@arndb.de
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 39f711b69799c49e0e385494b9b8c0787f51293f
Author: Dmitry Torokhov
Date: Fri Dec 13 14:56:16 2019 -0800
Input: add safety guards to input\_set\_keycode()
commit cb222aed03d798fc074be55e59d9a112338ee784 upstream.
If we happen to have a garbage in input device's keycode table with values
too big we'll end up doing clear\_bit() with offset way outside of our
bitmaps, damaging other objects within an input device or even outside of
it. Let's add sanity checks to the returned old keycodes.
Reported-by: syzbot+c769968809f9359b07aa@syzkaller.appspotmail.com
Reported-by: syzbot+76f3a30e88d256644c78@syzkaller.appspotmail.com
Link: https://lore.kernel.org/r/20191207212757.GA245964@dtor-ws
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 4091fbf6cc143c8ccd8275eaa642b2f2afe7c4ab
Author: Dmitry Torokhov
Date: Sat Dec 7 13:05:18 2019 -0800
HID: hid-input: clear unmapped usages
commit 4f3882177240a1f55e45a3d241d3121341bead78 upstream.
We should not be leaving half-mapped usages with potentially invalid
keycodes, as that may confuse hidinput\_find\_key() when the key is located
by index, which may end up feeding way too large keycode into the VT
keyboard handler and cause OOB write there:
BUG: KASAN: global-out-of-bounds in clear\_bit include/asm-generic/bitops-instrumented.h:56 [inline]
BUG: KASAN: global-out-of-bounds in kbd\_keycode drivers/tty/vt/keyboard.c:1411 [inline]
BUG: KASAN: global-out-of-bounds in kbd\_event+0xe6b/0x3790 drivers/tty/vt/keyboard.c:1495
Write of size 8 at addr ffffffff89a1b2d8 by task syz-executor108/1722
...
kbd\_keycode drivers/tty/vt/keyboard.c:1411 [inline]
kbd\_event+0xe6b/0x3790 drivers/tty/vt/keyboard.c:1495
input\_to\_handler+0x3b6/0x4c0 drivers/input/input.c:118
input\_pass\_values.part.0+0x2e3/0x720 drivers/input/input.c:145
input\_pass\_values drivers/input/input.c:949 [inline]
input\_set\_keycode+0x290/0x320 drivers/input/input.c:954
evdev\_handle\_set\_keycode\_v2+0xc4/0x120 drivers/input/evdev.c:882
evdev\_do\_ioctl drivers/input/evdev.c:1150 [inline]
Cc: stable@vger.kernel.org
Reported-by: syzbot+19340dff067c2d3835c0@syzkaller.appspotmail.com
Signed-off-by: Dmitry Torokhov
Tested-by: Benjamin Tissoires
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit e38d7bb30cbe8f9070607a424bb25f27c3cf3d35
Author: Marcel Holtmann
Date: Wed Dec 4 03:37:13 2019 +0100
HID: hidraw: Fix returning EPOLLOUT from hidraw\_poll
commit 9f3b61dc1dd7b81e99e7ed23776bb64a35f39e1a upstream.
When polling a connected /dev/hidrawX device, it is useful to get the
EPOLLOUT when writing is possible. Since writing is possible as soon as
the device is connected, always return it.
Right now EPOLLOUT is only returned when there are also input reports
are available. This works if devices start sending reports when
connected, but some HID devices might need an output report first before
sending any input reports. This change will allow using EPOLLOUT here as
well.
Fixes: 378b80370aa1 ("hidraw: Return EPOLLOUT from hidraw\_poll")
Signed-off-by: Marcel Holtmann
Cc: stable@vger.kernel.org
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 566dbc0db3fc58335df35336083feb44649051a3
Author: Marcel Holtmann
Date: Wed Dec 4 03:43:55 2019 +0100
HID: uhid: Fix returning EPOLLOUT from uhid\_char\_poll
commit be54e7461ffdc5809b67d2aeefc1ddc9a91470c7 upstream.
Always return EPOLLOUT from uhid\_char\_poll to allow polling /dev/uhid
for writable state.
Fixes: 1f9dec1e0164 ("HID: uhid: allow poll()'ing on uhid devices")
Signed-off-by: Marcel Holtmann
Cc: stable@vger.kernel.org
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 2cc7eb656286e761fec47eccccacc953db6e0cff
Author: Alan Stern
Date: Tue Dec 10 16:26:11 2019 -0500
HID: Fix slab-out-of-bounds read in hid\_field\_extract
commit 8ec321e96e056de84022c032ffea253431a83c3c upstream.
The syzbot fuzzer found a slab-out-of-bounds bug in the HID report
handler. The bug was caused by a report descriptor which included a
field with size 12 bits and count 4899, for a total size of 7349
bytes.
The usbhid driver uses at most a single-page 4-KB buffer for reports.
In the test there wasn't any problem about overflowing the buffer,
since only one byte was received from the device. Rather, the bug
occurred when the HID core tried to extract the data from the report
fields, which caused it to try reading data beyond the end of the
allocated buffer.
This patch fixes the problem by rejecting any report whose total
length exceeds the HID\_MAX\_BUFFER\_SIZE limit (minus one byte to allow
for a possible report index). In theory a device could have a report
longer than that, but if there was such a thing we wouldn't handle it
correctly anyway.
Reported-and-tested-by: syzbot+09ef48aa58261464b621@syzkaller.appspotmail.com
Signed-off-by: Alan Stern
CC:
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit 5270a752defa4d71e4a3ca7e2a1026e9806340e4
Author: Joel Fernandes (Google)
Date: Thu Jan 2 14:46:25 2020 -0500
tracing: Change offset type to s32 in preempt/irq tracepoints
commit bf44f488e168368cae4139b4b33c3d0aaa11679c upstream.
Discussion in the below link reported that symbols in modules can appear
to be before \_stext on ARM architecture, causing wrapping with the
offsets of this tracepoint. Change the offset type to s32 to fix this.
Link: http://lore.kernel.org/r/20191127154428.191095-1-antonio.borneo@st.com
Link: http://lkml.kernel.org/r/20200102194625.226436-1-joel@joelfernandes.org
Cc: Bjorn Helgaas
Cc: David Sterba
Cc: Ingo Molnar
Cc: Mike Rapoport
Cc: "Rafael J. Wysocki"
Cc: Sakari Ailus
Cc: Antonio Borneo
Cc: stable@vger.kernel.org
Fixes: d59158162e032 ("tracing: Add support for preempt and irq enable/disable events")
Signed-off-by: Joel Fernandes (Google)
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 907062a7503a64b1d48df4bf4d3cde9c4d58a267
Author: Steven Rostedt (VMware)
Date: Thu Jan 2 22:02:41 2020 -0500
tracing: Have stack tracer compile when MCOUNT\_INSN\_SIZE is not defined
commit b8299d362d0837ae39e87e9019ebe6b736e0f035 upstream.
On some archs with some configurations, MCOUNT\_INSN\_SIZE is not defined, and
this makes the stack tracer fail to compile. Just define it to zero in this
case.
Link: https://lore.kernel.org/r/202001020219.zvE3vsty%lkp@intel.com
Cc: stable@vger.kernel.org
Fixes: 4df297129f622 ("tracing: Remove most or all of stack tracer stack size from stack\_max\_size")
Reported-by: kbuild test robot
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit 654eced27a13c5b45af9ea9ca7e4626bb050eb68
Author: Kaitao Cheng
Date: Tue Dec 31 05:35:30 2019 -0800
kernel/trace: Fix do not unregister tracepoints when register sched\_migrate\_task fail
commit 50f9ad607ea891a9308e67b81f774c71736d1098 upstream.
In the function, if register\_trace\_sched\_migrate\_task() returns error,
sched\_switch/sched\_wakeup\_new/sched\_wakeup won't unregister. That is
why fail\_deprobe\_sched\_switch was added.
Link: http://lkml.kernel.org/r/20191231133530.2794-1-pilgrimtao@gmail.com
Cc: stable@vger.kernel.org
Fixes: 478142c39c8c2 ("tracing: do not grab lock in wakeup latency function tracing")
Signed-off-by: Kaitao Cheng
Signed-off-by: Steven Rostedt (VMware)
Signed-off-by: Greg Kroah-Hartman
commit cfa719c2cc5989d81ffeb5994005b5a18e89a75c
Author: Chen-Yu Tsai
Date: Thu Dec 5 16:50:54 2019 +0800
rtc: sun6i: Add support for RTC clocks on R40
commit 111bf02b8f544f98de53ea1f912ae01f598b161b upstream.
When support for the R40 in the rtc-sun6i driver was split out for a
separate compatible string, only the RTC half was covered, and not the
clock half. Unfortunately this results in the whole driver not working,
as the RTC half expects the clock half to have been initialized.
Add support for the clock part as well. The clock part is like the H3,
but does not need to export the internal oscillator, nor does it have
a gateable LOSC external output.
This fixes issues with WiFi and Bluetooth not working on the BPI M2U.
Fixes: d6624cc75021 ("rtc: sun6i: Add R40 compatible")
Cc:  # 5.3.x
Signed-off-by: Chen-Yu Tsai
Acked-by: Maxime Ripard
Link: https://lore.kernel.org/r/20191205085054.6049-1-wens@kernel.org
Signed-off-by: Alexandre Belloni
Signed-off-by: Greg Kroah-Hartman
commit 18c395532370dc30d4abe526d77a58c2372add2b
Author: Tadeusz Struk
Date: Tue Jan 7 14:04:48 2020 -0800
tpm: Handle negative priv->response\_len in tpm\_common\_read()
commit a430e67d9a2c62a8c7b315b99e74de02018d0a96 upstream.
The priv->response\_length can hold the size of an response or an negative
error code, and the tpm\_common\_read() needs to handle both cases correctly.
Changed the type of response\_length to signed and accounted for negative
value in tpm\_common\_read().
Cc: stable@vger.kernel.org
Fixes: d23d12484307 ("tpm: fix invalid locking in NONBLOCKING mode")
Reported-by: Laura Abbott
Signed-off-by: Tadeusz Struk
Reviewed-by: Jarkko Sakkinen
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 2e1a0a118abe853cd9217368a551f53a0cdff15b
Author: Stefan Berger
Date: Tue Nov 26 08:17:53 2019 -0500
tpm: Revert "tpm\_tis\_core: Turn on the TPM before probing IRQ's"
commit aa4a63dd981682b1742baa01237036e48bc11923 upstream.
There has been a bunch of reports (one from kernel bugzilla linked)
reporting that when this commit is applied it causes on some machines
boot freezes.
Unfortunately hardware where this commit causes a failure is not widely
available (only one I'm aware is Lenovo T490), which means we cannot
predict yet how long it will take to properly fix tpm\_tis interrupt
probing.
Thus, the least worst short term action is to revert the code to the
state before this commit. In long term we need fix the tpm\_tis probing
code to work on machines that Stefan's fix was supposed to fix.
Fixes: 21df4a8b6018 ("tpm\_tis: reserve chip for duration of tpm\_tis\_core\_init")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=205935
Cc: stable@vger.kernel.org
Cc: Jerry Snitselaar
Cc: Dan Williams
Tested-by: Dan Williams
Tested-by: Xiaoping Zhou
Signed-off-by: Stefan Berger
Reported-by: Jerry Snitselaar
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 495e9443cab9db3b8d51e837923f8170b3085c71
Author: Stefan Berger
Date: Tue Nov 26 08:17:52 2019 -0500
tpm: Revert "tpm\_tis\_core: Set TPM\_CHIP\_FLAG\_IRQ before probing for interrupts"
commit dda8b2af395b2ed508e2ef314ae32e122841b447 upstream.
There has been a bunch of reports (one from kernel bugzilla linked)
reporting that when this commit is applied it causes on some machines
boot freezes.
Unfortunately hardware where this commit causes a failure is not widely
available (only one I'm aware is Lenovo T490), which means we cannot
predict yet how long it will take to properly fix tpm\_tis interrupt
probing.
Thus, the least worst short term action is to revert the code to the
state before this commit. In long term we need fix the tpm\_tis probing
code to work on machines that Stefan's fix was supposed to fix.
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=205935
Fixes: 1ea32c83c699 ("tpm\_tis\_core: Set TPM\_CHIP\_FLAG\_IRQ before probing for interrupts")
Cc: stable@vger.kernel.org
Cc: Jerry Snitselaar
Cc: Dan Williams
Tested-by: Dan Williams
Tested-by: Xiaoping Zhou
Signed-off-by: Stefan Berger
Reported-by: Jerry Snitselaar
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 6de025ef5840dff4ddb6e9043ae6ca3d1b95c1cd
Author: Jarkko Sakkinen
Date: Tue Dec 31 01:19:59 2019 +0200
tpm: Revert "tpm\_tis: reserve chip for duration of tpm\_tis\_core\_init"
commit 9550f210492c6f88415709002f42a9d15c0e6231 upstream.
Revert a commit, which was included in Linux v5.5-rc3 because it did not
properly fix the issues it was supposed to fix.
Fixes: 21df4a8b6018 ("tpm\_tis: reserve chip for duration of tpm\_tis\_core\_init")
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=205935
Cc: stable@vger.kernel.org
Cc: Jerry Snitselaar
Cc: Dan Williams
Tested-by: Dan Williams
Tested-by: Xiaoping Zhou
Signed-off-by: Jarkko Sakkinen
Signed-off-by: Greg Kroah-Hartman
commit 86353aa70ed085f1b8ef9dae45491d5beb0728dd
Author: Kailang Yang
Date: Wed Jan 8 16:47:56 2020 +0800
ALSA: hda/realtek - Add quirk for the bass speaker on Lenovo Yoga X1 7th gen
commit 54a6a7dc107da0492a9e84fd7e9a107b3c58138d upstream.
Add quirk to ALC285\_FIXUP\_SPEAKER2\_TO\_DAC1, which is the same fixup
applied for X1 Carbon 7th gen in commit d2cd795c4ece ("ALSA: hda -
fixup for the bass speaker on Lenovo Carbon X1 7th gen").
Signed-off-by: Kailang Yang
Reviewed-by: Jaroslav Kysela
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 69ec8c0e3377f2f94ae160377fad585fbd062caf
Author: Kailang Yang
Date: Tue Jan 7 17:22:19 2020 +0800
ALSA: hda/realtek - Set EAPD control to default for ALC222
commit 9194a1ebbc56d7006835e2b4cacad301201fb832 upstream.
Set EAPD control to verb control.
Signed-off-by: Kailang Yang
Cc:
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b25acd7045df332edd142efbad9594eb18d91e6d
Author: Kailang Yang
Date: Fri Jan 3 16:24:06 2020 +0800
ALSA: hda/realtek - Add new codec supported for ALCS1200A
commit 6d9ffcff646bbd0ede6c2a59f4cd28414ecec6e0 upstream.
Add ALCS1200A supported.
It was similar as ALC900.
Signed-off-by: Kailang Yang
Cc:
Link: https://lore.kernel.org/r/a9bd3cdaa02d4fa197623448d5c51e50@realtek.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit d496377685e3e8a2fd32cf6567aab99a30585b46
Author: Takashi Iwai
Date: Sat Jan 4 12:09:36 2020 +0100
ALSA: usb-audio: Apply the sample rate quirk for Bose Companion 5
commit 51d4efab7865e6ea6a4ebcd25b3f03c019515c4c upstream.
Bose Companion 5 (with USB ID 05a7:1020) doesn't seem supporting
reading back the sample rate, so the existing quirk is needed.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=206063
Cc:
Link: https://lore.kernel.org/r/20200104110936.14288-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit b5c477d904eb179cbaf82b9e263b011f65ee249b
Author: Guenter Roeck
Date: Thu Dec 26 07:57:54 2019 -0800
usb: chipidea: host: Disable port power only if previously enabled
commit c1ffba305dbcf3fb9ca969c20a97acbddc38f8e9 upstream.
On shutdown, ehci\_power\_off() is called unconditionally to power off
each port, even if it was never called to power on the port.
For chipidea, this results in a call to ehci\_ci\_portpower() with a request
to power off ports even if the port was never powered on.
This results in the following warning from the regulator code.
WARNING: CPU: 0 PID: 182 at drivers/regulator/core.c:2596 \_regulator\_disable+0x1a8/0x210
unbalanced disables for usb\_otg2\_vbus
Modules linked in:
CPU: 0 PID: 182 Comm: init Not tainted 5.4.6 #1
Hardware name: Freescale i.MX7 Dual (Device Tree)
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0xe0/0x10c)
[] (dump\_stack) from [] (\_\_warn+0xf4/0x10c)
[] (\_\_warn) from [] (warn\_slowpath\_fmt+0x78/0xbc)
[] (warn\_slowpath\_fmt) from [] (\_regulator\_disable+0x1a8/0x210)
[] (\_regulator\_disable) from [] (regulator\_disable+0x38/0xe8)
[] (regulator\_disable) from [] (ehci\_ci\_portpower+0x38/0xdc)
[] (ehci\_ci\_portpower) from [] (ehci\_port\_power+0x50/0xa4)
[] (ehci\_port\_power) from [] (ehci\_silence\_controller+0x5c/0xc4)
[] (ehci\_silence\_controller) from [] (ehci\_stop+0x3c/0xcc)
[] (ehci\_stop) from [] (usb\_remove\_hcd+0xe0/0x19c)
[] (usb\_remove\_hcd) from [] (host\_stop+0x38/0xa8)
[] (host\_stop) from [] (ci\_hdrc\_remove+0x44/0xe4)
...
Keeping track of the power enable state avoids the warning and traceback.
Fixes: c8679a2fb8dec ("usb: chipidea: host: add portpower override")
Cc: Michael Grzeschik
Cc: Peter Chen
Cc: stable@vger.kernel.org
Signed-off-by: Guenter Roeck
Acked-by: Peter Chen
Link: https://lore.kernel.org/r/20191226155754.25451-1-linux@roeck-us.net
Signed-off-by: Greg Kroah-Hartman
commit d7ce45829cbfff0c4fc082d05823dac8cd241fdf
Author: Harry Pan
Date: Mon Dec 30 22:36:56 2019 +0800
powercap: intel\_rapl: add NULL pointer check to rapl\_mmio\_cpu\_online()
commit 3aa3c5882e4fb2274448908aaed605a3ed7dd15d upstream.
RAPL MMIO support depends on the RAPL common driver. During CPU
initialization rapl\_mmio\_cpu\_online() is called via CPU hotplug
to initialize the MMIO RAPL for the new CPU, but if that CPU is
not present in the common RAPL driver's support list, rapl\_defaults
is NULL and the kernel crashes on an attempt to dereference it:
[ 4.188566] BUG: kernel NULL pointer dereference, address: 0000000000000020
...snip...
[ 4.189555] RIP: 0010:rapl\_add\_package+0x223/0x574
[ 4.189555] Code: b5 a0 31 c0 49 8b 4d 78 48 01 d9 48 8b 0c c1 49 89 4c c6 10 48 ff c0 48 83 f8 05 75 e7 49 83 ff 03 75 15 48 8b 05 09 bc 18 01 <8b> 70 20 41 89 b6 0c 05 00 00 85 f6 75 1a 49 81 c6 18 9
[ 4.189555] RSP: 0000:ffffb3adc00b3d90 EFLAGS: 00010246
[ 4.189555] RAX: 0000000000000000 RBX: 0000000000000098 RCX: 0000000000000000
[ 4.267161] usb 1-1: New USB device found, idVendor=2109, idProduct=2812, bcdDevice= b.e0
[ 4.189555] RDX: 0000000000001000 RSI: 0000000000000000 RDI: ffff9340caafd000
[ 4.189555] RBP: ffffb3adc00b3df8 R08: ffffffffa0246e28 R09: ffff9340caafc000
[ 4.189555] R10: 000000000000024a R11: ffffffff9ff1f6f2 R12: 00000000ffffffed
[ 4.189555] R13: ffff9340caa94800 R14: ffff9340caafc518 R15: 0000000000000003
[ 4.189555] FS: 0000000000000000(0000) GS:ffff9340ce200000(0000) knlGS:0000000000000000
[ 4.189555] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4.189555] CR2: 0000000000000020 CR3: 0000000302c14001 CR4: 00000000003606f0
[ 4.189555] Call Trace:
[ 4.189555] ? \_\_switch\_to\_asm+0x40/0x70
[ 4.189555] rapl\_mmio\_cpu\_online+0x47/0x64
[ 4.189555] ? rapl\_mmio\_write\_raw+0x33/0x33
[ 4.281059] usb 1-1: New USB device strings: Mfr=1, Product=2, SerialNumber=0
[ 4.189555] cpuhp\_invoke\_callback+0x29f/0x66f
[ 4.189555] ? \_\_schedule+0x46d/0x6a0
[ 4.189555] cpuhp\_thread\_fun+0xb9/0x11c
[ 4.189555] smpboot\_thread\_fn+0x17d/0x22f
[ 4.297006] usb 1-1: Product: USB2.0 Hub
[ 4.189555] ? cpu\_report\_death+0x43/0x43
[ 4.189555] kthread+0x137/0x13f
[ 4.189555] ? cpu\_report\_death+0x43/0x43
[ 4.189555] ? kthread\_blkcg+0x2e/0x2e
[ 4.312951] usb 1-1: Manufacturer: VIA Labs, Inc.
[ 4.189555] ret\_from\_fork+0x1f/0x40
[ 4.189555] Modules linked in:
[ 4.189555] CR2: 0000000000000020
[ 4.189555] ---[ end trace 01bb812aabc791f4 ]---
To avoid that problem, check rapl\_defaults NULL upfront and return an
error code if it is NULL. [Note that it does not make sense to even
try to allocate memory in that case, because it is not going to be
used anyway.]
Fixes: 555c45fe0d04 ("int340X/processor\_thermal\_device: add support for MMIO RAPL")
Cc: 5.3+  # 5.3+
Signed-off-by: Harry Pan
[ rjw: Subject & changelog ]
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Greg Kroah-Hartman
commit 9d7e2f25a0fde3e216a97e90b6556adf0d7d3eca
Author: Russell King
Date: Sun Dec 15 16:39:05 2019 +0000
i2c: fix bus recovery stop mode timing
commit cf8ce8b80f8bf9669f6ec4e71e16668430febdac upstream.
The I2C specification states that tsu:sto for standard mode timing must
be at minimum 4us. Pictographically, this is:
SCL: \_\_\_\_/~~~~~~~~~
SDA: \_\_\_\_\_\_\_\_\_/~~~~
->| |<- 4us minimum
We are currently waiting 2.5us between asserting SCL and SDA, which is
in violation of the standard. Adjust the timings to ensure that we meet
what is stipulated as the minimum timings to ensure that all devices
correctly interpret the STOP bus transition.
This is more important than trying to generate a square wave with even
duty cycle.
Signed-off-by: Russell King
Signed-off-by: Wolfram Sang
Signed-off-by: Greg Kroah-Hartman
commit 341464390512ed50d5e96cf8f5340dcfbebd837a
Author: Will Deacon
Date: Thu Dec 19 12:02:03 2019 +0000
chardev: Avoid potential use-after-free in 'chrdev\_open()'
commit 68faa679b8be1a74e6663c21c3a9d25d32f1c079 upstream.
'chrdev\_open()' calls 'cdev\_get()' to obtain a reference to the
'struct cdev \*' stashed in the 'i\_cdev' field of the target inode
structure. If the pointer is NULL, then it is initialised lazily by
looking up the kobject in the 'cdev\_map' and so the whole procedure is
protected by the 'cdev\_lock' spinlock to serialise initialisation of
the shared pointer.
Unfortunately, it is possible for the initialising thread to fail \*after\*
installing the new pointer, for example if the subsequent '->open()' call
on the file fails. In this case, 'cdev\_put()' is called, the reference
count on the kobject is dropped and, if nobody else has taken a reference,
the release function is called which finally clears 'inode->i\_cdev' from
'cdev\_purge()' before potentially freeing the object. The problem here
is that a racing thread can happily take the 'cdev\_lock' and see the
non-NULL pointer in the inode, which can result in a refcount increment
from zero and a warning:
| ------------[ cut here ]------------
| refcount\_t: addition on 0; use-after-free.
| WARNING: CPU: 2 PID: 6385 at lib/refcount.c:25 refcount\_warn\_saturate+0x6d/0xf0
| Modules linked in:
| CPU: 2 PID: 6385 Comm: repro Not tainted 5.5.0-rc2+ #22
| Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.12.0-1 04/01/2014
| RIP: 0010:refcount\_warn\_saturate+0x6d/0xf0
| Code: 05 55 9a 15 01 01 e8 9d aa c8 ff 0f 0b c3 80 3d 45 9a 15 01 00 75 ce 48 c7 c7 00 9c 62 b3 c6 08
| RSP: 0018:ffffb524c1b9bc70 EFLAGS: 00010282
| RAX: 0000000000000000 RBX: ffff9e9da1f71390 RCX: 0000000000000000
| RDX: ffff9e9dbbd27618 RSI: ffff9e9dbbd18798 RDI: ffff9e9dbbd18798
| RBP: 0000000000000000 R08: 000000000000095f R09: 0000000000000039
| R10: 0000000000000000 R11: ffffb524c1b9bb20 R12: ffff9e9da1e8c700
| R13: ffffffffb25ee8b0 R14: 0000000000000000 R15: ffff9e9da1e8c700
| FS: 00007f3b87d26700(0000) GS:ffff9e9dbbd00000(0000) knlGS:0000000000000000
| CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
| CR2: 00007fc16909c000 CR3: 000000012df9c000 CR4: 00000000000006e0
| DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
| DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
| Call Trace:
| kobject\_get+0x5c/0x60
| cdev\_get+0x2b/0x60
| chrdev\_open+0x55/0x220
| ? cdev\_put.part.3+0x20/0x20
| do\_dentry\_open+0x13a/0x390
| path\_openat+0x2c8/0x1470
| do\_filp\_open+0x93/0x100
| ? selinux\_file\_ioctl+0x17f/0x220
| do\_sys\_open+0x186/0x220
| do\_syscall\_64+0x48/0x150
| entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
| RIP: 0033:0x7f3b87efcd0e
| Code: 89 54 24 08 e8 a3 f4 ff ff 8b 74 24 0c 48 8b 3c 24 41 89 c0 44 8b 54 24 08 b8 01 01 00 00 89 f4
| RSP: 002b:00007f3b87d259f0 EFLAGS: 00000293 ORIG\_RAX: 0000000000000101
| RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f3b87efcd0e
| RDX: 0000000000000000 RSI: 00007f3b87d25a80 RDI: 00000000ffffff9c
| RBP: 00007f3b87d25e90 R08: 0000000000000000 R09: 0000000000000000
| R10: 0000000000000000 R11: 0000000000000293 R12: 00007ffe188f504e
| R13: 00007ffe188f504f R14: 00007f3b87d26700 R15: 0000000000000000
| ---[ end trace 24f53ca58db8180a ]---
Since 'cdev\_get()' can already fail to obtain a reference, simply move
it over to use 'kobject\_get\_unless\_zero()' instead of 'kobject\_get()',
which will cause the racing thread to return -ENXIO if the initialising
thread fails unexpectedly.
Cc: Hillf Danton
Cc: Andrew Morton
Cc: Al Viro
Reported-by: syzbot+82defefbbd8527e1c2cb@syzkaller.appspotmail.com
Signed-off-by: Will Deacon
Cc: stable
Link: https://lore.kernel.org/r/20191219120203.32691-1-will@kernel.org
Signed-off-by: Greg Kroah-Hartman

