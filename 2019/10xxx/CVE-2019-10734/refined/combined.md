=== Content from invent.kde.org_7236cbdb_20250121_020716.html ===


You need to sign in or sign up before continuing.

# KDE Invent (Gitlab)

GitLab is a single application for the entire software development lifecycle.

To register or recover an account please visit [KDE Identity](https://identity.kde.org/).

![KDE Invent (Gitlab)](data:image/gif;base64...)

* [KDE Identity](#ldapmain)

Username

Password

Remember me

Sign in

---

[Explore](/explore)
[Help](/help)
[About GitLab](https://about.gitlab.com)
[Community forum](https://forum.gitlab.com)



=== Content from arxiv.org_96427d7e_20250121_020719.html ===
Re: What’s Up Johnny?
Covert Content Attacks on Email End-to-End Encryption

Jens Müller1, Marcus Brinkmann1, Damian Poddebniak2, Sebastian Schinzel2,
and Jörg Schwenk1

1 Ruhr University Bochum, Germany
{jens.a.mueller,marcus.brinkmann,joerg.schwenk}@rub.de
2 Münster University of Applied Sciences, Germany
{damian.poddebniak,schinzel}@fh-muenster.de

Abstract. We show practical attacks against OpenPGP and S/MIME
encryption and digital signatures in the context of email. Instead of tar-
geting the underlying cryptographic primitives, our attacks abuse legiti-
mate features of the MIME standard and HTML, as supported by email
clients, to deceive the user regarding the actual message content. We
demonstrate how the attacker can unknowingly abuse the user as a de-
cryption oracle by replying to an unsuspicious looking email. Using this
technique, the plaintext of hundreds of encrypted emails can be leaked
at once. Furthermore, we show how users could be tricked into signing
arbitrary text by replying to emails containing CSS conditional rules.
An evaluation shows that 17 out of 19 OpenPGP-capable email clients,
as well as 21 out of 22 clients supporting S/MIME, are vulnerable to at
least one attack. We provide diﬀerent countermeasures and discuss their
advantages and disadvantages.

Keywords: PGP · S/MIME · Decryption Oracles · Signing Oracles.

1

Introduction

Email was designed as a plaintext protocol, which allows eavesdroppers to read or
modify the communication on the channel. While it is common today that traﬃc
between mailservers is TLS encrypted,3 transport encryption is not suﬃcient to
protect against strong attackers, such as a man-in-the-middle (MitM) within the
infrastructure (e.g., a dishonest mail server operator), or an attacker who gains
access to leaked user emails. OpenPGP [2] and S/MIME [9] are the two major
standards used in such scenarios and provide end-to-end cryptographic protec-
tion. Both standards are designed to guarantee conﬁdentiality, integrity, and
authenticity of messages, even in hostile environments such as a compromised
or untrustworthy mail server by encrypting and digitally signing emails.

3 According to Google’s transparency report, 88% of the email traﬃc was TLS encrypted
in the fourth quarter of 2018: https://transparencyreport.google.com/safer-email/

2

J. Müller et al.

Research Question. Both standards are based on asymmetric encryption; only
the user has access to the private key and, therefore, can decrypt messages en-
crypted with the public key or sign messages. However, email usage involves
interaction with multiple communication partners, including potentially dishon-
est parties. Example: a mail server operator, Eve, who is in possession of the
ciphertext messages sent from Alice to Bob can simply re-send the encrypted
message from her address and have Bob decrypt it.4 If Bob simply replied to
Eve while quoting the original message, he would leak the plaintext of his com-
munication with Alice. Such message takeover attacks under a new identity are
well-known issues in email end-to-end encryption (see [6, 7]). However, they are
generally considered an acceptable risk because it is assumed that given the
context of the message (e.g., “Hi Bob, [...] Yours, Alice”) Bob can tell that this
message is not originally from Eve and could easily discover the deception.

Therefore, the research question arises: Is it possible to hide the original text
to trick a user into unintentionally acting as a decryption oracle? A schematic
illustration of such an attack is given in Figure 1.

Fig. 1: Covert content attacks against email encryption.

Contributions. In this work, we show simple, yet practical, attacks against
email encryption and digital signatures, and discuss the countermeasures. We
demonstrate how an attacker can wrap ciphertext into a specially crafted email
which looks benign but leaks the plaintext of hundreds of encrypted emails at
once if replied to. Furthermore, we show how to turn the victim into a signing
oracle by having him sign quoted covert content. The attacker can put this
content into a diﬀerent context based on CSS conditional rules, resulting in
arbitrary text to be displayed as correctly signed by the victim. Our evaluation
shows that 17 out of 19 OpenPGP capable email clients, as well as 21 out of 22
clients supporting S/MIME are vulnerable to at least one attack. Our attacks
raise concerns about the overall security of encryption and digital signatures in
the context of email, even though the security guarantees of the cryptography
behind them remains untouched.

Responsible Disclosure. We reported our attacks to the aﬀected vendors
and proposed appropriate countermeasures. Our ﬁndings regarding email end-
to-end encryption resulted in CVE-2019-10731 to CVE-2019-10741. Our attacks
on digital signatures are documented as CVE-2019-10726 to CVE-2019-10730.

4 Note that digital signatures do not prevent this attack because Eve can strip them
and re-sign the message under her identity as discussed in section 8.1 of this paper.

Re: What’s Up Johnny?

3

2 Background

In this section, we provide the fundamentals and the historical context of the
OpenPGP and S/MIME encryption schemes, as well as MIME and HTML email.

2.1 OpenPGP

Pretty Good Privacy (PGP) was invented in 1991 by Phil Zimmermann and
played a major political role in the ‘crypto wars’ of the mid-1990s. Until today,
it has a high reputation among activists, journalists, and privacy enthusiasts.
PGP was standardized as OpenPGP in RFC4880 which comes in two ﬂavors: For
PGP/Inline, the plaintext in the email body is simply replaced by its encrypted
counterpart. This is done separately for each body part (or attachment) in case
of multipart emails. For PGP/MIME, the whole MIME structure including all
body parts is encrypted into a single part of content type multipart/encrypted.

2.2 S/MIME

In the late 1990s, S/MIME was speciﬁed as an Internet standard for email en-
cryption and digital signatures based on X.509 public key certiﬁcates and a PKI.
Besides having a more centralized trust model than OpenPGP, both standards
have a lot in common. S/MIME and OpenPGP are both hybrid cryptosystems,
consisting of a symmetric cipher such as AES and an asymmetric cipher like
RSA. S/MIME encrypts the whole MIME structure into a single body part of
content type application/pkcs7-mime. It is supported natively by various mail
clients and used in business environments and organizations, such as universities.

2.3 MIME Email

Historically, RFC822 email was limited to ASCII messages. This did not ﬁt the
needs of users to send other ﬁle formats such as binary data. Therefore, in 1992
Multipurpose Internet Mail Extensions (MIME) were born, enabling emails that
consist of multiple parts of various content types. An example HTML email with
inline images, additional text parts, and a PDF attachment is given in Figure 2.

Fig. 2: Exemplary MIME tree of a multipart email.

multipart/mixedmultipart/relatedmultipart/alternativetext/plaintext/htmlimage/jpegimage/gifapplication/pdfdisplayedinline byclientdisplayedasattachmenttext/plain4

J. Müller et al.

In the context of end-to-end encryption, the ﬂexibility of multipart mails can
be dangerous. Neither OpenPGP nor the S/MIME standard cover the edge-case
of partially encrypted messages: e.g., ciphertexts can be wrapped as a sub-part
within the MIME tree, which is the foundation of our attacks on encryption.

2.4 HTML Email

HTML in emails was introduced by Netscape in 1995 to format messages, e.g.,
to provide bold or colored text. It competed with the text/enriched MIME type
as deﬁned in RFC1563 and Microsoft’s proprietary Rich Text Format (RTF).
HTML email was eventually adopted by the general public, despite opposition
by tech enthusiasts (as expressed, e.g., in the ASCII ribbon campaign). Today
most mail clients support HTML emails by default.5 However, until today, there
is no standard that deﬁnes which HTML elements should be enabled in email.
For example, some email clients even execute script tags within emails (see [8]).

3 Related Work

In 2000 Katz, Schneier, and Jallad [6, 7] presented chosen-ciphertext attacks
against OpenPGP and S/MIME, in which they make use of the malleability fea-
ture of CFB and CBC mode to modify encrypted messages resulting in ‘garbage’
plaintext. A victim replying to the garbled plaintext unwittingly acts as a decryp-
tion oracle, allowing the receiver to reconstruct the original plaintext. Heiderich
et al. [5] showed that this attack is possible even without ciphertext masking.
Recently, Poddebniak et al. [8] demonstrated that the malleability of CFB/CBC
can be used to modify encrypted emails such that their plaintext is automatically
exﬁltrated to the attacker when opened in a vulnerable email client, using HTML
and other backchannels. They, furthermore, showed that some email clients con-
catenate encrypted and unencrypted MIME parts, allowing an attacker to leak
the plaintext of OpenPGP and S/MIME encrypted messages by loading them as
the resource of a remote URL. Message takeover attacks for signed emails have
been discussed by Davis [3] in 2001. He showed that a signed message “Let’s
break up” from Bob to Eve can simply be re-send by Eve to scare Alice (Bob’s
new girlfriend). Furthermore, Davis demonstrated that signatures can simply be
removed in many scenarios and the message can be re-signed by the attacker.
In 2017, Ribeiro [10] showed that the displayed content of signed HTML emails
can be changed subsequently if the mail client fetches external CSS stylesheets.

4 Attacker Model

Attacks based on decryption oracles require the attacker to somehow have ob-
tained PGP or S/MIME encrypted emails. In practice, this could be achieved via
an untrustworthy or compromised SMTP or IMAP server, via a third party com-
ponent such as cloud-based antivirus solutions scanning transiting emails, or via

5 According to an email marketing statistics and metrics study conducted by Juniper

Research, 97% of all email clients used in 2007 supported HTML messages.

Re: What’s Up Johnny?

5

a compromised mailbox (e.g., based on weak passwords or XSS on the webmail
service). While this is a strong attacker model, the only reason to use end-to-end
encryption at all is that an untrusted communication channel is presumed.

After having obtained ciphertext messages, the attacker, Eve, can re-send
them in her own name to one of the original communication parties, Alice or
Bob. Note that both can act as a decryption oracle because emails are usually
encrypted with the public key of both, the sender and the receiver, as both parties
want to be able to decrypt it later. Eve can perform additional changes to the
encrypted messages such as wrapping them within a multipart mail. In addition,
Eve may apply social engineering to lure the victim – Alice or Bob – into replying
to her (benign-looking) message. Note that this is a weak requirement as it is
a basic function of email to reply to communication partners, even previously
unknown ones. It is clear that the security of a cryptographic protocol should
not be dependent on the assumption that no communication is made. Signing
oracle-based attacks only require the victim to reply to a benign-looking email.

5 Decryption Oracles

Replying to a decrypted email and quoting the original message can leak the
plaintext to a third party in case the From: or Reply-To: header had been re-
placed with the attacker’s email address. Such message takeover attacks under
a new identity are well-known (see [6, 7]). However, they can often be detected
based on the message content. It is generally assumed that trained users should
get suspicious and discover the deception instead of replying to ‘out of context’
messages. In this paper we show how to hide the original plaintext and instead
show a meaningful message, asking the user to reply and, therefore, leak the
(hidden) plaintext. We do this by abusing the MIME standard in combination
with HTML email. Encrypted messages can themselves be a sub-part within a
MIME tree which may include further non-encrypted parts. Even though there
are hardly meaningful use cases for such ‘partially encrypted’ emails, they are a
valid feature. This allows an attacker to integrate captured ciphertext messages
into a MIME tree under her control and re-send this new email to the victim (i.e.,
the original sender or receiver). A MIME tree containing an attacker-controlled
message, as well as S/MIME and OpenPGP encrypted parts, is given in Figure 3.

Fig. 3: MIME tree of a partially encrypted email.

multipart/mixedtext/htmlapplication/pkcs7-mimeencryptedcontentattacker-controlledcontentmultipart/encryptedtext/plainS/MIMEPGP/MIMEPGP/INLINE6

J. Müller et al.

Plaintext Merged with Attacker’s Text. If a client receives a multipart
email, it decrypts the ciphertext parts and afterwards merges all ASCII and
HTML parts into a single document which is quoted upon replying.6 This im-
plementation approach of the MIME standard can be considered dangerous: Eve
can prepend her own message, followed by a lot of newlines, to the captured ci-
phertext part. If Alice replies without scrolling down in her reply quoting the
text, she unintentionally acts as a decryption oracle and leaks the plaintext.
Other obfuscation techniques include hiding the ciphertext somewhere between
the attacker’s message parts: Emails, especially forwarded mails, can contain a
long conversation history and top-posting without reading the whole conversa-
tion history is common user behavior. A user replying to a ‘mixed content’ con-
versation can thereby leak the plaintext of encrypted messages wrapped within
the attacker-controlled text.

Plaintext Hidden Using HTML and CSS. In the context of HTML email,
mixed content attacks are more serious than in ASCII emails. An attacker who
can inject her own HTML/CSS code into the same document where the plaintext
is displayed can completely hide it, e.g., by wrapping it within an iframe. An
example email is given in Figure 4. The result for Apple Mail is shown in Figure 5.

8

9

10

15

16

1

2

3

4

5

6

7

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: multipart/mixed; boundary=“BOUNDARY”
4

--BOUNDARY

5
6 Content-Type: text/html
7

<b>Hello Johnny,</b>
I’m interested in your work. Could you explain to me how...
<iframe height=“1” frameborder=“0”>
--BOUNDARY

11
12 Content-Type: application/pkcs7-mime; smime-type=enveloped-data
13 Content-Transfer-Encoding: base64
14

[... ciphertext ...]
--BOUNDARY--

(a) Attacker-prepared multipart email received by victim’s mail client.

<b>Hello Johnny,</b>
I’m interested in your work. Could you...
<iframe height=“1” frameborder=“0”>
Secret message, for Johnny’s eye only...

1 Dear Eve, ...
2
3 On 01/05/19 08:27, Eve wrote :
4

> <b>Hello Johnny,</b>
> I’m interested in your work. Could you...
<iframe height=“1” frameborder=“0”>
Secret message, for Johnny’s eye only...

5

6

7

(b) HTML code after decryption.

(c) HTML code in reply message.

Fig. 4: Email structure to hide S/MIME ciphertext in an invisible iframe. After
decryption the plaintext will be included as ‘covert content’ in the quoted reply.

6 There are alternative ways to handle multipart messages. The email client “The
Bat!” shows a new tab for each body part, while Outlook only displays the very ﬁrst
part. However, a majority of the evaluated clients follows the described approach.

Re: What’s Up Johnny?

7

(a) Johnny receives a benign-looking email from Eve.

(b) Johnny replies to Eve.

(c) Eve obtains the plaintext.

Fig. 5: Covert content attack using Apple Mail as S/MIME decryption oracle.

Note that a closing </iframe> tag is not required. However, it could easily be
added by placing another attacker-controlled text/html part at the end of the
message. Iframes are just one way to hide the original plaintext. Other options
include wrapping it into HTML comments or other elements such as <audio> or
<canvas> which do not display the content between opening and closing tags –
while it is still kept when replying to the email. Other, more advanced, techniques
to hide the plaintext using CSS properties are shown for attacks on signatures
in section 6. A comprehensive list of CSS blinding options is given in Table 1.

Breaking Mixed-Content Isolation with References. In cases where mul-
tiple MIME parts are not automatically concatenated by the client, this behav-
ior can be enforced by creating a multipart/related email structure referencing
the ciphertext via cid: URI schemes (see RFC2392). Such Content-ID resource
locators are typically used to embed and display inline images within HTML
emails. They are generally seen as more compatible than referencing remote im-
ages which are blocked in most email clients for privacy reasons. In the example
email given in Figure 6, the attacker’s text/html part includes the ciphertext as
an ‘image’. Because the resulting plaintext is not a valid image ﬁle, it cannot
be displayed by the client. However, the decrypted inline ‘image’ is included
in reply emails, therefore leaking the plaintext. A resulting screenshot of the

8

J. Müller et al.

wrapped PGP/MIME message being opened in Thunderbird is given in Fig-
ure 10 in the appendix. The attacker is not limited to images; the plaintext can
also be referenced as the content of an iframe, object, embed, and other elements.

--BOUNDARY
12
13 Content-ID: <target>
14 Content-Type: multipart/encrypted; protocol=“application/pgp-encrypted”; boundary=“PGPMIME”
15

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: multipart/related; boundary=“BOUNDARY”
4

--BOUNDARY

5
6 Content-Type: text/html
7
8 What’s up Johnny?
9

10

11

<img src=“cid:target” width=“1” height=“1”>
<style >fieldset , br{display : none}</style >

--PGPMIME

16
17 Content-Type: application/pgp-encrypted
18
19 Version: 1
20
21 Content-Type: application/octet-stream; name=“encrypted.asc”
22 Content-Disposition: inline; ﬁlename=“encrypted.asc”
23

--PGPMIME

24

25

26

27

28

-----BEGIN PGP MESSAGE-----
[... ciphertext ...]
-----END PGP MESSAGE-----
--PGPMIME--
--BOUNDARY--

Fig. 6: Email structure to hide PGP/MIME ciphertext in a referenced ‘image’.

Note that the attack does not require a ‘partially encrypted’ email because
Eve can also encrypt her malicious parts with the victim’s public PGP key
or S/MIME certiﬁcate. The attack is even successful if the victim replies to
Eve with an encrypted email because Eve’s public key is used for re-encryption.
These attacks apply not only for single ciphertext messages in the middle part of
a multipart email, but hundreds of encrypted emails can be hidden as sub-parts
and their plaintext can be leaked with a single reply.7 Furthermore, the attack
does not require an active MitM, but rather, the obtained ciphertext could be
years-old. For example, a nation-state actor could have captured a target user’s
encrypted emails over years and later decides to expose them by sending a single
benign-looking email which lures the user into replying. While the attacks use
email to exﬁltrate the plaintext, their scope is not limited to exﬁltrating de-
crypted emails. The attacks also work with non-email ciphertexts such as PGP
encrypted ﬁles. Covert content attacks are independent of the applied encryption
scheme, even though email clients and crypto plugins may handle multipart mes-
sages diﬀerently, depending on whether S/MIME and OpenPGP is used. While
the attacks require user interaction, they do not require any ‘unusual’ behavior,
but instead normal usage of email as a communication medium. They also do
not require complex cryptographic attacks like the CBC gadgets discussed in [8].

7 At some point, the SMTP server may enforce a resource limit, e.g., 25 MB for Gmail.

Re: What’s Up Johnny?

9

6 Signing Oracles

Digital signatures should guarantee integrity, authenticity, and non-repudiation
of messages. To give an example, Johnny could be a commander-in-chief who
takes information security seriously. All his emails are digitally signed, making
it hard to impersonate him in order to send forged statements or instructions.
The goal of our attacker Eve is to start false-ﬂag warfare. Therefore, she needs
to obtain a digitally signed ‘declaration of war’ which she can forward to the
armed forces. Every time Johnny replies to a message he already acts – to a
certain extent – as a signing oracle when quoting the original text. For example,
consider the following message from Eve to Johnny:

1

I hereby declare war.

Johnny replies with a signed message, thereby quoting the original text:

1

Sorry Eve, You can ' t do that .

2
3 On 01/05/19 09:42, Eve wrote :
4

> I hereby declare war.

In the reply, commander Johnny unintentionally signed Eve’s quoted text. Cer-
tainly, given the message context and the quote preﬁx (>...) it is clear that
declaring war is not his intention. However, Eve can try to hide her malicious
content using CSS blinding options while a benign text message, such as “What’s
up Johnny?”, is added to be shown. Similarly, the benign text can be hidden
while showing the malicious content, based on CSS conditional rules which are
satisﬁed only for a third party. If Johnny replies to such a specially-crafted
HTML/CSS email, he signs arbitrary covert content along with visible content.
This signed message can then be forwarded by Eve to a third party (e.g., the
armed forces) where it displays the previously hidden malicious content “I hereby
declare war”, while hiding the benign content. A schematic illustration of such
covert content attacks on email signatures is given in Figure 7.

Fig. 7: Covert content attacks against email signatures.

A simple HTML email containing conditional CSS code to display diﬀerent con-
tent based on the device’s screen resolution is given in Figure 8. It can be used
to obtain a signed email from a mobile device, where a benign message is shown.
The reply message instead displays a (signed) declaration of war when shown
on a desktop mail client. A screenshot of the attack using iOS Mail as a signing
oracle and the resulting signed email shown in Thunderbird is given in Figure 9.

10

J. Müller et al.

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: text/html
4

5

6

7

8

9

10

11

12

13

14

15

<style>
/* hide malicious content on mobile devices */
@media (max-device-width: 834px) {
.covert {visibility: hidden;}
}
/* but show on desktop/large-screen devices */
@media (min-device-width: 835px) {
* {visibility: hidden;}
.covert {visibility: visible !important; position: absolute; top: 8px; left: 8px;}
}
</style>

16
17 What’s up Johnny?
18

<div class=“covert” style=“visibility: hidden”>I hereby declare war.</div>

(a) Attacker-prepared HTML/CSS email sent to Johnny.

1 What’s up Johnny?

(b) Content seen by Johnny on his mobile email client.

1

I’m ﬁne, thanks.

2
3 On 01/05/19 09:53, Eve wrote:
4

> What’s up Johnny?

(c) Content seen by Johnny when replying to the message.

1

I hereby declare war.

(d) Signed content seen by a third party on a desktop client.

Fig. 8: Malicious HTML/CSS email to obtain a signed ‘declaration of war’.

(a) Johnny replies to Eve’s email.

(b) Eve obtains a signed reply email for arbitrary text.

Fig. 9: Covert content attack abusing iOS Mail as S/MIME signing oracle.

In the given example, email clients with a screen width of less than 835px (e.g.,
a mobile phone or tablet) show a diﬀerent text than desktop mail clients based
on the @media conditional rule. If the email client includes this conditional CSS
in the reply message it can be misused as a signing oracle, therefore allowing the
attacker to obtain signed messaged for arbitrary (displayed) content.

Re: What’s Up Johnny?

11

Conditional Rules. The W3C speciﬁes CSS conditional rules [12] like @media,
which allow diﬀerent formatting based on conditions such as screen width or
orientation. For example, a diﬀerent text can be shown whether a mobile phone
is held in portrait or landscape mode, or whether the document is displayed
on a screen or printed out. Besides media queries, we can show diﬀerent text
in diﬀerent email clients using the @support conditional rule, which applies
formatting based on CSS feature support in the client. For example, an email
can be shown in red if two property-value pairs are supported:

1

@supports (property1 : value1 ) and (property2 : value2) {* {color : red}}

We assembled a list of over 1,000 CSS property-value pairs to ﬁngerprint the
features supported by clients. This allows us to selectively enable certain CSS
code for every client that interprets the @support rule. A further conditional
rule introduced by Mozilla is @document. It allows CSS code to be executed
based on the document location. In the context of email clients, this even allows
us to show diﬀerent text for each user because the location contains an imap://
URI scheme with the email address. For example, to apply a red color solely for
the emails of general@good.com the following CSS code can be used:

1 @-moz-document url - prefix ("imap://general@good .com") {* {color : red}}

In case CSS conditional rules are not supported, email clients may support their
own proprietary conditional statements. For example, Outlook interprets HTML
and CSS code within <!--[if mso]>...<![endif]-->, while other clients will ignore
it. A listing of other conditional features is given in Figure 11 in the appendix.

Blinding Options. We identiﬁed seven CSS properties which can be used for
covert content attacks, as shown in Table 1. However, this list is unlikely to be
complete because CSS is very complex and oﬀers more possibilities to hide text.

property show hide

display:
visibility:
opacity:
clip-path:
position:
color:
font-size:

none;

initial;
visible; hidden;
1;
initial;
static;
initial;
initial;

0;
polygon(0px 0px, 0px 0px, 0px 0px, 0px 0px);
absolute; top: -9999px; left: -9999px;
transparent;
0;

Table 1: CSS properties to hide text.

The proposed attacks allow an attacker to obtain valid signatures for arbitrary
content to be displayed. This can be used to trick a third party, which relies
on the authenticity and integrity of signed messages, to perform certain actions
(such as starting a war). A forensic analysis can reveal the deception, but then
it may already be too late (i.e., war is already declared). Note that the covert
content attacks to obtain signatures do not require any MIME wrapping, but
rather depend on HTML emails, and on support for (internal) CSS styles.

12

J. Müller et al.

7 Evaluation

To evaluate the proposed attacks, we selected 19 widely-used email clients with
OpenPGP support and 22 clients supporting S/MIME from a comprehensive list
of over 50 email clients assembled from public software directories for all major
platforms (Windows, Linux, macOS, Android, iOS, and Web). Email clients were
excluded if they were not updated for several years, or if the cost to obtain them
would be prohibitive (e.g., appliances). All clients were tested in the default
settings with an additional PGP or S/MIME plugin installed where required.
The results from the tested clients regarding covert content attacks, (i.e., tricking
a user into acting as an oracle for decryption or signing) are shown in Table 2.

Support

Decryption

Signatures

S/MIME PGP

S/MIME PGP S/MIME PGP

Windows Thunderbird (52.5.2)

native
native
Outlook 2016 (16.0.4266)
Win. 10 Mail (17.8730)
native
Win. Live Mail (16.4.3528) native
native
The Bat! (8.2.0)
native
Postbox (5.0.20)
native
eM Client (7.1.31849.0)

Linux

macOS

KMail (5.2.3)
Evolution (3.22.6)
Trojitá (0.7-278)
Claws (3.14.1)
Mutt (1.7.2)

Apple Mail (11.2)
MailMate (1.10)
Airmail (3.5.3)

native
native
native
plugin
native

native
native
plugin

Enigmail
GpgOL
–
–
GnuPG
Enigmail
native

GPGME
GnuPG
GPGME
GPG plugin
GPGME

GPGTools
GPGTools
GPG-PGP

iOS

Mail App (11.2.2)

native

–

Android K-9 Mail (5.403)

R2Mail2 (2.30)
MailDroid (4.81)
Nine (4.1.3a)

–
native
Flipdog
native

OpenKeychain
native
Flipdog
–

(cid:32)
–
(cid:35)
–

(cid:35)
(cid:32)
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)
–

(cid:35)
(cid:32)
–
(cid:35)

–

(cid:32)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:71)(cid:35)
(cid:32)
(cid:32)

(cid:32)
–

(cid:71)(cid:35)
(cid:32)
(cid:32)

(cid:32)
–
(cid:71)(cid:35)
–

(cid:35)
(cid:32)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:71)(cid:35)
(cid:32)
(cid:32)
–

(cid:32)
(cid:71)(cid:35)
–
(cid:32)

–

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)
–

(cid:35)
(cid:35)
(cid:35)

–
(cid:35)

Web

Exchange/OWA (15.1.1034) plugin
plugin
Roundcube (1.3.4)
native
Horde/IMP (6.2.21)
–
Mailpile (1.0.0rc2)

–
Enigma
GnuPG
GnuPG

{︁

decryption
oracles

Plaintext can be completely hidden
Plaintext merged with attacker-text

–
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
Covert rules are kept in reply message}︁signing
(cid:35)
Covert rules only for received message
oracles
No vulnerabilities found

(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:71)(cid:35)
–
(cid:71)(cid:35)

(cid:32)
(cid:71)(cid:35)
(cid:35)
Table 2: Evaluation of covert content attacks on email encryption and signatures

(cid:32)
– Cryptosystem not available
(cid:71)(cid:35)

All tested email clients quote the original message when replying, which is the
precondition for our attacks. Of the overall tested 24 clients, 20 display HTML
emails in the default settings without any additional user interaction, but only
16 clients reply with HTML formatted content. While only ﬁve clients download
external CSS style sheets by default, all HTML capable clients support internal
and/or inline CSS, and at least one blinding option to hide text. All but two
HTML capable clients support conditional rules or other features to conditionally
show or hide text. Full details on HTML and CSS support for the various tested
email clients are given in Table 3 in the appendix.

Re: What’s Up Johnny?

13

7.1 Decryption Oracles

All email clients, excluding Microsoft products and “The Bat!”, merge multiple
ASCII text or HTML parts into a single document when replying, making them
potentially vulnerable to covert content attacks. However, not all clients decrypt
ciphertext sub-parts within the MIME tree, thereby disabling the attack. From
discussions with application developers, we learned that this was initially not
meant as a security precaution. Instead, the case of partially encrypted mes-
sages was simply not considered in the implementation of S/MIME or the PGP
plugin. As a consequence, clients that are more feature complete, have higher
compatibility, and require a larger implementation eﬀort are more likely to be
misused as decryption oracles. We consider clients as vulnerable if the plaintext
of encrypted messages can either be completely hidden, or if it is concatenated
with attacker-controlled text.

For seven clients, including popular applications such as Apple Mail or Thun-
derbird, we could completely hide the ciphertext within a multipart mail us-
ing HTML/CSS and show arbitrary content instead. A user replying to such
a benign-looking email unknowingly leaks the plaintext of up to hundreds of
encrypted emails at once. For another six vulnerable clients, HTML formatted
replies are deactivated in the default settings or not supported at all. In such
cases, our attacks are limited because the decrypted message cannot be com-
pletely hidden. However, it can be appended to the attacker’s text, separated
by a lot of newlines, or wrapped somewhere within the conversation history.
All aﬀected clients, except R2Mail2, show consistent behavior, independently of
whether S/MIME or OpenPGP is used as encryption scheme.

7.2 Signing Oracles

We classify clients as vulnerable not only if they can act as a signing oracle, but
also if they show diﬀerent text for signed messages based on conditional CSS.
Both vulnerabilities are required for the attack, but they do not need to exist in
the same client. In fact, because the targeted users (e.g., Johnny and General)
in each of these cases are diﬀerent, they are likely to use diﬀerent clients.

Ten clients, including popular applications such as Thunderbird, K-9 Mail,
the iOS Mail App, and Outlook Web Application (OWA), the GUI for Microsoft
Exchange, keep the original <style> element in replies, allowing an attacker to
misuse them as signing oracles.8 Of the remaining clients, six convert internal
CSS style information into inline styles when replying and eight clients reply to
HTML emails with ASCII text in the default settings. Once a signed email with
conditional CSS has been obtained, it can be used to trick 18 of the 20 clients
displaying HTML in the default settings (all but Mailpile and “The Bat!”) as
well as the HTML-to-text converter used by Horde/IMP into selectively show-
ing/hiding certain text. We could observe the same behavior for all email clients,
independent of the applied encryption scheme.

8 It must be noted that for two clients, MailMate and Airmail, some additional eﬀort

was required to bypass ﬁlters which would otherwise strip internal CSS styles.

14

J. Müller et al.

8 Countermeasures

Building a secure encryption protocol on top of email is very challenging. There
are many pitfalls and edge-cases to be considered. In this section, we provide best
practices to counter the attacks previously described. These practices should be
of help to guide implementations of OpenPGP or S/MIME capable clients.

8.1 Decryption Oracles

All-or-Nothing Encryption. Partially encrypted messages can be considered
harmful. Therefore, email clients must not decrypt emails unless they contain a
single encrypted part (i.e., the root node in the MIME tree). This can be stan-
dardized and enforced for S/MIME and PGP/MIME. For PGP/Inline however,
the only way to send a multipart message is to separately encrypt each part. Un-
fortunately, every PGP/MIME message can be interpreted in the context of a
PGP/Inline message (i.e., a downgrade attack). Hence, email clients supporting
PGP/Inline must enforce a strict separation between multiple body parts, for
example, by opening each part in a separate window or tab. When replying to
multipart messages, only the very ﬁrst body part may be quoted and, therefore,
included in the reply to prevent unintended leakage of covert plaintext content.

Accepting ASCII Text Only. Active content such as HTML within emails
is dangerous. Disabling HTML prevents most attacks described in this work.
Unfortunately, this does not meet today’s usage of email. HTML email has be-
come the norm and in ten of the tested email clients – for example, in Apple
Mail and iOS Mail – there is not even an option to disable HTML for incom-
ing emails. It must be additionally noted that modern email clients also display
text/plain emails within an HTML widget component. One major problem is
that no deﬁnition for ‘HTML email’ exists. Developing a standard describing a
‘safe’ subset of HTML which can be used in emails to allow basic formatting,
but forbid potentially harmful features, would be a step in the right direction.

Enforcing Digital Signatures.
In theory, signed emails oﬀer protection
against covert content attacks. If Bob received an email originating from Eve,
but one message part was signed by Alice, he may get suspicious and not reply
to Eve. In practice, email clients miserably fail when it comes to verifying signa-
tures for multipart messages. Our tests show that most email clients either do
not show a signature at all for partially signed messages, or show the ﬁrst avail-
able signature in the MIME tree – which can originate from Eve because she can
simply re-sign the message. Even in cases where the client explicitly shows inline
information regarding which part is signed, we managed to hide the signature
information itself using CSS. Moreover, S/MIME signatures can be stripped by
targeted modiﬁcations of the CBC-ciphertext as shown by Strenzke [11]. Never-
theless, digital signatures – if done right – can enhance message authenticity and
integrity. For example, a company could set up a policy to discard all incoming
messages if they do not contain exactly one single sign-then-encrypt message

Re: What’s Up Johnny?

15

part, including signed email headers which can be enforced using extensions
such as Memory Hole for OpenPGP [4] or Secure Header Fields for S/MIME [1].

It is important to note that the described countermeasures must be implemented
by all involved parties. Usually, a user has no control over the security precau-
tions taken by his communication partners. In the context of email end-to-end
encryption, this is problematic because both the sender and the receiver can act
as a decryption oracle for captured ciphertext. Even if Bob discarded partially
encrypted messages and disabled HTML, Alice may still be vulnerable.

8.2 Signing Oracles

Dropping CSS Support. Conditional CSS makes it easy for an attacker to hide
certain text within a signed message while showing diﬀerent text. Ideally, clients
would ignore CSS in received emails. However, this is an unrealistic scenario
given today’s usage of email, especially in a business context, where it is expected
that emails can have any sort of formatting – technically implemented with CSS.
Sanitizing conditional CSS rules and properties which can be used to hide content
is feasible, but it may be insuﬃcient as web technologies are constantly evolving.
Nevertheless, it is important to display digitally signed content equally to all
viewers. The S/MIME and OpenPGP standards, which are from a time-period
where messages were ASCII text, fail to address this and should be extended.

Only ASCII Text in Replies. It should not harm the user experience if mail
clients converted quoted messages into ASCII text when replying to an email.
Eight of the tested clients (e.g., Roundcube) are actually doing this. Thus, we
recommend that security-focused mail clients should adopt this behavior. They
must not sign any quoted HTML/CSS input from the original message, so that
they cannot be misused as signing oracles.

9 Conclusion

Email is complex. The MIME standard and HTML, as supported by modern
email clients, provide a high level of ﬂexibility and allow arbitrary wrapping,
nesting, and hiding of encrypted or to-be-signed content. This complexity and
the conjoined attack surface are not dealt with in the security considerations of
the OpenPGP and S/MIME standards, which primarily focus on cryptographic
algorithms and their parameters such as key sizes. However, relying on the secu-
rity of cryptographic primitives, such as AES or ECDH, is not enough for secure
email end-to-end encryption and signatures. The developers of email clients have
to handle a plethora of critical edge-cases – without being able to consult any
published best practices. Our work aims to close this research gap. We reveal im-
plementation pitfalls in the “no man’s land” between cryptography and email,
as used today, and give guidance and best practices in order to improve the
security of S/MIME and OpenPGP capable email clients.

16

J. Müller et al.

Acknowledgements

The authors thank Juraj Somorovsky for his valuable feedback and insightful
discussions. Jens Müller was supported by the research training group ‘Human
Centered System Security’ sponsored by the state of North-Rhine Westfalia. In
addition, this work was supported by the German Research Foundation (DFG)
within the framework of the Excellence Strategy of the Federal Government and
the States – EXC 2092 CASA.
Note this is a draft version. The ﬁnal version of this work will be published at the
17th International Conference on Applied Cryptography and Network Security.

References

[1] Cailleux, L., Bonatti, C.: Securing Header Fields with S/MIME (April

2015), http://tools.ietf.org/rfc/rfc7508.txt, RFC7508

[2] Callas, J., Donnerhacke, L., Finney, H., Thayer, R.: OpenPGP Message
Format (November 1998), http://tools.ietf.org/rfc/rfc2440.txt, RFC2440
[3] Davis, D.: Defective Sign & Encrypt in S/MIME, PKCS#7, MOSS, PEM,
PGP, and XML. In: Proceedings of the General Track: 2001 USENIX An-
nual Technical Conference. pp. 65–78. USENIX Association, Berkeley, CA,
USA (2001), http://dl.acm.org/citation.cfm?id=647055.715781

[4] Gillmor, D.K.: Memory Hole spec and documentation. https://github.

com/autocrypt/memoryhole (2014)

[5] Heiderich, M., Krein, N., Weißer, D., Fäßler, F., Kobeissi, N., Inführ, A.,
Hong, Magazinius, J.: Pentest-Report Thunderbird & Enigmail 09.2017.
https://cure53.de/pentest-report_thunderbird-enigmail.pdf (2017)
[6] Jallad, K., Katz, J., Schneier, B.: Implementation of Chosen-Ciphertext At-
tacks against PGP and GnuPG. In: Chan, Agnes Huiand Gligor, V. (ed.)
Information Security. pp. 90–101. Springer Berlin Heidelberg, Berlin, Hei-
delberg (2002)

[7] Katz, J., Schneier, B.: A Chosen Ciphertext Attack Against Several e-Mail
Encryption Protocols. In: Proceedings of the 9th Conference on USENIX
Security Symposium - Volume 9. pp. 18–18. SSYM’00 (2000)

[8] Poddebniak, D., Dresen, C., Müller, J., Ising, F., Schinzel, S., Fried-
berger, S., Somorovsky, J., Schwenk, J.: Efail: Breaking S/MIME and
OpenPGP Email Encryption using Exﬁltration Channels. In: 27th USENIX
Security Symposium (USENIX Security 18). pp. 549–566. USENIX As-
sociation, Baltimore, MD (2018), https://www.usenix.org/conference/
usenixsecurity18/presentation/poddebniak

[9] Ramsdell, B.: S/MIME Version 3 Message Speciﬁcation (June 1999), http:

//tools.ietf.org/rfc/rfc2633.txt, RFC2633
[10] Ribeiro, F.: The Ropemaker Email Exploit (2017)
[11] Strenzke, F.: Improved Message Takeover Attacks against S/MIME (Feb

2016), https://cryptosource.de/posts/smime_mta_improved_en.html

[12] W3C: CSS Conditional Rules Module Level 3 (2013), https://www.w3.

org/TR/css3-conditional/

REFERENCES

17

A Screenshots of Decryption Oracles

A.1 Plaintext Hidden in a Referenced Inline ‘Image’.

Figure 10 depicts a covert content attack against Thunderbird/Enigmail based
on the example email given in Figure 6. The ciphertext is hidden in an embedded
‘image’ ﬁle, referenced from the attacker’s part via a cid: URI scheme. The
OpenPGP plugin – Enigmail – detects the ‘image’ as PGP/MIME content and
decrypts it. The decrypted ‘image’ is then Base64 encoded by Thunderbird and
included in the reply message, therefore leaking the plaintext.

(a) Johnny receives a benign-looking
email with an embedded invisible ‘image’
which contains PGP/MIME ciphertext.

(b) Johnny replies to Eve, thereby un-
knowingly leaking the plaintext within
the invisible inline image.

(c) Eve obtains the reply email, including
the Base64 encoded ‘image’ which con-
tains the plaintext.

(d) Eve decodes the Base64 encoded
data, resulting in the original plaintext
MIME message.

Fig. 10: Convert content attack using Thunderbird as PGP decryption oracle.

18

J. Müller et al.

B HTML/CSS Email Support

HTML CSS styles

blinding options
view reply external internal inline display visibility opacity clip-path position color font-size @media @supports @document other

conditional rules

s Thunderbird
w
Outlook 2016
o
d
Win. 10 Mail
n
W. Live Mail
i
W
The Bat!
Postbox
eM Client

x KMail
u
n
i
L

Evolution
Trojitá
Claws
Mutt

c Apple Mail
a
M

MailMate
Airmail

iOS Mail App

d K-9 Mail
i
R2Mail2
o
r
MailDroid
d
n
Nine
A

(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:71)(cid:35) (cid:32)
(cid:32) (cid:71)(cid:35)
(cid:32) (cid:35)
(cid:35) (cid:35)
(cid:35) (cid:35)

(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:32) (cid:32)

(cid:32) (cid:32)
(cid:32) (cid:35)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:32)
(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)

(cid:35)
(cid:35)
(cid:71)(cid:35)
(cid:32)

b Exchange/OWA
e
Roundcube
W
Horde/IMP
Mailpile

(cid:32) (cid:32)
(cid:32) (cid:71)(cid:35)
(cid:71)(cid:35) (cid:71)(cid:35)
(cid:32) (cid:35)
Not supported by client

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:35)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:32)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)
Supported in default settings

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)
Supported in non-default settings

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:35)

Table 3: HTML and CSS support in various email clients.

C Other Conditional Features

1

2

3

4

5

6

7

8

9

10

11

12

13

14

.owa {color : red ;}

[owa]
. tb {color : red ;}

<html><head>
<! - -[ i f IE]>< style >.wlm {color : red;}</ style > <![ endif ] - - >
<! - -[ i f mso]>< style >. ol {color : red;}</ style > <![ endif ] - - >
<style >
. ExternalClass .owa,
.moz- text -html
</style >
</head>
<body>
<div class="wlm"> RED text only in Windows Live Mail </div>
<div class="ol "> RED text only in Outlook / W10Mail </div>
</div>
<div class="owa"> RED text only in Exchange (OWA)
<div class="tb"> RED text only in Thunderbird
</div>
</body></html>

<! - - Windows Live Mail -->
<! - - Outlook / W10Mail -->

/* Exchange (OWA) */
/* Thunderbird */

Fig. 11: Proprietary features and CSS to target only certain clients.



=== Content from bugs.kde.org_31b04d6e_20250120_235947.html ===


KDE Bugtracking System – Bug 404697
CVE-2019-10734: Decryption Oracle based on replying to PGP or S/MIME encrypted emails
Last modified: 2020-06-26 17:37:47 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=404697&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=404697&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 404697**](show_bug.cgi?id=404697)
- CVE-2019-10734: Decryption Oracle based on replying to PGP or S/MIME encrypted emails

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2019-10734: Decryption Oracle based on replying to PGP or S/MIME encrypte...

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | trojita | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unmaintained | | [Component:](describecomponents.cgi?product=trojita "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Cryptography ([show other bugs](buglist.cgi?component=Cryptography&product=trojita&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 0.7 | | [Platform:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Compiled Sources Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | NOR normal | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the bug is expected to be fixed.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Trojita default assignee | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2019-02-22 12:44 UTC by Jens Mueller | | --- | --- | | Modified: | 2020-06-26 17:37 UTC ([History](show_activity.cgi?id=404697)) | | CC List: | 3 users (show)  fabian kevin.kofler projects.rg | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Latest Commit:](page.cgi?id=fields.html#cf_commitlink "A custom Free Text field in this installation of Bugzilla.") | https://invent.kde.org/pim/trojita/commit/8db7f450d52539b4c72ee968384911b6813ad1e7 | | [Version Fixed In:](page.cgi?id=fields.html#cf_versionfixedin "A custom Free Text field in this installation of Bugzilla.") |  | | [Sentry Crash Report:](page.cgi?id=fields.html#cf_sentryurl "URL to Sentry Crash Report on crash-reports.kde.org") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Proof-of-concept PGP**](attachment.cgi?id=118286 "View the content of the attachment") (1.68 KB, message/rfc822)  [2019-02-22 12:44 UTC](#attach_118286 "Go to the comment associated with the attachment"), Jens Mueller | [Details](attachment.cgi?id=118286&action=edit) | | [**Proof-of-concept S/MIME**](attachment.cgi?id=118287 "View the content of the attachment") (1.48 KB, message/rfc822)  [2019-02-22 12:45 UTC](#attach_118287 "Go to the comment associated with the attachment"), Jens Mueller | [Details](attachment.cgi?id=118287&action=edit) | | [View All](attachment.cgi?bugid=404697&action=viewall)  [Add an attachment](attachment.cgi?bugid=404697&action=enter) | |   | Note You need to [log in](show_bug.cgi?id=404697&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=404697#c0)  Jens Mueller    2019-02-22 12:44:06 UTC  ``` In the scope of academic research in cooperation with Ruhr-Uni Bochum and FH Münster, Germany we discovered a security issue in Trojitá: An attacker who is in possession of PGP or S/MIME encrypted messages can embed them into a multipart message and re-send them to the intended receiver. When the message is read and decrypted by the receiver, the attacker's content is shown. If the victim replies, the plaintext is leaked to an attacker's email address. The root cause for these vulnerabilities lies in the way Trojitá (and many other mail clients) handle partially encrypted multipart messages.  ----------------------------------------- *Leaking plaintext through reply/forward* -----------------------------------------  /Attacker model/: Attacker is in possession of PGP or S/MIME encrypted messages, which she may have obtained as passive man-in-the-middle or by actively hacking into the victim's mail server or gateway  /Attacker's goal/: Leak the plaintext by wrapping the ciphertext part within a benign-looking MIME mail sent to and decrypted+replied to by the victim  /Attack outline:/ If Trojitá receives a multipart email, as depicted below, it decrypt the ciphertext part(s), together with the attacker-controlled text (which may be prepended and/or appended).  multipart/mixed    |--- Attacker's part    |--- [encrypted part]    +--- Attacker's part  A benign-looking attacker's text may lure the victim into replying. Because the decrypted part is also quoted in the reply, the user unintentionally acts as a decryption oracle. To obfuscate the existence of the encrypted part(s), the attacker may add a lot of newlines or hide it within a long conversation history. A user replying to such a ‘mixed content’ conversation thereby leaks the plaintext of encrypted messages wrapped within attacker-controlled text.  --------------- Countermeasures ---------------  Do not decrypt emails unless the PGP or S/MIME encrypted part is the root node -- and therefore the only part -- in the MIME tree (exception: multipart/signed for encrypted-then-signed S/MIME messages). Another, potentially less secure, option would be to quote only the very first MIME part in replies. ```  [Comment 1](show_bug.cgi?id=404697#c1)  Jens Mueller    2019-02-22 12:44:43 UTC  ``` Created [attachment 118286](attachment.cgi?id=118286 "Proof-of-concept PGP") [[details]](attachment.cgi?id=118286&action=edit "Proof-of-concept PGP") Proof-of-concept PGP  Please find attached a raw .eml file which depicts the issue for PGP. ```  [Comment 2](show_bug.cgi?id=404697#c2)  Jens Mueller    2019-02-22 12:45:14 UTC  ``` Created [attachment 118287](attachment.cgi?id=118287 "Proof-of-concept S/MIME") [[details]](attachment.cgi?id=118287&action=edit "Proof-of-concept S/MIME") Proof-of-concept S/MIME  Please find attached a raw .eml file which depicts the issue for S/MIME. ```  [Comment 3](show_bug.cgi?id=404697#c3)  Jan Kundrát    2019-02-24 15:46:25 UTC  ``` Hi Jens, thanks for sharing results of your research. This is a nice attack indeed. ```  [Comment 4](show_bug.cgi?id=404697#c4)  Raphael Groner    2019-04-16 17:50:47 UTC  ``` Is this reprocible with a snapshot taken from git sources? ```  [Comment 5](show_bug.cgi?id=404697#c5)  Raphael Groner    2019-04-16 17:51:19 UTC  ``` Is this reproducible with a snapshot taken from git sources? ```  [Comment 6](show_bug.cgi?id=404697#c6)  Jan Kundrát    2019-04-17 07:27:41 UTC  ``` (In reply to Raphael Groner from [comment #5](show_bug.cgi?id=404697#c5)) > Is this reproducible with a snapshot taken from git sources?  Yes, it is still valid. We do not have any countermeasure for this at this time. Patches welcome. ```  [Comment 7](show_bug.cgi?id=404697#c7)  Jens Mueller    2019-04-18 13:37:37 UTC  ``` Update: Here's a full (public) report on the issue: <https://arxiv.org/ftp/arxiv/papers/1904/1904.07550.pdf>  For Trojitá, CVE-2019-10734 was assigned for reply-based `decryption oracles`. ```  [Comment 8](show_bug.cgi?id=404697#c8)  Fabian Vogt    2019-07-12 07:19:27 UTC  ``` Is this being actively worked on?  > Countermeasures > --------------- > Do not decrypt emails unless the PGP or S/MIME encrypted part is the root node > -- and therefore the only part -- in the MIME tree (exception: multipart/signed > for encrypted-then-signed S/MIME messages). Another, potentially less secure, > option would be to quote only the very first MIME part in replies. ```  [Comment 9](show_bug.cgi?id=404697#c9)  Kevin Kofler    2019-10-31 22:38:31 UTC  ``` Ping? I just got reminded of this CVE by the Fedora EOL bot (due to the impending Fedora 29 end of life). ```  [Comment 10](show_bug.cgi?id=404697#c10)  Jan Kundrát    2020-06-26 10:30:40 UTC  ``` Patch for review is available at <https://gerrit.vesnicky.cesnet.cz/r/1038> ```  [Comment 11](show_bug.cgi?id=404697#c11)  Jan Kundrát    2020-06-26 17:37:47 UTC  ``` Git commit 8db7f450d52539b4c72ee968384911b6813ad1e7 by Jan Kundrát. Committed on 26/06/2020 at 10:29. Pushed by jkt into branch 'master'.  Prevent a possible decryption oracle attack  Thanks to Jens Mueller (Ruhr-Uni Bochum and FH Münster) for reporting this. The gist is that an attacker can embed arbitrary ciphertext into their messages. Trojita decrypts that, and when we hit reply, the original *cleartext* gets quoted and put into a reply for the attacker to see.  Fix this by not quoting any plaintext which originated in an encrypted message. That's pretty draconian, but hey, it works and we never came up with any better patch. Also, given that Trojita does not encrypt outgoing messages yet, this is probably also a conservative thing to do.  Change-Id: I84c45b9e707eb7c99eb7183c6ef59ef41cd62c43 CVE: CVE-2019-10734  M  +2    -0    src/Cryptography/GpgMe++.cpp M  +8    -1    src/Gui/MessageView.cpp M  +8    -0    src/Gui/PartWidget.cpp M  +1    -1    src/Imap/Model/ItemRoles.h  <https://invent.kde.org/pim/trojita/commit/8db7f450d52539b4c72ee968384911b6813ad1e7> ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=404697)
* - [XML](show_bug.cgi?ctype=xml&id=404697)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=404697)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=404697&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=404697&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


