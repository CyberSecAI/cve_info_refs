=== Content from commits.kde.org_b9b68380_20250121_021955.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

**Commit
a58286ae**

authored
May 12, 2019
by
**[![Sandro Knau√ü's avatar](/uploads/-/system/user/avatar/229/avatar.png?width=48 "Sandro Knau√ü")](/knauss)
[Sandro Knau√ü](/knauss)**
üêù

[Browse files](/pim/messagelib/-/tree/a58286aec8f300d78c570726924baa91d9a22771)

### Merge branch 'CVE-2019-10732' into Applications/19.04

```

Fixes the CVE-2019-10732, with additional tests, to make sure, we fixed
the CVE completely.

FIXED-IN: 5.11.2
[BUG: 404698](https://bugs.kde.org/404698 "Issue in Bugzilla")
CCMAIL: security@kde.org
```

parents
[a4918242](/pim/messagelib/-/commit/a49182427bbf28142a8b2c9df73a905950b011d6)
[a5d0ad10](/pim/messagelib/-/commit/a5d0ad10ced249d74819209ae22052fde481e426)

Loading

Loading

Loading

* [Changes
  34](/pim/messagelib/-/commit/a58286aec8f300d78c570726924baa91d9a22771)

[Hide whitespace changes](/pim/messagelib/-/commit/a58286aec8f300d78c570726924baa91d9a22771?action=show&controller=projects%2Fcommit&id=a58286aec8f300d78c570726924baa91d9a22771&namespace_id=pim&project_id=messagelib&w=1)
[Inline](/pim/messagelib/-/commit/a58286aec8f300d78c570726924baa91d9a22771?view=inline)
[Side-by-side](/pim/messagelib/-/commit/a58286aec8f300d78c570726924baa91d9a22771?view=parallel)

Loading

Preview

0%
Loading

Try again

or
attach a new file

.

Cancel

You are about to add
**0
people**
to the discussion. Proceed with caution.

Finish editing this message first!

Save comment

Cancel

Please [register](/users/sign_up?redirect_to_referer=yes) or [sign in](/users/sign_in?redirect_to_referer=yes) to comment



=== Content from lists.debian.org_94fdf369_20250121_001246.html ===


---

[[Date Prev](msg00011.html)][[Date Next](msg00013.html)]
[[Thread Prev](msg00011.html)][[Thread Next](msg00013.html)]
[[Date Index](maillist.html#00012)]
[[Thread Index](threads.html#00012)]

# [SECURITY] [DLA 1825-1] kdepim security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 1825-1] kdepim security update
* *From*: Sylvain Beucler <beuc@beuc.net>
* *Date*: Tue, 18 Jun 2019 13:51:10 +0200
* *Message-id*: <[[üîé]](/msgid-search/20190618115110.l5jvbaejeaqgebak%40mail.beuc.net)¬†[20190618115110.l5jvbaejeaqgebak@mail.beuc.net](msg00012.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Package        : kdepim
Version        : 4:4.14.1-1+deb8u2
CVE ID         : CVE-2019-10732
Debian Bug     : 926996

A reply-based decryption oracle was found in kdepim, which provides
the KMail e-mail client.

An attacker in possession of S/MIME or PGP encrypted emails can wrap
them as sub-parts within a crafted multipart email. The encrypted
part(s) can further be hidden using HTML/CSS or ASCII newline
characters. This modified multipart email can be re-sent by the
attacker to the intended receiver. If the receiver replies to this
(benign looking) email, they unknowingly leak the plaintext of the
encrypted message part(s) back to the attacker.

For Debian 8 "Jessie", this problem has been fixed in version
4:4.14.1-1+deb8u2.

We recommend that you upgrade your kdepim packages.

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQEzBAEBCgAdFiEEQic8GuN/xDR88HkSj/HLbo2JBZ8FAl0ItNgACgkQj/HLbo2J
BZ/+yAgAmLvf2+02Tpnn/RD0xCAePqvhZ0S6dAmpKOs0RD1VJH/3iOT+rCOBKxYl
bMFbP6pjaPg4/fQI7OgwJqCGXBWr9HdyJWHD7VGJEPYavWGFF+pJccwY3wSD4qS9
SBzcy/uSbx/2yf7xfuY4kbJ9bIVnnQVyHvEg46w5YGeoLYScZyvqcY7l1bV1Z/dY
SqTA03rLclweIIvbTcyeNA3N5LIi2Gp7yNA5nEzuhNs848IrrBkpzLFDtBhGR21o
Vj0cLCxyFlMCZE+r6papacHqega4vRFfzkJkE1wcH7ccuWcXC6kvpUsL0BWNr7Do
+0IzO3+4SurRmfM13Y76Y55KVXkPvw==
=yraI
-----END PGP SIGNATURE-----

```

---



=== Content from commits.kde.org_5c5b1ad8_20250121_021955.html ===


[Skip to content](#content-body)
GitLab
[![](data:image/gif;base64...)](/ "Homepage")

* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)

P
# PIM Messagelib

## Project information

Library components for messages (e.g. displaying Akonadi collections)

Read more

* [**8,521** Commits](/pim/messagelib/-/commits/master)
* [**67** Branches](/pim/messagelib/-/branches)
* [**162** Tags](/pim/messagelib/-/tags)

Created on

May 16, 2020

Find file

Copy HTTPS clone URL

* [**Copy SSH clone URL**git@invent.kde.org:pim/messagelib.git](git%40invent.kde.org%3Apim/messagelib.git)
* [**Copy HTTPS clone URL**https://invent.kde.org/pim/messagelib.git](https://invent.kde.org/pim/messagelib.git)

Loading



=== Content from bugs.kde.org_fec7ead3_20250121_001246.html ===


KDE Bugtracking System ‚Äì Bug¬†404698
Decryption Oracle based on replying to PGP or S/MIME encrypted emails
Last modified: 2019-07-31 02:15:35 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New¬†Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=404698&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=404698&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug¬†404698**](show_bug.cgi?id=404698)
- Decryption Oracle based on replying to PGP or S/MIME encrypted emails

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
Decryption Oracle based on replying to PGP or S/MIME encrypted emails

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | kmail2 | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Applications | | [Component:](describecomponents.cgi?product=kmail2 "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | crypto ([show other bugs](buglist.cgi?component=crypto&product=kmail2&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Platform:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Debian stable Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | NOR normal | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the bug is expected to be fixed.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | kdepim bugs | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2019-02-22 12:52 UTC by Jens Mueller | | --- | --- | | Modified: | 2019-07-31 02:15 UTC ([History](show_activity.cgi?id=404698)) | | CC List: | 11 users (show)  aacid asturm beuc dvratil faure montel nate null+samzain rdieter sknauss stupor\_scurvy343 | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Latest Commit:](page.cgi?id=fields.html#cf_commitlink "A custom Free Text field in this installation of Bugzilla.") | https://commits.kde.org/messagelib/ac360b3a57eacbf0542ed0800e6054db76f01398 | | [Version Fixed In:](page.cgi?id=fields.html#cf_versionfixedin "A custom Free Text field in this installation of Bugzilla.") | 5.11.2 | | [Sentry Crash Report:](page.cgi?id=fields.html#cf_sentryurl "URL to Sentry Crash Report on crash-reports.kde.org") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Proof-of-concept PGP**](attachment.cgi?id=118288 "View the content of the attachment") (1.95 KB, message/rfc822)  [2019-02-22 12:52 UTC](#attach_118288 "Go to the comment associated with the attachment"), Jens Mueller | [Details](attachment.cgi?id=118288&action=edit) | | [**Proof-of-concept S/MIME**](attachment.cgi?id=118289 "View the content of the attachment") (1.56 KB, message/rfc822)  [2019-02-22 12:52 UTC](#attach_118289 "Go to the comment associated with the attachment"), Jens Mueller | [Details](attachment.cgi?id=118289&action=edit) | | [**html mail with two images embeded.**](attachment.cgi?id=120026 "View the content of the attachment") (859 bytes, application/mbox)  [2019-05-12 22:10 UTC](#attach_120026 "Go to the comment associated with the attachment"), Sandro Knau√ü | [Details](attachment.cgi?id=120026&action=edit) | | [View All](attachment.cgi?bugid=404698&action=viewall)  [Add an attachment](attachment.cgi?bugid=404698&action=enter) | |   | Note You need to [log in](show_bug.cgi?id=404698&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=404698#c0)  Jens Mueller    2019-02-22 12:52:18 UTC  ``` In the scope of academic research in cooperation with Ruhr-Uni Bochum and FH M√ºnster, Germany we discovered a security issue in KMail: An attacker who is in possession of PGP or S/MIME encrypted messages can embed them into a multipart message and re-send them to the intended receiver. When the message is read and decrypted by the receiver, the attacker's content is shown. If the victim replies, the plaintext is leaked to an attacker's email address. The root cause for these vulnerabilities lies in the way KMail (and many other mail clients) handle partially encrypted multipart messages.  ----------------------------------------- *Leaking plaintext through reply/forward* -----------------------------------------  /Attacker model/: Attacker is in possession of PGP or S/MIME encrypted messages, which she may have obtained as passive man-in-the-middle or by actively hacking into the victim's mail server or gateway  /Attacker's goal/: Leak the plaintext by wrapping the ciphertext part within a benign-looking MIME mail sent to and decrypted+replied to by the victim  /Attack outline:/ If KMail receives a multipart email, as depicted below, it decrypt the ciphertext part(s), together with the attacker-controlled text (which may be prepended and/or appended).  multipart/mixed    |--- Attacker's part    |--- [encrypted part to leak]    +--- [Attacker's encrypted part]  A benign-looking attacker's text may lure the victim into replying. Because the decrypted part is also quoted in the reply, the user unintentionally acts as a decryption oracle. To obfuscate the existence of the encrypted part(s), the attacker may add a lot of newlines or hide it within a long conversation history. A user replying to such a ‚Äòmixed content‚Äô conversation thereby leaks the plaintext of encrypted messages wrapped within attacker-controlled text.  Please find attached a raw .eml file which depicts the issue.  --------------- Countermeasures ---------------  Do not decrypt emails unless the PGP or S/MIME encrypted part is the root node -- and therefore the only part -- in the MIME tree (exception: multipart/signed for encrypted-then-signed S/MIME messages). Another, potentially less secure, option would be to quote only the very first MIME part in replies. ```  [Comment 1](show_bug.cgi?id=404698#c1)  Jens Mueller    2019-02-22 12:52:40 UTC  ``` Created [attachment 118288](attachment.cgi?id=118288 "Proof-of-concept PGP") [[details]](attachment.cgi?id=118288&action=edit "Proof-of-concept PGP") Proof-of-concept PGP ```  [Comment 2](show_bug.cgi?id=404698#c2)  Jens Mueller    2019-02-22 12:52:53 UTC  ``` Created [attachment 118289](attachment.cgi?id=118289 "Proof-of-concept S/MIME") [[details]](attachment.cgi?id=118289&action=edit "Proof-of-concept S/MIME") Proof-of-concept S/MIME ```  [Comment 3](show_bug.cgi?id=404698#c3)  Daniel Vr√°til    2019-04-08 16:55:35 UTC  ``` In KMail this attack requires that user would enable "Automatic decryption of encrypted messages when viewing" option in KMail settings, which is disabled by default.  Without this option enabled the user has to click on "Decrypt" on the part that the attacker wants to leak. At this point, the user will still clearly see which part of the content was encrypted and which part was not. When the user wants to reply to this decrypted message, the content would indeed get leaked to the attacker. However, I believe that at this point KMail has done enough to prevent (by not enabling auto-decryption by default) and warn (by clearly showing which part is encrypted and which not) the user so he or she could judge for themselves the potential risks when replying to the message. ```  [Comment 4](show_bug.cgi?id=404698#c4)  Jens Mueller    2019-04-09 15:41:27 UTC  ``` Things may have changed in the meantime, but for the version we tested (v5.2.3), there is no need to click on "Decrypt Message". While the plaintext is not shown to the user, if he does not explicitly click "Decrypt Message", the plaintext is still included in replies -- just re-tested for S/MIME and PGP/MIME. Note that KMail was tested in the default settings (the option "Attempt decryption of encrypted messages when viewing" was *not* set). ```  [Comment 5](show_bug.cgi?id=404698#c5)  Sandro Knau√ü    2019-04-09 20:54:50 UTC  ``` (In reply to Daniel Vr√°til from [comment #3](show_bug.cgi?id=404698#c3)) > In KMail this attack requires that user would enable "Automatic decryption > of encrypted messages when viewing" option in KMail settings, which is > disabled by default.  As Jens already explained, this setting does not help here. This Setting only do not trigger decryption directly when you view the mail. But if you reply the mail is decrypted in anycase. And we use the same code paths for rendering the view and prepare the reply/forward. ```  [Comment 6](show_bug.cgi?id=404698#c6)  Albert Astals Cid    2019-04-13 10:39:21 UTC  ``` I am not sure I understand where the problem is, potentially means you need to explain it in simpler words (or that i need to learn how to read long sentences :D)  Is this problem?  * A sends encrypted email to B  * C intercepts that email  * C resends the email modified to B (adding his own reply address and some plain text)  * B answers to C  * C can see the original email ```  [Comment 7](show_bug.cgi?id=404698#c7)  Jens Mueller    2019-04-13 12:29:02 UTC  ``` Exactly that's the problem. Note that not only one message, but hundreds of captured messages can be wrapped and leaked with one single reply.  Traditional message takeover attacks under a new identity (C) are considered as an acceptable risk in email e2e encryption because it is assumed that given the context of the message (e.g.,‚ÄúHi A, [...] Yours, B‚Äù) B can tell that this message is not originally from C and could easily discover the deception. However, using MIME wrapping, C can make a different content being displayed to B (if B does not carefully scroll down the whole message conversation) and therefore potentially trick B into replying to C. ```  [Comment 8](show_bug.cgi?id=404698#c8)  Albert Astals Cid    2019-04-15 21:36:49 UTC  ``` Right i can see the problem.  Question is, are those kind of messages that you are suggesting to stop supporting "common" or even is there a reason for someone to be sending messages like that?  Or if you get a message like this it's most probably someone trying to trick you?  Because if those messages are common, stopping to work on them is going to be a pain for the people that have a valid usecase. ```  [Comment 9](show_bug.cgi?id=404698#c9)  Jens Mueller    2019-04-16 09:06:50 UTC  ``` Imho, there are no legitimate use cases for `partial encryption` in S/MIME and PGP/MIME, but it's hard to measure if such emails do exist in the wild. In case of PGP/Inline, unfortunately, every part is encrypted separately. Note that a captured PGP/MIME message can be `downgraded` to be interpreted in the context of PGP/INLINE. ```  [Comment 10](show_bug.cgi?id=404698#c10)  Jens Mueller    2019-04-18 13:30:36 UTC  ``` Update: Here's a full (public) report on the issue: <https://arxiv.org/ftp/arxiv/papers/1904/1904.07550.pdf>  For KMail, CVE-2019-10732 was assigned for reply-based `decryption oracles`. ```  [Comment 11](show_bug.cgi?id=404698#c11)  David Faure    2019-04-21 17:14:23 UTC  ``` Interesting problem. Here's my feedback.  - Preventing KMail from *sending* such messages would obviously be no help (one could just craft that message by hand or using another email client).   - Preventing the user from replying to such a message would be very weird user experience (sorry, you are not allowed to reply to this message!)  - So I guess the best solution is that when replying, we don't decrypt parts that were encrypted in the original message. I.e. if we are replying with a copy of those parts, and they were encrypted, they should be copied "as is". This would prevent any newly-added recipient from reading those, but that's fair enough I would say. I wouldn't really know how to implement this though. Might be tricky if the tree in memory only has the decrypted version.  - Alternatively, KMail could say "for security reasons, these parts are going to be removed from your reply". But this also requires that we somehow know that these parts used to be encrypted in the original email. ```  [Comment 12](show_bug.cgi?id=404698#c12)  David Faure    2019-04-22 09:31:07 UTC  ``` About the original suggestion: "Do not decrypt emails unless the PGP or S/MIME encrypted part is the root node -- and therefore the only part -- in the MIME tree (exception: multipart/signed for encrypted-then-signed S/MIME messages)."  This would mean if you attach a non-encrypted image (say, company logo) to an encrypted email, the recipient can't reply to the email anymore? I think we always want to decrypt the main text part? (fuzzy term, I don't know what the actual logic is in kmail, but I mean the text that gets quoted). ```  [Comment 13](show_bug.cgi?id=404698#c13)  Sandro Knau√ü    2019-04-22 21:21:16 UTC  ``` @Jens: what version did you test? You set "Debian Stable" and "5.10.3" this does not match. Debian stable has 16.04.3 aka 5.2.3.   I now started to look into the issue, but I can't reproduce it with the attached messages for 18.08.3 nor for master. At least for the encrypted content to be simple text. Do I need to construct a mimetree inside the encrypted message parts? And this make totally sense, as we have already have the concept of firstTextNode inside ObjectTreeParser, that takes effect here.  I added the proof-of-concept mails to our autotests:    <https://phabricator.kde.org/D20757> the plain.reply files are the output of the reply window.  For those you have a test environment for messagelib, those can view such mails and reply/forward:  GNUPGHOME=<buildpath of messagelib>/messagecore/autotests/gnupg_home/ kmail --view 404698-gpg.mbox  A short explanation, how a reply/forward is created (everything in messagelib): * templateparser/src/templateparserjob constructs a new KMime::Message mMsg from a given mOrigMsg. * TemplateParserJob uses MimeTreeParser::ObjectTreeParser to get htmlContent/plainTextContent. At least for plainTextContent it is easy to follow, that only the content from first text node is used. For htmlContent it looks, like we merge different htmlNodes via messagepart.cpp:HtmlMessagePart::fix() ```  [Comment 14](show_bug.cgi?id=404698#c14)  Sandro Knau√ü    2019-04-22 21:44:01 UTC  ``` (In reply to David Faure from [comment #11](show_bug.cgi?id=404698#c11)) > - Preventing KMail from *sending* such messages would obviously be no help > (one could just craft that message by hand or using another email client).   ACK.  > - Preventing the user from replying to such a message would be very weird > user experience (sorry, you are not allowed to reply to this message!)  jepp bad UX.  > - So I guess the best solution is that when replying, we don't decrypt parts > that were encrypted in the original message. I.e. if we are replying with a > copy of those parts, and they were encrypted, they should be copied "as is". > This would prevent any newly-added recipient from reading those, but that's > fair enough I would say. > I wouldn't really know how to implement this though. > Might be tricky if the tree in memory only has the decrypted version. > > - Alternatively, KMail could say "for security reasons, these parts are > going to be removed from your reply". But this also requires that we somehow > know that these parts used to be encrypted in the original email.  Both things are not that hard to solve. We have MimeTreeParser::ObjecttreeParser that returns a MessagePart tree. This is a tree, where only visual interesting nodes of the Mime messages with the additional information of each node, about their encrypted status, used keys etc... To get an idea about those trees look at mimetreeparser/autotests/data/*tree files, these are the MessagePart tree for the corresponding mbox. Also TemplateParser, that is responsible for creating a reply/template, uses MimeTreeParser::ObjecttreeParser, so we are able to filter out bad nodes. ```  [Comment 15](show_bug.cgi?id=404698#c15)  Jens Mueller    2019-04-26 10:09:00 UTC  ``` @David: This would mean if you attach a non-encrypted image to an encrypted...  Absolutely, such an email could not be decrypted anymore if you follow our suggestions (or had to be manually decrypted on the command line). While this may seem a bit harsh, we have not seen any mail client that allows to send such "partially encrypted" emails (e.g., with unencrypted attachments), and I think handling such edge cases can become a security nightmare. Either the whole mail is encrypted or it's not, everything else gives a false sense of security, imho.  However, I see the developer's perspective and the and the fear of potentially breaking things, too. I guess a rule like "in case of an encrypted, multipart email, reply only with the first part" *should* be fine too.  @Sandro: We originally tested in version 5.2.3 on Debian 9.8 (stretch). This version is probably outdated by now. ```  [Comment 16](show_bug.cgi?id=404698#c16)  Sandro Knau√ü    2019-04-26 11:00:21 UTC  ``` (In reply to Jens Mueller from [comment #15](show_bug.cgi?id=404698#c15)) > @David: This would mean if you attach a non-encrypted image to an > encrypted... >  > Absolutely, such an email could not be decrypted anymore if you follow our > suggestions (or had to be manually decrypted on the command line). While > this may seem a bit harsh, we have not seen any mail client that allows to > send such "partially encrypted" emails (e.g., with unencrypted attachments), > and I think handling such edge cases can become a security nightmare. Either > the whole mail is encrypted or it's not, everything else gives a false sense > of security, imho.  One client that supports sending encrypted mails with unencrypted attachment is kmail (but you need to do it explicitly).  One common use case, of such partial encrypted mails are mails forwarded via Mailman. Mailman adds a non encrypted footer to each email. So not supporting these mails make would break my workflow. This was the reason, why I fixed a several things, because I didn't wanted to see this footer in the reply ;D And I see a big difference between displaying such broken mails and replying.   > However, I see the developer's perspective and the and the fear of > potentially breaking things, too. I guess a rule like "in case of an > encrypted, multipart email, reply only with the first part" *should* be fine > too.  I think so, too, that reply to only one part you be fine.  > @Sandro: We originally tested in version 5.2.3 on Debian 9.8 (stretch). This > version is probably outdated by now.  yes! Did you tested any other version? ```  [Comment 17](show_bug.cgi?id=404698#c17)  Sandro Knau√ü    2019-05-12 21:59:21 UTC  ``` Git commit d397aa46e809203c94e31891caac57affac746d9 by Sandro Knau√ü. Committed on 12/05/2019 at 20:34. Pushed by knauss into branch 'Applications/19.04'.  Test mails for Decryption Oracle based on replying to PGP or S/MIME.  Summary: In order to make sure we never add a Decryption Oracle add test mails to TemplateParser.  Reviewers: #kde_pim, aacid, dfaure  Subscribers: kde-pim  Tags: #kde_pim  Differential Revision: <https://phabricator.kde.org/D20757>  A  +120  -0    templateparser/autotests/data/404698-gpg.mbox A  +51   -0    templateparser/autotests/data/404698-gpg.mbox.plain.reply A  +88   -0    templateparser/autotests/data/404698-smime.mbox A  +51   -0    templateparser/autotests/data/404698-smime.mbox.plain.reply  <https://commits.kde.org/messagelib/d397aa46e809203c94e31891caac57affac746d9> ```  [Comment 18](show_bug.cgi?id=404698#c18)  Sandro Knau√ü    2019-05-12 22:10:25 UTC  ``` Created [attachment 120026](attachment.cgi?id=120026 "html mail with two images embeded.") [[details]](attachment.cgi?id=120026&action=edit "html mail with two images embeded.") html mail with two images embeded.  There is one question, how we should handle forwards with embedded images. We have a testcase with two images embedded (see attachment), that are added to the forwarded message. IMO this is not a security issue, as we do not parse those two images (aka do not encrypt them) and just copy them like they were sent over the wire. So we can't leak private information. ```  [Comment 19](show_bug.cgi?id=404698#c19)  Sandro Knau√ü    2019-05-12 22:14:40 UTC  ``` Git commit a58286aec8f300d78c570726924baa91d9a22771 by Sandro Knau√ü. Committed on 12/05/2019 at 21:48. Pushed by knauss into branch 'Applications/19.04'.  Merge branch 'CVE-2019-10732' into Applications/19.04  Fixes the CVE-2019-10732, with additional tests, to make sure, we fixed the CVE completely.  FIXED-IN: 5.11.2 CCMAIL: security@kde.org   <https://commits.kde.org/messagelib/a58286aec8f300d78c570726924baa91d9a22771> ```  [Comment 20](show_bug.cgi?id=404698#c20)  Sandro Knau√ü    2019-05-12 22:14:40 UTC  ``` Git commit 8f9b85b664be0987014c5d2485e706ab5a198e1b by Sandro Knau√ü. Committed on 12/05/2019 at 20:37. Pushed by knauss into branch 'Applications/19.04'.  Make unexpected data leak harder via reply.  ObjectTreeParser.htmlContent/plainTextContent may concats different encrypted parts without the user noticing it. That would lead to a Decryption oracle. We have already a logic to find the topleveltextNode in MimeTreeParser, this does not take HTML nodes into account nor that TEXT nodes may have several PGP Inline blocks.  That plaintextContent for HtmlMessagePart is not return QString(), that bubbled up by testing the stuff.  M  +5    -0    mimetreeparser/src/messagepart.cpp M  +1    -0    mimetreeparser/src/messagepart.h A  +31   -0    templateparser/autotests/data/openpgp-inline-space.mbox A  +1    -0    templateparser/autotests/data/openpgp-inline-space.mbox.html.reply A  +1    -0    templateparser/autotests/data/openpgp-inline-space.mbox.plain.reply M  +46   -14   templateparser/src/templateparserjob.cpp  <https://commits.kde.org/messagelib/8f9b85b664be0987014c5d2485e706ab5a198e1b> ```  [Comment 21](show_bug.cgi?id=404698#c21)  Sandro Knau√ü    2019-05-12 22:14:43 UTC  ``` Git commit ac360b3a57eacbf0542ed0800e6054db76f01398 by Sandro Knau√ü. Committed on 12/05/2019 at 20:37. Pushed by knauss into branch 'Applications/19.04'.  Decryption Oracle based on forwarding PGP or S/MIME mails (CVE-2019-10732)  Summary: Add test coverage for mail forwarding.  Test Plan: all tests passes forward (text/html): [x] PGP Mime text [x] PGP Mime html [x] S/MIME [x] PGP inline  Reviewers: #kde_pim, vkrause, aacid, dfaure  Subscribers: kde-pim, security-team  Tags: #kde_pim  Differential Revision: <https://phabricator.kde.org/D20847>  A  +72   -0    templateparser/autotests/data/404698-gpg-attachments.mbox A  +66   -0    templateparser/autotests/data/404698-gpg-attachments.mbox.forwarded.mbox A  +1    -0    templateparser/autotests/data/404698-gpg-attachments.mbox.html.reply A  +5    -0    templateparser/autotests/data/404698-gpg-attachments.mbox.plain.reply A  +83   -0    templateparser/autotests/data/html-[attachment1](attachment.cgi?id=1 "Decoded attachment") [[details]](attachment.cgi?id=1&action=edit "Decoded attachment").mbox.forwarded.mbox A  +28   -0    templateparser/autotests/data/html-[attachment2](attachment.cgi?id=2 "Decoded attachment") [[details]](attachment.cgi?id=2&action=edit "Decoded attachment").mbox.forwarded.mbox M  +162  -0    templateparser/autotests/templateparserjobtest.cpp M  +9    -0    templateparser/autotests/templateparserjobtest.h  <https://commits.kde.org/messagelib/ac360b3a57eacbf0542ed0800e6054db76f01398> ```  [Comment 22](show_bug.cgi?id=404698#c22)  beuc    2019-06-12 14:59:32 UTC  ``` Hi,  As part of the Debian LTS project, I'm trying to fix this vulnerability in Debian Jessie, which ships kdepim 4.14.1.  I'm attempting to backport <https://commits.kde.org/messagelib/8f9b85b664be0987014c5d2485e706ab5a198e1b> but the API is very different, I'm not even sure there are available functions to expose the MIME parts and extract their quotable content independently.  Do you think this is doable? ```  [Comment 23](show_bug.cgi?id=404698#c23)  beuc    2019-06-12 18:57:26 UTC  ``` I wrote something cruder but that works with the 404698-* messagelib test cases: <https://www.beuc.net/tmp/kdepim-CVE-2019-10732.patch> This should be a good compromise, let me know if I missed something. I plan to upload an update shortly, probably next week :) ```  [Comment 24](show_bug.cgi?id=404698#c24)  Sandro Knau√ü    2019-06-28 15:38:27 UTC  ``` (In reply to beuc from [comment #23](show_bug.cgi?id=404698#c23)) > I wrote something cruder but that works with the 404698-* messagelib test > cases: > <https://www.beuc.net/tmp/kdepim-CVE-2019-10732.patch> > This should be a good compromise, let me know if I missed something. > I plan to upload an update shortly, probably next week :)  The code looks like it should be enough. But the surrounding code has changed a lot between 4.14.1 and had less tests etc. It may be that there are other things to fix. ```  [Comment 25](show_bug.cgi?id=404698#c25)  removed by sysadmin    2019-07-31 02:15:35 UTC |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=404698)
* -¬†[XML](show_bug.cgi?ctype=xml&id=404698)
* -¬†[Clone This Bug](enter_bug.cgi?cloned_bug_id=404698)
* -¬†Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New¬†Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=404698&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=404698&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from arxiv.org_96427d7e_20250121_022000.html ===
Re: What‚Äôs Up Johnny?
Covert Content Attacks on Email End-to-End Encryption

Jens M√ºller1, Marcus Brinkmann1, Damian Poddebniak2, Sebastian Schinzel2,
and J√∂rg Schwenk1

1 Ruhr University Bochum, Germany
{jens.a.mueller,marcus.brinkmann,joerg.schwenk}@rub.de
2 M√ºnster University of Applied Sciences, Germany
{damian.poddebniak,schinzel}@fh-muenster.de

Abstract. We show practical attacks against OpenPGP and S/MIME
encryption and digital signatures in the context of email. Instead of tar-
geting the underlying cryptographic primitives, our attacks abuse legiti-
mate features of the MIME standard and HTML, as supported by email
clients, to deceive the user regarding the actual message content. We
demonstrate how the attacker can unknowingly abuse the user as a de-
cryption oracle by replying to an unsuspicious looking email. Using this
technique, the plaintext of hundreds of encrypted emails can be leaked
at once. Furthermore, we show how users could be tricked into signing
arbitrary text by replying to emails containing CSS conditional rules.
An evaluation shows that 17 out of 19 OpenPGP-capable email clients,
as well as 21 out of 22 clients supporting S/MIME, are vulnerable to at
least one attack. We provide diÔ¨Äerent countermeasures and discuss their
advantages and disadvantages.

Keywords: PGP ¬∑ S/MIME ¬∑ Decryption Oracles ¬∑ Signing Oracles.

1

Introduction

Email was designed as a plaintext protocol, which allows eavesdroppers to read or
modify the communication on the channel. While it is common today that traÔ¨Éc
between mailservers is TLS encrypted,3 transport encryption is not suÔ¨Écient to
protect against strong attackers, such as a man-in-the-middle (MitM) within the
infrastructure (e.g., a dishonest mail server operator), or an attacker who gains
access to leaked user emails. OpenPGP [2] and S/MIME [9] are the two major
standards used in such scenarios and provide end-to-end cryptographic protec-
tion. Both standards are designed to guarantee conÔ¨Ådentiality, integrity, and
authenticity of messages, even in hostile environments such as a compromised
or untrustworthy mail server by encrypting and digitally signing emails.

3 According to Google‚Äôs transparency report, 88% of the email traÔ¨Éc was TLS encrypted
in the fourth quarter of 2018: https://transparencyreport.google.com/safer-email/

2

J. M√ºller et al.

Research Question. Both standards are based on asymmetric encryption; only
the user has access to the private key and, therefore, can decrypt messages en-
crypted with the public key or sign messages. However, email usage involves
interaction with multiple communication partners, including potentially dishon-
est parties. Example: a mail server operator, Eve, who is in possession of the
ciphertext messages sent from Alice to Bob can simply re-send the encrypted
message from her address and have Bob decrypt it.4 If Bob simply replied to
Eve while quoting the original message, he would leak the plaintext of his com-
munication with Alice. Such message takeover attacks under a new identity are
well-known issues in email end-to-end encryption (see [6, 7]). However, they are
generally considered an acceptable risk because it is assumed that given the
context of the message (e.g., ‚ÄúHi Bob, [...] Yours, Alice‚Äù) Bob can tell that this
message is not originally from Eve and could easily discover the deception.

Therefore, the research question arises: Is it possible to hide the original text
to trick a user into unintentionally acting as a decryption oracle? A schematic
illustration of such an attack is given in Figure 1.

Fig. 1: Covert content attacks against email encryption.

Contributions. In this work, we show simple, yet practical, attacks against
email encryption and digital signatures, and discuss the countermeasures. We
demonstrate how an attacker can wrap ciphertext into a specially crafted email
which looks benign but leaks the plaintext of hundreds of encrypted emails at
once if replied to. Furthermore, we show how to turn the victim into a signing
oracle by having him sign quoted covert content. The attacker can put this
content into a diÔ¨Äerent context based on CSS conditional rules, resulting in
arbitrary text to be displayed as correctly signed by the victim. Our evaluation
shows that 17 out of 19 OpenPGP capable email clients, as well as 21 out of 22
clients supporting S/MIME are vulnerable to at least one attack. Our attacks
raise concerns about the overall security of encryption and digital signatures in
the context of email, even though the security guarantees of the cryptography
behind them remains untouched.

Responsible Disclosure. We reported our attacks to the aÔ¨Äected vendors
and proposed appropriate countermeasures. Our Ô¨Åndings regarding email end-
to-end encryption resulted in CVE-2019-10731 to CVE-2019-10741. Our attacks
on digital signatures are documented as CVE-2019-10726 to CVE-2019-10730.

4 Note that digital signatures do not prevent this attack because Eve can strip them
and re-sign the message under her identity as discussed in section 8.1 of this paper.

Re: What‚Äôs Up Johnny?

3

2 Background

In this section, we provide the fundamentals and the historical context of the
OpenPGP and S/MIME encryption schemes, as well as MIME and HTML email.

2.1 OpenPGP

Pretty Good Privacy (PGP) was invented in 1991 by Phil Zimmermann and
played a major political role in the ‚Äòcrypto wars‚Äô of the mid-1990s. Until today,
it has a high reputation among activists, journalists, and privacy enthusiasts.
PGP was standardized as OpenPGP in RFC4880 which comes in two Ô¨Çavors: For
PGP/Inline, the plaintext in the email body is simply replaced by its encrypted
counterpart. This is done separately for each body part (or attachment) in case
of multipart emails. For PGP/MIME, the whole MIME structure including all
body parts is encrypted into a single part of content type multipart/encrypted.

2.2 S/MIME

In the late 1990s, S/MIME was speciÔ¨Åed as an Internet standard for email en-
cryption and digital signatures based on X.509 public key certiÔ¨Åcates and a PKI.
Besides having a more centralized trust model than OpenPGP, both standards
have a lot in common. S/MIME and OpenPGP are both hybrid cryptosystems,
consisting of a symmetric cipher such as AES and an asymmetric cipher like
RSA. S/MIME encrypts the whole MIME structure into a single body part of
content type application/pkcs7-mime. It is supported natively by various mail
clients and used in business environments and organizations, such as universities.

2.3 MIME Email

Historically, RFC822 email was limited to ASCII messages. This did not Ô¨Åt the
needs of users to send other Ô¨Åle formats such as binary data. Therefore, in 1992
Multipurpose Internet Mail Extensions (MIME) were born, enabling emails that
consist of multiple parts of various content types. An example HTML email with
inline images, additional text parts, and a PDF attachment is given in Figure 2.

Fig. 2: Exemplary MIME tree of a multipart email.

multipart/mixedmultipart/relatedmultipart/alternativetext/plaintext/htmlimage/jpegimage/gifapplication/pdfdisplayedinline byclientdisplayedasattachmenttext/plain4

J. M√ºller et al.

In the context of end-to-end encryption, the Ô¨Çexibility of multipart mails can
be dangerous. Neither OpenPGP nor the S/MIME standard cover the edge-case
of partially encrypted messages: e.g., ciphertexts can be wrapped as a sub-part
within the MIME tree, which is the foundation of our attacks on encryption.

2.4 HTML Email

HTML in emails was introduced by Netscape in 1995 to format messages, e.g.,
to provide bold or colored text. It competed with the text/enriched MIME type
as deÔ¨Åned in RFC1563 and Microsoft‚Äôs proprietary Rich Text Format (RTF).
HTML email was eventually adopted by the general public, despite opposition
by tech enthusiasts (as expressed, e.g., in the ASCII ribbon campaign). Today
most mail clients support HTML emails by default.5 However, until today, there
is no standard that deÔ¨Ånes which HTML elements should be enabled in email.
For example, some email clients even execute script tags within emails (see [8]).

3 Related Work

In 2000 Katz, Schneier, and Jallad [6, 7] presented chosen-ciphertext attacks
against OpenPGP and S/MIME, in which they make use of the malleability fea-
ture of CFB and CBC mode to modify encrypted messages resulting in ‚Äògarbage‚Äô
plaintext. A victim replying to the garbled plaintext unwittingly acts as a decryp-
tion oracle, allowing the receiver to reconstruct the original plaintext. Heiderich
et al. [5] showed that this attack is possible even without ciphertext masking.
Recently, Poddebniak et al. [8] demonstrated that the malleability of CFB/CBC
can be used to modify encrypted emails such that their plaintext is automatically
exÔ¨Åltrated to the attacker when opened in a vulnerable email client, using HTML
and other backchannels. They, furthermore, showed that some email clients con-
catenate encrypted and unencrypted MIME parts, allowing an attacker to leak
the plaintext of OpenPGP and S/MIME encrypted messages by loading them as
the resource of a remote URL. Message takeover attacks for signed emails have
been discussed by Davis [3] in 2001. He showed that a signed message ‚ÄúLet‚Äôs
break up‚Äù from Bob to Eve can simply be re-send by Eve to scare Alice (Bob‚Äôs
new girlfriend). Furthermore, Davis demonstrated that signatures can simply be
removed in many scenarios and the message can be re-signed by the attacker.
In 2017, Ribeiro [10] showed that the displayed content of signed HTML emails
can be changed subsequently if the mail client fetches external CSS stylesheets.

4 Attacker Model

Attacks based on decryption oracles require the attacker to somehow have ob-
tained PGP or S/MIME encrypted emails. In practice, this could be achieved via
an untrustworthy or compromised SMTP or IMAP server, via a third party com-
ponent such as cloud-based antivirus solutions scanning transiting emails, or via

5 According to an email marketing statistics and metrics study conducted by Juniper

Research, 97% of all email clients used in 2007 supported HTML messages.

Re: What‚Äôs Up Johnny?

5

a compromised mailbox (e.g., based on weak passwords or XSS on the webmail
service). While this is a strong attacker model, the only reason to use end-to-end
encryption at all is that an untrusted communication channel is presumed.

After having obtained ciphertext messages, the attacker, Eve, can re-send
them in her own name to one of the original communication parties, Alice or
Bob. Note that both can act as a decryption oracle because emails are usually
encrypted with the public key of both, the sender and the receiver, as both parties
want to be able to decrypt it later. Eve can perform additional changes to the
encrypted messages such as wrapping them within a multipart mail. In addition,
Eve may apply social engineering to lure the victim ‚Äì Alice or Bob ‚Äì into replying
to her (benign-looking) message. Note that this is a weak requirement as it is
a basic function of email to reply to communication partners, even previously
unknown ones. It is clear that the security of a cryptographic protocol should
not be dependent on the assumption that no communication is made. Signing
oracle-based attacks only require the victim to reply to a benign-looking email.

5 Decryption Oracles

Replying to a decrypted email and quoting the original message can leak the
plaintext to a third party in case the From: or Reply-To: header had been re-
placed with the attacker‚Äôs email address. Such message takeover attacks under
a new identity are well-known (see [6, 7]). However, they can often be detected
based on the message content. It is generally assumed that trained users should
get suspicious and discover the deception instead of replying to ‚Äòout of context‚Äô
messages. In this paper we show how to hide the original plaintext and instead
show a meaningful message, asking the user to reply and, therefore, leak the
(hidden) plaintext. We do this by abusing the MIME standard in combination
with HTML email. Encrypted messages can themselves be a sub-part within a
MIME tree which may include further non-encrypted parts. Even though there
are hardly meaningful use cases for such ‚Äòpartially encrypted‚Äô emails, they are a
valid feature. This allows an attacker to integrate captured ciphertext messages
into a MIME tree under her control and re-send this new email to the victim (i.e.,
the original sender or receiver). A MIME tree containing an attacker-controlled
message, as well as S/MIME and OpenPGP encrypted parts, is given in Figure 3.

Fig. 3: MIME tree of a partially encrypted email.

multipart/mixedtext/htmlapplication/pkcs7-mimeencryptedcontentattacker-controlledcontentmultipart/encryptedtext/plainS/MIMEPGP/MIMEPGP/INLINE6

J. M√ºller et al.

Plaintext Merged with Attacker‚Äôs Text. If a client receives a multipart
email, it decrypts the ciphertext parts and afterwards merges all ASCII and
HTML parts into a single document which is quoted upon replying.6 This im-
plementation approach of the MIME standard can be considered dangerous: Eve
can prepend her own message, followed by a lot of newlines, to the captured ci-
phertext part. If Alice replies without scrolling down in her reply quoting the
text, she unintentionally acts as a decryption oracle and leaks the plaintext.
Other obfuscation techniques include hiding the ciphertext somewhere between
the attacker‚Äôs message parts: Emails, especially forwarded mails, can contain a
long conversation history and top-posting without reading the whole conversa-
tion history is common user behavior. A user replying to a ‚Äòmixed content‚Äô con-
versation can thereby leak the plaintext of encrypted messages wrapped within
the attacker-controlled text.

Plaintext Hidden Using HTML and CSS. In the context of HTML email,
mixed content attacks are more serious than in ASCII emails. An attacker who
can inject her own HTML/CSS code into the same document where the plaintext
is displayed can completely hide it, e.g., by wrapping it within an iframe. An
example email is given in Figure 4. The result for Apple Mail is shown in Figure 5.

8

9

10

15

16

1

2

3

4

5

6

7

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: multipart/mixed; boundary=‚ÄúBOUNDARY‚Äù
4

--BOUNDARY

5
6 Content-Type: text/html
7

<b>Hello Johnny,</b>
I‚Äôm interested in your work. Could you explain to me how...
<iframe height=‚Äú1‚Äù frameborder=‚Äú0‚Äù>
--BOUNDARY

11
12 Content-Type: application/pkcs7-mime; smime-type=enveloped-data
13 Content-Transfer-Encoding: base64
14

[... ciphertext ...]
--BOUNDARY--

(a) Attacker-prepared multipart email received by victim‚Äôs mail client.

<b>Hello Johnny,</b>
I‚Äôm interested in your work. Could you...
<iframe height=‚Äú1‚Äù frameborder=‚Äú0‚Äù>
Secret message, for Johnny‚Äôs eye only...

1 Dear Eve, ...
2
3 On 01/05/19 08:27, Eve wrote :
4

> <b>Hello Johnny,</b>
> I‚Äôm interested in your work. Could you...
<iframe height=‚Äú1‚Äù frameborder=‚Äú0‚Äù>
Secret message, for Johnny‚Äôs eye only...

5

6

7

(b) HTML code after decryption.

(c) HTML code in reply message.

Fig. 4: Email structure to hide S/MIME ciphertext in an invisible iframe. After
decryption the plaintext will be included as ‚Äòcovert content‚Äô in the quoted reply.

6 There are alternative ways to handle multipart messages. The email client ‚ÄúThe
Bat!‚Äù shows a new tab for each body part, while Outlook only displays the very Ô¨Årst
part. However, a majority of the evaluated clients follows the described approach.

Re: What‚Äôs Up Johnny?

7

(a) Johnny receives a benign-looking email from Eve.

(b) Johnny replies to Eve.

(c) Eve obtains the plaintext.

Fig. 5: Covert content attack using Apple Mail as S/MIME decryption oracle.

Note that a closing </iframe> tag is not required. However, it could easily be
added by placing another attacker-controlled text/html part at the end of the
message. Iframes are just one way to hide the original plaintext. Other options
include wrapping it into HTML comments or other elements such as <audio> or
<canvas> which do not display the content between opening and closing tags ‚Äì
while it is still kept when replying to the email. Other, more advanced, techniques
to hide the plaintext using CSS properties are shown for attacks on signatures
in section 6. A comprehensive list of CSS blinding options is given in Table 1.

Breaking Mixed-Content Isolation with References. In cases where mul-
tiple MIME parts are not automatically concatenated by the client, this behav-
ior can be enforced by creating a multipart/related email structure referencing
the ciphertext via cid: URI schemes (see RFC2392). Such Content-ID resource
locators are typically used to embed and display inline images within HTML
emails. They are generally seen as more compatible than referencing remote im-
ages which are blocked in most email clients for privacy reasons. In the example
email given in Figure 6, the attacker‚Äôs text/html part includes the ciphertext as
an ‚Äòimage‚Äô. Because the resulting plaintext is not a valid image Ô¨Åle, it cannot
be displayed by the client. However, the decrypted inline ‚Äòimage‚Äô is included
in reply emails, therefore leaking the plaintext. A resulting screenshot of the

8

J. M√ºller et al.

wrapped PGP/MIME message being opened in Thunderbird is given in Fig-
ure 10 in the appendix. The attacker is not limited to images; the plaintext can
also be referenced as the content of an iframe, object, embed, and other elements.

--BOUNDARY
12
13 Content-ID: <target>
14 Content-Type: multipart/encrypted; protocol=‚Äúapplication/pgp-encrypted‚Äù; boundary=‚ÄúPGPMIME‚Äù
15

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: multipart/related; boundary=‚ÄúBOUNDARY‚Äù
4

--BOUNDARY

5
6 Content-Type: text/html
7
8 What‚Äôs up Johnny?
9

10

11

<img src=‚Äúcid:target‚Äù width=‚Äú1‚Äù height=‚Äú1‚Äù>
<style >fieldset , br{display : none}</style >

--PGPMIME

16
17 Content-Type: application/pgp-encrypted
18
19 Version: 1
20
21 Content-Type: application/octet-stream; name=‚Äúencrypted.asc‚Äù
22 Content-Disposition: inline; Ô¨Ålename=‚Äúencrypted.asc‚Äù
23

--PGPMIME

24

25

26

27

28

-----BEGIN PGP MESSAGE-----
[... ciphertext ...]
-----END PGP MESSAGE-----
--PGPMIME--
--BOUNDARY--

Fig. 6: Email structure to hide PGP/MIME ciphertext in a referenced ‚Äòimage‚Äô.

Note that the attack does not require a ‚Äòpartially encrypted‚Äô email because
Eve can also encrypt her malicious parts with the victim‚Äôs public PGP key
or S/MIME certiÔ¨Åcate. The attack is even successful if the victim replies to
Eve with an encrypted email because Eve‚Äôs public key is used for re-encryption.
These attacks apply not only for single ciphertext messages in the middle part of
a multipart email, but hundreds of encrypted emails can be hidden as sub-parts
and their plaintext can be leaked with a single reply.7 Furthermore, the attack
does not require an active MitM, but rather, the obtained ciphertext could be
years-old. For example, a nation-state actor could have captured a target user‚Äôs
encrypted emails over years and later decides to expose them by sending a single
benign-looking email which lures the user into replying. While the attacks use
email to exÔ¨Åltrate the plaintext, their scope is not limited to exÔ¨Åltrating de-
crypted emails. The attacks also work with non-email ciphertexts such as PGP
encrypted Ô¨Åles. Covert content attacks are independent of the applied encryption
scheme, even though email clients and crypto plugins may handle multipart mes-
sages diÔ¨Äerently, depending on whether S/MIME and OpenPGP is used. While
the attacks require user interaction, they do not require any ‚Äòunusual‚Äô behavior,
but instead normal usage of email as a communication medium. They also do
not require complex cryptographic attacks like the CBC gadgets discussed in [8].

7 At some point, the SMTP server may enforce a resource limit, e.g., 25 MB for Gmail.

Re: What‚Äôs Up Johnny?

9

6 Signing Oracles

Digital signatures should guarantee integrity, authenticity, and non-repudiation
of messages. To give an example, Johnny could be a commander-in-chief who
takes information security seriously. All his emails are digitally signed, making
it hard to impersonate him in order to send forged statements or instructions.
The goal of our attacker Eve is to start false-Ô¨Çag warfare. Therefore, she needs
to obtain a digitally signed ‚Äòdeclaration of war‚Äô which she can forward to the
armed forces. Every time Johnny replies to a message he already acts ‚Äì to a
certain extent ‚Äì as a signing oracle when quoting the original text. For example,
consider the following message from Eve to Johnny:

1

I hereby declare war.

Johnny replies with a signed message, thereby quoting the original text:

1

Sorry Eve, You can ' t do that .

2
3 On 01/05/19 09:42, Eve wrote :
4

> I hereby declare war.

In the reply, commander Johnny unintentionally signed Eve‚Äôs quoted text. Cer-
tainly, given the message context and the quote preÔ¨Åx (>...) it is clear that
declaring war is not his intention. However, Eve can try to hide her malicious
content using CSS blinding options while a benign text message, such as ‚ÄúWhat‚Äôs
up Johnny?‚Äù, is added to be shown. Similarly, the benign text can be hidden
while showing the malicious content, based on CSS conditional rules which are
satisÔ¨Åed only for a third party. If Johnny replies to such a specially-crafted
HTML/CSS email, he signs arbitrary covert content along with visible content.
This signed message can then be forwarded by Eve to a third party (e.g., the
armed forces) where it displays the previously hidden malicious content ‚ÄúI hereby
declare war‚Äù, while hiding the benign content. A schematic illustration of such
covert content attacks on email signatures is given in Figure 7.

Fig. 7: Covert content attacks against email signatures.

A simple HTML email containing conditional CSS code to display diÔ¨Äerent con-
tent based on the device‚Äôs screen resolution is given in Figure 8. It can be used
to obtain a signed email from a mobile device, where a benign message is shown.
The reply message instead displays a (signed) declaration of war when shown
on a desktop mail client. A screenshot of the attack using iOS Mail as a signing
oracle and the resulting signed email shown in Thunderbird is given in Figure 9.

10

J. M√ºller et al.

From: eve@evil.com
1
2 To: johnny@good.com
3 Content-Type: text/html
4

5

6

7

8

9

10

11

12

13

14

15

<style>
/* hide malicious content on mobile devices */
@media (max-device-width: 834px) {
.covert {visibility: hidden;}
}
/* but show on desktop/large-screen devices */
@media (min-device-width: 835px) {
* {visibility: hidden;}
.covert {visibility: visible !important; position: absolute; top: 8px; left: 8px;}
}
</style>

16
17 What‚Äôs up Johnny?
18

<div class=‚Äúcovert‚Äù style=‚Äúvisibility: hidden‚Äù>I hereby declare war.</div>

(a) Attacker-prepared HTML/CSS email sent to Johnny.

1 What‚Äôs up Johnny?

(b) Content seen by Johnny on his mobile email client.

1

I‚Äôm Ô¨Åne, thanks.

2
3 On 01/05/19 09:53, Eve wrote:
4

> What‚Äôs up Johnny?

(c) Content seen by Johnny when replying to the message.

1

I hereby declare war.

(d) Signed content seen by a third party on a desktop client.

Fig. 8: Malicious HTML/CSS email to obtain a signed ‚Äòdeclaration of war‚Äô.

(a) Johnny replies to Eve‚Äôs email.

(b) Eve obtains a signed reply email for arbitrary text.

Fig. 9: Covert content attack abusing iOS Mail as S/MIME signing oracle.

In the given example, email clients with a screen width of less than 835px (e.g.,
a mobile phone or tablet) show a diÔ¨Äerent text than desktop mail clients based
on the @media conditional rule. If the email client includes this conditional CSS
in the reply message it can be misused as a signing oracle, therefore allowing the
attacker to obtain signed messaged for arbitrary (displayed) content.

Re: What‚Äôs Up Johnny?

11

Conditional Rules. The W3C speciÔ¨Åes CSS conditional rules [12] like @media,
which allow diÔ¨Äerent formatting based on conditions such as screen width or
orientation. For example, a diÔ¨Äerent text can be shown whether a mobile phone
is held in portrait or landscape mode, or whether the document is displayed
on a screen or printed out. Besides media queries, we can show diÔ¨Äerent text
in diÔ¨Äerent email clients using the @support conditional rule, which applies
formatting based on CSS feature support in the client. For example, an email
can be shown in red if two property-value pairs are supported:

1

@supports (property1 : value1 ) and (property2 : value2) {* {color : red}}

We assembled a list of over 1,000 CSS property-value pairs to Ô¨Ångerprint the
features supported by clients. This allows us to selectively enable certain CSS
code for every client that interprets the @support rule. A further conditional
rule introduced by Mozilla is @document. It allows CSS code to be executed
based on the document location. In the context of email clients, this even allows
us to show diÔ¨Äerent text for each user because the location contains an imap://
URI scheme with the email address. For example, to apply a red color solely for
the emails of general@good.com the following CSS code can be used:

1 @-moz-document url - prefix ("imap://general@good .com") {* {color : red}}

In case CSS conditional rules are not supported, email clients may support their
own proprietary conditional statements. For example, Outlook interprets HTML
and CSS code within <!--[if mso]>...<![endif]-->, while other clients will ignore
it. A listing of other conditional features is given in Figure 11 in the appendix.

Blinding Options. We identiÔ¨Åed seven CSS properties which can be used for
covert content attacks, as shown in Table 1. However, this list is unlikely to be
complete because CSS is very complex and oÔ¨Äers more possibilities to hide text.

property show hide

display:
visibility:
opacity:
clip-path:
position:
color:
font-size:

none;

initial;
visible; hidden;
1;
initial;
static;
initial;
initial;

0;
polygon(0px 0px, 0px 0px, 0px 0px, 0px 0px);
absolute; top: -9999px; left: -9999px;
transparent;
0;

Table 1: CSS properties to hide text.

The proposed attacks allow an attacker to obtain valid signatures for arbitrary
content to be displayed. This can be used to trick a third party, which relies
on the authenticity and integrity of signed messages, to perform certain actions
(such as starting a war). A forensic analysis can reveal the deception, but then
it may already be too late (i.e., war is already declared). Note that the covert
content attacks to obtain signatures do not require any MIME wrapping, but
rather depend on HTML emails, and on support for (internal) CSS styles.

12

J. M√ºller et al.

7 Evaluation

To evaluate the proposed attacks, we selected 19 widely-used email clients with
OpenPGP support and 22 clients supporting S/MIME from a comprehensive list
of over 50 email clients assembled from public software directories for all major
platforms (Windows, Linux, macOS, Android, iOS, and Web). Email clients were
excluded if they were not updated for several years, or if the cost to obtain them
would be prohibitive (e.g., appliances). All clients were tested in the default
settings with an additional PGP or S/MIME plugin installed where required.
The results from the tested clients regarding covert content attacks, (i.e., tricking
a user into acting as an oracle for decryption or signing) are shown in Table 2.

Support

Decryption

Signatures

S/MIME PGP

S/MIME PGP S/MIME PGP

Windows Thunderbird (52.5.2)

native
native
Outlook 2016 (16.0.4266)
Win. 10 Mail (17.8730)
native
Win. Live Mail (16.4.3528) native
native
The Bat! (8.2.0)
native
Postbox (5.0.20)
native
eM Client (7.1.31849.0)

Linux

macOS

KMail (5.2.3)
Evolution (3.22.6)
Trojit√° (0.7-278)
Claws (3.14.1)
Mutt (1.7.2)

Apple Mail (11.2)
MailMate (1.10)
Airmail (3.5.3)

native
native
native
plugin
native

native
native
plugin

Enigmail
GpgOL
‚Äì
‚Äì
GnuPG
Enigmail
native

GPGME
GnuPG
GPGME
GPG plugin
GPGME

GPGTools
GPGTools
GPG-PGP

iOS

Mail App (11.2.2)

native

‚Äì

Android K-9 Mail (5.403)

R2Mail2 (2.30)
MailDroid (4.81)
Nine (4.1.3a)

‚Äì
native
Flipdog
native

OpenKeychain
native
Flipdog
‚Äì

(cid:32)
‚Äì
(cid:35)
‚Äì

(cid:35)
(cid:32)
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)
‚Äì

(cid:35)
(cid:32)
‚Äì
(cid:35)

‚Äì

(cid:32)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:71)(cid:35)
(cid:32)
(cid:32)

(cid:32)
‚Äì

(cid:71)(cid:35)
(cid:32)
(cid:32)

(cid:32)
‚Äì
(cid:71)(cid:35)
‚Äì

(cid:35)
(cid:32)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:71)(cid:35)
(cid:32)
(cid:32)
‚Äì

(cid:32)
(cid:71)(cid:35)
‚Äì
(cid:32)

‚Äì

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)
‚Äì

(cid:35)
(cid:35)
(cid:35)

‚Äì
(cid:35)

Web

Exchange/OWA (15.1.1034) plugin
plugin
Roundcube (1.3.4)
native
Horde/IMP (6.2.21)
‚Äì
Mailpile (1.0.0rc2)

‚Äì
Enigma
GnuPG
GnuPG

{Ô∏Å

decryption
oracles

Plaintext can be completely hidden
Plaintext merged with attacker-text

‚Äì
(cid:35)

(cid:71)(cid:35)
(cid:71)(cid:35)
Covert rules are kept in reply message}Ô∏Åsigning
(cid:35)
Covert rules only for received message
oracles
No vulnerabilities found

(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:71)(cid:35)
‚Äì
(cid:71)(cid:35)

(cid:32)
(cid:71)(cid:35)
(cid:35)
Table 2: Evaluation of covert content attacks on email encryption and signatures

(cid:32)
‚Äì Cryptosystem not available
(cid:71)(cid:35)

All tested email clients quote the original message when replying, which is the
precondition for our attacks. Of the overall tested 24 clients, 20 display HTML
emails in the default settings without any additional user interaction, but only
16 clients reply with HTML formatted content. While only Ô¨Åve clients download
external CSS style sheets by default, all HTML capable clients support internal
and/or inline CSS, and at least one blinding option to hide text. All but two
HTML capable clients support conditional rules or other features to conditionally
show or hide text. Full details on HTML and CSS support for the various tested
email clients are given in Table 3 in the appendix.

Re: What‚Äôs Up Johnny?

13

7.1 Decryption Oracles

All email clients, excluding Microsoft products and ‚ÄúThe Bat!‚Äù, merge multiple
ASCII text or HTML parts into a single document when replying, making them
potentially vulnerable to covert content attacks. However, not all clients decrypt
ciphertext sub-parts within the MIME tree, thereby disabling the attack. From
discussions with application developers, we learned that this was initially not
meant as a security precaution. Instead, the case of partially encrypted mes-
sages was simply not considered in the implementation of S/MIME or the PGP
plugin. As a consequence, clients that are more feature complete, have higher
compatibility, and require a larger implementation eÔ¨Äort are more likely to be
misused as decryption oracles. We consider clients as vulnerable if the plaintext
of encrypted messages can either be completely hidden, or if it is concatenated
with attacker-controlled text.

For seven clients, including popular applications such as Apple Mail or Thun-
derbird, we could completely hide the ciphertext within a multipart mail us-
ing HTML/CSS and show arbitrary content instead. A user replying to such
a benign-looking email unknowingly leaks the plaintext of up to hundreds of
encrypted emails at once. For another six vulnerable clients, HTML formatted
replies are deactivated in the default settings or not supported at all. In such
cases, our attacks are limited because the decrypted message cannot be com-
pletely hidden. However, it can be appended to the attacker‚Äôs text, separated
by a lot of newlines, or wrapped somewhere within the conversation history.
All aÔ¨Äected clients, except R2Mail2, show consistent behavior, independently of
whether S/MIME or OpenPGP is used as encryption scheme.

7.2 Signing Oracles

We classify clients as vulnerable not only if they can act as a signing oracle, but
also if they show diÔ¨Äerent text for signed messages based on conditional CSS.
Both vulnerabilities are required for the attack, but they do not need to exist in
the same client. In fact, because the targeted users (e.g., Johnny and General)
in each of these cases are diÔ¨Äerent, they are likely to use diÔ¨Äerent clients.

Ten clients, including popular applications such as Thunderbird, K-9 Mail,
the iOS Mail App, and Outlook Web Application (OWA), the GUI for Microsoft
Exchange, keep the original <style> element in replies, allowing an attacker to
misuse them as signing oracles.8 Of the remaining clients, six convert internal
CSS style information into inline styles when replying and eight clients reply to
HTML emails with ASCII text in the default settings. Once a signed email with
conditional CSS has been obtained, it can be used to trick 18 of the 20 clients
displaying HTML in the default settings (all but Mailpile and ‚ÄúThe Bat!‚Äù) as
well as the HTML-to-text converter used by Horde/IMP into selectively show-
ing/hiding certain text. We could observe the same behavior for all email clients,
independent of the applied encryption scheme.

8 It must be noted that for two clients, MailMate and Airmail, some additional eÔ¨Äort

was required to bypass Ô¨Ålters which would otherwise strip internal CSS styles.

14

J. M√ºller et al.

8 Countermeasures

Building a secure encryption protocol on top of email is very challenging. There
are many pitfalls and edge-cases to be considered. In this section, we provide best
practices to counter the attacks previously described. These practices should be
of help to guide implementations of OpenPGP or S/MIME capable clients.

8.1 Decryption Oracles

All-or-Nothing Encryption. Partially encrypted messages can be considered
harmful. Therefore, email clients must not decrypt emails unless they contain a
single encrypted part (i.e., the root node in the MIME tree). This can be stan-
dardized and enforced for S/MIME and PGP/MIME. For PGP/Inline however,
the only way to send a multipart message is to separately encrypt each part. Un-
fortunately, every PGP/MIME message can be interpreted in the context of a
PGP/Inline message (i.e., a downgrade attack). Hence, email clients supporting
PGP/Inline must enforce a strict separation between multiple body parts, for
example, by opening each part in a separate window or tab. When replying to
multipart messages, only the very Ô¨Årst body part may be quoted and, therefore,
included in the reply to prevent unintended leakage of covert plaintext content.

Accepting ASCII Text Only. Active content such as HTML within emails
is dangerous. Disabling HTML prevents most attacks described in this work.
Unfortunately, this does not meet today‚Äôs usage of email. HTML email has be-
come the norm and in ten of the tested email clients ‚Äì for example, in Apple
Mail and iOS Mail ‚Äì there is not even an option to disable HTML for incom-
ing emails. It must be additionally noted that modern email clients also display
text/plain emails within an HTML widget component. One major problem is
that no deÔ¨Ånition for ‚ÄòHTML email‚Äô exists. Developing a standard describing a
‚Äòsafe‚Äô subset of HTML which can be used in emails to allow basic formatting,
but forbid potentially harmful features, would be a step in the right direction.

Enforcing Digital Signatures.
In theory, signed emails oÔ¨Äer protection
against covert content attacks. If Bob received an email originating from Eve,
but one message part was signed by Alice, he may get suspicious and not reply
to Eve. In practice, email clients miserably fail when it comes to verifying signa-
tures for multipart messages. Our tests show that most email clients either do
not show a signature at all for partially signed messages, or show the Ô¨Årst avail-
able signature in the MIME tree ‚Äì which can originate from Eve because she can
simply re-sign the message. Even in cases where the client explicitly shows inline
information regarding which part is signed, we managed to hide the signature
information itself using CSS. Moreover, S/MIME signatures can be stripped by
targeted modiÔ¨Åcations of the CBC-ciphertext as shown by Strenzke [11]. Never-
theless, digital signatures ‚Äì if done right ‚Äì can enhance message authenticity and
integrity. For example, a company could set up a policy to discard all incoming
messages if they do not contain exactly one single sign-then-encrypt message

Re: What‚Äôs Up Johnny?

15

part, including signed email headers which can be enforced using extensions
such as Memory Hole for OpenPGP [4] or Secure Header Fields for S/MIME [1].

It is important to note that the described countermeasures must be implemented
by all involved parties. Usually, a user has no control over the security precau-
tions taken by his communication partners. In the context of email end-to-end
encryption, this is problematic because both the sender and the receiver can act
as a decryption oracle for captured ciphertext. Even if Bob discarded partially
encrypted messages and disabled HTML, Alice may still be vulnerable.

8.2 Signing Oracles

Dropping CSS Support. Conditional CSS makes it easy for an attacker to hide
certain text within a signed message while showing diÔ¨Äerent text. Ideally, clients
would ignore CSS in received emails. However, this is an unrealistic scenario
given today‚Äôs usage of email, especially in a business context, where it is expected
that emails can have any sort of formatting ‚Äì technically implemented with CSS.
Sanitizing conditional CSS rules and properties which can be used to hide content
is feasible, but it may be insuÔ¨Écient as web technologies are constantly evolving.
Nevertheless, it is important to display digitally signed content equally to all
viewers. The S/MIME and OpenPGP standards, which are from a time-period
where messages were ASCII text, fail to address this and should be extended.

Only ASCII Text in Replies. It should not harm the user experience if mail
clients converted quoted messages into ASCII text when replying to an email.
Eight of the tested clients (e.g., Roundcube) are actually doing this. Thus, we
recommend that security-focused mail clients should adopt this behavior. They
must not sign any quoted HTML/CSS input from the original message, so that
they cannot be misused as signing oracles.

9 Conclusion

Email is complex. The MIME standard and HTML, as supported by modern
email clients, provide a high level of Ô¨Çexibility and allow arbitrary wrapping,
nesting, and hiding of encrypted or to-be-signed content. This complexity and
the conjoined attack surface are not dealt with in the security considerations of
the OpenPGP and S/MIME standards, which primarily focus on cryptographic
algorithms and their parameters such as key sizes. However, relying on the secu-
rity of cryptographic primitives, such as AES or ECDH, is not enough for secure
email end-to-end encryption and signatures. The developers of email clients have
to handle a plethora of critical edge-cases ‚Äì without being able to consult any
published best practices. Our work aims to close this research gap. We reveal im-
plementation pitfalls in the ‚Äúno man‚Äôs land‚Äù between cryptography and email,
as used today, and give guidance and best practices in order to improve the
security of S/MIME and OpenPGP capable email clients.

16

J. M√ºller et al.

Acknowledgements

The authors thank Juraj Somorovsky for his valuable feedback and insightful
discussions. Jens M√ºller was supported by the research training group ‚ÄòHuman
Centered System Security‚Äô sponsored by the state of North-Rhine Westfalia. In
addition, this work was supported by the German Research Foundation (DFG)
within the framework of the Excellence Strategy of the Federal Government and
the States ‚Äì EXC 2092 CASA.
Note this is a draft version. The Ô¨Ånal version of this work will be published at the
17th International Conference on Applied Cryptography and Network Security.

References

[1] Cailleux, L., Bonatti, C.: Securing Header Fields with S/MIME (April

2015), http://tools.ietf.org/rfc/rfc7508.txt, RFC7508

[2] Callas, J., Donnerhacke, L., Finney, H., Thayer, R.: OpenPGP Message
Format (November 1998), http://tools.ietf.org/rfc/rfc2440.txt, RFC2440
[3] Davis, D.: Defective Sign & Encrypt in S/MIME, PKCS#7, MOSS, PEM,
PGP, and XML. In: Proceedings of the General Track: 2001 USENIX An-
nual Technical Conference. pp. 65‚Äì78. USENIX Association, Berkeley, CA,
USA (2001), http://dl.acm.org/citation.cfm?id=647055.715781

[4] Gillmor, D.K.: Memory Hole spec and documentation. https://github.

com/autocrypt/memoryhole (2014)

[5] Heiderich, M., Krein, N., Wei√üer, D., F√§√üler, F., Kobeissi, N., Inf√ºhr, A.,
Hong, Magazinius, J.: Pentest-Report Thunderbird & Enigmail 09.2017.
https://cure53.de/pentest-report_thunderbird-enigmail.pdf (2017)
[6] Jallad, K., Katz, J., Schneier, B.: Implementation of Chosen-Ciphertext At-
tacks against PGP and GnuPG. In: Chan, Agnes Huiand Gligor, V. (ed.)
Information Security. pp. 90‚Äì101. Springer Berlin Heidelberg, Berlin, Hei-
delberg (2002)

[7] Katz, J., Schneier, B.: A Chosen Ciphertext Attack Against Several e-Mail
Encryption Protocols. In: Proceedings of the 9th Conference on USENIX
Security Symposium - Volume 9. pp. 18‚Äì18. SSYM‚Äô00 (2000)

[8] Poddebniak, D., Dresen, C., M√ºller, J., Ising, F., Schinzel, S., Fried-
berger, S., Somorovsky, J., Schwenk, J.: Efail: Breaking S/MIME and
OpenPGP Email Encryption using ExÔ¨Åltration Channels. In: 27th USENIX
Security Symposium (USENIX Security 18). pp. 549‚Äì566. USENIX As-
sociation, Baltimore, MD (2018), https://www.usenix.org/conference/
usenixsecurity18/presentation/poddebniak

[9] Ramsdell, B.: S/MIME Version 3 Message SpeciÔ¨Åcation (June 1999), http:

//tools.ietf.org/rfc/rfc2633.txt, RFC2633
[10] Ribeiro, F.: The Ropemaker Email Exploit (2017)
[11] Strenzke, F.: Improved Message Takeover Attacks against S/MIME (Feb

2016), https://cryptosource.de/posts/smime_mta_improved_en.html

[12] W3C: CSS Conditional Rules Module Level 3 (2013), https://www.w3.

org/TR/css3-conditional/

REFERENCES

17

A Screenshots of Decryption Oracles

A.1 Plaintext Hidden in a Referenced Inline ‚ÄòImage‚Äô.

Figure 10 depicts a covert content attack against Thunderbird/Enigmail based
on the example email given in Figure 6. The ciphertext is hidden in an embedded
‚Äòimage‚Äô Ô¨Åle, referenced from the attacker‚Äôs part via a cid: URI scheme. The
OpenPGP plugin ‚Äì Enigmail ‚Äì detects the ‚Äòimage‚Äô as PGP/MIME content and
decrypts it. The decrypted ‚Äòimage‚Äô is then Base64 encoded by Thunderbird and
included in the reply message, therefore leaking the plaintext.

(a) Johnny receives a benign-looking
email with an embedded invisible ‚Äòimage‚Äô
which contains PGP/MIME ciphertext.

(b) Johnny replies to Eve, thereby un-
knowingly leaking the plaintext within
the invisible inline image.

(c) Eve obtains the reply email, including
the Base64 encoded ‚Äòimage‚Äô which con-
tains the plaintext.

(d) Eve decodes the Base64 encoded
data, resulting in the original plaintext
MIME message.

Fig. 10: Convert content attack using Thunderbird as PGP decryption oracle.

18

J. M√ºller et al.

B HTML/CSS Email Support

HTML CSS styles

blinding options
view reply external internal inline display visibility opacity clip-path position color font-size @media @supports @document other

conditional rules

s Thunderbird
w
Outlook 2016
o
d
Win. 10 Mail
n
W. Live Mail
i
W
The Bat!
Postbox
eM Client

x KMail
u
n
i
L

Evolution
Trojit√°
Claws
Mutt

c Apple Mail
a
M

MailMate
Airmail

iOS Mail App

d K-9 Mail
i
R2Mail2
o
r
MailDroid
d
n
Nine
A

(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:71)(cid:35) (cid:32)
(cid:32) (cid:71)(cid:35)
(cid:32) (cid:35)
(cid:35) (cid:35)
(cid:35) (cid:35)

(cid:32) (cid:32)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:32) (cid:32)

(cid:32) (cid:32)
(cid:32) (cid:35)
(cid:32) (cid:32)
(cid:32) (cid:32)

(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:32)
(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)

(cid:35)
(cid:71)(cid:35)
(cid:71)(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)

(cid:35)
(cid:35)
(cid:71)(cid:35)
(cid:32)

b Exchange/OWA
e
Roundcube
W
Horde/IMP
Mailpile

(cid:32) (cid:32)
(cid:32) (cid:71)(cid:35)
(cid:71)(cid:35) (cid:71)(cid:35)
(cid:32) (cid:35)
Not supported by client

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:35)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:32)

(cid:71)(cid:35)
(cid:32)
(cid:32)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:32)
(cid:32)
(cid:32)
(cid:32)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:32)

(cid:32)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:32)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:32)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)
Supported in default settings

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:32)
Supported in non-default settings

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:32)
(cid:32)
(cid:71)(cid:35)
(cid:32)

(cid:35)
(cid:32)
(cid:71)(cid:35)
(cid:35)

(cid:71)(cid:35)

(cid:32)
(cid:32)
(cid:32)
(cid:32)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:35)
(cid:35)
(cid:35)

(cid:35)

(cid:35)
(cid:35)
(cid:35)
(cid:35)

(cid:32)
(cid:35)
(cid:35)
(cid:35)

Table 3: HTML and CSS support in various email clients.

C Other Conditional Features

1

2

3

4

5

6

7

8

9

10

11

12

13

14

.owa {color : red ;}

[owa]
. tb {color : red ;}

<html><head>
<! - -[ i f IE]>< style >.wlm {color : red;}</ style > <![ endif ] - - >
<! - -[ i f mso]>< style >. ol {color : red;}</ style > <![ endif ] - - >
<style >
. ExternalClass .owa,
.moz- text -html
</style >
</head>
<body>
<div class="wlm"> RED text only in Windows Live Mail </div>
<div class="ol "> RED text only in Outlook / W10Mail </div>
</div>
<div class="owa"> RED text only in Exchange (OWA)
<div class="tb"> RED text only in Thunderbird
</div>
</body></html>

<! - - Windows Live Mail -->
<! - - Outlook / W10Mail -->

/* Exchange (OWA) */
/* Thunderbird */

Fig. 11: Proprietary features and CSS to target only certain clients.


