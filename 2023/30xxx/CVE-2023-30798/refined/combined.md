=== Content from github.com_39a1ebc1_20250114_205738.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fencode%2Fstarlette%2Fsecurity%2Fadvisories%2FGHSA-74m5-2c7w-9w3x)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fencode%2Fstarlette%2Fsecurity%2Fadvisories%2FGHSA-74m5-2c7w-9w3x)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=encode%2Fstarlette)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[encode](/encode)
/
**[starlette](/encode/starlette)**
Public

* [Notifications](/login?return_to=%2Fencode%2Fstarlette) You must be signed in to change notification settings
* [Fork
  954](/login?return_to=%2Fencode%2Fstarlette)
* [Star
   10.5k](/login?return_to=%2Fencode%2Fstarlette)

* [Code](/encode/starlette)
* [Issues
  21](/encode/starlette/issues)
* [Pull requests
  18](/encode/starlette/pulls)
* [Discussions](/encode/starlette/discussions)
* [Actions](/encode/starlette/actions)
* [Security](/encode/starlette/security)
* [Insights](/encode/starlette/pulse)

Additional navigation options

* [Code](/encode/starlette)
* [Issues](/encode/starlette/issues)
* [Pull requests](/encode/starlette/pulls)
* [Discussions](/encode/starlette/discussions)
* [Actions](/encode/starlette/actions)
* [Security](/encode/starlette/security)
* [Insights](/encode/starlette/pulse)

# MultipartParser DOS with too many fields or files

Moderate

[Kludex](/Kludex)
published
GHSA-74m5-2c7w-9w3x
Feb 14, 2023

## Package

pip

starlette
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<0.25.0

## Patched versions

0.25.0

## Description

### Impact

The `MultipartParser` using the package `python-multipart` accepts an unlimited number of multipart parts (form fields or files).

Processing too many parts results in high CPU usage and high memory usage, eventually leading to an OOM process kill.

This can be triggered by sending too many small form fields with no content, or too many empty files.

For this to take effect application code has to:

* Have `python-multipart` installed and
* call `request.form()`
  + or via another framework like FastAPI, using form field parameters or `UploadFile` parameters, which in turn calls `request.form()`.

### Patches

The vulnerability is solved in Starlette 0.25.0 by making the maximum fields and files customizable and with a sensible default (1000).

Applications will be secure by just upgrading their Starlette version to 0.25.0 (or FastAPI to 0.92.0).

If application code needs to customize the new max field and file number, there are new `request.form()` parameters (with the default values):

* `max_files=1000`
* `max_fields=1000`

### Workarounds

Applications that don't install `python-multipart` or that don't use form fields are safe.

In older versions, it's also possible to instead of calling `request.form()` call `request.stream()` and parse the form data in internal code.

In most cases, the best solution is to upgrade the Starlette version.

### References

This was reported in private by [@das7pad](https://github.com/das7pad) via internal email. He also coordinated the fix across multiple frameworks and parsers.

The details about how `multipart/form-data` is structured and parsed are in the [RFC 7578](https://www.rfc-editor.org/rfc/rfc7578).

### Severity

Moderate

### CVE ID

No known CVE

### Weaknesses

No CWEs

### Credits

* [![@das7pad](https://avatars.githubusercontent.com/u/17931887?s=40&v=4)](/das7pad)
  [das7pad](/das7pad)
  Analyst

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_5a040104_20250114_205737.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fencode%2Fstarlette%2Fcommit%2F8c74c2c8dba7030154f8af18e016136bea1938fa)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fencode%2Fstarlette%2Fcommit%2F8c74c2c8dba7030154f8af18e016136bea1938fa)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=encode%2Fstarlette)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[encode](/encode)
/
**[starlette](/encode/starlette)**
Public

* [Notifications](/login?return_to=%2Fencode%2Fstarlette) You must be signed in to change notification settings
* [Fork
  954](/login?return_to=%2Fencode%2Fstarlette)
* [Star
   10.5k](/login?return_to=%2Fencode%2Fstarlette)

* [Code](/encode/starlette)
* [Issues
  21](/encode/starlette/issues)
* [Pull requests
  18](/encode/starlette/pulls)
* [Discussions](/encode/starlette/discussions)
* [Actions](/encode/starlette/actions)
* [Security](/encode/starlette/security)
* [Insights](/encode/starlette/pulse)

Additional navigation options

* [Code](/encode/starlette)
* [Issues](/encode/starlette/issues)
* [Pull requests](/encode/starlette/pulls)
* [Discussions](/encode/starlette/discussions)
* [Actions](/encode/starlette/actions)
* [Security](/encode/starlette/security)
* [Insights](/encode/starlette/pulse)

## Commit

[Permalink](/encode/starlette/commit/8c74c2c8dba7030154f8af18e016136bea1938fa)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-74m5-2c7w-9w3x](https://github.com/advisories/GHSA-74m5-2c7w-9w3x "GHSA-74m5-2c7w-9w3x")

[Browse files](/encode/starlette/tree/8c74c2c8dba7030154f8af18e016136bea1938fa)
Browse the repository at this point in the history

```
* ‚ôªÔ∏è Refactor multipart parser logic to support limiting max fields and files

* ‚ú® Add support for new request.form() parameters max_files and max_fields

* ‚úÖ Add tests for limiting max fields and files in form data

* üìù Add docs about request.form() with new parameters max_files and max_fields

* üìù Update `docs/requests.md`

Co-authored-by: Marcelo Trylesinski <marcelotryle@gmail.com>

* üìù Tweak docs for request.form()

* ‚úè Fix typo in `starlette/formparsers.py`

Co-authored-by: Adrian Garcia Badaracco <1755071+adriangb@users.noreply.github.com>

---------

Co-authored-by: Marcelo Trylesinski <marcelotryle@gmail.com>
Co-authored-by: Adrian Garcia Badaracco <1755071+adriangb@users.noreply.github.com>
```

* Loading branch information

[![@tiangolo](https://avatars.githubusercontent.com/u/1326112?s=40&v=4)](/tiangolo) [![@Kludex](https://avatars.githubusercontent.com/u/7353520?s=40&v=4)](/Kludex) [![@adriangb](https://avatars.githubusercontent.com/u/1755071?s=40&v=4)](/adriangb)

3 people

authored
Feb 14, 2023

1 parent
[5771a78](/encode/starlette/commit/5771a78c14d577bd1743ed2e948c91589dd30e20)

commit 8c74c2c

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**356 additions**
and
**91 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs

  + docs/requests.md
    [requests.md](#diff-6f755c99d1790eb638396dd559a8ece7932e095bb3f99e0131e478cd265bf9a1)
* starlette

  + starlette/formparsers.py
    [formparsers.py](#diff-59eaf7e36ef8b186735f99bca714455f02f04cee26e014dc89120417996d35b2)
  + starlette/requests.py
    [requests.py](#diff-7d5cdd0c41aca64786e140201f4b95f1983e2ceb09d47f52de587669e8df776f)
* tests

  + tests/test\_formparsers.py
    [test\_formparsers.py](#diff-f7f9908499f315cee25da522e89d1dfd9c33e78b6a08cc7542754a046093d0c2)

## There are no files selected for viewing

12 changes: 12 additions & 0 deletions

12
[docs/requests.md](#diff-6f755c99d1790eb638396dd559a8ece7932e095bb3f99e0131e478cd265bf9a1 "docs/requests.md")

Show comments

[View file](/encode/starlette/blob/8c74c2c8dba7030154f8af18e016136bea1938fa/docs/requests.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -114,6 +114,18 @@ state with `disconnected = await request.is\_disconnected()`. |
|  |  |  |
|  |  | Request files are normally sent as multipart form data (`multipart/form-data`). |
|  |  |  |
|  |  | Signature: `request.form(max\_files=1000, max\_fields=1000)` |
|  |  |  |
|  |  | You can configure the number of maximum fields or files with the parameters `max\_files` and `max\_fields`: |
|  |  |  |
|  |  | ```python |
|  |  | async with request.form(max\_files=1000, max\_fields=1000): |
|  |  | ... |
|  |  | ``` |
|  |  |  |
|  |  | !!! info |
|  |  | These limits are for security reasons, allowing an unlimited number of fields or files could lead to a denial of service attack by consuming a lot of CPU and memory parsing too many empty fields. |
|  |  |  |
|  |  | When you call `async with request.form() as form` you receive a `starlette.datastructures.FormData` which is an immutable |
|  |  | multidict, containing both file uploads and text input. File upload items are represented as instances of `starlette.datastructures.UploadFile`. |
|  |  |  |
| Expand Down | |  |

188 changes: 101 additions & 87 deletions

188
[starlette/formparsers.py](#diff-59eaf7e36ef8b186735f99bca714455f02f04cee26e014dc89120417996d35b2 "starlette/formparsers.py")

Show comments

[View file](/encode/starlette/blob/8c74c2c8dba7030154f8af18e016136bea1938fa/starlette/formparsers.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,5 @@ |
|  |  | import typing |
|  |  | from dataclasses import dataclass, field |
|  |  | from enum import Enum |
|  |  | from tempfile import SpooledTemporaryFile |
|  |  | from urllib.parse import unquote\_plus |
| Expand All | | @@ -21,15 +22,13 @@ class FormMessage(Enum): |
|  |  | END = 5 |
|  |  |  |
|  |  |  |
|  |  | class MultiPartMessage(Enum): |
|  |  | PART\_BEGIN = 1 |
|  |  | PART\_DATA = 2 |
|  |  | PART\_END = 3 |
|  |  | HEADER\_FIELD = 4 |
|  |  | HEADER\_VALUE = 5 |
|  |  | HEADER\_END = 6 |
|  |  | HEADERS\_FINISHED = 7 |
|  |  | END = 8 |
|  |  | @dataclass |
|  |  | class MultipartPart: |
|  |  | content\_disposition: typing.Optional[bytes] = None |
|  |  | field\_name: str = "" |
|  |  | data: bytes = b"" |
|  |  | file: typing.Optional[UploadFile] = None |
|  |  | item\_headers: typing.List[typing.Tuple[bytes, bytes]] = field(default\_factory=list) |
|  |  |  |
|  |  |  |
|  |  | def \_user\_safe\_decode(src: bytes, codec: str) -> str: |
| Expand Down  Expand Up | | @@ -120,53 +119,115 @@ class MultiPartParser: |
|  |  | max\_file\_size = 1024 \* 1024 |
|  |  |  |
|  |  | def \_\_init\_\_( |
|  |  | self, headers: Headers, stream: typing.AsyncGenerator[bytes, None] |
|  |  | self, |
|  |  | headers: Headers, |
|  |  | stream: typing.AsyncGenerator[bytes, None], |
|  |  | \*, |
|  |  | max\_files: typing.Union[int, float] = 1000, |
|  |  | max\_fields: typing.Union[int, float] = 1000, |
|  |  | ) -> None: |
|  |  | assert ( |
|  |  | multipart is not None |
|  |  | ), "The `python-multipart` library must be installed to use form parsing." |
|  |  | self.headers = headers |
|  |  | self.stream = stream |
|  |  | self.messages: typing.List[typing.Tuple[MultiPartMessage, bytes]] = [] |
|  |  | self.max\_files = max\_files |
|  |  | self.max\_fields = max\_fields |
|  |  | self.items: typing.List[typing.Tuple[str, typing.Union[str, UploadFile]]] = [] |
|  |  | self.\_current\_files = 0 |
|  |  | self.\_current\_fields = 0 |
|  |  | self.\_current\_partial\_header\_name: bytes = b"" |
|  |  | self.\_current\_partial\_header\_value: bytes = b"" |
|  |  | self.\_current\_part = MultipartPart() |
|  |  | self.\_charset = "" |
|  |  | self.\_file\_parts\_to\_write: typing.List[typing.Tuple[MultipartPart, bytes]] = [] |
|  |  | self.\_file\_parts\_to\_finish: typing.List[MultipartPart] = [] |
|  |  |  |
|  |  | def on\_part\_begin(self) -> None: |
|  |  | message = (MultiPartMessage.PART\_BEGIN, b"") |
|  |  | self.messages.append(message) |
|  |  | self.\_current\_part = MultipartPart() |
|  |  |  |
|  |  | def on\_part\_data(self, data: bytes, start: int, end: int) -> None: |
|  |  | message = (MultiPartMessage.PART\_DATA, data[start:end]) |
|  |  | self.messages.append(message) |
|  |  | message\_bytes = data[start:end] |
|  |  | if self.\_current\_part.file is None: |
|  |  | self.\_current\_part.data += message\_bytes |
|  |  | else: |
|  |  | self.\_file\_parts\_to\_write.append((self.\_current\_part, message\_bytes)) |
|  |  |  |
|  |  | def on\_part\_end(self) -> None: |
|  |  | message = (MultiPartMessage.PART\_END, b"") |
|  |  | self.messages.append(message) |
|  |  | if self.\_current\_part.file is None: |
|  |  | self.items.append( |
|  |  | ( |
|  |  | self.\_current\_part.field\_name, |
|  |  | \_user\_safe\_decode(self.\_current\_part.data, self.\_charset), |
|  |  | ) |
|  |  | ) |
|  |  | else: |
|  |  | self.\_file\_parts\_to\_finish.append(self.\_current\_part) |
|  |  | # The file can be added to the items right now even though it's not |
|  |  | # finished yet, because it will be finished in the `parse()` method, before |
|  |  | # self.items is used in the return value. |
|  |  | self.items.append((self.\_current\_part.field\_name, self.\_current\_part.file)) |
|  |  |  |
|  |  | def on\_header\_field(self, data: bytes, start: int, end: int) -> None: |
|  |  | message = (MultiPartMessage.HEADER\_FIELD, data[start:end]) |
|  |  | self.messages.append(message) |
|  |  | self.\_current\_partial\_header\_name += data[start:end] |
|  |  |  |
|  |  | def on\_header\_value(self, data: bytes, start: int, end: int) -> None: |
|  |  | message = (MultiPartMessage.HEADER\_VALUE, data[start:end]) |
|  |  | self.messages.append(message) |
|  |  | self.\_current\_partial\_header\_value += data[start:end] |
|  |  |  |
|  |  | def on\_header\_end(self) -> None: |
|  |  | message = (MultiPartMessage.HEADER\_END, b"") |
|  |  | self.messages.append(message) |
|  |  | field = self.\_current\_partial\_header\_name.lower() |
|  |  | if field == b"content-disposition": |
|  |  | self.\_current\_part.content\_disposition = self.\_current\_partial\_header\_value |
|  |  | self.\_current\_part.item\_headers.append( |
|  |  | (field, self.\_current\_partial\_header\_value) |
|  |  | ) |
|  |  | self.\_current\_partial\_header\_name = b"" |
|  |  | self.\_current\_partial\_header\_value = b"" |
|  |  |  |
|  |  | def on\_headers\_finished(self) -> None: |
|  |  | message = (MultiPartMessage.HEADERS\_FINISHED, b"") |
|  |  | self.messages.append(message) |
|  |  | disposition, options = parse\_options\_header( |
|  |  | self.\_current\_part.content\_disposition |
|  |  | ) |
|  |  | try: |
|  |  | self.\_current\_part.field\_name = \_user\_safe\_decode( |
|  |  | options[b"name"], self.\_charset |
|  |  | ) |
|  |  | except KeyError: |
|  |  | raise MultiPartException( |
|  |  | 'The Content-Disposition header field "name" must be ' "provided." |
|  |  | ) |
|  |  | if b"filename" in options: |
|  |  | self.\_current\_files += 1 |
|  |  | if self.\_current\_files > self.max\_files: |
|  |  | raise MultiPartException( |
|  |  | f"Too many files. Maximum number of files is {self.max\_files}." |
|  |  | ) |
|  |  | filename = \_user\_safe\_decode(options[b"filename"], self.\_charset) |
|  |  | tempfile = SpooledTemporaryFile(max\_size=self.max\_file\_size) |
|  |  | self.\_current\_part.file = UploadFile( |
|  |  | file=tempfile, # type: ignore[arg-type] |
|  |  | size=0, |
|  |  | filename=filename, |
|  |  | headers=Headers(raw=self.\_current\_part.item\_headers), |
|  |  | ) |
|  |  | else: |
|  |  | self.\_current\_fields += 1 |
|  |  | if self.\_current\_fields > self.max\_fields: |
|  |  | raise MultiPartException( |
|  |  | f"Too many fields. Maximum number of fields is {self.max\_fields}." |
|  |  | ) |
|  |  | self.\_current\_part.file = None |
|  |  |  |
|  |  | def on\_end(self) -> None: |
|  |  | message = (MultiPartMessage.END, b"") |
|  |  | self.messages.append(message) |
|  |  | pass |
|  |  |  |
|  |  | async def parse(self) -> FormData: |
|  |  | # Parse the Content-Type header to get the multipart boundary. |
|  |  | \_, params = parse\_options\_header(self.headers["Content-Type"]) |
|  |  | charset = params.get(b"charset", "utf-8") |
|  |  | if type(charset) == bytes: |
|  |  | charset = charset.decode("latin-1") |
|  |  | self.\_charset = charset |
|  |  | try: |
|  |  | boundary = params[b"boundary"] |
|  |  | except KeyError: |
| Expand All | | @@ -186,68 +247,21 @@ async def parse(self) -> FormData: |
|  |  |  |
|  |  | # Create the parser. |
|  |  | parser = multipart.MultipartParser(boundary, callbacks) |
|  |  | header\_field = b"" |
|  |  | header\_value = b"" |
|  |  | content\_disposition = None |
|  |  | field\_name = "" |
|  |  | data = b"" |
|  |  | file: typing.Optional[UploadFile] = None |
|  |  |  |
|  |  | items: typing.List[typing.Tuple[str, typing.Union[str, UploadFile]]] = [] |
|  |  | item\_headers: typing.List[typing.Tuple[bytes, bytes]] = [] |
|  |  |  |
|  |  | # Feed the parser with data from the request. |
|  |  | async for chunk in self.stream: |
|  |  | parser.write(chunk) |
|  |  | messages = list(self.messages) |
|  |  | self.messages.clear() |
|  |  | for message\_type, message\_bytes in messages: |
|  |  | if message\_type == MultiPartMessage.PART\_BEGIN: |
|  |  | content\_disposition = None |
|  |  | data = b"" |
|  |  | item\_headers = [] |
|  |  | elif message\_type == MultiPartMessage.HEADER\_FIELD: |
|  |  | header\_field += message\_bytes |
|  |  | elif message\_type == MultiPartMessage.HEADER\_VALUE: |
|  |  | header\_value += message\_bytes |
|  |  | elif message\_type == MultiPartMessage.HEADER\_END: |
|  |  | field = header\_field.lower() |
|  |  | if field == b"content-disposition": |
|  |  | content\_disposition = header\_value |
|  |  | item\_headers.append((field, header\_value)) |
|  |  | header\_field = b"" |
|  |  | header\_value = b"" |
|  |  | elif message\_type == MultiPartMessage.HEADERS\_FINISHED: |
|  |  | disposition, options = parse\_options\_header(content\_disposition) |
|  |  | try: |
|  |  | field\_name = \_user\_safe\_decode(options[b"name"], charset) |
|  |  | except KeyError: |
|  |  | raise MultiPartException( |
|  |  | 'The Content-Disposition header field "name" must be ' |
|  |  | "provided." |
|  |  | ) |
|  |  | if b"filename" in options: |
|  |  | filename = \_user\_safe\_decode(options[b"filename"], charset) |
|  |  | tempfile = SpooledTemporaryFile(max\_size=self.max\_file\_size) |
|  |  | file = UploadFile( |
|  |  | file=tempfile, # type: ignore[arg-type] |
|  |  | size=0, |
|  |  | filename=filename, |
|  |  | headers=Headers(raw=item\_headers), |
|  |  | ) |
|  |  | else: |
|  |  | file = None |
|  |  | elif message\_type == MultiPartMessage.PART\_DATA: |
|  |  | if file is None: |
|  |  | data += message\_bytes |
|  |  | else: |
|  |  | await file.write(message\_bytes) |
|  |  | elif message\_type == MultiPartMessage.PART\_END: |
|  |  | if file is None: |
|  |  | items.append((field\_name, \_user\_safe\_decode(data, charset))) |
|  |  | else: |
|  |  | await file.seek(0) |
|  |  | items.append((field\_name, file)) |
|  |  | # Write file data, it needs to use await with the UploadFile methods that |
|  |  | # call the corresponding file methods \*in a threadpool\*, otherwise, if |
|  |  | # they were called directly in the callback methods above (regular, |
|  |  | # non-async functions), that would block the event loop in the main thread. |
|  |  | for part, data in self.\_file\_parts\_to\_write: |
|  |  | assert part.file # for type checkers |
|  |  | await part.file.write(data) |
|  |  | for part in self.\_file\_parts\_to\_finish: |
|  |  | assert part.file # for type checkers |
|  |  | await part.file.seek(0) |
|  |  | self.\_file\_parts\_to\_write.clear() |
|  |  | self.\_file\_parts\_to\_finish.clear() |
|  |  |  |
|  |  | parser.finalize() |
|  |  | return FormData(items) |
|  |  | return FormData(self.items) |

25 changes: 21 additions & 4 deletions

25
[starlette/requests.py](#diff-7d5cdd0c41aca64786e140201f4b95f1983e2ceb09d47f52de587669e8df776f "starlette/requests.py")

Show comments

[View file](/encode/starlette/blob/8c74c2c8dba7030154f8af18e016136bea1938fa/starlette/requests.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -244,7 +244,12 @@ async def json(self) -> typing.Any: |
|  |  | self.\_json = json.loads(body) |
|  |  | return self.\_json |
|  |  |  |
|  |  | async def \_get\_form(self) -> FormData: |
|  |  | async def \_get\_form( |
|  |  | self, |
|  |  | \*, |
|  |  | max\_files: typing.Union[int, float] = 1000, |
|  |  | max\_fields: typing.Union[int, float] = 1000, |
|  |  | ) -> FormData: |
|  |  | if self.\_form is None: |
|  |  | assert ( |
|  |  | parse\_options\_header is not None |
| Expand All | | @@ -254,7 +259,12 @@ async def \_get\_form(self) -> FormData: |
|  |  | content\_type, \_ = parse\_options\_header(content\_type\_header) |
|  |  | if content\_type == b"multipart/form-data": |
|  |  | try: |
|  |  | multipart\_parser = MultiPartParser(self.headers, self.stream()) |
|  |  | multipart\_parser = MultiPartParser( |
|  |  | self.headers, |
|  |  | self.stream(), |
|  |  | max\_files=max\_files, |
|  |  | max\_fields=max\_fields, |
|  |  | ) |
|  |  | self.\_form = await multipart\_parser.parse() |
|  |  | except MultiPartException as exc: |
|  |  | if "app" in self.scope: |
| Expand All | | @@ -267,8 +277,15 @@ async def \_get\_form(self) -> FormData: |
|  |  | self.\_form = FormData() |
|  |  | return self.\_form |
|  |  |  |
|  |  | def form(self) -> AwaitableOrContextManager[FormData]: |
|  |  | return AwaitableOrContextManagerWrapper(self.\_get\_form()) |
|  |  | def form( |
|  |  | self, |
|  |  | \*, |
|  |  | max\_files: typing.Union[int, float] = 1000, |
|  |  | max\_fields: typing.Union[int, float] = 1000, |
|  |  | ) -> AwaitableOrContextManager[FormData]: |
|  |  | return AwaitableOrContextManagerWrapper( |
|  |  | self.\_get\_form(max\_files=max\_files, max\_fields=max\_fields) |
|  |  | ) |
|  |  |  |
|  |  | async def close(self) -> None: |
|  |  | if self.\_form is not None: |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8c74c2c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fencode%2Fstarlette%2Fcommit%2F8c74c2c8dba7030154f8af18e016136bea1938fa) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from vulncheck.com_5b126451_20250114_205740.html ===

## Cookies

We use our own cookies and third-party cookies so that we can display this website correctly and better understand how this website is used, with a view to improving the services we offer. A decision on cookie usage permissions can be changed anytime using the cookie button that will appear after a selection has been made on this banner.

AcceptDeclineLearn more and customize[Products](/product)[Government](/government)Resources[Community](/community)Open Source[Company](/company)Go back

MultipartParser DOS with too many fields or files in Starlette Framework

severityhighdateApril 20, 2023Affecting

* Python module starlette versions lessage than 0.25.0. It is patched in 0.25.0.

CVECVE-2023-30798CVE typeUncontrolled Resource ConsumptionCVSS7.5CVSS V3 VectorAV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:HReferences

* [GHSA-74m5-2c7w-9w3x](https://github.com/encode/starlette/security/advisories/GHSA-74m5-2c7w-9w3x)
* [fix commit](https://github.com/encode/starlette/commit/8c74c2c8dba7030154f8af18e016136bea1938fa)

FooterVulnCheck helps organizations outpace adversaries with vulnerability intelligence that predicts avenues of attack with speed and accuracy.¬© 2025 VulnCheck Inc.Products

* [Exploit & Vulnerability Intelligence](/product/exploit-intelligence)
* [Initial Access Intelligence](/product/initial-access-intelligence)
* [IP Intelligence](/product/ip-intelligence)
* [VulnCheck for Government](/government)

Resources

* [Documentation](https://docs.vulncheck.com/)
* [API](https://docs.vulncheck.com/api)
* [Changelog](https://docs.vulncheck.com/changelog)
* [Glossary](https://docs.vulncheck.com/glossary/terms)
* Contact Support

Community

* [VulnCheck KEV](/kev)
* [NVD++](/nvd2)
* [XDB](/xdb)
* [Knowledge Base](/blog?tags=101)
* [Report a Vulnerability](/advisories/report)

Open Source

* [SDK for Go](https://github.com/vulncheck-oss/sdk-go)
* [SDK for Python](https://github.com/vulncheck-oss/sdk-python)
* [CLI](https://github.com/vulncheck-oss/cli)
* [GitHub Action](https://github.com/vulncheck-oss/action)
* [go-exploit](https://github.com/vulncheck-oss/go-exploit)

Company

* [Blog](/blog)
* [News and Awards](/news)
* [Press Releases](/press)
* [Partners](/partners)
* [Events](/events)
* [VulnCheck Advisories](/advisories)
* [Leadership Team](/company/about)

Legal

* [Privacy Policy](/privacy)
* [Terms & Conditions](/terms)
* [Vulnerability Disclosure Policy](/vulnerability-disclosure-policy)


