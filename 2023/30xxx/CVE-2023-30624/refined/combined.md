=== Content from github.com_24b0228c_20250115_090356.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-ch89-5g45-qwc7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fsecurity%2Fadvisories%2FGHSA-ch89-5g45-qwc7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  79](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

# Undefined Behavior in Rust runtime functions

Low

[alexcrichton](/alexcrichton)
published
GHSA-ch89-5g45-qwc7
Apr 27, 2023

## Package

cargo

wasmtime
([Rust](/advisories?query=ecosystem%3Arust))

## Affected versions

<= 6.0.1, 7.0.0, 8.0.0

## Patched versions

6.0.2, 7.0.1, 8.0.1

## Description

### Impact

Wasmtime's implementation of managing per-instance state, such as tables and memories, contains LLVM-level undefined behavior. This undefined behavior was found to cause runtime-level issues when compiled with LLVM 16 which causes some writes, which are critical for correctness, to be optimized away. Vulnerable versions of Wasmtime compiled with Rust 1.70, which is currently in beta, or later are known to have incorrectly compiled functions. Versions of Wasmtime compiled with the current Rust stable release, 1.69, and prior are not known at this time to have any issues, but can theoretically exhibit potential issues.

The underlying problem is that Wasmtime's runtime state for an instance involves a Rust-defined structure called `Instance` which has a trailing `VMContext` structure after it. This `VMContext` structure has a runtime-defined layout that is unique per-module. This representation cannot be expressed with safe code in Rust so `unsafe` code is required to maintain this state. The code doing this, however, has methods which take `&self` as an argument but modify data in the `VMContext` part of the allocation. This means that pointers derived from `&self` are mutated. This is typically not allowed, except in the presence of `UnsafeCell`, in Rust. When compiled to LLVM these functions have `noalias readonly` parameters which means it's UB to write through the pointers.

Wasmtime's internal representation and management of `VMContext` has been updated to use `&mut self` methods where appropriate. Additionally verification tools for `unsafe` code in Rust, such as `cargo miri`, are planned to be executed on the `main` branch soon to fix any Rust-level issues that may be exploited in future compiler versions.

Precomplied binaries available for Wasmtime from GitHub releases have been compiled with at most LLVM 15 so are not known to be vulnerable. As mentioned above, however, it's still recommended to update.

### Patches

Wasmtime version 6.0.2, 7.0.1, and 8.0.1 have been issued which contain the patch necessary to work correctly on LLVM 16 and have no known UB on LLVM 15 and earlier.

### Workarounds

If Wasmtime is compiled with Rust 1.69 and prior, which use LLVM 15, then there are no known issues. There is a theoretical possibility for UB to exploited, however, so it's recommended that users upgrade to a patched version of Wasmtime. Users using beta Rust (1.70 at this time) or nightly Rust (1.71 at this time) must update to a patched version to work correctly.

### References

* [GitHub Advisory](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ch89-5g45-qwc7)
* [Mailing list announcement](https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/ecK-6G2yi90)

### For more information

If you have any questions or comments about this advisory:

* Reach out to us on [the Bytecode Alliance Zulip chat](https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime)
* Open an issue in [the bytecodealliance/wasmtime repository](https://github.com/bytecodealliance/wasmtime/)

### Severity

Low

3.9

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
High

User interaction
Required

Scope
Unchanged

Confidentiality
Low

Integrity
Low

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:U/C:L/I:L/A:L

### CVE ID

CVE-2023-30624

### Weaknesses

[CWE-758](/advisories?query=cwe%3A758)

### Credits

* [![@guidovranken](https://avatars.githubusercontent.com/u/6846644?s=40&v=4)](/guidovranken)
  [guidovranken](/guidovranken)
  Reporter
* [![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)
  [alexcrichton](/alexcrichton)
  Remediation developer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e7681668_20250115_090355.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F0977952dcd9d482bff7c288868ccb52769b3a92e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F0977952dcd9d482bff7c288868ccb52769b3a92e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=bytecodealliance%2Fwasmtime)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bytecodealliance](/bytecodealliance)
/
**[wasmtime](/bytecodealliance/wasmtime)**
Public

* [Notifications](/login?return_to=%2Fbytecodealliance%2Fwasmtime) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)
* [Star
   15.7k](/login?return_to=%2Fbytecodealliance%2Fwasmtime)

* [Code](/bytecodealliance/wasmtime)
* [Issues
  707](/bytecodealliance/wasmtime/issues)
* [Pull requests
  79](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

Additional navigation options

* [Code](/bytecodealliance/wasmtime)
* [Issues](/bytecodealliance/wasmtime/issues)
* [Pull requests](/bytecodealliance/wasmtime/pulls)
* [Actions](/bytecodealliance/wasmtime/actions)
* [Security](/bytecodealliance/wasmtime/security)
* [Insights](/bytecodealliance/wasmtime/pulse)

## Commit

[Permalink](/bytecodealliance/wasmtime/commit/0977952dcd9d482bff7c288868ccb52769b3a92e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-ch89-5g45-qwc7](https://github.com/advisories/GHSA-ch89-5g45-qwc7 "GHSA-ch89-5g45-qwc7")

[Browse files](/bytecodealliance/wasmtime/tree/0977952dcd9d482bff7c288868ccb52769b3a92e)
Browse the repository at this point in the history

```
* Fix miscompile from functions mutating `VMContext`

This commit fixes a miscompilation in Wasmtime on LLVM 16 where methods
on `Instance` which mutated the state of the internal `VMContext` were
optimized to not actually mutate the state. The root cause of this issue
is a change in LLVM which takes advantage of `noalias readonly` pointers
which is how `&self` methods are translated. This means that `Instance`
methods which take `&self` but actually mutate the `VMContext` end up
being undefined behavior from LLVM's point of view, meaning that the
writes are candidate for removal.

The fix applied here is intended to be a temporary one while a more
formal fix, ideally backed by `cargo miri` verification, is implemented
on `main`. The fix here is to change the return value of
`vmctx_plus_offset` to return `*const T` instead of `*mut T`. This
caused lots of portions of the runtime code to stop compiling because
mutations were indeed happening. To cover these a new
`vmctx_plus_offset_mut` method was added which notably takes `&mut self`
instead of `&self`. This forced all callers which may mutate to reflect
the `&mut self` requirement, propagating that outwards.

This fixes the miscompilation with LLVM 16 in the immediate future and
should be at least a meager line of defense against issues like this in
the future. This is not a long-term fix, though, since `cargo miri`
still does not like what's being done in `Instance` and with
`VMContext`. That fix is likely to be more invasive, though, so it's
being deferred to later.

* Update release notes

* Fix dates and fill out more notes
```

* Loading branch information

[![@alexcrichton](https://avatars.githubusercontent.com/u/64996?s=40&v=4)](/alexcrichton)

[alexcrichton](/bytecodealliance/wasmtime/commits?author=alexcrichton "View all commits by alexcrichton")
authored
Apr 27, 2023

1 parent
[f14bb4f](/bytecodealliance/wasmtime/commit/f14bb4fb14687951de7d21f5e65b977ac284f8d8)

commit 0977952

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**127 additions**
and
**82 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* RELEASES.md
  [RELEASES.md](#diff-4a00447b47c36ebd3ded77321deff288e424f4605496ee1199fc9953a20f4473)
* crates

  + environ/src

    - crates/environ/src/module.rs
      [module.rs](#diff-26a6cd76b4c168a74993c45b72cb46abfba09f17db22d9dc9ec7f3e724a13d62)
  + runtime/src

    - crates/runtime/src/instance.rs
      [instance.rs](#diff-e95cf87da8a8dcc08101777a3375ca3e634f0ed6b9f7c5daeec7e73cc4610eaf)
    - instance

      * crates/runtime/src/instance/allocator.rs
        [allocator.rs](#diff-aeff6fbd8ba216e92a8c8166d0a044b0eff2095a23e5bf831f699813fa284dcb)
    - crates/runtime/src/libcalls.rs
      [libcalls.rs](#diff-aeecd191ed2832ecc670202be8de1d73ff30c8476f710bc5aa6d759bd5d925b9)
    - crates/runtime/src/traphandlers.rs
      [traphandlers.rs](#diff-560b66f5eac16eef20c78bcaf2c66582dbc6cf76fa1cc72faf6bca7b736cd660)

## There are no files selected for viewing

43 changes: 43 additions & 0 deletions

43
[RELEASES.md](#diff-4a00447b47c36ebd3ded77321deff288e424f4605496ee1199fc9953a20f4473 "RELEASES.md")

Show comments

[View file](/bytecodealliance/wasmtime/blob/0977952dcd9d482bff7c288868ccb52769b3a92e/RELEASES.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -10,6 +10,27 @@ Unreleased. |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 8.0.1 |
|  |  |  |
|  |  | Released 2023-04-27. |
|  |  |  |
|  |  | ### Changed |
|  |  |  |
|  |  | \* Breaking: Files opened using Wasmtime's implementation of WASI on Windows now |
|  |  | cannot be deleted until the file handle is closed. This was already true for |
|  |  | open directories. The change was necessary for the bug fix in |
|  |  | [#6163](https://github.com/bytecodealliance/wasmtime/pull/6163). |
|  |  |  |
|  |  | ### Fixed |
|  |  |  |
|  |  | \* Fixed wasi-common's implementation of the `O\_DIRECTORY` flag to match POSIX. |
|  |  | [#6163](https://github.com/bytecodealliance/wasmtime/pull/6163) |
|  |  |  |
|  |  | \* Undefined Behavior in Rust runtime functions |
|  |  | [GHSA-ch89-5g45-qwc7](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ch89-5g45-qwc7) |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 8.0.0 |
|  |  |  |
|  |  | Released 2023-04-20 |
| Expand Down  Expand Up | | @@ -110,6 +131,17 @@ Released 2023-04-20 |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 7.0.1 |
|  |  |  |
|  |  | Released 2023-04-27. |
|  |  |  |
|  |  | ### Fixed |
|  |  |  |
|  |  | \* Undefined Behavior in Rust runtime functions |
|  |  | [GHSA-ch89-5g45-qwc7](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ch89-5g45-qwc7) |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 7.0.0 |
|  |  |  |
|  |  | Released 2023-03-20 |
| Expand Down  Expand Up | | @@ -174,6 +206,17 @@ Released 2023-03-20 |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 6.0.2 |
|  |  |  |
|  |  | Released 2023-04-27. |
|  |  |  |
|  |  | ### Fixed |
|  |  |  |
|  |  | \* Undefined Behavior in Rust runtime functions |
|  |  | [GHSA-ch89-5g45-qwc7](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-ch89-5g45-qwc7) |
|  |  |  |
|  |  | -------------------------------------------------------------------------------- |
|  |  |  |
|  |  | ## 6.0.1 |
|  |  |  |
|  |  | Released 2023-03-08. |
| Expand Down | |  |

28 changes: 15 additions & 13 deletions

28
[crates/environ/src/module.rs](#diff-26a6cd76b4c168a74993c45b72cb46abfba09f17db22d9dc9ec7f3e724a13d62 "crates/environ/src/module.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/0977952dcd9d482bff7c288868ccb52769b3a92e/crates/environ/src/module.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -241,8 +241,9 @@ impl ModuleTranslation<'\_> { |
|  |  | } |
|  |  | let mut idx = 0; |
|  |  | let ok = self.module.memory\_initialization.init\_memory( |
|  |  | &mut (), |
|  |  | InitMemory::CompileTime(&self.module), |
|  |  | &mut |memory, init| { |
|  |  | |(), memory, init| { |
|  |  | // Currently `Static` only applies to locally-defined memories, |
|  |  | // so if a data segment references an imported memory then |
|  |  | // transitioning to a `Static` memory initializer is not |
| Expand Down  Expand Up | | @@ -525,10 +526,11 @@ impl MemoryInitialization { |
|  |  | /// question needs to be deferred to runtime, and at runtime this means |
|  |  | /// that an invalid initializer has been found and a trap should be |
|  |  | /// generated. |
|  |  | pub fn init\_memory( |
|  |  | pub fn init\_memory<T>( |
|  |  | &self, |
|  |  | state: InitMemory<'\_>, |
|  |  | write: &mut dyn FnMut(MemoryIndex, &StaticMemoryInitializer) -> bool, |
|  |  | state: &mut T, |
|  |  | init: InitMemory<'\_, T>, |
|  |  | mut write: impl FnMut(&mut T, MemoryIndex, &StaticMemoryInitializer) -> bool, |
|  |  | ) -> bool { |
|  |  | let initializers = match self { |
|  |  | // Fall through below to the segmented memory one-by-one |
| Expand All | | @@ -543,7 +545,7 @@ impl MemoryInitialization { |
|  |  | MemoryInitialization::Static { map } => { |
|  |  | for (index, init) in map { |
|  |  | if let Some(init) = init { |
|  |  | let result = write(index, init); |
|  |  | let result = write(state, index, init); |
|  |  | if !result { |
|  |  | return result; |
|  |  | } |
| Expand All | | @@ -567,10 +569,10 @@ impl MemoryInitialization { |
|  |  | // (e.g. this is a task happening before instantiation at |
|  |  | // compile-time). |
|  |  | let base = match base { |
|  |  | Some(index) => match &state { |
|  |  | Some(index) => match &init { |
|  |  | InitMemory::Runtime { |
|  |  | get\_global\_as\_u64, .. |
|  |  | } => get\_global\_as\_u64(index), |
|  |  | } => get\_global\_as\_u64(state, index), |
|  |  | InitMemory::CompileTime(\_) => return false, |
|  |  | }, |
|  |  | None => 0, |
| Expand All | | @@ -585,12 +587,12 @@ impl MemoryInitialization { |
|  |  | None => return false, |
|  |  | }; |
|  |  |  |
|  |  | let cur\_size\_in\_pages = match &state { |
|  |  | let cur\_size\_in\_pages = match &init { |
|  |  | InitMemory::CompileTime(module) => module.memory\_plans[memory\_index].memory.minimum, |
|  |  | InitMemory::Runtime { |
|  |  | memory\_size\_in\_pages, |
|  |  | .. |
|  |  | } => memory\_size\_in\_pages(memory\_index), |
|  |  | } => memory\_size\_in\_pages(state, memory\_index), |
|  |  | }; |
|  |  |  |
|  |  | // Note that this `minimum` can overflow if `minimum` is |
| Expand All | | @@ -616,7 +618,7 @@ impl MemoryInitialization { |
|  |  | offset: start, |
|  |  | data: data.clone(), |
|  |  | }; |
|  |  | let result = write(memory\_index, &init); |
|  |  | let result = write(state, memory\_index, &init); |
|  |  | if !result { |
|  |  | return result; |
|  |  | } |
| Expand All | | @@ -628,7 +630,7 @@ impl MemoryInitialization { |
|  |  |  |
|  |  | /// Argument to [`MemoryInitialization::init\_memory`] indicating the current |
|  |  | /// status of the instance. |
|  |  | pub enum InitMemory<'a> { |
|  |  | pub enum InitMemory<'a, T> { |
|  |  | /// This evaluation of memory initializers is happening at compile time. |
|  |  | /// This means that the current state of memories is whatever their initial |
|  |  | /// state is, and additionally globals are not available if data segments |
| Expand All | | @@ -640,10 +642,10 @@ pub enum InitMemory<'a> { |
|  |  | /// instance's state. |
|  |  | Runtime { |
|  |  | /// Returns the size, in wasm pages, of the the memory specified. |
|  |  | memory\_size\_in\_pages: &'a dyn Fn(MemoryIndex) -> u64, |
|  |  | memory\_size\_in\_pages: &'a dyn Fn(&mut T, MemoryIndex) -> u64, |
|  |  | /// Returns the value of the global, as a `u64`. Note that this may |
|  |  | /// involve zero-extending a 32-bit global to a 64-bit number. |
|  |  | get\_global\_as\_u64: &'a dyn Fn(GlobalIndex) -> u64, |
|  |  | get\_global\_as\_u64: &'a dyn Fn(&mut T, GlobalIndex) -> u64, |
|  |  | }, |
|  |  | } |
|  |  |  |
| Expand Down | |  |

80 changes: 44 additions & 36 deletions

80
[crates/runtime/src/instance.rs](#diff-e95cf87da8a8dcc08101777a3375ca3e634f0ed6b9f7c5daeec7e73cc4610eaf "crates/runtime/src/instance.rs")

Show comments

[View file](/bytecodealliance/wasmtime/blob/0977952dcd9d482bff7c288868ccb52769b3a92e/crates/runtime/src/instance.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -147,8 +147,14 @@ impl Instance { |
|  |  |  |
|  |  | /// Helper function to access various locations offset from our `\*mut |
|  |  | /// VMContext` object. |
|  |  | unsafe fn vmctx\_plus\_offset<T>(&self, offset: u32) -> \*mut T { |
|  |  | (self.vmctx\_ptr().cast::<u8>()) |
|  |  | unsafe fn vmctx\_plus\_offset<T>(&self, offset: u32) -> \*const T { |
|  |  | (std::ptr::addr\_of!(self.vmctx).cast::<u8>()) |
|  |  | .add(usize::try\_from(offset).unwrap()) |
|  |  | .cast() |
|  |  | } |
|  |  |  |
|  |  | unsafe fn vmctx\_plus\_offset\_mut<T>(&mut self, offset: u32) -> \*mut T { |
|  |  | (std::ptr::addr\_of\_mut!(self.vmctx).cast::<u8>()) |
|  |  | .add(usize::try\_from(offset).unwrap()) |
|  |  | .cast() |
|  |  | } |
| Expand Down  Expand Up | | @@ -183,20 +189,20 @@ impl Instance { |
|  |  |  |
|  |  | /// Return the indexed `VMTableDefinition`. |
|  |  | #[allow(dead\_code)] |
|  |  | fn table(&self, index: DefinedTableIndex) -> VMTableDefinition { |
|  |  | fn table(&mut self, index: DefinedTableIndex) -> VMTableDefinition { |
|  |  | unsafe { \*self.table\_ptr(index) } |
|  |  | } |
|  |  |  |
|  |  | /// Updates the value for a defined table to `VMTableDefinition`. |
|  |  | fn set\_table(&self, index: DefinedTableIndex, table: VMTableDefinition) { |
|  |  | fn set\_table(&mut self, index: DefinedTableIndex, table: VMTableDefinition) { |
|  |  | unsafe { |
|  |  | \*self.table\_ptr(index) = table; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /// Return the indexed `VMTableDefinition`. |
|  |  | fn table\_ptr(&self, index: DefinedTableIndex) -> \*mut VMTableDefinition { |
|  |  | unsafe { self.vmctx\_plus\_offset(self.offsets().vmctx\_vmtable\_definition(index)) } |
|  |  | fn table\_ptr(&mut self, index: DefinedTableIndex) -> \*mut VMTableDefinition { |
|  |  | unsafe { self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_vmtable\_definition(index)) } |
|  |  | } |
|  |  |  |
|  |  | /// Get a locally defined or imported memory. |
| Expand Down  Expand Up | | @@ -238,21 +244,21 @@ impl Instance { |
|  |  | } |
|  |  |  |
|  |  | /// Return the indexed `VMGlobalDefinition`. |
|  |  | fn global(&self, index: DefinedGlobalIndex) -> &VMGlobalDefinition { |
|  |  | fn global(&mut self, index: DefinedGlobalIndex) -> &VMGlobalDefinition { |
|  |  | unsafe { &\*self.global\_ptr(index) } |
|  |  | } |
|  |  |  |
|  |  | /// Return the indexed `VMGlobalDefinition`. |
|  |  | fn global\_ptr(&self, index: DefinedGlobalIndex) -> \*mut VMGlobalDefinition { |
|  |  | unsafe { self.vmctx\_plus\_offset(self.offsets().vmctx\_vmglobal\_definition(index)) } |
|  |  | fn global\_ptr(&mut self, index: DefinedGlobalIndex) -> \*mut VMGlobalDefinition { |
|  |  | unsafe { self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_vmglobal\_definition(index)) } |
|  |  | } |
|  |  |  |
|  |  | /// Get a raw pointer to the global at the given index regardless whether it |
|  |  | /// is defined locally or imported from another module. |
|  |  | /// |
|  |  | /// Panics if the index is out of bound or is the reserved value. |
|  |  | pub(crate) fn defined\_or\_imported\_global\_ptr( |
|  |  | &self, |
|  |  | &mut self, |
|  |  | index: GlobalIndex, |
|  |  | ) -> \*mut VMGlobalDefinition { |
|  |  | if let Some(index) = self.module().defined\_global\_index(index) { |
| Expand All | | @@ -263,18 +269,18 @@ impl Instance { |
|  |  | } |
|  |  |  |
|  |  | /// Return a pointer to the interrupts structure |
|  |  | pub fn runtime\_limits(&self) -> \*mut \*const VMRuntimeLimits { |
|  |  | unsafe { self.vmctx\_plus\_offset(self.offsets().vmctx\_runtime\_limits()) } |
|  |  | pub fn runtime\_limits(&mut self) -> \*mut \*const VMRuntimeLimits { |
|  |  | unsafe { self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_runtime\_limits()) } |
|  |  | } |
|  |  |  |
|  |  | /// Return a pointer to the global epoch counter used by this instance. |
|  |  | pub fn epoch\_ptr(&self) -> \*mut \*const AtomicU64 { |
|  |  | unsafe { self.vmctx\_plus\_offset(self.offsets().vmctx\_epoch\_ptr()) } |
|  |  | pub fn epoch\_ptr(&mut self) -> \*mut \*const AtomicU64 { |
|  |  | unsafe { self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_epoch\_ptr()) } |
|  |  | } |
|  |  |  |
|  |  | /// Return a pointer to the `VMExternRefActivationsTable`. |
|  |  | pub fn externref\_activations\_table(&self) -> \*mut \*mut VMExternRefActivationsTable { |
|  |  | unsafe { self.vmctx\_plus\_offset(self.offsets().vmctx\_externref\_activations\_table()) } |
|  |  | pub fn externref\_activations\_table(&mut self) -> \*mut \*mut VMExternRefActivationsTable { |
|  |  | unsafe { self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_externref\_activations\_table()) } |
|  |  | } |
|  |  |  |
|  |  | /// Gets a pointer to this instance's `Store` which was originally |
| Expand All | | @@ -297,7 +303,7 @@ impl Instance { |
|  |  |  |
|  |  | pub unsafe fn set\_store(&mut self, store: Option<\*mut dyn Store>) { |
|  |  | if let Some(store) = store { |
|  |  | \*self.vmctx\_plus\_offset(self.offsets().vmctx\_store()) = store; |
|  |  | \*self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_store()) = store; |
|  |  | \*self.runtime\_limits() = (\*store).vmruntime\_limits(); |
|  |  | \*self.epoch\_ptr() = (\*store).epoch\_ptr(); |
|  |  | \*self.externref\_activations\_table() = (\*store).externref\_activations\_table().0; |
| Expand All | | @@ -306,7 +312,7 @@ impl Instance { |
|  |  | mem::size\_of::<\*mut dyn Store>(), |
|  |  | mem::size\_of::<[\*mut (); 2]>() |
|  |  | ); |
|  |  | \*self.vmctx\_plus\_offset::<[\*mut (); 2]>(self.offsets().vmctx\_store()) = |
|  |  | \*self.vmctx\_plus\_offset\_mut::<[\*mut (); 2]>(self.offsets().vmctx\_store()) = |
|  |  | [ptr::null\_mut(), ptr::null\_mut()]; |
|  |  |  |
|  |  | \*self.runtime\_limits() = ptr::null\_mut(); |
| Expand All | | @@ -316,7 +322,7 @@ impl Instance { |
|  |  | } |
|  |  |  |
|  |  | pub(crate) unsafe fn set\_callee(&mut self, callee: Option<NonNull<VMFunctionBody>>) { |
|  |  | \*self.vmctx\_plus\_offset(self.offsets().vmctx\_callee()) = |
|  |  | \*self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_callee()) = |
|  |  | callee.map\_or(ptr::null\_mut(), |c| c.as\_ptr()); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -402,7 +408,7 @@ impl Instance { |
|  |  | } |
|  |  |  |
|  |  | /// Return the table index for the given `VMTableDefinition`. |
|  |  | unsafe fn table\_index(&self, table: &VMTableDefinition) -> DefinedTableIndex { |
|  |  | unsafe fn table\_index(&mut self, table: &VMTableDefinition) -> DefinedTableIndex { |
|  |  | let index = DefinedTableIndex::new( |
|  |  | usize::try\_from( |
|  |  | (table as \*const VMTableDefinition) |
| Expand Down  Expand Up | | @@ -515,7 +521,7 @@ impl Instance { |
|  |  | ) { |
|  |  | let type\_index = unsafe { |
|  |  | let base: \*const VMSharedSignatureIndex = |
|  |  | \*self.vmctx\_plus\_offset(self.offsets().vmctx\_signature\_ids\_array()); |
|  |  | \*self.vmctx\_plus\_offset\_mut(self.offsets().vmctx\_signature\_ids\_array()); |
|  |  | \*base.add(sig.index()) |
|  |  | }; |
|  |  |  |
| Expand Down  Expand Up | | @@ -584,7 +590,7 @@ impl Instance { |
|  |  | let func = &self.module().functions[index]; |
|  |  | let sig = func.signature; |
|  |  | let anyfunc: \*mut VMCallerCheckedFuncRef = self |
|  |  | .vmctx\_plus\_offset::<VMCallerCheckedFuncRef>( |
|  |  | .vmctx\_plus\_offset\_mut::<VMCallerCheckedFuncRef>( |
|  |  | self.offsets().vmctx\_anyfunc(func.anyfunc), |
|  |  | ); |
|  |  | self.construct\_anyfunc(index, sig, anyfunc); |
| Expand Down  Expand Up | | @@ -923,40 +929,41 @@ impl Instance { |
|  |  | ) { |
|  |  | assert!(std::ptr::eq(module, self.module().as\_ref())); |
|  |  |  |
|  |  | \*self.vmctx\_plus\_offset(offsets.vmctx\_magic()) = VMCONTEXT\_MAGIC; |
|  |  | \*self.vmctx\_plus\_offset\_mut(offsets.vmctx\_magic()) = VMCONTEXT\_MAGIC; |
|  |  | self.set\_callee(None); |
|  |  | self.set\_store(store.as\_raw()); |
|  |  |  |
|  |  | // Initialize shared signatures |
|  |  | let signatures = self.runtime\_info.signature\_ids(); |
|  |  | \*self.vmctx\_plus\_offset(offsets.vmctx\_signature\_ids\_array()) = signatures.as\_ptr(); |
|  |  | \*self.vmctx\_plus\_offset\_mut(offsets.vmctx\_signature\_ids\_array()) = signatures.as\_ptr(); |
|  |  |  |
|  |  | // Initialize the built-in functions |
|  |  | \*self.vmctx\_plus\_offset(offsets.vmctx\_builtin\_functions()) = &VMBuiltinFunctionsArray::INIT; |
|  |  | \*self.vmctx\_plus\_offset\_mut(offsets.vmctx\_builtin\_functions()) = |
|  |  | &VMBuiltinFunctionsArray::INIT; |
|  |  |  |
|  |  | // Initialize the imports |
|  |  | debug\_assert\_eq!(imports.functions.len(), module.num\_imported\_funcs); |
|  |  | ptr::copy\_nonoverlapping( |
|  |  | imports.functions.as\_ptr(), |
|  |  | self.vmctx\_plus\_offset(offsets.vmctx\_imported\_functions\_begin()), |
|  |  | self.vmctx\_plus\_offset\_mut(offsets.vmctx\_imported\_functions\_begin()), |
|  |  | imports.functions.len(), |
|  |  | ); |
|  |  | debug\_assert\_eq!(imports.tables.len(), module.num\_imported\_tables); |
|  |  | ptr::copy\_nonoverlapping( |
|  |  | imports.tables.as\_ptr(), |
|  |  | self.vmctx\_plus\_offset(offsets.vmctx\_imported\_tables\_begin()), |
|  |  | self.vmctx\_plus\_offset\_mut(offsets.vmctx\_imported\_tables\_begin()), |
|  |  | imports.tables.len(), |
|  |  | ); |
|  |  | debug\_assert\_eq!(imports.memories.len(), module.num\_imported\_memories); |
|  |  | ptr::copy\_nonoverlapping( |
|  |  | imports.memories.as\_ptr(), |
|  |  | self.vmctx\_plus\_offset(offsets.vmctx\_imported\_memories\_begin()), |
|  |  | self.vmctx\_plus\_offset\_mut(offsets.vmctx\_imported\_memories\_begin()), |
|  |  | imports.memories.len(), |
|  |  | ); |
|  |  | debug\_assert\_eq!(imports.globals.len(), module.num\_imported\_globals); |
|  |  | ptr::copy\_nonoverlapping( |
|  |  | imports.globals.as\_ptr(), |
|  |  | self.vmctx\_plus\_offset(offsets.vmctx\_imported\_globals\_begin()), |
|  |  | self.vmctx\_plus\_offset\_mut(offsets.vmctx\_imported\_globals\_begin()), |
|  |  | imports.globals.len(), |
|  |  | ); |
|  |  |  |
| Expand All | | @@ -967,7 +974,7 @@ impl Instance { |
|  |  | // any state now. |
|  |  |  |
|  |  | // Initialize the defined tables |
|  |  | let mut ptr = self.vmctx\_plus\_offset(offsets.vmctx\_tables\_begin()); |
|  |  | let mut ptr = self.vmctx\_plus\_offset\_mut(offsets.vmctx\_tables\_begin()); |
|  |  | for i in 0..module.table\_plans.len() - module.num\_imported\_tables { |
|  |  | ptr::write(ptr, self.tables[DefinedTableIndex::new(i)].vmtable()); |
|  |  | ptr = ptr.add(1); |
| Expand All | | @@ -978,8 +985,8 @@ impl Instance { |
|  |  | // time. Entries in `defined\_memories` hold a pointer to a definition |
|  |  | // (all memories) whereas the `owned\_memories` hold the actual |
|  |  | // definitions of memories owned (not shared) in the module. |
|  |  | let mut ptr = self.vmctx\_plus\_offset(offsets.vmctx\_memories\_begin()); |
|  |  | let mut owned\_ptr = self.vmctx\_plus\_offset(offsets.vmctx\_owned\_memories\_begin()); |
|  |  | let mut ptr = self.vmctx\_plus\_offset\_mut(offsets.vmctx\_memories\_begin()); |
|  |  | let mut owned\_ptr = self.vmctx\_plus\_offset\_mut(offsets.vmctx\_owned\_memories\_begin()); |
|  |  | for i in 0..module.memory\_plans.len() - module.num\_imported\_memories { |
|  |  | let defined\_memory\_index = DefinedMemoryIndex::new(i); |
|  |  | let memory\_index = module.memory\_index(defined\_memory\_index); |
| Expand Down  Expand Up | | @@ -1068,8 +1075,9 @@ impl Instance { |
|  |  | impl Drop for Instance { |
|  |  | fn drop(&mut self) { |
|  |  | // Drop any defined globals |
|  |  | for (idx, global) in self.module().globals.iter() { |
|  |  | let idx = match self.module().defined\_global\_index(idx) { |
|  |  | let module = self.module().clone(); |
|  |  | for (idx, global) in module.globals.iter() { |
|  |  | let idx = match module.defined\_global\_index(idx) { |
|  |  | Some(idx) => idx, |
|  |  | None => continue, |
|  |  | }; |
| Expand Down  Expand Up | | @@ -1182,8 +1190,8 @@ impl InstanceHandle { |
|  |  | } |
|  |  |  |
|  |  | /// Return the table index for the given `VMTableDefinition` in this instance. |
|  |  | pub unsafe fn table\_index(&self, table: &VMTableDefinition) -> DefinedTableIndex { |
|  |  | self.instance().table\_index(table) |
|  |  | pub unsafe fn table\_index(&mut self, table: &VMTableDefinition) -> DefinedTableIndex { |
|  |  | self.instance\_mut().table\_index(table) |
|  |  | } |
|  |  |  |
|  |  | /// Get a table defined locally within this module. |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `0977952`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbytecodealliance%2Fwasmtime%2Fcommit%2F0977952dcd9d482bff7c288868ccb52769b3a92e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


