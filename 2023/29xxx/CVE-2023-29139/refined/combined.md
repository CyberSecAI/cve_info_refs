=== Content from phabricator.wikimedia.org_58f60ba7_20250115_084356.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT326293)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T326293
# CVE-2023-29139: API request timeout - CheckUserLogClosed, Resolved[Public](/policy/explain/PHID-TASK-3nkvmjigfnxqkpwcpbd7/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/326293/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/326293/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Protect as security issue](/wmf/escalate-task/326293/)
* [Award Token](/token/give/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
* [Flag For Later](/flag/edit/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)

Assigned To

|  | [Zabe](/p/Zabe/) |
| --- | --- |

Authored By

|  | [AmandaNP](/p/AmandaNP/) |
| --- | --- |
| Jan 5 2023, 8:23 AM2023-01-05 08:23:46 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [Wikimedia-production-error](/tag/wikimedia-production-error/) [(Jan 2023)](/project/board/1055/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [Vuln-DoS](/tag/vuln-dos/) [(Tracked)](/project/board/1446/)
* [CheckUser](/tag/checkuser/) [(Inbox)](/project/board/203/)
* [MW-1.40-notes (1.40.0-wmf.18; 2023-01-09)](/project/view/6318/)
Referenced Files

|  | [F35993285: 0001-api-Only-add-actor-table-to-table-list-when-querying.patch](/F35993285) |
| --- | --- |
| Jan 5 2023, 11:42 AM2023-01-05 11:42:28 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [AmandaNP](/p/AmandaNP/) |
| --- | --- |

|  | [Dreamy\_Jazz](/p/Dreamy_Jazz/) |
| --- | --- |

|  | [gerritbot](/p/gerritbot/) |
| --- | --- |

|  | [Ladsgroup](/p/Ladsgroup/) |
| --- | --- |

|  | [Legoktm](/p/Legoktm/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

[View All 9 Subscribers](/subscriptions/list/PHID-TASK-3nkvmjigfnxqkpwcpbd7/)
# Description

Reason this is security flagged: I don't know how vulnerable multiple executions of the same API request in the form of a DoS type attack would affect a wikis server status

Error Message 1:

```
{"error":{"code":"internal_api_error_Wikimedia\\RequestTimeout\\RequestTimeoutException","info":"[cb78d894-a1fc-4dec-8329-08d4bfe7985a] Caught exception of type Wikimedia\\RequestTimeout\\RequestTimeoutException","errorclass":"Wikimedia\\RequestTimeout\\RequestTimeoutException"},"servedby":"mw1361"}
```

Error message 2:

```
upstream request timeout
```

Affected Authentications: Logged in with checkuserlog permission

Unaffected: Logged in without checkuserlog permission & logged out

Affected Wikis: Group 0 & Group 1 wikis - on MW 1.40.0-wmf.17

Not affected Wikis: Group 2 wikis - on 1.40.0-wmf.14

Reproduction:

1. Go to a project in which you have checkuserlog abilities
2. make a request to the API CheckUserLog where you expect a non-zero result (could even just be a generic view all CU logs request)

Ways not to reproduce:

1. Specifying parameters where the CU log would have zero enteries - this produces as it should, no results
2. While not logged in OR without the checkuserlog permission - this results in the proper permission denied
# Details

Risk Rating Low Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: api: Only add actor table to table list when querying from it](https://gerrit.wikimedia.org/r/c/905732) | [mediawiki/extensions/CheckUser](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CheckUser) | [REL1\_40](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CheckUser/%2B/REL1_40) | +10 -1 |
|  | [SECURITY: api: Only add actor table to table list when querying from it](https://gerrit.wikimedia.org/r/c/877267) | [mediawiki/extensions/CheckUser](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CheckUser) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CheckUser/%2B/master) | +2 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T326293)
# Related Objects

* Mentions

Mentioned In [T325849: Write and send supplementary release announcement for extensions and skins with security patches (1.35.10/1.38.6/1.39.3)](/T325849) Mentioned Here [T325849: Write and send supplementary release announcement for extensions and skins with security patches (1.35.10/1.38.6/1.39.3)](/T325849)
### Event Timeline

[AmandaNP](/p/AmandaNP/) created this task.[Jan 5 2023, 8:23 AM2023-01-05 08:23:46 (UTC+0)](#8500847)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  Â· [View Herald Transcript](/herald/transcript/5114273/)[Jan 5 2023, 8:23 AM2023-01-05 08:23:48 (UTC+0)](#8500857)[AmandaNP](/p/AmandaNP/) added a parent task: [T325580: 1.40.0-wmf.17 deployment blockers](/T325580).[Jan 5 2023, 8:24 AM2023-01-05 08:24:32 (UTC+0)](#8500858)[AmandaNP](/p/AmandaNP/) added a project: [Wikimedia-production-error](/tag/wikimedia-production-error/).[Ladsgroup](/p/Ladsgroup/) added a subscriber: [Zabe](/p/Zabe/).[Jan 5 2023, 11:24 AM2023-01-05 11:24:04 (UTC+0)](#8501109)

[taavi](/p/taavi/) triaged this task as Unbreak Now! priority.[Jan 5 2023, 11:33 AM2023-01-05 11:33:49 (UTC+0)](#8501122)[taavi](/p/taavi/) subscribed.Comment Actions

(as a train blocker)

[Zabe](/p/Zabe/) added a comment.[Jan 5 2023, 11:42 AM2023-01-05 11:42:28 (UTC+0)](#8501142)Comment Actions

0001-api-Only-add-actor-table-to-table-list-when-querying.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/jw6gwfn2wytyn2nowuet/PHID-FILE-coiwbwmturvlothkfgqe/0001-api-Only-add-actor-table-to-table-list-when-querying.patch)

[Ladsgroup](/p/Ladsgroup/) subscribed.[Jan 5 2023, 11:52 AM2023-01-05 11:52:14 (UTC+0)](#8501171)Comment Actions

I was about to suggest:

you can do something much simpler:

instead of:

```
+			$this->addTables( [ 'actor' ] );
 			$this->addJoinConds( [ 'actor' => [ 'JOIN', 'actor_id=cul_actor' ] ] );
```

do:

```
			$this->addJoin( 'actor', null, 'actor_id=cul_actor' );
```

But it Api class doesn't support it which baffling to me :/ to be fixed later.

[Ladsgroup](/p/Ladsgroup/) added a comment.[Jan 5 2023, 11:53 AM2023-01-05 11:53:48 (UTC+0)](#8501172)Comment Actions

This is good to go IMO.

It can get deployed and then immediately added to gerrit. It was introduced recently so it shouldn't be in any release branch.

[Ladsgroup](/p/Ladsgroup/) added a comment.[Jan 5 2023, 12:37 PM2023-01-05 12:37:17 (UTC+0)](#8501272)Comment Actions

It is deployed so it shouldn't block the train anymore. I'll double check with secteam and then push it to gerrit and close this.

[Ladsgroup](/p/Ladsgroup/) removed a parent task: [T325580: 1.40.0-wmf.17 deployment blockers](/T325580).[Jan 5 2023, 12:37 PM2023-01-05 12:37:30 (UTC+0)](#8501273)[thcipriani](/p/thcipriani/) moved this task from [Untriaged](/project/board/1055/) to [Jan 2023](/project/board/1055/) on the [Wikimedia-production-error](/tag/wikimedia-production-error/) board.[Jan 5 2023, 5:04 PM2023-01-05 17:04:55 (UTC+0)](#8502196)[sbassett](/p/sbassett/) added projects: [SecTeam-Processed](/tag/secteam-processed/), [Vuln-DoS](/tag/vuln-dos/).[Jan 5 2023, 5:20 PM2023-01-05 17:20:22 (UTC+0)](#8502232)[sbassett](/p/sbassett/) moved this task from [Incoming](/project/board/1179/) to [Watching](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[sbassett](/p/sbassett/) subscribed.Comment Actions

Hey [@Ladsgroup](/p/Ladsgroup/) [@taavi](/p/taavi/) [@Zabe](/p/Zabe/) -

Thanks for the quick response here. It looks like this made it to 1.40.0-wmf.17 but not 1.40.0-wmf.14, which is still where group 2 is for a little while, if I'm not mistaken. If there aren't concerns about this vuln shortly existing there for a bit, then I suppose we don't need to worry about 1.40.0-wmf.14.

SAL entry: <https://sal.toolforge.org/log/LTTqgYUBa_6PSCT9o6gu>

> It can get deployed and then immediately added to gerrit. It was introduced recently so it shouldn't be in any release branch.

This looks to be the bad change set? <https://gerrit.wikimedia.org/r/871259>. It's fine to backport the security patch ASAP anyways, now that it's patched in production, as CU isn't [bundled](https://www.mediawiki.org/wiki/Bundled_extensions_and_skins). We can also track it for the next supplemental release at [T325849](/T325849).

Thanks again.

[sbassett](/p/sbassett/) changed the task status from Open to In Progress.[Jan 5 2023, 5:22 PM2023-01-05 17:22:14 (UTC+0)](#8502238)[sbassett](/p/sbassett/) lowered the priority of this task from Unbreak Now! to Medium.[sbassett](/p/sbassett/) mentioned this in [T325849: Write and send supplementary release announcement for extensions and skins with security patches (1.35.10/1.38.6/1.39.3)](/T325849).[Zabe](/p/Zabe/) added a comment.[Jan 5 2023, 5:34 PM2023-01-05 17:34:25 (UTC+0)](#8502276)Comment Actions
> In [T326293#8502232](/T326293#8502232), [@sbassett](/p/sbassett/) wrote:
>
> Thanks for the quick response here. It looks like this made it to 1.40.0-wmf.17 but not 1.40.0-wmf.14, which is still where group 2 is for a little while, if I'm not mistaken. If there aren't concerns about this vuln shortly existing there for a bit, then I suppose we don't need to worry about 1.40.0-wmf.14.

The causing patch itself only made it into 1.40.0-wmf.17, so 1.40.0-wmf.14 is not affected by the vuln.

[sbassett](/p/sbassett/) added a comment.[Jan 5 2023, 5:35 PM2023-01-05 17:35:24 (UTC+0)](#8502280)Comment Actions
> In [T326293#8502276](/T326293#8502276), [@Zabe](/p/Zabe/) wrote:
>
> The causing patch itself only made it into 1.40.0-wmf.17, so 1.40.0-wmf.14 is not affected by the vuln.

Ah, missed that, thanks!

[Zabe](/p/Zabe/) added a project: [CheckUser](/tag/checkuser/).[Jan 5 2023, 8:16 PM2023-01-05 20:16:27 (UTC+0)](#8502876)[Zabe](/p/Zabe/) added a subscriber: [gerritbot](/p/gerritbot/).[Jan 9 2023, 10:00 PM2023-01-09 22:00:56 (UTC+0)](#8511124)[gerritbot](/p/gerritbot/) added a comment.[Jan 9 2023, 10:04 PM2023-01-09 22:04:48 (UTC+0)](#8511135)Comment Actions

Change 877267 had a related patch set uploaded (by Zabe; author: Zabe):

[mediawiki/extensions/CheckUser@master] SECURITY: api: Only add actor table to table list when querying from it

<https://gerrit.wikimedia.org/r/877267>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Jan 9 2023, 10:04 PM2023-01-09 22:04:51 (UTC+0)](#8511136)[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[Jan 9 2023, 10:17 PM2023-01-09 22:17:45 (UTC+0)](#8511151)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-rlrctmlaqqq77pw/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-fzslhxmmjonyo4p/)" to "All Users".[sbassett](/p/sbassett/) changed Risk Rating from N/A to Low.[Dreamy\_Jazz](/p/Dreamy_Jazz/) subscribed.[Jan 9 2023, 10:19 PM2023-01-09 22:19:56 (UTC+0)](#8511158)Comment Actions

Apologies for not catching that in my review. Thanks for the quick response everyone.

[gerritbot](/p/gerritbot/) added a comment.[Jan 9 2023, 10:21 PM2023-01-09 22:21:13 (UTC+0)](#8511167)Comment Actions

Change 877267 **merged** by jenkins-bot:

[mediawiki/extensions/CheckUser@master] SECURITY: api: Only add actor table to table list when querying from it

<https://gerrit.wikimedia.org/r/877267>

[Zabe](/p/Zabe/) closed this task as Resolved.[Jan 9 2023, 10:22 PM2023-01-09 22:22:10 (UTC+0)](#8511176)[Zabe](/p/Zabe/) claimed this task.[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Jan 9 2023, 10:32 PM2023-01-09 22:32:02 (UTC+0)](#8511242)[sbassett](/p/sbassett/) moved this task from [Watching](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jan 9 2023, 10:35 PM2023-01-09 22:35:37 (UTC+0)](#8511251)[ReleaseTaggerBot](/p/ReleaseTaggerBot/) added a project: [MW-1.40-notes (1.40.0-wmf.18; 2023-01-09)](/project/view/6318/).[Jan 9 2023, 11:00 PM2023-01-09 23:00:48 (UTC+0)](#8511286)[mmartorana](/p/mmartorana/) renamed this task from API request timeout - CheckUserLog to CVE-2023-29139: API request timeout - CheckUserLog.[Apr 3 2023, 3:19 PM2023-04-03 15:19:01 (UTC+0)](#8750928)[gerritbot](/p/gerritbot/) added a comment.[Apr 4 2023, 7:51 PM2023-04-04 19:51:29 (UTC+0)](#8756482)Comment Actions

Change 905732 had a related patch set uploaded (by SBassett; author: Zabe):

[mediawiki/extensions/CheckUser@REL1\_40] SECURITY: api: Only add actor table to table list when querying from it

<https://gerrit.wikimedia.org/r/905732>

[gerritbot](/p/gerritbot/) added a project: [Patch-For-Review](/tag/patch-for-review/).[Apr 4 2023, 7:51 PM2023-04-04 19:51:29 (UTC+0)](#8756483)[gerritbot](/p/gerritbot/) added a comment.[Apr 4 2023, 8:01 PM2023-04-04 20:01:54 (UTC+0)](#8756552)Comment Actions

Change 905732 **abandoned** by SBassett:

[mediawiki/extensions/CheckUser@REL1\_40] SECURITY: api: Only add actor table to table list when querying from it

Reason:

Already on 1.40

<https://gerrit.wikimedia.org/r/905732>

[Maintenance\_bot](/p/Maintenance_bot/) removed a project: [Patch-For-Review](/tag/patch-for-review/).[Apr 4 2023, 8:12 PM2023-04-04 20:12:00 (UTC+0)](#8756616)[Dreamy\_Jazz](/p/Dreamy_Jazz/) added a comment.Edited Â· [Apr 4 2023, 8:12 PM2023-04-04 20:12:24 (UTC+0)](#8756619)Comment Actions

The CVE description is wrong here. This problem was never present in any release of 1.39. The only versions this was an issue in were specific 1.40-wmf.\* branches and the master branch as far as I remember. Can this be updated ([@sbassett](/p/sbassett/))? Maybe using 1.40-alpha as the version would work here?

[Legoktm](/p/Legoktm/) subscribed.[Apr 4 2023, 8:14 PM2023-04-04 20:14:26 (UTC+0)](#8756627)Comment Actions

If it was never in a stable release the CVE should just be retracted.

[Dreamy\_Jazz](/p/Dreamy_Jazz/) added a comment.[Apr 4 2023, 8:16 PM2023-04-04 20:16:07 (UTC+0)](#8756647)Comment Actions
> In [T326293#8756627](/T326293#8756627), [@Legoktm](/p/Legoktm/) wrote:
>
> If it was never in a stable release the CVE should just be retracted.

From what I can tell, this was never in a stable release, so as long as I've not missed something I think that should be done.

[sbassett](/p/sbassett/) added a comment.[Apr 4 2023, 8:42 PM2023-04-04 20:42:55 (UTC+0)](#8756796)Comment Actions
> In [T326293#8756619](/T326293#8756619), [@Dreamy\_Jazz](/p/Dreamy_Jazz/) wrote:
>
> The CVE description is wrong here. This problem was never present in any release of 1.39. The only versions this was an issue in were specific 1.40-wmf.\* branches and the master branch as far as I remember. Can this be updated ([@sbassett](/p/sbassett/))? Maybe using 1.40-alpha as the version would work here?

I can send an update or retraction to Mitre. I could go either way, tbh. For the supplemental release, where ext:CheckUser security issues land, the bar is pretty low and we often still request CVEs for things that just land on master, which [this did](https://gerrit.wikimedia.org/r/877267). But yes, the bug was quickly introduced and quickly fixed, so it might be too inconsequential even for that.

Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. Â· [Wikimedia Foundation](https://wikimediafoundation.org/) Â· [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) Â· [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) Â· [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) Â· [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) Â· [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) Â· [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) Â· [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)
