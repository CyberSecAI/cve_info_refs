=== Content from bugzilla.mozilla.org_0c273c3d_20250115_091433.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1685403)
* [XML](/show_bug.cgi?ctype=xml&id=1685403)

Closed
[Bug 1685403](/show_bug.cgi?id=1685403)
(CVE-2023-29538)

Opened 4 years ago
Closed 2 years ago

# onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///

## Categories

### (Core :: Networking, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking#Networking)

Networking
▾

Core :: Networking
For bugs in Mozilla's modular networking library (aka "Netlib" or "Necko".) The networking library supplies the software interface that Mozilla uses to access physical transports (e.g. the Internet and local drives), perform URL resolutions, and handle a variety of networking protocols.

Examples of appropriate bugs: URLs with backslash not fetched; URLs starting with a single slash turn into http:///; Cannot access authenticated FTP site.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Android

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

112 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix) |
| firefox110 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=wontfix) |
| firefox111 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix) |
| firefox112 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | wontfix |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox110 |  | wontfix |
| firefox111 |  | wontfix |
| firefox112 |  | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: agi, Assigned: kershaw)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/608e04ebca94be52b05c003d51d43e07?d=mm&size=40)  [kershaw](/user_profile?user_id=505624)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/2f23a572bdd06777026ab2c155cfe0c0?d=mm&size=40)  [agi](/user_profile?user_id=421286)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/ae002109ba1cfbb7f5ad990cc5d9fbaf?d=mm&size=40)  [jesup](/user_profile?user_id=11539)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

24 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=1685403&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1685403)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL")

[github.com/mozilla-mobile/fenix/issue...](https://github.com/mozilla-mobile/fenix/issues/17321 "https://github.com/mozilla-mobile/fenix/issues/17321")

[github.com/mozilla-mobile/android-com...](https://github.com/mozilla-mobile/android-components/pull/9381 "https://github.com/mozilla-mobile/android-components/pull/9381")

## Details

### (Keywords: csectype-disclosure, sec-moderate, Whiteboard: [necko-triaged][necko-priority-queue][post-critsmash-triage][adv-main112+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-29538

[Keywords:](/describekeywords.cgi)

[csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[necko-triaged][necko-priority-queue][post-critsmash-triage][adv-main112+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [ohorvath](/user_profile?user_id=585566) | [qe-verify](#c47 "2 years ago") | - |
| --- | --- | --- |
| [ohorvath](/user_profile?user_id=585566) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 2 obsolete files)

| [webRequest-redirect-to-extension-2.zip](/attachment.cgi?id=9196443)  [4 years ago](#c1)  [Rob Wu [:robwu]](/user_profile?user_id=447061)   1.57 KB, application/zip |  | [Details](/attachment.cgi?id=9196443&action=edit) |
| --- | --- | --- |
| [Bug 1685403 - Add linter to check using GetURI, r=#necko](/attachment.cgi?id=9308231)  [2 years ago](#c36)  [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9308231&action=edit) | [Review](/attachment.cgi?id=9308231) |
| [Bug 1685403 - Use NS\_GetFinalChannelURI at some places, r=#necko](/attachment.cgi?id=9308232)  [2 years ago](#c37)  [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9308232&action=edit) | [Review](/attachment.cgi?id=9308232) |
| [Bug 1685403 - Use NS\_GetFinalChannelURI at some places, r=#necko](/attachment.cgi?id=9317357)  [2 years ago](#c43)  [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9317357&action=edit) | [Review](/attachment.cgi?id=9317357) |
| [advisory.txt](/attachment.cgi?id=9327529)  [2 years ago](#c48)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   291 bytes, text/plain |  | [Details](/attachment.cgi?id=9327529&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1685403#c0)• 4 years ago |
|  | |

From github: <https://github.com/mozilla-mobile/fenix/issues/17321>.

> ## Steps to reproduce
>
> 1. Install HTTPS Everywhere for Firefox Android
> 2. Go to Add-Ons Menu for HTTPS Everywhere
> 3. Toggle "ON" for Encrypt All Sites Eligible setting
> 4. Navigate to an insecure page with no HTTPS support, such as <http.badssl.com>
>
> ### Expected behavior
>
> Display EASE mode page for insecure sites:
>
>
> ### Actual behavior
>
> Redirects to an error page with am unfamiliar prefix that I assume is browser based:
>
>
> URL:
>
> `jar:file:///data/user/0/org.mozilla.fenix/files/mozilla/p4a5m9oi.default/extensions/https-everywhere@eff.org.xpi!/pages/cancel/index.html?originURL=http%3A%2F%2Fhttp.badssl.com%2F`
>
> Console Output during this time:
>
> [console-export-2021-1-5\_16-5-27.txt](https://github.com/mozilla-mobile/fenix/files/5773285/console-export-2021-1-5_16-5-27.txt)
>
> When I turn HTTPSE EASE mode off and then back on, this strange error occurs where it tries to navigate to the extension's EASE interstitial but the extension's assets URIs get remapped to the insecure link's URI. Breaking scripts and other assets that need to be loaded for the page:
>
>
> Console error:
>
> ```
> 16:06:27.251 Loading failed for the <script> with source “http://http.badssl.com/translation.js”. http.badssl.com:28:1
> 16:06:27.326 Loading failed for the <script> with source “http://http.badssl.com/util.js”. http.badssl.com:29:1
> 16:06:27.379 Loading failed for the <script> with source “http://http.badssl.com/ux.js”. http.badssl.com:30:1
>
> ```
>
> [console-export-2021-1-5\_16-6-48.txt](https://github.com/mozilla-mobile/fenix/files/5773289/console-export-2021-1-5_16-6-48.txt)
>
> ### Device information
>
> Reported across at least two devices, with different builds of Fenix (Stable and Nightly) but I will just give my specs
>
> * Android device:
>
>   Pixel 3a, Android 11, Build RQ1A.201205.003
> * Fenix version:
>
>   Nightly 210104 19:29 (Build #2015785435)
>
>   AC: 71.0.20210104143130, 3790c3ac2
>
>   GV: 86.0a1-20210103092941
>
>   AS: 67.2.0
>
> Note: I am the lead developer on the HTTPS Everywhere project and if there is something that can help guide me to take care of this error on my end, feel free to to speak to that. I am personally stuck debugging this error and can't seem to find the trigger point for this error.

Change performed by the [Move to Bugzilla add-on](https://addons.mozilla.org/en-US/firefox/addon/move-to-bugzilla/).

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a69647_421286)• 4 years ago |

Component: Extensions → AndroidProduct: GeckoView → WebExtensions

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a411073_447061)• 4 years ago |

Flags: needinfo?(rob)

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1685403#c1)• 4 years ago |
| str | |

Attached file
[webRequest-redirect-to-extension-2.zip](attachment.cgi?id=9196443)
— [Details](attachment.cgi?id=9196443&action=edit)

It seems that navigations triggered from the location bar are handled incorrectly. The correct resource is loaded, but the loaded resource is associated with the URL of the original load, AND an attempt is made to load the internal (file/resource) URL too (in an external app).

### Steps to reproduce (STR)

1. Extract attached extension to a directory, cd that directory.
2. Attach an Android device or start an Android emulator, with Fenix installed.
3. Run `web-ext run -t firefox-android` to see the device ID.
4. Run `web-ext run -t firefox-android --android-device=DEVICE_ID_HERE` to run Fenix with the extension (add `--firefox-apk org.mozilla.fenix` if needed to select a specific Fenix (Nightly) app)
5. Tap on the Menu, "Add-ons" to open the add-on manager. Tap on the "Redirect redir to extension page" extension to view its options. Enable the "Run in private browsing" option.

   (private browsing is not strictly necessary for the STR but will helpfully add another prompt later)
6. Open any web page in a private browsing tab, tap on the Menu, Add-ons. In the submenu that opens, tap on "Redirect redir to extension page" to trigger the extension.

   (the extension has a `browserAction.onClicked` listener that calls `tabs.create` to open a new tab)

   (the extension will open `https://example.com/redir` , intercept the request and redirect to a page bundled with the extension)
7. For comparison, focus the location bar, enter `https://example.net/redir` and try to visit it.

### Expected

* Step 7 should result in exactly the same behavior as step 6. The page's URL should start with `moz-extension:` and the content area should show

```
This URL: moz-extension://[uuid]/subdir/test.html
This base URL: moz-extension://[uuid]/subdir/test.html
Subresource loaded: yes

```
### Actual

* Step 7's location bar shows `example.com/redir`, with a dialog containing following title/text appears: "Open in app? Your activity may no longer be private" `jar:file://some/path/to/extension.xpi!/subdir/test.html`
* The content area shows that the redirection target is actually loaded in the content area, but with the wrong document URL. The content area contains:

```
This URL: https://example.com/redir
This base URL: https://example.com/redir
Subresource loaded: no

```

* Relative URLs in the extension page were resolved relative to the website's base URL. "Subresource loaded: no" in the content area means that the script subresource could not be loaded. With the network tab of the developer tools (via `about:debugging` from desktop Firefox), I can confirm that the page attempted to load the subresource, relative to `https://example.com` instead of the `moz-extension:`-URL).

This is a worrisome issue, as it could potentially result in leakage of static extension information (i.e. paths to extension subresources) (and/or URL parameters) to the domain that was redirected by the extension.

Flags: needinfo?(rob)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1685403#c2)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1685403&comment_id=15211698 "2 revisions") |
|  | |

Thanks for the investigation Rob!

I think what's happening here is that AC looks at the `jar:` URI and thinks it's something the browser cannot load and then tries to send it to an external app, although now I'm wondering if this is the right behavior? I thought we only did that for very specific types of URIs? This sounds like it might be problematic.

:csadilek do you have opinions about this ^ ?

As to fix this we should probably send the `moz-extension` URI instead of the `jar` URI in `onLoadRequest`.

Assignee: nobody → agiGroup: mobile-core-securityComponent: Android → GeneralProduct: WebExtensions → GeckoView

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a431734_421286)• 4 years ago |

Group: mobile-core-security

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1685403#c3)• 4 years ago |
|  | |

ni for [Comment 2](/show_bug.cgi?id=1685403#c2 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///")

Flags: needinfo?(csadilek)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1685403#c4)• 4 years ago |
|  | |

(In reply to Agi Sferro | :agi | ni? for questions | ⏰ PST | he/him from [comment #2](/show_bug.cgi?id=1685403#c2 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> As to fix this we should probably send the `moz-extension` URI instead of the `jar` URI in `onLoadRequest`.

Looks like we're getting this URI from `DocumentChannel` directly here: <https://searchfox.org/mozilla-central/rev/31ddf859c57e812878a5f817e4097efb06de4d97/netwerk/ipc/DocumentLoadListener.cpp#579>

So to recap the problem here is that a load involving a `moz-extension://...` URI triggers a `onLoadRequest` call with the translated `jar:file:///` URI which confuses the front-end.

Would it be possible to keep the `moz-extension:...` URI here? at least as `displaySpec`.

Component: General → DOM: NavigationProduct: GeckoView → Core

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a432722_421286)• 4 years ago |

Summary: [Bug] HTTPS Everywhere Extension Page Inexplicably Blocked → onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1685403#c5)• 4 years ago |
|  | |

(In reply to Agi Sferro | :agi | ni? for questions | ⏰ PST | he/him from [comment #4](/show_bug.cgi?id=1685403#c4 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> Looks like we're getting this URI from `DocumentChannel` directly here: <https://searchfox.org/mozilla-central/rev/31ddf859c57e812878a5f817e4097efb06de4d97/netwerk/ipc/DocumentLoadListener.cpp#579>
>
> So to recap the problem here is that a load involving a `moz-extension://...` URI triggers a `onLoadRequest` call with the translated `jar:file:///` URI which confuses the front-end.

I don't think that this recap is complete. As my STR in [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") shows, it's not merely a problem of the app trying to open the internal URL,

but also associating the loaded content with the wrong pre-redirect URL. That is very concerning, bordering on the edge of a sec issue.

If I use `window.open` to open a same-origin URL, and that URL is redirected to the extension page, then the same-origin URL is able to read the resulting HTML. Such pages were already public anyway via `web_accessible_resources`, but the content / origin / URL mixup is still very concerning.

FWIW, the internal URL is generated via `SubstitutingProtocolHandler::ResolveURI`, which calls into `ExtensionProtocolHandler.cpp`. The actual content is loaded via <https://searchfox.org/mozilla-central/rev/014fe72eaba26dcf6082fb9bbaf208f97a38594e/netwerk/protocol/res/ExtensionProtocolHandler.cpp#479>

[bug 1645264](/show_bug.cgi?id=1645264 "RESOLVED FIXED - Using redirectUrl to a moz-extension URL in a webRequest.onBeforeRequest works on GVE and desktop, but not Fenix") had added a test case for `redirectUrl` in `webRequest.onBeforeRequest`, but that only tested subresources. Document loads have a different code path and should also have unit tests. Navigations triggered via `location.href` assignment have the same issue, only navigations from `browser.tabs.create` result in the expected behavior.

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1685403#c6)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1685403&comment_id=15212747 "1 revision") |
|  | |

(In reply to Rob Wu [:robwu] from [comment #5](/show_bug.cgi?id=1685403#c5 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> (In reply to Agi Sferro | :agi | ni? for questions | ⏰ PST | he/him from [comment #4](/show_bug.cgi?id=1685403#c4 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))
>
> > Looks like we're getting this URI from `DocumentChannel` directly here: <https://searchfox.org/mozilla-central/rev/31ddf859c57e812878a5f817e4097efb06de4d97/netwerk/ipc/DocumentLoadListener.cpp#579>
> >
> > So to recap the problem here is that a load involving a `moz-extension://...` URI triggers a `onLoadRequest` call with the translated `jar:file:///` URI which confuses the front-end.
>
> I don't think that this recap is complete. As my STR in [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") shows, it's not merely a problem of the app trying to open the internal URL,
>
> but also associating the loaded content with the wrong pre-redirect URL. That is very concerning, bordering on the edge of a sec issue.

Oh I missed this part! This *is* a security issue:

> ```
> The content area shows that the redirection target is actually loaded in the content area, but with the wrong document URL. The content area contains:
>
> ```
>
> This URL: <https://example.com/redir>
>
> This base URL: <https://example.com/redir>
>
> Subresource loaded: no

Am I reading this correctly that the web page thinks it's loaded from `https://example.com/redir` but it's actually loading from an `moz-extension` page? Could you do this, say, with `google.com` or `bankingwebsite.com` and pretend you're somebody you're not? (and worse, read the cookies?)

Restricting for now.

Group: core-security

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a500627_406194)• 4 years ago |

Group: core-security → dom-core-security

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1685403#c7)• 4 years ago |
|  | |

(In reply to Agi Sferro | :agi | ni? for questions | ⏰ PST | he/him from [comment #6](/show_bug.cgi?id=1685403#c6 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> Am I reading this correctly that the web page thinks it's loaded from `https://example.com/redir` but it's actually loading from an `moz-extension` page?

Yes.

> Could you do this, say, with `google.com` or `bankingwebsite.com` and pretend you're somebody you're not? (and worse, read the cookies?)

I don't know the underlying cause, so I cannot tell. The STR that I use relies on a redirect from extensions to a moz-extension:-URL; redirects to a http(s):-URL work as expected.

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1685403#c8)• 4 years ago |
|  | |

(In reply to Rob Wu [:robwu] from [comment #7](/show_bug.cgi?id=1685403#c7 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> I don't know the underlying cause, so I cannot tell. The STR that I use relies on a redirect from extensions to a moz-extension:-URL; redirects to a http(s):-URL work as expected.

I mean you can just replace `example.com` with `google.com` and just as easily pretend to be a `google.com` page. It looks like you can access cookies too (via `document.cookie`) not sure if you can construct an extension that is not supposed to see cookies though and still be able to read `document.cookie` this way.

|  | [Christian Sadilek [:csadilek]](/user_profile?user_id=590895) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1685403#c9)• 4 years ago |
|  | |

> I thought we only did that for very specific types of URIs? This sounds like it might be problematic. :csadilek do you have opinions about this ^ ?

App Links functionality in Fenix uses a block list, not an allow list for specific apps. I verified that adding `jar` to the block list fixes the issue Rob describes above. So, let's do that today as a first step.

The exact flow here is that Fenix doesn't recognize `jar` as a supported scheme by the engine, verifies it isn't blocked and tries to find an app that supports it. As it doesn't find an app that can handle it, it falls back to loading which it also shouldn't do...and won't once blocked.

> As to fix this we should probably send the moz-extension URI instead of the jar URI in onLoadRequest.

Yes, we'd need that as for other recent security issues we decided not to allow load `jar://` but we can revisit if that's not feasible for you.

Flags: needinfo?(csadilek)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1685403#c10)• 4 years ago |
|  | |

Note: there's no way to exploit this in Fenix stable because we only allow a limited set of trusted extensions.

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a511303_421286)• 4 years ago |

Assignee: agi → nobody

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1685403#c11)• 4 years ago |
|  | |

(In reply to Christian Sadilek [:csadilek] from [comment #9](/show_bug.cgi?id=1685403#c9 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> The exact flow here is that Fenix doesn't recognize `jar` as a supported scheme by the engine, verifies it isn't blocked and tries to find an app that supports it. As it doesn't find an app that can handle it, it falls back to loading which it also shouldn't do...and won't once blocked.

There is more going on than described here. What you're describing looks like a plausible explanation for the first bullet point of "Actual" in my STR of [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") (i.e. the "Open in app? Your activity may no longer be private" dialog).

It does not explain the second+third bullet points from "Actual" in [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///").

(In reply to Agi Sferro | :agi | ni? for questions | ⏰ PST | he/him from [comment #8](/show_bug.cgi?id=1685403#c8 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> It looks like you can access cookies too (via `document.cookie`) not sure if you can construct an extension that is not supposed to see cookies though and still be able to read `document.cookie` this way.

Extensions can only redirect requests if they have host permissions to access the website, so there is no privilege escalation there.

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1685403#c12)• 4 years ago |
|  | |

(added reporter of issue on Github to cc so they can follow this bug.)

Extensions can work around this issue in some cases. For requests of top-level documents, cancel the request with `{cancel: true}` and use `browser.tabs.update` to replace the document with the moz-extension:-document. Make sure to check that `details.frameId` is `0` to not inadvertently replace top-level documents for navigations in child frames.

|  | [Christian Sadilek [:csadilek]](/user_profile?user_id=590895) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1685403#c13)• 4 years ago |
|  | |

(In reply to Rob Wu [:robwu] from [comment #11](/show_bug.cgi?id=1685403#c11 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> There is more going on than described here. What you're describing looks like a plausible explanation for the first bullet point of "Actual" in my STR of [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") (i.e. the "Open in app? Your activity may no longer be private" dialog).
>
> It does not explain the second+third bullet points from "Actual" in [comment 1](/show_bug.cgi?id=1685403#c1 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///").

Yes, that's because there are a few different things going on here:

1. Fenix shouldn't interpret `jar://` URLs as app links (links to be opened in external apps)
2. Fenix shouldn't fall back to loading app links via Gecko in case of errors opening external apps

These two are fixed now on master and will roll into tomorrow's Fenix Nightly. I've verified that the original problem (<https://github.com/mozilla-mobile/fenix/issues/17321>) is fixed by this and also that the security problem you mentioned above no longer reproduces using your test extension.

3. Load requests for `moz-extension://` pages should not be forward to embedders/apps as `jar:file://` URLs
4. Load requests "denied" by the embedder/app (to indicate customized hanlding) leave the session in an invalid state

Agi has all context about 3. and 4. :)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a518795_421286)• 4 years ago |

Depends on: [1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state")

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1685403#c14)• 4 years ago |
|  | |

(In reply to Christian Sadilek [:csadilek] from [comment #13](/show_bug.cgi?id=1685403#c13 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

This is getting a little bit confusing so I'm spinning off 4) from this bug, we can do 3) here.

> 3. Load requests for `moz-extension://` pages should not be forward to embedders/apps as `jar:file://` URLs

This is pretty straightforward, [`onLoadRequest`](https://searchfox.org/mozilla-central/source/netwerk/ipc/DocumentLoadListener.cpp#579) should not contain the internal `jar:file://` representation as that doesn't really represent what the browser is trying to load, and `moz-extension` should be used instead.

> 4. Load requests "denied" by the embedder/app (to indicate customized hanlding) leave the session in an invalid state

Opened [Bug 1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state") for that.

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1685403#c15)• 4 years ago |
|  | |

I suppose that we can mark this as fixed by <https://github.com/mozilla-mobile/android-components/pull/9381> ?

No longer depends on: [1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state")

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1685403#c16)• 4 years ago |
|  | |

I didn't mean to remove the dependency. Bugzilla did it.

Depends on: [1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state")

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1685403#c17)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1685403&comment_id=15213441 "1 revision") |
|  | |

(In reply to Rob Wu [:robwu] from [comment #15](/show_bug.cgi?id=1685403#c15 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> I suppose that we can mark this as fixed by <https://github.com/mozilla-mobile/android-components/pull/9381> ?

Even after the AC fix there's still this problem (which is the subject of this bug)

> > ```
> >    Load requests for moz-extension:// pages should not be forward to embedders/apps as jar:file:// URLs
> >
> > ```

> This is pretty straightforward, onLoadRequest should not contain the internal jar:file:// representation as that doesn't really represent what the browser is trying to load, and moz-extension should be used instead.

|  | [alexis](/user_profile?user_id=677475) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1685403#c18)• 4 years ago |
|  | |

(In reply to Rob Wu [:robwu] from [comment #12](/show_bug.cgi?id=1685403#c12 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> (added reporter of issue on Github to cc so they can follow this bug.)
>
> Extensions can work around this issue in some cases. For requests of top-level documents, cancel the request with `{cancel: true}` and use `browser.tabs.update` to replace the document with the moz-extension:-document. Make sure to check that `details.frameId` is `0` to not inadvertently replace top-level documents for navigations in child frames.

Thank you for mentioning, this. In our workflow, we do set cancel to `{cancel: true}`, but I will double check the workflow.

To understand what happened.

1. The `onLoadRequest` that was triggered by the extension
2. Here is where I lose context...but somehow that request was forwarded to load an internal URI
3. And then in turn Fenix tried to load with the extension's sources with the pre-redirect URI

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a608829_1689)• 4 years ago |

Keywords: [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Neha Kochar [:neha]](/user_profile?user_id=627348) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1685403#c19)• 4 years ago |
|  | |

Agi, could you please summarize which parts of this are fixed, and what's left? And is the current state still a sec issue?

Flags: needinfo?(agi)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1685403#c20)• 4 years ago |
|  | |

The problem that's still a bug here is that [`onLoadRequest`](https://searchfox.org/mozilla-central/rev/294f10eff7398d6b05beac6aa256d86ac3cb7113/netwerk/ipc/DocumentLoadListener.cpp#653) is called with a `jar:file:` URL instead of the original `moz-extension:` URL.

It could cause a security vulnerability since it deals with URLs and could confuse the front-end, but the one reported in this bug was fixed.

Flags: needinfo?(agi)

|  | [Anny Gakhokidze [:annyG]](/user_profile?user_id=618050) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a24195821_618050)• 3 years ago |

Severity: -- → S2

|  | [Hsin-Yi Tsai (she/her) [:hsinyi]](/user_profile?user_id=434964) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1685403#c21)• 3 years ago |
|  | |

Hi Agi,

I talked with Andreas about this. And we thought this may have been fixed by [bug 1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state"). Could you kindly test and confirm? Thank you.

Flags: needinfo?(agi)

|  | [[ex-Mozilla] Agi Sferro | :agi](/user_profile?user_id=421286)  Reporter |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1685403#c22)• 3 years ago |
|  | |

It's not fixed yet, I can see the `jar:file:///` URI here: <https://searchfox.org/mozilla-central/rev/ea1234192518e01694a88eac8ff090e4cadf5ca4/widget/android/nsWindow.cpp#1944-1947>

```
05-03 10:37:32.484 22074 22102 D GeckoSession: onLoadRequest jar:file:///data/user/0/org.mozilla.fenix.debug/files/mozilla/65cen61b.default/extensions/https-everywhere@eff.org.xpi!/pages/cancel/index.html?originURL=http%3A%2F%2Fhttp.badssl.com%2F

```
Flags: needinfo?(agi)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1685403#c23)• 3 years ago |
|  | |

Nika has some ideas here.

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1685403#c24)• 2 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

I ended up not filling this in 5 months ago, when I originally had the idea, but I have some vague memory of what the specific problem was here, which needs to be fixed. My understanding is that this is probably related to how internal redirects are handled in DocumentLoadListener, and how that informaiton is forwarded to the gecko session. Specifically in <https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/ipc/DocumentLoadListener.cpp#2756>, we pass down the URI for the new channel in `AsyncOnChannelRedirect`, but this is too early to learn the actual final URI that the channel is going to have after the redirect. When redirecting within `nsBaseChannel` (which is what extension URIs use), the `OriginalURI` of the new channel isn't set until `nsBaseChannel::ContinueRedirect` (<https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/base/nsBaseChannel.cpp#143-145>), which is called after `AsyncOnChannelRedirect`. This means that the "final channel URI" which you see in that function is unfortunately wrong, with no clear way to get the "real" channel URI, as it hasn't been overridden yet.

Fundamentally the code right now is observing implementation details of the moz-extension protocol, and that it is implemented using internal redirects, and then setting `OriginalURI` to override the final channel URI of the load in the parent process. (extension protocols behave slightly differently in a content process iirc).

I don't necessarily have a solution here off the top of my head, though :valentin might have some insight into what the correct way to handle this kind of thing is.

Flags: needinfo?(nika) → needinfo?(valentin.gosu)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1685403#c25)• 2 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

It occurs to me that we actually already ignore internal redirects in the callback (<https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/ipc/DocumentLoadListener.cpp#2702-2711>). Unfortunately, it seems like the redirect used by `nsBaseChannel` is inconsistent. If the channel is opened synchronously, it will be a `REDIRECT_INTERNAL` (<https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/base/nsBaseChannel.cpp#643>), but if it's opened asynchronously, it'll be a `REDIRECT_TEMPORARY` (<https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/base/nsBaseChannel.cpp#280>).

It appears this dates back to [bug 464956](/show_bug.cgi?id=464956 "RESOLVED FIXED - Don't use REDIRECT_INTERNAL for .url/.desktop files"), where :bz changed it from `REDIRECT_INTERNAL` to `REDIRECT_TEMPORARY` in order to change something about how `.desktop` and `.url` files are handled. I'm unsure if this is still relevant today.

|  | [Valentin Gosu [:valentin] (he/him)](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1685403#c26)• 2 years ago |
|  | |

It seems to me that the arguments for [bug 464956](/show_bug.cgi?id=464956 "RESOLVED FIXED - Don't use REDIRECT_INTERNAL for .url/.desktop files") hold barely, but only for file channels [here](https://searchfox.org/mozilla-central/rev/4d433a219634633ce19158b55520ea228187577a/netwerk/protocol/file/nsFileChannel.cpp#327,340-341) and even then it's a shaky premise - that the user's FS is not under their control.

However, the linked [bug 464954](/show_bug.cgi?id=464954 "RESOLVED FIXED - cross-site XHR doesn't handle redirects correctly") has tests in test\_CrossSiteXHR.html and that test no longer has jar:file for file:// tests; so we MIGHT be able to change it back to REDIRECT\_INTERNAL without major fallback.

Alternatively, could try calling OnRedirectVerifyCallback before calling `window->OnLoadRequest`, so the URL gets updated, and if that fails, then we could cancel the channel?

Flags: needinfo?(valentin.gosu)

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1685403#c27)• 2 years ago |
|  | |

I observed an easily reproducible test case with a similar issue (i.e. URL is jar/file instead of moz-extension).

It is not limited to document loads, and also reproducible on desktop.

Could you take a look at [bug 1802385](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL") and check if they have the same root cause? Even if the other issue happens to be different, then I'd be interested in knowing what's causing that other bug.

Flags: needinfo?(nika)See Also: → [CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL")

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1685403#c28)• 2 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

(In reply to Valentin Gosu [:valentin] (he/him) from [comment #26](/show_bug.cgi?id=1685403#c26 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> It seems to me that the arguments for [bug 464956](/show_bug.cgi?id=464956 "RESOLVED FIXED - Don't use REDIRECT_INTERNAL for .url/.desktop files") hold barely, but only for file channels [here](https://searchfox.org/mozilla-central/rev/4d433a219634633ce19158b55520ea228187577a/netwerk/protocol/file/nsFileChannel.cpp#327,340-341) and even then it's a shaky premise - that the user's FS is not under their control.
>
> However, the linked [bug 464954](/show_bug.cgi?id=464954 "RESOLVED FIXED - cross-site XHR doesn't handle redirects correctly") has tests in test\_CrossSiteXHR.html and that test no longer has jar:file for file:// tests; so we MIGHT be able to change it back to REDIRECT\_INTERNAL without major fallback.

Yeah, I think if it's not an issue anymore, we should switch it back to a `REDIRECT_INTERNAL`. My impression after looking at that was that it probably would be fine to switch the redirect back to `REDIRECT_INTERNAL` at this point, so it's probably worth at least trying out?

> Alternatively, could try calling OnRedirectVerifyCallback before calling `window->OnLoadRequest`, so the URL gets updated, and if that fails, then we could cancel the channel?

I'm pretty sure that would break things, even just in `DocumentLoadListener::AsyncONChannelRedirect`. We very explicitly make sure to fetch the channel creation original URI at the beginning of the function (<https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/ipc/DocumentLoadListener.cpp#2685>), which would be lost if we updated it before this call.

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1685403#c29)• 2 years ago |
| obsolete | |

| Comment hidden (obsolete) |  |
| --- | --- |

(In reply to Rob Wu [:robwu] from [comment #27](/show_bug.cgi?id=1685403#c27 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> I observed an easily reproducible test case with a similar issue (i.e. URL is jar/file instead of moz-extension).
>
> It is not limited to document loads, and also reproducible on desktop.
>
> Could you take a look at [bug 1802385](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL") and check if they have the same root cause? Even if the other issue happens to be different, then I'd be interested in knowing what's causing that other bug.

I think that might be from the same root cause, as the redirect isn't being marked as internal, so the final URI isn't being updated properly, or something like that? I don't know the details of how the final URI for a fetch is determined off the top of my head.

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1685403#c30)• 2 years ago |
|  | |

I looked into the above thing a bit more because I was surprised by the current behaviour, and it turns out I made some poor assumptions in my original comment explaining this situation, and I think the problem is actually completely different than I was originally implying.

I'll post again soon with an updated explanation of what's going on once I've looked into this a bit more.

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1685403#c31)• 2 years ago |
|  | |

So it turns out I was completely wrong about the cause. When loading a `moz-extension:` URI in the parent process, there's actually no nsBaseChannel redirects at all. I've marked my old comments as `obsolete` to avoid confusing future people coming to this bug with incorrect information.

When a `moz-extension` URI is loaded in the parent process, it is loaded using a `SubstitutingProtocolHandler`. This is a class which is used to handle some types of URIs, but the general strategy is used by more protocol handlers than just subclasses of that class.

A substituting-style protocol handler is one which, during `nsIProtocolHandler::NewChannel`, picks a new URI, opens a channel for that URI, and then returns it. However, it does not want that new channel's URI to be the URI of the loaded document, so it avoids that by first calling `SetOriginalURI` on the channel to the URI passed to `NewChannel`, before returning it. (Examples for some protocols: [`moz-extension`/`resource`](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/netwerk/protocol/res/SubstitutingProtocolHandler.cpp#433), `about` ([1](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/browser/components/about/AboutRedirector.cpp#243), [2](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/docshell/base/nsAboutRedirector.cpp#243)), [`chrome`](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/chrome/nsChromeProtocolHandler.cpp#154)).

This does the trick, as when code calls [`NS_GetFinalChannelURI`](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/netwerk/base/nsNetUtil.cpp#2287-2298) to get the URI being loaded from a channel, it will pull the URI from either `GetResultPrincipalURI` or `GetOriginalURI`, not from `GetURI`. This means that the loaded channel is treated as-if it was a channel for the substituted URI.

Unfortunately, both the example in this bug and the example in [comment 27](/show_bug.cgi?id=1685403#c27 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") appear to be places where callers call `nsIChannel::GetURI` instead of `NS_GetFinalChannelURI` to determine the URI being loaded by a channel.

1. For this bug, `DocumentLoadListener` [calls](https://searchfox.org/mozilla-central/rev/0062309958c212504556ae21a7e3eb120c9bd093/netwerk/ipc/DocumentLoadListener.cpp#2745-2746) `AntiTrackingUtils::MaybeGetDocumentUriBeingLoaded`, which [calls `GetURI`](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/toolkit/components/antitracking/AntiTrackingUtils.cpp#88). I think this should probably be calling `NS_GetFinalChannelURI`.
2. For [bug 1802385](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL"), the call appears to be in the `FetchDriver`, which in a few places ([1](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/dom/fetch/FetchDriver.cpp#1494), [2](https://searchfox.org/mozilla-central/rev/513d9c0f27c0c3fdc9ed6c5fb222a3f90ae69d70/dom/fetch/FetchDriver.cpp#1172)) calls `nsIChannel::GetURI` to get the URI being loaded. I'm guessing that these also should probably be using `NS_GetFInalChannelURI`.

Assuming I'm correct about the above, I'm also a bit worried about other places where `nsIChannel::GetURI` is called, as it appears like it's probably being used incorrectly somewhat often, likely because it's the obvious method to call to ask "what URI is this channel loading?". And that appears to be mostly true for almost all URIs which come up during normal browsing, but is not correct for internal URIs and moz-extension. (One place which I noticed where `NS_GetFinalChannelURI` might produce the "wrong" value is for `javascript:` URIs, which are overridden to return the document URI they're running under: <https://searchfox.org/mozilla-central/rev/ce3b4cdbc501cde6176c0330d0d6e8458908dd8a/dom/jsurl/nsJSProtocolHandler.cpp#180-181>, but you can't redirect to those anyway, and that's the correct URI for security checks)

The easiest "fix" here is probably to swap some callers over to `NS_GetFinalChannelURI`, but I worry that won't actually fix issues with people using the wrong method to determine the URI of a channel. We could also simplify the protocol handler for `moz-extension` to no longer use the substituting approach in the parent process (always using the remote codepath might be good for consistency between in-parent and in-content channels anyway), which would fix most of the visible issues, but still technically doesn't fix issues with internal URIs like resource, chrome, and about.

Changing the meaning or name of `nsIChannel::GetURI` sounds like it'd be a complete nightmare as well, so that's probably also not a great option :-/

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1685403#c32)• 2 years ago |
|  | |

It'd be perhaps an inelegant solution, but a bit of me wonders if it would make sense to make everywhere where we currently do this trick instead create a new wrapper channel like we do for content process extension channels, as it would mean that `nsIChannel::GetURI` does the "right thing" more often. Not sure how much that'd end up breaking, or what the perf/memory hit would be of the extra wrappers though.

|  | [Valentin Gosu [:valentin] (he/him)](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1685403#c33)• 2 years ago |
|  | |

I should have occured to me that a missing NS\_GetFinalChannelURI could be the problem. Sorry I missed it.

> The easiest "fix" here is probably to swap some callers over to NS\_GetFinalChannelURI, but I worry that won't actually fix issues with people using the wrong method to determine the URI of a channel.

We could audit current uses of `nsIChannel::GetURI` and add a linter for new uses of it. That would at least force people to think about the correct thing to do.

|  | [Valentin Gosu [:valentin] (he/him)](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1685403#c34)• 2 years ago |
|  | |

Necko will take this one.

Component: DOM: Navigation → NetworkingPriority: -- → P1Whiteboard: [necko-triaged][necko-priority-queue]

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a60883591_505624)• 2 years ago |

Assignee: nobody → kershaw

|  | [Hsin-Yi Tsai (she/her) [:hsinyi]](/user_profile?user_id=434964) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1685403#c35)• 2 years ago |
|  | |

Thank you very much, Valentin & Kershaw :)

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1685403#c36)• 2 years ago |
|  | |

Attached file
[Bug 1685403 - Add linter to check using GetURI, r=#necko](attachment.cgi?id=9308231) (obsolete)
— [Details](attachment.cgi?id=9308231&action=edit)

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1685403#c37)• 2 years ago |
|  | |

Attached file
[Bug 1685403 - Use NS\_GetFinalChannelURI at some places, r=#necko](attachment.cgi?id=9308232)
— [Details](attachment.cgi?id=9308232&action=edit)

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1685403#c38)• 2 years ago |
|  | |

(In reply to Valentin Gosu [:valentin] (he/him) from [comment #33](/show_bug.cgi?id=1685403#c33 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> I should have occured to me that a missing NS\_GetFinalChannelURI could be the problem. Sorry I missed it.
>
> > The easiest "fix" here is probably to swap some callers over to NS\_GetFinalChannelURI, but I worry that won't actually fix issues with people using the wrong method to determine the URI of a channel.
>
> We could audit current uses of `nsIChannel::GetURI` and add a linter for new uses of it. That would at least force people to think about the correct thing to do.

I am not really sure how to audit the current use of `nsIChannel::GetURI`, so I just submit a patch to change someplace mentioned in [comment #31](/show_bug.cgi?id=1685403#c31 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///").

Do you maybe have an idea about how to audit this?

Thanks.

Flags: needinfo?(valentin.gosu)Flags: needinfo?(nika)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a61146106_1689)• 2 years ago |

Group: dom-core-security → network-core-security

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1685403#c39)• 2 years ago |
|  | |

I unfortunately don't have an easy rule for figuring out whether or not a call-site should be switched to `NS_GetFinalChannelURI`. I think it comes down to whether the code is trying to get low-level information about the channel and what it's trying to load, or if it is actually wanting to ask questions about the final URI which is going to be produced by the channel. This probably requires some judgement based on the code being read to figure out what the intention of the code was originally.

Changing callers in JS will also probably be a bit of a pain. Don't know if there's an easy way to get the final URI of the channel from JS (it looks like it might be on [`ChannelWrapper`](https://searchfox.org/mozilla-central/rev/b4de9fa6fe3fb425129093c3deb1dae0686f7a2b/dom/chrome-webidl/ChannelWrapper.webidl#172-177))? Finding them in JS will also be somewhat painful, because it's just an access to a `.URI` member, but it does appear that for the most part that is only a property on principals, history entries, or channels (<https://searchfox.org/mozilla-central/search?q=%5C.URI%5Cb&path=js&case=true&regexp=true>).

Flags: needinfo?(nika)

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1685403#c40)• 2 years ago |
|  | |

(In reply to Nika Layzell [:nika] (ni? for response) from [comment #39](/show_bug.cgi?id=1685403#c39 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> Changing callers in JS will also probably be a bit of a pain. Don't know if there's an easy way to get the final URI of the channel from JS (it looks like it might be on [`ChannelWrapper`](https://searchfox.org/mozilla-central/rev/b4de9fa6fe3fb425129093c3deb1dae0686f7a2b/dom/chrome-webidl/ChannelWrapper.webidl#172-177))?

ChannelWrapper depends on the extension's WebRequest implementation ([bug 1799118](/show_bug.cgi?id=1799118 "NEW - ChannelWrapper does not trace redirects unless a WebRequest listener is present")), so I recommend to add a utility method or channel method instead of replacing nsIChannel uses with ChannelWrapper.

|  | [Valentin Gosu [:valentin] (he/him)](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=1685403#c41)• 2 years ago |
|  | |

I agree with Nika. It's really difficult to figure out which one you need without thinking about it.

I assume we'll need a new method on nsIChannel that calls NS\_GetFinalChannelURI to be accessible from JS.

Flags: needinfo?(valentin.gosu)

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a62973279_447061)• 2 years ago |

Blocks: [CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL")See Also: [CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL") →

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=1685403#c42)• 2 years ago |
|  | |

This bug has morphed from a security issue to a regular bug.

<https://bugzilla.mozilla.org/show_bug.cgi?id=1685403#c13> lists the issues associated with this bug.

The original security bug was fixed in multiple ways:

* 1+2 by <https://github.com/mozilla-mobile/android-components/pull/9381>
* 4 by [bug 1686334](/show_bug.cgi?id=1686334 "RESOLVED FIXED - Rejecting page load in onLoadRequest leaves page in invalid state") (actually [bug 1735613](/show_bug.cgi?id=1735613 "RESOLVED FIXED - Fix android test NavigationDelegateTest#redirectIntentLoad when parent-controlled path is enabled in GeckoView"))

3 was thought to be fixed by [bug 1735613](/show_bug.cgi?id=1735613 "RESOLVED FIXED - Fix android test NavigationDelegateTest#redirectIntentLoad when parent-controlled path is enabled in GeckoView"), but it was not:

(In reply to [ex-Mozilla] Agi Sferro | :agi from [comment #22](/show_bug.cgi?id=1685403#c22 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"))

> It's not fixed yet, I can see the `jar:file:///` URI here: <https://searchfox.org/mozilla-central/rev/ea1234192518e01694a88eac8ff090e4cadf5ca4/widget/android/nsWindow.cpp#1944-1947>
>
> ```
> 05-03 10:37:32.484 22074 22102 D GeckoSession: onLoadRequest jar:file:///data/user/0/org.mozilla.fenix.debug/files/mozilla/65cen61b.default/extensions/https-everywhere@eff.org.xpi!/pages/cancel/index.html?originURL=http%3A%2F%2Fhttp.badssl.com%2F
>
> ```

Nika posted the latest analysis in [comment 31](/show_bug.cgi?id=1685403#c31 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///") of the root cause, along with how that causes this bug, and (independently) causes [bug 1802385](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL"). These two specific examples are fixed in the patch from [comment 37](/show_bug.cgi?id=1685403#c37 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///").

There is a patch to add linter warnings in [comment 36](/show_bug.cgi?id=1685403#c36 "RESOLVED FIXED - onLoadRequest contains translated jar:file:/// URI instead of moz-extension:///"). I think that it would make sense to move that to a follow-up bug.

See Also: → <https://github.com/mozilla-mobile/fenix/issues/17321>,
<https://github.com/mozilla-mobile/android-components/pull/9381>

|  | [Rob Wu [:robwu]](/user_profile?user_id=447061) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a63499909_447061)• 2 years ago |

No longer blocks: [CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL")See Also: → [CVE-2023-28160](/show_bug.cgi?id=1802385 "RESOLVED FIXED - After redirect to moz-extension:-URL in the parent process, the URL changes to the underlying jar/file-URL")

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=1685403#c43)• 2 years ago |
|  | |

Attached file
[Bug 1685403 - Use NS\_GetFinalChannelURI at some places, r=#necko](attachment.cgi?id=9317357) (obsolete)
— [Details](attachment.cgi?id=9317357&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a66333560_600971)• 2 years ago |

[Attachment #9317357](/attachment.cgi?id=9317357&action=edit "Bug 1685403 - Use NS_GetFinalChannelURI at some places, r=#necko") -
Attachment is obsolete: true

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a66334048_600971)• 2 years ago |

[Attachment #9308231](/attachment.cgi?id=9308231&action=edit "Bug 1685403 - Add linter to check using GetURI, r=#necko") -
Attachment is obsolete: true

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=1685403#c44)• 2 years ago |
|  | |

Use NS\_GetFinalChannelURI at some places, r=necko-reviewers,valentin

<https://hg.mozilla.org/integration/autoland/rev/6d75b6c4bdf7a2f88110f425352461a1619e3501>

<https://hg.mozilla.org/mozilla-central/rev/6d75b6c4bdf7>

Group: network-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 2 years ago
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 112 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a66452936_75935)• 2 years ago |

[status-firefox110](/buglist.cgi?f1=cf_status_firefox110&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=wontfix)
[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=1685403#c45)• 2 years ago |
|  | |

The patch landed in nightly and beta is affected.

:kershaw, is this bug important enough to require an uplift?

* If yes, please nominate the patch for beta approval.
* If no, please set `status-firefox111` to `wontfix`.

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#uplift_beta.py).

Flags: needinfo?(kershaw)

|  | [Kershaw Chang [:kershaw]](/user_profile?user_id=505624)  Assignee |  |
| --- | --- | --- |
| [Comment 46](/show_bug.cgi?id=1685403#c46)• 2 years ago |
|  | |

I think it's fine not to uplift this patch.

[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix)Flags: needinfo?(kershaw)

|  | [Oana Horvath [:ohorvath]](/user_profile?user_id=585566) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a68139137_585566)• 2 years ago |

Flags: qe-verify+

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a68139980_553429)• 2 years ago |

Whiteboard: [necko-triaged][necko-priority-queue] → [necko-triaged][necko-priority-queue][post-critsmash-triage]

|  | [Oana Horvath [:ohorvath]](/user_profile?user_id=585566) |  |
| --- | --- | --- |
| [Comment 47](/show_bug.cgi?id=1685403#c47)• 2 years ago |
|  | |

I removed the qe-verify flag after seeing the original issue with STR was fixed somewhere else and it was also covered by automated testing. If QA is still needed here please let us know.

Flags: qe-verify+ → qe-verify-

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a70736593_578488)• 2 years ago |

Whiteboard: [necko-triaged][necko-priority-queue][post-critsmash-triage] → [necko-triaged][necko-priority-queue][post-critsmash-triage][adv-main112+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 48](/show_bug.cgi?id=1685403#c48)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9327529)
— [Details](attachment.cgi?id=9327529&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a70927337_578488)• 2 years ago |

Alias: CVE-2023-29538

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1685403#a87630928_1689)• 1 year ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1685403&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Rob Wu [:robwu]](/user_profile?user_id=447061)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from www.mozilla.org_acf64303_20250115_091434.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-13

## Security Vulnerabilities fixed in Firefox 112, Firefox for Android 112, Focus for Android 112

Announced
April 11, 2023
Impact
high
Products
Firefox, Firefox for Android, Focus for Android
Fixed in

* Firefox 112
* Firefox for Android 112
* Focus for Android 112

#### [#CVE-2023-29531: Out-of-bound memory access in WebGL on macOS](#CVE-2023-29531)

Reporter
DoHyun Lee
Impact
high
##### Description

An attacker could have caused an out of bounds memory access using WebGL APIs, leading to memory corruption and a potentially exploitable crash.
*This bug only affects Firefox for macOS. Other operating systems are unaffected.*

##### References

* [Bug 1794292](https://bugzilla.mozilla.org/show_bug.cgi?id=1794292)

#### [#CVE-2023-29532: Mozilla Maintenance Service Write-lock bypass](#CVE-2023-29532)

Reporter
Holger Fuhrmannek
Impact
high
##### Description

A local attacker can trick the Mozilla Maintenance Service into applying an unsigned update file by pointing the service at an update file on a malicious SMB server. The update file can be replaced after the signature check, before the use, because the write-lock requested by the service does not work on a SMB server.
*Note: This attack requires local system access and only affects Windows. Other operating systems are not affected.*

##### References

* [Bug 1806394](https://bugzilla.mozilla.org/show_bug.cgi?id=1806394)

#### [#CVE-2023-29533: Fullscreen notification obscured](#CVE-2023-29533)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A website could have obscured the fullscreen notification by using a combination of `window.open`, fullscreen requests, `window.name` assignments, and `setInterval` calls. This could have led to user confusion and possible spoofing attacks.

##### References

* [Bug 1814597](https://bugzilla.mozilla.org/show_bug.cgi?id=1814597)
* [Bug 1798219](https://bugzilla.mozilla.org/show_bug.cgi?id=1798219)

#### [#CVE-2023-29534: Fullscreen notification could have been obscured on Firefox for Android](#CVE-2023-29534)

Reporter
Shaheen Fazim and Hafiizh
Impact
high
##### Description

Different techniques existed to obscure the fullscreen notification in Firefox and Focus for Android. These could have led to potential user confusion and spoofing attacks.
*This bug only affects Firefox and Focus for Android. Other versions of Firefox are unaffected.*

##### References

* [Bug 1816059](https://bugzilla.mozilla.org/show_bug.cgi?id=1816059)
* [Bug 1816007](https://bugzilla.mozilla.org/show_bug.cgi?id=1816007)
* [Bug 1821155](https://bugzilla.mozilla.org/show_bug.cgi?id=1821155)
* [Bug 1821576](https://bugzilla.mozilla.org/show_bug.cgi?id=1821576)
* [Bug 1821906](https://bugzilla.mozilla.org/show_bug.cgi?id=1821906)
* [Bug 1822298](https://bugzilla.mozilla.org/show_bug.cgi?id=1822298)
* [Bug 1822305](https://bugzilla.mozilla.org/show_bug.cgi?id=1822305)

#### [#CVE-2023-1999: Double-free in libwebp](#CVE-2023-1999)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A double-free in libwebp could have led to memory corruption and a potentially exploitable crash.

##### References

* [Bug 1819244](https://bugzilla.mozilla.org/show_bug.cgi?id=1819244)

#### [#CVE-2023-29535: Potential Memory Corruption following Garbage Collector compaction](#CVE-2023-29535)

Reporter
Lukas Bernhard
Impact
high
##### Description

Following a Garbage Collector compaction, weak maps may have been accessed before they were correctly traced. This resulted in memory corruption and a potentially exploitable crash.

##### References

* [Bug 1820543](https://bugzilla.mozilla.org/show_bug.cgi?id=1820543)

#### [#CVE-2023-29536: Invalid free from JavaScript code](#CVE-2023-29536)

Reporter
zx from qriousec
Impact
high
##### Description

An attacker could cause the memory manager to incorrectly free a pointer that addresses attacker-controlled memory, resulting in an assertion, memory corruption, or a potentially exploitable crash.

##### References

* [Bug 1821959](https://bugzilla.mozilla.org/show_bug.cgi?id=1821959)

#### [#CVE-2023-29537: Data Races in font initialization code](#CVE-2023-29537)

Reporter
Looben Yang
Impact
high
##### Description

Multiple race conditions in the font initialization could have led to memory corruption and execution of attacker-controlled code.

##### References

* [Bug 1823365](https://bugzilla.mozilla.org/show_bug.cgi?id=1823365)
* [Bug 1824200](https://bugzilla.mozilla.org/show_bug.cgi?id=1824200)
* [Bug 1825569](https://bugzilla.mozilla.org/show_bug.cgi?id=1825569)

#### [#CVE-2023-29538: Directory information could have been leaked to WebExtensions](#CVE-2023-29538)

Reporter
Alexis aka zoracon
Impact
moderate
##### Description

Under specific circumstances a WebExtension may have received a `jar:file:///` URI instead of a `moz-extension:///` URI during a load request. This leaked directory paths on the user's machine.

##### References

* [Bug 1685403](https://bugzilla.mozilla.org/show_bug.cgi?id=1685403)

#### [#CVE-2023-29539: Content-Disposition filename truncation leads to Reflected File Download](#CVE-2023-29539)

Reporter
Trung Pham
Impact
moderate
##### Description

When handling the filename directive in the Content-Disposition header, the filename would be truncated if the filename contained a NULL character. This could have led to reflected file download attacks potentially tricking users to install malware.

##### References

* [Bug 1784348](https://bugzilla.mozilla.org/show_bug.cgi?id=1784348)

#### [#CVE-2023-29540: Iframe sandbox bypass using redirects and sourceMappingUrls](#CVE-2023-29540)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

Using a redirect embedded into `sourceMappingUrls` could allow for navigation to external protocol links in sandboxed iframes without `allow-top-navigation-to-custom-protocols`.

##### References

* [Bug 1790542](https://bugzilla.mozilla.org/show_bug.cgi?id=1790542)

#### [#CVE-2023-29541: Files with malicious extensions could have been downloaded unsafely on Linux](#CVE-2023-29541)

Reporter
Ameen Basha M K
Impact
moderate
##### Description

Firefox did not properly handle downloads of files ending in `.desktop`, which can be interpreted to run attacker-controlled commands.
*This bug only affects Firefox for Linux on certain Distributions. Other operating systems are unaffected, and Mozilla is unable to enumerate all affected Linux Distributions.*

##### References

* [Bug 1810191](https://bugzilla.mozilla.org/show_bug.cgi?id=1810191)

#### [#CVE-2023-29542: Bypass of file download extension restrictions](#CVE-2023-29542)

Reporter
Shaheen Fazim and Ameen Basha M K
Impact
moderate
##### Description

A newline in a filename could have been used to bypass the file extension security mechanisms that replace malicious file extensions such as .lnk with .download. This could have led to accidental execution of malicious code.
*This bug only affects Firefox on Windows. Other versions of Firefox are unaffected.*

##### References

* [Bug 1815062](https://bugzilla.mozilla.org/show_bug.cgi?id=1815062)
* [Bug 1810793](https://bugzilla.mozilla.org/show_bug.cgi?id=1810793)

#### [#CVE-2023-29543: Use-after-free in debugging APIs](#CVE-2023-29543)

Reporter
Lukas Bernhard
Impact
moderate
##### Description

An attacker could have caused memory corruption and a potentially exploitable use-after-free of a pointer in a global object's debugger vector.

##### References

* [Bug 1816158](https://bugzilla.mozilla.org/show_bug.cgi?id=1816158)

#### [#CVE-2023-29544: Memory Corruption in garbage collector](#CVE-2023-29544)

Reporter
Lukas Bernhard
Impact
moderate
##### Description

If multiple instances of resource exhaustion occurred at the incorrect time, the garbage collector could have caused memory corruption and a potentially exploitable crash.

##### References

* [Bug 1818781](https://bugzilla.mozilla.org/show_bug.cgi?id=1818781)

#### [#CVE-2023-29545: Windows Save As dialog resolved environment variables](#CVE-2023-29545)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

Similar to CVE-2023-28163, this time when choosing 'Save Link As', suggested filenames containing environment variable names would have resolved those in the context of the current user.
*This bug only affects Firefox on Windows. Other versions of Firefox are unaffected.*

##### References

* [Bug 1823077](https://bugzilla.mozilla.org/show_bug.cgi?id=1823077)

#### [#CVE-2023-29546: Screen recording in Private Browsing included address bar on Android](#CVE-2023-29546)

Reporter
Irwan
Impact
low
##### Description

When recording the screen while in Private Browsing on Firefox for Android the address bar and keyboard were not hidden, potentially leaking sensitive information.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1780842](https://bugzilla.mozilla.org/show_bug.cgi?id=1780842)

#### [#CVE-2023-29547: Secure document cookie could be spoofed with insecure cookie](#CVE-2023-29547)

Reporter
Marco Squarcina
Impact
low
##### Description

When a secure cookie existed in the Firefox cookie jar an insecure cookie for the same domain could have been created, when it should have silently failed. This could have led to a desynchronization in expected results when reading from the secure cookie.

##### References

* [Bug 1783536](https://bugzilla.mozilla.org/show_bug.cgi?id=1783536)

#### [#CVE-2023-29548: Incorrect optimization result on ARM64](#CVE-2023-29548)

Reporter
JunYoung Park
Impact
low
##### Description

A wrong lowering instruction in the ARM64 Ion compiler resulted in a wrong optimization result.

##### References

* [Bug 1822754](https://bugzilla.mozilla.org/show_bug.cgi?id=1822754)

#### [#CVE-2023-29549: Javascript's bind function may have failed](#CVE-2023-29549)

Reporter
Lukas Bernhard
Impact
low
##### Description

Under certain circumstances, a call to the `bind` function may have resulted in the incorrect realm. This may have created a vulnerability relating to JavaScript-implemented sandboxes such as SES.

##### References

* [Bug 1823042](https://bugzilla.mozilla.org/show_bug.cgi?id=1823042)

#### [#CVE-2023-29550: Memory safety bugs fixed in Firefox 112 and Firefox ESR 102.10](#CVE-2023-29550)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Randell Jesup, Andrew Osmond, Sebastian Hengst, Andrew McCreight, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 111 and Firefox ESR 102.9. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 112 and Firefox ESR 102.10](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1720594%2C1812498%2C1814217%2C1818357%2C1751945%2C1818762%2C1819493%2C1820389%2C1820602%2C1821448%2C1822413%2C1824828)

#### [#CVE-2023-29551: Memory safety bugs fixed in Firefox 112](#CVE-2023-29551)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Randell Jesup, Andrew McCreight, Gabriele Svelto, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 111. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 112](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1763625%2C1814314%2C1815798%2C1815890%2C1819239%2C1819465%2C1819486%2C1819492%2C1819957%2C1820514%2C1820776%2C1821838%2C1822175%2C1823547)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)


