=== Content from github.com_f248fd93_20250115_093054.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fsecurity%2Fadvisories%2FGHSA-m3jr-cvhj-f35j)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fsecurity%2Fadvisories%2FGHSA-m3jr-cvhj-f35j)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=xwiki%2Fxwiki-commons)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-commons](/xwiki/xwiki-commons)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-commons) You must be signed in to change notification settings
* [Fork
  123](/login?return_to=%2Fxwiki%2Fxwiki-commons)
* [Star
   85](/login?return_to=%2Fxwiki%2Fxwiki-commons)

* [Code](/xwiki/xwiki-commons)
* [Pull requests
  28](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects
  0](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-commons)
* [Pull requests](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

# Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting') in org.xwiki.commons:xwiki-commons-xml

Critical

[tmortagne](/tmortagne)
published
GHSA-m3jr-cvhj-f35j
Apr 12, 2023

## Package

maven

org.xwiki.commons:xwiki-commons-xml
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

>= 4.2-milestone-1

## Patched versions

14.6-rc-1

## Description

### Impact

The "restricted" mode of the HTML cleaner in XWiki, introduced in version 4.2-milestone-1, only escaped `<script>` and `<style>`-tags but neither attributes that can be used to inject scripts nor other dangerous HTML tags like `<iframe>`. As a consequence, any code relying on this "restricted" mode for security is vulnerable to JavaScript injection ("cross-site scripting"/XSS). An example are anonymous comments in XWiki where the HTML macro filters HTML using restricted mode:

```
{{html}}
<a href='' onclick='alert(1)'>XSS</a>
{{/html}}

```

When a privileged user with programming rights visits such a comment in XWiki, the malicious JavaScript code is executed in the context of the user session. This allows server-side code execution with programming rights, impacting the confidentiality, integrity and availability of the XWiki instance.

### Patches

This problem has been patched in XWiki 14.6 RC1 with the introduction of a filter with allowed HTML elements and attributes that is enabled in restricted mode.

### Workarounds

There are no known workarounds apart from upgrading to a version including the fix.

### References

* [b11eae9](https://github.com/xwiki/xwiki-commons/commit/b11eae9d82cb53f32962056b5faa73f3720c6182) - the patch with the filter
* [4a185e0](https://github.com/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2) - the patch with the definitions what is allowed
* <https://jira.xwiki.org/browse/XWIKI-9118> - the security issue with the HTML macro
* <https://jira.xwiki.org/browse/XCOMMONS-1680> - the issue regarding a definition of what is allowed HTML
* <https://jira.xwiki.org/browse/XCOMMONS-2426> - the issue regarding the filter that fixes the security issue

### For more information

If you have any questions or comments about this advisory:

* Open an issue in [Jira XWiki](https://jira.xwiki.org/)
* Email us at XWiki Security mailing-list

### Severity

Critical

9.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
Required

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H

### CVE ID

CVE-2023-29201

### Weaknesses

[CWE-79](/advisories?query=cwe%3A79) [CWE-692](/advisories?query=cwe%3A692)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from jira.xwiki.org_1c8f233d_20250115_093054.html ===


[Log in](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-2426)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![XWiki.org JIRA](/s/-65z3d2/930000/8ws80b/_/jira-logo-scaled.png)](https://jira.xwiki.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-093/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-093/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-2426)

![Uploaded image for project: 'XWiki Commons'](https://jira.xwiki.org/secure/projectavatar?pid=10620&avatarId=13603)

1. [XWiki Commons](/browse/XCOMMONS)
2. [XCOMMONS-2426](/browse/XCOMMONS-2426)

# Provide a component for filtering safe HTML elements and attributes

[Log In](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-2426 "Log In")ClosedExportnull

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=13510&avatarType=issuetype "Improvement - An improvement or enhancement to an existing feature or task.") Improvement
* **Resolution:**
  Fixed
* **Priority:**
  ![](/images/icons/priorities/major.svg "Major - Major loss of function.") Major
* **Fix Version/s:**
  [14.6-rc-1](/issues/?jql=project+%3D+XCOMMONS+AND+fixVersion+%3D+14.6-rc-1 "14.6-rc-1 ")
* **Affects Version/s:**
  13.10.5, 14.3
* **Component/s:**
  [XML](/issues/?jql=project+%3D+XCOMMONS+AND+component+%3D+XML "XML XML Module")
* **Labels:**
  None

* **Tests:**
  Unit
* **Difficulty:**
  Unknown
* **Documentation:**
  <https://extensions.xwiki.org/xwiki/bin/view/Extension/XML%20Module>
* **Documentation in Release Notes:**
  <https://www.xwiki.org/xwiki/bin/view/ReleaseNotes/Data/XWiki/14.6RC1/Entry007/>
* **Similar issues:**

#### Description

The XML module should provide a component that provides ways to determine if a certain HTML element or attribute is considered safe for user-generated content that can be re-used for filtering elements and attributes in various places in XWiki. As the definition what is safe might depend on the context of the wiki, there should be different options that can be selected with a configuration option: a secure one based on a definition of allowed elements, attributes and values of attributes, a less secure one that is based on disallowing dangerous elements, attributes and attribute values and an insecure one that allows everything.

#### Attachments

#### Activity

#### People

Assignee:

![MichaelHamann](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Michael Hamann

Reporter:

![MichaelHamann](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Michael Hamann

Votes:
0
Vote for this issue

Watchers:
1
Start watching this issue

#### Dates

Created:

05/May/22 11:34

Updated:

13/Jul/22 11:49

Resolved:

30/Jun/22 15:41

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for XWiki.org. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from github.com_218bbca2_20250115_093052.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2Fb11eae9d82cb53f32962056b5faa73f3720c6182)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2Fb11eae9d82cb53f32962056b5faa73f3720c6182)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-commons)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-commons](/xwiki/xwiki-commons)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-commons) You must be signed in to change notification settings
* [Fork
  123](/login?return_to=%2Fxwiki%2Fxwiki-commons)
* [Star
   85](/login?return_to=%2Fxwiki%2Fxwiki-commons)

* [Code](/xwiki/xwiki-commons)
* [Pull requests
  28](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects
  0](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-commons)
* [Pull requests](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

## Commit

[Permalink](/xwiki/xwiki-commons/commit/b11eae9d82cb53f32962056b5faa73f3720c6182)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XCOMMONS-1680: Filter Html attributes in restricted mode based on a w…

[Browse files](/xwiki/xwiki-commons/tree/b11eae9d82cb53f32962056b5faa73f3720c6182)
Browse the repository at this point in the history

```
…hitelist

* Add a SanitizerFilter that checks namespaces and filters elements
  based on the HTMLElementSanitizer
```

* Loading branch information

[![@michitux](https://avatars.githubusercontent.com/u/198317?s=40&v=4)](/michitux)

[michitux](/xwiki/xwiki-commons/commits?author=michitux "View all commits by michitux")
committed
Jun 30, 2022

1 parent
[4a185e0](/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2)

commit b11eae9

 Show file tree

 Hide file tree

Showing
**6 changed files**
with
**343 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-commons-core/xwiki-commons-xml/src

  + main

    - java/org/xwiki/xml/internal/html

      * xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLCleaner.java
        [DefaultHTMLCleaner.java](#diff-3584354d62cdd7827c8e17f74b3bfd58cdde9d68d0fe4ec1771d8fc58aa3a903)
      * filter

        + xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/filter/SanitizerFilter.java
          [SanitizerFilter.java](#diff-65d5d914ba15ba66443db1eaf4b2db13235aaf377f473efe1788ad6fee1de84d)
    - resources/META-INF

      * xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt
        [components.txt](#diff-9791ca2c5cccf514e4d98069e69414ecebe0ec84698bb37c5d07eec9b6a7e5de)
  + test/java/org/xwiki/xml

    - html

      * xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/HTMLUtilsTest.java
        [HTMLUtilsTest.java](#diff-920132e5684f4b0bb3c9f2070eb712e37bd05eae65e1a67bb46f447926eb47f1)
      * filter

        + xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/filter/AbstractHTMLFilterTest.java
          [AbstractHTMLFilterTest.java](#diff-61dfbed3da7a57edf601df8e410f4ec6dc3b512d4898ff0d099cfd56fd715593)
    - internal/html

      * xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/DefaultHTMLCleanerTest.java
        [DefaultHTMLCleanerTest.java](#diff-8f4184ae46501b7812490e56339d20e9d5481edd7b29f01c2c9add66c61d7aab)

## There are no files selected for viewing

7 changes: 6 additions & 1 deletion

7
[...-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLCleaner.java](#diff-3584354d62cdd7827c8e17f74b3bfd58cdde9d68d0fe4ec1771d8fc58aa3a903 "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLCleaner.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/b11eae9d82cb53f32962056b5faa73f3720c6182/xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLCleaner.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -107,6 +107,10 @@ public class DefaultHTMLCleaner implements HTMLCleaner |
|  |  | // TODO: remove when upgrading to HTMLClener 2.23 |
|  |  | private HTMLFilter controlFilter; |
|  |  |  |
|  |  | @Inject |
|  |  | @Named("sanitizer") |
|  |  | private HTMLFilter sanitizerFilter; |
|  |  |  |
|  |  | @Inject |
|  |  | private Execution execution; |
|  |  |  |
| Expand Down  Expand Up | | @@ -201,7 +205,8 @@ public HTMLCleanerConfiguration getDefaultConfiguration() |
|  |  | this.listFilter, |
|  |  | this.fontFilter, |
|  |  | this.attributeFilter, |
|  |  | this.linkFilter)); |
|  |  | this.linkFilter, |
|  |  | this.sanitizerFilter)); |
|  |  | return configuration; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

246 changes: 246 additions & 0 deletions

246
[...e/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/filter/SanitizerFilter.java](#diff-65d5d914ba15ba66443db1eaf4b2db13235aaf377f473efe1788ad6fee1de84d "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/filter/SanitizerFilter.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/b11eae9d82cb53f32962056b5faa73f3720c6182/xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/filter/SanitizerFilter.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,246 @@ |
|  |  | /\* |
|  |  | \* See the NOTICE file distributed with this work for additional |
|  |  | \* information regarding copyright ownership. |
|  |  | \* |
|  |  | \* This is free software; you can redistribute it and/or modify it |
|  |  | \* under the terms of the GNU Lesser General Public License as |
|  |  | \* published by the Free Software Foundation; either version 2.1 of |
|  |  | \* the License, or (at your option) any later version. |
|  |  | \* |
|  |  | \* This software is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU |
|  |  | \* Lesser General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU Lesser General Public |
|  |  | \* License along with this software; if not, write to the Free |
|  |  | \* Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA |
|  |  | \* 02110-1301 USA, or see the FSF site: http://www.fsf.org. |
|  |  | \*/ |
|  |  | /\* |
|  |  | \* Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License, |
|  |  | \* v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/. |
|  |  | \*/ |
|  |  | package org.xwiki.xml.internal.html.filter; |
|  |  |  |
|  |  | import java.util.ArrayDeque; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.Deque; |
|  |  | import java.util.List; |
|  |  | import java.util.Map; |
|  |  | import java.util.function.BiPredicate; |
|  |  |  |
|  |  | import javax.inject.Inject; |
|  |  | import javax.inject.Named; |
|  |  | import javax.inject.Singleton; |
|  |  |  |
|  |  | import org.w3c.dom.Attr; |
|  |  | import org.w3c.dom.Document; |
|  |  | import org.w3c.dom.Element; |
|  |  | import org.w3c.dom.NamedNodeMap; |
|  |  | import org.w3c.dom.Node; |
|  |  | import org.xwiki.component.annotation.Component; |
|  |  | import org.xwiki.xml.html.HTMLCleanerConfiguration; |
|  |  | import org.xwiki.xml.html.HTMLElementSanitizer; |
|  |  | import org.xwiki.xml.html.filter.AbstractHTMLFilter; |
|  |  | import org.xwiki.xml.internal.html.MathMLDefinitions; |
|  |  | import org.xwiki.xml.internal.html.SVGDefinitions; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sanitizer that sanitizes the document. |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \* @since 14.6RC1 |
|  |  | \*/ |
|  |  | @Component |
|  |  | @Named("sanitizer") |
|  |  | @Singleton |
|  |  | public class SanitizerFilter extends AbstractHTMLFilter |
|  |  | { |
|  |  | private static final String MATHML\_NAMESPACE = "http://www.w3.org/1998/Math/MathML"; |
|  |  |  |
|  |  | private static final String SVG\_NAMESPACE = "http://www.w3.org/2000/svg"; |
|  |  |  |
|  |  | private static final String HTML\_NAMESPACE = "http://www.w3.org/1999/xhtml"; |
|  |  |  |
|  |  | @Inject |
|  |  | private HTMLElementSanitizer htmlElementSanitizer; |
|  |  |  |
|  |  | @Inject |
|  |  | private SVGDefinitions svgDefinitions; |
|  |  |  |
|  |  | @Inject |
|  |  | private MathMLDefinitions mathMLDefinitions; |
|  |  |  |
|  |  | @Override |
|  |  | public void filter(Document document, Map<String, String> cleaningParameters) |
|  |  | { |
|  |  | String restricted = cleaningParameters.get(HTMLCleanerConfiguration.RESTRICTED); |
|  |  | if ("true".equalsIgnoreCase(restricted)) { |
|  |  | cleanDocument(document.getDocumentElement()); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private static class TagInformation |
|  |  | { |
|  |  | public static final TagInformation INVALID = new TagInformation(null, null); |
|  |  |  |
|  |  | public final String tagName; |
|  |  |  |
|  |  | public final String namespace; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Default constructor. |
|  |  | \* |
|  |  | \* @param tagName the name of the tag |
|  |  | \* @param namespace the namespace of the tag |
|  |  | \*/ |
|  |  | TagInformation(String tagName, String namespace) |
|  |  | { |
|  |  | this.tagName = tagName; |
|  |  | this.namespace = namespace; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private void cleanDocument(Element rootElement) |
|  |  | { |
|  |  | List<Element> elementsToRemove = new ArrayList<>(); |
|  |  | traverseWithNamespace(rootElement, (element, currentNamespace) -> { |
|  |  | if (currentNamespace == TagInformation.INVALID |
|  |  | || !this.htmlElementSanitizer.isElementAllowed(element.getTagName())) |
|  |  | { |
|  |  | elementsToRemove.add(element); |
|  |  | return true; |
|  |  | } else { |
|  |  | getAttributes(element).stream() |
|  |  | .filter( |
|  |  | attr -> !this.htmlElementSanitizer.isAttributeAllowed(element.getTagName(), attr.getName(), |
|  |  | attr.getValue()) |
|  |  | ) |
|  |  | .forEach(element::removeAttributeNode); |
|  |  | return false; |
|  |  | } |
|  |  | }); |
|  |  |  |
|  |  | elementsToRemove.forEach(element -> element.getParentNode().removeChild(element)); |
|  |  | } |
|  |  |  |
|  |  | private void traverseWithNamespace(Element rootElement, BiPredicate<Element, TagInformation> traversal) |
|  |  | { |
|  |  | Node node = rootElement; |
|  |  |  |
|  |  | boolean reachedRoot = false; |
|  |  |  |
|  |  | Deque<TagInformation> parentNamespace = new ArrayDeque<>(); |
|  |  | TagInformation currentNamespace = new TagInformation("html", HTML\_NAMESPACE); |
|  |  | parentNamespace.push(currentNamespace); |
|  |  |  |
|  |  | while (!reachedRoot) { |
|  |  | boolean skipChildren = false; |
|  |  |  |
|  |  | if (node.getNodeType() == Node.ELEMENT\_NODE && node instanceof Element) { |
|  |  | Element element = (Element) node; |
|  |  |  |
|  |  | currentNamespace = checkNamespace(element, parentNamespace.peek()); |
|  |  | skipChildren = traversal.test(element, currentNamespace); |
|  |  | } |
|  |  |  |
|  |  | if (node.getFirstChild() != null && !skipChildren) { |
|  |  | node = node.getFirstChild(); |
|  |  | parentNamespace.push(currentNamespace); |
|  |  | } else { |
|  |  | while (node.getNextSibling() == null) { |
|  |  | if (node == rootElement) { |
|  |  | reachedRoot = true; |
|  |  | break; |
|  |  | } |
|  |  |  |
|  |  | node = node.getParentNode(); |
|  |  | currentNamespace = parentNamespace.pop(); |
|  |  | } |
|  |  |  |
|  |  | node = node.getNextSibling(); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Computes the namespace of the current element if it is allowed. |
|  |  | \* <p> |
|  |  | \* Tries to follow the logic in DOMPurify by Cure53 and other contributors | Released under the Apache license |
|  |  | \* 2.0 and Mozilla Public License 2.0 - <a href="https://github.com/cure53/DOMPurify/blob/main/LICENSE">LICENSE</a>. |
|  |  | \* |
|  |  | \* @param element the element to check |
|  |  | \* @param parentTag the information of the parent tag |
|  |  | \* @return the tag information of the current tag or {@link TagInformation#INVALID} if the element must not be |
|  |  | \* there |
|  |  | \*/ |
|  |  | private TagInformation checkNamespace(Element element, TagInformation parentTag) |
|  |  | { |
|  |  | TagInformation result = TagInformation.INVALID; |
|  |  |  |
|  |  | // Stay in parent SVG/MathML namespace if the current element clearly belongs to the parent namespace. |
|  |  | if (SVG\_NAMESPACE.equals(parentTag.namespace) && isPureSVGTag(element.getTagName(), parentTag)) { |
|  |  | result = new TagInformation(element.getTagName(), SVG\_NAMESPACE); |
|  |  | } else if (MATHML\_NAMESPACE.equals(parentTag.namespace) |
|  |  | && this.mathMLDefinitions.isMathMLTag(element.getTagName())) |
|  |  | { |
|  |  | result = new TagInformation(element.getTagName(), MATHML\_NAMESPACE); |
|  |  | } else if (areHTMLChildrenAllowed(parentTag)) { |
|  |  | // If HTML children are allowed, only allow the element if is actually an HTML element or the root |
|  |  | // element of MathML/SVG. |
|  |  | if ("math".equals(element.getTagName())) { |
|  |  | result = new TagInformation(element.getTagName(), MATHML\_NAMESPACE); |
|  |  | } else if ("svg".equals(element.getTagName())) { |
|  |  | result = new TagInformation(element.getTagName(), SVG\_NAMESPACE); |
|  |  | } else if (isPossiblyHtmlTag(element.getTagName())) { |
|  |  | result = new TagInformation(element.getTagName(), HTML\_NAMESPACE); |
|  |  | } |
|  |  | } |
|  |  | return result; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param tagName the tag name to check |
|  |  | \* @param parentTag the parent information |
|  |  | \* @return if the tag is an SVG tag and not also an HTML tag that is nested in an HTML integration point in SVG |
|  |  | \*/ |
|  |  | private boolean isPureSVGTag(String tagName, TagInformation parentTag) |
|  |  | { |
|  |  | return this.svgDefinitions.isSVGTag(tagName) && ( |
|  |  | !this.svgDefinitions.isHTMLIntegrationPoint(parentTag.tagName) |
|  |  | || !this.svgDefinitions.isCommonHTMLElement(tagName)); |
|  |  | } |
|  |  |  |
|  |  | private boolean areHTMLChildrenAllowed(TagInformation parent) |
|  |  | { |
|  |  | boolean result = HTML\_NAMESPACE.equals(parent.namespace); |
|  |  | result = result || (SVG\_NAMESPACE.equals(parent.namespace) |
|  |  | && this.svgDefinitions.isHTMLIntegrationPoint(parent.tagName)); |
|  |  | result = result || (MATHML\_NAMESPACE.equals(parent.namespace) |
|  |  | && this.mathMLDefinitions.isTextOrHTMLIntegrationPoint(parent.tagName)); |
|  |  | return result; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param tagName the tag name to check |
|  |  | \* @return if the given tag is neither a MathML tag nor an SVG tag that is also an HTML tag |
|  |  | \*/ |
|  |  | private boolean isPossiblyHtmlTag(String tagName) |
|  |  | { |
|  |  | return !this.mathMLDefinitions.isMathMLTag(tagName) |
|  |  | && (!this.svgDefinitions.isSVGTag(tagName) || this.svgDefinitions.isCommonHTMLElement(tagName)); |
|  |  | } |
|  |  |  |
|  |  | private List<Attr> getAttributes(Element element) |
|  |  | { |
|  |  | NamedNodeMap attributeNodes = element.getAttributes(); |
|  |  | List<Attr> result = new ArrayList<>(); |
|  |  |  |
|  |  | for (int i = 0, length = attributeNodes.getLength(); i < length; ++i) { |
|  |  | result.add((Attr) attributeNodes.item(i)); |
|  |  | } |
|  |  |  |
|  |  | return result; |
|  |  | } |
|  |  | } |

1 change: 1 addition & 0 deletions

1
[xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt](#diff-9791ca2c5cccf514e4d98069e69414ecebe0ec84698bb37c5d07eec9b6a7e5de "xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt")

Show comments

[View file](/xwiki/xwiki-commons/blob/b11eae9d82cb53f32962056b5faa73f3720c6182/xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -6,6 +6,7 @@ org.xwiki.xml.internal.html.filter.BodyFilter |
|  |  | org.xwiki.xml.internal.html.filter.ControlCharactersFilter |
|  |  | org.xwiki.xml.internal.html.filter.AttributeFilter |
|  |  | org.xwiki.xml.internal.html.filter.UniqueIdFilter |
|  |  | org.xwiki.xml.internal.html.filter.SanitizerFilter |
|  |  | org.xwiki.xml.internal.html.DefaultHTMLCleaner |
|  |  | org.xwiki.xml.internal.html.XWikiHTML5TagProvider |
|  |  | org.xwiki.xml.internal.html.DefaultHTMLElementSanitizer |
| Expand Down | |  |

16 changes: 16 additions & 0 deletions

16
[xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/HTMLUtilsTest.java](#diff-920132e5684f4b0bb3c9f2070eb712e37bd05eae65e1a67bb46f447926eb47f1 "xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/HTMLUtilsTest.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/b11eae9d82cb53f32962056b5faa73f3720c6182/xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/HTMLUtilsTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,11 +25,18 @@ |
|  |  | import org.junit.jupiter.api.Test; |
|  |  | import org.w3c.dom.Document; |
|  |  | import org.xwiki.component.manager.ComponentManager; |
|  |  | import org.xwiki.configuration.internal.RestrictedConfigurationSourceProvider; |
|  |  | import org.xwiki.context.internal.DefaultExecution; |
|  |  | import org.xwiki.test.annotation.ComponentList; |
|  |  | import org.xwiki.test.junit5.mockito.ComponentTest; |
|  |  | import org.xwiki.xml.internal.html.DefaultHTMLCleaner; |
|  |  | import org.xwiki.xml.internal.html.DefaultHTMLCleanerTest; |
|  |  | import org.xwiki.xml.internal.html.DefaultHTMLElementSanitizer; |
|  |  | import org.xwiki.xml.internal.html.HTMLDefinitions; |
|  |  | import org.xwiki.xml.internal.html.HTMLElementSanitizerConfiguration; |
|  |  | import org.xwiki.xml.internal.html.MathMLDefinitions; |
|  |  | import org.xwiki.xml.internal.html.SVGDefinitions; |
|  |  | import org.xwiki.xml.internal.html.SecureHTMLElementSanitizer; |
|  |  | import org.xwiki.xml.internal.html.XWikiHTML5TagProvider; |
|  |  | import org.xwiki.xml.internal.html.filter.AttributeFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.BodyFilter; |
| Expand All | | @@ -38,6 +45,7 @@ |
|  |  | import org.xwiki.xml.internal.html.filter.LinkFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.ListFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.ListItemFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.SanitizerFilter; |
|  |  |  |
|  |  | import static org.junit.jupiter.api.Assertions.assertEquals; |
|  |  | import static org.junit.jupiter.api.Assertions.assertFalse; |
| Expand All | | @@ -58,6 +66,14 @@ |
|  |  | BodyFilter.class, |
|  |  | AttributeFilter.class, |
|  |  | ControlCharactersFilter.class, |
|  |  | SanitizerFilter.class, |
|  |  | DefaultHTMLElementSanitizer.class, |
|  |  | SecureHTMLElementSanitizer.class, |
|  |  | HTMLElementSanitizerConfiguration.class, |
|  |  | RestrictedConfigurationSourceProvider.class, |
|  |  | HTMLDefinitions.class, |
|  |  | MathMLDefinitions.class, |
|  |  | SVGDefinitions.class, |
|  |  | DefaultHTMLCleaner.class, |
|  |  | DefaultExecution.class, |
|  |  | XWikiHTML5TagProvider.class |
| Expand Down | |  |

16 changes: 16 additions & 0 deletions

16
[...ore/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/filter/AbstractHTMLFilterTest.java](#diff-61dfbed3da7a57edf601df8e410f4ec6dc3b512d4898ff0d099cfd56fd715593 "xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/filter/AbstractHTMLFilterTest.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/b11eae9d82cb53f32962056b5faa73f3720c6182/xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/html/filter/AbstractHTMLFilterTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,11 +28,18 @@ |
|  |  | import org.w3c.dom.Document; |
|  |  | import org.w3c.dom.Element; |
|  |  | import org.xwiki.component.manager.ComponentManager; |
|  |  | import org.xwiki.configuration.internal.RestrictedConfigurationSourceProvider; |
|  |  | import org.xwiki.context.internal.DefaultExecution; |
|  |  | import org.xwiki.test.annotation.ComponentList; |
|  |  | import org.xwiki.test.junit5.mockito.ComponentTest; |
|  |  | import org.xwiki.xml.html.HTMLCleaner; |
|  |  | import org.xwiki.xml.internal.html.DefaultHTMLCleaner; |
|  |  | import org.xwiki.xml.internal.html.DefaultHTMLElementSanitizer; |
|  |  | import org.xwiki.xml.internal.html.HTMLDefinitions; |
|  |  | import org.xwiki.xml.internal.html.HTMLElementSanitizerConfiguration; |
|  |  | import org.xwiki.xml.internal.html.MathMLDefinitions; |
|  |  | import org.xwiki.xml.internal.html.SVGDefinitions; |
|  |  | import org.xwiki.xml.internal.html.SecureHTMLElementSanitizer; |
|  |  | import org.xwiki.xml.internal.html.XWikiHTML5TagProvider; |
|  |  | import org.xwiki.xml.internal.html.filter.AttributeFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.BodyFilter; |
| Expand All | | @@ -41,6 +48,7 @@ |
|  |  | import org.xwiki.xml.internal.html.filter.LinkFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.ListFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.ListItemFilter; |
|  |  | import org.xwiki.xml.internal.html.filter.SanitizerFilter; |
|  |  |  |
|  |  | import static org.junit.jupiter.api.Assertions.assertEquals; |
|  |  | import static org.junit.jupiter.api.Assertions.assertFalse; |
| Expand All | | @@ -63,6 +71,14 @@ |
|  |  | DefaultHTMLCleaner.class, |
|  |  | DefaultExecution.class, |
|  |  | ControlCharactersFilter.class, |
|  |  | SanitizerFilter.class, |
|  |  | DefaultHTMLElementSanitizer.class, |
|  |  | SecureHTMLElementSanitizer.class, |
|  |  | HTMLElementSanitizerConfiguration.class, |
|  |  | RestrictedConfigurationSourceProvider.class, |
|  |  | HTMLDefinitions.class, |
|  |  | MathMLDefinitions.class, |
|  |  | SVGDefinitions.class, |
|  |  | XWikiHTML5TagProvider.class |
|  |  | }) |
|  |  | // @formatter:on |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b11eae9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2Fb11eae9d82cb53f32962056b5faa73f3720c6182) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from jira.xwiki.org_47b7a670_20250115_093055.html ===


[Log in](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-9118)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![XWiki.org JIRA](/s/-65z3d2/930000/8ws80b/_/jira-logo-scaled.png)](https://jira.xwiki.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-093/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-093/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-9118)

![Uploaded image for project: 'XWiki Platform'](https://jira.xwiki.org/secure/projectavatar?pid=10010&avatarId=13602)

1. [XWiki Platform](/browse/XWIKI)
2. [XWIKI-9118](/browse/XWIKI-9118)

# XSS in restricted context via html macro

[Log In](/login.jsp?os_destination=%2Fbrowse%2FXWIKI-9118 "Log In")ClosedExportnull

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.") Bug
* **Resolution:**
  Solved By
* **Priority:**
  ![](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.") Blocker
* **Fix Version/s:**
  [14.6-rc-1](/issues/?jql=project+%3D+XWIKI+AND+fixVersion+%3D+14.6-rc-1 "14.6-rc-1 ")
* **Affects Version/s:**
  1.6 M1
* **Component/s:**
  [Display](/issues/?jql=project+%3D+XWIKI+AND+component+%3D+Display "Display Handles Displayers (Content, Title, Field,, etc)")
* **Labels:**
  + [attack\_xss](/issues/?jql=labels+%3D+attack_xss "attack_xss")
  + [attacker\_account](/issues/?jql=labels+%3D+attacker_account "attacker_account")
  + [security](/issues/?jql=labels+%3D+security "security")

* **Development Priority:**
  High
* **Difficulty:**
  Medium
* **Documentation:**
  N/A
* **Documentation in Release Notes:**
  N/A
* **Similar issues:**

#### Description

To reproduce, just put the following comment on any page :

```

{{html}}
<a href='' onclick='alert("xss")'>XSS</a>
{{/html}}

```

Comments are executed in a restricted context won which we disabled server side scripting for example, so it sounds equally necessary to filter out client side scripting.

#### Attachments

#### Issue Links

depends on

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XWIKI-18049](/browse/XWIKI-18049)
Improve the html escaping mechanism for XSS protection

* ![Critical - Crashes, loss of data, severe memory leak.](/images/icons/priorities/critical.svg "Critical - Crashes, loss of data, severe memory leak.")
* Closed

![Improvement - An improvement or enhancement to an existing feature or task.](/secure/viewavatar?size=xsmall&avatarId=13510&avatarType=issuetype "Improvement - An improvement or enhancement to an existing feature or task.")
[XCOMMONS-1680](/browse/XCOMMONS-1680)
Filter Html attributes in restricted mode based on a whitelist

* ![Major - Major loss of function.](/images/icons/priorities/major.svg "Major - Major loss of function.")
* Closed

is duplicated by

![Task - A task that needs to be done.](/secure/viewavatar?size=xsmall&avatarId=13518&avatarType=issuetype "Task - A task that needs to be done.")
[XWIKI-9147](/browse/XWIKI-9147)
Secure the HTML macro

* ![Major - Major loss of function.](/images/icons/priorities/major.svg "Major - Major loss of function.")
* Closed

![Improvement - An improvement or enhancement to an existing feature or task.](/secure/viewavatar?size=xsmall&avatarId=13510&avatarType=issuetype "Improvement - An improvement or enhancement to an existing feature or task.")
[XWIKI-4874](/browse/XWIKI-4874)
Restrict unsafe HTML/JavaScript features of Wiki syntax to trusted users

* ![Minor - Minor loss of function, or other problem where easy workaround is present.](/images/icons/priorities/minor.svg "Minor - Minor loss of function, or other problem where easy workaround is present.")
* Closed

is related to

![Task - A task that needs to be done.](/secure/viewavatar?size=xsmall&avatarId=13518&avatarType=issuetype "Task - A task that needs to be done.")
[XWIKI-7878](/browse/XWIKI-7878)
Add a 'restricted' parameter to transformation context to enable a safe rendering mode

* ![Critical - Crashes, loss of data, severe memory leak.](/images/icons/priorities/critical.svg "Critical - Crashes, loss of data, severe memory leak.")
* Closed

relates to

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XWIKI-18568](/browse/XWIKI-18568)
Multiple instances of stored cross-site scripting (XSS) via editor and HTML macro

* ![Blocker - Blocks development and/or testing work, production could not run.](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.")
* Closed

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XWIKI-19514](/browse/XWIKI-19514)
XSS using a JSX object

* ![Blocker - Blocks development and/or testing work, production could not run.](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.")
* Closed

links to

![Web Link](https://github.com/favicon.ico "Web Link")
[GitHub Security advisory](https://github.com/xwiki/xwiki-commons/security/advisories/GHSA-m3jr-cvhj-f35j)

Show 3 more links (2 relates to, 1 links to)

#### Activity

#### People

Assignee:

![MichaelHamann](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Michael Hamann

Reporter:

![thomas_delafosse](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Thomas Delafosse

Special Allowed Users:

 Alex Busenius,  Richard Curteis,  Stuart Walker

Votes:
0
Vote for this issue

Watchers:
3
Start watching this issue

#### Dates

Created:

07/May/13 16:32

Updated:

12/Apr/23 13:35

Resolved:

04/Jul/22 12:12

Date of First Response:

10/Mar/22 3:31 PM

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for XWiki.org. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from jira.xwiki.org_b8d8f0ae_20250115_093054.html ===


[Log in](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-1680)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![XWiki.org JIRA](/s/-65z3d2/930000/8ws80b/_/jira-logo-scaled.png)](https://jira.xwiki.org/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* Give feedback to Atlassian
* [Help](https://docs.atlassian.com/jira/jcore-docs-093/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-093/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-1680)

![Uploaded image for project: 'XWiki Commons'](https://jira.xwiki.org/secure/projectavatar?pid=10620&avatarId=13603)

1. [XWiki Commons](/browse/XCOMMONS)
2. [XCOMMONS-1680](/browse/XCOMMONS-1680)

# Filter Html attributes in restricted mode based on a whitelist

[Log In](/login.jsp?os_destination=%2Fbrowse%2FXCOMMONS-1680 "Log In")ClosedExportnull

XMLWordPrintable
#### Details

* **Type:**
  ![](/secure/viewavatar?size=xsmall&avatarId=13510&avatarType=issuetype "Improvement - An improvement or enhancement to an existing feature or task.") Improvement
* **Resolution:**
  Fixed
* **Priority:**
  ![](/images/icons/priorities/major.svg "Major - Major loss of function.") Major
* **Fix Version/s:**
  [14.6-rc-1](/issues/?jql=project+%3D+XCOMMONS+AND+fixVersion+%3D+14.6-rc-1 "14.6-rc-1 ")
* **Affects Version/s:**
  None
* **Component/s:**
  [XML](/issues/?jql=project+%3D+XCOMMONS+AND+component+%3D+XML "XML XML Module")
* **Labels:**
  None

* **Tests:**
  Unit
* **Difficulty:**
  Unknown
* **Documentation:**
  <https://extensions.xwiki.org/xwiki/bin/view/Extension/XML%20Module>
* **Documentation in Release Notes:**
  <https://www.xwiki.org/xwiki/bin/view/ReleaseNotes/Data/XWiki/14.6RC1/Entry001/>
* **Similar issues:**

#### Attachments

#### Issue Links

blocks

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XRENDERING-663](/browse/XRENDERING-663)
XSS Javascript injection via XWiki 2.x syntax

* ![Blocker - Blocks development and/or testing work, production could not run.](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.")
* Closed

![Bug - A problem which impairs or prevents the functions of the product.](/secure/viewavatar?size=xsmall&avatarId=13503&avatarType=issuetype "Bug - A problem which impairs or prevents the functions of the product.")
[XWIKI-9118](/browse/XWIKI-9118)
XSS in restricted context via html macro

* ![Blocker - Blocks development and/or testing work, production could not run.](/images/icons/priorities/blocker.svg "Blocker - Blocks development and/or testing work, production could not run.")
* Closed

#### Activity

#### People

Assignee:

![MichaelHamann](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Michael Hamann

Reporter:

![surli](https://jira.xwiki.org/secure/useravatar?size=small&avatarId=10222)
Simon Urli

Votes:
0
Vote for this issue

Watchers:
1
Start watching this issue

#### Dates

Created:

25/Jul/19 10:14

Updated:

13/Jul/22 11:39

Resolved:

30/Jun/22 15:40

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for XWiki.org. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)



=== Content from github.com_1bb37f9a_20250115_093050.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2F4a185e0594d90cd4916d60aa60bb4333dc5623b2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2F4a185e0594d90cd4916d60aa60bb4333dc5623b2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=xwiki%2Fxwiki-commons)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xwiki](/xwiki)
/
**[xwiki-commons](/xwiki/xwiki-commons)**
Public

* [Notifications](/login?return_to=%2Fxwiki%2Fxwiki-commons) You must be signed in to change notification settings
* [Fork
  123](/login?return_to=%2Fxwiki%2Fxwiki-commons)
* [Star
   85](/login?return_to=%2Fxwiki%2Fxwiki-commons)

* [Code](/xwiki/xwiki-commons)
* [Pull requests
  28](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects
  0](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

Additional navigation options

* [Code](/xwiki/xwiki-commons)
* [Pull requests](/xwiki/xwiki-commons/pulls)
* [Actions](/xwiki/xwiki-commons/actions)
* [Projects](/xwiki/xwiki-commons/projects)
* [Security](/xwiki/xwiki-commons/security)
* [Insights](/xwiki/xwiki-commons/pulse)

## Commit

[Permalink](/xwiki/xwiki-commons/commit/4a185e0594d90cd4916d60aa60bb4333dc5623b2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

XCOMMONS-2426: Provide a component for filtering safe HTML elements a…

[Browse files](/xwiki/xwiki-commons/tree/4a185e0594d90cd4916d60aa60bb4333dc5623b2)
Browse the repository at this point in the history

```
…nd attributes

* Add an interface and two implementations for an HTML element sanitizer.
* Let the default implementation dispatch to the different
  implementations depending on a configuration.
* Allow overriding the hint from the execution context to allow a
  context to be more permissive than another.
* Add configuration options for allowed elements/attributes
* Add tests.
```

* Loading branch information

[![@michitux](https://avatars.githubusercontent.com/u/198317?s=40&v=4)](/michitux)

[michitux](/xwiki/xwiki-commons/commits?author=michitux "View all commits by michitux")
committed
Jun 30, 2022

1 parent
[67aeae5](/xwiki/xwiki-commons/commit/67aeae54995f939142d28ca6e9403c9c1b01fe2c)

commit 4a185e0

 Show file tree

 Hide file tree

Showing
**14 changed files**
with
**1,484 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* xwiki-commons-core/xwiki-commons-xml

  + xwiki-commons-core/xwiki-commons-xml/pom.xml
    [pom.xml](#diff-6d95c5ec8cfc049e6a54245728bc1bc4148165fc6fe5e5d880a741eccb5514f8)
  + src

    - main

      * checkstyle

        + xwiki-commons-core/xwiki-commons-xml/src/main/checkstyle/checkstyle-suppressions.xml
          [checkstyle-suppressions.xml](#diff-b969376053ec024bf791243a1b664247e98b36b31ff69055fd0523d4b92acdce)
      * java/org/xwiki/xml

        + html

          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/html/HTMLElementSanitizer.java
            [HTMLElementSanitizer.java](#diff-5e167e2971b42bbbdabc6b1d284e130fb5bc83287c454a7b4cdfeecf371c7d6c)
        + internal/html

          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizer.java
            [DefaultHTMLElementSanitizer.java](#diff-48da7a8e3c2ac5abc56de4a0a09e321e276f0342dce19985ede2c8a9e88e4604)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLDefinitions.java
            [HTMLDefinitions.java](#diff-f55f414e4a311d91beae1590bb2fdd64e6a19927164e680eb3f942107344306f)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLElementSanitizerConfiguration.java
            [HTMLElementSanitizerConfiguration.java](#diff-84dda2c222b9b473f90b51114491ef75159ba851b10cd5ffb05c90520be85fec)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/InsecureHTMLElementSanitizer.java
            [InsecureHTMLElementSanitizer.java](#diff-b3443181d4c411687090312fc4d9d84061d399f05a5d8f9112a7a0e6d1874ec3)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/MathMLDefinitions.java
            [MathMLDefinitions.java](#diff-fffe3fc6fa21256a26a5589023497cefcbaac792a3811efec23cd95c4e2483f5)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/SVGDefinitions.java
            [SVGDefinitions.java](#diff-1eddaf9bdefd5638c2f5642fde48b0b570bd57397383a1fb1365b0fed66512da)
          - xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/SecureHTMLElementSanitizer.java
            [SecureHTMLElementSanitizer.java](#diff-a6e2b25a8d464e37748e2ee1522cfbb80beaa8d61f8d2aa51be58828646670d9)
      * resources/META-INF

        + xwiki-commons-core/xwiki-commons-xml/src/main/resources/META-INF/components.txt
          [components.txt](#diff-9791ca2c5cccf514e4d98069e69414ecebe0ec84698bb37c5d07eec9b6a7e5de)
    - test/java/org/xwiki/xml/internal/html

      * xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizerTest.java
        [DefaultHTMLElementSanitizerTest.java](#diff-0c68afba5463e2d68b5144c5b3370be5fcd14a602f191628b874498628f01a48)
      * xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/HTMLElementSanitizerTest.java
        [HTMLElementSanitizerTest.java](#diff-4350131e943f30fa1e4f79be313086bd9e491f5b56a0edd961e60715acaf3694)
      * xwiki-commons-core/xwiki-commons-xml/src/test/java/org/xwiki/xml/internal/html/SecureHTMLElementSanitizerTest.java
        [SecureHTMLElementSanitizerTest.java](#diff-9ec24c98ad2b6c1bae254e165d489e7e44bd184746722670a3e256f05cc71976)

## There are no files selected for viewing

7 changes: 6 additions & 1 deletion

7
[xwiki-commons-core/xwiki-commons-xml/pom.xml](#diff-6d95c5ec8cfc049e6a54245728bc1bc4148165fc6fe5e5d880a741eccb5514f8 "xwiki-commons-core/xwiki-commons-xml/pom.xml")

Show comments

[View file](/xwiki/xwiki-commons/blob/4a185e0594d90cd4916d60aa60bb4333dc5623b2/xwiki-commons-core/xwiki-commons-xml/pom.xml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,7 +32,7 @@ |
|  |  | <packaging>jar</packaging> |
|  |  | <description>XWiki Commons - XML</description> |
|  |  | <properties> |
|  |  | <xwiki.jacoco.instructionRatio>0.72</xwiki.jacoco.instructionRatio> |
|  |  | <xwiki.jacoco.instructionRatio>0.82</xwiki.jacoco.instructionRatio> |
|  |  | <!-- There's a utility class with lots of features, allow it to have many dependencies; |
|  |  | There's a SAX event listener, which requires complex code --> |
|  |  | <checkstyle.suppressions.location>${basedir}/src/main/checkstyle/checkstyle-suppressions.xml |
| Expand All | | @@ -53,6 +53,11 @@ |
|  |  | <artifactId>xwiki-commons-context</artifactId> |
|  |  | <version>${project.version}</version> |
|  |  | </dependency> |
|  |  | <dependency> |
|  |  | <groupId>org.xwiki.commons</groupId> |
|  |  | <artifactId>xwiki-commons-configuration-api</artifactId> |
|  |  | <version>${project.version}</version> |
|  |  | </dependency> |
|  |  | <dependency> |
|  |  | <groupId>org.apache.commons</groupId> |
|  |  | <artifactId>commons-lang3</artifactId> |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[xwiki-commons-core/xwiki-commons-xml/src/main/checkstyle/checkstyle-suppressions.xml](#diff-b969376053ec024bf791243a1b664247e98b36b31ff69055fd0523d4b92acdce "xwiki-commons-core/xwiki-commons-xml/src/main/checkstyle/checkstyle-suppressions.xml")

Show comments

[View file](/xwiki/xwiki-commons/blob/4a185e0594d90cd4916d60aa60bb4333dc5623b2/xwiki-commons-core/xwiki-commons-xml/src/main/checkstyle/checkstyle-suppressions.xml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -36,4 +36,9 @@ |
|  |  | <!-- XWikiDomSerializer copied from DomSerializer --> |
|  |  | <suppress checks="CyclomaticComplexity" files="XWikiDOMSerializer" /> |
|  |  | <suppress checks="NPathComplexity" files="XWikiDOMSerializer" /> |
|  |  |  |
|  |  | <!-- These files have lists of strings copied from a source, making them constants would complicate updating from |
|  |  | upstream. --> |
|  |  | <suppress checks="MultipleStringLiterals" |
|  |  | files="SecureHTMLElementSanitizer.java|HTMLDefinitions.java|MathMLDefinitions.java|SVGDefinitions.java"/> |
|  |  | </suppressions> |

55 changes: 55 additions & 0 deletions

55
[...commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/html/HTMLElementSanitizer.java](#diff-5e167e2971b42bbbdabc6b1d284e130fb5bc83287c454a7b4cdfeecf371c7d6c "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/html/HTMLElementSanitizer.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/4a185e0594d90cd4916d60aa60bb4333dc5623b2/xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/html/HTMLElementSanitizer.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,55 @@ |
|  |  | /\* |
|  |  | \* See the NOTICE file distributed with this work for additional |
|  |  | \* information regarding copyright ownership. |
|  |  | \* |
|  |  | \* This is free software; you can redistribute it and/or modify it |
|  |  | \* under the terms of the GNU Lesser General Public License as |
|  |  | \* published by the Free Software Foundation; either version 2.1 of |
|  |  | \* the License, or (at your option) any later version. |
|  |  | \* |
|  |  | \* This software is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU |
|  |  | \* Lesser General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU Lesser General Public |
|  |  | \* License along with this software; if not, write to the Free |
|  |  | \* Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA |
|  |  | \* 02110-1301 USA, or see the FSF site: http://www.fsf.org. |
|  |  | \*/ |
|  |  | package org.xwiki.xml.html; |
|  |  |  |
|  |  | import org.xwiki.component.annotation.Role; |
|  |  | import org.xwiki.stability.Unstable; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Provides methods to check if HTML elements and attributes/attribute values are considered safe. |
|  |  | \* <p> |
|  |  | \* This also includes SVG and MathML elements and attributes. |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \* @since 14.6RC1 |
|  |  | \*/ |
|  |  | @Role |
|  |  | @Unstable |
|  |  | public interface HTMLElementSanitizer |
|  |  | { |
|  |  | /\*\* |
|  |  | \* The key under which a hint can be stored that will be used by the default implementation. |
|  |  | \*/ |
|  |  | String EXECUTION\_CONTEXT\_HINT\_KEY = "xml.html.htmlElementSanitizerHint"; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param elementName the name of the HTML element |
|  |  | \* @return {@code true} if the given element is allowed in principle (given appropriate attributes) |
|  |  | \*/ |
|  |  | boolean isElementAllowed(String elementName); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param elementName the element for which the attributes shall be checked |
|  |  | \* @param attributeName the attributes to check |
|  |  | \* @param value the value of the attribute |
|  |  | \* @return {@code true} if the attribute with this value is considered safe |
|  |  | \*/ |
|  |  | boolean isAttributeAllowed(String elementName, String attributeName, String value); |
|  |  | } |

135 changes: 135 additions & 0 deletions

135
[...ki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizer.java](#diff-48da7a8e3c2ac5abc56de4a0a09e321e276f0342dce19985ede2c8a9e88e4604 "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizer.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/4a185e0594d90cd4916d60aa60bb4333dc5623b2/xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/DefaultHTMLElementSanitizer.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,135 @@ |
|  |  | /\* |
|  |  | \* See the NOTICE file distributed with this work for additional |
|  |  | \* information regarding copyright ownership. |
|  |  | \* |
|  |  | \* This is free software; you can redistribute it and/or modify it |
|  |  | \* under the terms of the GNU Lesser General Public License as |
|  |  | \* published by the Free Software Foundation; either version 2.1 of |
|  |  | \* the License, or (at your option) any later version. |
|  |  | \* |
|  |  | \* This software is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU |
|  |  | \* Lesser General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU Lesser General Public |
|  |  | \* License along with this software; if not, write to the Free |
|  |  | \* Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA |
|  |  | \* 02110-1301 USA, or see the FSF site: http://www.fsf.org. |
|  |  | \*/ |
|  |  | package org.xwiki.xml.internal.html; |
|  |  |  |
|  |  | import javax.inject.Inject; |
|  |  | import javax.inject.Named; |
|  |  | import javax.inject.Provider; |
|  |  | import javax.inject.Singleton; |
|  |  |  |
|  |  | import org.apache.commons.lang3.exception.ExceptionUtils; |
|  |  | import org.slf4j.Logger; |
|  |  | import org.xwiki.component.annotation.Component; |
|  |  | import org.xwiki.component.manager.ComponentLookupException; |
|  |  | import org.xwiki.component.manager.ComponentManager; |
|  |  | import org.xwiki.component.phase.Initializable; |
|  |  | import org.xwiki.component.phase.InitializationException; |
|  |  | import org.xwiki.configuration.ConfigurationSource; |
|  |  | import org.xwiki.context.Execution; |
|  |  | import org.xwiki.context.ExecutionContext; |
|  |  | import org.xwiki.stability.Unstable; |
|  |  | import org.xwiki.xml.html.HTMLElementSanitizer; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Default {@link HTMLElementSanitizer} that loads the implementation chosen by the configuration. |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \* @since 14.6RC1 |
|  |  | \*/ |
|  |  | @Component |
|  |  | @Singleton |
|  |  | @Unstable |
|  |  | public class DefaultHTMLElementSanitizer implements HTMLElementSanitizer, Initializable |
|  |  | { |
|  |  | private static final String CONFIGURATION\_KEY = "xml.htmlElementSanitizer"; |
|  |  |  |
|  |  | private HTMLElementSanitizer implementation; |
|  |  |  |
|  |  | @Inject |
|  |  | @Named("restricted") |
|  |  | private Provider<ConfigurationSource> configurationSourceProvider; |
|  |  |  |
|  |  | @Inject |
|  |  | private Execution execution; |
|  |  |  |
|  |  | @Inject |
|  |  | private Provider<ComponentManager> componentManagerProvider; |
|  |  |  |
|  |  | @Inject |
|  |  | private Logger logger; |
|  |  |  |
|  |  | @Override |
|  |  | public void initialize() throws InitializationException |
|  |  | { |
|  |  |  |
|  |  | ConfigurationSource configurationSource = this.configurationSourceProvider.get(); |
|  |  |  |
|  |  | String hint; |
|  |  | if (configurationSource != null) { |
|  |  | hint = configurationSource.getProperty(CONFIGURATION\_KEY, SecureHTMLElementSanitizer.HINT); |
|  |  | } else { |
|  |  | hint = SecureHTMLElementSanitizer.HINT; |
|  |  | } |
|  |  |  |
|  |  | try { |
|  |  | this.implementation = loadImplementationWithSecureFallback(hint); |
|  |  | } catch (ComponentLookupException ex) { |
|  |  | throw new InitializationException("Couldn't initialize the default secure HTMLElementSanitizer", ex); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | private HTMLElementSanitizer loadImplementationWithSecureFallback(String hint) throws ComponentLookupException |
|  |  | { |
|  |  | ComponentManager componentManager = this.componentManagerProvider.get(); |
|  |  | HTMLElementSanitizer result; |
|  |  |  |
|  |  | try { |
|  |  | result = componentManager.getInstance(HTMLElementSanitizer.class, hint); |
|  |  | } catch (ComponentLookupException e) { |
|  |  | this.logger.error("Couldn't load the configured HTMLElementSanitizer with hint [{}], falling back to the " |
|  |  | + "default secure implementation: {}", hint, ExceptionUtils.getRootCauseMessage(e)); |
|  |  | result = componentManager.getInstance(HTMLElementSanitizer.class, SecureHTMLElementSanitizer.HINT); |
|  |  | } |
|  |  |  |
|  |  | return result; |
|  |  | } |
|  |  |  |
|  |  | private HTMLElementSanitizer getImplementation() |
|  |  | { |
|  |  | ExecutionContext context = this.execution.getContext(); |
|  |  |  |
|  |  | HTMLElementSanitizer result = this.implementation; |
|  |  |  |
|  |  | if (context != null && context.hasProperty(HTMLElementSanitizer.EXECUTION\_CONTEXT\_HINT\_KEY)) { |
|  |  | String hint = (String) context.getProperty(HTMLElementSanitizer.EXECUTION\_CONTEXT\_HINT\_KEY); |
|  |  |  |
|  |  | try { |
|  |  | result = this.componentManagerProvider.get().getInstance(HTMLElementSanitizer.class, hint); |
|  |  | } catch (ComponentLookupException e) { |
|  |  | this.logger.error("Couldn't load the HTMLElementSanitizer with hint [{}] from the execution context, " |
|  |  | + "falling back to the configured implementation: {}", hint, ExceptionUtils.getRootCauseMessage(e)); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return result; |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public boolean isElementAllowed(String elementName) |
|  |  | { |
|  |  | return getImplementation().isElementAllowed(elementName); |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public boolean isAttributeAllowed(String elementName, String attributeName, String value) |
|  |  | { |
|  |  | return getImplementation().isAttributeAllowed(elementName, attributeName, value); |
|  |  | } |
|  |  | } |

110 changes: 110 additions & 0 deletions

110
[...ons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLDefinitions.java](#diff-f55f414e4a311d91beae1590bb2fdd64e6a19927164e680eb3f942107344306f "xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLDefinitions.java")

Show comments

[View file](/xwiki/xwiki-commons/blob/4a185e0594d90cd4916d60aa60bb4333dc5623b2/xwiki-commons-core/xwiki-commons-xml/src/main/java/org/xwiki/xml/internal/html/HTMLDefinitions.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,110 @@ |
|  |  | /\* |
|  |  | \* See the NOTICE file distributed with this work for additional |
|  |  | \* information regarding copyright ownership. |
|  |  | \* |
|  |  | \* This is free software; you can redistribute it and/or modify it |
|  |  | \* under the terms of the GNU Lesser General Public License as |
|  |  | \* published by the Free Software Foundation; either version 2.1 of |
|  |  | \* the License, or (at your option) any later version. |
|  |  | \* |
|  |  | \* This software is distributed in the hope that it will be useful, |
|  |  | \* but WITHOUT ANY WARRANTY; without even the implied warranty of |
|  |  | \* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU |
|  |  | \* Lesser General Public License for more details. |
|  |  | \* |
|  |  | \* You should have received a copy of the GNU Lesser General Public |
|  |  | \* License along with this software; if not, write to the Free |
|  |  | \* Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA |
|  |  | \* 02110-1301 USA, or see the FSF site: http://www.fsf.org. |
|  |  | \*/ |
|  |  | /\* |
|  |  | \* Alternatively, at your choice, the contents of this file may be used under the terms of the Mozilla Public License, |
|  |  | \* v. 2.0. If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/. |
|  |  | \*/ |
|  |  | package org.xwiki.xml.internal.html; |
|  |  |  |
|  |  | import java.util.Arrays; |
|  |  | import java.util.HashSet; |
|  |  | import java.util.Set; |
|  |  |  |
|  |  | import javax.inject.Singleton; |
|  |  |  |
|  |  | import org.xwiki.component.annotation.Component; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Provides definitions of safe HTML attributes and tags. |
|  |  | \* <p> |
|  |  | \* Unless otherwise noted, lists of elements and attributes are copied from DOMPurify by Cure53 and other contributors | |
|  |  | \* Released under the Apache license 2.0 and Mozilla Public License 2.0 - |
|  |  | \* <a href="https://github.com/cure53/DOMPurify/blob/main/LICENSE">LICENSE</a>. |
|  |  | \* |
|  |  | \* @version $Id$ |
|  |  | \* @since 14.6RC1 |
|  |  | \*/ |
|  |  | @Component(roles = HTMLDefinitions.class) |
|  |  | @Singleton |
|  |  | public class HTMLDefinitions |
|  |  | { |
|  |  | /\*\* |
|  |  | \* Allowed HTML elements. |
|  |  | \*/ |
|  |  | private final Set<String> htmlTags; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Allowed attributes. |
|  |  | \*/ |
|  |  | private final Set<String> htmlAttributes; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Default constructor. |
|  |  | \*/ |
|  |  | public HTMLDefinitions() |
|  |  | { |
|  |  | this.htmlTags = new HashSet<>( |
|  |  | Arrays.asList("a", "abbr", "acronym", "address", "area", "article", "aside", "audio", "b", "bdi", "bdo", |
|  |  | "big", "blink", "blockquote", "body", "br", "button", "canvas", "caption", "center", "cite", "code", |
|  |  | "col", "colgroup", "content", "data", "datalist", "dd", "decorator", "del", "details", "dfn", "dialog", |
|  |  | "dir", "div", "dl", "dt", "element", "em", "fieldset", "figcaption", "figure", "font", "footer", "form", |
|  |  | "h1", "h2", "h3", "h4", "h5", "h6", "head", "header", "hgroup", "hr", "html", "i", "img", "input", |
|  |  | "ins", "kbd", "label", "legend", "li", "main", "map", "mark", "marquee", "menu", "menuitem", "meter", |
|  |  | "nav", "nobr", "ol", "optgroup", "option", "output", "p", "picture", "pre", "progress", "q", "rp", "rt", |
|  |  | "ruby", "s", "samp", "section", "select", "shadow", "small", "source", "spacer", "span", "strike", |
|  |  | "strong", "style", "sub", "summary", "sup", "table", "tbody", "td", "template", "textarea", "tfoot", |
|  |  | "th", "thead", "time", "tr", "track", "tt", "u", "ul", "var", "video", "wbr")); |
|  |  |  |
|  |  | // Attributes that are in general allowed. Note that "target" is not generally safe, but XWiki contains code |
|  |  | // that already adds the necessary attributes to make it safe both in HTMLCleaner and in XHTML rendering. |
|  |  | this.htmlAttributes = new HashSet<>( |
|  |  | Arrays.asList("accept", "action", "align", "alt", "autocapitalize", "autocomplete", "autopictureinpicture", |
|  |  | "autoplay", "background", "bgcolor", "border", "capture", "cellpadding", "cellspacing", "checked", |
|  |  | "cite", "class", "clear", "color", "cols", "colspan", "controls", "controlslist", "coords", |
|  |  | "crossorigin", "datetime", "decoding", "default", "dir", "disabled", "disablepictureinpicture", |
|  |  | "disableremoteplayback", "download", "draggable", "enctype", "enterkeyhint", "face", "for", "headers", |
|  |  | "height", "hidden", "high", "href", "hreflang", "id", "inputmode", "integrity", "ismap", "kind", |
|  |  | "label", "lang", "list", "loading", "loop", "low", "max", "maxlength", "media", "method", "min", |
|  |  | "minlength", "multiple", "muted", "name", "nonce", "noshade", "novalidate", "nowrap", "open", "optimum", |
|  |  | "pattern", "placeholder", "playsinline", "poster", "preload", "pubdate", "radiogroup", "readonly", |
|  |  | "rel", "required", "rev", "reversed", "role", "rows", "rowspan", "spellcheck", "scope", "selected", |
|  |  | "shape", "size", "sizes", "span", "srclang", "start", "src", "srcset", "step", "style", "summary", |
|  |  | "tabindex", "title", "translate", "type", "usemap", "valign", "value", "width", "xmlns", "slot", |
|  |  | "target")); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param tagName the name of the tag to check |
|  |  | \* @return if the tag is considered safe |
|  |  | \*/ |
|  |  | public boolean isSafeTag(String tagName) |
|  |  | { |
|  |  | return this.htmlTags.contains(tagName); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param attributeName the name of the attribute to check |
|  |  | \* @return if the attribute is allowed |
|  |  | \*/ |
|  |  | public boolean isAllowedAttribute(String attributeName) |
|  |  | { |
|  |  | return this.htmlAttributes.contains(attributeName); |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4a185e0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxwiki%2Fxwiki-commons%2Fcommit%2F4a185e0594d90cd4916d60aa60bb4333dc5623b2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


