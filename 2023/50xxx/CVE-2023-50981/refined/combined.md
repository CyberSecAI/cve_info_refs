=== Content from github.com_d86c657e_20250114_212925.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fweidai11%2Fcryptopp%2Fissues%2F1249)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fweidai11%2Fcryptopp%2Fissues%2F1249)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=weidai11%2Fcryptopp)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[weidai11](/weidai11)
/
**[cryptopp](/weidai11/cryptopp)**
Public

* [Notifications](/login?return_to=%2Fweidai11%2Fcryptopp) You must be signed in to change notification settings
* [Fork
  1.5k](/login?return_to=%2Fweidai11%2Fcryptopp)
* [Star
   5k](/login?return_to=%2Fweidai11%2Fcryptopp)

* [Code](/weidai11/cryptopp)
* [Issues
  52](/weidai11/cryptopp/issues)
* [Pull requests
  11](/weidai11/cryptopp/pulls)
* [Actions](/weidai11/cryptopp/actions)
* [Projects
  0](/weidai11/cryptopp/projects)
* [Security](/weidai11/cryptopp/security)
* [Insights](/weidai11/cryptopp/pulse)

Additional navigation options

* [Code](/weidai11/cryptopp)
* [Issues](/weidai11/cryptopp/issues)
* [Pull requests](/weidai11/cryptopp/pulls)
* [Actions](/weidai11/cryptopp/actions)
* [Projects](/weidai11/cryptopp/projects)
* [Security](/weidai11/cryptopp/security)
* [Insights](/weidai11/cryptopp/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fweidai11%2Fcryptopp%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fweidai11%2Fcryptopp%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# A security issue in the `ModularSquareRoot` function leads to a DOS attack #1249

Open

[roadicing](/roadicing) opened this issue
Nov 20, 2023
· 10 comments
 · May be fixed by [#1255](https://github.com/weidai11/cryptopp/pull/1255)

Open

# [A security issue in the `ModularSquareRoot` function leads to a DOS attack](#top) #1249

[roadicing](/roadicing) opened this issue
Nov 20, 2023
· 10 comments
 · May be fixed by [#1255](https://github.com/weidai11/cryptopp/pull/1255)

## Comments

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

### **[roadicing](/roadicing)** commented [Nov 20, 2023](#issue-2002042178) • edited Loading

| Hi, recently I found a security issue in the [ModularSquareRoot](https://github.com/weidai11/cryptopp/blob/3e3b8af96d4d957b77588be91df7715efbe2ed69/nbtheory.cpp#L544) function of `Crypto++` library that would cause an infinite loop, since this function is being used in [ECP::DecodePoint](https://github.com/weidai11/cryptopp/blob/93208e83937a351babdfd9cfa07d7908ba15f68b/ecp.cpp#L117), an attacker could potentially craft a malformed DER public key file, and any user or server attempting to read this public key file in processes such as ECDSA may be susceptible to a DOS attack. Issue The issue lies in [the second while loop](https://github.com/weidai11/cryptopp/blob/3e3b8af96d4d957b77588be91df7715efbe2ed69/nbtheory.cpp#L558) in this function, the loop starts with `n = 2` and increments `n` by one each time until we find an `n` such that `Jacobi(n, p) = -1`. However, this overlooks the case when `p` is in the form of `m^2` and `m` is an odd number.  In this case, `jacobi(n, p) = jacobi(n, m^2)` can be converted into the product of a series of squares of Jacobi symbols using the properties of Jacobi symbols, this means that its value can only be `1` or `0` but not `-1`, therefore, no matter how `n` continues to increase, it will never satisfy `Jacobi(n, p) = -1` to break out of the loop, thus leading to an infinite loop.  Furthermore, since this function is being used in `ECP::DecodePoint`, we can construct a malformed DER public key file that includes an elliptic curve parameter `p` as:  ``` 72358384006116823815439217615866351214375729203207450702838342058601772551609  ```  which is the square of:  ``` 268995137513890432434389773128616504853  ```  and repackage it into a DER file, then any attempt to read and parse this DER file in `Crypto++` will trigger an infinite loop immediately.  In addition, since the `ModularSquareRoot` function is in the branch that handles `03` compression encoding, we need to ensure that the points in the constructed DER file are in compressed form (start with `03`). Fix To fix this issue, the simplest method is to check whether `p` is a prime number at the beginning of the `ModularSquareRoot` function. If it is not a prime number, then directly reject any further calculations (after all, even if it is not rejected, the result calculated in this way will be wrong). |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=40&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)
[roadicing](/roadicing)
linked a pull request
[Dec 20, 2023](#ref-pullrequest-2049981683)
that will
close
this issue

[Validate p in ModularSquareRoot
#1255](/weidai11/cryptopp/pull/1255)
 Open

[![@noloader](https://avatars.githubusercontent.com/u/3538226?s=80&u=254e47b655f2f85bc78c793cbc5a2f44331191fe&v=4)](/noloader)

Copy link

Collaborator

### **[noloader](/noloader)** commented [Jun 10, 2024](#issuecomment-2158442602) • edited Loading

| Thanks [@roadicing](https://github.com/roadicing),  The docs for `ModularSquareRoot` already states `p` must be prime. I think the problem is in the callers. Internal callers like `ECP::DecodePoint` need to perform the check before calling `ModularSquareRoot`, just like external callers.   ---   ``` $ grep ModularSquareRoot *.h *.cpp nbtheory.h:... ecp.cpp:                P.y = ModularSquareRoot(P.y, p); nbtheory.cpp:Integer ModularSquareRoot(const Integer &a, const Integer &p) nbtheory.cpp:           Integer s = ModularSquareRoot(D, p); rabin.cpp:      cp = ModularSquareRoot(cp, m_p); rabin.cpp:      cq = ModularSquareRoot(cq, m_q); ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

Author

### **[roadicing](/roadicing)** commented [Jun 10, 2024](#issuecomment-2158495527) • edited Loading

| Hi [@noloader](https://github.com/noloader)  Yes, considering that users are directly vulnerable to DoS attacks when using the API as shown below to parse external public key files (also including parsing certificates using APIs from `cryptopp-pem`):  ``` DL_PublicKey_EC<ECP> pubKey; FileSource fs(".malformed-pub.der", true); pubKey.Load(fs); // infinite loop  ```  I think it is necessary to introduce a check for whether `p` is a prime number, at least in [ECP::DecodePoint](https://github.com/weidai11/cryptopp/blob/93208e83937a351babdfd9cfa07d7908ba15f68b/ecp.cpp#L105C6-L105C22). |
| --- |

All reactions

Sorry, something went wrong.

[noloader](/noloader)
added a commit
that referenced
this issue
[Jun 10, 2024](#ref-commit-9aa07ae)
[![@noloader](https://avatars.githubusercontent.com/u/3538226?s=40&u=254e47b655f2f85bc78c793cbc5a2f44331191fe&v=4)](/noloader)

`[Guard use of ModularSquareRoot (GH](/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73 "Guard use of ModularSquareRoot (GH #1249)") [#1249](https://github.com/weidai11/cryptopp/issues/1249)[)](/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73 "Guard use of ModularSquareRoot (GH #1249)")`

`[9aa07ae](/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73)`

[![@noloader](https://avatars.githubusercontent.com/u/3538226?s=80&u=254e47b655f2f85bc78c793cbc5a2f44331191fe&v=4)](/noloader)

Copy link

Collaborator

### **[noloader](/noloader)** commented [Jun 10, 2024](#issuecomment-2158933288)

| [@roadicing](https://github.com/roadicing) ,  Take a look at [9aa07aebbdc6](https://github.com/weidai11/cryptopp/commit/9aa07aebbdc6) and see if it helps. |
| --- |

All reactions

Sorry, something went wrong.

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

Author

### **[roadicing](/roadicing)** commented [Jun 10, 2024](#issuecomment-2159016157) • edited Loading

| [@noloader](https://github.com/noloader)  Yes, I think it is feasible. However, since primality testing can also become time-consuming when the `p` contained in the external public key or certificate is extremely large, a more recommended approach is to also check the size of `p` before testing its primality in `ECP::DecodePoint`. Currently, the largest `p` used in NIST-recommended ECDSA parameters is 521 bits, which can serve as a reasonable upper bound. |
| --- |

All reactions

Sorry, something went wrong.

[![@noloader](https://avatars.githubusercontent.com/u/3538226?s=80&u=254e47b655f2f85bc78c793cbc5a2f44331191fe&v=4)](/noloader)

Copy link

Collaborator

### **[noloader](/noloader)** commented [Jun 10, 2024](#issuecomment-2159077697)

| external public key or certificate is extremely large, a more recommended approach is to also check the size of p before testing its primality in ECP::DecodePoint. Currently, the largest p used in NIST-recommended ECDSA parameters is 521 bits, which can serve as a reasonable upper bound.  I disagree with this one. All security parameters must be checked before use. If you don't validate it, then you can't use it. If you can't use it, then there's no sense in even loading it.  (And I don't buy into the crap like [CVE-2023-3446](https://github.com/advisories/GHSA-3p3x-vg38-6g9q "CVE-2023-3446")). |
| --- |

All reactions

Sorry, something went wrong.

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

Author

### **[roadicing](/roadicing)** commented [Jun 11, 2024](#issuecomment-2159586360) • edited Loading

| Hi [@noloader](https://github.com/noloader)  The issue is that in the current version with primality checks added, an attacker can change their approach by constructing an ECDSA public key containing a very large prime number. Consequently, any user who uses the API in the same way as before the fix will still be vulnerable to a DoS attack. The difference is that before the fix, it was an infinite loop, whereas after the fix, it becomes a pseudo-infinite loop with the duration depending on the size of the prime number. When the prime number used by the attacker is extremely large (e.g., 20,000 bits), the time consumed by the pseudo-infinite loop is still very significant.  In the current fixes applied by other algorithm libraries, they generally adopt a combination of primality checks and limiting the size of p. In fact, there are other fix approaches (such as changing the implementation of finding the smallest quadratic non-residue in the `ModularSquareRoot` function as mentioned in the original email, OpenSSL also uses this method). However, this would require more modifications to the implementation from the fix perspective. Therefore, if you do not consider the time cost caused by checking excessively large prime numbers to be a threat, then adding only primality checks would also be acceptable.  However, I feel that adding primality checks within the `ModularSquareRoot` function already covers the necessary validation. With primality checks already added within this function, conducting further primality checks in other external functions like `ECP::DecodePoint` seems somewhat redundant. After all, primality checks are relatively time-consuming, and the infinite loop only occurs within the `ModularSquareRoot` function. Hence, I think that adding primality checks directly into `ModularSquareRoot` function itself should be sufficient. |
| --- |

All reactions

Sorry, something went wrong.

[![@TheNormalnij](https://avatars.githubusercontent.com/u/6773493?s=40&v=4)](/TheNormalnij)
[TheNormalnij](/TheNormalnij)
mentioned this issue
[Jun 23, 2024](#ref-issue-2368646631)

[GenerateRandomWithKeySize calls debug break
#1279](/weidai11/cryptopp/issues/1279)

Closed

[![@gsantner](https://avatars.githubusercontent.com/u/6735650?s=80&u=f557ae88717c9bb4aa410a8d93dd546f192c470a&v=4)](/gsantner)

Copy link

### **[gsantner](/gsantner)** commented [Jul 16, 2024](#issuecomment-2230326114)

| Guess this issue can be closed / is resolved by that [9aa07ae](https://github.com/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73) is on master?  Thank you 😄 |
| --- |

All reactions

Sorry, something went wrong.

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

Author

### **[roadicing](/roadicing)** commented [Aug 8, 2024](#issuecomment-2274918741) • edited Loading

| Guess this issue can be closed / is resolved by that [9aa07ae](https://github.com/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73) is on master?  Thank you 😄  Hi  Firstly, the infinite loop issue in `ModularSquareRoot` has indeed been fixed by patch [9aa07ae](https://github.com/weidai11/cryptopp/commit/9aa07aebbdc62461c3ac32f958d7c3ab89ff6f73). However, to be honest, as mentioned in my previous response, this fix introduces a new risk in the form of pseudo-infinite loops due to excessive time overhead from checking large primes. Particularly, since a prime check is already performed within the `ModularSquareRoot` function, re-introducing prime checks in other functions are somewhat redundant and further increases the time overhead.  Nevertheless, the time consumed by prime checks is finite. If you do not consider the time overhead caused by these checks, then this fix could be viable. Given that the Crypto++ project currently appears to be in a phase with relatively lower update and maintenance frequency, if you need further improvements, you may manually patch the `IsPrime` function to include necessary limits on prime size, and also thanks for your reply. |
| --- |

All reactions

Sorry, something went wrong.

[![@Keisial](https://avatars.githubusercontent.com/u/647460?s=80&v=4)](/Keisial)

Copy link

### **[Keisial](/Keisial)** commented [Jan 4, 2025](#issuecomment-2571273866)

| Doing `CRYPTOPP_ASSERT(IsPrime(p));` on the different functions, is… interesting, since it will cause a noticeable performance hit on them, while not protecting the callers, which still need to do their own checks. However, that's just for DEBUG builds, so probably ok.  However, the one line that actually protects ECP:DecodePoint() from this DOS attack when parsing an untrusted key (`if (!IsPrime(p))` on line 125), is preceded by a `CRYPTOPP_ASSERT(IsPrime(p));`. So, if we are assuming `ECP:DecodePoint()` contract includes that it may be passed untrusted input, then on a debug build, such malicious input would still cause a DoS, due to the assert failure instead of the infinite loop. |
| --- |

All reactions

Sorry, something went wrong.

[![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=80&u=1eeac51b824ff8abe587431a034d3583236e0784&v=4)](/roadicing)

Copy link

Author

### **[roadicing](/roadicing)** commented [Jan 5, 2025](#issuecomment-2571457760)

| Doing `CRYPTOPP_ASSERT(IsPrime(p));` on the different functions, is… interesting, since it will cause a noticeable performance hit on them, while not protecting the callers, which still need to do their own checks. However, that's just for DEBUG builds, so probably ok.  However, the one line that actually protects ECP:DecodePoint() from this DOS attack when parsing an untrusted key (`if (!IsPrime(p))` on line 125), is preceded by a `CRYPTOPP_ASSERT(IsPrime(p));`. So, if we are assuming `ECP:DecodePoint()` contract includes that it may be passed untrusted input, then on a debug build, such malicious input would still cause a DoS, due to the assert failure instead of the infinite loop.  Yes, the existing patch still has issues. However, given that Crypto++ seems to no longer be updated, I haven’t continued reaching out. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fweidai11%2Fcryptopp%2Fissues%2F1249)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Validate p in ModularSquareRoot](/weidai11/cryptopp/pull/1255)
 [roadicing/cryptopp](/roadicing/cryptopp)

4 participants

[![@Keisial](https://avatars.githubusercontent.com/u/647460?s=52&v=4)](/Keisial) [![@noloader](https://avatars.githubusercontent.com/u/3538226?s=52&v=4)](/noloader) [![@gsantner](https://avatars.githubusercontent.com/u/6735650?s=52&v=4)](/gsantner) [![@roadicing](https://avatars.githubusercontent.com/u/23152450?s=52&v=4)](/roadicing)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


