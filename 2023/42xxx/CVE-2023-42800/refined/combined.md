=== Content from github.com_78b8162a_20250114_200206.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F50c0a51b10ecc5b3415ea78c21d96d679e2288f9)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F50c0a51b10ecc5b3415ea78c21d96d679e2288f9)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Commit

[Permalink](/moonlight-stream/moonlight-common-c/commit/50c0a51b10ecc5b3415ea78c21d96d679e2288f9)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Improve high quality audio support

[Browse files](/moonlight-stream/moonlight-common-c/tree/50c0a51b10ecc5b3415ea78c21d96d679e2288f9)
Browse the repository at this point in the history

```
High quality audio now works on IPv6 and remote connections
```

* Loading branch information

[![@cgutman](https://avatars.githubusercontent.com/u/2695644?s=40&v=4)](/cgutman)

[cgutman](/moonlight-stream/moonlight-common-c/commits?author=cgutman "View all commits by cgutman")
committed
Nov 5, 2022

1 parent
[7d9df5b](/moonlight-stream/moonlight-common-c/commit/7d9df5b731fa9c90535bc94f74a9d92b7f7d79a0)

commit 50c0a51

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**84 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/Connection.c
    [Connection.c](#diff-6aa947e4305dab73570f2e4d1d6eae0e97900a658f6c125772695dfd111c820c)
  + src/Limelight-internal.h
    [Limelight-internal.h](#diff-7f6f0a09776044dee447b6aec864b9774dfac284e88e6dd901858e921592fd38)
  + src/RtspConnection.c
    [RtspConnection.c](#diff-8b678559c0bf2ad7ac3b7fd275a8138dd1e46c27d00ae881af423ad3629b4617)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[src/Connection.c](#diff-6aa947e4305dab73570f2e4d1d6eae0e97900a658f6c125772695dfd111c820c "src/Connection.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/50c0a51b10ecc5b3415ea78c21d96d679e2288f9/src/Connection.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -399,7 +399,7 @@ int LiStartConnection(PSERVER\_INFORMATION serverInfo, PSTREAM\_CONFIGURATION stre |
|  |  |  |
|  |  | Limelog("Starting RTSP handshake..."); |
|  |  | ListenerCallbacks.stageStarting(STAGE\_RTSP\_HANDSHAKE); |
|  |  | err = performRtspHandshake(); |
|  |  | err = performRtspHandshake(serverInfo); |
|  |  | if (err != 0) { |
|  |  | Limelog("failed: %d\n", err); |
|  |  | ListenerCallbacks.stageFailed(STAGE\_RTSP\_HANDSHAKE, err); |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[src/Limelight-internal.h](#diff-7f6f0a09776044dee447b6aec864b9774dfac284e88e6dd901858e921592fd38 "src/Limelight-internal.h")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/50c0a51b10ecc5b3415ea78c21d96d679e2288f9/src/Limelight-internal.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -91,7 +91,7 @@ void connectionLostPackets(int lastReceivedPacket, int nextReceivedPacket); |
|  |  | int sendInputPacketOnControlStream(unsigned char\* data, int length); |
|  |  | bool isControlDataInTransit(void); |
|  |  |  |
|  |  | int performRtspHandshake(void); |
|  |  | int performRtspHandshake(PSERVER\_INFORMATION serverInfo); |
|  |  |  |
|  |  | void initializeVideoDepacketizer(int pktSize); |
|  |  | void destroyVideoDepacketizer(void); |
| Expand Down | |  |

95 changes: 82 additions & 13 deletions

95
[src/RtspConnection.c](#diff-8b678559c0bf2ad7ac3b7fd275a8138dd1e46c27d00ae881af423ad3629b4617 "src/RtspConnection.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/50c0a51b10ecc5b3415ea78c21d96d679e2288f9/src/RtspConnection.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -657,32 +657,101 @@ static int parseOpusConfigurations(PRTSP\_MESSAGE response) { |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | // Perform RTSP Handshake with the streaming server machine as part of the connection process |
|  |  | int performRtspHandshake(void) { |
|  |  | int ret; |
|  |  | static bool parseUrlAddrFromRtspUrlString(const char\* rtspUrlString, char\* destination) { |
|  |  | char\* rtspUrlScratchBuffer; |
|  |  | char\* portSeparator; |
|  |  | char\* v6EscapeEndChar; |
|  |  | char\* urlPathSeparator; |
|  |  | int prefixLen; |
|  |  |  |
|  |  | // Create a copy that we can modify |
|  |  | rtspUrlScratchBuffer = strdup(rtspUrlString); |
|  |  | if (rtspUrlScratchBuffer == NULL) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // HACK: In order to get GFE to respect our request for a lower audio bitrate, we must |
|  |  | // fake our target address so it doesn't match any of the PC's local interfaces. It seems |
|  |  | // that the only way to get it to give you "low quality" stereo audio nowadays is if it |
|  |  | // thinks you are remote (target address != any local address). |
|  |  | if (OriginalVideoBitrate >= HIGH\_AUDIO\_BITRATE\_THRESHOLD && |
|  |  | (AudioCallbacks.capabilities & CAPABILITY\_SLOW\_OPUS\_DECODER) == 0) { |
|  |  | addrToUrlSafeString(&RemoteAddr, urlAddr); |
|  |  | // If we have a v6 address, we want to stop one character after the closing ] |
|  |  | // If we have a v4 address, we want to stop at the port separator |
|  |  | portSeparator = strrchr(rtspUrlScratchBuffer, ':'); |
|  |  | v6EscapeEndChar = strchr(rtspUrlScratchBuffer, ']'); |
|  |  |  |
|  |  | // Count the prefix length to skip past the initial rtsp:// or rtspru:// part |
|  |  | for (prefixLen = 2; rtspUrlScratchBuffer[prefixLen - 2] != 0 && (rtspUrlScratchBuffer[prefixLen - 2] != '/' || rtspUrlScratchBuffer[prefixLen - 1] != '/'); prefixLen++); |
|  |  |  |
|  |  | // If we hit the end of the string prior to parsing the prefix, we cannot proceed |
|  |  | if (rtspUrlScratchBuffer[prefixLen - 2] == 0) { |
|  |  | free(rtspUrlScratchBuffer); |
|  |  | return false; |
|  |  | } |
|  |  | else { |
|  |  | strcpy(urlAddr, "0.0.0.0"); |
|  |  |  |
|  |  | // Look for a slash at the end of the host portion of the URL (may not be present) |
|  |  | urlPathSeparator = strchr(rtspUrlScratchBuffer + prefixLen, '/'); |
|  |  |  |
|  |  | // Check for a v6 address first since they also have colons |
|  |  | if (v6EscapeEndChar) { |
|  |  | // Terminate the string at the next character |
|  |  | \*(v6EscapeEndChar + 1) = 0; |
|  |  | } |
|  |  | else if (portSeparator) { |
|  |  | // Terminate the string prior to the port separator |
|  |  | \*portSeparator = 0; |
|  |  | } |
|  |  | else if (urlPathSeparator) { |
|  |  | // Terminate the string prior to the path separator |
|  |  | \*urlPathSeparator = 0; |
|  |  | } |
|  |  |  |
|  |  | strcpy(destination, rtspUrlScratchBuffer + prefixLen); |
|  |  |  |
|  |  | free(rtspUrlScratchBuffer); |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | // Perform RTSP Handshake with the streaming server machine as part of the connection process |
|  |  | int performRtspHandshake(PSERVER\_INFORMATION serverInfo) { |
|  |  | int ret; |
|  |  |  |
|  |  | LC\_ASSERT(RtspPortNumber != 0); |
|  |  |  |
|  |  | // Initialize global state |
|  |  | useEnet = (AppVersionQuad[0] >= 5) && (AppVersionQuad[0] <= 7) && (AppVersionQuad[2] < 404); |
|  |  | sprintf(rtspTargetUrl, "rtsp%s://%s:%u", useEnet ? "ru" : "", urlAddr, RtspPortNumber); |
|  |  | currentSeqNumber = 1; |
|  |  | hasSessionId = false; |
|  |  | controlStreamId = APP\_VERSION\_AT\_LEAST(7, 1, 431) ? "streamid=control/13/0" : "streamid=control/1/0"; |
|  |  | AudioEncryptionEnabled = false; |
|  |  |  |
|  |  | // HACK: In order to get GFE to respect our request for a lower audio bitrate, we must |
|  |  | // fake our target address so it doesn't match any of the PC's local interfaces. It seems |
|  |  | // that the only way to get it to give you "low quality" stereo audio nowadays is if it |
|  |  | // thinks you are remote (target address != any local address). |
|  |  | // |
|  |  | // We will enable high quality audio if the following are all true: |
|  |  | // 1. Video bitrate is higher than 15 Mbps (to ensure most bandwidth is reserved for video) |
|  |  | // 2. The audio decoder has not declared that it is slow |
|  |  | // 3. The stream is either local or not surround sound (to prevent MTU issues over the Internet) |
|  |  | LC\_ASSERT(StreamConfig.streamingRemotely != STREAM\_CFG\_AUTO); |
|  |  | if (OriginalVideoBitrate >= HIGH\_AUDIO\_BITRATE\_THRESHOLD && |
|  |  | (AudioCallbacks.capabilities & CAPABILITY\_SLOW\_OPUS\_DECODER) == 0 && |
|  |  | (StreamConfig.streamingRemotely != STREAM\_CFG\_REMOTE || CHANNEL\_COUNT\_FROM\_AUDIO\_CONFIGURATION(StreamConfig.audioConfiguration) <= 2)) { |
|  |  | // If we have an RTSP URL string and it was successfully parsed, use that string |
|  |  | if (serverInfo->rtspSessionUrl != NULL && parseUrlAddrFromRtspUrlString(serverInfo->rtspSessionUrl, urlAddr)) { |
|  |  | strcpy(rtspTargetUrl, serverInfo->rtspSessionUrl); |
|  |  | } |
|  |  | else { |
|  |  | // If an RTSP URL string was not provided or failed to parse, we will construct one now as best we can. |
|  |  | // |
|  |  | // NB: If the remote address is not a LAN address, the host will likely not enable high quality |
|  |  | // audio since it only does that for local streaming normally. We can avoid this limitation, |
|  |  | // but only if the caller gave us the RTSP session URL that it received from the host during launch. |
|  |  | addrToUrlSafeString(&RemoteAddr, urlAddr); |
|  |  | sprintf(rtspTargetUrl, "rtsp%s://%s:%u", useEnet ? "ru" : "", urlAddr, RtspPortNumber); |
|  |  | } |
|  |  | } |
|  |  | else { |
|  |  | strcpy(urlAddr, "0.0.0.0"); |
|  |  | sprintf(rtspTargetUrl, "rtsp%s://%s:%u", useEnet ? "ru" : "", urlAddr, RtspPortNumber); |
|  |  | } |
|  |  |  |
|  |  | switch (AppVersionQuad[0]) { |
|  |  | case 3: |
|  |  | rtspClientVersion = 10; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `50c0a51`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F50c0a51b10ecc5b3415ea78c21d96d679e2288f9) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_b5eb30f3_20250114_200204.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F24750d4b748fefa03d09fcfd6d45056faca354e0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F24750d4b748fefa03d09fcfd6d45056faca354e0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Commit

[Permalink](/moonlight-stream/moonlight-common-c/commit/24750d4b748fefa03d09fcfd6d45056faca354e0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix buffer overflow in performRtspHandshake (CVE-2023-42800)

[Browse files](/moonlight-stream/moonlight-common-c/tree/24750d4b748fefa03d09fcfd6d45056faca354e0)
Browse the repository at this point in the history

* Loading branch information

[![@k3an3](https://avatars.githubusercontent.com/u/2617725?s=40&v=4)](/k3an3) [![@cgutman](https://avatars.githubusercontent.com/u/2695644?s=40&v=4)](/cgutman)

[k3an3](/moonlight-stream/moonlight-common-c/commits?author=k3an3 "View all commits by k3an3")
authored and
[cgutman](/moonlight-stream/moonlight-common-c/commits?author=cgutman "View all commits by cgutman")
committed
Oct 7, 2023

1 parent
[02b7742](/moonlight-stream/moonlight-common-c/commit/02b7742f4d19631024bd766bd2bb76715780004e)

commit 24750d4

Showing
**1 changed file**
with
**2 additions**
and
**1 deletion**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

3 changes: 2 additions & 1 deletion

3
[src/RtspConnection.c](#diff-8b678559c0bf2ad7ac3b7fd275a8138dd1e46c27d00ae881af423ad3629b4617 "src/RtspConnection.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/24750d4b748fefa03d09fcfd6d45056faca354e0/src/RtspConnection.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -776,7 +776,8 @@ int performRtspHandshake(PSERVER\_INFORMATION serverInfo) { |
|  |  | (StreamConfig.streamingRemotely != STREAM\_CFG\_REMOTE || CHANNEL\_COUNT\_FROM\_AUDIO\_CONFIGURATION(StreamConfig.audioConfiguration) <= 2)) { |
|  |  | // If we have an RTSP URL string and it was successfully parsed, use that string |
|  |  | if (serverInfo->rtspSessionUrl != NULL && parseUrlAddrFromRtspUrlString(serverInfo->rtspSessionUrl, urlAddr, sizeof(urlAddr))) { |
|  |  | strcpy(rtspTargetUrl, serverInfo->rtspSessionUrl); |
|  |  | PltSafeStrcpy(rtspTargetUrl, sizeof(rtspTargetUrl), serverInfo->rtspSessionUrl); |
|  |  | rtspTargetUrl[sizeof(rtspTargetUrl) - 1] = '\0'; |
|  |  | } |
|  |  | else { |
|  |  | // If an RTSP URL string was not provided or failed to parse, we will construct one now as best we can. |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `24750d4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2F24750d4b748fefa03d09fcfd6d45056faca354e0) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8725238f_20250114_200207.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fsecurity%2Fadvisories%2FGHSA-4927-23jw-rq62)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fsecurity%2Fadvisories%2FGHSA-4927-23jw-rq62)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

# Buffer overflow due to use of `strcpy` in `performRtspHandshake`

High

[cgutman](/cgutman)
published
GHSA-4927-23jw-rq62
Dec 14, 2023

## Package

moonlight-common-c

## Affected versions

>= 0c0a51b10ecc5b3415ea78c21d96d679e2288f9

## Patched versions

>= 24750d4b748fefa03d09fcfd6d45056faca354e0

## Description

### Impact

A malicious game streaming server could exploit a buffer overflow vulnerability to crash a moonlight client, or achieve remote code execution (RCE) on the client (with insufficient exploit mitigations or if mitigations can be bypassed). The CVSS vulnerabililty severity score is based on the worst-case scenario of a client with no exploit mitigations.

This vulnerability takes place after the pairing process, so it requires the user to be tricked into pairing to a malicious host. It is not possible to perform using a MITM due to public key pinning that takes place during the pairing process.

### Summary

A buffer overflow was introduced in [this commit](https://github.com/moonlight-stream/moonlight-common-c/commit/50c0a51b10ecc5b3415ea78c21d96d679e2288f9) due to unmitigated usage of unsafe C functions and improper bounds checking.

### Details

A memory corruption issue exists within the `performRtspHandshake()` function in `RtspConnection.c`. The RTSP URL received from the game stream server is copied into static buffer `rtspTargetUrl` of size 256, causing an overflow:

[moonlight-common-c/src/RtspConnection.c](https://github.com/moonlight-stream/moonlight-common-c/blob/2bb026c763fc18807d7e4a93f918054c488f84e1/src/RtspConnection.c#L796)

Line 796
in
[2bb026c](/moonlight-stream/moonlight-common-c/commit/2bb026c763fc18807d7e4a93f918054c488f84e1)

|  | strcpy(rtspTargetUrl, serverInfo->rtspSessionUrl); |
| --- | --- |

The server-provided `serverInfo->rtspSessionUrl` contents may be of arbitrary length, so it can overflow `urlAddr` into the surrounding memory, allowing for a crash or RCE.

The vulnerable code path requires the client to have selected a video bitrate of at least 15 Mbps.

### Patch

The bug was addressed in [24750d4](https://github.com/moonlight-stream/moonlight-common-c/commit/24750d4b748fefa03d09fcfd6d45056faca354e0)

### Affected Moonlight Client Versions

Known affected clients are listed below for convenience. Not all clients may be vulnerable with the same severity due to differences in built-in exploit mitigations on each platform.

Affected client version ranges (inclusive):

* [Moonlight iOS/tvOS](https://github.com/moonlight-stream/moonlight-ios) - v8.4.0 to v8.5.0
* [Moonlight Android](https://github.com/moonlight-stream/moonlight-android) - v10.10 to v11.0
* [Moonlight Chrome](https://github.com/moonlight-stream/moonlight-chrome) - v0.10.22
* [Moonlight Embedded](https://github.com/moonlight-stream/moonlight-embedded) - v2.6.0
* [Moonlight Xbox](https://github.com/TheElixZammuto/moonlight-xbox) - v1.12.0 to v1.14.4.0
* [Moonlight TV](https://github.com/mariotaku/moonlight-tv) - v1.5.4 to v1.5.27
* [Moonlight Switch](https://github.com/XITRIX/Moonlight-Switch) - v0.13 to v0.13.3
* [Moonlight Vita](https://github.com/xyzz/vita-moonlight) - v0.9.2 to v0.9.3

There may be other third-party Moonlight clients and forks that were not investigated for vulnerability.

### PoC

A Python webserver can be used to simulate the gamestream server and serve the exploit: <https://github.com/k3an3/cve/moonlight-common-c/>

1. Extract the webserver to a clean directory:

```
tar xf exploit.tar.xz

```

2. Install needed dependencies (ideally within a Python virtual environment):

```
python3 -m pip install -r requirements.txt

```

3. Run the webserver, and a proxy to handle TLS connections (requires `ssl-cert` Debian package, or similar):

```
socat openssl-listen:47984,fork,reuseaddr,key=/etc/ssl/private/ssl-cert-snakeoil.key,cert=/etc/ssl/certs/ssl-cert-snakeoil.pem,verify=0 tcp:127.0.0.1:47989
python3 app.py

```

4. Create a `moonlight.conf` with the following contents:

```
address = <ADDRESS_OF_EXPLOIT_SERVER>
bitrate = 20000

```

5. Invoke `moonlight stream`:

```
moonlight -config path/to/moonlight.conf stream

```

6. The program should crash.

AddressSanitizer output:

```
$ ./moonlight stream
/home/keane/src/moonlight-embedded/src/config.c:125:20: runtime error: applying non-zero offset 1 to null pointer
SUMMARY: UndefinedBehaviorSanitizer: undefined-behavior /home/keane/src/moonlight-embedded/src/config.c:125:20 in
Failed to open device /dev/input/event5
Failed to open device /dev/input/event6
Failed to open device /dev/input/event2
Failed to open device /dev/input/event1
Failed to open device /dev/input/event3
Failed to open device /dev/input/event7
Failed to open device /dev/input/event9
Failed to open device /dev/input/event10
Failed to open device /dev/input/event13
Failed to open device /dev/input/event14
Failed to open device /dev/input/event15
Failed to open device /dev/input/event16
Failed to open device /dev/input/event8
Failed to open device /dev/input/event4
Failed to open device /dev/input/event12
Failed to open device /dev/input/event0
Failed to open device /dev/input/event11
=================================================================
==511071==ERROR: AddressSanitizer: global-buffer-overflow on address 0x7fdf58df2a00 at pc 0x563b87ca9c8b bp 0x7ffc3def5e70 sp 0x7ffc3def5638
WRITE of size 131080 at 0x7fdf58df2a00 thread T0
    #0 0x563b87ca9c8a in __interceptor_strcpy (/home/keane/src/moonlight-embedded/build/moonlight+0xe3c8a) (BuildId: 2971e520010823d36c5caa4a027a2b5a8ebd7cca)
    #1 0x7fdf58cad1d3 in performRtspHandshake /home/keane/src/moonlight-embedded/third_party/moonlight-common-c/src/RtspConnection.c:797:13
    #2 0x7fdf58c07c90 in LiStartConnection /home/keane/src/moonlight-embedded/third_party/moonlight-common-c/src/Connection.c:415:11
    #3 0x563b87d1902b in stream /home/keane/src/moonlight-embedded/src/main.c:146:3
    #4 0x563b87d1515c in main /home/keane/src/moonlight-embedded/src/main.c:395:5
    #5 0x7fdf582456c9 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
    #6 0x7fdf58245784 in __libc_start_main csu/../csu/libc-start.c:360:3
    #7 0x563b87c3bb80 in _start (/home/keane/src/moonlight-embedded/build/moonlight+0x75b80) (BuildId: 2971e520010823d36c5caa4a027a2b5a8ebd7cca)

0x7fdf58df2a00 is located 0 bytes to the right of global variable 'rtspTargetUrl' defined in '/home/keane/src/moonlight-embedded/third_party/moonlight-common-c/src/RtspConnection.c:9:13' (0x7fdf58df2900) of size 256
SUMMARY: AddressSanitizer: global-buffer-overflow (/home/keane/src/moonlight-embedded/build/moonlight+0xe3c8a) (BuildId: 2971e520010823d36c5caa4a027a2b5a8ebd7cca) in __interceptor_strcpy
Shadow bytes around the buggy address:
  0x0ffc6b1b64f0: 00 00 00 00 00 00 f9 f9 f9 f9 f9 f9 00 f9 f9 f9
  0x0ffc6b1b6500: 00 f9 f9 f9 01 f9 f9 f9 04 f9 f9 f9 01 f9 f9 f9
  0x0ffc6b1b6510: 00 f9 f9 f9 00 00 00 00 00 00 f9 f9 f9 f9 f9 f9
  0x0ffc6b1b6520: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0ffc6b1b6530: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0ffc6b1b6540:[f9]f9 f9 f9 f9 f9 f9 f9 04 f9 f9 f9 00 f9 f9 f9
  0x0ffc6b1b6550: 00 f9 f9 f9 00 f9 f9 f9 00 00 00 00 00 00 00 00
  0x0ffc6b1b6560: 00 00 00 00 00 00 00 f9 f9 f9 f9 f9 04 f9 f9 f9
  0x0ffc6b1b6570: 04 f9 f9 f9 01 f9 f9 f9 01 f9 f9 f9 01 f9 f9 f9
  0x0ffc6b1b6580: 04 f9 f9 f9 01 f9 f9 f9 00 f9 f9 f9 02 f9 f9 f9
  0x0ffc6b1b6590: 00 f9 f9 f9 04 f9 f9 f9 02 f9 f9 f9 01 f9 f9 f9
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
AddressSanitizer:DEADLYSIGNAL
=================================================================
==511071==ERROR: AddressSanitizer: SEGV on unknown address 0x7fdf58e04000 (pc 0x7fdf58373000 bp 0x7ffc3def5e70 sp 0x7ffc3def5628 T0)
==511071==The signal is caused by a WRITE memory access.
    #0 0x7fdf58373000 in __strcpy_avx2 string/../sysdeps/x86_64/multiarch/strcpy-avx2.S:222
    #1 0x563b87ca9cbc in __interceptor_strcpy (/home/keane/src/moonlight-embedded/build/moonlight+0xe3cbc) (BuildId: 2971e520010823d36c5caa4a027a2b5a8ebd7cca)
    #2 0x7fdf58cad1d3 in performRtspHandshake /home/keane/src/moonlight-embedded/third_party/moonlight-common-c/src/RtspConnection.c:797:13
    #3 0x7fdf58c07c90 in LiStartConnection /home/keane/src/moonlight-embedded/third_party/moonlight-common-c/src/Connection.c:415:11
    #4 0x563b87d1902b in stream /home/keane/src/moonlight-embedded/src/main.c:146:3
    #5 0x563b87d1515c in main /home/keane/src/moonlight-embedded/src/main.c:395:5
    #6 0x7fdf582456c9 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
    #7 0x7fdf58245784 in __libc_start_main csu/../csu/libc-start.c:360:3
    #8 0x563b87c3bb80 in _start (/home/keane/src/moonlight-embedded/build/moonlight+0x75b80) (BuildId: 2971e520010823d36c5caa4a027a2b5a8ebd7cca)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV string/../sysdeps/x86_64/multiarch/strcpy-avx2.S:222 in __strcpy_avx2
==511071==ABORTING

```

### Severity

High

8.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
Required

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H

### CVE ID

CVE-2023-42800

### Weaknesses

[CWE-120](/advisories?query=cwe%3A120)

### Credits

* [![@k3an3](https://avatars.githubusercontent.com/u/2617725?s=40&v=4)](/k3an3)
  [k3an3](/k3an3)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8f2b4ac2_20250114_200203.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fblob%2F2bb026c763fc18807d7e4a93f918054c488f84e1%2Fsrc%2FRtspConnection.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fblob%2F2bb026c763fc18807d7e4a93f918054c488f84e1%2Fsrc%2FRtspConnection.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Files

 2bb026c
## Breadcrumbs

1. [moonlight-common-c](/moonlight-stream/moonlight-common-c/tree/2bb026c763fc18807d7e4a93f918054c488f84e1)
2. /[src](/moonlight-stream/moonlight-common-c/tree/2bb026c763fc18807d7e4a93f918054c488f84e1/src)
/
# RtspConnection.c

Copy path Blame  Blame
## Latest commit

## History

[History](/moonlight-stream/moonlight-common-c/commits/2bb026c763fc18807d7e4a93f918054c488f84e1/src/RtspConnection.c)1221 lines (1024 loc) · 39.6 KB 2bb026c
## Breadcrumbs

1. [moonlight-common-c](/moonlight-stream/moonlight-common-c/tree/2bb026c763fc18807d7e4a93f918054c488f84e1)
2. /[src](/moonlight-stream/moonlight-common-c/tree/2bb026c763fc18807d7e4a93f918054c488f84e1/src)
/
# RtspConnection.c

Top
## File metadata and controls

* Code
* Blame

1221 lines (1024 loc) · 39.6 KB[Raw](https://github.com/moonlight-stream/moonlight-common-c/raw/2bb026c763fc18807d7e4a93f918054c488f84e1/src/RtspConnection.c)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000#include "Limelight-internal.h"#include "Rtsp.h"
#define RTSP\_CONNECT\_TIMEOUT\_SEC 10#define RTSP\_RECEIVE\_TIMEOUT\_SEC 15#define RTSP\_RETRY\_DELAY\_MS 500
static int currentSeqNumber;static char rtspTargetUrl[256];static char\* sessionIdString;static bool hasSessionId;static int rtspClientVersion;static char urlAddr[URLSAFESTRING\_LEN];static bool useEnet;static char\* controlStreamId;
static SOCKET sock = INVALID\_SOCKET;static ENetHost\* client;static ENetPeer\* peer;
#define CHAR\_TO\_INT(x) ((x) - '0')#define CHAR\_IS\_DIGIT(x) ((x) >= '0' && (x) <= '9')
// Create RTSP Optionstatic POPTION\_ITEM createOptionItem(char\* option, char\* content){ POPTION\_ITEM item = malloc(sizeof(\*item)); if (item == NULL) { return NULL; }
 item->option = strdup(option); if (item->option == NULL) { free(item); return NULL; }
 item->content = strdup(content); if (item->content == NULL) { free(item->option); free(item); return NULL; }
 item->next = NULL; item->flags = FLAG\_ALLOCATED\_OPTION\_FIELDS;
 return item;}
// Add an option to the RTSP Messagestatic bool addOption(PRTSP\_MESSAGE msg, char\* option, char\* content){ POPTION\_ITEM item = createOptionItem(option, content); if (item == NULL) { return false; }
 insertOption(&msg->options, item); msg->flags |= FLAG\_ALLOCATED\_OPTION\_ITEMS;
 return true;}
// Create an RTSP Requeststatic bool initializeRtspRequest(PRTSP\_MESSAGE msg, char\* command, char\* target){ char sequenceNumberStr[16]; char clientVersionStr[16];
 // FIXME: Hacked CSeq attribute due to RTSP parser bug createRtspRequest(msg, NULL, 0, command, target, "RTSP/1.0", 0, NULL, NULL, 0);
 sprintf(sequenceNumberStr, "%d", currentSeqNumber++); sprintf(clientVersionStr, "%d", rtspClientVersion); if (!addOption(msg, "CSeq", sequenceNumberStr) || !addOption(msg, "X-GS-ClientVersion", clientVersionStr) || (!useEnet && !addOption(msg, "Host", urlAddr))) { freeMessage(msg); return false; }
 return true;}
// Send RTSP message and get response over ENetstatic bool transactRtspMessageEnet(PRTSP\_MESSAGE request, PRTSP\_MESSAGE response, bool expectingPayload, int\* error) { ENetEvent event; char\* serializedMessage; int messageLen; int offset; ENetPacket\* packet; char\* payload; int payloadLength; bool ret; char\* responseBuffer;
 \*error = -1; ret = false; responseBuffer = NULL;
 // We're going to handle the payload separately, so temporarily set the payload to NULL payload = request->payload; payloadLength = request->payloadLength; request->payload = NULL; request->payloadLength = 0;  // Serialize the RTSP message into a message buffer serializedMessage = serializeRtspMessage(request, &messageLen); if (serializedMessage == NULL) { goto Exit; }  // Create the reliable packet that describes our outgoing message packet = enet\_packet\_create(serializedMessage, messageLen, ENET\_PACKET\_FLAG\_RELIABLE); if (packet == NULL) { goto Exit; }  // Send the message if (enet\_peer\_send(peer, 0, packet) < 0) { enet\_packet\_destroy(packet); goto Exit; } enet\_host\_flush(client);
 // If we have a payload to send, we'll need to send that separately if (payload != NULL) { packet = enet\_packet\_create(payload, payloadLength, ENET\_PACKET\_FLAG\_RELIABLE); if (packet == NULL) { goto Exit; }
 // Send the payload if (enet\_peer\_send(peer, 0, packet) < 0) { enet\_packet\_destroy(packet); goto Exit; }  enet\_host\_flush(client); }  // Wait for a reply if (serviceEnetHost(client, &event, RTSP\_RECEIVE\_TIMEOUT\_SEC \* 1000) <= 0 || event.type != ENET\_EVENT\_TYPE\_RECEIVE) { Limelog("Failed to receive RTSP reply\n"); goto Exit; }
 responseBuffer = malloc(event.packet->dataLength); if (responseBuffer == NULL) { Limelog("Failed to allocate RTSP response buffer\n"); enet\_packet\_destroy(event.packet); goto Exit; }
 // Copy the data out and destroy the packet memcpy(responseBuffer, event.packet->data, event.packet->dataLength); offset = (int) event.packet->dataLength; enet\_packet\_destroy(event.packet);
 // Wait for the payload if we're expecting some if (expectingPayload) { // The payload comes in a second packet if (serviceEnetHost(client, &event, RTSP\_RECEIVE\_TIMEOUT\_SEC \* 1000) <= 0 || event.type != ENET\_EVENT\_TYPE\_RECEIVE) { Limelog("Failed to receive RTSP reply payload\n"); goto Exit; }
 responseBuffer = extendBuffer(responseBuffer, event.packet->dataLength + offset); if (responseBuffer == NULL) { Limelog("Failed to extend RTSP response buffer\n"); enet\_packet\_destroy(event.packet); goto Exit; }
 // Copy the payload out to the end of the response buffer and destroy the packet memcpy(&responseBuffer[offset], event.packet->data, event.packet->dataLength); offset += (int) event.packet->dataLength; enet\_packet\_destroy(event.packet); }  if (parseRtspMessage(response, responseBuffer, offset) == RTSP\_ERROR\_SUCCESS) { // Successfully parsed response ret = true; } else { Limelog("Failed to parse RTSP response\n"); }
Exit: // Swap back the payload pointer to avoid leaking memory later request->payload = payload; request->payloadLength = payloadLength;
 // Free the serialized buffer if (serializedMessage != NULL) { free(serializedMessage); }
 // Free the response buffer if (responseBuffer != NULL) { free(responseBuffer); }
 return ret;}
// Send RTSP message and get response over TCPstatic bool transactRtspMessageTcp(PRTSP\_MESSAGE request, PRTSP\_MESSAGE response, int\* error) { SOCK\_RET err; bool ret; int offset; char\* serializedMessage = NULL; int messageLen; char\* responseBuffer; int responseBufferSize; int connectRetries;
 \*error = -1; ret = false; responseBuffer = NULL; connectRetries = 0;
 // Retry up to 10 seconds if we receive ECONNREFUSED errors from the host PC. // This can happen with GFE 3.22 when initially launching a session because it // returns HTTP 200 OK for the /launch request before the RTSP handshake port // is listening. do { sock = connectTcpSocket(&RemoteAddr, RemoteAddrLen, RtspPortNumber, RTSP\_CONNECT\_TIMEOUT\_SEC); if (sock == INVALID\_SOCKET) { \*error = LastSocketError(); if (\*error == ECONNREFUSED) { // Try again after 500 ms on ECONNREFUSED PltSleepMs(RTSP\_RETRY\_DELAY\_MS); } else { // Fail if we get some other error break; } } else { // We successfully connected break; } } while (connectRetries++ < (RTSP\_CONNECT\_TIMEOUT\_SEC \* 1000) / RTSP\_RETRY\_DELAY\_MS && !ConnectionInterrupted); if (sock == INVALID\_SOCKET) { return ret; }
 serializedMessage = serializeRtspMessage(request, &messageLen); if (serializedMessage == NULL) { closeSocket(sock); sock = INVALID\_SOCKET; return ret; }
 // Send our message split into smaller chunks to avoid MTU issues. // enableNoDelay() must have been called for sendMtuSafe() to work. enableNoDelay(sock); err = sendMtuSafe(sock, serializedMessage, messageLen); if (err == SOCKET\_ERROR) { \*error = LastSocketError(); Limelog("Failed to send RTSP message: %d\n", \*error); goto Exit; }
 // Read the response until the server closes the connection offset = 0; responseBufferSize = 0; for (;;) { struct pollfd pfd;
 if (offset >= responseBufferSize) { responseBufferSize = offset + 16384; responseBuffer = extendBuffer(responseBuffer, responseBufferSize); if (responseBuffer == NULL) { Limelog("Failed to allocate RTSP response buffer\n"); goto Exit; } }
 pfd.fd = sock; pfd.events = POLLIN; err = pollSockets(&pfd, 1, RTSP\_RECEIVE\_TIMEOUT\_SEC \* 1000); if (err == 0) { \*error = ETIMEDOUT; Limelog("RTSP request timed out\n"); goto Exit; } else if (err < 0) { \*error = LastSocketError(); Limelog("Failed to wait for RTSP response: %d\n", \*error); goto Exit; }
 err = recv(sock, &responseBuffer[offset], responseBufferSize - offset, 0); if (err < 0) { // Error reading \*error = LastSocketError(); Limelog("Failed to read RTSP response: %d\n", \*error); goto Exit; } else if (err == 0) { // Done reading break; } else { offset += err; } }
 if (parseRtspMessage(response, responseBuffer, offset) == RTSP\_ERROR\_SUCCESS) { // Successfully parsed response ret = true; } else { Limelog("Failed to parse RTSP response\n"); }
Exit: if (serializedMessage != NULL) { free(serializedMessage); }
 if (responseBuffer != NULL) { free(responseBuffer); }
 closeSocket(sock); sock = INVALID\_SOCKET; return ret;}
static bool transactRtspMessage(PRTSP\_MESSAGE request, PRTSP\_MESSAGE response, bool expectingPayload, int\* error) { if (ConnectionInterrupted) { \*error = -1; return false; }
 if (useEnet) { return transactRtspMessageEnet(request, response, expectingPayload, error); } else { return transactRtspMessageTcp(request, response, error); }}
// Send RTSP OPTIONS requeststatic bool requestOptions(PRTSP\_MESSAGE response, int\* error) { RTSP\_MESSAGE request; bool ret;
 \*error = -1;
 ret = initializeRtspRequest(&request, "OPTIONS", rtspTargetUrl); if (ret) { ret = transactRtspMessage(&request, response, false, error); freeMessage(&request); }
 return ret;}
// Send RTSP DESCRIBE requeststatic bool requestDescribe(PRTSP\_MESSAGE response, int\* error) { RTSP\_MESSAGE request; bool ret;
 \*error = -1;
 ret = initializeRtspRequest(&request, "DESCRIBE", rtspTargetUrl); if (ret) { if (addOption(&request, "Accept", "application/sdp") && addOption(&request, "If-Modified-Since", "Thu, 01 Jan 1970 00:00:00 GMT")) { ret = transactRtspMessage(&request, response, true, error); } else { ret = false; } freeMessage(&request); }
 return ret;}
// Send RTSP SETUP requeststatic bool setupStream(PRTSP\_MESSAGE response, char\* target, int\* error) { RTSP\_MESSAGE request; bool ret; char\* transportValue;
 \*error = -1;
 ret = initializeRtspRequest(&request, "SETUP", target); if (ret) { if (hasSessionId) { if (!addOption(&request, "Session", sessionIdString)) { ret = false; goto FreeMessage; } }
 if (AppVersionQuad[0] >= 6) { // It looks like GFE doesn't care what we say our port is but // we need to give it some port to successfully complete the // handshake process. transportValue = "unicast;X-GS-ClientPort=50000-50001"; } else { transportValue = " "; }  if (addOption(&request, "Transport", transportValue) && addOption(&request, "If-Modified-Since", "Thu, 01 Jan 1970 00:00:00 GMT")) { ret = transactRtspMessage(&request, response, false, error); } else { ret = false; }
 FreeMessage: freeMessage(&request); }
 return ret;}
// Send RTSP PLAY requeststatic bool playStream(PRTSP\_MESSAGE response, char\* target, int\* error) { RTSP\_MESSAGE request; bool ret;
 \*error = -1;
 ret = initializeRtspRequest(&request, "PLAY", target); if (ret != 0) { if (addOption(&request, "Session", sessionIdString)) { ret = transactRtspMessage(&request, response, false, error); } else { ret = false; } freeMessage(&request); }
 return ret;}
// Send RTSP ANNOUNCE messagestatic bool sendVideoAnnounce(PRTSP\_MESSAGE response, int\* error) { RTSP\_MESSAGE request; bool ret; int payloadLength; char payloadLengthStr[16];
 \*error = -1;
 ret = initializeRtspRequest(&request, "ANNOUNCE", APP\_VERSION\_AT\_LEAST(7, 1, 431) ? controlStreamId : "streamid=video"); if (ret) { ret = false;
 if (!addOption(&request, "Session", sessionIdString) || !addOption(&request, "Content-type", "application/sdp")) { goto FreeMessage; }
 request.payload = getSdpPayloadForStreamConfig(rtspClientVersion, &payloadLength); if (request.payload == NULL) { goto FreeMessage; } request.flags |= FLAG\_ALLOCATED\_PAYLOAD; request.payloadLength = payloadLength;
 sprintf(payloadLengthStr, "%d", payloadLength); if (!addOption(&request, "Content-length", payloadLengthStr)) { goto FreeMessage; }
 ret = transactRtspMessage(&request, response, false, error);
 FreeMessage: freeMessage(&request); }
 return ret;}
static int parseOpusConfigFromParamString(char\* paramStr, int channelCount, POPUS\_MULTISTREAM\_CONFIGURATION opusConfig) { int i;
 // Set channel count (included in the prefix, so not parsed below) opusConfig->channelCount = channelCount;
 // Parse the remaining data from the surround-params value if (!CHAR\_IS\_DIGIT(\*paramStr)) { Limelog("Invalid stream count: %c\n", \*paramStr); return -1; } opusConfig->streams = CHAR\_TO\_INT(\*paramStr); paramStr++;
 if (!CHAR\_IS\_DIGIT(\*paramStr)) { Limelog("Invalid coupled stream count: %c\n", \*paramStr); return -2; } opusConfig->coupledStreams = CHAR\_TO\_INT(\*paramStr); paramStr++;
 for (i = 0; i < opusConfig->channelCount; i++) { if (!CHAR\_IS\_DIGIT(\*paramStr)) { Limelog("Invalid mapping value at %d: %c\n", i, \*paramStr); return -3; }
 opusConfig->mapping[i] = CHAR\_TO\_INT(\*paramStr); paramStr++; }
 return 0;}
// Parse the server port from the Transport header// Example: unicast;server\_port=48000-48001;source=192.168.35.177static bool parseServerPortFromTransport(PRTSP\_MESSAGE response, uint16\_t\* port) { char\* transport; char\* portStart;
 transport = getOptionContent(response->options, "Transport"); if (transport == NULL) { return false; }
 // Look for the server\_port= entry in the Transport option portStart = strstr(transport, "server\_port="); if (portStart == NULL) { return false; }
 // Skip the prefix portStart += strlen("server\_port=");
 // Validate the port number long int rawPort = strtol(portStart, NULL, 10); if (rawPort <= 0 || rawPort > 65535) { return false; }
 \*port = (uint16\_t)rawPort; return true;}
// Parses the Opus configuration from an RTSP DESCRIBE responsestatic int parseOpusConfigurations(PRTSP\_MESSAGE response) { HighQualitySurroundSupported = false; memset(&NormalQualityOpusConfig, 0, sizeof(NormalQualityOpusConfig)); memset(&HighQualityOpusConfig, 0, sizeof(HighQualityOpusConfig));
 // Sample rate is always 48 KHz HighQualityOpusConfig.sampleRate = NormalQualityOpusConfig.sampleRate = 48000;
 // Stereo doesn't have any surround-params elements in the RTSP data if (CHANNEL\_COUNT\_FROM\_AUDIO\_CONFIGURATION(StreamConfig.audioConfiguration) == 2) { NormalQualityOpusConfig.channelCount = 2; NormalQualityOpusConfig.streams = 1; NormalQualityOpusConfig.coupledStreams = 1; NormalQualityOpusConfig.mapping[0] = 0; NormalQualityOpusConfig.mapping[1] = 1; } else { char paramsPrefix[128]; char\* paramStart; int err; int channelCount;
 channelCount = CHANNEL\_COUNT\_FROM\_AUDIO\_CONFIGURATION(StreamConfig.audioConfiguration);
 // Find the correct audio parameter value sprintf(paramsPrefix, "a=fmtp:97 surround-params=%d", channelCount); paramStart = strstr(response->payload, paramsPrefix); if (paramStart) { // Skip the prefix paramStart += strlen(paramsPrefix);
 // Parse the normal quality Opus config err = parseOpusConfigFromParamString(paramStart, channelCount, &NormalQualityOpusConfig); if (err != 0) { return err; }
 // GFE's normal-quality channel mapping differs from the one our clients use. // They use FL FR C RL RR SL SR LFE, but we use FL FR C LFE RL RR SL SR. We'll need // to swap the mappings to match the expected values. if (channelCount == 6 || channelCount == 8) { OPUS\_MULTISTREAM\_CONFIGURATION originalMapping = NormalQualityOpusConfig;
 // LFE comes after C NormalQualityOpusConfig.mapping[3] = originalMapping.mapping[channelCount - 1];
 // Slide everything else up memcpy(&NormalQualityOpusConfig.mapping[4], &originalMapping.mapping[3], channelCount - 4); }
 // If this configuration is compatible with high quality mode, we may have another // matching surround-params value for high quality mode. paramStart = strstr(paramStart, paramsPrefix); if (paramStart) { // Skip the prefix paramStart += strlen(paramsPrefix);
 // Parse the high quality Opus config err = parseOpusConfigFromParamString(paramStart, channelCount, &HighQualityOpusConfig); if (err != 0) { return err; }
 // We can request high quality audio HighQualitySurroundSupported = true; } } else { Limelog("No surround parameters found for channel count: %d\n", channelCount);
 // It's unknown whether all GFE versions that supported surround sound included these // surround sound parameters. In case they didn't, we'll specifically handle 5.1 surround // sound using a hardcoded configuration like we used to before this parsing code existed. // // It is not necessary to provide HighQualityOpusConfig here because high quality mode // can only be enabled from seeing the required "surround-params=" value, so there's no // chance it could regress from implementing this parser. if (channelCount == 6) { NormalQualityOpusConfig.channelCount = 6; NormalQualityOpusConfig.streams = 4; NormalQualityOpusConfig.coupledStreams = 2; NormalQualityOpusConfig.mapping[0] = 0; NormalQualityOpusConfig.mapping[1] = 4; NormalQualityOpusConfig.mapping[2] = 1; NormalQualityOpusConfig.mapping[3] = 5; NormalQualityOpusConfig.mapping[4] = 2; NormalQualityOpusConfig.mapping[5] = 3; } else { // We don't have a hardcoded fallback mapping, so we have no choice but to fail. return -4; } } }
 return 0;}
static bool parseUrlAddrFromRtspUrlString(const char\* rtspUrlString, char\* destination) { char\* rtspUrlScratchBuffer; char\* portSeparator; char\* v6EscapeEndChar; char\* urlPathSeparator; int prefixLen;
 // Create a copy that we can modify rtspUrlScratchBuffer = strdup(rtspUrlString); if (rtspUrlScratchBuffer == NULL) { return false; }
 // If we have a v6 address, we want to stop one character after the closing ] // If we have a v4 address, we want to stop at the port separator portSeparator = strrchr(rtspUrlScratchBuffer, ':'); v6EscapeEndChar = strchr(rtspUrlScratchBuffer, ']');
 // Count the prefix length to skip past the initial rtsp:// or rtspru:// part for (prefixLen = 2; rtspUrlScratchBuffer[prefixLen - 2] != 0 && (rtspUrlScratchBuffer[prefixLen - 2] != '/' || rtspUrlScratchBuffer[prefixLen - 1] != '/'); prefixLen++);
 // If we hit the end of the string prior to parsing the prefix, we cannot proceed if (rtspUrlScratchBuffer[prefixLen - 2] == 0) { free(rtspUrlScratchBuffer); return false; }
 // Look for a slash at the end of the host portion of the URL (may not be present) urlPathSeparator = strchr(rtspUrlScratchBuffer + prefixLen, '/');
 // Check for a v6 address first since they also have colons if (v6EscapeEndChar) { // Terminate the string at the next character \*(v6EscapeEndChar + 1) = 0; } else if (portSeparator) { // Terminate the string prior to the port separator \*portSeparator = 0; } else if (urlPathSeparator) { // Terminate the string prior to the path separator \*urlPathSeparator = 0; }
 strcpy(destination, rtspUrlScratchBuffer + prefixLen);
 free(rtspUrlScratchBuffer); return true;}
// SDP attributes are in the form:// a=x-nv-bwe.bwuSafeZoneLowLimit:70\r\nbool parseSdpAttributeToUInt(const char\* payload, const char\* name, unsigned int\* val) { // Find the entry for the specified attribute name char\* attribute = strstr(payload, name); if (!attribute) { return false; }
 // Locate the start of the value char\* valst = strstr(attribute, ":"); if (!valst) { return false; }
 // Locate the end of the value char\* valend; if (!(valend = strstr(valst, "\r")) && !(valend = strstr(valst, "\n"))) { return false; }
 // Swap the end character for a null terminator, read the integer, then swap it back char valendchar = \*valend; \*valend = 0; \*val = strtoul(valst + 1, NULL, 0); \*valend = valendchar;
 return true;}
bool parseSdpAttributeToInt(const char\* payload, const char\* name, int\* val) { // Find the entry for the specified attribute name char\* attribute = strstr(payload, name); if (!attribute) { return false; }
 // Locate the start of the value char\* valst = strstr(attribute, ":"); if (!valst) { return false; }
 // Locate the end of the value char\* valend; if (!(valend = strstr(valst, "\r")) && !(valend = strstr(valst, "\n"))) { return false; }
 // Swap the end character for a null terminator, read the integer, then swap it back char valendchar = \*valend; \*valend = 0; \*val = strtol(valst + 1, NULL, 0); \*valend = valendchar;
 return true;}
// Perform RTSP Handshake with the streaming server machine as part of the connection processint performRtspHandshake(PSERVER\_INFORMATION serverInfo) { int ret;
 LC\_ASSERT(RtspPortNumber != 0);
 // Initialize global state useEnet = (AppVersionQuad[0] >= 5) && (AppVersionQuad[0] <= 7) && (AppVersionQuad[2] < 404); currentSeqNumber = 1; hasSessionId = false; controlStreamId = APP\_VERSION\_AT\_LEAST(7, 1, 431) ? "streamid=control/13/0" : "streamid=control/1/0"; AudioEncryptionEnabled = false;
 // HACK: In order to get GFE to respect our request for a lower audio bitrate, we must // fake our target address so it doesn't match any of the PC's local interfaces. It seems // that the only way to get it to give you "low quality" stereo audio nowadays is if it // thinks you are remote (target address != any local address). // // We will enable high quality audio if the following are all true: // 1. Video bitrate is higher than 15 Mbps (to ensure most bandwidth is reserved for video) // 2. The audio decoder has not declared that it is slow // 3. The stream is either local or not surround sound (to prevent MTU issues over the Internet) LC\_ASSERT(StreamConfig.streamingRemotely != STREAM\_CFG\_AUTO); if (OriginalVideoBitrate >= HIGH\_AUDIO\_BITRATE\_THRESHOLD && (AudioCallbacks.capabilities & CAPABILITY\_SLOW\_OPUS\_DECODER) == 0 && (StreamConfig.streamingRemotely != STREAM\_CFG\_REMOTE || CHANNEL\_COUNT\_FROM\_AUDIO\_CONFIGURATION(StreamConfig.audioConfiguration) <= 2)) { // If we have an RTSP URL string and it was successfully parsed, use that string if (serverInfo->rtspSessionUrl != NULL && parseUrlAddrFromRtspUrlString(serverInfo->rtspSessionUrl, urlAddr)) { strcpy(rtspTargetUrl, serverInfo->rtspSessionUrl); } else { // If an RTSP URL string was not provided or failed to parse, we will construct one now as best we can. // // NB: If the remote address is not a LAN address, the host will likely not enable high quality // audio since it only does that for local streaming normally. We can avoid this limitation, // but only if the caller gave us the RTSP session URL that it received from the host during launch. addrToUrlSafeString(&RemoteAddr, urlAddr); sprintf(rtspTargetUrl, "rtsp%s://%s:%u", useEnet ? "ru" : "", urlAddr, RtspPortNumber); } } else { strcpy(urlAddr, "0.0.0.0"); sprintf(rtspTargetUrl, "rtsp%s://%s:%u", useEnet ? "ru" : "", urlAddr, RtspPortNumber); }
 switch (AppVersionQuad[0]) { case 3: rtspClientVersion = 10; break; case 4: rtspClientVersion = 11; break; case 5: rtspClientVersion = 12; break; case 6: // Gen 6 has never been seen in the wild rtspClientVersion = 13; break; case 7: default: rtspClientVersion = 14; break; }  // Setup ENet if required by this GFE version if (useEnet) { ENetAddress address; ENetEvent event;  enet\_address\_set\_address(&address, (struct sockaddr \*)&RemoteAddr, RemoteAddrLen); enet\_address\_set\_port(&address, RtspPortNumber);  // Create a client that can use 1 outgoing connection and 1 channel client = enet\_host\_create(RemoteAddr.ss\_family, NULL, 1, 1, 0, 0); if (client == NULL) { return -1; }  // Connect to the host peer = enet\_host\_connect(client, &address, 1, 0); if (peer == NULL) { enet\_host\_destroy(client); client = NULL; return -1; }  // Wait for the connect to complete if (serviceEnetHost(client, &event, RTSP\_CONNECT\_TIMEOUT\_SEC \* 1000) <= 0 || event.type != ENET\_EVENT\_TYPE\_CONNECT) { Limelog("RTSP: Failed to connect to UDP port %u\n", RtspPortNumber); enet\_peer\_reset(peer); peer = NULL; enet\_host\_destroy(client); client = NULL; return -1; }
 // Ensure the connect verify ACK is sent immediately enet\_host\_flush(client); }
 { RTSP\_MESSAGE response; int error = -1;
 if (!requestOptions(&response, &error)) { Limelog("RTSP OPTIONS request failed: %d\n", error); ret = error; goto Exit; }
 if (response.message.response.statusCode != 200) { Limelog("RTSP OPTIONS request failed: %d\n", response.message.response.statusCode); ret = response.message.response.statusCode; goto Exit; }
 freeMessage(&response); }
 { RTSP\_MESSAGE response; int error = -1;
 if (!requestDescribe(&response, &error)) { Limelog("RTSP DESCRIBE request failed: %d\n", error); ret = error; goto Exit; }
 if (response.message.response.statusCode != 200) { Limelog("RTSP DESCRIBE request failed: %d\n", response.message.response.statusCode); ret = response.message.response.statusCode; goto Exit; }  if ((StreamConfig.supportedVideoFormats & VIDEO\_FORMAT\_MASK\_AV1) && strstr(response.payload, "AV1/90000")) { if ((serverInfo->serverCodecModeSupport & SCM\_AV1\_MAIN10) && (StreamConfig.supportedVideoFormats & VIDEO\_FORMAT\_AV1\_MAIN10)) { NegotiatedVideoFormat = VIDEO\_FORMAT\_AV1\_MAIN10; } else { NegotiatedVideoFormat = VIDEO\_FORMAT\_AV1\_MAIN8;
 // Apply bitrate adjustment for SDR AV1 if the client requested one if (StreamConfig.av1BitratePercentageMultiplier != 0) { StreamConfig.bitrate \*= StreamConfig.av1BitratePercentageMultiplier; StreamConfig.bitrate /= 100; } } } else if ((StreamConfig.supportedVideoFormats & VIDEO\_FORMAT\_MASK\_H265) && strstr(response.payload, "sprop-parameter-sets=AAAAAU")) { // The RTSP DESCRIBE reply will contain a collection of SDP media attributes that // describe the various supported video stream formats and include the SPS, PPS, // and VPS (if applicable). We will use this information to determine whether the // server can support HEVC. For some reason, they still set the MIME type of the HEVC // format to H264, so we can't just look for the HEVC MIME type. What we'll do instead is // look for the base 64 encoded VPS NALU prefix that is unique to the HEVC bitstream. if ((serverInfo->serverCodecModeSupport & SCM\_HEVC\_MAIN10) && (StreamConfig.supportedVideoFormats & VIDEO\_FORMAT\_H265\_MAIN10)) { NegotiatedVideoFormat = VIDEO\_FORMAT\_H265\_MAIN10; } else { NegotiatedVideoFormat = VIDEO\_FORMAT\_H265;
 // Apply bitrate adjustment for SDR HEVC if the client requested one if (StreamConfig.hevcBitratePercentageMultiplier != 0) { StreamConfig.bitrate \*= StreamConfig.hevcBitratePercentageMultiplier; StreamConfig.bitrate /= 100; } } } else { NegotiatedVideoFormat = VIDEO\_FORMAT\_H264;
 // Dimensions over 4096 are only supported with HEVC on NVENC if (StreamConfig.width > 4096 || StreamConfig.height > 4096) { Limelog("WARNING: Host PC doesn't support HEVC. Streaming at resolutions above 4K using H.264 will likely fail!\n"); } }
 // Look for the SDP attribute that indicates we're dealing with a server that supports RFI ReferenceFrameInvalidationSupported = strstr(response.payload, "x-nv-video[0].refPicInvalidation") != NULL; if (!ReferenceFrameInvalidationSupported) { Limelog("Reference frame invalidation is not supported by this host\n"); }
 // Look for the Sunshine feature flags in the SDP attributes if (!parseSdpAttributeToUInt(response.payload, "x-ss-general.featureFlags", &SunshineFeatureFlags)) { SunshineFeatureFlags = 0; }
 // Parse the Opus surround parameters out of the RTSP DESCRIBE response. ret = parseOpusConfigurations(&response); if (ret != 0) { goto Exit; }
 freeMessage(&response); }
 { RTSP\_MESSAGE response; char\* sessionId; char\* pingPayload; int error = -1;
 if (!setupStream(&response, AppVersionQuad[0] >= 5 ? "streamid=audio/0/0" : "streamid=audio", &error)) { Limelog("RTSP SETUP streamid=audio request failed: %d\n", error); ret = error; goto Exit; }
 if (response.message.response.statusCode != 200) { Limelog("RTSP SETUP streamid=audio request failed: %d\n", response.message.response.statusCode); ret = response.message.response.statusCode; goto Exit; }
 // Parse the audio port out of the RTSP SETUP response LC\_ASSERT(AudioPortNumber == 0); if (!parseServerPortFromTransport(&response, &AudioPortNumber)) { // Use the well known port if parsing fails AudioPortNumber = 48000;
 Limelog("Audio port: %u (RTSP parsing failed)\n", AudioPortNumber); } else { Limelog("Audio port: %u\n", AudioPortNumber);[View remainder of file in raw view](https://github.com/moonlight-stream/moonlight-common-c/raw/2bb026c763fc18807d7e4a93f918054c488f84e1/src/RtspConnection.c)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


