=== Content from github.com_3416fc4f_20250115_083822.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fsecurity%2Fadvisories%2FGHSA-f3h8-j898-5h5v)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fsecurity%2Fadvisories%2FGHSA-f3h8-j898-5h5v)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

# Stack buffer overflow due to `strcpy` into fixed size buffer in `extractVersionQuadFromString`

High

[cgutman](/cgutman)
published
GHSA-f3h8-j898-5h5v
Dec 14, 2023

## Package

moonlight-common-c

## Affected versions

>= f57bd745b4cbed577ea654fad4701bea4d38b44c

## Patched versions

>= b2497a3918a6d79808d9fd0c04734786e70d5954

## Description

### Impact

A malicious game streaming server could exploit a buffer overflow vulnerability to crash a moonlight client.

Acheiving RCE is possible but unlikely, due to stack canaries in use by modern compiler toolchains. The published binaries for official clients ([Qt](https://github.com/moonlight-stream/moonlight-qt), [Android](https://github.com/moonlight-stream/moonlight-android), [iOS/tvOS](https://github.com/moonlight-stream/moonlight-ios), and [Embedded](https://github.com/moonlight-stream/moonlight-qt)) are built with stack canaries, but some unofficial clients may not use stack canaries. The CVSS vulnerabililty severity score is based on the worst-case scenario of a client with no exploit mitigations.

This vulnerability takes place after the pairing process, so it requires the user to be tricked into pairing to a malicious host. It is not possible to perform using a MITM due to public key pinning that takes place during the pairing process.

### Details

A stack buffer may be overflowed if the `appversion` field in the server's `/serverinfo` response exceeds 127 characters.

The overflow takes place in the following code:

[moonlight-common-c/src/Misc.c](https://github.com/moonlight-stream/moonlight-common-c/blob/c1744de06938b5a5c8897a705be1bc6508dc7580/src/Misc.c#L82-L88)

Lines 82 to 88
in
[c1744de](/moonlight-stream/moonlight-common-c/commit/c1744de06938b5a5c8897a705be1bc6508dc7580)

|  | int extractVersionQuadFromString(const char\* string, int\* quad) { |
| --- | --- |
|  | char versionString[128]; |
|  | char\* nextDot; |
|  | char\* nextNumber; |
|  | int i; |
|  |  |
|  | strcpy(versionString, string); |

The server provided `serverInfo->serverInfoAppVersion` string that is passed to `extractVersionQuadFromString()` is not guaranteed to be bounded in length. Therefore, the provided string may exceed the fixed sized `versionString` buffer used as the destination of the `strcpy()` call.

### Patch

The bug was addressed in [b2497a3](https://github.com/moonlight-stream/moonlight-common-c/commit/b2497a3918a6d79808d9fd0c04734786e70d5954)

### Affected Moonlight Client Versions

Known affected clients are listed below for convenience. Not all clients may be vulnerable with the same severity due to differences in built-in exploit mitigations on each platform.

Affected client versions:

* [Moonlight Qt/PC](https://github.com/moonlight-stream/moonlight-qt) - versions prior to v5.0
* [Moonlight iOS/tvOS](https://github.com/moonlight-stream/moonlight-ios) - versions prior to v9.0
* [Moonlight Android](https://github.com/moonlight-stream/moonlight-android) - versions prior to v12.0
* [Moonlight Chrome](https://github.com/moonlight-stream/moonlight-chrome) - versions prior to v0.10.23
* [Moonlight Embedded](https://github.com/moonlight-stream/moonlight-embedded) - versions prior to v2.6.1
* [Moonlight Xbox](https://github.com/TheElixZammuto/moonlight-xbox) - versions prior to v1.14.5
* [Moonlight TV](https://github.com/mariotaku/moonlight-tv) - versions prior to v1.6.0
* [Moonlight Switch](https://github.com/XITRIX/Moonlight-Switch) - versions prior to v0.13.4
* [Moonlight Vita](https://github.com/xyzz/vita-moonlight) - all versions

There may be other third-party Moonlight clients and forks that were not investigated for vulnerability.

### Severity

High

7.6

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
Required

Scope
Unchanged

Confidentiality
Low

Integrity
Low

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:H

### CVE ID

CVE-2023-42801

### Weaknesses

[CWE-120](/advisories?query=cwe%3A120)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_00b1a077_20250115_083820.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Ff57bd745b4cbed577ea654fad4701bea4d38b44c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Ff57bd745b4cbed577ea654fad4701bea4d38b44c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Commit

[Permalink](/moonlight-stream/moonlight-common-c/commit/f57bd745b4cbed577ea654fad4701bea4d38b44c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

API update to provide enough information to support GFE 3.0.7

[Browse files](/moonlight-stream/moonlight-common-c/tree/f57bd745b4cbed577ea654fad4701bea4d38b44c)
Browse the repository at this point in the history

* Loading branch information

[![@cgutman](https://avatars.githubusercontent.com/u/2695644?s=40&v=4)](/cgutman)

[cgutman](/moonlight-stream/moonlight-common-c/commits?author=cgutman "View all commits by cgutman")
committed
Oct 6, 2016

1 parent
[ed2c4e7](/moonlight-stream/moonlight-common-c/commit/ed2c4e716b2b1fdfbeb6d0d792e78a061865d3f5)

commit f57bd74

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**103 additions**
and
**48 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/Connection.c
    [Connection.c](#diff-6aa947e4305dab73570f2e4d1d6eae0e97900a658f6c125772695dfd111c820c)
  + src/ControlStream.c
    [ControlStream.c](#diff-a059c1a505bad3b0b398c6335f8670711daf7e266e54858c32b123454f4055fe)
  + src/InputStream.c
    [InputStream.c](#diff-25e226786e37e2a47d2a219e0ab4a797ae749111e00c9cb95b13bfe535f7f982)
  + src/Limelight-internal.h
    [Limelight-internal.h](#diff-7f6f0a09776044dee447b6aec864b9774dfac284e88e6dd901858e921592fd38)
  + src/Limelight.h
    [Limelight.h](#diff-91ce3e358bf54b78b058cc3c032c35969ff067ab8e53ac9eb452a70244a39ebd)
  + src/Misc.c
    [Misc.c](#diff-bafa2be8a3379ef2699bf31b0d50067e69faf54eeaa97400df224455138e3f78)
  + src/RtspConnection.c
    [RtspConnection.c](#diff-8b678559c0bf2ad7ac3b7fd275a8138dd1e46c27d00ae881af423ad3629b4617)
  + src/SdpGenerator.c
    [SdpGenerator.c](#diff-b240889a66edd86e87521589c5a88cfc931f62edf8e252c95c8547f0e7ab4181)
  + src/VideoDepacketizer.c
    [VideoDepacketizer.c](#diff-0f7550dcf31c2ea2f74253a49ba338d54d2b95c6a73677e3733c37923f36a486)
  + src/VideoStream.c
    [VideoStream.c](#diff-22fc7054e8b85fe635d52966629b52c3833caec5898a9071e2c1a9532926e3ac)

## There are no files selected for viewing

19 changes: 12 additions & 7 deletions

19
[src/Connection.c](#diff-6aa947e4305dab73570f2e4d1d6eae0e97900a658f6c125772695dfd111c820c "src/Connection.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/Connection.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,7 +11,7 @@ static long terminationCallbackErrorCode; |
|  |  | char\* RemoteAddrString; |
|  |  | struct sockaddr\_storage RemoteAddr; |
|  |  | SOCKADDR\_LEN RemoteAddrLen; |
|  |  | int ServerMajorVersion; |
|  |  | int AppVersionQuad[4]; |
|  |  | STREAM\_CONFIGURATION StreamConfig; |
|  |  | CONNECTION\_LISTENER\_CALLBACKS ListenerCallbacks; |
|  |  | DECODER\_RENDERER\_CALLBACKS VideoCallbacks; |
| Expand Down  Expand Up | | @@ -206,15 +206,20 @@ static int resolveHostName(const char\* host) |
|  |  | } |
|  |  |  |
|  |  | // Starts the connection to the streaming machine |
|  |  | int LiStartConnection(const char\* host, PSTREAM\_CONFIGURATION streamConfig, PCONNECTION\_LISTENER\_CALLBACKS clCallbacks, |
|  |  | PDECODER\_RENDERER\_CALLBACKS drCallbacks, PAUDIO\_RENDERER\_CALLBACKS arCallbacks, |
|  |  | void\* renderContext, int drFlags, int \_serverMajorVersion) { |
|  |  | int LiStartConnection(PSERVER\_INFORMATION serverInfo, PSTREAM\_CONFIGURATION streamConfig, PCONNECTION\_LISTENER\_CALLBACKS clCallbacks, |
|  |  | PDECODER\_RENDERER\_CALLBACKS drCallbacks, PAUDIO\_RENDERER\_CALLBACKS arCallbacks, void\* renderContext, int drFlags) { |
|  |  | int err; |
|  |  |  |
|  |  | NegotiatedVideoFormat = 0; |
|  |  | ServerMajorVersion = \_serverMajorVersion; |
|  |  | memcpy(&StreamConfig, streamConfig, sizeof(StreamConfig)); |
|  |  | RemoteAddrString = strdup(host); |
|  |  | RemoteAddrString = strdup(serverInfo->address); |
|  |  |  |
|  |  | // Extract the appversion from the supplied string |
|  |  | if (extractVersionQuadFromString(serverInfo->serverInfoAppVersion, |
|  |  | AppVersionQuad) < 0) { |
|  |  | Limelog("Invalid appversion string: %s\n", serverInfo->serverInfoAppVersion); |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | // Replace missing callbacks with placeholders |
|  |  | fixupMissingCallbacks(&drCallbacks, &arCallbacks, &clCallbacks); |
| Expand Down  Expand Up | | @@ -244,7 +249,7 @@ int LiStartConnection(const char\* host, PSTREAM\_CONFIGURATION streamConfig, PCON |
|  |  |  |
|  |  | Limelog("Resolving host name..."); |
|  |  | ListenerCallbacks.stageStarting(STAGE\_NAME\_RESOLUTION); |
|  |  | err = resolveHostName(host); |
|  |  | err = resolveHostName(serverInfo->address); |
|  |  | if (err != 0) { |
|  |  | Limelog("failed: %d\n", err); |
|  |  | ListenerCallbacks.stageFailed(STAGE\_NAME\_RESOLUTION, err); |
| Expand Down | |  |

20 changes: 10 additions & 10 deletions

20
[src/ControlStream.c](#diff-a059c1a505bad3b0b398c6335f8670711daf7e266e54858c32b123454f4055fe "src/ControlStream.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/ControlStream.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -151,17 +151,17 @@ int initializeControlStream(void) { |
|  |  | PltCreateEvent(&invalidateRefFramesEvent); |
|  |  | LbqInitializeLinkedBlockingQueue(&invalidReferenceFrameTuples, 20); |
|  |  |  |
|  |  | if (ServerMajorVersion == 3) { |
|  |  | if (AppVersionQuad[0] == 3) { |
|  |  | packetTypes = (short\*)packetTypesGen3; |
|  |  | payloadLengths = (short\*)payloadLengthsGen3; |
|  |  | preconstructedPayloads = (char\*\*)preconstructedPayloadsGen3; |
|  |  | } |
|  |  | else if (ServerMajorVersion == 4) { |
|  |  | else if (AppVersionQuad[0] == 4) { |
|  |  | packetTypes = (short\*)packetTypesGen4; |
|  |  | payloadLengths = (short\*)payloadLengthsGen4; |
|  |  | preconstructedPayloads = (char\*\*)preconstructedPayloadsGen4; |
|  |  | } |
|  |  | else if (ServerMajorVersion == 5) { |
|  |  | else if (AppVersionQuad[0] == 5) { |
|  |  | packetTypes = (short\*)packetTypesGen5; |
|  |  | payloadLengths = (short\*)payloadLengthsGen5; |
|  |  | preconstructedPayloads = (char\*\*)preconstructedPayloadsGen5; |
| Expand Down  Expand Up | | @@ -290,7 +290,7 @@ static int sendMessageEnet(short ptype, short paylen, const void\* payload) { |
|  |  | ENetEvent event; |
|  |  | int err; |
|  |  |  |
|  |  | LC\_ASSERT(ServerMajorVersion >= 5); |
|  |  | LC\_ASSERT(AppVersionQuad[0] >= 5); |
|  |  |  |
|  |  | // We may be trying to disconnect, so our peer could be gone. |
|  |  | // This check is safe because we're guaranteed to be holding enetMutex. |
| Expand Down  Expand Up | | @@ -347,7 +347,7 @@ static int sendMessageTcp(short ptype, short paylen, const void\* payload) { |
|  |  | PNVCTL\_TCP\_PACKET\_HEADER packet; |
|  |  | SOCK\_RET err; |
|  |  |  |
|  |  | LC\_ASSERT(ServerMajorVersion < 5); |
|  |  | LC\_ASSERT(AppVersionQuad[0] < 5); |
|  |  |  |
|  |  | packet = malloc(sizeof(\*packet) + paylen); |
|  |  | if (packet == NULL) { |
| Expand All | | @@ -373,7 +373,7 @@ static int sendMessageAndForget(short ptype, short paylen, const void\* payload) |
|  |  |  |
|  |  | // Unlike regular sockets, ENet sockets aren't safe to invoke from multiple |
|  |  | // threads at once. We have to synchronize them with a lock. |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | PltLockMutex(&enetMutex); |
|  |  | ret = sendMessageEnet(ptype, paylen, payload); |
|  |  | PltUnlockMutex(&enetMutex); |
| Expand All | | @@ -387,7 +387,7 @@ static int sendMessageAndForget(short ptype, short paylen, const void\* payload) |
|  |  |  |
|  |  | static int sendMessageAndDiscardReply(short ptype, short paylen, const void\* payload) { |
|  |  | // Discard the response |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | ENetEvent event; |
|  |  |  |
|  |  | PltLockMutex(&enetMutex); |
| Expand Down  Expand Up | | @@ -469,7 +469,7 @@ static void lossStatsThreadFunc(void\* context) { |
|  |  | static void requestIdrFrame(void) { |
|  |  | long long payload[3]; |
|  |  |  |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | // Form the payload |
|  |  | if (lastSeenFrame < 0x20) { |
|  |  | payload[0] = 0; |
| Expand Down  Expand Up | | @@ -610,7 +610,7 @@ int stopControlStream(void) { |
|  |  |  |
|  |  | // Called by the input stream to send a packet for Gen 5+ servers |
|  |  | int sendInputPacketOnControlStream(unsigned char\* data, int length) { |
|  |  | LC\_ASSERT(ServerMajorVersion >= 5); |
|  |  | LC\_ASSERT(AppVersionQuad[0] >= 5); |
|  |  |  |
|  |  | // Send the input data (no reply expected) |
|  |  | if (sendMessageAndForget(packetTypes[IDX\_INPUT\_DATA], length, data) == 0) { |
| Expand All | | @@ -626,7 +626,7 @@ int startControlStream(void) { |
|  |  |  |
|  |  | PltCreateMutex(&enetMutex); |
|  |  |  |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | ENetAddress address; |
|  |  | ENetEvent event; |
|  |  |  |
| Expand Down | |  |

18 changes: 9 additions & 9 deletions

18
[src/InputStream.c](#diff-25e226786e37e2a47d2a219e0ab4a797ae749111e00c9cb95b13bfe535f7f982 "src/InputStream.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/InputStream.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -116,7 +116,7 @@ static int encryptData(const unsigned char\* plaintext, int plaintextLen, |
|  |  | int ret; |
|  |  | int len; |
|  |  |  |
|  |  | if (ServerMajorVersion >= 7) { |
|  |  | if (AppVersionQuad[0] >= 7) { |
|  |  | EVP\_CIPHER\_CTX\_init(&cipherContext); |
|  |  |  |
|  |  | // Gen 7 servers use 128-bit AES GCM |
| Expand Down  Expand Up | | @@ -332,7 +332,7 @@ static void inputSendThreadProc(void\* context) { |
|  |  | encryptedLengthPrefix = htonl((unsigned long)encryptedSize); |
|  |  | memcpy(&encryptedBuffer[0], &encryptedLengthPrefix, 4); |
|  |  |  |
|  |  | if (ServerMajorVersion < 5) { |
|  |  | if (AppVersionQuad[0] < 5) { |
|  |  | // Send the encrypted payload |
|  |  | err = send(inputSock, (const char\*) encryptedBuffer, |
|  |  | (int) (encryptedSize + sizeof(encryptedLengthPrefix)), 0); |
| Expand All | | @@ -347,7 +347,7 @@ static void inputSendThreadProc(void\* context) { |
|  |  | // bytes of ciphertext in the most recent game controller packet as the IV for |
|  |  | // future encryption. I think it may be a buffer overrun on their end but we'll have |
|  |  | // to mimic it to work correctly. |
|  |  | if (ServerMajorVersion >= 7 && encryptedSize >= 16 + sizeof(currentAesIv)) { |
|  |  | if (AppVersionQuad[0] >= 7 && encryptedSize >= 16 + sizeof(currentAesIv)) { |
|  |  | memcpy(currentAesIv, |
|  |  | &encryptedBuffer[4 + encryptedSize - sizeof(currentAesIv)], |
|  |  | sizeof(currentAesIv)); |
| Expand All | | @@ -369,7 +369,7 @@ int startInputStream(void) { |
|  |  | int err; |
|  |  |  |
|  |  | // After Gen 5, we send input on the control stream |
|  |  | if (ServerMajorVersion < 5) { |
|  |  | if (AppVersionQuad[0] < 5) { |
|  |  | inputSock = connectTcpSocket(&RemoteAddr, RemoteAddrLen, |
|  |  | 35043, INPUT\_STREAM\_TIMEOUT\_SEC); |
|  |  | if (inputSock == INVALID\_SOCKET) { |
| Expand Down  Expand Up | | @@ -426,7 +426,7 @@ int LiSendMouseMoveEvent(short deltaX, short deltaY) { |
|  |  | holder->packet.mouseMove.header.packetType = htonl(PACKET\_TYPE\_MOUSE\_MOVE); |
|  |  | holder->packet.mouseMove.magic = MOUSE\_MOVE\_MAGIC; |
|  |  | // On Gen 5 servers, the header code is incremented by one |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | holder->packet.mouseMove.magic++; |
|  |  | } |
|  |  | holder->packet.mouseMove.deltaX = htons(deltaX); |
| Expand Down  Expand Up | | @@ -457,7 +457,7 @@ int LiSendMouseButtonEvent(char action, int button) { |
|  |  | holder->packetLength = sizeof(NV\_MOUSE\_BUTTON\_PACKET); |
|  |  | holder->packet.mouseButton.header.packetType = htonl(PACKET\_TYPE\_MOUSE\_BUTTON); |
|  |  | holder->packet.mouseButton.action = action; |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | holder->packet.mouseButton.action++; |
|  |  | } |
|  |  | holder->packet.mouseButton.button = htonl(button); |
| Expand Down  Expand Up | | @@ -515,7 +515,7 @@ static int sendControllerEventInternal(short controllerNumber, short buttonFlags |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | if (ServerMajorVersion == 3) { |
|  |  | if (AppVersionQuad[0] == 3) { |
|  |  | // Generation 3 servers don't support multiple controllers so we send |
|  |  | // the legacy packet |
|  |  | holder->packetLength = sizeof(NV\_CONTROLLER\_PACKET); |
| Expand All | | @@ -538,7 +538,7 @@ static int sendControllerEventInternal(short controllerNumber, short buttonFlags |
|  |  | holder->packet.multiController.header.packetType = htonl(PACKET\_TYPE\_MULTI\_CONTROLLER); |
|  |  | holder->packet.multiController.headerA = MC\_HEADER\_A; |
|  |  | // On Gen 5 servers, the header code is decremented by one |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | holder->packet.multiController.headerA--; |
|  |  | } |
|  |  | holder->packet.multiController.headerB = MC\_HEADER\_B; |
| Expand Down  Expand Up | | @@ -598,7 +598,7 @@ int LiSendScrollEvent(signed char scrollClicks) { |
|  |  | holder->packet.scroll.header.packetType = htonl(PACKET\_TYPE\_SCROLL); |
|  |  | holder->packet.scroll.magicA = MAGIC\_A; |
|  |  | // On Gen 5 servers, the header code is incremented by one |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | holder->packet.scroll.magicA++; |
|  |  | } |
|  |  | holder->packet.scroll.zero1 = 0; |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[src/Limelight-internal.h](#diff-7f6f0a09776044dee447b6aec864b9774dfac284e88e6dd901858e921592fd38 "src/Limelight-internal.h")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/Limelight-internal.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -12,7 +12,7 @@ |
|  |  | extern char\* RemoteAddrString; |
|  |  | extern struct sockaddr\_storage RemoteAddr; |
|  |  | extern SOCKADDR\_LEN RemoteAddrLen; |
|  |  | extern int ServerMajorVersion; |
|  |  | extern int AppVersionQuad[4]; |
|  |  | extern STREAM\_CONFIGURATION StreamConfig; |
|  |  | extern CONNECTION\_LISTENER\_CALLBACKS ListenerCallbacks; |
|  |  | extern DECODER\_RENDERER\_CALLBACKS VideoCallbacks; |
| Expand All | | @@ -21,6 +21,7 @@ extern int NegotiatedVideoFormat; |
|  |  |  |
|  |  | int isBeforeSignedInt(int numA, int numB, int ambiguousCase); |
|  |  | int serviceEnetHost(ENetHost\* client, ENetEvent\* event, enet\_uint32 timeoutMs); |
|  |  | int extractVersionQuadFromString(const char\* string, int\* quad); |
|  |  |  |
|  |  | void fixupMissingCallbacks(PDECODER\_RENDERER\_CALLBACKS\* drCallbacks, PAUDIO\_RENDERER\_CALLBACKS\* arCallbacks, |
|  |  | PCONNECTION\_LISTENER\_CALLBACKS\* clCallbacks); |
| Expand Down | |  |

21 changes: 17 additions & 4 deletions

21
[src/Limelight.h](#diff-91ce3e358bf54b78b058cc3c032c35969ff067ab8e53ac9eb452a70244a39ebd "src/Limelight.h")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/Limelight.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -214,15 +214,28 @@ typedef struct \_CONNECTION\_LISTENER\_CALLBACKS { |
|  |  | // Use this function to zero the connection callbacks when allocated on the stack or heap |
|  |  | void LiInitializeConnectionCallbacks(PCONNECTION\_LISTENER\_CALLBACKS clCallbacks); |
|  |  |  |
|  |  |  |
|  |  | typedef struct \_SERVER\_INFORMATION { |
|  |  | // Server host name or IP address in text form |
|  |  | const char\* address; |
|  |  |  |
|  |  | // Text inside 'appversion' tag in /serverinfo |
|  |  | const char\* serverInfoAppVersion; |
|  |  |  |
|  |  | // Text inside 'GfeVersion' tag in /serverinfo (if present) |
|  |  | const char\* serverInfoGfeVersion; |
|  |  | } SERVER\_INFORMATION, \*PSERVER\_INFORMATION; |
|  |  |  |
|  |  | // Use this function to zero the server information when allocated on the stack or heap |
|  |  | void LiInitializeServerInformation(PSERVER\_INFORMATION serverInfo); |
|  |  |  |
|  |  | // This function begins streaming. |
|  |  | // |
|  |  | // Callbacks are all optional. Pass NULL for individual callbacks within each struct or pass NULL for the entire struct |
|  |  | // to use the defaults for all callbacks. |
|  |  | // |
|  |  | // \_serverMajorVersion is the major version number of the 'appversion' tag in the /serverinfo request |
|  |  | // |
|  |  | int LiStartConnection(const char\* host, PSTREAM\_CONFIGURATION streamConfig, PCONNECTION\_LISTENER\_CALLBACKS clCallbacks, |
|  |  | PDECODER\_RENDERER\_CALLBACKS drCallbacks, PAUDIO\_RENDERER\_CALLBACKS arCallbacks, void\* renderContext, int drFlags, int \_serverMajorVersion); |
|  |  | int LiStartConnection(PSERVER\_INFORMATION serverInfo, PSTREAM\_CONFIGURATION streamConfig, PCONNECTION\_LISTENER\_CALLBACKS clCallbacks, |
|  |  | PDECODER\_RENDERER\_CALLBACKS drCallbacks, PAUDIO\_RENDERER\_CALLBACKS arCallbacks, void\* renderContext, int drFlags); |
|  |  |  |
|  |  | // This function stops streaming. |
|  |  | void LiStopConnection(void); |
| Expand Down | |  |

38 changes: 37 additions & 1 deletion

38
[src/Misc.c](#diff-bafa2be8a3379ef2699bf31b0d50067e69faf54eeaa97400df224455138e3f78 "src/Misc.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/Misc.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,6 +37,38 @@ int isBeforeSignedInt(int numA, int numB, int ambiguousCase) { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | int extractVersionQuadFromString(const char\* string, int\* quad) { |
|  |  | char versionString[128]; |
|  |  | char\* nextDot; |
|  |  | char\* nextNumber; |
|  |  | int i; |
|  |  |  |
|  |  | strcpy(versionString, string); |
|  |  | nextNumber = versionString; |
|  |  |  |
|  |  | for (i = 0; i < 4; i++) { |
|  |  | if (i == 3) { |
|  |  | nextDot = strchr(nextNumber, '\0'); |
|  |  | } |
|  |  | else { |
|  |  | nextDot = strchr(nextNumber, '.'); |
|  |  | } |
|  |  | if (nextDot == NULL) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | // Cut the string off at the next dot |
|  |  | \*nextDot = '\0'; |
|  |  |  |
|  |  | quad[i] = atoi(nextNumber); |
|  |  |  |
|  |  | // Move on to the next segment |
|  |  | nextNumber = nextDot + 1; |
|  |  | } |
|  |  |  |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | void LiInitializeStreamConfiguration(PSTREAM\_CONFIGURATION streamConfig) { |
|  |  | memset(streamConfig, 0, sizeof(\*streamConfig)); |
|  |  | } |
| Expand All | | @@ -51,4 +83,8 @@ void LiInitializeAudioCallbacks(PAUDIO\_RENDERER\_CALLBACKS arCallbacks) { |
|  |  |  |
|  |  | void LiInitializeConnectionCallbacks(PCONNECTION\_LISTENER\_CALLBACKS clCallbacks) { |
|  |  | memset(clCallbacks, 0, sizeof(\*clCallbacks)); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void LiInitializeServerInformation(PSERVER\_INFORMATION serverInfo) { |
|  |  | memset(serverInfo, 0, sizeof(\*serverInfo)); |
|  |  | } |

16 changes: 8 additions & 8 deletions

16
[src/RtspConnection.c](#diff-8b678559c0bf2ad7ac3b7fd275a8138dd1e46c27d00ae881af423ad3629b4617 "src/RtspConnection.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/f57bd745b4cbed577ea654fad4701bea4d38b44c/src/RtspConnection.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -273,7 +273,7 @@ static int transactRtspMessageTcp(PRTSP\_MESSAGE request, PRTSP\_MESSAGE response, |
|  |  |  |
|  |  | static int transactRtspMessage(PRTSP\_MESSAGE request, PRTSP\_MESSAGE response, int expectingPayload, int\* error) { |
|  |  | // Gen 5+ does RTSP over ENet not TCP |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | return transactRtspMessageEnet(request, response, expectingPayload, error); |
|  |  | } |
|  |  | else { |
| Expand Down  Expand Up | | @@ -349,7 +349,7 @@ static int setupStream(PRTSP\_MESSAGE response, char\* target, int\* error) { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (ServerMajorVersion >= 6) { |
|  |  | if (AppVersionQuad[0] >= 6) { |
|  |  | // It looks like GFE doesn't care what we say our port is but |
|  |  | // we need to give it some port to successfully complete the |
|  |  | // handshake process. |
| Expand Down  Expand Up | | @@ -446,7 +446,7 @@ int performRtspHandshake(void) { |
|  |  | currentSeqNumber = 1; |
|  |  | hasSessionId = 0; |
|  |  |  |
|  |  | switch (ServerMajorVersion) { |
|  |  | switch (AppVersionQuad[0]) { |
|  |  | case 3: |
|  |  | rtspClientVersion = 10; |
|  |  | break; |
| Expand All | | @@ -467,7 +467,7 @@ int performRtspHandshake(void) { |
|  |  | } |
|  |  |  |
|  |  | // Gen 5 servers use ENet to do the RTSP handshake |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | ENetAddress address; |
|  |  | ENetEvent event; |
|  |  |  |
| Expand Down  Expand Up | | @@ -562,7 +562,7 @@ int performRtspHandshake(void) { |
|  |  | int error = -1; |
|  |  |  |
|  |  | if (!setupStream(&response, |
|  |  | ServerMajorVersion >= 5 ? "streamid=audio/0/0" : "streamid=audio", |
|  |  | AppVersionQuad[0] >= 5 ? "streamid=audio/0/0" : "streamid=audio", |
|  |  | &error)) { |
|  |  | Limelog("RTSP SETUP streamid=audio request failed: %d\n", error); |
|  |  | ret = error; |
| Expand Down  Expand Up | | @@ -594,7 +594,7 @@ int performRtspHandshake(void) { |
|  |  | int error = -1; |
|  |  |  |
|  |  | if (!setupStream(&response, |
|  |  | ServerMajorVersion >= 5 ? "streamid=video/0/0" : "streamid=video", |
|  |  | AppVersionQuad[0] >= 5 ? "streamid=video/0/0" : "streamid=video", |
|  |  | &error)) { |
|  |  | Limelog("RTSP SETUP streamid=video request failed: %d\n", error); |
|  |  | ret = error; |
| Expand All | | @@ -611,7 +611,7 @@ int performRtspHandshake(void) { |
|  |  | freeMessage(&response); |
|  |  | } |
|  |  |  |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | RTSP\_MESSAGE response; |
|  |  | int error = -1; |
|  |  |  |
| Expand Down  Expand Up | | @@ -695,7 +695,7 @@ int performRtspHandshake(void) { |
|  |  |  |
|  |  | Exit: |
|  |  | // Cleanup the ENet stuff |
|  |  | if (ServerMajorVersion >= 5) { |
|  |  | if (AppVersionQuad[0] >= 5) { |
|  |  | if (peer != NULL) { |
|  |  | enet\_peer\_disconnect\_now(peer, 0); |
|  |  | peer = NULL; |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f57bd74`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Ff57bd745b4cbed577ea654fad4701bea4d38b44c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7dfc822c_20250115_083817.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fblob%2Fc1744de06938b5a5c8897a705be1bc6508dc7580%2Fsrc%2FMisc.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fblob%2Fc1744de06938b5a5c8897a705be1bc6508dc7580%2Fsrc%2FMisc.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Files

 c1744de
## Breadcrumbs

1. [moonlight-common-c](/moonlight-stream/moonlight-common-c/tree/c1744de06938b5a5c8897a705be1bc6508dc7580)
2. /[src](/moonlight-stream/moonlight-common-c/tree/c1744de06938b5a5c8897a705be1bc6508dc7580/src)
/
# Misc.c

Copy path Blame  Blame
## Latest commit

## History

[History](/moonlight-stream/moonlight-common-c/commits/c1744de06938b5a5c8897a705be1bc6508dc7580/src/Misc.c)161 lines (130 loc) · 5.26 KB c1744de
## Breadcrumbs

1. [moonlight-common-c](/moonlight-stream/moonlight-common-c/tree/c1744de06938b5a5c8897a705be1bc6508dc7580)
2. /[src](/moonlight-stream/moonlight-common-c/tree/c1744de06938b5a5c8897a705be1bc6508dc7580/src)
/
# Misc.c

Top
## File metadata and controls

* Code
* Blame

161 lines (130 loc) · 5.26 KB[Raw](https://github.com/moonlight-stream/moonlight-common-c/raw/c1744de06938b5a5c8897a705be1bc6508dc7580/src/Misc.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161#include "Limelight-internal.h"
#define ENET\_INTERNAL\_TIMEOUT\_MS 100
// This function wraps enet\_host\_service() and hides the fact that it must be called// multiple times for retransmissions to work correctly. It is meant to be a drop-in// replacement for enet\_host\_service(). It also handles cancellation of the connection// attempt during the wait.static int serviceEnetHostInternal(ENetHost\* client, ENetEvent\* event, enet\_uint32 timeoutMs, bool ignoreInterrupts) { int ret;
 // We need to call enet\_host\_service() multiple times to make sure retransmissions happen for (;;) { int selectedTimeout = timeoutMs < ENET\_INTERNAL\_TIMEOUT\_MS ? timeoutMs : ENET\_INTERNAL\_TIMEOUT\_MS;
 // We want to report an interrupt event if we are able to read data if (!ignoreInterrupts && ConnectionInterrupted) { Limelog("ENet wait interrupted\n"); ret = -1; break; }
 ret = enet\_host\_service(client, event, selectedTimeout); if (ret != 0 || timeoutMs == 0) { break; }
 timeoutMs -= selectedTimeout; }
 return ret;}
int serviceEnetHost(ENetHost\* client, ENetEvent\* event, enet\_uint32 timeoutMs) { return serviceEnetHostInternal(client, event, timeoutMs, false);}
// This function performs a graceful disconnect, including lingering until outbound// traffic is acked (up until the linger timeout elapses).int gracefullyDisconnectEnetPeer(ENetHost\* host, ENetPeer\* peer, enet\_uint32 lingerTimeoutMs) { // Check if this peer is currently alive. We won't get another ENET\_EVENT\_TYPE\_DISCONNECT // event from ENet if the peer is dead. In that case, we'll do an abortive disconnect. if (peer->state == ENET\_PEER\_STATE\_CONNECTED) { ENetEvent event; int err;
 // Begin the disconnection process. We'll get ENET\_EVENT\_TYPE\_DISCONNECT once // the peer acks all outstanding reliable sends. enet\_peer\_disconnect\_later(peer, 0);
 // We must use the internal function which lets us ignore pending interrupts. while ((err = serviceEnetHostInternal(host, &event, lingerTimeoutMs, true)) > 0) { switch (event.type) { case ENET\_EVENT\_TYPE\_RECEIVE: enet\_packet\_destroy(event.packet); break; case ENET\_EVENT\_TYPE\_DISCONNECT: Limelog("ENet peer acknowledged disconnection\n"); return 0; default: LC\_ASSERT(false); break; } }
 if (err == 0) { Limelog("Timed out waiting for ENet peer to acknowledge disconnection\n"); } else { Limelog("Failed to receive ENet peer disconnection acknowledgement\n"); }
 return -1; } else { Limelog("ENet peer is already disconnected\n"); enet\_peer\_disconnect\_now(peer, 0); return 0; }}
int extractVersionQuadFromString(const char\* string, int\* quad) { char versionString[128]; char\* nextDot; char\* nextNumber; int i;  strcpy(versionString, string); nextNumber = versionString;  for (i = 0; i < 4; i++) { if (i == 3) { nextDot = strchr(nextNumber, '\0'); } else { nextDot = strchr(nextNumber, '.'); } if (nextDot == NULL) { return -1; }  // Cut the string off at the next dot \*nextDot = '\0';  quad[i] = atoi(nextNumber);  // Move on to the next segment nextNumber = nextDot + 1; }  return 0;}
void\* extendBuffer(void\* ptr, size\_t newSize) { void\* newBuf = realloc(ptr, newSize); if (newBuf == NULL && ptr != NULL) { free(ptr); } return newBuf;}
bool isReferenceFrameInvalidationSupportedByDecoder(void) { LC\_ASSERT(NegotiatedVideoFormat != 0);
 return ((NegotiatedVideoFormat & VIDEO\_FORMAT\_MASK\_H264) && (VideoCallbacks.capabilities & CAPABILITY\_REFERENCE\_FRAME\_INVALIDATION\_AVC)) || ((NegotiatedVideoFormat & VIDEO\_FORMAT\_MASK\_H265) && (VideoCallbacks.capabilities & CAPABILITY\_REFERENCE\_FRAME\_INVALIDATION\_HEVC)) || ((NegotiatedVideoFormat & VIDEO\_FORMAT\_MASK\_AV1) && (VideoCallbacks.capabilities & CAPABILITY\_REFERENCE\_FRAME\_INVALIDATION\_AV1));}
bool isReferenceFrameInvalidationEnabled(void) { // RFI must be supported by the server and the client decoder to be used return ReferenceFrameInvalidationSupported && isReferenceFrameInvalidationSupportedByDecoder();}
void LiInitializeStreamConfiguration(PSTREAM\_CONFIGURATION streamConfig) { memset(streamConfig, 0, sizeof(\*streamConfig));}
void LiInitializeVideoCallbacks(PDECODER\_RENDERER\_CALLBACKS drCallbacks) { memset(drCallbacks, 0, sizeof(\*drCallbacks));}
void LiInitializeAudioCallbacks(PAUDIO\_RENDERER\_CALLBACKS arCallbacks) { memset(arCallbacks, 0, sizeof(\*arCallbacks));}
void LiInitializeConnectionCallbacks(PCONNECTION\_LISTENER\_CALLBACKS clCallbacks) { memset(clCallbacks, 0, sizeof(\*clCallbacks));}
void LiInitializeServerInformation(PSERVER\_INFORMATION serverInfo) { memset(serverInfo, 0, sizeof(\*serverInfo));}
uint64\_t LiGetMillis(void) { return PltGetMillis();}
uint32\_t LiGetHostFeatureFlags(void) { return SunshineFeatureFlags;}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8b4a9124_20250115_083819.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Fb2497a3918a6d79808d9fd0c04734786e70d5954)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Fb2497a3918a6d79808d9fd0c04734786e70d5954)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=moonlight-stream%2Fmoonlight-common-c)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[moonlight-stream](/moonlight-stream)
/
**[moonlight-common-c](/moonlight-stream/moonlight-common-c)**
Public

* [Notifications](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c) You must be signed in to change notification settings
* [Fork
  174](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)
* [Star
   472](/login?return_to=%2Fmoonlight-stream%2Fmoonlight-common-c)

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues
  14](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests
  5](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects
  0](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

Additional navigation options

* [Code](/moonlight-stream/moonlight-common-c)
* [Issues](/moonlight-stream/moonlight-common-c/issues)
* [Pull requests](/moonlight-stream/moonlight-common-c/pulls)
* [Actions](/moonlight-stream/moonlight-common-c/actions)
* [Projects](/moonlight-stream/moonlight-common-c/projects)
* [Security](/moonlight-stream/moonlight-common-c/security)
* [Insights](/moonlight-stream/moonlight-common-c/pulse)

## Commit

[Permalink](/moonlight-stream/moonlight-common-c/commit/b2497a3918a6d79808d9fd0c04734786e70d5954)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Rewrite extractVersionQuadFromString() to avoid copying the input string

[Browse files](/moonlight-stream/moonlight-common-c/tree/b2497a3918a6d79808d9fd0c04734786e70d5954)
Browse the repository at this point in the history

* Loading branch information

[![@cgutman](https://avatars.githubusercontent.com/u/2695644?s=40&v=4)](/cgutman)

[cgutman](/moonlight-stream/moonlight-common-c/commits?author=cgutman "View all commits by cgutman")
committed
Oct 6, 2023

1 parent
[8b84d17](/moonlight-stream/moonlight-common-c/commit/8b84d17c8d34e76d2531c6695d61349776474df2)

commit b2497a3

Showing
**1 changed file**
with
**12 additions**
and
**25 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

37 changes: 12 additions & 25 deletions

37
[src/Misc.c](#diff-bafa2be8a3379ef2699bf31b0d50067e69faf54eeaa97400df224455138e3f78 "src/Misc.c")

Show comments

[View file](/moonlight-stream/moonlight-common-c/blob/b2497a3918a6d79808d9fd0c04734786e70d5954/src/Misc.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -80,32 +80,19 @@ int gracefullyDisconnectEnetPeer(ENetHost\* host, ENetPeer\* peer, enet\_uint32 lin |
|  |  | } |
|  |  |  |
|  |  | int extractVersionQuadFromString(const char\* string, int\* quad) { |
|  |  | char versionString[128]; |
|  |  | char\* nextDot; |
|  |  | char\* nextNumber; |
|  |  | int i; |
|  |  |  |
|  |  | strcpy(versionString, string); |
|  |  | nextNumber = versionString; |
|  |  |  |
|  |  | for (i = 0; i < 4; i++) { |
|  |  | if (i == 3) { |
|  |  | nextDot = strchr(nextNumber, '\0'); |
|  |  | } |
|  |  | else { |
|  |  | nextDot = strchr(nextNumber, '.'); |
|  |  | } |
|  |  | if (nextDot == NULL) { |
|  |  | return -1; |
|  |  | const char\* nextNumber = string; |
|  |  | for (int i = 0; i < 4; i++) { |
|  |  | // Parse the next component |
|  |  | quad[i] = (int)strtol(nextNumber, (char\*\*)&nextNumber, 10); |
|  |  |  |
|  |  | // Skip the dot if we still have version components left. |
|  |  | // |
|  |  | // We continue looping even when we're at the end of the |
|  |  | // input string to ensure all subsequent version components |
|  |  | // are zeroed. |
|  |  | if (\*nextNumber != 0) { |
|  |  | nextNumber++; |
|  |  | } |
|  |  |  |
|  |  | // Cut the string off at the next dot |
|  |  | \*nextDot = '\0'; |
|  |  |  |
|  |  | quad[i] = atoi(nextNumber); |
|  |  |  |
|  |  | // Move on to the next segment |
|  |  | nextNumber = nextDot + 1; |
|  |  | } |
|  |  |  |
|  |  | return 0; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b2497a3`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmoonlight-stream%2Fmoonlight-common-c%2Fcommit%2Fb2497a3918a6d79808d9fd0c04734786e70d5954) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


