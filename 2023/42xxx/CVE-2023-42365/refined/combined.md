=== Content from bugs.busybox.net_c0b89d46_20250114_231030.html ===


Bugzilla – Bug 15871
[busybox 1.36.1] use-after-free in awk
Last modified: 2024-09-17 21:07:32 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](docs/en/html/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=15871&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=15871&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 15871**](show_bug.cgi?id=15871)
- [busybox 1.36.1] use-after-free in awk

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
[busybox 1.36.1] use-after-free in awk

| | [Status](page.cgi?id=fields.html#bug_status): | NEW | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Busybox | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Busybox "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Other ([show other bugs](buglist.cgi?component=Other&product=Busybox&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | P5 normal | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | unassigned | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2023-11-23 04:43 UTC by zclin | | --- | --- | | Modified: | 2024-09-17 21:07 UTC ([History](show_activity.cgi?id=15871)) | | CC List: | 2 users (show)  busybox-cvs uwe | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Host:](page.cgi?id=fields.html#cf_host "The system where the compiled code runs. e.g. you compiled busybox on your desktop to run on an ARM host -- ARM is the host.") |  | | [Target:](page.cgi?id=fields.html#cf_target "Used when building cross-compilers. This is the system your cross-compiler for which code is generated.") |  | | [Build:](page.cgi?id=fields.html#cf_build "The system where you compile. e.g. you compiled busybox on your x86 desktop.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**POC file**](attachment.cgi?id=9673 "View the content of the attachment") (4.63 KB, application/octet-stream)  [2023-11-23 04:44 UTC](#attach_9673 "Go to the comment associated with the attachment"), zclin | [Details](attachment.cgi?id=9673&action=edit) | | [**awk\_t1\_input file**](attachment.cgi?id=9676 "View the content of the attachment") (47.00 KB, application/octet-stream)  [2023-11-23 04:44 UTC](#attach_9676 "Go to the comment associated with the attachment"), zclin | [Details](attachment.cgi?id=9676&action=edit) | | [**1.36.1 patch for CVE-2023-42364 CVE-2023-42365**](attachment.cgi?id=9811 "View the content of the attachment") (1.58 KB, patch)  [2024-09-17 21:07 UTC](#attach_9811 "Go to the comment associated with the attachment"), David Leonard | [Details](attachment.cgi?id=9811&action=edit) | | [Add an attachment](attachment.cgi?bugid=15871&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=15871&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=15871#c0)  zclin    2023-11-23 04:43:46 UTC  ``` Hi, busybox developers, We found a use-after-free vulnerability in awk applet of busybox v1.36.1. The affected component is awk.c:1064 in copyvar function. Following is the reproduction process, and we put the poc file in the attachment. [1.] Environment Ubuntu 18.04, 64 bit BusyBox 1.36.1 Clang 6.0.0  [2.] Compilation 2.1 Modify the Makefile: HOSTCC=clang -fsanitize=address HOSTCXX=clang++ -fsanitize=address CC=clang CFLAGS=-fsanitize=address CPPFLAGS=-fsanitize=address LDFLAGS="-Wl,--allow-multiple-definition" 2.2 Modify the Config.in file, switch the following configs to y： DEBUG: y DEBUG_PESSIMIZE: y FEATURE_CLEAN_UP: y DEBUG_SANITIZE: y 2.3 Commands for compilation: export ASAN_OPTIONS=detect_leaks=0 make defconfig make install  [3.] Reproduction export ASAN_OPTIONS="abort_on_error=1 symbolize=0" ./busybox_unstripped awk -f $poc ./awk_t1_input [ASAN report]:  ==32093==ERROR: AddressSanitizer: heap-use-after-free on address 0x606000003080 at pc 0x000000e7dfe2 bp 0x7fff6ee9b930 sp 0x7fff6ee9b928 READ of size 4 at 0x606000003080 thread T0     #0 0xe7dfe1  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe7dfe1)     #1 0xe4bbdf  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4bbdf)     #2 0xe4eb16  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4eb16)     #3 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #4 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #5 0xe4062d  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4062d)     #6 0x50ac81  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50ac81)     #7 0x50dbaf  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50dbaf)     #8 0x51036d  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x51036d)     #9 0x50db58  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50db58)     #10 0x50c3fd  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50c3fd)     #11 0x7f8358526c86  (/lib/x86_64-linux-gnu/libc.so.6+0x21c86)     #12 0x41e459  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x41e459)  0x606000003080 is located 0 bytes inside of 64-byte region [0x606000003080,0x6060000030c0) freed by thread T0 here:     #0 0x4dc500  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x4dc500)     #1 0xe7f4ca  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe7f4ca)     #2 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #3 0xe4eb16  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4eb16)     #4 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #5 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #6 0xe4062d  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4062d)     #7 0x50ac81  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50ac81)  previously allocated by thread T0 here:     #0 0x4dc6d0  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x4dc6d0)     #1 0x519df2  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x519df2)     #2 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #3 0xe4eb16  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4eb16)     #4 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #5 0xe4886f  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4886f)     #6 0xe4062d  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe4062d)     #7 0x50ac81  (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0x50ac81)  SUMMARY: AddressSanitizer: heap-use-after-free (/home/zclin/afl-vul-score/llvm_mode/research/path-collect-all-new-0524/path-collect-all-new/busybox/reproduce/busybox-1_36_1/fuzz_check/awk/busybox_unstripped+0xe7dfe1)    [line number]:  addr2line -e ./busybox_unstripped 0xe7dfe1 .../busybox-1_36_1/editors/awk.c:1064  Best wishes, Zclin ```  [Comment 1](show_bug.cgi?id=15871#c1)  zclin    2023-11-23 04:44:10 UTC  ``` Created [attachment 9673](attachment.cgi?id=9673 "POC file") [[details]](attachment.cgi?id=9673&action=edit "POC file") POC file ```  [Comment 2](show_bug.cgi?id=15871#c2)  zclin    2023-11-23 04:44:30 UTC  ``` Created [attachment 9676](attachment.cgi?id=9676 "awk_t1_input file") [[details]](attachment.cgi?id=9676&action=edit "awk_t1_input file") awk_t1_input file ```  [Comment 3](show_bug.cgi?id=15871#c3)  Valery Ushakov    2024-01-25 00:50:34 UTC  ``` The result of OC_REPLACE may be a TEMPVAR0 via L.v    res = setvar_i(((opinfo & OPCLSMASK) == OC_BINARY) ? res : L.v, ...); ```  [Comment 4](show_bug.cgi?id=15871#c4)  Natanael Copa    2024-05-20 15:50:40 UTC  ``` This appears to be fixed in git master. valgrind with the attached POC does not show anything.  But I am not sure which commit fixes it? ```  [Comment 5](show_bug.cgi?id=15871#c5)  Natanael Copa    2024-05-20 17:25:19 UTC  ``` A git bisect with the POC shows that it was fixed with  commit 0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4 (HEAD) Author: Denys Vlasenko <vda.linux@googlemail.com> Date:   Tue May 30 16:42:18 2023 +0200      awk: fix precedence of = relative to ==   <https://git.busybox.net/busybox/commit/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4> ```  [Comment 6](show_bug.cgi?id=15871#c6)  Natanael Copa    2024-05-21 15:10:20 UTC  ``` (In reply to Natanael Copa from [comment #5](show_bug.cgi?id=15871#c5))  The commit that "fixes" it also introduces a regression.    awk 'BEGIN { a = 0 ? \"yes\": \"no\"; print a }'  Prints '0' instead of 'no'. But that is a different issue.  I have a smaller reproducer for the use-after-free:  ``` function f1(v) { 	return v }  function f2(a) { 	return f1(a) -= 0 }  function f3(a) { 	return missingfunc(a) }  BEGIN { 	f2() || f3() } ```   Or: awk 'function f1(v) { return v } function f2(a) { return f1(a) -= 0 } function f3(a) { return missingfunc(a) } BEGIN { f2() || f3() }' ```  [Comment 7](show_bug.cgi?id=15871#c7)  David Leonard    2024-09-17 21:07:32 UTC  ``` Created [attachment 9811](attachment.cgi?id=9811 "1.36.1 patch for CVE-2023-42364 CVE-2023-42365") [[details]](attachment.cgi?id=9811&action=edit "1.36.1 patch for CVE-2023-42364 CVE-2023-42365") 1.36.1 patch for CVE-2023-42364 CVE-2023-42365  So that we can interim patch 1.36.1, I have extracted and attached what I believe is the essential fix extracted from commit 0256e00a9d. It is the hunk that stops binary updates to a non-lvalue LHS (such as the f1(a)-=0 statement in the simplified POC). ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=15871)
* - [XML](show_bug.cgi?ctype=xml&id=15871)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=15871)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](docs/en/html/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=15871&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=15871&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from git.busybox.net_e491c7de_20250115_130202.html ===


| [cgit logo](/) | [index](/) : [busybox](/busybox/ "busybox") | 0\_60\_stable 1\_00\_stable 1\_00\_stable\_10817 1\_10\_stable 1\_11\_stable 1\_12\_stable 1\_13\_stable 1\_14\_stable 1\_15\_stable 1\_16\_stable 1\_17\_stable 1\_18\_stable 1\_19\_stable 1\_1\_stable 1\_20\_stable 1\_21\_stable 1\_22\_stable 1\_23\_stable 1\_24\_stable 1\_25\_stable 1\_26\_stable 1\_27\_stable 1\_28\_stable 1\_29\_stable 1\_30\_stable 1\_31\_stable 1\_32\_stable 1\_33\_stable 1\_34\_stable 1\_35\_stable 1\_36\_stable 1\_37\_stable 1\_3\_stable 1\_4\_stable 1\_5\_stable 1\_6\_stable 1\_7\_stable 1\_8\_stable 1\_9\_stable master |
| --- | --- | --- |
| BusyBox: The Swiss Army Knife of Embedded Linux | vda |

| [about](/busybox/about/)[summary](/busybox/)[refs](/busybox/refs/?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)[log](/busybox/log/editors/awk.c)[tree](/busybox/tree/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)[commit](/busybox/commit/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)[diff](/busybox/diff/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) | log msg author committer range |
| --- | --- |

path: [root](/busybox/commit/?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)/[editors](/busybox/commit/editors?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)/[awk.c](/busybox/commit/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Denys Vlasenko <vda.linux@googlemail.com> | 2023-05-30 16:42:18 +0200 |
| --- | --- | --- |
| committer | Denys Vlasenko <vda.linux@googlemail.com> | 2023-05-30 16:44:04 +0200 |
| commit | [0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4](/busybox/commit/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) ([patch](/busybox/patch/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)) | |
| tree | [bdd3f15616a63a3261f5433c4df7bf83ce9f1be3](/busybox/tree/?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) /[editors/awk.c](/busybox/tree/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) | |
| parent | [fe0b7985483a93d3416e0e5c9e761b6ee1ba310b](/busybox/commit/editors/awk.c?id=fe0b7985483a93d3416e0e5c9e761b6ee1ba310b) ([diff](/busybox/diff/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4&id2=fe0b7985483a93d3416e0e5c9e761b6ee1ba310b)) | |
| download | [busybox-0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4.tar.bz2](/busybox/snapshot/busybox-0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4.tar.bz2) | |

awk: fix precedence of = relative to ==Discovered while adding code to disallow assignments to non-lvalues
function old new delta
parse\_expr 936 991 +55
.rodata 105243 105247 +4
------------------------------------------------------------------------------
(add/remove: 0/0 grow/shrink: 2/0 up/down: 59/0) Total: 59 bytes
Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>
[Diffstat](/busybox/diff/?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) (limited to 'editors/awk.c')

| -rw-r--r-- | [editors/awk.c](/busybox/diff/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4) | 66 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 45 insertions, 21 deletions

| diff --git a/editors/awk.c b/editors/awk.cindex c49ad6e02..0f062dcdb 100644--- a/[editors/awk.c](/busybox/tree/editors/awk.c?id=fe0b7985483a93d3416e0e5c9e761b6ee1ba310b)+++ b/[editors/awk.c](/busybox/tree/editors/awk.c?id=0256e00a9d077588bd3a39f5a1ef7e2eaa2911e4)@@ -337,7 +337,9 @@ static void debug\_parse\_print\_tc(uint32\_t n) #undef P #undef PRIMASK #undef PRIMASK2-#define P(x) (x << 24)+/\* Smaller 'x' means \_higher\_ operator precedence \*/+#define PRECEDENCE(x) (x << 24)+#define P(x) PRECEDENCE(x) #define PRIMASK 0x7F000000 #define PRIMASK2 0x7E000000 @@ -360,7 +362,7 @@ enum { OC\_MOVE = 0x1f00, OC\_PGETLINE = 0x2000, OC\_REGEXP = 0x2100, OC\_REPLACE = 0x2200, OC\_RETURN = 0x2300, OC\_SPRINTF = 0x2400, OC\_TERNARY = 0x2500, OC\_UNARY = 0x2600, OC\_VAR = 0x2700,- OC\_DONE = 0x2800,+ OC\_CONST = 0x2800, OC\_DONE = 0x2900,  ST\_IF = 0x3000, ST\_DO = 0x3100, ST\_FOR = 0x3200, ST\_WHILE = 0x3300@@ -440,9 +442,9 @@ static const uint32\_t tokeninfo[] ALIGN4 = { #define TI\_PREINC (OC\_UNARY|xV|P(9)|'P') #define TI\_PREDEC (OC\_UNARY|xV|P(9)|'M') TI\_PREINC, TI\_PREDEC, OC\_FIELD|xV|P(5),- OC\_COMPARE|VV|P(39)|5, OC\_MOVE|VV|P(74), OC\_REPLACE|NV|P(74)|'+', OC\_REPLACE|NV|P(74)|'-',- OC\_REPLACE|NV|P(74)|'\*', OC\_REPLACE|NV|P(74)|'/', OC\_REPLACE|NV|P(74)|'%', OC\_REPLACE|NV|P(74)|'&',- OC\_BINARY|NV|P(29)|'+', OC\_BINARY|NV|P(29)|'-', OC\_REPLACE|NV|P(74)|'&', OC\_BINARY|NV|P(15)|'&',+ OC\_COMPARE|VV|P(39)|5, OC\_MOVE|VV|P(38), OC\_REPLACE|NV|P(38)|'+', OC\_REPLACE|NV|P(38)|'-',+ OC\_REPLACE|NV|P(38)|'\*', OC\_REPLACE|NV|P(38)|'/', OC\_REPLACE|NV|P(38)|'%', OC\_REPLACE|NV|P(38)|'&',+ OC\_BINARY|NV|P(29)|'+', OC\_BINARY|NV|P(29)|'-', OC\_REPLACE|NV|P(38)|'&', OC\_BINARY|NV|P(15)|'&', OC\_BINARY|NV|P(25)|'/', OC\_BINARY|NV|P(25)|'%', OC\_BINARY|NV|P(15)|'&', OC\_BINARY|NV|P(25)|'\*', OC\_COMPARE|VV|P(39)|4, OC\_COMPARE|VV|P(39)|3, OC\_COMPARE|VV|P(39)|0, OC\_COMPARE|VV|P(39)|1, #define TI\_LESS (OC\_COMPARE|VV|P(39)|2)@@ -1301,7 +1303,7 @@ static uint32\_t next\_token(uint32\_t expected) save\_tclass = tc; save\_info = t\_info; tc = TC\_BINOPX;- t\_info = OC\_CONCAT | SS | P(35);+ t\_info = OC\_CONCAT | SS | PRECEDENCE(35); }  t\_tclass = tc;@@ -1361,9 +1363,8 @@ static node \*parse\_expr(uint32\_t term\_tc) { node sn; node \*cn = &sn;- node \*vn, \*glptr;+ node \*glptr; uint32\_t tc, expected\_tc;- var \*v;  debug\_printf\_parse("%s() term\_tc(%x):", \_\_func\_\_, term\_tc); debug\_parse\_print\_tc(term\_tc);@@ -1374,11 +1375,12 @@ static node \*parse\_expr(uint32\_t term\_tc) expected\_tc = TS\_OPERAND | TS\_UOPPRE | TC\_REGEXP | term\_tc;  while (!((tc = next\_token(expected\_tc)) & term\_tc)) {+ node \*vn;  if (glptr && (t\_info == TI\_LESS)) { /\* input redirection (<) attached to glptr node \*/ debug\_printf\_parse("%s: input redir\n", \_\_func\_\_);- cn = glptr->l.n = new\_node(OC\_CONCAT | SS | P(37));+ cn = glptr->l.n = new\_node(OC\_CONCAT | SS | PRECEDENCE(37)); cn->a.n = glptr; expected\_tc = TS\_OPERAND | TS\_UOPPRE; glptr = NULL;@@ -1390,24 +1392,42 @@ static node \*parse\_expr(uint32\_t term\_tc) \* previous operators with higher priority \*/ vn = cn; while (((t\_info & PRIMASK) > (vn->a.n->info & PRIMASK2))- || ((t\_info == vn->info) && t\_info == TI\_COLON)+ || (t\_info == vn->info && t\_info == TI\_COLON) ) { vn = vn->a.n; if (!vn->a.n) syntax\_error(EMSG\_UNEXP\_TOKEN); } if (t\_info == TI\_TERNARY) //TODO: why?- t\_info += P(6);+ t\_info += PRECEDENCE(6); cn = vn->a.n->r.n = new\_node(t\_info); cn->a.n = vn->a.n; if (tc & TS\_BINOP) { cn->l.n = vn;-//FIXME: this is the place to detect and reject assignments to non-lvalues.-//Currently we allow "assignments" to consts and temporaries, nonsense like this:-// awk 'BEGIN { "qwe" = 1 }'-// awk 'BEGIN { 7 \*= 7 }'-// awk 'BEGIN { length("qwe") = 1 }'-// awk 'BEGIN { (1+1) += 3 }'++ /\* Prevent:+ \* awk 'BEGIN { "qwe" = 1 }'+ \* awk 'BEGIN { 7 \*= 7 }'+ \* awk 'BEGIN { length("qwe") = 1 }'+ \* awk 'BEGIN { (1+1) += 3 }'+ \*/+ /\* Assignment? (including \*= and friends) \*/+ if (((t\_info & OPCLSMASK) == OC\_MOVE)+ || ((t\_info & OPCLSMASK) == OC\_REPLACE)+ ) {+ debug\_printf\_parse("%s: MOVE/REPLACE vn->info:%08x\n", \_\_func\_\_, vn->info);+ /\* Left side is a (variable or array element)+ \* or function argument+ \* or $FIELD ?+ \*/+ if ((vn->info & OPCLSMASK) != OC\_VAR+ && (vn->info & OPCLSMASK) != OC\_FNARG+ && (vn->info & OPCLSMASK) != OC\_FIELD+ ) {+ syntax\_error(EMSG\_UNEXP\_TOKEN); /\* no. bad \*/+ }+ }+ expected\_tc = TS\_OPERAND | TS\_UOPPRE | TC\_REGEXP; if (t\_info == TI\_PGETLINE) { /\* it's a pipe \*/@@ -1443,6 +1463,8 @@ static node \*parse\_expr(uint32\_t term\_tc) /\* one should be very careful with switch on tclass - \* only simple tclasses should be used (TC\_xyz, not TS\_xyz) \*/ switch (tc) {+ var \*v;+ case TC\_VARIABLE: case TC\_ARRAY: debug\_printf\_parse("%s: TC\_VARIABLE | TC\_ARRAY\n", \_\_func\_\_);@@ -1463,14 +1485,14 @@ static node \*parse\_expr(uint32\_t term\_tc) case TC\_NUMBER: case TC\_STRING: debug\_printf\_parse("%s: TC\_NUMBER | TC\_STRING\n", \_\_func\_\_);- cn->info = OC\_VAR;+ cn->info = OC\_CONST; v = cn->l.v = xzalloc(sizeof(var));- if (tc & TC\_NUMBER)+ if (tc & TC\_NUMBER) { setvar\_i(v, t\_double);- else {+ } else { setvar\_s(v, t\_string);- expected\_tc &= ~TC\_UOPPOST; /\* "str"++ is not allowed \*/ }+ expected\_tc &= ~TC\_UOPPOST; /\* NUM++, "str"++ not allowed \*/ break;  case TC\_REGEXP:@@ -3124,6 +3146,8 @@ static var \*evaluate(node \*op, var \*res)  /\* -- recursive node type -- \*/ + case XC( OC\_CONST ):+ debug\_printf\_eval("CONST "); case XC( OC\_VAR ): debug\_printf\_eval("VAR\n"); L.v = op->l.v; |
| --- |

generated by [cgit v1.2.3](https://git.zx2c4.com/cgit/about/) ([git 2.25.1](https://git-scm.com/)) at 2025-01-15 13:02:01 +0000


