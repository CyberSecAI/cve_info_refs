=== Content from www.mozilla.org_7e9e9b8c_20250115_083840.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-09

## Security Vulnerabilities fixed in Firefox 111

Announced
March 14, 2023
Impact
high
Products
Firefox
Fixed in

* Firefox 111

#### [#CVE-2023-28159: Fullscreen Notification could have been hidden by download popups on Android](#CVE-2023-28159)

Reporter
Axel Chong (@Haxatron)
Impact
high
##### Description

The fullscreen notification could have been hidden on Firefox for Android by using download popups, resulting in potential user confusion or spoofing attacks.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1783561](https://bugzilla.mozilla.org/show_bug.cgi?id=1783561)

#### [#CVE-2023-25748: Fullscreen Notification could have been hidden by window prompts on Android](#CVE-2023-25748)

Reporter
Hafiizh
Impact
high
##### Description

By displaying a prompt with a long description, the fullscreen notification could have been hidden, resulting in potential user confusion or spoofing attacks.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1798798](https://bugzilla.mozilla.org/show_bug.cgi?id=1798798)

#### [#CVE-2023-25749: Firefox for Android may have opened third-party apps without a prompt](#CVE-2023-25749)

Reporter
Kirtikumar Anandrao Ramchandani
Impact
high
##### Description

Android applications with unpatched vulnerabilities can be launched from a browser using Intents, exposing users to these vulnerabilities. Firefox will now confirm with users that they want to launch an external application before doing so.
*This bug only affects Firefox for Android. Other versions of Firefox are unaffected.*

##### References

* [Bug 1810705](https://bugzilla.mozilla.org/show_bug.cgi?id=1810705)

#### [#CVE-2023-25750: Potential ServiceWorker cache leak during private browsing mode](#CVE-2023-25750)

Reporter
Kagami Rosylight
Impact
high
##### Description

Under certain circumstances, a ServiceWorker's offline cache may have leaked to the file system when using private browsing mode.

##### References

* [Bug 1814733](https://bugzilla.mozilla.org/show_bug.cgi?id=1814733)

#### [#CVE-2023-25751: Incorrect code generation during JIT compilation](#CVE-2023-25751)

Reporter
Lukas Bernhard
Impact
high
##### Description

Sometimes, when invalidating JIT code while following an iterator, the newly generated code could be overwritten incorrectly. This could lead to a potentially exploitable crash.

##### References

* [Bug 1814899](https://bugzilla.mozilla.org/show_bug.cgi?id=1814899)

#### [#CVE-2023-28160: Redirect to Web Extension files may have leaked local path](#CVE-2023-28160)

Reporter
Rob Wu
Impact
moderate
##### Description

When following a redirect to a publicly accessible web extension file, the URL may have been translated to the actual local path, leaking potentially sensitive information.

##### References

* [Bug 1802385](https://bugzilla.mozilla.org/show_bug.cgi?id=1802385)

#### [#CVE-2023-28164: URL being dragged from a removed cross-origin iframe into the same tab triggered navigation](#CVE-2023-28164)

Reporter
Luan Herrera
Impact
moderate
##### Description

Dragging a URL from a cross-origin iframe that was removed during the drag could have led to user confusion and website spoofing attacks.

##### References

* [Bug 1809122](https://bugzilla.mozilla.org/show_bug.cgi?id=1809122)

#### [#CVE-2023-28161: One-time permissions granted to a local file were extended to other local files loaded in the same tab](#CVE-2023-28161)

Reporter
Khiem Tran
Impact
moderate
##### Description

If temporary "one-time" permissions, such as the ability to use the Camera, were granted to a document loaded using a file: URL, that permission persisted in that tab for all other documents loaded from a file: URL. This is potentially dangerous if the local files came from different sources, such as in a download directory.

##### References

* [Bug 1811181](https://bugzilla.mozilla.org/show_bug.cgi?id=1811181)

#### [#CVE-2023-28162: Invalid downcast in Worklets](#CVE-2023-28162)

Reporter
Lukas Bernhard
Impact
moderate
##### Description

While implementing AudioWorklets, some code may have casted one type to another, invalid, dynamic type. This could have led to a potentially exploitable crash.

##### References

* [Bug 1811327](https://bugzilla.mozilla.org/show_bug.cgi?id=1811327)

#### [#CVE-2023-25752: Potential out-of-bounds when accessing throttled streams](#CVE-2023-25752)

Reporter
Ronald Crane
Impact
moderate
##### Description

When accessing throttled streams, the count of available bytes needed to be checked in the calling function to be within bounds. This may have lead future code to be incorrect and vulnerable.

##### References

* [Bug 1811627](https://bugzilla.mozilla.org/show_bug.cgi?id=1811627)

#### [#CVE-2023-28163: Windows Save As dialog resolved environment variables](#CVE-2023-28163)

Reporter
Shaheen Fazim
Impact
moderate
##### Description

When downloading files through the Save As dialog on Windows with suggested filenames containing environment variable names, Windows would have resolved those in the context of the current user.
*This bug only affects Firefox on Windows. Other versions of Firefox are unaffected.*

##### References

* [Bug 1817768](https://bugzilla.mozilla.org/show_bug.cgi?id=1817768)

#### [#CVE-2023-28176: Memory safety bugs fixed in Firefox 111 and Firefox ESR 102.9](#CVE-2023-28176)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers Timothy Nikkel, Andrew McCreight, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 110 and Firefox ESR 102.8. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 111 and Firefox ESR 102.9](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1808352%2C1811637%2C1815904%2C1817442%2C1818674)

#### [#CVE-2023-28177: Memory safety bugs fixed in Firefox 111](#CVE-2023-28177)

Reporter
Mozilla developers and community
Impact
high
##### Description

Mozilla developers and community members Calixte Denizet, Gabriele Svelto, Andrew McCreight, and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 110. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 111](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1803109%2C1808832%2C1809542%2C1817336)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_5ad3a477_20250115_083839.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1814733)
* [XML](/show_bug.cgi?ctype=xml&id=1814733)

Closed
[Bug 1814733](/show_bug.cgi?id=1814733)
(CVE-2023-25750)

Opened 2 years ago
Closed 2 years ago

# `caches.open("foo")` doesn't throw on partitioned third-party iframe on PBM

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

`caches.open("foo")` doesn't throw on partitioned third-party iframe on PBM

## Categories

### (Core :: Privacy: Anti-Tracking, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Privacy%3A%20Anti-Tracking#Privacy%3A%20Anti-Tracking)

Privacy: Anti-Tracking
▾

Core :: Privacy: Anti-Tracking
Tracking detection and content-blocking; part of the Enhanced Tracking Protection functionality
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Privacy%3A%20Anti-Tracking&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Privacy%3A%20Anti-Tracking&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Privacy%3A%20Anti-Tracking)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

112 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| Webcompat Priority | --- |
| a11y-review | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox109 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=wontfix) |
| firefox110 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=wontfix) |
| firefox111 | [+](/buglist.cgi?f1=cf_tracking_firefox111&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=verified) |
| firefox112 | [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox109 |  | wontfix |
| firefox110 |  | wontfix |
| firefox111 | + | verified |
| firefox112 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: saschanaz, Assigned: emz)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/46f58cc04758e80835820f0f1d5646bb?d=mm&size=40)  [emz](/user_profile?user_id=636491)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/bfbb1b40a40aa4b5b3e877686791ccc6?d=mm&size=40)  [saschanaz](/user_profile?user_id=473060)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/9c043b04a6702f66940ab8ea398e08a3?d=mm&size=40)  [timhuang](/user_profile?user_id=547199)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

14 people

## References

### (Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1815042](/show_bug.cgi?id=1815042 "RESOLVED DUPLICATE - Permanent private browsing mode leaks information to private storage from partitioning")

Dependency [tree](/showdependencytree.cgi?id=1814733&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1814733)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned")

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[1815042](/show_bug.cgi?id=1815042 "RESOLVED DUPLICATE - Permanent private browsing mode leaks information to private storage from partitioning"), [1817596](/show_bug.cgi?id=1817596 "RESOLVED DUPLICATE - Firefox >DOES< save cookies in private mode"), [1819858](/show_bug.cgi?id=1819858 "RESOLVED DUPLICATE - Always private mode stores website data and writes to disk")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1868448](/show_bug.cgi?id=1868448 "NEW - Private browsing site data displayed in regular manage site data dialog")

## Details

### (Keywords: csectype-disclosure, regression, sec-high, Whiteboard: [adv-main111+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-25750

[Keywords:](/describekeywords.cgi)

[csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main111+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Bug 1814733 r=timhuang!,#dom-storage-reviewers!](/attachment.cgi?id=9316161)  [2 years ago](#c13)  [Emma Zühlcke [:emz]](/user_profile?user_id=636491)   48 bytes, text/x-phabricator-request | dmeehan : [approval-mozilla-beta+](#c38 "2 years ago")  tjr : [sec-approval+](#c29 "2 years ago") | [Details](/attachment.cgi?id=9316161&action=edit) | [Review](/attachment.cgi?id=9316161) |
| --- | --- | --- |
| [poc.html](/attachment.cgi?id=9316714)  [2 years ago](#c17)  [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)   410 bytes, text/plain |  | [Details](/attachment.cgi?id=9316714&action=edit) |
| [advisory.txt](/attachment.cgi?id=9322638)  [2 years ago](#c43)  [Frederik Braun [:freddy]](/user_profile?user_id=428608)   213 bytes, text/plain |  | [Details](/attachment.cgi?id=9322638&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1814733#c0)• 2 years ago |
|  | |

Steps:

0. Turn off `dom.caches.hide_in_pbmode.enabled` (when bisecting)
1. Open Private Browsing Mode
2. Access <https://faz.net>
3. Allow cookie access if prompted
4. Scroll down and play an embedded YT video

Expected: No entry should appear with `^privateBrowsing=1` in `/storage/default` in the profile directory.

Actual: It does.

Mozregression shows <https://hg.mozilla.org/integration/autoland/pushloghtml?fromchange=a7402247dc7e4b5c0a4a173aa08545075a03f481&tochange=cd3007f4be5d49ea21cadf77ef79f8d0aa798b3d>, and from there [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned") looks most relevant.

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1814733#c1)• 2 years ago |
|  | |

Hi :twisniewski, can you take a look? Thanks!

Flags: needinfo?(twisniewski)

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1814733#c2)• 2 years ago |
|  | |

```
  StorageAccess access = mGlobal->GetStorageAccess();
  return access > StorageAccess::ePrivateBrowsing ||
         (StaticPrefs::
              privacy_partition_always_partition_third_party_non_cookie_storage() &&
          ShouldPartitionStorage(access));

```

This still allows storage access in PBM, and I don't think we should do it - yet.

|  | [Thomas Wisniewski [:twisniewski]](/user_profile?user_id=583576) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1814733#c3)• 2 years ago |
|  | |

:pbz, what do you think?

Flags: needinfo?(twisniewski) → needinfo?(pbz)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1814733#c4)• 2 years ago |
|  | |

If I understand this correctly the change from [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned") was meant to allow partitioned cache storage only if always partioning is enabled, but had the unintended side effect of also allowing it for PBM?

I'm curious why we didn't allow partitioned storage here in the first place, even before [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned"). Was this because of concerns with unpartitioning the cache (e.g. via storage access api, etc)?

Looks like `mGlobal->GetStorageAccess()` should return `ePrivateBrowsing` in the PBM case and not `ePartitionForeignOrDeny`? In that case the bug isn't actually this check but somewhere else where we compute the storage access flag. What's the source of truth for determining whether this storage should be enabled in PBM?

Flags: needinfo?(twisniewski)Flags: needinfo?(pbz)Flags: needinfo?(bvandersloot)

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a65633_695136)• 2 years ago |

[status-firefox109](/buglist.cgi?f1=cf_status_firefox109&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=affected)
[status-firefox110](/buglist.cgi?f1=cf_status_firefox110&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=affected)
[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a73311_406194)• 2 years ago |

Group: core-security → dom-core-security

|  | [Benjamin VanderSloot [:bvandersloot]](/user_profile?user_id=692134) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1814733#c5)• 2 years ago |
|  | |

> If I understand this correctly the change from [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned") was meant to allow partitioned cache storage only if always partioning is enabled, but had the unintended side effect of also allowing it for PBM?
>
> More like it was meant to prevent access to unpartitioned cache storage if always partitioning is enabled, IIRC.

> Looks like mGlobal->GetStorageAccess() should return ePrivateBrowsing in the PBM case and not ePartitionForeignOrDeny?
>
> I think it is actually in the second half of the OR in what Kagami pointed out. That gives partitioning values a pass despite being < ePrivateBrowsing
>
> We need to reconsider the total ordering of that enum [1] and the implications. Like should partition\*OrDeny be < eDeny?

I think we can revert this diff to fix this regression: <https://searchfox.org/mozilla-central/diff/d1c82fe05fb6d461afea6d7d46754065cbd31723/dom/cache/CacheStorage.cpp#565>. This is what Kagami pointed to in [comment 2](/show_bug.cgi?id=1814733#c2 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM").

[1] <https://searchfox.org/mozilla-central/source/toolkit/components/antitracking/StorageAccess.h#28-30>

Flags: needinfo?(bvandersloot)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1814733#c6)• 2 years ago |
|  | |

(In reply to Benjamin VanderSloot from [comment #5](/show_bug.cgi?id=1814733#c5 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> > If I understand this correctly the change from [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned") was meant to allow partitioned cache storage only if always partioning is enabled, but had the unintended side effect of also allowing it for PBM?
> >
> > More like it was meant to prevent access to unpartitioned cache storage if always partitioning is enabled, IIRC.
>
> > Looks like mGlobal->GetStorageAccess() should return ePrivateBrowsing in the PBM case and not ePartitionForeignOrDeny?
> >
> > I think it is actually in the second half of the OR in what Kagami pointed out. That gives partitioning values a pass despite being < ePrivateBrowsing
> >
> > We need to reconsider the total ordering of that enum [1] and the implications. Like should partition\*OrDeny be < eDeny?
>
> I think we can revert this diff to fix this regression: <https://searchfox.org/mozilla-central/diff/d1c82fe05fb6d461afea6d7d46754065cbd31723/dom/cache/CacheStorage.cpp#565>. This is what Kagami pointed to in [comment 2](/show_bug.cgi?id=1814733#c2 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM").
>
> [1] <https://searchfox.org/mozilla-central/source/toolkit/components/antitracking/StorageAccess.h#28-30>

Yes that should fix the immediate regression, but wouldn't that also mean we don't support partitioned cache storage?

Flags: needinfo?(bvandersloot)

|  | [Benjamin VanderSloot [:bvandersloot]](/user_profile?user_id=692134) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1814733#c7)• 2 years ago |
|  | |

Ugh, right. I think part of the issue is that partitioning should really be orthogonal to the other values of the enum.

> Looks like mGlobal->GetStorageAccess() should return ePrivateBrowsing in the PBM case and not ePartitionForeignOrDeny?

I don't think so... Because then I think it will effectively disable storage partitioning in PBM because the result of mGlobal->GetStorageAccess() is passed into StoragePartitioningEnabled() (which looks for StorageAccess::ePartitionForeignOrDeny)to perform partitioning checks pretty often. Maybe I'm misremembering the semantic here though. Thoughts @pbz?

Flags: needinfo?(bvandersloot) → needinfo?(pbz)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1814733#c8)• 2 years ago |
|  | |

> Ugh, right. I think part of the issue is that partitioning should really be orthogonal to the other values of the enum.

Yes - the current state makes it really confusing. When debugging this with the STR above for some reason I get -1 for storage access, which also seems unexpected.

It's really hard to trace where this is coming from. The storage access value is retrieved form the global which in this case should be `WorkerGlobalScope` I believe: <https://searchfox.org/mozilla-central/rev/a7156afbfa575f12f60b1c8bf099d547c29bcadf/dom/workers/WorkerScope.cpp#287>

This value comes from WorkerPrivate `StorageAccess` which gets it from loadInfo here: <https://searchfox.org/mozilla-central/rev/a7156afbfa575f12f60b1c8bf099d547c29bcadf/dom/workers/WorkerPrivate.h#867>

loadInfo has the storage access field populated here: <https://searchfox.org/mozilla-central/rev/a7156afbfa575f12f60b1c8bf099d547c29bcadf/dom/workers/WorkerPrivate.cpp#2925>

Looking into that method I can see a fallback here that returns `ePrivateBrowsing`: <https://searchfox.org/mozilla-central/rev/a7156afbfa575f12f60b1c8bf099d547c29bcadf/toolkit/components/antitracking/StorageAccess.cpp#242>

However that fallback doesn't seem to be used here, so we go into the regular storage access check. Time to debug that....

|  | [Benjamin VanderSloot [:bvandersloot]](/user_profile?user_id=692134) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1814733#c9)• 2 years ago |
|  | |

> Looking into that method I can see a fallback here that returns `ePrivateBrowsing`: <https://searchfox.org/mozilla-central/rev/a7156afbfa575f12f60b1c8bf099d547c29bcadf/toolkit/components/antitracking/StorageAccess.cpp#242>

That is just in the event that the window doesn't have a document, which it should in our case.

Instead we get all the way to the internal check on the window where we note that it is private browsing (<https://searchfox.org/mozilla-central/source/toolkit/components/antitracking/StorageAccess.cpp#88>) but then only return that if !StorageDisabledByAntiTracking(...): <https://searchfox.org/mozilla-central/source/toolkit/components/antitracking/StorageAccess.cpp#129>... I think

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1814733#c10)• 2 years ago |
|  | |

The storage access value returned is `ePartitionTrackersOrDeny` for the YouTube embed.

I've tested checking for PBM in `CacheStorage::HasStorageAccess` explicitly and denying storage access like this:

```
  if(nsIPrincipal* principal = mGlobal->PrincipalOrNull()) {
    if(!principal->IsSystemPrincipal() && principal->GetPrivateBrowsingId() != nsIScriptSecurityManager::DEFAULT_PRIVATE_BROWSING_ID) {
       printf("Denying dom cache storage access in PBM\n");
    return false;
    }
  }

```

That seems to work. However I'm not sure if this is the proper way to do it. The storage access checks don't have a way to return a combination of "partition, but in PBM deny".

What seems odd to me is that I don't see any partition key in the dom cache files. Even in normal browsing dom cache from YouTube looks unpartitioned, even though it's a third-party. Perhaps I'm just missing where the partition key is stored? Do we just not support it yet?

Here are my open questions:

* Should DOM Cache be partitioned? If so I don't think that's working properly at the moment?
* Why does the storage access check currently return `ePartitionTrackersOrDeny` and not `ePartitionForeignOrDeny` or `ePrivateBrowsing`?
* Which component decides whether a storage is enabled in PBM? Should that be determined in `StorageAccess.cpp` or in the storage code itself (since it happens on a case-by-case basis)?

Tim, could you please help answer some of these questions when you're back? Much appreciated!

Flags: needinfo?(pbz) → needinfo?(tihuang)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1814733#c11)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #10](/show_bug.cgi?id=1814733#c10 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> * Which component decides whether a storage is enabled in PBM? Should that be determined in `StorageAccess.cpp` or in the storage code itself (since it happens on a case-by-case basis)?

I've proposed introducing an explicit StorageKey abstraction in [bug 1776271](/show_bug.cgi?id=1776271 "NEW - Introduce a StorageKey class corresponding to the PartitionedPrincipal wrapping the now-threadsafe nsIPrincipal") which I think would be a reasonable place to implement all policy-related decision-making. I'll write a little more on this in that bug now, as I think I've talked about this before but haven't captured that in the bug.

|  | [Tim Huang[:timhuang]](/user_profile?user_id=547199) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1814733#c12)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #10](/show_bug.cgi?id=1814733#c10 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> What seems odd to me is that I don't see any partition key in the dom cache files. Even in normal browsing dom cache from YouTube looks unpartitioned, even though it's a third-party. Perhaps I'm just missing where the partition key is stored? Do we just not support it yet?
>
> Here are my open questions:
>
> * Should DOM Cache be partitioned? If so I don't think that's working properly at the moment?

The DOM Cache should be partitioned in third-party contexts, see [[1]](https://privacycg.github.io/storage-partitioning/). And we only do this if Always Partitioning Storage is enabled; DOM Cache is disabled in a third-party context if APS is disabled. Also, we have a [test](https://searchfox.org/mozilla-central/rev/ddbeacddc15008936e8f619c8c3a05fac6eab8d8/toolkit/components/antitracking/test/browser/browser_partitionedDOMCache.js) to ensure this when APS is enabled.

> * Why does the storage access check currently return `ePartitionTrackersOrDeny` and not `ePartitionForeignOrDeny` or `ePrivateBrowsing`?

It's because `youtube.com` is considered a content tracker if the level 2 list is enabled.

> * Which component decides whether a storage is enabled in PBM? Should that be determined in `StorageAccess.cpp` or in the storage code itself (since it happens on a case-by-case basis)?

It should be decided by the storage module itself by the current design. The `StorageAccess.cpp` provides a hint for the storage module to know which access type should be used, and the storage modules can decide their behavior according to the storage access.

[1] <https://privacycg.github.io/storage-partitioning/>

Flags: needinfo?(tihuang)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a312246_636491)• 2 years ago |

Assignee: nobody → pbzSeverity: -- → S2Status: NEW → ASSIGNEDPriority: -- → P1

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1814733#c13)• 2 years ago |
|  | |

Attached file
[Bug 1814733 r=timhuang!,#dom-storage-reviewers!](attachment.cgi?id=9316161)
— [Details](attachment.cgi?id=9316161&action=edit)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a336839_151407)• 2 years ago |

Blocks: [1815042](/show_bug.cgi?id=1815042 "RESOLVED DUPLICATE - Permanent private browsing mode leaks information to private storage from partitioning")

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a416621_636491)• 2 years ago |

Flags: needinfo?(twisniewski)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a419389_636491)• 2 years ago |

Duplicate of this bug: [1815042](/show_bug.cgi?id=1815042 "RESOLVED DUPLICATE - Permanent private browsing mode leaks information to private storage from partitioning")

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1814733#c15)• 2 years ago |
|  | |

Looks like we can land this in Fx112 and uplift to Fx111. Moving faster than that seems risky.

Here is what we need before we can land the patch:

* sec-rating pending (I don't think that's still happening in this cycle?)
* Clarify the remaining review questions, Andrew could you please help with that? See <https://phabricator.services.mozilla.com/D168976#inline-932882>
* Consider if we need to do any cleanup. Does the cache storage persist or does it expire at some point automatically? If not we probably need some migration code that clears `^privateBrowsingId=1` entries from disks.

NI to Andrew for the latter 2 questions. Thank you!

Flags: needinfo?(bugmail)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1814733#c16)• 2 years ago |
|  | |

What are the web-detectable impacts of this? Clearly it's writing things to disk in private mode which is a big failure for that, but more as a privacy matter than a "security" one: might call that `sec-moderate`. But if this leads to past private visits being web-detectable in non-private sessions or in future private sessions we should call this `sec-high`

Flags: needinfo?(pbz)

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1814733#c17)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1814733&comment_id=16273460 "4 revisions") |
|  | |

Attached file
[poc.html](attachment.cgi?id=9316714)
— [Details](attachment.cgi?id=9316714&action=edit)

I fear it's sec-high in that case.

1. Download the attachment as `index.html`.
2. Run it locally, e.g. by `python -m http.server`
3. Open `http://localhost:8000/index.html` in PBM and see the console log. You'll see one error and one array, which should be empty initially.
4. Refresh and see the array became `["visited"]`.
5. Close the window and open the page again in PBM
6. See what the log says, it shows `["visited"]`.

Edit: Oh, in PBM I mean. Modified the steps.

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a572883_636491)• 2 years ago |

Flags: needinfo?(pbz)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1814733#c18)• 2 years ago |
|  | |

Set release status flags based on info from the regressing [bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned")

[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected)Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1814733#c19)• 2 years ago |
|  | |

(In reply to Kagami [:saschanaz] from [comment #17](/show_bug.cgi?id=1814733#c17 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> Created [attachment 9316714](/attachment.cgi?id=9316714 "poc.html") [[details]](/attachment.cgi?id=9316714&action=edit "poc.html")
>
> poc.html
>
> I fear it's sec-high in that case.
>
> 1. Download the attachment
> 2. Run it locally, e.g. by `python -m http.server`
> 3. Open `http://localhost:8000/` in PBM and see the console log. You'll see one error and one array, which should be empty initially.
> 4. Refresh and see the array became `["visited"]`.
> 5. Close the window and open the page again in PBM
> 6. See what the log says, it shows `["visited"]`.
>
> Edit: Oh, in PBM I mean. Modified the steps.

I can't reproduce your poc, I get `Uncaught DOMException: The operation is insecure. index.html:11` in PBM. Both with localhost:8080 and another test origin origin1.com:8080. Am I doing something wrong?

Flags: needinfo?(krosylight)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1814733#c20)• 2 years ago |
|  | |

Clearing NI for :asuth, we discussed this on Slack. The attached patch is r+. However we need to update the QuotaManager init to clean up anything that has a privateBrowsingId set. I'll add another patch for that.

Flags: needinfo?(bugmail)

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1814733#c21)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #19](/show_bug.cgi?id=1814733#c19 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> I can't reproduce your poc, I get `Uncaught DOMException: The operation is insecure. index.html:11` in PBM. Both with localhost:8080 and another test origin origin1.com:8080. Am I doing something wrong?

It's possible this could be related to [bug 1817893](/show_bug.cgi?id=1817893 "NEW - Remove CacheStorage.cpp's IsTrusted helper and make CachesEnabled check honor devtools ServiceWorkersTestingEnabled browsing context flag") about the Caches API continuing to have its own redundant SecureContext logic which I filed while digging into the existing control flow paths as part of this bug.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a1737535_406194)• 2 years ago |

Keywords: [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1814733#c22)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #19](/show_bug.cgi?id=1814733#c19 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> I can't reproduce your poc, I get `Uncaught DOMException: The operation is insecure. index.html:11` in PBM. Both with localhost:8080 and another test origin origin1.com:8080. Am I doing something wrong?

You mean you see two errors?

BTW, I edited step 1 as it assumes index.html in `localhost` and `127.0.0.1`.

Flags: needinfo?(krosylight)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1814733#c23)• 2 years ago |
|  | |

(In reply to Kagami [:saschanaz] from [comment #22](/show_bug.cgi?id=1814733#c22 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> (In reply to Paul Zühlcke [:pbz] from [comment #19](/show_bug.cgi?id=1814733#c19 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))
>
> > I can't reproduce your poc, I get `Uncaught DOMException: The operation is insecure. index.html:11` in PBM. Both with localhost:8080 and another test origin origin1.com:8080. Am I doing something wrong?
>
> You mean you see two errors?
>
> BTW, I edited step 1 as it assumes index.html in `localhost` and `127.0.0.1`.

Yes, two errors. I tested all kinds of domain combinations, some trusted like localhost and some untrusted like origin1.com

Do I need to set a pref for this to work, or do I need to serve the test page via HTTPS?

Flags: needinfo?(krosylight)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1814733#c24)• 2 years ago |
|  | |

Update on the patch: I'm currently discussing with :asuth via DM whether we want to land the fix and the cleanup separately. And how we need to do the cleanup.

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1814733#c25)• 2 years ago |
|  | |

I discussed this with :asuth as well. I think it's ok to land the existing fix first (without the cleanup for now). There's also patch <https://phabricator.services.mozilla.com/D86562> which introduces clearing of all origin directories on disk which contain the privateBrowsindId attribute. That should be enough for now. I would wait with the cleanup patch because there's also <https://phabricator.services.mozilla.com/D161618> in the works which will map private browsing origins to UUIDs. It would be better to finish the cleanup patch after that.

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1814733#c26)• 2 years ago |
|  | |

Comment on [attachment 9316161](/attachment.cgi?id=9316161 "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") [[details]](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!")

[Bug 1814733](/show_bug.cgi?id=1814733 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM") r=timhuang!,#dom-storage-reviewers!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: From looking a the patch it's relatively easy to see that we allowed storage access for CacheStorage in PBM before. The fact that this storage persists across private browsing sessions however is not obvious.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: Yes
* **Which older supported branches are affected by this flaw?**: release, beta
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1758745](/show_bug.cgi?id=1758745 "RESOLVED FIXED - Refactor EffectiveStoragePrincipal to EffectiveCookiePrincipal and create new function EffectiveStoragePrincipal that is never unpartitioned")
* **Do you have backports for the affected branches?**: No
* **If not, how different, hard to create, and risky will they be?**: Should be a simple uplift, I don't expect merge conflicts with Fx111 and Fx110.x (given we could still uplift this late)
* **How likely is this patch to cause regressions; how much testing does it need?**: Rather unlikely since the change is quite small, has automated test coverage and can be manually verified.
* **Is Android affected?**: Yes
[Attachment #9316161](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") -
Flags: sec-approval?

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1814733#c27)• 2 years ago |
|  | |

Thanks Jan! I agree so I created a sec-approval request for the attached patch (without the cleanup/migration code).

|  | [Kagami Rosylight [:saschanaz] (they/them)](/user_profile?user_id=473060)  Reporter |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1814733#c28)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #23](/show_bug.cgi?id=1814733#c23 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> Yes, two errors. I tested all kinds of domain combinations, some trusted like localhost and some untrusted like origin1.com
>
> Do I need to set a pref for this to work, or do I need to serve the test page via HTTPS?

No, I just run `python -m http.server` and open localhost:3000 on a clean profile and then I can reproduce it. How are you running it?

Flags: needinfo?(krosylight) → needinfo?(pbz)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1814733#c29)• 2 years ago |
|  | |

Comment on [attachment 9316161](/attachment.cgi?id=9316161 "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") [[details]](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!")

[Bug 1814733](/show_bug.cgi?id=1814733 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM") r=timhuang!,#dom-storage-reviewers!

Approved to request uplift and land.

[Attachment #9316161](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1814733#c30)• 2 years ago |
|  | |

To be clear, I think it's okay to land the test alongside the patch this time.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a1920170_75935)• 2 years ago |

[status-firefox109](/buglist.cgi?f1=cf_status_firefox109&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=wontfix)
[status-firefox110](/buglist.cgi?f1=cf_status_firefox110&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox110&o1=equals&v1=wontfix)
[tracking-firefox111](/buglist.cgi?f1=cf_tracking_firefox111&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox111&o1=equals&v1=%2B)
[tracking-firefox112](/buglist.cgi?f1=cf_tracking_firefox112&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox112&o1=equals&v1=%2B)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a2129367_600971)• 2 years ago |

[Attachment #9316161](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") -
Attachment description: Bug 1814733 - Deny dom cache storage access for private browsing. r=timhuang!,#dom-storage-reviewers! → Bug 1814733 r=timhuang!,#dom-storage-reviewers!

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1814733#c31)• 2 years ago |
|  | |

r=timhuang,dom-storage-reviewers,asuth

<https://hg.mozilla.org/integration/autoland/rev/b8a8b74dbdd01cade5a6aa258ce75f922969b639>

<https://hg.mozilla.org/mozilla-central/rev/b8a8b74dbdd0>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years agoResolution: --- → FIXEDTarget Milestone: --- → 112 Branch

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1814733#c32)• 2 years ago |
|  | |

(In reply to Jan Varga [:janv] from [comment #25](/show_bug.cgi?id=1814733#c25 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> I discussed this with :asuth as well. I think it's ok to land the existing fix first (without the cleanup for now). There's also patch <https://phabricator.services.mozilla.com/D86562> which introduces clearing of all origin directories on disk which contain the privateBrowsindId attribute. That should be enough for now. I would wait with the cleanup patch because there's also <https://phabricator.services.mozilla.com/D161618> in the works which will map private browsing origins to UUIDs. It would be better to finish the cleanup patch after that.

To clarify, are the patches you linked sufficient to clean up this leak or will we need another patch to do that?

Flags: needinfo?(pbz) → needinfo?(jvarga)

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1814733#c33)• 2 years ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #32](/show_bug.cgi?id=1814733#c32 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))

> (In reply to Jan Varga [:janv] from [comment #25](/show_bug.cgi?id=1814733#c25 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM"))
>
> > I discussed this with :asuth as well. I think it's ok to land the existing fix first (without the cleanup for now). There's also patch <https://phabricator.services.mozilla.com/D86562> which introduces clearing of all origin directories on disk which contain the privateBrowsindId attribute. That should be enough for now. I would wait with the cleanup patch because there's also <https://phabricator.services.mozilla.com/D161618> in the works which will map private browsing origins to UUIDs. It would be better to finish the cleanup patch after that.
>
> To clarify, are the patches you linked sufficient to clean up this leak or will we need another patch to do that?

<https://phabricator.services.mozilla.com/D86562> is about to land. It introduces clearing of all origin directories with privateBrowsingId=1 after a private browsing session is finished. So there's only one theoretical case when the cleanup wouldn't be done, when the user never starts a private browsing session again. I think this should be ok for now, but we will find a way how to cleanup stuff which doesn't depend on finishing a private browsing session once we complete <https://phabricator.services.mozilla.com/D161618> because we don't know yet how exactly origin directories will look like for private browsing after those changes.

Flags: needinfo?(jvarga)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1814733#c34)• 2 years ago |
|  | |

Agreed, that seems sufficient for now. Thanks!

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1814733#c35)• 2 years ago |
|  | |

I'm a bit confused about the state of this bug - it's RESOLVED FIXED in 112 but both 112 and 111 are still marked as affected. Should 112 be marked fixed, and should there be an uplift request for 111 here?

Flags: needinfo?(pbz)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1814733#c36)• 2 years ago |
|  | |

112 should be fixed. I'll create an uplift request now, just wanted this to land on central first.

[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed)Flags: needinfo?(pbz)

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1814733#c37)• 2 years ago |
|  | |

Comment on [attachment 9316161](/attachment.cgi?id=9316161 "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") [[details]](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!")

[Bug 1814733](/show_bug.cgi?id=1814733 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM") r=timhuang!,#dom-storage-reviewers!

### Beta/Release Uplift Approval Request

* **User impact if declined**: Private Browsing Mode leakage (also across PBM sessions); sec-high
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: Yes
* **If yes, steps to reproduce**: See [comment 0](/show_bug.cgi?id=1814733#c0 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM")
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Smaller code change which effectively restores original behavior of blocking storage access in PBM. Has automated test coverage.
* **String changes made/needed**:
* **Is Android affected?**: Yes
[Attachment #9316161](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") -
Flags: approval-mozilla-beta?

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a2224230_636491)• 2 years ago |

Flags: qe-verify+

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1814733#c38)• 2 years ago |
|  | |

Comment on [attachment 9316161](/attachment.cgi?id=9316161 "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") [[details]](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!")

[Bug 1814733](/show_bug.cgi?id=1814733 "VERIFIED FIXED - `caches.open(\"foo\")` doesn't throw on partitioned third-party iframe on PBM") r=timhuang!,#dom-storage-reviewers!

Approved for 111.0b7

[Attachment #9316161](/attachment.cgi?id=9316161&action=edit "Bug 1814733 r=timhuang!,#dom-storage-reviewers!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1814733#c39)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/4143af401e11>

[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=fixed)

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a2285498_553429)• 2 years ago |

QA Whiteboard: [qa-triaged]

|  | [Hani Yacoub, Desktop QA](/user_profile?user_id=583007) |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1814733#c40)• 2 years ago |
|  | |

Verified as fixed on macOS 11.6, Windows 10 x64 and on Ubuntu 20.04 x64 on both Firefox Nightly112.0a1 (2023-03-01) and Firefox 111.0b7.

Status: RESOLVED → VERIFIEDQA Whiteboard: [qa-triaged]
[status-firefox111](/buglist.cgi?f1=cf_status_firefox111&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox111&o1=equals&v1=verified)
[status-firefox112](/buglist.cgi?f1=cf_status_firefox112&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox112&o1=equals&v1=verified)Flags: qe-verify+

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a2492058_636491)• 2 years ago |

Duplicate of this bug: [1817596](/show_bug.cgi?id=1817596 "RESOLVED DUPLICATE - Firefox >DOES< save cookies in private mode")

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a2840911_636491)• 2 years ago |

Duplicate of this bug: [1819858](/show_bug.cgi?id=1819858 "RESOLVED DUPLICATE - Always private mode stores website data and writes to disk")

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a3091773_578488)• 2 years ago |

Whiteboard: [adv-main111+]

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=1814733#c43)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9322638)
— [Details](attachment.cgi?id=9322638&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a3359269_578488)• 2 years ago |

Alias: CVE-2023-25750

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a22231147_1689)• 1 year ago |

Group: core-security-release

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1814733#a26436846_636491)• 1 year ago |

See Also: → [1868448](/show_bug.cgi?id=1868448 "NEW - Private browsing site data displayed in regular manage site data dialog")
You need to [log in](/show_bug.cgi?id=1814733&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Emma Zühlcke [:emz]](/user_profile?user_id=636491)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


