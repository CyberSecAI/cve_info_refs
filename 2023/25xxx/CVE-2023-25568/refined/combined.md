=== Content from github.com_715ef571_20250115_092131.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F62cbac40b96f49e39cd7fedc77ee6b56adce4916)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F62cbac40b96f49e39cd7fedc77ee6b56adce4916)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ipfs%2Fboxo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ipfs](/ipfs)
/
**[boxo](/ipfs/boxo)**
Public

generated from [ipfs/ipfs-repository-template](/ipfs/ipfs-repository-template)

* [Notifications](/login?return_to=%2Fipfs%2Fboxo) You must be signed in to change notification settings
* [Fork
  108](/login?return_to=%2Fipfs%2Fboxo)
* [Star
   221](/login?return_to=%2Fipfs%2Fboxo)

* [Code](/ipfs/boxo)
* [Issues
  168](/ipfs/boxo/issues)
* [Pull requests
  23](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects
  0](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

Additional navigation options

* [Code](/ipfs/boxo)
* [Issues](/ipfs/boxo/issues)
* [Pull requests](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

## Commit

[Permalink](/ipfs/boxo/commit/62cbac40b96f49e39cd7fedc77ee6b56adce4916)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

bitswap/server/internal/decision: add filtering on CIDs

[Browse files](/ipfs/boxo/tree/62cbac40b96f49e39cd7fedc77ee6b56adce4916)
Browse the repository at this point in the history

```
- Ignore cids that are too big.
- Kill connection for peers that are using inline CIDs.
```

* Loading branch information

[![@Jorropo](https://avatars.githubusercontent.com/u/24391983?s=40&v=4)](/Jorropo)

[Jorropo](/ipfs/boxo/commits?author=Jorropo "View all commits by Jorropo")
committed
Feb 17, 2023

1 parent
[9cb5cb5](/ipfs/boxo/commit/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197)

commit 62cbac4

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**71 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* bitswap

  + internal/defaults

    - bitswap/internal/defaults/defaults.go
      [defaults.go](#diff-aa2da67fd9afab3469064874508db3b047a65f7496abc44fdf08705c2e392ee3)
  + network

    - bitswap/network/ipfs\_impl.go
      [ipfs\_impl.go](#diff-c9bd00c0010c344b44ae10414c6581ca733b7b6f3799eebdc461ca926575c342)
  + bitswap/options.go
    [options.go](#diff-518591031c81c0d6b4d7dfd212280f5267a5e0304695b59b5a971b96b2d22cbc)
  + server

    - internal/decision

      * bitswap/server/internal/decision/engine.go
        [engine.go](#diff-b387ad6bf1bb411dbd6773c5f8c3c10ed275043c0482013a0938b717b81395d1)
    - bitswap/server/server.go
      [server.go](#diff-d93b13f93791b21b76ed7d993b2d223ab1c395fdda0e88142ba637e958b1c328)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[bitswap/internal/defaults/defaults.go](#diff-aa2da67fd9afab3469064874508db3b047a65f7496abc44fdf08705c2e392ee3 "bitswap/internal/defaults/defaults.go")

Show comments

[View file](/ipfs/boxo/blob/62cbac40b96f49e39cd7fedc77ee6b56adce4916/bitswap/internal/defaults/defaults.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,7 @@ |
|  |  | package defaults |
|  |  |  |
|  |  | import ( |
|  |  | "encoding/binary" |
|  |  | "time" |
|  |  | ) |
|  |  |  |
| Expand All | | @@ -27,4 +28,9 @@ const ( |
|  |  |  |
|  |  | // Maximum size of the wantlist we are willing to keep in memory. |
|  |  | MaxQueuedWantlistEntiresPerPeer = 1024 |
|  |  |  |
|  |  | // Copied from github.com/ipfs/go-verifcid#maximumHashLength |
|  |  | // FIXME: expose this in go-verifcid. |
|  |  | MaximumHashLength = 128 |
|  |  | MaximumAllowedCid = binary.MaxVarintLen64\*4 + MaximumHashLength |
|  |  | ) |

2 changes: 1 addition & 1 deletion

2
[bitswap/network/ipfs\_impl.go](#diff-c9bd00c0010c344b44ae10414c6581ca733b7b6f3799eebdc461ca926575c342 "bitswap/network/ipfs_impl.go")

Show comments

[View file](/ipfs/boxo/blob/62cbac40b96f49e39cd7fedc77ee6b56adce4916/bitswap/network/ipfs_impl.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -370,7 +370,7 @@ func (bsnet \*impl) ConnectTo(ctx context.Context, p peer.ID) error { |
|  |  | } |
|  |  |  |
|  |  | func (bsnet \*impl) DisconnectFrom(ctx context.Context, p peer.ID) error { |
|  |  | panic("Not implemented: DisconnectFrom() is only used by tests") |
|  |  | return bsnet.host.Network().ClosePeer(p) |
|  |  | } |
|  |  |  |
|  |  | // FindProvidersAsync returns a channel of providers for the given key. |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[bitswap/options.go](#diff-518591031c81c0d6b4d7dfd212280f5267a5e0304695b59b5a971b96b2d22cbc "bitswap/options.go")

Show comments

[View file](/ipfs/boxo/blob/62cbac40b96f49e39cd7fedc77ee6b56adce4916/bitswap/options.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -33,6 +33,12 @@ func MaxQueuedWantlistEntriesPerPeer(count uint) Option { |
|  |  | return Option{server.MaxQueuedWantlistEntriesPerPeer(count)} |
|  |  | } |
|  |  |  |
|  |  | // MaxCidSize only affects the server. |
|  |  | // If it is 0 no limit is applied. |
|  |  | func MaxCidSize(n uint) Option { |
|  |  | return Option{server.MaxCidSize(n)} |
|  |  | } |
|  |  |  |
|  |  | func TaskWorkerCount(count int) Option { |
|  |  | return Option{server.TaskWorkerCount(count)} |
|  |  | } |
| Expand Down | |  |

45 changes: 43 additions & 2 deletions

45
[bitswap/server/internal/decision/engine.go](#diff-b387ad6bf1bb411dbd6773c5f8c3c10ed275043c0482013a0938b717b81395d1 "bitswap/server/internal/decision/engine.go")

Show comments

[View file](/ipfs/boxo/blob/62cbac40b96f49e39cd7fedc77ee6b56adce4916/bitswap/server/internal/decision/engine.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -25,6 +25,7 @@ import ( |
|  |  | "github.com/ipfs/go-peertaskqueue/peertracker" |
|  |  | process "github.com/jbenet/goprocess" |
|  |  | "github.com/libp2p/go-libp2p/core/peer" |
|  |  | mh "github.com/multiformats/go-multihash" |
|  |  | ) |
|  |  |  |
|  |  | // TODO consider taking responsibility for other types of requests. For |
| Expand Down  Expand Up | | @@ -187,6 +188,7 @@ type Engine struct { |
|  |  | maxOutstandingBytesPerPeer int |
|  |  |  |
|  |  | maxQueuedWantlistEntriesPerPeer uint |
|  |  | maxCidSize uint |
|  |  | } |
|  |  |  |
|  |  | // TaskInfo represents the details of a request from a peer. |
| Expand Down  Expand Up | | @@ -272,13 +274,20 @@ func WithMaxOutstandingBytesPerPeer(count int) Option { |
|  |  |  |
|  |  | // WithMaxQueuedWantlistEntriesPerPeer limits how much individual entries each peer is allowed to send. |
|  |  | // If a peer send us more than this we will truncate newest entries. |
|  |  | // It defaults to DefaultMaxQueuedWantlistEntiresPerPeer. |
|  |  | func WithMaxQueuedWantlistEntriesPerPeer(count uint) Option { |
|  |  | return func(e \*Engine) { |
|  |  | e.maxQueuedWantlistEntriesPerPeer = count |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // WithMaxQueuedWantlistEntriesPerPeer limits how much individual entries each peer is allowed to send. |
|  |  | // If a peer send us more than this we will truncate newest entries. |
|  |  | func WithMaxCidSize(n uint) Option { |
|  |  | return func(e \*Engine) { |
|  |  | e.maxCidSize = n |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func WithSetSendDontHave(send bool) Option { |
|  |  | return func(e \*Engine) { |
|  |  | e.sendDontHaves = send |
| Expand Down  Expand Up | | @@ -357,6 +366,7 @@ func newEngine( |
|  |  | tagQueued: fmt.Sprintf(tagFormat, "queued", uuid.New().String()), |
|  |  | tagUseful: fmt.Sprintf(tagFormat, "useful", uuid.New().String()), |
|  |  | maxQueuedWantlistEntriesPerPeer: defaults.MaxQueuedWantlistEntiresPerPeer, |
|  |  | maxCidSize: defaults.MaximumAllowedCid, |
|  |  | } |
|  |  |  |
|  |  | for \_, opt := range opts { |
| Expand Down  Expand Up | | @@ -617,7 +627,7 @@ func (e \*Engine) Peers() []peer.ID { |
|  |  | // MessageReceived is called when a message is received from a remote peer. |
|  |  | // For each item in the wantlist, add a want-have or want-block entry to the |
|  |  | // request queue (this is later popped off by the workerTasks) |
|  |  | func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwapMessage) { |
|  |  | func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwapMessage) (mustKillConnection bool) { |
|  |  | entries := m.Wantlist() |
|  |  |  |
|  |  | if len(entries) > 0 { |
| Expand Down  Expand Up | | @@ -676,10 +686,40 @@ func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwap |
|  |  | wants = wants[:available] |
|  |  | } |
|  |  |  |
|  |  | filteredWants := wants[:0] // shift inplace |
|  |  |  |
|  |  | for \_, entry := range wants { |
|  |  | if entry.Cid.Prefix().MhType == mh.IDENTITY { |
|  |  | // This is a truely broken client, let's kill the connection. |
|  |  | e.lock.Unlock() |
|  |  | log.Warnw("peer wants an identity CID", "local", e.self, "remote", p) |
|  |  | return true |
|  |  | } |
|  |  | if e.maxCidSize != 0 && uint(entry.Cid.ByteLen()) > e.maxCidSize { |
|  |  | // Ignore requests about CIDs that big. |
|  |  | continue |
|  |  | } |
|  |  |  |
|  |  | e.peerLedger.Wants(p, entry.Entry) |
|  |  | filteredWants = append(filteredWants, entry) |
|  |  | } |
|  |  | clear := wants[len(filteredWants):] |
|  |  | for i := range clear { |
|  |  | clear[i] = bsmsg.Entry{} // early GC |
|  |  | } |
|  |  | wants = filteredWants |
|  |  | for \_, entry := range cancels { |
|  |  | if entry.Cid.Prefix().MhType == mh.IDENTITY { |
|  |  | // This is a truely broken client, let's kill the connection. |
|  |  | e.lock.Unlock() |
|  |  | log.Warnw("peer canceled an identity CID", "local", e.self, "remote", p) |
|  |  | return true |
|  |  | } |
|  |  | if e.maxCidSize != 0 && uint(entry.Cid.ByteLen()) > e.maxCidSize { |
|  |  | // Ignore requests about CIDs that big. |
|  |  | continue |
|  |  | } |
|  |  |  |
|  |  | log.Debugw("Bitswap engine <- cancel", "local", e.self, "from", p, "cid", entry.Cid) |
|  |  | if e.peerLedger.CancelWant(p, entry.Cid) { |
|  |  | e.peerRequestQueue.Remove(entry.Cid, p) |
| Expand Down  Expand Up | | @@ -765,6 +805,7 @@ func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwap |
|  |  | e.peerRequestQueue.PushTasksTruncated(e.maxQueuedWantlistEntriesPerPeer, p, activeEntries...) |
|  |  | e.updateMetrics() |
|  |  | } |
|  |  | return false |
|  |  | } |
|  |  |  |
|  |  | // Split the want-have / want-block entries from the cancel entries |
| Expand Down | |  |

16 changes: 15 additions & 1 deletion

16
[bitswap/server/server.go](#diff-d93b13f93791b21b76ed7d993b2d223ab1c395fdda0e88142ba637e958b1c328 "bitswap/server/server.go")

Show comments

[View file](/ipfs/boxo/blob/62cbac40b96f49e39cd7fedc77ee6b56adce4916/bitswap/server/server.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -220,6 +220,17 @@ func MaxQueuedWantlistEntriesPerPeer(count uint) Option { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // MaxCidSize limits how big CIDs we are willing to serve. |
|  |  | // We will ignore CIDs over this limit. |
|  |  | // It defaults to [defaults.MaxCidSize]. |
|  |  | // If it is 0 no limit is applied. |
|  |  | func MaxCidSize(n uint) Option { |
|  |  | o := decision.WithMaxCidSize(n) |
|  |  | return func(bs \*Server) { |
|  |  | bs.engineOptions = append(bs.engineOptions, o) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // HasBlockBufferSize configure how big the new blocks buffer should be. |
|  |  | func HasBlockBufferSize(count int) Option { |
|  |  | if count < 0 { |
| Expand Down  Expand Up | | @@ -511,7 +522,10 @@ func (bs \*Server) provideWorker(px process.Process) { |
|  |  | func (bs \*Server) ReceiveMessage(ctx context.Context, p peer.ID, incoming message.BitSwapMessage) { |
|  |  | // This call records changes to wantlists, blocks received, |
|  |  | // and number of bytes transfered. |
|  |  | bs.engine.MessageReceived(ctx, p, incoming) |
|  |  | mustKillConnection := bs.engine.MessageReceived(ctx, p, incoming) |
|  |  | if mustKillConnection { |
|  |  | bs.network.DisconnectFrom(ctx, p) |
|  |  | } |
|  |  | // TODO: this is bad, and could be easily abused. |
|  |  | // Should only track \*useful\* messages in ledger |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `62cbac4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F62cbac40b96f49e39cd7fedc77ee6b56adce4916) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ebb9753b_20250115_092133.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ipfs%2Fboxo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ipfs](/ipfs)
/
**[boxo](/ipfs/boxo)**
Public

generated from [ipfs/ipfs-repository-template](/ipfs/ipfs-repository-template)

* [Notifications](/login?return_to=%2Fipfs%2Fboxo) You must be signed in to change notification settings
* [Fork
  108](/login?return_to=%2Fipfs%2Fboxo)
* [Star
   221](/login?return_to=%2Fipfs%2Fboxo)

* [Code](/ipfs/boxo)
* [Issues
  168](/ipfs/boxo/issues)
* [Pull requests
  23](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects
  0](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

Additional navigation options

* [Code](/ipfs/boxo)
* [Issues](/ipfs/boxo/issues)
* [Pull requests](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

## Commit

[Permalink](/ipfs/boxo/commit/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

bitswap/server/internal/decision: rewrite ledger inversion

[Browse files](/ipfs/boxo/tree/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197)
Browse the repository at this point in the history

* Loading branch information

[![@Jorropo](https://avatars.githubusercontent.com/u/24391983?s=40&v=4)](/Jorropo)

[Jorropo](/ipfs/boxo/commits?author=Jorropo "View all commits by Jorropo")
committed
Feb 17, 2023

1 parent
[d195f6d](/ipfs/boxo/commit/d195f6d37ba415a922535d41c3cc765e9b9deb91)

commit 9cb5cb5

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**198 additions**
and
**163 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* bitswap

  + internal/defaults

    - bitswap/internal/defaults/defaults.go
      [defaults.go](#diff-aa2da67fd9afab3469064874508db3b047a65f7496abc44fdf08705c2e392ee3)
  + bitswap/options.go
    [options.go](#diff-518591031c81c0d6b4d7dfd212280f5267a5e0304695b59b5a971b96b2d22cbc)
  + server

    - internal/decision

      * bitswap/server/internal/decision/engine.go
        [engine.go](#diff-b387ad6bf1bb411dbd6773c5f8c3c10ed275043c0482013a0938b717b81395d1)
      * bitswap/server/internal/decision/engine\_test.go
        [engine\_test.go](#diff-02cf337fd370a1bdee175e7cd7d5afec529da8d2b38830f734d4ab8320b7a2de)
      * bitswap/server/internal/decision/peer\_ledger.go
        [peer\_ledger.go](#diff-1751fec11237ac56eff6ebe7eab255b22f32e82e6e28d439e4cc149000cec345)
    - bitswap/server/server.go
      [server.go](#diff-d93b13f93791b21b76ed7d993b2d223ab1c395fdda0e88142ba637e958b1c328)
* examples

  + examples/go.sum
    [go.sum](#diff-b05a4695386fab24648f2bfbd368123e8f3dcd6dd9e1a8f38565b10bb9a028f5)
* go.mod
  [go.mod](#diff-33ef32bf6c23acb95f5902d7097b7a1d5128ca061167ec0716715b0b9eeaa5f6)
* go.sum
  [go.sum](#diff-3295df7234525439d778f1b282d146a4f1ff6b415248aaac074e8042d9f42d63)

## There are no files selected for viewing

3 changes: 3 additions & 0 deletions

3
[bitswap/internal/defaults/defaults.go](#diff-aa2da67fd9afab3469064874508db3b047a65f7496abc44fdf08705c2e392ee3 "bitswap/internal/defaults/defaults.go")

Show comments

[View file](/ipfs/boxo/blob/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197/bitswap/internal/defaults/defaults.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,4 +24,7 @@ const ( |
|  |  | // provideCollector even before they are actually provided. |
|  |  | // TODO: Does this need to be this large givent that? |
|  |  | HasBlockBufferSize = 256 |
|  |  |  |
|  |  | // Maximum size of the wantlist we are willing to keep in memory. |
|  |  | MaxQueuedWantlistEntiresPerPeer = 1024 |
|  |  | ) |

4 changes: 4 additions & 0 deletions

4
[bitswap/options.go](#diff-518591031c81c0d6b4d7dfd212280f5267a5e0304695b59b5a971b96b2d22cbc "bitswap/options.go")

Show comments

[View file](/ipfs/boxo/blob/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197/bitswap/options.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ func MaxOutstandingBytesPerPeer(count int) Option { |
|  |  | return Option{server.MaxOutstandingBytesPerPeer(count)} |
|  |  | } |
|  |  |  |
|  |  | func MaxQueuedWantlistEntriesPerPeer(count uint) Option { |
|  |  | return Option{server.MaxQueuedWantlistEntriesPerPeer(count)} |
|  |  | } |
|  |  |  |
|  |  | func TaskWorkerCount(count int) Option { |
|  |  | return Option{server.TaskWorkerCount(count)} |
|  |  | } |
| Expand Down | |  |

183 changes: 48 additions & 135 deletions

183
[bitswap/server/internal/decision/engine.go](#diff-b387ad6bf1bb411dbd6773c5f8c3c10ed275043c0482013a0938b717b81395d1 "bitswap/server/internal/decision/engine.go")

Show comments

[View file](/ipfs/boxo/blob/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197/bitswap/server/internal/decision/engine.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,6 +4,7 @@ package decision |
|  |  | import ( |
|  |  | "context" |
|  |  | "fmt" |
|  |  | "math/bits" |
|  |  | "sync" |
|  |  | "time" |
|  |  |  |
| Expand Down  Expand Up | | @@ -147,9 +148,6 @@ type Engine struct { |
|  |  |  |
|  |  | lock sync.RWMutex // protects the fields immediately below |
|  |  |  |
|  |  | // ledgerMap lists block-related Ledgers by their Partner key. |
|  |  | ledgerMap map[peer.ID]\*ledger |
|  |  |  |
|  |  | // peerLedger saves which peers are waiting for a Cid |
|  |  | peerLedger \*peerLedger |
|  |  |  |
| Expand Down  Expand Up | | @@ -187,6 +185,8 @@ type Engine struct { |
|  |  |  |
|  |  | bstoreWorkerCount int |
|  |  | maxOutstandingBytesPerPeer int |
|  |  |  |
|  |  | maxQueuedWantlistEntriesPerPeer uint |
|  |  | } |
|  |  |  |
|  |  | // TaskInfo represents the details of a request from a peer. |
| Expand Down  Expand Up | | @@ -270,6 +270,15 @@ func WithMaxOutstandingBytesPerPeer(count int) Option { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // WithMaxQueuedWantlistEntriesPerPeer limits how much individual entries each peer is allowed to send. |
|  |  | // If a peer send us more than this we will truncate newest entries. |
|  |  | // It defaults to DefaultMaxQueuedWantlistEntiresPerPeer. |
|  |  | func WithMaxQueuedWantlistEntriesPerPeer(count uint) Option { |
|  |  | return func(e \*Engine) { |
|  |  | e.maxQueuedWantlistEntriesPerPeer = count |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func WithSetSendDontHave(send bool) Option { |
|  |  | return func(e \*Engine) { |
|  |  | e.sendDontHaves = send |
| Expand Down  Expand Up | | @@ -330,7 +339,6 @@ func newEngine( |
|  |  | opts ...Option, |
|  |  | ) \*Engine { |
|  |  | e := &Engine{ |
|  |  | ledgerMap: make(map[peer.ID]\*ledger), |
|  |  | scoreLedger: NewDefaultScoreLedger(), |
|  |  | bstoreWorkerCount: defaults.BitswapEngineBlockstoreWorkerCount, |
|  |  | maxOutstandingBytesPerPeer: defaults.BitswapMaxOutstandingBytesPerPeer, |
| Expand All | | @@ -348,6 +356,7 @@ func newEngine( |
|  |  | targetMessageSize: defaultTargetMessageSize, |
|  |  | tagQueued: fmt.Sprintf(tagFormat, "queued", uuid.New().String()), |
|  |  | tagUseful: fmt.Sprintf(tagFormat, "useful", uuid.New().String()), |
|  |  | maxQueuedWantlistEntriesPerPeer: defaults.MaxQueuedWantlistEntiresPerPeer, |
|  |  | } |
|  |  |  |
|  |  | for \_, opt := range opts { |
| Expand Down  Expand Up | | @@ -450,13 +459,10 @@ func (e \*Engine) onPeerRemoved(p peer.ID) { |
|  |  |  |
|  |  | // WantlistForPeer returns the list of keys that the given peer has asked for |
|  |  | func (e \*Engine) WantlistForPeer(p peer.ID) []wl.Entry { |
|  |  | partner := e.findOrCreate(p) |
|  |  |  |
|  |  | partner.lk.Lock() |
|  |  | entries := partner.wantList.Entries() |
|  |  | partner.lk.Unlock() |
|  |  | e.lock.RLock() |
|  |  | defer e.lock.RUnlock() |
|  |  |  |
|  |  | return entries |
|  |  | return e.peerLedger.WantlistForPeer(p) |
|  |  | } |
|  |  |  |
|  |  | // LedgerForPeer returns aggregated data communication with a given peer. |
| Expand Down  Expand Up | | @@ -605,12 +611,7 @@ func (e \*Engine) Peers() []peer.ID { |
|  |  | e.lock.RLock() |
|  |  | defer e.lock.RUnlock() |
|  |  |  |
|  |  | response := make([]peer.ID, 0, len(e.ledgerMap)) |
|  |  |  |
|  |  | for \_, ledger := range e.ledgerMap { |
|  |  | response = append(response, ledger.Partner) |
|  |  | } |
|  |  | return response |
|  |  | return e.peerLedger.CollectPeerIDs() |
|  |  | } |
|  |  |  |
|  |  | // MessageReceived is called when a message is received from a remote peer. |
| Expand Down  Expand Up | | @@ -659,33 +660,34 @@ func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwap |
|  |  | } |
|  |  |  |
|  |  | e.lock.Lock() |
|  |  | for \_, entry := range wants { |
|  |  | e.peerLedger.Wants(p, entry.Cid) |
|  |  | } |
|  |  | for \_, entry := range cancels { |
|  |  | e.peerLedger.CancelWant(p, entry.Cid) |
|  |  | } |
|  |  | e.lock.Unlock() |
|  |  |  |
|  |  | // Get the ledger for the peer |
|  |  | l := e.findOrCreate(p) |
|  |  | l.lk.Lock() |
|  |  | defer l.lk.Unlock() |
|  |  |  |
|  |  | // If the peer sent a full wantlist, replace the ledger's wantlist |
|  |  | if m.Full() { |
|  |  | l.wantList = wl.New() |
|  |  | e.peerLedger.ClearPeerWantlist(p) |
|  |  | } |
|  |  |  |
|  |  | var activeEntries []peertask.Task |
|  |  | s := uint(e.peerLedger.WantlistSizeForPeer(p)) |
|  |  | if wouldBe := s + uint(len(wants)); wouldBe > e.maxQueuedWantlistEntriesPerPeer { |
|  |  | log.Debugw("wantlist overflow", "local", e.self, "remote", p, "would be", wouldBe) |
|  |  | // truncate wantlist to avoid overflow |
|  |  | available, o := bits.Sub(e.maxQueuedWantlistEntriesPerPeer, s, 0) |
|  |  | if o != 0 { |
|  |  | available = 0 |
|  |  | } |
|  |  | wants = wants[:available] |
|  |  | } |
|  |  |  |
|  |  | // Remove cancelled blocks from the queue |
|  |  | for \_, entry := range wants { |
|  |  | e.peerLedger.Wants(p, entry.Entry) |
|  |  | } |
|  |  | for \_, entry := range cancels { |
|  |  | log.Debugw("Bitswap engine <- cancel", "local", e.self, "from", p, "cid", entry.Cid) |
|  |  | if l.CancelWant(entry.Cid) { |
|  |  | if e.peerLedger.CancelWant(p, entry.Cid) { |
|  |  | e.peerRequestQueue.Remove(entry.Cid, p) |
|  |  | } |
|  |  | } |
|  |  | e.lock.Unlock() |
|  |  |  |
|  |  | var activeEntries []peertask.Task |
|  |  |  |
|  |  | // Cancel a block operation |
|  |  | sendDontHave := func(entry bsmsg.Entry) { |
| Expand Down  Expand Up | | @@ -724,9 +726,6 @@ func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwap |
|  |  | c := entry.Cid |
|  |  | blockSize, found := blockSizes[entry.Cid] |
|  |  |  |
|  |  | // Add each want-have / want-block to the ledger |
|  |  | l.Wants(c, entry.Priority, entry.WantType) |
|  |  |  |
|  |  | // If the block was not found |
|  |  | if !found { |
|  |  | log.Debugw("Bitswap engine: block not found", "local", e.self, "from", p, "cid", entry.Cid, "sendDontHave", entry.SendDontHave) |
| Expand Down  Expand Up | | @@ -763,7 +762,7 @@ func (e \*Engine) MessageReceived(ctx context.Context, p peer.ID, m bsmsg.BitSwap |
|  |  |  |
|  |  | // Push entries onto the request queue |
|  |  | if len(activeEntries) > 0 { |
|  |  | e.peerRequestQueue.PushTasks(p, activeEntries...) |
|  |  | e.peerRequestQueue.PushTasksTruncated(e.maxQueuedWantlistEntriesPerPeer, p, activeEntries...) |
|  |  | e.updateMetrics() |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -809,14 +808,10 @@ func (e \*Engine) ReceivedBlocks(from peer.ID, blks []blocks.Block) { |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | l := e.findOrCreate(from) |
|  |  |  |
|  |  | // Record how many bytes were received in the ledger |
|  |  | l.lk.Lock() |
|  |  | defer l.lk.Unlock() |
|  |  | for \_, blk := range blks { |
|  |  | log.Debugw("Bitswap engine <- block", "local", e.self, "from", from, "cid", blk.Cid(), "size", len(blk.RawData())) |
|  |  | e.scoreLedger.AddToReceivedBytes(l.Partner, len(blk.RawData())) |
|  |  | e.scoreLedger.AddToReceivedBytes(from, len(blk.RawData())) |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand All | | @@ -835,34 +830,14 @@ func (e \*Engine) NotifyNewBlocks(blks []blocks.Block) { |
|  |  |  |
|  |  | // Check each peer to see if it wants one of the blocks we received |
|  |  | var work bool |
|  |  | missingWants := make(map[peer.ID][]cid.Cid) |
|  |  | for \_, b := range blks { |
|  |  | k := b.Cid() |
|  |  |  |
|  |  | e.lock.RLock() |
|  |  | peers := e.peerLedger.Peers(k) |
|  |  | e.lock.RUnlock() |
|  |  |  |
|  |  | for \_, p := range peers { |
|  |  | e.lock.RLock() |
|  |  | ledger, ok := e.ledgerMap[p] |
|  |  | e.lock.RUnlock() |
|  |  |  |
|  |  | if !ok { |
|  |  | // This can happen if the peer has disconnected while we're processing this list. |
|  |  | log.Debugw("failed to find peer in ledger", "peer", p) |
|  |  | missingWants[p] = append(missingWants[p], k) |
|  |  | continue |
|  |  | } |
|  |  | ledger.lk.RLock() |
|  |  | entry, ok := ledger.WantListContains(k) |
|  |  | ledger.lk.RUnlock() |
|  |  | if !ok { |
|  |  | // This can happen if the peer has canceled their want while we're processing this message. |
|  |  | log.Debugw("wantlist index doesn't match peer's wantlist", "peer", p) |
|  |  | missingWants[p] = append(missingWants[p], k) |
|  |  | continue |
|  |  | } |
|  |  | for \_, entry := range peers { |
|  |  | work = true |
|  |  |  |
|  |  | blockSize := blockSizes[k] |
| Expand All | | @@ -873,8 +848,8 @@ func (e \*Engine) NotifyNewBlocks(blks []blocks.Block) { |
|  |  | entrySize = bsmsg.BlockPresenceSize(k) |
|  |  | } |
|  |  |  |
|  |  | e.peerRequestQueue.PushTasks(p, peertask.Task{ |
|  |  | Topic: entry.Cid, |
|  |  | e.peerRequestQueue.PushTasksTruncated(e.maxQueuedWantlistEntriesPerPeer, entry.Peer, peertask.Task{ |
|  |  | Topic: k, |
|  |  | Priority: int(entry.Priority), |
|  |  | Work: entrySize, |
|  |  | Data: &taskData{ |
| Expand All | | @@ -888,30 +863,6 @@ func (e \*Engine) NotifyNewBlocks(blks []blocks.Block) { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // If we found missing wants (e.g., because the peer disconnected, we have some races here) |
|  |  | // remove them from the list. Unfortunately, we still have to re-check because the user |
|  |  | // could have re-connected in the meantime. |
|  |  | if len(missingWants) > 0 { |
|  |  | e.lock.Lock() |
|  |  | for p, wl := range missingWants { |
|  |  | if ledger, ok := e.ledgerMap[p]; ok { |
|  |  | ledger.lk.RLock() |
|  |  | for \_, k := range wl { |
|  |  | if \_, has := ledger.WantListContains(k); has { |
|  |  | continue |
|  |  | } |
|  |  | e.peerLedger.CancelWant(p, k) |
|  |  | } |
|  |  | ledger.lk.RUnlock() |
|  |  | } else { |
|  |  | for \_, k := range wl { |
|  |  | e.peerLedger.CancelWant(p, k) |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  | e.lock.Unlock() |
|  |  | } |
|  |  |  |
|  |  | if work { |
|  |  | e.signalNewWork() |
|  |  | } |
| Expand All | | @@ -926,21 +877,20 @@ func (e \*Engine) NotifyNewBlocks(blks []blocks.Block) { |
|  |  | // MessageSent is called when a message has successfully been sent out, to record |
|  |  | // changes. |
|  |  | func (e \*Engine) MessageSent(p peer.ID, m bsmsg.BitSwapMessage) { |
|  |  | l := e.findOrCreate(p) |
|  |  | l.lk.Lock() |
|  |  | defer l.lk.Unlock() |
|  |  | e.lock.Lock() |
|  |  | defer e.lock.Unlock() |
|  |  |  |
|  |  | // Remove sent blocks from the want list for the peer |
|  |  | for \_, block := range m.Blocks() { |
|  |  | e.scoreLedger.AddToSentBytes(l.Partner, len(block.RawData())) |
|  |  | l.wantList.RemoveType(block.Cid(), pb.Message\_Wantlist\_Block) |
|  |  | e.scoreLedger.AddToSentBytes(p, len(block.RawData())) |
|  |  | e.peerLedger.CancelWantWithType(p, block.Cid(), pb.Message\_Wantlist\_Block) |
|  |  | } |
|  |  |  |
|  |  | // Remove sent block presences from the want list for the peer |
|  |  | for \_, bp := range m.BlockPresences() { |
|  |  | // Don't record sent data. We reserve that for data blocks. |
|  |  | if bp.Type == pb.Message\_Have { |
|  |  | l.wantList.RemoveType(bp.Cid, pb.Message\_Wantlist\_Have) |
|  |  | e.peerLedger.CancelWantWithType(p, bp.Cid, pb.Message\_Wantlist\_Have) |
|  |  | } |
|  |  | } |
|  |  | } |
| Expand All | | @@ -951,31 +901,17 @@ func (e \*Engine) PeerConnected(p peer.ID) { |
|  |  | e.lock.Lock() |
|  |  | defer e.lock.Unlock() |
|  |  |  |
|  |  | \_, ok := e.ledgerMap[p] |
|  |  | if !ok { |
|  |  | e.ledgerMap[p] = newLedger(p) |
|  |  | } |
|  |  |  |
|  |  | e.scoreLedger.PeerConnected(p) |
|  |  | } |
|  |  |  |
|  |  | // PeerDisconnected is called when a peer disconnects. |
|  |  | func (e \*Engine) PeerDisconnected(p peer.ID) { |
|  |  | e.peerRequestQueue.Clear(p) |
|  |  |  |
|  |  | e.lock.Lock() |
|  |  | defer e.lock.Unlock() |
|  |  |  |
|  |  | ledger, ok := e.ledgerMap[p] |
|  |  | if ok { |
|  |  | ledger.lk.RLock() |
|  |  | entries := ledger.Entries() |
|  |  | ledger.lk.RUnlock() |
|  |  |  |
|  |  | for \_, entry := range entries { |
|  |  | e.peerLedger.CancelWant(p, entry.Cid) |
|  |  | } |
|  |  | } |
|  |  | delete(e.ledgerMap, p) |
|  |  |  |
|  |  | e.peerLedger.PeerDisconnected(p) |
|  |  | e.scoreLedger.PeerDisconnected(p) |
|  |  | } |
|  |  |  |
| Expand All | | @@ -994,29 +930,6 @@ func (e \*Engine) numBytesReceivedFrom(p peer.ID) uint64 { |
|  |  | return e.LedgerForPeer(p).Recv |
|  |  | } |
|  |  |  |
|  |  | // ledger lazily instantiates a ledger |
|  |  | func (e \*Engine) findOrCreate(p peer.ID) \*ledger { |
|  |  | // Take a read lock (as it's less expensive) to check if we have a ledger |
|  |  | // for the peer |
|  |  | e.lock.RLock() |
|  |  | l, ok := e.ledgerMap[p] |
|  |  | e.lock.RUnlock() |
|  |  | if ok { |
|  |  | return l |
|  |  | } |
|  |  |  |
|  |  | // There's no ledger, so take a write lock, then check again and create the |
|  |  | // ledger if necessary |
|  |  | e.lock.Lock() |
|  |  | defer e.lock.Unlock() |
|  |  | l, ok = e.ledgerMap[p] |
|  |  | if !ok { |
|  |  | l = newLedger(p) |
|  |  | e.ledgerMap[p] = l |
|  |  | } |
|  |  | return l |
|  |  | } |
|  |  |  |
|  |  | func (e \*Engine) signalNewWork() { |
|  |  | // Signal task generation to restart (if stopped!) |
|  |  | select { |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9cb5cb5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2F9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_6914adbd_20250115_092135.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fsecurity%2Fadvisories%2FGHSA-m974-xj4j-7qv5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fsecurity%2Fadvisories%2FGHSA-m974-xj4j-7qv5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=ipfs%2Fboxo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ipfs](/ipfs)
/
**[boxo](/ipfs/boxo)**
Public

generated from [ipfs/ipfs-repository-template](/ipfs/ipfs-repository-template)

* [Notifications](/login?return_to=%2Fipfs%2Fboxo) You must be signed in to change notification settings
* [Fork
  108](/login?return_to=%2Fipfs%2Fboxo)
* [Star
   221](/login?return_to=%2Fipfs%2Fboxo)

* [Code](/ipfs/boxo)
* [Issues
  168](/ipfs/boxo/issues)
* [Pull requests
  23](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects
  0](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

Additional navigation options

* [Code](/ipfs/boxo)
* [Issues](/ipfs/boxo/issues)
* [Pull requests](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

# bitswap/server: DOS unbounded persistant memory leak

Moderate

[Jorropo](/Jorropo)
published
GHSA-m974-xj4j-7qv5
May 10, 2023

## Package

gomod

github.com/ipfs/go-libipfs/bitswap/server
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

0.4.0; 0.5.0

## Patched versions

0.4.1; 0.6.0

## Description

### Impact

An attacker is able allocate arbitrarily many bytes in the Bitswap server by sending many `WANT_BLOCK` and or `WANT_HAVE` requests which are queued in an unbounded queue, with allocations that persist even if the connection is closed.

This affects users accepting untrusted connections with the Bitswap server, this also affects users using the old API stubs at `github.com/ipfs/boxo/bitswap` because it transitively uses `github.com/ipfs/boxo/bitswap/server`.

We have [renamed go-libipfs to boxo](https://github.com/ipfs/boxo/issues/215); this document uses both terms interchangeably. The version numbers for both are applicable, as they share the same historical timeline.

### Remediation

Apply one of:

* Update `boxo` to [`v0.6.0`](https://github.com/ipfs/boxo/releases/tag/v0.6.0) or later
* Update `boxo` to [`v0.4.1`](https://github.com/ipfs/boxo/releases/tag/v0.4.1)

  Note that ***`v0.5.0` is NOT safe***, `v0.4.1` is a backport of the `v0.6.0` security fixes on top of `v0.4.0`.

### Mitigations

1. The server now limits how many wantlist entries per peer it knows.

   The `MaxQueuedWantlistEntriesPerPeer` option allows configuring how many wantlist entries the server remembers; if a peer sends a wantlist bigger than this (including a sum of multiple delta updates) the server will truncate the wantlist to the match the limit.

   This defaults to `1024` entries per peer.
2. The server now properly clears state about peers when they disconnect.

   Peer state is more lazily allocated (only when a wantlist is received in the first place) and is properly cleared when the `PeerDisconnected` callback is received.
3. The server now ignores CIDs above some size.

   Clients were able to send any CID as long as the total protobuf message were bellow the 4MiB limit. This is allowed to allocate lots of memory with very little entries.

   This can be configured using the `MaxCidSize` option and defaults to `168 bytes`.
4. The server now closes the connection if an inline CID is requested (either as `WANT_*` or `CANCEL`).

   The attack were more effective if done with CIDs that are present in target's blockstore, this is because this will push longer-lasting jobs on some priority queue.

   Since inline CID are literal data (instead of hashes of data), everyone always "has" any inline CID (since instead of loading the data from disk, it can be extracted from the CID). It makes no sense for anyone to ever ask you about an inline CID since they could also just parse it themselves. Thus, as a defensive measure, we kill the connection with peers that ask about an inline CID.

### Vulnerable symbols

* `github.com/ipfs/go-libipfs/bitswap/server/internal/decision.(*Engine).MessageReceived`
* `github.com/ipfs/go-libipfs/bitswap/server/internal/decision.(*Engine).NotifyNewBlocks`
* `github.com/ipfs/go-libipfs/bitswap/server/internal/decision.(*Engine).findOrCreate`
* `github.com/ipfs/go-libipfs/bitswap/server/internal/decision.(*Engine).PeerConnected`

### Patches

* [9cb5cb5](https://github.com/ipfs/boxo/commit/9cb5cb54d40b57084d1221ba83b9e6bb3fcc3197) (mitigations 1 and 2)
* [62cbac4](https://github.com/ipfs/boxo/commit/62cbac40b96f49e39cd7fedc77ee6b56adce4916) (mitigations 3 and 4)
* [baa748b](https://github.com/ipfs/boxo/commit/baa748b682fabb21a4c1f7628a8af348d4645974) (tests)

### Workarounds

If you are using the stubs at `github.com/ipfs/go-libipfs/bitswap` and not taking advantage of the features provided by the server, refactoring your code to use the new split API will allow you to run in a client-only mode using: [`github.com/ipfs/boxo/bitswap/client`](https://pkg.go.dev/github.com/ipfs/boxo/bitswap/client).

### Severity

Moderate

5.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
Low

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L

### CVE ID

CVE-2023-25568

### Weaknesses

[CWE-400](/advisories?query=cwe%3A400) [CWE-770](/advisories?query=cwe%3A770)

### Credits

* [![@Jorropo](https://avatars.githubusercontent.com/u/24391983?s=40&v=4)](/Jorropo)
  [Jorropo](/Jorropo)
  Analyst
* [![@guseggert](https://avatars.githubusercontent.com/u/877588?s=40&v=4)](/guseggert)
  [guseggert](/guseggert)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_711260be_20250115_092134.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2Fbaa748b682fabb21a4c1f7628a8af348d4645974)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2Fbaa748b682fabb21a4c1f7628a8af348d4645974)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=ipfs%2Fboxo)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ipfs](/ipfs)
/
**[boxo](/ipfs/boxo)**
Public

generated from [ipfs/ipfs-repository-template](/ipfs/ipfs-repository-template)

* [Notifications](/login?return_to=%2Fipfs%2Fboxo) You must be signed in to change notification settings
* [Fork
  108](/login?return_to=%2Fipfs%2Fboxo)
* [Star
   221](/login?return_to=%2Fipfs%2Fboxo)

* [Code](/ipfs/boxo)
* [Issues
  168](/ipfs/boxo/issues)
* [Pull requests
  23](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects
  0](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

Additional navigation options

* [Code](/ipfs/boxo)
* [Issues](/ipfs/boxo/issues)
* [Pull requests](/ipfs/boxo/pulls)
* [Actions](/ipfs/boxo/actions)
* [Projects](/ipfs/boxo/projects)
* [Wiki](/ipfs/boxo/wiki)
* [Security](/ipfs/boxo/security)
* [Insights](/ipfs/boxo/pulse)

## Commit

[Permalink](/ipfs/boxo/commit/baa748b682fabb21a4c1f7628a8af348d4645974)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

bitswap/server/internal/decision: add more non flaky tests

[Browse files](/ipfs/boxo/tree/baa748b682fabb21a4c1f7628a8af348d4645974)
Browse the repository at this point in the history

* Loading branch information

[![@Jorropo](https://avatars.githubusercontent.com/u/24391983?s=40&v=4)](/Jorropo)

[Jorropo](/ipfs/boxo/commits?author=Jorropo "View all commits by Jorropo")
committed
Feb 17, 2023

1 parent
[62cbac4](/ipfs/boxo/commit/62cbac40b96f49e39cd7fedc77ee6b56adce4916)

commit baa748b

Showing
**1 changed file**
with
**133 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

133 changes: 133 additions & 0 deletions

133
[bitswap/server/internal/decision/engine\_test.go](#diff-02cf337fd370a1bdee175e7cd7d5afec529da8d2b38830f734d4ab8320b7a2de "bitswap/server/internal/decision/engine_test.go")

Show comments

[View file](/ipfs/boxo/blob/baa748b682fabb21a4c1f7628a8af348d4645974/bitswap/server/internal/decision/engine_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,8 +3,10 @@ package decision |
|  |  | import ( |
|  |  | "bytes" |
|  |  | "context" |
|  |  | "encoding/binary" |
|  |  | "errors" |
|  |  | "fmt" |
|  |  | "math/rand" |
|  |  | "strings" |
|  |  | "sync" |
|  |  | "testing" |
| Expand All | | @@ -23,6 +25,7 @@ import ( |
|  |  | process "github.com/jbenet/goprocess" |
|  |  | peer "github.com/libp2p/go-libp2p/core/peer" |
|  |  | libp2ptest "github.com/libp2p/go-libp2p/core/test" |
|  |  | mh "github.com/multiformats/go-multihash" |
|  |  | ) |
|  |  |  |
|  |  | type peerTag struct { |
| Expand Down  Expand Up | | @@ -1051,6 +1054,12 @@ func TestWantlistForPeer(t \*testing.T) { |
|  |  | if len(entries) != 4 { |
|  |  | t.Fatal("expected wantlist to contain all wants from parter") |
|  |  | } |
|  |  |  |
|  |  | e.PeerDisconnected(partner) |
|  |  | entries = e.WantlistForPeer(partner) |
|  |  | if len(entries) != 0 { |
|  |  | t.Fatal("expected wantlist to be empty after disconnect") |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func TestTaskComparator(t \*testing.T) { |
| Expand Down  Expand Up | | @@ -1629,3 +1638,127 @@ func stringsComplement(set, subset []string) []string { |
|  |  | } |
|  |  | return complement |
|  |  | } |
|  |  |  |
|  |  | func TestWantlistDoesNotGrowPastLimit(t \*testing.T) { |
|  |  | ctx, cancel := context.WithCancel(context.Background()) |
|  |  | defer cancel() |
|  |  |  |
|  |  | const limit = 32 |
|  |  | warsaw := newTestEngine(ctx, "warsaw", WithMaxQueuedWantlistEntriesPerPeer(limit)) |
|  |  | riga := newTestEngine(ctx, "riga") |
|  |  |  |
|  |  | // Send in two messages to test reslicing. |
|  |  | for i := 2; i != 0; i-- { |
|  |  | m := message.New(false) |
|  |  | for j := limit \* 3 / 4; j != 0; j-- { |
|  |  | m.AddEntry(blocks.NewBlock([]byte(fmt.Sprint(i, j))).Cid(), 0, pb.Message\_Wantlist\_Block, true) |
|  |  | } |
|  |  | warsaw.Engine.MessageReceived(ctx, riga.Peer, m) |
|  |  | } |
|  |  |  |
|  |  | if warsaw.Peer == riga.Peer { |
|  |  | t.Fatal("Sanity Check: Peers have same Key!") |
|  |  | } |
|  |  |  |
|  |  | wl := warsaw.Engine.WantlistForPeer(riga.Peer) |
|  |  | if len(wl) != limit { |
|  |  | t.Fatal("wantlist does not match limit", len(wl)) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func TestWantlistGrowsToLimit(t \*testing.T) { |
|  |  | ctx, cancel := context.WithCancel(context.Background()) |
|  |  | defer cancel() |
|  |  |  |
|  |  | const limit = 32 |
|  |  | warsaw := newTestEngine(ctx, "warsaw", WithMaxQueuedWantlistEntriesPerPeer(limit)) |
|  |  | riga := newTestEngine(ctx, "riga") |
|  |  |  |
|  |  | // Send in two messages to test reslicing. |
|  |  | m := message.New(false) |
|  |  | for j := limit; j != 0; j-- { |
|  |  | m.AddEntry(blocks.NewBlock([]byte(fmt.Sprint(j))).Cid(), 0, pb.Message\_Wantlist\_Block, true) |
|  |  | } |
|  |  | warsaw.Engine.MessageReceived(ctx, riga.Peer, m) |
|  |  |  |
|  |  | if warsaw.Peer == riga.Peer { |
|  |  | t.Fatal("Sanity Check: Peers have same Key!") |
|  |  | } |
|  |  |  |
|  |  | wl := warsaw.Engine.WantlistForPeer(riga.Peer) |
|  |  | if len(wl) != limit { |
|  |  | t.Fatal("wantlist does not match limit", len(wl)) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func TestIgnoresCidsAboveLimit(t \*testing.T) { |
|  |  | ctx, cancel := context.WithCancel(context.Background()) |
|  |  | defer cancel() |
|  |  |  |
|  |  | const cidLimit = 64 |
|  |  | warsaw := newTestEngine(ctx, "warsaw", WithMaxCidSize(cidLimit)) |
|  |  | riga := newTestEngine(ctx, "riga") |
|  |  |  |
|  |  | // Send in two messages to test reslicing. |
|  |  | m := message.New(true) |
|  |  |  |
|  |  | m.AddEntry(blocks.NewBlock([]byte("Hæ")).Cid(), 0, pb.Message\_Wantlist\_Block, true) |
|  |  |  |
|  |  | var hash mh.Multihash |
|  |  | hash = binary.AppendUvarint(hash, mh.BLAKE3) |
|  |  | hash = binary.AppendUvarint(hash, cidLimit) |
|  |  | startOfDigest := len(hash) |
|  |  | hash = append(hash, make(mh.Multihash, cidLimit)...) |
|  |  | rand.Read(hash[startOfDigest:]) |
|  |  | m.AddEntry(cid.NewCidV1(cid.Raw, hash), 0, pb.Message\_Wantlist\_Block, true) |
|  |  |  |
|  |  | warsaw.Engine.MessageReceived(ctx, riga.Peer, m) |
|  |  |  |
|  |  | if warsaw.Peer == riga.Peer { |
|  |  | t.Fatal("Sanity Check: Peers have same Key!") |
|  |  | } |
|  |  |  |
|  |  | wl := warsaw.Engine.WantlistForPeer(riga.Peer) |
|  |  | if len(wl) != 1 { |
|  |  | t.Fatal("wantlist add a CID too big") |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func TestKillConnectionForInlineCid(t \*testing.T) { |
|  |  | ctx, cancel := context.WithCancel(context.Background()) |
|  |  | defer cancel() |
|  |  |  |
|  |  | warsaw := newTestEngine(ctx, "warsaw") |
|  |  | riga := newTestEngine(ctx, "riga") |
|  |  |  |
|  |  | if warsaw.Peer == riga.Peer { |
|  |  | t.Fatal("Sanity Check: Peers have same Key!") |
|  |  | } |
|  |  |  |
|  |  | // Send in two messages to test reslicing. |
|  |  | m := message.New(true) |
|  |  |  |
|  |  | m.AddEntry(blocks.NewBlock([]byte("Hæ")).Cid(), 0, pb.Message\_Wantlist\_Block, true) |
|  |  |  |
|  |  | var hash mh.Multihash |
|  |  | hash = binary.AppendUvarint(hash, mh.IDENTITY) |
|  |  | const digestSize = 32 |
|  |  | hash = binary.AppendUvarint(hash, digestSize) |
|  |  | startOfDigest := len(hash) |
|  |  | hash = append(hash, make(mh.Multihash, digestSize)...) |
|  |  | rand.Read(hash[startOfDigest:]) |
|  |  | m.AddEntry(cid.NewCidV1(cid.Raw, hash), 0, pb.Message\_Wantlist\_Block, true) |
|  |  |  |
|  |  | if !warsaw.Engine.MessageReceived(ctx, riga.Peer, m) { |
|  |  | t.Fatal("connection was not killed when receiving inline in cancel") |
|  |  | } |
|  |  |  |
|  |  | m.Reset(true) |
|  |  |  |
|  |  | m.AddEntry(blocks.NewBlock([]byte("Hæ")).Cid(), 0, pb.Message\_Wantlist\_Block, true) |
|  |  | m.Cancel(cid.NewCidV1(cid.Raw, hash)) |
|  |  |  |
|  |  | if !warsaw.Engine.MessageReceived(ctx, riga.Peer, m) { |
|  |  | t.Fatal("connection was not killed when receiving inline in cancel") |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `baa748b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fipfs%2Fboxo%2Fcommit%2Fbaa748b682fabb21a4c1f7628a8af348d4645974) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


