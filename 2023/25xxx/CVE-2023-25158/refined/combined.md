=== Content from github.com_9cc96e00_20250115_090612.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgeotools%2Fgeotools%2Fcommit%2F64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgeotools%2Fgeotools%2Fcommit%2F64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=geotools%2Fgeotools)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[geotools](/geotools)
/
**[geotools](/geotools/geotools)**
Public

* [Notifications](/login?return_to=%2Fgeotools%2Fgeotools) You must be signed in to change notification settings
* [Fork
  1.2k](/login?return_to=%2Fgeotools%2Fgeotools)
* [Star
   1.8k](/login?return_to=%2Fgeotools%2Fgeotools)

* [Code](/geotools/geotools)
* [Pull requests
  3](/geotools/geotools/pulls)
* [Actions](/geotools/geotools/actions)
* [Projects
  0](/geotools/geotools/projects)
* [Wiki](/geotools/geotools/wiki)
* [Security](/geotools/geotools/security)
* [Insights](/geotools/geotools/pulse)

Additional navigation options

* [Code](/geotools/geotools)
* [Pull requests](/geotools/geotools/pulls)
* [Actions](/geotools/geotools/actions)
* [Projects](/geotools/geotools/projects)
* [Wiki](/geotools/geotools/wiki)
* [Security](/geotools/geotools/security)
* [Insights](/geotools/geotools/pulse)

## Commit

[Permalink](/geotools/geotools/commit/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-99c3-qc2q-p94m](https://github.com/advisories/GHSA-99c3-qc2q-p94m "GHSA-99c3-qc2q-p94m")

[Browse files](/geotools/geotools/tree/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b)
Browse the repository at this point in the history

* Loading branch information

[![@sikeoka](https://avatars.githubusercontent.com/u/11542093?s=40&v=4)](/sikeoka)

[sikeoka](/geotools/geotools/commits?author=sikeoka "View all commits by sikeoka")
authored
Feb 10, 2023

1 parent
[424f4f0](/geotools/geotools/commit/424f4f03888da7257d0f775b48b9d3c1acbd0f6f)

commit 64fb4c4

 Show file tree

 Hide file tree

Showing
**17 changed files**
with
**614 additions**
and
**170 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* modules

  + library

    - jdbc/src

      * main/java/org/geotools

        + data/jdbc

          - modules/library/jdbc/src/main/java/org/geotools/data/jdbc/FilterToSQL.java
            [FilterToSQL.java](#diff-bd6d9db0d247e2fa5b149e6e281e39d27da9eecb7b755cb5f9be01aa975aca2e)
        + jdbc

          - modules/library/jdbc/src/main/java/org/geotools/jdbc/EscapeSql.java
            [EscapeSql.java](#diff-9c2f3a1daafd589eb6305170ffa40db051aeda5ae26c22b3438ba5923b451ab7)
          - modules/library/jdbc/src/main/java/org/geotools/jdbc/SQLDialect.java
            [SQLDialect.java](#diff-06ea10ce30449e1b7b5c364a2ab00a5dc3dc23f13ce309e6ff02a1791f9faf92)
      * test/java/org/geotools/data/jdbc

        + modules/library/jdbc/src/test/java/org/geotools/data/jdbc/FilterToSQLTest.java
          [FilterToSQLTest.java](#diff-72a6758b0e8fe51dfc8d8908fb229c2ab458b5aae08904788e342792acc07d66)
    - main/src

      * main/java/org/geotools/filter

        + modules/library/main/src/main/java/org/geotools/filter/LikeFilterImpl.java
          [LikeFilterImpl.java](#diff-c6d93734739add8b8b53d0eb9a7c04abb52dad436d30261b7f3f78fb61ab254f)
      * test/java/org/geotools/filter

        + modules/library/main/src/test/java/org/geotools/filter/FilterTest.java
          [FilterTest.java](#diff-210392731fc74be9635ceb5e104b246e9c6a578c27d7641ceb79a3c6375878f7)
  + plugin/jdbc

    - jdbc-mysql/src

      * main/java/org/geotools/data/mysql

        + modules/plugin/jdbc/jdbc-mysql/src/main/java/org/geotools/data/mysql/MySQLDialectBasic.java
          [MySQLDialectBasic.java](#diff-35bd5ec6e0524d2a1777641ab65deb7b4d02504a218c3113b049cc83ac48a20a)
      * test/java/org/geotools/data/mysql

        + modules/plugin/jdbc/jdbc-mysql/src/test/java/org/geotools/data/mysql/MySQLFilterToSQLTest.java
          [MySQLFilterToSQLTest.java](#diff-d2387583690c0a2442a147af44986650dedcbe227a5d1b2f8c2d0435cd9e6b36)
    - jdbc-oracle/src

      * main/java/org/geotools/data/oracle

        + modules/plugin/jdbc/jdbc-oracle/src/main/java/org/geotools/data/oracle/OracleDialect.java
          [OracleDialect.java](#diff-75235b151c4bebb6e9f1f3c0bc3bf37f4217163b520b58e8f4d7c8e008d448c4)
        + modules/plugin/jdbc/jdbc-oracle/src/main/java/org/geotools/data/oracle/OracleFilterToSQL.java
          [OracleFilterToSQL.java](#diff-550ea58c49aebbb8133c96f183efa40be7a456ed921f98820d6dff139e0f79a7)
      * test/java/org/geotools/data/oracle

        + modules/plugin/jdbc/jdbc-oracle/src/test/java/org/geotools/data/oracle/OracleFilterToSqlTest.java
          [OracleFilterToSqlTest.java](#diff-b5a037cb29d071d551a56f8c16d6637e2eee165df1e676ff2d7b1de9b83694af)
    - jdbc-postgis/src

      * main/java/org/geotools/data/postgis

        + modules/plugin/jdbc/jdbc-postgis/src/main/java/org/geotools/data/postgis/FilterToSqlHelper.java
          [FilterToSqlHelper.java](#diff-0c3c5b417a703499b63002a66fe41dc8de036bf871f822ba6016d391177d7036)
        + modules/plugin/jdbc/jdbc-postgis/src/main/java/org/geotools/data/postgis/PostGISDialect.java
          [PostGISDialect.java](#diff-78dcdaf922d032b77d065884b6e2fd6b2b7d90cdee6f2974b7d041c46ad03350)
        + modules/plugin/jdbc/jdbc-postgis/src/main/java/org/geotools/data/postgis/PostGISPSDialect.java
          [PostGISPSDialect.java](#diff-5cec64f3f3a96c3dd6fbeb4ac6f7d4cb50d8b533f61745d78fbdc4f65eada38c)
        + modules/plugin/jdbc/jdbc-postgis/src/main/java/org/geotools/data/postgis/PostgisNGDataStoreFactory.java
          [PostgisNGDataStoreFactory.java](#diff-dc3b8ce529ddec4c0796ba0c5dfd354f80f7c02b55deac45a57c873e14f612fd)
      * test/java/org/geotools/data/postgis

        + modules/plugin/jdbc/jdbc-postgis/src/test/java/org/geotools/data/postgis/PostgisFilterToSQLTest.java
          [PostgisFilterToSQLTest.java](#diff-f386bfb6594693b19eee733cccf6b86925e49d4916c1bc1ea0807a7ae48b5c81)
        + modules/plugin/jdbc/jdbc-postgis/src/test/java/org/geotools/data/postgis/PostgisNGDataStoreFactoryTest.java
          [PostgisNGDataStoreFactoryTest.java](#diff-46d34de7510bc996ea201cec54d359f8aa332b2ccd1f0abe9e8a872a149f9ba6)

## There are no files selected for viewing

40 changes: 28 additions & 12 deletions

40
[modules/library/jdbc/src/main/java/org/geotools/data/jdbc/FilterToSQL.java](#diff-bd6d9db0d247e2fa5b149e6e281e39d27da9eecb7b755cb5f9be01aa975aca2e "modules/library/jdbc/src/main/java/org/geotools/data/jdbc/FilterToSQL.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/jdbc/src/main/java/org/geotools/data/jdbc/FilterToSQL.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -45,6 +45,7 @@ |
|  |  | import org.geotools.filter.function.InFunction; |
|  |  | import org.geotools.filter.spatial.BBOXImpl; |
|  |  | import org.geotools.jdbc.EnumMapper; |
|  |  | import org.geotools.jdbc.EscapeSql; |
|  |  | import org.geotools.jdbc.JDBCDataStore; |
|  |  | import org.geotools.jdbc.JoinId; |
|  |  | import org.geotools.jdbc.JoinPropertyName; |
| Expand Down  Expand Up | | @@ -230,6 +231,9 @@ public class FilterToSQL implements FilterVisitor, ExpressionVisitor { |
|  |  | /\*\* Whether the encoder should try to encode "in" function into a SQL IN operator \*/ |
|  |  | protected boolean inEncodingEnabled = true; |
|  |  |  |
|  |  | /\*\* Whether to escape backslash characters in string literals \*/ |
|  |  | protected boolean escapeBackslash = false; |
|  |  |  |
|  |  | /\*\* Default constructor \*/ |
|  |  | public FilterToSQL() {} |
|  |  |  |
| Expand Down  Expand Up | | @@ -265,6 +269,16 @@ public void setInEncodingEnabled(boolean inEncodingEnabled) { |
|  |  | this.inEncodingEnabled = inEncodingEnabled; |
|  |  | } |
|  |  |  |
|  |  | /\*\* @return whether to escape backslash characters in string literals \*/ |
|  |  | public boolean isEscapeBackslash() { |
|  |  | return escapeBackslash; |
|  |  | } |
|  |  |  |
|  |  | /\*\* @param escapeBackslash whether to escape backslash characters in string literals \*/ |
|  |  | public void setEscapeBackslash(boolean escapeBackslash) { |
|  |  | this.escapeBackslash = escapeBackslash; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Performs the encoding, sends the encoded sql to the writer passed in. |
|  |  | \* |
| Expand Down  Expand Up | | @@ -529,7 +543,8 @@ public Object visit(PropertyIsLike filter, Object extraData) { |
|  |  | literal += multi; |
|  |  | } |
|  |  |  |
|  |  | String pattern = LikeFilterImpl.convertToSQL92(esc, multi, single, matchCase, literal); |
|  |  | String pattern = |
|  |  | LikeFilterImpl.convertToSQL92(esc, multi, single, matchCase, literal, false); |
|  |  |  |
|  |  | try { |
|  |  | if (!matchCase) { |
| Expand All | | @@ -539,13 +554,12 @@ public Object visit(PropertyIsLike filter, Object extraData) { |
|  |  | att.accept(this, extraData); |
|  |  |  |
|  |  | if (!matchCase) { |
|  |  | out.write(") LIKE '"); |
|  |  | out.write(") LIKE "); |
|  |  | } else { |
|  |  | out.write(" LIKE '"); |
|  |  | out.write(" LIKE "); |
|  |  | } |
|  |  |  |
|  |  | out.write(pattern); |
|  |  | out.write("' "); |
|  |  | writeLiteral(pattern); |
|  |  | } catch (java.io.IOException ioe) { |
|  |  | throw new RuntimeException(IO\_ERROR, ioe); |
|  |  | } |
| Expand Down  Expand Up | | @@ -1170,11 +1184,8 @@ public Object visit(Id filter, Object extraData) { |
|  |  | out.write("."); |
|  |  | } |
|  |  | out.write(escapeName(columns.get(j).getName())); |
|  |  | out.write(" = '"); |
|  |  | out.write( |
|  |  | attValues.get(j).toString()); // DJB: changed this to attValues[j] from |
|  |  | // attValues[i]. |
|  |  | out.write("'"); |
|  |  | out.write(" = "); |
|  |  | writeLiteral(attValues.get(j)); |
|  |  |  |
|  |  | if (j < (attValues.size() - 1)) { |
|  |  | out.write(" AND "); |
| Expand Down  Expand Up | | @@ -1747,12 +1758,17 @@ protected void writeLiteral(Object literal) throws IOException { |
|  |  | encoding = literal.toString(); |
|  |  | } |
|  |  |  |
|  |  | // sigle quotes must be escaped to have a valid sql string |
|  |  | String escaped = encoding.replaceAll("'", "''"); |
|  |  | // single quotes must be escaped to have a valid sql string |
|  |  | String escaped = escapeLiteral(encoding); |
|  |  | out.write("'" + escaped + "'"); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* Escapes the string literal. \*/ |
|  |  | public String escapeLiteral(String literal) { |
|  |  | return EscapeSql.escapeLiteral(literal, escapeBackslash, false); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Subclasses must implement this method in order to encode geometry filters according to the |
|  |  | \* specific database implementation |
| Expand Down | |  |

24 changes: 24 additions & 0 deletions

24
[modules/library/jdbc/src/main/java/org/geotools/jdbc/EscapeSql.java](#diff-9c2f3a1daafd589eb6305170ffa40db051aeda5ae26c22b3438ba5923b451ab7 "modules/library/jdbc/src/main/java/org/geotools/jdbc/EscapeSql.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/jdbc/src/main/java/org/geotools/jdbc/EscapeSql.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -16,6 +16,8 @@ |
|  |  | \*/ |
|  |  | package org.geotools.jdbc; |
|  |  |  |
|  |  | import java.util.regex.Pattern; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Perform basic SQL validation on input string. This is to allow safe encoding of parameters that |
|  |  | \* must contain quotes, while still protecting users from SQL injection. |
| Expand All | | @@ -24,6 +26,28 @@ |
|  |  | \* quotes. Backslashes are too risky to allow so are removed completely |
|  |  | \*/ |
|  |  | public class EscapeSql { |
|  |  |  |
|  |  | private static final Pattern SINGLE\_QUOTE\_PATTERN = Pattern.compile("'"); |
|  |  |  |
|  |  | private static final Pattern DOUBLE\_QUOTE\_PATTERN = Pattern.compile("\""); |
|  |  |  |
|  |  | private static final Pattern BACKSLASH\_PATTERN = Pattern.compile("\\\\"); |
|  |  |  |
|  |  | public static String escapeLiteral( |
|  |  | String literal, boolean escapeBackslash, boolean escapeDoubleQuote) { |
|  |  | // ' --> '' |
|  |  | String escaped = SINGLE\_QUOTE\_PATTERN.matcher(literal).replaceAll("''"); |
|  |  | if (escapeBackslash) { |
|  |  | // \ --> \\ |
|  |  | escaped = BACKSLASH\_PATTERN.matcher(escaped).replaceAll("\\\\\\\\"); |
|  |  | } |
|  |  | if (escapeDoubleQuote) { |
|  |  | // " --> \" |
|  |  | escaped = DOUBLE\_QUOTE\_PATTERN.matcher(escaped).replaceAll("\\\\\""); |
|  |  | } |
|  |  | return escaped; |
|  |  | } |
|  |  |  |
|  |  | public static String escapeSql(String str) { |
|  |  |  |
|  |  | // ' --> '' |
| Expand Down | |  |

86 changes: 86 additions & 0 deletions

86
[modules/library/jdbc/src/main/java/org/geotools/jdbc/SQLDialect.java](#diff-06ea10ce30449e1b7b5c364a2ab00a5dc3dc23f13ce309e6ff02a1791f9faf92 "modules/library/jdbc/src/main/java/org/geotools/jdbc/SQLDialect.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/jdbc/src/main/java/org/geotools/jdbc/SQLDialect.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ |
|  |  | import java.sql.Timestamp; |
|  |  | import java.sql.Types; |
|  |  | import java.util.ArrayList; |
|  |  | import java.util.HashMap; |
|  |  | import java.util.LinkedHashMap; |
|  |  | import java.util.List; |
|  |  | import java.util.Map; |
| Expand All | | @@ -39,6 +40,8 @@ |
|  |  | import java.util.logging.Logger; |
|  |  | import org.geotools.data.Join.Type; |
|  |  | import org.geotools.data.Query; |
|  |  | import org.geotools.data.jdbc.datasource.DataSourceFinder; |
|  |  | import org.geotools.data.jdbc.datasource.UnWrapper; |
|  |  | import org.geotools.feature.visitor.AverageVisitor; |
|  |  | import org.geotools.feature.visitor.CountVisitor; |
|  |  | import org.geotools.feature.visitor.FeatureAttributeVisitor; |
| Expand Down  Expand Up | | @@ -164,6 +167,41 @@ public abstract class SQLDialect { |
|  |  | } |
|  |  | }; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Sentinel value used to mark that the unwrapper lookup happened already, and an unwrapper was |
|  |  | \* not found |
|  |  | \*/ |
|  |  | protected static final UnWrapper UNWRAPPER\_NOT\_FOUND = |
|  |  | new UnWrapper() { |
|  |  |  |
|  |  | @Override |
|  |  | public Statement unwrap(Statement statement) { |
|  |  | throw new UnsupportedOperationException(); |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public Connection unwrap(Connection conn) { |
|  |  | throw new UnsupportedOperationException(); |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public boolean canUnwrap(Statement st) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public boolean canUnwrap(Connection conn) { |
|  |  | return false; |
|  |  | } |
|  |  | }; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Map of {@code UnWrapper} objects keyed by the class of {@code Connection} it is an unwrapper |
|  |  | \* for. This avoids the overhead of searching the {@code DataSourceFinder} service registry at |
|  |  | \* each unwrap. |
|  |  | \*/ |
|  |  | protected final Map<Class<? extends Connection>, UnWrapper> uwMap = new HashMap<>(); |
|  |  |  |
|  |  | /\*\* The datastore using the dialect \*/ |
|  |  | protected JDBCDataStore dataStore; |
|  |  |  |
| Expand Down  Expand Up | | @@ -1415,4 +1453,52 @@ public boolean canGroupOnGeometry() { |
|  |  | public Class<?> getMapping(String sqlTypeName) { |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | /\*\* Obtains the native connection object given a database connection. \*/ |
|  |  | @SuppressWarnings("PMD.CloseResource") |
|  |  | protected <T extends Connection> T unwrapConnection(Connection cx, Class<T> clazz) |
|  |  | throws SQLException { |
|  |  | if (clazz.isInstance(cx)) { |
|  |  | return clazz.cast(cx); |
|  |  | } |
|  |  | try { |
|  |  | // Unwrap the connection multiple levels as necessary to get at the underlying |
|  |  | // connection. Maintain a map of UnWrappers to avoid searching the registry |
|  |  | // every time we need to unwrap. |
|  |  | Connection testCon = cx; |
|  |  | Connection toUnwrap; |
|  |  | do { |
|  |  | UnWrapper unwrapper = uwMap.get(testCon.getClass()); |
|  |  | if (unwrapper == null) { |
|  |  | unwrapper = DataSourceFinder.getUnWrapper(testCon); |
|  |  | if (unwrapper == null) { |
|  |  | unwrapper = UNWRAPPER\_NOT\_FOUND; |
|  |  | } |
|  |  | uwMap.put(testCon.getClass(), unwrapper); |
|  |  | } |
|  |  | if (unwrapper == UNWRAPPER\_NOT\_FOUND) { |
|  |  | // give up and do Java unwrap below |
|  |  | break; |
|  |  | } |
|  |  | toUnwrap = testCon; |
|  |  | testCon = unwrapper.unwrap(testCon); |
|  |  | if (clazz.isInstance(testCon)) { |
|  |  | return clazz.cast(cx); |
|  |  | } |
|  |  | } while (testCon != null && testCon != toUnwrap); |
|  |  | // try to use Java unwrapping |
|  |  | try { |
|  |  | if (cx.isWrapperFor(clazz)) { |
|  |  | return cx.unwrap(clazz); |
|  |  | } |
|  |  | } catch (Throwable t) { |
|  |  | // not a mistake, old DBCP versions will throw an Error here, we need to catch it |
|  |  | LOGGER.log(Level.FINER, "Failed to unwrap connection using Java facilities", t); |
|  |  | } |
|  |  | } catch (IOException e) { |
|  |  | throw new SQLException( |
|  |  | "Could not obtain " + clazz.getName() + " from " + cx.getClass(), e); |
|  |  | } |
|  |  | throw new SQLException("Could not obtain " + clazz.getName() + " from " + cx.getClass()); |
|  |  | } |
|  |  | } |

14 changes: 14 additions & 0 deletions

14
[modules/library/jdbc/src/test/java/org/geotools/data/jdbc/FilterToSQLTest.java](#diff-72a6758b0e8fe51dfc8d8908fb229c2ab458b5aae08904788e342792acc07d66 "modules/library/jdbc/src/test/java/org/geotools/data/jdbc/FilterToSQLTest.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/jdbc/src/test/java/org/geotools/data/jdbc/FilterToSQLTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -465,4 +465,18 @@ public void testEscapeName() { |
|  |  | encoder.setSqlNameEscape(""); |
|  |  | Assert.assertEquals("abc", encoder.escapeName("abc")); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testLikeEscaping() throws Exception { |
|  |  | Filter filter = ff.like(ff.property("testString"), "\\'FOO", "%", "-", "\\", true); |
|  |  | FilterToSQL encoder = new FilterToSQL(output); |
|  |  | Assert.assertEquals("WHERE testString LIKE '''FOO'", encoder.encodeToString(filter)); |
|  |  | } |
|  |  |  |
|  |  | @Test |
|  |  | public void testIdEscaping() throws Exception { |
|  |  | Id id = ff.id(Collections.singleton(ff.featureId("'FOO"))); |
|  |  | encoder.encode(id); |
|  |  | Assert.assertEquals("WHERE (id = '''FOO')", output.toString()); |
|  |  | } |
|  |  | } |

44 changes: 41 additions & 3 deletions

44
[modules/library/main/src/main/java/org/geotools/filter/LikeFilterImpl.java](#diff-c6d93734739add8b8b53d0eb9a7c04abb52dad436d30261b7f3f78fb61ab254f "modules/library/main/src/main/java/org/geotools/filter/LikeFilterImpl.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/main/src/main/java/org/geotools/filter/LikeFilterImpl.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -79,13 +79,49 @@ public class LikeFilterImpl extends AbstractFilter implements PropertyIsLike { |
|  |  | \* have a special char as another special char. Using this will throw an error |
|  |  | \* (IllegalArgumentException). |
|  |  | \*/ |
|  |  | @Deprecated |
|  |  | public static String convertToSQL92( |
|  |  | char escape, char multi, char single, boolean matchCase, String pattern) |
|  |  | throws IllegalArgumentException { |
|  |  | return convertToSQL92(escape, multi, single, matchCase, pattern, true); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Given OGC PropertyIsLike Filter information, construct an SQL-compatible 'like' pattern. |
|  |  | \* |
|  |  | \* <p>SQL % --> match any number of characters \_ --> match a single character |
|  |  | \* |
|  |  | \* <p>NOTE; the SQL command is 'string LIKE pattern [ESCAPE escape-character]' We could |
|  |  | \* re-define the escape character, but I'm not doing to do that in this code since some |
|  |  | \* databases will not handle this case. |
|  |  | \* |
|  |  | \* <p>Method: 1. |
|  |  | \* |
|  |  | \* <p>Examples: ( escape ='!', multi='\*', single='.' ) broadway\* -> 'broadway%' broad\_ay -> |
|  |  | \* 'broad\_ay' broadway -> 'broadway' |
|  |  | \* |
|  |  | \* <p>broadway!\* -> 'broadway\*' (\* has no significance and is escaped) can't -> 'can''t' ( ' |
|  |  | \* escaped for SQL compliance) |
|  |  | \* |
|  |  | \* <p>NOTE: when the escapeSingleQuote parameter is false, this method will not convert ' to '' |
|  |  | \* (double single quote) and it is the caller's responsibility to ensure that the resulting |
|  |  | \* pattern is used safely in SQL queries. |
|  |  | \* |
|  |  | \* <p>NOTE: we dont handle "'" as a 'special' character because it would be too confusing to |
|  |  | \* have a special char as another special char. Using this will throw an error |
|  |  | \* (IllegalArgumentException). |
|  |  | \*/ |
|  |  | public static String convertToSQL92( |
|  |  | char escape, |
|  |  | char multi, |
|  |  | char single, |
|  |  | boolean matchCase, |
|  |  | String pattern, |
|  |  | boolean escapeSingleQuote) { |
|  |  | if ((escape == '\'') || (multi == '\'') || (single == '\'')) |
|  |  | throw new IllegalArgumentException("do not use single quote (') as special char!"); |
|  |  |  |
|  |  | StringBuffer result = new StringBuffer(pattern.length() + 5); |
|  |  | StringBuilder result = new StringBuilder(pattern.length() + 5); |
|  |  | for (int i = 0; i < pattern.length(); i++) { |
|  |  | char chr = pattern.charAt(i); |
|  |  | if (chr == escape) { |
| Expand All | | @@ -96,7 +132,7 @@ public static String convertToSQL92( |
|  |  | result.append('\_'); |
|  |  | } else if (chr == multi) { |
|  |  | result.append('%'); |
|  |  | } else if (chr == '\'') { |
|  |  | } else if (chr == '\'' && escapeSingleQuote) { |
|  |  | result.append('\''); |
|  |  | result.append('\''); |
|  |  | } else { |
| Expand All | | @@ -108,6 +144,7 @@ public static String convertToSQL92( |
|  |  | } |
|  |  |  |
|  |  | /\*\* see convertToSQL92 \*/ |
|  |  | @Deprecated |
|  |  | public String getSQL92LikePattern() throws IllegalArgumentException { |
|  |  | if (escape.length() != 1) { |
|  |  | throw new IllegalArgumentException( |
| Expand All | | @@ -126,7 +163,8 @@ public String getSQL92LikePattern() throws IllegalArgumentException { |
|  |  | wildcardMulti.charAt(0), |
|  |  | wildcardSingle.charAt(0), |
|  |  | matchingCase, |
|  |  | pattern); |
|  |  | pattern, |
|  |  | true); |
|  |  | } |
|  |  |  |
|  |  | public void setWildCard(String wildCard) { |
| Expand Down | |  |

28 changes: 18 additions & 10 deletions

28
[modules/library/main/src/test/java/org/geotools/filter/FilterTest.java](#diff-210392731fc74be9635ceb5e104b246e9c6a578c27d7641ceb79a3c6375878f7 "modules/library/main/src/test/java/org/geotools/filter/FilterTest.java")

Show comments

[View file](/geotools/geotools/blob/64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b/modules/library/main/src/test/java/org/geotools/filter/FilterTest.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -187,29 +187,37 @@ public void setUp() throws SchemaException { |
|  |  | @Test |
|  |  | public void testLikeToSQL() { |
|  |  | Assert.assertEquals( |
|  |  | "BroadWay%", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "BroadWay\*")); |
|  |  | "BroadWay%", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "BroadWay\*", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broad#ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad#ay")); |
|  |  | "broad#ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad#ay", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broadway", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway")); |
|  |  | "broadway", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway", true)); |
|  |  |  |
|  |  | Assert.assertEquals( |
|  |  | "broad\_ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad.ay")); |
|  |  | "broad\_ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad.ay", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broad.ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad!.ay")); |
|  |  | "broad.ay", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broad!.ay", true)); |
|  |  |  |
|  |  | Assert.assertEquals( |
|  |  | "broa''dway", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa'dway")); |
|  |  | "broa''dway", |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa'dway", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broa''''dway", |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa" + "''dway")); |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa" + "''dway", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broa'dway", |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa'dway", false)); |
|  |  | Assert.assertEquals( |
|  |  | "broa''dway", |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broa" + "''dway", false)); |
|  |  |  |
|  |  | Assert.assertEquals( |
|  |  | "broadway\_", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway.")); |
|  |  | "broadway\_", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway.", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broadway", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway!")); |
|  |  | "broadway", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway!", true)); |
|  |  | Assert.assertEquals( |
|  |  | "broadway!", LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway!!")); |
|  |  | "broadway!", |
|  |  | LikeFilterImpl.convertToSQL92('!', '\*', '.', true, "broadway!!", true)); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `64fb4c4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgeotools%2Fgeotools%2Fcommit%2F64fb4c47f43ca818c2fe96a94651bff1b3b3ed2b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_9201d5b6_20250115_090614.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgeotools%2Fgeotools%2Fsecurity%2Fadvisories%2FGHSA-99c3-qc2q-p94m)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgeotools%2Fgeotools%2Fsecurity%2Fadvisories%2FGHSA-99c3-qc2q-p94m)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=geotools%2Fgeotools)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[geotools](/geotools)
/
**[geotools](/geotools/geotools)**
Public

* [Notifications](/login?return_to=%2Fgeotools%2Fgeotools) You must be signed in to change notification settings
* [Fork
  1.2k](/login?return_to=%2Fgeotools%2Fgeotools)
* [Star
   1.8k](/login?return_to=%2Fgeotools%2Fgeotools)

* [Code](/geotools/geotools)
* [Pull requests
  3](/geotools/geotools/pulls)
* [Actions](/geotools/geotools/actions)
* [Projects
  0](/geotools/geotools/projects)
* [Wiki](/geotools/geotools/wiki)
* [Security](/geotools/geotools/security)
* [Insights](/geotools/geotools/pulse)

Additional navigation options

* [Code](/geotools/geotools)
* [Pull requests](/geotools/geotools/pulls)
* [Actions](/geotools/geotools/actions)
* [Projects](/geotools/geotools/projects)
* [Wiki](/geotools/geotools/wiki)
* [Security](/geotools/geotools/security)
* [Insights](/geotools/geotools/pulse)

# OGC Filter SQL Injection Vulnerabilities

Critical

[jodygarnett](/jodygarnett)
published
GHSA-99c3-qc2q-p94m
Feb 21, 2023

## Package

maven

org.geotools.jdbc
([Maven](/advisories?query=ecosystem%3Amaven))

## Affected versions

< 28.2, < 27.4, <26.7, <25.7, <24.7

## Patched versions

28.2, 27.4, 26.7, 25.7,24.7

## Description

### Impact

GeoTools includes support for OGC Filter expression language parsing, encoding and execution against a range of datastore.

SQL Injection Vulnerabilities have been found when executing OGC Filters with JDBCDataStore implementations:

1. `PropertyIsLike` filter
   * Requires PostGIS DataStore with "encode functions" enabled
   * Or any JDBCDataStore (all relational databases) with String field (no mitigation)
2. `strEndsWith` function
   * Requires PostGIS DataStore with "encode functions" enabled
3. `strStartsWith` function
   * Requires PostGIS DataStore with "encode functions" enabled
4. `FeatureId` filter
   * Requires JDBCDataStore (all relational databases) with prepared statements disabled and table with String primary key (Oracle not affected, SQL Server and MySQL have no settings to enabled prepared statements, PostGIS does)
5. `jsonArrayContains` function
   * Requires PostGIS and Oracle DataStore with String or JSON field
6. `DWithin` filter
   * Happens only in Oracle DataStore, no mitigation

### Patches

* GeoTools 28.2
* GeoTools 27.4
* GeoTools 26.7
* GeoTools 25.7
* GeoTools 24.7

### Workarounds

Partial mitigation:

* In PostGIS DataStore disable "encode functions"
* In any PostGIS enable "prepared statements" (only database with such settings)

```
        Map<String, Object> params = new HashMap<>();
        params.put("dbtype", "postgis");
        params.put("host", "localhost");
        params.put("port", 5432);
        params.put("schema", "public");
        params.put("database", "database");
        params.put("user", "postgres");
        params.put("passwd", "postgres");
        params.put("preparedStatements", true ); // mitigation
        params.put("encode functions", false ); // mitigation

        DataStore dataStore = DataStoreFinder.getDataStore(params);
```
### References

* [OGC Filter SQL Injection Vulnerabilities](https://github.com/geoserver/geoserver/security/advisories/GHSA-7g5f-wrx8-5ccf) (GeoServer)

### Severity

Critical

9.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2023-25158

### Weaknesses

[CWE-89](/advisories?query=cwe%3A89)

### Credits

* [![@sikeoka](https://avatars.githubusercontent.com/u/11542093?s=40&v=4)](/sikeoka)
  [sikeoka](/sikeoka)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


