=== Content from github.com_81be48b4_20250114_225238.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbndr%2Fpipreqs%2Fpull%2F364)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fbndr%2Fpipreqs%2Fpull%2F364)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=bndr%2Fpipreqs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[bndr](/bndr)
/
**[pipreqs](/bndr/pipreqs)**
Public

* [Notifications](/login?return_to=%2Fbndr%2Fpipreqs) You must be signed in to change notification settings
* [Fork
  404](/login?return_to=%2Fbndr%2Fpipreqs)
* [Star
   7k](/login?return_to=%2Fbndr%2Fpipreqs)

* [Code](/bndr/pipreqs)
* [Issues
  173](/bndr/pipreqs/issues)
* [Pull requests
  36](/bndr/pipreqs/pulls)
* [Actions](/bndr/pipreqs/actions)
* [Projects
  0](/bndr/pipreqs/projects)
* [Wiki](/bndr/pipreqs/wiki)
* [Security](/bndr/pipreqs/security)
* [Insights](/bndr/pipreqs/pulse)

Additional navigation options

* [Code](/bndr/pipreqs)
* [Issues](/bndr/pipreqs/issues)
* [Pull requests](/bndr/pipreqs/pulls)
* [Actions](/bndr/pipreqs/actions)
* [Projects](/bndr/pipreqs/projects)
* [Wiki](/bndr/pipreqs/wiki)
* [Security](/bndr/pipreqs/security)
* [Insights](/bndr/pipreqs/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fbndr%2Fpipreqs%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fbndr%2Fpipreqs%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Mitigation for dependency confusion in pipreqs #364

 Merged

[bndr](/bndr)
merged 9 commits into
[bndr:master](/bndr/pipreqs/tree/master "bndr/pipreqs:master")
from
[adeadfed:master](/adeadfed/pipreqs/tree/master "adeadfed/pipreqs:master")

Apr 13, 2023

 Merged

# [Mitigation for dependency confusion in pipreqs](#top) #364

[bndr](/bndr)
merged 9 commits into
[bndr:master](/bndr/pipreqs/tree/master "bndr/pipreqs:master")
from
[adeadfed:master](/adeadfed/pipreqs/tree/master "adeadfed/pipreqs:master")

Apr 13, 2023

[Conversation
3](/bndr/pipreqs/pull/364)
[Commits
9](/bndr/pipreqs/pull/364/commits)
[Checks
0](/bndr/pipreqs/pull/364/checks)
[Files changed](/bndr/pipreqs/pull/364/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![adeadfed](https://avatars.githubusercontent.com/u/54282598?s=60&v=4)](/adeadfed)

Copy link

Contributor

### @adeadfed **[adeadfed](/adeadfed)** commented [Apr 10, 2023](#issue-1661149082)

Hi folks! I am a security researcher, and I believe I have found a way to perform a dependency confusion attack on pipreqs. This pull request aims to mitigate a larger portion of the impact, however, there are still some caveats left (will be discussed later).

## Vulnerability description

**Impact:**¬†Arbitrary code execution on all machines running the Python code with requirements.txt file that includes one of the vulnerable packages and was generated through pipreqs.

**Difficulty:**¬†The exploit needs several prerequisites listed below.

### tl;dr

Pipreq's remote dependency resolving mechanism (lines [447](https://github.com/bndr/pipreqs/blob/master/pipreqs/pipreqs.py#L447)-[449](https://github.com/bndr/pipreqs/blob/master/pipreqs/pipreqs.py#L449)) can be abused to inject arbitrary packages into the final requirements.txt file.

There are three necessary conditions for triggering this behavior:

* PyPI package name (later - `pypi_package_name`) and the names of its exported Python modules (later on `exported_module_name`) must differ.
* `exported_module_name`:`pypi_package_name` mapping must be absent from the pipreq's hard-coded mapping file
* `exported_module_name` must be available at PyPI as a package name

### In-depth explanation

Let‚Äôs use the `djangorestframework-simplejwt` package as an example. It has over 1.3M monthly downloads, according to PyPIStats (<https://pypistats.org/packages/djangorestframework-simplejwt>). The package exports the `rest_framework_simplejwt` Python module.

Consider the following snippet of code from the above package's¬†[documentation](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html).

```
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)

urlpatterns = [
    ...
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    ...
]

```

When pipreqs is run on the code above, the following things happen:

1. Pipreqs extracts the imported module name (`rest_framework_simplejwt`) and places it into the `candidates` variable at line 425.

   [![Untitled](https://camo.githubusercontent.com/4d066062be90dc28282b57120afcd57045f7bbf3846de5c944eb153539917d14/68747470733a2f2f692e696d6775722e636f6d2f62735958424a4e2e706e67)](https://camo.githubusercontent.com/4d066062be90dc28282b57120afcd57045f7bbf3846de5c944eb153539917d14/68747470733a2f2f692e696d6775722e636f6d2f62735958424a4e2e706e67)
2. Pipreqs tries to find the `rest_framework_simplejwt` value in the mapping file at line 429 through the `get_pkg_names` function, but it isn‚Äôt there, so the script assumes that the package name is `rest_framework_simplejwt`.

   [![Untitled](https://camo.githubusercontent.com/7b7e699750f0119c8c9ce3e588ca47e66766b7e9651b8142d37000689c84ef5e/68747470733a2f2f692e696d6775722e636f6d2f506c775971316d2e706e67)](https://camo.githubusercontent.com/7b7e699750f0119c8c9ce3e588ca47e66766b7e9651b8142d37000689c84ef5e/68747470733a2f2f692e696d6775722e636f6d2f506c775971316d2e706e67)
3. The script tries to find the `rest_framework_simplejwt` module in the exports of all locally installed Python packages at line 445 by default.

   If the package `djangorestframework-simplejwt` is installed locally, the function will find it and assign it to the `local` variable.

   [![Untitled](https://camo.githubusercontent.com/3b044926c4d774a840f76ba7bd44214014c0529393744976504b9a9575f65521/68747470733a2f2f692e696d6775722e636f6d2f3269716a6e53392e706e67)](https://camo.githubusercontent.com/3b044926c4d774a840f76ba7bd44214014c0529393744976504b9a9575f65521/68747470733a2f2f692e696d6775722e636f6d2f3269716a6e53392e706e67)

   If not, the function will return an empty array.

   [![Untitled](https://camo.githubusercontent.com/266fc2e0c80b7dfff3ed5ea62b4640c33e0e9069313b596fdffe50ec51bc76fa/68747470733a2f2f692e696d6775722e636f6d2f67427770594e652e706e67)](https://camo.githubusercontent.com/266fc2e0c80b7dfff3ed5ea62b4640c33e0e9069313b596fdffe50ec51bc76fa/68747470733a2f2f692e696d6775722e636f6d2f67427770594e652e706e67)
4. Pipreqs then compares the names inside `candidates` and `local` variables to populate a `difference` variable at line 447.

   Since the `candidates` variable contains `rest_framework_simplejwt`, and the `local` variable is either empty or has the name of the PyPI package (`djangorestframework-simplejwt`), this comparison will always evaluate to `True`. Consequently, the code will simply copy the `candidates` entries into the `difference` variable.

   [![Untitled](https://camo.githubusercontent.com/0e78ca94ea5594cb13c64034e174606dc228b6f0991aa3ed23cb0bebb85e70d1/68747470733a2f2f692e696d6775722e636f6d2f586d46593474332e706e67)](https://camo.githubusercontent.com/0e78ca94ea5594cb13c64034e174606dc228b6f0991aa3ed23cb0bebb85e70d1/68747470733a2f2f692e696d6775722e636f6d2f586d46593474332e706e67)
5. Then `get_imports_info function` is triggered with the `difference`array (`['rest_framework_simplejwt']`). It tries to find PyPI packages with the same names as in the passed array.

   If a PyPI package name inside the `difference` array is missing from PyPI, the code will ignore it. However, if an attacker registers the name on PyPI, pipreqs will inject this malicious package to "requirements.txt". And, during the dependency installation, attacker-controlled code will be executed on the user's machine.

### Proof of Concept

I've created a PoC using the `rest_framework_simplejwt` module mentioned above (<https://pypi.org/project/rest-framework-simplejwt/>).

If you run pipreqs on the code above, you will see that my package is injected into the requirements.txt:

```
pipreqs --print
djangorestframework_simplejwt==5.2.2 <--- legitimate package
rest_framework_simplejwt==0.0.2¬† ¬† ¬† <--- malicious package

INFO: Successfully output requirements

```

In fact, this behavior above is the source of a 3y.o. open issue ([#218](https://github.com/bndr/pipreqs/issues/218)).

## What can be done about this?

This pull request reworks the local package resolution. In particular:

* `get_locally_installed_packages` function will now return local packages in a form of `{'name':'package_name','version':'package_version','exports':['exported_module_1', 'exported_module_2', ...]}`
* `get_import_local` function will now search `imports` list entries in the `exports` and `name` fields (to account for pipreqs `mapping`) of the reworked `get_locally_installed_packages` function output.
* `init` function will now compute the `difference` list entries (packages that are not found locally and have to be resolved remotely) accordingly to the changes made.

These 3 steps should improve the quality of the `requirements.txt` output for packages that are installed locally.

New pipreqs version's output for the same code above:

```
pipreqs --print
djangorestframework_simplejwt==5.2.2 <--- legitimate package only

INFO: Successfully output requirements

```

Unfortunately, there is still a fundamental issue with the Python packaging system that we cannot address in any way. `get_imports_info` function will anyway output a flawed requirements list if a correct package is not installed locally.

So, I added a warning message into the CLI output for users when using a remote resolution to check the list of the final requirements for the correct packages:

```
pipreqs --print
WARNING: Import named "rest_framework_simplejwt" not found locally. Trying to resolve it at the PyPI server.
WARNING: Import named "rest_framework_simplejwt" was resolved to "rest-framework-simplejwt:0.0.2" package (https://pypi.org/project/rest-framework-simplejwt/).
Please, verify manually the final list of requirements.txt to avoid possible dependency confusions.
rest_framework_simplejwt==0.0.2     <--- malicious package
INFO: Successfully output requirements

```

This bug is also a good reasoning to make `--use-local` flag a default option, and create a `--use-remote` flag to use a remote package name resolution. However, this change would violate one of the pipreqs' use cases, so I will leave this proposal for a public discussion.

Sorry, something went wrong.

All reactions

 [adeadfed](/adeadfed)
added 7 commits
[March 14, 2023 21:14](#commits-pushed-3f5964f)

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[fix name resolution for local packages](/bndr/pipreqs/pull/364/commits/3f5964fcb90ec6eb6df46d78e651a1b73538d0ba "fix name resolution for local packages")`

`[3f5964f](/bndr/pipreqs/pull/364/commits/3f5964fcb90ec6eb6df46d78e651a1b73538d0ba)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[improved version of local package resolving](/bndr/pipreqs/pull/364/commits/6cd9925a31adc75522f4c453169eba162654af70 "improved version of local package resolving")`

`[6cd9925](/bndr/pipreqs/pull/364/commits/6cd9925a31adc75522f4c453169eba162654af70)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[add warnings to for remote resolving mode](/bndr/pipreqs/pull/364/commits/da442e7a2a3664c6001144a68bfcb63d72d7d6b3 "add warnings to for remote resolving mode")`

`[da442e7](/bndr/pipreqs/pull/364/commits/da442e7a2a3664c6001144a68bfcb63d72d7d6b3)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[change warning messages](/bndr/pipreqs/pull/364/commits/50498d3cd4b6ffbe30e93894e44e60b73b63d2f0 "change warning messages")`

`[50498d3](/bndr/pipreqs/pull/364/commits/50498d3cd4b6ffbe30e93894e44e60b73b63d2f0)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[delete vscode related files from repo](/bndr/pipreqs/pull/364/commits/001ead91edea0837e9291176fce068f3e4f1211d "delete vscode related files from repo")`

`[001ead9](/bndr/pipreqs/pull/364/commits/001ead91edea0837e9291176fce068f3e4f1211d)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[remove invalid comment](/bndr/pipreqs/pull/364/commits/3ae82087f96ef1526ba1e0b93e0e7b7d72ddd669 "remove invalid comment")`

`[3ae8208](/bndr/pipreqs/pull/364/commits/3ae82087f96ef1526ba1e0b93e0e7b7d72ddd669)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[revert changes to .gitignore](/bndr/pipreqs/pull/364/commits/bb61883079ebbe45714d3cb5cd035b951bc10885 "revert changes to .gitignore")`

`[bb61883](/bndr/pipreqs/pull/364/commits/bb61883079ebbe45714d3cb5cd035b951bc10885)`

[![@bndr](https://avatars.githubusercontent.com/u/1145456?s=80&u=fe5733c293f25b3306fe1c9a72c7cf5efc21238a&v=4)](/bndr)

Copy link

Owner

### **[bndr](/bndr)** commented [Apr 13, 2023](#issuecomment-1506944490)

| Hey [@adeadfed](https://github.com/adeadfed), I'm ready to merge your fix once the linting issues are fixed.  Cheers, Vadim |
| --- |

All reactions

Sorry, something went wrong.

 [adeadfed](/adeadfed)
added 2 commits
[April 13, 2023 15:59](#commits-pushed-5537bcd)

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[fix pep8 linting issues](/bndr/pipreqs/pull/364/commits/5537bcd217eff939c2e1835a1cac928ce429056f "fix pep8 linting issues")`

`[5537bcd](/bndr/pipreqs/pull/364/commits/5537bcd217eff939c2e1835a1cac928ce429056f)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=40&v=4)](/adeadfed)

`[add whitespaces to pep8 formatted strings](/bndr/pipreqs/pull/364/commits/2103371746b727f6db341d301214d16c0dfba59b "add whitespaces to pep8 formatted strings")`

`[2103371](/bndr/pipreqs/pull/364/commits/2103371746b727f6db341d301214d16c0dfba59b)`

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=80&u=addf95c463464f3b7ac89f242e511b60802b957f&v=4)](/adeadfed)

Copy link

Contributor

Author

### **[adeadfed](/adeadfed)** commented [Apr 13, 2023](#issuecomment-1507036625)

| Thanks [@bndr](https://github.com/bndr)! I've fixed the PEP8 linting, should be good now. |
| --- |

All reactions

Sorry, something went wrong.

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [Apr 13, 2023](#issuecomment-1507316678)

|  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/bndr/pipreqs/pull/364?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) Report Patch coverage: **`100.00`**% and project coverage change: **`+0.25`** üéâ  Comparison is base [(`f97d8b9`)](https://codecov.io/gh/bndr/pipreqs/commit/f97d8b9ba4b5b1b0814f7e270d4ce6b705602b99?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) 86.71% compared to head [(`2103371`)](https://codecov.io/gh/bndr/pipreqs/pull/364?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) 86.97%.  üì£ This organization is not using Codecov‚Äôs [GitHub App Integration](https://github.com/apps/codecov). We recommend you install it so Codecov can continue to function properly for your repositories. [Learn more](https://about.codecov.io/blog/codecov-is-updating-its-github-integration/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) Additional details and impacted files ``` @@            Coverage Diff             @@ ##           master     #364      +/-   ## ========================================== + Coverage   86.71%   86.97%   +0.25%      ==========================================   Files           2        2                 Lines         256      261       +5      ========================================== + Hits          222      227       +5        Misses         34       34               ```  | [Impacted Files](https://codecov.io/gh/bndr/pipreqs/pull/364?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) | Coverage Œî |  | | --- | --- | --- | | [pipreqs/pipreqs.py](https://codecov.io/gh/bndr/pipreqs/pull/364?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-cGlwcmVxcy9waXByZXFzLnB5) | `86.82% <100.00%> (+0.26%)` | ‚¨ÜÔ∏è |   Help us with your feedback. Take ten seconds to tell us [how you rate us](https://about.codecov.io/nps?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). Have a feature suggestion? [Share it here.](https://app.codecov.io/gh/feedback/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None)  [‚òî View full report in Codecov by Sentry](https://codecov.io/gh/bndr/pipreqs/pull/364?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). üì¢ Do you have feedback about the report comment? [Let us know in this issue](https://about.codecov.io/codecov-pr-comment-feedback/?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). |

All reactions

Sorry, something went wrong.

[![@bndr](https://avatars.githubusercontent.com/u/1145456?s=40&u=fe5733c293f25b3306fe1c9a72c7cf5efc21238a&v=4)](/bndr)
[bndr](/bndr)
merged commit [`717d492`](/bndr/pipreqs/commit/717d4926bc6cd1d17aed88941ede18cfd9747fa9)
into
bndr:master

[Apr 13, 2023](https://github.com/bndr/pipreqs/pull/364#event-9000089388)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fbndr%2Fpipreqs%2Fpull%2F364)

Reviewers

No reviews

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

3 participants

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=52&v=4)](/adeadfed) [![@bndr](https://avatars.githubusercontent.com/u/1145456?s=52&v=4)](/bndr) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from gist.github.com_285b6509_20250114_225237.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe&source=header-gist)

[Sign¬†in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe) [Sign¬†up](/join?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@adeadfed](https://avatars.githubusercontent.com/u/54282598?s=64&v=4)](/adeadfed)

# [adeadfed](/adeadfed)/**[cve-2023-31543.md](/adeadfed/ccc834440af354a5638f889bee34bafe)**

Last active
July 13, 2023 00:39

Show Gist options

* [Download ZIP](/adeadfed/ccc834440af354a5638f889bee34bafe/archive/c69c419d34ed0213473dee8c0dde51480d58f33f.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/adeadfed/ccc834440af354a5638f889bee34bafe.js&quot;&gt;&lt;/script&gt;
* Save adeadfed/ccc834440af354a5638f889bee34bafe to your computer and use it in GitHub Desktop.

[Code](/adeadfed/ccc834440af354a5638f889bee34bafe)
[Revisions
3](/adeadfed/ccc834440af354a5638f889bee34bafe/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/adeadfed/ccc834440af354a5638f889bee34bafe.js&quot;&gt;&lt;/script&gt;

Save adeadfed/ccc834440af354a5638f889bee34bafe to your computer and use it in GitHub Desktop.

[Download ZIP](/adeadfed/ccc834440af354a5638f889bee34bafe/archive/c69c419d34ed0213473dee8c0dde51480d58f33f.zip)

Dependency confusion in pipreqs

 [Raw](/adeadfed/ccc834440af354a5638f889bee34bafe/raw/c69c419d34ed0213473dee8c0dde51480d58f33f/cve-2023-31543.md)

[**cve-2023-31543.md**](#file-cve-2023-31543-md)

# Info

Dependency confusion in pipreqs

| Software Link | [pipreqs](https://pypi.org/project/pipreqs/) |
| --- | --- |
| Affected Versions | 0.3.0 - 0.4.12 |
| Tested on | pipreqs 0.4.11 |
| Vulnerable Components | [pipreqs/pipreqs.py#L447-L449](https://github.com/bndr/pipreqs/blob/master/pipreqs/pipreqs.py#L447) |
| CVSS 3.1 | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| CVE | CVE-2023-31543 |

# Summary

Pipreqs's [remote dependency resolving mechanism (lines 447-449)](https://github.com/bndr/pipreqs/blob/master/pipreqs/pipreqs.py#L447) can be abused to inject arbitrary packages into the final requirements.txt file, leading to a dependency confusion attack and subsequent arbitrary code execution on machines running the Python code with requirements, generated by the vulnerable version of pipreqs.

There are three important conditions that have to be met by an attacker to perform the package confusion. (see details section)

# Mitigation

The issue was mitigated in the minor [pipreqs 0.4.13 release](https://github.com/bndr/pipreqs/releases/tag/v0.4.13) on April 14th 2023.
pipreqs now has an improved local dependency resolving mechanism that accounts for possible PyPI package <-> Python module name mismatches. Additionally, when the remote resolving mechanism is used, the application will put up a warning message to ensure the developers will manually review the output.

[Merge request with corresponding fixes](https://github.com/bndr/pipreqs/pull/364)

# Details

The attack exploits the mismatches in the naming of PyPI packages and the nested Python modules within. Necessary prerequisites that would allow an attacker to attack a given PyPI package include:

* PyPI package name (later - `pypi_package_name`) and the names of its exported Python modules (later on `exported_module_name`) must differ.
* `exported_module_name`:`pypi_package_name` mapping must be absent from the pipreq's hard-coded mapping file
* `exported_module_name` must be available at PyPI as a package name

Let‚Äôs use the `djangorestframework-simplejwt` package as an example. It has over 1.3M monthly downloads, according to PyPIStats (<https://pypistats.org/packages/djangorestframework-simplejwt>). The package exports the `rest_framework_simplejwt` Python module.

Consider the following snippet of code from the above package's¬†[documentation](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html).

```
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)

urlpatterns = [
    ...
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    ...
]

```

When pipreqs is run on the code above, the following things happen:

1. Pipreqs extracts the imported module name (`rest_framework_simplejwt`) and places it into the `candidates` variable at line 425.

   [![Untitled](https://camo.githubusercontent.com/4d066062be90dc28282b57120afcd57045f7bbf3846de5c944eb153539917d14/68747470733a2f2f692e696d6775722e636f6d2f62735958424a4e2e706e67)](https://camo.githubusercontent.com/4d066062be90dc28282b57120afcd57045f7bbf3846de5c944eb153539917d14/68747470733a2f2f692e696d6775722e636f6d2f62735958424a4e2e706e67)
2. Pipreqs tries to find the `rest_framework_simplejwt` value in the mapping file at line 429 through the `get_pkg_names` function, but it isn‚Äôt there, so the script assumes that the package name is `rest_framework_simplejwt`.

   [![Untitled](https://camo.githubusercontent.com/7b7e699750f0119c8c9ce3e588ca47e66766b7e9651b8142d37000689c84ef5e/68747470733a2f2f692e696d6775722e636f6d2f506c775971316d2e706e67)](https://camo.githubusercontent.com/7b7e699750f0119c8c9ce3e588ca47e66766b7e9651b8142d37000689c84ef5e/68747470733a2f2f692e696d6775722e636f6d2f506c775971316d2e706e67)
3. The script tries to find the `rest_framework_simplejwt` module in the exports of all locally installed Python packages at line 445 by default.

   If the package `djangorestframework-simplejwt` is installed locally, the function will find it and assign it to the `local` variable.

   [![Untitled](https://camo.githubusercontent.com/3b044926c4d774a840f76ba7bd44214014c0529393744976504b9a9575f65521/68747470733a2f2f692e696d6775722e636f6d2f3269716a6e53392e706e67)](https://camo.githubusercontent.com/3b044926c4d774a840f76ba7bd44214014c0529393744976504b9a9575f65521/68747470733a2f2f692e696d6775722e636f6d2f3269716a6e53392e706e67)

   If not, the function will return an empty array.

   [![Untitled](https://camo.githubusercontent.com/266fc2e0c80b7dfff3ed5ea62b4640c33e0e9069313b596fdffe50ec51bc76fa/68747470733a2f2f692e696d6775722e636f6d2f67427770594e652e706e67)](https://camo.githubusercontent.com/266fc2e0c80b7dfff3ed5ea62b4640c33e0e9069313b596fdffe50ec51bc76fa/68747470733a2f2f692e696d6775722e636f6d2f67427770594e652e706e67)
4. Pipreqs then compares the names inside `candidates` and `local` variables to populate a `difference` variable at line 447.

   Since the `candidates` variable contains `rest_framework_simplejwt`, and the `local` variable is either empty or has the name of the PyPI package (`djangorestframework-simplejwt`), this comparison will always evaluate to `True`. Consequently, the code will simply copy the `candidates` entries into the `difference` variable.

   [![Untitled](https://camo.githubusercontent.com/0e78ca94ea5594cb13c64034e174606dc228b6f0991aa3ed23cb0bebb85e70d1/68747470733a2f2f692e696d6775722e636f6d2f586d46593474332e706e67)](https://camo.githubusercontent.com/0e78ca94ea5594cb13c64034e174606dc228b6f0991aa3ed23cb0bebb85e70d1/68747470733a2f2f692e696d6775722e636f6d2f586d46593474332e706e67)
5. Then `get_imports_info function` is triggered with the `difference`array (`['rest_framework_simplejwt']`). It tries to find PyPI packages with the same names as in the passed array.

   If a PyPI package name inside the `difference` array is missing from PyPI, the code will ignore it. However, if an attacker registers the name on PyPI, pipreqs will inject this malicious package to "requirements.txt". And, during the dependency installation, attacker-controlled code will be executed on the user's machine.

# Proof of Concept

I've created a PoC using the `rest_framework_simplejwt` module mentioned above (<https://pypi.org/project/rest-framework-simplejwt/>).

If you run pipreqs on the code above, you will see that my package is injected into the requirements.txt:

```
pipreqs --print
djangorestframework_simplejwt==5.2.2 <--- legitimate package
rest_framework_simplejwt==0.0.2¬† ¬† ¬† <--- malicious package

INFO: Successfully output requirements

```

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2Fadeadfed%2Fccc834440af354a5638f889bee34bafe)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


