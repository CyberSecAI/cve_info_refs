=== Content from github.com_9da58cf1_20250114_224907.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fissues%2F1378)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fissues%2F1378)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=pymumu%2Fsmartdns)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pymumu](/pymumu)
/
**[smartdns](/pymumu/smartdns)**
Public

* [Notifications](/login?return_to=%2Fpymumu%2Fsmartdns) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2Fpymumu%2Fsmartdns)
* [Star
   8.6k](/login?return_to=%2Fpymumu%2Fsmartdns)

* [Code](/pymumu/smartdns)
* [Issues
  179](/pymumu/smartdns/issues)
* [Pull requests
  3](/pymumu/smartdns/pulls)
* [Discussions](/pymumu/smartdns/discussions)
* [Actions](/pymumu/smartdns/actions)
* [Projects
  0](/pymumu/smartdns/projects)
* [Security](/pymumu/smartdns/security)
* [Insights](/pymumu/smartdns/pulse)

Additional navigation options

* [Code](/pymumu/smartdns)
* [Issues](/pymumu/smartdns/issues)
* [Pull requests](/pymumu/smartdns/pulls)
* [Discussions](/pymumu/smartdns/discussions)
* [Actions](/pymumu/smartdns/actions)
* [Projects](/pymumu/smartdns/projects)
* [Security](/pymumu/smartdns/security)
* [Insights](/pymumu/smartdns/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpymumu%2Fsmartdns%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpymumu%2Fsmartdns%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# SmartDNS Vulnerability Report #1378

Closed

[htejeda](/htejeda) opened this issue
Apr 22, 2023
· 2 comments

Closed

# [SmartDNS Vulnerability Report](#top) #1378

[htejeda](/htejeda) opened this issue
Apr 22, 2023
· 2 comments

## Comments

[![@htejeda](https://avatars.githubusercontent.com/u/2684910?s=80&v=4)](/htejeda)

Copy link

### **[htejeda](/htejeda)** commented [Apr 22, 2023](#issue-1679238240)

| Hello,  I'm writing to report a security vulnerability I've discovered, which affects all releases of SmartDNS. This vulnerability can be exploited by an attacker to cause a denial of service (crash) or remotely execute arbitrary code (RCE) on the server by crafting a special DNS request.  *Tested on:* *Ubuntu 22.04.2 LTS* *gcc version 11.3.0 (Ubuntu 11.3.0-1ubuntu1~22.04)* *clang version 15.0.7*  **Technical Details:**  A stack buffer overflow vulnerability exists in the ***\_dns\_encode\_domain*** function in the ***dns.c*** file, which can be triggered by crafting a DNS request that causes the program to write outside the bounds of the ***packet\_buff*** variable.  You can find the AddressSanitizer (ASAN) output and the GDB backtrace from a production server below for your reference. If it helps confirm if the patches to your code fix the vulnerability, I can also share a trigger file containing a DNS payload that causes a crash with the project maintainer, and to ensure the security of this sensitive information, I will share the trigger file via a secure method, so it is not exposed publicly.  **ASAN Output:**  ``` ================================================================= ==2457317==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7fffffffdd8e at pc 0x000000305a31 bp 0x7fffffffaf00 sp 0x7fffffffaef8 WRITE of size 1 at 0x7fffffffdd8e thread T0     #0 0x305a30 in _dns_encode_domain /opt/smartdns/src/dns.c:298:11     #1 0x30bdea in _dns_add_qr_head /opt/smartdns/src/dns.c:461:12     #2 0x30bdea in _dns_add_rr_head /opt/smartdns/src/dns.c:509:8     #3 0x30bdea in dns_add_rr_nested_start /opt/smartdns/src/dns.c:568:8     #4 0x30bdea in dns_add_HTTPS_start /opt/smartdns/src/dns.c:1074:20     #5 0x30bdea in _dns_decode_HTTPS /opt/smartdns/src/dns.c:2007:2     #6 0x30bdea in _dns_decode_an /opt/smartdns/src/dns.c:2192:9     #7 0x30954d in _dns_decode_body /opt/smartdns/src/dns.c:2329:9     #8 0x30954d in dns_decode /opt/smartdns/src/dns.c:2469:8     #9 0x31750d in main /opt/smartdns/src/smartdns.c:49:13     #10 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16     #11 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3     #12 0x2558d4 in _start (/opt/smartdns/src/smartdns+0x2558d4)  Address 0x7fffffffdd8e is located in stack of thread T0 at offset 6190 in frame     #0 0x316cdf in main /opt/smartdns/src/smartdns.c    This frame has 5 object(s):     [32, 6176) 'packet_buff' (line 45) <== Memory access at offset 6190 overflows this variable     [6432, 6436) 'rr_count' (line 53)     [6448, 6452) 'qtype' (line 54)     [6464, 6468) 'qclass' (line 55)     [6480, 6736) 'domain' (line 56) HINT: this may be a false positive if your program uses some custom stack unwind mechanism, swapcontext or vfork       (longjmp and C++ exceptions *are* supported) SUMMARY: AddressSanitizer: stack-buffer-overflow /opt/smartdns/src/dns.c:298:11 in _dns_encode_domain Shadow bytes around the buggy address:   0x10007fff7b60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x10007fff7b70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x10007fff7b80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x10007fff7b90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x10007fff7ba0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 =>0x10007fff7bb0: f2[f2]f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2   0x10007fff7bc0: f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2 f2   0x10007fff7bd0: f8 f2 f8 f2 f8 f2 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8   0x10007fff7be0: f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8 f8   0x10007fff7bf0: f8 f8 f8 f8 f8 f8 f3 f3 f3 f3 f3 f3 f3 f3 f3 f3   0x10007fff7c00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07   Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb   Shadow gap:              cc ==2457317==ABORTING  ```  **GDB Backtrace:**  ``` #0  __pthread_kill_implementation (no_tid=0x0, signo=0x6, threadid=0x7ffff7ee1000) at ./nptl/pthread_kill.c:44 #1  __pthread_kill_internal (signo=0x6, threadid=0x7ffff7ee1000) at ./nptl/pthread_kill.c:78 #2  __GI___pthread_kill (threadid=0x7ffff7ee1000, signo=signo@entry=0x6) at ./nptl/pthread_kill.c:89 #3  0x00007ffff7642476 in __GI_raise (sig=sig@entry=0x6) at ../sysdeps/posix/raise.c:26 #4  0x00007ffff76287f3 in __GI_abort () at ./stdlib/abort.c:79 #5  0x00007ffff76896f6 in __libc_message (action=action@entry=do_abort, fmt=fmt@entry=0x7ffff77db943 "*** %s ***: terminated\n") at ../sysdeps/posix/libc_fatal.c:155 #6  0x00007ffff773676a in __GI___fortify_fail (msg=msg@entry=0x7ffff77db92b "stack smashing detected") at ./debug/fortify_fail.c:26 #7  0x00007ffff7736736 in __stack_chk_fail () at ./debug/stack_chk_fail.c:24 #8  0x0000555555576b19 in _dns_server_recv (conn=conn@entry=0x55555575a3e0, inpacket=inpacket@entry=0x7fffffff3500 "0000", inpacket_len=<optimized out>, local=local@entry=0x7fffffff2870, local_len=0x10, from=from@entry=0x7fffffff27f0, from_len=0x1c) at dns_server.c:5308 #9  0x0000555555577dfe in _dns_server_process_udp_one (event=<optimized out>, now=<optimized out>, udpconn=<optimized out>) at dns_server.c:5441 #10 _dns_server_process_udp (event=<optimized out>, now=<optimized out>, udpconn=<optimized out>) at dns_server.c:5448 #11 _dns_server_process (now=0x1504f191, event=0x7fffffff28f0, conn=<optimized out>) at dns_server.c:6056 #12 dns_server_run () at dns_server.c:6429 #13 0x000055555555d837 in _smartdns_run () at smartdns.c:536 #14 main (argc=<optimized out>, argv=<optimized out>) at smartdns.c:776  ```  The issue appears to be caused by insufficient bounds checking in the ***\_dns\_encode\_domain*** function. I added the following code to the beginning of the function, which appears to prevent the overflow to happen for this specific payload:  ``` if (_dns_left_len(context) <= 0) {     return -1; }  ```  *However, I'm not certain if this is the best solution to address the vulnerability.*  **Suggested Fix:**  I recommend reviewing the ***\_dns\_encode\_domain*** function in the ***dns.c*** file to ensure proper bounds checking is in place. You may also want to review the ***\_dns\_left\_len*** function, as it is used in the problematic function to calculate the remaining buffer length.  I will be requesting a CVE ID for this vulnerability to ensure proper tracking and handling of the issue.  Please let me know if you require any additional information or assistance in addressing this vulnerability. I'm looking forward to your prompt response and action to ensure the security of SmartDNS users.  Regards, Huáscar |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@pymumu](https://avatars.githubusercontent.com/u/3275997?s=80&u=6eafad1c66232f210a74f5dda345195d16be8f07&v=4)](/pymumu)

Copy link

Owner

### **[pymumu](/pymumu)** commented [Apr 22, 2023](#issuecomment-1518604916)

| Thanks for the report, I modified the code according to your description. Please check it out and let me know if there is still a problem. |
| --- |

All reactions

Sorry, something went wrong.

[![@htejeda](https://avatars.githubusercontent.com/u/2684910?s=80&v=4)](/htejeda)

Copy link

Author

### **[htejeda](/htejeda)** commented [Apr 22, 2023](#issuecomment-1518698403)

| Thanks for the quick response and action in addressing the reported vulnerability! I've tested the patched version with multiple trigger files that used to cause the issue in different ways, and I can confirm that the patch you implemented has successfully resolved the problem. |
| --- |

All reactions

Sorry, something went wrong.

[![@htejeda](https://avatars.githubusercontent.com/u/2684910?s=40&v=4)](/htejeda)
[htejeda](/htejeda)
closed this as [completed](/pymumu/smartdns/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Apr 22, 2023](#event-9073329527)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fissues%2F1378)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@htejeda](https://avatars.githubusercontent.com/u/2684910?s=52&v=4)](/htejeda) [![@pymumu](https://avatars.githubusercontent.com/u/3275997?s=52&v=4)](/pymumu)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d03eab06_20250114_224905.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fcommit%2F56d0332bf91104cfc877635f6c82e9348587df04)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fcommit%2F56d0332bf91104cfc877635f6c82e9348587df04)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=pymumu%2Fsmartdns)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pymumu](/pymumu)
/
**[smartdns](/pymumu/smartdns)**
Public

* [Notifications](/login?return_to=%2Fpymumu%2Fsmartdns) You must be signed in to change notification settings
* [Fork
  1.1k](/login?return_to=%2Fpymumu%2Fsmartdns)
* [Star
   8.6k](/login?return_to=%2Fpymumu%2Fsmartdns)

* [Code](/pymumu/smartdns)
* [Issues
  179](/pymumu/smartdns/issues)
* [Pull requests
  3](/pymumu/smartdns/pulls)
* [Discussions](/pymumu/smartdns/discussions)
* [Actions](/pymumu/smartdns/actions)
* [Projects
  0](/pymumu/smartdns/projects)
* [Security](/pymumu/smartdns/security)
* [Insights](/pymumu/smartdns/pulse)

Additional navigation options

* [Code](/pymumu/smartdns)
* [Issues](/pymumu/smartdns/issues)
* [Pull requests](/pymumu/smartdns/pulls)
* [Discussions](/pymumu/smartdns/discussions)
* [Actions](/pymumu/smartdns/actions)
* [Projects](/pymumu/smartdns/projects)
* [Security](/pymumu/smartdns/security)
* [Insights](/pymumu/smartdns/pulse)

## Commit

[Permalink](/pymumu/smartdns/commit/56d0332bf91104cfc877635f6c82e9348587df04)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

dns: fix crash issue

[Browse files](/pymumu/smartdns/tree/56d0332bf91104cfc877635f6c82e9348587df04)
Browse the repository at this point in the history

* Loading branch information

[![@pymumu](https://avatars.githubusercontent.com/u/3275997?s=40&v=4)](/pymumu)

[pymumu](/pymumu/smartdns/commits?author=pymumu "View all commits by pymumu")
committed
Apr 22, 2023

1 parent
[e38d5ea](/pymumu/smartdns/commit/e38d5eaecca631ebc9b66e2c37e1986f2d58c27b)

commit 56d0332

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**108 additions**
and
**27 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/dns.c
    [dns.c](#diff-0d126928d0b96e34c25b578cbdd8b48ca09a274b437cc639fe9a64adef9a4c72)
  + src/dns.h
    [dns.h](#diff-a7df4afb1bc78818396b87dab6d0ff27daee7ee27990a2413df0d19748bbdd65)
  + src/util.c
    [util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab)

## There are no files selected for viewing

89 changes: 72 additions & 17 deletions

89
[src/dns.c](#diff-0d126928d0b96e34c25b578cbdd8b48ca09a274b437cc639fe9a64adef9a4c72 "src/dns.c")

Show comments

[View file](/pymumu/smartdns/blob/56d0332bf91104cfc877635f6c82e9348587df04/src/dns.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -274,6 +274,10 @@ static int \_dns\_encode\_domain(struct dns\_context \*context, const char \*domain) |
|  |  | total\_len++; |
|  |  | if (dict\_offset >= 0) { |
|  |  | int offset = 0xc000 | dict\_offset; |
|  |  | if (\_dns\_left\_len(context) < 2) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | \_dns\_write\_short(&ptr\_num, offset); |
|  |  | context->ptr++; |
|  |  | ptr\_num = NULL; |
| Expand All | | @@ -295,6 +299,10 @@ static int \_dns\_encode\_domain(struct dns\_context \*context, const char \*domain) |
|  |  | domain++; |
|  |  | } |
|  |  |  |
|  |  | if (\_dns\_left\_len(context) < 1) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | \*ptr\_num = num; |
|  |  |  |
|  |  | if (total\_len > 1) { |
| Expand Down  Expand Up | | @@ -575,7 +583,7 @@ struct dns\_rr\_nested \*dns\_add\_rr\_nested\_start(struct dns\_rr\_nested \*rr\_nested\_bu |
|  |  | return rr\_nested\_buffer; |
|  |  | } |
|  |  |  |
|  |  | int dns\_add\_rr\_nested\_memcpy(struct dns\_rr\_nested \*rr\_nested, void \*data, int data\_len) |
|  |  | int dns\_add\_rr\_nested\_memcpy(struct dns\_rr\_nested \*rr\_nested, const void \*data, int data\_len) |
|  |  | { |
|  |  | if (rr\_nested == NULL || data == NULL || data\_len <= 0) { |
|  |  | return -1; |
| Expand Down  Expand Up | | @@ -603,6 +611,12 @@ int dns\_add\_rr\_nested\_end(struct dns\_rr\_nested \*rr\_nested, dns\_type\_t rtype) |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | /\* NO SVC keys, reset ptr \*/ |
|  |  | if (len <= 14) { |
|  |  | rr\_nested->context.ptr = rr\_nested->rr\_start; |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | \_dns\_write\_short(&ptr, len - rr\_nested->rr\_head\_len); |
|  |  |  |
|  |  | return \_dns\_rr\_add\_end(rr\_nested->context.packet, rr\_nested->type, rtype, len); |
| Expand Down  Expand Up | | @@ -1076,7 +1090,12 @@ int dns\_add\_HTTPS\_start(struct dns\_rr\_nested \*svcparam\_buffer, struct dns\_packet |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | int target\_len = strnlen(target, DNS\_MAX\_CNAME\_LEN) + 1; |
|  |  | int target\_len = 0; |
|  |  | if (target == NULL) { |
|  |  | target = ""; |
|  |  | } |
|  |  |  |
|  |  | target\_len = strnlen(target, DNS\_MAX\_CNAME\_LEN) + 1; |
|  |  | if (\_dns\_left\_len(&svcparam\_buffer->context) < 2 + target\_len) { |
|  |  | return -1; |
|  |  | } |
| Expand Down  Expand Up | | @@ -1117,6 +1136,22 @@ int dns\_HTTPS\_add\_port(struct dns\_rr\_nested \*svcparam, unsigned short port) |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | int dns\_HTTPS\_add\_alpn(struct dns\_rr\_nested \*svcparam, const char \*alpn, int alpn\_len) |
|  |  | { |
|  |  | if (\_dns\_left\_len(&svcparam->context) < 2 + 2 + alpn\_len) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | unsigned short value = DNS\_HTTPS\_T\_ALPN; |
|  |  | dns\_add\_rr\_nested\_memcpy(svcparam, &value, 2); |
|  |  |  |
|  |  | value = alpn\_len; |
|  |  | dns\_add\_rr\_nested\_memcpy(svcparam, &value, 2); |
|  |  | dns\_add\_rr\_nested\_memcpy(svcparam, alpn, alpn\_len); |
|  |  |  |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | int dns\_HTTPS\_add\_ech(struct dns\_rr\_nested \*svcparam, void \*ech, int ech\_len) |
|  |  | { |
|  |  | if (\_dns\_left\_len(&svcparam->context) < 2 + 2 + ech\_len) { |
| Expand All | | @@ -1133,7 +1168,7 @@ int dns\_HTTPS\_add\_ech(struct dns\_rr\_nested \*svcparam, void \*ech, int ech\_len) |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | int dns\_HTTPS\_add\_ipv4hint(struct dns\_rr\_nested \*svcparam, unsigned char addr[][DNS\_RR\_A\_LEN], int addr\_num) |
|  |  | int dns\_HTTPS\_add\_ipv4hint(struct dns\_rr\_nested \*svcparam, unsigned char \*addr[], int addr\_num) |
|  |  | { |
|  |  | if (\_dns\_left\_len(&svcparam->context) < 4 + addr\_num \* DNS\_RR\_A\_LEN) { |
|  |  | return -1; |
| Expand All | | @@ -1151,7 +1186,8 @@ int dns\_HTTPS\_add\_ipv4hint(struct dns\_rr\_nested \*svcparam, unsigned char addr[][ |
|  |  |  |
|  |  | return 0; |
|  |  | } |
|  |  | int dns\_HTTPS\_add\_ipv6hint(struct dns\_rr\_nested \*svcparam, unsigned char addr[][DNS\_RR\_AAAA\_LEN], int addr\_num) |
|  |  |  |
|  |  | int dns\_HTTPS\_add\_ipv6hint(struct dns\_rr\_nested \*svcparam, unsigned char \*addr[], int addr\_num) |
|  |  | { |
|  |  | if (\_dns\_left\_len(&svcparam->context) < 4 + addr\_num \* DNS\_RR\_AAAA\_LEN) { |
|  |  | return -1; |
| Expand All | | @@ -1175,41 +1211,48 @@ int dns\_add\_HTTPS\_end(struct dns\_rr\_nested \*svcparam) |
|  |  | return dns\_add\_rr\_nested\_end(svcparam, DNS\_T\_HTTPS); |
|  |  | } |
|  |  |  |
|  |  | struct dns\_https\_param \*dns\_get\_HTTPS\_svcparm\_start(struct dns\_rrs \*rrs, char \*domain, int maxsize, int \*ttl, |
|  |  | int \*priority, char \*target, int target\_size) |
|  |  | int dns\_get\_HTTPS\_svcparm\_start(struct dns\_rrs \*rrs, struct dns\_https\_param \*\*https\_param, char \*domain, int maxsize, |
|  |  | int \*ttl, int \*priority, char \*target, int target\_size) |
|  |  | { |
|  |  | int qtype = 0; |
|  |  | unsigned char \*data = NULL; |
|  |  | int rr\_len = 0; |
|  |  |  |
|  |  | data = dns\_get\_rr\_nested\_start(rrs, domain, maxsize, &qtype, ttl, &rr\_len); |
|  |  | if (data == NULL) { |
|  |  | return NULL; |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | if (qtype != DNS\_T\_HTTPS) { |
|  |  | return NULL; |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | if (rr\_len < 2) { |
|  |  | return NULL; |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | \*priority = \_dns\_read\_short(&data); |
|  |  | rr\_len -= 2; |
|  |  | if (rr\_len <= 0) { |
|  |  | return NULL; |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | int len = strnlen((char \*)data, rr\_len); |
|  |  | safe\_strncpy(target, (char \*)data, target\_size); |
|  |  | data += len + 1; |
|  |  | rr\_len -= len + 1; |
|  |  | if (rr\_len <= 0) { |
|  |  | return NULL; |
|  |  | if (rr\_len < 0) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | if (rr\_len == 0) { |
|  |  | \*https\_param = NULL; |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | return (struct dns\_https\_param \*)data; |
|  |  | \*https\_param = (struct dns\_https\_param \*)data; |
|  |  |  |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | struct dns\_https\_param \*dns\_get\_HTTPS\_svcparm\_next(struct dns\_rrs \*rrs, struct dns\_https\_param \*param) |
| Expand Down  Expand Up | | @@ -1925,12 +1968,16 @@ static int \_dns\_encode\_HTTPS(struct dns\_context \*context, struct dns\_rrs \*rrs) |
|  |  | int priority = 0; |
|  |  | struct dns\_https\_param \*param = NULL; |
|  |  |  |
|  |  | param = dns\_get\_HTTPS\_svcparm\_start(rrs, domain, DNS\_MAX\_CNAME\_LEN, &ttl, &priority, target, DNS\_MAX\_CNAME\_LEN); |
|  |  | if (param == NULL) { |
|  |  | tlog(TLOG\_ERROR, "get https param failed."); |
|  |  | return -1; |
|  |  | ret = |
|  |  | dns\_get\_HTTPS\_svcparm\_start(rrs, &param, domain, DNS\_MAX\_CNAME\_LEN, &ttl, &priority, target, DNS\_MAX\_CNAME\_LEN); |
|  |  | if (ret < 0) { |
|  |  | tlog(TLOG\_DEBUG, "get https param failed."); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | qtype = DNS\_T\_HTTPS; |
|  |  | qclass = DNS\_C\_IN; |
|  |  |  |
|  |  | ret = \_dns\_encode\_rr\_head(context, domain, qtype, qclass, ttl, 0, &rr\_len\_ptr); |
|  |  | if (ret < 0) { |
|  |  | return -1; |
| Expand All | | @@ -1954,6 +2001,10 @@ static int \_dns\_encode\_HTTPS(struct dns\_context \*context, struct dns\_rrs \*rrs) |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | if (param->len + 4 > \_dns\_left\_len(context)) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | \_dns\_write\_short(&context->ptr, param->key); |
|  |  | \_dns\_write\_short(&context->ptr, param->len); |
|  |  | switch (param->key) { |
| Expand All | | @@ -1974,6 +2025,10 @@ static int \_dns\_encode\_HTTPS(struct dns\_context \*context, struct dns\_rrs \*rrs) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (\_dns\_left\_len(context) < 2) { |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | \_dns\_write\_short(&rr\_len\_ptr, context->ptr - rr\_start); |
|  |  |  |
|  |  | return 0; |
| Expand Down | |  |

23 changes: 16 additions & 7 deletions

23
[src/dns.h](#diff-a7df4afb1bc78818396b87dab6d0ff27daee7ee27990a2413df0d19748bbdd65 "src/dns.h")

Show comments

[View file](/pymumu/smartdns/blob/56d0332bf91104cfc877635f6c82e9348587df04/src/dns.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -30,6 +30,8 @@ extern "C" { |
|  |  | #define DNS\_IN\_PACKSIZE (512 \* 8) |
|  |  | #define DNS\_PACKSIZE (512 \* 12) |
|  |  | #define DNS\_DEFAULT\_PACKET\_SIZE 512 |
|  |  | #define DNS\_MAX\_ALPN\_LEN 32 |
|  |  | #define DNS\_MAX\_ECH\_LEN 256 |
|  |  |  |
|  |  | #define DNS\_ADDR\_FAMILY\_IP 1 |
|  |  | #define DNS\_ADDR\_FAMILY\_IPV6 2 |
| Expand Down  Expand Up | | @@ -236,7 +238,7 @@ struct dns\_rrs \*dns\_get\_rrs\_start(struct dns\_packet \*packet, dns\_rr\_type type, i |
|  |  | struct dns\_rr\_nested \*dns\_add\_rr\_nested\_start(struct dns\_rr\_nested \*rr\_nested\_buffer, struct dns\_packet \*packet, |
|  |  | dns\_rr\_type type, dns\_type\_t rtype, const char \*domain, int ttl); |
|  |  | int dns\_add\_rr\_nested\_end(struct dns\_rr\_nested \*rr\_nested, dns\_type\_t rtype); |
|  |  | int dns\_add\_rr\_nested\_memcpy(struct dns\_rr\_nested \*rr\_nested, void \*data, int data\_len); |
|  |  | int dns\_add\_rr\_nested\_memcpy(struct dns\_rr\_nested \*rr\_nested, const void \*data, int data\_len); |
|  |  |  |
|  |  | void \*dns\_get\_rr\_nested\_start(struct dns\_rrs \*rrs, char \*domain, int maxsize, int \*qtype, int \*ttl, int \*rr\_len); |
|  |  | void \*dns\_get\_rr\_nested\_next(struct dns\_rrs \*rrs, void \*rr\_nested, int rr\_nested\_len); |
| Expand Down  Expand Up | | @@ -280,19 +282,26 @@ int dns\_add\_OPT\_TCP\_KEEPALIVE(struct dns\_packet \*packet, unsigned short timeout) |
|  |  | int dns\_get\_OPT\_TCP\_KEEPALIVE(struct dns\_rrs \*rrs, unsigned short \*opt\_code, unsigned short \*opt\_len, |
|  |  | unsigned short \*timeout); |
|  |  |  |
|  |  | /\* the key must be added in orders, or dig will report FORMERR \*/ |
|  |  | int dns\_add\_HTTPS\_start(struct dns\_rr\_nested \*svcparam\_buffer, struct dns\_packet \*packet, dns\_rr\_type type, |
|  |  | const char \*domain, int ttl, int priority, const char \*target); |
|  |  | int dns\_HTTPS\_add\_raw(struct dns\_rr\_nested \*svcparam, unsigned short key, unsigned char \*value, unsigned short len); |
|  |  | int dns\_HTTPS\_add\_port(struct dns\_rr\_nested \*svcparam, unsigned short port); |
|  |  | int dns\_HTTPS\_add\_alpn(struct dns\_rr\_nested \*svcparam, const char \*alpn); |
|  |  | /\* key 1, alph \*/ |
|  |  | int dns\_HTTPS\_add\_alpn(struct dns\_rr\_nested \*svcparam, const char \*alpn, int alpn\_len); |
|  |  | /\* key 2, no default alph \*/ |
|  |  | int dns\_HTTPS\_add\_no\_default\_alpn(struct dns\_rr\_nested \*svcparam); |
|  |  | int dns\_HTTPS\_add\_ipv4hint(struct dns\_rr\_nested \*svcparam, unsigned char addr[][DNS\_RR\_A\_LEN], int addr\_num); |
|  |  | int dns\_HTTPS\_add\_ipv6hint(struct dns\_rr\_nested \*svcparam, unsigned char addr[][DNS\_RR\_AAAA\_LEN], int addr\_num); |
|  |  | /\* key 3, port \*/ |
|  |  | int dns\_HTTPS\_add\_port(struct dns\_rr\_nested \*svcparam, unsigned short port); |
|  |  | /\* key 4, ipv4 \*/ |
|  |  | int dns\_HTTPS\_add\_ipv4hint(struct dns\_rr\_nested \*svcparam, unsigned char \*addr[], int addr\_num); |
|  |  | /\* key 5, ech \*/ |
|  |  | int dns\_HTTPS\_add\_ech(struct dns\_rr\_nested \*svcparam, void \*ech, int ech\_len); |
|  |  | /\* key 6, ipv6\*/ |
|  |  | int dns\_HTTPS\_add\_ipv6hint(struct dns\_rr\_nested \*svcparam, unsigned char \*addr[], int addr\_num); |
|  |  | int dns\_add\_HTTPS\_end(struct dns\_rr\_nested \*svcparam); |
|  |  |  |
|  |  | struct dns\_https\_param \*dns\_get\_HTTPS\_svcparm\_start(struct dns\_rrs \*rrs, char \*domain, int maxsize, int \*ttl, |
|  |  | int \*priority, char \*target, int target\_size); |
|  |  | int dns\_get\_HTTPS\_svcparm\_start(struct dns\_rrs \*rrs, struct dns\_https\_param \*\*https\_param, char \*domain, int maxsize, |
|  |  | int \*ttl, int \*priority, char \*target, int target\_size); |
|  |  | struct dns\_https\_param \*dns\_get\_HTTPS\_svcparm\_next(struct dns\_rrs \*rrs, struct dns\_https\_param \*parm); |
|  |  |  |
|  |  | /\* |
| Expand Down | |  |

23 changes: 20 additions & 3 deletions

23
[src/util.c](#diff-40aa21688f1ac58ddf8ef5f0f4e472e6075411f5c4f75b9c1d512b7e03a2cbab "src/util.c")

Show comments

[View file](/pymumu/smartdns/blob/56d0332bf91104cfc877635f6c82e9348587df04/src/util.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1601,10 +1601,11 @@ static int \_dns\_debug\_display(struct dns\_packet \*packet) |
|  |  | char target[DNS\_MAX\_CNAME\_LEN] = {0}; |
|  |  | struct dns\_https\_param \*p = NULL; |
|  |  | int priority = 0; |
|  |  | int ret = 0; |
|  |  |  |
|  |  | p = dns\_get\_HTTPS\_svcparm\_start(rrs, name, DNS\_MAX\_CNAME\_LEN, &ttl, &priority, target, |
|  |  | ret = dns\_get\_HTTPS\_svcparm\_start(rrs, &p, name, DNS\_MAX\_CNAME\_LEN, &ttl, &priority, target, |
|  |  | DNS\_MAX\_CNAME\_LEN); |
|  |  | if (p == NULL) { |
|  |  | if (ret != 0) { |
|  |  | printf("get HTTPS svcparm failed\n"); |
|  |  | break; |
|  |  | } |
| Expand All | | @@ -1617,7 +1618,23 @@ static int \_dns\_debug\_display(struct dns\_packet \*packet) |
|  |  | printf(" HTTPS: mandatory: %s\n", p->value); |
|  |  | } break; |
|  |  | case DNS\_HTTPS\_T\_ALPN: { |
|  |  | printf(" HTTPS: alpn: %s\n", p->value); |
|  |  | char alph[64] = {0}; |
|  |  | int total\_alph\_len = 0; |
|  |  | char \*ptr = (char \*)p->value; |
|  |  | do { |
|  |  | int alphlen = \*ptr; |
|  |  | memcpy(alph + total\_alph\_len, ptr + 1, alphlen); |
|  |  | total\_alph\_len += alphlen; |
|  |  | ptr += alphlen + 1; |
|  |  | alph[total\_alph\_len] = ','; |
|  |  | total\_alph\_len++; |
|  |  | alph[total\_alph\_len] = ' '; |
|  |  | total\_alph\_len++; |
|  |  | } while (ptr - (char \*)p->value < p->len); |
|  |  | if (total\_alph\_len > 2) { |
|  |  | alph[total\_alph\_len - 2] = '\0'; |
|  |  | } |
|  |  | printf(" HTTPS: alpn: %s\n", alph); |
|  |  | } break; |
|  |  | case DNS\_HTTPS\_T\_NO\_DEFAULT\_ALPN: { |
|  |  | printf(" HTTPS: no\_default\_alpn: %s\n", p->value); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `56d0332`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpymumu%2Fsmartdns%2Fcommit%2F56d0332bf91104cfc877635f6c82e9348587df04) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


