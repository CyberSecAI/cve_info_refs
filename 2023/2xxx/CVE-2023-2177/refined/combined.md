=== Content from git.kernel.org_ce6f66ac_20250115_082623.html ===


| [cgit logo](/) | [index](/) : [kernel/git/netdev/net.git](/pub/scm/linux/kernel/git/netdev/net.git/) | main |
| --- | --- | --- |
| Netdev Group's networking tree | Netdev Group |

| [about](/pub/scm/linux/kernel/git/netdev/net.git/about/)[summary](/pub/scm/linux/kernel/git/netdev/net.git/)[refs](/pub/scm/linux/kernel/git/netdev/net.git/refs/?id=181d8d2066c0)[log](/pub/scm/linux/kernel/git/netdev/net.git/log/)[tree](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=181d8d2066c0)[commit](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=181d8d2066c0)[diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=181d8d2066c0)[stats](/pub/scm/linux/kernel/git/netdev/net.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Xin Long <lucien.xin@gmail.com> | 2022-07-25 18:11:06 -0400 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2022-07-27 18:23:22 -0700 |
| commit | [181d8d2066c000ba0a0e6940a7ad80f1a0e68e9d](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=181d8d2066c000ba0a0e6940a7ad80f1a0e68e9d) ([patch](/pub/scm/linux/kernel/git/netdev/net.git/patch/?id=181d8d2066c000ba0a0e6940a7ad80f1a0e68e9d)) | |
| tree | [0a6e824f8046ec6563de603554f86ddd1fecd093](/pub/scm/linux/kernel/git/netdev/net.git/tree/?id=181d8d2066c0) | |
| parent | [67c3b611d92fc238c43734878bc3e232ab570c79](/pub/scm/linux/kernel/git/netdev/net.git/commit/?id=67c3b611d92fc238c43734878bc3e232ab570c79) ([diff](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=181d8d2066c0&id2=67c3b611d92fc238c43734878bc3e232ab570c79)) | |
| download | [net-181d8d2066c0.tar.gz](/pub/scm/linux/kernel/git/netdev/net.git/snapshot/net-181d8d2066c0.tar.gz) | |

sctp: leave the err path free in sctp\_stream\_init to sctp\_stream\_freeA NULL pointer dereference was reported by Wei Chen:
BUG: kernel NULL pointer dereference, address: 0000000000000000
RIP: 0010:\_\_list\_del\_entry\_valid+0x26/0x80
Call Trace:
<TASK>
sctp\_sched\_dequeue\_common+0x1c/0x90
sctp\_sched\_prio\_dequeue+0x67/0x80
\_\_sctp\_outq\_teardown+0x299/0x380
sctp\_outq\_free+0x15/0x20
sctp\_association\_free+0xc3/0x440
sctp\_do\_sm+0x1ca7/0x2210
sctp\_assoc\_bh\_rcv+0x1f6/0x340
This happens when calling sctp\_sendmsg without connecting to server first.
In this case, a data chunk already queues up in send queue of client side
when processing the INIT\_ACK from server in sctp\_process\_init() where it
calls sctp\_stream\_init() to alloc stream\_in. If it fails to alloc stream\_in
all stream\_out will be freed in sctp\_stream\_init's err path. Then in the
asoc freeing it will crash when dequeuing this data chunk as stream\_out
is missing.
As we can't free stream out before dequeuing all data from send queue, and
this patch is to fix it by moving the err path stream\_out/in freeing in
sctp\_stream\_init() to sctp\_stream\_free() which is eventually called when
freeing the asoc in sctp\_association\_free(). This fix also makes the code
in sctp\_process\_init() more clear.
Note that in sctp\_association\_init() when it fails in sctp\_stream\_init(),
sctp\_association\_free() will not be called, and in that case it should
go to 'stream\_free' err path to free stream instead of 'fail\_init'.
Fixes: 5bbbbe32a431 ("sctp: introduce stream scheduler foundations")
Reported-by: Wei Chen <harperchen1110@gmail.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
Link: [https://lore.kernel.org/r/831a3dc100c4908ff76e5bcc363be97f2778bc0b.1658787066.git.lucien.xin@gmail.com](https://lore.kernel.org/r/831a3dc100c4908ff76e5bcc363be97f2778bc0b.1658787066.git.lucien.xin%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/netdev/net.git/diff/?id=181d8d2066c0)

| -rw-r--r-- | [net/sctp/associola.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/net/sctp/associola.c?id=181d8d2066c0) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/sctp/stream.c](/pub/scm/linux/kernel/git/netdev/net.git/diff/net/sctp/stream.c?id=181d8d2066c0) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 19 deletions

| diff --git a/net/sctp/associola.c b/net/sctp/associola.cindex be29da09cc7ab0..3460abceba443b 100644--- a/[net/sctp/associola.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/sctp/associola.c?id=67c3b611d92fc238c43734878bc3e232ab570c79)+++ b/[net/sctp/associola.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/sctp/associola.c?id=181d8d2066c000ba0a0e6940a7ad80f1a0e68e9d)@@ -229,9 +229,8 @@ static struct sctp\_association \*sctp\_association\_init( if (!sctp\_ulpq\_init(&asoc->ulpq, asoc)) goto fail\_init; - if (sctp\_stream\_init(&asoc->stream, asoc->c.sinit\_num\_ostreams,- 0, gfp))- goto fail\_init;+ if (sctp\_stream\_init(&asoc->stream, asoc->c.sinit\_num\_ostreams, 0, gfp))+ goto stream\_free;  /\* Initialize default path MTU. \*/ asoc->pathmtu = sp->pathmtu;diff --git a/net/sctp/stream.c b/net/sctp/stream.cindex 6dc95dcc0ff4f0..ef9fceadef8d5a 100644--- a/[net/sctp/stream.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/sctp/stream.c?id=67c3b611d92fc238c43734878bc3e232ab570c79)+++ b/[net/sctp/stream.c](/pub/scm/linux/kernel/git/netdev/net.git/tree/net/sctp/stream.c?id=181d8d2066c000ba0a0e6940a7ad80f1a0e68e9d)@@ -137,7 +137,7 @@ int sctp\_stream\_init(struct sctp\_stream \*stream, \_\_u16 outcnt, \_\_u16 incnt,  ret = sctp\_stream\_alloc\_out(stream, outcnt, gfp); if (ret)- goto out\_err;+ return ret;  for (i = 0; i < stream->outcnt; i++) SCTP\_SO(stream, i)->state = SCTP\_STREAM\_OPEN;@@ -145,22 +145,9 @@ int sctp\_stream\_init(struct sctp\_stream \*stream, \_\_u16 outcnt, \_\_u16 incnt, handle\_in: sctp\_stream\_interleave\_init(stream); if (!incnt)- goto out;-- ret = sctp\_stream\_alloc\_in(stream, incnt, gfp);- if (ret)- goto in\_err;-- goto out;+ return 0; -in\_err:- sched->free(stream);- genradix\_free(&stream->in);-out\_err:- genradix\_free(&stream->out);- stream->outcnt = 0;-out:- return ret;+ return sctp\_stream\_alloc\_in(stream, incnt, gfp); }  int sctp\_stream\_init\_ext(struct sctp\_stream \*stream, \_\_u16 sid) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 08:25:00 +0000


