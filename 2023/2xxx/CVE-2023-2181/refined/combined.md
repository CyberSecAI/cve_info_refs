=== Content from gitlab.com_9c5b5f0d_20250115_090846.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

* [cves](/gitlab-org/cves/-/tree/master)
* [2023](/gitlab-org/cves/-/tree/master/2023)
* [**CVE-2023-2181.json**](/gitlab-org/cves/-/blob/master/2023/CVE-2023-2181.json)

Find file

[Blame](/gitlab-org/cves/-/blame/master/2023/CVE-2023-2181.json)
[Permalink](/gitlab-org/cves/-/blob/5dbfc725a86e6d942deec9c36b7f06f5b8d912fc/2023/CVE-2023-2181.json "Go to permalink <kbd class='flat ml-1' aria-hidden=true>y</kbd>")

* [![ðŸ¤– GitLab Bot ðŸ¤–'s avatar](/uploads/-/system/user/avatar/1786152/avatar.png?width=64 "ðŸ¤– GitLab Bot ðŸ¤–")](/gitlab-bot)

  May 12, 2023

  [83342e98](/gitlab-org/cves/-/commit/83342e983c6ac4bd2fda699e86fd08168df2d085)
  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/83342e983c6ac4bd2fda699e86fd08168df2d085)
  Â·
  83342e98

  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 12, 2023

  83342e98

  [Publishing 0 updated advisories and 1 new advisories](/gitlab-org/cves/-/commit/83342e983c6ac4bd2fda699e86fd08168df2d085)
  [ðŸ¤– GitLab Bot ðŸ¤–](/gitlab-bot) authored May 12, 2023

Loading



=== Content from gitlab.com_51ebeb16_20250115_090848.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Smuggling content in MR with refs/replace in Gitlab

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #1938185](https://hackerone.com/reports/1938185)** by `inspector-ambitious` on 2023-04-07, assigned to [@ottilia\_westerlund](/ottilia_westerlund "Ottilia Westerlund"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

### Summary

In Git, the `refs/replace` namespace is used to create a temporary reference that points to a commit object, allowing for the replacement or overwriting of an existing commit with a new one.

When a new commit object is created in Git, it is assigned a unique SHA-1 hash that identifies it in the repository's history.

However, an attacker with the `Developer` role in a repository can push a replacement reference in the `refs/replace` namespace, which would replace an existing commit with a malicious one. And if the head commit of a MR is replaced with a malicious one, we will get a situation where the MR will show the original commit but what would be merged will be the malicious one instead. Therefore this would allow an attacker to inject malicious code in the protected branch.

You can find a documentation on git replace [here](https://git-scm.com/book/en/v2/Git-Tools-Replace).

### Steps to reproduce

To reproduce this vulnerability we will need 2 users:

* `victim01` the victim and repository owner.
* `inspector-ambitious` the attacker with `Developer` access.

#### Step 1: Setup repository (in victim context `victim01`)

1. Create an empty (no README) private project called `replace`
2. Add one empty file called `a`. (we need at least one commit)

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a68da18b8a825b8c0e3ae884ca135278919723d7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32616338323332392d633130382d343837312d623634632d6337333033323036643331352f696d6167652e706e67)

3. Go to `Settings > Repository > Protected Branches` and check that `main` branch is protected

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6a4cd1507a7827295bf62dd5d900ff69554c155a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38326634333366622d623739362d343733322d383435302d6230303936623134643531352f696d6167652e706e67)

It should be the default setup. Only maintainers can merge or push to this branch.

5. Got to `Project information > Members` and invite `inspector-ambitious` with the role `Developer`

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/564273da9f13975dd4f3927f70b0811d4dfa3a57/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36646134303233342d383262332d343233312d393061662d3565666434313436323533342f696d6167652e706e67)

#### Step 2: Attack preparation (in attacker context `inspector-ambitious`)

\*\* It is extremely important to respect the order of operations here \*\*

1. Create a new branch from `main` called `b` for example
2. Add a new empty file called `b`in the branch `b`

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f02df13b9241c8c8638e8b6bbd6b7e76bacdbc92/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39373437326633342d303235382d343638312d626230392d3933663764376439396132612f696d6167652e706e67)

3. Create a branch called `c` from `main` with an empty file called `c`

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/747f881b6182ef21c966d344c9e40b6d00046582/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31646139653465302d643631322d343232612d383936312d3732636239613662323431322f696d6167652e706e67)

4. Clone the repository and run `git ls-remote` in the terminal

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3f252981edfc258478452d2602f81c6357b7056a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38353863623366392d336131332d346439362d393830612d3535623639623238663064652f696d6167652e706e67)

5. Now push a refs/replace reference to replace commit from `b` with `c`

in our case based on previous output of `ls-remote`

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/a06049d1743dbc30ebed887f697674c408d760a3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30663734383231362d616636382d343937392d613564612d3139396238666663336162322f696d6167652e706e67)

running `git ls-remote` again we get

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/29b21a3ad2ba30b4d9b94d514bce0aaffce41a89/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62333338383061652d613062642d343061662d623064372d3438316136386633313737362f696d6167652e706e67)

5. Create a MR from `b` to `main`.

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/56f8fc56ae29d85a7cd88201bc06d9ee3759640f/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62646137353035662d376665662d346365342d383063302d3339613237336135626661302f696d6167652e706e67)

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0631abc543f6c389a5eef1393f1a7f7737fcba09/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36626532653539382d613630302d343662392d623831612d3431366139383635663831622f696d6167652e706e67)

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/975cbcfc03888208c92b77172950892e3a888597/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37626138666262622d333033352d346431652d393235632d3735356338623663303230372f696d6167652e706e67)

As you can see only the file `b` should be added when this PR is merged.

## Step 3: `main` branch is compromised (in victim context `victim01`)

1. Go to the pull request and merge it.

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/531bf7b790c3757ce14ba4a2d3dd4b730dd4eb37/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33353832313864622d633533352d346438362d623439392d3538373836323632393936392f696d6167652e706e67)

2. Go to the `main` branch

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/072a321e444827b306c4fd21e5d575816f98c2d4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f35353731323337622d346565332d343863372d383135342d3363333539376131656139312f696d6167652e706e67)

You can see the file `c` from `c` got merged !

The commit history looks correct.

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/c2e1dec95cc4ae2c004e5ba9f197d281172ae6f5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30323034656164622d663161302d346531362d386463622d3661343834626630383235632f696d6167652e706e67)

However if we look at the merge commit we see that `c` was added instead of `b`

[![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/d4a93c2d4c47e151892d1e9e9f70ab426df66b01/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63643237306435652d356664652d346366322d616133332d6430656332353064633234312f696d6167652e706e67)

#### Output of checks

This bug happens on GitLab.com, I tried to reproduce it on a local instance but somehow it didn't work out...

#### Impact

A collaborator can bypass branch protection and smuggle malicious content in a merge request, which could potentially introduce security vulnerabilities or other types of defects into the codebase, compromising the integrity and security of the repository. This could result in sensitive data being leaked, unauthorized access to resources, or even complete system compromise.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [image.png](https://h1.sec.gitlab.net/a/2ac82329-c108-4871-b64c-c7303206d315/image.png)
* [image.png](https://h1.sec.gitlab.net/a/82f433fb-b796-4732-8450-b0096b14d515/image.png)
* [image.png](https://h1.sec.gitlab.net/a/6da40234-82b3-4231-90af-5efd41462534/image.png)
* [image.png](https://h1.sec.gitlab.net/a/97472f34-0258-4681-bb09-93f7d7d99a2a/image.png)
* [image.png](https://h1.sec.gitlab.net/a/1da9e4e0-d612-422a-8961-72cb9a6b2412/image.png)
* [image.png](https://h1.sec.gitlab.net/a/858cb3f9-3a13-4d96-980a-55b69b28f0de/image.png)
* [image.png](https://h1.sec.gitlab.net/a/0f748216-af68-4979-a5da-199b8ffc3ab2/image.png)
* [image.png](https://h1.sec.gitlab.net/a/b33880ae-a0bd-40af-b0d7-481a68f31776/image.png)
* [image.png](https://h1.sec.gitlab.net/a/bda7505f-7fef-4ce4-80c0-39a273a5bfa0/image.png)
* [image.png](https://h1.sec.gitlab.net/a/6be2e598-a600-46b9-b81a-416a9865f81b/image.png)
* [image.png](https://h1.sec.gitlab.net/a/7ba8fbbb-3035-4d1e-925c-755c8b6c0207/image.png)
* [image.png](https://h1.sec.gitlab.net/a/358218db-c535-4d86-b499-587862629969/image.png)
* [image.png](https://h1.sec.gitlab.net/a/5571237b-4ee3-48c7-8154-3c3597a1ea91/image.png)
* [image.png](https://h1.sec.gitlab.net/a/0204eadb-f1a0-4e16-8dcb-6a484bf0825c/image.png)
* [image.png](https://h1.sec.gitlab.net/a/cd270d5e-5fde-4cf2-aa33-d0ec250dc241/image.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


