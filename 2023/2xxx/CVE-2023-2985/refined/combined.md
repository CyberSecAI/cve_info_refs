=== Content from git.kernel.org_c7e4ac72_20250114_211807.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dongliang Mu <mudongliangabcd@gmail.com> | 2023-02-26 20:49:47 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2023-03-02 21:54:23 -0800 |
| commit | [07db5e247ab5858439b14dd7cc1fe538b9efcf32](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)) | |
| tree | [c208850ebb405da463e783f6c3c6dc4b39f4dd74](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32) | |
| parent | [b905039e428d639adeebb719b76f98865ea38d4d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b905039e428d639adeebb719b76f98865ea38d4d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32&id2=b905039e428d639adeebb719b76f98865ea38d4d)) | |
| download | [linux-07db5e247ab5858439b14dd7cc1fe538b9efcf32.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-07db5e247ab5858439b14dd7cc1fe538b9efcf32.tar.gz) | |

fs: hfsplus: fix UAF issue in hfsplus\_put\_superThe current hfsplus\_put\_super first calls hfs\_btree\_close on
sbi->ext\_tree, then invokes iput on sbi->hidden\_dir, resulting in an
use-after-free issue in hfsplus\_release\_folio.
As shown in hfsplus\_fill\_super, the error handling code also calls iput
before hfs\_btree\_close.
To fix this error, we move all iput calls before hfsplus\_btree\_close.
Note that this patch is tested on Syzbot.
Link: [https://lkml.kernel.org/r/20230226124948.3175736-1-mudongliangabcd@gmail.com](https://lkml.kernel.org/r/20230226124948.3175736-1-mudongliangabcd%40gmail.com)
Reported-by: syzbot+57e3e98f7e3b80f64d56@syzkaller.appspotmail.com
Tested-by: Dongliang Mu <mudongliangabcd@gmail.com>
Signed-off-by: Dongliang Mu <mudongliangabcd@gmail.com>
Cc: Bart Van Assche <bvanassche@acm.org>
Cc: Jens Axboe <axboe@kernel.dk>
Cc: Muchun Song <songmuchun@bytedance.com>
Cc: Roman Gushchin <roman.gushchin@linux.dev>
Cc: "Theodore Ts'o" <tytso@mit.edu>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)

| -rw-r--r-- | [fs/hfsplus/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/hfsplus/super.c?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/fs/hfsplus/super.c b/fs/hfsplus/super.cindex 122ed89ebf9f22..1986b4f18a9013 100644--- a/[fs/hfsplus/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/hfsplus/super.c?id=b905039e428d639adeebb719b76f98865ea38d4d)+++ b/[fs/hfsplus/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/hfsplus/super.c?id=07db5e247ab5858439b14dd7cc1fe538b9efcf32)@@ -295,11 +295,11 @@ static void hfsplus\_put\_super(struct super\_block \*sb) hfsplus\_sync\_fs(sb, 1); } + iput(sbi->alloc\_file);+ iput(sbi->hidden\_dir); hfs\_btree\_close(sbi->attr\_tree); hfs\_btree\_close(sbi->cat\_tree); hfs\_btree\_close(sbi->ext\_tree);- iput(sbi->alloc\_file);- iput(sbi->hidden\_dir); kfree(sbi->s\_vhdr\_buf); kfree(sbi->s\_backup\_vhdr\_buf); unload\_nls(sbi->nls); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 21:16:44 +0000


