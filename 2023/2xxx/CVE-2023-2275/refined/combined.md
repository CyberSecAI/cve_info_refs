=== Content from www.wordfence.com_7fc77f30_20250114_181924.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# WooCommerce Multivendor Marketplace – REST API <= 1.5.3 - Missing Authorization to Authenticated (Subscriber+) Arbitrary Order/Order Note Disclosure, Order Note Addition via REST API

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   WooCommerce Multivendor Marketplace – REST API <= 1.5.3 - Missing Authorization to Authenticated (Subscriber+) Arbitrary Order/Order Note Disclosure, Order Note Addition via REST API

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:L)

| CVE | [CVE-2023-2275](https://www.cve.org/CVERecord?id=CVE-2023-2275) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | April 26, 2023 |
| Last Updated | June 9, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The WooCommerce Multivendor Marketplace – REST API plugin for WordPress is vulnerable to unauthorized access of data and addition of data due to a missing capability check on the 'get\_item', 'get\_order\_notes' and 'add\_order\_note' functions in versions up to, and including, 1.5.3. This makes it possible for authenticated attackers with subscriber privileges or above, to view the order details and order notes, and add order notes.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php#L151)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php#L167)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php#L175)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2904331/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwcfm-marketplace-rest-api%2Fwoocommerce-multivendor-marketplace-rest-api-153-missing-authorization-to-authenticated-subscriber-arbitrary-orderorder-note-disclosure-order-note-addition-via-rest-api&t=WooCommerce%20Multivendor%20Marketplace%20%E2%80%93%20REST%20API%20%3C%3D%201.5.3%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20Order%2FOrder%20Note%20Disclosure%2C%20Order%20Note%20Addition%20via%20REST%20API "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwcfm-marketplace-rest-api%2Fwoocommerce-multivendor-marketplace-rest-api-153-missing-authorization-to-authenticated-subscriber-arbitrary-orderorder-note-disclosure-order-note-addition-via-rest-api&text=WooCommerce%20Multivendor%20Marketplace%20%E2%80%93%20REST%20API%20%3C%3D%201.5.3%20-%20Missing%20Authorization%20to%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20Order%2FOrder%20Note%20Disclosure%2C%20Order%20Note%20Addition%20via%20REST%20API "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwcfm-marketplace-rest-api%2Fwoocommerce-multivendor-marketplace-rest-api-153-missing-authorization-to-authenticated-subscriber-arbitrary-orderorder-note-disclosure-order-note-addition-via-rest-api "LinkedIn")
Email

## Vulnerability Details for WooCommerce Multivendor Marketplace – REST API

#### [WooCommerce Multivendor Marketplace – REST API](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wcfm-marketplace-rest-api)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wcfm-marketplace-rest-api [(view on wordpress.org)](https://wordpress.org/plugins/wcfm-marketplace-rest-api) |
| Patched? | Yes |
| Remediation | Update to version 1.6.0, or a newer patched version |
| Affected Version | * <= 1.5.3 |
| Patched Version | * 1.6.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_486afd82_20250114_181918.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwcfm-marketplace-rest-api%2Ftags%2F1.5.3%2Fincludes%2Fapi%2Fclass-api-order-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [wcfm-marketplace-rest-api](/browser/wcfm-marketplace-rest-api?order=name "View wcfm-marketplace-rest-api")/[tags](/browser/wcfm-marketplace-rest-api/tags?order=name "View tags")/[1.5.3](/browser/wcfm-marketplace-rest-api/tags/1.5.3?order=name "View 1.5.3")/[includes](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes?order=name "View includes")/[api](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api?order=name "View api")/[class-api-order-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?order=name "View class-api-order-controller.php")

View diff against:

View revision:

| [Last change](/changeset/2719086/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php "View differences") on this file was [2719086](/changeset/2719086/ "View changeset 2719086"), checked in by wclovers, [3 years ago](/timeline?from=2022-05-06T07%3A24%3A59Z&precision=second "See timeline at 05/06/2022 07:24:59 AM") |
| --- |
| Version update 1.5.3 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 31.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class WCFM\_REST\_Order\_Controller extends WCFM\_REST\_Controller { |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Endpoint namespace |
| [5](#L5) | \* |
| [6](#L6) | \* @var string |
| [7](#L7) | \*/ |
| [8](#L8) | protected $namespace = 'wcfmmp/v1'; |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Route name |
| [12](#L12) | \* |
| [13](#L13) | \* @var string |
| [14](#L14) | \*/ |
| [15](#L15) | protected $base = 'orders'; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Post type |
| [19](#L19) | \* |
| [20](#L20) | \* @var string |
| [21](#L21) | \*/ |
| [22](#L22) | protected $post\_type = 'shop\_order'; |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Post status |
| [26](#L26) | \*/ |
| [27](#L27) | protected $post\_status = array(); |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Stores the request. |
| [31](#L31) | \* @var array |
| [32](#L32) | \*/ |
| [33](#L33) | protected $request = array(); |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Load autometically when class initiate |
| [37](#L37) | \* |
| [38](#L38) | \* @since 1.0.0 |
| [39](#L39) | \* |
| [40](#L40) | \* @return array |
| [41](#L41) | \*/ |
| [42](#L42) | public function \_\_construct() { |
| [43](#L43) | $this->post\_status = array\_keys( wc\_get\_order\_statuses() ); |
| [44](#L44) |  |
| [45](#L45) | //        add\_filter( 'woocommerce\_new\_order\_data', array( $this, 'set\_order\_vendor\_id' ) ); |
| [46](#L46) | //        add\_action( 'woocommerce\_rest\_insert\_shop\_order\_object', array( $this, 'after\_order\_create' ), 10, 2 ); |
| [47](#L47) | } |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* Register the routes for orders. |
| [51](#L51) | \*/ |
| [52](#L52) | public function register\_routes() { |
| [53](#L53) | register\_rest\_route( $this->namespace, '/' . $this->base, array( |
| [54](#L54) | array( |
| [55](#L55) | 'methods'             => WP\_REST\_Server::READABLE, |
| [56](#L56) | 'callback'            => array( $this, 'get\_items' ), |
| [57](#L57) | 'permission\_callback' => array( $this, 'get\_orders\_permissions\_check' ), |
| [58](#L58) | 'args'                => $this->get\_collection\_params(), |
| [59](#L59) | ), |
| [60](#L60) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [61](#L61) | ) ); |
| [62](#L62) |  |
| [63](#L63) | register\_rest\_route( $this->namespace, '/' . $this->base . '/(?P<id>[\d]+)/', array( |
| [64](#L64) | 'args' => array( |
| [65](#L65) | 'id' => array( |
| [66](#L66) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [67](#L67) | 'type'        => 'integer', |
| [68](#L68) | ) |
| [69](#L69) | ), |
| [70](#L70) | array( |
| [71](#L71) | 'methods'             => WP\_REST\_Server::READABLE, |
| [72](#L72) | 'callback'            => array( $this, 'get\_item' ), |
| [73](#L73) | 'args'                => $this->get\_collection\_params(), |
| [74](#L74) | 'permission\_callback' => array( $this, 'get\_single\_order\_permissions\_check' ), |
| [75](#L75) | ), |
| [76](#L76) | array( |
| [77](#L77) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [78](#L78) | 'callback'            => array( $this, 'update\_order\_status' ), |
| [79](#L79) | 'args'                => array( |
| [80](#L80) | 'status' => array( |
| [81](#L81) | 'type'        => 'string', |
| [82](#L82) | 'description' => \_\_( 'Order Status', 'wcfm-marketplace-rest-api' ), |
| [83](#L83) | 'required'    => true, |
| [84](#L84) | 'sanitize\_callback' => 'sanitize\_text\_field', |
| [85](#L85) | ) |
| [86](#L86) | ), |
| [87](#L87) | 'permission\_callback' => array( $this, 'update\_order\_status\_permissions\_check' ), |
| [88](#L88) | ), |
| [89](#L89) | )); |
| [90](#L90) |  |
| [91](#L91) | register\_rest\_route( $this->namespace, '/' . $this->base . '/note/(?P<id>[\d]+)/', array( |
| [92](#L92) | 'args' => array( |
| [93](#L93) | 'id' => array( |
| [94](#L94) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [95](#L95) | 'type'        => 'integer', |
| [96](#L96) | ) |
| [97](#L97) | ), |
| [98](#L98) | array( |
| [99](#L99) | 'methods'             => WP\_REST\_Server::READABLE, |
| [100](#L100) | 'callback'            => array( $this, 'get\_order\_notes' ), |
| [101](#L101) | 'args'                => $this->get\_collection\_params(), |
| [102](#L102) | 'permission\_callback' => array( $this, 'get\_order\_note\_permissions\_check' ), |
| [103](#L103) | ), |
| [104](#L104) | array( |
| [105](#L105) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [106](#L106) | 'callback'            => array( $this, 'add\_order\_note' ), |
| [107](#L107) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [108](#L108) | 'permission\_callback' => array( $this, 'add\_order\_note\_permissions\_check' ), |
| [109](#L109) | ), |
| [110](#L110) | )); |
| [111](#L111) |  |
| [112](#L112) | register\_rest\_route( $this->namespace, '/' . $this->base . '/shipment\_tracking/', array( |
| [113](#L113) | array( |
| [114](#L114) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [115](#L115) | 'callback'            => array( $this, 'update\_shipment\_tracking' ), |
| [116](#L116) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [117](#L117) | 'permission\_callback' => array( $this, 'update\_shipment\_tracking\_permissions\_check' ), |
| [118](#L118) | ), |
| [119](#L119) | )); |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | /\*\* |
| [123](#L123) | \* Get object. |
| [124](#L124) | \* |
| [125](#L125) | \* @since  1.0.0 |
| [126](#L126) | \* @param  int $id Object ID. |
| [127](#L127) | \* @return WC\_Data |
| [128](#L128) | \*/ |
| [129](#L129) | public function get\_object( $id ) { |
| [130](#L130) | if(!wc\_get\_order($id)) |
| [131](#L131) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", sprintf( \_\_( "Invalid ID", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [132](#L132) | return wc\_get\_order( $id ); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Checking if have any permission to view orders |
| [138](#L138) | \* |
| [139](#L139) | \* @since 1.0.0 |
| [140](#L140) | \* |
| [141](#L141) | \* @return boolean |
| [142](#L142) | \*/ |
| [143](#L143) | public function get\_orders\_permissions\_check() { |
| [144](#L144) | if( !is\_user\_logged\_in() ) |
| [145](#L145) | return false; |
| [146](#L146) | if( apply\_filters( 'wcfm\_is\_allow\_orders', true ) ) |
| [147](#L147) | return true; |
| [148](#L148) | return false; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | public function update\_order\_status\_permissions\_check() { |
| [152](#L152) | if( !is\_user\_logged\_in() ) |
| [153](#L153) | return false; |
| [154](#L154) | if( apply\_filters( 'wcfm\_is\_allow\_order\_status\_update', true ) ) |
| [155](#L155) | return true; |
| [156](#L156) | return false; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function get\_single\_order\_permissions\_check() { |
| [160](#L160) | if( !is\_user\_logged\_in() ) |
| [161](#L161) | return false; |
| [162](#L162) | if( apply\_filters( 'wcfm\_is\_allow\_order\_details', true ) ) |
| [163](#L163) | return true; |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | public function get\_order\_note\_permissions\_check() { |
| [168](#L168) | if( !is\_user\_logged\_in() ) |
| [169](#L169) | return false; |
| [170](#L170) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [171](#L171) | return true; |
| [172](#L172) | return false; |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | public function add\_order\_note\_permissions\_check() { |
| [176](#L176) | if( !is\_user\_logged\_in() ) |
| [177](#L177) | return false; |
| [178](#L178) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [179](#L179) | return true; |
| [180](#L180) | return false; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function update\_shipment\_tracking\_permissions\_check() { |
| [184](#L184) | if( !is\_user\_logged\_in() ) |
| [185](#L185) | return false; |
| [186](#L186) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [187](#L187) | return true; |
| [188](#L188) | return false; |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) |  |
| [192](#L192) | public function get\_post\_type\_items( $request ) { |
| [193](#L193) | global $WCFM; |
| [194](#L194) |  |
| [195](#L195) | $orders = $this->get\_objects\_from\_database($request); |
| [196](#L196) | $order\_return\_obj = array(); |
| [197](#L197) | foreach ($orders as $each\_order ) { |
| [198](#L198) |  |
| [199](#L199) | if($each\_order->vendor\_id) { |
| [200](#L200) | $order\_object = $this->get\_object( $each\_order->order\_id ); |
| [201](#L201) | $formated\_order\_data = $this->get\_formatted\_item\_data($order\_object, $each\_order->vendor\_id ); |
| [202](#L202) | $formated\_order\_data['vendor\_order\_details'] = $each\_order; |
| [203](#L203) | $order\_return\_obj[] =  $formated\_order\_data; |
| [204](#L204) | } else { |
| [205](#L205) | $order\_object = $this->get\_object($each\_order->ID); |
| [206](#L206) |  |
| [207](#L207) | $order\_return\_obj[] = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [208](#L208) | } |
| [209](#L209) | } |
| [210](#L210) | $response = rest\_ensure\_response($order\_return\_obj); |
| [211](#L211) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_objects", $response, $orders, $request ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | protected function get\_objects\_from\_database( $request ) { |
| [215](#L215) | global $WCFM; |
| [216](#L216) | $\_POST["controller"] = 'wcfm-orders'; |
| [217](#L217) | $\_POST['length'] = !empty($request['per\_page']) ? intval($request['per\_page']) : 10; |
| [218](#L218) | $\_POST['start'] = !empty($request['page']) ? ( intval($request['page']) - 1 ) \* $\_POST['length'] : 0; |
| [219](#L219) | //    if(empty($request['page'])){ |
| [220](#L220) | //      $\_POST['start'] = !empty($request['offset']) ? intval($request['offset']) : 0; |
| [221](#L221) | //    } |
| [222](#L222) | $\_POST['filter\_date\_form'] = !empty($request['after']) ? $request['after'] : ''; |
| [223](#L223) | $\_POST['filter\_date\_to'] = !empty($request['before']) ? $request['before'] : ''; |
| [224](#L224) | $\_POST['search']['value'] = !empty($request['search']) ? $request['search'] : ''; |
| [225](#L225) | $\_POST['orderby'] = !empty($request['orderby']) ? $request['orderby'] : ''; |
| [226](#L226) | $\_POST['order'] = !empty($request['order']) ? $request['order'] : ''; |
| [227](#L227) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [228](#L228) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [229](#L229) | $WCFM->init(); |
| [230](#L230) | $orders = $WCFM->ajax->wcfm\_ajax\_controller(); |
| [231](#L231) | return $orders; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) |  |
| [235](#L235) | public function get\_post\_type\_item( $request , $id ) { |
| [236](#L236) | global $WCFM; |
| [237](#L237) | $order\_return\_obj = array(); |
| [238](#L238) | if( wcfm\_is\_vendor() ) { |
| [239](#L239) |  |
| [240](#L240) | $is\_order\_for\_vendor = $WCFM->wcfm\_vendor\_support->wcfm\_is\_order\_for\_vendor( $id ); |
| [241](#L241) | if( $is\_order\_for\_vendor ) { |
| [242](#L242) | $current\_vendor   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [243](#L243) | $order\_object = $this->get\_object( $id ); |
| [244](#L244) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, $current\_vendor ); |
| [245](#L245) | } else { |
| [246](#L246) | return new WP\_Error( "wcfmapi\_rest\_invalid\_vendor", sprintf( \_\_( "Invalid Vendor - Order Id do not belong to the loggedin vendor", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | } else { |
| [250](#L250) | $order\_object = $this->get\_object( $id ); |
| [251](#L251) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [252](#L252) | } |
| [253](#L253) | $response = rest\_ensure\_response($order\_return\_obj); |
| [254](#L254) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_object", $response, $order\_object, $request ); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) |  |
| [258](#L258) | protected function get\_formatted\_item\_data( $object, $each\_order\_vendor\_id ) { |
| [259](#L259) | $data = $object->get\_data(); |
| [260](#L260) | $order\_id = $data['id']; |
| [261](#L261) | $order\_status = $data['status']; |
| [262](#L262) | //print\_r($data);die; |
| [263](#L263) | $format\_date       = array( 'date\_created', 'date\_modified', 'date\_completed', 'date\_paid' ); |
| [264](#L264) | $format\_line\_items = array( 'line\_items', 'tax\_lines', 'shipping\_lines', 'fee\_lines', 'coupon\_lines' ); |
| [265](#L265) |  |
| [266](#L266) | // Format date values. |
| [267](#L267) | foreach ( $format\_date as $key ) { |
| [268](#L268) | $datetime              = $data[ $key ]; |
| [269](#L269) | $data[ $key ]          = wc\_rest\_prepare\_date\_response( $datetime, false ); |
| [270](#L270) | $data[ $key . '\_gmt' ] = wc\_rest\_prepare\_date\_response( $datetime ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | // Format state and country |
| [274](#L274) | if($data['billing']['state']) { |
| [275](#L275) | $data['billing']['state'] = WC()->countries->get\_states( $data['billing']['country'] )[$data['billing']['state']]; |
| [276](#L276) | } |
| [277](#L277) | if($data['shipping']['state']) { |
| [278](#L278) | $data['shipping']['state'] = WC()->countries->get\_states( $data['shipping']['country'] )[$data['shipping']['state']]; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Add Commission Head |
| [282](#L282) | $data['commission\_head'] = $this->wcfmmp\_line\_item\_commission\_head($object, $each\_order\_vendor\_id); |
| [283](#L283) |  |
| [284](#L284) | // Add Delivery datetime & location |
| [285](#L285) | $data['user\_delivery\_location'] = $object->get\_meta('\_wcfmmp\_user\_location', true); |
| [286](#L286) | $wcfmd\_delvery\_times = $object->get\_meta('\_wcfmd\_delvery\_times', true); |
| [287](#L287) | if( !empty(  $wcfmd\_delvery\_times ) ) { |
| [288](#L288) | $data['user\_delivery\_time'] = date('Y-m-d H:i:s', $wcfmd\_delvery\_times[$each\_order\_vendor\_id]); |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | // Format line items. |
| [292](#L292) |  |
| [293](#L293) | foreach ( $format\_line\_items as $key ) { |
| [294](#L294) | if( $each\_order\_vendor\_id ) { |
| [295](#L295) | $line\_item\_datas = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [296](#L296) | $line\_item\_datas\_final = array(); |
| [297](#L297) | //print\_r($line\_item\_datas); |
| [298](#L298) | if($key == 'line\_items') { |
| [299](#L299) | //print\_r($line\_item\_datas); |
| [300](#L300) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [301](#L301) | $order\_item\_product = new WC\_Order\_Item\_Product($line\_item['id']); |
| [302](#L302) | $order\_product\_vendor\_id = $order\_item\_product->get\_meta('\_vendor\_id', true); |
| [303](#L303) | if( $order\_product\_vendor\_id && $order\_product\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [304](#L304) |  |
| [305](#L305) | // Add Store Name |
| [306](#L306) | if( $this->is\_vendor\_sold\_by( absint($order\_product\_vendor\_id) ) ) { |
| [307](#L307) |  |
| [308](#L308) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($order\_product\_vendor\_id) ); |
| [309](#L309) |  |
| [310](#L310) | $line\_item['store\_name'] = $shop\_name; |
| [311](#L311) |  |
| [312](#L312) | } |
| [313](#L313) | // Add Commission Value |
| [314](#L314) | $line\_item['commission\_value'] = $this->wcfmmp\_line\_item\_commission($order\_item\_product, $object, $order\_product\_vendor\_id); |
| [315](#L315) |  |
| [316](#L316) | $line\_item\_datas\_final[] = $line\_item; |
| [317](#L317) | } |
| [318](#L318) | // $line\_item\_datas\_final[] = $line\_item; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) | else if( $key == 'shipping\_lines' ) { |
| [322](#L322) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [323](#L323) | //var\_dump($line\_item['id']); |
| [324](#L324) | $order\_item\_shipping = new WC\_Order\_Item\_Shipping($line\_item['id']); |
| [325](#L325) | $shipping\_vendor\_id = $order\_item\_shipping->get\_meta('vendor\_id', true); |
| [326](#L326) | if( $shipping\_vendor\_id && $shipping\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [327](#L327) |  |
| [328](#L328) | // Add Store Name |
| [329](#L329) | if( $this->is\_vendor\_sold\_by( absint($shipping\_vendor\_id) ) ) { |
| [330](#L330) |  |
| [331](#L331) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($shipping\_vendor\_id) ); |
| [332](#L332) |  |
| [333](#L333) | $line\_item['store\_name'] = $shop\_name; |
| [334](#L334) |  |
| [335](#L335) | } |
| [336](#L336) | $line\_item\_datas\_final[] = $line\_item; |
| [337](#L337) | } |
| [338](#L338) | // $line\_item\_datas\_final[] = $line\_item; |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) | else { |
| [342](#L342) | $line\_item\_datas\_final = $line\_item\_datas; |
| [343](#L343) | } |
| [344](#L344) | $data[ $key ] = $line\_item\_datas\_final; |
| [345](#L345) |  |
| [346](#L346) | } else { |
| [347](#L347) | $data[ $key ] = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // Add Shipment Tracking |
| [352](#L352) | if( ( ( $object->needs\_shipping\_address() && $object->get\_formatted\_shipping\_address() ) || apply\_filters( 'wcfm\_is\_force\_shipping\_address', false ) ) && ( !function\_exists( 'wcs\_order\_contains\_subscription' ) || ( !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) && !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) ) ) && apply\_filters( 'wcfm\_is\_pref\_shipment\_tracking', true ) && apply\_filters( 'wcfm\_is\_allow\_shipping\_tracking', true ) && !in\_array( $order\_status, apply\_filters( 'wcfm\_shipment\_disable\_order\_status', array( 'failed', 'cancelled', 'refunded', 'pending' ) ) ) ) { |
| [353](#L353) |  |
| [354](#L354) | $data['shipment\_tracking'] = $this->get\_order\_shipping\_data( $object ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | $data['status'] = apply\_filters( 'wcfm\_current\_order\_status', $data['status'], $data['id'] ); |
| [358](#L358) |  |
| [359](#L359) | // Format the order status. |
| [360](#L360) | $data['status'] = 'wc-' === substr( $data['status'], 0, 3 ) ? substr( $data['status'], 3 ) : $data['status']; |
| [361](#L361) | return $data; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) |  |
| [365](#L365) | /\*\* |
| [366](#L366) | \* Expands an order item to get its data. |
| [367](#L367) | \* |
| [368](#L368) | \* @param WC\_Order\_item $item |
| [369](#L369) | \* |
| [370](#L370) | \* @return array |
| [371](#L371) | \*/ |
| [372](#L372) | protected function get\_order\_item\_data( $item ) { |
| [373](#L373) |  |
| [374](#L374) | $data           = $item->get\_data(); |
| [375](#L375) |  |
| [376](#L376) | // Add Shop Name |
| [377](#L377) | /\*$meta\_data         = $item->get\_meta\_data(); |
| [378](#L378) | foreach ( $meta\_data as $meta ) { |
| [379](#L379) |  |
| [380](#L380) | if( !is\_array( $meta->key ) ) { |
| [381](#L381) |  |
| [382](#L382) | $meta->key     = rawurldecode( (string) $meta->key ); |
| [383](#L383) |  |
| [384](#L384) | if( $meta->key == '\_vendor\_id' ) { |
| [385](#L385) |  |
| [386](#L386) | $meta->value   = rawurldecode( (string) $meta->value ); |
| [387](#L387) |  |
| [388](#L388) | if( $this->is\_vendor\_sold\_by( absint($meta->value) ) ) { |
| [389](#L389) |  |
| [390](#L390) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($meta->value) ); |
| [391](#L391) |  |
| [392](#L392) | $data['shop\_name'] = $shop\_name; |
| [393](#L393) |  |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | } \*/ |
| [401](#L401) |  |
| [402](#L402) | $format\_decimal = array( 'subtotal', 'subtotal\_tax', 'total', 'total\_tax', 'tax\_total', 'shipping\_tax\_total' ); |
| [403](#L403) |  |
| [404](#L404) | // Format decimal values. |
| [405](#L405) | foreach ( $format\_decimal as $key ) { |
| [406](#L406) | if ( isset( $data[ $key ] ) ) { |
| [407](#L407) | $data[ $key ] = wc\_format\_decimal( $data[ $key ], ( isset($this->request['dp']) ) ? $this->request['dp'] : false ); |
| [408](#L408) | } |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | // Add SKU, THUMBNAIL and PRICE to products. |
| [412](#L412) | if ( is\_callable( array( $item, 'get\_product' ) ) ) { |
| [413](#L413) | $\_product = $item->get\_product(); |
| [414](#L414) | $data['sku']   = $\_product ? $\_product->get\_sku(): null; |
| [415](#L415) | $data['thumbnail']     = $\_product ? apply\_filters( 'woocommerce\_admin\_order\_item\_thumbnail', $\_product->get\_image( 'thumbnail', array( 'title' => '' ), false ), $data['id'], $item ) : ''; |
| [416](#L416) | $data['image\_url'] = $\_product ? wp\_get\_attachment\_image\_url( $\_product->get\_image\_id(), 'thumbnail' ) : null; |
| [417](#L417) | $data['price'] = (float)( $item->get\_total() / max( 1, $item->get\_quantity() ) ); |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | // Format taxes. |
| [421](#L421) | if ( ! empty( $data['taxes']['total'] ) ) { |
| [422](#L422) | $taxes = array(); |
| [423](#L423) |  |
| [424](#L424) | foreach ( $data['taxes']['total'] as $tax\_rate\_id => $tax ) { |
| [425](#L425) | $taxes[] = array( |
| [426](#L426) | 'id'       => $tax\_rate\_id, |
| [427](#L427) | 'total'    => $tax, |
| [428](#L428) | 'subtotal' => isset( $data['taxes']['subtotal'][ $tax\_rate\_id ] ) ? $data['taxes']['subtotal'][ $tax\_rate\_id ] : '', |
| [429](#L429) | ); |
| [430](#L430) | } |
| [431](#L431) | $data['taxes'] = $taxes; |
| [432](#L432) | } elseif ( isset( $data['taxes'] ) ) { |
| [433](#L433) | $data['taxes'] = array(); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | // Remove names for coupons, taxes and shipping. |
| [437](#L437) | if ( isset( $data['code'] ) || isset( $data['rate\_code'] ) || isset( $data['method\_title'] ) ) { |
| [438](#L438) | unset( $data['name'] ); |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | // Remove props we don't want to expose. |
| [442](#L442) | unset( $data['order\_id'] ); |
| [443](#L443) | unset( $data['type'] ); |
| [444](#L444) |  |
| [445](#L445) | return $data; |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) |  |
| [450](#L450) | \* Return is show sold by label |
| [451](#L451) |  |
| [452](#L452) | \* @return boolean |
| [453](#L453) |  |
| [454](#L454) | \*/ |
| [455](#L455) |  |
| [456](#L456) | public function is\_vendor\_sold\_by( $vendor\_id = '' ) { |
| [457](#L457) |  |
| [458](#L458) | global $WCFM, $WCFMmp; |
| [459](#L459) |  |
| [460](#L460) |  |
| [461](#L461) |  |
| [462](#L462) | $wcfmmp\_marketplace\_options   = get\_option( 'wcfm\_marketplace\_options', array() ); |
| [463](#L463) |  |
| [464](#L464) | $vendor\_sold\_by = isset( $wcfmmp\_marketplace\_options['vendor\_sold\_by'] ) ? $wcfmmp\_marketplace\_options['vendor\_sold\_by'] : 'yes'; |
| [465](#L465) |  |
| [466](#L466) | if( $vendor\_sold\_by == 'yes' ) { |
| [467](#L467) |  |
| [468](#L468) | if( !$vendor\_id || ( $vendor\_id && apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $vendor\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $vendor\_id, 'sold\_by' ) ) ) { |
| [469](#L469) |  |
| [470](#L470) | return true; |
| [471](#L471) |  |
| [472](#L472) | } else { |
| [473](#L473) |  |
| [474](#L474) | return false; |
| [475](#L475) |  |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | return false; |
| [481](#L481) |  |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | // WCFMmp Line Item Commission Head |
| [485](#L485) |  |
| [486](#L486) | protected function wcfmmp\_line\_item\_commission\_head( $order, $vendor\_id ) { |
| [487](#L487) |  |
| [488](#L488) | global $WCFM, $WCFMmp; |
| [489](#L489) |  |
| [490](#L490) |  |
| [491](#L491) | if( wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) { |
| [492](#L492) |  |
| [493](#L493) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [494](#L494) |  |
| [495](#L495) | if( $admin\_fee\_mode ) { |
| [496](#L496) |  |
| [497](#L497) | return \_\_( 'Fees', 'wc-frontend-manager' ); |
| [498](#L498) |  |
| [499](#L499) | } else { |
| [500](#L500) |  |
| [501](#L501) | return \_\_( 'Earning', 'wc-frontend-manager' ); |
| [502](#L502) |  |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | // WCFMmp Line item Commission |
| [510](#L510) |  |
| [511](#L511) | protected function wcfmmp\_line\_item\_commission( $item, $order, $vendor\_id ) { |
| [512](#L512) |  |
| [513](#L513) | global $WCFM, $wpdb, $WCFMmp; |
| [514](#L514) |  |
| [515](#L515) | if( !wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) return; |
| [516](#L516) |  |
| [517](#L517) | $order\_currency = $order->get\_currency(); |
| [518](#L518) |  |
| [519](#L519) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [520](#L520) |  |
| [521](#L521) | $qty = ( isset( $item['qty'] ) ? esc\_html( $item['qty'] ) : '1' ); |
| [522](#L522) |  |
| [523](#L523) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_deduct\_discount( $vendor\_id, $order->get\_id() ) ) { |
| [524](#L524) |  |
| [525](#L525) | $line\_total = $item->get\_total(); |
| [526](#L526) |  |
| [527](#L527) | } else { |
| [528](#L528) |  |
| [529](#L529) | $line\_total = $item->get\_subtotal(); |
| [530](#L530) |  |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | if( $item->get\_product\_id() ) { |
| [534](#L534) |  |
| [535](#L535) | $product\_id = $item->get\_product\_id(); |
| [536](#L536) |  |
| [537](#L537) | $variation\_id = $item->get\_variation\_id(); |
| [538](#L538) |  |
| [539](#L539) | } else { |
| [540](#L540) |  |
| [541](#L541) | $product\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_product\_id', true ); |
| [542](#L542) |  |
| [543](#L543) | $variation\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_variation\_id', true ); |
| [544](#L544) |  |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $sql = " |
| [548](#L548) |  |
| [549](#L549) | SELECT item\_id, is\_refunded, commission\_amount AS line\_total, shipping AS total\_shipping, tax, shipping\_tax\_amount |
| [550](#L550) |  |
| [551](#L551) | FROM {$wpdb->prefix}wcfm\_marketplace\_orders |
| [552](#L552) |  |
| [553](#L553) | WHERE (product\_id = " . $product\_id . " OR variation\_id = " . $variation\_id . ") |
| [554](#L554) |  |
| [555](#L555) | AND   order\_id    = " . $order->get\_id() . " |
| [556](#L556) |  |
| [557](#L557) | AND   item\_id     = " . $item->get\_id() . " |
| [558](#L558) |  |
| [559](#L559) | AND   `vendor\_id` = " . $vendor\_id; |
| [560](#L560) |  |
| [561](#L561) | $order\_line\_due = $wpdb->get\_results( $sql ); |
| [562](#L562) |  |
| [563](#L563) |  |
| [564](#L564) |  |
| [565](#L565) | if( !empty( $order\_line\_due ) && !$order\_line\_due[0]->is\_refunded ) { |
| [566](#L566) |  |
| [567](#L567) | if ( $get\_shipping = $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_shipping( $vendor\_id ) ) { |
| [568](#L568) |  |
| [569](#L569) | //$line\_total += $order\_line\_due[0]->total\_shipping; |
| [570](#L570) |  |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_tax( $vendor\_id ) ) { |
| [574](#L574) |  |
| [575](#L575) | $line\_total += $order\_line\_due[0]->tax; |
| [576](#L576) |  |
| [577](#L577) | $order\_line\_due[0]->line\_total += $order\_line\_due[0]->tax; |
| [578](#L578) |  |
| [579](#L579) | if( $get\_shipping ) { |
| [580](#L580) |  |
| [581](#L581) | //$line\_total += $order\_line\_due[0]->shipping\_tax\_amount; |
| [582](#L582) |  |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | if( $admin\_fee\_mode ) { |
| [588](#L588) |  |
| [589](#L589) | $refunded = $order->get\_total\_refunded\_for\_item( $item->get\_id() ); |
| [590](#L590) |  |
| [591](#L591) | return $line\_total - $refunded - $order\_line\_due[0]->line\_total; |
| [592](#L592) |  |
| [593](#L593) | } else { |
| [594](#L594) |  |
| [595](#L595) | return $order\_line\_due[0]->line\_total; |
| [596](#L596) |  |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | } else { |
| [600](#L600) |  |
| [601](#L601) | return 0; |
| [602](#L602) |  |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* |
| [609](#L609) | \* |
| [610](#L610) | \*/ |
| [611](#L611) | protected function get\_order\_shipping\_data( $order ) { |
| [612](#L612) |  |
| [613](#L613) | global $WCFM; |
| [614](#L614) |  |
| [615](#L615) | $needs\_shipping\_tracking = false; |
| [616](#L616) |  |
| [617](#L617) | $product\_ids = array(); |
| [618](#L618) |  |
| [619](#L619) | $order\_item\_ids = array(); |
| [620](#L620) |  |
| [621](#L621) | $line\_items = $order->get\_items( 'line\_item' ); |
| [622](#L622) |  |
| [623](#L623) | $line\_items = apply\_filters( 'wcfm\_valid\_line\_items', $line\_items, $order->get\_id() ); |
| [624](#L624) |  |
| [625](#L625) | $shipment\_tracking\_data = array(); |
| [626](#L626) |  |
| [627](#L627) | foreach ( $line\_items as $item\_id => $item ) { |
| [628](#L628) |  |
| [629](#L629) | $each\_data = array(); |
| [630](#L630) |  |
| [631](#L631) | $\_product  = $item->get\_product(); |
| [632](#L632) |  |
| [633](#L633) | $needs\_shipping = $WCFM->frontend->is\_wcfm\_needs\_shipping( $\_product ); |
| [634](#L634) |  |
| [635](#L635) | $shipped = true; |
| [636](#L636) |  |
| [637](#L637) | $tracking\_url  = ''; |
| [638](#L638) |  |
| [639](#L639) | $tracking\_code = ''; |
| [640](#L640) |  |
| [641](#L641) | $delivery\_boy  = ''; |
| [642](#L642) |  |
| [643](#L643) | $delivery\_boy\_name = ''; |
| [644](#L644) |  |
| [645](#L645) | if( $needs\_shipping ) { |
| [646](#L646) |  |
| [647](#L647) | $shipped = false; |
| [648](#L648) |  |
| [649](#L649) | foreach ( $item->get\_formatted\_meta\_data() as $meta\_id => $meta ) { |
| [650](#L650) |  |
| [651](#L651) | if( $meta->key == 'wcfm\_tracking\_url' ) { |
| [652](#L652) |  |
| [653](#L653) | $tracking\_url  = $meta->value; |
| [654](#L654) |  |
| [655](#L655) | $shipped = true; |
| [656](#L656) |  |
| [657](#L657) | } elseif( $meta->key == 'wcfm\_tracking\_code' ) { |
| [658](#L658) |  |
| [659](#L659) | $tracking\_code  = $meta->value; |
| [660](#L660) |  |
| [661](#L661) | } elseif( $meta->key == 'wcfm\_delivery\_boy' ) { |
| [662](#L662) |  |
| [663](#L663) | $delivery\_boy  = $meta->value; |
| [664](#L664) |  |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | } else { |
| [670](#L670) |  |
| [671](#L671) | continue; |
| [672](#L672) |  |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | $order\_item\_ids[] = $item->get\_id(); |
| [676](#L676) |  |
| [677](#L677) | $product\_ids[]    = $item->get\_product\_id(); |
| [678](#L678) |  |
| [679](#L679) | $each\_data['item\_id'] = $item->get\_id(); |
| [680](#L680) | $each\_data['product\_id'] = $item->get\_product\_id(); |
| [681](#L681) |  |
| [682](#L682) | //if( $shipped ) continue; |
| [683](#L683) |  |
| [684](#L684) | $needs\_shipping\_tracking = true; |
| [685](#L685) |  |
| [686](#L686) |  |
| [687](#L687) | if( ( !empty( $product\_ids ) && ( count( $product\_ids ) == 1 ) ) || apply\_filters( 'wcfm\_is\_allow\_itemwise\_notification', true ) ) { |
| [688](#L688) |  |
| [689](#L689) | $each\_data['product\_name'] = esc\_html( $item->get\_name() ); |
| [690](#L690) |  |
| [691](#L691) | if ( $\_product && $\_product->get\_sku() ) { |
| [692](#L692) |  |
| [693](#L693) | $each\_data['sku'] = esc\_html( $\_product->get\_sku() ); |
| [694](#L694) |  |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | if ( $tracking\_code ) { |
| [698](#L698) |  |
| [699](#L699) | $each\_data['tracking\_code'] = $tracking\_code; |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | if ( $tracking\_url ) { |
| [704](#L704) |  |
| [705](#L705) | $each\_data['tracking\_url'] = $tracking\_url; |
| [706](#L706) |  |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( $delivery\_boy ) { |
| [710](#L710) |  |
| [711](#L711) | $each\_data['delivery\_boy'] = $delivery\_boy; |
| [712](#L712) | $wcfm\_delivery\_boy\_user = get\_userdata( absint( $delivery\_boy ) ); |
| [713](#L713) | if ( $wcfm\_delivery\_boy\_user ) { |
| [714](#L714) | $delivery\_boy\_name = apply\_filters( 'wcfm\_delivery\_boy\_display', $wcfm\_delivery\_boy\_user->first\_name . ' ' . $wcfm\_delivery\_boy\_user->last\_name, $delivery\_boy ); |
| [715](#L715) | $each\_data['delivery\_boy\_name'] = $delivery\_boy\_name; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | if ( function\_exists( 'wcfm\_is\_order\_delivered' ) ) { |
| [721](#L721) |  |
| [722](#L722) | $is\_order\_delivered = wcfm\_is\_order\_delivered( $order->get\_id(), $item\_id ); |
| [723](#L723) |  |
| [724](#L724) | if( $is\_order\_delivered ) { |
| [725](#L725) |  |
| [726](#L726) | $each\_data['delivery\_status'] = 'completed'; |
| [727](#L727) |  |
| [728](#L728) | } else { |
| [729](#L729) |  |
| [730](#L730) | $each\_data['delivery\_status'] = 'pending'; |
| [731](#L731) |  |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | if( $\_product ) { |
| [736](#L736) |  |
| [737](#L737) | $each\_data['mark\_shipped'] = true; |
| [738](#L738) |  |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | $shipment\_tracking\_data['each\_data'][] = $each\_data; |
| [743](#L743) |  |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | if( !empty( $product\_ids ) && ( count( $product\_ids ) > 1 ) ) { |
| [747](#L747) |  |
| [748](#L748) | $shipment\_tracking\_data['mark\_all'] = array( |
| [749](#L749) |  |
| [750](#L750) | 'product\_ids' => $product\_ids, |
| [751](#L751) | 'order\_item\_ids' => $order\_item\_ids |
| [752](#L752) |  |
| [753](#L753) | ); |
| [754](#L754) |  |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | $wcfm\_delivery\_boys\_array = function\_exists( 'wcfm\_get\_delivery\_boys' ) ? wcfm\_get\_delivery\_boys() : array(); |
| [758](#L758) |  |
| [759](#L759) | if(!empty($wcfm\_delivery\_boys\_array)) { |
| [760](#L760) |  |
| [761](#L761) | $delivery\_users = array(); |
| [762](#L762) |  |
| [763](#L763) | foreach( $wcfm\_delivery\_boys\_array as $wcfm\_delivery\_boys\_single ) { |
| [764](#L764) |  |
| [765](#L765) | $delivery\_users[] = array( 'id' => $wcfm\_delivery\_boys\_single->ID, |
| [766](#L766) | 'name' => $wcfm\_delivery\_boys\_single->first\_name . ' ' . $wcfm\_delivery\_boys\_single->last\_name . ' (' . $wcfm\_delivery\_boys\_single->user\_email . ')'); |
| [767](#L767) |  |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | $shipment\_tracking\_data['delivery\_boys'] = $delivery\_users; |
| [771](#L771) |  |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | return $shipment\_tracking\_data; |
| [775](#L775) |  |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | public function update\_shipment\_tracking( $request ) { |
| [779](#L779) | global $WCFM, $WCFMu, $WCFMd; |
| [780](#L780) |  |
| [781](#L781) | $\_POST['orderid'] = !empty($request['order\_id']) ? $request['order\_id'] : ''; |
| [782](#L782) |  |
| [783](#L783) | $\_POST['tracking\_data'] = ""; |
| [784](#L784) |  |
| [785](#L785) | $\_POST['tracking\_data'] .= "wcfm\_tracking\_order\_id="; |
| [786](#L786) | $\_POST['tracking\_data'] .= !empty($request['order\_id']) ? $request['order\_id'] : ""; |
| [787](#L787) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_product\_id="; |
| [788](#L788) | $\_POST['tracking\_data'] .= !empty($request['product\_id']) ? $request['product\_id'] : ""; |
| [789](#L789) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_order\_item\_id="; |
| [790](#L790) | $\_POST['tracking\_data'] .= !empty($request['item\_id']) ? $request['item\_id'] : ""; |
| [791](#L791) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_url="; |
| [792](#L792) | $\_POST['tracking\_data'] .= !empty($request['tracking\_url']) ? $request['tracking\_url'] : ""; |
| [793](#L793) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_code="; |
| [794](#L794) | $\_POST['tracking\_data'] .= !empty($request['tracking\_code']) ? $request['tracking\_code'] : ""; |
| [795](#L795) | $\_POST['tracking\_data'] .= "&wcfm\_delivery\_boy="; |
| [796](#L796) | $\_POST['tracking\_data'] .= !empty($request['delivery\_boy']) ? $request['delivery\_boy'] : ""; |
| [797](#L797) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [798](#L798) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [799](#L799) | if(WCFMapi\_Dependencies::wcfmapi\_ultimate\_plugin\_active\_check()) { |
| [800](#L800) | $WCFMu->init\_wcfmu(); |
| [801](#L801) | $wcfm\_tracking\_data = $WCFMu->wcfmu\_shipment\_tracking->wcfm\_wcfmmarketplace\_order\_mark\_shipped(); |
| [802](#L802) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [803](#L803) | $order    = wc\_get\_order( $order\_id ); |
| [804](#L804) | $response = array('order\_id' => $order\_id); |
| [805](#L805) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [806](#L806) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [807](#L807) |  |
| [808](#L808) | return rest\_ensure\_response( $response ); |
| [809](#L809) | } elseif( !empty($request['delivery\_boy']) ) { |
| [810](#L810) | $WCFMd->init\_wcfmd(); |
| [811](#L811) | $wcfm\_tracking\_data = $WCFMd->ajax->wcfmd\_delivery\_boy\_assign(); |
| [812](#L812) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [813](#L813) | $order    = wc\_get\_order( $order\_id ); |
| [814](#L814) | $response = array('order\_id' => $order\_id); |
| [815](#L815) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [816](#L816) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [817](#L817) | return rest\_ensure\_response( $response ); |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | public function update\_order\_status( $request ) { |
| [823](#L823) |  |
| [824](#L824) | global $WCFM; |
| [825](#L825) |  |
| [826](#L826) | $id             = isset( $request['id'] ) ? absint( $request['id'] ) : 0; |
| [827](#L827) | $status         = isset( $request['status'] ) ? $request['status'] : ''; |
| [828](#L828) |  |
| [829](#L829) | if(substr($status, 0, 2) !== 'wc-'){ |
| [830](#L830) | $status = 'wc-' . $status; |
| [831](#L831) | } |
| [832](#L832) | $order\_statuses = wc\_get\_order\_statuses(); |
| [833](#L833) |  |
| [834](#L834) | if ( empty( $id ) ) { |
| [835](#L835) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", \_\_( 'Invalid order ID', 'wcfm-marketplace-rest-api' ), array( |
| [836](#L836) | 'status' => 404, |
| [837](#L837) | ) ); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | if ( empty( $status ) ) { |
| [841](#L841) | return new WP\_Error( "wcfmapi\_rest\_empty\_{$this->post\_type}\_status", \_\_( 'Order status must me required', 'wcfm-marketplace-rest-api' ), array( |
| [842](#L842) | 'status' => 404, |
| [843](#L843) | ) ); |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | if ( ! in\_array( $status, array\_keys( $order\_statuses ) ) ) { |
| [847](#L847) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_status", \_\_( 'Order status not valid', 'wcfm-marketplace-rest-api' ), array( |
| [848](#L848) | 'status' => 404, |
| [849](#L849) | ) ); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | // $order = $this->get\_object( $id ); |
| [853](#L853) | // $order->set\_status( $status ); |
| [854](#L854) | // $order =  apply\_filters( "wcfmapi\_rest\_pre\_insert\_{$this->post\_type}\_object", $order, $request ); |
| [855](#L855) | // $order->save(); |
| [856](#L856) | $\_POST['order\_id'] = $id; |
| [857](#L857) | $\_POST['order\_status'] = $status; |
| [858](#L858) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [859](#L859) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [860](#L860) | $WCFM->init(); |
| [861](#L861) | $order\_status\_change = $WCFM->ajax->wcfm\_modify\_order\_status(); |
| [862](#L862) | return $this->get\_post\_type\_item($request, $id); |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | /\*\* |
| [866](#L866) |  |
| [867](#L867) | \* Handle Order Note Add |
| [868](#L868) |  |
| [869](#L869) | \*/ |
| [870](#L870) |  |
| [871](#L871) | public function add\_order\_note( $request ) { |
| [872](#L872) |  |
| [873](#L873) | global $WCFM, $WCFMu, $woocommerce; |
| [874](#L874) |  |
| [875](#L875) |  |
| [876](#L876) | $user\_id   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [877](#L877) |  |
| [878](#L878) | $user      = $user\_id; |
| [879](#L879) | $comment\_id = ''; |
| [880](#L880) |  |
| [881](#L881) |  |
| [882](#L882) | //parse\_str($\_POST['note\_data'], $wcfm\_note\_data); |
| [883](#L883) |  |
| [884](#L884) | $order\_id   = absint( $request['id'] ); |
| [885](#L885) | //$noteData = $request['noteData']; |
| [886](#L886) |  |
| [887](#L887) | $note       = apply\_filters( 'wcfm\_editor\_content\_before\_save', wp\_kses\_post( trim( stripslashes( $request['note'] ) ) ) ); |
| [888](#L888) |  |
| [889](#L889) | $note\_type  = $request['note\_type']; |
| [890](#L890) |  |
| [891](#L891) |  |
| [892](#L892) |  |
| [893](#L893) | $is\_customer\_note = $note\_type == 'customer' ? 1 : 0; |
| [894](#L894) |  |
| [895](#L895) | $note\_class = ''; |
| [896](#L896) |  |
| [897](#L897) | if($is\_customer\_note) $note\_class = 'customer-note'; |
| [898](#L898) |  |
| [899](#L899) |  |
| [900](#L900) |  |
| [901](#L901) | if ( $order\_id > 0 ) { |
| [902](#L902) |  |
| [903](#L903) | $order      = wc\_get\_order( $order\_id ); |
| [904](#L904) |  |
| [905](#L905) | if( apply\_filters( 'wcfm\_is\_allow\_order\_note\_attachments', true ) ) { |
| [906](#L906) |  |
| [907](#L907) | $attachments = $request['attachments']; |
| [908](#L908) |  |
| [909](#L909) | if( !empty( $attachments ) ) { |
| [910](#L910) |  |
| [911](#L911) | $attachment\_data = ''; |
| [912](#L912) |  |
| [913](#L913) | foreach( $attachments as $index => $attachment ) { |
| [914](#L914) |  |
| [915](#L915) | if( isset( $attachment['attachmentData'] ) && !empty( $attachment['attachmentData'] ) ) { |
| [916](#L916) |  |
| [917](#L917) | $name = !empty( $attachment['attachmentText'] ) ? $attachment['attachmentText'] : \_\_  ( 'Attachment', 'wc-frontend-manager-ultimate' ) . ' ' . $index; |
| [918](#L918) |  |
| [919](#L919) | if( $index != 0  ) $note .= ',&nbsp;'; |
| [920](#L920) |  |
| [921](#L921) | $attachment\_data .= '<a class="wcfm\_dashboard\_item\_title wcfm\_linked\_attached" target="\_blank" href="' . $attachment['attachmentData']['source\_url'] . '">' . $name . '</a>'; |
| [922](#L922) |  |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if( !empty( $attachment\_data ) ) { |
| [928](#L928) |  |
| [929](#L929) | $note .= "<br />" . \_\_  ( 'Attachments', 'wc-frontend-manager-ultimate' ) . ': ' . $attachment\_data; |
| [930](#L930) |  |
| [931](#L931) | } |
| [932](#L932) |  |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) |  |
| [938](#L938) |  |
| [939](#L939) | $note = apply\_filters( 'wcfm\_order\_note\_before\_save', $note, $request ); |
| [940](#L940) |  |
| [941](#L941) |  |
| [942](#L942) |  |
| [943](#L943) | // Vendor association |
| [944](#L944) |  |
| [945](#L945) | if( wcfm\_is\_vendor() ) { |
| [946](#L946) |  |
| [947](#L947) | if( apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $user\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $user\_id, 'sold\_by' ) && apply\_filters( 'wcfm\_is\_allow\_order\_note\_vendor\_reference', true ) ) { |
| [948](#L948) |  |
| [949](#L949) | $note = sprintf( \_\_( '%s has added the following note', 'wc-frontend-manager-ultimate' ), wcfm\_get\_vendor\_store( $user\_id ) ) . ': ' . "<br />"  . $note; |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) |  |
| [954](#L954) |  |
| [955](#L955) | add\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [956](#L956) |  |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) |  |
| [960](#L960) |  |
| [961](#L961) | $comment\_id = $order->add\_order\_note( $note, $is\_customer\_note, true ); |
| [962](#L962) |  |
| [963](#L963) |  |
| [964](#L964) |  |
| [965](#L965) | // Vendor association |
| [966](#L966) |  |
| [967](#L967) | if( wcfm\_is\_vendor() ) remove\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [968](#L968) |  |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | $notes = $this->get\_order\_notes(array('id' => $request['id'])); |
| [972](#L972) | $response = rest\_ensure\_response($notes); |
| [973](#L973) | return $response; |
| [974](#L974) |  |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) |  |
| [978](#L978) | public function get\_order\_notes( $request ) { |
| [979](#L979) |  |
| [980](#L980) | $args = array( |
| [981](#L981) |  |
| [982](#L982) | 'post\_id'   => $request['id'], |
| [983](#L983) |  |
| [984](#L984) | 'orderby'   => 'comment\_ID', |
| [985](#L985) |  |
| [986](#L986) | 'order'     => 'DESC', |
| [987](#L987) |  |
| [988](#L988) | 'approve'   => 'approve', |
| [989](#L989) |  |
| [990](#L990) | 'type'      => 'order\_note' |
| [991](#L991) |  |
| [992](#L992) | ); |
| [993](#L993) |  |
| [994](#L994) | $args = apply\_filters( 'wcfm\_order\_notes\_args', $args ); |
| [995](#L995) |  |
| [996](#L996) | //$notes = apply\_filters( 'wcfm\_order\_notes', get\_comments( $args ), $request['id'] ); |
| [997](#L997) |  |
| [998](#L998) | $notes = wc\_get\_order\_notes( $args ); |
| [999](#L999) |  |
| [1000](#L1000) | $response = rest\_ensure\_response($notes); |
| [1001](#L1001) |  |
| [1002](#L1002) | return $response; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) |  |
| [1006](#L1006) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?format=txt)
* [Original Format](/export/3222433/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_57609a60_20250114_181919.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwcfm-marketplace-rest-api%2Ftags%2F1.5.3%2Fincludes%2Fapi%2Fclass-api-order-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [wcfm-marketplace-rest-api](/browser/wcfm-marketplace-rest-api?order=name "View wcfm-marketplace-rest-api")/[tags](/browser/wcfm-marketplace-rest-api/tags?order=name "View tags")/[1.5.3](/browser/wcfm-marketplace-rest-api/tags/1.5.3?order=name "View 1.5.3")/[includes](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes?order=name "View includes")/[api](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api?order=name "View api")/[class-api-order-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?order=name "View class-api-order-controller.php")

View diff against:

View revision:

| [Last change](/changeset/2719086/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php "View differences") on this file was [2719086](/changeset/2719086/ "View changeset 2719086"), checked in by wclovers, [3 years ago](/timeline?from=2022-05-06T07%3A24%3A59Z&precision=second "See timeline at 05/06/2022 07:24:59 AM") |
| --- |
| Version update 1.5.3 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 31.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class WCFM\_REST\_Order\_Controller extends WCFM\_REST\_Controller { |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Endpoint namespace |
| [5](#L5) | \* |
| [6](#L6) | \* @var string |
| [7](#L7) | \*/ |
| [8](#L8) | protected $namespace = 'wcfmmp/v1'; |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Route name |
| [12](#L12) | \* |
| [13](#L13) | \* @var string |
| [14](#L14) | \*/ |
| [15](#L15) | protected $base = 'orders'; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Post type |
| [19](#L19) | \* |
| [20](#L20) | \* @var string |
| [21](#L21) | \*/ |
| [22](#L22) | protected $post\_type = 'shop\_order'; |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Post status |
| [26](#L26) | \*/ |
| [27](#L27) | protected $post\_status = array(); |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Stores the request. |
| [31](#L31) | \* @var array |
| [32](#L32) | \*/ |
| [33](#L33) | protected $request = array(); |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Load autometically when class initiate |
| [37](#L37) | \* |
| [38](#L38) | \* @since 1.0.0 |
| [39](#L39) | \* |
| [40](#L40) | \* @return array |
| [41](#L41) | \*/ |
| [42](#L42) | public function \_\_construct() { |
| [43](#L43) | $this->post\_status = array\_keys( wc\_get\_order\_statuses() ); |
| [44](#L44) |  |
| [45](#L45) | //        add\_filter( 'woocommerce\_new\_order\_data', array( $this, 'set\_order\_vendor\_id' ) ); |
| [46](#L46) | //        add\_action( 'woocommerce\_rest\_insert\_shop\_order\_object', array( $this, 'after\_order\_create' ), 10, 2 ); |
| [47](#L47) | } |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* Register the routes for orders. |
| [51](#L51) | \*/ |
| [52](#L52) | public function register\_routes() { |
| [53](#L53) | register\_rest\_route( $this->namespace, '/' . $this->base, array( |
| [54](#L54) | array( |
| [55](#L55) | 'methods'             => WP\_REST\_Server::READABLE, |
| [56](#L56) | 'callback'            => array( $this, 'get\_items' ), |
| [57](#L57) | 'permission\_callback' => array( $this, 'get\_orders\_permissions\_check' ), |
| [58](#L58) | 'args'                => $this->get\_collection\_params(), |
| [59](#L59) | ), |
| [60](#L60) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [61](#L61) | ) ); |
| [62](#L62) |  |
| [63](#L63) | register\_rest\_route( $this->namespace, '/' . $this->base . '/(?P<id>[\d]+)/', array( |
| [64](#L64) | 'args' => array( |
| [65](#L65) | 'id' => array( |
| [66](#L66) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [67](#L67) | 'type'        => 'integer', |
| [68](#L68) | ) |
| [69](#L69) | ), |
| [70](#L70) | array( |
| [71](#L71) | 'methods'             => WP\_REST\_Server::READABLE, |
| [72](#L72) | 'callback'            => array( $this, 'get\_item' ), |
| [73](#L73) | 'args'                => $this->get\_collection\_params(), |
| [74](#L74) | 'permission\_callback' => array( $this, 'get\_single\_order\_permissions\_check' ), |
| [75](#L75) | ), |
| [76](#L76) | array( |
| [77](#L77) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [78](#L78) | 'callback'            => array( $this, 'update\_order\_status' ), |
| [79](#L79) | 'args'                => array( |
| [80](#L80) | 'status' => array( |
| [81](#L81) | 'type'        => 'string', |
| [82](#L82) | 'description' => \_\_( 'Order Status', 'wcfm-marketplace-rest-api' ), |
| [83](#L83) | 'required'    => true, |
| [84](#L84) | 'sanitize\_callback' => 'sanitize\_text\_field', |
| [85](#L85) | ) |
| [86](#L86) | ), |
| [87](#L87) | 'permission\_callback' => array( $this, 'update\_order\_status\_permissions\_check' ), |
| [88](#L88) | ), |
| [89](#L89) | )); |
| [90](#L90) |  |
| [91](#L91) | register\_rest\_route( $this->namespace, '/' . $this->base . '/note/(?P<id>[\d]+)/', array( |
| [92](#L92) | 'args' => array( |
| [93](#L93) | 'id' => array( |
| [94](#L94) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [95](#L95) | 'type'        => 'integer', |
| [96](#L96) | ) |
| [97](#L97) | ), |
| [98](#L98) | array( |
| [99](#L99) | 'methods'             => WP\_REST\_Server::READABLE, |
| [100](#L100) | 'callback'            => array( $this, 'get\_order\_notes' ), |
| [101](#L101) | 'args'                => $this->get\_collection\_params(), |
| [102](#L102) | 'permission\_callback' => array( $this, 'get\_order\_note\_permissions\_check' ), |
| [103](#L103) | ), |
| [104](#L104) | array( |
| [105](#L105) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [106](#L106) | 'callback'            => array( $this, 'add\_order\_note' ), |
| [107](#L107) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [108](#L108) | 'permission\_callback' => array( $this, 'add\_order\_note\_permissions\_check' ), |
| [109](#L109) | ), |
| [110](#L110) | )); |
| [111](#L111) |  |
| [112](#L112) | register\_rest\_route( $this->namespace, '/' . $this->base . '/shipment\_tracking/', array( |
| [113](#L113) | array( |
| [114](#L114) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [115](#L115) | 'callback'            => array( $this, 'update\_shipment\_tracking' ), |
| [116](#L116) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [117](#L117) | 'permission\_callback' => array( $this, 'update\_shipment\_tracking\_permissions\_check' ), |
| [118](#L118) | ), |
| [119](#L119) | )); |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | /\*\* |
| [123](#L123) | \* Get object. |
| [124](#L124) | \* |
| [125](#L125) | \* @since  1.0.0 |
| [126](#L126) | \* @param  int $id Object ID. |
| [127](#L127) | \* @return WC\_Data |
| [128](#L128) | \*/ |
| [129](#L129) | public function get\_object( $id ) { |
| [130](#L130) | if(!wc\_get\_order($id)) |
| [131](#L131) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", sprintf( \_\_( "Invalid ID", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [132](#L132) | return wc\_get\_order( $id ); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Checking if have any permission to view orders |
| [138](#L138) | \* |
| [139](#L139) | \* @since 1.0.0 |
| [140](#L140) | \* |
| [141](#L141) | \* @return boolean |
| [142](#L142) | \*/ |
| [143](#L143) | public function get\_orders\_permissions\_check() { |
| [144](#L144) | if( !is\_user\_logged\_in() ) |
| [145](#L145) | return false; |
| [146](#L146) | if( apply\_filters( 'wcfm\_is\_allow\_orders', true ) ) |
| [147](#L147) | return true; |
| [148](#L148) | return false; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | public function update\_order\_status\_permissions\_check() { |
| [152](#L152) | if( !is\_user\_logged\_in() ) |
| [153](#L153) | return false; |
| [154](#L154) | if( apply\_filters( 'wcfm\_is\_allow\_order\_status\_update', true ) ) |
| [155](#L155) | return true; |
| [156](#L156) | return false; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function get\_single\_order\_permissions\_check() { |
| [160](#L160) | if( !is\_user\_logged\_in() ) |
| [161](#L161) | return false; |
| [162](#L162) | if( apply\_filters( 'wcfm\_is\_allow\_order\_details', true ) ) |
| [163](#L163) | return true; |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | public function get\_order\_note\_permissions\_check() { |
| [168](#L168) | if( !is\_user\_logged\_in() ) |
| [169](#L169) | return false; |
| [170](#L170) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [171](#L171) | return true; |
| [172](#L172) | return false; |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | public function add\_order\_note\_permissions\_check() { |
| [176](#L176) | if( !is\_user\_logged\_in() ) |
| [177](#L177) | return false; |
| [178](#L178) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [179](#L179) | return true; |
| [180](#L180) | return false; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function update\_shipment\_tracking\_permissions\_check() { |
| [184](#L184) | if( !is\_user\_logged\_in() ) |
| [185](#L185) | return false; |
| [186](#L186) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [187](#L187) | return true; |
| [188](#L188) | return false; |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) |  |
| [192](#L192) | public function get\_post\_type\_items( $request ) { |
| [193](#L193) | global $WCFM; |
| [194](#L194) |  |
| [195](#L195) | $orders = $this->get\_objects\_from\_database($request); |
| [196](#L196) | $order\_return\_obj = array(); |
| [197](#L197) | foreach ($orders as $each\_order ) { |
| [198](#L198) |  |
| [199](#L199) | if($each\_order->vendor\_id) { |
| [200](#L200) | $order\_object = $this->get\_object( $each\_order->order\_id ); |
| [201](#L201) | $formated\_order\_data = $this->get\_formatted\_item\_data($order\_object, $each\_order->vendor\_id ); |
| [202](#L202) | $formated\_order\_data['vendor\_order\_details'] = $each\_order; |
| [203](#L203) | $order\_return\_obj[] =  $formated\_order\_data; |
| [204](#L204) | } else { |
| [205](#L205) | $order\_object = $this->get\_object($each\_order->ID); |
| [206](#L206) |  |
| [207](#L207) | $order\_return\_obj[] = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [208](#L208) | } |
| [209](#L209) | } |
| [210](#L210) | $response = rest\_ensure\_response($order\_return\_obj); |
| [211](#L211) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_objects", $response, $orders, $request ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | protected function get\_objects\_from\_database( $request ) { |
| [215](#L215) | global $WCFM; |
| [216](#L216) | $\_POST["controller"] = 'wcfm-orders'; |
| [217](#L217) | $\_POST['length'] = !empty($request['per\_page']) ? intval($request['per\_page']) : 10; |
| [218](#L218) | $\_POST['start'] = !empty($request['page']) ? ( intval($request['page']) - 1 ) \* $\_POST['length'] : 0; |
| [219](#L219) | //    if(empty($request['page'])){ |
| [220](#L220) | //      $\_POST['start'] = !empty($request['offset']) ? intval($request['offset']) : 0; |
| [221](#L221) | //    } |
| [222](#L222) | $\_POST['filter\_date\_form'] = !empty($request['after']) ? $request['after'] : ''; |
| [223](#L223) | $\_POST['filter\_date\_to'] = !empty($request['before']) ? $request['before'] : ''; |
| [224](#L224) | $\_POST['search']['value'] = !empty($request['search']) ? $request['search'] : ''; |
| [225](#L225) | $\_POST['orderby'] = !empty($request['orderby']) ? $request['orderby'] : ''; |
| [226](#L226) | $\_POST['order'] = !empty($request['order']) ? $request['order'] : ''; |
| [227](#L227) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [228](#L228) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [229](#L229) | $WCFM->init(); |
| [230](#L230) | $orders = $WCFM->ajax->wcfm\_ajax\_controller(); |
| [231](#L231) | return $orders; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) |  |
| [235](#L235) | public function get\_post\_type\_item( $request , $id ) { |
| [236](#L236) | global $WCFM; |
| [237](#L237) | $order\_return\_obj = array(); |
| [238](#L238) | if( wcfm\_is\_vendor() ) { |
| [239](#L239) |  |
| [240](#L240) | $is\_order\_for\_vendor = $WCFM->wcfm\_vendor\_support->wcfm\_is\_order\_for\_vendor( $id ); |
| [241](#L241) | if( $is\_order\_for\_vendor ) { |
| [242](#L242) | $current\_vendor   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [243](#L243) | $order\_object = $this->get\_object( $id ); |
| [244](#L244) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, $current\_vendor ); |
| [245](#L245) | } else { |
| [246](#L246) | return new WP\_Error( "wcfmapi\_rest\_invalid\_vendor", sprintf( \_\_( "Invalid Vendor - Order Id do not belong to the loggedin vendor", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | } else { |
| [250](#L250) | $order\_object = $this->get\_object( $id ); |
| [251](#L251) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [252](#L252) | } |
| [253](#L253) | $response = rest\_ensure\_response($order\_return\_obj); |
| [254](#L254) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_object", $response, $order\_object, $request ); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) |  |
| [258](#L258) | protected function get\_formatted\_item\_data( $object, $each\_order\_vendor\_id ) { |
| [259](#L259) | $data = $object->get\_data(); |
| [260](#L260) | $order\_id = $data['id']; |
| [261](#L261) | $order\_status = $data['status']; |
| [262](#L262) | //print\_r($data);die; |
| [263](#L263) | $format\_date       = array( 'date\_created', 'date\_modified', 'date\_completed', 'date\_paid' ); |
| [264](#L264) | $format\_line\_items = array( 'line\_items', 'tax\_lines', 'shipping\_lines', 'fee\_lines', 'coupon\_lines' ); |
| [265](#L265) |  |
| [266](#L266) | // Format date values. |
| [267](#L267) | foreach ( $format\_date as $key ) { |
| [268](#L268) | $datetime              = $data[ $key ]; |
| [269](#L269) | $data[ $key ]          = wc\_rest\_prepare\_date\_response( $datetime, false ); |
| [270](#L270) | $data[ $key . '\_gmt' ] = wc\_rest\_prepare\_date\_response( $datetime ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | // Format state and country |
| [274](#L274) | if($data['billing']['state']) { |
| [275](#L275) | $data['billing']['state'] = WC()->countries->get\_states( $data['billing']['country'] )[$data['billing']['state']]; |
| [276](#L276) | } |
| [277](#L277) | if($data['shipping']['state']) { |
| [278](#L278) | $data['shipping']['state'] = WC()->countries->get\_states( $data['shipping']['country'] )[$data['shipping']['state']]; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Add Commission Head |
| [282](#L282) | $data['commission\_head'] = $this->wcfmmp\_line\_item\_commission\_head($object, $each\_order\_vendor\_id); |
| [283](#L283) |  |
| [284](#L284) | // Add Delivery datetime & location |
| [285](#L285) | $data['user\_delivery\_location'] = $object->get\_meta('\_wcfmmp\_user\_location', true); |
| [286](#L286) | $wcfmd\_delvery\_times = $object->get\_meta('\_wcfmd\_delvery\_times', true); |
| [287](#L287) | if( !empty(  $wcfmd\_delvery\_times ) ) { |
| [288](#L288) | $data['user\_delivery\_time'] = date('Y-m-d H:i:s', $wcfmd\_delvery\_times[$each\_order\_vendor\_id]); |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | // Format line items. |
| [292](#L292) |  |
| [293](#L293) | foreach ( $format\_line\_items as $key ) { |
| [294](#L294) | if( $each\_order\_vendor\_id ) { |
| [295](#L295) | $line\_item\_datas = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [296](#L296) | $line\_item\_datas\_final = array(); |
| [297](#L297) | //print\_r($line\_item\_datas); |
| [298](#L298) | if($key == 'line\_items') { |
| [299](#L299) | //print\_r($line\_item\_datas); |
| [300](#L300) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [301](#L301) | $order\_item\_product = new WC\_Order\_Item\_Product($line\_item['id']); |
| [302](#L302) | $order\_product\_vendor\_id = $order\_item\_product->get\_meta('\_vendor\_id', true); |
| [303](#L303) | if( $order\_product\_vendor\_id && $order\_product\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [304](#L304) |  |
| [305](#L305) | // Add Store Name |
| [306](#L306) | if( $this->is\_vendor\_sold\_by( absint($order\_product\_vendor\_id) ) ) { |
| [307](#L307) |  |
| [308](#L308) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($order\_product\_vendor\_id) ); |
| [309](#L309) |  |
| [310](#L310) | $line\_item['store\_name'] = $shop\_name; |
| [311](#L311) |  |
| [312](#L312) | } |
| [313](#L313) | // Add Commission Value |
| [314](#L314) | $line\_item['commission\_value'] = $this->wcfmmp\_line\_item\_commission($order\_item\_product, $object, $order\_product\_vendor\_id); |
| [315](#L315) |  |
| [316](#L316) | $line\_item\_datas\_final[] = $line\_item; |
| [317](#L317) | } |
| [318](#L318) | // $line\_item\_datas\_final[] = $line\_item; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) | else if( $key == 'shipping\_lines' ) { |
| [322](#L322) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [323](#L323) | //var\_dump($line\_item['id']); |
| [324](#L324) | $order\_item\_shipping = new WC\_Order\_Item\_Shipping($line\_item['id']); |
| [325](#L325) | $shipping\_vendor\_id = $order\_item\_shipping->get\_meta('vendor\_id', true); |
| [326](#L326) | if( $shipping\_vendor\_id && $shipping\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [327](#L327) |  |
| [328](#L328) | // Add Store Name |
| [329](#L329) | if( $this->is\_vendor\_sold\_by( absint($shipping\_vendor\_id) ) ) { |
| [330](#L330) |  |
| [331](#L331) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($shipping\_vendor\_id) ); |
| [332](#L332) |  |
| [333](#L333) | $line\_item['store\_name'] = $shop\_name; |
| [334](#L334) |  |
| [335](#L335) | } |
| [336](#L336) | $line\_item\_datas\_final[] = $line\_item; |
| [337](#L337) | } |
| [338](#L338) | // $line\_item\_datas\_final[] = $line\_item; |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) | else { |
| [342](#L342) | $line\_item\_datas\_final = $line\_item\_datas; |
| [343](#L343) | } |
| [344](#L344) | $data[ $key ] = $line\_item\_datas\_final; |
| [345](#L345) |  |
| [346](#L346) | } else { |
| [347](#L347) | $data[ $key ] = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // Add Shipment Tracking |
| [352](#L352) | if( ( ( $object->needs\_shipping\_address() && $object->get\_formatted\_shipping\_address() ) || apply\_filters( 'wcfm\_is\_force\_shipping\_address', false ) ) && ( !function\_exists( 'wcs\_order\_contains\_subscription' ) || ( !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) && !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) ) ) && apply\_filters( 'wcfm\_is\_pref\_shipment\_tracking', true ) && apply\_filters( 'wcfm\_is\_allow\_shipping\_tracking', true ) && !in\_array( $order\_status, apply\_filters( 'wcfm\_shipment\_disable\_order\_status', array( 'failed', 'cancelled', 'refunded', 'pending' ) ) ) ) { |
| [353](#L353) |  |
| [354](#L354) | $data['shipment\_tracking'] = $this->get\_order\_shipping\_data( $object ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | $data['status'] = apply\_filters( 'wcfm\_current\_order\_status', $data['status'], $data['id'] ); |
| [358](#L358) |  |
| [359](#L359) | // Format the order status. |
| [360](#L360) | $data['status'] = 'wc-' === substr( $data['status'], 0, 3 ) ? substr( $data['status'], 3 ) : $data['status']; |
| [361](#L361) | return $data; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) |  |
| [365](#L365) | /\*\* |
| [366](#L366) | \* Expands an order item to get its data. |
| [367](#L367) | \* |
| [368](#L368) | \* @param WC\_Order\_item $item |
| [369](#L369) | \* |
| [370](#L370) | \* @return array |
| [371](#L371) | \*/ |
| [372](#L372) | protected function get\_order\_item\_data( $item ) { |
| [373](#L373) |  |
| [374](#L374) | $data           = $item->get\_data(); |
| [375](#L375) |  |
| [376](#L376) | // Add Shop Name |
| [377](#L377) | /\*$meta\_data         = $item->get\_meta\_data(); |
| [378](#L378) | foreach ( $meta\_data as $meta ) { |
| [379](#L379) |  |
| [380](#L380) | if( !is\_array( $meta->key ) ) { |
| [381](#L381) |  |
| [382](#L382) | $meta->key     = rawurldecode( (string) $meta->key ); |
| [383](#L383) |  |
| [384](#L384) | if( $meta->key == '\_vendor\_id' ) { |
| [385](#L385) |  |
| [386](#L386) | $meta->value   = rawurldecode( (string) $meta->value ); |
| [387](#L387) |  |
| [388](#L388) | if( $this->is\_vendor\_sold\_by( absint($meta->value) ) ) { |
| [389](#L389) |  |
| [390](#L390) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($meta->value) ); |
| [391](#L391) |  |
| [392](#L392) | $data['shop\_name'] = $shop\_name; |
| [393](#L393) |  |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | } \*/ |
| [401](#L401) |  |
| [402](#L402) | $format\_decimal = array( 'subtotal', 'subtotal\_tax', 'total', 'total\_tax', 'tax\_total', 'shipping\_tax\_total' ); |
| [403](#L403) |  |
| [404](#L404) | // Format decimal values. |
| [405](#L405) | foreach ( $format\_decimal as $key ) { |
| [406](#L406) | if ( isset( $data[ $key ] ) ) { |
| [407](#L407) | $data[ $key ] = wc\_format\_decimal( $data[ $key ], ( isset($this->request['dp']) ) ? $this->request['dp'] : false ); |
| [408](#L408) | } |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | // Add SKU, THUMBNAIL and PRICE to products. |
| [412](#L412) | if ( is\_callable( array( $item, 'get\_product' ) ) ) { |
| [413](#L413) | $\_product = $item->get\_product(); |
| [414](#L414) | $data['sku']   = $\_product ? $\_product->get\_sku(): null; |
| [415](#L415) | $data['thumbnail']     = $\_product ? apply\_filters( 'woocommerce\_admin\_order\_item\_thumbnail', $\_product->get\_image( 'thumbnail', array( 'title' => '' ), false ), $data['id'], $item ) : ''; |
| [416](#L416) | $data['image\_url'] = $\_product ? wp\_get\_attachment\_image\_url( $\_product->get\_image\_id(), 'thumbnail' ) : null; |
| [417](#L417) | $data['price'] = (float)( $item->get\_total() / max( 1, $item->get\_quantity() ) ); |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | // Format taxes. |
| [421](#L421) | if ( ! empty( $data['taxes']['total'] ) ) { |
| [422](#L422) | $taxes = array(); |
| [423](#L423) |  |
| [424](#L424) | foreach ( $data['taxes']['total'] as $tax\_rate\_id => $tax ) { |
| [425](#L425) | $taxes[] = array( |
| [426](#L426) | 'id'       => $tax\_rate\_id, |
| [427](#L427) | 'total'    => $tax, |
| [428](#L428) | 'subtotal' => isset( $data['taxes']['subtotal'][ $tax\_rate\_id ] ) ? $data['taxes']['subtotal'][ $tax\_rate\_id ] : '', |
| [429](#L429) | ); |
| [430](#L430) | } |
| [431](#L431) | $data['taxes'] = $taxes; |
| [432](#L432) | } elseif ( isset( $data['taxes'] ) ) { |
| [433](#L433) | $data['taxes'] = array(); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | // Remove names for coupons, taxes and shipping. |
| [437](#L437) | if ( isset( $data['code'] ) || isset( $data['rate\_code'] ) || isset( $data['method\_title'] ) ) { |
| [438](#L438) | unset( $data['name'] ); |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | // Remove props we don't want to expose. |
| [442](#L442) | unset( $data['order\_id'] ); |
| [443](#L443) | unset( $data['type'] ); |
| [444](#L444) |  |
| [445](#L445) | return $data; |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) |  |
| [450](#L450) | \* Return is show sold by label |
| [451](#L451) |  |
| [452](#L452) | \* @return boolean |
| [453](#L453) |  |
| [454](#L454) | \*/ |
| [455](#L455) |  |
| [456](#L456) | public function is\_vendor\_sold\_by( $vendor\_id = '' ) { |
| [457](#L457) |  |
| [458](#L458) | global $WCFM, $WCFMmp; |
| [459](#L459) |  |
| [460](#L460) |  |
| [461](#L461) |  |
| [462](#L462) | $wcfmmp\_marketplace\_options   = get\_option( 'wcfm\_marketplace\_options', array() ); |
| [463](#L463) |  |
| [464](#L464) | $vendor\_sold\_by = isset( $wcfmmp\_marketplace\_options['vendor\_sold\_by'] ) ? $wcfmmp\_marketplace\_options['vendor\_sold\_by'] : 'yes'; |
| [465](#L465) |  |
| [466](#L466) | if( $vendor\_sold\_by == 'yes' ) { |
| [467](#L467) |  |
| [468](#L468) | if( !$vendor\_id || ( $vendor\_id && apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $vendor\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $vendor\_id, 'sold\_by' ) ) ) { |
| [469](#L469) |  |
| [470](#L470) | return true; |
| [471](#L471) |  |
| [472](#L472) | } else { |
| [473](#L473) |  |
| [474](#L474) | return false; |
| [475](#L475) |  |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | return false; |
| [481](#L481) |  |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | // WCFMmp Line Item Commission Head |
| [485](#L485) |  |
| [486](#L486) | protected function wcfmmp\_line\_item\_commission\_head( $order, $vendor\_id ) { |
| [487](#L487) |  |
| [488](#L488) | global $WCFM, $WCFMmp; |
| [489](#L489) |  |
| [490](#L490) |  |
| [491](#L491) | if( wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) { |
| [492](#L492) |  |
| [493](#L493) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [494](#L494) |  |
| [495](#L495) | if( $admin\_fee\_mode ) { |
| [496](#L496) |  |
| [497](#L497) | return \_\_( 'Fees', 'wc-frontend-manager' ); |
| [498](#L498) |  |
| [499](#L499) | } else { |
| [500](#L500) |  |
| [501](#L501) | return \_\_( 'Earning', 'wc-frontend-manager' ); |
| [502](#L502) |  |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | // WCFMmp Line item Commission |
| [510](#L510) |  |
| [511](#L511) | protected function wcfmmp\_line\_item\_commission( $item, $order, $vendor\_id ) { |
| [512](#L512) |  |
| [513](#L513) | global $WCFM, $wpdb, $WCFMmp; |
| [514](#L514) |  |
| [515](#L515) | if( !wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) return; |
| [516](#L516) |  |
| [517](#L517) | $order\_currency = $order->get\_currency(); |
| [518](#L518) |  |
| [519](#L519) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [520](#L520) |  |
| [521](#L521) | $qty = ( isset( $item['qty'] ) ? esc\_html( $item['qty'] ) : '1' ); |
| [522](#L522) |  |
| [523](#L523) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_deduct\_discount( $vendor\_id, $order->get\_id() ) ) { |
| [524](#L524) |  |
| [525](#L525) | $line\_total = $item->get\_total(); |
| [526](#L526) |  |
| [527](#L527) | } else { |
| [528](#L528) |  |
| [529](#L529) | $line\_total = $item->get\_subtotal(); |
| [530](#L530) |  |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | if( $item->get\_product\_id() ) { |
| [534](#L534) |  |
| [535](#L535) | $product\_id = $item->get\_product\_id(); |
| [536](#L536) |  |
| [537](#L537) | $variation\_id = $item->get\_variation\_id(); |
| [538](#L538) |  |
| [539](#L539) | } else { |
| [540](#L540) |  |
| [541](#L541) | $product\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_product\_id', true ); |
| [542](#L542) |  |
| [543](#L543) | $variation\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_variation\_id', true ); |
| [544](#L544) |  |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $sql = " |
| [548](#L548) |  |
| [549](#L549) | SELECT item\_id, is\_refunded, commission\_amount AS line\_total, shipping AS total\_shipping, tax, shipping\_tax\_amount |
| [550](#L550) |  |
| [551](#L551) | FROM {$wpdb->prefix}wcfm\_marketplace\_orders |
| [552](#L552) |  |
| [553](#L553) | WHERE (product\_id = " . $product\_id . " OR variation\_id = " . $variation\_id . ") |
| [554](#L554) |  |
| [555](#L555) | AND   order\_id    = " . $order->get\_id() . " |
| [556](#L556) |  |
| [557](#L557) | AND   item\_id     = " . $item->get\_id() . " |
| [558](#L558) |  |
| [559](#L559) | AND   `vendor\_id` = " . $vendor\_id; |
| [560](#L560) |  |
| [561](#L561) | $order\_line\_due = $wpdb->get\_results( $sql ); |
| [562](#L562) |  |
| [563](#L563) |  |
| [564](#L564) |  |
| [565](#L565) | if( !empty( $order\_line\_due ) && !$order\_line\_due[0]->is\_refunded ) { |
| [566](#L566) |  |
| [567](#L567) | if ( $get\_shipping = $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_shipping( $vendor\_id ) ) { |
| [568](#L568) |  |
| [569](#L569) | //$line\_total += $order\_line\_due[0]->total\_shipping; |
| [570](#L570) |  |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_tax( $vendor\_id ) ) { |
| [574](#L574) |  |
| [575](#L575) | $line\_total += $order\_line\_due[0]->tax; |
| [576](#L576) |  |
| [577](#L577) | $order\_line\_due[0]->line\_total += $order\_line\_due[0]->tax; |
| [578](#L578) |  |
| [579](#L579) | if( $get\_shipping ) { |
| [580](#L580) |  |
| [581](#L581) | //$line\_total += $order\_line\_due[0]->shipping\_tax\_amount; |
| [582](#L582) |  |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | if( $admin\_fee\_mode ) { |
| [588](#L588) |  |
| [589](#L589) | $refunded = $order->get\_total\_refunded\_for\_item( $item->get\_id() ); |
| [590](#L590) |  |
| [591](#L591) | return $line\_total - $refunded - $order\_line\_due[0]->line\_total; |
| [592](#L592) |  |
| [593](#L593) | } else { |
| [594](#L594) |  |
| [595](#L595) | return $order\_line\_due[0]->line\_total; |
| [596](#L596) |  |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | } else { |
| [600](#L600) |  |
| [601](#L601) | return 0; |
| [602](#L602) |  |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* |
| [609](#L609) | \* |
| [610](#L610) | \*/ |
| [611](#L611) | protected function get\_order\_shipping\_data( $order ) { |
| [612](#L612) |  |
| [613](#L613) | global $WCFM; |
| [614](#L614) |  |
| [615](#L615) | $needs\_shipping\_tracking = false; |
| [616](#L616) |  |
| [617](#L617) | $product\_ids = array(); |
| [618](#L618) |  |
| [619](#L619) | $order\_item\_ids = array(); |
| [620](#L620) |  |
| [621](#L621) | $line\_items = $order->get\_items( 'line\_item' ); |
| [622](#L622) |  |
| [623](#L623) | $line\_items = apply\_filters( 'wcfm\_valid\_line\_items', $line\_items, $order->get\_id() ); |
| [624](#L624) |  |
| [625](#L625) | $shipment\_tracking\_data = array(); |
| [626](#L626) |  |
| [627](#L627) | foreach ( $line\_items as $item\_id => $item ) { |
| [628](#L628) |  |
| [629](#L629) | $each\_data = array(); |
| [630](#L630) |  |
| [631](#L631) | $\_product  = $item->get\_product(); |
| [632](#L632) |  |
| [633](#L633) | $needs\_shipping = $WCFM->frontend->is\_wcfm\_needs\_shipping( $\_product ); |
| [634](#L634) |  |
| [635](#L635) | $shipped = true; |
| [636](#L636) |  |
| [637](#L637) | $tracking\_url  = ''; |
| [638](#L638) |  |
| [639](#L639) | $tracking\_code = ''; |
| [640](#L640) |  |
| [641](#L641) | $delivery\_boy  = ''; |
| [642](#L642) |  |
| [643](#L643) | $delivery\_boy\_name = ''; |
| [644](#L644) |  |
| [645](#L645) | if( $needs\_shipping ) { |
| [646](#L646) |  |
| [647](#L647) | $shipped = false; |
| [648](#L648) |  |
| [649](#L649) | foreach ( $item->get\_formatted\_meta\_data() as $meta\_id => $meta ) { |
| [650](#L650) |  |
| [651](#L651) | if( $meta->key == 'wcfm\_tracking\_url' ) { |
| [652](#L652) |  |
| [653](#L653) | $tracking\_url  = $meta->value; |
| [654](#L654) |  |
| [655](#L655) | $shipped = true; |
| [656](#L656) |  |
| [657](#L657) | } elseif( $meta->key == 'wcfm\_tracking\_code' ) { |
| [658](#L658) |  |
| [659](#L659) | $tracking\_code  = $meta->value; |
| [660](#L660) |  |
| [661](#L661) | } elseif( $meta->key == 'wcfm\_delivery\_boy' ) { |
| [662](#L662) |  |
| [663](#L663) | $delivery\_boy  = $meta->value; |
| [664](#L664) |  |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | } else { |
| [670](#L670) |  |
| [671](#L671) | continue; |
| [672](#L672) |  |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | $order\_item\_ids[] = $item->get\_id(); |
| [676](#L676) |  |
| [677](#L677) | $product\_ids[]    = $item->get\_product\_id(); |
| [678](#L678) |  |
| [679](#L679) | $each\_data['item\_id'] = $item->get\_id(); |
| [680](#L680) | $each\_data['product\_id'] = $item->get\_product\_id(); |
| [681](#L681) |  |
| [682](#L682) | //if( $shipped ) continue; |
| [683](#L683) |  |
| [684](#L684) | $needs\_shipping\_tracking = true; |
| [685](#L685) |  |
| [686](#L686) |  |
| [687](#L687) | if( ( !empty( $product\_ids ) && ( count( $product\_ids ) == 1 ) ) || apply\_filters( 'wcfm\_is\_allow\_itemwise\_notification', true ) ) { |
| [688](#L688) |  |
| [689](#L689) | $each\_data['product\_name'] = esc\_html( $item->get\_name() ); |
| [690](#L690) |  |
| [691](#L691) | if ( $\_product && $\_product->get\_sku() ) { |
| [692](#L692) |  |
| [693](#L693) | $each\_data['sku'] = esc\_html( $\_product->get\_sku() ); |
| [694](#L694) |  |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | if ( $tracking\_code ) { |
| [698](#L698) |  |
| [699](#L699) | $each\_data['tracking\_code'] = $tracking\_code; |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | if ( $tracking\_url ) { |
| [704](#L704) |  |
| [705](#L705) | $each\_data['tracking\_url'] = $tracking\_url; |
| [706](#L706) |  |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( $delivery\_boy ) { |
| [710](#L710) |  |
| [711](#L711) | $each\_data['delivery\_boy'] = $delivery\_boy; |
| [712](#L712) | $wcfm\_delivery\_boy\_user = get\_userdata( absint( $delivery\_boy ) ); |
| [713](#L713) | if ( $wcfm\_delivery\_boy\_user ) { |
| [714](#L714) | $delivery\_boy\_name = apply\_filters( 'wcfm\_delivery\_boy\_display', $wcfm\_delivery\_boy\_user->first\_name . ' ' . $wcfm\_delivery\_boy\_user->last\_name, $delivery\_boy ); |
| [715](#L715) | $each\_data['delivery\_boy\_name'] = $delivery\_boy\_name; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | if ( function\_exists( 'wcfm\_is\_order\_delivered' ) ) { |
| [721](#L721) |  |
| [722](#L722) | $is\_order\_delivered = wcfm\_is\_order\_delivered( $order->get\_id(), $item\_id ); |
| [723](#L723) |  |
| [724](#L724) | if( $is\_order\_delivered ) { |
| [725](#L725) |  |
| [726](#L726) | $each\_data['delivery\_status'] = 'completed'; |
| [727](#L727) |  |
| [728](#L728) | } else { |
| [729](#L729) |  |
| [730](#L730) | $each\_data['delivery\_status'] = 'pending'; |
| [731](#L731) |  |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | if( $\_product ) { |
| [736](#L736) |  |
| [737](#L737) | $each\_data['mark\_shipped'] = true; |
| [738](#L738) |  |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | $shipment\_tracking\_data['each\_data'][] = $each\_data; |
| [743](#L743) |  |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | if( !empty( $product\_ids ) && ( count( $product\_ids ) > 1 ) ) { |
| [747](#L747) |  |
| [748](#L748) | $shipment\_tracking\_data['mark\_all'] = array( |
| [749](#L749) |  |
| [750](#L750) | 'product\_ids' => $product\_ids, |
| [751](#L751) | 'order\_item\_ids' => $order\_item\_ids |
| [752](#L752) |  |
| [753](#L753) | ); |
| [754](#L754) |  |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | $wcfm\_delivery\_boys\_array = function\_exists( 'wcfm\_get\_delivery\_boys' ) ? wcfm\_get\_delivery\_boys() : array(); |
| [758](#L758) |  |
| [759](#L759) | if(!empty($wcfm\_delivery\_boys\_array)) { |
| [760](#L760) |  |
| [761](#L761) | $delivery\_users = array(); |
| [762](#L762) |  |
| [763](#L763) | foreach( $wcfm\_delivery\_boys\_array as $wcfm\_delivery\_boys\_single ) { |
| [764](#L764) |  |
| [765](#L765) | $delivery\_users[] = array( 'id' => $wcfm\_delivery\_boys\_single->ID, |
| [766](#L766) | 'name' => $wcfm\_delivery\_boys\_single->first\_name . ' ' . $wcfm\_delivery\_boys\_single->last\_name . ' (' . $wcfm\_delivery\_boys\_single->user\_email . ')'); |
| [767](#L767) |  |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | $shipment\_tracking\_data['delivery\_boys'] = $delivery\_users; |
| [771](#L771) |  |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | return $shipment\_tracking\_data; |
| [775](#L775) |  |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | public function update\_shipment\_tracking( $request ) { |
| [779](#L779) | global $WCFM, $WCFMu, $WCFMd; |
| [780](#L780) |  |
| [781](#L781) | $\_POST['orderid'] = !empty($request['order\_id']) ? $request['order\_id'] : ''; |
| [782](#L782) |  |
| [783](#L783) | $\_POST['tracking\_data'] = ""; |
| [784](#L784) |  |
| [785](#L785) | $\_POST['tracking\_data'] .= "wcfm\_tracking\_order\_id="; |
| [786](#L786) | $\_POST['tracking\_data'] .= !empty($request['order\_id']) ? $request['order\_id'] : ""; |
| [787](#L787) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_product\_id="; |
| [788](#L788) | $\_POST['tracking\_data'] .= !empty($request['product\_id']) ? $request['product\_id'] : ""; |
| [789](#L789) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_order\_item\_id="; |
| [790](#L790) | $\_POST['tracking\_data'] .= !empty($request['item\_id']) ? $request['item\_id'] : ""; |
| [791](#L791) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_url="; |
| [792](#L792) | $\_POST['tracking\_data'] .= !empty($request['tracking\_url']) ? $request['tracking\_url'] : ""; |
| [793](#L793) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_code="; |
| [794](#L794) | $\_POST['tracking\_data'] .= !empty($request['tracking\_code']) ? $request['tracking\_code'] : ""; |
| [795](#L795) | $\_POST['tracking\_data'] .= "&wcfm\_delivery\_boy="; |
| [796](#L796) | $\_POST['tracking\_data'] .= !empty($request['delivery\_boy']) ? $request['delivery\_boy'] : ""; |
| [797](#L797) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [798](#L798) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [799](#L799) | if(WCFMapi\_Dependencies::wcfmapi\_ultimate\_plugin\_active\_check()) { |
| [800](#L800) | $WCFMu->init\_wcfmu(); |
| [801](#L801) | $wcfm\_tracking\_data = $WCFMu->wcfmu\_shipment\_tracking->wcfm\_wcfmmarketplace\_order\_mark\_shipped(); |
| [802](#L802) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [803](#L803) | $order    = wc\_get\_order( $order\_id ); |
| [804](#L804) | $response = array('order\_id' => $order\_id); |
| [805](#L805) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [806](#L806) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [807](#L807) |  |
| [808](#L808) | return rest\_ensure\_response( $response ); |
| [809](#L809) | } elseif( !empty($request['delivery\_boy']) ) { |
| [810](#L810) | $WCFMd->init\_wcfmd(); |
| [811](#L811) | $wcfm\_tracking\_data = $WCFMd->ajax->wcfmd\_delivery\_boy\_assign(); |
| [812](#L812) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [813](#L813) | $order    = wc\_get\_order( $order\_id ); |
| [814](#L814) | $response = array('order\_id' => $order\_id); |
| [815](#L815) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [816](#L816) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [817](#L817) | return rest\_ensure\_response( $response ); |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | public function update\_order\_status( $request ) { |
| [823](#L823) |  |
| [824](#L824) | global $WCFM; |
| [825](#L825) |  |
| [826](#L826) | $id             = isset( $request['id'] ) ? absint( $request['id'] ) : 0; |
| [827](#L827) | $status         = isset( $request['status'] ) ? $request['status'] : ''; |
| [828](#L828) |  |
| [829](#L829) | if(substr($status, 0, 2) !== 'wc-'){ |
| [830](#L830) | $status = 'wc-' . $status; |
| [831](#L831) | } |
| [832](#L832) | $order\_statuses = wc\_get\_order\_statuses(); |
| [833](#L833) |  |
| [834](#L834) | if ( empty( $id ) ) { |
| [835](#L835) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", \_\_( 'Invalid order ID', 'wcfm-marketplace-rest-api' ), array( |
| [836](#L836) | 'status' => 404, |
| [837](#L837) | ) ); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | if ( empty( $status ) ) { |
| [841](#L841) | return new WP\_Error( "wcfmapi\_rest\_empty\_{$this->post\_type}\_status", \_\_( 'Order status must me required', 'wcfm-marketplace-rest-api' ), array( |
| [842](#L842) | 'status' => 404, |
| [843](#L843) | ) ); |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | if ( ! in\_array( $status, array\_keys( $order\_statuses ) ) ) { |
| [847](#L847) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_status", \_\_( 'Order status not valid', 'wcfm-marketplace-rest-api' ), array( |
| [848](#L848) | 'status' => 404, |
| [849](#L849) | ) ); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | // $order = $this->get\_object( $id ); |
| [853](#L853) | // $order->set\_status( $status ); |
| [854](#L854) | // $order =  apply\_filters( "wcfmapi\_rest\_pre\_insert\_{$this->post\_type}\_object", $order, $request ); |
| [855](#L855) | // $order->save(); |
| [856](#L856) | $\_POST['order\_id'] = $id; |
| [857](#L857) | $\_POST['order\_status'] = $status; |
| [858](#L858) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [859](#L859) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [860](#L860) | $WCFM->init(); |
| [861](#L861) | $order\_status\_change = $WCFM->ajax->wcfm\_modify\_order\_status(); |
| [862](#L862) | return $this->get\_post\_type\_item($request, $id); |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | /\*\* |
| [866](#L866) |  |
| [867](#L867) | \* Handle Order Note Add |
| [868](#L868) |  |
| [869](#L869) | \*/ |
| [870](#L870) |  |
| [871](#L871) | public function add\_order\_note( $request ) { |
| [872](#L872) |  |
| [873](#L873) | global $WCFM, $WCFMu, $woocommerce; |
| [874](#L874) |  |
| [875](#L875) |  |
| [876](#L876) | $user\_id   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [877](#L877) |  |
| [878](#L878) | $user      = $user\_id; |
| [879](#L879) | $comment\_id = ''; |
| [880](#L880) |  |
| [881](#L881) |  |
| [882](#L882) | //parse\_str($\_POST['note\_data'], $wcfm\_note\_data); |
| [883](#L883) |  |
| [884](#L884) | $order\_id   = absint( $request['id'] ); |
| [885](#L885) | //$noteData = $request['noteData']; |
| [886](#L886) |  |
| [887](#L887) | $note       = apply\_filters( 'wcfm\_editor\_content\_before\_save', wp\_kses\_post( trim( stripslashes( $request['note'] ) ) ) ); |
| [888](#L888) |  |
| [889](#L889) | $note\_type  = $request['note\_type']; |
| [890](#L890) |  |
| [891](#L891) |  |
| [892](#L892) |  |
| [893](#L893) | $is\_customer\_note = $note\_type == 'customer' ? 1 : 0; |
| [894](#L894) |  |
| [895](#L895) | $note\_class = ''; |
| [896](#L896) |  |
| [897](#L897) | if($is\_customer\_note) $note\_class = 'customer-note'; |
| [898](#L898) |  |
| [899](#L899) |  |
| [900](#L900) |  |
| [901](#L901) | if ( $order\_id > 0 ) { |
| [902](#L902) |  |
| [903](#L903) | $order      = wc\_get\_order( $order\_id ); |
| [904](#L904) |  |
| [905](#L905) | if( apply\_filters( 'wcfm\_is\_allow\_order\_note\_attachments', true ) ) { |
| [906](#L906) |  |
| [907](#L907) | $attachments = $request['attachments']; |
| [908](#L908) |  |
| [909](#L909) | if( !empty( $attachments ) ) { |
| [910](#L910) |  |
| [911](#L911) | $attachment\_data = ''; |
| [912](#L912) |  |
| [913](#L913) | foreach( $attachments as $index => $attachment ) { |
| [914](#L914) |  |
| [915](#L915) | if( isset( $attachment['attachmentData'] ) && !empty( $attachment['attachmentData'] ) ) { |
| [916](#L916) |  |
| [917](#L917) | $name = !empty( $attachment['attachmentText'] ) ? $attachment['attachmentText'] : \_\_  ( 'Attachment', 'wc-frontend-manager-ultimate' ) . ' ' . $index; |
| [918](#L918) |  |
| [919](#L919) | if( $index != 0  ) $note .= ',&nbsp;'; |
| [920](#L920) |  |
| [921](#L921) | $attachment\_data .= '<a class="wcfm\_dashboard\_item\_title wcfm\_linked\_attached" target="\_blank" href="' . $attachment['attachmentData']['source\_url'] . '">' . $name . '</a>'; |
| [922](#L922) |  |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if( !empty( $attachment\_data ) ) { |
| [928](#L928) |  |
| [929](#L929) | $note .= "<br />" . \_\_  ( 'Attachments', 'wc-frontend-manager-ultimate' ) . ': ' . $attachment\_data; |
| [930](#L930) |  |
| [931](#L931) | } |
| [932](#L932) |  |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) |  |
| [938](#L938) |  |
| [939](#L939) | $note = apply\_filters( 'wcfm\_order\_note\_before\_save', $note, $request ); |
| [940](#L940) |  |
| [941](#L941) |  |
| [942](#L942) |  |
| [943](#L943) | // Vendor association |
| [944](#L944) |  |
| [945](#L945) | if( wcfm\_is\_vendor() ) { |
| [946](#L946) |  |
| [947](#L947) | if( apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $user\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $user\_id, 'sold\_by' ) && apply\_filters( 'wcfm\_is\_allow\_order\_note\_vendor\_reference', true ) ) { |
| [948](#L948) |  |
| [949](#L949) | $note = sprintf( \_\_( '%s has added the following note', 'wc-frontend-manager-ultimate' ), wcfm\_get\_vendor\_store( $user\_id ) ) . ': ' . "<br />"  . $note; |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) |  |
| [954](#L954) |  |
| [955](#L955) | add\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [956](#L956) |  |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) |  |
| [960](#L960) |  |
| [961](#L961) | $comment\_id = $order->add\_order\_note( $note, $is\_customer\_note, true ); |
| [962](#L962) |  |
| [963](#L963) |  |
| [964](#L964) |  |
| [965](#L965) | // Vendor association |
| [966](#L966) |  |
| [967](#L967) | if( wcfm\_is\_vendor() ) remove\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [968](#L968) |  |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | $notes = $this->get\_order\_notes(array('id' => $request['id'])); |
| [972](#L972) | $response = rest\_ensure\_response($notes); |
| [973](#L973) | return $response; |
| [974](#L974) |  |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) |  |
| [978](#L978) | public function get\_order\_notes( $request ) { |
| [979](#L979) |  |
| [980](#L980) | $args = array( |
| [981](#L981) |  |
| [982](#L982) | 'post\_id'   => $request['id'], |
| [983](#L983) |  |
| [984](#L984) | 'orderby'   => 'comment\_ID', |
| [985](#L985) |  |
| [986](#L986) | 'order'     => 'DESC', |
| [987](#L987) |  |
| [988](#L988) | 'approve'   => 'approve', |
| [989](#L989) |  |
| [990](#L990) | 'type'      => 'order\_note' |
| [991](#L991) |  |
| [992](#L992) | ); |
| [993](#L993) |  |
| [994](#L994) | $args = apply\_filters( 'wcfm\_order\_notes\_args', $args ); |
| [995](#L995) |  |
| [996](#L996) | //$notes = apply\_filters( 'wcfm\_order\_notes', get\_comments( $args ), $request['id'] ); |
| [997](#L997) |  |
| [998](#L998) | $notes = wc\_get\_order\_notes( $args ); |
| [999](#L999) |  |
| [1000](#L1000) | $response = rest\_ensure\_response($notes); |
| [1001](#L1001) |  |
| [1002](#L1002) | return $response; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) |  |
| [1006](#L1006) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?format=txt)
* [Original Format](/export/3222433/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_5cf0fa07_20250114_181921.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2904331)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/2904330 "Changeset 2904330")
* [Next Changeset](/changeset/2904332 "Changeset 2904332") →

---

# Changeset 2904331

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
04/26/2023 09:36:35 AM
([21 months](/timeline?from=2023-04-26T09%3A36%3A35Z&precision=second "See timeline at 04/26/2023 09:36:35 AM") ago)

Author:
wclovers
Message:

Version Updated to 1.6.0

Location:
[wcfm-marketplace-rest-api](/browser/wcfm-marketplace-rest-api?rev=2904331)
Files:

35 added
5 edited

* [tags/1.6.0](/browser/wcfm-marketplace-rest-api/tags/1.6.0?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/core](/browser/wcfm-marketplace-rest-api/tags/1.6.0/core?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/core/class-wcfmapi-api-manager.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/core/class-wcfmapi-api-manager.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/core/class-wcfmapi-rest-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/core/class-wcfmapi-rest-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/core/class-wcfmapi.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/core/class-wcfmapi.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/helpers](/browser/wcfm-marketplace-rest-api/tags/1.6.0/helpers?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/helpers/class-wcfmapi-dependencies.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/helpers/class-wcfmapi-dependencies.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/helpers/wcfmapi-core-functions.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/helpers/wcfmapi-core-functions.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-booking-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-booking-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-capabilities-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-capabilities-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-customer\_app\_settings-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-customer_app_settings-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-deliveries-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-deliveries-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-enquiry-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-enquiry-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-notification-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-notification-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-order-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-order-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-product-attribute-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-product-attribute-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-product-categories-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-product-categories-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-product-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-product-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-review-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-review-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-sales\_stats-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-sales_stats-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-settings-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-settings-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-site\_details-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-site_details-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-store\_vendors-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-store_vendors-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-support-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-support-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-user\_profile-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-user_profile-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-wc\_cart-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-wc_cart-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-wc\_checkout-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-wc_checkout-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/includes/api/class-api-wc\_product\_variation-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/includes/api/class-api-wc_product_variation-controller.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/lang](/browser/wcfm-marketplace-rest-api/tags/1.6.0/lang?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/lang/wcfm-marketplace-rest-api.pot](/browser/wcfm-marketplace-rest-api/tags/1.6.0/lang/wcfm-marketplace-rest-api.pot?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/readme.txt](/browser/wcfm-marketplace-rest-api/tags/1.6.0/readme.txt?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/wcfm-marketplace-rest-api-config.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/wcfm-marketplace-rest-api-config.php?rev=2904331 "Show entry in browser")
  (added)
* [tags/1.6.0/wcfm-marketplace-rest-api.php](/browser/wcfm-marketplace-rest-api/tags/1.6.0/wcfm-marketplace-rest-api.php?rev=2904331 "Show entry in browser")
  (added)
* [trunk/core/class-wcfmapi-api-manager.php](/browser/wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php?rev=2904331 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [trunk/includes/api/class-api-order-controller.php](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331 "Show entry in browser")
  (modified)
  ([6 diffs](#file36 "Show differences"))
* [trunk/includes/api/class-api-product-controller.php](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2904331 "Show entry in browser")
  (modified)
  ([4 diffs](#file37 "Show differences"))
* [trunk/readme.txt](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2904331 "Show entry in browser")
  (modified)
  ([3 diffs](#file38 "Show differences"))
* [trunk/wcfm-marketplace-rest-api.php](/browser/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php?rev=2904331 "Show entry in browser")
  (modified)
  ([2 diffs](#file39 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php](/changeset/2904331/wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php "Show the changeset 2904331 restricted to wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php")

  | [r2639021](/browser/wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php?rev=2639021#L112 "Show revision 2639021 of this file in browser") | [r2904331](/browser/wcfm-marketplace-rest-api/trunk/core/class-wcfmapi-api-manager.php?rev=2904331#L112 "Show revision 2904331 of this file in browser") |  |
  | --- | --- | --- |
  | 112 | 112 | $data['product\_units']['weight\_unit'] = $weight\_unit; |
  | 113 | 113 | $data['product\_units']['dimension\_unit'] = $dimension\_unit; |
  |  | 114 |  |
  |  | 115 | $args       = array( 'post\_id' => $object->get\_id() ); |
  |  | 116 | $data['product\_restirction\_message'] = ''; |
  |  | 117 |  |
  |  | 118 | if(isset($request['isAuthSaved']) && $request['isAuthSaved'] === 'yes' && $request['cust\_id'] != 0  ) { |
  |  | 119 |  |
  |  | 120 | if ( ! user\_can( $request['cust\_id'], 'wc\_memberships\_purchase\_restricted\_product', $object->get\_id() ) ) { |
  |  | 121 |  |
  |  | 122 | if (class\_exists('\WC\_Memberships\_User\_Messages')) { |
  |  | 123 | $data['product\_restirction\_message'] = \WC\_Memberships\_User\_Messages::get\_message\_html( 'product\_purchasing\_restricted', $args ); |
  |  | 124 | } |
  |  | 125 |  |
  |  | 126 | } else { |
  |  | 127 |  |
  |  | 128 | $data['product\_restirction\_message'] = ''; |
  |  | 129 | } |
  |  | 130 |  |
  |  | 131 | } elseif(isset($request['isAuthSaved']) && $request['isAuthSaved'] === 'no' && $request['cust\_id'] == 0) { |
  |  | 132 | if ( ! user\_can( 0, 'wc\_memberships\_purchase\_restricted\_product', $object->get\_id() ) ) { |
  |  | 133 | $data['product\_restirction\_message'] = \WC\_Memberships\_User\_Messages::get\_message\_html( 'product\_purchasing\_restricted', $args ); |
  |  | 134 |  |
  |  | 135 | } else { |
  |  | 136 |  |
  |  | 137 | $data['product\_restirction\_message'] = ''; |
  |  | 138 | } |
  |  | 139 |  |
  |  | 140 | } else { |
  |  | 141 | $data['product\_restirction\_message'] = ''; |
  |  | 142 | } |
  |  | 143 |  |
  | 114 | 144 | if ( $object && ( $object->has\_attributes() || apply\_filters( 'wc\_product\_enable\_dimensions\_display', $object->has\_weight() || $object->has\_dimensions() ) ) ) { |
  | 115 | 145 | $data['showAdditionalInfoTab'] = true; |
* ## [wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php](/changeset/2904331/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php "Show the changeset 2904331 restricted to wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php")

  | [r2719086](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L144 "Show revision 2719086 of this file in browser") | [r2904331](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L144 "Show revision 2904331 of this file in browser") |  |
  | --- | --- | --- |
  | 144 | 144 | if( !is\_user\_logged\_in() ) |
  | 145 | 145 | return false; |
  | 146 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_orders', true~~ ) ) |
  |  | 146 | if( ( apply\_filters( 'wcfm\_is\_allow\_orders', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 147 | 147 | return true; |
  | 148 | 148 | return false; |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L152) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L152) |  |
  | 152 | 152 | if( !is\_user\_logged\_in() ) |
  | 153 | 153 | return false; |
  | 154 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_order\_status\_update', true~~ ) ) |
  |  | 154 | if( ( apply\_filters( 'wcfm\_is\_allow\_order\_status\_update', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 155 | 155 | return true; |
  | 156 | 156 | return false; |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L160) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L160) |  |
  | 160 | 160 | if( !is\_user\_logged\_in() ) |
  | 161 | 161 | return false; |
  | 162 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_order\_details', true~~ ) ) |
  |  | 162 | if( ( apply\_filters( 'wcfm\_is\_allow\_order\_details', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 163 | 163 | return true; |
  | 164 | 164 | return false; |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L168) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L168) |  |
  | 168 | 168 | if( !is\_user\_logged\_in() ) |
  | 169 | 169 | return false; |
  | 170 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_manage\_order', true~~ ) ) |
  |  | 170 | if( ( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 171 | 171 | return true; |
  | 172 | 172 | return false; |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L176) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L176) |  |
  | 176 | 176 | if( !is\_user\_logged\_in() ) |
  | 177 | 177 | return false; |
  | 178 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_manage\_order', true~~ ) ) |
  |  | 178 | if( ( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 179 | 179 | return true; |
  | 180 | 180 | return false; |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2719086#L184) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-order-controller.php?rev=2904331#L184) |  |
  | 184 | 184 | if( !is\_user\_logged\_in() ) |
  | 185 | 185 | return false; |
  | 186 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_manage\_order', true~~ ) ) |
  |  | 186 | if( ( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 187 | 187 | return true; |
  | 188 | 188 | return false; |
* ## [wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php](/changeset/2904331/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php "Show the changeset 2904331 restricted to wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php")

  | [r2639021](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2639021#L220 "Show revision 2639021 of this file in browser") | [r2904331](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2904331#L220 "Show revision 2904331 of this file in browser") |  |
  | --- | --- | --- |
  | 220 | 220 | public function get\_product\_permissions\_check( $request ) { |
  | 221 | 221 | // if( !is\_user\_logged\_in() )  return false; |
  | 222 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_manage\_products', true~~ ) ) { |
  |  | 222 | if( ( apply\_filters( 'wcfm\_is\_allow\_manage\_products', true ) && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) { |
  | 223 | 223 | if(isset( $request['id'] )) { |
  | 224 | 224 | //return current\_user\_can( 'edit\_post', (int) $request['id'] ); |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2639021#L242) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2904331#L242) |  |
  | 242 | 242 | public function create\_product\_permissions\_check() { |
  | 243 | 243 | if( !is\_user\_logged\_in() )  return false; |
  | 244 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_add\_products', true~~ ) ) |
  |  | 244 | if( ( apply\_filters( 'wcfm\_is\_allow\_add\_products', true )  && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) |
  | 245 | 245 | return true; |
  | 246 | 246 |  |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2639021#L256) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2904331#L256) |  |
  | 256 | 256 | public function update\_product\_permissions\_check( $request ) { |
  | 257 | 257 | if( !is\_user\_logged\_in() )  return false; |
  | 258 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_edit\_products', true~~ ) ) { |
  |  | 258 | if( ( apply\_filters( 'wcfm\_is\_allow\_edit\_products', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) { |
  | 259 | 259 | // if(isset( $request['id'] )) { |
  | 260 | 260 | //   return current\_user\_can( 'edit\_post', (int) $request['id'] ); |
  | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2639021#L275) | […](/browser/wcfm-marketplace-rest-api/trunk/includes/api/class-api-product-controller.php?rev=2904331#L275) |  |
  | 275 | 275 | public function delete\_product\_permissions\_check( $request ) { |
  | 276 | 276 | if( !is\_user\_logged\_in() )  return false; |
  | 277 |  | if( ~~apply\_filters( 'wcfm\_is\_allow\_delete\_products', true~~ ) ) { |
  |  | 277 | if( ( apply\_filters( 'wcfm\_is\_allow\_delete\_products', true )   && wcfm\_is\_vendor() ) || current\_user\_can('administrator') ) { |
  | 278 | 278 | if(isset( $request['id'] )) { |
  | 279 | 279 | return current\_user\_can( 'delete\_post', (int) $request['id'] ); |
* ## [wcfm-marketplace-rest-api/trunk/readme.txt](/changeset/2904331/wcfm-marketplace-rest-api/trunk/readme.txt "Show the changeset 2904331 restricted to wcfm-marketplace-rest-api/trunk/readme.txt")

  | [r2719086](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2719086#L4 "Show revision 2719086 of this file in browser") | [r2904331](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2904331#L4 "Show revision 2904331 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Donate link: https://www.paypal.me/wclovers/25usd |
  | 5 | 5 | Requires at least: 4.4 |
  | 6 |  | Tested up to: ~~5.9.3~~ |
  |  | 6 | Tested up to: 6.2 |
  | 7 | 7 | WC requires at least: 3.0 |
  | 8 |  | WC tested up to: ~~6.4.1~~ |
  |  | 8 | WC tested up to: 7.6.0 |
  | 9 | 9 | Requires PHP: 5.6 |
  | 10 |  | Stable tag: 1.~~5.3~~ |
  |  | 10 | Stable tag: 1.6.0 |
  | 11 | 11 | License: GPLv2 or later |
  | 12 | 12 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2719086#L164) | […](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2904331#L164) |  |
  | 164 | 164 |  |
  | 165 | 165 | == Changelog == |
  |  | 166 |  |
  |  | 167 | = 1.6.0 = |
  |  | 168 | \* Updated - 26/04/2023 \* |
  |  | 169 |  |
  |  | 170 | \* Security patch Added: Missing capability check in order route. |
  |  | 171 | \* WooCommerce latest version compatibility. |
  |  | 172 | \* WordPress latest version compatibility. |
  | 166 | 173 |  |
  | 167 | 174 | = 1.5.3 = |
  | […](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2719086#L373) | […](/browser/wcfm-marketplace-rest-api/trunk/readme.txt?rev=2904331#L380) |  |
  | 373 | 380 | == Upgrade Notice == |
  | 374 | 381 |  |
  | 375 |  | = 1.5.3 = |
  | 376 |  |  |
  | 377 |  | \* Bug Fix Shipping Tracking route |
  |  | 382 | = 1.6.0 = |
  |  | 383 |  |
  |  | 384 | \* Security patch Added: Missing capability check in order route. |
  |  | 385 | \* WooCommerce latest version compatibility. |
  |  | 386 | \* WordPress latest version compatibility. |
* ## [wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php](/changeset/2904331/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php "Show the changeset 2904331 restricted to wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php")

  | [r2719086](/browser/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php?rev=2719086#L5 "Show revision 2719086 of this file in browser") | [r2904331](/browser/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php?rev=2904331#L5 "Show revision 2904331 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | \* Description: Most featured and flexible marketplace solution for your e-commerce store. Simply and Smoothly. |
  | 6 | 6 | \* Author: WC Lovers |
  | 7 |  | \* Version: 1.~~5.3~~ |
  |  | 7 | \* Version: 1.6.0 |
  | 8 | 8 | \* Author URI: https://wclovers.com |
  | 9 | 9 | \* |
  | […](/browser/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php?rev=2719086#L12) | […](/browser/wcfm-marketplace-rest-api/trunk/wcfm-marketplace-rest-api.php?rev=2904331#L12) |  |
  | 12 | 12 | \* |
  | 13 | 13 | \* WC requires at least: 3.0.0 |
  | 14 |  | \* WC tested up to: ~~6.4.1~~ |
  |  | 14 | \* WC tested up to: 7.6.0 |
  | 15 | 15 | \* |
  | 16 | 16 | \*/ |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2904331)
* [Zip Archive](?format=zip&new=2904331)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_a6163aa9_20250114_181915.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwcfm-marketplace-rest-api%2Ftags%2F1.5.3%2Fincludes%2Fapi%2Fclass-api-order-controller.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

---

# [source:](/browser?order=name "Go to repository root") [wcfm-marketplace-rest-api](/browser/wcfm-marketplace-rest-api?order=name "View wcfm-marketplace-rest-api")/[tags](/browser/wcfm-marketplace-rest-api/tags?order=name "View tags")/[1.5.3](/browser/wcfm-marketplace-rest-api/tags/1.5.3?order=name "View 1.5.3")/[includes](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes?order=name "View includes")/[api](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api?order=name "View api")/[class-api-order-controller.php](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?order=name "View class-api-order-controller.php")

View diff against:

View revision:

| [Last change](/changeset/2719086/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php "View differences") on this file was [2719086](/changeset/2719086/ "View changeset 2719086"), checked in by wclovers, [3 years ago](/timeline?from=2022-05-06T07%3A24%3A59Z&precision=second "See timeline at 05/06/2022 07:24:59 AM") |
| --- |
| Version update 1.5.3 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 31.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class WCFM\_REST\_Order\_Controller extends WCFM\_REST\_Controller { |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Endpoint namespace |
| [5](#L5) | \* |
| [6](#L6) | \* @var string |
| [7](#L7) | \*/ |
| [8](#L8) | protected $namespace = 'wcfmmp/v1'; |
| [9](#L9) |  |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Route name |
| [12](#L12) | \* |
| [13](#L13) | \* @var string |
| [14](#L14) | \*/ |
| [15](#L15) | protected $base = 'orders'; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Post type |
| [19](#L19) | \* |
| [20](#L20) | \* @var string |
| [21](#L21) | \*/ |
| [22](#L22) | protected $post\_type = 'shop\_order'; |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Post status |
| [26](#L26) | \*/ |
| [27](#L27) | protected $post\_status = array(); |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Stores the request. |
| [31](#L31) | \* @var array |
| [32](#L32) | \*/ |
| [33](#L33) | protected $request = array(); |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* Load autometically when class initiate |
| [37](#L37) | \* |
| [38](#L38) | \* @since 1.0.0 |
| [39](#L39) | \* |
| [40](#L40) | \* @return array |
| [41](#L41) | \*/ |
| [42](#L42) | public function \_\_construct() { |
| [43](#L43) | $this->post\_status = array\_keys( wc\_get\_order\_statuses() ); |
| [44](#L44) |  |
| [45](#L45) | //        add\_filter( 'woocommerce\_new\_order\_data', array( $this, 'set\_order\_vendor\_id' ) ); |
| [46](#L46) | //        add\_action( 'woocommerce\_rest\_insert\_shop\_order\_object', array( $this, 'after\_order\_create' ), 10, 2 ); |
| [47](#L47) | } |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* Register the routes for orders. |
| [51](#L51) | \*/ |
| [52](#L52) | public function register\_routes() { |
| [53](#L53) | register\_rest\_route( $this->namespace, '/' . $this->base, array( |
| [54](#L54) | array( |
| [55](#L55) | 'methods'             => WP\_REST\_Server::READABLE, |
| [56](#L56) | 'callback'            => array( $this, 'get\_items' ), |
| [57](#L57) | 'permission\_callback' => array( $this, 'get\_orders\_permissions\_check' ), |
| [58](#L58) | 'args'                => $this->get\_collection\_params(), |
| [59](#L59) | ), |
| [60](#L60) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [61](#L61) | ) ); |
| [62](#L62) |  |
| [63](#L63) | register\_rest\_route( $this->namespace, '/' . $this->base . '/(?P<id>[\d]+)/', array( |
| [64](#L64) | 'args' => array( |
| [65](#L65) | 'id' => array( |
| [66](#L66) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [67](#L67) | 'type'        => 'integer', |
| [68](#L68) | ) |
| [69](#L69) | ), |
| [70](#L70) | array( |
| [71](#L71) | 'methods'             => WP\_REST\_Server::READABLE, |
| [72](#L72) | 'callback'            => array( $this, 'get\_item' ), |
| [73](#L73) | 'args'                => $this->get\_collection\_params(), |
| [74](#L74) | 'permission\_callback' => array( $this, 'get\_single\_order\_permissions\_check' ), |
| [75](#L75) | ), |
| [76](#L76) | array( |
| [77](#L77) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [78](#L78) | 'callback'            => array( $this, 'update\_order\_status' ), |
| [79](#L79) | 'args'                => array( |
| [80](#L80) | 'status' => array( |
| [81](#L81) | 'type'        => 'string', |
| [82](#L82) | 'description' => \_\_( 'Order Status', 'wcfm-marketplace-rest-api' ), |
| [83](#L83) | 'required'    => true, |
| [84](#L84) | 'sanitize\_callback' => 'sanitize\_text\_field', |
| [85](#L85) | ) |
| [86](#L86) | ), |
| [87](#L87) | 'permission\_callback' => array( $this, 'update\_order\_status\_permissions\_check' ), |
| [88](#L88) | ), |
| [89](#L89) | )); |
| [90](#L90) |  |
| [91](#L91) | register\_rest\_route( $this->namespace, '/' . $this->base . '/note/(?P<id>[\d]+)/', array( |
| [92](#L92) | 'args' => array( |
| [93](#L93) | 'id' => array( |
| [94](#L94) | 'description' => \_\_( 'Unique identifier for the object.', 'wcfm-marketplace-rest-api' ), |
| [95](#L95) | 'type'        => 'integer', |
| [96](#L96) | ) |
| [97](#L97) | ), |
| [98](#L98) | array( |
| [99](#L99) | 'methods'             => WP\_REST\_Server::READABLE, |
| [100](#L100) | 'callback'            => array( $this, 'get\_order\_notes' ), |
| [101](#L101) | 'args'                => $this->get\_collection\_params(), |
| [102](#L102) | 'permission\_callback' => array( $this, 'get\_order\_note\_permissions\_check' ), |
| [103](#L103) | ), |
| [104](#L104) | array( |
| [105](#L105) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [106](#L106) | 'callback'            => array( $this, 'add\_order\_note' ), |
| [107](#L107) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [108](#L108) | 'permission\_callback' => array( $this, 'add\_order\_note\_permissions\_check' ), |
| [109](#L109) | ), |
| [110](#L110) | )); |
| [111](#L111) |  |
| [112](#L112) | register\_rest\_route( $this->namespace, '/' . $this->base . '/shipment\_tracking/', array( |
| [113](#L113) | array( |
| [114](#L114) | 'methods'             => WP\_REST\_Server::EDITABLE, |
| [115](#L115) | 'callback'            => array( $this, 'update\_shipment\_tracking' ), |
| [116](#L116) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( WP\_REST\_Server::EDITABLE ), |
| [117](#L117) | 'permission\_callback' => array( $this, 'update\_shipment\_tracking\_permissions\_check' ), |
| [118](#L118) | ), |
| [119](#L119) | )); |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | /\*\* |
| [123](#L123) | \* Get object. |
| [124](#L124) | \* |
| [125](#L125) | \* @since  1.0.0 |
| [126](#L126) | \* @param  int $id Object ID. |
| [127](#L127) | \* @return WC\_Data |
| [128](#L128) | \*/ |
| [129](#L129) | public function get\_object( $id ) { |
| [130](#L130) | if(!wc\_get\_order($id)) |
| [131](#L131) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", sprintf( \_\_( "Invalid ID", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [132](#L132) | return wc\_get\_order( $id ); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) |  |
| [136](#L136) | /\*\* |
| [137](#L137) | \* Checking if have any permission to view orders |
| [138](#L138) | \* |
| [139](#L139) | \* @since 1.0.0 |
| [140](#L140) | \* |
| [141](#L141) | \* @return boolean |
| [142](#L142) | \*/ |
| [143](#L143) | public function get\_orders\_permissions\_check() { |
| [144](#L144) | if( !is\_user\_logged\_in() ) |
| [145](#L145) | return false; |
| [146](#L146) | if( apply\_filters( 'wcfm\_is\_allow\_orders', true ) ) |
| [147](#L147) | return true; |
| [148](#L148) | return false; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | public function update\_order\_status\_permissions\_check() { |
| [152](#L152) | if( !is\_user\_logged\_in() ) |
| [153](#L153) | return false; |
| [154](#L154) | if( apply\_filters( 'wcfm\_is\_allow\_order\_status\_update', true ) ) |
| [155](#L155) | return true; |
| [156](#L156) | return false; |
| [157](#L157) | } |
| [158](#L158) |  |
| [159](#L159) | public function get\_single\_order\_permissions\_check() { |
| [160](#L160) | if( !is\_user\_logged\_in() ) |
| [161](#L161) | return false; |
| [162](#L162) | if( apply\_filters( 'wcfm\_is\_allow\_order\_details', true ) ) |
| [163](#L163) | return true; |
| [164](#L164) | return false; |
| [165](#L165) | } |
| [166](#L166) |  |
| [167](#L167) | public function get\_order\_note\_permissions\_check() { |
| [168](#L168) | if( !is\_user\_logged\_in() ) |
| [169](#L169) | return false; |
| [170](#L170) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [171](#L171) | return true; |
| [172](#L172) | return false; |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | public function add\_order\_note\_permissions\_check() { |
| [176](#L176) | if( !is\_user\_logged\_in() ) |
| [177](#L177) | return false; |
| [178](#L178) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [179](#L179) | return true; |
| [180](#L180) | return false; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | public function update\_shipment\_tracking\_permissions\_check() { |
| [184](#L184) | if( !is\_user\_logged\_in() ) |
| [185](#L185) | return false; |
| [186](#L186) | if( apply\_filters( 'wcfm\_is\_allow\_manage\_order', true ) ) |
| [187](#L187) | return true; |
| [188](#L188) | return false; |
| [189](#L189) | } |
| [190](#L190) |  |
| [191](#L191) |  |
| [192](#L192) | public function get\_post\_type\_items( $request ) { |
| [193](#L193) | global $WCFM; |
| [194](#L194) |  |
| [195](#L195) | $orders = $this->get\_objects\_from\_database($request); |
| [196](#L196) | $order\_return\_obj = array(); |
| [197](#L197) | foreach ($orders as $each\_order ) { |
| [198](#L198) |  |
| [199](#L199) | if($each\_order->vendor\_id) { |
| [200](#L200) | $order\_object = $this->get\_object( $each\_order->order\_id ); |
| [201](#L201) | $formated\_order\_data = $this->get\_formatted\_item\_data($order\_object, $each\_order->vendor\_id ); |
| [202](#L202) | $formated\_order\_data['vendor\_order\_details'] = $each\_order; |
| [203](#L203) | $order\_return\_obj[] =  $formated\_order\_data; |
| [204](#L204) | } else { |
| [205](#L205) | $order\_object = $this->get\_object($each\_order->ID); |
| [206](#L206) |  |
| [207](#L207) | $order\_return\_obj[] = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [208](#L208) | } |
| [209](#L209) | } |
| [210](#L210) | $response = rest\_ensure\_response($order\_return\_obj); |
| [211](#L211) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_objects", $response, $orders, $request ); |
| [212](#L212) | } |
| [213](#L213) |  |
| [214](#L214) | protected function get\_objects\_from\_database( $request ) { |
| [215](#L215) | global $WCFM; |
| [216](#L216) | $\_POST["controller"] = 'wcfm-orders'; |
| [217](#L217) | $\_POST['length'] = !empty($request['per\_page']) ? intval($request['per\_page']) : 10; |
| [218](#L218) | $\_POST['start'] = !empty($request['page']) ? ( intval($request['page']) - 1 ) \* $\_POST['length'] : 0; |
| [219](#L219) | //    if(empty($request['page'])){ |
| [220](#L220) | //      $\_POST['start'] = !empty($request['offset']) ? intval($request['offset']) : 0; |
| [221](#L221) | //    } |
| [222](#L222) | $\_POST['filter\_date\_form'] = !empty($request['after']) ? $request['after'] : ''; |
| [223](#L223) | $\_POST['filter\_date\_to'] = !empty($request['before']) ? $request['before'] : ''; |
| [224](#L224) | $\_POST['search']['value'] = !empty($request['search']) ? $request['search'] : ''; |
| [225](#L225) | $\_POST['orderby'] = !empty($request['orderby']) ? $request['orderby'] : ''; |
| [226](#L226) | $\_POST['order'] = !empty($request['order']) ? $request['order'] : ''; |
| [227](#L227) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [228](#L228) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [229](#L229) | $WCFM->init(); |
| [230](#L230) | $orders = $WCFM->ajax->wcfm\_ajax\_controller(); |
| [231](#L231) | return $orders; |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) |  |
| [235](#L235) | public function get\_post\_type\_item( $request , $id ) { |
| [236](#L236) | global $WCFM; |
| [237](#L237) | $order\_return\_obj = array(); |
| [238](#L238) | if( wcfm\_is\_vendor() ) { |
| [239](#L239) |  |
| [240](#L240) | $is\_order\_for\_vendor = $WCFM->wcfm\_vendor\_support->wcfm\_is\_order\_for\_vendor( $id ); |
| [241](#L241) | if( $is\_order\_for\_vendor ) { |
| [242](#L242) | $current\_vendor   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [243](#L243) | $order\_object = $this->get\_object( $id ); |
| [244](#L244) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, $current\_vendor ); |
| [245](#L245) | } else { |
| [246](#L246) | return new WP\_Error( "wcfmapi\_rest\_invalid\_vendor", sprintf( \_\_( "Invalid Vendor - Order Id do not belong to the loggedin vendor", 'wcfm-marketplace-rest-api' ), \_\_METHOD\_\_ ), array( 'status' => 404 ) ); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | } else { |
| [250](#L250) | $order\_object = $this->get\_object( $id ); |
| [251](#L251) | $order\_return\_obj = $this->get\_formatted\_item\_data($order\_object, 0 ); |
| [252](#L252) | } |
| [253](#L253) | $response = rest\_ensure\_response($order\_return\_obj); |
| [254](#L254) | return apply\_filters( "wcfmapi\_rest\_prepare\_{$this->post\_type}\_object", $response, $order\_object, $request ); |
| [255](#L255) | } |
| [256](#L256) |  |
| [257](#L257) |  |
| [258](#L258) | protected function get\_formatted\_item\_data( $object, $each\_order\_vendor\_id ) { |
| [259](#L259) | $data = $object->get\_data(); |
| [260](#L260) | $order\_id = $data['id']; |
| [261](#L261) | $order\_status = $data['status']; |
| [262](#L262) | //print\_r($data);die; |
| [263](#L263) | $format\_date       = array( 'date\_created', 'date\_modified', 'date\_completed', 'date\_paid' ); |
| [264](#L264) | $format\_line\_items = array( 'line\_items', 'tax\_lines', 'shipping\_lines', 'fee\_lines', 'coupon\_lines' ); |
| [265](#L265) |  |
| [266](#L266) | // Format date values. |
| [267](#L267) | foreach ( $format\_date as $key ) { |
| [268](#L268) | $datetime              = $data[ $key ]; |
| [269](#L269) | $data[ $key ]          = wc\_rest\_prepare\_date\_response( $datetime, false ); |
| [270](#L270) | $data[ $key . '\_gmt' ] = wc\_rest\_prepare\_date\_response( $datetime ); |
| [271](#L271) | } |
| [272](#L272) |  |
| [273](#L273) | // Format state and country |
| [274](#L274) | if($data['billing']['state']) { |
| [275](#L275) | $data['billing']['state'] = WC()->countries->get\_states( $data['billing']['country'] )[$data['billing']['state']]; |
| [276](#L276) | } |
| [277](#L277) | if($data['shipping']['state']) { |
| [278](#L278) | $data['shipping']['state'] = WC()->countries->get\_states( $data['shipping']['country'] )[$data['shipping']['state']]; |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | // Add Commission Head |
| [282](#L282) | $data['commission\_head'] = $this->wcfmmp\_line\_item\_commission\_head($object, $each\_order\_vendor\_id); |
| [283](#L283) |  |
| [284](#L284) | // Add Delivery datetime & location |
| [285](#L285) | $data['user\_delivery\_location'] = $object->get\_meta('\_wcfmmp\_user\_location', true); |
| [286](#L286) | $wcfmd\_delvery\_times = $object->get\_meta('\_wcfmd\_delvery\_times', true); |
| [287](#L287) | if( !empty(  $wcfmd\_delvery\_times ) ) { |
| [288](#L288) | $data['user\_delivery\_time'] = date('Y-m-d H:i:s', $wcfmd\_delvery\_times[$each\_order\_vendor\_id]); |
| [289](#L289) | } |
| [290](#L290) |  |
| [291](#L291) | // Format line items. |
| [292](#L292) |  |
| [293](#L293) | foreach ( $format\_line\_items as $key ) { |
| [294](#L294) | if( $each\_order\_vendor\_id ) { |
| [295](#L295) | $line\_item\_datas = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [296](#L296) | $line\_item\_datas\_final = array(); |
| [297](#L297) | //print\_r($line\_item\_datas); |
| [298](#L298) | if($key == 'line\_items') { |
| [299](#L299) | //print\_r($line\_item\_datas); |
| [300](#L300) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [301](#L301) | $order\_item\_product = new WC\_Order\_Item\_Product($line\_item['id']); |
| [302](#L302) | $order\_product\_vendor\_id = $order\_item\_product->get\_meta('\_vendor\_id', true); |
| [303](#L303) | if( $order\_product\_vendor\_id && $order\_product\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [304](#L304) |  |
| [305](#L305) | // Add Store Name |
| [306](#L306) | if( $this->is\_vendor\_sold\_by( absint($order\_product\_vendor\_id) ) ) { |
| [307](#L307) |  |
| [308](#L308) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($order\_product\_vendor\_id) ); |
| [309](#L309) |  |
| [310](#L310) | $line\_item['store\_name'] = $shop\_name; |
| [311](#L311) |  |
| [312](#L312) | } |
| [313](#L313) | // Add Commission Value |
| [314](#L314) | $line\_item['commission\_value'] = $this->wcfmmp\_line\_item\_commission($order\_item\_product, $object, $order\_product\_vendor\_id); |
| [315](#L315) |  |
| [316](#L316) | $line\_item\_datas\_final[] = $line\_item; |
| [317](#L317) | } |
| [318](#L318) | // $line\_item\_datas\_final[] = $line\_item; |
| [319](#L319) | } |
| [320](#L320) | } |
| [321](#L321) | else if( $key == 'shipping\_lines' ) { |
| [322](#L322) | foreach( $line\_item\_datas as $item\_key => $line\_item ) { |
| [323](#L323) | //var\_dump($line\_item['id']); |
| [324](#L324) | $order\_item\_shipping = new WC\_Order\_Item\_Shipping($line\_item['id']); |
| [325](#L325) | $shipping\_vendor\_id = $order\_item\_shipping->get\_meta('vendor\_id', true); |
| [326](#L326) | if( $shipping\_vendor\_id && $shipping\_vendor\_id  == $each\_order\_vendor\_id ) { |
| [327](#L327) |  |
| [328](#L328) | // Add Store Name |
| [329](#L329) | if( $this->is\_vendor\_sold\_by( absint($shipping\_vendor\_id) ) ) { |
| [330](#L330) |  |
| [331](#L331) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($shipping\_vendor\_id) ); |
| [332](#L332) |  |
| [333](#L333) | $line\_item['store\_name'] = $shop\_name; |
| [334](#L334) |  |
| [335](#L335) | } |
| [336](#L336) | $line\_item\_datas\_final[] = $line\_item; |
| [337](#L337) | } |
| [338](#L338) | // $line\_item\_datas\_final[] = $line\_item; |
| [339](#L339) | } |
| [340](#L340) | } |
| [341](#L341) | else { |
| [342](#L342) | $line\_item\_datas\_final = $line\_item\_datas; |
| [343](#L343) | } |
| [344](#L344) | $data[ $key ] = $line\_item\_datas\_final; |
| [345](#L345) |  |
| [346](#L346) | } else { |
| [347](#L347) | $data[ $key ] = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ),  $data[ $key ] ) ); |
| [348](#L348) | } |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | // Add Shipment Tracking |
| [352](#L352) | if( ( ( $object->needs\_shipping\_address() && $object->get\_formatted\_shipping\_address() ) || apply\_filters( 'wcfm\_is\_force\_shipping\_address', false ) ) && ( !function\_exists( 'wcs\_order\_contains\_subscription' ) || ( !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) && !wcs\_order\_contains\_subscription( $order\_id, 'renewal' ) ) ) && apply\_filters( 'wcfm\_is\_pref\_shipment\_tracking', true ) && apply\_filters( 'wcfm\_is\_allow\_shipping\_tracking', true ) && !in\_array( $order\_status, apply\_filters( 'wcfm\_shipment\_disable\_order\_status', array( 'failed', 'cancelled', 'refunded', 'pending' ) ) ) ) { |
| [353](#L353) |  |
| [354](#L354) | $data['shipment\_tracking'] = $this->get\_order\_shipping\_data( $object ); |
| [355](#L355) | } |
| [356](#L356) |  |
| [357](#L357) | $data['status'] = apply\_filters( 'wcfm\_current\_order\_status', $data['status'], $data['id'] ); |
| [358](#L358) |  |
| [359](#L359) | // Format the order status. |
| [360](#L360) | $data['status'] = 'wc-' === substr( $data['status'], 0, 3 ) ? substr( $data['status'], 3 ) : $data['status']; |
| [361](#L361) | return $data; |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) |  |
| [365](#L365) | /\*\* |
| [366](#L366) | \* Expands an order item to get its data. |
| [367](#L367) | \* |
| [368](#L368) | \* @param WC\_Order\_item $item |
| [369](#L369) | \* |
| [370](#L370) | \* @return array |
| [371](#L371) | \*/ |
| [372](#L372) | protected function get\_order\_item\_data( $item ) { |
| [373](#L373) |  |
| [374](#L374) | $data           = $item->get\_data(); |
| [375](#L375) |  |
| [376](#L376) | // Add Shop Name |
| [377](#L377) | /\*$meta\_data         = $item->get\_meta\_data(); |
| [378](#L378) | foreach ( $meta\_data as $meta ) { |
| [379](#L379) |  |
| [380](#L380) | if( !is\_array( $meta->key ) ) { |
| [381](#L381) |  |
| [382](#L382) | $meta->key     = rawurldecode( (string) $meta->key ); |
| [383](#L383) |  |
| [384](#L384) | if( $meta->key == '\_vendor\_id' ) { |
| [385](#L385) |  |
| [386](#L386) | $meta->value   = rawurldecode( (string) $meta->value ); |
| [387](#L387) |  |
| [388](#L388) | if( $this->is\_vendor\_sold\_by( absint($meta->value) ) ) { |
| [389](#L389) |  |
| [390](#L390) | $shop\_name = wcfm\_get\_vendor\_store\_name( absint($meta->value) ); |
| [391](#L391) |  |
| [392](#L392) | $data['shop\_name'] = $shop\_name; |
| [393](#L393) |  |
| [394](#L394) | } |
| [395](#L395) |  |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | } |
| [399](#L399) |  |
| [400](#L400) | } \*/ |
| [401](#L401) |  |
| [402](#L402) | $format\_decimal = array( 'subtotal', 'subtotal\_tax', 'total', 'total\_tax', 'tax\_total', 'shipping\_tax\_total' ); |
| [403](#L403) |  |
| [404](#L404) | // Format decimal values. |
| [405](#L405) | foreach ( $format\_decimal as $key ) { |
| [406](#L406) | if ( isset( $data[ $key ] ) ) { |
| [407](#L407) | $data[ $key ] = wc\_format\_decimal( $data[ $key ], ( isset($this->request['dp']) ) ? $this->request['dp'] : false ); |
| [408](#L408) | } |
| [409](#L409) | } |
| [410](#L410) |  |
| [411](#L411) | // Add SKU, THUMBNAIL and PRICE to products. |
| [412](#L412) | if ( is\_callable( array( $item, 'get\_product' ) ) ) { |
| [413](#L413) | $\_product = $item->get\_product(); |
| [414](#L414) | $data['sku']   = $\_product ? $\_product->get\_sku(): null; |
| [415](#L415) | $data['thumbnail']     = $\_product ? apply\_filters( 'woocommerce\_admin\_order\_item\_thumbnail', $\_product->get\_image( 'thumbnail', array( 'title' => '' ), false ), $data['id'], $item ) : ''; |
| [416](#L416) | $data['image\_url'] = $\_product ? wp\_get\_attachment\_image\_url( $\_product->get\_image\_id(), 'thumbnail' ) : null; |
| [417](#L417) | $data['price'] = (float)( $item->get\_total() / max( 1, $item->get\_quantity() ) ); |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | // Format taxes. |
| [421](#L421) | if ( ! empty( $data['taxes']['total'] ) ) { |
| [422](#L422) | $taxes = array(); |
| [423](#L423) |  |
| [424](#L424) | foreach ( $data['taxes']['total'] as $tax\_rate\_id => $tax ) { |
| [425](#L425) | $taxes[] = array( |
| [426](#L426) | 'id'       => $tax\_rate\_id, |
| [427](#L427) | 'total'    => $tax, |
| [428](#L428) | 'subtotal' => isset( $data['taxes']['subtotal'][ $tax\_rate\_id ] ) ? $data['taxes']['subtotal'][ $tax\_rate\_id ] : '', |
| [429](#L429) | ); |
| [430](#L430) | } |
| [431](#L431) | $data['taxes'] = $taxes; |
| [432](#L432) | } elseif ( isset( $data['taxes'] ) ) { |
| [433](#L433) | $data['taxes'] = array(); |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | // Remove names for coupons, taxes and shipping. |
| [437](#L437) | if ( isset( $data['code'] ) || isset( $data['rate\_code'] ) || isset( $data['method\_title'] ) ) { |
| [438](#L438) | unset( $data['name'] ); |
| [439](#L439) | } |
| [440](#L440) |  |
| [441](#L441) | // Remove props we don't want to expose. |
| [442](#L442) | unset( $data['order\_id'] ); |
| [443](#L443) | unset( $data['type'] ); |
| [444](#L444) |  |
| [445](#L445) | return $data; |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | /\*\* |
| [449](#L449) |  |
| [450](#L450) | \* Return is show sold by label |
| [451](#L451) |  |
| [452](#L452) | \* @return boolean |
| [453](#L453) |  |
| [454](#L454) | \*/ |
| [455](#L455) |  |
| [456](#L456) | public function is\_vendor\_sold\_by( $vendor\_id = '' ) { |
| [457](#L457) |  |
| [458](#L458) | global $WCFM, $WCFMmp; |
| [459](#L459) |  |
| [460](#L460) |  |
| [461](#L461) |  |
| [462](#L462) | $wcfmmp\_marketplace\_options   = get\_option( 'wcfm\_marketplace\_options', array() ); |
| [463](#L463) |  |
| [464](#L464) | $vendor\_sold\_by = isset( $wcfmmp\_marketplace\_options['vendor\_sold\_by'] ) ? $wcfmmp\_marketplace\_options['vendor\_sold\_by'] : 'yes'; |
| [465](#L465) |  |
| [466](#L466) | if( $vendor\_sold\_by == 'yes' ) { |
| [467](#L467) |  |
| [468](#L468) | if( !$vendor\_id || ( $vendor\_id && apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $vendor\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $vendor\_id, 'sold\_by' ) ) ) { |
| [469](#L469) |  |
| [470](#L470) | return true; |
| [471](#L471) |  |
| [472](#L472) | } else { |
| [473](#L473) |  |
| [474](#L474) | return false; |
| [475](#L475) |  |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | } |
| [479](#L479) |  |
| [480](#L480) | return false; |
| [481](#L481) |  |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | // WCFMmp Line Item Commission Head |
| [485](#L485) |  |
| [486](#L486) | protected function wcfmmp\_line\_item\_commission\_head( $order, $vendor\_id ) { |
| [487](#L487) |  |
| [488](#L488) | global $WCFM, $WCFMmp; |
| [489](#L489) |  |
| [490](#L490) |  |
| [491](#L491) | if( wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) { |
| [492](#L492) |  |
| [493](#L493) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [494](#L494) |  |
| [495](#L495) | if( $admin\_fee\_mode ) { |
| [496](#L496) |  |
| [497](#L497) | return \_\_( 'Fees', 'wc-frontend-manager' ); |
| [498](#L498) |  |
| [499](#L499) | } else { |
| [500](#L500) |  |
| [501](#L501) | return \_\_( 'Earning', 'wc-frontend-manager' ); |
| [502](#L502) |  |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | // WCFMmp Line item Commission |
| [510](#L510) |  |
| [511](#L511) | protected function wcfmmp\_line\_item\_commission( $item, $order, $vendor\_id ) { |
| [512](#L512) |  |
| [513](#L513) | global $WCFM, $wpdb, $WCFMmp; |
| [514](#L514) |  |
| [515](#L515) | if( !wcfm\_vendor\_has\_capability( $vendor\_id, 'view\_commission' ) ) return; |
| [516](#L516) |  |
| [517](#L517) | $order\_currency = $order->get\_currency(); |
| [518](#L518) |  |
| [519](#L519) | $admin\_fee\_mode = apply\_filters( 'wcfm\_is\_admin\_fee\_mode', false ); |
| [520](#L520) |  |
| [521](#L521) | $qty = ( isset( $item['qty'] ) ? esc\_html( $item['qty'] ) : '1' ); |
| [522](#L522) |  |
| [523](#L523) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_deduct\_discount( $vendor\_id, $order->get\_id() ) ) { |
| [524](#L524) |  |
| [525](#L525) | $line\_total = $item->get\_total(); |
| [526](#L526) |  |
| [527](#L527) | } else { |
| [528](#L528) |  |
| [529](#L529) | $line\_total = $item->get\_subtotal(); |
| [530](#L530) |  |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | if( $item->get\_product\_id() ) { |
| [534](#L534) |  |
| [535](#L535) | $product\_id = $item->get\_product\_id(); |
| [536](#L536) |  |
| [537](#L537) | $variation\_id = $item->get\_variation\_id(); |
| [538](#L538) |  |
| [539](#L539) | } else { |
| [540](#L540) |  |
| [541](#L541) | $product\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_product\_id', true ); |
| [542](#L542) |  |
| [543](#L543) | $variation\_id = wc\_get\_order\_item\_meta( $item->get\_id(), '\_variation\_id', true ); |
| [544](#L544) |  |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $sql = " |
| [548](#L548) |  |
| [549](#L549) | SELECT item\_id, is\_refunded, commission\_amount AS line\_total, shipping AS total\_shipping, tax, shipping\_tax\_amount |
| [550](#L550) |  |
| [551](#L551) | FROM {$wpdb->prefix}wcfm\_marketplace\_orders |
| [552](#L552) |  |
| [553](#L553) | WHERE (product\_id = " . $product\_id . " OR variation\_id = " . $variation\_id . ") |
| [554](#L554) |  |
| [555](#L555) | AND   order\_id    = " . $order->get\_id() . " |
| [556](#L556) |  |
| [557](#L557) | AND   item\_id     = " . $item->get\_id() . " |
| [558](#L558) |  |
| [559](#L559) | AND   `vendor\_id` = " . $vendor\_id; |
| [560](#L560) |  |
| [561](#L561) | $order\_line\_due = $wpdb->get\_results( $sql ); |
| [562](#L562) |  |
| [563](#L563) |  |
| [564](#L564) |  |
| [565](#L565) | if( !empty( $order\_line\_due ) && !$order\_line\_due[0]->is\_refunded ) { |
| [566](#L566) |  |
| [567](#L567) | if ( $get\_shipping = $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_shipping( $vendor\_id ) ) { |
| [568](#L568) |  |
| [569](#L569) | //$line\_total += $order\_line\_due[0]->total\_shipping; |
| [570](#L570) |  |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | if ( $WCFMmp->wcfmmp\_vendor->is\_vendor\_get\_tax( $vendor\_id ) ) { |
| [574](#L574) |  |
| [575](#L575) | $line\_total += $order\_line\_due[0]->tax; |
| [576](#L576) |  |
| [577](#L577) | $order\_line\_due[0]->line\_total += $order\_line\_due[0]->tax; |
| [578](#L578) |  |
| [579](#L579) | if( $get\_shipping ) { |
| [580](#L580) |  |
| [581](#L581) | //$line\_total += $order\_line\_due[0]->shipping\_tax\_amount; |
| [582](#L582) |  |
| [583](#L583) | } |
| [584](#L584) |  |
| [585](#L585) | } |
| [586](#L586) |  |
| [587](#L587) | if( $admin\_fee\_mode ) { |
| [588](#L588) |  |
| [589](#L589) | $refunded = $order->get\_total\_refunded\_for\_item( $item->get\_id() ); |
| [590](#L590) |  |
| [591](#L591) | return $line\_total - $refunded - $order\_line\_due[0]->line\_total; |
| [592](#L592) |  |
| [593](#L593) | } else { |
| [594](#L594) |  |
| [595](#L595) | return $order\_line\_due[0]->line\_total; |
| [596](#L596) |  |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | } else { |
| [600](#L600) |  |
| [601](#L601) | return 0; |
| [602](#L602) |  |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | } |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* |
| [609](#L609) | \* |
| [610](#L610) | \*/ |
| [611](#L611) | protected function get\_order\_shipping\_data( $order ) { |
| [612](#L612) |  |
| [613](#L613) | global $WCFM; |
| [614](#L614) |  |
| [615](#L615) | $needs\_shipping\_tracking = false; |
| [616](#L616) |  |
| [617](#L617) | $product\_ids = array(); |
| [618](#L618) |  |
| [619](#L619) | $order\_item\_ids = array(); |
| [620](#L620) |  |
| [621](#L621) | $line\_items = $order->get\_items( 'line\_item' ); |
| [622](#L622) |  |
| [623](#L623) | $line\_items = apply\_filters( 'wcfm\_valid\_line\_items', $line\_items, $order->get\_id() ); |
| [624](#L624) |  |
| [625](#L625) | $shipment\_tracking\_data = array(); |
| [626](#L626) |  |
| [627](#L627) | foreach ( $line\_items as $item\_id => $item ) { |
| [628](#L628) |  |
| [629](#L629) | $each\_data = array(); |
| [630](#L630) |  |
| [631](#L631) | $\_product  = $item->get\_product(); |
| [632](#L632) |  |
| [633](#L633) | $needs\_shipping = $WCFM->frontend->is\_wcfm\_needs\_shipping( $\_product ); |
| [634](#L634) |  |
| [635](#L635) | $shipped = true; |
| [636](#L636) |  |
| [637](#L637) | $tracking\_url  = ''; |
| [638](#L638) |  |
| [639](#L639) | $tracking\_code = ''; |
| [640](#L640) |  |
| [641](#L641) | $delivery\_boy  = ''; |
| [642](#L642) |  |
| [643](#L643) | $delivery\_boy\_name = ''; |
| [644](#L644) |  |
| [645](#L645) | if( $needs\_shipping ) { |
| [646](#L646) |  |
| [647](#L647) | $shipped = false; |
| [648](#L648) |  |
| [649](#L649) | foreach ( $item->get\_formatted\_meta\_data() as $meta\_id => $meta ) { |
| [650](#L650) |  |
| [651](#L651) | if( $meta->key == 'wcfm\_tracking\_url' ) { |
| [652](#L652) |  |
| [653](#L653) | $tracking\_url  = $meta->value; |
| [654](#L654) |  |
| [655](#L655) | $shipped = true; |
| [656](#L656) |  |
| [657](#L657) | } elseif( $meta->key == 'wcfm\_tracking\_code' ) { |
| [658](#L658) |  |
| [659](#L659) | $tracking\_code  = $meta->value; |
| [660](#L660) |  |
| [661](#L661) | } elseif( $meta->key == 'wcfm\_delivery\_boy' ) { |
| [662](#L662) |  |
| [663](#L663) | $delivery\_boy  = $meta->value; |
| [664](#L664) |  |
| [665](#L665) | } |
| [666](#L666) |  |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | } else { |
| [670](#L670) |  |
| [671](#L671) | continue; |
| [672](#L672) |  |
| [673](#L673) | } |
| [674](#L674) |  |
| [675](#L675) | $order\_item\_ids[] = $item->get\_id(); |
| [676](#L676) |  |
| [677](#L677) | $product\_ids[]    = $item->get\_product\_id(); |
| [678](#L678) |  |
| [679](#L679) | $each\_data['item\_id'] = $item->get\_id(); |
| [680](#L680) | $each\_data['product\_id'] = $item->get\_product\_id(); |
| [681](#L681) |  |
| [682](#L682) | //if( $shipped ) continue; |
| [683](#L683) |  |
| [684](#L684) | $needs\_shipping\_tracking = true; |
| [685](#L685) |  |
| [686](#L686) |  |
| [687](#L687) | if( ( !empty( $product\_ids ) && ( count( $product\_ids ) == 1 ) ) || apply\_filters( 'wcfm\_is\_allow\_itemwise\_notification', true ) ) { |
| [688](#L688) |  |
| [689](#L689) | $each\_data['product\_name'] = esc\_html( $item->get\_name() ); |
| [690](#L690) |  |
| [691](#L691) | if ( $\_product && $\_product->get\_sku() ) { |
| [692](#L692) |  |
| [693](#L693) | $each\_data['sku'] = esc\_html( $\_product->get\_sku() ); |
| [694](#L694) |  |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | if ( $tracking\_code ) { |
| [698](#L698) |  |
| [699](#L699) | $each\_data['tracking\_code'] = $tracking\_code; |
| [700](#L700) |  |
| [701](#L701) | } |
| [702](#L702) |  |
| [703](#L703) | if ( $tracking\_url ) { |
| [704](#L704) |  |
| [705](#L705) | $each\_data['tracking\_url'] = $tracking\_url; |
| [706](#L706) |  |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | if ( $delivery\_boy ) { |
| [710](#L710) |  |
| [711](#L711) | $each\_data['delivery\_boy'] = $delivery\_boy; |
| [712](#L712) | $wcfm\_delivery\_boy\_user = get\_userdata( absint( $delivery\_boy ) ); |
| [713](#L713) | if ( $wcfm\_delivery\_boy\_user ) { |
| [714](#L714) | $delivery\_boy\_name = apply\_filters( 'wcfm\_delivery\_boy\_display', $wcfm\_delivery\_boy\_user->first\_name . ' ' . $wcfm\_delivery\_boy\_user->last\_name, $delivery\_boy ); |
| [715](#L715) | $each\_data['delivery\_boy\_name'] = $delivery\_boy\_name; |
| [716](#L716) | } |
| [717](#L717) |  |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | if ( function\_exists( 'wcfm\_is\_order\_delivered' ) ) { |
| [721](#L721) |  |
| [722](#L722) | $is\_order\_delivered = wcfm\_is\_order\_delivered( $order->get\_id(), $item\_id ); |
| [723](#L723) |  |
| [724](#L724) | if( $is\_order\_delivered ) { |
| [725](#L725) |  |
| [726](#L726) | $each\_data['delivery\_status'] = 'completed'; |
| [727](#L727) |  |
| [728](#L728) | } else { |
| [729](#L729) |  |
| [730](#L730) | $each\_data['delivery\_status'] = 'pending'; |
| [731](#L731) |  |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | if( $\_product ) { |
| [736](#L736) |  |
| [737](#L737) | $each\_data['mark\_shipped'] = true; |
| [738](#L738) |  |
| [739](#L739) | } |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | $shipment\_tracking\_data['each\_data'][] = $each\_data; |
| [743](#L743) |  |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | if( !empty( $product\_ids ) && ( count( $product\_ids ) > 1 ) ) { |
| [747](#L747) |  |
| [748](#L748) | $shipment\_tracking\_data['mark\_all'] = array( |
| [749](#L749) |  |
| [750](#L750) | 'product\_ids' => $product\_ids, |
| [751](#L751) | 'order\_item\_ids' => $order\_item\_ids |
| [752](#L752) |  |
| [753](#L753) | ); |
| [754](#L754) |  |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | $wcfm\_delivery\_boys\_array = function\_exists( 'wcfm\_get\_delivery\_boys' ) ? wcfm\_get\_delivery\_boys() : array(); |
| [758](#L758) |  |
| [759](#L759) | if(!empty($wcfm\_delivery\_boys\_array)) { |
| [760](#L760) |  |
| [761](#L761) | $delivery\_users = array(); |
| [762](#L762) |  |
| [763](#L763) | foreach( $wcfm\_delivery\_boys\_array as $wcfm\_delivery\_boys\_single ) { |
| [764](#L764) |  |
| [765](#L765) | $delivery\_users[] = array( 'id' => $wcfm\_delivery\_boys\_single->ID, |
| [766](#L766) | 'name' => $wcfm\_delivery\_boys\_single->first\_name . ' ' . $wcfm\_delivery\_boys\_single->last\_name . ' (' . $wcfm\_delivery\_boys\_single->user\_email . ')'); |
| [767](#L767) |  |
| [768](#L768) | } |
| [769](#L769) |  |
| [770](#L770) | $shipment\_tracking\_data['delivery\_boys'] = $delivery\_users; |
| [771](#L771) |  |
| [772](#L772) | } |
| [773](#L773) |  |
| [774](#L774) | return $shipment\_tracking\_data; |
| [775](#L775) |  |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | public function update\_shipment\_tracking( $request ) { |
| [779](#L779) | global $WCFM, $WCFMu, $WCFMd; |
| [780](#L780) |  |
| [781](#L781) | $\_POST['orderid'] = !empty($request['order\_id']) ? $request['order\_id'] : ''; |
| [782](#L782) |  |
| [783](#L783) | $\_POST['tracking\_data'] = ""; |
| [784](#L784) |  |
| [785](#L785) | $\_POST['tracking\_data'] .= "wcfm\_tracking\_order\_id="; |
| [786](#L786) | $\_POST['tracking\_data'] .= !empty($request['order\_id']) ? $request['order\_id'] : ""; |
| [787](#L787) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_product\_id="; |
| [788](#L788) | $\_POST['tracking\_data'] .= !empty($request['product\_id']) ? $request['product\_id'] : ""; |
| [789](#L789) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_order\_item\_id="; |
| [790](#L790) | $\_POST['tracking\_data'] .= !empty($request['item\_id']) ? $request['item\_id'] : ""; |
| [791](#L791) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_url="; |
| [792](#L792) | $\_POST['tracking\_data'] .= !empty($request['tracking\_url']) ? $request['tracking\_url'] : ""; |
| [793](#L793) | $\_POST['tracking\_data'] .= "&wcfm\_tracking\_code="; |
| [794](#L794) | $\_POST['tracking\_data'] .= !empty($request['tracking\_code']) ? $request['tracking\_code'] : ""; |
| [795](#L795) | $\_POST['tracking\_data'] .= "&wcfm\_delivery\_boy="; |
| [796](#L796) | $\_POST['tracking\_data'] .= !empty($request['delivery\_boy']) ? $request['delivery\_boy'] : ""; |
| [797](#L797) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [798](#L798) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [799](#L799) | if(WCFMapi\_Dependencies::wcfmapi\_ultimate\_plugin\_active\_check()) { |
| [800](#L800) | $WCFMu->init\_wcfmu(); |
| [801](#L801) | $wcfm\_tracking\_data = $WCFMu->wcfmu\_shipment\_tracking->wcfm\_wcfmmarketplace\_order\_mark\_shipped(); |
| [802](#L802) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [803](#L803) | $order    = wc\_get\_order( $order\_id ); |
| [804](#L804) | $response = array('order\_id' => $order\_id); |
| [805](#L805) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [806](#L806) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [807](#L807) |  |
| [808](#L808) | return rest\_ensure\_response( $response ); |
| [809](#L809) | } elseif( !empty($request['delivery\_boy']) ) { |
| [810](#L810) | $WCFMd->init\_wcfmd(); |
| [811](#L811) | $wcfm\_tracking\_data = $WCFMd->ajax->wcfmd\_delivery\_boy\_assign(); |
| [812](#L812) | $order\_id = absint( $wcfm\_tracking\_data['wcfm\_tracking\_order\_id'] ); |
| [813](#L813) | $order    = wc\_get\_order( $order\_id ); |
| [814](#L814) | $response = array('order\_id' => $order\_id); |
| [815](#L815) | $response['order\_status'] = apply\_filters( 'wcfm\_current\_order\_status', $order->get\_status(), $order->get\_id() ); |
| [816](#L816) | $response['tracking\_data'] = $wcfm\_tracking\_data; |
| [817](#L817) | return rest\_ensure\_response( $response ); |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | public function update\_order\_status( $request ) { |
| [823](#L823) |  |
| [824](#L824) | global $WCFM; |
| [825](#L825) |  |
| [826](#L826) | $id             = isset( $request['id'] ) ? absint( $request['id'] ) : 0; |
| [827](#L827) | $status         = isset( $request['status'] ) ? $request['status'] : ''; |
| [828](#L828) |  |
| [829](#L829) | if(substr($status, 0, 2) !== 'wc-'){ |
| [830](#L830) | $status = 'wc-' . $status; |
| [831](#L831) | } |
| [832](#L832) | $order\_statuses = wc\_get\_order\_statuses(); |
| [833](#L833) |  |
| [834](#L834) | if ( empty( $id ) ) { |
| [835](#L835) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_id", \_\_( 'Invalid order ID', 'wcfm-marketplace-rest-api' ), array( |
| [836](#L836) | 'status' => 404, |
| [837](#L837) | ) ); |
| [838](#L838) | } |
| [839](#L839) |  |
| [840](#L840) | if ( empty( $status ) ) { |
| [841](#L841) | return new WP\_Error( "wcfmapi\_rest\_empty\_{$this->post\_type}\_status", \_\_( 'Order status must me required', 'wcfm-marketplace-rest-api' ), array( |
| [842](#L842) | 'status' => 404, |
| [843](#L843) | ) ); |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | if ( ! in\_array( $status, array\_keys( $order\_statuses ) ) ) { |
| [847](#L847) | return new WP\_Error( "wcfmapi\_rest\_invalid\_{$this->post\_type}\_status", \_\_( 'Order status not valid', 'wcfm-marketplace-rest-api' ), array( |
| [848](#L848) | 'status' => 404, |
| [849](#L849) | ) ); |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | // $order = $this->get\_object( $id ); |
| [853](#L853) | // $order->set\_status( $status ); |
| [854](#L854) | // $order =  apply\_filters( "wcfmapi\_rest\_pre\_insert\_{$this->post\_type}\_object", $order, $request ); |
| [855](#L855) | // $order->save(); |
| [856](#L856) | $\_POST['order\_id'] = $id; |
| [857](#L857) | $\_POST['order\_status'] = $status; |
| [858](#L858) | $\_REQUEST['wcfm\_ajax\_nonce'] = wp\_create\_nonce( 'wcfm\_ajax\_nonce' ); |
| [859](#L859) | define('WCFM\_REST\_API\_CALL', TRUE); |
| [860](#L860) | $WCFM->init(); |
| [861](#L861) | $order\_status\_change = $WCFM->ajax->wcfm\_modify\_order\_status(); |
| [862](#L862) | return $this->get\_post\_type\_item($request, $id); |
| [863](#L863) | } |
| [864](#L864) |  |
| [865](#L865) | /\*\* |
| [866](#L866) |  |
| [867](#L867) | \* Handle Order Note Add |
| [868](#L868) |  |
| [869](#L869) | \*/ |
| [870](#L870) |  |
| [871](#L871) | public function add\_order\_note( $request ) { |
| [872](#L872) |  |
| [873](#L873) | global $WCFM, $WCFMu, $woocommerce; |
| [874](#L874) |  |
| [875](#L875) |  |
| [876](#L876) | $user\_id   = apply\_filters( 'wcfm\_current\_vendor\_id', get\_current\_user\_id() ); |
| [877](#L877) |  |
| [878](#L878) | $user      = $user\_id; |
| [879](#L879) | $comment\_id = ''; |
| [880](#L880) |  |
| [881](#L881) |  |
| [882](#L882) | //parse\_str($\_POST['note\_data'], $wcfm\_note\_data); |
| [883](#L883) |  |
| [884](#L884) | $order\_id   = absint( $request['id'] ); |
| [885](#L885) | //$noteData = $request['noteData']; |
| [886](#L886) |  |
| [887](#L887) | $note       = apply\_filters( 'wcfm\_editor\_content\_before\_save', wp\_kses\_post( trim( stripslashes( $request['note'] ) ) ) ); |
| [888](#L888) |  |
| [889](#L889) | $note\_type  = $request['note\_type']; |
| [890](#L890) |  |
| [891](#L891) |  |
| [892](#L892) |  |
| [893](#L893) | $is\_customer\_note = $note\_type == 'customer' ? 1 : 0; |
| [894](#L894) |  |
| [895](#L895) | $note\_class = ''; |
| [896](#L896) |  |
| [897](#L897) | if($is\_customer\_note) $note\_class = 'customer-note'; |
| [898](#L898) |  |
| [899](#L899) |  |
| [900](#L900) |  |
| [901](#L901) | if ( $order\_id > 0 ) { |
| [902](#L902) |  |
| [903](#L903) | $order      = wc\_get\_order( $order\_id ); |
| [904](#L904) |  |
| [905](#L905) | if( apply\_filters( 'wcfm\_is\_allow\_order\_note\_attachments', true ) ) { |
| [906](#L906) |  |
| [907](#L907) | $attachments = $request['attachments']; |
| [908](#L908) |  |
| [909](#L909) | if( !empty( $attachments ) ) { |
| [910](#L910) |  |
| [911](#L911) | $attachment\_data = ''; |
| [912](#L912) |  |
| [913](#L913) | foreach( $attachments as $index => $attachment ) { |
| [914](#L914) |  |
| [915](#L915) | if( isset( $attachment['attachmentData'] ) && !empty( $attachment['attachmentData'] ) ) { |
| [916](#L916) |  |
| [917](#L917) | $name = !empty( $attachment['attachmentText'] ) ? $attachment['attachmentText'] : \_\_  ( 'Attachment', 'wc-frontend-manager-ultimate' ) . ' ' . $index; |
| [918](#L918) |  |
| [919](#L919) | if( $index != 0  ) $note .= ',&nbsp;'; |
| [920](#L920) |  |
| [921](#L921) | $attachment\_data .= '<a class="wcfm\_dashboard\_item\_title wcfm\_linked\_attached" target="\_blank" href="' . $attachment['attachmentData']['source\_url'] . '">' . $name . '</a>'; |
| [922](#L922) |  |
| [923](#L923) | } |
| [924](#L924) |  |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | if( !empty( $attachment\_data ) ) { |
| [928](#L928) |  |
| [929](#L929) | $note .= "<br />" . \_\_  ( 'Attachments', 'wc-frontend-manager-ultimate' ) . ': ' . $attachment\_data; |
| [930](#L930) |  |
| [931](#L931) | } |
| [932](#L932) |  |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | } |
| [936](#L936) |  |
| [937](#L937) |  |
| [938](#L938) |  |
| [939](#L939) | $note = apply\_filters( 'wcfm\_order\_note\_before\_save', $note, $request ); |
| [940](#L940) |  |
| [941](#L941) |  |
| [942](#L942) |  |
| [943](#L943) | // Vendor association |
| [944](#L944) |  |
| [945](#L945) | if( wcfm\_is\_vendor() ) { |
| [946](#L946) |  |
| [947](#L947) | if( apply\_filters( 'wcfmmp\_is\_allow\_sold\_by', true, $user\_id ) && $WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $user\_id, 'sold\_by' ) && apply\_filters( 'wcfm\_is\_allow\_order\_note\_vendor\_reference', true ) ) { |
| [948](#L948) |  |
| [949](#L949) | $note = sprintf( \_\_( '%s has added the following note', 'wc-frontend-manager-ultimate' ), wcfm\_get\_vendor\_store( $user\_id ) ) . ': ' . "<br />"  . $note; |
| [950](#L950) |  |
| [951](#L951) | } |
| [952](#L952) |  |
| [953](#L953) |  |
| [954](#L954) |  |
| [955](#L955) | add\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [956](#L956) |  |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) |  |
| [960](#L960) |  |
| [961](#L961) | $comment\_id = $order->add\_order\_note( $note, $is\_customer\_note, true ); |
| [962](#L962) |  |
| [963](#L963) |  |
| [964](#L964) |  |
| [965](#L965) | // Vendor association |
| [966](#L966) |  |
| [967](#L967) | if( wcfm\_is\_vendor() ) remove\_filter( 'woocommerce\_new\_order\_note\_data', array( $WCFMu->wcfmu\_marketplace, 'filter\_wcfm\_vendors\_comment' ), 10, 2 ); |
| [968](#L968) |  |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | $notes = $this->get\_order\_notes(array('id' => $request['id'])); |
| [972](#L972) | $response = rest\_ensure\_response($notes); |
| [973](#L973) | return $response; |
| [974](#L974) |  |
| [975](#L975) | } |
| [976](#L976) |  |
| [977](#L977) |  |
| [978](#L978) | public function get\_order\_notes( $request ) { |
| [979](#L979) |  |
| [980](#L980) | $args = array( |
| [981](#L981) |  |
| [982](#L982) | 'post\_id'   => $request['id'], |
| [983](#L983) |  |
| [984](#L984) | 'orderby'   => 'comment\_ID', |
| [985](#L985) |  |
| [986](#L986) | 'order'     => 'DESC', |
| [987](#L987) |  |
| [988](#L988) | 'approve'   => 'approve', |
| [989](#L989) |  |
| [990](#L990) | 'type'      => 'order\_note' |
| [991](#L991) |  |
| [992](#L992) | ); |
| [993](#L993) |  |
| [994](#L994) | $args = apply\_filters( 'wcfm\_order\_notes\_args', $args ); |
| [995](#L995) |  |
| [996](#L996) | //$notes = apply\_filters( 'wcfm\_order\_notes', get\_comments( $args ), $request['id'] ); |
| [997](#L997) |  |
| [998](#L998) | $notes = wc\_get\_order\_notes( $args ); |
| [999](#L999) |  |
| [1000](#L1000) | $response = rest\_ensure\_response($notes); |
| [1001](#L1001) |  |
| [1002](#L1002) | return $response; |
| [1003](#L1003) | } |
| [1004](#L1004) |  |
| [1005](#L1005) |  |
| [1006](#L1006) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php?format=txt)
* [Original Format](/export/3222433/wcfm-marketplace-rest-api/tags/1.5.3/includes/api/class-api-order-controller.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


