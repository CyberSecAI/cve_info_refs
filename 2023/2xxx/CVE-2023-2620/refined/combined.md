=== Content from gitlab.com_ee05618e_20250114_195401.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Maintainer can leak masked webhook secrets by manipulating URL masking

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #1976206](https://hackerone.com/reports/1976206)** by `theluci` on 2023-05-07, assigned to [@nmalcolm](/nmalcolm "Nick Malcolm"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hello,

I recently submitted a report #1915507 which was closed as duplicate of [#391685 (closed)](https://gitlab.com/gitlab-org/gitlab/-/issues/391685 "Maintainer can leak masked webhook secrets by adding a new parameter to the webhook URL to bypass the newly added validation logic").

The fix to [#391685 (closed)](https://gitlab.com/gitlab-org/gitlab/-/issues/391685 "Maintainer can leak masked webhook secrets by adding a new parameter to the webhook URL to bypass the newly added validation logic") can be bypassed.

#### Summary

There is an option to mask parts of a webhook URL to treat it as a secret value.

<https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#mask-sensitive-portions-of-webhook-urls>

When this feature is used any secret string in the configured URL will be masked in the UI and in any logs in the UI. The values work the same as other tokens in that they are not even accessible by the user configuring it after it is first configured. It should not be possible for the initial user or any other users to retrieve these values.

The docs states this about the secret

> Sensitive portions do not get logged and are encrypted at rest in the database.

However, there is a way to leak masked webhook secrets by bypassing the validation logic. (See **Vulnerability**)

#### Vulnerability

The fix changed [validation logic](https://gitlab.com/gitlab-org/gitlab/-/issues/402265#note_1330325232 "CVE-2022-4342 Bypassed - Maintainer can leak masked webhook secrets by changing target URL of the webhook") as following,

```
  def reset_url_variables
    interpolated_url_was = interpolated_url(decrypt_url_was, url_variables_were)

    return if url_variables_were.empty? || interpolated_url_was == interpolated_url

    self.url_variables = {} if url_changed? && url_variables_were.to_a.intersection(url_variables.to_a).any?
  end
```

**To bypass the validation logic**

1. `attacker` mask the **victim-url** such as `https://victim-url?token={TOKEN}` becomes `{masked-url}?token={TOKEN}` and clicks save.

This will not reset `url_variables` as `url_changed?` returns false.

2. `attacker` now changes the url such as `{masked-url}?token={TOKEN}` becomes `https://attacker-url?token={TOKEN}`
3. `attacker` masks the **attacker-url** with the same mask **{masked-url}**. So, that url finally becomes `{masked-url}?token={TOKEN}` and clicks save.

This will not reset `url_variables` as `interpolated_url_was == interpolated_url` condition is satisfied.

4. `attacker` can now click test to receive masked webhook secrets.

### Steps to reproduce

`victim` is the owner of a project `victim-project`

`attacker` is a maintainer in `victim-project`

As `victim`,

1. `victim` goes to his `victim-project` webhook settings, `https://gitlab.com/<victim-group>/<victim-project>/-/hooks`
2. `victim` configures a webhook with a secret token and mask the secret token. For example, Put the URL like this `https://example.com?token=secret-token`
3. Click to add a mask, add the value `secret-token` with the replacement TOKEN. Click save for the webhook

[![W1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/653dd047a6dd6ffa20641f9b08d54dabb86f5c5d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61646137346362332d616563362d343530622d393336612d3535643563613565363062322f57312e706e67)

As `attacker`

1. `attacker` goes to `victim-project` webhook settings, `https://gitlab.com/<victim-group>/<victim-project>/-/hooks`
2. Scroll to the bottom of the page to the list of configured hooks and edit the webhook.
3. `attacker` mask the victim-url as **{masked-url}**. Keep the token={TOKEN} part. Like this, `{masked-url}?token={TOKEN}` and **clicks save**

[![W2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/676592e459e96a67227c9a5f2b01110aa8d753d7/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f32353466653633362d653331612d343461652d393935302d3234636161646662656439392f57322e706e67)

4. `attacker` add the **attacker-url** (i used <https://webhook.site> to catch the request). Keep the token={TOKEN} part. Like this, `https://attacker-url?token={TOKEN}` and mask the **attacker-url** using the same mask, **{masked-url}** as shown below

[![W3.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6304996be2830226438da5544f06cd9dfdae7ae0/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62376337343166642d646435622d346666332d613330302d3837636238306330343238652f57332e706e67)

5. `attacker` click save
6. `attacker` click test
7. Request is sent to the attacker-url and containing the secret token.

[![W4.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/92c1dc3d52a8ba7eacdc80d26d6a2e7bfe155ac5/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f64313963356161612d663632362d343337312d613938362d6436653936306362306530622f57342e706e67)

### POC

[poc-webhook-2.mp4](https://user-content.gitlab-static.net/573afcdd253b90321fedc4a1f508d9957824779c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36303566363363372d376530632d346462342d616131322d3435353734666338626534342f706f632d776562686f6f6b2d322e6d7034 "Download 'poc-webhook-2.mp4'")

#### Impact

Maintainers can leak secret masked values that should not be accessible after configuration.

#### Output of checks

This bug happens on GitLab.com (Probably on instance too)

#### Impact

Maintainers can leak secret masked values that should not be accessible after configuration.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [W1.png](https://h1.sec.gitlab.net/a/ada74cb3-aec6-450b-936a-55d5ca5e60b2/W1.png)
* [W2.png](https://h1.sec.gitlab.net/a/254fe636-e31a-44ae-9950-24caadfbed99/W2.png)
* [W3.png](https://h1.sec.gitlab.net/a/b7c741fd-dd5b-4ff3-a300-87cb80c0428e/W3.png)
* [W4.png](https://h1.sec.gitlab.net/a/d19c5aaa-f626-4371-a986-d6e960cb0e0b/W4.png)
* [poc-webhook-2.mp4](https://h1.sec.gitlab.net/a/605f63c7-7e0c-4db4-aa12-45574fc8be44/poc-webhook-2.mp4)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


