=== Content from portswigger.net_3ab506cd_20250114_223847.html ===


[![The Daily Swig](/content/images/banners/the-daily-swig-logo.svg)](/daily-swig)

Latest threats

Bug bounty

For devs

Deep dives

More

[About](https://portswigger.net/daily-swig/about)
[Web security vulnerabilities](https://portswigger.net/daily-swig/vulnerabilities)
[Network security vulnerabilities](https://portswigger.net/daily-swig/network-security)
[Cloud security](https://portswigger.net/daily-swig/cloud-security)
[Zero-day news](https://portswigger.net/daily-swig/zero-day)
[Supply chain attacks](https://portswigger.net/daily-swig/supply-chain-attacks)

[View all web security news](https://portswigger.net/daily-swig/vulnerabilities)

[**Prototype pollution**

Prototype pollution project yields another Parse Server RCE

![Prototype-pollution](/daily-swig-mega-nav/images/latestthreats.png)](https://portswigger.net/daily-swig/prototype-pollution-project-yields-another-parse-server-rce)

[Bug bounty news](https://portswigger.net/daily-swig/bug-bounty)
[VDPs](https://portswigger.net/daily-swig/vdp)
[Bug Bounty Radar](https://portswigger.net/daily-swig/bug-bounty-radar)

[View all bug bounty news](https://portswigger.net/daily-swig/bug-bounty)

[**Bug Bounty Radar**

The latest programs for February 2023

![Bug bounties](/daily-swig-mega-nav/images/bug-bounties.png)](https://portswigger.net/daily-swig/bug-bounty-radar-the-latest-bug-bounty-programs-for-february-2023)

[DevSecOps](https://portswigger.net/daily-swig/devsecops)
[Security best practices](https://portswigger.net/daily-swig/security-best-practices)
[Dev stack tech](https://portswigger.net/daily-swig/dev-stack-tech)

[View all dev related news](https://portswigger.net/daily-swig/devsecops)

[**All Day DevOps**

AppSec engineer keynote says Log4j revealed lessons were not learned from the Equifax breach

![DevOps](/daily-swig-mega-nav/images/devsecops.png)](https://portswigger.net/daily-swig/all-day-devops-third-of-log4j-downloads-still-pull-vulnerable-version-despite-threat-of-supply-chain-attacks)

[Deep dives](https://portswigger.net/daily-swig/deep-dives)
[Interviews](https://portswigger.net/daily-swig/interviews)

[View all of the latest features](https://portswigger.net/daily-swig/deep-dives)

[**Infosec beginner?**

A rough guide to launching a career in cybersecurity

![cyber-career](/daily-swig-mega-nav/images/deepdives.png)](https://portswigger.net/daily-swig/a-rough-guide-to-launching-a-career-in-cybersecurity)

[Industry news](https://portswigger.net/daily-swig/industry-news)
[Enterprise security news](https://portswigger.net/daily-swig/enterprise)
[Web hacking tools](https://portswigger.net/daily-swig/hacking-tools)
[Events](https://portswigger.net/daily-swig/events)

[View all infosec industry news](https://portswigger.net/daily-swig/industry-news)

[**Cybersecurity conferences**

A schedule of events in 2022 and beyond

![More topics](/daily-swig-mega-nav/images/more-topics.jpg)](https://portswigger.net/daily-swig/cybersecurity-conferences-a-rundown-of-online-in-person-and-hybrid-events)

# Blind TCP/IP hijacking is resurrected for Windows 7

[Adam Bannister](/daily-swig/by/adam-bannister)
28 January 2021 at 11:39 UTC

Updated: 29 January 2021 at 11:58 UTC

[Microsoft](/daily-swig/microsoft)
[Cyber-attacks](/daily-swig/cyber-attacks)
[Vulnerabilities](/daily-swig/vulnerabilities)

[Twitter](https://twitter.com/share?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7&text=Blind+TCP%2fIP+hijacking+is+resurrected+for+Windows+7+%7c+The+Daily+Swig%0A)
[WhatsApp](https://api.whatsapp.com/send?text=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[Facebook](https://www.facebook.com/sharer.php?u=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[Reddit](https://reddit.com/submit?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[LinkedIn](https://www.linkedin.com/sharing/share-offsite?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
Email

Retro cyber-attack returns to haunt widely used, end-of-life operating system

![Blind TCP/IP hijacking is resurrected for Windows 7](/cms/images/b2/50/8039-article-210126-windows-7-body-text.jpg "Image: tomeqs / Shutterstock")

UPDATED Windows 7 is still susceptible to blind TCP/IP hijacking [attacks](https://portswigger.net/daily-swig/cyber-attacks) via a vulnerability that a security researcher says he reported to Microsoft eight years ago.

[Adam Zabrocki](https://twitter.com/Adam_pi3) (AKA ‘pi3’) has recounted in a [blog post](http://blog.pi3.com.pl/?p=850) how in 2008 he fashioned a proof-of-concept of this venerable attack technique with Windows XP the target.

Later, in 2012, he warned Microsoft that all subsequent versions up to Windows 7 – the latest version at that time – contained the same TCP/IP stack flaw that made the attack viable.

Although [Microsoft](https://portswigger.net/daily-swig/microsoft) deemed the bug “very difficult” to exploit and therefore only fixed it in Windows 8, Zabrocki says that he was able to rework the attack for use against Windows 7 – noting that doing so was even easier than setting up an up-to-date version of the operating system (OS).

Launched in 2009, Windows 7 reached its end of life a year ago, meaning that users no longer receive security patches.

[Read more of the latest Microsoft security news](https://portswigger.net/daily-swig/microsoft)

However, roughly [one in four PCs](https://netmarketshare.com/operating-system-market-share.aspx?options=%7B%22filter%22%3A%7B%22%24and%22%3A%5B%7B%22deviceType%22%3A%7B%22%24in%22%3A%5B%22Desktop%2Flaptop%22%5D%7D%7D%5D%7D%2C%22dateLabel%22%3A%22Custom%22%2C%22attributes%22%3A%22share%22%2C%22group%22%3A%22platformVersion%22%2C%22sort%22%3A%7B%22share%22%3A-1%7D%2C%22id%22%3A%22platformsDesktopVersions%22%2C%22dateInterval%22%3A%22Monthly%22%2C%22dateStart%22%3A%222019-12%22%2C%22dateEnd%22%3A%222020-12%22%2C%22plotKeys%22%3A%5B%7B%22platformVersion%22%3A%22Windows%207%22%7D%5D%2C%22segments%22%3A%22-1000%22%7D) are believed to still be running the aging OS, leaving them potentially vulnerable to a form of cyber-attack that was famously deployed against a [Japanese security researcher](https://www.wired.com/1996/02/catching/) back in 1994.

### Encryption mitigation

“At minimum, this bug allows the attacker to use any Windows 7 machine as a ‘zombie host’ to execute an ‘[idle scan](https://seclists.org/bugtraq/1998/Dec/79)’” – which is a “sophisticated TCP port scanning technique because there is no interaction between the attacker computer and the target”, and the “attacker is invisible to the target”, Zabrocki, a former Microsoft security engineer, tells The Daily Swig.

“At most, attackers can fully hijack any established TCP connection.”

Fortunately, most modern protocols implement [encryption](https://portswigger.net/daily-swig/encryption) that limits the attacker’s options unless they can “correctly generate encrypted messages” – an “unlikely” scenario, says Zabrocki.

Nevertheless, there remain “widely deployed protocols which do not encrypt the traffic, e.g, FTP, SMTP, HTTP, DNS, IMAP, and more” that would permit an attacker to “send any commands on behalf of the original client”.

Critical protocols such as TELNET that are used in many [IoT](https://portswigger.net/daily-swig/iot) devices could enable “the most critical scenario”, adds the researcher, with hijacked sessions potentially having a “catastrophic impact”.

However, a Microsoft spokesperson told The Daily Swig: “The technique described relies on a set of specific conditions that make it very difficult to execute in a real-world scenario. We do not plan to address this with a security update. We recommend customers use Windows 10 for the best protection.”

YOU MIGHT ALSO LIKE [Pwnable Document Format: Windows PDF viewers outperformed by browser, macOS, Linux counterparts](https://portswigger.net/daily-swig/pwnable-document-format-windows-pdf-viewers-outperformed-by-browser-macos-linux-counterparts)

### Trial and error

Zabrocki’s exploit modified an attack technique [documented by another researcher](http://phrack.org/issues/64/13.html) in 2007 that was effective against FreeBSD 4 and Windows 2K/XP because both OS’ used IP\_ID as a global counter that increments, predictably, with each sent IP packet.

This also applies to Windows 7, many printers, “older Linux/FreeBSD/Mac OS hosts and probably more”, Zabrocki says.

By contrast, Windows 8 onwards and most other modern OS’ implement IP\_ID as a ‘local’ counter per session, each of which has an independent IP\_ID base.

### Brute forcing the ACK

Zabrocki sent packets with an IP header to the victim’s client in order to ascertain how many packets were sent between each probe. This created a “covert channel” through which he could discover the client IP and port, and sequence numbers for both client and server.

Unlike his XP exploit, Zabrocki’s Windows 7 tool doesn’t need to send two spoofed TCP packets with different ACK values to validate the server SND.NEXT, and ascertained the client’s SND.NEXT by brute-forcing the ACK with spoofed packets containing the correct SQN and various ACK permutations.

“We don’t need to verify every possible value of ACK, we can still use the same trick with TCP window size,” he says.

This article was updated on January 29 with a statement from Microsoft

YOU MAY ALSO LIKE [Critical zero-day RCE in Microsoft Office 365 awaits third security patch](https://portswigger.net/daily-swig/critical-zero-day-rce-in-microsoft-office-365-awaits-third-security-patch)

[Microsoft](/daily-swig/microsoft)
[Cyber-attacks](/daily-swig/cyber-attacks)
[Vulnerabilities](/daily-swig/vulnerabilities)
[IoT](/daily-swig/iot)
[Encryption](/daily-swig/encryption)
[Hacking Techniques](/daily-swig/hacking-techniques)
[Secure Development](/daily-swig/secure-development)
[Organizations](/daily-swig/organizations)
[US](/daily-swig/us)
[Research](/daily-swig/research)

![Adam Bannister](/cms/profiles/adam-bannister.png)
[Twitter](https://twitter.com/share?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7&text=Blind+TCP%2fIP+hijacking+is+resurrected+for+Windows+7+%7c+The+Daily+Swig%0A)
[WhatsApp](https://api.whatsapp.com/send?text=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[Facebook](https://www.facebook.com/sharer.php?u=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[Reddit](https://reddit.com/submit?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
[LinkedIn](https://www.linkedin.com/sharing/share-offsite?url=https%3a%2f%2fportswigger.net%2fdaily-swig%2fblind-tcp-ip-hijacking-is-resurrected-for-windows-7)
Email

This page requires JavaScript for an enhanced user experience.

Latest Posts
[### We’re going teetotal – It’s goodbye to The Daily Swig

02 March 2023
We’re going teetotal – It’s goodbye to The Daily Swig
PortSwigger today announces that The Daily Swig is closing down](/daily-swig/were-going-teetotal-its-goodbye-to-the-daily-swig)
[### Bug Bounty Radar

The latest bug bounty programs for March 2023
28 February 2023
Bug Bounty Radar
The latest bug bounty programs for March 2023](/daily-swig/bug-bounty-radar-the-latest-bug-bounty-programs-for-march-2023)
[### Indian gov flaws allowed creation of counterfeit driving licenses

28 February 2023
Indian gov flaws allowed creation of counterfeit driving licenses
Armed with personal data fragments, a researcher could also access 185 million citizens’ PII](/daily-swig/indian-transport-ministry-flaws-potentially-allowed-creation-of-counterfeit-driving-licenses)

Burp Suite

[Web vulnerability scanner](/burp/vulnerability-scanner)
[Burp Suite Editions](/burp)
[Release Notes](/burp/releases)

Vulnerabilities

[Cross-site scripting (XSS)](/web-security/cross-site-scripting)
[SQL injection](/web-security/sql-injection)
[Cross-site request forgery](/web-security/csrf)
[XML external entity injection](/web-security/xxe)
[Directory traversal](/web-security/file-path-traversal)
[Server-side request forgery](/web-security/ssrf)

Customers

[Organizations](/organizations)
[Testers](/testers)
[Developers](/developers)

Company

[About](/about)
[Careers](/careers)
[Contact](/about/contact)
[Legal](/legal)
[Privacy Notice](/privacy)

Insights

[Web Security Academy](/web-security)
[Blog](/blog)
[Research](/research)

[![PortSwigger Logo](/content/images/logos/portswigger-logo.svg)](/)
 [Follow us](https://twitter.com/Burp_Suite)

© 2025 PortSwigger Ltd.



=== Content from blog.pi3.com.pl_aa6383e8_20250114_223846.html ===


# pi3 blog

bug bugs bughunt exploit exploiting research vulnerabilities

* [Home](http://blog.pi3.com.pl/ "A link to home page")
* [About](http://blog.pi3.com.pl/?page_id=2)

“He who fights with monsters should be careful lest he thereby become a
monster. And if thou gaze long into an abyss, the abyss will also gaze into thee.”

~Friedrich Nietzsche

* Subscribe

  [![rss](http://blog.pi3.com.pl/wp-content/themes/gods-and-monsters/images/rss.png)](http://blog.pi3.com.pl/?feed=rss2)

Search

* ## Categories

  + [Bughunt](http://blog.pi3.com.pl/?cat=4) (28)
  + [Exploiting](http://blog.pi3.com.pl/?cat=5) (36)
  + [Ideas](http://blog.pi3.com.pl/?cat=6) (28)
  + [LKRG](http://blog.pi3.com.pl/?cat=7) (10)
  + [Meeting](http://blog.pi3.com.pl/?cat=3) (6)
  + [O wszystkim i o niczym](http://blog.pi3.com.pl/?cat=1) (34)
* ## Recent Posts

  + [RISC-V: Vice Chair of the J-extension Task Group](http://blog.pi3.com.pl/?p=1008)
  + [CVE-2023-34367](http://blog.pi3.com.pl/?p=1003)
  + [Bug bounties are broken – the story of “i915” bug, ChromeOS + Intel bounty programs, and beyond](http://blog.pi3.com.pl/?p=931)
  + [My talks @ BlackHat 2021 and DefCon29](http://blog.pi3.com.pl/?p=894)
  + [LKRG 0.9.0 has been released!](http://blog.pi3.com.pl/?p=890)
* ## Archives

  + [November 2023](http://blog.pi3.com.pl/?m=202311)
  + [June 2023](http://blog.pi3.com.pl/?m=202306)
  + [May 2023](http://blog.pi3.com.pl/?m=202305)
  + [July 2021](http://blog.pi3.com.pl/?m=202107)
  + [April 2021](http://blog.pi3.com.pl/?m=202104)
  + [January 2021](http://blog.pi3.com.pl/?m=202101)
  + [December 2020](http://blog.pi3.com.pl/?m=202012)
  + [October 2020](http://blog.pi3.com.pl/?m=202010)
  + [September 2020](http://blog.pi3.com.pl/?m=202009)
  + [June 2020](http://blog.pi3.com.pl/?m=202006)
  + [May 2020](http://blog.pi3.com.pl/?m=202005)
  + [March 2020](http://blog.pi3.com.pl/?m=202003)
  + [October 2019](http://blog.pi3.com.pl/?m=201910)
  + [July 2019](http://blog.pi3.com.pl/?m=201907)
  + [May 2019](http://blog.pi3.com.pl/?m=201905)
  + [April 2019](http://blog.pi3.com.pl/?m=201904)
  + [February 2019](http://blog.pi3.com.pl/?m=201902)
  + [August 2018](http://blog.pi3.com.pl/?m=201808)
  + [July 2018](http://blog.pi3.com.pl/?m=201807)
  + [March 2018](http://blog.pi3.com.pl/?m=201803)
  + [February 2018](http://blog.pi3.com.pl/?m=201802)
  + [January 2018](http://blog.pi3.com.pl/?m=201801)
  + [April 2017](http://blog.pi3.com.pl/?m=201704)
  + [September 2016](http://blog.pi3.com.pl/?m=201609)
  + [July 2015](http://blog.pi3.com.pl/?m=201507)
  + [February 2015](http://blog.pi3.com.pl/?m=201502)
  + [March 2014](http://blog.pi3.com.pl/?m=201403)
  + [August 2013](http://blog.pi3.com.pl/?m=201308)
  + [July 2013](http://blog.pi3.com.pl/?m=201307)
  + [May 2013](http://blog.pi3.com.pl/?m=201305)
  + [April 2013](http://blog.pi3.com.pl/?m=201304)
  + [March 2013](http://blog.pi3.com.pl/?m=201303)
  + [February 2013](http://blog.pi3.com.pl/?m=201302)
  + [October 2012](http://blog.pi3.com.pl/?m=201210)
  + [May 2012](http://blog.pi3.com.pl/?m=201205)
  + [April 2012](http://blog.pi3.com.pl/?m=201204)
  + [December 2011](http://blog.pi3.com.pl/?m=201112)
  + [September 2011](http://blog.pi3.com.pl/?m=201109)
  + [August 2011](http://blog.pi3.com.pl/?m=201108)
  + [July 2011](http://blog.pi3.com.pl/?m=201107)
  + [March 2011](http://blog.pi3.com.pl/?m=201103)
  + [November 2010](http://blog.pi3.com.pl/?m=201011)
  + [October 2010](http://blog.pi3.com.pl/?m=201010)
  + [July 2010](http://blog.pi3.com.pl/?m=201007)
  + [May 2010](http://blog.pi3.com.pl/?m=201005)
  + [March 2010](http://blog.pi3.com.pl/?m=201003)
  + [February 2010](http://blog.pi3.com.pl/?m=201002)
  + [January 2010](http://blog.pi3.com.pl/?m=201001)
  + [December 2009](http://blog.pi3.com.pl/?m=200912)
  + [November 2009](http://blog.pi3.com.pl/?m=200911)
  + [October 2009](http://blog.pi3.com.pl/?m=200910)
  + [September 2009](http://blog.pi3.com.pl/?m=200909)
* ## Friends

  + [Bothunters – Borys Łącki](http://bothunters.pl)
  + [Gynvael Coldwind](http://gynvael.coldwind.pl)
  + [Icewall](http://www.icewall.pl)
  + [j00ru](http://j00ru.vexillium.org)
  + [Piotr Bania](http://piotrbania.com/)
* ## Pages

  + [About](http://blog.pi3.com.pl/?page_id=2)

24

Jan

# [Windows 7 TCP/IP hijacking](http://blog.pi3.com.pl/?p=850)

by pi3

Blind TCP/IP hijacking is still alive on Windows 7… and not only. This version of Windows is certainly one of the “juiciest” targets even though January 14th 2020 was the official EOL (End Of Life) for it. Based on various data Windows 7 holds [around 25% share of the Operating Systems (OS) market](https://netmarketshare.com/operating-system-market-share.aspx?options=%7B%22filter%22%3A%7B%22%24and%22%3A%5B%7B%22deviceType%22%3A%7B%22%24in%22%3A%5B%22Desktop%2Flaptop%22%5D%7D%7D%5D%7D%2C%22dateLabel%22%3A%22Trend%22%2C%22attributes%22%3A%22share%22%2C%22group%22%3A%22platformVersion%22%2C%22sort%22%3A%7B%22share%22%3A-1%7D%2C%22id%22%3A%22platformsDesktopVersions%22%2C%22dateInterval%22%3A%22Monthly%22%2C%22dateStart%22%3A%222019-11%22%2C%22dateEnd%22%3A%222020-10%22%2C%22segments%22%3A%22-1000%22%2C%22plotKeys%22%3A%5B%7B%22platformVersion%22%3A%22Windows%207%22%7D%5D%7D) and is still [the world’s second most popular desktop operating system](https://www.windowslatest.com/2020/12/31/users-still-run-windows-7-one-year-after-microsoft-ended-support/).

### A little bit of history

It was a few months before I joined Microsoft as a Security Software Engineer in 2012 when I sent them a report with an interesting bug/vulnerability in all versions of Microsoft Windows including Windows 7 (the latest version at that time). It was an issue in the implementation of TCP/IP stack allowing attackers to carry out a blind TCP/IP hijacking attack. During my discussion with MSRC (Microsoft Security Response Center) they acknowledged the bug exists, but they had their doubts about the impact of the issue claiming “it is very difficult and very unreliable” to exploit. Therefore, they were not going to address it in the current OSes. However, they would fix it in the upcoming OS which was going to be released soon (Windows 8).

I didn’t agree with MSRC’s evaluation. In 2008 I developed a fully working PoC which would automatically find all the necessary primitives (client’s port, SQN and ACK) to perform blind TCP/IP hijacking attack. This tool was exploiting exactly the same weaknesses in TCP/IP stack which I’ve reported. That being said, Microsoft informed me that if I share my tool (I didn’t want to do it), they would reconsider their decision. However, for now, no CVE would be allocated, and this problem was supposed to be addresses in Windows 8.

In the next months I started my work as FTE (Full Time Employee) for Microsoft, and I verified that this problem was fixed in Windows 8.  Over the course of years, I completely forgot about it. Nevertheless, when I left Microsoft, I was doing some cleanups on my old laptop and found my old tool. I copied it from the laptop and decided to re-visit it once I will have a bit more time. I found some time and thought that my tool deserves a release and a proper description.

### What is TCP/IP hijacking?

Most likely majority of the readers are aware what this is. For those who don’t, I encourage you to read many great articles about it which you can find on the internet these days.

It might be worth to mention that probably the most famous blind TCP/IP hijacking attack was done by Kevin Mitnick against the computers of Tsutomu Shimomura at the San Diego Supercomputer Center on Christmas Day, 1994.

This is a VERY old-school technique which nobody expects to be alive in 2021… Yet, it’s still possible to perform TCP/IP session hijacking today without attacking the PRNG responsible for generating the initials TCP sequence numbers (ISN).

### What is the impact of TCP/IP hijacking nowadays?

(Un)fortunately it is not as catastrophic as it used to be. The main reason is that majority of the modern protocols do implement encryption. Sure, it’s overwhelmingly bad if attacker can hijack any TCP/IP session which is established. However, if the upper-layer protocols properly implement encryption, attackers are limited in terms of what they can do with it. Unless they have ability to correctly generate encrypted messages.

That being said, we still have widely deployed protocols which do not encrypt the traffic, e.g., FTP, SMTP, HTTP, DNS, IMAP, and more. Thankfully, protocols like Telnet or Rlogin (hopefully?) can be seen only in the museum.

### Where is the bug?

**TL;DR**: In the implementation of TCP/IP stack for Windows 7, IP\_ID is a global counter.

#### **Details:**

The tool which I developed in 2008 was implementing a known attack described by ‘lkm’ (there is a typo and real nickname of the author is ‘klm’) in Phrack 64 magazine and can be read here:

<http://phrack.org/issues/64/13.html>

This is an amazing article (research) and I encourage everyone to carefully study all the details.

Back in 2007 (and 2008) this attack could be executed successfully on many modern OS (modern at that time) including Windows 2K/XP or FreeBSD 4. I gave a live presentation of this attack against Windows XP on a local conference in Poland (SysDay 2009).

Before we move to the details on how to perform described attack, it is useful to refresh how TCP handles the communication in more details. Quoting phrack paper:

> Each of the two hosts involved in the connection computes a 32bits SEQ number randomly at the establishment of the connection. This initial SEQ number is called the ISN. Then, each time an host sends some packet with N bytes of data, it adds N to the SEQ number.
>
> The sender put his current SEQ in the SEQ field of each outgoing TCP packet. The ACK field is filled with the next *expected* SEQ number from the other host. Each host will maintain his own next sequence number (called SND.NEXT), and next expected SEQ number from the other host (called RCV.NEXT.
> (…)
> TCP implements a flow control mechanism by defining the concept of “window”. Each host has a TCP window size (which is dynamic, specific to each TCP connection, and announced in TCP packets), that we will call RCV.WND.
> At any given time, a host will accept bytes with sequence number between RCV.NXT and (RCV.NXT+RCV.WND-1). This mechanism ensures that at any time, there can be no more than RCV.WND bytes “in transit” to the host.

In short, in order to execute TCP/IP hijacking attack, we must know:

* Client IP
* Server IP (usually known)
* Client port
* Server port (usually known)
* Sequence number of the client
* Sequence number of the server

#### **OK, but what it has to do with IP ID?**

In 1998(!), Salvatore Sanfilippo (aka antirez) posted in the Bugtraq mailing list a description of a new port scanning technique which is known today as an “Idle scan”. Original post can be found here:

[https://seclists](https://seclists.org/bugtraq/1998/Dec/79)[.org/bugtraq/1998/Dec/79](https://seclists.org/bugtraq/1998/Dec/79)

and more information about Idle scan you can read here:

<https://nmap.org/book/idlescan.html>

In short, if IP\_ID is implemented as a global counter (which is the case e.g., in Windows 7), it is simply incremented with each sent IP packet. By “probing” the IP\_ID of the victim we know how many packets have been sent between each “probe”. Such “probing” can be performed by sending any packet to the victim which results in a reply to the attacker. ‘lkm’ suggests using an ICMP packet, but it can be any packet with IP header:

```
[===================================================================]
attacker                                  Host
                --[PING]->
        <-[PING REPLY, IP_ID=1000]--

          ... wait a little ...

                --[PING]->
        <-[PING REPLY, IP_ID=1010]--

<attacker> Uh oh, the Host sent 9 IP packets between my pings.
[===================================================================]
```

This essentially creates some form of “covert channel” which can be exploited by remote attacker to “discover” all the necessary information to execute TCP/IP Hijacking attack. How? Let’s quote the original phrack article:

#### **Discovering client’s port**

> Assuming we already know the client/server IP, and the server port, there’s a well known method to test if a given port is the correct client port. In order to do this, we can send a TCP packet with the SYN flag set to server-IP:server-port, from client-IP:guessed-client-port (we need to be able to send spoofed IP packets for this technique to work).

When attacker guessed the valid client’s port, server replies to the real client (not attacker) with ACK. If port was incorrect, server replies to the real client with SYN+ACK. A real client didn’t start a new connection so it replies to the server with RST.

> So, all we have to do to test if a guessed client-port is the correct one
> is:
>
> – Send a PING to the client, note the IP ID
> – Send our spoofed SYN packet
> – Resend a PING to the client, note the new IP ID
> – Compare the two IP IDs to determine if the guessed port was correct.

#### **Finding the server’s SND.NEXT**

This is the essential part, and the best what I can do is to quote (again) phrack article:

> Whenever a host receive a TCP packet with the good source/destination ports, but an incorrect seq and/or ack, it sends back a simple ACK with the correct SEQ/ACK numbers. Before we investigate this matter, let’s define exactly what is a correct seq/ack combination, as defined by the RFC793 [2]:
>
> A correct SEQ is a SEQ which is between the RCV.NEXT and (RCV.NEXT+RCV.WND-1) of the host receiving the packet. Typically, the RCV.WND is a fairly large number (several dozens of kilobytes at last).
>
> A correct ACK is an ACK which corresponds to a sequence number of something the host receiving the ACK has already sent. That is, the ACK field of the packet received by an host must be lower or equal than the host’s own current SND.SEQ, otherwise the ACK is invalid (you can’t acknowledge data that were never sent!).
>
> It is important to node that the sequence number space is “circular”. For exemple, the condition used by the receiving host to check the ACK validity is not simply the unsigned comparison “ACK <= receiver’s SND.NEXT”, but the signed comparison “(ACK – receiver’s SND.NEXT) <= 0”.
>
> Now, let’s return to our original problem: we want to guess server’s SND.NEXT. We know that if we send a wrong SEQ or ACK to the client from the server, the client will send back an ACK, while if we guess right, the client will send nothing. As for the client-port detection, this may be tested with the IP ID.
>
> If we look at the ACK checking formula, we note that if we pick randomly two ACK values, let’s call them ack1 and ack2, such as |ack1-ack2| = 2^31, then exactly one of them will be valid. For example, let ack1=0 and ack2=2^31. If the real ACK is between 1 and 2^31 then the ack2 will be an acceptable ack. If the real ACK is 0, or is between (2^32 – 1) and (2^31 + 1), then, the ack1 will be acceptable.
>
> Taking this into consideration, we can more easily scan the sequence number space to find the server’s SND.NEXT. Each guess will involve the sending of two packets, each with its SEQ field set to the guessed server’s SND.NEXT. The first packet (resp. second packet) will have his ACK field set to ack1 (resp. ack2), so that we are sure that if the guessed’s SND.NEXT is correct, at least one of the two packet will be accepted.
>
> The sequence number space is way bigger than the client-port space, but two facts make this scan easier:
>
> First, when the client receive our packet, it replies immediately. There’s not a problem with latency between client and server like in the client-port scan. Thus, the time between the two IP ID probes can be very small, speeding up our scanning and reducing greatly the odds that the client will have IP traffic between our probes and mess with our detection.
>
> Secondly, it’s not necessary to test all the possible sequence numbers, because of the receiver’s window. In fact, we need only to do approx. (2^32 / client’s RCV.WND) guesses at worst (this fact has already been mentionned in [6]). Of course, we don’t know the client’s RCV.WND.
> We can take a wild guess of RCV.WND=64K, perform the scan (trying each SEQ multiple of 64K). Then, if we didn’t find anything, wen can try all SEQs such as seq = 32K + i*64K for all i. Then, all SEQ such as seq=16k + i*32k, and so on… narrowing the window, while avoiding to re-test already tried SEQs. On a typical “modern” connection, this scan usually takes less than 15 minutes with our tool.
>
> With the server’s SND.NEXT known, and a method to work around our ignorance of the ACK, we may hijack the connection in the way “server -> client”. This is not bad, but not terribly useful, we’d prefer to be able to send data from the client to the server, to make the client execute a command, etc… In order to do this, we need to find the client’s SND.NEXT.

And here is a small, weird difference in Windows 7. Described scenario perfectly works for Windows XP but I’ve encountered a different behavior in Windows 7. Having two edge cases as ACK value to fulfill ACK formula doesn’t really change anything and I have exactly the same results (just in Windows 7) just by always using one of the edge values for ACK. Originally, I thought that my implementation of attack is not working against Windows 7. However, after some tests and tuning it turns out that’s not the case. I’m not sure why or what I’m missing but, in the end, you can send less packages (twice less) and speed-up the overall attack.

#### **Finding the client’s SND.NEXT**

Quote:

> What we can do to find the client’s SND.NEXT ? Obviously we can’t use the same method as for the server’s SND.NEXT, because the server’s OS is probably not vunerable to this attack, and besides, the heavy network traffic on the server would render the IP ID analysis infeasible.
>
> However, we know the server’s SND.NEXT. We also know that the client’s SND.NEXT is used for checking the ACK fields of client’s incoming packets.
> So we can send packets from the server to the client with SEQ field set to server’s SND.NEXT, pick an ACK, and determine (again with IP ID) if our ACK was acceptable.
>
> If we detect that our ACK was acceptable, that means that (guessed\_ACK – SND.NEXT) <= 0. Otherwise, it means.. well, you guessed it, that (guessed\_ACK – SND\_NEXT) > 0.
>
> Using this knowledge, we can find the exact SND\_NEXT in at most 32 tries by doing a binary search (a slightly modified one, because the sequence space is circular).
>
> Now, at last we have all the required informations and we can perform the session hijacking from either client or server.

(Un)fortunately, here Windows 7 is different as well. This is connected to the differences in the previous stage of how it handles correctness of ACK. Regardless of the `guessed_ACK` value (`(guessed_ACK - SND.NEXT) <= 0` or `(guessed_ACK - SND_NEXT) > 0`) Windows 7 won’t send any package back to the server. Essentially, we are blind here and we can’t do the same amazingly effective ‘binary search’ to find the correct ACK. However, we are not completely lost here. We can always brute force ACK if we have the correct SQN. Again, we don’t need to verify every possible value of ACK, we can still use the same trick with TCP window size. Nevertheless, to be more effective and not miss the correct ACK brackets, I’ve chosen to use window size value as 0x3FF. Essentially, we are flooding the server with the spoofed packets containing our payload for injection, with the correct SQN and guessed ACK. This operation takes around 5 minutes and is effective 🙂 Nevertheless, if for any reason our payload is not injected, a smaller TCP window size (e.g., 0xFF) should be chosen.

#### **Important notes**

1. This type of attack is not limited to any specific OS, but rather leverages “covert channel” generated by implementing IP\_ID as a global counter. In short, any OS which is vulnerable to the “Idle scan” is also vulnerable to the old-school blind TCP/IP Hijacking attack.
2. We need to be able to send spoofed IP packets to execute this attack.
   * Our attack relies on “scanning” and constant “poking” of IP\_ID:
   * Any latency between victim and the server affects such logic.
   * If victim’s machine is overloaded (heavy or slow traffic) it obviously affects the attack. Taking appropriate measures of the victim’s networking performance might be necessary for correct tuning of the attack.

#### **Proof-of-Concept**

Originally, I implemented lkm’s attack in 2008 and I tested it against Windows XP. When I ran compiled binary on the modern system, everything was working fine. However, when I took the original sources and wanted to recompile it on the modern Linux environment, my tool stopped working(!). New binary was not able to find client’s port neither SQN. However, old binary still worked perfectly fine. It was a riddle for me what was really happening. Output of strace tool gave me some clues:

Generated packet from the old binary:

> `sendmsg(4, {msg_name={sa_family=AF_INET, sin_port=htons(21), sin_addr=inet_addr("192.168.1.169")}, msg_namelen=16, msg_iov=[{iov_base="E\0\0(\0\0\0\0@\6\0\0\300\250\1\356\300\250\1\251\277\314\0\25\0\0\0224\0\0VxP\2\26\320\353\234\0\0", iov_len=40}], msg_iovlen=1, msg_control=[{cmsg_len=24, cmsg_level=SOL_IP, cmsg_type=IP_PKTINFO, cmsg_data={ipi_ifindex=0, ipi_spec_dst=inet_addr("0.0.0.0"), ipi_addr=inet_addr("0.0.0.0")}}], msg_controllen=24, msg_flags=0}, 0) = 40`

Generated packet from the new binary:

> `sendmsg(4, {msg_name={sa_family=AF_INET, sin_port=htons(21), sin_addr=inet_addr("192.168.1.169")}, msg_namelen=16, msg_iov=[{iov_base="E\0\0(\0\0\0\0@\6\0\0\300\250\1\356\300\250\1\251\277\314\0\25\0\0\0224\0\0VxP\2\26\320\2563\0\0", iov_len=40}], msg_iovlen=1, msg_control=[{cmsg_len=28, cmsg_level=SOL_IP, cmsg_type=IP_PKTINFO, cmsg_data={ipi_ifindex=0, ipi_spec_dst=inet_addr("0.0.0.0"), ipi_addr=inet_addr("0.0.0.0")}}], msg_controllen=32, msg_flags=0}, 0) = 40`

`cmsg_len` and `msg_controllen` has different values. However, I didn’t modify the source code so how is it possible? Some GCC/Glibc changes broke the functionality of sending the spoofed package. I’ve found the answer here:

<https://sourceware.org/pipermail/libc-alpha/2016-May/071274.html>

I needed to rewrite spoofing function to make it functional again on the modern Linux environment. However, to do that I needed to use different API. I wonder how many non-offensive tools were broken by this change 🙂

### Windows 7

I’ve tested this tool against fully updated Windows 7. Surprisingly, rewriting PoC was not the most difficult task… setting up a fully updated Windows 7 is much more problematic. Many updates break update channel/service(!) itself and you need to manually fix it. Usually, it means manual downloading of the specific KB and installing it in “safe mode”. Then it can “unlock” update service and you can continue your work. In the end it took me around 2-3 days to get fully updated Windows 7 and it looks like this:

[![](http://blog.pi3.com.pl/wp-content/uploads/2021/01/image-1024x576.png)](http://blog.pi3.com.pl/wp-content/uploads/2021/01/image.png)

`192.168.1.132` – attacker’s IP address
`192.168.1.238` – victim’s Windows 7 machine IP address
`192.168.1.169` – FTP server running on Linux. I’ve tested ProFTPd and vsFTP servers running under git TOT kernel (5.11+)

[![](http://blog.pi3.com.pl/wp-content/uploads/2021/01/image-1-1024x363.png)](http://blog.pi3.com.pl/wp-content/uploads/2021/01/image-1.png)

This tool does not do appropriate “tuning” per victim which could significantly speed-up the attack. However, in my specific case, the full attack which means finding client’s port address, finding server’s SQN and finding client’s SQN took about 45 minutes.

I found old logs from attacking Windows XP (~2009) and the entire attack took almost an hour:

> pi3-darkstar z\_new # time ./test -r 192.168.254.20 -s 192.168.254.46 -l 192.168.254.31 -p 21 -P 5357 -c 49450 -C “PWD”
>
> …::: -=[ [d]evil\_pi3 TCP/IP Blind Spoofer by Adam ‘pi3’ Zabrocki ]=- :::…
>
> [+] Trying to find client port
>         [+] Found port => 49456!
>         [+] Veryfing… OK! 🙂
>
>         [+] Second level of verifcation
>         [+] Found port => 49456!
>         [+] Veryfing… OK! 🙂
>
> [!!] Port is found (49456)! Let’s go further…
>
> [+] Trying to find server’s window SQN
>        [+] Found server’s window SQN => 1874825280, with ACK => 758086748 with seq\_offset => 65535
>         [+] Rechecking…
>        [+] Found server’s window SQN => 1874825280, with ACK => 758086748 with seq\_offset => 65535
>
> [!!] SQN => 1874825280, with seq\_offset => 65535
>
> [+] Trying to find server’s real SQN
>         [+] Found server’s real SQN => 1874825279 => seq\_offset 32767
>         [+] Found server’s real SQN => 1874825277 => seq\_offset 16383
>         [+] Found server’s real SQN => 1874825275 => seq\_offset 8191
>         [+] Found server’s real SQN => 1874825273 => seq\_offset 4095
>         [+] Found server’s real SQN => 1874823224 => seq\_offset 2047
>         [+] Found server’s real SQN => 1874822199 => seq\_offset 1023
>         [+] Found server’s real SQN => 1874821686 => seq\_offset 511
>         [+] Found server’s real SQN => 1874821684 => seq\_offset 255
>         [+] Found server’s real SQN => 1874821555 => seq\_offset 127
>         [+] Found server’s real SQN => 1874821553 => seq\_offset 63
>         [+] Found server’s real SQN => 1874821520 => seq\_offset 31
>         [+] Found server’s real SQN => 1874821518 => seq\_offset 15
>         [+] Found server’s real SQN => 1874821509 => seq\_offset 7
>         [+] Found server’s real SQN => 1874821507 => seq\_offset 3
>         [+] Found server’s real SQN => 1874821505 => seq\_offset 1
>         [+] Found server’s real SQN => 1874821505 => seq\_offset 1
>         [+] Rechecking…
>         [+] Found server’s real SQN => 1874821505 => seq\_offset 1
>         [+] Found server’s real SQN => 1874821505 => seq\_offset 1
>
> [!!] Real server’s SQN => 1874821505
>
> [+] Finish! check whether command was injected (should be :))
>
> [!] Next SQN [1874822706]
>
> real    56m38.321s
> user    0m8.955s
> sys     0m29.181s
> pi3-darkstar z\_new #

#### **Some more notes:**

* Sometimes you can see that tool is spinning around the same value when trying to find “server’s real SQN”. If next to the number in the parentheses you see number 1, kill the attack, copy calculated SQN (the one around which value tool was spinning) and paste it as an SQN start parameter (-M). It should fix that edge case.
* Sometimes you can encounter the problem that scanning by 64KB window size can ‘overjump’ the appropriate SQN brackets. You might want to reduce the window size to be smaller. However, tools should change the window size automatically if it finishes scanning the full SQN range with current window size and didn’t find the correct value. Nevertheless, it takes time. You might want to start scanning with the smaller window size (but that implies longer attack).
* By default, tool sends ICMP message to the victim’s machine to read IP\_ID. However, I’ve implemented functionality that it can read that field from any IP packet. It sends standard SYN packet and waits for reply to extract IP\_ID. Please give an appropriate TCP port to appropriate parameter (-P)

**Tool can be found here:**

<http://site.pi3.com.pl/exp/devil_pi3.c>

#### **Closing words**

Modern operating systems (like Windows 10) usually implement IP\_ID as a “local” counter per session. If you monitor IP\_ID in specific session, you can see it is just incremented per each sent packet. However, each session has independent IP\_ID base.

Happy hacking,
Adam

Filed Under [Bughunt](http://blog.pi3.com.pl/?cat=4), [Exploiting](http://blog.pi3.com.pl/?cat=5), [Ideas](http://blog.pi3.com.pl/?cat=6)

Comments

1. [CVE-2023-34367 : pi3 blog](http://blog.pi3.com.pl/?p=1003) on
   06.16.2023

   […] Windows 7 TCP/IP hijacking […]

Leave a Reply

Name (Required)

Email Address (Required)

Website

Δ

CAPTCHA \*
Time limit is exhausted. Please reload the CAPTCHA.
5
 +
7
 =

Copyright © 2025 [pi3 blog](http://blog.pi3.com.pl).

[Gods & Monsters](http://www.arsgrafik.com/) Theme | Powered by [WordPress](http://wordpress.org/)



=== Content from pwnies.com_31b0721e_20250114_223848.html ===

[Skip to content](#primary)

[![Pwnies](https://pwnies.com/wp-content/themes/pwnies/assets/images/header_graphic.jpg)](https://pwnies.com/)

recognize both excellence and incompetence in the field of information security

Primary Menu

* [news](https://pwnies.com/)
* [About](https://pwnies.com/about/)
* [noms](https://pwnies.com/nominations/)
* [winners](https://pwnies.com/winners/)
* [previous](https://pwnies.com/previous/)
* [team](https://pwnies.com/the-pwnies-team/)

# The 2021 Pwnie Nominee For Most Under-Hyped Research

## Windows 7 blind TCP/IP Hijacking

**Researcher Names:** Adam ‘pi3’ Zabrocki

**Link:** <http://blog.pi3.com.pl/?p=850>

Windows 7 is vulnerable to a full blind TCP/IP hijacking attack. The same type of attack was done by Kevin Mitnick against the computers of Tsutomu Shimomura at the San Diego Supercomputer Center on Christmas Day, 1994.

The vulnerability exists in Windows 7 (any Windows until Windows 8) and in any implementation of TCP/IP, which is vulnerable to the Idle scan attack (including many IoT devices).

The original bug was reported back in 2012. MSRC acknowledged that the bug exists but claimed that “it is very difficult and very unreliable” to exploit. Therefore, they were not going to address it in the current OSes (at that time). However, they would fix it in the upcoming OS, which was going to be released soon (Windows 8). 9 years later, in 2021, there’s still no patch, and the complete exploit/tool was released. Microsoft acknowledged the bug again but released the statement recommending Windows 10 for anyone who wants protection against the attack.

## calendar

Apr 19
Nominations open
Jul 19
Nominees announced, Summercon 2024, Brooklyn, NY
Aug 10
Awards Ceremony, 10:00am, DEF CON 32, Las Vegas Convention Center, Las Vegas, NV
## awards ceremony

Date
August 10
Time
10:00am PDT
Where
DEF CON 32, Las Vegas Convention Center, Las Vegas, NV
## follow us

* [twitter](https://twitter.com/PwnieAwards/)
* [atom feed](/feed/atom)
## Archives

* [Nominations and Winners Archive](https://pwnies.com/archive/)

Copyright © 2007-2025 Pwnie Awards LLC. Designed by [ikonoklasm](http://ikonoklasm.com/%20).


