=== Content from cdn.kernel.org_c21ccd77_20250115_112334.html ===
commit 170014a900a54d2c44ba6aacd3acda1733018c69
Author: Greg Kroah-Hartman
Date: Wed May 17 14:02:08 2023 +0200
Linux 6.3.3
Link: https://lore.kernel.org/r/20230515161722.610123835@linuxfoundation.org
Tested-by: Chris Paterson (CIP)
Tested-by: Shuah Khan
Tested-by: Ron Economos
Tested-by: Bagas Sanjaya
Tested-by: Sudip Mukherjee
Tested-by: Linux Kernel Functional Testing
Tested-by: Ronald Warsow
Tested-by: Justin M. Forbes
Tested-by: Conor Dooley
Tested-by: Rudi Heitbaum
Tested-by: Markus Reichelt
Tested-by: Guenter Roeck
Tested-by: Jon Hunter
Signed-off-by: Greg Kroah-Hartman
commit 8b0554b2c298443ee58adc8133619a2e235d1edd
Author: Aurabindo Pillai
Date: Fri Mar 24 10:42:37 2023 -0400
drm/amd/display: Fix hang when skipping modeset
commit da5e14909776edea4462672fb4a3007802d262e7 upstream.
[Why&How]
When skipping full modeset since the only state change was a front porch
change, the DC commit sequence requires extra checks to handle non
existant plane states being asked to be removed from context.
Reviewed-by: Alvin Lee
Acked-by: Qingqing Zhuo
Signed-off-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit f995f951eb3d3e4998899626eee5b2153d90adbf
Author: Heiko Carstens
Date: Tue May 9 16:31:17 2023 +0200
s390/mm: fix direct map accounting
[ Upstream commit 81e8479649853ffafc714aca4a9c0262efd3160a ]
Commit bb1520d581a3 ("s390/mm: start kernel with DAT enabled") did not
implement direct map accounting in the early page table setup code. In
result the reported values are bogus now:
$cat /proc/meminfo
...
DirectMap4k: 5120 kB
DirectMap1M: 18446744073709546496 kB
DirectMap2G: 0 kB
Fix this by adding the missing accounting. The result looks sane again:
$cat /proc/meminfo
...
DirectMap4k: 6156 kB
DirectMap1M: 2091008 kB
DirectMap2G: 6291456 kB
Fixes: bb1520d581a3 ("s390/mm: start kernel with DAT enabled")
Reviewed-by: Alexander Gordeev
Signed-off-by: Heiko Carstens
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit 4ad0867b2dbca2415ce5619363e11d38aa67ca41
Author: Heiko Carstens
Date: Tue May 9 16:31:14 2023 +0200
s390/mm: rename POPULATE\_ONE2ONE to POPULATE\_DIRECT
[ Upstream commit 07fdd6627f7f9c72ed68d531653b56df81da9996 ]
Architectures generally use the "direct map" wording for mapping the whole
physical memory. Use that wording as well in arch/s390/boot/vmem.c, instead
of "one to one" in order to avoid confusion.
This also matches what is already done in arch/s390/mm/vmem.c.
Reviewed-by: Alexander Gordeev
Signed-off-by: Heiko Carstens
Signed-off-by: Vasily Gorbik
Signed-off-by: Greg Kroah-Hartman
commit 36a6d0f66c874666caf4e8be155b1be30f6231be
Author: Christophe Leroy
Date: Sat Apr 1 19:59:48 2023 +0200
spi: fsl-cpm: Use 16 bit mode for large transfers with even size
commit fc96ec826bced75cc6b9c07a4ac44bbf651337ab upstream.
On CPM, the RISC core is a lot more efficiant when doing transfers
in 16-bits chunks than in 8-bits chunks, but unfortunately the
words need to be byte swapped as seen in a previous commit.
So, for large tranfers with an even size, allocate a temporary tx
buffer and byte-swap data before and after transfer.
This change allows setting higher speed for transfer. For instance
on an MPC 8xx (CPM1 comms RISC processor), the documentation tells
that transfer in byte mode at 1 kbit/s uses 0.200% of CPM load
at 25 MHz while a word transfer at the same speed uses 0.032%
of CPM load. This means the speed can be 6 times higher in
word mode for the same CPM load.
For the time being, only do it on CPM1 as there must be a
trade-off between the CPM load reduction and the CPU load required
to byte swap the data.
Signed-off-by: Christophe Leroy
Link: https://lore.kernel.org/r/f2e981f20f92dd28983c3949702a09248c23845c.1680371809.git.christophe.leroy@csgroup.eu
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit 421f0bacd77222af296f6d0d4407b18e6dd3b086
Author: Christophe Leroy
Date: Sat Apr 1 19:59:47 2023 +0200
spi: fsl-spi: Re-organise transfer bits\_per\_word adaptation
commit 8a5299a1278eadf1e08a598a5345c376206f171e upstream.
For different reasons, fsl-spi driver performs bits\_per\_word
modifications for different reasons:
- On CPU mode, to minimise amount of interrupts
- On CPM/QE mode to work around controller byte order
For CPU mode that's done in fsl\_spi\_prepare\_message() while
for CPM mode that's done in fsl\_spi\_setup\_transfer().
Reunify all of it in fsl\_spi\_prepare\_message(), and catch
impossible cases early through master's bits\_per\_word\_mask
instead of returning EINVAL later.
Signed-off-by: Christophe Leroy
Link: https://lore.kernel.org/r/0ce96fe96e8b07cba0613e4097cfd94d09b8919a.1680371809.git.christophe.leroy@csgroup.eu
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit b805d212c394f291f116b12c53401e7ba0c4d408
Author: Linus Torvalds
Date: Sun May 14 15:46:19 2023 -0700
x86: fix clear\_user\_rep\_good() exception handling annotation
This code no longer exists in mainline, because it was removed in
commit d2c95f9d6802 ("x86: don't use REP\_GOOD or ERMS for user memory
clearing") upstream.
However, rather than backport the full range of x86 memory clearing and
copying cleanups, fix the exception table annotation placement for the
final 'rep movsb' in clear\_user\_rep\_good(): rather than pointing at the
actual instruction that did the user space access, it pointed to the
register move just before it.
That made sense from a code flow standpoint, but not from an actual
usage standpoint: it means that if user access takes an exception, the
exception handler won't actually find the instruction in the exception
tables.
As a result, rather than fixing it up and returning -EFAULT, it would
then turn it into a kernel oops report instead, something like:
BUG: unable to handle page fault for address: 0000000020081000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0002) - not-present page
...
RIP: 0010:clear\_user\_rep\_good+0x1c/0x30 arch/x86/lib/clear\_page\_64.S:147
...
Call Trace:
\_\_clear\_user arch/x86/include/asm/uaccess\_64.h:103 [inline]
clear\_user arch/x86/include/asm/uaccess\_64.h:124 [inline]
iov\_iter\_zero+0x709/0x1290 lib/iov\_iter.c:800
iomap\_dio\_hole\_iter fs/iomap/direct-io.c:389 [inline]
iomap\_dio\_iter fs/iomap/direct-io.c:440 [inline]
\_\_iomap\_dio\_rw+0xe3d/0x1cd0 fs/iomap/direct-io.c:601
iomap\_dio\_rw+0x40/0xa0 fs/iomap/direct-io.c:689
ext4\_dio\_read\_iter fs/ext4/file.c:94 [inline]
ext4\_file\_read\_iter+0x4be/0x690 fs/ext4/file.c:145
call\_read\_iter include/linux/fs.h:2183 [inline]
do\_iter\_readv\_writev+0x2e0/0x3b0 fs/read\_write.c:733
do\_iter\_read+0x2f2/0x750 fs/read\_write.c:796
vfs\_readv+0xe5/0x150 fs/read\_write.c:916
do\_preadv+0x1b6/0x270 fs/read\_write.c:1008
\_\_do\_sys\_preadv2 fs/read\_write.c:1070 [inline]
\_\_se\_sys\_preadv2 fs/read\_write.c:1061 [inline]
\_\_x64\_sys\_preadv2+0xef/0x150 fs/read\_write.c:1061
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x39/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
which then looks like a filesystem bug rather than the incorrect
exception annotation that it is.
[ The alternative to this one-liner fix is to take the upstream series
that cleans this all up:
68674f94ffc9 ("x86: don't use REP\_GOOD or ERMS for small memory copies")
20f3337d350c ("x86: don't use REP\_GOOD or ERMS for small memory clearing")
adfcf4231b8c ("x86: don't use REP\_GOOD or ERMS for user memory copies")
\* d2c95f9d6802 ("x86: don't use REP\_GOOD or ERMS for user memory clearing")
3639a535587d ("x86: move stac/clac from user copy routines into callers")
577e6a7fd50d ("x86: inline the 'rep movs' in user copies for the FSRM case")
8c9b6a88b7e2 ("x86: improve on the non-rep 'clear\_user' function")
427fda2c8a49 ("x86: improve on the non-rep 'copy\_user' function")
\* e046fe5a36a9 ("x86: set FSRS automatically on AMD CPUs that have FSRM")
e1f2750edc4a ("x86: remove 'zerorest' argument from \_\_copy\_user\_nocache()")
034ff37d3407 ("x86: rewrite '\_\_copy\_user\_nocache' function")
with either the whole series or at a minimum the two marked commits
being needed to fix this issue ]
Reported-by: syzbot
Link: https://syzkaller.appspot.com/bug?extid=401145a9a237779feb26
Fixes: 0db7058e8e23 ("x86/clear\_user: Make it faster")
Cc: Borislav Petkov
Cc: stable@kernel.org
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 7e29e780b167a3c7a6378ad44ea53f03018bff45
Author: Mario Limonciello
Date: Thu Apr 27 00:33:36 2023 -0500
x86/amd\_nb: Add PCI ID for family 19h model 78h
commit 23a5b8bb022c1e071ca91b1a9c10f0ad6a0966e9 upstream.
Commit
310e782a99c7 ("platform/x86/amd: pmc: Utilize SMN index 0 for driver probe")
switched to using amd\_smn\_read() which relies upon the misc PCI ID used
by DF function 3 being included in a table. The ID for model 78h is
missing in that table, so amd\_smn\_read() doesn't work.
Add the missing ID into amd\_nb, restoring s2idle on this system.
[ bp: Simplify commit message. ]
Fixes: 310e782a99c7 ("platform/x86/amd: pmc: Utilize SMN index 0 for driver probe")
Signed-off-by: Mario Limonciello
Signed-off-by: Borislav Petkov (AMD)
Acked-by: Bjorn Helgaas  # pci\_ids.h
Acked-by: Guenter Roeck
Link: https://lore.kernel.org/r/20230427053338.16653-2-mario.limonciello@amd.com
Signed-off-by: Greg Kroah-Hartman
commit b2fab1807d26acd1c6115b95b5eddd697d84751b
Author: Theodore Ts'o
Date: Sun Apr 30 03:04:13 2023 -0400
ext4: fix invalid free tracking in ext4\_xattr\_move\_to\_block()
commit b87c7cdf2bed4928b899e1ce91ef0d147017ba45 upstream.
In ext4\_xattr\_move\_to\_block(), the value of the extended attribute
which we need to move to an external block may be allocated by
kvmalloc() if the value is stored in an external inode. So at the end
of the function the code tried to check if this was the case by
testing entry->e\_value\_inum.
However, at this point, the pointer to the xattr entry is no longer
valid, because it was removed from the original location where it had
been stored. So we could end up calling kvfree() on a pointer which
was not allocated by kvmalloc(); or we could also potentially leak
memory by not freeing the buffer when it should be freed. Fix this by
storing whether it should be freed in a separate variable.
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230430160426.581366-1-tytso@mit.edu
Link: https://syzkaller.appspot.com/bug?id=5c2aee8256e30b55ccf57312c16d88417adbd5e1
Link: https://syzkaller.appspot.com/bug?id=41a6b5d4917c0412eb3b3c3c604965bed7d7420b
Reported-by: syzbot+64b645917ce07d89bde5@syzkaller.appspotmail.com
Reported-by: syzbot+0d042627c4f2ad332195@syzkaller.appspotmail.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 53c14e7cc2257191ba15425c15638fc4f8abb92b
Author: Theodore Ts'o
Date: Sat Apr 29 16:14:46 2023 -0400
ext4: remove a BUG\_ON in ext4\_mb\_release\_group\_pa()
commit 463808f237cf73e98a1a45ff7460c2406a150a0b upstream.
If a malicious fuzzer overwrites the ext4 superblock while it is
mounted such that the s\_first\_data\_block is set to a very large
number, the calculation of the block group can underflow, and trigger
a BUG\_ON check. Change this to be an ext4\_warning so that we don't
crash the kernel.
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230430154311.579720-3-tytso@mit.edu
Reported-by: syzbot+e2efa3efc15a1c9e95c3@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=69b28112e098b070f639efb356393af3ffec4220
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 01346b25c5a863687a82f66dea6cba392eca869b
Author: Jan Kara
Date: Tue Apr 11 14:10:19 2023 +0200
ext4: fix lockdep warning when enabling MMP
commit 949f95ff39bf188e594e7ecd8e29b82eb108f5bf upstream.
When we enable MMP in ext4\_multi\_mount\_protect() during mount or
remount, we end up calling sb\_start\_write() from write\_mmp\_block(). This
triggers lockdep warning because freeze protection ranks above s\_umount
semaphore we are holding during mount / remount. The problem is harmless
because we are guaranteed the filesystem is not frozen during mount /
remount but still let's fix the warning by not grabbing freeze
protection from ext4\_multi\_mount\_protect().
Cc: stable@kernel.org
Reported-by: syzbot+6b7df7d5506b32467149@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=ab7e5b6f400b7778d46f01841422e5718fb81843
Signed-off-by: Jan Kara
Reviewed-by: Christian Brauner
Link: https://lore.kernel.org/r/20230411121019.21940-1-jack@suse.cz
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 7564c1498e995f80e43ecc9cd0bdb76a70303813
Author: Theodore Ts'o
Date: Fri May 12 15:16:27 2023 -0400
ext4: bail out of ext4\_xattr\_ibody\_get() fails for any reason
commit 2a534e1d0d1591e951f9ece2fb460b2ff92edabd upstream.
In ext4\_update\_inline\_data(), if ext4\_xattr\_ibody\_get() fails for any
reason, it's best if we just fail as opposed to stumbling on,
especially if the failure is EFSCORRUPTED.
Cc: stable@kernel.org
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 88a06a94942c5c0a896e9da1113a6bb29e36cbef
Author: Theodore Ts'o
Date: Fri May 12 15:11:02 2023 -0400
ext4: add bounds checking in get\_max\_inline\_xattr\_value\_size()
commit 2220eaf90992c11d888fe771055d4de330385f01 upstream.
Normally the extended attributes in the inode body would have been
checked when the inode is first opened, but if someone is writing to
the block device while the file system is mounted, it's possible for
the inode table to get corrupted. Add bounds checking to avoid
reading beyond the end of allocated memory if this happens.
Reported-by: syzbot+1966db24521e5f6e23f7@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?extid=1966db24521e5f6e23f7
Cc: stable@kernel.org
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 804de0c72cd473e186ca4e1f6287d45431b14e5a
Author: Theodore Ts'o
Date: Sat May 6 21:04:01 2023 -0400
ext4: fix deadlock when converting an inline directory in nojournal mode
commit f4ce24f54d9cca4f09a395f3eecce20d6bec4663 upstream.
In no journal mode, ext4\_finish\_convert\_inline\_dir() can self-deadlock
by calling ext4\_handle\_dirty\_dirblock() when it already has taken the
directory lock. There is a similar self-deadlock in
ext4\_incvert\_inline\_data\_nolock() for data files which we'll fix at
the same time.
A simple reproducer demonstrating the problem:
mke2fs -Fq -t ext2 -O inline\_data -b 4k /dev/vdc 64
mount -t ext4 -o dirsync /dev/vdc /vdc
cd /vdc
mkdir file0
cd file0
touch file0
touch file1
attr -s BurnSpaceInEA -V abcde .
touch supercalifragilisticexpialidocious
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230507021608.1290720-1-tytso@mit.edu
Reported-by: syzbot+91dccab7c64e2850a4e5@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=ba84cc80a9491d65416bc7877e1650c87530fe8a
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit c1fae027da61fe8e7eb99f7244297e81bc0f1e43
Author: Theodore Ts'o
Date: Sat May 6 11:59:13 2023 -0400
ext4: improve error handling from ext4\_dirhash()
commit 4b3cb1d108bfc2aebb0d7c8a52261a53cf7f5786 upstream.
The ext4\_dirhash() will \*almost\* never fail, especially when the hash
tree feature was first introduced. However, with the addition of
support of encrypted, casefolded file names, that function can most
certainly fail today.
So make sure the callers of ext4\_dirhash() properly check for
failures, and reflect the errors back up to their callers.
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230506142419.984260-1-tytso@mit.edu
Reported-by: syzbot+394aa8a792cb99dbc837@syzkaller.appspotmail.com
Reported-by: syzbot+344aaa8697ebd232bfc8@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=db56459ea4ac4a676ae4b4678f633e55da005a9b
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 536ecbd569cb99b2e8a4422c43926590c7893aef
Author: Theodore Ts'o
Date: Fri May 5 22:20:29 2023 -0400
ext4: improve error recovery code paths in \_\_ext4\_remount()
commit 4c0b4818b1f636bc96359f7817a2d8bab6370162 upstream.
If there are failures while changing the mount options in
\_\_ext4\_remount(), we need to restore the old mount options.
This commit fixes two problem. The first is there is a chance that we
will free the old quota file names before a potential failure leading
to a use-after-free. The second problem addressed in this commit is
if there is a failed read/write to read-only transition, if the quota
has already been suspended, we need to renable quota handling.
Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20230506142419.984260-2-tytso@mit.edu
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 118e484989b9f1fb5e2b0c6bf57cb5b28b99add5
Author: Baokun Li
Date: Fri May 5 21:24:29 2023 +0800
ext4: check iomap type only if ext4\_iomap\_begin() does not fail
commit fa83c34e3e56b3c672af38059e066242655271b1 upstream.
When ext4\_iomap\_overwrite\_begin() calls ext4\_iomap\_begin() map blocks may
fail for some reason (e.g. memory allocation failure, bare disk write), and
later because "iomap->type ! = IOMAP\_MAPPED" triggers WARN\_ON(). When ext4
iomap\_begin() returns an error, it is normal that the type of iomap->type
may not match the expectation. Therefore, we only determine if iomap->type
is as expected when ext4\_iomap\_begin() is executed successfully.
Cc: stable@kernel.org
Reported-by: syzbot+08106c4b7d60702dbc14@syzkaller.appspotmail.com
Link: https://lore.kernel.org/all/00000000000015760b05f9b4eee9@google.com
Signed-off-by: Baokun Li
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230505132429.714648-1-libaokun1@huawei.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 4b4340bf04ce9a52061f15000ecedd126abc093c
Author: Jan Kara
Date: Thu May 4 14:47:23 2023 +0200
ext4: avoid deadlock in fs reclaim with page writeback
commit 00d873c17e29cc32d90ca852b82685f1673acaa5 upstream.
Ext4 has a filesystem wide lock protecting ext4\_writepages() calls to
avoid races with switching of journalled data flag or inode format. This
lock can however cause a deadlock like:
CPU0 CPU1
ext4\_writepages()
percpu\_down\_read(sbi->s\_writepages\_rwsem);
ext4\_change\_inode\_journal\_flag()
percpu\_down\_write(sbi->s\_writepages\_rwsem);
- blocks, all readers block from now on
ext4\_do\_writepages()
ext4\_init\_io\_end()
kmem\_cache\_zalloc(io\_end\_cachep, GFP\_KERNEL)
fs\_reclaim frees dentry...
dentry\_unlink\_inode()
iput() - last ref =>
iput\_final() - inode dirty =>
write\_inode\_now()...
ext4\_writepages() tries to acquire sbi->s\_writepages\_rwsem
and blocks forever
Make sure we cannot recurse into filesystem reclaim from writeback code
to avoid the deadlock.
Reported-by: syzbot+6898da502aef574c5f8a@syzkaller.appspotmail.com
Link: https://lore.kernel.org/all/0000000000004c66b405fa108e27@google.com
Fixes: c8585c6fcaf2 ("ext4: fix races between changing inode journal mode and ext4\_writepages")
CC: stable@vger.kernel.org
Signed-off-by: Jan Kara
Link: https://lore.kernel.org/r/20230504124723.20205-1-jack@suse.cz
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 0bec6fd4b826ecdfc54e203e9de47710238dce80
Author: Jan Kara
Date: Thu May 4 14:55:24 2023 +0200
ext4: fix data races when using cached status extents
commit 492888df0c7b42fc0843631168b0021bc4caee84 upstream.
When using cached extent stored in extent status tree in tree->cache\_es
another process holding ei->i\_es\_lock for reading can be racing with us
setting new value of tree->cache\_es. If the compiler would decide to
refetch tree->cache\_es at an unfortunate moment, it could result in a
bogus in\_range() check. Fix the possible race by using READ\_ONCE() when
using tree->cache\_es only under ei->i\_es\_lock for reading.
Cc: stable@kernel.org
Reported-by: syzbot+4a03518df1e31b537066@syzkaller.appspotmail.com
Link: https://lore.kernel.org/all/000000000000d3b33905fa0fd4a6@google.com
Suggested-by: Dmitry Vyukov
Signed-off-by: Jan Kara
Link: https://lore.kernel.org/r/20230504125524.10802-1-jack@suse.cz
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit be7b6374a2ee8a59c1ff5addcbe25ebc1b4efd9f
Author: Tudor Ambarus
Date: Thu May 4 12:15:25 2023 +0000
ext4: avoid a potential slab-out-of-bounds in ext4\_group\_desc\_csum
commit 4f04351888a83e595571de672e0a4a8b74f4fb31 upstream.
When modifying the block device while it is mounted by the filesystem,
syzbot reported the following:
BUG: KASAN: slab-out-of-bounds in crc16+0x206/0x280 lib/crc16.c:58
Read of size 1 at addr ffff888075f5c0a8 by task syz-executor.2/15586
CPU: 1 PID: 15586 Comm: syz-executor.2 Not tainted 6.2.0-rc5-syzkaller-00205-gc96618275234 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/12/2023
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x1b1/0x290 lib/dump\_stack.c:106
print\_address\_description+0x74/0x340 mm/kasan/report.c:306
print\_report+0x107/0x1f0 mm/kasan/report.c:417
kasan\_report+0xcd/0x100 mm/kasan/report.c:517
crc16+0x206/0x280 lib/crc16.c:58
ext4\_group\_desc\_csum+0x81b/0xb20 fs/ext4/super.c:3187
ext4\_group\_desc\_csum\_set+0x195/0x230 fs/ext4/super.c:3210
ext4\_mb\_clear\_bb fs/ext4/mballoc.c:6027 [inline]
ext4\_free\_blocks+0x191a/0x2810 fs/ext4/mballoc.c:6173
ext4\_remove\_blocks fs/ext4/extents.c:2527 [inline]
ext4\_ext\_rm\_leaf fs/ext4/extents.c:2710 [inline]
ext4\_ext\_remove\_space+0x24ef/0x46a0 fs/ext4/extents.c:2958
ext4\_ext\_truncate+0x177/0x220 fs/ext4/extents.c:4416
ext4\_truncate+0xa6a/0xea0 fs/ext4/inode.c:4342
ext4\_setattr+0x10c8/0x1930 fs/ext4/inode.c:5622
notify\_change+0xe50/0x1100 fs/attr.c:482
do\_truncate+0x200/0x2f0 fs/open.c:65
handle\_truncate fs/namei.c:3216 [inline]
do\_open fs/namei.c:3561 [inline]
path\_openat+0x272b/0x2dd0 fs/namei.c:3714
do\_filp\_open+0x264/0x4f0 fs/namei.c:3741
do\_sys\_openat2+0x124/0x4e0 fs/open.c:1310
do\_sys\_open fs/open.c:1326 [inline]
\_\_do\_sys\_creat fs/open.c:1402 [inline]
\_\_se\_sys\_creat fs/open.c:1396 [inline]
\_\_x64\_sys\_creat+0x11f/0x160 fs/open.c:1396
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3d/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f72f8a8c0c9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 f1 19 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f72f97e3168 EFLAGS: 00000246 ORIG\_RAX: 0000000000000055
RAX: ffffffffffffffda RBX: 00007f72f8bac050 RCX: 00007f72f8a8c0c9
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000020000280
RBP: 00007f72f8ae7ae9 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007ffd165348bf R14: 00007f72f97e3300 R15: 0000000000022000
Replace
le16\_to\_cpu(sbi->s\_es->s\_desc\_size)
with
sbi->s\_desc\_size
It reduces ext4's compiled text size, and makes the code more efficient
(we remove an extra indirect reference and a potential byte
swap on big endian systems), and there is no downside. It also avoids the
potential KASAN / syzkaller failure, as a bonus.
Reported-by: syzbot+fc51227e7100c9294894@syzkaller.appspotmail.com
Reported-by: syzbot+8785e41224a3afd04321@syzkaller.appspotmail.com
Link: https://syzkaller.appspot.com/bug?id=70d28d11ab14bd7938f3e088365252aa923cff42
Link: https://syzkaller.appspot.com/bug?id=b85721b38583ecc6b5e72ff524c67302abbc30f3
Link: https://lore.kernel.org/all/000000000000ece18705f3b20934@google.com/
Fixes: 717d50e4971b ("Ext4: Uninitialized Block Groups")
Cc: stable@vger.kernel.org
Signed-off-by: Tudor Ambarus
Link: https://lore.kernel.org/r/20230504121525.3275886-1-tudor.ambarus@linaro.org
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit dd45e536f47a82e0a405f9a4b6c7ceb367171ee9
Author: Ye Bin
Date: Mon Jan 16 10:00:15 2023 +0800
ext4: fix WARNING in mb\_find\_extent
commit fa08a7b61dff8a4df11ff1e84abfc214b487caf7 upstream.
Syzbot found the following issue:
EXT4-fs: Warning: mounting with data=journal disables delayed allocation, dioread\_nolock, O\_DIRECT and fast\_commit support!
EXT4-fs (loop0): orphan cleanup on readonly fs
------------[ cut here ]------------
WARNING: CPU: 1 PID: 5067 at fs/ext4/mballoc.c:1869 mb\_find\_extent+0x8a1/0xe30
Modules linked in:
CPU: 1 PID: 5067 Comm: syz-executor307 Not tainted 6.2.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 10/26/2022
RIP: 0010:mb\_find\_extent+0x8a1/0xe30 fs/ext4/mballoc.c:1869
RSP: 0018:ffffc90003c9e098 EFLAGS: 00010293
RAX: ffffffff82405731 RBX: 0000000000000041 RCX: ffff8880783457c0
RDX: 0000000000000000 RSI: 0000000000000041 RDI: 0000000000000040
RBP: 0000000000000040 R08: ffffffff82405723 R09: ffffed10053c9402
R10: ffffed10053c9402 R11: 1ffff110053c9401 R12: 0000000000000000
R13: ffffc90003c9e538 R14: dffffc0000000000 R15: ffffc90003c9e2cc
FS: 0000555556665300(0000) GS:ffff8880b9900000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000056312f6796f8 CR3: 0000000022437000 CR4: 00000000003506e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
ext4\_mb\_complex\_scan\_group+0x353/0x1100 fs/ext4/mballoc.c:2307
ext4\_mb\_regular\_allocator+0x1533/0x3860 fs/ext4/mballoc.c:2735
ext4\_mb\_new\_blocks+0xddf/0x3db0 fs/ext4/mballoc.c:5605
ext4\_ext\_map\_blocks+0x1868/0x6880 fs/ext4/extents.c:4286
ext4\_map\_blocks+0xa49/0x1cc0 fs/ext4/inode.c:651
ext4\_getblk+0x1b9/0x770 fs/ext4/inode.c:864
ext4\_bread+0x2a/0x170 fs/ext4/inode.c:920
ext4\_quota\_write+0x225/0x570 fs/ext4/super.c:7105
write\_blk fs/quota/quota\_tree.c:64 [inline]
get\_free\_dqblk+0x34a/0x6d0 fs/quota/quota\_tree.c:130
do\_insert\_tree+0x26b/0x1aa0 fs/quota/quota\_tree.c:340
do\_insert\_tree+0x722/0x1aa0 fs/quota/quota\_tree.c:375
do\_insert\_tree+0x722/0x1aa0 fs/quota/quota\_tree.c:375
do\_insert\_tree+0x722/0x1aa0 fs/quota/quota\_tree.c:375
dq\_insert\_tree fs/quota/quota\_tree.c:401 [inline]
qtree\_write\_dquot+0x3b6/0x530 fs/quota/quota\_tree.c:420
v2\_write\_dquot+0x11b/0x190 fs/quota/quota\_v2.c:358
dquot\_acquire+0x348/0x670 fs/quota/dquot.c:444
ext4\_acquire\_dquot+0x2dc/0x400 fs/ext4/super.c:6740
dqget+0x999/0xdc0 fs/quota/dquot.c:914
\_\_dquot\_initialize+0x3d0/0xcf0 fs/quota/dquot.c:1492
ext4\_process\_orphan+0x57/0x2d0 fs/ext4/orphan.c:329
ext4\_orphan\_cleanup+0xb60/0x1340 fs/ext4/orphan.c:474
\_\_ext4\_fill\_super fs/ext4/super.c:5516 [inline]
ext4\_fill\_super+0x81cd/0x8700 fs/ext4/super.c:5644
get\_tree\_bdev+0x400/0x620 fs/super.c:1282
vfs\_get\_tree+0x88/0x270 fs/super.c:1489
do\_new\_mount+0x289/0xad0 fs/namespace.c:3145
do\_mount fs/namespace.c:3488 [inline]
\_\_do\_sys\_mount fs/namespace.c:3697 [inline]
\_\_se\_sys\_mount+0x2d3/0x3c0 fs/namespace.c:3674
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3d/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Add some debug information:
mb\_find\_extent: mb\_find\_extent block=41, order=0 needed=64 next=0 ex=0/41/1@3735929054 64 64 7
block\_bitmap: ff 3f 0c 00 fc 01 00 00 d2 3d 00 00 00 00 00 00 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
Acctually, blocks per group is 64, but block bitmap indicate at least has
128 blocks. Now, ext4\_validate\_block\_bitmap() didn't check invalid block's
bitmap if set.
To resolve above issue, add check like fsck "Padding at end of block bitmap is
not set".
Cc: stable@kernel.org
Reported-by: syzbot+68223fe9f6c95ad43bed@syzkaller.appspotmail.com
Signed-off-by: Ye Bin
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230116020015.1506120-1-yebin@huaweicloud.com
Signed-off-by: Theodore Ts'o
Signed-off-by: Greg Kroah-Hartman
commit 946416dee8541b519b6ec86c183c6b4f8210451c
Author: John Stultz
Date: Wed May 3 02:33:51 2023 +0000
locking/rwsem: Add \_\_always\_inline annotation to \_\_down\_read\_common() and inlined callers
commit 92cc5d00a431e96e5a49c0b97e5ad4fa7536bd4b upstream.
Apparently despite it being marked inline, the compiler
may not inline \_\_down\_read\_common() which makes it difficult
to identify the cause of lock contention, as the blocked
function in traceevents will always be listed as
\_\_down\_read\_common().
So this patch adds \_\_always\_inline annotation to the common
function (as well as the inlined helper callers) to force it to
be inlined so the blocking function will be listed (via Wchan)
in traceevents.
Fixes: c995e638ccbb ("locking/rwsem: Fold \_\_down\_{read,write}\*()")
Reported-by: Tim Murray
Signed-off-by: John Stultz
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Waiman Long
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20230503023351.2832796-1-jstultz@google.com
Signed-off-by: Greg Kroah-Hartman
commit 34b7f8a42333d443378fd9b8c7537e47c73d5e59
Author: Namhyung Kim
Date: Wed Apr 26 20:05:27 2023 -0700
perf/x86: Fix missing sample size update on AMD BRS
commit 90befef5a9e820ccccc33181ec14c015980300cc upstream.
It missed to convert a PERF\_SAMPLE\_BRANCH\_STACK user to call the new
perf\_sample\_save\_brstack() helper in order to update the dyn\_size.
This affects AMD Zen3 machines with the branch-brs event.
Fixes: eb55b455ef9c ("perf/core: Add perf\_sample\_save\_brstack() helper")
Signed-off-by: Namhyung Kim
Signed-off-by: Peter Zijlstra (Intel)
Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/20230427030527.580841-1-namhyung@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit c97d51f160c428687150a181e7a2dd82bf3d706e
Author: Helge Deller
Date: Sat May 13 22:30:06 2023 +0200
parisc: Fix encoding of swp\_entry due to added SWP\_EXCLUSIVE flag
commit 6f9e98849edaa8aefc4030ff3500e41556e83ff7 upstream.
Fix the \_\_swp\_offset() and \_\_swp\_entry() macros due to commit 6d239fc78c0b
("parisc/mm: support \_\_HAVE\_ARCH\_PTE\_SWP\_EXCLUSIVE") which introduced the
SWP\_EXCLUSIVE flag by reusing the \_PAGE\_ACCESSED flag.
Reported-by: Christoph Biedl
Tested-by: Christoph Biedl
Reviewed-by: David Hildenbrand
Signed-off-by: Helge Deller
Fixes: 6d239fc78c0b ("parisc/mm: support \_\_HAVE\_ARCH\_PTE\_SWP\_EXCLUSIVE")
Cc:  # v6.3+
Signed-off-by: Greg Kroah-Hartman
commit 5d58b3e4fff139cdb0c609eb078cc07608736e02
Author: Leo Chen
Date: Tue Apr 11 10:49:38 2023 -0400
drm/amd/display: Lowering min Z8 residency time
[ Upstream commit d893f39320e1248d1c97fde0d6e51e5ea008a76b ]
[Why & How]
Per HW team request, we're lowering the minimum Z8
residency time to 2000us. This enables Z8 support for additional
modes we were previously blocking like 2k>60hz
Cc: stable@vger.kernel.org
Tested-by: Daniel Wheeler
Reviewed-by: Nicholas Kazlauskas
Acked-by: Rodrigo Siqueira
Signed-off-by: Leo Chen
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 3f6bda0b7a044a76f5ee61227dd43fbd42c4be79
Author: Nicholas Kazlauskas
Date: Tue Feb 21 10:27:10 2023 -0500
drm/amd/display: Update minimum stutter residency for DCN314 Z8
[ Upstream commit 0215ce9057edf69aff9c1a32f4254e1ec297db31 ]
[Why]
Block periods that are too short as they have the potential to
currently cause hangs in other firmware components on the system.
[How]
Update the threshold, mostly targeting a block of 4k and downscaling.
Reviewed-by: Jun Lei
Acked-by: Qingqing Zhuo
Signed-off-by: Nicholas Kazlauskas
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Stable-dep-of: d893f39320e1 ("drm/amd/display: Lowering min Z8 residency time")
Signed-off-by: Sasha Levin
commit 143e4b6a3e61807d8cd9d2d5673cf942ef1e3763
Author: Nicholas Kazlauskas
Date: Fri Feb 17 11:17:50 2023 -0500
drm/amd/display: Add minimum Z8 residency debug option
[ Upstream commit 0db13eae41fcc67f408dbb3dfda59633c4fa03fb ]
[Why]
Allows finer control and tuning for debug and profiling.
[How]
Add the debug option into DC. The default remains the same as before
for now.
Reviewed-by: Jun Lei
Acked-by: Qingqing Zhuo
Signed-off-by: Nicholas Kazlauskas
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Stable-dep-of: d893f39320e1 ("drm/amd/display: Lowering min Z8 residency time")
Signed-off-by: Sasha Levin
commit 368bf062dcca7497514b0f2c173456dd317e29ee
Author: Lionel Landwerlin
Date: Fri Apr 7 12:32:37 2023 +0300
drm/i915: disable sampler indirect state in bindless heap
[ Upstream commit 81900e3a37750d8c6ad705045310e002f6dd0356 ]
By default the indirect state sampler data (border colors) are stored
in the same heap as the SAMPLER\_STATE structure. For userspace drivers
that can be 2 different heaps (dynamic state heap & bindless sampler
state heap). This means that border colors have to copied in 2
different places so that the same SAMPLER\_STATE structure find the
right data.
This change is forcing the indirect state sampler data to only be in
the dynamic state pool (more convenient for userspace drivers, they
only have to have one copy of the border colors). This is reproducing
the behavior of the Windows drivers.
BSpec: 46052
Signed-off-by: Lionel Landwerlin
Cc: stable@vger.kernel.org
Reviewed-by: Haridhar Kalvala
Signed-off-by: Matt Roper
Link: https://patchwork.freedesktop.org/patch/msgid/20230407093237.3296286-1-lionel.g.landwerlin@intel.com
(cherry picked from commit 16fc9c08f0ec7b1c95f1ea4a16097acdb3fc943d)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 20e13881369abab8db57fa313d5861650780ed9f
Author: Haridhar Kalvala
Date: Tue Apr 4 23:02:20 2023 +0530
drm/i915/mtl: Add Wa\_14017856879
[ Upstream commit 4b51210f98c2b89ce37aede5b8dc5105be0572c6 ]
Wa\_14017856879 implementation for mtl.
Bspec: 46046
Signed-off-by: Haridhar Kalvala
Reviewed-by: Gustavo Sousa
Signed-off-by: Matt Roper
Link: https://patchwork.freedesktop.org/patch/msgid/20230404173220.3175577-1-haridhar.kalvala@intel.com
Stable-dep-of: 81900e3a3775 ("drm/i915: disable sampler indirect state in bindless heap")
Signed-off-by: Sasha Levin
commit 6a3752f2bafb6d5d3fd141fac99983c454ddb617
Author: Radhakrishna Sripada
Date: Wed Mar 29 18:23:35 2023 -0300
drm/i915/mtl: Add workarounds Wa\_14017066071 and Wa\_14017654203
[ Upstream commit 5fba65efa7cfb8cef227a2c555deb10327a5e27b ]
Both workarounds require the same implementation and apply to MTL P and
M from stepping A0 to B0 (exclusive).
v2:
- Remove unrelated brace removal. (Matt)
Signed-off-by: Radhakrishna Sripada
Signed-off-by: Gustavo Sousa
Reviewed-by: Matt Roper
Signed-off-by: Matt Roper
Link: https://patchwork.freedesktop.org/patch/msgid/20230329212336.106161-2-gustavo.sousa@intel.com
Stable-dep-of: 81900e3a3775 ("drm/i915: disable sampler indirect state in bindless heap")
Signed-off-by: Sasha Levin
commit 0ee18aa1a8b9cd7de51536661317049b4503798f
Author: Lucas De Marchi
Date: Wed Jan 25 10:24:03 2023 -0800
drm/i915: Add \_PICK\_EVEN\_2RANGES()
[ Upstream commit 357513233d6456c9f99e34794897efd4ae907e83 ]
It's a constant pattern in the driver to need to use 2 ranges of MMIOs
based on port, phy, pll, etc. When that happens, instead of using
\_PICK\_EVEN(), \_PICK() needs to be used. Using \_PICK() is discouraged
due to some reasons like:
1) It increases the code size since the array is declared
in each call site
2) Developers need to be careful not to incur an
out-of-bounds array access
3) Developers need to be careful that the indexes match the
table. For that it may be that the table needs to contain
holes, making (1) even worse.
Add a variant of \_PICK\_EVEN() that works with 2 ranges and selects which
one to use depending on the index value.
v2: Fix the address expansion in the example (Anusha)
v3: Also rename macro to \_PICK\_EVEN\_2RANGES() in the documentation
and reword it to clarify what ranges are chosen based on the index
(Jani)
Signed-off-by: Lucas De Marchi
Reviewed-by: Anusha Srivatsa
Acked-by: Jani Nikula
Link: https://patchwork.freedesktop.org/patch/msgid/20230125182403.7526-1-lucas.demarchi@intel.com
Stable-dep-of: 214b09db6197 ("drm/msm: fix drm device leak on bind errors")
Signed-off-by: Sasha Levin
commit 92758439c0fafa347bcd6501128ebd6fbb43cc5c
Author: Robin Chen
Date: Fri Feb 17 20:47:57 2023 +0800
drm/amd/display: hpd rx irq not working with eDP interface
[ Upstream commit eeefe7c4820b6baa0462a8b723ea0a3b5846ccae ]
[Why]
This is the fix for the defect of commit ab144f0b4ad6
("drm/amd/display: Allow individual control of eDP hotplug support").
[How]
To revise the default eDP hotplug setting and use the enum to git rid
of the magic number for different options.
Fixes: ab144f0b4ad6 ("drm/amd/display: Allow individual control of eDP hotplug support")
Cc: stable@vger.kernel.org
Cc: Mario Limonciello
Reviewed-by: Wenjing Liu
Acked-by: Qingqing Zhuo
Signed-off-by: Robin Chen
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit cdbf4f3feff61ce1c2aa76328b74c1a7b7cef99d
Author: Wenjing Liu
Date: Mon Feb 6 17:58:52 2023 -0500
drm/amd/display: merge dc\_link.h into dc.h and dc\_types.h
[ Upstream commit 7ae1dbe6547c39410d82156c96eaa9c8cf55e87a ]
[why]
Remove the need to include dc\_link.h separately. dc.h should contain
everything needed on DM side.
[How]
Merge dc\_link.h into dc.h and dc\_types.h so DM only needs to include
dc.h to use all link public functions.
Reviewed-by: Jun Lei
Acked-by: Qingqing Zhuo
Signed-off-by: Wenjing Liu
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Stable-dep-of: eeefe7c4820b ("drm/amd/display: hpd rx irq not working with eDP interface")
Signed-off-by: Sasha Levin
commit 8d106ef1174b57a286ab3bfd6f82da38ccd6eba6
Author: Konrad Dybcio
Date: Fri Mar 31 01:15:16 2023 +0200
drm/msm/adreno: adreno\_gpu: Use suspend() instead of idle() on load error
commit 3eeca5e5f3100435b06a5b5d86daa3d135a8a4bd upstream.
The adreno\_load\_gpu() path is guarded by an error check on
adreno\_load\_fw(). This function is responsible for loading
Qualcomm-only-signed binaries (e.g. SQE and GMU FW for A6XX), but it
does not take the vendor-signed ZAP blob into account.
By embedding the SQE (and GMU, if necessary) firmware into the
initrd/kernel, we can trigger and unfortunate path that would not bail
out early and proceed with gpu->hw\_init(). That will fail, as the ZAP
loader path will not find the firmware and return back to
adreno\_load\_gpu().
This error path involves pm\_runtime\_put\_sync() which then calls idle()
instead of suspend(). This is suboptimal, as it means that we're not
going through the clean shutdown sequence. With at least A619\_holi, this
makes the GPU not wake up until it goes through at least one more
start-fail-stop cycle. The pm\_runtime\_put\_sync that appears in the error
path actually does not guarantee that because of the earlier enabling of
runtime autosuspend.
Fix that by using pm\_runtime\_put\_sync\_suspend to force a clean shutdown.
Test cases:
1. All firmware baked into kernel
2. error loading ZAP fw in initrd -> load from rootfs at DE start
Both succeed on A619\_holi (SM6375) and A630 (SDM845).
Fixes: 0d997f95b70f ("drm/msm/adreno: fix runtime PM imbalance at gpu load")
Signed-off-by: Konrad Dybcio
Reviewed-by: Johan Hovold
Patchwork: https://patchwork.freedesktop.org/patch/530001/
Link: https://lore.kernel.org/r/20230330231517.2747024-1-konrad.dybcio@linaro.org
Signed-off-by: Rob Clark
Signed-off-by: Greg Kroah-Hartman
commit 5b60c709cb7f0faa3c14559bcc51a7e1850210d3
Author: Vlad Buslov
Date: Thu May 4 20:16:15 2023 +0200
Revert "net/sched: flower: Fix wrong handle assignment during filter change"
commit 5110f3ff6d3c986df9575c8da86630578b7f0846 upstream.
This reverts commit 32eff6bacec2cb574677c15378169a9fa30043ef.
Superseded by the following commit in this series.
Signed-off-by: Vlad Buslov
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit caf38037ea1506b724f8bdfd011f366327b2035b
Author: Konstantin Komarov
Date: Fri Dec 30 14:58:25 2022 +0400
fs/ntfs3: Refactoring of various minor issues
commit 6827d50b2c430c329af442b64c9176d174f56521 upstream.
Removed unused macro.
Changed null pointer checking.
Fixed inconsistent indenting.
Signed-off-by: Konstantin Komarov
Cc: Rudi Heitbaum
Signed-off-by: Greg Kroah-Hartman
commit 694d3e4387bfa69925e075053894385351106e64
Author: Ping Cheng
Date: Fri Feb 24 08:26:43 2023 -0800
HID: wacom: insert timestamp to packed Bluetooth (BT) events
commit 17d793f3ed53080dab6bbeabfc82de890c901001 upstream.
To fully utilize the BT polling/refresh rate, a few input events
are sent together to reduce event delay. This causes issue to the
timestamp generated by input\_sync since all the events in the same
packet would pretty much have the same timestamp. This patch inserts
time interval to the events by averaging the total time used for
sending the packet.
This decision was mainly based on observing the actual time interval
between each BT polling. The interval doesn't seem to be constant,
due to the network and system environment. So, using solutions other
than averaging doesn't end up with valid timestamps.
Signed-off-by: Ping Cheng
Reviewed-by: Jason Gerecke
Signed-off-by: Jiri Kosina
Signed-off-by: Greg Kroah-Hartman
commit c079803ab37f3d92e485829c2c95df74e9be7028
Author: Ping Cheng
Date: Sun Apr 9 09:42:29 2023 -0700
HID: wacom: Set a default resolution for older tablets
commit 08a46b4190d345544d04ce4fe2e1844b772b8535 upstream.
Some older tablets may not report physical maximum for X/Y
coordinates. Set a default to prevent undefined resolution.
Signed-off-by: Ping Cheng
Link: https://lore.kernel.org/r/20230409164229.29777-1-ping.cheng@wacom.com
Signed-off-by: Benjamin Tissoires
Signed-off-by: Greg Kroah-Hartman
commit 2dbf73d3fabaea8736c70abef3aa7ca2bc37e8f4
Author: Takashi Sakamoto
Date: Wed May 10 10:35:33 2023 +0900
firewire: net: fix unexpected release of object for asynchronous request packet
commit f7dcc5e33c1e4b0d278a30f7d2f0c9a63d7b40ca upstream.
The lifetime of object for asynchronous request packet is now maintained
by reference counting, while current implementation of firewire-net
releases the passed object in the handler.
This commit fixes the bug.
Reported-by: Dan Carpenter
Link: https://lore.kernel.org/lkml/Y%2Fymx6WZIAlrtjLc@workstation/
Fixes: 13a55d6bb15f ("firewire: core: use kref structure to maintain lifetime of data for fw\_request structure")
Link: https://lore.kernel.org/lkml/20230510031205.782032-1-o-takashi@sakamocchi.jp/
Signed-off-by: Takashi Sakamoto
Signed-off-by: Greg Kroah-Hartman
commit cb44ddee540e79ff1c5d66bef0890375cf193a66
Author: Guchun Chen
Date: Tue May 9 09:36:49 2023 +0800
drm/amd/pm: avoid potential UBSAN issue on legacy asics
commit 5247f05eadf1081a74b2233f291cee2efed25e3a upstream.
Prevent further dpm casting on legacy asics without od\_enabled in
amdgpu\_dpm\_is\_overdrive\_supported. This can avoid UBSAN complain
in init sequence.
v2: add a macro to check legacy dpm instead of checking asic family/type
v3: refine macro name for naming consistency
Suggested-by: Evan Quan
Signed-off-by: Guchun Chen
Reviewed-by: Lijo Lazar
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit c5123c193696bf97fdf259c825ebfac517b54e44
Author: Guchun Chen
Date: Sat May 6 16:52:59 2023 +0800
drm/amdgpu: disable sdma ecc irq only when sdma RAS is enabled in suspend
commit 8b229ada2669b74fdae06c83fbfda5a5a99fc253 upstream.
sdma\_v4\_0\_ip is shared on a few asics, but in sdma\_v4\_0\_hw\_fini,
driver unconditionally disables ecc\_irq which is only enabled on
those asics enabling sdma ecc. This will introduce a warning in
suspend cycle on those chips with sdma ip v4.0, while without
sdma ecc. So this patch correct this.
[ 7283.166354] RIP: 0010:amdgpu\_irq\_put+0x45/0x70 [amdgpu]
[ 7283.167001] RSP: 0018:ffff9a5fc3967d08 EFLAGS: 00010246
[ 7283.167019] RAX: ffff98d88afd3770 RBX: 0000000000000001 RCX: 0000000000000000
[ 7283.167023] RDX: 0000000000000000 RSI: ffff98d89da30390 RDI: ffff98d89da20000
[ 7283.167025] RBP: ffff98d89da20000 R08: 0000000000036838 R09: 0000000000000006
[ 7283.167028] R10: ffffd5764243c008 R11: 0000000000000000 R12: ffff98d89da30390
[ 7283.167030] R13: ffff98d89da38978 R14: ffffffff999ae15a R15: ffff98d880130105
[ 7283.167032] FS: 0000000000000000(0000) GS:ffff98d996f00000(0000) knlGS:0000000000000000
[ 7283.167036] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 7283.167039] CR2: 00000000f7a9d178 CR3: 00000001c42ea000 CR4: 00000000003506e0
[ 7283.167041] Call Trace:
[ 7283.167046]
[ 7283.167048] sdma\_v4\_0\_hw\_fini+0x38/0xa0 [amdgpu]
[ 7283.167704] amdgpu\_device\_ip\_suspend\_phase2+0x101/0x1a0 [amdgpu]
[ 7283.168296] amdgpu\_device\_suspend+0x103/0x180 [amdgpu]
[ 7283.168875] amdgpu\_pmops\_freeze+0x21/0x60 [amdgpu]
[ 7283.169464] pci\_pm\_freeze+0x54/0xc0
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2522
Signed-off-by: Guchun Chen
Reviewed-by: Tao Zhou
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 31b07aec4a2bdcab00770ea3a18efe49734ce153
Author: Horatio Zhang
Date: Thu May 4 01:46:12 2023 -0400
drm/amdgpu: drop gfx\_v11\_0\_cp\_ecc\_error\_irq\_funcs
commit 720b47229a5b24061d1c2e29ddb6043a59178d79 upstream.
The gfx.cp\_ecc\_error\_irq is retired in gfx11. In gfx\_v11\_0\_hw\_fini still
use amdgpu\_irq\_put to disable this interrupt, which caused the call trace
in this function.
[ 102.873958] Call Trace:
[ 102.873959]
[ 102.873961] gfx\_v11\_0\_hw\_fini+0x23/0x1e0 [amdgpu]
[ 102.874019] gfx\_v11\_0\_suspend+0xe/0x20 [amdgpu]
[ 102.874072] amdgpu\_device\_ip\_suspend\_phase2+0x240/0x460 [amdgpu]
[ 102.874122] amdgpu\_device\_ip\_suspend+0x3d/0x80 [amdgpu]
[ 102.874172] amdgpu\_device\_pre\_asic\_reset+0xd9/0x490 [amdgpu]
[ 102.874223] amdgpu\_device\_gpu\_recover.cold+0x548/0xce6 [amdgpu]
[ 102.874321] amdgpu\_debugfs\_reset\_work+0x4c/0x70 [amdgpu]
[ 102.874375] process\_one\_work+0x21f/0x3f0
[ 102.874377] worker\_thread+0x200/0x3e0
[ 102.874378] ? process\_one\_work+0x3f0/0x3f0
[ 102.874379] kthread+0xfd/0x130
[ 102.874380] ? kthread\_complete\_and\_exit+0x20/0x20
[ 102.874381] ret\_from\_fork+0x22/0x30
v2:
- Handle umc and gfx ras cases in separated patch
- Retired the gfx\_v11\_0\_cp\_ecc\_error\_irq\_funcs in gfx11
v3:
- Improve the subject and code comments
- Add judgment on gfx11 in the function of amdgpu\_gfx\_ras\_late\_init
v4:
- Drop the define of CP\_ME1\_PIPE\_INST\_ADDR\_INTERVAL and
SET\_ECC\_ME\_PIPE\_STATE which using in gfx\_v11\_0\_set\_cp\_ecc\_error\_state
- Check cp\_ecc\_error\_irq.funcs rather than ip version for a more
sustainable life
v5:
- Simplify judgment conditions
Signed-off-by: Horatio Zhang
Reviewed-by: Hawking Zhang
Acked-by: Christian König
Reviewed-by: Guchun Chen
Reviewed-by: Feifei Xu
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit eb0b3f7cc1e27535f2ae77ebff74dde0fa23ddad
Author: Guchun Chen
Date: Fri May 5 13:20:11 2023 +0800
drm/amd/pm: parse pp\_handle under appropriate conditions
commit 58d9b9a14b47c2a3da6effcbb01607ad7edc0275 upstream.
amdgpu\_dpm\_is\_overdrive\_supported is a common API across all
asics, so we should cast pp\_handle into correct structure
under different power frameworks.
v2: using return directly to simplify code
v3: SI asic does not carry od\_enabled member in pp\_handle, and update Fixes tag
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2541
Fixes: eb4900aa4c49 ("drm/amdgpu: Fix kernel NULL pointer dereference in dpm functions")
Suggested-by: Mario Limonciello
Signed-off-by: Guchun Chen
Reviewed-by: Mario Limonciello
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit ec7b8e4fe6ff070b0d9af2bcb9018bec6d3393ce
Author: Alvin Lee
Date: Thu Apr 27 15:10:13 2023 -0400
drm/amd/display: Enforce 60us prefetch for 200Mhz DCFCLK modes
commit b504f99ccaa64da364443431e388ecf30b604e38 upstream.
[Description]
- Due to bandwidth / arbitration issues at 200Mhz DCFCLK,
we want to enforce minimum 60us of prefetch to avoid
intermittent underflow issues
- Since 60us prefetch is already enforced for UCLK DPM0,
and many DCFCLK's > 200Mhz are mapped to UCLK DPM1, in
theory there should not be any UCLK DPM regressions by
enforcing greater prefetch
Reviewed-by: Nevenko Stupar
Reviewed-by: Jun Lei
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Alex Hung
Signed-off-by: Alvin Lee
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit e7b3b5cae1ac343cae1715a99c8d81ee99f0878c
Author: Lin.Cao
Date: Mon May 8 17:28:41 2023 +0800
drm/amdgpu: Fix vram recover doesn't work after whole GPU reset (v2)
commit 6c032c37ac3ef3b7df30937c785ecc4da428edc0 upstream.
v1: Vmbo->shadow is used to back vram bo up when vram lost. So that we
should set shadow as vmbo->shadow to recover vmbo->bo
v2: Modify if(vmbo->shadow) shadow = vmbo->shadow as if(!vmbo->shadow)
continue;
Fixes: e18aaea733da ("drm/amdgpu: move shadow\_list to amdgpu\_bo\_vm")
Reviewed-by: Christian König
Signed-off-by: Lin.Cao
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 7c71430cf40eba8b51876acb657b7002bcf57022
Author: Yifan Zhang
Date: Wed May 10 16:13:48 2023 +0800
drm/amdgpu: change gfx 11.0.4 external\_id range
commit 996e93a3fe74dcf9d467ae3020aea42cc3ff65e3 upstream.
gfx 11.0.4 range starts from 0x80.
Fixes: 311d52367d0a ("drm/amdgpu: add soc21 common ip block support for GC 11.0.4")
Cc: stable@vger.kernel.org
Signed-off-by: Yifan Zhang
Reported-by: Yogesh Mohan Marimuthu
Acked-by: Alex Deucher
Reviewed-by: Tim Huang
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit 867e9cc25cd09459df62265b77b1981c47106ce3
Author: Saleemkhan Jamadar
Date: Tue May 9 12:37:50 2023 +0530
drm/amdgpu/jpeg: Remove harvest checking for JPEG3
commit 5b94db73e45e2e6c2840f39c022fd71dfa47fc58 upstream.
Register CC\_UVD\_HARVESTING is obsolete for JPEG 3.1.2
Signed-off-by: Saleemkhan Jamadar
Reviewed-by: Veerabadhran Gopalakrishnan
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit efce310db74fdc6d2acd959f3582972ae4a8d7d5
Author: Guchun Chen
Date: Sat May 6 20:06:45 2023 +0800
drm/amdgpu/gfx: disable gfx9 cp\_ecc\_error\_irq only when enabling legacy gfx ras
commit 4a76680311330aefe5074bed8f06afa354b85c48 upstream.
gfx9 cp\_ecc\_error\_irq is only enabled when legacy gfx ras is assert.
So in gfx\_v9\_0\_hw\_fini, interrupt disablement for cp\_ecc\_error\_irq
should be executed under such condition, otherwise, an amdgpu\_irq\_put
calltrace will occur.
[ 7283.170322] RIP: 0010:amdgpu\_irq\_put+0x45/0x70 [amdgpu]
[ 7283.170964] RSP: 0018:ffff9a5fc3967d00 EFLAGS: 00010246
[ 7283.170967] RAX: ffff98d88afd3040 RBX: ffff98d89da20000 RCX: 0000000000000000
[ 7283.170969] RDX: 0000000000000000 RSI: ffff98d89da2bef8 RDI: ffff98d89da20000
[ 7283.170971] RBP: ffff98d89da20000 R08: ffff98d89da2ca18 R09: 0000000000000006
[ 7283.170973] R10: ffffd5764243c008 R11: 0000000000000000 R12: 0000000000001050
[ 7283.170975] R13: ffff98d89da38978 R14: ffffffff999ae15a R15: ffff98d880130105
[ 7283.170978] FS: 0000000000000000(0000) GS:ffff98d996f00000(0000) knlGS:0000000000000000
[ 7283.170981] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 7283.170983] CR2: 00000000f7a9d178 CR3: 00000001c42ea000 CR4: 00000000003506e0
[ 7283.170986] Call Trace:
[ 7283.170988]
[ 7283.170989] gfx\_v9\_0\_hw\_fini+0x1c/0x6d0 [amdgpu]
[ 7283.171655] amdgpu\_device\_ip\_suspend\_phase2+0x101/0x1a0 [amdgpu]
[ 7283.172245] amdgpu\_device\_suspend+0x103/0x180 [amdgpu]
[ 7283.172823] amdgpu\_pmops\_freeze+0x21/0x60 [amdgpu]
[ 7283.173412] pci\_pm\_freeze+0x54/0xc0
[ 7283.173419] ? \_\_pfx\_pci\_pm\_freeze+0x10/0x10
[ 7283.173425] dpm\_run\_callback+0x98/0x200
[ 7283.173430] \_\_device\_suspend+0x164/0x5f0
v2: drop gfx11 as it's fixed in a different solution by retiring cp\_ecc\_irq funcs(Hawking)
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2522
Signed-off-by: Guchun Chen
Reviewed-by: Tao Zhou
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 79038b78af931908d6f5d4e279d3afe32e7c840b
Author: Horatio Zhang
Date: Tue Apr 25 13:16:32 2023 +0800
drm/amdgpu: fix amdgpu\_irq\_put call trace in gmc\_v11\_0\_hw\_fini
commit 13af556104fa93b1945c70bbf8a0a62cd2c92879 upstream.
The gmc.ecc\_irq is enabled by firmware per IFWI setting,
and the host driver is not privileged to enable/disable
the interrupt. So, it is meaningless to use the amdgpu\_irq\_put
function in gmc\_v11\_0\_hw\_fini, which also leads to the call
trace.
[ 102.980303] Call Trace:
[ 102.980303]
[ 102.980304] gmc\_v11\_0\_hw\_fini+0x54/0x90 [amdgpu]
[ 102.980357] gmc\_v11\_0\_suspend+0xe/0x20 [amdgpu]
[ 102.980409] amdgpu\_device\_ip\_suspend\_phase2+0x240/0x460 [amdgpu]
[ 102.980459] amdgpu\_device\_ip\_suspend+0x3d/0x80 [amdgpu]
[ 102.980520] amdgpu\_device\_pre\_asic\_reset+0xd9/0x490 [amdgpu]
[ 102.980573] amdgpu\_device\_gpu\_recover.cold+0x548/0xce6 [amdgpu]
[ 102.980687] amdgpu\_debugfs\_reset\_work+0x4c/0x70 [amdgpu]
[ 102.980740] process\_one\_work+0x21f/0x3f0
[ 102.980741] worker\_thread+0x200/0x3e0
[ 102.980742] ? process\_one\_work+0x3f0/0x3f0
[ 102.980743] kthread+0xfd/0x130
[ 102.980743] ? kthread\_complete\_and\_exit+0x20/0x20
[ 102.980744] ret\_from\_fork+0x22/0x30
Signed-off-by: Horatio Zhang
Reviewed-by: Hawking Zhang
Reviewed-by: Guchun Chen
Signed-off-by: Alex Deucher
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2522
Fixes: c8b5a95b5709 ("drm/amdgpu: Fix desktop freezed after gpu-reset")
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit d2b1a984f979f2a9b667f61f3b3d15cf3dc33c11
Author: Hamza Mahfooz
Date: Tue May 2 11:59:08 2023 -0400
drm/amdgpu: fix an amdgpu\_irq\_put() issue in gmc\_v9\_0\_hw\_fini()
commit 922a76ba31adf84e72bc947267385be420c689ee upstream.
As made mention of in commit 08c677cb0b43 ("drm/amdgpu: fix
amdgpu\_irq\_put call trace in gmc\_v10\_0\_hw\_fini") and commit 13af556104fa
("drm/amdgpu: fix amdgpu\_irq\_put call trace in gmc\_v11\_0\_hw\_fini"). It
is meaningless to call amdgpu\_irq\_put() for gmc.ecc\_irq. So, remove it
from gmc\_v9\_0\_hw\_fini().
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2522
Fixes: 3029c855d79f ("drm/amdgpu: Fix desktop freezed after gpu-reset")
Reviewed-by: Mario Limonciello
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 23febab57e345c0e66f8574c1018707e7eb6ea94
Author: Horatio Zhang
Date: Tue Apr 25 10:52:28 2023 +0800
drm/amdgpu: fix amdgpu\_irq\_put call trace in gmc\_v10\_0\_hw\_fini
commit 08c677cb0b436a96a836792bb35a8ec5de4999c2 upstream.
The gmc.ecc\_irq is enabled by firmware per IFWI setting,
and the host driver is not privileged to enable/disable
the interrupt. So, it is meaningless to use the amdgpu\_irq\_put
function in gmc\_v10\_0\_hw\_fini, which also leads to the call
trace.
[ 82.340264] Call Trace:
[ 82.340265]
[ 82.340269] gmc\_v10\_0\_hw\_fini+0x83/0xa0 [amdgpu]
[ 82.340447] gmc\_v10\_0\_suspend+0xe/0x20 [amdgpu]
[ 82.340623] amdgpu\_device\_ip\_suspend\_phase2+0x127/0x1c0 [amdgpu]
[ 82.340789] amdgpu\_device\_ip\_suspend+0x3d/0x80 [amdgpu]
[ 82.340955] amdgpu\_device\_pre\_asic\_reset+0xdd/0x2b0 [amdgpu]
[ 82.341122] amdgpu\_device\_gpu\_recover.cold+0x4dd/0xbb2 [amdgpu]
[ 82.341359] amdgpu\_debugfs\_reset\_work+0x4c/0x70 [amdgpu]
[ 82.341529] process\_one\_work+0x21d/0x3f0
[ 82.341535] worker\_thread+0x1fa/0x3c0
[ 82.341538] ? process\_one\_work+0x3f0/0x3f0
[ 82.341540] kthread+0xff/0x130
[ 82.341544] ? kthread\_complete\_and\_exit+0x20/0x20
[ 82.341547] ret\_from\_fork+0x22/0x30
Signed-off-by: Horatio Zhang
Reviewed-by: Hawking Zhang
Reviewed-by: Guchun Chen
Signed-off-by: Alex Deucher
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2522
Fixes: c8b5a95b5709 ("drm/amdgpu: Fix desktop freezed after gpu-reset")
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 3c9e2929799426f45688a71538a4510d0a9a9c2d
Author: Leo Chen
Date: Thu Apr 13 17:34:24 2023 -0400
drm/amd/display: Change default Z8 watermark values
commit 8f586cc16c1fc3c2202c9d54563db8c7ed365f82 upstream.
[Why & How]
Previous Z8 watermark values were causing flickering and OTC underflow.
Updating Z8 watermark values based on the measurement.
Reviewed-by: Nicholas Kazlauskas
Cc: Mario Limonciello
Cc: Alex Deucher
Cc: stable@vger.kernel.org
Acked-by: Alan Liu
Signed-off-by: Leo Chen
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit ec02a29c3c2ef8ad3e15a0e3f96b99a00e5d97b4
Author: Guchun Chen
Date: Wed Apr 26 09:46:54 2023 +0800
drm/amdgpu: drop redundant sched job cleanup when cs is aborted
commit 1253685f0d3eb3eab0bfc4bf15ab341a5f3da0c8 upstream.
Once command submission failed due to userptr invalidation in
amdgpu\_cs\_submit, legacy code will perform cleanup of scheduler
job. However, it's not needed at all, as former commit has integrated
job cleanup stuff into amdgpu\_job\_free. Otherwise, because of double
free, a NULL pointer dereference will occur in such scenario.
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/2457
Fixes: f7d66fb2ea43 ("drm/amdgpu: cleanup scheduler job initialization v2")
Signed-off-by: Guchun Chen
Reviewed-by: Christian König
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 917680e6056aa288cac288d3afd2745d372beb61
Author: Hamza Mahfooz
Date: Fri Apr 14 14:26:27 2023 -0400
drm/amd/display: fix flickering caused by S/G mode
commit 08da182175db4c7f80850354849d95f2670e8cd9 upstream.
Currently, on a handful of ASICs. We allow the framebuffer for a given
plane to exist in either VRAM or GTT. However, if the plane's new
framebuffer is in a different memory domain than it's previous
framebuffer, flipping between them can cause the screen to flicker. So,
to fix this, don't perform an immediate flip in the aforementioned case.
Cc: stable@vger.kernel.org
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2354
Reviewed-by: Roman Li
Fixes: 81d0bcf99009 ("drm/amdgpu: make display pinning more flexible (v2)")
Signed-off-by: Hamza Mahfooz
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit ecd45aa70f1d417e250482ac288f51da266b7991
Author: Hersen Wu
Date: Tue Mar 28 10:45:24 2023 -0400
drm/amd/display: fix access hdcp\_workqueue assert
commit 3cf7cd3f770a0b89dc5f06e19edb52e65b93b214 upstream.
[Why] hdcp are enabled for asics from raven. for old asics
which hdcp are not enabled, hdcp\_workqueue are null. some
access to hdcp work queue are not guarded with pointer check.
[How] add hdcp\_workqueue pointer check before access workqueue.
Fixes: 82986fd631fa ("drm/amd/display: save restore hdcp state when display is unplugged from mst hub")
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2444
Reported-by: Niklāvs Koļesņikovs <89q1r14hd@relay.firefox.com>
Reviewed-by: Bhawanpreet Lakha
Acked-by: Qingqing Zhuo
Signed-off-by: Hersen Wu
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit e23a3c3e574318e8d99b54b8702d749fe19f8ee0
Author: Samson Tam
Date: Wed Apr 19 18:17:14 2023 -0400
drm/amd/display: filter out invalid bits in pipe\_fuses
commit 682439fffad9fa9a38d37dd1b1318e9374232213 upstream.
[Why]
Reading pipe\_fuses from register may have invalid bits set, which may
affect the num\_pipes erroneously.
[How]
Add read\_pipes\_fuses() call and filter bits based on expected number
of pipes.
Reviewed-by: Alvin Lee
Acked-by: Alan Liu
Signed-off-by: Samson Tam
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org # 6.1.x
Signed-off-by: Greg Kroah-Hartman
commit b52ca48c30f224c8d996223652c1b15e9d41b981
Author: Nicholas Kazlauskas
Date: Mon Mar 13 13:23:45 2023 -0400
drm/amd/display: Fix 4to1 MPC black screen with DPP RCO
commit bf224e00a9f54e2bf14b4d720a09c3d2f4aa4aa8 upstream.
[Why]
DPP Root clock optimization when combined with 4to1 MPC combine results
in the screen turning black.
This is because the DPPCLK is stopped during the middle of an
optimize\_bandwidth sequence during commit\_minimal\_transition without
going through plane power down/power up.
[How]
The intent of a 0Hz DPP clock through update\_clocks is to disable the
DTO. This differs from the behavior of stopping the DPPCLK entirely
(utilizing a 0Hz clock on some ASIC) so it's better to move this logic
to reside next to plane power up/power down where we gate the HUBP/DPP
DOMAIN.
The new sequence should be:
Power down: PG enabled -> RCO on
Power up: RCO off -> PG disabled
Rename power\_on\_plane to power\_on\_plane\_resources to reflect the
actual operation that's occurring.
Cc: stable@vger.kernel.org
Cc: Mario Limonciello
Reviewed-by: Jun Lei
Acked-by: Qingqing Zhuo
Signed-off-by: Nicholas Kazlauskas
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit fb2c88f8d294be569bd1ce5c8d07a76f263f5484
Author: Nicholas Kazlauskas
Date: Sat Mar 11 09:11:29 2023 -0500
drm/amd/display: Add NULL plane\_state check for cursor disable logic
commit d29fb7baab09b6a1dc484c9c67933253883e770a upstream.
[Why]
While scanning the top\_pipe connections we can run into a case where
the bottom pipe is still connected to a top\_pipe but with a NULL
plane\_state.
[How]
Treat a NULL plane\_state the same as the plane being invisible for
pipe cursor disable logic.
Cc: stable@vger.kernel.org
Cc: Mario Limonciello
Reviewed-by: Charlene Liu
Acked-by: Qingqing Zhuo
Signed-off-by: Nicholas Kazlauskas
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Greg Kroah-Hartman
commit f859513b408798837874ec325fec1cbf8e28cee3
Author: James Cowgill
Date: Wed Apr 12 17:35:07 2023 +0000
drm/panel: otm8009a: Set backlight parent to panel device
commit ab4f869fba6119997f7630d600049762a2b014fa upstream.
This is the logical place to put the backlight device, and it also
fixes a kernel crash if the MIPI host is removed. Previously the
backlight device would be unregistered twice when this happened - once
as a child of the MIPI host through `mipi\_dsi\_host\_unregister`, and
once when the panel device is destroyed.
Fixes: 12a6cbd4f3f1 ("drm/panel: otm8009a: Use new backlight API")
Signed-off-by: James Cowgill
Cc: stable@vger.kernel.org
Reviewed-by: Neil Armstrong
Signed-off-by: Neil Armstrong
Link: https://patchwork.freedesktop.org/patch/msgid/20230412173450.199592-1-james.cowgill@blaize.com
Signed-off-by: Greg Kroah-Hartman
commit 1b141e7556d206666300ea2c2cbd13b8a98eba51
Author: Jianmin Lv
Date: Fri Apr 7 16:34:51 2023 +0800
irqchip/loongson-eiointc: Fix registration of syscore\_ops
commit bdd60211eebb43ba1c4c14704965f4d4b628b931 upstream.
When support suspend/resume for loongson-eiointc, the syscore\_ops
is registered twice in dual-bridges machines where there are two
eiointc IRQ domains. Repeated registration of an same syscore\_ops
broke syscore\_ops\_list. Also, cpuhp\_setup\_state\_nocalls is only
needed to call for once. So the patch will corret them.
Fixes: a90335c2dfb4 ("irqchip/loongson-eiointc: Add suspend/resume support")
Cc: stable@vger.kernel.org
Signed-off-by: Jianmin Lv
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230407083453.6305-4-lvjianmin@loongson.cn
Signed-off-by: Greg Kroah-Hartman
commit 65ba08a5019a34bf3a451368e75c5b29dc6c375e
Author: Jianmin Lv
Date: Fri Apr 7 16:34:50 2023 +0800
irqchip/loongson-eiointc: Fix incorrect use of acpi\_get\_vec\_parent
commit 64cc451e45e146b2140211b4f45f278b93b24ac0 upstream.
In eiointc\_acpi\_init(), a \*eiointc\* node is passed into
acpi\_get\_vec\_parent() instead of a required \*NUMA\* node (on some chip
like 3C5000L, a \*NUMA\* node means a \*eiointc\* node, but on some chip
like 3C5000, a \*NUMA\* node contains 4 \*eiointc\* nodes), and node in
struct acpi\_vector\_group is essentially a \*NUMA\* node, which will
lead to no parent matched for passed \*eiointc\* node. so the patch
adjusts code to use \*NUMA\* node for parameter node of
acpi\_set\_vec\_parent/acpi\_get\_vec\_parent.
Cc: stable@vger.kernel.org
Signed-off-by: Jianmin Lv
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230407083453.6305-3-lvjianmin@loongson.cn
Signed-off-by: Greg Kroah-Hartman
commit f9087cc4b83c8998a3ee281e68d34b4e1c8a6126
Author: Jianmin Lv
Date: Fri Apr 7 16:34:49 2023 +0800
irqchip/loongson-eiointc: Fix returned value on parsing MADT
commit 112eaa8fec5ea75f1be003ec55760b09a86799f8 upstream.
In pch\_pic\_parse\_madt(), a NULL parent pointer will be
returned from acpi\_get\_vec\_parent() for second pch-pic domain
related to second bridge while calling eiointc\_acpi\_init() at
first time, where the parent of it has not been initialized
yet, and will be initialized during second time calling
eiointc\_acpi\_init(). So, it's reasonable to return zero so
that failure of acpi\_table\_parse\_madt() will be avoided, or else
acpi\_cascade\_irqdomain\_init() will return and initialization of
followed pch\_msi domain will be skipped.
Although it does not matter when pch\_msi\_parse\_madt() returns
-EINVAL if no invalid parent is found, it's also reasonable to
return zero for that.
Cc: stable@vger.kernel.org
Signed-off-by: Jianmin Lv
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230407083453.6305-2-lvjianmin@loongson.cn
Signed-off-by: Greg Kroah-Hartman
commit 1052bee615c13b6feb31551293310064b18ef86d
Author: Jianmin Lv
Date: Fri Apr 7 16:34:52 2023 +0800
irqchip/loongson-pch-pic: Fix registration of syscore\_ops
commit c84efbba46901b187994558ee0edb15f7076c9a7 upstream.
When support suspend/resume for loongson-pch-pic, the syscore\_ops
is registered twice in dual-bridges machines where there are two
pch-pic IRQ domains. Repeated registration of an same syscore\_ops
broke syscore\_ops\_list, so the patch will corret it.
Fixes: 1ed008a2c331 ("irqchip/loongson-pch-pic: Add suspend/resume support")
Cc: stable@vger.kernel.org
Signed-off-by: Jianmin Lv
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230407083453.6305-5-lvjianmin@loongson.cn
Signed-off-by: Greg Kroah-Hartman
commit 459e74ec3a3e18fe897c249058bc3653106b1904
Author: Jianmin Lv
Date: Fri Apr 7 16:34:53 2023 +0800
irqchip/loongson-pch-pic: Fix pch\_pic\_acpi\_init calling
commit 48ce2d722f7f108f27bedddf54bee3423a57ce57 upstream.
For dual-bridges scenario, pch\_pic\_acpi\_init() will be called
in following path:
cpuintc\_acpi\_init
acpi\_cascade\_irqdomain\_init(in cpuintc driver)
acpi\_table\_parse\_madt
eiointc\_parse\_madt
eiointc\_acpi\_init /\* this will be called two times
correspondingto parsing two
eiointc entries in MADT under
dual-bridges scenario\*/
acpi\_cascade\_irqdomain\_init(in eiointc driver)
acpi\_table\_parse\_madt
pch\_pic\_parse\_madt
pch\_pic\_acpi\_init /\* this will be called depend
on valid parent IRQ domain
handle for one or two times
corresponding to parsing
two pchpic entries in MADT
druring calling
eiointc\_acpi\_init() under
dual-bridges scenario\*/
During the first eiointc\_acpi\_init() calling, the
pch\_pic\_acpi\_init() will be called just one time since only
one valid parent IRQ domain handle will be found for current
eiointc IRQ domain.
During the second eiointc\_acpi\_init() calling, the
pch\_pic\_acpi\_init() will be called two times since two valid
parent IRQ domain handles will be found. So in pch\_pic\_acpi\_init(),
we must have a reasonable way to prevent from creating second same
pch\_pic IRQ domain.
The patch matches gsi base information in created pch\_pic IRQ
domains to check if the target domain has been created to avoid the
bug mentioned above.
Cc: stable@vger.kernel.org
Signed-off-by: Jianmin Lv
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230407083453.6305-6-lvjianmin@loongson.cn
Signed-off-by: Greg Kroah-Hartman
commit 0a76082a4a32a90d1ef33dee8b400efc082b4b6f
Author: Jaegeuk Kim
Date: Thu Apr 6 11:18:48 2023 -0700
f2fs: fix potential corruption when moving a directory
commit d94772154e524b329a168678836745d2773a6e02 upstream.
F2FS has the same issue in ext4\_rename causing crash revealed by
xfstests/generic/707.
See also commit 0813299c586b ("ext4: Fix possible corruption when moving a directory")
CC: stable@vger.kernel.org
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit e2bbefc1741cb0732c13652be173da02f25611d1
Author: Jaegeuk Kim
Date: Mon Apr 3 09:37:24 2023 -0700
f2fs: fix null pointer panic in tracepoint in \_\_replace\_atomic\_write\_block
commit da6ea0b050fa720302b56fbb59307e7c7531a342 upstream.
We got a kernel panic if old\_addr is NULL.
https://bugzilla.kernel.org/show\_bug.cgi?id=217266
BUG: kernel NULL pointer dereference, address: 0000000000000000
Call Trace:
f2fs\_commit\_atomic\_write+0x619/0x990 [f2fs a1b985b80f5babd6f3ea778384908880812bfa43]
\_\_f2fs\_ioctl+0xd8e/0x4080 [f2fs a1b985b80f5babd6f3ea778384908880812bfa43]
? vfs\_write+0x2ae/0x3f0
? vfs\_write+0x2ae/0x3f0
\_\_x64\_sys\_ioctl+0x91/0xd0
do\_syscall\_64+0x5c/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
RIP: 0033:0x7f69095fe53f
Fixes: 2f3a9ae990a7 ("f2fs: introduce trace\_f2fs\_replace\_atomic\_write\_block")
Cc:
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit d184a33884c81b6adca6e4042447e3ab01db5d6b
Author: Jaegeuk Kim
Date: Fri Mar 10 11:49:57 2023 -0800
f2fs: remove entire rb\_entry sharing
commit bf21acf9959a48d90dd32869a0649525eb21be56 upstream.
This is a last part to remove the memory sharing for rb\_tree in extent\_cache.
This should also fix arm32 memory alignment issue.
[struct extent\_node] [struct rb\_entry]
[0] struct rb\_node rb\_node; [0] struct rb\_node rb\_node;
union { union {
struct { struct {
[16] unsigned int fofs; [12] unsigned int ofs;
unsigned int len; unsigned int len;
};
unsigned long long key;
} \_\_packed;
Cc:
Fixes: 13054c548a1c ("f2fs: introduce infra macro and data structure of rb-tree extent cache")
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 6d04f277d01d9e46d61e39d9c4d56631bafea86f
Author: Jaegeuk Kim
Date: Fri Mar 10 11:12:35 2023 -0800
f2fs: factor out discard\_cmd usage from general rb\_tree use
commit f69475dd4878e5f2e316a6573044d55f294baa51 upstream.
This is a second part to remove the mixed use of rb\_tree in discard\_cmd from
extent\_cache.
This should also fix arm32 memory alignment issue caused by shared rb\_entry.
[struct discard\_cmd] [struct rb\_entry]
[0] struct rb\_node rb\_node; [0] struct rb\_node rb\_node;
union { union {
struct { struct {
[16] block\_t lstart; [12] unsigned int ofs;
block\_t len; unsigned int len;
};
unsigned long long key;
} \_\_packed;
Cc:
Fixes: 004b68621897 ("f2fs: use rb-tree to track pending discard commands")
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 72f9a761b03514b66610e94022e4a70756b488b4
Author: Jaegeuk Kim
Date: Fri Mar 10 10:04:26 2023 -0800
f2fs: factor out victim\_entry usage from general rb\_tree use
commit 043d2d00b44310f84c0593c63e51fae88c829cdd upstream.
Let's reduce the complexity of mixed use of rb\_tree in victim\_entry from
extent\_cache and discard\_cmd.
This should fix arm32 memory alignment issue caused by shared rb\_entry.
[struct victim\_entry] [struct rb\_entry]
[0] struct rb\_node rb\_node; [0] struct rb\_node rb\_node;
union {
struct {
unsigned int ofs;
unsigned int len;
};
[16] unsigned long long mtime; [12] unsigned long long key;
} \_\_packed;
Cc:
Fixes: 093749e296e2 ("f2fs: support age threshold based garbage collection")
Reviewed-by: Chao Yu
Signed-off-by: Jaegeuk Kim
Signed-off-by: Greg Kroah-Hartman
commit 6e6df8bc3dc0187c49e2677340231703be0239cb
Author: Jani Nikula
Date: Thu Apr 6 16:46:14 2023 +0300
drm/dsc: fix drm\_edp\_dsc\_sink\_output\_bpp() DPCD high byte usage
commit 13525645e2246ebc8a21bd656248d86022a6ee8f upstream.
The operator precedence between << and & is wrong, leading to the high
byte being completely ignored. For example, with the 6.4 format, 32
becomes 0 and 24 becomes 8. Fix it, and remove the slightly confusing
and unnecessary DP\_DSC\_MAX\_BITS\_PER\_PIXEL\_HI\_SHIFT macro while at it.
Fixes: 0575650077ea ("drm/dp: DRM DP helper/macros to get DP sink DSC parameters")
Cc: Stanislav Lisovskiy
Cc: Manasi Navare
Cc: Anusha Srivatsa
Cc:  # v5.0+
Signed-off-by: Jani Nikula
Reviewed-by: Ankit Nautiyal
Link: https://patchwork.freedesktop.org/patch/msgid/20230406134615.1422509-1-jani.nikula@intel.com
Signed-off-by: Greg Kroah-Hartman
commit fb4726500548510cdb5b3d3c8ec5a806ba8f3c54
Author: Hans de Goede
Date: Tue Apr 25 21:44:41 2023 +0200
drm/i915/dsi: Use unconditional msleep() instead of intel\_dsi\_msleep()
commit c8c2969bfcba5fcba3a5b078315c1b586d927d9f upstream.
The intel\_dsi\_msleep() helper skips sleeping if the MIPI-sequences have
a version of 3 or newer and the panel is in vid-mode.
This is based on the big comment around line 730 which starts with
"Panel enable/disable sequences from the VBT spec.", where
the "v3 video mode seq" column does not have any wait t# entries.
Checking the Windows driver shows that it does always honor
the VBT delays independent of the version of the VBT sequences.
Commit 6fdb335f1c9c ("drm/i915/dsi: Use unconditional msleep for
the panel\_on\_delay when there is no reset-deassert MIPI-sequence")
switched to a direct msleep() instead of intel\_dsi\_msleep()
when there is no MIPI\_SEQ\_DEASSERT\_RESET sequence, to fix
the panel on an Acer Aspire Switch 10 E SW3-016 not turning on.
And now testing on a Nextbook Ares 8A shows that panel\_on\_delay
must always be honored otherwise the panel will not turn on.
Instead of only always using regular msleep() for panel\_on\_delay
do as Windows does and always use regular msleep() everywhere
were intel\_dsi\_msleep() is used and drop the intel\_dsi\_msleep()
helper.
Changes in v2:
- Replace all intel\_dsi\_msleep() calls instead of just
the intel\_dsi\_msleep(panel\_on\_delay) call
Cc: stable@vger.kernel.org
Fixes: 6fdb335f1c9c ("drm/i915/dsi: Use unconditional msleep for the panel\_on\_delay when there is no reset-deassert MIPI-sequence")
Signed-off-by: Hans de Goede
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20230425194441.68086-1-hdegoede@redhat.com
(cherry picked from commit fa83c12132f71302f7d4b02758dc0d46048d3f5f)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 9a2ca2d932cf17e2f7e06dce49cfc886d8217e6e
Author: Ville Syrjälä
Date: Tue Apr 18 20:55:14 2023 +0300
drm/i915: Check pipe source size when using skl+ scalers
commit d944eafed618a8507270b324ad9d5405bb7f0b3e upstream.
The skl+ scalers only sample 12 bits of PIPESRC so we can't
do any plane scaling at all when the pipe source size is >4k.
Make sure the pipe source size is also below the scaler's src
size limits. Might not be 100% accurate, but should at least be
safe. We can refine the limits later if we discover that recent
hw is less restricted.
Cc: stable@vger.kernel.org
Tested-by: Ross Zwisler
Closes: https://gitlab.freedesktop.org/drm/intel/-/issues/8357
Signed-off-by: Ville Syrjälä
Link: https://patchwork.freedesktop.org/patch/msgid/20230418175528.13117-2-ville.syrjala@linux.intel.com
Reviewed-by: Jani Nikula
(cherry picked from commit 691248d4135fe3fae64b4ee0676bc96a7fd6950c)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 8551c4b7c8ffb42f759547e5c39da5980abf2432
Author: Johan Hovold
Date: Mon Mar 6 11:07:20 2023 +0100
drm/msm: fix workqueue leak on bind errors
commit a75b49db6529b2af049eafd938fae888451c3685 upstream.
Make sure to destroy the workqueue also in case of early errors during
bind (e.g. a subcomponent failing to bind).
Since commit c3b790ea07a1 ("drm: Manage drm\_mode\_config\_init with
drmm\_") the mode config will be freed when the drm device is released
also when using the legacy interface, but add an explicit cleanup for
consistency and to facilitate backporting.
Fixes: 060530f1ea67 ("drm/msm: use componentised device support")
Cc: stable@vger.kernel.org # 3.15
Cc: Rob Clark
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525093/
Link: https://lore.kernel.org/r/20230306100722.28485-9-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 9b92dc722a5dfc5b45aa89c532e0dbe3295c6c6e
Author: Johan Hovold
Date: Mon Mar 6 11:07:19 2023 +0100
drm/msm: fix missing wq allocation error handling
commit ca090c837b430752038b24e56dd182010d77f6f6 upstream.
Add the missing sanity check to handle workqueue allocation failures.
Fixes: c8afe684c95c ("drm/msm: basic KMS driver for snapdragon")
Cc: stable@vger.kernel.org # 3.12
Cc: Rob Clark
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525102/
Link: https://lore.kernel.org/r/20230306100722.28485-8-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit e3401e07ba98a94b978164b7e873c25e5fc82b4b
Author: Johan Hovold
Date: Mon Mar 6 11:07:18 2023 +0100
drm/msm: fix vram leak on bind errors
commit 60d476af96015891c7959f30838ae7a9749932bf upstream.
Make sure to release the VRAM buffer also in a case a subcomponent fails
to bind.
Fixes: d863f0c7b536 ("drm/msm: Call msm\_init\_vram before binding the gpu")
Cc: stable@vger.kernel.org # 5.11
Cc: Craig Tatlor
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525094/
Link: https://lore.kernel.org/r/20230306100722.28485-7-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 514b189bb3813445b19ea1b4c67fc85e1c0b9643
Author: Johan Hovold
Date: Mon Mar 6 11:07:17 2023 +0100
drm/msm: fix drm device leak on bind errors
commit 214b09db61978497df24efcb3959616814bca46b upstream.
Make sure to free the DRM device also in case of early errors during
bind().
Fixes: 2027e5b3413d ("drm/msm: Initialize MDSS irq domain at probe time")
Cc: stable@vger.kernel.org # 5.17
Cc: Dmitry Baryshkov
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525097/
Link: https://lore.kernel.org/r/20230306100722.28485-6-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 72092e34742e8b34accdadfa7bd9a13cf255a531
Author: Johan Hovold
Date: Mon Mar 6 11:07:16 2023 +0100
drm/msm: fix NULL-deref on irq uninstall
commit cd459c005de3e2b855a8cc7768e633ce9d018e9f upstream.
In case of early initialisation errors and on platforms that do not use
the DPU controller, the deinitilisation code can be called with the kms
pointer set to NULL.
Fixes: f026e431cf86 ("drm/msm: Convert to Linux IRQ interfaces")
Cc: stable@vger.kernel.org # 5.14
Cc: Thomas Zimmermann
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525104/
Link: https://lore.kernel.org/r/20230306100722.28485-5-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 19fe79ae816a7e3400df1eb4d27530bf9b8ae258
Author: Johan Hovold
Date: Mon Mar 6 11:07:15 2023 +0100
drm/msm: fix NULL-deref on snapshot tear down
commit a465353b9250802f87b97123e33a17f51277f0b1 upstream.
In case of early initialisation errors and on platforms that do not use
the DPU controller, the deinitilisation code can be called with the kms
pointer set to NULL.
Fixes: 98659487b845 ("drm/msm: add support to take dpu snapshot")
Cc: stable@vger.kernel.org # 5.14
Cc: Abhinav Kumar
Signed-off-by: Johan Hovold
Reviewed-by: Dmitry Baryshkov
Patchwork: https://patchwork.freedesktop.org/patch/525099/
Link: https://lore.kernel.org/r/20230306100722.28485-4-johan+linaro@kernel.org
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Greg Kroah-Hartman
commit 0f68be59fabef0f6264ecd3964c7e63cf05ef0ff
Author: Chaitanya Kumar Borah
Date: Thu Mar 30 20:31:04 2023 +0530
drm/i915/color: Fix typo for Plane CSC indexes
commit 2efc8e1001acfdc143cf2d25a08a4974c322e2a8 upstream.
Replace \_PLANE\_INPUT\_CSC\_RY\_GY\_2\_\* with \_PLANE\_CSC\_RY\_GY\_2\_\*
for Plane CSC
Fixes: 6eba56f64d5d ("drm/i915/pxp: black pixels on pxp disabled")
Cc:
Signed-off-by: Chaitanya Kumar Borah
Reviewed-by: Uma Shankar
Signed-off-by: Animesh Manna
Link: https://patchwork.freedesktop.org/patch/msgid/20230330150104.2923519-1-chaitanya.kumar.borah@intel.com
(cherry picked from commit e39c76b2160bbd005587f978d29603ef790aefcd)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 5e6ceb1a6a9491785a198ed4b24ac4bb03fd18e2
Author: Francesco Dolcini
Date: Thu Mar 30 11:31:31 2023 +0200
drm/bridge: lt8912b: Fix DSI Video Mode
commit f435b7ef3b360d689df2ffa8326352cd07940d92 upstream.
LT8912 DSI port supports only Non-Burst mode video operation with Sync
Events and continuous clock on clock lane, correct dsi mode flags
according to that removing MIPI\_DSI\_MODE\_VIDEO\_BURST flag.
Cc:
Fixes: 30e2ae943c26 ("drm/bridge: Introduce LT8912B DSI to HDMI bridge")
Signed-off-by: Francesco Dolcini
Reviewed-by: Robert Foss
Signed-off-by: Robert Foss
Link: https://patchwork.freedesktop.org/patch/msgid/20230330093131.424828-1-francesco@dolcini.it
Signed-off-by: Greg Kroah-Hartman
commit b8de0c4def919ee6138e2f1cd244f4329d763f76
Author: Johan Hovold
Date: Fri Mar 3 17:48:05 2023 +0100
drm/msm/adreno: fix runtime PM imbalance at gpu load
commit 0d997f95b70f98987ae031a89677c13e0e223670 upstream.
A recent commit moved enabling of runtime PM to GPU load time (first
open()) but failed to update the error paths so that runtime PM is
disabled if initialisation of the GPU fails. This would trigger a
warning about the unbalanced disable count on the next open() attempt.
Note that pm\_runtime\_put\_noidle() is sufficient to balance the usage
count when pm\_runtime\_put\_sync() fails (and is chosen over
pm\_runtime\_resume\_and\_get() for consistency reasons).
Fixes: 4b18299b3365 ("drm/msm/adreno: Defer enabling runpm until hw\_init()")
Cc: stable@vger.kernel.org # 6.0
Signed-off-by: Johan Hovold
Patchwork: https://patchwork.freedesktop.org/patch/524971/
Link: https://lore.kernel.org/r/20230303164807.13124-3-johan+linaro@kernel.org
Signed-off-by: Rob Clark
Signed-off-by: Greg Kroah-Hartman
commit ae0bb54155052c82ec4f7d30cf284e911a4ae096
Author: Zev Weiss
Date: Thu Feb 23 16:03:58 2023 -0800
ARM: dts: aspeed: romed8hm3: Fix GPIO polarity of system-fault LED
commit a3fd10732d276d7cf372c6746a78a1c8b6aa7541 upstream.
Turns out it's in fact not the same as the heartbeat LED.
Signed-off-by: Zev Weiss
Cc: stable@vger.kernel.org # v5.18+
Fixes: a9a3d60b937a ("ARM: dts: aspeed: Add ASRock ROMED8HM3 BMC")
Link: https://lore.kernel.org/r/20230224000400.12226-2-zev@bewilderbeest.net
Signed-off-by: Joel Stanley
Signed-off-by: Greg Kroah-Hartman
commit f39914f88afb99dd7802072f6dbf1f261038e1e8
Author: Krzysztof Kozlowski
Date: Sun Feb 12 19:58:18 2023 +0100
ARM: dts: s5pv210: correct MIPI CSIS clock name
commit 665b9459bb53b8f19bd1541567e1fe9782c83c4b upstream.
The Samsung S5P/Exynos MIPI CSIS bindings and Linux driver expect first
clock name to be "csis". Otherwise the driver fails to probe.
Fixes: 94ad0f6d9278 ("ARM: dts: Add Device tree for s5pv210 SoC")
Cc:
Link: https://lore.kernel.org/r/20230212185818.43503-2-krzysztof.kozlowski@linaro.org
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Greg Kroah-Hartman
commit 99b7337f08a31715a67d4a8d08c453b136bd23c4
Author: Krzysztof Kozlowski
Date: Fri Feb 17 16:06:27 2023 +0100
ARM: dts: exynos: fix WM8960 clock name in Itop Elite
commit 6c950c20da38debf1ed531e0b972bd8b53d1c11f upstream.
The WM8960 Linux driver expects the clock to be named "mclk". Otherwise
the clock will be ignored and not prepared/enabled by the driver.
Cc:
Fixes: 339b2fb36a67 ("ARM: dts: exynos: Add TOPEET itop elite based board")
Link: https://lore.kernel.org/r/20230217150627.779764-3-krzysztof.kozlowski@linaro.org
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: Greg Kroah-Hartman
commit 99d8415144b8011c68e6568f459b2004ec0e733e
Author: Zev Weiss
Date: Thu Feb 23 16:04:00 2023 -0800
ARM: dts: aspeed: asrock: Correct firmware flash SPI clocks
commit 9dedb724446913ea7b1591b4b3d2e3e909090980 upstream.
While I'm not aware of any problems that have occurred running these
at 100 MHz, the official word from ASRock is that 50 MHz is the
correct speed to use, so let's be safe and use that instead.
Signed-off-by: Zev Weiss
Cc: stable@vger.kernel.org
Fixes: 2b81613ce417 ("ARM: dts: aspeed: Add ASRock E3C246D4I BMC")
Fixes: a9a3d60b937a ("ARM: dts: aspeed: Add ASRock ROMED8HM3 BMC")
Link: https://lore.kernel.org/r/20230224000400.12226-4-zev@bewilderbeest.net
Signed-off-by: Joel Stanley
Signed-off-by: Greg Kroah-Hartman
commit 324fb783d2e751d10fb4322e03bb04dadbb7112f
Author: Luis Chamberlain
Date: Thu Mar 2 12:28:18 2023 -0800
sysctl: clarify register\_sysctl\_init() base directory order
commit 228b09de936395ddd740df3522ea35ae934830d8 upstream.
Relatively new docs which I added which hinted the base directories needed
to be created before is wrong, remove that incorrect comment. This has been
hinted before by Eric twice already [0] [1], I had just not verified that
until now. Now that I've verified that updates the docs to relax the context
described.
[0] https://lkml.kernel.org/r/875ys0azt8.fsf@email.froward.int.ebiederm.org
[1] https://lkml.kernel.org/r/87ftbiud6s.fsf@x220.int.ebiederm.org
Cc: stable@vger.kernel.org # v5.17
Cc: Christian Brauner
Cc: Kefeng Wang
Suggested-by: Eric W. Biederman
Signed-off-by: Luis Chamberlain
Signed-off-by: Greg Kroah-Hartman
commit 898ee6c0b999c9c0525d8cd9ee89602487e9988a
Author: Mathieu Poirier
Date: Mon Mar 20 16:18:24 2023 -0600
remoteproc: rcar\_rproc: Call of\_node\_put() on iteration error
commit f8bae637d3d5e082b4ced71e28b16eb3ee0683c1 upstream.
Function of\_phandle\_iterator\_next() calls of\_node\_put() on the last
device\_node it iterated over, but when the loop exits prematurely it has
to be called explicitly.
Fixes: 285892a74f13 ("remoteproc: Add Renesas rcar driver")
Cc: stable@vger.kernel.org
Signed-off-by: Mathieu Poirier
Link: https://lore.kernel.org/r/20230320221826.2728078-4-mathieu.poirier@linaro.org
Signed-off-by: Mathieu Poirier
Signed-off-by: Greg Kroah-Hartman
commit 3f3abe8a04d99919a23f3898890c9ede3b78b979
Author: Mathieu Poirier
Date: Mon Mar 20 16:18:25 2023 -0600
remoteproc: imx\_rproc: Call of\_node\_put() on iteration error
commit 5ef074e805ecfd9a16dbb7b6b88bbfa8abad7054 upstream.
Function of\_phandle\_iterator\_next() calls of\_node\_put() on the last
device\_node it iterated over, but when the loop exits prematurely it has
to be called explicitly.
Fixes: b29b4249f8f0 ("remoteproc: imx\_rproc: add i.MX specific parse fw hook")
Cc: stable@vger.kernel.org
Signed-off-by: Mathieu Poirier
Reviewed-by: Peng Fan
Link: https://lore.kernel.org/r/20230320221826.2728078-5-mathieu.poirier@linaro.org
Signed-off-by: Mathieu Poirier
Signed-off-by: Greg Kroah-Hartman
commit db9296341c98b205a67e13ba0b66f835bc59cfd6
Author: Mathieu Poirier
Date: Mon Mar 20 16:18:26 2023 -0600
remoteproc: imx\_dsp\_rproc: Call of\_node\_put() on iteration error
commit e0e01de8ee146986872e54e8365f4b4654819412 upstream.
Function of\_phandle\_iterator\_next() calls of\_node\_put() on the last
device\_node it iterated over, but when the loop exits prematurely it has
to be called explicitly.
Fixes: ec0e5549f358 ("remoteproc: imx\_dsp\_rproc: Add remoteproc driver for DSP on i.MX")
Cc: stable@vger.kernel.org
Signed-off-by: Mathieu Poirier
Acked-by: Shengjiu Wang
Link: https://lore.kernel.org/r/20230320221826.2728078-6-mathieu.poirier@linaro.org
Signed-off-by: Mathieu Poirier
Signed-off-by: Greg Kroah-Hartman
commit 23ae1fea571730a7b23d548d88034615f0e99265
Author: Mathieu Poirier
Date: Mon Mar 20 16:18:23 2023 -0600
remoteproc: st: Call of\_node\_put() on iteration error
commit 8a74918948b40317a5b5bab9739d13dcb5de2784 upstream.
Function of\_phandle\_iterator\_next() calls of\_node\_put() on the last
device\_node it iterated over, but when the loop exits prematurely it has
to be called explicitly.
Fixes: 3df52ed7f269 ("remoteproc: st: add reserved memory support")
Cc: stable@vger.kernel.org
Signed-off-by: Mathieu Poirier
Reviewed-by: Arnaud Pouliquen
Link: https://lore.kernel.org/r/20230320221826.2728078-3-mathieu.poirier@linaro.org
Signed-off-by: Mathieu Poirier
Signed-off-by: Greg Kroah-Hartman
commit 6b43e2246a440d395619daddd2b31d50b71eadd8
Author: Mathieu Poirier
Date: Mon Mar 20 16:18:22 2023 -0600
remoteproc: stm32: Call of\_node\_put() on iteration error
commit ccadca5baf5124a880f2bb50ed1ec265415f025b upstream.
Function of\_phandle\_iterator\_next() calls of\_node\_put() on the last
device\_node it iterated over, but when the loop exits prematurely it has
to be called explicitly.
Fixes: 13140de09cc2 ("remoteproc: stm32: add an ST stm32\_rproc driver")
Cc: stable@vger.kernel.org
Signed-off-by: Mathieu Poirier
Reviewed-by: Arnaud Pouliquen
Link: https://lore.kernel.org/r/20230320221826.2728078-2-mathieu.poirier@linaro.org
Signed-off-by: Mathieu Poirier
Signed-off-by: Greg Kroah-Hartman
commit a60bf98ec063e3e127eaeeacbea2cf8988a8f5a1
Author: Luis Chamberlain
Date: Fri Mar 10 13:00:16 2023 -0800
proc\_sysctl: enhance documentation
commit 1dc8689e4cc651e21566e10206a84c4006e81fb1 upstream.
Expand documentation to clarify:
o that paths don't need to exist for the new API callers
o clarify that we \*require\* callers to keep the memory of
the table around during the lifetime of the sysctls
o annotate routines we are trying to deprecate and later remove
Cc: stable@vger.kernel.org # v5.17
Cc: Christian Brauner
Cc: Kefeng Wang
Signed-off-by: Luis Chamberlain
Signed-off-by: Greg Kroah-Hartman
commit e867cc98be37ba2caed8e30803c72d8ea0527927
Author: Luis Chamberlain
Date: Thu Mar 2 12:28:16 2023 -0800
proc\_sysctl: update docs for \_\_register\_sysctl\_table()
commit 67ff32289acad9ed338cd9f2351b44939e55163e upstream.
Update the docs for \_\_register\_sysctl\_table() to make it clear no child
entries can be passed. When the child is true these are non-leaf entries
on the ctl table and sysctl treats these as directories. The point to
\_\_register\_sysctl\_table() is to deal only with directories not part of
the ctl table where thay may riside, to be simple and avoid recursion.
While at it, hint towards using long on extra1 and extra2 later.
Cc: stable@vger.kernel.org # v5.17
Cc: Christian Brauner
Cc: Kefeng Wang
Signed-off-by: Luis Chamberlain
Signed-off-by: Greg Kroah-Hartman
commit 6219c6aef79559e5356a23d617c965f5939185f5
Author: Randy Dunlap
Date: Sun Mar 5 20:00:32 2023 -0800
sh: nmi\_debug: fix return value of \_\_setup handler
commit d1155e4132de712a9d3066e2667ceaad39a539c5 upstream.
\_\_setup() handlers should return 1 to obsolete\_checksetup() in
init/main.c to indicate that the boot option has been handled.
A return of 0 causes the boot option/value to be listed as an Unknown
kernel parameter and added to init's (limited) argument or environment
strings. Also, error return codes don't mean anything to
obsolete\_checksetup() -- only non-zero (usually 1) or zero.
So return 1 from nmi\_debug\_setup().
Fixes: 1e1030dccb10 ("sh: nmi\_debug support.")
Signed-off-by: Randy Dunlap
Reported-by: Igor Zhbanov
Link: lore.kernel.org/r/64644a2f-4a20-bab3-1e15-3b2cdd0defe3@omprussia.ru
Cc: John Paul Adrian Glaubitz
Cc: Yoshinori Sato
Cc: Rich Felker
Cc: linux-sh@vger.kernel.org
Cc: stable@vger.kernel.org
Reviewed-by: John Paul Adrian Glaubitz
Link: https://lore.kernel.org/r/20230306040037.20350-3-rdunlap@infradead.org
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Greg Kroah-Hartman
commit a789d79f1efb59b94b15839da3070be6967d4c54
Author: Randy Dunlap
Date: Sun Mar 5 20:00:33 2023 -0800
sh: init: use OF\_EARLY\_FLATTREE for early init
commit 6cba655543c7959f8a6d2979b9d40a6a66b7ed4f upstream.
When CONFIG\_OF\_EARLY\_FLATTREE and CONFIG\_SH\_DEVICE\_TREE are not set,
SH3 build fails with a call to early\_init\_dt\_scan(), so in
arch/sh/kernel/setup.c and arch/sh/kernel/head\_32.S, use
CONFIG\_OF\_EARLY\_FLATTREE instead of CONFIG\_OF\_FLATTREE.
Fixes this build error:
../arch/sh/kernel/setup.c: In function 'sh\_fdt\_init':
../arch/sh/kernel/setup.c:262:26: error: implicit declaration of function 'early\_init\_dt\_scan' [-Werror=implicit-function-declaration]
262 | if (!dt\_virt || !early\_init\_dt\_scan(dt\_virt)) {
Fixes: 03767daa1387 ("sh: fix build regression with CONFIG\_OF && !CONFIG\_OF\_FLATTREE")
Fixes: eb6b6930a70f ("sh: fix memory corruption of unflattened device tree")
Signed-off-by: Randy Dunlap
Suggested-by: Rob Herring
Cc: Frank Rowand
Cc: devicetree@vger.kernel.org
Cc: Rich Felker
Cc: Yoshinori Sato
Cc: Geert Uytterhoeven
Cc: John Paul Adrian Glaubitz
Cc: linux-sh@vger.kernel.org
Cc: stable@vger.kernel.org
Reviewed-by: John Paul Adrian Glaubitz
Link: https://lore.kernel.org/r/20230306040037.20350-4-rdunlap@infradead.org
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Greg Kroah-Hartman
commit ff546b8913b46e2c6a4b40acdf75dae32bf0a762
Author: Randy Dunlap
Date: Sun Mar 5 20:00:37 2023 -0800
sh: mcount.S: fix build error when PRINTK is not enabled
commit c2bd1e18c6f85c0027da2e5e7753b9bfd9f8e6dc upstream.
Fix a build error in mcount.S when CONFIG\_PRINTK is not enabled.
Fixes this build error:
sh2-linux-ld: arch/sh/lib/mcount.o: in function `stack\_panic':
(.text+0xec): undefined reference to `dump\_stack'
Fixes: e460ab27b6c3 ("sh: Fix up stack overflow check with ftrace disabled.")
Signed-off-by: Randy Dunlap
Cc: John Paul Adrian Glaubitz
Cc: Yoshinori Sato
Cc: Rich Felker
Suggested-by: Geert Uytterhoeven
Cc: stable@vger.kernel.org
Reviewed-by: John Paul Adrian Glaubitz
Link: https://lore.kernel.org/r/20230306040037.20350-8-rdunlap@infradead.org
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Greg Kroah-Hartman
commit 605cad5b1b8fc5893e8455bf01a2a2160701f44d
Author: Randy Dunlap
Date: Sun Mar 5 20:00:34 2023 -0800
sh: math-emu: fix macro redefined warning
commit 58a49ad90939386a8682e842c474a0d2c00ec39c upstream.
Fix a warning that was reported by the kernel test robot:
In file included from ../include/math-emu/soft-fp.h:27,
from ../arch/sh/math-emu/math.c:22:
../arch/sh/include/asm/sfp-machine.h:17: warning: "\_\_BYTE\_ORDER" redefined
17 | #define \_\_BYTE\_ORDER \_\_BIG\_ENDIAN
In file included from ../arch/sh/math-emu/math.c:21:
../arch/sh/math-emu/sfp-util.h:71: note: this is the location of the previous definition
71 | #define \_\_BYTE\_ORDER \_\_LITTLE\_ENDIAN
Fixes: b929926f01f2 ("sh: define \_\_BIG\_ENDIAN for math-emu")
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Link: lore.kernel.org/r/202111121827.6v6SXtVv-lkp@intel.com
Cc: John Paul Adrian Glaubitz
Cc: Yoshinori Sato
Cc: Rich Felker
Cc: linux-sh@vger.kernel.org
Reviewed-by: Geert Uytterhoeven
Cc: stable@vger.kernel.org
Reviewed-by: John Paul Adrian Glaubitz
Link: https://lore.kernel.org/r/20230306040037.20350-5-rdunlap@infradead.org
Signed-off-by: John Paul Adrian Glaubitz
Signed-off-by: Greg Kroah-Hartman
commit ded19bcba2bd8426a86cd238bf2a1be655a2cae8
Author: Steve French
Date: Tue May 9 01:00:42 2023 -0500
SMB3: force unmount was failing to close deferred close files
commit 2cb6f968775a9fd60c90a6042b9550bcec3ea087 upstream.
In investigating a failure with xfstest generic/392 it
was noticed that mounts were reusing a superblock that should
already have been freed. This turned out to be related to
deferred close files keeping a reference count until the
closetimeo expired.
Currently the only way an fs knows that mount is beginning is
when force unmount is called, but when this, ie umount\_begin(),
is called all deferred close files on the share (tree
connection) should be closed immediately (unless shared by
another mount) to avoid using excess resources on the server
and to avoid reusing a superblock which should already be freed.
In umount\_begin, close all deferred close handles for that
share if this is the last mount using that share on this
client (ie send the SMB3 close request over the wire for those
that have been already closed by the app but that we have
kept a handle lease open for and have not sent closes to the
server for yet).
Reported-by: David Howells
Acked-by: Bharath SM
Cc:
Fixes: 78c09634f7dc ("Cifs: Fix kernel oops caused by deferred close for files.")
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 61cb595f56c80e16e85951f6e2a341b5a9d9b2cf
Author: Steve French
Date: Tue May 9 01:37:19 2023 -0500
smb3: fix problem remounting a share after shutdown
commit 716a3cf317456fa01d54398bb14ab354f50ed6a2 upstream.
xfstests generic/392 showed a problem where even after a
shutdown call was made on a mount, we would still attempt
to use the (now inaccessible) superblock if another mount
was attempted for the same share.
Reported-by: David Howells
Reviewed-by: David Howells
Cc:
Fixes: 087f757b0129 ("cifs: add shutdown support")
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit a48bacee05860c6089c3482bcdc80720b0ee5732
Author: Jan Kara
Date: Mon Apr 24 18:32:19 2023 +0200
inotify: Avoid reporting event with invalid wd
commit c915d8f5918bea7c3962b09b8884ca128bfd9b0c upstream.
When inotify\_freeing\_mark() races with inotify\_handle\_inode\_event() it
can happen that inotify\_handle\_inode\_event() sees that i\_mark->wd got
already reset to -1 and reports this value to userspace which can
confuse the inotify listener. Avoid the problem by validating that wd is
sensible (and pretend the mark got removed before the event got
generated otherwise).
CC: stable@vger.kernel.org
Fixes: 7e790dd5fc93 ("inotify: fix error paths in inotify\_update\_watch")
Message-Id: <20230424163219.9250-1-jack@suse.cz>
Reported-by: syzbot+4a06d4373fd52f0b2f9c@syzkaller.appspotmail.com
Reviewed-by: Amir Goldstein
Signed-off-by: Jan Kara
Signed-off-by: Greg Kroah-Hartman
commit e47df7c5ddc25fbbea3cc1499fc4265c2cdfefc7
Author: Mark Pearson
Date: Fri May 5 09:25:23 2023 -0400
platform/x86: thinkpad\_acpi: Add profile force ability
commit 1684878952929e20a864af5df7b498941c750f45 upstream.
There has been a lot of confusion around which platform profiles are
supported on various platforms and it would be useful to have a debug
method to be able to override the profile mode that is selected.
I don't expect this to be used in anything other than debugging in
conjunction with Lenovo engineers - but it does give a way to get a
system working whilst we wait for either FW fixes, or a driver fix
to land upstream, if something is wonky in the mode detection logic
Signed-off-by: Mark Pearson
Link: https://lore.kernel.org/r/20230505132523.214338-2-mpearson-lenovo@squebb.ca
Cc: stable@vger.kernel.org
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit d8fdb9129abf66e4557085c0e936b9da68add1d3
Author: Andrey Avdeev
Date: Sun Apr 30 11:01:10 2023 +0300
platform/x86: touchscreen\_dmi: Add info for the Dexp Ursus KX210i
commit 4b65f95c87c35699bc6ad540d6b9dd7f950d0924 upstream.
Add touchscreen info for the Dexp Ursus KX210i
Signed-off-by: Andrey Avdeev
Link: https://lore.kernel.org/r/ZE4gRgzRQCjXFYD0@avdeevavpc
Cc: stable@vger.kernel.org
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 65ef5715837e445c46fcb0b265646d69f6c9ba00
Author: Fae
Date: Tue Apr 25 01:36:44 2023 -0500
platform/x86: hp-wmi: add micmute to hp\_wmi\_keymap struct
commit decab2825c3ef9b154c6f76bce40872ffb41c36f upstream.
Fixes micmute key of HP Envy X360 ey0xxx.
Signed-off-by: Fae
Link: https://lore.kernel.org/r/20230425063644.11828-1-faenkhauser@gmail.com
Cc: stable@vger.kernel.org
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 0fc765944effd065866bf7adbfeed2b57e52832d
Author: Mark Pearson
Date: Fri May 5 09:25:22 2023 -0400
platform/x86: thinkpad\_acpi: Fix platform profiles on T490
commit 0c0cd3e25a5b64b541dd83ba6e032475a9d77432 upstream.
I had incorrectly thought that PSC profiles were not usable on Intel
platforms so had blocked them in the driver initialistion. This broke
platform profiles on the T490.
After discussion with the FW team PSC does work on Intel platforms and
should be allowed.
Note - it's possible this may impact other platforms where it is advertised
but special driver support that only Windows has is needed. But if it does
then they will need fixing via quirks. Please report any issues to me so I
can get them addressed - but I haven't found any problems in testing...yet
Fixes: bce6243f767f ("platform/x86: thinkpad\_acpi: do not use PSC mode on Intel platforms")
Link: https://bugzilla.redhat.com/show\_bug.cgi?id=2177962
Cc: stable@vger.kernel.org
Signed-off-by: Mark Pearson
Link: https://lore.kernel.org/r/20230505132523.214338-1-mpearson-lenovo@squebb.ca
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 87a24df957bd0682eaaa68f50c96be76c9d4f372
Author: Hans de Goede
Date: Fri May 5 23:03:23 2023 +0200
platform/x86: touchscreen\_dmi: Add upside-down quirk for GDIX1002 ts on the Juno Tablet
commit 6abfa99ce52f61a31bcfc2aaaae09006f5665495 upstream.
The Juno Computers Juno Tablet has an upside-down mounted Goodix
touchscreen. Add a quirk to invert both axis to correct for this.
Link: https://junocomputers.com/us/product/juno-tablet/
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede
Link: https://lore.kernel.org/r/20230505210323.43177-1-hdegoede@redhat.com
Signed-off-by: Greg Kroah-Hartman
commit 9ae5c610cace186f5f14d60da9a4431ae1693288
Author: Srinivas Pandruvada
Date: Tue Apr 18 08:32:30 2023 -0700
platform/x86/intel-uncore-freq: Return error on write frequency
commit 75e406b540c3eca67625d97bbefd4e3787eafbfe upstream.
Currently when the uncore\_write() returns error, it is silently
ignored. Return error to user space when uncore\_write() fails.
Fixes: 49a474c7ba51 ("platform/x86: Add support for Uncore frequency control")
Signed-off-by: Srinivas Pandruvada
Reviewed-by: Zhang Rui
Tested-by: Wendy Wang
Reviewed-by: Ilpo Järvinen
Link: https://lore.kernel.org/r/20230418153230.679094-1-srinivas.pandruvada@linux.intel.com
Cc: stable@vger.kernel.org
Signed-off-by: Hans de Goede
Signed-off-by: Greg Kroah-Hartman
commit 177b9093efa8f69d4195e250af08875764d7bf42
Author: Steve French
Date: Wed May 10 17:42:21 2023 -0500
cifs: release leases for deferred close handles when freezing
commit d39fc592ef8ae9a89c5e85c8d9f760937a57d5ba upstream.
We should not be caching closed files when freeze is invoked on an fs
(so we can release resources more gracefully).
Fixes xfstests generic/068 generic/390 generic/491
Reviewed-by: David Howells
Cc:
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit 6c76dfb265217f80788aea9634d7c7ae8f5c7ca1
Author: Pawel Witek
Date: Fri May 5 17:14:59 2023 +0200
cifs: fix pcchunk length type in smb2\_copychunk\_range
commit d66cde50c3c868af7abddafce701bb86e4a93039 upstream.
Change type of pcchunk->Length from u32 to u64 to match
smb2\_copychunk\_range arguments type. Fixes the problem where performing
server-side copy with CIFS\_IOC\_COPYCHUNK\_FILE ioctl resulted in incomplete
copy of large files while returning -EINVAL.
Fixes: 9bf0c9cd4314 ("CIFS: Fix SMB2/SMB3 Copy offload support (refcopy) for large files")
Cc:
Signed-off-by: Pawel Witek
Signed-off-by: Steve French
Signed-off-by: Greg Kroah-Hartman
commit dee80752e1b259d9aed882da2f2617797cd3c625
Author: Filipe Manana
Date: Tue May 9 12:50:02 2023 +0100
btrfs: fix backref walking not returning all inode refs
commit 0cad8f14d70cfeb5173dce93cafeba665a95430e upstream.
When using the logical to ino ioctl v2, if the flag to ignore offsets of
file extent items (BTRFS\_LOGICAL\_INO\_ARGS\_IGNORE\_OFFSET) is given, the
backref walking code ends up not returning references for all file offsets
of an inode that point to the given logical bytenr. This happens since
kernel 6.2, commit 6ce6ba534418 ("btrfs: use a single argument for extent
offset in backref walking functions") because:
1) It mistakenly skipped the search for file extent items in a leaf that
point to the target extent if that flag is given. Instead it should
only skip the filtering done by check\_extent\_in\_eb() - that is, it
should not avoid the calls to that function (or find\_extent\_in\_eb(),
which uses it).
2) It was also not building a list of inode extent elements (struct
extent\_inode\_elem) if we have multiple inode references for an extent
when the ignore offset flag is given to the logical to ino ioctl - it
would leave a single element, only the last one that was found.
These stem from the confusing old interface for backref walking functions
where we had an extent item offset argument that was a pointer to a u64
and another boolean argument that indicated if the offset should be
ignored, but the pointer could be NULL. That NULL case is used by
relocation, qgroup extent accounting and fiemap, simply to avoid building
the inode extent list for each reference, as it's not necessary for those
use cases and therefore avoids memory allocations and some computations.
Fix this by adding a boolean argument to the backref walk context
structure to indicate that the inode extent list should not be built,
make relocation set that argument to true and fix the backref walking
logic to skip the calls to check\_extent\_in\_eb() and find\_extent\_in\_eb()
only if this new argument is true, instead of 'ignore\_extent\_item\_pos'
being true.
A test case for fstests will be added soon, to provide cover not only
for these cases but to the logical to ino ioctl in general as well, as
currently we do not have a test case for it.
Reported-by: Vladimir Panteleev
Link: https://lore.kernel.org/linux-btrfs/CAHhfkvwo=nmzrJSqZ2qMfF-rZB-ab6ahHnCD\_sq9h4o8v+M7QQ@mail.gmail.com/
Fixes: 6ce6ba534418 ("btrfs: use a single argument for extent offset in backref walking functions")
CC: stable@vger.kernel.org # 6.2+
Tested-by: Vladimir Panteleev
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit cd8cffa9d402eb25977dddc7db88c89b0ae8dbc3
Author: Naohiro Aota
Date: Tue May 9 18:29:15 2023 +0000
btrfs: zoned: fix full zone super block reading on ZNS
commit 02ca9e6fb5f66a031df4fac508b8e477ca69e918 upstream.
When both of the superblock zones are full, we need to check which
superblock is newer. The calculation of last superblock position is wrong
as it does not consider zone\_capacity and uses the length.
Fixes: 9658b72ef300 ("btrfs: zoned: locate superblock position using zone capacity")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Johannes Thumshirn
Signed-off-by: Naohiro Aota
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 0af493c79a6f931b78caf029ce31f19981ddc534
Author: Naohiro Aota
Date: Mon May 8 22:14:20 2023 +0000
btrfs: zoned: zone finish data relocation BG with last IO
commit f84353c7c20536ea7e01eca79430eccdf3cc7348 upstream.
For data block groups, we zone finish a zone (or, just deactivate it) when
seeing the last IO in btrfs\_finish\_ordered\_io(). That is only called for
IOs using ZONE\_APPEND, but we use a regular WRITE command for data
relocation IOs. Detect it and call btrfs\_zone\_finish\_endio() properly.
Fixes: be1a1d7a5d24 ("btrfs: zoned: finish fully written block group")
CC: stable@vger.kernel.org # 6.1+
Reviewed-by: Johannes Thumshirn
Signed-off-by: Naohiro Aota
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 573b38f8dff017d66d3ceabf7e1bf72fb66878f2
Author: Filipe Manana
Date: Thu May 4 12:04:18 2023 +0100
btrfs: fix space cache inconsistency after error loading it from disk
commit 0004ff15ea26015a0a3a6182dca3b9d1df32e2b7 upstream.
When loading a free space cache from disk, at \_\_load\_free\_space\_cache(),
if we fail to insert a bitmap entry, we still increment the number of
total bitmaps in the btrfs\_free\_space\_ctl structure, which is incorrect
since we failed to add the bitmap entry. On error we then empty the
cache by calling \_\_btrfs\_remove\_free\_space\_cache(), which will result
in getting the total bitmaps counter set to 1.
A failure to load a free space cache is not critical, so if a failure
happens we just rebuild the cache by scanning the extent tree, which
happens at block-group.c:caching\_thread(). Yet the failure will result
in having the total bitmaps of the btrfs\_free\_space\_ctl always bigger
by 1 then the number of bitmap entries we have. So fix this by having
the total bitmaps counter be incremented only if we successfully added
the bitmap entry.
Fixes: a67509c30079 ("Btrfs: add a io\_ctl struct and helpers for dealing with the space cache")
Reviewed-by: Anand Jain
CC: stable@vger.kernel.org # 4.4+
Signed-off-by: Filipe Manana
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 978eb480ae6ac05d339ddaf6a9d839092905476f
Author: Anastasia Belova
Date: Wed Apr 26 14:53:23 2023 +0300
btrfs: print-tree: parent bytenr must be aligned to sector size
commit c87f318e6f47696b4040b58f460d5c17ea0280e6 upstream.
Check nodesize to sectorsize in alignment check in print\_extent\_item.
The comment states that and this is correct, similar check is done
elsewhere in the functions.
Found by Linux Verification Center (linuxtesting.org) with SVACE.
Fixes: ea57788eb76d ("btrfs: require only sector size alignment for parent eb bytenr")
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Qu Wenruo
Signed-off-by: Anastasia Belova
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 11bd62688c807493316dd2bf95bf473328eac30e
Author: Qu Wenruo
Date: Fri Apr 28 14:13:05 2023 +0800
btrfs: make clear\_cache mount option to rebuild FST without disabling it
commit 1d6a4fc85717677e00fefffd847a50fc5928ce69 upstream.
Previously clear\_cache mount option would simply disable free-space-tree
feature temporarily then re-enable it to rebuild the whole free space
tree.
But this is problematic for block-group-tree feature, as we have an
artificial dependency on free-space-tree feature.
If we go the existing method, after clearing the free-space-tree
feature, we would flip the filesystem to read-only mode, as we detect a
super block write with block-group-tree but no free-space-tree feature.
This patch would change the behavior by properly rebuilding the free
space tree without disabling this feature, thus allowing clear\_cache
mount option to work with block group tree.
Now we can mount a filesystem with block-group-tree feature and
clear\_mount option:
$ mkfs.btrfs -O block-group-tree /dev/test/scratch1 -f
$ sudo mount /dev/test/scratch1 /mnt/btrfs -o clear\_cache
$ sudo dmesg -t | head -n 5
BTRFS info (device dm-1): force clearing of disk cache
BTRFS info (device dm-1): using free space tree
BTRFS info (device dm-1): auto enabling async discard
BTRFS info (device dm-1): rebuilding free space tree
BTRFS info (device dm-1): checking UUID tree
CC: stable@vger.kernel.org # 6.1+
Signed-off-by: Qu Wenruo
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 4484428b7ac33aa523d51d495eeeff52a84508d5
Author: Christoph Hellwig
Date: Mon May 8 07:58:37 2023 -0700
btrfs: zero the buffer before marking it dirty in btrfs\_redirty\_list\_add
commit c83b56d1dd87cf67492bb770c26d6f87aee70ed6 upstream.
btrfs\_redirty\_list\_add zeroes the buffer data and sets the
EXTENT\_BUFFER\_NO\_CHECK to make sure writeback is fine with a bogus
header. But it does that after already marking the buffer dirty, which
means that writeback could already be looking at the buffer.
Switch the order of operations around so that the buffer is only marked
dirty when we're ready to write it.
Fixes: d3575156f662 ("btrfs: zoned: redirty released extent buffers")
CC: stable@vger.kernel.org # 5.15+
Signed-off-by: Christoph Hellwig
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 478bd15f46b6e3aae78aac4f3788697f1546eea6
Author: Josef Bacik
Date: Tue May 2 16:00:06 2023 -0400
btrfs: don't free qgroup space unless specified
commit d246331b78cbef86237f9c22389205bc9b4e1cc1 upstream.
Boris noticed in his simple quotas testing that he was getting a leak
with Sweet Tea's change to subvol create that stopped doing a
transaction commit. This was just a side effect of that change.
In the delayed inode code we have an optimization that will free extra
reservations if we think we can pack a dir item into an already modified
leaf. Previously this wouldn't be triggered in the subvolume create
case because we'd commit the transaction, it was still possible but
much harder to trigger. It could actually be triggered if we did a
mkdir && subvol create with qgroups enabled.
This occurs because in btrfs\_insert\_delayed\_dir\_index(), which gets
called when we're adding the dir item, we do the following:
btrfs\_block\_rsv\_release(fs\_info, trans->block\_rsv, bytes, NULL);
if we're able to skip reserving space.
The problem here is that trans->block\_rsv points at the temporary block
rsv for the subvolume create, which has qgroup reservations in the block
rsv.
This is a problem because btrfs\_block\_rsv\_release() will do the
following:
if (block\_rsv->qgroup\_rsv\_reserved >= block\_rsv->qgroup\_rsv\_size) {
qgroup\_to\_release = block\_rsv->qgroup\_rsv\_reserved -
block\_rsv->qgroup\_rsv\_size;
block\_rsv->qgroup\_rsv\_reserved = block\_rsv->qgroup\_rsv\_size;
}
The temporary block rsv just has ->qgroup\_rsv\_reserved set,
->qgroup\_rsv\_size == 0. The optimization in
btrfs\_insert\_delayed\_dir\_index() sets ->qgroup\_rsv\_reserved = 0. Then
later on when we call btrfs\_subvolume\_release\_metadata() which has
btrfs\_block\_rsv\_release(fs\_info, rsv, (u64)-1, &qgroup\_to\_release);
btrfs\_qgroup\_convert\_reserved\_meta(root, qgroup\_to\_release);
qgroup\_to\_release is set to 0, and we do not convert the reserved
metadata space.
The problem here is that the block rsv code has been unconditionally
messing with ->qgroup\_rsv\_reserved, because the main place this is used
is delalloc, and any time we call btrfs\_block\_rsv\_release() we do it
with qgroup\_to\_release set, and thus do the proper accounting.
The subvolume code is the only other code that uses the qgroup
reservation stuff, but it's intermingled with the above optimization,
and thus was getting its reservation freed out from underneath it and
thus leaking the reserved space.
The solution is to simply not mess with the qgroup reservations if we
don't have qgroup\_to\_release set. This works with the existing code as
anything that messes with the delalloc reservations always have
qgroup\_to\_release set. This fixes the leak that Boris was observing.
Reviewed-by: Qu Wenruo
CC: stable@vger.kernel.org # 5.4+
Signed-off-by: Josef Bacik
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 9fd7199b7a1bfbecb7df64c0ca5219bc864c4506
Author: Boris Burkov
Date: Fri Apr 28 14:02:11 2023 -0700
btrfs: fix encoded write i\_size corruption with no-holes
commit e7db9e5c6b9615b287d01f0231904fbc1fbde9c5 upstream.
We have observed a btrfs filesystem corruption on workloads using
no-holes and encoded writes via send stream v2. The symptom is that a
file appears to be truncated to the end of its last aligned extent, even
though the final unaligned extent and even the file extent and otherwise
correctly updated inode item have been written.
So if we were writing out a 1MiB+X file via 8 128K extents and one
extent of length X, i\_size would be set to 1MiB, but the ninth extent,
nbyte, etc. would all appear correct otherwise.
The source of the race is a narrow (one line of code) window in which a
no-holes fs has read in an updated i\_size, but has not yet set a shared
disk\_i\_size variable to write. Therefore, if two ordered extents run in
parallel (par for the course for receive workloads), the following
sequence can play out: (following "threads" a bit loosely, since there
are callbacks involved for endio but extra threads aren't needed to
cause the issue)
ENC-WR1 (second to last) ENC-WR2 (last)
------- -------
btrfs\_do\_encoded\_write
set i\_size = 1M
submit bio B1 ending at 1M
endio B1
btrfs\_inode\_safe\_disk\_i\_size\_write
local i\_size = 1M
falls off a cliff for some reason
btrfs\_do\_encoded\_write
set i\_size = 1M+X
submit bio B2 ending at 1M+X
endio B2
btrfs\_inode\_safe\_disk\_i\_size\_write
local i\_size = 1M+X
disk\_i\_size = 1M+X
disk\_i\_size = 1M
btrfs\_delayed\_update\_inode
btrfs\_delayed\_update\_inode
And the delayed inode ends up filled with nbytes=1M+X and isize=1M, and
writes respect i\_size and present a corrupted file missing its last
extents.
Fix this by holding the inode lock in the no-holes case so that a thread
can't sneak in a write to disk\_i\_size that gets overwritten with an out
of date i\_size.
Fixes: 41a2ee75aab0 ("btrfs: introduce per-inode file extent tree")
CC: stable@vger.kernel.org # 5.10+
Reviewed-by: Josef Bacik
Signed-off-by: Boris Burkov
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 6062e9e335a3bf409b5118bfe4cc10aff4b6adb1
Author: xiaoshoukui
Date: Thu Apr 13 05:55:07 2023 -0400
btrfs: fix assertion of exclop condition when starting balance
commit ac868bc9d136cde6e3eb5de77019a63d57a540ff upstream.
Balance as exclusive state is compatible with paused balance and device
add, which makes some things more complicated. The assertion of valid
states when starting from paused balance needs to take into account two
more states, the combinations can be hit when there are several threads
racing to start balance and device add. This won't typically happen when
the commands are started from command line.
Scenario 1: With exclusive\_operation state == BTRFS\_EXCLOP\_NONE.
Concurrently adding multiple devices to the same mount point and
btrfs\_exclop\_finish executed finishes before assertion in
btrfs\_exclop\_balance, exclusive\_operation will changed to
BTRFS\_EXCLOP\_NONE state which lead to assertion failed:
fs\_info->exclusive\_operation == BTRFS\_EXCLOP\_BALANCE ||
fs\_info->exclusive\_operation == BTRFS\_EXCLOP\_DEV\_ADD,
in fs/btrfs/ioctl.c:456
Call Trace:
btrfs\_exclop\_balance+0x13c/0x310
? memdup\_user+0xab/0xc0
? PTR\_ERR+0x17/0x20
btrfs\_ioctl\_add\_dev+0x2ee/0x320
btrfs\_ioctl+0x9d5/0x10d0
? btrfs\_ioctl\_encoded\_write+0xb80/0xb80
\_\_x64\_sys\_ioctl+0x197/0x210
do\_syscall\_64+0x3c/0xb0
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Scenario 2: With exclusive\_operation state == BTRFS\_EXCLOP\_BALANCE\_PAUSED.
Concurrently adding multiple devices to the same mount point and
btrfs\_exclop\_balance executed finish before the latter thread execute
assertion in btrfs\_exclop\_balance, exclusive\_operation will changed to
BTRFS\_EXCLOP\_BALANCE\_PAUSED state which lead to assertion failed:
fs\_info->exclusive\_operation == BTRFS\_EXCLOP\_BALANCE ||
fs\_info->exclusive\_operation == BTRFS\_EXCLOP\_DEV\_ADD ||
fs\_info->exclusive\_operation == BTRFS\_EXCLOP\_NONE,
fs/btrfs/ioctl.c:458
Call Trace:
btrfs\_exclop\_balance+0x240/0x410
? memdup\_user+0xab/0xc0
? PTR\_ERR+0x17/0x20
btrfs\_ioctl\_add\_dev+0x2ee/0x320
btrfs\_ioctl+0x9d5/0x10d0
? btrfs\_ioctl\_encoded\_write+0xb80/0xb80
\_\_x64\_sys\_ioctl+0x197/0x210
do\_syscall\_64+0x3c/0xb0
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
An example of the failed assertion is below, which shows that the
paused balance is also needed to be checked.
root@syzkaller:/home/xsk# ./repro
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
[ 416.611428][ T7970] BTRFS info (device loop0): fs\_info exclusive\_operation: 0
Failed to add device /dev/vda, errno 14
[ 416.613973][ T7971] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.615456][ T7972] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.617528][ T7973] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.618359][ T7974] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.622589][ T7975] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.624034][ T7976] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.626420][ T7977] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.627643][ T7978] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.629006][ T7979] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
[ 416.630298][ T7980] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
Failed to add device /dev/vda, errno 14
[ 416.632787][ T7981] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.634282][ T7982] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
Failed to add device /dev/vda, errno 14
[ 416.636202][ T7983] BTRFS info (device loop0): fs\_info exclusive\_operation: 3
[ 416.637012][ T7984] BTRFS info (device loop0): fs\_info exclusive\_operation: 1
Failed to add device /dev/vda, errno 14
[ 416.637759][ T7984] assertion failed: fs\_info->exclusive\_operation ==
BTRFS\_EXCLOP\_BALANCE || fs\_info->exclusive\_operation ==
BTRFS\_EXCLOP\_DEV\_ADD || fs\_info->exclusive\_operation ==
BTRFS\_EXCLOP\_NONE, in fs/btrfs/ioctl.c:458
[ 416.639845][ T7984] invalid opcode: 0000 [#1] PREEMPT SMP KASAN
[ 416.640485][ T7984] CPU: 0 PID: 7984 Comm: repro Not tainted 6.2.0 #7
[ 416.641172][ T7984] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
[ 416.642090][ T7984] RIP: 0010:btrfs\_assertfail+0x2c/0x2e
[ 416.644423][ T7984] RSP: 0018:ffffc90003ea7e28 EFLAGS: 00010282
[ 416.645018][ T7984] RAX: 00000000000000cc RBX: 0000000000000000 RCX: 0000000000000000
[ 416.645763][ T7984] RDX: ffff88801d030000 RSI: ffffffff81637e7c RDI: fffff520007d4fb7
[ 416.646554][ T7984] RBP: ffffffff8a533de0 R08: 00000000000000cc R09: 0000000000000000
[ 416.647299][ T7984] R10: 0000000000000001 R11: 0000000000000001 R12: ffffffff8a533da0
[ 416.648041][ T7984] R13: 00000000000001ca R14: 000000005000940a R15: 0000000000000000
[ 416.648785][ T7984] FS: 00007fa2985d4640(0000) GS:ffff88802cc00000(0000) knlGS:0000000000000000
[ 416.649616][ T7984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 416.650238][ T7984] CR2: 0000000000000000 CR3: 0000000018e5e000 CR4: 0000000000750ef0
[ 416.650980][ T7984] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 416.651725][ T7984] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 416.652502][ T7984] PKRU: 55555554
[ 416.652888][ T7984] Call Trace:
[ 416.653241][ T7984]
[ 416.653527][ T7984] btrfs\_exclop\_balance+0x240/0x410
[ 416.654036][ T7984] ? memdup\_user+0xab/0xc0
[ 416.654465][ T7984] ? PTR\_ERR+0x17/0x20
[ 416.654874][ T7984] btrfs\_ioctl\_add\_dev+0x2ee/0x320
[ 416.655380][ T7984] btrfs\_ioctl+0x9d5/0x10d0
[ 416.655822][ T7984] ? btrfs\_ioctl\_encoded\_write+0xb80/0xb80
[ 416.656400][ T7984] \_\_x64\_sys\_ioctl+0x197/0x210
[ 416.656874][ T7984] do\_syscall\_64+0x3c/0xb0
[ 416.657346][ T7984] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 416.657922][ T7984] RIP: 0033:0x4546af
[ 416.660170][ T7984] RSP: 002b:00007fa2985d4150 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[ 416.660972][ T7984] RAX: ffffffffffffffda RBX: 00007fa2985d4640 RCX: 00000000004546af
[ 416.661714][ T7984] RDX: 0000000000000000 RSI: 000000005000940a RDI: 0000000000000003
[ 416.662449][ T7984] RBP: 00007fa2985d41d0 R08: 0000000000000000 R09: 00007ffee37a4c4f
[ 416.663195][ T7984] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fa2985d4640
[ 416.663951][ T7984] R13: 0000000000000009 R14: 000000000041b320 R15: 00007fa297dd4000
[ 416.664703][ T7984]
[ 416.665040][ T7984] Modules linked in:
[ 416.665590][ T7984] ---[ end trace 0000000000000000 ]---
[ 416.666176][ T7984] RIP: 0010:btrfs\_assertfail+0x2c/0x2e
[ 416.668775][ T7984] RSP: 0018:ffffc90003ea7e28 EFLAGS: 00010282
[ 416.669425][ T7984] RAX: 00000000000000cc RBX: 0000000000000000 RCX: 0000000000000000
[ 416.670235][ T7984] RDX: ffff88801d030000 RSI: ffffffff81637e7c RDI: fffff520007d4fb7
[ 416.671050][ T7984] RBP: ffffffff8a533de0 R08: 00000000000000cc R09: 0000000000000000
[ 416.671867][ T7984] R10: 0000000000000001 R11: 0000000000000001 R12: ffffffff8a533da0
[ 416.672685][ T7984] R13: 00000000000001ca R14: 000000005000940a R15: 0000000000000000
[ 416.673501][ T7984] FS: 00007fa2985d4640(0000) GS:ffff88802cc00000(0000) knlGS:0000000000000000
[ 416.674425][ T7984] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 416.675114][ T7984] CR2: 0000000000000000 CR3: 0000000018e5e000 CR4: 0000000000750ef0
[ 416.675933][ T7984] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 416.676760][ T7984] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Link: https://lore.kernel.org/linux-btrfs/20230324031611.98986-1-xiaoshoukui@gmail.com/
CC: stable@vger.kernel.org # 6.1+
Signed-off-by: xiaoshoukui
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit dc0072dd5d28027a81a5b5644ddc71668c07df07
Author: Qu Wenruo
Date: Thu Apr 27 09:45:32 2023 +0800
btrfs: properly reject clear\_cache and v1 cache for block-group-tree
commit 64b5d5b2852661284ccbb038c697562cc56231bf upstream.
[BUG]
With block-group-tree feature enabled, mounting it with clear\_cache
would cause the following transaction abort at mount or remount:
BTRFS info (device dm-4): force clearing of disk cache
BTRFS info (device dm-4): using free space tree
BTRFS info (device dm-4): auto enabling async discard
BTRFS info (device dm-4): clearing free space tree
BTRFS info (device dm-4): clearing compat-ro feature flag for FREE\_SPACE\_TREE (0x1)
BTRFS info (device dm-4): clearing compat-ro feature flag for FREE\_SPACE\_TREE\_VALID (0x2)
BTRFS error (device dm-4): block-group-tree feature requires fres-space-tree and no-holes
BTRFS error (device dm-4): super block corruption detected before writing it to disk
BTRFS: error (device dm-4) in write\_all\_supers:4288: errno=-117 Filesystem corrupted (unexpected superblock corruption detected)
BTRFS warning (device dm-4: state E): Skipping commit of aborted transaction.
[CAUSE]
For block-group-tree feature, we have an artificial dependency on
free-space-tree.
This means if we detect block-group-tree without v2 cache, we consider
it a corruption and cause the problem.
For clear\_cache mount option, it would temporary disable v2 cache, then
re-enable it.
But unfortunately for that temporary v2 cache disabled status, we refuse
to write a superblock with bg tree only flag, thus leads to the above
transaction abortion.
[FIX]
For now, just reject clear\_cache and v1 cache mount option for block
group tree. So now we got a graceful rejection other than a transaction
abort:
BTRFS info (device dm-4): force clearing of disk cache
BTRFS error (device dm-4): cannot disable free space tree with block-group-tree feature
BTRFS error (device dm-4): open\_ctree failed
CC: stable@vger.kernel.org # 6.1+
Signed-off-by: Qu Wenruo
Reviewed-by: David Sterba
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit bf3d7a5c393cb1445dbb76ccf6a233f3f0e0e96e
Author: Naohiro Aota
Date: Tue Apr 18 17:45:24 2023 +0900
btrfs: zoned: fix wrong use of bitops API in btrfs\_ensure\_empty\_zones
commit 631003e2333c12cc1b52df06a707365b7363a159 upstream.
find\_next\_bit and find\_next\_zero\_bit take @size as the second parameter and
@offset as the third parameter. They are specified opposite in
btrfs\_ensure\_empty\_zones(). Thanks to the later loop, it never failed to
detect the empty zones. Fix them and (maybe) return the result a bit
faster.
Note: the naming is a bit confusing, size has two meanings here, bitmap
and our range size.
Fixes: 1cd6121f2a38 ("btrfs: zoned: implement zoned chunk allocator")
CC: stable@vger.kernel.org # 5.15+
Signed-off-by: Naohiro Aota
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit 371a81d7fa45fc7304bd4cbdfca621ab7119c84d
Author: Filipe Manana
Date: Wed Apr 12 11:33:09 2023 +0100
btrfs: fix btrfs\_prev\_leaf() to not return the same key twice
commit 6f932d4ef007d6a4ae03badcb749fbb8f49196f6 upstream.
A call to btrfs\_prev\_leaf() may end up returning a path that points to the
same item (key) again. This happens if while btrfs\_prev\_leaf(), after we
release the path, a concurrent insertion happens, which moves items off
from a sibling into the front of the previous leaf, and an item with the
computed previous key does not exists.
For example, suppose we have the two following leaves:
Leaf A
-------------------------------------------------------------
| ... key (300 96 10) key (300 96 15) key (300 96 16) |
-------------------------------------------------------------
slot 20 slot 21 slot 22
Leaf B
-------------------------------------------------------------
| key (300 96 20) key (300 96 21) key (300 96 22) ... |
-------------------------------------------------------------
slot 0 slot 1 slot 2
If we call btrfs\_prev\_leaf(), from btrfs\_previous\_item() for example, with
a path pointing to leaf B and slot 0 and the following happens:
1) At btrfs\_prev\_leaf() we compute the previous key to search as:
(300 96 19), which is a key that does not exists in the tree;
2) Then we call btrfs\_release\_path() at btrfs\_prev\_leaf();
3) Some other task inserts a key at leaf A, that sorts before the key at
slot 20, for example it has an objectid of 299. In order to make room
for the new key, the key at slot 22 is moved to the front of leaf B.
This happens at push\_leaf\_right(), called from split\_leaf().
After this leaf B now looks like:
--------------------------------------------------------------------------------
| key (300 96 16) key (300 96 20) key (300 96 21) key (300 96 22) ... |
--------------------------------------------------------------------------------
slot 0 slot 1 slot 2 slot 3
4) At btrfs\_prev\_leaf() we call btrfs\_search\_slot() for the computed
previous key: (300 96 19). Since the key does not exists,
btrfs\_search\_slot() returns 1 and with a path pointing to leaf B
and slot 1, the item with key (300 96 20);
5) This makes btrfs\_prev\_leaf() return a path that points to slot 1 of
leaf B, the same key as before it was called, since the key at slot 0
of leaf B (300 96 16) is less than the computed previous key, which is
(300 96 19);
6) As a consequence btrfs\_previous\_item() returns a path that points again
to the item with key (300 96 20).
For some users of btrfs\_prev\_leaf() or btrfs\_previous\_item() this may not
be functional a problem, despite not making sense to return a new path
pointing again to the same item/key. However for a caller such as
tree-log.c:log\_dir\_items(), this has a bad consequence, as it can result
in not logging some dir index deletions in case the directory is being
logged without holding the inode's VFS lock (logging triggered while
logging a child inode for example) - for the example scenario above, in
case the dir index keys 17, 18 and 19 were deleted in the current
transaction.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Josef Bacik
Signed-off-by: Filipe Manana
Signed-off-by: David Sterba
Signed-off-by: Greg Kroah-Hartman
commit e16be8fb7291568f5c1bbfc6367ba7e389eb0e79
Author: Borislav Petkov (AMD)
Date: Fri May 12 23:12:26 2023 +0200
x86/retbleed: Fix return thunk alignment
commit 9a48d604672220545d209e9996c2a1edbb5637f6 upstream.
SYM\_FUNC\_START\_LOCAL\_NOALIGN() adds an endbr leading to this layout
(leaving only the last 2 bytes of the address):
3bff :
3bff: f3 0f 1e fa endbr64
3c03: f6 test $0xcc,%bl
3c04 <\_\_x86\_return\_thunk>:
3c04: c3 ret
3c05: cc int3
3c06: 0f ae e8 lfence
However, "the RET at \_\_x86\_return\_thunk must be on a 64 byte boundary,
for alignment within the BTB."
Use SYM\_START instead.
Signed-off-by: Borislav Petkov (AMD)
Reviewed-by: Thomas Gleixner
Cc:
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 2a4aa97aad002d6d0cba256f4ece3d35033f1f80
Author: Sean Christopherson
Date: Fri May 12 15:20:24 2023 +0200
KVM: x86/mmu: Refresh CR0.WP prior to checking for emulated permission faults
[ Upstream commit cf9f4c0eb1699d306e348b1fd0225af7b2c282d3 ]
Refresh the MMU's snapshot of the vCPU's CR0.WP prior to checking for
permission faults when emulating a guest memory access and CR0.WP may be
guest owned. If the guest toggles only CR0.WP and triggers emulation of
a supervisor write, e.g. when KVM is emulating UMIP, KVM may consume a
stale CR0.WP, i.e. use stale protection bits metadata.
Note, KVM passes through CR0.WP if and only if EPT is enabled as CR0.WP
is part of the MMU role for legacy shadow paging, and SVM (NPT) doesn't
support per-bit interception controls for CR0. Don't bother checking for
EPT vs. NPT as the "old == new" check will always be true under NPT, i.e.
the only cost is the read of vcpu->arch.cr4 (SVM unconditionally grabs CR0
from the VMCB on VM-Exit).
Reported-by: Mathias Krause
Link: https://lkml.kernel.org/r/677169b4-051f-fcae-756b-9a3e1bb9f8fe%40grsecurity.net
Fixes: fb509f76acc8 ("KVM: VMX: Make CR0.WP a guest owned bit")
Tested-by: Mathias Krause
Link: https://lore.kernel.org/r/20230405002608.418442-1-seanjc@google.com
Signed-off-by: Sean Christopherson
Signed-off-by: Mathias Krause  # backport to v6.3.x
Signed-off-by: Sasha Levin
commit f13be15a3b41eccca22184a3d7180493ee544085
Author: Mathias Krause
Date: Fri May 12 15:20:23 2023 +0200
KVM: VMX: Make CR0.WP a guest owned bit
[ Upstream commit fb509f76acc8d42bed11bca308404f81c2be856a ]
Guests like grsecurity that make heavy use of CR0.WP to implement kernel
level W^X will suffer from the implied VMEXITs.
With EPT there is no need to intercept a guest change of CR0.WP, so
simply make it a guest owned bit if we can do so.
This implies that a read of a guest's CR0.WP bit might need a VMREAD.
However, the only potentially affected user seems to be kvm\_init\_mmu()
which is a heavy operation to begin with. But also most callers already
cache the full value of CR0 anyway, so no additional VMREAD is needed.
The only exception is nested\_vmx\_load\_cr3().
This change is VMX-specific, as SVM has no such fine grained control
register intercept control.
Suggested-by: Sean Christopherson
Signed-off-by: Mathias Krause
Link: https://lore.kernel.org/r/20230322013731.102955-7-minipli@grsecurity.net
Co-developed-by: Sean Christopherson
Signed-off-by: Sean Christopherson
Signed-off-by: Mathias Krause
Signed-off-by: Sasha Levin
commit cf5e267bbfb36ef6105b0f0cac9c6ddf40ce541d
Author: Mathias Krause
Date: Fri May 12 15:20:22 2023 +0200
KVM: x86: Make use of kvm\_read\_cr\*\_bits() when testing bits
[ Upstream commit 74cdc836919bf34684ef66f995273f35e2189daf ]
Make use of the kvm\_read\_cr{0,4}\_bits() helper functions when we only
want to know the state of certain bits instead of the whole register.
This not only makes the intent cleaner, it also avoids a potential
VMREAD in case the tested bits aren't guest owned.
Signed-off-by: Mathias Krause
Link: https://lore.kernel.org/r/20230322013731.102955-5-minipli@grsecurity.net
Signed-off-by: Sean Christopherson
Signed-off-by: Mathias Krause
Signed-off-by: Sasha Levin
commit 65c29d39419cc55e808f849c83e78e8cc55949b4
Author: Mathias Krause
Date: Fri May 12 15:20:21 2023 +0200
KVM: x86: Do not unload MMU roots when only toggling CR0.WP with TDP enabled
[ Upstream commit 01b31714bd90be2784f7145bf93b7f78f3d081e1 ]
There is no need to unload the MMU roots with TDP enabled when only
CR0.WP has changed -- the paging structures are still valid, only the
permission bitmap needs to be updated.
One heavy user of toggling CR0.WP is grsecurity's KERNEXEC feature to
implement kernel W^X.
The optimization brings a huge performance gain for this case as the
following micro-benchmark running 'ssdd 10 50000' from rt-tests[1] on a
grsecurity L1 VM shows (runtime in seconds, lower is better):
legacy TDP shadow
kvm-x86/next@d8708b 8.43s 9.45s 70.3s
+patch 5.39s 5.63s 70.2s
For legacy MMU this is ~36% faster, for TDP MMU even ~40% faster. Also
TDP and legacy MMU now both have a similar runtime which vanishes the
need to disable TDP MMU for grsecurity.
Shadow MMU sees no measurable difference and is still slow, as expected.
[1] https://git.kernel.org/pub/scm/utils/rt-tests/rt-tests.git
Signed-off-by: Mathias Krause
Link: https://lore.kernel.org/r/20230322013731.102955-3-minipli@grsecurity.net
Co-developed-by: Sean Christopherson
Signed-off-by: Sean Christopherson
Signed-off-by: Mathias Krause
Signed-off-by: Sasha Levin
commit b1b91f9704fde41ec222fa7ee06dfc3a7b0cebd3
Author: Paolo Bonzini
Date: Fri May 12 15:20:20 2023 +0200
KVM: x86/mmu: Avoid indirect call for get\_cr3
[ Upstream commit 2fdcc1b324189b5fb20655baebd40cd82e2bdf0c ]
Most of the time, calls to get\_guest\_pgd result in calling
kvm\_read\_cr3 (the exception is only nested TDP). Hardcode
the default instead of using the get\_cr3 function, avoiding
a retpoline if they are enabled.
Signed-off-by: Paolo Bonzini
Signed-off-by: Mathias Krause
Link: https://lore.kernel.org/r/20230322013731.102955-2-minipli@grsecurity.net
Signed-off-by: Sean Christopherson
Signed-off-by: Mathias Krause  # backport to v6.3.x
Signed-off-by: Sasha Levin
commit bc7eae6d98e9009cb34124d758637c1312fd5777
Author: Dmitrii Dolgov <9erthalion6@gmail.com>
Date: Wed Apr 12 20:23:16 2023 +0200
perf stat: Separate bperf from bpf\_profiler
[ Upstream commit ecc68ee216c6c5b2f84915e1441adf436f1b019b ]
It seems that perf stat -b  doesn't produce any results:
$ perf stat -e cycles -b 4 -I 10000 -vvv
Control descriptor is not initialized
cycles: 0 0 0
time counts unit events
10.007641640  cycles
Looks like this happens because fentry/fexit progs are getting loaded, but the
corresponding perf event is not enabled and not added into the events bpf map.
I think there is some mixing up between two type of bpf support, one for bperf
and one for bpf\_profiler. Both are identified via evsel\_\_is\_bpf, based on which
perf events are enabled, but for the latter (bpf\_profiler) a perf event is
required. Using evsel\_\_is\_bperf to check only bperf produces expected results:
$ perf stat -e cycles -b 4 -I 10000 -vvv
Control descriptor is not initialized
------------------------------------------------------------
perf\_event\_attr:
size 136
sample\_type IDENTIFIER
read\_format TOTAL\_TIME\_ENABLED|TOTAL\_TIME\_RUNNING
disabled 1
exclude\_guest 1
------------------------------------------------------------
sys\_perf\_event\_open: pid -1 cpu 0 group\_fd -1 flags 0x8 = 3
------------------------------------------------------------
[...perf\_event\_attr for other CPUs...]
------------------------------------------------------------
cycles: 309426 169009 169009
time counts unit events
10.010091271 309426 cycles
The final numbers correspond (at least in the level of magnitude) to the
same metric obtained via bpftool.
Fixes: 112cb56164bc2108 ("perf stat: Introduce config stat.bpf-counter-events")
Reviewed-by: Song Liu
Signed-off-by: Dmitrii Dolgov <9erthalion6@gmail.com>
Tested-by: Song Liu
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Song Liu
Link: https://lore.kernel.org/r/20230412182316.11628-1-9erthalion6@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f8341baf09e09f87d96966516f058405fc19b25c
Author: Yang Jihong
Date: Fri Apr 21 02:59:53 2023 +0000
perf tracepoint: Fix memory leak in is\_valid\_tracepoint()
[ Upstream commit 9b86c49710eec7b4fbb78a0232b2dd0972a2b576 ]
When is\_valid\_tracepoint() returns 1, need to call put\_events\_file() to
free `dir\_path`.
Fixes: 25a7d914274de386 ("perf parse-events: Use get/put\_events\_file()")
Signed-off-by: Yang Jihong
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230421025953.173826-1-yangjihong1@huawei.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 1f39a22ab7634129fc695171ac63e74aa7029996
Author: Yang Jihong
Date: Thu Apr 27 01:28:41 2023 +0000
perf symbols: Fix return incorrect build\_id size in elf\_read\_build\_id()
[ Upstream commit 1511e4696acb715a4fe48be89e1e691daec91c0e ]
In elf\_read\_build\_id(), if gnu build\_id is found, should return the size of
the actually copied data. If descsz is greater thanBuild\_ID\_SIZE,
write\_buildid data access may occur.
Fixes: be96ea8ffa788dcc ("perf symbols: Fix issue with binaries using 16-bytes buildids (v2)")
Reported-by: Will Ochowicz
Signed-off-by: Yang Jihong
Tested-by: Will Ochowicz
Acked-by: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Leo Yan
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Stephane Eranian
Link: https://lore.kernel.org/lkml/CWLP265MB49702F7BA3D6D8F13E4B1A719C649@CWLP265MB4970.GBRP265.PROD.OUTLOOK.COM/T/
Link: https://lore.kernel.org/r/20230427012841.231729-1-yangjihong1@huawei.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit beb57ba9bb680fe7ea110a909c3e01a62c5da941
Author: Olivier Bacon
Date: Thu Apr 20 11:00:35 2023 -0400
crypto: engine - fix crypto\_queue backlog handling
[ Upstream commit 4140aafcff167b5b9e8dae6a1709a6de7cac6f74 ]
CRYPTO\_TFM\_REQ\_MAY\_BACKLOG tells the crypto driver that it should
internally backlog requests until the crypto hw's queue becomes
full. At that point, crypto\_engine backlogs the request and returns
-EBUSY. Calling driver such as dm-crypt then waits until the
complete() function is called with a status of -EINPROGRESS before
sending a new request.
The problem lies in the call to complete() with a value of -EINPROGRESS
that is made when a backlog item is present on the queue. The call is
done before the successful execution of the crypto request. In the case
that do\_one\_request() returns < 0 and the retry support is available,
the request is put back in the queue. This leads upper drivers to send
a new request even if the queue is still full.
The problem can be reproduced by doing a large dd into a crypto
dm-crypt device. This is pretty easy to see when using
Freescale CAAM crypto driver and SWIOTLB dma. Since the actual amount
of requests that can be hold in the queue is unlimited we get IOs error
and dma allocation.
The fix is to call complete with a value of -EINPROGRESS only if
the request is not enqueued back in crypto\_queue. This is done
by calling complete() later in the code. In order to delay the decision,
crypto\_queue is modified to correctly set the backlog pointer
when a request is enqueued back.
Fixes: 6a89f492f8e5 ("crypto: engine - support for parallel requests based on retry mechanism")
Co-developed-by: Sylvain Ouellet
Signed-off-by: Sylvain Ouellet
Signed-off-by: Olivier Bacon
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 0045f0dcdf58bd0f2350928be8c04bb4585de870
Author: Christophe JAILLET
Date: Mon Apr 17 22:25:09 2023 +0200
crypto: sun8i-ss - Fix a test in sun8i\_ss\_setup\_ivs()
[ Upstream commit 8fd91151ebcb21b3f2f2bf158ac6092192550b2b ]
SS\_ENCRYPTION is (0 << 7 = 0), so the test can never be true.
Use a direct comparison to SS\_ENCRYPTION instead.
The same king of test is already done the same way in sun8i\_ss\_run\_task().
Fixes: 359e893e8af4 ("crypto: sun8i-ss - rework handling of IV")
Signed-off-by: Christophe JAILLET
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit a8b295892eccb2f81ac3b5a3ee5ac87857041cfa
Author: James Clark
Date: Mon Apr 24 14:47:41 2023 +0100
perf cs-etm: Fix timeless decode mode detection
[ Upstream commit 449067f3fc9f340da54e383738286881e6634d0b ]
In this context, timeless refers to the trace data rather than the perf
event data. But when detecting whether there are timestamps in the trace
data or not, the presence of a timestamp flag on any perf event is used.
Since commit f42c0ce573df ("perf record: Always get text\_poke events
with --kcore option") timestamps were added to a tracking event when
--kcore is used which breaks this detection mechanism. Fix it by
detecting if trace timestamps exist by looking at the ETM config flags.
This would have always been a more accurate way of doing it anyway.
This fixes the following error message when using --kcore with
Coresight:
$ perf record --kcore -e cs\_etm// --per-thread
$ perf report
The perf.data/data data has no samples!
Fixes: f42c0ce573df79d1 ("perf record: Always get text\_poke events with --kcore option")
Reported-by: Yang Shi
Signed-off-by: James Clark
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: John Garry
Cc: Leo Yan
Cc: Mark Rutland
Cc: Mathieu Poirier
Cc: Mike Leach
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Suzuki Poulouse
Cc: Will Deacon
Cc: coresight@lists.linaro.org
Cc: denik@google.com
Cc: linux-arm-kernel@lists.infradead.org
Link: https://lore.kernel.org/lkml/CAHbLzkrJQTrYBtPkf=jf3OpQ-yBcJe7XkvQstX9j2frz4WF-SQ@mail.gmail.com/
Link: https://lore.kernel.org/r/20230424134748.228137-2-james.clark@arm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 935df4d78cd847fcdadba67bd6a4e4b0f449a872
Author: Markus Elfring
Date: Thu Apr 13 14:46:39 2023 +0200
perf map: Delete two variable initialisations before null pointer checks in sort\_\_sym\_from\_cmp()
[ Upstream commit c160118a90d4acf335993d8d59b02ae2147a524e ]
Addresses of two data structure members were determined before
corresponding null pointer checks in the implementation of the function
“sort\_\_sym\_from\_cmp”.
Thus avoid the risk for undefined behaviour by removing extra
initialisations for the local variables “from\_l” and “from\_r” (also
because they were already reassigned with the same value behind this
pointer check).
This issue was detected by using the Coccinelle software.
Fixes: 1b9e97a2a95e4941 ("perf tools: Fix report -F symbol\_from for data without branch info")
Signed-off-by:
Acked-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Andi Kleen
Cc: German Gomez
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Mark Rutland
Cc: Namhyung Kim
Link: https://lore.kernel.org/cocci/54a21fea-64e3-de67-82ef-d61b90ffad05@web.de/
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 340666d6bf1ad8ea35fd5fb5cbc91f7e4cf644f4
Author: Arnaldo Carvalho de Melo
Date: Wed Apr 12 10:23:35 2023 -0300
perf pmu: zfree() expects a pointer to a pointer to zero it after freeing its contents
[ Upstream commit 57f14b5ae1a97537f2abd2828ee7212cada7036e ]
An audit showed just this one problem with zfree(), fix it.
Fixes: 9fbc61f832ebf432 ("perf pmu: Add support for PMU capabilities")
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 6580b6d45fcf3e3dcdc6290a0a55e3d44de44a51
Author: Adrian Hunter
Date: Thu Mar 16 21:41:55 2023 +0200
perf symbols: Fix unaligned access in get\_x86\_64\_plt\_disp()
[ Upstream commit a2410b579c72242ac0f77b3768093d8c1b48012e ]
Use memcpy() to avoid unaligned access.
Discovered using EXTRA\_CFLAGS="-fsanitize=undefined -fsanitize=address".
Fixes: ce4c8e7966f317ef ("perf symbols: Get symbols for .plt.got for x86-64")
Reported-by: kernel test robot
Signed-off-by: Adrian Hunter
Acked-by: Ian Rogers
Cc: Adrian Hunter
Cc: Jiri Olsa
Cc: Namhyung Kim
Link: https://lore.kernel.org/oe-lkp/202303061424.6ad43294-yujie.liu@intel.com
Link: https://lore.kernel.org/r/20230316194156.8320-2-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit d744e075e42793f2f2bce9fee88b9cab693c3da0
Author: Adrian Hunter
Date: Thu Mar 16 21:41:54 2023 +0200
perf symbols: Fix use-after-free in get\_plt\_got\_name()
[ Upstream commit c8bb2d76a40ac0ccf6303d369e536fddcde847fb ]
Fix use-after-free in get\_plt\_got\_name().
Discovered using EXTRA\_CFLAGS="-fsanitize=undefined -fsanitize=address".
Fixes: ce4c8e7966f317ef ("perf symbols: Get symbols for .plt.got for x86-64")
Reported-by: kernel test robot
Signed-off-by: Adrian Hunter
Acked-by: Ian Rogers
Cc: Adrian Hunter
Cc: Jiri Olsa
Cc: Namhyung Kim
Link: https://lore.kernel.org/oe-lkp/202303061424.6ad43294-yujie.liu@intel.com
Link: https://lore.kernel.org/r/20230316194156.8320-2-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 4d907b275dfcf2e63d62cd2a4f3889810df59263
Author: Kajol Jain
Date: Tue Mar 28 16:59:08 2023 +0530
perf vendor events power9: Remove UTF-8 characters from JSON files
[ Upstream commit 5d9df8731c0941f3add30f96745a62586a0c9d52 ]
Commit 3c22ba5243040c13 ("perf vendor events powerpc: Update POWER9
events") added and updated power9 PMU JSON events. However some of the
JSON events which are part of other.json and pipeline.json files,
contains UTF-8 characters in their brief description. Having UTF-8
character could breaks the perf build on some distros.
Fix this issue by removing the UTF-8 characters from other.json and
pipeline.json files.
Result without the fix:
[command]# file -i pmu-events/arch/powerpc/power9/\*
pmu-events/arch/powerpc/power9/cache.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/floating-point.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/frontend.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/marked.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/memory.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/metrics.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/nest\_metrics.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/other.json: application/json; charset=utf-8
pmu-events/arch/powerpc/power9/pipeline.json: application/json; charset=utf-8
pmu-events/arch/powerpc/power9/pmc.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/translation.json: application/json; charset=us-ascii
[command]#
Result with the fix:
[command]# file -i pmu-events/arch/powerpc/power9/\*
pmu-events/arch/powerpc/power9/cache.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/floating-point.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/frontend.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/marked.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/memory.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/metrics.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/nest\_metrics.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/other.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/pipeline.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/pmc.json: application/json; charset=us-ascii
pmu-events/arch/powerpc/power9/translation.json: application/json; charset=us-ascii
[command]#
Fixes: 3c22ba5243040c13 ("perf vendor events powerpc: Update POWER9 events")
Reported-by: Arnaldo Carvalho de Melo
Signed-off-by: Kajol Jain
Acked-by: Ian Rogers
Tested-by: Arnaldo Carvalho de Melo
Cc: Athira Rajeev
Cc: Disha Goel
Cc: Jiri Olsa
Cc: Madhavan Srinivasan
Cc: Sukadev Bhattiprolu
Cc: linuxppc-dev@lists.ozlabs.org
Link: https://lore.kernel.org/lkml/ZBxP77deq7ikTxwG@kernel.org/
Link: https://lore.kernel.org/r/20230328112908.113158-1-kjain@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit ef9435e2f40466e56ccdb199b1a6f487b6e5d4bd
Author: Yang Jihong
Date: Fri Mar 24 03:27:02 2023 +0000
perf ftrace: Make system wide the default target for latency subcommand
[ Upstream commit ecd4960d908e27e40b63a7046df2f942c148c6f6 ]
If no target is specified for 'latency' subcommand, the execution fails
because - 1 (invalid value) is written to set\_ftrace\_pid tracefs file.
Make system wide the default target, which is the same as the default
behavior of 'trace' subcommand.
Before the fix:
# perf ftrace latency -T schedule
failed to set ftrace pid
After the fix:
# perf ftrace latency -T schedule
^C# DURATION | COUNT | GRAPH |
0 - 1 us | 0 | |
1 - 2 us | 0 | |
2 - 4 us | 0 | |
4 - 8 us | 2828 | #### |
8 - 16 us | 23953 | ######################################## |
16 - 32 us | 408 | |
32 - 64 us | 318 | |
64 - 128 us | 4 | |
128 - 256 us | 3 | |
256 - 512 us | 0 | |
512 - 1024 us | 1 | |
1 - 2 ms | 4 | |
2 - 4 ms | 0 | |
4 - 8 ms | 0 | |
8 - 16 ms | 0 | |
16 - 32 ms | 0 | |
32 - 64 ms | 0 | |
64 - 128 ms | 0 | |
128 - 256 ms | 4 | |
256 - 512 ms | 2 | |
512 - 1024 ms | 0 | |
1 - ... s | 0 | |
Fixes: 53be50282269b46c ("perf ftrace: Add 'latency' subcommand")
Signed-off-by: Yang Jihong
Acked-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230324032702.109964-1-yangjihong1@huawei.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 13a926d09faca4302174e8ab3e783e52074ce5ac
Author: Patrice Duroux
Date: Fri Mar 3 20:30:58 2023 +0100
perf tests record\_offcpu.sh: Fix redirection of stderr to stdin
[ Upstream commit 9835b742ac3ee16dee361e7ccda8022f99d1cd94 ]
It's not 2&>1, the correct is 2>&1
Fixes: ade1d0307b2fb3d9 ("perf offcpu: Update offcpu test for child process")
Signed-off-by: Patrice Duroux
Acked-by: Ian Rogers
Cc: Namhyung Kim
Link: https://lore.kernel.org/r/20230303193058.21274-1-patrice.duroux@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 568c0293f62cfdadcb3095e3db5a7a9feb9339e6
Author: Thomas Richter
Date: Thu Mar 23 13:25:32 2023 +0100
perf vendor events s390: Remove UTF-8 characters from JSON file
[ Upstream commit eb2feb68cb7d404288493c41480843bc9f404789 ]
Commit 7f76b31130680fb3 ("perf list: Add IBM z16 event description for
s390") contains the verbal description for z16 extended counter set.
However some entries of the public description contain UTF-8 characters
which breaks the build on some distros.
Fix this and remove the UTF-8 characters.
Fixes: 7f76b31130680fb3 ("perf list: Add IBM z16 event description for s390")
Reported-by: Arnaldo Carvalho de Melo
Suggested-by: Heiko Carstens
Signed-off-by: Thomas Richter
Tested-by: Arnaldo Carvalho de Melo
Cc: Sumanth Korikkar
Cc: Sven Schnelle
Cc: Thomas Richter
Cc: Vasily Gorbik
Link: https://lore.kernel.org/r/ZBwkl77/I31AQk12@osiris
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 2d94c08b33639df21c1a27497e2067bef42f16f0
Author: Namhyung Kim
Date: Wed Mar 22 19:50:05 2023 -0700
perf hist: Improve srcfile sort key performance (really)
[ Upstream commit 6094c7744bb0563e833e81d8df8513f9a4e7a257 ]
The earlier commit f0cdde28fecc0d7f ("perf hist: Improve srcfile sort
key performance") updated the srcfile logic but missed to change the
->cmp() callback which is called for every sample.
It should use the same logic like in the srcline to speed up the
processing because it'd return the same information repeatedly for the
same address. The real processing will be done in
sort\_\_srcfile\_collapse().
Fixes: f0cdde28fecc0d7f ("perf hist: Improve srcfile sort key performance")
Signed-off-by: Namhyung Kim
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230323025005.191239-1-namhyung@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 89236aedd4fd87773dc95909bf39ccb96edcc0e7
Author: Thomas Richter
Date: Wed Mar 22 10:47:31 2023 +0100
perf test: Fix wrong size expectation for 'Setup struct perf\_event\_attr'
[ Upstream commit 30df88a80f32ccca5c5cdcf2710d1fb2de5e314d ]
The test case "perf test 'Setup struct perf\_event\_attr'" is failing.
On s390 this output is observed:
# ./perf test -Fvvvv 17
17: Setup struct perf\_event\_attr :
--- start ---
running './tests/attr/test-stat-C0'
Using CPUID IBM,8561,703,T01,3.6,002f
.....
Event event:base-stat
fd = 1
group\_fd = -1
flags = 0|8
cpu = \*
type = 0
size = 128 <<<--- wrong, specified in file base-stat
config = 0
sample\_period = 0
sample\_type = 65536
...
'PERF\_TEST\_ATTR=/tmp/tmpgw574wvg ./perf stat -o \
/tmp/tmpgw574wvg/perf.data -e cycles -C 0 kill >/dev/null \
2>&1 ret '1', expected '1'
loading result events
Event event-0-0-4
fd = 4
group\_fd = -1
cpu = 0
pid = -1
flags = 8
type = 0
size = 136 <<<--- actual size used in system call
.....
compare
matching [event-0-0-4]
to [event:base-stat]
[cpu] 0 \*
[flags] 8 0|8
[type] 0 0
[size] 136 128
->FAIL
match: [event-0-0-4] matches []
expected size=136, got 128
FAILED './tests/attr/test-stat-C0' - match failure
This mismatch is caused by
commit 09519ec3b19e ("perf: Add perf\_event\_attr::config3")
which enlarges the structure perf\_event\_attr by 8 bytes.
Fix this by adjusting the expected value of size.
Output after:
# ./perf test -Fvvvv 17
17: Setup struct perf\_event\_attr :
--- start ---
running './tests/attr/test-stat-C0'
Using CPUID IBM,8561,703,T01,3.6,002f
...
matched
compare
matching [event-0-0-4]
to [event:base-stat]
[cpu] 0 \*
[flags] 8 0|8
[type] 0 0
[size] 136 136
....
->OK
match: [event-0-0-4] matches ['event:base-stat']
matched
Fixes: 09519ec3b19e4144 ("perf: Add perf\_event\_attr::config3")
Signed-off-by: Thomas Richter
Acked-by: Namhyung Kim
Cc: Heiko Carstens
Cc: Rob Herring
Cc: Sumanth Korikkar
Cc: Sven Schnelle
Cc: Vasily Gorbik
Cc: Will Deacon
Link: https://lore.kernel.org/r/20230322094731.1768281-1-tmricht@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit f968ee18b019cec8a577517d910d0b034ccb4068
Author: Adrian Hunter
Date: Wed Mar 15 10:43:21 2023 +0200
perf script: Fix Python support when no libtraceevent
[ Upstream commit 80c3a7d9f20401169283b5670dbb8d7ac07a1d55 ]
Python scripting can be used without libtraceevent. In particular,
scripting for Intel PT does not use tracepoints, and so does not need
libtraceevent support.
Alter the build and employ conditional compilation to allow Python
scripting without libtraceevent.
Example:
Before:
$ ldd `which perf` | grep -i python
$ ldd `which perf` | grep -i libtraceevent
$ perf record -e intel\_pt//u uname
Linux
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.031 MB perf.data ]
$ perf script intel-pt-events.py |& head -3
Error: Couldn't find script `intel-pt-events.py'
See perf script -l for available scripts.
After:
$ ldd `which perf` | grep -i python
libpython3.10.so.1.0 => /lib/x86\_64-linux-gnu/libpython3.10.so.1.0 (0x00007f4bac400000)
$ ldd `which perf` | grep -i libtraceevent
$ perf script intel-pt-events.py | head
Intel PT Branch Trace, Power Events, Event Trace and PTWRITE
Switch In 8021/8021 [000] 11234.097713404 0/0
perf-exec 8021/8021 [000] 11234.098041726 psb offset: 0x0 0 [unknown] ([unknown])
perf-exec 8021/8021 [000] 11234.098041726 cbr 45 freq: 4505 MHz (161%) 0 [unknown] ([unknown])
uname 8021/8021 [000] 11234.098082170 branches:uH tr strt 0 [unknown] ([unknown]) => 7f3a8b9422b0 \_start+0x0 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2)
uname 8021/8021 [000] 11234.098082379 branches:uH tr end 7f3a8b9422b0 \_start+0x0 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2) => 0 [unknown] ([unknown])
uname 8021/8021 [000] 11234.098083629 branches:uH tr strt 0 [unknown] ([unknown]) => 7f3a8b9422b0 \_start+0x0 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2)
uname 8021/8021 [000] 11234.098083629 branches:uH call 7f3a8b9422b3 \_start+0x3 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2) => 7f3a8b943050 \_dl\_start+0x0 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2)
uname 8021/8021 [000] 11234.098083837 branches:uH tr end 7f3a8b943060 \_dl\_start+0x10 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2) => 0 [unknown] ([unknown]) IPC: 0.01 (9/938)
uname 8021/8021 [000] 11234.098084670 branches:uH tr strt 0 [unknown] ([unknown]) => 7f3a8b943060 \_dl\_start+0x10 (/usr/lib/x86\_64-linux-gnu/ld-linux-x86-64.so.2)
Fixes: 378ef0f5d9d7f465 ("perf build: Use libtraceevent from the system")
Signed-off-by: Adrian Hunter
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Namhyung Kim
Link: https://lore.kernel.org/r/20230315084321.14563-1-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 09ab2ecbf7ad0bc3e5d2cfb382ce6249b6ee148d
Author: Roman Lozko
Date: Fri Mar 10 15:04:45 2023 +0000
perf scripts intel-pt-events.py: Fix IPC output for Python 2
[ Upstream commit 1f64cfdebfe0494264271e8d7a3a47faf5f58ec7 ]
Integers are not converted to floats during division in Python 2 which
results in incorrect IPC values. Fix by switching to new division
behavior.
Fixes: a483e64c0b62e93a ("perf scripting python: intel-pt-events.py: Add --insn-trace and --src-trace")
Signed-off-by: Roman Lozko
Acked-by: Adrian Hunter
Cc: Adrian Hunter
Link: https://lore.kernel.org/r/20230310150445.2925841-1-lozko.roma@gmail.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 0b83db47662161e065b616b2c1c3234fa78609ff
Author: Ian Rogers
Date: Tue Mar 7 16:27:14 2023 -0800
perf test: Fix "PMU event table sanity" for NO\_JEVENTS=1
[ Upstream commit 07fc5921a014e227bd3b622d31a8a35ff3f19afb ]
A table was renamed and needed to be renamed in the empty case.
Fixes: 62774db2a05dc878 ("perf jevents: Generate metrics and events as separate tables")
Reviewed-by: John Garry
Signed-off-by: Ian Rogers
Cc: Alexander Shishkin
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kajol Jain
Cc: Mark Rutland
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230308002714.1755698-1-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 92e42c59d728ee32e291105c7f2af0df34ab2d1f
Author: Ian Rogers
Date: Fri Mar 10 22:57:41 2023 -0800
perf build: Support python/perf.so testing
[ Upstream commit 7a9b223ca0761a7c7c72e569b86b84a907aa0f92 ]
Add a build target to echo the python/perf.so's name from
Makefile.perf. Use it in tests/make so the correct target is built and
tested for.
Fixes: caec54705adb73b0 ("perf build: Fix python/perf.so library's name")
Signed-off-by: Ian Rogers
Cc: Adrian Hunter
Cc: Alexander Shishkin
Cc: Andres Freund
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Leo Yan
Cc: Mark Rutland
Cc: Martin Liška
Cc: Namhyung Kim
Cc: Nathan Chancellor
Cc: Nick Desaulniers
Cc: Pavithra Gurushankar
Cc: Peter Zijlstra
Cc: Quentin Monnet
Cc: Roberto Sassu
Cc: Stephane Eranian
Cc: Tiezhu Yang
Cc: Tom Rix
Cc: Yang Jihong
Cc: llvm@lists.linux.dev
Link: https://lore.kernel.org/r/20230311065753.3012826-2-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 8a198aab243e5b06813f017ad0a0bb8f431dfa55
Author: Ian Rogers
Date: Tue Mar 7 16:30:20 2023 -0800
perf lock contention: Fix compiler builtin detection
[ Upstream commit 17535a33a9c1e4fb52f3db1d72a7ddbe4cea1a2e ]
\_\_has\_builtin was passed the macro rather than the actual builtin
feature. The builtin test isn't sufficient and a clang version test
also needs to be performed.
Fixes: 1bece1351c653c3d ("perf lock contention: Support old rw\_semaphore type")
Reviewed-by: Namhyung Kim
Signed-off-by: Ian Rogers
Cc: Alexander Shishkin
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Mark Rutland
Cc: Martin KaFai Lau
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: bpf@vger.kernel.org
Link: https://lore.kernel.org/r/20230308003020.3653271-1-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit a74b7dc59edf632a013fe83d4af583cbbee6a1ea
Author: Kan Liang
Date: Wed Mar 1 07:04:13 2023 -0800
perf record: Fix "read LOST count failed" msg with sample read
[ Upstream commit 07d85ba9d04e1ebd282f656a29ddf08c5b7b32a2 ]
Hundreds of "read LOST count failed" error messages may be displayed,
when the below command is launched.
perf record -e '{cpu/mem-loads-aux/,cpu/event=0xcd,umask=0x1/}:S' -a
According to the commit 89e3106fa25fb1b6 ("libperf: Handle read format
in perf\_evsel\_\_read()"), the PERF\_FORMAT\_GROUP is only available for
the leader. However, the record\_\_read\_lost\_samples() goes through every
entry of an evlist, which includes both leader and member. The member
event errors out and triggers the error message. Since there may be
hundreds of CPUs on a server, the message will be printed hundreds of
times, which is very annoying.
The message itself is correct, but the pr\_err is a overkill. Other error
messages in the record\_\_read\_lost\_samples() are all pr\_debug. To make
the output format consistent, change the pr\_err("read LOST count
failed\n"); to pr\_debug("read LOST count failed\n");.
User can still get the message via -v option.
Fixes: e3a23261ad06d598 ("perf record: Read and inject LOST\_SAMPLES events")
Signed-off-by: Kan Liang
Acked-by: Namhyung Kim
Cc: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Peter Zijlstra
Link: https://lore.kernel.org/r/20230301150413.27011-1-kan.liang@linux.intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit e25e404effcf6712e1e9e758e94c57c025a7c877
Author: Vlad Buslov
Date: Thu May 4 20:16:16 2023 +0200
net/sched: flower: fix error handler on replace
[ Upstream commit fd741f0d9f702c193b2b44225c004f8c5d5be163 ]
When replacing a filter (i.e. 'fold' pointer is not NULL) the insertion of
new filter to idr is postponed until later in code since handle is already
provided by the user. However, the error handling code in fl\_change()
always assumes that the new filter had been inserted into idr. If error
handler is reached when replacing existing filter it may remove it from idr
therefore making it unreachable for delete or dump afterwards. Fix the
issue by verifying that 'fold' argument wasn't provided by caller before
calling idr\_remove().
Fixes: 08a0063df3ae ("net/sched: flower: Move filter handle initialization earlier")
Signed-off-by: Vlad Buslov
Reviewed-by: Pedro Tammela
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 253a3a324e0ebc2825de76a0f5f17b8383b2023d
Author: Vlad Buslov
Date: Thu May 4 20:16:14 2023 +0200
net/sched: flower: fix filter idr initialization
[ Upstream commit dd4f6bbfa646f258e5bcdfac57a5c413d687f588 ]
The cited commit moved idr initialization too early in fl\_change() which
allows concurrent users to access the filter that is still being
initialized and is in inconsistent state, which, in turn, can cause NULL
pointer dereference [0]. Since there is no obvious way to fix the ordering
without reverting the whole cited commit, alternative approach taken to
first insert NULL pointer into idr in order to allocate the handle but
still cause fl\_get() to return NULL and prevent concurrent users from
seeing the filter while providing miss-to-action infrastructure with valid
handle id early in fl\_change().
[ 152.434728] general protection fault, probably for non-canonical address 0xdffffc0000000000: 0000 [#1] SMP KASAN
[ 152.436163] KASAN: null-ptr-deref in range [0x0000000000000000-0x0000000000000007]
[ 152.437269] CPU: 4 PID: 3877 Comm: tc Not tainted 6.3.0-rc4+ #5
[ 152.438110] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 152.439644] RIP: 0010:fl\_dump\_key+0x8b/0x1d10 [cls\_flower]
[ 152.440461] Code: 01 f2 02 f2 c7 40 08 04 f2 04 f2 c7 40 0c 04 f3 f3 f3 65 48 8b 04 25 28 00 00 00 48 89 84 24 00 01 00 00 48 89 c8 48 c1 e8 03 <0f> b6 04 10 84 c0 74 08 3c 03 0f 8e 98 19 00 00 8b 13 85 d2 74 57
[ 152.442885] RSP: 0018:ffff88817a28f158 EFLAGS: 00010246
[ 152.443851] RAX: 0000000000000000 RBX: 0000000000000000 RCX: 0000000000000000
[ 152.444826] RDX: dffffc0000000000 RSI: ffffffff8500ae80 RDI: ffff88810a987900
[ 152.445791] RBP: ffff888179d88240 R08: ffff888179d8845c R09: ffff888179d88240
[ 152.446780] R10: ffffed102f451e48 R11: 00000000fffffff2 R12: ffff88810a987900
[ 152.447741] R13: ffffffff8500ae80 R14: ffff88810a987900 R15: ffff888149b3c738
[ 152.448756] FS: 00007f5eb2a34800(0000) GS:ffff88881ec00000(0000) knlGS:0000000000000000
[ 152.449888] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 152.450685] CR2: 000000000046ad19 CR3: 000000010b0bd006 CR4: 0000000000370ea0
[ 152.451641] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 152.452628] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 152.453588] Call Trace:
[ 152.454032]
[ 152.454447] ? netlink\_sendmsg+0x7a1/0xcb0
[ 152.455109] ? sock\_sendmsg+0xc5/0x190
[ 152.455689] ? \_\_\_\_sys\_sendmsg+0x535/0x6b0
[ 152.456320] ? \_\_\_sys\_sendmsg+0xeb/0x170
[ 152.456916] ? do\_syscall\_64+0x3d/0x90
[ 152.457529] ? entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 152.458321] ? \_\_\_sys\_sendmsg+0xeb/0x170
[ 152.458958] ? \_\_sys\_sendmsg+0xb5/0x140
[ 152.459564] ? do\_syscall\_64+0x3d/0x90
[ 152.460122] ? entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 152.460852] ? fl\_dump\_key\_options.part.0+0xea0/0xea0 [cls\_flower]
[ 152.461710] ? \_raw\_spin\_lock+0x7a/0xd0
[ 152.462299] ? \_raw\_read\_lock\_irq+0x30/0x30
[ 152.462924] ? nla\_put+0x15e/0x1c0
[ 152.463480] fl\_dump+0x228/0x650 [cls\_flower]
[ 152.464112] ? fl\_tmplt\_dump+0x210/0x210 [cls\_flower]
[ 152.464854] ? \_\_kmem\_cache\_alloc\_node+0x1a7/0x330
[ 152.465592] ? nla\_put+0x15e/0x1c0
[ 152.466160] tcf\_fill\_node+0x515/0x9a0
[ 152.466766] ? tc\_setup\_offload\_action+0xf0/0xf0
[ 152.467463] ? \_\_alloc\_skb+0x13c/0x2a0
[ 152.468067] ? \_\_build\_skb\_around+0x330/0x330
[ 152.468814] ? fl\_get+0x107/0x1a0 [cls\_flower]
[ 152.469503] tc\_del\_tfilter+0x718/0x1330
[ 152.470115] ? is\_bpf\_text\_address+0xa/0x20
[ 152.470765] ? tc\_ctl\_chain+0xee0/0xee0
[ 152.471335] ? \_\_kernel\_text\_address+0xe/0x30
[ 152.471948] ? unwind\_get\_return\_address+0x56/0xa0
[ 152.472639] ? \_\_thaw\_task+0x150/0x150
[ 152.473218] ? arch\_stack\_walk+0x98/0xf0
[ 152.473839] ? \_\_stack\_depot\_save+0x35/0x4c0
[ 152.474501] ? stack\_trace\_save+0x91/0xc0
[ 152.475119] ? security\_capable+0x51/0x90
[ 152.475741] rtnetlink\_rcv\_msg+0x2c1/0x9d0
[ 152.476387] ? rtnl\_calcit.isra.0+0x2b0/0x2b0
[ 152.477042] ? \_\_sys\_sendmsg+0xb5/0x140
[ 152.477664] ? do\_syscall\_64+0x3d/0x90
[ 152.478255] ? entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 152.479010] ? \_\_stack\_depot\_save+0x35/0x4c0
[ 152.479679] ? \_\_stack\_depot\_save+0x35/0x4c0
[ 152.480346] netlink\_rcv\_skb+0x12c/0x360
[ 152.480929] ? rtnl\_calcit.isra.0+0x2b0/0x2b0
[ 152.481517] ? do\_syscall\_64+0x3d/0x90
[ 152.482061] ? netlink\_ack+0x1550/0x1550
[ 152.482612] ? rhashtable\_walk\_peek+0x170/0x170
[ 152.483262] ? kmem\_cache\_alloc\_node+0x1af/0x390
[ 152.483875] ? \_copy\_from\_iter+0x3d6/0xc70
[ 152.484528] netlink\_unicast+0x553/0x790
[ 152.485168] ? netlink\_attachskb+0x6a0/0x6a0
[ 152.485848] ? unwind\_next\_frame+0x11cc/0x1a10
[ 152.486538] ? arch\_stack\_walk+0x61/0xf0
[ 152.487169] netlink\_sendmsg+0x7a1/0xcb0
[ 152.487799] ? netlink\_unicast+0x790/0x790
[ 152.488355] ? iovec\_from\_user.part.0+0x4d/0x220
[ 152.488990] ? \_raw\_spin\_lock+0x7a/0xd0
[ 152.489598] ? netlink\_unicast+0x790/0x790
[ 152.490236] sock\_sendmsg+0xc5/0x190
[ 152.490796] \_\_\_\_sys\_sendmsg+0x535/0x6b0
[ 152.491394] ? import\_iovec+0x7/0x10
[ 152.491964] ? kernel\_sendmsg+0x30/0x30
[ 152.492561] ? \_\_copy\_msghdr+0x3c0/0x3c0
[ 152.493160] ? do\_syscall\_64+0x3d/0x90
[ 152.493706] \_\_\_sys\_sendmsg+0xeb/0x170
[ 152.494283] ? may\_open\_dev+0xd0/0xd0
[ 152.494858] ? copy\_msghdr\_from\_user+0x110/0x110
[ 152.495541] ? \_\_handle\_mm\_fault+0x2678/0x4ad0
[ 152.496205] ? copy\_page\_range+0x2360/0x2360
[ 152.496862] ? \_\_fget\_light+0x57/0x520
[ 152.497449] ? mas\_find+0x1c0/0x1c0
[ 152.498026] ? sockfd\_lookup\_light+0x1a/0x140
[ 152.498703] \_\_sys\_sendmsg+0xb5/0x140
[ 152.499306] ? \_\_sys\_sendmsg\_sock+0x20/0x20
[ 152.499951] ? do\_user\_addr\_fault+0x369/0xd80
[ 152.500595] do\_syscall\_64+0x3d/0x90
[ 152.501185] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 152.501917] RIP: 0033:0x7f5eb294f887
[ 152.502494] Code: 0a 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b9 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 2e 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 51 c3 48 83 ec 28 89 54 24 1c 48 89 74 24 10
[ 152.505008] RSP: 002b:00007ffd2c708f78 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
[ 152.506152] RAX: ffffffffffffffda RBX: 00000000642d9472 RCX: 00007f5eb294f887
[ 152.507134] RDX: 0000000000000000 RSI: 00007ffd2c708fe0 RDI: 0000000000000003
[ 152.508113] RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000000
[ 152.509119] R10: 00007f5eb2808708 R11: 0000000000000246 R12: 0000000000000001
[ 152.510068] R13: 0000000000000000 R14: 00007ffd2c70d1b8 R15: 0000000000485400
[ 152.511031]
[ 152.511444] Modules linked in: cls\_flower sch\_ingress openvswitch nsh mlx5\_vdpa vringh vhost\_iotlb vdpa mlx5\_ib mlx5\_core rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm ib\_uverbs ib\_core xt\_conntrack xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink xt\_addrtype iptable\_nat nf\_nat br\_netfilter overlay zram zsmalloc fuse [last unloaded: mlx5\_core]
[ 152.515720] ---[ end trace 0000000000000000 ]---
Fixes: 08a0063df3ae ("net/sched: flower: Move filter handle initialization earlier")
Signed-off-by: Vlad Buslov
Reviewed-by: Pedro Tammela
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit eaeb32a3276c7b023c95f02a8788187432593358
Author: Shenwei Wang
Date: Thu May 4 10:35:17 2023 -0500
net: fec: correct the counting of XDP sent frames
[ Upstream commit 26312c685ae0bca61e06ac75ee158b1e69546415 ]
In the current xdp\_xmit implementation, if any single frame fails to
transmit due to insufficient buffer descriptors, the function nevertheless
reports success in sending all frames. This results in erroneously
indicating that frames were transmitted when in fact they were dropped.
This patch fixes the issue by ensureing the return value properly
indicates the actual number of frames successfully transmitted, rather than
potentially reporting success for all frames when some could not transmit.
Fixes: 6d6b39f180b8 ("net: fec: add initial XDP support")
Signed-off-by: Gagandeep Singh
Signed-off-by: Shenwei Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b959da534df580292ba48b3b09c2838d2599c5ec
Author: Wei Fang
Date: Thu May 4 16:03:59 2023 +0800
net: enetc: check the index of the SFI rather than the handle
[ Upstream commit 299efdc2380aac588557f4d0b2ce7bee05bd0cf2 ]
We should check whether the current SFI (Stream Filter Instance) table
is full before creating a new SFI entry. However, the previous logic
checks the handle by mistake and might lead to unpredictable behavior.
Fixes: 888ae5a3952b ("net: enetc: add tc flower psfp offload driver")
Signed-off-by: Wei Fang
Reviewed-by: Leon Romanovsky
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 4fda3cab61c9c1066ba5c14e2f1642a68e3098ce
Author: Wenliang Wang
Date: Thu May 4 10:27:06 2023 +0800
virtio\_net: suppress cpu stall when free\_unused\_bufs
[ Upstream commit f8bb5104394560e29017c25bcade4c6b7aabd108 ]
For multi-queue and large ring-size use case, the following error
occurred when free\_unused\_bufs:
rcu: INFO: rcu\_sched self-detected stall on CPU.
Fixes: 986a4f4d452d ("virtio\_net: multiqueue support")
Signed-off-by: Wenliang Wang
Acked-by: Michael S. Tsirkin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9b99fe93d5f17855be9af8606882ee3bae3b06fe
Author: Michal Swiatkowski
Date: Wed May 3 08:39:35 2023 -0700
ice: block LAN in case of VF to VF offload
[ Upstream commit 9f699b71c2f31c51bd1483a20e1c8ddc5986a8c9 ]
VF to VF traffic shouldn't go outside. To enforce it, set only the loopback
enable bit in case of all ingress type rules added via the tc tool.
Fixes: 0d08a441fb1a ("ice: ndo\_setup\_tc implementation for PF")
Reported-by: Sujai Buvaneswaran
Signed-off-by: Michal Swiatkowski
Tested-by: George Kuruvinakunnel
Reviewed-by: Simon Horman
Signed-off-by: Tony Nguyen
Reviewed-by: Leon Romanovsky
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d415b01bc647a1347e14afcdcf6d392ae7e6f998
Author: Arınç ÜNAL
Date: Wed May 3 00:09:47 2023 +0300
net: dsa: mt7530: fix network connectivity with multiple CPU ports
[ Upstream commit 120a56b01beed51ab5956a734adcfd2760307107 ]
On mt753x\_cpu\_port\_enable() there's code that enables flooding for the CPU
port only. Since mt753x\_cpu\_port\_enable() runs twice when both CPU ports
are enabled, port 6 becomes the only port to forward the frames to. But
port 5 is the active port, so no frames received from the user ports will
be forwarded to port 5 which breaks network connectivity.
Every bit of the BC\_FFP, UNM\_FFP, and UNU\_FFP bits represents a port. Fix
this issue by setting the bit that corresponds to the CPU port without
overwriting the other bits.
Clear the bits beforehand only for the MT7531 switch. According to the
documents MT7621 Giga Switch Programming Guide v0.3 and MT7531 Reference
Manual for Development Board v1.0, after reset, the BC\_FFP, UNM\_FFP, and
UNU\_FFP bits are set to 1 for MT7531, 0 for MT7530.
The commit 5e5502e012b8 ("net: dsa: mt7530: fix roaming from DSA user
ports") silently changed the method to set the bits on the MT7530\_MFC.
Instead of clearing the relevant bits before mt7530\_cpu\_port\_enable()
which runs under a for loop, the commit started doing it on
mt7530\_cpu\_port\_enable().
Back then, this didn't really matter as only a single CPU port could be
used since the CPU port number was hardcoded. The driver was later changed
with commit 1f9a6abecf53 ("net: dsa: mt7530: get cpu-port via dp->cpu\_dp
instead of constant") to retrieve the CPU port via dp->cpu\_dp. With that,
this silent change became an issue for when using multiple CPU ports.
Fixes: 5e5502e012b8 ("net: dsa: mt7530: fix roaming from DSA user ports")
Signed-off-by: Arınç ÜNAL
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ce46f0fd4bb0e70339098e8d9afebaac7c6a6f47
Author: Daniel Golle
Date: Mon Apr 3 02:19:02 2023 +0100
net: dsa: mt7530: split-off common parts from mt7531\_setup
[ Upstream commit 7f54cc9772ced2d76ac11832f0ada43798443ac9 ]
MT7988 shares a significant part of the setup function with MT7531.
Split-off those parts into a shared function which is going to be used
also by mt7988\_setup.
Signed-off-by: Daniel Golle
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Stable-dep-of: 120a56b01bee ("net: dsa: mt7530: fix network connectivity with multiple CPU ports")
Signed-off-by: Sasha Levin
commit 395a5a1e078132b81cf0bf9b44e836a737f14cca
Author: Arınç ÜNAL
Date: Wed May 3 00:09:46 2023 +0300
net: dsa: mt7530: fix corrupt frames using trgmii on 40 MHz XTAL MT7621
[ Upstream commit 37c218d8021e36e226add4bab93d071d30fe0704 ]
The multi-chip module MT7530 switch with a 40 MHz oscillator on the
MT7621AT, MT7621DAT, and MT7621ST SoCs forwards corrupt frames using
trgmii.
This is caused by the assumption that MT7621 SoCs have got 150 MHz PLL,
hence using the ncpo1 value, 0x0780.
My testing shows this value works on Unielec U7621-06, Bartel's testing
shows it won't work on Hi-Link HLK-MT7621A and Netgear WAC104. All devices
tested have got 40 MHz oscillators.
Using the value for 125 MHz PLL, 0x0640, works on all boards at hand. The
definitions for 125 MHz PLL exist on the Banana Pi BPI-R2 BSP source code
whilst 150 MHz PLL don't.
Forwarding frames using trgmii on the MCM MT7530 switch with a 25 MHz
oscillator on the said MT7621 SoCs works fine because the ncpo1 value
defined for it is for 125 MHz PLL.
Change the 150 MHz PLL comment to 125 MHz PLL, and use the 125 MHz PLL
ncpo1 values for both oscillator frequencies.
Link: https://github.com/BPI-SINOVOIP/BPI-R2-bsp/blob/81d24bbce7d99524d0771a8bdb2d6663e4eb4faa/u-boot-mt/drivers/net/rt2880\_eth.c#L2195
Fixes: 7ef6f6f8d237 ("net: dsa: mt7530: Add MT7621 TRGMII mode support")
Tested-by: Bartel Eerdekens
Signed-off-by: Arınç ÜNAL
Reviewed-by: Florian Fainelli
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9f1c4754fe4d49499deeda18bd698f5b423c9ead
Author: Conor Dooley
Date: Tue Apr 4 19:03:22 2023 +0100
dt-bindings: perf: riscv,pmu: fix property dependencies
[ Upstream commit 4d276e4d3bb4a503e75086faab54f92c0a8fd368 ]
Seemingly I mis-implemented the dependencies here. The OpenSBI docs only
point out that the "riscv,event-to-mhpmcounters property is mandatory if
riscv,event-to-mhpmevent is present". It never claims that
riscv,event-to-mhpmcounters requires riscv,event-to-mhpmevent.
Drop the dependency of riscv,event-to-mhpmcounters on
riscv,event-to-mhpmevent.
Fixes: 7e38085d9c59 ("dt-bindings: riscv: add SBI PMU event mappings")
Signed-off-by: Conor Dooley
Reviewed-by: Atish Patra
Link: https://lore.kernel.org/r/20230404-tractor-confusing-8852e552539a@spud
Signed-off-by: Rob Herring
Signed-off-by: Sasha Levin
commit 6c7f1d867bf82425ee3c0babccfa41e4cc332ebe
Author: Claudio Imbrenda
Date: Fri Apr 28 11:27:53 2023 +0200
KVM: s390: fix race in gmap\_make\_secure()
[ Upstream commit c148dc8e2fa403be501612ee409db866eeed35c0 ]
Fix a potential race in gmap\_make\_secure() and remove the last user of
follow\_page() without FOLL\_GET.
The old code is locking something it doesn't have a reference to, and
as explained by Jason and David in this discussion:
https://lore.kernel.org/linux-mm/Y9J4P%2FRNvY1Ztn0Q@nvidia.com/
it can lead to all kind of bad things, including the page getting
unmapped (MADV\_DONTNEED), freed, reallocated as a larger folio and the
unlock\_page() would target the wrong bit.
There is also another race with the FOLL\_WRITE, which could race
between the follow\_page() and the get\_locked\_pte().
The main point is to remove the last use of follow\_page() without
FOLL\_GET or FOLL\_PIN, removing the races can be considered a nice
bonus.
Link: https://lore.kernel.org/linux-mm/Y9J4P%2FRNvY1Ztn0Q@nvidia.com/
Suggested-by: Jason Gunthorpe
Fixes: 214d9bbcd3a6 ("s390/mm: provide memory management functions for protected KVM guests")
Reviewed-by: Jason Gunthorpe
Signed-off-by: Claudio Imbrenda
Message-Id: <20230428092753.27913-2-imbrenda@linux.ibm.com>
Signed-off-by: Sasha Levin
commit 77780a7b442a18e19f5960f962a31d05a92eedb0
Author: Claudio Imbrenda
Date: Fri Apr 21 10:50:36 2023 +0200
KVM: s390: pv: fix asynchronous teardown for small VMs
[ Upstream commit 292a7d6fca33df70ca4b8e9b0d0e74adf87582dc ]
On machines without the Destroy Secure Configuration Fast UVC, the
topmost level of page tables is set aside and freed asynchronously
as last step of the asynchronous teardown.
Each gmap has a host\_to\_guest radix tree mapping host (userspace)
addresses (with 1M granularity) to gmap segment table entries (pmds).
If a guest is smaller than 2GB, the topmost level of page tables is the
segment table (i.e. there are only 2 levels). Replacing it means that
the pointers in the host\_to\_guest mapping would become stale and cause
all kinds of nasty issues.
This patch fixes the issue by disallowing asynchronous teardown for
guests with only 2 levels of page tables. Userspace should (and already
does) try using the normal destroy if the asynchronous one fails.
Update s390\_replace\_asce so it refuses to replace segment type ASCEs.
This is still needed in case the normal destroy VM fails.
Fixes: fb491d5500a7 ("KVM: s390: pv: asynchronous destroy for reboot")
Reviewed-by: Marc Hartmayer
Reviewed-by: Janosch Frank
Signed-off-by: Claudio Imbrenda
Message-Id: <20230421085036.52511-2-imbrenda@linux.ibm.com>
Signed-off-by: Sasha Levin
commit a6a00ac3eed1019e92426a04ac9875efd116ac70
Author: Ruliang Lin
Date: Thu May 4 14:50:53 2023 +0800
ALSA: caiaq: input: Add error handling for unsupported input methods in `snd\_usb\_caiaq\_input\_init`
[ Upstream commit 0d727e1856ef22dd9337199430258cb64cbbc658 ]
Smatch complains that:
snd\_usb\_caiaq\_input\_init() warn: missing error code 'ret'
This patch adds a new case to handle the situation where the
device does not support any input methods in the
`snd\_usb\_caiaq\_input\_init` function. It returns an `-EINVAL` error code
to indicate that no input methods are supported on the device.
Fixes: 523f1dce3743 ("[ALSA] Add Native Instrument usb audio device support")
Signed-off-by: Ruliang Lin
Reviewed-by: Dongliang Mu
Acked-by: Daniel Mack
Link: https://lore.kernel.org/r/20230504065054.3309-1-u202112092@hust.edu.cn
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit eeae4012fdac928d55661ac6de29167137b3875b
Author: Chia-I Wu
Date: Wed Apr 26 15:54:55 2023 -0700
drm/amdgpu: add a missing lock for AMDGPU\_SCHED
[ Upstream commit 2397e3d8d2e120355201a8310b61929f5a8bd2c0 ]
mgr->ctx\_handles should be protected by mgr->lock.
v2: improve commit message
v3: add a Fixes tag
Signed-off-by: Chia-I Wu
Reviewed-by: Christian König
Fixes: 52c6a62c64fa ("drm/amdgpu: add interface for editing a foreign process's priority v3")
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit d243c61de1c5e0ad8f7b6c07e51c0b887233fff5
Author: Ming Lei
Date: Tue May 2 10:42:31 2023 +0800
ublk: add timeout handler
[ Upstream commit c0b79b0ff53be5b05be98e3caaa6a39de1fe9520 ]
Add timeout handler, so that we can provide forward progress guarantee for
unprivileged ublk, which can't be trusted.
One thing is that sync() calls sync\_bdevs(wait) for all block devices after
running sync\_bdevs(no\_wait), and if one device can't move on, the sync() won't
return any more.
Add timeout for unprivileged ublk to avoid such affect for other users which call
sync() syscall.
Meantime clear UBLK\_F\_USER\_RECOVERY\_REISSUE for unprivileged ublk since
that feature may cause IO hang too.
Fixes: 4093cb5a0634 ("ublk\_drv: add mechanism for supporting unprivileged ublk device")
Signed-off-by: Ming Lei
Link: https://lore.kernel.org/r/20230502024231.888498-1-ming.lei@redhat.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 81b845f9ee25148e047304c77de0cf71fe5e5f7f
Author: Arnd Bergmann
Date: Mon Apr 3 09:49:13 2023 +0200
i2c: gxp: fix build failure without CONFIG\_I2C\_SLAVE
[ Upstream commit 5d388143fa6c351d985ffd23ea50c91c8839141b ]
The gxp\_i2c\_slave\_irq\_handler() is hidden in an #ifdef, but the
caller uses an IS\_ENABLED() check:
drivers/i2c/busses/i2c-gxp.c: In function 'gxp\_i2c\_irq\_handler':
drivers/i2c/busses/i2c-gxp.c:467:29: error: implicit declaration of function 'gxp\_i2c\_slave\_irq\_handler'; did you mean 'gxp\_i2c\_irq\_handler'? [-Werror=implicit-function-declaration]
It has to consistently use one method or the other to avoid warnings,
so move to IS\_ENABLED() here for readability and build coverage, and
move the #ifdef in linux/i2c.h to allow building it as dead code.
Fixes: 4a55ed6f89f5 ("i2c: Add GXP SoC I2C Controller")
Signed-off-by: Arnd Bergmann
Reviewed-by: Nick Hawkins
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit ac982db3e17652c79465646a34e9b6cf6b1e0884
Author: Florian Westphal
Date: Wed May 3 12:00:18 2023 +0200
netfilter: nf\_tables: fix ct untracked match breakage
[ Upstream commit f057b63bc11d86a98176de31b437e46789f44d8f ]
"ct untracked" no longer works properly due to erroneous NFT\_BREAK.
We have to check ctinfo enum first.
Fixes: d9e789147605 ("netfilter: nf\_tables: avoid retpoline overhead for some ct expression calls")
Reported-by: Rvfg
Link: https://marc.info/?l=netfilter&m=168294996212038&w=2
Signed-off-by: Florian Westphal
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit a6f038f246c3829ad18eddace1fcfa71da5ba9b6
Author: Kuniyuki Iwashima
Date: Mon May 1 13:28:57 2023 -0700
af\_packet: Don't send zero-byte data in packet\_sendmsg\_spkt().
[ Upstream commit 6a341729fb31b4c5df9f74f24b4b1c98410c9b87 ]
syzkaller reported a warning below [0].
We can reproduce it by sending 0-byte data from the (AF\_PACKET,
SOCK\_PACKET) socket via some devices whose dev->hard\_header\_len
is 0.
struct sockaddr\_pkt addr = {
.spkt\_family = AF\_PACKET,
.spkt\_device = "tun0",
};
int fd;
fd = socket(AF\_PACKET, SOCK\_PACKET, 0);
sendto(fd, NULL, 0, 0, (struct sockaddr \*)&addr, sizeof(addr));
We have a similar fix for the (AF\_PACKET, SOCK\_RAW) socket as
commit dc633700f00f ("net/af\_packet: check len when min\_header\_len
equals to 0").
Let's add the same test for the SOCK\_PACKET socket.
[0]:
skb\_assert\_len
WARNING: CPU: 1 PID: 19945 at include/linux/skbuff.h:2552 skb\_assert\_len include/linux/skbuff.h:2552 [inline]
WARNING: CPU: 1 PID: 19945 at include/linux/skbuff.h:2552 \_\_dev\_queue\_xmit+0x1f26/0x31d0 net/core/dev.c:4159
Modules linked in:
CPU: 1 PID: 19945 Comm: syz-executor.0 Not tainted 6.3.0-rc7-02330-gca6270c12e20 #1
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.16.0-0-gd239552ce722-prebuilt.qemu.org 04/01/2014
RIP: 0010:skb\_assert\_len include/linux/skbuff.h:2552 [inline]
RIP: 0010:\_\_dev\_queue\_xmit+0x1f26/0x31d0 net/core/dev.c:4159
Code: 89 de e8 1d a2 85 fd 84 db 75 21 e8 64 a9 85 fd 48 c7 c6 80 2a 1f 86 48 c7 c7 c0 06 1f 86 c6 05 23 cf 27 04 01 e8 fa ee 56 fd <0f> 0b e8 43 a9 85 fd 0f b6 1d 0f cf 27 04 31 ff 89 de e8 e3 a1 85
RSP: 0018:ffff8880217af6e0 EFLAGS: 00010282
RAX: 0000000000000000 RBX: 0000000000000000 RCX: ffffc90001133000
RDX: 0000000000040000 RSI: ffffffff81186922 RDI: 0000000000000001
RBP: ffff8880217af8b0 R08: 0000000000000001 R09: 0000000000000000
R10: 0000000000000001 R11: 0000000000000001 R12: ffff888030045640
R13: ffff8880300456b0 R14: ffff888030045650 R15: ffff888030045718
FS: 00007fc5864da640(0000) GS:ffff88806cd00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020005740 CR3: 000000003f856003 CR4: 0000000000770ee0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
dev\_queue\_xmit include/linux/netdevice.h:3085 [inline]
packet\_sendmsg\_spkt+0xc4b/0x1230 net/packet/af\_packet.c:2066
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg+0x1b4/0x200 net/socket.c:747
\_\_\_\_sys\_sendmsg+0x331/0x970 net/socket.c:2503
\_\_\_sys\_sendmsg+0x11d/0x1c0 net/socket.c:2557
\_\_sys\_sendmmsg+0x18c/0x430 net/socket.c:2643
\_\_do\_sys\_sendmmsg net/socket.c:2672 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2669 [inline]
\_\_x64\_sys\_sendmmsg+0x9c/0x100 net/socket.c:2669
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3c/0x90 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
RIP: 0033:0x7fc58791de5d
Code: ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 73 9f 1b 00 f7 d8 64 89 01 48
RSP: 002b:00007fc5864d9cc8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000133
RAX: ffffffffffffffda RBX: 00000000004bbf80 RCX: 00007fc58791de5d
RDX: 0000000000000001 RSI: 0000000020005740 RDI: 0000000000000004
RBP: 00000000004bbf80 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 000000000000000b R14: 00007fc58797e530 R15: 0000000000000000

---[ end trace 0000000000000000 ]---
skb len=0 headroom=16 headlen=0 tailroom=304
mac=(16,0) net=(16,-1) trans=-1
shinfo(txflags=0 nr\_frags=0 gso(size=0 type=0 segs=0))
csum(0x0 ip\_summed=0 complete\_sw=0 valid=0 level=0)
hash(0x0 sw=0 l4=0) proto=0x0000 pkttype=0 iif=0
dev name=sit0 feat=0x00000006401d7869
sk family=17 type=10 proto=0
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: syzbot
Signed-off-by: Kuniyuki Iwashima
Reviewed-by: Willem de Bruijn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0020c16c8af7f4bc9503a2088fb30793b6771fac
Author: Shannon Nelson
Date: Tue May 2 11:35:36 2023 -0700
ionic: catch failure from devlink\_alloc
[ Upstream commit 4a54903ff68ddb33b6463c94b4eb37fc584ef760 ]
Add a check for NULL on the alloc return. If devlink\_alloc() fails and
we try to use devlink\_priv() on the NULL return, the kernel gets very
unhappy and panics. With this fix, the driver load will still fail,
but at least it won't panic the kernel.
Fixes: df69ba43217d ("ionic: Add basic framework for IONIC Network device driver")
Signed-off-by: Shannon Nelson
Reviewed-by: Simon Horman
Reviewed-by: Jiri Pirko
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 72808c4ab5fd01bf1214195005e15b434bf55cef
Author: Ido Schimmel
Date: Tue May 2 15:20:50 2023 +0300
ethtool: Fix uninitialized number of lanes
[ Upstream commit 9ad685dbfe7e856bbf17a7177b64676d324d6ed7 ]
It is not possible to set the number of lanes when setting link modes
using the legacy IOCTL ethtool interface. Since 'struct
ethtool\_link\_ksettings' is not initialized in this path, drivers receive
an uninitialized number of lanes in 'struct
ethtool\_link\_ksettings::lanes'.
When this information is later queried from drivers, it results in the
ethtool code making decisions based on uninitialized memory, leading to
the following KMSAN splat [1]. In practice, this most likely only
happens with the tun driver that simply returns whatever it got in the
set operation.
As far as I can tell, this uninitialized memory is not leaked to user
space thanks to the 'ethtool\_ops->cap\_link\_lanes\_supported' check in
linkmodes\_prepare\_data().
Fix by initializing the structure in the IOCTL path. Did not find any
more call sites that pass an uninitialized structure when calling
'ethtool\_ops::set\_link\_ksettings()'.
[1]
BUG: KMSAN: uninit-value in ethnl\_update\_linkmodes net/ethtool/linkmodes.c:273 [inline]
BUG: KMSAN: uninit-value in ethnl\_set\_linkmodes+0x190b/0x19d0 net/ethtool/linkmodes.c:333
ethnl\_update\_linkmodes net/ethtool/linkmodes.c:273 [inline]
ethnl\_set\_linkmodes+0x190b/0x19d0 net/ethtool/linkmodes.c:333
ethnl\_default\_set\_doit+0x88d/0xde0 net/ethtool/netlink.c:640
genl\_family\_rcv\_msg\_doit net/netlink/genetlink.c:968 [inline]
genl\_family\_rcv\_msg net/netlink/genetlink.c:1048 [inline]
genl\_rcv\_msg+0x141a/0x14c0 net/netlink/genetlink.c:1065
netlink\_rcv\_skb+0x3f8/0x750 net/netlink/af\_netlink.c:2577
genl\_rcv+0x40/0x60 net/netlink/genetlink.c:1076
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0xf41/0x1270 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x127d/0x1430 net/netlink/af\_netlink.c:1942
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0xa24/0xe40 net/socket.c:2501
\_\_\_sys\_sendmsg+0x2a1/0x3f0 net/socket.c:2555
\_\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2593 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2591 [inline]
\_\_x64\_sys\_sendmsg+0x36b/0x540 net/socket.c:2591
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Uninit was stored to memory at:
tun\_get\_link\_ksettings+0x37/0x60 drivers/net/tun.c:3544
\_\_ethtool\_get\_link\_ksettings+0x17b/0x260 net/ethtool/ioctl.c:441
ethnl\_set\_linkmodes+0xee/0x19d0 net/ethtool/linkmodes.c:327
ethnl\_default\_set\_doit+0x88d/0xde0 net/ethtool/netlink.c:640
genl\_family\_rcv\_msg\_doit net/netlink/genetlink.c:968 [inline]
genl\_family\_rcv\_msg net/netlink/genetlink.c:1048 [inline]
genl\_rcv\_msg+0x141a/0x14c0 net/netlink/genetlink.c:1065
netlink\_rcv\_skb+0x3f8/0x750 net/netlink/af\_netlink.c:2577
genl\_rcv+0x40/0x60 net/netlink/genetlink.c:1076
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1339 [inline]
netlink\_unicast+0xf41/0x1270 net/netlink/af\_netlink.c:1365
netlink\_sendmsg+0x127d/0x1430 net/netlink/af\_netlink.c:1942
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0xa24/0xe40 net/socket.c:2501
\_\_\_sys\_sendmsg+0x2a1/0x3f0 net/socket.c:2555
\_\_sys\_sendmsg net/socket.c:2584 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2593 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2591 [inline]
\_\_x64\_sys\_sendmsg+0x36b/0x540 net/socket.c:2591
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Uninit was stored to memory at:
tun\_set\_link\_ksettings+0x37/0x60 drivers/net/tun.c:3553
ethtool\_set\_link\_ksettings+0x600/0x690 net/ethtool/ioctl.c:609
\_\_dev\_ethtool net/ethtool/ioctl.c:3024 [inline]
dev\_ethtool+0x1db9/0x2a70 net/ethtool/ioctl.c:3078
dev\_ioctl+0xb07/0x1270 net/core/dev\_ioctl.c:524
sock\_do\_ioctl+0x295/0x540 net/socket.c:1213
sock\_ioctl+0x729/0xd90 net/socket.c:1316
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:870 [inline]
\_\_se\_sys\_ioctl+0x222/0x400 fs/ioctl.c:856
\_\_x64\_sys\_ioctl+0x96/0xe0 fs/ioctl.c:856
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
Local variable link\_ksettings created at:
ethtool\_set\_link\_ksettings+0x54/0x690 net/ethtool/ioctl.c:577
\_\_dev\_ethtool net/ethtool/ioctl.c:3024 [inline]
dev\_ethtool+0x1db9/0x2a70 net/ethtool/ioctl.c:3078
Fixes: 012ce4dd3102 ("ethtool: Extend link modes settings uAPI with lanes")
Reported-and-tested-by: syzbot+ef6edd9f1baaa54d6235@syzkaller.appspotmail.com
Link: https://lore.kernel.org/netdev/0000000000004bb41105fa70f361@google.com/
Reviewed-by: Danielle Ratson
Signed-off-by: Ido Schimmel
Reviewed-by: Leon Romanovsky
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit add02b924434f7212a3f6091702aa23eb4faa4ff
Author: Hayes Wang
Date: Tue May 2 11:36:27 2023 +0800
r8152: fix the autosuspend doesn't work
[ Upstream commit 0fbd79c01a9a657348f7032df70c57a406468c86 ]
Set supports\_autosuspend = 1 for the rtl8152\_cfgselector\_driver.
Fixes: ec51fbd1b8a2 ("r8152: add USB device driver for config selection")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ff9ede9feedd2af43934c00c4b7c1a14ede696ef
Author: Shannon Nelson
Date: Tue May 2 11:47:40 2023 -0700
ionic: remove noise from ethtool rxnfc error msg
[ Upstream commit 3711d44fac1f80ea69ecb7315fed05b3812a7401 ]
It seems that ethtool is calling into .get\_rxnfc more often with
ETHTOOL\_GRXCLSRLCNT which ionic doesn't know about. We don't
need to log a message about it, just return not supported.
Fixes: aa3198819bea6 ("ionic: Add RSS support")
Signed-off-by: Shannon Nelson
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 22f2ec513f86c30afd1a88c927e6b916533ab7f6
Author: Subbaraya Sundeep
Date: Wed May 3 12:39:44 2023 +0530
octeontx2-vf: Detach LF resources on probe cleanup
[ Upstream commit 99ae1260fdb5f15beab8a3adfb93a9041c87a2c1 ]
When a VF device probe fails due to error in MSIX vector allocation then
the resources NIX and NPA LFs were not detached. Fix this by detaching
the LFs when MSIX vector allocation fails.
Fixes: 3184fb5ba96e ("octeontx2-vf: Virtual function driver support")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit fe10c03c8aa6442615319eb6188f17c9a9bd4eed
Author: Subbaraya Sundeep
Date: Wed May 3 12:39:43 2023 +0530
octeontx2-pf: Disable packet I/O for graceful exit
[ Upstream commit c926252205c424c4842dbdbe02f8e3296f623204 ]
At the stage of enabling packet I/O in otx2\_open, If mailbox
timeout occurs then interface ends up in down state where as
hardware packet I/O is enabled. Hence disable packet I/O also
before bailing out.
Fixes: 1ea0166da050 ("octeontx2-pf: Fix the device state on error")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit df470471f66b96d796e9e4ed1f1d0098cc8019f8
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:42 2023 +0530
octeontx2-af: Skip PFs if not enabled
[ Upstream commit 5eb1b7220948a69298a436148a735f32ec325289 ]
Firmware enables PFs and allocate mbox resources for each of the PFs.
Currently PF driver configures mbox resources without checking whether
PF is enabled or not. This results in crash. This patch fixes this issue
by skipping disabled PF's mbox initialization.
Fixes: 9bdc47a6e328 ("octeontx2-af: Mbox communication support btw AF and it's VFs")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9844e200be717f5eb27c32803ab742dae80816e2
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:41 2023 +0530
octeontx2-af: Fix issues with NPC field hash extract
[ Upstream commit f66155905959076619c9c519fb099e8ae6cb6f7b ]
1. Allow field hash configuration for both source and destination IPv6.
2. Configure hardware parser based on hash extract feature enable flag
for IPv6.
3. Fix IPv6 endianness issue while updating the source/destination IP
address via ntuple rule.
Fixes: 56d9f5fd2246 ("octeontx2-af: Use hashed field in MCAM key")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit af682595ae794fc9c442719f435efab9c44b9514
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:40 2023 +0530
octeontx2-af: Update/Fix NPC field hash extract feature
[ Upstream commit 406bed11fb91a0b35c26fe633d8700febaec6439 ]
1. As per previous implementation, mask and control parameter to
generate the field hash value was not passed to the caller program.
Updated the secret key mbox to share that information as well,
as a part of the fix.
2. Earlier implementation did not consider hash reduction of both
source and destination IPv6 addresses. Only source IPv6 address
was considered. This fix solves that and provides option to hash
Fixes: 56d9f5fd2246 ("octeontx2-af: Use hashed field in MCAM key")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 8be36751fbe0503526d2aae12c31c5885c051bff
Author: Suman Ghosh
Date: Wed May 3 12:39:39 2023 +0530
octeontx2-af: Update correct mask to filter IPv4 fragments
[ Upstream commit 2075bf150ddf320df02c05e242774dc0f73be1a1 ]
During the initial design, the IPv4 ip\_flag mask was set to 0xff.
Which results to filter only fragmets with (fragment\_offset == 0).
As part of the fix, updated the mask to 0x20 to filter all the
fragmented packets irrespective of the fragment\_offset value.
Fixes: c672e3727989 ("octeontx2-pf: Add support to filter packet based on IP fragment")
Signed-off-by: Suman Ghosh
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5c0268b141ad612b6fca13d3a66cfda111716dbb
Author: Hariprasad Kelam
Date: Wed May 3 12:39:38 2023 +0530
octeontx2-af: Add validation for lmac type
[ Upstream commit cb5edce271764524b88b1a6866b3e626686d9a33 ]
Upon physical link change, firmware reports to the kernel about the
change along with the details like speed, lmac\_type\_id, etc.
Kernel derives lmac\_type based on lmac\_type\_id received from firmware.
In a few scenarios, firmware returns an invalid lmac\_type\_id, which
is resulting in below kernel panic. This patch adds the missing
validation of the lmac\_type\_id field.
Internal error: Oops: 96000005 [#1] PREEMPT SMP
[ 35.321595] Modules linked in:
[ 35.328982] CPU: 0 PID: 31 Comm: kworker/0:1 Not tainted
5.4.210-g2e3169d8e1bc-dirty #17
[ 35.337014] Hardware name: Marvell CN103XX board (DT)
[ 35.344297] Workqueue: events work\_for\_cpu\_fn
[ 35.352730] pstate: 40400089 (nZcv daIf +PAN -UAO)
[ 35.360267] pc : strncpy+0x10/0x30
[ 35.366595] lr : cgx\_link\_change\_handler+0x90/0x180
Fixes: 61071a871ea6 ("octeontx2-af: Forward CGX link notifications to PFs")
Signed-off-by: Hariprasad Kelam
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b74573bd4b4d0e0a6b1d301d7f54745620dabe8a
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:37 2023 +0530
octeontx2-pf: Increase the size of dmac filter flows
[ Upstream commit 2a6eecc592b4d59a04d513aa25fc0f30d52100cd ]
CN10kb supports large number of dmac filter flows to be
inserted. Increase the field size to accommodate the same
Fixes: b747923afff8 ("octeontx2-af: Exact match support")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 40bb59571cd1f954c6746d5497c0211e567b5f10
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:36 2023 +0530
octeontx2-af: Fix depth of cam and mem table.
[ Upstream commit 60999cb83554ebcf6cfff8894bc2c3d99ea858ba ]
In current driver, NPC cam and mem table sizes are read from wrong
register offset. This patch fixes the register offset so that correct
values are populated on read.
Fixes: b747923afff8 ("octeontx2-af: Exact match support")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0c82a0e860b96c562a062ab8825f19b5efafb7a1
Author: Ratheesh Kannoth
Date: Wed May 3 12:39:35 2023 +0530
octeontx2-af: Fix start and end bit for scan config
[ Upstream commit c60a6b90e7890453f09e0d2163d6acadabe3415b ]
In the current driver, NPC exact match feature was not getting
enabled as configured bit was not read properly.
for\_each\_set\_bit\_from() need end bit as one bit post
position in the bit map to read NPC exact nibble enable
bits properly. This patch fixes the same.
Fixes: b747923afff8 ("octeontx2-af: Exact match support")
Signed-off-by: Ratheesh Kannoth
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d083928fd44b0a38a274c9b8d42feb76b5db6413
Author: Geetha sowjanya
Date: Wed May 3 12:39:34 2023 +0530
octeontx2-af: Secure APR table update with the lock
[ Upstream commit 048486f81d01db4d100af021ee2ea211d19732a0 ]
APR table contains the lmtst base address of PF/VFs. These entries
are updated by the PF/VF during the device probe. The lmtst address
is fetched from HW using "TXN\_REQ" and "ADDR\_RSP\_STS" registers.
The lock tries to protect these registers from getting overwritten
when multiple PFs invokes rvu\_get\_lmtaddr() simultaneously.
For example, if PF1 submit the request and got permitted before it
reads the response and PF2 got scheduled submit the request then the
response of PF1 is overwritten by the PF2 response.
Fixes: 893ae97214c3 ("octeontx2-af: cn10k: Support configurable LMTST regions")
Signed-off-by: Geetha sowjanya
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Sai Krishna
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 3657cdb25d04460d4c23449844385b420df84dcb
Author: Jeremy Sowden
Date: Tue Apr 25 22:11:39 2023 +0100
selftests: netfilter: fix libmnl pkg-config usage
[ Upstream commit de4773f0235acf74554f6a64ea60adc0d7b01895 ]
1. Don't hard-code pkg-config
2. Remove distro-specific default for CFLAGS
3. Use pkg-config for LDLIBS
Fixes: a50a88f026fb ("selftests: netfilter: fix a build error on openSUSE")
Suggested-by: Jan Engelhardt
Signed-off-by: Jeremy Sowden
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 42e84e40a94b012d15feb37c8d1e5e9b2369a245
Author: Pablo Neira Ayuso
Date: Tue Apr 25 16:50:32 2023 +0200
netfilter: nf\_tables: hit ENOENT on unexisting chain/flowtable update with missing attributes
[ Upstream commit 8509f62b0b07ae8d6dec5aa9613ab1b250ff632f ]
If user does not specify hook number and priority, then assume this is
a chain/flowtable update. Therefore, report ENOENT which provides a
better hint than EINVAL. Set on extended netlink error report to refer
to the chain name.
Fixes: 5b6743fb2c2a ("netfilter: nf\_tables: skip flowtable hooknum and priority on device updates")
Fixes: 5efe72698a97 ("netfilter: nf\_tables: support for adding new devices to an existing netdev chain")
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit d131ce7a319d3bff68d5a9d5509bb22e4ce33946
Author: Pablo Neira Ayuso
Date: Fri Apr 21 00:34:31 2023 +0200
netfilter: nf\_tables: support for adding new devices to an existing netdev chain
[ Upstream commit b9703ed44ffbfba85c103b9de01886a225e14b38 ]
This patch allows users to add devices to an existing netdev chain.
Signed-off-by: Pablo Neira Ayuso
Stable-dep-of: 8509f62b0b07 ("netfilter: nf\_tables: hit ENOENT on unexisting chain/flowtable update with missing attributes")
Signed-off-by: Sasha Levin
commit 88e255edcaa1bc9ee61e87e27f84b3aed0e493bc
Author: Pablo Neira Ayuso
Date: Fri Apr 21 00:34:30 2023 +0200
netfilter: nf\_tables: rename function to destroy hook list
[ Upstream commit cdc32546632354305afdcf399a5431138a31c9e0 ]
Rename nft\_flowtable\_hooks\_destroy() by nft\_hooks\_destroy() to prepare
for netdev chain device updates.
Signed-off-by: Pablo Neira Ayuso
Stable-dep-of: 8509f62b0b07 ("netfilter: nf\_tables: hit ENOENT on unexisting chain/flowtable update with missing attributes")
Signed-off-by: Sasha Levin
commit b79c7846864989bba6d5cebc35e78ff833ef3d2d
Author: Pablo Neira Ayuso
Date: Fri Apr 21 00:34:28 2023 +0200
netfilter: nf\_tables: extended netlink error reporting for netdevice
[ Upstream commit c3c060adc0249355411a93e61888051e6902b8a1 ]
Flowtable and netdev chains are bound to one or several netdevice,
extend netlink error reporting to specify the the netdevice that
triggers the error.
Signed-off-by: Pablo Neira Ayuso
Stable-dep-of: 8509f62b0b07 ("netfilter: nf\_tables: hit ENOENT on unexisting chain/flowtable update with missing attributes")
Signed-off-by: Sasha Levin
commit f889cc6f05bf8ff1f24432a6c1ffc28b4d2c46e9
Author: Radhakrishna Sripada
Date: Thu Apr 20 15:12:47 2023 -0700
drm/i915/mtl: Add the missing CPU transcoder mask in intel\_device\_info
[ Upstream commit 6ece90e3665a9b7fb2637fcca26cebd42991580b ]
CPU transcoder mask is used to iterate over the available
CPU transcoders in the macro for\_each\_cpu\_transcoder().
The macro is broken on MTL and got highlighted when audio
state was being tracked for each transcoder added in [1].
Add the missing CPU transcoder mask which is similar to ADL-P
mask but without DSI transcoders.
[1]: https://patchwork.freedesktop.org/patch/523723/
Fixes: 7835303982d1 ("drm/i915/mtl: Add MeteorLake PCI IDs")
Cc: Ville Syrjälä
Signed-off-by: Radhakrishna Sripada
Acked-by: Haridhar Kalvala
Reviewed-by: Gustavo Sousa
Link: https://patchwork.freedesktop.org/patch/msgid/20230420221248.2511314-1-radhakrishna.sripada@intel.com
(cherry picked from commit bddc18913bd44adae5c828fd514d570f43ba1576)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 0edc015104718e94dd67515bb26d80bbb905a9df
Author: John Harrison
Date: Fri Apr 21 15:47:42 2023 -0700
drm/i915/guc: Actually return an error if GuC version range check fails
[ Upstream commit 1816f4a17f54a01afa2f06d6571c39890b97d282 ]
Dan Carpenter pointed out that 'err' was not being set in the case
where the GuC firmware version range check fails. Fix that.
Note that while this is a bug fix for a previous patch (see Fixes tag
below). It is an exceedingly low risk bug. The range check is
asserting that the GuC firmware version is within spec. So it should
not be possible to ever have a firmware file that fails this check. If
larger version numbers are required in the future, that would be a
backwards breaking spec change and thus require a major version bump,
in which case an old i915 driver would not load that new version anyway.
Fixes: 9bbba0667f37 ("drm/i915/guc: Use GuC submission API version number")
Reported-by: Dan Carpenter
Signed-off-by: John Harrison
Cc: John Harrison
Cc: Daniele Ceraolo Spurio
Cc: Alan Previn
Cc: Umesh Nerlige Ramappa
Cc: Rodrigo Vivi
Cc: Matthew Brost
Cc: Andi Shyti
Cc: Matthew Auld
Cc: Tvrtko Ursulin
Cc: Lucas De Marchi
Cc: Jani Nikula
Reviewed-by: Andi Shyti
Link: https://patchwork.freedesktop.org/patch/msgid/20230421224742.2357198-1-John.C.Harrison@Intel.com
(cherry picked from commit 80ab31799002166ac7c660bacfbff4f85bc29107)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit 8435e4b1e4ad8823bc5386caf1dda91b4ace287d
Author: John Harrison
Date: Mon Feb 6 21:07:12 2023 -0800
drm/i915/guc: More debug print updates - UC firmware
[ Upstream commit 4fd4fde8e42e16425e7acab2e093614491107083 ]
Update a bunch more debug prints to use the new GT based scheme.
v2: Also change prints to use %pe for error values (MichalW).
Signed-off-by: John Harrison
Reviewed-by: Michal Wajdeczko
Link: https://patchwork.freedesktop.org/patch/msgid/20230207050717.1833718-2-John.C.Harrison@Intel.com
Stable-dep-of: 1816f4a17f54 ("drm/i915/guc: Actually return an error if GuC version range check fails")
Signed-off-by: Sasha Levin
commit c28ed1bfff67ff462d6a5cdef04895db462b1f34
Author: Felix Fietkau
Date: Wed Apr 26 19:21:53 2023 +0200
net: ethernet: mtk\_eth\_soc: drop generic vlan rx offload, only use DSA untagging
[ Upstream commit c6d96df9fa2c1d19525239d4262889cce594ce6c ]
Through testing I found out that hardware vlan rx offload support seems to
have some hardware issues. At least when using multiple MACs and when
receiving tagged packets on the secondary MAC, the hardware can sometimes
start to emit wrong tags on the first MAC as well.
In order to avoid such issues, drop the feature configuration and use
the offload feature only for DSA hardware untagging on MT7621/MT7622
devices where this feature works properly.
Fixes: 08666cbb7dd5 ("net: ethernet: mtk\_eth\_soc: add support for configuring vlan rx offload")
Tested-by: Frank Wunderlich
Signed-off-by: Felix Fietkau
Signed-off-by: Frank Wunderlich
Tested-by: Arınç ÜNAL
Acked-by: Arınç ÜNAL
Link: https://lore.kernel.org/r/20230426172153.8352-1-linux@fw-web.de
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 0bbd25e3fcf554a8b1a006be75e05acbce977090
Author: ndesaulniers@google.com
Date: Fri Apr 28 11:28:17 2023 -0700
arm64: kernel: remove SHF\_WRITE|SHF\_EXECINSTR from .idmap.text
[ Upstream commit 4df69e0df295822cdf816442fe4897f214cccb08 ]
commit d54170812ef1 ("arm64: fix .idmap.text assertion for large kernels")
modified some of the section assembler directives that declare
.idmap.text to be SHF\_ALLOC instead of
SHF\_ALLOC|SHF\_WRITE|SHF\_EXECINSTR.
This patch fixes up the remaining stragglers that were left behind. Add
Fixes tag so that this doesn't precede related change in stable.
Fixes: d54170812ef1 ("arm64: fix .idmap.text assertion for large kernels")
Reported-by: Greg Thelen
Reviewed-by: Ard Biesheuvel
Signed-off-by: Nick Desaulniers
Link: https://lore.kernel.org/r/20230428-awx-v2-1-b197ffa16edc@google.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 0efb17007a445d49b0d6f09a6ed054b6667d68be
Author: Guo Ren
Date: Mon May 1 15:33:54 2023 -0700
riscv: compat\_syscall\_table: Fixup compile warning
[ Upstream commit f9c4bbddece7eff1155c70d48e3c9c2a01b9d778 ]
../arch/riscv/kernel/compat\_syscall\_table.c:12:41: warning: initialized
field overwritten [-Woverride-init]
12 | #define \_\_SYSCALL(nr, call) [nr] = (call),
| ^
../include/uapi/asm-generic/unistd.h:567:1: note: in expansion of macro
'\_\_SYSCALL'
567 | \_\_SYSCALL(\_\_NR\_semget, sys\_semget)
Fixes: 59c10c52f573 ("riscv: compat: syscall: Add compat\_sys\_call\_table implementation")
Reviewed-by: Conor Dooley
Reported-by: kernel test robot
Tested-by: Jisheng Zhang
Signed-off-by: Guo Ren
Signed-off-by: Guo Ren
Signed-off-by: Drew Fustini
Link: https://lore.kernel.org/r/20230501223353.2833899-1-dfustini@baylibre.com
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit 72f4a9f3f447948cf86dffe1c4a4c8a429ab9666
Author: David Howells
Date: Fri Apr 28 21:27:56 2023 +0100
rxrpc: Fix timeout of a call that hasn't yet been granted a channel
[ Upstream commit db099c625b13a74d462521a46d98a8ce5b53af5d ]
afs\_make\_call() calls rxrpc\_kernel\_begin\_call() to begin a call (which may
get stalled in the background waiting for a connection to become
available); it then calls rxrpc\_kernel\_set\_max\_life() to set the timeouts -
but that starts the call timer so the call timer might then expire before
we get a connection assigned - leading to the following oops if the call
stalled:
BUG: kernel NULL pointer dereference, address: 0000000000000000
...
CPU: 1 PID: 5111 Comm: krxrpcio/0 Not tainted 6.3.0-rc7-build3+ #701
RIP: 0010:rxrpc\_alloc\_txbuf+0xc0/0x157
...
Call Trace:
rxrpc\_send\_ACK+0x50/0x13b
rxrpc\_input\_call\_event+0x16a/0x67d
rxrpc\_io\_thread+0x1b6/0x45f
? \_raw\_spin\_unlock\_irqrestore+0x1f/0x35
? rxrpc\_input\_packet+0x519/0x519
kthread+0xe7/0xef
? kthread\_complete\_and\_exit+0x1b/0x1b
ret\_from\_fork+0x22/0x30
Fix this by noting the timeouts in struct rxrpc\_call when the call is
created. The timer will be started when the first packet is transmitted.
It shouldn't be possible to trigger this directly from userspace through
AF\_RXRPC as sendmsg() will return EBUSY if the call is in the
waiting-for-conn state if it dropped out of the wait due to a signal.
Fixes: 9d35d880e0e4 ("rxrpc: Move client call connection to the I/O thread")
Reported-by: Marc Dionne
Signed-off-by: David Howells
cc: "David S. Miller"
cc: Eric Dumazet
cc: Jakub Kicinski
cc: Paolo Abeni
cc: linux-afs@lists.infradead.org
cc: netdev@vger.kernel.org
cc: linux-kernel@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 876d96faacbc407daf4978d7ec95051b68f5344a
Author: David Howells
Date: Fri Apr 28 21:27:55 2023 +0100
rxrpc: Make it so that a waiting process can be aborted
[ Upstream commit 0eb362d254814ce04848730bf32e75b8ee1a4d6c ]
When sendmsg() creates an rxrpc call, it queues it to wait for a connection
and channel to be assigned and then waits before it can start shovelling
data as the encrypted DATA packet content includes a summary of the
connection parameters.
However, sendmsg() may get interrupted before a connection gets assigned
and further sendmsg() calls will fail with EBUSY until an assignment is
made.
Fix this so that the call can at least be aborted without failing on
EBUSY. We have to be careful here as sendmsg() mustn't be allowed to start
the call timer if the call doesn't yet have a connection assigned as an
oops may follow shortly thereafter.
Fixes: 540b1c48c37a ("rxrpc: Fix deadlock between call creation and sendmsg/recvmsg")
Reported-by: Marc Dionne
Signed-off-by: David Howells
cc: "David S. Miller"
cc: Eric Dumazet
cc: Jakub Kicinski
cc: Paolo Abeni
cc: linux-afs@lists.infradead.org
cc: netdev@vger.kernel.org
cc: linux-kernel@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 1d433c2b2e7d9dfd077417d35269b529f97183ec
Author: David Howells
Date: Fri Apr 28 21:27:54 2023 +0100
rxrpc: Fix hard call timeout units
[ Upstream commit 0d098d83c5d9e107b2df7f5e11f81492f56d2fe7 ]
The hard call timeout is specified in the RXRPC\_SET\_CALL\_TIMEOUT cmsg in
seconds, so fix the point at which sendmsg() applies it to the call to
convert to jiffies from seconds, not milliseconds.
Fixes: a158bdd3247b ("rxrpc: Fix timeout of a call that hasn't yet been granted a channel")
Signed-off-by: David Howells
cc: Marc Dionne
cc: "David S. Miller"
cc: Eric Dumazet
cc: Jakub Kicinski
cc: Paolo Abeni
cc: linux-afs@lists.infradead.org
cc: netdev@vger.kernel.org
cc: linux-kernel@vger.kernel.org
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 49c76c787ba0a797680235d61896f259a15bd575
Author: Andy Moreton
Date: Fri Apr 28 12:33:33 2023 +0100
sfc: Fix module EEPROM reporting for QSFP modules
[ Upstream commit 281900a923d4c50df109b52a22ae3cdac150159b ]
The sfc driver does not report QSFP module EEPROM contents correctly
as only the first page is fetched from hardware.
Commit 0e1a2a3e6e7d ("ethtool: Add SFF-8436 and SFF-8636 max EEPROM
length definitions") added ETH\_MODULE\_SFF\_8436\_MAX\_LEN for the overall
size of the EEPROM info, so use that to report the full EEPROM contents.
Fixes: 9b17010da57a ("sfc: Add ethtool -m support for QSFP modules")
Signed-off-by: Andy Moreton
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7bfcd304f37bc2a6a0db6f99aedc98a6b0421a2f
Author: Hayes Wang
Date: Fri Apr 28 16:53:31 2023 +0800
r8152: move setting r8153b\_rx\_agg\_chg\_indicate()
[ Upstream commit cce8334f4aacd9936309a002d4a4de92a07cd2c2 ]
Move setting r8153b\_rx\_agg\_chg\_indicate() for 2.5G devices. The
r8153b\_rx\_agg\_chg\_indicate() has to be called after enabling tx/rx.
Otherwise, the coalescing settings are useless.
Fixes: 195aae321c82 ("r8152: support new chips")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit a96b8634a43052c08ef4b9e53b3c38b141c2f23f
Author: Hayes Wang
Date: Fri Apr 28 16:53:30 2023 +0800
r8152: fix the poor throughput for 2.5G devices
[ Upstream commit 61b0ad6f58e2066e054c6d4839d67974d2861a7d ]
Fix the poor throughput for 2.5G devices, when changing the speed from
auto mode to force mode. This patch is used to notify the MAC when the
mode is changed.
Fixes: 195aae321c82 ("r8152: support new chips")
Signed-off-by: Hayes Wang
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 90ab6cf8e57f01acfd987efaf6047e56c7af7387
Author: Hayes Wang
Date: Fri Apr 28 16:53:29 2023 +0800
r8152: fix flow control issue of RTL8156A
[ Upstream commit 8ceda6d5a1e5402fd852e6cc59a286ce3dc545ee ]
The feature of flow control becomes abnormal, if the device sends a
pause frame and the tx/rx is disabled before sending a release frame. It
causes the lost of packets.
Set PLA\_RX\_FIFO\_FULL and PLA\_RX\_FIFO\_EMPTY to zeros before disabling the
tx/rx. And, toggle FC\_PATCH\_TASK before enabling tx/rx to reset the flow
control patch and timer. Then, the hardware could clear the state and
the flow control becomes normal after enabling tx/rx.
Besides, remove inline for fc\_pause\_on\_auto() and fc\_pause\_off\_auto().
Fixes: 195aae321c82 ("r8152: support new chips")
Signed-off-by: Hayes Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9e481996efa853042162a810f8b4167df689a07c
Author: Victor Nogueira
Date: Wed Apr 26 15:19:40 2023 +0000
net/sched: act\_mirred: Add carrier check
[ Upstream commit 526f28bd0fbdc699cda31426928802650c1528e5 ]
There are cases where the device is adminstratively UP, but operationally
down. For example, we have a physical device (Nvidia ConnectX-6 Dx, 25Gbps)
who's cable was pulled out, here is its ip link output:
5: ens2f1:  mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
link/ether b8:ce:f6:4b:68:35 brd ff:ff:ff:ff:ff:ff
altname enp179s0f1np1
As you can see, it's administratively UP but operationally down.
In this case, sending a packet to this port caused a nasty kernel hang (so
nasty that we were unable to capture it). Aborting a transmit based on
operational status (in addition to administrative status) fixes the issue.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Acked-by: Jamal Hadi Salim
Signed-off-by: Victor Nogueira
v1->v2: Add fixes tag
v2->v3: Remove blank line between tags + add change log, suggested by Leon
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 775027b644ce7250e5d6d9f83191bb607d75ad91
Author: Akhil R
Date: Thu Apr 27 18:09:14 2023 +0530
i2c: tegra: Fix PEC support for SMBUS block read
[ Upstream commit 9f855779a3874eee70e9f6be57b5f7774f14e510 ]
Update the msg->len value correctly for SMBUS block read. The discrepancy
went unnoticed as msg->len is used in SMBUS transfers only when a PEC
byte is added.
Fixes: d7583c8a5748 ("i2c: tegra: Add SMBus block read function")
Signed-off-by: Akhil R
Acked-by: Thierry Reding
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit b245d9a4839d58bd945c45566bc4c049b53950ad
Author: Sia Jee Heng
Date: Thu Mar 30 14:43:20 2023 +0800
RISC-V: mm: Enable huge page support to kernel\_page\_present() function
[ Upstream commit a15c90b67a662c75f469822a7f95c7aaa049e28f ]
Currently kernel\_page\_present() function doesn't support huge page
detection causes the function to mistakenly return false to the
hibernation core.
Add huge page detection to the function to solve the problem.
Fixes: 9e953cda5cdf ("riscv: Introduce huge page support for 32/64bit kernel")
Signed-off-by: Sia Jee Heng
Reviewed-by: Ley Foon Tan
Reviewed-by: Mason Huo
Reviewed-by: Andrew Jones
Reviewed-by: Alexandre Ghiti
Link: https://lore.kernel.org/r/20230330064321.1008373-4-jeeheng.sia@starfivetech.com
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit badfc942592e37c940074cea16d603363c510e76
Author: Christophe JAILLET
Date: Wed Apr 26 08:52:48 2023 +0200
watchdog: dw\_wdt: Fix the error handling path of dw\_wdt\_drv\_probe()
[ Upstream commit 7f5390750645756bd5da2b24fac285f2654dd922 ]
The commit in Fixes has only updated the remove function and missed the
error handling path of the probe.
Add the missing reset\_control\_assert() call.
Fixes: 65a3b6935d92 ("watchdog: dw\_wdt: get reset lines from dt")
Signed-off-by: Christophe JAILLET
Reviewed-by: Philipp Zabel
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/fbb650650bbb33a8fa2fd028c23157bedeed50e1.1682491863.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Signed-off-by: Sasha Levin
commit 5528db70963448c7f6287300a7f07799256f6e62
Author: Tao Su
Date: Fri Apr 28 12:51:49 2023 +0800
block: Skip destroyed blkg when restart in blkg\_destroy\_all()
[ Upstream commit 8176080d59e6d4ff9fc97ae534063073b4f7a715 ]
Kernel hang in blkg\_destroy\_all() when total blkg greater than
BLKG\_DESTROY\_BATCH\_SIZE, because of not removing destroyed blkg in
blkg\_list. So the size of blkg\_list is same after destroying a
batch of blkg, and the infinite 'restart' occurs.
Since blkg should stay on the queue list until blkg\_free\_workfn(),
skip destroyed blkg when restart a new round, which will solve this
kernel hang issue and satisfy the previous will to restart.
Reported-by: Xiangfei Ma
Tested-by: Xiangfei Ma
Tested-by: Farrah Chen
Signed-off-by: Tao Su
Fixes: f1c006f1c685 ("blk-cgroup: synchronize pd\_free\_fn() from blkg\_free\_workfn() and blkcg\_deactivate\_policy()")
Suggested-and-reviewed-by: Yu Kuai
Link: https://lore.kernel.org/r/20230428045149.1310073-1-tao1.su@linux.intel.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 38257946b3c9ff929573ba9f3c015fc987b7109f
Author: Maxim Korotkov
Date: Thu Jan 19 13:44:43 2023 +0300
writeback: fix call of incorrect macro
[ Upstream commit 3e46c89c74f2c38e5337d2cf44b0b551adff1cb4 ]
the variable 'history' is of type u16, it may be an error
that the hweight32 macro was used for it
I guess macro hweight16 should be used
Found by Linux Verification Center (linuxtesting.org) with SVACE.
Fixes: 2a81490811d0 ("writeback: implement foreign cgroup inode detection")
Signed-off-by: Maxim Korotkov
Reviewed-by: Jan Kara
Link: https://lore.kernel.org/r/20230119104443.3002-1-korotkov.maxim.s@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 1933882031ab7143d3a8dc0d7e0cbf3fe8595bb7
Author: Angelo Dureghello
Date: Wed Apr 26 22:28:15 2023 +0200
net: dsa: mv88e6xxx: add mv88e6321 rsvd2cpu
[ Upstream commit 6686317855c6997671982d4489ccdd946f644957 ]
Add rsvd2cpu capability for mv88e6321 model, to allow proper bpdu
processing.
Signed-off-by: Angelo Dureghello
Fixes: 51c901a775621 ("net: dsa: mv88e6xxx: distinguish Global 2 Rsvd2CPU")
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0951584f73a95f4df26e47c00f3de63553522c9e
Author: Antoine Tenart
Date: Thu Apr 27 11:21:59 2023 +0200
net: ipv6: fix skb hash for some RST packets
[ Upstream commit dc6456e938e938d64ffb6383a286b2ac9790a37f ]
The skb hash comes from sk->sk\_txhash when using TCP, except for some
IPv6 RST packets. This is because in tcp\_v6\_send\_reset when not in
TIME\_WAIT the hash is taken from sk->sk\_hash, while it should come from
sk->sk\_txhash as those two hashes are not computed the same way.
Packetdrill script to test the above,
0 socket(..., SOCK\_STREAM, IPPROTO\_TCP) = 3
+0 fcntl(3, F\_SETFL, O\_RDWR|O\_NONBLOCK) = 0
+0 connect(3, ..., ...) = -1 EINPROGRESS (Operation now in progress)
+0 > (flowlabel 0x1) S 0:0(0) <...>
// Wrong ack seq, trigger a rst.
+0 < S. 0:0(0) ack 0 win 4000
// Check the flowlabel matches prior one from SYN.
+0 > (flowlabel 0x1) R 0:0(0) <...>
Fixes: 9258b8b1be2e ("ipv6: tcp: send consistent autoflowlabel in RST packets")
Signed-off-by: Antoine Tenart
Reviewed-by: Eric Dumazet
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 69f015aae9d1ee8d46bf29e8f15f4c6db61b75cb
Author: Andrea Mayer
Date: Thu Apr 27 11:49:23 2023 +0200
selftests: srv6: make srv6\_end\_dt46\_l3vpn\_test more robust
[ Upstream commit 46ef24c60f8ee70662968ac55325297ed4624d61 ]
On some distributions, the rp\_filter is automatically set (=1) by
default on a netdev basis (also on VRFs).
In an SRv6 End.DT46 behavior, decapsulated IPv4 packets are routed using
the table associated with the VRF bound to that tunnel. During lookup
operations, the rp\_filter can lead to packet loss when activated on the
VRF.
Therefore, we chose to make this selftest more robust by explicitly
disabling the rp\_filter during tests (as it is automatically set by some
Linux distributions).
Fixes: 03a0b567a03d ("selftests: seg6: add selftest for SRv6 End.DT46 Behavior")
Reported-by: Hangbin Liu
Signed-off-by: Andrea Mayer
Tested-by: Hangbin Liu
Reviewed-by: David Ahern
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit faea6d10b42b77e376ca18905dfa93dabdba04e9
Author: Cong Wang
Date: Wed Apr 26 23:00:06 2023 -0700
sit: update dev->needed\_headroom in ipip6\_tunnel\_bind\_dev()
[ Upstream commit c88f8d5cd95fd039cff95d682b8e71100c001df0 ]
When a tunnel device is bound with the underlying device, its
dev->needed\_headroom needs to be updated properly. IPv4 tunnels
already do the same in ip\_tunnel\_bind\_dev(). Otherwise we may
not have enough header room for skb, especially after commit
b17f709a2401 ("gue: TX support for using remote checksum offload option").
Fixes: 32b8a8e59c9c ("sit: add IPv4 over IPv4 support")
Reported-by: Palash Oswal
Link: https://lore.kernel.org/netdev/CAGyP=7fDcSPKu6nttbGwt7RXzE3uyYxLjCSE97J64pRxJP8jPA@mail.gmail.com/
Cc: Kuniyuki Iwashima
Cc: Eric Dumazet
Signed-off-by: Cong Wang
Reviewed-by: Eric Dumazet
Reviewed-by: Kuniyuki Iwashima
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 7b7a74ed303d532fb73ae4b1697f16a0fea89cd0
Author: Vlad Buslov
Date: Wed Apr 26 14:31:11 2023 +0200
net/sched: cls\_api: remove block\_cb from driver\_list before freeing
[ Upstream commit da94a7781fc3c92e7df7832bc2746f4d39bc624e ]
Error handler of tcf\_block\_bind() frees the whole bo->cb\_list on error.
However, by that time the flow\_block\_cb instances are already in the driver
list because driver ndo\_setup\_tc() callback is called before that up the
call chain in tcf\_block\_offload\_cmd(). This leaves dangling pointers to
freed objects in the list and causes use-after-free[0]. Fix it by also
removing flow\_block\_cb instances from driver\_list before deallocating them.
[0]:
[ 279.868433] ==================================================================
[ 279.869964] BUG: KASAN: slab-use-after-free in flow\_block\_cb\_setup\_simple+0x631/0x7c0
[ 279.871527] Read of size 8 at addr ffff888147e2bf20 by task tc/2963
[ 279.873151] CPU: 6 PID: 2963 Comm: tc Not tainted 6.3.0-rc6+ #4
[ 279.874273] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 279.876295] Call Trace:
[ 279.876882]
[ 279.877413] dump\_stack\_lvl+0x33/0x50
[ 279.878198] print\_report+0xc2/0x610
[ 279.878987] ? flow\_block\_cb\_setup\_simple+0x631/0x7c0
[ 279.879994] kasan\_report+0xae/0xe0
[ 279.880750] ? flow\_block\_cb\_setup\_simple+0x631/0x7c0
[ 279.881744] ? mlx5e\_tc\_reoffload\_flows\_work+0x240/0x240 [mlx5\_core]
[ 279.883047] flow\_block\_cb\_setup\_simple+0x631/0x7c0
[ 279.884027] tcf\_block\_offload\_cmd.isra.0+0x189/0x2d0
[ 279.885037] ? tcf\_block\_setup+0x6b0/0x6b0
[ 279.885901] ? mutex\_lock+0x7d/0xd0
[ 279.886669] ? \_\_mutex\_unlock\_slowpath.constprop.0+0x2d0/0x2d0
[ 279.887844] ? ingress\_init+0x1c0/0x1c0 [sch\_ingress]
[ 279.888846] tcf\_block\_get\_ext+0x61c/0x1200
[ 279.889711] ingress\_init+0x112/0x1c0 [sch\_ingress]
[ 279.890682] ? clsact\_init+0x2b0/0x2b0 [sch\_ingress]
[ 279.891701] qdisc\_create+0x401/0xea0
[ 279.892485] ? qdisc\_tree\_reduce\_backlog+0x470/0x470
[ 279.893473] tc\_modify\_qdisc+0x6f7/0x16d0
[ 279.894344] ? tc\_get\_qdisc+0xac0/0xac0
[ 279.895213] ? mutex\_lock+0x7d/0xd0
[ 279.896005] ? \_\_mutex\_lock\_slowpath+0x10/0x10
[ 279.896910] rtnetlink\_rcv\_msg+0x5fe/0x9d0
[ 279.897770] ? rtnl\_calcit.isra.0+0x2b0/0x2b0
[ 279.898672] ? \_\_sys\_sendmsg+0xb5/0x140
[ 279.899494] ? do\_syscall\_64+0x3d/0x90
[ 279.900302] ? entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 279.901337] ? kasan\_save\_stack+0x2e/0x40
[ 279.902177] ? kasan\_save\_stack+0x1e/0x40
[ 279.903058] ? kasan\_set\_track+0x21/0x30
[ 279.903913] ? kasan\_save\_free\_info+0x2a/0x40
[ 279.904836] ? \_\_\_\_kasan\_slab\_free+0x11a/0x1b0
[ 279.905741] ? kmem\_cache\_free+0x179/0x400
[ 279.906599] netlink\_rcv\_skb+0x12c/0x360
[ 279.907450] ? rtnl\_calcit.isra.0+0x2b0/0x2b0
[ 279.908360] ? netlink\_ack+0x1550/0x1550
[ 279.909192] ? rhashtable\_walk\_peek+0x170/0x170
[ 279.910135] ? kmem\_cache\_alloc\_node+0x1af/0x390
[ 279.911086] ? \_copy\_from\_iter+0x3d6/0xc70
[ 279.912031] netlink\_unicast+0x553/0x790
[ 279.912864] ? netlink\_attachskb+0x6a0/0x6a0
[ 279.913763] ? netlink\_recvmsg+0x416/0xb50
[ 279.914627] netlink\_sendmsg+0x7a1/0xcb0
[ 279.915473] ? netlink\_unicast+0x790/0x790
[ 279.916334] ? iovec\_from\_user.part.0+0x4d/0x220
[ 279.917293] ? netlink\_unicast+0x790/0x790
[ 279.918159] sock\_sendmsg+0xc5/0x190
[ 279.918938] \_\_\_\_sys\_sendmsg+0x535/0x6b0
[ 279.919813] ? import\_iovec+0x7/0x10
[ 279.920601] ? kernel\_sendmsg+0x30/0x30
[ 279.921423] ? \_\_copy\_msghdr+0x3c0/0x3c0
[ 279.922254] ? import\_iovec+0x7/0x10
[ 279.923041] \_\_\_sys\_sendmsg+0xeb/0x170
[ 279.923854] ? copy\_msghdr\_from\_user+0x110/0x110
[ 279.924797] ? \_\_\_sys\_recvmsg+0xd9/0x130
[ 279.925630] ? \_\_perf\_event\_task\_sched\_in+0x183/0x470
[ 279.926656] ? \_\_\_sys\_sendmsg+0x170/0x170
[ 279.927529] ? ctx\_sched\_in+0x530/0x530
[ 279.928369] ? update\_curr+0x283/0x4f0
[ 279.929185] ? perf\_event\_update\_userpage+0x570/0x570
[ 279.930201] ? \_\_fget\_light+0x57/0x520
[ 279.931023] ? \_\_switch\_to+0x53d/0xe70
[ 279.931846] ? sockfd\_lookup\_light+0x1a/0x140
[ 279.932761] \_\_sys\_sendmsg+0xb5/0x140
[ 279.933560] ? \_\_sys\_sendmsg\_sock+0x20/0x20
[ 279.934436] ? fpregs\_assert\_state\_consistent+0x1d/0xa0
[ 279.935490] do\_syscall\_64+0x3d/0x90
[ 279.936300] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 279.937311] RIP: 0033:0x7f21c814f887
[ 279.938085] Code: 0a 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b9 0f 1f 00 f3 0f 1e fa 64 8b 04 25 18 00 00 00 85 c0 75 10 b8 2e 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 51 c3 48 83 ec 28 89 54 24 1c 48 89 74 24 10
[ 279.941448] RSP: 002b:00007fff11efd478 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
[ 279.942964] RAX: ffffffffffffffda RBX: 0000000064401979 RCX: 00007f21c814f887
[ 279.944337] RDX: 0000000000000000 RSI: 00007fff11efd4e0 RDI: 0000000000000003
[ 279.945660] RBP: 0000000000000000 R08: 0000000000000001 R09: 0000000000000000
[ 279.947003] R10: 00007f21c8008708 R11: 0000000000000246 R12: 0000000000000001
[ 279.948345] R13: 0000000000409980 R14: 000000000047e538 R15: 0000000000485400
[ 279.949690]
[ 279.950706] Allocated by task 2960:
[ 279.951471] kasan\_save\_stack+0x1e/0x40
[ 279.952338] kasan\_set\_track+0x21/0x30
[ 279.953165] \_\_kasan\_kmalloc+0x77/0x90
[ 279.954006] flow\_block\_cb\_setup\_simple+0x3dd/0x7c0
[ 279.955001] tcf\_block\_offload\_cmd.isra.0+0x189/0x2d0
[ 279.956020] tcf\_block\_get\_ext+0x61c/0x1200
[ 279.956881] ingress\_init+0x112/0x1c0 [sch\_ingress]
[ 279.957873] qdisc\_create+0x401/0xea0
[ 279.958656] tc\_modify\_qdisc+0x6f7/0x16d0
[ 279.959506] rtnetlink\_rcv\_msg+0x5fe/0x9d0
[ 279.960392] netlink\_rcv\_skb+0x12c/0x360
[ 279.961216] netlink\_unicast+0x553/0x790
[ 279.962044] netlink\_sendmsg+0x7a1/0xcb0
[ 279.962906] sock\_sendmsg+0xc5/0x190
[ 279.963702] \_\_\_\_sys\_sendmsg+0x535/0x6b0
[ 279.964534] \_\_\_sys\_sendmsg+0xeb/0x170
[ 279.965343] \_\_sys\_sendmsg+0xb5/0x140
[ 279.966132] do\_syscall\_64+0x3d/0x90
[ 279.966908] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 279.968407] Freed by task 2960:
[ 279.969114] kasan\_save\_stack+0x1e/0x40
[ 279.969929] kasan\_set\_track+0x21/0x30
[ 279.970729] kasan\_save\_free\_info+0x2a/0x40
[ 279.971603] \_\_\_\_kasan\_slab\_free+0x11a/0x1b0
[ 279.972483] \_\_kmem\_cache\_free+0x14d/0x280
[ 279.973337] tcf\_block\_setup+0x29d/0x6b0
[ 279.974173] tcf\_block\_offload\_cmd.isra.0+0x226/0x2d0
[ 279.975186] tcf\_block\_get\_ext+0x61c/0x1200
[ 279.976080] ingress\_init+0x112/0x1c0 [sch\_ingress]
[ 279.977065] qdisc\_create+0x401/0xea0
[ 279.977857] tc\_modify\_qdisc+0x6f7/0x16d0
[ 279.978695] rtnetlink\_rcv\_msg+0x5fe/0x9d0
[ 279.979562] netlink\_rcv\_skb+0x12c/0x360
[ 279.980388] netlink\_unicast+0x553/0x790
[ 279.981214] netlink\_sendmsg+0x7a1/0xcb0
[ 279.982043] sock\_sendmsg+0xc5/0x190
[ 279.982827] \_\_\_\_sys\_sendmsg+0x535/0x6b0
[ 279.983703] \_\_\_sys\_sendmsg+0xeb/0x170
[ 279.984510] \_\_sys\_sendmsg+0xb5/0x140
[ 279.985298] do\_syscall\_64+0x3d/0x90
[ 279.986076] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 279.987532] The buggy address belongs to the object at ffff888147e2bf00
which belongs to the cache kmalloc-192 of size 192
[ 279.989747] The buggy address is located 32 bytes inside of
freed 192-byte region [ffff888147e2bf00, ffff888147e2bfc0)
[ 279.992367] The buggy address belongs to the physical page:
[ 279.993430] page:00000000550f405c refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x147e2a
[ 279.995182] head:00000000550f405c order:1 entire\_mapcount:0 nr\_pages\_mapped:0 pincount:0
[ 279.996713] anon flags: 0x200000000010200(slab|head|node=0|zone=2)
[ 279.997878] raw: 0200000000010200 ffff888100042a00 0000000000000000 dead000000000001
[ 279.999384] raw: 0000000000000000 0000000000200020 00000001ffffffff 0000000000000000
[ 280.000894] page dumped because: kasan: bad access detected
[ 280.002386] Memory state around the buggy address:
[ 280.003338] ffff888147e2be00: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 280.004781] ffff888147e2be80: fb fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ 280.006224] >ffff888147e2bf00: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 280.007700] ^
[ 280.008592] ffff888147e2bf80: fb fb fb fb fb fb fb fb fc fc fc fc fc fc fc fc
[ 280.010035] ffff888147e2c000: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 280.011564] ==================================================================
Fixes: 59094b1e5094 ("net: sched: use flow block API")
Signed-off-by: Vlad Buslov
Reviewed-by: Simon Horman
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 9cd62f0ba465cf647c7d8c2ca7b0d99ea0c1328f
Author: Eric Dumazet
Date: Fri Apr 28 04:32:31 2023 +0000
tcp: fix skb\_copy\_ubufs() vs BIG TCP
[ Upstream commit 7e692df3933628d974acb9f5b334d2b3e885e2a6 ]
David Ahern reported crashes in skb\_copy\_ubufs() caused by TCP tx zerocopy
using hugepages, and skb length bigger than ~68 KB.
skb\_copy\_ubufs() assumed it could copy all payload using up to
MAX\_SKB\_FRAGS order-0 pages.
This assumption broke when BIG TCP was able to put up to 512 KB per skb.
We did not hit this bug at Google because we use CONFIG\_MAX\_SKB\_FRAGS=45
and limit gso\_max\_size to 180000.
A solution is to use higher order pages if needed.
v2: add missing \_\_GFP\_COMP, or we leak memory.
Fixes: 7c4e983c4f3c ("net: allow gso\_max\_size to exceed 65536")
Reported-by: David Ahern
Link: https://lore.kernel.org/netdev/c70000f6-baa4-4a05-46d0-4b3e0dc1ccc8@gmail.com/T/
Signed-off-by: Eric Dumazet
Cc: Xin Long
Cc: Willem de Bruijn
Cc: Coco Li
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 27d5e46e5b977c07593666d24f661e5f454a02d2
Author: Cosmo Chou
Date: Wed Apr 26 16:13:50 2023 +0800
net/ncsi: clear Tx enable mode when handling a Config required AEN
[ Upstream commit 6f75cd166a5a3c0bc50441faa8b8304f60522fdd ]
ncsi\_channel\_is\_tx() determines whether a given channel should be
used for Tx or not. However, when reconfiguring the channel by
handling a Configuration Required AEN, there is a misjudgment that
the channel Tx has already been enabled, which results in the Enable
Channel Network Tx command not being sent.
Clear the channel Tx enable flag before reconfiguring the channel to
avoid the misjudgment.
Fixes: 8d951a75d022 ("net/ncsi: Configure multi-package, multi-channel modes with failover")
Signed-off-by: Cosmo Chou
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 63d2de4c5f268774c56cbe187d3c4fc325175bd6
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:28 2023 +0530
octeontx2-pf: mcs: Do not reset PN while updating secy
[ Upstream commit 3c99bace4ad08ad0264285ba8ad73117560992c2 ]
After creating SecYs, SCs and SAs a SecY can be modified
to change attributes like validation mode, protect frames
mode etc. During this SecY update, packet number is reset to
initial user given value by mistake. Hence do not reset
PN when updating SecY parameters.
Fixes: c54ffc73601c ("octeontx2-pf: mcs: Introduce MACSEC hardware offloading")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 6be8b77b969f8e6176d5b822938880c93d914845
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:27 2023 +0530
octeontx2-pf: mcs: Fix shared counters logic
[ Upstream commit 9bdfe61054fb2b989eb58df20bf99c0cf67e3038 ]
Macsec stats like InPktsLate and InPktsDelayed share
same counter in hardware. If SecY replay\_protect is true
then counter represents InPktsLate otherwise InPktsDelayed.
This mode change was tracked based on protect\_frames
instead of replay\_protect mistakenly. Similarly InPktsUnchecked
and InPktsOk share same counter and mode change was tracked
based on validate\_check instead of validate\_disabled.
This patch fixes those problems.
Fixes: c54ffc73601c ("octeontx2-pf: mcs: Introduce MACSEC hardware offloading")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 9f0079b5f43796d663a8ad9ac15db48fa63f3add
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:26 2023 +0530
octeontx2-pf: mcs: Clear stats before freeing resource
[ Upstream commit 815debbbf7b52026462c37eea3be70d6377a7a9a ]
When freeing MCS hardware resources like SecY, SC and
SA the corresponding stats needs to be cleared. Otherwise
previous stats are shown in newly created macsec interfaces.
Fixes: c54ffc73601c ("octeontx2-pf: mcs: Introduce MACSEC hardware offloading")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 029ff0cf782601f9d2c5a408e0308b04384b91df
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:25 2023 +0530
octeontx2-pf: mcs: Match macsec ethertype along with DMAC
[ Upstream commit 57d00d4364f314485092667d2a48718985515deb ]
On CN10KB silicon a single hardware macsec block is
present and offloads macsec operations for all the
ethernet LMACs. TCAM match with macsec ethertype 0x88e5
alone at RX side is not sufficient to distinguish all the
macsec interfaces created on top of netdevs. Hence append
the DMAC of the macsec interface too. Otherwise the first
created macsec interface only receives all the macsec traffic.
Fixes: c54ffc73601c ("octeontx2-pf: mcs: Introduce MACSEC hardware offloading")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 13ff119b17e5e2916435ce01a0156c8698ad9e16
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:24 2023 +0530
octeontx2-pf: mcs: Fix NULL pointer dereferences
[ Upstream commit 699af748c61574125d269db260dabbe20436d74e ]
When system is rebooted after creating macsec interface
below NULL pointer dereference crashes occurred. This
patch fixes those crashes by using correct order of teardown
[ 3324.406942] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 3324.415726] Mem abort info:
[ 3324.418510] ESR = 0x96000006
[ 3324.421557] EC = 0x25: DABT (current EL), IL = 32 bits
[ 3324.426865] SET = 0, FnV = 0
[ 3324.429913] EA = 0, S1PTW = 0
[ 3324.433047] Data abort info:
[ 3324.435921] ISV = 0, ISS = 0x00000006
[ 3324.439748] CM = 0, WnR = 0
....
[ 3324.575915] Call trace:
[ 3324.578353] cn10k\_mdo\_del\_secy+0x24/0x180
[ 3324.582440] macsec\_common\_dellink+0xec/0x120
[ 3324.586788] macsec\_notify+0x17c/0x1c0
[ 3324.590529] raw\_notifier\_call\_chain+0x50/0x70
[ 3324.594965] call\_netdevice\_notifiers\_info+0x34/0x7c
[ 3324.599921] rollback\_registered\_many+0x354/0x5bc
[ 3324.604616] unregister\_netdevice\_queue+0x88/0x10c
[ 3324.609399] unregister\_netdev+0x20/0x30
[ 3324.613313] otx2\_remove+0x8c/0x310
[ 3324.616794] pci\_device\_shutdown+0x30/0x70
[ 3324.620882] device\_shutdown+0x11c/0x204
[ 966.664930] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[ 966.673712] Mem abort info:
[ 966.676497] ESR = 0x96000006
[ 966.679543] EC = 0x25: DABT (current EL), IL = 32 bits
[ 966.684848] SET = 0, FnV = 0
[ 966.687895] EA = 0, S1PTW = 0
[ 966.691028] Data abort info:
[ 966.693900] ISV = 0, ISS = 0x00000006
[ 966.697729] CM = 0, WnR = 0
[ 966.833467] Call trace:
[ 966.835904] cn10k\_mdo\_stop+0x20/0xa0
[ 966.839557] macsec\_dev\_stop+0xe8/0x11c
[ 966.843384] \_\_dev\_close\_many+0xbc/0x140
[ 966.847298] dev\_close\_many+0x84/0x120
[ 966.851039] rollback\_registered\_many+0x114/0x5bc
[ 966.855735] unregister\_netdevice\_many.part.0+0x14/0xa0
[ 966.860952] unregister\_netdevice\_many+0x18/0x24
[ 966.865560] macsec\_notify+0x1ac/0x1c0
[ 966.869303] raw\_notifier\_call\_chain+0x50/0x70
[ 966.873738] call\_netdevice\_notifiers\_info+0x34/0x7c
[ 966.878694] rollback\_registered\_many+0x354/0x5bc
[ 966.883390] unregister\_netdevice\_queue+0x88/0x10c
[ 966.888173] unregister\_netdev+0x20/0x30
[ 966.892090] otx2\_remove+0x8c/0x310
[ 966.895571] pci\_device\_shutdown+0x30/0x70
[ 966.899660] device\_shutdown+0x11c/0x204
[ 966.903574] \_\_do\_sys\_reboot+0x208/0x290
[ 966.907487] \_\_arm64\_sys\_reboot+0x20/0x30
[ 966.911489] el0\_svc\_handler+0x80/0x1c0
[ 966.915316] el0\_svc+0x8/0x180
[ 966.918362] Code: f9400000 f9400a64 91220014 f94b3403 (f9400060)
[ 966.924448] ---[ end trace 341778e799c3d8d7 ]---
Fixes: c54ffc73601c ("octeontx2-pf: mcs: Introduce MACSEC hardware offloading")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 8089e3efe86583c79e04f1282f97c3774379cbb3
Author: Geetha sowjanya
Date: Wed Apr 26 11:55:23 2023 +0530
octeontx2-af: mcs: Fix MCS block interrupt
[ Upstream commit b8aebeaaf9ffb1e99c642eb3751e28981f9be475 ]
On CN10KB, MCS IP vector number, BBE and PAB interrupt mask
got changed to support more block level interrupts.
To address this changes, this patch fixes the bbe and pab
interrupt handlers.
Fixes: 6c635f78c474 ("octeontx2-af: cn10k: mcs: Handle MCS block interrupts")
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 77a43f4736f038381b988499987949298edbbd7b
Author: Geetha sowjanya
Date: Wed Apr 26 11:55:22 2023 +0530
octeontx2-af: mcs: Config parser to skip 8B header
[ Upstream commit 65cdc2b637a5749c7dec0ce14fe2c48f1f91f671 ]
When ptp timestamp is enabled in RPM, RPM will append 8B
timestamp header for all RX traffic. MCS need to skip these
8 bytes header while parsing the packet header, so that
correct tcam key is created for lookup.
This patch fixes the mcs parser configuration to skip this
8B header for ptp packets.
Fixes: ca7f49ff8846 ("octeontx2-af: cn10k: Introduce driver for macsec block.")
Signed-off-by: Sunil Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 4a7c530edd9139f45e1470c4d3f5ab524f784ace
Author: Subbaraya Sundeep
Date: Wed Apr 26 11:55:21 2023 +0530
octeontx2-af: mcs: Write TCAM\_DATA and TCAM\_MASK registers at once
[ Upstream commit b51612198603fce33d6cf57b4864e3018a1cd9b8 ]
As per hardware errata on CN10KB, all the four TCAM\_DATA
and TCAM\_MASK registers has to be written at once otherwise
write to individual registers will fail. Hence write to all
TCAM\_DATA registers and then to all TCAM\_MASK registers.
Fixes: cfc14181d497 ("octeontx2-af: cn10k: mcs: Manage the MCS block hardware resources")
Signed-off-by: Subbaraya Sundeep
Signed-off-by: Sunil Kovvuri Goutham
Signed-off-by: Geetha sowjanya
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit b7d1644164cbfff3e6bf1b5c6c8a55661bffc4ed
Author: Geetha sowjanya
Date: Wed Apr 26 11:55:20 2023 +0530
octeonxt2-af: mcs: Fix per port bypass config
[ Upstream commit c222b292a3568754828ffd30338d2909b14ed160 ]
For each lmac port, MCS has two MCS\_TOP\_SLAVE\_CHANNEL\_CONFIGX
registers. For CN10KB both register need to be configured for the
port level mcs bypass to work. This patch also sets bitmap
of flowid/secy entry reserved for default bypass so that these
entries can be shown in debugfs.
Fixes: bd69476e86fc ("octeontx2-af: cn10k: mcs: Install a default TCAM for normal traffic")
Signed-off-by: Geetha sowjanya
Signed-off-by: Sunil Goutham
Reviewed-by: Leon Romanovsky
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 4cd43a19900d0b98c1ec4bb6984763369d2e19ec
Author: John Hickey
Date: Tue Apr 25 10:03:08 2023 -0700
ixgbe: Fix panic during XDP\_TX with > 64 CPUs
[ Upstream commit c23ae5091a8b3e50fe755257df020907e7c029bb ]
Commit 4fe815850bdc ("ixgbe: let the xdpdrv work with more than 64 cpus")
adds support to allow XDP programs to run on systems with more than
64 CPUs by locking the XDP TX rings and indexing them using cpu % 64
(IXGBE\_MAX\_XDP\_QS).
Upon trying this out patch on a system with more than 64 cores,
the kernel paniced with an array-index-out-of-bounds at the return in
ixgbe\_determine\_xdp\_ring in ixgbe.h, which means ixgbe\_determine\_xdp\_q\_idx
was just returning the cpu instead of cpu % IXGBE\_MAX\_XDP\_QS. An example
splat:
==========================================================================
UBSAN: array-index-out-of-bounds in
/var/lib/dkms/ixgbe/5.18.6+focal-1/build/src/ixgbe.h:1147:26
index 65 is out of range for type 'ixgbe\_ring \*[64]'
==========================================================================
BUG: kernel NULL pointer dereference, address: 0000000000000058
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
CPU: 65 PID: 408 Comm: ksoftirqd/65
Tainted: G IOE 5.15.0-48-generic #54~20.04.1-Ubuntu
Hardware name: Dell Inc. PowerEdge R640/0W23H8, BIOS 2.5.4 01/13/2020
RIP: 0010:ixgbe\_xmit\_xdp\_ring+0x1b/0x1c0 [ixgbe]
Code: 3b 52 d4 cf e9 42 f2 ff ff 66 0f 1f 44 00 00 0f 1f 44 00 00 55 b9
00 00 00 00 48 89 e5 41 57 41 56 41 55 41 54 53 48 83 ec 08 <44> 0f b7
47 58 0f b7 47 5a 0f b7 57 54 44 0f b7 76 08 66 41 39 c0
RSP: 0018:ffffbc3fcd88fcb0 EFLAGS: 00010282
RAX: ffff92a253260980 RBX: ffffbc3fe68b00a0 RCX: 0000000000000000
RDX: ffff928b5f659000 RSI: ffff928b5f659000 RDI: 0000000000000000
RBP: ffffbc3fcd88fce0 R08: ffff92b9dfc20580 R09: 0000000000000001
R10: 3d3d3d3d3d3d3d3d R11: 3d3d3d3d3d3d3d3d R12: 0000000000000000
R13: ffff928b2f0fa8c0 R14: ffff928b9be20050 R15: 000000000000003c
FS: 0000000000000000(0000) GS:ffff92b9dfc00000(0000)
knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000058 CR3: 000000011dd6a002 CR4: 00000000007706e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
PKRU: 55555554
Call Trace:
ixgbe\_poll+0x103e/0x1280 [ixgbe]
? sched\_clock\_cpu+0x12/0xe0
\_\_napi\_poll+0x30/0x160
net\_rx\_action+0x11c/0x270
\_\_do\_softirq+0xda/0x2ee
run\_ksoftirqd+0x2f/0x50
smpboot\_thread\_fn+0xb7/0x150
? sort\_range+0x30/0x30
kthread+0x127/0x150
? set\_kthread\_struct+0x50/0x50
ret\_from\_fork+0x1f/0x30

I think this is how it happens:
Upon loading the first XDP program on a system with more than 64 CPUs,
ixgbe\_xdp\_locking\_key is incremented in ixgbe\_xdp\_setup. However,
immediately after this, the rings are reconfigured by ixgbe\_setup\_tc.
ixgbe\_setup\_tc calls ixgbe\_clear\_interrupt\_scheme which calls
ixgbe\_free\_q\_vectors which calls ixgbe\_free\_q\_vector in a loop.
ixgbe\_free\_q\_vector decrements ixgbe\_xdp\_locking\_key once per call if
it is non-zero. Commenting out the decrement in ixgbe\_free\_q\_vector
stopped my system from panicing.
I suspect to make the original patch work, I would need to load an XDP
program and then replace it in order to get ixgbe\_xdp\_locking\_key back
above 0 since ixgbe\_setup\_tc is only called when transitioning between
XDP and non-XDP ring configurations, while ixgbe\_xdp\_locking\_key is
incremented every time ixgbe\_xdp\_setup is called.
Also, ixgbe\_setup\_tc can be called via ethtool --set-channels, so this
becomes another path to decrement ixgbe\_xdp\_locking\_key to 0 on systems
with more than 64 CPUs.
Since ixgbe\_xdp\_locking\_key only protects the XDP\_TX path and is tied
to the number of CPUs present, there is no reason to disable it upon
unloading an XDP program. To avoid confusion, I have moved enabling
ixgbe\_xdp\_locking\_key into ixgbe\_sw\_init, which is part of the probe path.
Fixes: 4fe815850bdc ("ixgbe: let the xdpdrv work with more than 64 cpus")
Signed-off-by: John Hickey
Reviewed-by: Maciej Fijalkowski
Tested-by: Chandan Kumar Rout  (A Contingent Worker at Intel)
Signed-off-by: Tony Nguyen
Link: https://lore.kernel.org/r/20230425170308.2522429-1-anthony.l.nguyen@intel.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit d9607ae4129d79351d9958cfa8cf063090151135
Author: Ivan Vecera
Date: Tue Apr 25 16:06:04 2023 +0200
net/sched: flower: Fix wrong handle assignment during filter change
[ Upstream commit 32eff6bacec2cb574677c15378169a9fa30043ef ]
Commit 08a0063df3ae ("net/sched: flower: Move filter handle initialization
earlier") moved filter handle initialization but an assignment of
the handle to fnew->handle is done regardless of fold value. This is wrong
because if fold != NULL (so fold->handle == handle) no new handle is
allocated and passed handle is assigned to fnew->handle. Then if any
subsequent action in fl\_change() fails then the handle value is
removed from IDR that is incorrect as we will have still valid old filter
instance with handle that is not present in IDR.
Fix this issue by moving the assignment so it is done only when passed
fold == NULL.
Prior the patch:
[root@machine tc-testing]# ./tdc.py -d enp1s0f0np0 -e 14be
Test 14be: Concurrently replace same range of 100k flower filters from 10 tc instances
exit: 123
exit: 0
RTNETLINK answers: Invalid argument
We have an error talking to the kernel
Command failed tmp/replace\_6:1885
All test results:
1..1
not ok 1 14be - Concurrently replace same range of 100k flower filters from 10 tc instances
Command exited with 123, expected 0
RTNETLINK answers: Invalid argument
We have an error talking to the kernel
Command failed tmp/replace\_6:1885
After the patch:
[root@machine tc-testing]# ./tdc.py -d enp1s0f0np0 -e 14be
Test 14be: Concurrently replace same range of 100k flower filters from 10 tc instances
All test results:
1..1
ok 1 14be - Concurrently replace same range of 100k flower filters from 10 tc instances
Fixes: 08a0063df3ae ("net/sched: flower: Move filter handle initialization earlier")
Signed-off-by: Ivan Vecera
Reviewed-by: Simon Horman
Link: https://lore.kernel.org/r/20230425140604.169881-1-ivecera@redhat.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 454e48a9ff04c5fa1631bb172070fcb6389b97f9
Author: David Howells
Date: Tue Apr 25 13:56:35 2023 +0100
rxrpc: Fix potential data race in rxrpc\_wait\_to\_be\_connected()
[ Upstream commit 2b5fdc0f5caa505afe34d608e2eefadadf2ee67a ]
Inside the loop in rxrpc\_wait\_to\_be\_connected() it checks call->error to
see if it should exit the loop without first checking the call state. This
is probably safe as if call->error is set, the call is dead anyway, but we
should probably wait for the call state to have been set to completion
first, lest it cause surprise on the way out.
Fix this by only accessing call->error if the call is complete. We don't
actually need to access the error inside the loop as we'll do that after.
This caused the following report:
BUG: KCSAN: data-race in rxrpc\_send\_data / rxrpc\_set\_call\_completion
write to 0xffff888159cf3c50 of 4 bytes by task 25673 on cpu 1:
rxrpc\_set\_call\_completion+0x71/0x1c0 net/rxrpc/call\_state.c:22
rxrpc\_send\_data\_packet+0xba9/0x1650 net/rxrpc/output.c:479
rxrpc\_transmit\_one+0x1e/0x130 net/rxrpc/output.c:714
rxrpc\_decant\_prepared\_tx net/rxrpc/call\_event.c:326 [inline]
rxrpc\_transmit\_some\_data+0x496/0x600 net/rxrpc/call\_event.c:350
rxrpc\_input\_call\_event+0x564/0x1220 net/rxrpc/call\_event.c:464
rxrpc\_io\_thread+0x307/0x1d80 net/rxrpc/io\_thread.c:461
kthread+0x1ac/0x1e0 kernel/kthread.c:376
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:308
read to 0xffff888159cf3c50 of 4 bytes by task 25672 on cpu 0:
rxrpc\_send\_data+0x29e/0x1950 net/rxrpc/sendmsg.c:296
rxrpc\_do\_sendmsg+0xb7a/0xc20 net/rxrpc/sendmsg.c:726
rxrpc\_sendmsg+0x413/0x520 net/rxrpc/af\_rxrpc.c:565
sock\_sendmsg\_nosec net/socket.c:724 [inline]
sock\_sendmsg net/socket.c:747 [inline]
\_\_\_\_sys\_sendmsg+0x375/0x4c0 net/socket.c:2501
\_\_\_sys\_sendmsg net/socket.c:2555 [inline]
\_\_sys\_sendmmsg+0x263/0x500 net/socket.c:2641
\_\_do\_sys\_sendmmsg net/socket.c:2670 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2667 [inline]
\_\_x64\_sys\_sendmmsg+0x57/0x60 net/socket.c:2667
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x41/0xc0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
value changed: 0x00000000 -> 0xffffffea
Fixes: 9d35d880e0e4 ("rxrpc: Move client call connection to the I/O thread")
Reported-by: syzbot+ebc945fdb4acd72cba78@syzkaller.appspotmail.com
Link: https://lore.kernel.org/r/000000000000e7c6d205fa10a3cd@google.com/
Signed-off-by: David Howells
cc: Marc Dionne
cc: Dmitry Vyukov
cc: "David S. Miller"
cc: Eric Dumazet
cc: Jakub Kicinski
cc: Paolo Abeni
cc: linux-afs@lists.infradead.org
cc: linux-fsdevel@vger.kernel.org
cc: netdev@vger.kernel.org
Link: https://lore.kernel.org/r/508133.1682427395@warthog.procyon.org.uk
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit b1b112ea6e480c331603f695e050b4d1fbf8d59e
Author: Aurabindo Pillai
Date: Thu Apr 6 15:59:45 2023 -0400
drm/amd/display: Update bounding box values for DCN321
[ Upstream commit 989cd3e76a4aab76fe7dd50090ac3fa501c537f6 ]
[Why&how]
Update bounding box values as per hardware spec
Fixes: 197485c69543 ("drm/amd/display: Create dcn321\_fpu file")
Acked-by: Leo Li
Signed-off-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 97582ac14bd23c72485bbdd980f40bbb4d4ba6b0
Author: Aurabindo Pillai
Date: Thu Apr 6 15:48:48 2023 -0400
drm/amd/display: Do not clear GPINT register when releasing DMUB from reset
[ Upstream commit 99d92eaca5d915763b240aae24669f5bf3227ecf ]
[Why & How]
There's no need to clear GPINT register for DMUB
when releasing it from reset. Fix that.
Fixes: ac2e555e0a7f ("drm/amd/display: Add DMCUB source files and changes for DCN32/321")
Reviewed-by: Leo Li
Signed-off-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit fb387219e905431698d60f40ac3333ee5952e986
Author: Cruise Hung
Date: Fri May 13 09:16:42 2022 +0800
drm/amd/display: Reset OUTBOX0 r/w pointer on DMUB reset
[ Upstream commit 425afa0ac99a05b39e6cd00704fa0e3e925cee2b ]
[Why & How]
We missed resetting OUTBOX0 mailbox r/w pointer on DMUB reset.
Fix it.
Fixes: 6ecf9773a503 ("drm/amd/display: Fix DMUB outbox trace in S4 (#4465)")
Signed-off-by: Cruise Hung
Acked-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 62eaf89a89f0eaae4aacf5f2306d1a88de80d998
Author: Aurabindo Pillai
Date: Thu Apr 6 12:28:59 2023 -0400
drm/amd/display: Fixes for dcn32\_clk\_mgr implementation
[ Upstream commit d1c5c3e252b8a911a524e6ee33b82aca81397745 ]
[Why&How]
Fix CLK MGR early initialization and add logging.
Fixes: 265280b99822 ("drm/amd/display: add CLKMGR changes for DCN32/321")
Reviewed-by: Leo Li
Reviewed-by: Qingqing Zhuo
Signed-off-by: Aurabindo Pillai
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit afaf980a0b683df6476ee97f9bcbfa6ae74504bb
Author: Hersen Wu
Date: Sun May 29 10:54:30 2022 -0400
drm/amd/display: Return error code on DSC atomic check failure
[ Upstream commit dd24662d9dfbad281bbf030f06d68c7938fa0c66 ]
[Why&How]
We were not returning -EINVAL on DSC atomic check fail. Add it.
Fixes: 71be4b16d39a ("drm/amd/display: dsc validate fail not pass to atomic check")
Reviewed-by: Aurabindo Pillai
Signed-off-by: Hersen Wu
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 4b5020042aced066b5e3eaeb926ae640b5dbf4d6
Author: Rodrigo Siqueira
Date: Tue Apr 4 14:54:05 2023 -0600
drm/amd/display: Add missing WA and MCLK validation
[ Upstream commit 822b84ecfc646da0f87fd947fa00dc3be5e45ecc ]
When the commit fff7eb56b376 ("drm/amd/display: Don't set dram clock
change requirement for SubVP") was merged, we missed some parts
associated with the MCLK switch. This commit adds all the missing parts.
Fixes: fff7eb56b376 ("drm/amd/display: Don't set dram clock change requirement for SubVP")
Reviewed-by: Aurabindo Pillai
Signed-off-by: Rodrigo Siqueira
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 2da41c8e1c98b14b773b5a7796e0a83aaa66d547
Author: Neeraj Upadhyay
Date: Tue Apr 25 15:27:00 2023 +0530
arm64: Fix label placement in record\_mmu\_state()
[ Upstream commit 4e8f6e44bce8da3b0e2df37b12839f4bc9c9cabe ]
Fix label so that pre\_disable\_mmu\_workaround() is called
before clearing sctlr\_el1.M.
Fixes: 2ced0f30a426 ("arm64: head: Switch endianness before populating the ID map")
Signed-off-by: Neeraj Upadhyay
Acked-by: Ard Biesheuvel
Link: https://lore.kernel.org/r/20230425095700.22005-1-quic\_neeraju@quicinc.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 124027cd1a624ce0347adcd59241a9966a726b22
Author: Zheng Wang
Date: Thu Apr 13 11:34:22 2023 +0800
scsi: qedi: Fix use after free bug in qedi\_remove()
[ Upstream commit c5749639f2d0a1f6cbe187d05f70c2e7c544d748 ]
In qedi\_probe() we call \_\_qedi\_probe() which initializes
&qedi->recovery\_work with qedi\_recovery\_handler() and
&qedi->board\_disable\_work with qedi\_board\_disable\_work().
When qedi\_schedule\_recovery\_handler() is called, schedule\_delayed\_work()
will finally start the work.
In qedi\_remove(), which is called to remove the driver, the following
sequence may be observed:
Fix this by finishing the work before cleanup in qedi\_remove().
CPU0 CPU1
|qedi\_recovery\_handler
qedi\_remove |
\_\_qedi\_remove |
iscsi\_host\_free |
scsi\_host\_put |
//free shost |
|iscsi\_host\_for\_each\_session
|//use qedi->shost
Cancel recovery\_work and board\_disable\_work in \_\_qedi\_remove().
Fixes: 4b1068f5d74b ("scsi: qedi: Add MFW error recovery process")
Signed-off-by: Zheng Wang
Link: https://lore.kernel.org/r/20230413033422.28003-1-zyytlz.wz@163.com
Acked-by: Manish Rangankar
Reviewed-by: Mike Christie
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 2ce8c49c7b53e0a2258b833eeab16a6d78f732d1
Author: Alice Chao
Date: Mon Apr 24 16:03:56 2023 +0800
scsi: ufs: core: mcq: Fix &hwq->cq\_lock deadlock issue
[ Upstream commit 948afc69615167a3c82430f99bfd046332b89912 ]
When ufshcd\_err\_handler() is executed, CQ event interrupt can enter waiting
for the same lock. This can happen in ufshcd\_handle\_mcq\_cq\_events() and
also in ufs\_mtk\_mcq\_intr(). The following warning message will be generated
when &hwq->cq\_lock is used in IRQ context with IRQ enabled. Use
ufshcd\_mcq\_poll\_cqe\_lock() with spin\_lock\_irqsave instead of spin\_lock to
resolve the deadlock issue.
[name:lockdep&]WARNING: inconsistent lock state
[name:lockdep&]--------------------------------
[name:lockdep&]inconsistent {IN-HARDIRQ-W} -> {HARDIRQ-ON-W} usage.
[name:lockdep&]kworker/u16:4/260 [HC0[0]:SC0[0]:HE1:SE1] takes:
ffffff8028444600 (&hwq->cq\_lock){?.-.}-{2:2}, at:
ufshcd\_mcq\_poll\_cqe\_lock+0x30/0xe0
[name:lockdep&]{IN-HARDIRQ-W} state was registered at:
lock\_acquire+0x17c/0x33c
\_raw\_spin\_lock+0x5c/0x7c
ufshcd\_mcq\_poll\_cqe\_lock+0x30/0xe0
ufs\_mtk\_mcq\_intr+0x60/0x1bc [ufs\_mediatek\_mod]
\_\_handle\_irq\_event\_percpu+0x140/0x3ec
handle\_irq\_event+0x50/0xd8
handle\_fasteoi\_irq+0x148/0x2b0
generic\_handle\_domain\_irq+0x4c/0x6c
gic\_handle\_irq+0x58/0x134
call\_on\_irq\_stack+0x40/0x74
do\_interrupt\_handler+0x84/0xe4
el1\_interrupt+0x3c/0x78
Possible unsafe locking scenario:
CPU0
----
lock(&hwq->cq\_lock);
lock(&hwq->cq\_lock);
\*\*\* DEADLOCK \*\*\*
2 locks held by kworker/u16:4/260:
[name:lockdep&]
stack backtrace:
CPU: 7 PID: 260 Comm: kworker/u16:4 Tainted: G S W OE
6.1.17-mainline-android14-2-g277223301adb #1
Workqueue: ufs\_eh\_wq\_0 ufshcd\_err\_handler
Call trace:
dump\_backtrace+0x10c/0x160
show\_stack+0x20/0x30
dump\_stack\_lvl+0x98/0xd8
dump\_stack+0x20/0x60
print\_usage\_bug+0x584/0x76c
mark\_lock\_irq+0x488/0x510
mark\_lock+0x1ec/0x25c
\_\_lock\_acquire+0x4d8/0xffc
lock\_acquire+0x17c/0x33c
\_raw\_spin\_lock+0x5c/0x7c
ufshcd\_mcq\_poll\_cqe\_lock+0x30/0xe0
ufshcd\_poll+0x68/0x1b0
ufshcd\_transfer\_req\_compl+0x9c/0xc8
ufshcd\_err\_handler+0x3bc/0xea0
process\_one\_work+0x2f4/0x7e8
worker\_thread+0x234/0x450
kthread+0x110/0x134
ret\_from\_fork+0x10/0x20
Fixes: ed975065c31c ("scsi: ufs: core: mcq: Add completion support in poll")
Reviewed-by: Can Guo
Reviewed-by: Stanley Chu
Signed-off-by: Alice Chao
Link: https://lore.kernel.org/r/20230424080400.8955-1-alice.chao@mediatek.com
Reviewed-by: AngeloGioacchino Del Regno
Reviewed-by: Bart Van Assche
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit b8761206ef521b69948e09aeb83aee1f2fcab2bd
Author: Hans de Goede
Date: Fri Apr 21 20:37:14 2023 +0200
ASoC: Intel: soc-acpi-byt: Fix "WM510205" match no longer working
[ Upstream commit c963e2ec095cb3f855890be53f56f5a6c6fbe371 ]
Commit 7e1d728a94ca ("ASoC: Intel: soc-acpi-byt: Add new WM5102 ACPI HID")
added an extra HID to wm5102\_comp\_ids.codecs, but it forgot to bump
wm5102\_comp\_ids.num\_codecs, causing the last codec HID in the codecs list
to no longer work.
Bump wm5102\_comp\_ids.num\_codecs to fix this.
Fixes: 7e1d728a94ca ("ASoC: Intel: soc-acpi-byt: Add new WM5102 ACPI HID")
Signed-off-by: Hans de Goede
Acked-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20230421183714.35186-1-hdegoede@redhat.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 1fa1410af5ae0f02761ddb761be88ccef1057af3
Author: Bob Pearson
Date: Fri Mar 3 16:16:23 2023 -0600
RDMA/rxe: Extend dbg log messages to err and info
[ Upstream commit 9ac01f434a1eb56ea94611bd75cf62fa276b41f4 ]
Extend the dbg log messages (e.g. rxe\_dbg\_xxx) to include
err and info types. rxe.c is modified to use these new log
messages as examples.
Link: https://lore.kernel.org/r/20230303221623.8053-4-rpearsonhpe@gmail.com
Signed-off-by: Bob Pearson
Signed-off-by: Jason Gunthorpe
Stable-dep-of: 78b26a335310 ("RDMA/rxe: Remove tasklet call from rxe\_cq.c")
Signed-off-by: Sasha Levin
commit 43b503d4ed18bc85f5a0b9dcdf2a1faf8746fda4
Author: Bob Pearson
Date: Fri Mar 3 16:16:22 2023 -0600
RDMA/rxe: Change rxe\_dbg to rxe\_dbg\_dev
[ Upstream commit a9fb3287211e64b94ceb2b6b4791cc2b829d0d56 ]
Replace the name rxe\_dbg with rxe\_dbg\_dev which better matches
the remaining rxe\_dbg\_xxx macros for debug messages with a
rxe device parameter. Reuse the name rxe\_dbg for debug messages
which do not have a rxe device parameter.
Link: https://lore.kernel.org/r/20230303221623.8053-3-rpearsonhpe@gmail.com
Signed-off-by: Bob Pearson
Signed-off-by: Jason Gunthorpe
Stable-dep-of: 78b26a335310 ("RDMA/rxe: Remove tasklet call from rxe\_cq.c")
Signed-off-by: Sasha Levin
commit e78240bc4b94fc42854d65e657bb998100cc8e1b
Author: ZhangPeng
Date: Fri Nov 25 10:21:59 2022 +0000
fs/ntfs3: Fix null-ptr-deref on inode->i\_op in ntfs\_lookup()
[ Upstream commit 254e69f284d7270e0abdc023ee53b71401c3ba0c ]
Syzbot reported a null-ptr-deref bug:
ntfs3: loop0: Different NTFS' sector size (1024) and media sector size
(512)
ntfs3: loop0: Mark volume as dirty due to NTFS errors
general protection fault, probably for non-canonical address
0xdffffc0000000001: 0000 [#1] PREEMPT SMP KASAN
KASAN: null-ptr-deref in range [0x0000000000000008-0x000000000000000f]
RIP: 0010:d\_flags\_for\_inode fs/dcache.c:1980 [inline]
RIP: 0010:\_\_d\_add+0x5ce/0x800 fs/dcache.c:2796
Call Trace:
d\_splice\_alias+0x122/0x3b0 fs/dcache.c:3191
lookup\_open fs/namei.c:3391 [inline]
open\_last\_lookups fs/namei.c:3481 [inline]
path\_openat+0x10e6/0x2df0 fs/namei.c:3688
do\_filp\_open+0x264/0x4f0 fs/namei.c:3718
do\_sys\_openat2+0x124/0x4e0 fs/open.c:1310
do\_sys\_open fs/open.c:1326 [inline]
\_\_do\_sys\_open fs/open.c:1334 [inline]
\_\_se\_sys\_open fs/open.c:1330 [inline]
\_\_x64\_sys\_open+0x221/0x270 fs/open.c:1330
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3d/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
If the MFT record of ntfs inode is not a base record, inode->i\_op can be
NULL. And a null-ptr-deref may happen:
ntfs\_lookup()
dir\_search\_u() # inode->i\_op is set to NULL
d\_splice\_alias()
\_\_d\_add()
d\_flags\_for\_inode() # inode->i\_op->get\_link null-ptr-deref
Fix this by adding a Check on inode->i\_op before calling the
d\_splice\_alias() function.
Fixes: 4342306f0f0d ("fs/ntfs3: Add file operations and implementation")
Reported-by: syzbot+a8f26a403c169b7593fe@syzkaller.appspotmail.com
Signed-off-by: ZhangPeng
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 8eac4cb8ab0a621e042eeeec2920f45f47530b9d
Author: Takahiro Kuwano
Date: Thu Apr 6 15:17:45 2023 +0900
mtd: spi-nor: spansion: Enable JFFS2 write buffer for Infineon s25hx SEMPER flash
[ Upstream commit 4199c1719e24e73be0acc8b0146fc31ad8af9771 ]
Infineon(Cypress) SEMPER NOR flash family has on-die ECC and its program
granularity is 16-byte ECC data unit size. JFFS2 supports write buffer
mode for ECC'd NOR flash. Provide a way to clear the MTD\_BIT\_WRITEABLE
flag in order to enable JFFS2 write buffer mode support.
Fixes: b6b23833fc42 ("mtd: spi-nor: spansion: Add s25hl-t/s25hs-t IDs and fixups")
Suggested-by: Tudor Ambarus
Signed-off-by: Takahiro Kuwano
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/a1cc128e094db4ec141f85bd380127598dfef17e.1680760742.git.Takahiro.Kuwano@infineon.com
Signed-off-by: Tudor Ambarus
Signed-off-by: Sasha Levin
commit 1fc5b7d97d1fee889b772f3576f183442f2d43cd
Author: Manivannan Sadhasivam
Date: Tue Mar 14 13:34:43 2023 +0530
soc: qcom: llcc: Do not create EDAC platform device on SDM845
[ Upstream commit cca94f1dd6d0a4c7e5c8190672f5747e3c00ddde ]
The platforms based on SDM845 SoC locks the access to EDAC registers in the
bootloader. So probing the EDAC driver will result in a crash. Hence,
disable the creation of EDAC platform device on all SDM845 devices.
The issue has been observed on Lenovo Yoga C630 and DB845c.
While at it, also sort the members of `struct qcom\_llcc\_config` to avoid
any holes in-between.
Cc:  # 5.10
Reported-by: Steev Klimaszewski
Signed-off-by: Manivannan Sadhasivam
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230314080443.64635-15-manivannan.sadhasivam@linaro.org
Signed-off-by: Sasha Levin
commit 47f5f9cf4ccd1762b861df054e4a508e1703a48d
Author: Manivannan Sadhasivam
Date: Tue Mar 14 13:34:42 2023 +0530
qcom: llcc/edac: Support polling mode for ECC handling
[ Upstream commit 721d3e91bfc93975c5e1a76c7d588dd8df5d82da ]
Not all Qcom platforms support IRQ mode for ECC handling. For those
platforms, the current EDAC driver will not be probed due to missing ECC
IRQ in devicetree.
So add support for polling mode so that the EDAC driver can be used on all
Qcom platforms supporting LLCC.
The polling delay of 5000ms is chosen based on Qcom downstream/vendor
driver.
Reported-by: Luca Weiss
Tested-by: Luca Weiss
Tested-by: Steev Klimaszewski  # Thinkpad X13s
Tested-by: Andrew Halaney  # sa8540p-ride
Reviewed-by: Borislav Petkov (AMD)
Signed-off-by: Manivannan Sadhasivam
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20230314080443.64635-14-manivannan.sadhasivam@linaro.org
Stable-dep-of: cca94f1dd6d0 ("soc: qcom: llcc: Do not create EDAC platform device on SDM845")
Signed-off-by: Sasha Levin
commit 28686863a8f12ded552e546ba1cea29858ea4c2a
Author: Takahiro Kuwano
Date: Thu Apr 6 15:17:44 2023 +0900
mtd: spi-nor: spansion: Enable JFFS2 write buffer for Infineon s28hx SEMPER flash
[ Upstream commit 9fd0945fe6fadfb6b54a9cd73be101c02b3e8134 ]
Infineon(Cypress) SEMPER NOR flash family has on-die ECC and its program
granularity is 16-byte ECC data unit size. JFFS2 supports write buffer
mode for ECC'd NOR flash. Provide a way to clear the MTD\_BIT\_WRITEABLE
flag in order to enable JFFS2 write buffer mode support.
A new SNOR\_F\_ECC flag is introduced to determine if the part has on-die
ECC and if it has, MTD\_BIT\_WRITEABLE is unset.
In vendor specific driver, a common cypress\_nor\_ecc\_init() helper is
added. This helper takes care for ECC related initialization for SEMPER
flash family by setting up params->writesize and SNOR\_F\_ECC.
Fixes: c3266af101f2 ("mtd: spi-nor: spansion: add support for Cypress Semper flash")
Suggested-by: Tudor Ambarus
Signed-off-by: Takahiro Kuwano
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/d586723f6f12aaff44fbcd7b51e674b47ed554ed.1680760742.git.Takahiro.Kuwano@infineon.com
Signed-off-by: Tudor Ambarus
Signed-off-by: Sasha Levin
commit dcf35178c5057f676cfb51ac27b827fdd4433d49
Author: Miquel Raynal
Date: Tue Mar 28 17:41:03 2023 +0200
mtd: spi-nor: Add a RWW flag
[ Upstream commit 4eddee70140b3ae183398b246a609756546c51f1 ]
Introduce a new (no SFDP) flag for the feature that we are about to
support: Read While Write. This means, if the chip has several banks and
supports RWW, once a page of data to write has been transferred into the
chip's internal SRAM, another read operation happening on a different
bank can be performed during the tPROG delay.
Signed-off-by: Miquel Raynal
Link: https://lore.kernel.org/r/20230328154105.448540-7-miquel.raynal@bootlin.com
Signed-off-by: Tudor Ambarus
Stable-dep-of: 9fd0945fe6fa ("mtd: spi-nor: spansion: Enable JFFS2 write buffer for Infineon s28hx SEMPER flash")
Signed-off-by: Sasha Levin
commit 13ca94aa241f68edc0973efc273e2e99b0fca7c8
Author: Jeremi Piotrowski
Date: Tue Mar 28 15:16:36 2023 +0000
crypto: ccp - Clear PSP interrupt status register before calling handler
[ Upstream commit 45121ad4a1750ca47ce3f32bd434bdb0cdbf0043 ]
The PSP IRQ is edge-triggered (MSI or MSI-X) in all cases supported by
the psp module so clear the interrupt status register early in the
handler to prevent missed interrupts. sev\_irq\_handler() calls wake\_up()
on a wait queue, which can result in a new command being submitted from
a different CPU. This then races with the clearing of isr and can result
in missed interrupts. A missed interrupt results in a command waiting
until it times out, which results in the psp being declared dead.
This is unlikely on bare metal, but has been observed when running
virtualized. In the cases where this is observed, sev->cmdresp\_reg has
PSP\_CMDRESP\_RESP set which indicates that the command was processed
correctly but no interrupt was asserted.
The full sequence of events looks like this:
CPU 1: submits SEV cmd #1
CPU 1: calls wait\_event\_timeout()
CPU 0: enters psp\_irq\_handler()
CPU 0: calls sev\_handler()->wake\_up()
CPU 1: wakes up; finishes processing cmd #1
CPU 1: submits SEV cmd #2
CPU 1: calls wait\_event\_timeout()
PSP: finishes processing cmd #2; interrupt status is still set; no interrupt
CPU 0: clears intsts
CPU 0: exits psp\_irq\_handler()
CPU 1: wait\_event\_timeout() times out; psp\_dead=true
Fixes: 200664d5237f ("crypto: ccp: Add Secure Encrypted Virtualization (SEV) command support")
Cc: stable@vger.kernel.org
Signed-off-by: Jeremi Piotrowski
Acked-by: Tom Lendacky
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 38ee8f4a8087b0798f750e8855b4b8134f87bad8
Author: Wesley Cheng
Date: Thu Apr 20 14:27:58 2023 -0700
usb: dwc3: gadget: Execute gadget stop after halting the controller
[ Upstream commit 39674be56fba1cd3a03bf4617f523a35f85fd2c1 ]
Do not call gadget stop until the poll for controller halt is
completed. DEVTEN is cleared as part of gadget stop, so the intention to
allow ep0 events to continue while waiting for controller halt is not
happening.
Fixes: c96683798e27 ("usb: dwc3: ep0: Don't prepare beyond Setup stage")
Cc: stable@vger.kernel.org
Acked-by: Thinh Nguyen
Signed-off-by: Wesley Cheng
Link: https://lore.kernel.org/r/20230420212759.29429-2-quic\_wcheng@quicinc.com
Signed-off-by: Greg Kroah-Hartman
Signed-off-by: Sasha Levin
commit 1a28bbfbd5f32305fd46f5c17476201a38ddc3ac
Author: Johan Hovold
Date: Tue Apr 4 09:25:17 2023 +0200
USB: dwc3: gadget: drop dead hibernation code
[ Upstream commit bdb19d01026a5cccfa437be8adcf2df472c5889e ]
The hibernation code is broken and has never been enabled in mainline
and should thus be dropped.
Remove the hibernation bits from the gadget code, which effectively
reverts commits e1dadd3b0f27 ("usb: dwc3: workaround: bogus hibernation
events") and 7b2a0368bbc9 ("usb: dwc3: gadget: set KEEP\_CONNECT in case
of hibernation") except for the spurious interrupt warning.
Acked-by: Thinh Nguyen
Signed-off-by: Johan Hovold
Link: https://lore.kernel.org/r/20230404072524.19014-5-johan+linaro@kernel.org
Signed-off-by: Greg Kroah-Hartman
Stable-dep-of: 39674be56fba ("usb: dwc3: gadget: Execute gadget stop after halting the controller")
Signed-off-by: Sasha Levin


=== Content from lists.debian.org_dab02457_20250114_182444.html ===


---

[[Date Prev](msg00026.html)][[Date Next](msg00028.html)]
[[Thread Prev](msg00026.html)][[Thread Next](msg00028.html)]
[[Date Index](maillist.html#00027)]
[[Thread Index](threads.html#00027)]

# [SECURITY] [DLA 3623-1] linux-5.10 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3623-1] linux-5.10 security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Thu, 19 Oct 2023 23:24:05 +0200
* *Message-id*: <[[🔎]](/msgid-search/ZTGedaavJuydJx_x%40decadent.org.uk) [ZTGedaavJuydJx\_x@decadent.org.uk](msg00027.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3623-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
October 19, 2023                              <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux-5.10
Version        : 5.10.197-1~deb10u1
CVE ID         : CVE-2022-4269 CVE-2022-39189 CVE-2023-1206 CVE-2023-1380
                 CVE-2023-2002 CVE-2023-2007 CVE-2023-2124 CVE-2023-2269
                 CVE-2023-2898 CVE-2023-3090 CVE-2023-3111 CVE-2023-3141
                 CVE-2023-3212 CVE-2023-3268 CVE-2023-3338 CVE-2023-3389
                 CVE-2023-3609 CVE-2023-3611 CVE-2023-3772 CVE-2023-3773
                 CVE-2023-3776 CVE-2023-3863 CVE-2023-4004 CVE-2023-4128
                 CVE-2023-4132 CVE-2023-4147 CVE-2023-4194 CVE-2023-4244
                 CVE-2023-4273 CVE-2023-4622 CVE-2023-4623 CVE-2023-4921
                 CVE-2023-20588 CVE-2023-21255 CVE-2023-21400 CVE-2023-31084
                 CVE-2023-34256 CVE-2023-34319 CVE-2023-35788 CVE-2023-35823
                 CVE-2023-35824 CVE-2023-40283 CVE-2023-42753 CVE-2023-42755
                 CVE-2023-42756
Debian Bug     : 871216 1035359 1036543 1044518 1050622

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2022-4269

    William Zhao discovered that a flaw in the Traffic Control (TC)
    subsystem when using a specific networking configuration
    (redirecting egress packets to ingress using TC action "mirred"),
    may allow a local unprivileged user to cause a denial of service
    (triggering a CPU soft lockup).

CVE-2022-39189

    Jann Horn discovered that TLB flush operations are mishandled in
    the KVM subsystem in certain KVM_VCPU_PREEMPTED situations, which
    may allow an unprivileged guest user to compromise the guest
    kernel.

CVE-2023-1206

    It was discovered that the networking stack permits attackers to
    force hash collisions in the IPv6 connection lookup table, which
    may result in denial of service (significant increase in the cost
    of lookups, increased CPU utilization).

CVE-2023-1380

    Jisoo Jang reported a heap out-of-bounds read in the brcmfmac
    Wi-Fi driver. On systems using this driver, a local user could
    exploit this to read sensitive information or to cause a denial of
    service.

CVE-2023-2002

    Ruiahn Li reported an incorrect permissions check in the Bluetooth
    subsystem. A local user could exploit this to reconfigure local
    Bluetooth interfaces, resulting in information leaks, spoofing, or
    denial of service (loss of connection).

CVE-2023-2007

    Lucas Leong and Reno Robert discovered a
    time-of-check-to-time-of-use flaw in the dpt_i2o SCSI controller
    driver. A local user with access to a SCSI device using this
    driver could exploit this for privilege escalation.

    This flaw has been mitigated by removing support for the I2OUSRCMD
    operation.

CVE-2023-2124

    Kyle Zeng, Akshay Ajayan and Fish Wang discovered that missing
    metadata validation may result in denial of service or potential
    privilege escalation if a corrupted XFS disk image is mounted.

CVE-2023-2269

    Zheng Zhang reported that improper handling of locking in the
    device mapper implementation may result in denial of service.

CVE-2023-2898

    It was discovered that missing sanitising in the f2fs file system
    may result in denial of service if a malformed file system is
    accessed.

CVE-2023-3090

    It was discovered that missing initialization in ipvlan networking
    may lead to an out-of-bounds write vulnerability, resulting in
    denial of service or potentially the execution of arbitrary code.

CVE-2023-3111

    The TOTE Robot tool found a flaw in the Btrfs filesystem driver
    that can lead to a use-after-free. It's unclear whether an
    unprivileged user can exploit this.

CVE-2023-3141

    A flaw was discovered in the r592 memstick driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device. The security impact of this is unclear.

CVE-2023-3212

    Yang Lan discovered that missing validation in the GFS2 filesystem
    could result in denial of service via a NULL pointer dereference
    when mounting a malformed GFS2 filesystem.

CVE-2023-3268

    It was discovered that an out-of-bounds memory access in relayfs
    could result in denial of service or an information leak.

CVE-2023-3338

    Davide Ornaghi discovered a flaw in the DECnet protocol
    implementation which could lead to a null pointer dereference or
    use-after-free. A local user can exploit this to cause a denial of
    service (crash or memory corruption) and probably for privilege
    escalation.

    This flaw has been mitigated by removing the DECnet protocol
    implementation.

CVE-2023-3389

    Querijn Voet discovered a use-after-free in the io_uring
    subsystem, which may result in denial of service or privilege
    escalation.

CVE-2023-3609, CVE-2023-3776. CVE-2023-4128

    It was discovered that a use-after-free in the cls_fw, cls_u32,
    cls_route and network classifiers may result in denial of service
    or potential local privilege escalation.

CVE-2023-3611

    It was discovered that an out-of-bounds write in the traffic
    control subsystem for the Quick Fair Queueing scheduler (QFQ) may
    result in denial of service or privilege escalation.

CVE-2023-3772

    Lin Ma discovered a NULL pointer dereference flaw in the XFRM
    subsystem which may result in denial of service.

CVE-2023-3773

    Lin Ma discovered a flaw in the XFRM subsystem, which may result
    in denial of service for a user with the CAP_NET_ADMIN capability
    in any user or network namespace.

CVE-2023-3863

    It was discovered that a use-after-free in the NFC implementation
    may result in denial of service, an information leak or potential
    local privilege escalation.

CVE-2023-4004

    It was discovered that a use-after-free in Netfilter's
    implementation of PIPAPO (PIle PAcket POlicies) may result in
    denial of service or potential local privilege escalation for a
    user with the CAP_NET_ADMIN capability in any user or network
    namespace.

CVE-2023-4132

    A use-after-free in the driver for Siano SMS1xxx based MDTV
    receivers may result in local denial of service.

CVE-2023-4147

    Kevin Rich discovered a use-after-free in Netfilter when adding a
    rule with NFTA_RULE_CHAIN_ID, which may result in local privilege
    escalation for a user with the CAP_NET_ADMIN capability in any
    user or network namespace.

CVE-2023-4194

    A type confusion in the implementation of TUN/TAP network devices
    may allow a local user to bypass network filters.

CVE-2023-4244

    A race condition was found in the nftables subsystem that could
    lead to a use-after-free.  A local user could exploit this to
    cause a denial of service (crash), information leak, or possibly
    for privilege escalation.

CVE-2023-4273

    Maxim Suhanov discovered a stack overflow in the exFAT driver,
    which may result in local denial of service via a malformed file
    system.

CVE-2023-4622

    Bing-Jhong Billy Jheng discovered a use-after-free within the Unix
    domain sockets component, which may result in local privilege
    escalation.

CVE-2023-4623

    Budimir Markovic reported a missing configuration check in the
    sch_hfsc network scheduler that could lead to a use-after-free or
    other problems.  A local user with the CAP_NET_ADMIN capability in
    any user or network namespace could exploit this to cause a denial
    of service (crash or memory corruption) or possibly for privilege
    escalation.

CVE-2023-4921

    "valis" reported flaws in the sch_qfq network scheduler that could
    lead to a use-after-free.  A local user with the CAP_NET_ADMIN
    capability in any user or network namespace could exploit this to
    cause a denial of service (crash or memory corruption) or possibly
    for privilege escalation.

CVE-2023-20588

    Jana Hofmann, Emanuele Vannacci, Cedric Fournet, Boris Koepf and
    Oleksii Oleksenko discovered that on some AMD CPUs with the Zen1
    micro architecture an integer division by zero may leave stale
    quotient data from a previous division, resulting in a potential
    leak of sensitive data.

CVE-2023-21255

    A use-after-free was discovered in the Android binder driver,
    which may result in local privilege escalation on systems where
    the binder driver is loaded.

CVE-2023-21400

    Ye Zhang and Nicolas Wu discovered a double-free in the io_uring
    subsystem, which may result in denial of service or privilege
    escalation.

CVE-2023-31084

    It was discovered that the DVB Core driver does not properly
    handle locking of certain events, allowing a local user to cause a
    denial of service.

CVE-2023-34256

    The syzbot tool found a time-of-check-to-time-of-use flaw in the
    ext4 filesystem driver. An attacker able to mount a disk image or
    device that they can also write to directly could exploit this to
    cause an out-of-bounds read, possibly resulting in a leak of
    sensitive information or denial of service (crash).

CVE-2023-34319

    Ross Lagerwall discovered a buffer overrun in Xen's netback driver
    which may allow a Xen guest to cause denial of service to the
    virtualisation host by sending malformed packets.

CVE-2023-35788

    Hangyu Hua discovered that an off-by-one in the Flower traffic
    classifier may result in local denial of service or the execution
    of privilege escalation.

CVE-2023-35823

    A flaw was discovered in the saa7134 media driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device. The security impact of this is unclear.

CVE-2023-35824

    A flaw was discovered in the dm1105 media driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device. The security impact of this is unclear.

CVE-2023-40283

    A use-after-free was discovered in Bluetooth L2CAP socket
    handling.

CVE-2023-42753

    Kyle Zeng discovered an off-by-one error in the netfilter ipset
    subsystem which could lead to out-of-bounds memory access.  A
    local user with the CAP_NET_ADMIN capability in any user or
    network namespace could exploit this to cause a denial of service
    (memory corruption or crash) and possibly for privilege
    escalation.

CVE-2023-42755

    Kyle Zeng discovered missing configuration validation in the
    cls_rsvp network classifier which could lead to out-of-bounds
    reads.  A local user with the CAP_NET_ADMIN capability in any user
    or network namespace could exploit this to cause a denial of
    service (crash) or to leak sensitive information.

    This flaw has been mitigated by removing the cls_rsvp classifier.

CVE-2023-42756

    Kyle Zeng discovered a race condition in the netfiler ipset
    subsystem which could lead to an assertion failure.  A local user
    with the CAP_NET_ADMIN capability in any user or network namespace
    could exploit this to cause a denial of service (crash).

For Debian 10 buster, these problems have been fixed in version
5.10.197-1~deb10u1.  This update additionally fixes Debian bugs
#871216, #1035359, #1036543, #1044518, and #1050622; and includes many
more bug fixes from stable updates 5.10.180-5.10.197 inclusive.

We recommend that you upgrade your linux-5.10 packages.

For the detailed security status of linux-5.10 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux-5.10>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpXgIbxIEfZ8.pgp)**

*Description:* PGP signature

---



=== Content from bugzilla.suse.com_8ae526e8_20250114_182419.html ===


| Bugzilla – Bug 1211895 | VUL-0: DISPUTED: CVE-2023-34256: kernel: potential slab-out-of-bounds in ext4\_group\_desc\_csum | Last modified: 2024-05-14 10:51:41 UTC |
| --- | --- | --- |

|  |
| --- |

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1211895)
* |
  [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

[**Bug 1211895**](show_bug.cgi?id=1211895)
(CVE-2023-34256)
- VUL-0: DISPUTED: CVE-2023-34256: kernel: potential slab-out-of-bounds in ext4\_group\_desc\_csum

[Summary:](page.cgi?id=glossary.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
VUL-0: DISPUTED: CVE-2023-34256: kernel: potential slab-out-of-bounds in ext4...

| | [Status](page.cgi?id=status_resolution_matrix.html): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=glossary.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2023-34256 | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | SUSE Security Incidents | | [Classification:](page.cgi?id=glossary.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Novell Products | | [Component:](describecomponents.cgi?product=SUSE Security Incidents "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Incidents ([show other bugs](buglist.cgi?component=Incidents&product=SUSE%20Security%20Incidents&bug_status=__open__)) | | [Version:](page.cgi?id=glossary.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=glossary.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Other Other | |  | | | [Priority](page.cgi?id=glossary.html#priority): | P3 - Medium **Severity**: Normal | | [Target Milestone:](page.cgi?id=glossary.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=glossary.html#assigned_to "The person in charge of resolving the bug.") | Security Team bot | | [QA Contact:](page.cgi?id=glossary.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") | Security Team bot | |  | | | [URL:](page.cgi?id=glossary.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") | <https://smash.suse.de/issue/368048/> | | [Whiteboard:](page.cgi?id=glossary.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") | CVSSv3.1:SUSE:CVE-2023-34256:4.0:(AV:... | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=glossary.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=glossary.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2023-06-01 09:03 UTC by Gabriele Sonnu | | --- | --- | | Modified: | 2024-05-14 10:51 UTC ([History](show_activity.cgi?id=1211895)) | | CC List: | 4 users (show)  chester.lin gabriele.sonnu rfrohl security-team | |  | | | [See Also:](page.cgi?id=glossary.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Found By:](page.cgi?id=glossary.html#cf_foundby "A custom Drop Down field in this installation of Bugzilla.") | Security Response Team | | [Services Priority:](page.cgi?id=glossary.html#cf_nts_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Business Priority:](page.cgi?id=glossary.html#cf_biz_priority "A custom Free Text field in this installation of Bugzilla.") |  | | [Blocker:](page.cgi?id=glossary.html#cf_blocker "A custom Drop Down field in this installation of Bugzilla.") | --- | | [Marketing QA Status:](page.cgi?id=glossary.html#cf_marketing_qa_status "A custom Drop Down field in this installation of Bugzilla.") | --- | | [IT Deployment:](page.cgi?id=glossary.html#cf_it_deployment "A custom Drop Down field in this installation of Bugzilla.") | --- | |  | |  * [Clone This Bug](enter_bug.cgi?cloned_bug_id=1211895) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [Add an attachment](attachment.cgi?bugid=1211895&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=1211895&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=1211895#c0)  Gabriele Sonnu   2023-06-01 09:03:25 UTC  ``` CVE-2023-34256  An issue was discovered in the Linux kernel before 6.3.3. There is an out-of-bounds read in crc16 in lib/crc16.c when called from fs/ext4/super.c because ext4_group_desc_csum does not properly check an offset.  References: <http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2023-34256> <https://www.cve.org/CVERecord?id=CVE-2023-34256> <https://cdn.kernel.org/pub/linux/kernel/v6.x/ChangeLog-6.3.3> <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f04351888a83e595571de672e0a4a8b74f4fb31> <https://syzkaller.appspot.com/bug?extid=8785e41224a3afd04321> ``` [Comment 1](show_bug.cgi?id=1211895#c1)  Gabriele Sonnu   2023-06-01 09:04:45 UTC  ``` Tracking as affected:   - SLE12-SP5  - SLE15-SP4  - SLE15-SP5  - SLE15-SP5-GA  - cve/linux-4.12  - cve/linux-4.4  - cve/linux-5.3  Fixing commit:  <https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f04351888a83e595571de672e0a4a8b74f4fb31> ``` [Comment 3](show_bug.cgi?id=1211895#c3)  Jan Kara   2023-06-01 09:56:23 UTC  ``` Gabriele, can you please dispute this CVE? Whoever filed it didn't think much about it... The changelog has in its first lines:      When modifying the block device while it is mounted by the filesystem,     syzbot reported the following:  So yes, if you have write access to the buffer cache of a block device and can make kernel mount such device, you can crash the kernel. But this is not something the kernel ever tried to protect against because there is no practical  protection - such access is pretty much equivalent to write access to any other kernel memory.  In this particular case we have accepted the fix to ext4: a) because it was actually cleaning up the code b) because it silenced some syzbot reports  but by no means this is relevant to security or even fixing any bug. ``` [Comment 5](show_bug.cgi?id=1211895#c5)  Jan Kara   2023-06-05 14:53:09 UTC  ``` Thanks! So nothing to be done here, reassigning back to security team. ``` [Comment 6](show_bug.cgi?id=1211895#c6)  Robert Frohl   2024-05-14 10:51:41 UTC  ``` done, closing ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=1211895)
* - [XML](show_bug.cgi?ctype=xml&id=1211895)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=1211895)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [IDP Log In](/saml2_login.cgi?idp=IDP&target=show_bug.cgi%3Fid%3D1211895)
  + |
    [Forgot Password](https://idp-portal.suse.com/univention/self-service/#page=passwordreset)

+ Legal:
+ [openSUSE](http://en.opensuse.org/Terms_of_site)
+ [SUSE](https://www.suse.com/company/legal/)



=== Content from syzkaller.appspot.com_e5ee8b6f_20250115_112334.html ===


| [syzbot](/upstream) | Android 5.10 Android 5.15 Android 5.4 Android 6.1 FreeBSD Linux Linux 5.15 Linux 6.1 NetBSD OpenBSD gVisor | [sign-in](https://syzkaller.appspot.com/_ah/conflogin?continue=https://syzkaller.appspot.com/bug%3Fextid%3D8785e41224a3afd04321) | [mailing list](https://groups.google.com/forum/#!forum/syzkaller) | [source](https://github.com/google/syzkaller) | [docs](https://github.com/google/syzkaller/blob/master/docs/syzbot.md) |
| --- | --- | --- |

[🐞 Open [1666]](/upstream)

[≡ Subsystems](/upstream/subsystems)

[🐞 Fixed [5974]](/upstream/fixed)

[🐞 Invalid [14663]](/upstream/invalid)

[⬇ Missing Backports [127]](/upstream/backports)

[≡ Crashes](/upstream/graph/crashes)

📈Graphs
[Kernel Health](/upstream/graph/bugs)
[Bugs/Month](/upstream/graph/found-bugs)
[Bug Lifetimes](/upstream/graph/lifetimes)
[Fuzzing](/upstream/graph/fuzzing)

📈Coverage
[Total](/upstream/graph/coverage?period=quarter)
[Repo Heatmap](/upstream/graph/coverage_heatmap?period=month)
[Subsystems Heatmap](/upstream/graph/coverage_subsystems_heatmap?period=month)

💬 Send us feedback

**KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum**

Status: [fixed on 2023/07/01 16:05](https://groups.google.com/d/msgid/syzkaller-bugs/000000000000ece18705f3b20934%40google.com)

Subsystems:
[ext4](/upstream/s/ext4)

[[Documentation on labels]](https://github.com/google/syzkaller/blob/master/docs/syzbot.md#labels)

Reported-by: syzbot+8785e41224a3afd04321@syzkaller.appspotmail.com

**Fix commit:**
4f04351888a8
[ext4: avoid a potential slab-out-of-bounds in ext4\_group\_desc\_csum](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)

First crash: 717d, last: 612d

**Cause bisection: failed**
**([error log](https://syzkaller.appspot.com/x/error.txt?x=16819a00c80000), [bisect log](https://syzkaller.appspot.com/x/bisect.txt?x=12819a00c80000))**

▶
▼
Discussions (1)

| Title | Replies (including bot) | Last reply |
| --- | --- | --- |
| [[syzbot] [ext4?] KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum](https://lore.kernel.org/all/000000000000ece18705f3b20934%40google.com/T/) | 17 (20) | 2023/04/30 02:55 |

▶
▼
Similar bugs (4)

| Kernel | Title | Repro | Cause bisect | Fix bisect | Count | Last | Reported | Patched | Status |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| android-5-10 | [KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum](/bug?extid=39411a8923ea201bae8e) [ext4](/android-5-10/s/ext4) | C | error | inconclusive | 11 | 591d | [692d](https://groups.google.com/d/msgid/syzkaller-android-bugs/000000000000d054f705f55424e5%40google.com) | 2/2 | [fixed on 2023/06/13 08:16](https://groups.google.com/d/msgid/syzkaller-android-bugs/000000000000d054f705f55424e5%40google.com) |
| android-54 | [KASAN: use-after-free Read in ext4\_group\_desc\_csum](/bug?id=1c555c2ed7051cdf8d0f817dd05945ad61db4373) |  |  |  | 6 | 638d | [692d](https://groups.google.com/d/msgid/syzkaller-android-bugs/0000000000005653b705f554177d%40google.com) | 0/2 | [auto-obsoleted due to no activity on 2023/08/15 14:19](https://groups.google.com/d/msgid/syzkaller-android-bugs/0000000000005653b705f554177d%40google.com) |
| android-5-15 | [KASAN: use-after-free Read in ext4\_group\_desc\_csum](/bug?extid=fc51227e7100c9294894) [ext4](/android-5-15/s/ext4) [origin:upstream](/android-5-15?label=origin%3Aupstream) | C | error |  | 4 | 631d | [701d](https://groups.google.com/d/msgid/syzkaller-android-bugs/0000000000003c38d705f49a83f2%40google.com) | 2/2 | [fixed on 2023/06/16 14:10](https://groups.google.com/d/msgid/syzkaller-android-bugs/0000000000003c38d705f49a83f2%40google.com) |
| linux-5.15 | [KASAN: use-after-free Read in ext4\_group\_desc\_csum](/bug?id=e317b7d22aabc42399cdbdcc549e7a1f85870397) |  |  |  | 1 | 632d | [632d](https://groups.google.com/d/msgid/syzkaller-lts-bugs/0000000000008397ba05fa1307d7%40google.com) | 0/3 | [auto-obsoleted due to no activity on 2023/08/22 11:08](https://groups.google.com/d/msgid/syzkaller-lts-bugs/0000000000008397ba05fa1307d7%40google.com) |

▶
▼
Last patch testing requests (1)

| Created | Duration | User | Patch | Repo | Result |
| --- | --- | --- | --- | --- | --- |
| 2023/05/07 03:54 | 23m | tytso@mit.edu | [patch](/text?tag=Patch&x=15f33522280000) | [git://git.kernel.org/pub/scm/linux/kernel/git/tytso/ext4.git tt/next](https://git.kernel.org/pub/scm/linux/kernel/git/tytso/ext4.git/commit/?id=0e65babaeb6b5047c309a33e31f071b6fa7de305) | OK [log](https://syzkaller.appspot.com/x/log.txt?x=15f72a6c280000) |

▶
▼
Fix bisection attempts (1)

| Created | Duration | User | Patch | Repo | Result |
| --- | --- | --- | --- | --- | --- |
| 2023/04/12 03:21 | 50m | bisect fix |  | [upstream](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ceaa837f96adb69c0df0397937cd74991d5d821a) | OK (0) [job log](https://syzkaller.appspot.com/x/bisect.txt?x=10170687c80000) [log](https://syzkaller.appspot.com/x/log.txt?x=14170687c80000) |

**Sample crash report:**

```
==================================================================
BUG: KASAN: slab-out-of-bounds in crc16+0xc0/0x104 [lib/crc16.c:58](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/crc16.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n58)
Read of size 1 at addr ffff0000d5eff0a8 by task syz-executor175/8245

CPU: 1 PID: 8245 Comm: syz-executor175 Not tainted 6.2.0-syzkaller-18302-g596b6b709632 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/21/2023
Call trace:
 dump_backtrace+0x1c8/0x1f4 [arch/arm64/kernel/stacktrace.c:158](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/stacktrace.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n158)
 show_stack+0x2c/0x3c [arch/arm64/kernel/stacktrace.c:165](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/stacktrace.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n165)
 __dump_stack [lib/dump_stack.c:88](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/dump_stack.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n88) [inline]
 dump_stack_lvl+0xd0/0x124 [lib/dump_stack.c:106](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/dump_stack.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n106)
 print_address_description [mm/kasan/report.c:306](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/report.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n306) [inline]
 print_report+0x174/0x4c0 [mm/kasan/report.c:417](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/report.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n417)
 kasan_report+0xd4/0x130 [mm/kasan/report.c:517](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/report.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n517)
 __asan_report_load1_noabort+0x2c/0x38 [mm/kasan/report_generic.c:348](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/report_generic.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n348)
 crc16+0xc0/0x104 [lib/crc16.c:58](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/crc16.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n58)
 ext4_group_desc_csum+0x6a8/0x99c [fs/ext4/super.c:3187](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/ext4/super.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3187)
 ext4_group_desc_csum_set+0x17c/0x210 [fs/ext4/super.c:3210](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/ext4/super.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3210)
 __ext4_new_inode+0x20dc/0x3acc [fs/ext4/ialloc.c:1227](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/ext4/ialloc.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1227)
 ext4_create+0x234/0x480 [fs/ext4/namei.c:2809](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/ext4/namei.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2809)
 lookup_open [fs/namei.c:3413](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/namei.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3413) [inline]
 open_last_lookups [fs/namei.c:3481](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/namei.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3481) [inline]
 path_openat+0xe6c/0x2578 [fs/namei.c:3711](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/namei.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3711)
 do_filp_open+0x1bc/0x3cc [fs/namei.c:3741](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/namei.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3741)
 do_sys_openat2+0x128/0x3d8 [fs/open.c:1310](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/open.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1310)
 do_sys_open [fs/open.c:1326](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/open.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1326) [inline]
 __do_sys_openat [fs/open.c:1342](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/open.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1342) [inline]
 __se_sys_openat [fs/open.c:1337](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/open.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1337) [inline]
 __arm64_sys_openat+0x1f0/0x240 [fs/open.c:1337](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/open.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1337)
 __invoke_syscall [arch/arm64/kernel/syscall.c:38](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n38) [inline]
 invoke_syscall+0x98/0x2c0 [arch/arm64/kernel/syscall.c:52](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n52)
 el0_svc_common+0x138/0x258 [arch/arm64/kernel/syscall.c:142](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n142)
 do_el0_svc+0x64/0x198 [arch/arm64/kernel/syscall.c:193](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n193)
 el0_svc+0x58/0x168 [arch/arm64/kernel/entry-common.c:637](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry-common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n637)
 el0t_64_sync_handler+0x84/0xf0 [arch/arm64/kernel/entry-common.c:655](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry-common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n655)
 el0t_64_sync+0x190/0x194 [arch/arm64/kernel/entry.S:591](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry.S?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n591)

Allocated by task 5961:
 kasan_save_stack [mm/kasan/common.c:45](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n45) [inline]
 kasan_set_track+0x4c/0x80 [mm/kasan/common.c:52](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n52)
 kasan_save_alloc_info+0x24/0x30 [mm/kasan/generic.c:512](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/generic.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n512)
 __kasan_slab_alloc+0x74/0x8c [mm/kasan/common.c:328](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/kasan/common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n328)
 kasan_slab_alloc [include/linux/kasan.h:201](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/include/linux/kasan.h?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n201) [inline]
 slab_post_alloc_hook+0x80/0x478 [mm/slab.h:761](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/slab.h?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n761)
 slab_alloc_node [mm/slub.c:3452](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/slub.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3452) [inline]
 slab_alloc [mm/slub.c:3460](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/slub.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3460) [inline]
 __kmem_cache_alloc_lru [mm/slub.c:3467](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/slub.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3467) [inline]
 kmem_cache_alloc+0x288/0x37c [mm/slub.c:3476](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/mm/slub.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3476)
 kmem_cache_zalloc [include/linux/slab.h:710](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/include/linux/slab.h?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n710) [inline]
 __kernfs_new_node+0xe4/0x66c [fs/kernfs/dir.c:614](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/kernfs/dir.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n614)
 kernfs_new_node+0x98/0x184 [fs/kernfs/dir.c:676](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/kernfs/dir.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n676)
 __kernfs_create_file+0x60/0x2d4 [fs/kernfs/file.c:1047](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/kernfs/file.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1047)
 sysfs_add_file_mode_ns+0x1dc/0x298 [fs/sysfs/file.c:294](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/sysfs/file.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n294)
 create_files [fs/sysfs/group.c:64](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/sysfs/group.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n64) [inline]
 internal_create_group+0x428/0xbec [fs/sysfs/group.c:148](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/sysfs/group.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n148)
 internal_create_groups [fs/sysfs/group.c:188](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/sysfs/group.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n188) [inline]
 sysfs_create_groups+0x60/0x130 [fs/sysfs/group.c:214](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/fs/sysfs/group.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n214)
 create_dir [lib/kobject.c:68](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/kobject.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n68) [inline]
 kobject_add_internal+0x5d4/0xb14 [lib/kobject.c:223](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/kobject.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n223)
 kobject_add_varg [lib/kobject.c:358](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/kobject.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n358) [inline]
 kobject_init_and_add+0x130/0x1a0 [lib/kobject.c:441](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/lib/kobject.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n441)
 netdev_queue_add_kobject [net/core/net-sysfs.c:1666](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/net-sysfs.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1666) [inline]
 netdev_queue_update_kobjects+0x1d8/0x470 [net/core/net-sysfs.c:1718](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/net-sysfs.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1718)
 register_queue_kobjects [net/core/net-sysfs.c:1779](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/net-sysfs.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1779) [inline]
 netdev_register_kobject+0x22c/0x2d8 [net/core/net-sysfs.c:2019](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/net-sysfs.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2019)
 register_netdevice+0xcb8/0x1270 [net/core/dev.c:10037](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/dev.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n10037)
 bond_newlink+0x50/0xa8 [drivers/net/bonding/bond_netlink.c:560](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/drivers/net/bonding/bond_netlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n560)
 rtnl_newlink_create [net/core/rtnetlink.c:3407](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/rtnetlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3407) [inline]
 __rtnl_newlink [net/core/rtnetlink.c:3624](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/rtnetlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3624) [inline]
 rtnl_newlink+0x1174/0x1b1c [net/core/rtnetlink.c:3637](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/rtnetlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n3637)
 rtnetlink_rcv_msg+0x6ec/0xc8c [net/core/rtnetlink.c:6141](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/rtnetlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n6141)
 netlink_rcv_skb+0x214/0x3c4 [net/netlink/af_netlink.c:2574](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/netlink/af_netlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2574)
 rtnetlink_rcv+0x28/0x38 [net/core/rtnetlink.c:6159](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/core/rtnetlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n6159)
 netlink_unicast_kernel [net/netlink/af_netlink.c:1339](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/netlink/af_netlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1339) [inline]
 netlink_unicast+0x660/0x8d4 [net/netlink/af_netlink.c:1365](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/netlink/af_netlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1365)
 netlink_sendmsg+0x800/0xae0 [net/netlink/af_netlink.c:1942](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/netlink/af_netlink.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n1942)
 sock_sendmsg_nosec [net/socket.c:714](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n714) [inline]
 sock_sendmsg [net/socket.c:734](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n734) [inline]
 __sys_sendto+0x3b4/0x504 [net/socket.c:2120](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2120)
 __do_sys_sendto [net/socket.c:2132](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2132) [inline]
 __se_sys_sendto [net/socket.c:2128](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2128) [inline]
 __arm64_sys_sendto+0xd8/0xf8 [net/socket.c:2128](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/net/socket.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n2128)
 __invoke_syscall [arch/arm64/kernel/syscall.c:38](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n38) [inline]
 invoke_syscall+0x98/0x2c0 [arch/arm64/kernel/syscall.c:52](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n52)
 el0_svc_common+0x138/0x258 [arch/arm64/kernel/syscall.c:142](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n142)
 do_el0_svc+0x64/0x198 [arch/arm64/kernel/syscall.c:193](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/syscall.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n193)
 el0_svc+0x58/0x168 [arch/arm64/kernel/entry-common.c:637](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry-common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n637)
 el0t_64_sync_handler+0x84/0xf0 [arch/arm64/kernel/entry-common.c:655](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry-common.c?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n655)
 el0t_64_sync+0x190/0x194 [arch/arm64/kernel/entry.S:591](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/tree/arch/arm64/kernel/entry.S?id=596b6b7096320e2ba3b5ee1f03c4669803c45253#n591)

The buggy address belongs to the object at ffff0000d5eff000
 which belongs to the cache kernfs_node_cache of size 168
The buggy address is located 0 bytes to the right of
 168-byte region [ffff0000d5eff000, ffff0000d5eff0a8)

The buggy address belongs to the physical page:
page:0000000016584f53 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x115eff
flags: 0x5ffc00000000200(slab|node=0|zone=2|lastcpupid=0x7ff)
raw: 05ffc00000000200 ffff0000c0844c00 dead000000000122 0000000000000000
raw: 0000000000000000 0000000000110011 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected

Memory state around the buggy address:
 ffff0000d5efef80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
 ffff0000d5eff000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
>ffff0000d5eff080: 00 00 00 00 00 fc fc fc fc fc fc fc fc 00 00 00
                                  ^
 ffff0000d5eff100: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
 ffff0000d5eff180: 00 00 fc fc fc fc fc fc fc fc 00 00 00 00 00 00
==================================================================
EXT4-fs error (device loop3): __ext4_get_inode_loc:4560: comm syz-executor175: Invalid inode table block 4 in block_group 0
EXT4-fs error (device loop3) in ext4_reserve_inode_write:5906: Corrupt filesystem
EXT4-fs error (device loop3): __ext4_get_inode_loc:4560: comm syz-executor175: Invalid inode table block 4 in block_group 0
EXT4-fs error (device loop3) in ext4_reserve_inode_write:5906: Corrupt filesystem
EXT4-fs error (device loop3): ext4_evict_inode:279: inode #18: comm syz-executor175: mark_inode_dirty error
EXT4-fs warning (device loop3): ext4_evict_inode:282: couldn't mark inode dirty (err -117)

```

Crashes (26):
| Time | Kernel | Commit | Syzkaller | Config | Log | Report | Syz repro | C repro | VM info | Assets ([help?](https://github.com/google/syzkaller/blob/master/docs/syzbot_assets.md)) | Manager | Title |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 2023/03/03 21:43 | git://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git for-kernelci | [596b6b709632](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/log/?id=596b6b7096320e2ba3b5ee1f03c4669803c45253) | [f8902b57](https://github.com/google/syzkaller/commits/f8902b5747fbe3d5b860bd782eec63fc9c7da6e7) | [.config](/text?tag=KernelConfig&x=3519974f3f27816d) | [console log](/text?tag=CrashLog&x=1151054cc80000) | [report](/text?tag=CrashReport&x=15bd0bb0c80000) | [syz](/text?tag=ReproSyz&x=16ce3de4c80000) | [C](/text?tag=ReproC&x=16b02598c80000) |  | [[disk image](https://storage.googleapis.com/syzbot-assets/06e2210b88a3/disk-596b6b70.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/79e6930ab577/vmlinux-596b6b70.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/56b95e6bcb5c/Image-596b6b70.gz.xz)] [[mounted in repro](https://storage.googleapis.com/syzbot-assets/a765d6554060/mount_0.gz)] | ci-upstream-gce-arm64 | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/05/14 07:11 | upstream | [d4d58949a6ea](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=d4d58949a6eac1c45ab022562c8494725e1ac094) | [2b9ba477](https://github.com/google/syzkaller/commits/2b9ba477a18ed0cc53e6b29a9641292709a7ba24) | [.config](/text?tag=KernelConfig&x=8bc832f563d8bf38) | [console log](/text?tag=CrashLog&x=147820fa280000) | [report](/text?tag=CrashReport&x=10e0fd3a280000) | [syz](/text?tag=ReproSyz&x=117ed39e280000) | [C](/text?tag=ReproC&x=10042cba280000) |  | [[disk image](https://storage.googleapis.com/syzbot-assets/5a3b703d1ada/disk-d4d58949.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/def0f98c2e84/vmlinux-d4d58949.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/e29ca0a35545/bzImage-d4d58949.xz)] [[mounted in repro](https://storage.googleapis.com/syzbot-assets/389a0a357a68/mount_0.gz)] | ci-upstream-kasan-gce-root | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/13 15:56 | upstream | [ceaa837f96ad](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=ceaa837f96adb69c0df0397937cd74991d5d821a) | [957959cb](https://github.com/google/syzkaller/commits/957959cbd5c40f4e7be0c363495e34454cd2fde6) | [.config](/text?tag=KernelConfig&x=42ba4da8e1e6af9f) | [console log](/text?tag=CrashLog&x=11727cc7480000) | [report](/text?tag=CrashReport&x=17cb8ac7480000) | [syz](/text?tag=ReproSyz&x=14392a4f480000) |  |  | [[disk image](https://storage.googleapis.com/syzbot-assets/88042f9b5fc8/disk-ceaa837f.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/9945b57ec9ee/vmlinux-ceaa837f.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/72ff118ed96b/bzImage-ceaa837f.xz)] [[mounted in repro](https://storage.googleapis.com/syzbot-assets/dabec17b2679/mount_0.gz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/05/13 10:04 | upstream | [9a48d6046722](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=9a48d604672220545d209e9996c2a1edbb5637f6) | [2b9ba477](https://github.com/google/syzkaller/commits/2b9ba477a18ed0cc53e6b29a9641292709a7ba24) | [.config](/text?tag=KernelConfig&x=38526bf24c8d961b) | [console log](/text?tag=CrashLog&x=1435f32a280000) | [report](/text?tag=CrashReport&x=17aabe4e280000) |  |  | [info](/text?tag=MachineInfo&x=449499851b57756b) | [[disk image](https://storage.googleapis.com/syzbot-assets/9151d600da35/disk-9a48d604.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/895748ad0a36/vmlinux-9a48d604.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/826ceb18c361/bzImage-9a48d604.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/05/13 05:33 | upstream | [9a48d6046722](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=9a48d604672220545d209e9996c2a1edbb5637f6) | [ecca8a24](https://github.com/google/syzkaller/commits/ecca8a243762a781257ba0b65291bca940e13e9c) | [.config](/text?tag=KernelConfig&x=38526bf24c8d961b) | [console log](/text?tag=CrashLog&x=132fab8a280000) | [report](/text?tag=CrashReport&x=1430b0ba280000) |  |  | [info](/text?tag=MachineInfo&x=3eacac06328b5e29) | [[disk image](https://storage.googleapis.com/syzbot-assets/9151d600da35/disk-9a48d604.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/895748ad0a36/vmlinux-9a48d604.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/826ceb18c361/bzImage-9a48d604.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/05/07 17:12 | upstream | [fc4354c6e5c2](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=fc4354c6e5c21257cf4a50b32f7c11c7d65c55b3) | [90c93c40](https://github.com/google/syzkaller/commits/90c93c40627cb0ac3c2c7cb99d807fd4c137adcb) | [.config](/text?tag=KernelConfig&x=73a06f6ef2d5b492) | [console log](/text?tag=CrashLog&x=1766cc46280000) | [report](/text?tag=CrashReport&x=12a8cd6a280000) |  |  | [info](/text?tag=MachineInfo&x=85594b64ada3f0c9) | [[disk image](https://storage.googleapis.com/syzbot-assets/5f4adc5d40b0/disk-fc4354c6.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/0e06af6b6985/vmlinux-fc4354c6.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/7d99bbab1361/bzImage-fc4354c6.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/05/02 16:59 | upstream | [865fdb08197e](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=865fdb08197e657c59e74a35fa32362b12397f58) | [52d40fd2](https://github.com/google/syzkaller/commits/52d40fd252bb12a2d5ec5573ce4d03b63682dfdc) | [.config](/text?tag=KernelConfig&x=d1c8518c09009bad) | [console log](/text?tag=CrashLog&x=11c16ef8280000) | [report](/text?tag=CrashReport&x=10c4d2d2280000) |  |  | [info](/text?tag=MachineInfo&x=449499851b57756b) | [[disk image](https://storage.googleapis.com/syzbot-assets/c667de87f318/disk-865fdb08.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/f5d4a94eb2fa/vmlinux-865fdb08.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/2b0950e1688b/bzImage-865fdb08.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/04/27 17:43 | upstream | [6e98b09da931](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=6e98b09da931a00bf4e0477d0fa52748bf28fcce) | [6f3d6fa7](https://github.com/google/syzkaller/commits/6f3d6fa7a0de9b4653808d3d0b5f8151a5909baf) | [.config](/text?tag=KernelConfig&x=5b762354749a3d5d) | [console log](/text?tag=CrashLog&x=11c1a4e8280000) | [report](/text?tag=CrashReport&x=13bb462c280000) |  |  | [info](/text?tag=MachineInfo&x=887c92bf56c63c8d) | [[disk image](https://storage.googleapis.com/syzbot-assets/8ad082c4dcdf/disk-6e98b09d.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/96565e4d870d/vmlinux-6e98b09d.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/cfcfe15601e5/bzImage-6e98b09d.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/02/13 15:35 | upstream | [ceaa837f96ad](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=ceaa837f96adb69c0df0397937cd74991d5d821a) | [957959cb](https://github.com/google/syzkaller/commits/957959cbd5c40f4e7be0c363495e34454cd2fde6) | [.config](/text?tag=KernelConfig&x=42ba4da8e1e6af9f) | [console log](/text?tag=CrashLog&x=12a7ac77480000) | [report](/text?tag=CrashReport&x=110df200c80000) |  |  | [info](/text?tag=MachineInfo&x=1c86e9fa26a435c0) | [[disk image](https://storage.googleapis.com/syzbot-assets/88042f9b5fc8/disk-ceaa837f.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/9945b57ec9ee/vmlinux-ceaa837f.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/72ff118ed96b/bzImage-ceaa837f.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/01/29 06:17 | upstream | [c96618275234](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=c96618275234ad03d44eafe9f8844305bb44fda4) | [9dfcf09c](https://github.com/google/syzkaller/commits/9dfcf09cf38eb123a007af28c5ee2562718893a0) | [.config](/text?tag=KernelConfig&x=c8d5c2ee6c2bd4b8) | [console log](/text?tag=CrashLog&x=14287dc1480000) | [report](/text?tag=CrashReport&x=1519a9ed480000) |  |  | [info](/text?tag=MachineInfo&x=d5e0d0be37290a2e) | [[disk image](https://storage.googleapis.com/syzbot-assets/a829cd39e940/disk-c9661827.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/abbc86f52a98/vmlinux-c9661827.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/ab0970dd4f84/bzImage-c9661827.xz)] | ci2-upstream-fs | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/03/03 20:16 | git://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git for-kernelci | [596b6b709632](https://git.kernel.org/pub/scm/linux/kernel/git/arm64/linux.git/log/?id=596b6b7096320e2ba3b5ee1f03c4669803c45253) | [f8902b57](https://github.com/google/syzkaller/commits/f8902b5747fbe3d5b860bd782eec63fc9c7da6e7) | [.config](/text?tag=KernelConfig&x=3519974f3f27816d) | [console log](/text?tag=CrashLog&x=107f3ee4c80000) | [report](/text?tag=CrashReport&x=1751a308c80000) |  |  | [info](/text?tag=MachineInfo&x=eaafbce7986de9ac) | [[disk image](https://storage.googleapis.com/syzbot-assets/06e2210b88a3/disk-596b6b70.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/79e6930ab577/vmlinux-596b6b70.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/56b95e6bcb5c/Image-596b6b70.gz.xz)] | ci-upstream-gce-arm64 | KASAN: slab-out-of-bounds Read in ext4\_group\_desc\_csum |
| 2023/05/12 01:24 | upstream | [105131df9c3b](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=105131df9c3b27673392a6b7ff356360188dc869) | [adb9a3cd](https://github.com/google/syzkaller/commits/adb9a3cd3732374cec4a7914bb6db944c1b16ef2) | [.config](/text?tag=KernelConfig&x=38526bf24c8d961b) | [console log](/text?tag=CrashLog&x=10e56b7c280000) | [report](/text?tag=CrashReport&x=16e81796280000) |  |  | [info](/text?tag=MachineInfo&x=449499851b57756b) | [[disk image](https://storage.googleapis.com/syzbot-assets/11583a3b6281/disk-105131df.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/7c79449fdc69/vmlinux-105131df.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/320c5a65d58c/bzImage-105131df.xz)] | ci2-upstream-fs | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/05/11 15:48 | upstream | [d295b66a7b66](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=d295b66a7b66ed504a827b58876ad9ea48c0f4a8) | [0fbd49f4](https://github.com/google/syzkaller/commits/0fbd49f48637cff2f7cf1ab0150e2c4ce8d97527) | [.config](/text?tag=KernelConfig&x=38526bf24c8d961b) | [console log](/text?tag=CrashLog&x=14122adc280000) | [report](/text?tag=CrashReport&x=12c45d24280000) |  |  | [info](/text?tag=MachineInfo&x=5ff6f799069b802d) | [[disk image](https://storage.googleapis.com/syzbot-assets/95f1878df2f4/disk-d295b66a.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/6d18d65ddcb5/vmlinux-d295b66a.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/6a59b1fdff8e/bzImage-d295b66a.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/05/09 15:50 | upstream | [ba0ad6ed89fd](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=ba0ad6ed89fd5dada3b7b65ef2b08e95d449d4ab) | [30aa2a7e](https://github.com/google/syzkaller/commits/30aa2a7ee322e62aaed06c29bf8a57b802dca8c2) | [.config](/text?tag=KernelConfig&x=38526bf24c8d961b) | [console log](/text?tag=CrashLog&x=12d24ef4280000) | [report](/text?tag=CrashReport&x=148178dc280000) |  |  | [info](/text?tag=MachineInfo&x=449499851b57756b) | [[disk image](https://storage.googleapis.com/syzbot-assets/d90fd81625c3/disk-ba0ad6ed.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/40278f703ebe/vmlinux-ba0ad6ed.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/582ba2804f3e/bzImage-ba0ad6ed.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/05/03 21:56 | upstream | [348551ddaf31](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=348551ddaf311c76b01cdcbaf61b6fef06a49144) | [b5918830](https://github.com/google/syzkaller/commits/b591883083486fa625ad707452e97a9a8f282a64) | [.config](/text?tag=KernelConfig&x=474780ac1e194316) | [console log](/text?tag=CrashLog&x=125cf482280000) | [report](/text?tag=CrashReport&x=1108065c280000) |  |  | [info](/text?tag=MachineInfo&x=449499851b57756b) | [[disk image](https://storage.googleapis.com/syzbot-assets/ba29786c6721/disk-348551dd.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/3b3f1847f3ae/vmlinux-348551dd.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/dffd5aef9e5d/bzImage-348551dd.xz)] | ci2-upstream-fs | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/04/28 09:34 | upstream | [91ec4b0d11fe](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=91ec4b0d11fe115581ce2835300558802ce55e6c) | [70a605de](https://github.com/google/syzkaller/commits/70a605de85f9d197b61ec86d50dd98b91a39e585) | [.config](/text?tag=KernelConfig&x=70a60a919cc6b5cc) | [console log](/text?tag=CrashLog&x=15286fc8280000) | [report](/text?tag=CrashReport&x=160a1c8c280000) |  |  | [info](/text?tag=MachineInfo&x=a289e4f42aee1bb1) | [[disk image](https://storage.googleapis.com/syzbot-assets/a20a0ae435a6/disk-91ec4b0d.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/f0b0da24109b/vmlinux-91ec4b0d.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/8e0090521b5d/bzImage-91ec4b0d.xz)] | ci2-upstream-fs | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/04/26 03:06 | upstream | [173ea743bf7a](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=173ea743bf7a9eef04460e03b00ba267cc52aee2) | [65320f8e](https://github.com/google/syzkaller/commits/65320f8e65b2fd5215822c6fc85034cec63dd887) | [.config](/text?tag=KernelConfig&x=e8360a411abc6ecb) | [console log](/text?tag=CrashLog&x=14ce8a78280000) | [report](/text?tag=CrashReport&x=1732f440280000) |  |  | [info](/text?tag=MachineInfo&x=a289e4f42aee1bb1) | [[disk image](https://storage.googleapis.com/syzbot-assets/cba553a84280/disk-173ea743.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/9d88be8c4e09/vmlinux-173ea743.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/9c1aa06ff46e/bzImage-173ea743.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/04/24 22:02 | upstream | [1a0beef98b58](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=1a0beef98b582b69a2ba44e468f7dfecbcfab48e) | [fdc18293](https://github.com/google/syzkaller/commits/fdc182930d958e977577923fadf8e5f05464e20c) | [.config](/text?tag=KernelConfig&x=87ffe5e27ecaaa4c) | [console log](/text?tag=CrashLog&x=11fb3d34280000) | [report](/text?tag=CrashReport&x=144e126fc80000) |  |  | [info](/text?tag=MachineInfo&x=a289e4f42aee1bb1) | [[disk image](https://storage.googleapis.com/syzbot-assets/05b3a3426770/disk-1a0beef9.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/004c8abeb4ec/vmlinux-1a0beef9.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/434b71393e44/bzImage-1a0beef9.xz)] | ci2-upstream-fs | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/03/13 03:20 | upstream | [134231664868](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=134231664868e163580cfe79e8c923560d7de302) | [5205ef30](https://github.com/google/syzkaller/commits/5205ef306e8b4217fc49cb8d8bd18670b7d08c3c) | [.config](/text?tag=KernelConfig&x=ddcab14a156008b7) | [console log](/text?tag=CrashLog&x=12a1182cc80000) | [report](/text?tag=CrashReport&x=16301e8ac80000) |  |  | [info](/text?tag=MachineInfo&x=873c187a5734dcce) |  | ci-upstream-kasan-gce-selinux-root | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/16 02:21 | upstream | [e1c04510f521](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=e1c04510f521e853019afeca2a5991a5ef8d6a5b) | [6be0f1f5](https://github.com/google/syzkaller/commits/6be0f1f57faa36df4b215edbe2fcfdbbb6de9f6d) | [.config](/text?tag=KernelConfig&x=7bfeb3e8d4df76ca) | [console log](/text?tag=CrashLog&x=11341e6f480000) | [report](/text?tag=CrashReport&x=12a298c8c80000) |  |  | [info](/text?tag=MachineInfo&x=b6ead4edb3adf35b) | [[disk image](https://storage.googleapis.com/syzbot-assets/4d534ae1fe51/disk-e1c04510.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/081573572120/vmlinux-e1c04510.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/87db273b5b14/bzImage-e1c04510.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/14 10:41 | upstream | [f6feea56f66d](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=f6feea56f66d34259c4222fa02e8171c4f2673d1) | [93ae7e0a](https://github.com/google/syzkaller/commits/93ae7e0a1ca84fd2df902b7c8d94cdedb671bed6) | [.config](/text?tag=KernelConfig&x=42ba4da8e1e6af9f) | [console log](/text?tag=CrashLog&x=126d6677480000) | [report](/text?tag=CrashReport&x=11485c10c80000) |  |  | [info](/text?tag=MachineInfo&x=7dc6cc5087e73616) | [[disk image](https://storage.googleapis.com/syzbot-assets/1ae0143f08d5/disk-f6feea56.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/18b8a23fa0cb/vmlinux-f6feea56.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/d915f4c5c8c0/bzImage-f6feea56.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/05 00:36 | upstream | [db27c22251e7](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=db27c22251e7c8f3a9d5bfb55c9c8c701a70bbb3) | [be607b78](https://github.com/google/syzkaller/commits/be607b78d7dea8ef5a0267ae7396fded7dc016d5) | [.config](/text?tag=KernelConfig&x=de1f4b1f70af0b59) | [console log](/text?tag=CrashLog&x=15179b45480000) | [report](/text?tag=CrashReport&x=15c899a5480000) |  |  | [info](/text?tag=MachineInfo&x=68dab20ddf29bd11) | [[disk image](https://storage.googleapis.com/syzbot-assets/e66f7750369b/disk-db27c222.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/beaee32233ec/vmlinux-db27c222.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/d664260f58c0/bzImage-db27c222.xz)] | ci2-upstream-fs | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/01/31 16:14 | upstream | [22b8077d0fce](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=22b8077d0fcec86c6ed0e0fce9f7e7e5a4c2d56a) | [7374c4e5](https://github.com/google/syzkaller/commits/7374c4e509b18f2c3fbcd98d7228c4f940a6d00b) | [.config](/text?tag=KernelConfig&x=89fb74cb65e24f0e) | [console log](/text?tag=CrashLog&x=108b03d1480000) | [report](/text?tag=CrashReport&x=126d5055480000) |  |  | [info](/text?tag=MachineInfo&x=912581d85c4f0504) |  | ci-qemu-upstream | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/23 01:23 | upstream | [5b7c4cabbb65](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/log/?id=5b7c4cabbb65f5c469464da6c5f614cbd7f730f2) | [9f1e2cb3](https://github.com/google/syzkaller/commits/9f1e2cb341151afb58bc3b8551b89b52f921b61c) | [.config](/text?tag=KernelConfig&x=c74c134cc415a89b) | [console log](/text?tag=CrashLog&x=1068fe18c80000) | [report](/text?tag=CrashReport&x=134f27f0c80000) |  |  | [info](/text?tag=MachineInfo&x=ccae7f14efda1f25) |  | ci-qemu-upstream-386 | KASAN: use-after-free Read in ext4\_group\_desc\_csum |
| 2023/02/23 01:22 | linux-next | [aaf70d5ad5e2](https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/log/?id=aaf70d5ad5e2b06a8050c51e278b0c3a14fabef5) | [409945bc](https://github.com/google/syzkaller/commits/409945bc8fab54efa11597029f5c9704bf0cbc22) | [.config](/text?tag=KernelConfig&x=4fe68735401a6111) | [console log](/text?tag=CrashLog&x=11730b3b480000) | [report](/text?tag=CrashReport&x=17df0c18c80000) |  |  | [info](/text?tag=MachineInfo&x=873c187a5734dcce) |  | ci-upstream-linux-next-kasan-gce-root | KASAN: slab-use-after-free Read in ext4\_group\_desc\_csum |
| 2023/01/29 07:04 | linux-next | [e2f86c02fdc9](https://git.kernel.org/pub/scm/linux/kernel/git/next/linux-next.git/log/?id=e2f86c02fdc96ca29ced53221a3cbf50aa6f8b49) | [9dfcf09c](https://github.com/google/syzkaller/commits/9dfcf09cf38eb123a007af28c5ee2562718893a0) | [.config](/text?tag=KernelConfig&x=920c61956db733da) | [console log](/text?tag=CrashLog&x=13249ef1480000) | [report](/text?tag=CrashReport&x=12762ff5480000) |  |  | [info](/text?tag=MachineInfo&x=1c86e9fa26a435c0) | [[disk image](https://storage.googleapis.com/syzbot-assets/ff04f1611fad/disk-e2f86c02.raw.xz)] [[vmlinux](https://storage.googleapis.com/syzbot-assets/67928a8622d3/vmlinux-e2f86c02.xz)] [[kernel image](https://storage.googleapis.com/syzbot-assets/b444a3d78556/bzImage-e2f86c02.xz)] | ci-upstream-linux-next-kasan-gce-root | KASAN: use-after-free Read in ext4\_group\_desc\_csum |

*\* ~~Struck through~~ repros no longer work on HEAD.*


=== Content from git.kernel.org_470310ac_20250115_112321.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tudor Ambarus <tudor.ambarus@linaro.org> | 2023-05-04 12:15:25 +0000 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2023-05-13 18:05:04 -0400 |
| commit | [4f04351888a83e595571de672e0a4a8b74f4fb31](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4f04351888a83e595571de672e0a4a8b74f4fb31) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)) | |
| tree | [77804903569a84726782ac8cb7f9cb91aec4ef5a](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=4f04351888a83e595571de672e0a4a8b74f4fb31) | |
| parent | [492888df0c7b42fc0843631168b0021bc4caee84](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=492888df0c7b42fc0843631168b0021bc4caee84) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4f04351888a83e595571de672e0a4a8b74f4fb31&id2=492888df0c7b42fc0843631168b0021bc4caee84)) | |
| download | [linux-4f04351888a83e595571de672e0a4a8b74f4fb31.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-4f04351888a83e595571de672e0a4a8b74f4fb31.tar.gz) | |

ext4: avoid a potential slab-out-of-bounds in ext4\_group\_desc\_csumWhen modifying the block device while it is mounted by the filesystem,
syzbot reported the following:
BUG: KASAN: slab-out-of-bounds in crc16+0x206/0x280 lib/crc16.c:58
Read of size 1 at addr ffff888075f5c0a8 by task syz-executor.2/15586
CPU: 1 PID: 15586 Comm: syz-executor.2 Not tainted 6.2.0-rc5-syzkaller-00205-gc96618275234 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/12/2023
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x1b1/0x290 lib/dump\_stack.c:106
print\_address\_description+0x74/0x340 mm/kasan/report.c:306
print\_report+0x107/0x1f0 mm/kasan/report.c:417
kasan\_report+0xcd/0x100 mm/kasan/report.c:517
crc16+0x206/0x280 lib/crc16.c:58
ext4\_group\_desc\_csum+0x81b/0xb20 fs/ext4/super.c:3187
ext4\_group\_desc\_csum\_set+0x195/0x230 fs/ext4/super.c:3210
ext4\_mb\_clear\_bb fs/ext4/mballoc.c:6027 [inline]
ext4\_free\_blocks+0x191a/0x2810 fs/ext4/mballoc.c:6173
ext4\_remove\_blocks fs/ext4/extents.c:2527 [inline]
ext4\_ext\_rm\_leaf fs/ext4/extents.c:2710 [inline]
ext4\_ext\_remove\_space+0x24ef/0x46a0 fs/ext4/extents.c:2958
ext4\_ext\_truncate+0x177/0x220 fs/ext4/extents.c:4416
ext4\_truncate+0xa6a/0xea0 fs/ext4/inode.c:4342
ext4\_setattr+0x10c8/0x1930 fs/ext4/inode.c:5622
notify\_change+0xe50/0x1100 fs/attr.c:482
do\_truncate+0x200/0x2f0 fs/open.c:65
handle\_truncate fs/namei.c:3216 [inline]
do\_open fs/namei.c:3561 [inline]
path\_openat+0x272b/0x2dd0 fs/namei.c:3714
do\_filp\_open+0x264/0x4f0 fs/namei.c:3741
do\_sys\_openat2+0x124/0x4e0 fs/open.c:1310
do\_sys\_open fs/open.c:1326 [inline]
\_\_do\_sys\_creat fs/open.c:1402 [inline]
\_\_se\_sys\_creat fs/open.c:1396 [inline]
\_\_x64\_sys\_creat+0x11f/0x160 fs/open.c:1396
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x3d/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
RIP: 0033:0x7f72f8a8c0c9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 f1 19 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f72f97e3168 EFLAGS: 00000246 ORIG\_RAX: 0000000000000055
RAX: ffffffffffffffda RBX: 00007f72f8bac050 RCX: 00007f72f8a8c0c9
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000020000280
RBP: 00007f72f8ae7ae9 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 00007ffd165348bf R14: 00007f72f97e3300 R15: 0000000000022000
Replace
le16\_to\_cpu(sbi->s\_es->s\_desc\_size)
with
sbi->s\_desc\_size
It reduces ext4's compiled text size, and makes the code more efficient
(we remove an extra indirect reference and a potential byte
swap on big endian systems), and there is no downside. It also avoids the
potential KASAN / syzkaller failure, as a bonus.
Reported-by: syzbot+fc51227e7100c9294894@syzkaller.appspotmail.com
Reported-by: syzbot+8785e41224a3afd04321@syzkaller.appspotmail.com
Link: <https://syzkaller.appspot.com/bug?id=70d28d11ab14bd7938f3e088365252aa923cff42>
Link: <https://syzkaller.appspot.com/bug?id=b85721b38583ecc6b5e72ff524c67302abbc30f3>
Link: [https://lore.kernel.org/all/000000000000ece18705f3b20934@google.com/](https://lore.kernel.org/all/000000000000ece18705f3b20934%40google.com/)
Fixes: 717d50e4971b ("Ext4: Uninitialized Block Groups")
Cc: stable@vger.kernel.org
Signed-off-by: Tudor Ambarus <tudor.ambarus@linaro.org>
Link: [https://lore.kernel.org/r/20230504121525.3275886-1-tudor.ambarus@linaro.org](https://lore.kernel.org/r/20230504121525.3275886-1-tudor.ambarus%40linaro.org)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4f04351888a83e595571de672e0a4a8b74f4fb31)

| -rw-r--r-- | [fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ext4/super.c?id=4f04351888a83e595571de672e0a4a8b74f4fb31) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 4 deletions

| diff --git a/fs/ext4/super.c b/fs/ext4/super.cindex 4037c8611c02ef..425b95a7a0ab6a 100644--- a/[fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/super.c?id=492888df0c7b42fc0843631168b0021bc4caee84)+++ b/[fs/ext4/super.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ext4/super.c?id=4f04351888a83e595571de672e0a4a8b74f4fb31)@@ -3240,11 +3240,9 @@ static \_\_le16 ext4\_group\_desc\_csum(struct super\_block \*sb, \_\_u32 block\_group, crc = crc16(crc, (\_\_u8 \*)gdp, offset); offset += sizeof(gdp->bg\_checksum); /\* skip checksum \*/ /\* for checksum of struct ext4\_group\_desc do the rest...\*/- if (ext4\_has\_feature\_64bit(sb) &&- offset < le16\_to\_cpu(sbi->s\_es->s\_desc\_size))+ if (ext4\_has\_feature\_64bit(sb) && offset < sbi->s\_desc\_size) crc = crc16(crc, (\_\_u8 \*)gdp + offset,- le16\_to\_cpu(sbi->s\_es->s\_desc\_size) -- offset);+ sbi->s\_desc\_size - offset);  out: return cpu\_to\_le16(crc); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-15 10:53:07 +0000



=== Content from lists.debian.org_a9ecba36_20250114_182443.html ===


---

[[Date Prev](msg00029.html)][[Date Next](msg00031.html)]
[[Thread Prev](msg00029.html)][[Thread Next](msg00031.html)]
[[Date Index](maillist.html#00030)]
[[Thread Index](threads.html#00030)]

# [SECURITY] [DLA 3508-1] linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3508-1] linux security update
* *From*: Ben Hutchings <benh@debian.org>
* *Date*: Thu, 27 Jul 2023 21:06:07 +0200
* *Message-id*: <[[🔎]](/msgid-search/ZMLAHxMjqV08Dawj%40decadent.org.uk) [ZMLAHxMjqV08Dawj@decadent.org.uk](msg00030.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-------------------------------------------------------------------------
Debian LTS Advisory DLA-3508-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                        Ben Hutchings
July 27, 2023                                 <https://wiki.debian.org/LTS>
-------------------------------------------------------------------------

Package        : linux
Version        : 4.19.289-1
CVE ID         : CVE-2023-1380 CVE-2023-2002 CVE-2023-2007 CVE-2023-2269
                 CVE-2023-3090 CVE-2023-3111 CVE-2023-3141 CVE-2023-3268
                 CVE-2023-3338 CVE-2023-20593 CVE-2023-31084 CVE-2023-32233
                 CVE-2023-34256 CVE-2023-35788 CVE-2023-35823 CVE-2023-35824
                 CVE-2023-35828

Several vulnerabilities have been discovered in the Linux kernel that
may lead to a privilege escalation, denial of service or information
leaks.

CVE-2023-1380

    Jisoo Jang reported a heap out-of-bounds read in the brcmfmac
    Wi-Fi driver.  On systems using this driver, a local user could
    exploit this to read sensitive information or to cause a denial of
    service (crash).

CVE-2023-2002

    Ruiahn Li reported an incorrect permissions check in the Bluetooth
    subsystem.  A local user could exploit this to reconfigure local
    Bluetooth interfaces, resulting in information leaks, spoofing, or
    denial of service (loss of connection).

CVE-2023-2007

    Lucas Leong (@_wmliang_) and Reno Robert of Trend Micro Zero Day
    Initiative discovered a time-of-check-to-time-of-use flaw in the
    dpt_i2o SCSI controller driver.  A local user with access to a
    SCSI device using this driver could exploit this for privilege
    escalation.

    This flaw has been mitigated by removing support for the I2OUSRCMD
    operation.

CVE-2023-2269

    Zheng Zhang reported that improper handling of locking in the
    device mapper implementation may result in denial of service.

CVE-2023-3090

    It was discovered that missing initialization in ipvlan networking
    may lead to an out-of-bounds write vulnerability, resulting in
    denial of service or potentially the execution of arbitrary code.

CVE-2023-3111

    The TOTE Robot tool found a flaw in the Btrfs filesystem driver
    that can lead to a use-after-free.  It's unclear whether an
    unprivileged user can exploit this.

CVE-2023-3141

    A flaw was discovered in the r592 memstick driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device.  The security impact of this is unclear.

CVE-2023-3268

    It was discovered that an out-of-bounds memory access in relayfs
    could result in denial of service or an information leak.

CVE-2023-3338

    Ornaghi Davide discovered a flaw in the DECnet protocol
    implementation which could lead to a null pointer dereference or
    use-after-free.  A local user can exploit this to cause a denial
    of service (crash or memory corruption) and probably for privilege
    escalation.

    This flaw has been mitigated by removing the DECnet protocol
    implementation.

CVE-2023-20593

    Tavis Ormandy discovered that under specific microarchitectural
    circumstances, a vector register in AMD "Zen 2" CPUs may not be
    written to 0 correctly.  This flaw allows an attacker to leak
    sensitive information across concurrent processes, hyper threads
    and virtualized guests.

    For details please refer to
    <<https://lock.cmpxchg8b.com/zenbleed.html>> and
    <<https://github.com/google/security-research/security/advisories/GHSA-v6wh-rxpg-cmm8>>.

    This issue can also be mitigated by a microcode update through the
    amd64-microcode package or a system firmware (BIOS/UEFI) update.
    However, the initial microcode release by AMD only provides
    updates for second generation EPYC CPUs.  Various Ryzen CPUs are
    also affected, but no updates are available yet.

CVE-2023-31084

    It was discovered that the DVB Core driver does not properly
    handle locking of certain events, allowing a local user to cause a
    denial of service.

CVE-2023-32233

    Patryk Sondej and Piotr Krysiuk discovered a use-after-free flaw
    in the Netfilter nf_tables implementation when processing batch
    requests, which may result in local privilege escalation for a
    user with the CAP_NET_ADMIN capability in any user or network
    namespace.

CVE-2023-34256

    The syzbot tool found a time-of-check-to-time-of-use flaw in the
    ext4 filesystem driver.  An attacker able to mount a disk image or
    device that they can also write to directly could exploit this to
    cause an out-of-bounds read, possibly resulting in a leak of
    sensitive information or denial of service (crash).

CVE-2023-35788

    Hangyu Hua discovered an out-of-bounds write vulnerability in the
    Flower classifier which may result in denial of service or the
    execution of arbitrary code.

CVE-2023-35823

    A flaw was discovered in the saa7134 media driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device.  The security impact of this is unclear.

CVE-2023-35824

    A flaw was discovered in the dm1105 media driver that could lead
    to a use-after-free after the driver is removed or unbound from a
    device.  The security impact of this is unclear.

CVE-2023-35828

    A flaw was discovered in the renesas_udc USB device-mode driver
    that could lead to a use-after-free after the driver is removed or
    unbound from a device.  The security impact of this is unclear.

    This driver is not enabled in Debian's official kernel
    configurations.

For Debian 10 buster, these problems have been fixed in version
4.19.289-1.

We recommend that you upgrade your linux packages.

For the detailed security status of linux please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/linux>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>

```

**Attachment:
[signature.asc](pgpeodXQB9o9z.pgp)**

*Description:* PGP signature

---


