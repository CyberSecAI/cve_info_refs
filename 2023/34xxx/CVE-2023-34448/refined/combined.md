=== Content from github.com_224bae95_20250114_200813.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftwigphp%2FTwig%2Fblob%2Fv1.44.7%2Fsrc%2FEnvironment.php)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftwigphp%2FTwig%2Fblob%2Fv1.44.7%2Fsrc%2FEnvironment.php)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=twigphp%2FTwig)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[twigphp](/twigphp)
/
**[Twig](/twigphp/Twig)**
Public

* [Notifications](/login?return_to=%2Ftwigphp%2FTwig) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Ftwigphp%2FTwig)
* [Star
   8.2k](/login?return_to=%2Ftwigphp%2FTwig)

* [Code](/twigphp/Twig/tree/v1.44.7)
* [Issues
  38](/twigphp/Twig/issues)
* [Pull requests
  19](/twigphp/Twig/pulls)
* [Discussions](/twigphp/Twig/discussions)
* [Actions](/twigphp/Twig/actions)
* [Security](/twigphp/Twig/security)
* [Insights](/twigphp/Twig/pulse)

Additional navigation options

* [Code](/twigphp/Twig/tree/v1.44.7)
* [Issues](/twigphp/Twig/issues)
* [Pull requests](/twigphp/Twig/pulls)
* [Discussions](/twigphp/Twig/discussions)
* [Actions](/twigphp/Twig/actions)
* [Security](/twigphp/Twig/security)
* [Insights](/twigphp/Twig/pulse)

## Files

 v1.44.7
## Breadcrumbs

1. [Twig](/twigphp/Twig/tree/v1.44.7)
2. /[src](/twigphp/Twig/tree/v1.44.7/src)
/
# Environment.php

Copy path Blame  Blame
## Latest commit

## History

[History](/twigphp/Twig/commits/v1.44.7/src/Environment.php)1638 lines (1428 loc) · 51.8 KB v1.44.7
## Breadcrumbs

1. [Twig](/twigphp/Twig/tree/v1.44.7)
2. /[src](/twigphp/Twig/tree/v1.44.7/src)
/
# Environment.php

Top
## File metadata and controls

* Code
* Blame

1638 lines (1428 loc) · 51.8 KB[Raw](https://github.com/twigphp/Twig/raw/refs/tags/v1.44.7/src/Environment.php)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000<?php
/\* \* This file is part of Twig. \* \* (c) Fabien Potencier \* \* For the full copyright and license information, please view the LICENSE \* file that was distributed with this source code. \*/
namespace Twig;
use Twig\Cache\CacheInterface;use Twig\Cache\FilesystemCache;use Twig\Cache\NullCache;use Twig\Error\Error;use Twig\Error\LoaderError;use Twig\Error\RuntimeError;use Twig\Error\SyntaxError;use Twig\Extension\CoreExtension;use Twig\Extension\EscaperExtension;use Twig\Extension\ExtensionInterface;use Twig\Extension\GlobalsInterface;use Twig\Extension\InitRuntimeInterface;use Twig\Extension\OptimizerExtension;use Twig\Extension\StagingExtension;use Twig\Loader\ArrayLoader;use Twig\Loader\ChainLoader;use Twig\Loader\LoaderInterface;use Twig\Loader\SourceContextLoaderInterface;use Twig\Node\ModuleNode;use Twig\NodeVisitor\NodeVisitorInterface;use Twig\RuntimeLoader\RuntimeLoaderInterface;use Twig\TokenParser\TokenParserInterface;
/\*\* \* Stores the Twig configuration and renders templates. \* \* @author Fabien Potencier <fabien@symfony.com> \*/class Environment{ public const VERSION = '1.44.7'; public const VERSION\_ID = 14407; public const MAJOR\_VERSION = 1; public const MINOR\_VERSION = 44; public const RELEASE\_VERSION = 7; public const EXTRA\_VERSION = '';
 protected $charset; protected $loader; protected $debug; protected $autoReload; protected $cache; protected $lexer; protected $parser; protected $compiler; protected $baseTemplateClass; protected $extensions; protected $parsers; protected $visitors; protected $filters; protected $tests; protected $functions; protected $globals; protected $runtimeInitialized = false; protected $extensionInitialized = false; protected $loadedTemplates; protected $strictVariables; protected $unaryOperators; protected $binaryOperators; protected $templateClassPrefix = '\_\_TwigTemplate\_'; protected $functionCallbacks = []; protected $filterCallbacks = []; protected $staging;
 private $originalCache; private $bcWriteCacheFile = false; private $bcGetCacheFilename = false; private $lastModifiedExtension = 0; private $extensionsByClass = []; private $runtimeLoaders = []; private $runtimes = []; private $optionsHash;
 /\*\* \* Constructor. \* \* Available options: \* \* \* debug: When set to true, it automatically set "auto\_reload" to true as \* well (default to false). \* \* \* charset: The charset used by the templates (default to UTF-8). \* \* \* base\_template\_class: The base template class to use for generated \* templates (default to \Twig\Template). \* \* \* cache: An absolute path where to store the compiled templates, \* a \Twig\Cache\CacheInterface implementation, \* or false to disable compilation cache (default). \* \* \* auto\_reload: Whether to reload the template if the original source changed. \* If you don't provide the auto\_reload option, it will be \* determined automatically based on the debug value. \* \* \* strict\_variables: Whether to ignore invalid variables in templates \* (default to false). \* \* \* autoescape: Whether to enable auto-escaping (default to html): \* \* false: disable auto-escaping \* \* true: equivalent to html \* \* html, js: set the autoescaping to one of the supported strategies \* \* name: set the autoescaping strategy based on the template name extension \* \* PHP callback: a PHP callback that returns an escaping strategy based on the template "name" \* \* \* optimizations: A flag that indicates which optimizations to apply \* (default to -1 which means that all optimizations are enabled; \* set it to 0 to disable). \*/ public function \_\_construct(LoaderInterface $loader = null, $options = []) { if (null !== $loader) { $this->setLoader($loader); } else { @trigger\_error('Not passing a "Twig\Lodaer\LoaderInterface" as the first constructor argument of "Twig\Environment" is deprecated since version 1.21.', \E\_USER\_DEPRECATED); }
 $options = array\_merge([ 'debug' => false, 'charset' => 'UTF-8', 'base\_template\_class' => '\Twig\Template', 'strict\_variables' => false, 'autoescape' => 'html', 'cache' => false, 'auto\_reload' => null, 'optimizations' => -1, ], $options);
 $this->debug = (bool) $options['debug']; $this->charset = null === $options['charset'] ? null : strtoupper($options['charset']); $this->baseTemplateClass = $options['base\_template\_class']; $this->autoReload = null === $options['auto\_reload'] ? $this->debug : (bool) $options['auto\_reload']; $this->strictVariables = (bool) $options['strict\_variables']; $this->setCache($options['cache']);
 $this->addExtension(new CoreExtension()); $this->addExtension(new EscaperExtension($options['autoescape'])); $this->addExtension(new OptimizerExtension($options['optimizations'])); $this->staging = new StagingExtension();
 // For BC if (\is\_string($this->originalCache)) { $r = new \ReflectionMethod($this, 'writeCacheFile'); if (\_\_CLASS\_\_ !== $r->getDeclaringClass()->getName()) { @trigger\_error('The Twig\Environment::writeCacheFile method is deprecated since version 1.22 and will be removed in Twig 2.0.', \E\_USER\_DEPRECATED);
 $this->bcWriteCacheFile = true; }
 $r = new \ReflectionMethod($this, 'getCacheFilename'); if (\_\_CLASS\_\_ !== $r->getDeclaringClass()->getName()) { @trigger\_error('The Twig\Environment::getCacheFilename method is deprecated since version 1.22 and will be removed in Twig 2.0.', \E\_USER\_DEPRECATED);
 $this->bcGetCacheFilename = true; } } }
 /\*\* \* Gets the base template class for compiled templates. \* \* @return string The base template class name \*/ public function getBaseTemplateClass() { return $this->baseTemplateClass; }
 /\*\* \* Sets the base template class for compiled templates. \* \* @param string $class The base template class name \*/ public function setBaseTemplateClass($class) { $this->baseTemplateClass = $class; $this->updateOptionsHash(); }
 /\*\* \* Enables debugging mode. \*/ public function enableDebug() { $this->debug = true; $this->updateOptionsHash(); }
 /\*\* \* Disables debugging mode. \*/ public function disableDebug() { $this->debug = false; $this->updateOptionsHash(); }
 /\*\* \* Checks if debug mode is enabled. \* \* @return bool true if debug mode is enabled, false otherwise \*/ public function isDebug() { return $this->debug; }
 /\*\* \* Enables the auto\_reload option. \*/ public function enableAutoReload() { $this->autoReload = true; }
 /\*\* \* Disables the auto\_reload option. \*/ public function disableAutoReload() { $this->autoReload = false; }
 /\*\* \* Checks if the auto\_reload option is enabled. \* \* @return bool true if auto\_reload is enabled, false otherwise \*/ public function isAutoReload() { return $this->autoReload; }
 /\*\* \* Enables the strict\_variables option. \*/ public function enableStrictVariables() { $this->strictVariables = true; $this->updateOptionsHash(); }
 /\*\* \* Disables the strict\_variables option. \*/ public function disableStrictVariables() { $this->strictVariables = false; $this->updateOptionsHash(); }
 /\*\* \* Checks if the strict\_variables option is enabled. \* \* @return bool true if strict\_variables is enabled, false otherwise \*/ public function isStrictVariables() { return $this->strictVariables; }
 /\*\* \* Gets the current cache implementation. \* \* @param bool $original Whether to return the original cache option or the real cache instance \* \* @return CacheInterface|string|false A Twig\Cache\CacheInterface implementation, \* an absolute path to the compiled templates, \* or false to disable cache \*/ public function getCache($original = true) { return $original ? $this->originalCache : $this->cache; }
 /\*\* \* Sets the current cache implementation. \* \* @param CacheInterface|string|false $cache A Twig\Cache\CacheInterface implementation, \* an absolute path to the compiled templates, \* or false to disable cache \*/ public function setCache($cache) { if (\is\_string($cache)) { $this->originalCache = $cache; $this->cache = new FilesystemCache($cache); } elseif (false === $cache) { $this->originalCache = $cache; $this->cache = new NullCache(); } elseif (null === $cache) { @trigger\_error('Using "null" as the cache strategy is deprecated since version 1.23 and will be removed in Twig 2.0.', \E\_USER\_DEPRECATED); $this->originalCache = false; $this->cache = new NullCache(); } elseif ($cache instanceof CacheInterface) { $this->originalCache = $this->cache = $cache; } else { throw new \LogicException('Cache can only be a string, false, or a \Twig\Cache\CacheInterface implementation.'); } }
 /\*\* \* Gets the cache filename for a given template. \* \* @param string $name The template name \* \* @return string|false The cache file name or false when caching is disabled \* \* @deprecated since 1.22 (to be removed in 2.0) \*/ public function getCacheFilename($name) { @trigger\_error(sprintf('The %s method is deprecated since version 1.22 and will be removed in Twig 2.0.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED);
 $key = $this->cache->generateKey($name, $this->getTemplateClass($name));
 return !$key ? false : $key; }
 /\*\* \* Gets the template class associated with the given string. \* \* The generated template class is based on the following parameters: \* \* \* The cache key for the given template; \* \* The currently enabled extensions; \* \* Whether the Twig C extension is available or not; \* \* PHP version; \* \* Twig version; \* \* Options with what environment was created. \* \* @param string $name The name for which to calculate the template class name \* @param int|null $index The index if it is an embedded template \* \* @return string The template class name \*/ public function getTemplateClass($name, $index = null) { $key = $this->getLoader()->getCacheKey($name).$this->optionsHash;
 return $this->templateClassPrefix.hash('sha256', $key).(null === $index ? '' : '\_\_\_'.$index); }
 /\*\* \* Gets the template class prefix. \* \* @return string The template class prefix \* \* @deprecated since 1.22 (to be removed in 2.0) \*/ public function getTemplateClassPrefix() { @trigger\_error(sprintf('The %s method is deprecated since version 1.22 and will be removed in Twig 2.0.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED);
 return $this->templateClassPrefix; }
 /\*\* \* Renders a template. \* \* @param string|TemplateWrapper $name The template name \* @param array $context An array of parameters to pass to the template \* \* @return string The rendered template \* \* @throws LoaderError When the template cannot be found \* @throws SyntaxError When an error occurred during compilation \* @throws RuntimeError When an error occurred during rendering \*/ public function render($name, array $context = []) { return $this->load($name)->render($context); }
 /\*\* \* Displays a template. \* \* @param string|TemplateWrapper $name The template name \* @param array $context An array of parameters to pass to the template \* \* @throws LoaderError When the template cannot be found \* @throws SyntaxError When an error occurred during compilation \* @throws RuntimeError When an error occurred during rendering \*/ public function display($name, array $context = []) { $this->load($name)->display($context); }
 /\*\* \* Loads a template. \* \* @param string|TemplateWrapper|\Twig\Template $name The template name \* \* @throws LoaderError When the template cannot be found \* @throws RuntimeError When a previously generated cache is corrupted \* @throws SyntaxError When an error occurred during compilation \* \* @return TemplateWrapper \*/ public function load($name) { if ($name instanceof TemplateWrapper) { return $name; }
 if ($name instanceof Template) { return new TemplateWrapper($this, $name); }
 return new TemplateWrapper($this, $this->loadTemplate($name)); }
 /\*\* \* Loads a template internal representation. \* \* This method is for internal use only and should never be called \* directly. \* \* @param string $name The template name \* @param int $index The index if it is an embedded template \* \* @return \Twig\_TemplateInterface A template instance representing the given template name \* \* @throws LoaderError When the template cannot be found \* @throws RuntimeError When a previously generated cache is corrupted \* @throws SyntaxError When an error occurred during compilation \* \* @internal \*/ public function loadTemplate($name, $index = null) { return $this->loadClass($this->getTemplateClass($name), $name, $index); }
 /\*\* \* @internal \*/ public function loadClass($cls, $name, $index = null) { $mainCls = $cls; if (null !== $index) { $cls .= '\_\_\_'.$index; }
 if (isset($this->loadedTemplates[$cls])) { return $this->loadedTemplates[$cls]; }
 if (!class\_exists($cls, false)) { if ($this->bcGetCacheFilename) { $key = $this->getCacheFilename($name); } else { $key = $this->cache->generateKey($name, $mainCls); }
 if (!$this->isAutoReload() || $this->isTemplateFresh($name, $this->cache->getTimestamp($key))) { $this->cache->load($key); }
 $source = null; if (!class\_exists($cls, false)) { $loader = $this->getLoader(); if (!$loader instanceof SourceContextLoaderInterface) { $source = new Source($loader->getSource($name), $name); } else { $source = $loader->getSourceContext($name); }
 $content = $this->compileSource($source);
 if ($this->bcWriteCacheFile) { $this->writeCacheFile($key, $content); } else { $this->cache->write($key, $content); $this->cache->load($key); }
 if (!class\_exists($mainCls, false)) { /\* Last line of defense if either $this->bcWriteCacheFile was used, \* $this->cache is implemented as a no-op or we have a race condition \* where the cache was cleared between the above calls to write to and load from \* the cache. \*/ eval('?>'.$content); } }
 if (!class\_exists($cls, false)) { throw new RuntimeError(sprintf('Failed to load Twig template "%s", index "%s": cache might be corrupted.', $name, $index), -1, $source); } }
 if (!$this->runtimeInitialized) { $this->initRuntime(); }
 return $this->loadedTemplates[$cls] = new $cls($this); }
 /\*\* \* Creates a template from source. \* \* This method should not be used as a generic way to load templates. \* \* @param string $template The template source \* @param string $name An optional name of the template to be used in error messages \* \* @return TemplateWrapper A template instance representing the given template name \* \* @throws LoaderError When the template cannot be found \* @throws SyntaxError When an error occurred during compilation \*/ public function createTemplate($template, $name = null) { $hash = hash('sha256', $template, false); if (null !== $name) { $name = sprintf('%s (string template %s)', $name, $hash); } else { $name = sprintf('\_\_string\_template\_\_%s', $hash); }
 $loader = new ChainLoader([ new ArrayLoader([$name => $template]), $current = $this->getLoader(), ]);
 $this->setLoader($loader); try { $template = new TemplateWrapper($this, $this->loadTemplate($name)); } catch (\Exception $e) { $this->setLoader($current);
 throw $e; } catch (\Throwable $e) { $this->setLoader($current);
 throw $e; } $this->setLoader($current);
 return $template; }
 /\*\* \* Returns true if the template is still fresh. \* \* Besides checking the loader for freshness information, \* this method also checks if the enabled extensions have \* not changed. \* \* @param string $name The template name \* @param int $time The last modification time of the cached template \* \* @return bool true if the template is fresh, false otherwise \*/ public function isTemplateFresh($name, $time) { if (0 === $this->lastModifiedExtension) { foreach ($this->extensions as $extension) { $r = new \ReflectionObject($extension); if (file\_exists($r->getFileName()) && ($extensionTime = filemtime($r->getFileName())) > $this->lastModifiedExtension) { $this->lastModifiedExtension = $extensionTime; } } }
 return $this->lastModifiedExtension <= $time && $this->getLoader()->isFresh($name, $time); }
 /\*\* \* Tries to load a template consecutively from an array. \* \* Similar to load() but it also accepts instances of \Twig\Template and \* \Twig\TemplateWrapper, and an array of templates where each is tried to be loaded. \* \* @param string|Template|\Twig\TemplateWrapper|array $names A template or an array of templates to try consecutively \* \* @return TemplateWrapper|Template \* \* @throws LoaderError When none of the templates can be found \* @throws SyntaxError When an error occurred during compilation \*/ public function resolveTemplate($names) { if (!\is\_array($names)) { $names = [$names]; }
 foreach ($names as $name) { if ($name instanceof Template) { return $name; } if ($name instanceof TemplateWrapper) { return $name; }
 try { return $this->loadTemplate($name); } catch (LoaderError $e) { if (1 === \count($names)) { throw $e; } } }
 throw new LoaderError(sprintf('Unable to find one of the following templates: "%s".', implode('", "', $names))); }
 /\*\* \* Clears the internal template cache. \* \* @deprecated since 1.18.3 (to be removed in 2.0) \*/ public function clearTemplateCache() { @trigger\_error(sprintf('The %s method is deprecated since version 1.18.3 and will be removed in Twig 2.0.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED);
 $this->loadedTemplates = []; }
 /\*\* \* Clears the template cache files on the filesystem. \* \* @deprecated since 1.22 (to be removed in 2.0) \*/ public function clearCacheFiles() { @trigger\_error(sprintf('The %s method is deprecated since version 1.22 and will be removed in Twig 2.0.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED);
 if (\is\_string($this->originalCache)) { foreach (new \RecursiveIteratorIterator(new \RecursiveDirectoryIterator($this->originalCache), \RecursiveIteratorIterator::LEAVES\_ONLY) as $file) { if ($file->isFile()) { @unlink($file->getPathname()); } } } }
 /\*\* \* Gets the Lexer instance. \* \* @return \Twig\_LexerInterface \* \* @deprecated since 1.25 (to be removed in 2.0) \*/ public function getLexer() { @trigger\_error(sprintf('The %s() method is deprecated since version 1.25 and will be removed in 2.0.', \_\_FUNCTION\_\_), \E\_USER\_DEPRECATED);
 if (null === $this->lexer) { $this->lexer = new Lexer($this); }
 return $this->lexer; }
 public function setLexer(\Twig\_LexerInterface $lexer) { $this->lexer = $lexer; }
 /\*\* \* Tokenizes a source code. \* \* @param string|Source $source The template source code \* @param string $name The template name (deprecated) \* \* @return TokenStream \* \* @throws SyntaxError When the code is syntactically wrong \*/ public function tokenize($source, $name = null) { if (!$source instanceof Source) { @trigger\_error(sprintf('Passing a string as the $source argument of %s() is deprecated since version 1.27. Pass a Twig\Source instance instead.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED); $source = new Source($source, $name); }
 if (null === $this->lexer) { $this->lexer = new Lexer($this); }
 return $this->lexer->tokenize($source); }
 /\*\* \* Gets the Parser instance. \* \* @return \Twig\_ParserInterface \* \* @deprecated since 1.25 (to be removed in 2.0) \*/ public function getParser() { @trigger\_error(sprintf('The %s() method is deprecated since version 1.25 and will be removed in 2.0.', \_\_FUNCTION\_\_), \E\_USER\_DEPRECATED);
 if (null === $this->parser) { $this->parser = new Parser($this); }
 return $this->parser; }
 public function setParser(\Twig\_ParserInterface $parser) { $this->parser = $parser; }
 /\*\* \* Converts a token stream to a node tree. \* \* @return ModuleNode \* \* @throws SyntaxError When the token stream is syntactically or semantically wrong \*/ public function parse(TokenStream $stream) { if (null === $this->parser) { $this->parser = new Parser($this); }
 return $this->parser->parse($stream); }
 /\*\* \* Gets the Compiler instance. \* \* @return \Twig\_CompilerInterface \* \* @deprecated since 1.25 (to be removed in 2.0) \*/ public function getCompiler() { @trigger\_error(sprintf('The %s() method is deprecated since version 1.25 and will be removed in 2.0.', \_\_FUNCTION\_\_), \E\_USER\_DEPRECATED);
 if (null === $this->compiler) { $this->compiler = new Compiler($this); }
 return $this->compiler; }
 public function setCompiler(\Twig\_CompilerInterface $compiler) { $this->compiler = $compiler; }
 /\*\* \* Compiles a node and returns the PHP code. \* \* @return string The compiled PHP source code \*/ public function compile(\Twig\_NodeInterface $node) { if (null === $this->compiler) { $this->compiler = new Compiler($this); }
 return $this->compiler->compile($node)->getSource(); }
 /\*\* \* Compiles a template source code. \* \* @param string|Source $source The template source code \* @param string $name The template name (deprecated) \* \* @return string The compiled PHP source code \* \* @throws SyntaxError When there was an error during tokenizing, parsing or compiling \*/ public function compileSource($source, $name = null) { if (!$source instanceof Source) { @trigger\_error(sprintf('Passing a string as the $source argument of %s() is deprecated since version 1.27. Pass a Twig\Source instance instead.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED); $source = new Source($source, $name); }
 try { return $this->compile($this->parse($this->tokenize($source))); } catch (Error $e) { $e->setSourceContext($source); throw $e; } catch (\Exception $e) { throw new SyntaxError(sprintf('An exception has been thrown during the compilation of a template ("%s").', $e->getMessage()), -1, $source, $e); } }
 public function setLoader(LoaderInterface $loader) { if (!$loader instanceof SourceContextLoaderInterface && 0 !== strpos(\get\_class($loader), 'Mock\_')) { @trigger\_error(sprintf('Twig loader "%s" should implement Twig\Loader\SourceContextLoaderInterface since version 1.27.', \get\_class($loader)), \E\_USER\_DEPRECATED); }
 $this->loader = $loader; }
 /\*\* \* Gets the Loader instance. \* \* @return LoaderInterface \*/ public function getLoader() { if (null === $this->loader) { throw new \LogicException('You must set a loader first.'); }
 return $this->loader; }
 /\*\* \* Sets the default template charset. \* \* @param string $charset The default charset \*/ public function setCharset($charset) { $this->charset = strtoupper($charset); }
 /\*\* \* Gets the default template charset. \* \* @return string The default charset \*/ public function getCharset() { return $this->charset; }
 /\*\* \* Initializes the runtime environment. \* \* @deprecated since 1.23 (to be removed in 2.0) \*/ public function initRuntime() { $this->runtimeInitialized = true;
 foreach ($this->getExtensions() as $name => $extension) { if (!$extension instanceof InitRuntimeInterface) { $m = new \ReflectionMethod($extension, 'initRuntime');
 $parentClass = $m->getDeclaringClass()->getName(); if ('Twig\_Extension' !== $parentClass && 'Twig\Extension\AbstractExtension' !== $parentClass) { @trigger\_error(sprintf('Defining the initRuntime() method in the "%s" extension is deprecated since version 1.23. Use the `needs\_environment` option to get the \Twig\_Environment instance in filters, functions, or tests; or explicitly implement Twig\Extension\InitRuntimeInterface if needed (not recommended).', $name), \E\_USER\_DEPRECATED); } }
 $extension->initRuntime($this); } }
 /\*\* \* Returns true if the given extension is registered. \* \* @param string $class The extension class name \* \* @return bool Whether the extension is registered or not \*/ public function hasExtension($class) { $class = ltrim($class, '\\'); if (!isset($this->extensionsByClass[$class]) && class\_exists($class, false)) { // For BC/FC with namespaced aliases $class = new \ReflectionClass($class); $class = $class->name; }
 if (isset($this->extensions[$class])) { if ($class !== \get\_class($this->extensions[$class])) { @trigger\_error(sprintf('Referencing the "%s" extension by its name (defined by getName()) is deprecated since 1.26 and will be removed in Twig 2.0. Use the Fully Qualified Extension Class Name instead.', $class), \E\_USER\_DEPRECATED); }
 return true; }
 return isset($this->extensionsByClass[$class]); }
 /\*\* \* Adds a runtime loader. \*/ public function addRuntimeLoader(RuntimeLoaderInterface $loader) { $this->runtimeLoaders[] = $loader; }
 /\*\* \* Gets an extension by class name. \* \* @param string $class The extension class name \* \* @return ExtensionInterface \*/ public function getExtension($class) { $class = ltrim($class, '\\'); if (!isset($this->extensionsByClass[$class]) && class\_exists($class, false)) { // For BC/FC with namespaced aliases $class = new \ReflectionClass($class); $class = $class->name; }
 if (isset($this->extensions[$class])) { if ($class !== \get\_class($this->extensions[$class])) { @trigger\_error(sprintf('Referencing the "%s" extension by its name (defined by getName()) is deprecated since 1.26 and will be removed in Twig 2.0. Use the Fully Qualified Extension Class Name instead.', $class), \E\_USER\_DEPRECATED); }
 return $this->extensions[$class]; }
 if (!isset($this->extensionsByClass[$class])) { throw new RuntimeError(sprintf('The "%s" extension is not enabled.', $class)); }
 return $this->extensionsByClass[$class]; }
 /\*\* \* Returns the runtime implementation of a Twig element (filter/function/test). \* \* @param string $class A runtime class name \* \* @return object The runtime implementation \* \* @throws RuntimeError When the template cannot be found \*/ public function getRuntime($class) { if (isset($this->runtimes[$class])) { return $this->runtimes[$class]; }
 foreach ($this->runtimeLoaders as $loader) { if (null !== $runtime = $loader->load($class)) { return $this->runtimes[$class] = $runtime; } }
 throw new RuntimeError(sprintf('Unable to load the "%s" runtime.', $class)); }
 public function addExtension(ExtensionInterface $extension) { if ($this->extensionInitialized) { throw new \LogicException(sprintf('Unable to register extension "%s" as extensions have already been initialized.', $extension->getName())); }
 $class = \get\_class($extension); if ($class !== $extension->getName()) { if (isset($this->extensions[$extension->getName()])) { unset($this->extensions[$extension->getName()], $this->extensionsByClass[$class]); @trigger\_error(sprintf('The possibility to register the same extension twice ("%s") is deprecated since version 1.23 and will be removed in Twig 2.0. Use proper PHP inheritance instead.', $extension->getName()), \E\_USER\_DEPRECATED); } }
 $this->lastModifiedExtension = 0; $this->extensionsByClass[$class] = $extension; $this->extensions[$extension->getName()] = $extension; $this->updateOptionsHash(); }
 /\*\* \* Removes an extension by name. \* \* This method is deprecated and you should not use it. \* \* @param string $name The extension name \* \* @deprecated since 1.12 (to be removed in 2.0) \*/ public function removeExtension($name) { @trigger\_error(sprintf('The %s method is deprecated since version 1.12 and will be removed in Twig 2.0.', \_\_METHOD\_\_), \E\_USER\_DEPRECATED);
 if ($this->extensionInitialized) { throw new \LogicException(sprintf('Unable to remove extension "%s" as extensions have already been initialized.', $name)); }
 $class = ltrim($name, '\\'); if (!isset($this->extensionsByClass[$class]) && class\_exists($class, false)) { // For BC/FC with namespaced aliases $class = new \ReflectionClass($class); $class = $class->name; }[View remainder of file in raw view](https://github.com/twigphp/Twig/raw/refs/tags/v1.44.7/src/Environment.php)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5557b652_20250114_200808.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fsecurity%2Fadvisories%2FGHSA-whr7-m3f8-mpm8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fsecurity%2Fadvisories%2FGHSA-whr7-m3f8-mpm8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=getgrav%2Fgrav)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[getgrav](/getgrav)
/
**[grav](/getgrav/grav)**
Public

* [Notifications](/login?return_to=%2Fgetgrav%2Fgrav) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fgetgrav%2Fgrav)
* [Star
   14.7k](/login?return_to=%2Fgetgrav%2Fgrav)

* [Code](/getgrav/grav)
* [Issues
  403](/getgrav/grav/issues)
* [Pull requests
  25](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects
  0](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

Additional navigation options

* [Code](/getgrav/grav)
* [Issues](/getgrav/grav/issues)
* [Pull requests](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

# Grav Server-side Template Injection (SSTI) via Twig Default Filters

High

[rhukster](/rhukster)
published
GHSA-whr7-m3f8-mpm8
Jun 14, 2023

## Package

No package listed

## Affected versions

<= v1.7.40 (Commit 685d762) (Latest version as of writing)

## Patched versions

None

## Description

Hi,

actually we have sent the bug report to security@getgrav.org on 27th March 2023 and on 10th April 2023.

# Grav Server-side Template Injection (SSTI) via Twig Default Filters

## Summary:

| **Product** | Grav CMS |
| --- | --- |
| **Vendor** | Grav |
| **Severity** | High - Users with login access to Grav Admin panel and page creation/update permissions are able to obtain remote code/command execution |
| **Affected Versions** | <= [v1.7.40](https://github.com/getgrav/grav/tree/1.7.40) (Commit [685d762](https://github.com/getgrav/grav/commit/685d76231a057416651ed192a6a2e83720800e61)) (Latest version as of writing) |
| **Tested Versions** | v1.7.40 |
| **Internal Identifier** | STAR-2023-0008 |
| **CVE Identifier** | TBD |
| **CWE(s)** | CWE-184: Incomplete List of Disallowed Inputs, CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine |

## CVSS3.1 Scoring System:

**Base Score:** 7.2 (High)

**Vector String:** `CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H`

| **Metric** | **Value** |
| --- | --- |
| **Attack Vector (AV)** | Network |
| **Attack Complexity (AC)** | Low |
| **Privileges Required (PR)** | High |
| **User Interaction (UI)** | None |
| **Scope (S)** | Unchanged |
| **Confidentiality (C)** | High |
| **Integrity (I)** | High |
| **Availability (A)** | High |

## Product Overview:

Grav is a PHP-based flat-file content management system (CMS) designed to provide a fast and simple way to build websites. It supports rendering of web pages written in Markdown and Twig expressions, and provides an administration panel to manage the entire website via an optional Admin plugin.

## Vulnerability Summary:

The patch for [CVE-2022-2073](https://huntr.dev/bounties/3ef640e6-9e25-4ecb-8ec1-64311d63fe66/), a server-side template injection vulnerability in Grav leveraging the default `filter()` function, did not block other built-in functions exposed by Twig's Core Extension that could be used to invoke arbitrary unsafe functions, thereby allowing for remote code execution.

## Vulnerability Details:

Twig comes with an extension known as the [Core Extension](https://github.com/twigphp/Twig/blob/v1.44.7/src/Extension/CoreExtension.php) that is enabled by default when initialising a new [Twig environment](https://github.com/twigphp/Twig/blob/v1.44.7/src/Environment.php#L148). Twig's Core Extension provides multiple built-in filters, such as the `filter()` function, which can be used in Twig templates.

[CVE-2022-2073](https://huntr.dev/bounties/3ef640e6-9e25-4ecb-8ec1-64311d63fe66/) leverages the default `filter()` filter function in Twig to invoke arbitrary unsafe functions. This was patched by overriding the default `filter()` filter function in commit [9d6a2d](https://www.github.com/getgrav/grav/commit/9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83) of Grav v1.7.34 to perform validation checks on the arguments passed to `filter()`:

```
...
class GravExtension extends AbstractExtension implements GlobalsInterface
{
    ...
    public function getFilters(): array
    {
        return [
            ...
            // Security fix
+           new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),
        ];
    }

    ...

+   /**
+    * @param Environment $env
+    * @param array $array
+    * @param callable|string $arrow
+    * @return array|CallbackFilterIterator
+    * @throws RuntimeError
+    */
+   function filterFilter(Environment $env, $array, $arrow)
+   {
+       if (is_string($arrow) && Utils::isDangerousFunction($arrow)) {
+           throw new RuntimeError('Twig |filter("' . $arrow . '") is not allowed.');
+       }
+
+       return \twig_array_filter($env, $array, $arrow);
+   }
}
```

However, looking at the source code of [/src/Extension/CoreExtension.php](https://github.com/twigphp/Twig/blob/v1.44.7/src/Extension/CoreExtension.php) of Twig, alternative default Twig filters could also be used invoke arbitrary functions:

```
...
class CoreExtension extends AbstractExtension
{
    ...
    public function getFilters(): array
    {
        return [
            ...
            // array helpers
            ...
            new TwigFilter('filter', 'twig_array_filter', ['needs_environment' => true]), // unsafe
            new TwigFilter('map', 'twig_array_map', ['needs_environment' => true]), // unsafe
            new TwigFilter('reduce', 'twig_array_reduce', ['needs_environment' => true]), // unsafe
        ];
    }
```

The three filter functions above respectively call `array_filter()`, `array_map()` and `array_reduce()`. Since only `filter()` is being overriden by Grav to ensure that the callable passed to `filter()` does not result in the invocation of an unsafe function, the other two functions (i.e. `map()` and `reduce()`) could be used by an authenticated attacker that is able to inject and render malicious templates to gain remote code execution.

## Exploit Conditions:

This vulnerability can be exploited if the attacker has access to:

1. an administrator account, or
2. a non-administrator, user account that are granted the following permissions:
   * login access to Grav admin panel, and
   * page creation or update rights

## Reproduction Steps:

1. Log in to Grav Admin using an administrator account.
2. Navigate to `Accounts > Add`, and ensure that the following permissions are assigned when creating a new low-privileged user:
   * Login to Admin - Allowed
   * Page Update - Allowed
3. Log out of Grav Admin, and log back in using the account created in step 2.
4. Navigate to `http://<grav_installation>/admin/pages/home`.
5. Click the `Advanced` tab and select the checkbox beside `Twig` to ensure that Twig processing is enabled for the modified webpage.
6. Under the `Content` tab, insert the following payload within the editor:
   ```
   {{ ['id'] | map('system') }}
   {{ ['id'] | reduce('system') }}
   ```
7. Click the Preview button. Observe that the output of the `id` shell command is returned in the preview.

## Suggested Mitigations:

Override the built-in Twig `map()` and `reduce()` filter functions in `system/src/Grav/Common/Twig/Extension/GravExtension.php` to validate the argument passed to the filter in `$arrow`.

For example:

```
...
class GravExtension extends AbstractExtension implements GlobalsInterface
{
    ...
    public function getFilters(): array
    {
        return [
            ...
            // Security fix
            new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),
+           new TwigFilter('map', [$this, 'mapFilter'], ['needs_environment' => true]),
+           new TwigFilter('reduce', [$this, 'reduceFilter'], ['needs_environment' => true]),
        ];
    }

    ...
+   /**
+    * @param Environment $env
+    * @param array $array
+    * @param callable|string $arrow
+    * @return array|CallbackFilterIterator
+    * @throws RuntimeError
+    */
+   function mapFilter(Environment $env, $array, $arrow)
+   {
+       if (!$arrow instanceof Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {
+           throw new RuntimeError('Twig |map("' . $arrow . '") is not allowed.');
+       }
+
+       return \twig_array_map($env, $array, $arrow);
+   }
+
+   /**
+    * @param Environment $env
+    * @param array $array
+    * @param callable|string $arrow
+    * @return array|CallbackFilterIterator
+    * @throws RuntimeError
+    */
+   function reduceFilter(Environment $env, $array, $arrow)
+   {
+       if (!$arrow instanceof Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {
+           throw new RuntimeError('Twig |reduce("' . $arrow . '") is not allowed.');
+       }
+
+       return \twig_array_reduce($env, $array, $arrow);
+   }
}
```
## Detection Guidance:

The following strategies may be used to detect potential exploitation attempts.

1. Searching within Markdown pages using the following shell command:

   `grep -Priz -e '\|\s*(map|reduce)\s*\(' /path/to/webroot/user/pages/`
2. Searching within Doctrine cache data using the following shell command:

   `grep -Priz -e '\|\s*(map|reduce)\s*\(' --include '*.doctrinecache.data' /path/to/webroot/cache/`
3. Searching within Twig cache using the following shell command:

   `grep -Priz -e 'twig_array_(map|reduce)' /path/to/webroot/cache/twig/`
4. Searching within compiled Twig template files using the following shell command:

   `grep -Priz -e '\|\s*(map|reduce)\s*\(' /path/to/webroot/cache/compiled/files/`

Note that it is not possible to detect indicators of compromise reliably using the Grav log file (located at `/path/to/webroot/logs/grav.log` by default), as successful exploitation attempts do not generate any additional logs. However, it is worthwhile to examine any PHP errors or warnings logged to determine the existence of any failed exploitation attempts.

## Credits:

Ngo Wei Lin ([@Creastery](https://twitter.com/Creastery)) & Wang Hengyue ([@w\_hy\_04](https://twitter.com/w_hy_04)) of STAR Labs SG Pte. Ltd. ([@starlabs\_sg](https://twitter.com/starlabs_sg))

## Vulnerability Disclosure:

This vulnerability report is subject to a 120 day disclosure deadline as per [STAR Labs SG Pte. Ltd.'s Vulnerability Disclosure Policy](https://starlabs.sg/advisories/STAR%20Labs%20SG%20Pte.%20Ltd.%20Vulnerability%20Disclosure%20Policy.pdf). After 120 days have elapsed, the vulnerability report will be published to the public by [STAR Labs SG Pte. Ltd.](https://starlabs.sg/) (STAR Labs).

The scheduled disclosure date is ***25th July, 2023***. Disclosure at an earlier date is also possible if agreed upon by all parties.

Kindly note that STAR Labs reserved and assigned the following CVE identifiers to the respective vulnerabilities presented in this report:

1. **CVE-2023-30596**

   Server-side Template Injection (SSTI) in getgrav/grav <= v1.7.40 allows Grav Admin users with page creation or update rights to bypass the dangerous functions denylist check in `GravExtension.filterFilter()` and to achieve remote code execution via Twig's default filters `map()` and `reduce()`. This is a bypass of [CVE-2022-2073](https://github.com/advisories/GHSA-cxgw-r5jg-7xwq "CVE-2022-2073").

### Severity

High

7.2

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
High

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2023-34448

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20) [CWE-1336](/advisories?query=cwe%3A1336)

### Credits

* [![@jacobsoo](https://avatars.githubusercontent.com/u/3516693?s=40&v=4)](/jacobsoo)
  [jacobsoo](/jacobsoo)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d907bd06_20250114_200807.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F8c2c1cb72611a399f13423fc6d0e1d998c03e5c8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F8c2c1cb72611a399f13423fc6d0e1d998c03e5c8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=getgrav%2Fgrav)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[getgrav](/getgrav)
/
**[grav](/getgrav/grav)**
Public

* [Notifications](/login?return_to=%2Fgetgrav%2Fgrav) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fgetgrav%2Fgrav)
* [Star
   14.7k](/login?return_to=%2Fgetgrav%2Fgrav)

* [Code](/getgrav/grav)
* [Issues
  403](/getgrav/grav/issues)
* [Pull requests
  25](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects
  0](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

Additional navigation options

* [Code](/getgrav/grav)
* [Issues](/getgrav/grav/issues)
* [Pull requests](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

## Commit

[Permalink](/getgrav/grav/commit/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

better SSTI in |map and |filter

[Browse files](/getgrav/grav/tree/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8)
Browse the repository at this point in the history

* Loading branch information

[![@rhukster](https://avatars.githubusercontent.com/u/1084697?s=40&v=4)](/rhukster)

[rhukster](/getgrav/grav/commits?author=rhukster "View all commits by rhukster")
committed
Jun 13, 2023

1 parent
[9d01140](/getgrav/grav/commit/9d01140a63c77075ef09b26ef57cf186138151a5)

commit 8c2c1cb

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**11 additions**
and
**5 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGELOG.md
  [CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed)
* system/src/Grav/Common

  + Twig/Extension

    - system/src/Grav/Common/Twig/Extension/GravExtension.php
      [GravExtension.php](#diff-a85d37d04dd05856c061a673dcedb849de79194bb315500bd681fb001484d644)
  + system/src/Grav/Common/Utils.php
    [Utils.php](#diff-4feb7352ae6910406f76519a42132a9c2814083459774e50622c3151deafc787)

## There are no files selected for viewing

4 changes: 3 additions & 1 deletion

4
[CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed "CHANGELOG.md")

Show comments

[View file](/getgrav/grav/blob/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8/CHANGELOG.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -3,8 +3,10 @@ |
|  |  |  |
|  |  | 1. [](#new) |
|  |  | \* Added a new `system.languages.debug` option that adds a `<span class="translate-debug"></span>` around strings translated with `|t`. This can be styled by the theme as needed. |
|  |  | 1. [](#improved) |
|  |  | \* More robust SSTI handling in `|filter` and `|map` |
|  |  | 1. [](#bugfix) |
|  |  | \* \* Fixed Twig `|map()` allowing code execution |
|  |  | \* Fixed Twig `|map()` allowing code execution |
|  |  |  |
|  |  | # v1.7.41.2 |
|  |  | ## 06/01/2023 |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[system/src/Grav/Common/Twig/Extension/GravExtension.php](#diff-a85d37d04dd05856c061a673dcedb849de79194bb315500bd681fb001484d644 "system/src/Grav/Common/Twig/Extension/GravExtension.php")

Show comments

[View file](/getgrav/grav/blob/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8/system/src/Grav/Common/Twig/Extension/GravExtension.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1708,7 +1708,7 @@ public function ofTypeFunc($var, $typeTest = null, $className = null) |
|  |  | \*/ |
|  |  | function filterFilter(Environment $env, $array, $arrow) |
|  |  | { |
|  |  | if (is\_string($arrow) && Utils::isDangerousFunction($arrow)) { |
|  |  | if (!$arrow instanceof \Closure && !is\_string($arrow) || Utils::isDangerousFunction($arrow)) { |
|  |  | throw new RuntimeError('Twig |filter("' . $arrow . '") is not allowed.'); |
|  |  | } |
|  |  |  |
| Expand All | | @@ -1724,7 +1724,7 @@ function filterFilter(Environment $env, $array, $arrow) |
|  |  | \*/ |
|  |  | function mapFilter(Environment $env, $array, $arrow) |
|  |  | { |
|  |  | if (is\_string($arrow) && Utils::isDangerousFunction($arrow)) { |
|  |  | if (!$arrow instanceof \Closure && !is\_string($arrow) || Utils::isDangerousFunction($arrow)) { |
|  |  | throw new RuntimeError('Twig |map("' . $arrow . '") is not allowed.'); |
|  |  | } |
|  |  |  |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[system/src/Grav/Common/Utils.php](#diff-4feb7352ae6910406f76519a42132a9c2814083459774e50622c3151deafc787 "system/src/Grav/Common/Utils.php")

Show comments

[View file](/getgrav/grav/blob/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8/system/src/Grav/Common/Utils.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1950,10 +1950,10 @@ public static function getSupportPageTypes(array $defaults = null) |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param string $name |
|  |  | \* @param string|array $name |
|  |  | \* @return bool |
|  |  | \*/ |
|  |  | public static function isDangerousFunction(string $name): bool |
|  |  | public static function isDangerousFunction($name): bool |
|  |  | { |
|  |  | static $commandExecutionFunctions = [ |
|  |  | 'exec', |
| Expand Down  Expand Up | | @@ -2050,6 +2050,10 @@ public static function isDangerousFunction(string $name): bool |
|  |  | 'posix\_setuid', |
|  |  | ]; |
|  |  |  |
|  |  | if (is\_array($name) || strpos($name, ":") !== false) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | if (in\_array($name, $commandExecutionFunctions)) { |
|  |  | return true; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8c2c1cb`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F8c2c1cb72611a399f13423fc6d0e1d998c03e5c8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.github.com_d12e5968_20250114_200817.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=getgrav%2Fgrav)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[getgrav](/getgrav)
/
**[grav](/getgrav/grav)**
Public

* [Notifications](/login?return_to=%2Fgetgrav%2Fgrav) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fgetgrav%2Fgrav)
* [Star
   14.7k](/login?return_to=%2Fgetgrav%2Fgrav)

* [Code](/getgrav/grav)
* [Issues
  403](/getgrav/grav/issues)
* [Pull requests
  25](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects
  0](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

Additional navigation options

* [Code](/getgrav/grav)
* [Issues](/getgrav/grav/issues)
* [Pull requests](/getgrav/grav/pulls)
* [Discussions](/getgrav/grav/discussions)
* [Actions](/getgrav/grav/actions)
* [Projects](/getgrav/grav/projects)
* [Security](/getgrav/grav/security)
* [Insights](/getgrav/grav/pulse)

## Commit

[Permalink](/getgrav/grav/commit/9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fixed Twig `|filter()` allowing code execution

[Browse files](/getgrav/grav/tree/9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83)
Browse the repository at this point in the history

* Loading branch information

[![@mahagr](https://avatars.githubusercontent.com/u/854915?s=40&v=4)](/mahagr)

[mahagr](/getgrav/grav/commits?author=mahagr "View all commits by mahagr")
committed
Jun 13, 2022

1 parent
[de4af5d](/getgrav/grav/commit/de4af5dbccd8b22b295f956ef143a79272b1fb62)

commit 9d6a2db

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**22 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* CHANGELOG.md
  [CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed)
* system/src/Grav/Common/Twig/Extension

  + system/src/Grav/Common/Twig/Extension/GravExtension.php
    [GravExtension.php](#diff-a85d37d04dd05856c061a673dcedb849de79194bb315500bd681fb001484d644)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[CHANGELOG.md](#diff-06572a96a58dc510037d5efa622f9bec8519bc1beab13c9f251e97e657a9d4ed "CHANGELOG.md")

Show comments

[View file](/getgrav/grav/blob/9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83/CHANGELOG.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -8,6 +8,7 @@ |
|  |  | \* Regression: Fixed saving page with a new language causing cache corruption [getgrav/grav-plugin-admin#2282](https://github.com/getgrav/grav-plugin-admin/issues/2282) |
|  |  | \* Fixed a potential fatal error when using watermark in images |
|  |  | \* Fixed `bin/grav install` command with arbitrary destination folder name |
|  |  | \* Fixed Twig `|filter()` allowing code execution |
|  |  |  |
|  |  | # v1.7.33 |
|  |  | ## 04/25/2022 |
| Expand Down | |  |

21 changes: 21 additions & 0 deletions

21
[system/src/Grav/Common/Twig/Extension/GravExtension.php](#diff-a85d37d04dd05856c061a673dcedb849de79194bb315500bd681fb001484d644 "system/src/Grav/Common/Twig/Extension/GravExtension.php")

Show comments

[View file](/getgrav/grav/blob/9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83/system/src/Grav/Common/Twig/Extension/GravExtension.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -9,6 +9,7 @@ |
|  |  |  |
|  |  | namespace Grav\Common\Twig\Extension; |
|  |  |  |
|  |  | use CallbackFilterIterator; |
|  |  | use Cron\CronExpression; |
|  |  | use Grav\Common\Config\Config; |
|  |  | use Grav\Common\Data\Data; |
| Expand Down  Expand Up | | @@ -41,6 +42,7 @@ |
|  |  | use RocketTheme\Toolbox\ResourceLocator\UniformResourceLocator; |
|  |  | use Traversable; |
|  |  | use Twig\Environment; |
|  |  | use Twig\Error\RuntimeError; |
|  |  | use Twig\Extension\AbstractExtension; |
|  |  | use Twig\Extension\GlobalsInterface; |
|  |  | use Twig\Loader\FilesystemLoader; |
| Expand Down  Expand Up | | @@ -167,6 +169,9 @@ public function getFilters(): array |
|  |  | // PHP methods |
|  |  | new TwigFilter('count', 'count'), |
|  |  | new TwigFilter('array\_diff', 'array\_diff'), |
|  |  |  |
|  |  | // Security fix |
|  |  | new TwigFilter('filter', [$this, 'filterFilter'], ['needs\_environment' => true]), |
|  |  | ]; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1676,4 +1681,20 @@ public function ofTypeFunc($var, $typeTest = null, $className = null) |
|  |  | return is\_string($var); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param Environment $env |
|  |  | \* @param array $array |
|  |  | \* @param callable|string $arrow |
|  |  | \* @return array|CallbackFilterIterator |
|  |  | \* @throws RuntimeError |
|  |  | \*/ |
|  |  | function filterFilter(Environment $env, $array, $arrow) |
|  |  | { |
|  |  | if (is\_string($arrow) && Utils::isDangerousFunction($arrow)) { |
|  |  | throw new RuntimeError('Twig |filter("' . $arrow . '") is not allowed.'); |
|  |  | } |
|  |  |  |
|  |  | return \twig\_array\_filter($env, $array, $arrow); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9d6a2db`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgetgrav%2Fgrav%2Fcommit%2F9d6a2dba09fd4e56f5cdfb9a399caea355bfeb83) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from huntr.dev_e75f6a85_20250114_200814.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)
