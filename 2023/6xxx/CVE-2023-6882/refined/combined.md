=== Content from plugins.trac.wordpress.org_df1710cd_20250114_191002.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3010737%2Fsimple-membership)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3010734/simple-membership "Changeset 3010734 for simple-membership")
* [Next Change](/changeset/3010738/simple-membership "Changeset 3010738 for simple-membership") →

---

# Changeset [3010737](/changeset/3010737 "Show full changeset") for [simple-membership](/browser/simple-membership?rev=3010737 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/16/2023 01:35:53 AM
([13 months](/timeline?from=2023-12-16T01%3A35%3A53Z&precision=second "See timeline at 12/16/2023 01:35:53 AM") ago)

Author:
wp.insider
Message:

v4.3.9

Location:
[simple-membership/trunk](/browser/simple-membership/trunk?rev=3010737)
Files:

4 added
9 deleted
25 edited

* [classes/admin-includes/class.swpm-payment-settings-menu-tab.php](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payment-settings-menu-tab.php?rev=3010737 "Show entry in browser")
  (added)
* [classes/admin-includes/class.swpm-payments-admin-menu.php](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php?rev=3010737 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [classes/admin-includes/class.swpm-send-direct-email-menu.php](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737 "Show entry in browser")
  (modified)
  ([7 diffs](#file2 "Show differences"))
* [classes/class.simple-wp-membership.php](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=3010737 "Show entry in browser")
  (modified)
  ([4 diffs](#file3 "Show differences"))
* [classes/class.swpm-members.php](/browser/simple-membership/trunk/classes/class.swpm-members.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [classes/class.swpm-settings.php](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=3010737 "Show entry in browser")
  (modified)
  ([4 diffs](#file5 "Show differences"))
* [classes/class.swpm-utils-member.php](/browser/simple-membership/trunk/classes/class.swpm-utils-member.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file6 "Show differences"))
* [classes/class.swpm-utils.php](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=3010737 "Show entry in browser")
  (modified)
  ([3 diffs](#file7 "Show differences"))
* [classes/shortcode-related/class.swpm-shortcodes-handler.php](/browser/simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [css/swpm.common.css](/browser/simple-membership/trunk/css/swpm.common.css?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file9 "Show differences"))
* [ipn/swpm-stripe-buy-now-ipn.php](/browser/simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [languages/simple-membership.pot](/browser/simple-membership/trunk/languages/simple-membership.pot?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file11 "Show differences"))
* [lib/paypal/class-swpm-paypal-acdc-related.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737 "Show entry in browser")
  (modified)
  ([10 diffs](#file12 "Show differences"))
* [lib/paypal/class-swpm-paypal-bearer.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=3010737 "Show entry in browser")
  (modified)
  ([4 diffs](#file13 "Show differences"))
* [lib/paypal/class-swpm-paypal-button-ajax-handler.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-button-ajax-handler.php?rev=3010737 "Show entry in browser")
  (added)
* [lib/paypal/class-swpm-paypal-main.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=3010737 "Show entry in browser")
  (modified)
  ([4 diffs](#file15 "Show differences"))
* [lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=3010737 "Show entry in browser")
  (modified)
  ([3 diffs](#file16 "Show differences"))
* [lib/paypal/class-swpm-paypal-request-api-injector.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=3010737 "Show entry in browser")
  (modified)
  ([3 diffs](#file17 "Show differences"))
* [lib/paypal/class-swpm-paypal-request-api.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737 "Show entry in browser")
  (modified)
  ([12 diffs](#file18 "Show differences"))
* [lib/paypal/class-swpm-paypal-utility-ipn-related.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-utility-ipn-related.php?rev=3010737 "Show entry in browser")
  (added)
* [lib/paypal/class-swpm-paypal-webhook.php](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file20 "Show differences"))
* [lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737 "Show entry in browser")
  (modified)
  ([6 diffs](#file21 "Show differences"))
* [lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=3010737 "Show entry in browser")
  (modified)
  ([3 diffs](#file22 "Show differences"))
* [lib/stripe-gateway/data/test.png](/browser/simple-membership/trunk/lib/stripe-gateway/data/test.png?rev=1438528 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/AttachedObject.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/AttachedObject.php?rev=1487789 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/Error](/browser/simple-membership/trunk/lib/stripe-gateway/lib/Error?rev=2156419 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/ExternalAccount.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/ExternalAccount.php?rev=1487789 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/FileUpload.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/FileUpload.php?rev=2156419 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/IssuerFraudRecord.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/IssuerFraudRecord.php?rev=2156419 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/JsonSerializable.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/JsonSerializable.php?rev=1438528 "Show what was removed (content at revision 3010736)")
  (deleted)
* [lib/stripe-gateway/lib/Util/AutoPagingIterator.php](/browser/simple-membership/trunk/lib/stripe-gateway/lib/Util/AutoPagingIterator.php?rev=2156419 "Show what was removed (content at revision 3010736)")
  (deleted)
* [readme.txt](/browser/simple-membership/trunk/readme.txt?rev=3010737 "Show entry in browser")
  (modified)
  ([3 diffs](#file31 "Show differences"))
* [simple-wp-membership.php](/browser/simple-membership/trunk/simple-wp-membership.php?rev=3010737 "Show entry in browser")
  (modified)
  ([2 diffs](#file32 "Show differences"))
* [views/admin\_send\_direct\_email\_menu.php](/browser/simple-membership/trunk/views/admin_send_direct_email_menu.php?rev=2902081 "Show what was removed (content at revision 3010736)")
  (deleted)
* [views/admin\_settings.php](/browser/simple-membership/trunk/views/admin_settings.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file34 "Show differences"))
* [views/payments/admin\_payment\_settings.php](/browser/simple-membership/trunk/views/payments/admin_payment_settings.php?rev=3010737 "Show entry in browser")
  (modified)
  ([1 diff](#file35 "Show differences"))
* [views/payments/payment-gateway/paypal\_advanced\_buy\_now\_button\_shortcode\_view.php](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_advanced_buy_now_button_shortcode_view.php?rev=3010737 "Show entry in browser")
  (added)
* [views/payments/payment-gateway/paypal\_buy\_now\_new\_button\_shortcode\_view.php](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737 "Show entry in browser")
  (modified)
  ([5 diffs](#file37 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php](/changeset/3010737/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php")

  | [r2875084](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php?rev=2875084#L26 "Show revision 2875084 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php?rev=3010737#L26 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 26 | 26 | <h2 class="nav-tab-wrapper"> |
  | 27 | 27 | <a class="nav-tab <?php echo ($tab == '') ? 'nav-tab-active' : ''; ?>" href="admin.php?page=simple\_wp\_membership\_payments"><?php \_e('Transactions', 'simple-membership'); ?></a> |
  |  | 28 | <a class="nav-tab <?php echo ($tab == 'payment\_settings') ? 'nav-tab-active' : ''; ?>" href="admin.php?page=simple\_wp\_membership\_payments&tab=payment\_settings"><?php \_e('Payment Settings', 'simple-membership'); ?></a> |
  | 28 | 29 | <a class="nav-tab <?php echo ($tab == 'payment\_buttons') ? 'nav-tab-active' : ''; ?>" href="admin.php?page=simple\_wp\_membership\_payments&tab=payment\_buttons"><?php \_e('Manage Payment Buttons', 'simple-membership'); ?></a> |
  | 29 | 30 | <a class="nav-tab <?php echo ($tab == 'create\_new\_button') ? 'nav-tab-active' : ''; ?>" href="admin.php?page=simple\_wp\_membership\_payments&tab=create\_new\_button"><?php \_e('Create New Button', 'simple-membership'); ?></a> |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php?rev=2875084#L66) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-payments-admin-menu.php?rev=3010737#L67) |  |
  | 66 | 67 | //Switch case for the various different tabs handled by the core plugin. |
  | 67 | 68 | switch ($tab) { |
  |  | 69 | case 'payment\_settings': |
  |  | 70 | include\_once(SIMPLE\_WP\_MEMBERSHIP\_PATH . 'classes/admin-includes/class.swpm-payment-settings-menu-tab.php'); |
  |  | 71 | $payment\_settings\_tab = new SWPM\_Payment\_Settings\_Menu\_Tab(); |
  |  | 72 | $payment\_settings\_tab->handle\_payment\_settings\_menu\_tab(); |
  |  | 73 | break; |
  | 68 | 74 | case 'payment\_buttons': |
  | 69 | 75 | include\_once(SIMPLE\_WP\_MEMBERSHIP\_PATH . '/views/payments/admin\_payment\_buttons.php'); |
* ## [simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php](/changeset/3010737/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php")

  | [r2960602](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L9 "Show revision 2960602 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L9 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 9 | 9 | public function handle\_send\_direct\_email\_menu() |
  | 10 | 10 | { |
  |  | 11 | //Check current\_user\_can() or die. |
  |  | 12 | SwpmMiscUtils::check\_user\_permission\_and\_is\_admin('Send Direct Email Admin Menu'); |
  |  | 13 |  |
  |  | 14 | //Triger action hook |
  | 11 | 15 | do\_action('swpm\_send\_direct\_email\_menu\_start'); |
  | 12 | 16 |  |
  |  | 17 | // Get saved data |
  | 13 | 18 | $settings = SwpmSettings::get\_instance(); |
  | 14 | 19 | $send\_email\_menu\_data = $settings->get\_value('send\_email\_menu\_data'); |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L18) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L23) |  |
  | 18 | 23 | } |
  | 19 | 24 |  |
  | 20 |  | if (isset($\_POST['send\_email\_submit'])) { |
  |  | 25 | // Get WP user's info |
  |  | 26 | $logged\_in\_user = wp\_get\_current\_user(); |
  |  | 27 | $logged\_in\_user\_email = isset($logged\_in\_user->user\_email) ? $logged\_in\_user->user\_email : ''; |
  |  | 28 | $logged\_in\_user\_name = isset($logged\_in\_user->user\_login) ? $logged\_in\_user->user\_login : ''; |
  |  | 29 | // $logged\_in\_user\_id = $logged\_in\_user->ID; |
  |  | 30 |  |
  |  | 31 | if (isset($\_POST['send\_email\_submit']) || isset($\_POST['list\_recipient\_list']) ) { |
  | 21 | 32 | $swpm\_send\_email\_nonce = filter\_input(INPUT\_POST, 'swpm\_send\_email\_nonce'); |
  | 22 | 33 | if (!wp\_verify\_nonce($swpm\_send\_email\_nonce, 'swpm\_send\_email\_nonce\_action')) { |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L27) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L38) |  |
  | 27 | 38 | $send\_email\_menu\_data['send\_email\_selected\_target\_recipients'] = $target\_recipients; |
  | 28 | 39 | $send\_email\_menu\_data['send\_email\_membership\_level'] = (isset($\_POST['send\_email\_membership\_level']) && $\_POST['send\_email\_membership\_level'] != '' && $target\_recipients === 'membership\_level') ? sanitize\_text\_field($\_POST['send\_email\_membership\_level']) : ''; |
  | 29 |  | $send\_email\_menu\_data['send\_email\_members\_id'] = (isset($\_POST['send\_email\_members\_id']) && $\_POST['send\_email\_members\_id'] != '' && $target\_recipients === 'members\_id') ? sanitize\_text\_field($\_POST['send\_email\_members\_id']) : ''; |
  | 30 |  | $send\_email\_menu\_data['send\_email\_enable\_html'] = (isset($\_POST['send\_email\_enable\_html']) && $\_POST['send\_email\_enable\_html'] === 'on') ? 'on' : ''; |
  |  | 40 | $send\_email\_menu\_data['send\_email\_account\_state'] = (isset($\_POST['send\_email\_account\_state']) && $\_POST['send\_email\_account\_state'] != '' && $target\_recipients === 'membership\_level') ? sanitize\_text\_field($\_POST['send\_email\_account\_state']) : ''; |
  |  | 41 | $send\_email\_menu\_data['send\_email\_copy\_author'] = (isset($\_POST['send\_email\_copy\_author']) && $\_POST['send\_email\_copy\_author'] === 'on') ? 'on' : ''; |
  |  | 42 | $send\_email\_menu\_data['send\_email\_members\_id'] = (isset($\_POST['send\_email\_members\_id']) && $\_POST['send\_email\_members\_id'] != '' && $target\_recipients === 'members\_id') ? sanitize\_text\_field($\_POST['send\_email\_members\_id']) : ''; |
  |  | 43 | $send\_email\_menu\_data['send\_email\_enable\_html'] = (isset($\_POST['send\_email\_enable\_html']) && $\_POST['send\_email\_enable\_html'] === 'on') ? 'on' : ''; |
  | 31 | 44 | $send\_email\_menu\_data['send\_email\_subject'] = (isset($\_POST['send\_email\_subject']) && $\_POST['send\_email\_subject'] != '') ? sanitize\_text\_field($\_POST['send\_email\_subject']) : ''; |
  | 32 | 45 | $send\_email\_menu\_data['send\_email\_body'] = (isset($\_POST['send\_email\_body']) && $\_POST['send\_email\_body'] != '') ? stripslashes(wp\_kses\_post($\_POST['send\_email\_body'])) : ''; |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L41) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L54) |  |
  | 41 | 54 | $recipients = array(); |
  | 42 | 55 |  |
  |  | 56 | $found\_logged\_in\_user\_in\_receipients = false; // Set true if if logged in user is in the recipient list. |
  |  | 57 | $list\_of\_recipients\_to\_display = array(); |
  |  | 58 |  |
  | 43 | 59 | // Validate recipients |
  | 44 | 60 | if ( $target\_recipients === 'membership\_level' && !empty($\_POST['send\_email\_membership\_level'])) { |
  | 45 |  | // send mail to specified members by membership level. |
  | 46 |  | $members = SwpmMemberUtils::get\_all\_members\_of\_a\_level~~(sanitize\_text\_field($\_POST['send\_email\_membership\_level~~'])); |
  |  | 61 | // send mail to specified members by membership level and account status. |
  |  | 62 | $members = SwpmMemberUtils::get\_all\_members\_of\_a\_level\_and\_a\_state(sanitize\_text\_field($\_POST['send\_email\_membership\_level']), sanitize\_text\_field($\_POST['send\_email\_account\_state'])); |
  | 47 | 63 | foreach ($members as $member) { |
  | 48 | 64 | $recipients[] = $member; |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L96) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L112) |  |
  | 96 | 112 | continue; |
  | 97 | 113 | } |
  |  | 114 |  |
  |  | 115 | if($recipient->email == $logged\_in\_user\_email) { |
  |  | 116 | $found\_logged\_in\_user\_in\_receipients = true; // Added by Dennis. No need to copy author |
  |  | 117 | } |
  | 98 | 118 |  |
  | 99 | 119 | // Send the email |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L109) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L129) |  |
  | 109 | 129 | $body = nl2br($body); |
  | 110 | 130 | } |
  | 111 |  | wp\_mail($recipient->email, $subject , $body, $headers); |
  | 112 |  | SwpmLog::log\_simple\_debug( 'Sending direct email. Email sent to : '.$recipient->email, true ); |
  | 113 |  | } |
  | 114 |  | echo '<div id="response-message" class="updated fade"><p>'; |
  | 115 |  | \_e('Email Sent Successfully!', 'simple-membership'); |
  | 116 |  | echo '</p></div>'; |
  |  | 131 |  |
  |  | 132 | if ( isset($\_POST['list\_recipient\_list']))  { |
  |  | 133 | // Get the membership level name |
  |  | 134 | $membership\_level\_name = SwpmMembershipLevelUtils::get\_membership\_level\_name\_of\_a\_member($recipient->member\_id); |
  |  | 135 | $list\_of\_recipients\_to\_display[] = array( |
  |  | 136 | 'id' => $recipient->member\_id, |
  |  | 137 | 'user\_name' => $recipient->user\_name, |
  |  | 138 | 'email' => $recipient->email, |
  |  | 139 | 'membership\_level' => $membership\_level\_name, |
  |  | 140 | 'account\_state' => $recipient->account\_state ? SwpmUtils::get\_account\_state\_options()[$recipient->account\_state] : 'N/A', |
  |  | 141 | ); |
  |  | 142 | } |
  |  | 143 | else { |
  |  | 144 | // Send the Emails |
  |  | 145 | wp\_mail($recipient->email, $subject , $body, $headers); |
  |  | 146 | SwpmLog::log\_simple\_debug( 'Sending direct email. Email sent to : '.$recipient->email, true ); |
  |  | 147 | } |
  |  | 148 |  |
  |  | 149 | } // end of foreach loop |
  |  | 150 |  |
  |  | 151 | // Check if need to include currently logged in user as recipient. |
  |  | 152 | // If the author of the emails is not in the selected recipients, but a copy is requested, then send a copy. |
  |  | 153 | if( $found\_logged\_in\_user\_in\_receipients == false && isset($\_POST['send\_email\_copy\_author']) && sanitize\_text\_field($\_POST['send\_email\_copy\_author']) === 'on' ){ |
  |  | 154 | if ( isset($\_POST['list\_recipient\_list']))  { |
  |  | 155 | $list\_of\_recipients\_to\_display[] = array( |
  |  | 156 | 'id' => 'N/A', |
  |  | 157 | 'user\_name' => $logged\_in\_user\_name, |
  |  | 158 | 'email' => $logged\_in\_user\_email, |
  |  | 159 | 'membership\_level' => 'N/A', |
  |  | 160 | 'account\_state' => 'N/A', |
  |  | 161 | ); |
  |  | 162 | } |
  |  | 163 | else { |
  |  | 164 | // add a warning message that this is a sample email at the top of the email body to prevent confusion |
  |  | 165 | $authors\_copy\_warning\_message = \_\_('Note: Below is a sample of the email content sent to the user.', 'simple-membership'); |
  |  | 166 | $body = $authors\_copy\_warning\_message . "\n-----------------------------\n\n" . $body; |
  |  | 167 | wp\_mail($logged\_in\_user\_email, $subject , $body, $headers); |
  |  | 168 | SwpmLog::log\_simple\_debug( '[Send Me a Copy] Sending email to logged in WordPress user: '.$logged\_in\_user\_email, true ); |
  |  | 169 | } |
  |  | 170 | } |
  |  | 171 |  |
  |  | 172 | if( isset($\_POST['list\_recipient\_list']) ) { |
  |  | 173 | $this->output\_recipient\_list\_table($list\_of\_recipients\_to\_display); |
  |  | 174 | } |
  |  | 175 | else { |
  |  | 176 | echo '<div id="response-message" class="updated fade"><p>'; |
  |  | 177 | \_e('Email Sent Successfully!', 'simple-membership'); |
  |  | 178 | echo '</p></div>'; |
  |  | 179 | } |
  | 117 | 180 |  |
  | 118 | 181 | } else { |
  | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=2960602#L129) | […](/browser/simple-membership/trunk/classes/admin-includes/class.swpm-send-direct-email-menu.php?rev=3010737#L192) |  |
  | 129 | 192 |  |
  | 130 | 193 | // render view. |
  | 131 |  | ~~include\_once(SIMPLE\_WP\_MEMBERSHIP\_PATH . "views/admin\_send\_direct\_email\_menu.php"~~); |
  |  | 194 | $this->display\_send\_direct\_email\_admin\_menu(); |
  | 132 | 195 | } |
  |  | 196 |  |
  |  | 197 | private function display\_send\_direct\_email\_admin\_menu(){ |
  |  | 198 | $settings = SwpmSettings::get\_instance(); |
  |  | 199 | $send\_email\_menu\_data = $settings->get\_value('send\_email\_menu\_data'); |
  |  | 200 |  |
  |  | 201 | $send\_email\_selected\_target\_recipients = isset( $send\_email\_menu\_data['send\_email\_selected\_target\_recipients'] ) ? sanitize\_text\_field($send\_email\_menu\_data['send\_email\_selected\_target\_recipients']) : 'membership\_level'; |
  |  | 202 | $send\_email\_recipient\_membership\_level = isset( $send\_email\_menu\_data['send\_email\_membership\_level'] ) ? sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_membership\_level'] ) : ''; |
  |  | 203 | $send\_email\_recipient\_members\_id = isset( $send\_email\_menu\_data['send\_email\_members\_id'] ) ? sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_members\_id'] ) : ''; |
  |  | 204 | $send\_email\_recipient\_account\_state = isset( $send\_email\_menu\_data['send\_email\_account\_state'] ) ? sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_account\_state'] ) : ''; |
  |  | 205 | $send\_email\_copy\_author = isset( $send\_email\_menu\_data['send\_email\_copy\_author'] ) && sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_copy\_author'] ) === 'on' ? 'checked="checked"' : ''; |
  |  | 206 | $send\_email\_enable\_html = isset( $send\_email\_menu\_data['send\_email\_enable\_html'] ) && sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_enable\_html'] ) === 'on' ? 'checked="checked"' : ''; |
  |  | 207 | $send\_email\_subject = isset( $send\_email\_menu\_data['send\_email\_subject'] ) ? sanitize\_text\_field( $send\_email\_menu\_data['send\_email\_subject'] ) : ''; |
  |  | 208 | $send\_email\_body = isset( $send\_email\_menu\_data['send\_email\_body'] ) ? wp\_kses\_post( $send\_email\_menu\_data['send\_email\_body'] ) : ''; |
  |  | 209 | ?> |
  |  | 210 |  |
  |  | 211 | <div id="poststuff"> |
  |  | 212 | <div id="post-body"> |
  |  | 213 | <div class="postbox"> |
  |  | 214 | <h3 class="hndle"><label |
  |  | 215 | for="title"><?php \_e( 'Send Direct Email to Members', 'simple-membership' ); ?></label></h3> |
  |  | 216 | <div class="inside"> |
  |  | 217 | <div class="swpm-grey-box"> |
  |  | 218 | <p> |
  |  | 219 | <?php \_e( 'This feature allows you to send emails to a group of members based on their membership level and account status or by individual member IDs.', 'simple-membership' ); ?> |
  |  | 220 | <?php \_e( 'Refer to <a href="https://simple-membership-plugin.com/send-a-quick-notification-email-to-your-members/" target="\_blank">this documentation page</a> for more details.', 'simple-membership' ); ?> |
  |  | 221 | </p> |
  |  | 222 | </div> |
  |  | 223 | <form method="post" action="" class="form-table"> |
  |  | 224 | <table width="100%" border="0" cellspacing="0" cellpadding="6"> |
  |  | 225 | <tbody> |
  |  | 226 | <tr valign="top"> |
  |  | 227 | <th width="25%" align="left"><?php \_e( 'Target Recipients', 'simple-membership' ); ?></th> |
  |  | 228 | <td align="left"> |
  |  | 229 | <div> |
  |  | 230 | <label> |
  |  | 231 | <input type="radio" id="target-recipients-option-1" name="send\_email\_menu\_target\_recipients" value="membership\_level" <?php echo $send\_email\_selected\_target\_recipients === "membership\_level" ? 'checked' : '';?>> |
  |  | 232 | <?php \_e( 'Send to Membership Level & Account Status', 'simple-membership' );?> |
  |  | 233 | </label> |
  |  | 234 | <label style="margin-left: 12px"> |
  |  | 235 | <input type="radio" id="target-recipients-option-2" name="send\_email\_menu\_target\_recipients" value="members\_id" <?php echo $send\_email\_selected\_target\_recipients === "members\_id" ? 'checked' : '';?>> |
  |  | 236 | <?php \_e( 'Send to Member IDs', 'simple-membership' ); ?> |
  |  | 237 | </label> |
  |  | 238 | </div> |
  |  | 239 | <div style="margin-top: 14px"> |
  |  | 240 | <div id="send-email-field-membership-level" style="<?php echo $send\_email\_selected\_target\_recipients == 'members\_id' ? 'display: none' : ''; ?>"> |
  |  | 241 | <select name="send\_email\_membership\_level"> |
  |  | 242 | <option value=""> <?php \_e( 'Select a Level', 'simple-membership' ); ?></option> |
  |  | 243 | <?php echo SwpmUtils::membership\_level\_dropdown( esc\_attr($send\_email\_recipient\_membership\_level)); ?> |
  |  | 244 | <option value="-1" <?php echo ($send\_email\_recipient\_membership\_level == -1 ? 'selected="selected"' : ''); ?>><?php \_e( 'All Levels', 'simple-membership' ); ?></option> |
  |  | 245 | </select> |
  |  | 246 | <p class="description"><?php \_e( 'Choose the membership level for email recipients.', 'simple-membership' ); ?></p> |
  |  | 247 | <br> |
  |  | 248 | </div> |
  |  | 249 | <div id="send-email-field-account-state" style="<?php echo $send\_email\_selected\_target\_recipients == 'members\_id' ? 'display: none' : ''; ?>"> |
  |  | 250 | <select name="send\_email\_account\_state"> |
  |  | 251 | <option value=""> <?php \_e( 'Select Account Status', 'simple-membership' ); ?></option> |
  |  | 252 | <?php echo SwpmUtils::account\_state\_dropdown( esc\_attr($send\_email\_recipient\_account\_state), true );  ?> |
  |  | 253 | <option value="all" <?php echo ($send\_email\_recipient\_account\_state == 'all' ? 'selected="selected"' : ''); ?>><?php \_e( 'All Status', 'simple-membership' ); ?></option> |
  |  | 254 | </select> |
  |  | 255 | <p class="description"><?php \_e( 'Choose the account status for email recipients.', 'simple-membership' ); ?></p> |
  |  | 256 | <br> |
  |  | 257 | </div> |
  |  | 258 | <div id="send-email-field-members-id" style="<?php echo $send\_email\_selected\_target\_recipients !== 'members\_id' ? 'display: none' : ''; ?>"> |
  |  | 259 | <input type="text" name="send\_email\_members\_id" size="50" value="<?php echo esc\_attr($send\_email\_recipient\_members\_id);?>" /> |
  |  | 260 | <p class="description"><?php \_e( "Enter member IDs separated by comma to specify the recipients.", "simple-membership" ); ?></p> |
  |  | 261 | <br> |
  |  | 262 | </div> |
  |  | 263 | <div id="send-email-copy-author-checkbox"> |
  |  | 264 | <label> |
  |  | 265 | <input type="checkbox" name="send\_email\_copy\_author" <?php echo esc\_attr( $send\_email\_copy\_author); ?> /> |
  |  | 266 | <?php \_e( 'Also Send Me a Copy', 'simple-membership' ); ?> |
  |  | 267 | </label> |
  |  | 268 | <p class="description"> |
  |  | 269 | <?php |
  |  | 270 | \_e('Check this if you want to send a copy of the email to your own email address', 'simple-membership'); |
  |  | 271 | echo ' ('; |
  |  | 272 | \_e('Your current WP user account email address is: ', 'simple-membership'); |
  |  | 273 | echo (isset($logged\_in\_user\_email) ? $logged\_in\_user\_email : ''); |
  |  | 274 | echo ').'; |
  |  | 275 | ?> |
  |  | 276 | </p> |
  |  | 277 | </div> |
  |  | 278 | </div> |
  |  | 279 | </td> |
  |  | 280 | </tr> |
  |  | 281 |  |
  |  | 282 | <tr valign="top"> |
  |  | 283 | <th width="25%" align="left"> |
  |  | 284 | <?php \_e( 'Email Subject', 'simple-membership' ); ?> |
  |  | 285 | </th> |
  |  | 286 | <td align="left"> |
  |  | 287 | <input type="text" name="send\_email\_subject" size="50" value="<?php echo esc\_attr( $send\_email\_subject ); ?>" /> |
  |  | 288 | <p class="description"><?php \_e( 'Enter the subject for the email.', 'simple-membership' ); ?></p> |
  |  | 289 | </td> |
  |  | 290 | </tr> |
  |  | 291 |  |
  |  | 292 | <tr valign="top" id="send-email-html"> |
  |  | 293 | <th width="25%" align="left"> |
  |  | 294 | <?php \_e( 'Allow HTML', 'simple-membership' ); ?> |
  |  | 295 | </th> |
  |  | 296 | <td align="left"> |
  |  | 297 | <input type="checkbox" name="send\_email\_enable\_html" <?php echo esc\_attr( $send\_email\_enable\_html ); ?> /> |
  |  | 298 | <p class="description"> <?php \_e( 'Enables HTML support in the email. For optimal email delivery rate, we suggest using plain text (non-HTML) email.', 'simple-membership' ); ?> </p> |
  |  | 299 | </td> |
  |  | 300 | </tr> |
  |  | 301 |  |
  |  | 302 | <tr valign="top"> |
  |  | 303 | <th width="25%" align="left"> |
  |  | 304 | <?php \_e( 'Email Body', 'simple-membership' ); ?> |
  |  | 305 | </th> |
  |  | 306 | <td align="left"> |
  |  | 307 | <?php |
  |  | 308 | $send\_email\_body\_settings = array( |
  |  | 309 | 'textarea\_name'  => 'send\_email\_body', |
  |  | 310 | 'teeny'          => true, |
  |  | 311 | 'default\_editor' => ! empty( $send\_email\_enable\_html ) ? 'QuickTags' : '', |
  |  | 312 | 'textarea\_rows'  => 15, |
  |  | 313 | ); |
  |  | 314 | //Trigger a filter to allow plugins/addons to modify the editor settings. |
  |  | 315 | $send\_email\_body\_settings = apply\_filters( 'swpm\_send\_direct\_email\_body\_settings', $send\_email\_body\_settings ); |
  |  | 316 | //Render the editor |
  |  | 317 | wp\_editor( wp\_kses\_post( $send\_email\_body ), 'send\_email\_body', $send\_email\_body\_settings ); |
  |  | 318 | ?> |
  |  | 319 | <p class="description"> |
  |  | 320 | <?php \_e( 'Enter the email content that will be sent to members. You can utilize the following email merge tags in this message (click to copy tags to clipboard).', 'simple-membership' ); ?> |
  |  | 321 | </p> |
  |  | 322 | <ul class="description"> |
  |  | 323 | <?php foreach ( SwpmUtils::email\_merge\_tags() as $tag => $desc ) { ?> |
  |  | 324 | <li> |
  |  | 325 | <span style="background-color: #eee; padding: 2px 4px; color: #6c6c6c; cursor: pointer;" onclick="copyMergeTag(event)" >{<?php echo $tag; ?>}</span> - <span> <?php echo $desc; ?> </span> |
  |  | 326 | </li> |
  |  | 327 | <?php } ?> |
  |  | 328 | </ul> |
  |  | 329 | <p class="description"><?php \_e( 'Please note that the following merge tag does not work in this email.', 'simple-membership' ); ?></p> |
  |  | 330 | <ul clear="description"> |
  |  | 331 | <li> |
  |  | 332 | <span style="background-color: #eee; padding: 2px 4px; color: #6c6c6c; cursor: pointer;">{password}</span> - |
  |  | 333 | <span><?php \_e( 'This tag will not work in this email since the password is stored in the database using a one-way hash, which means that the plugin cannot retrieve the plain text password once the account has been created.', 'simple-membership' ); ?></span> |
  |  | 334 | </li> |
  |  | 335 | </ul> |
  |  | 336 | </td> |
  |  | 337 | </td> |
  |  | 338 | </tr> |
  |  | 339 |  |
  |  | 340 | <tr valign="top"> |
  |  | 341 | <th width="25%" align="left"> |
  |  | 342 | </th> |
  |  | 343 | <td align="left"> |
  |  | 344 | <input type="submit" class="button-primary" name="send\_email\_submit" value="<?php \_e( 'Send Direct Email', 'simple-membership' ); ?>" /> |
  |  | 345 | <p class="description"><?php \_e('This option will send the email if there are no validation errors.', 'simple-membership');?></p> |
  |  | 346 | </td> |
  |  | 347 | </tr> |
  |  | 348 |  |
  |  | 349 | <tr valign="top"> |
  |  | 350 | <th width="25%" align="left"> |
  |  | 351 | </th> |
  |  | 352 | <td align="left"> |
  |  | 353 | <input type="submit" class="button-secondary" name="list\_recipient\_list" value="<?php \_e( 'View Recipient List', 'simple-membership' ); ?>"/> |
  |  | 354 | <p class="description"><?php \_e('You can use this option to display a list of selected members as recipients for cross-checking email addresses before sending.', 'simple-membership');?></p> |
  |  | 355 | </td> |
  |  | 356 | </tr> |
  |  | 357 |  |
  |  | 358 | <input type="hidden" name="swpm\_send\_email\_nonce" value="<?php echo wp\_create\_nonce( 'swpm\_send\_email\_nonce\_action' ); ?>" /> |
  |  | 359 | </tbody> |
  |  | 360 | </table> |
  |  | 361 | </form> |
  |  | 362 | </div> |
  |  | 363 | </div> |
  |  | 364 | </div> |
  |  | 365 | </div> |
  |  | 366 | <script> |
  |  | 367 | const recipientGroupRadio = document.querySelectorAll('input[name="send\_email\_menu\_target\_recipients"]'); |
  |  | 368 | const membershipLevelField = document.getElementById('send-email-field-membership-level'); |
  |  | 369 | const membershipAccountField = document.getElementById('send-email-field-account-state'); |
  |  | 370 | const membersIdField = document.getElementById('send-email-field-members-id'); |
  |  | 371 |  |
  |  | 372 | // Add event listener to each radio button |
  |  | 373 | recipientGroupRadio.forEach((item) => { |
  |  | 374 | item.addEventListener('change', toggleRecipientFieldType); |
  |  | 375 | }); |
  |  | 376 |  |
  |  | 377 | function toggleRecipientFieldType(event) { |
  |  | 378 | if (event.target.value === 'members\_id') { |
  |  | 379 | membershipLevelField.style.display = 'none'; |
  |  | 380 | membershipAccountField.style.display = 'none'; |
  |  | 381 | membersIdField.style.display = null; |
  |  | 382 | } else { |
  |  | 383 | membershipLevelField.style.display = null; |
  |  | 384 | membershipAccountField.style.display = null; |
  |  | 385 | membersIdField.style.display = 'none'; |
  |  | 386 | } |
  |  | 387 | } |
  |  | 388 |  |
  |  | 389 | function copyMergeTag(event) { |
  |  | 390 | const element = event.target; |
  |  | 391 | const text = element.innerText; |
  |  | 392 | const range = document.createRange(); |
  |  | 393 | range.selectNodeContents(element); |
  |  | 394 | const selection = window.getSelection(); |
  |  | 395 | navigator.clipboard.writeText(text); |
  |  | 396 | selection.removeAllRanges(); |
  |  | 397 | selection.addRange(range); |
  |  | 398 | } |
  |  | 399 | </script> |
  |  | 400 | <?php |
  |  | 401 | } |
  |  | 402 |  |
  |  | 403 | private function output\_recipient\_list\_table($recipient\_list){ |
  |  | 404 | $recipients\_count = count($recipient\_list); |
  |  | 405 | echo '<div class="postbox" style="margin:10px 0px 0px">'; |
  |  | 406 | echo '<div class="inside">'; |
  |  | 407 | echo '<h3 style="font-size: 14px;">'. \_\_('Email Recipient List', 'simple-membership'). '</h3>' ; |
  |  | 408 | // echo '<div style="max-height: 300px; overflow: scroll;">'; // table wrap |
  |  | 409 | echo '<table class="widefat">'; |
  |  | 410 | echo '<thead> |
  |  | 411 | <tr> |
  |  | 412 | <th style="padding-bottom: 4px;">'.\_\_('Recipient\'s Email', 'simple-membership').'</th> |
  |  | 413 | <th style="padding-bottom: 4px;">'.\_\_('Username', 'simple-membership').'</th> |
  |  | 414 | <th style="padding-bottom: 4px;">'.\_\_('Member ID', 'simple-membership').'</th> |
  |  | 415 | <th style="padding-bottom: 4px;">'.\_\_('Membership Level', 'simple-membership').'</th> |
  |  | 416 | <th style="padding-bottom: 4px;">'.\_\_('Account State', 'simple-membership').'</th> |
  |  | 417 | </tr> |
  |  | 418 | </thead>'; |
  |  | 419 | echo '<tbody>'; |
  |  | 420 | foreach ($recipient\_list as $recipient) { |
  |  | 421 | echo '<tr> |
  |  | 422 | <td>'.esc\_attr($recipient['email']).'</td> |
  |  | 423 | <td>'.esc\_attr($recipient['user\_name']).'</td> |
  |  | 424 | <td>'.esc\_attr($recipient['id']).'</td> |
  |  | 425 | <td>'.esc\_attr($recipient['membership\_level']).'</td> |
  |  | 426 | <td>'.esc\_attr($recipient['account\_state']).'</td> |
  |  | 427 | </tr>'; |
  |  | 428 | } |
  |  | 429 | echo '</tbody>'; |
  |  | 430 | echo '</table>'; |
  |  | 431 | // echo '</div>'; // end of table wrap |
  |  | 432 | echo '<p>' . \_\_('Total email recipients :','simple-membership') . $recipients\_count . '</p>'; |
  |  | 433 | echo '<p>'.\_\_('Note: No emails have been sent; this is only a display of the recipient list.', 'simple-membership').'</p>'; |
  |  | 434 | echo '</div>'; |
  |  | 435 | echo '</div>'; |
  |  | 436 | } |
  | 133 | 437 |  |
  | 134 | 438 | } |
* ## [simple-membership/trunk/classes/class.simple-wp-membership.php](/changeset/3010737/simple-membership/trunk/classes/class.simple-wp-membership.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/class.simple-wp-membership.php")

  | [r2991476](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=2991476#L335 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=3010737#L335 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 335 | 335 | if (!SwpmUtils::is\_ajax()) { |
  | 336 | 336 | //Redirection after login to make sure the page loads with all the correct variables set everywhere. |
  | 337 |  | $redirect\_url = SwpmMiscUtils::get\_current\_page\_url(); |
  |  | 337 |  |
  |  | 338 | if(isset($\_REQUEST['wp-submit'])){ |
  |  | 339 | //This is a WP login form submission. |
  |  | 340 | //Just return from here. WP will handle the post-login redirection. |
  |  | 341 | SwpmLog::log\_auth\_debug("The wp-submit query parameter is set. This is a WP login form submission. WP will handle any post login redirection.", true); |
  |  | 342 | return; |
  |  | 343 | } |
  |  | 344 |  |
  |  | 345 | //Check if "redirect\_to" parameter is set. If so, use that URL. |
  |  | 346 | if(isset($\_REQUEST['redirect\_to'])){ |
  |  | 347 | $redirect\_url = sanitize\_url($\_REQUEST['redirect\_to']); |
  |  | 348 | SwpmLog::log\_auth\_debug("The redirect\_to query parameter is set. Value: ". $redirect\_url, true); |
  |  | 349 | } else { |
  |  | 350 | $redirect\_url = SwpmMiscUtils::get\_current\_page\_url(); |
  |  | 351 | } |
  |  | 352 |  |
  |  | 353 | //Check if the URL is still empty. If so, use the site home URL. |
  | 338 | 354 | if(empty($redirect\_url)){ |
  | 339 | 355 | $redirect\_url = SIMPLE\_WP\_MEMBERSHIP\_SITE\_HOME\_URL; |
  | 340 | 356 | } |
  |  | 357 |  |
  | 341 | 358 | $redirect\_url = apply\_filters('swpm\_after\_login\_redirect\_url', $redirect\_url); |
  | 342 | 359 | SwpmLog::log\_auth\_debug("After triggering the default swpm\_after\_login\_redirect\_url hook. Redirect URL: ". $redirect\_url, true); |
  | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=2991476#L564) | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=3010737#L581) |  |
  | 564 | 581 | } |
  | 565 | 582 |  |
  | 566 |  | /\* If any message/notice was set during the execution then this function will output that message \*/ |
  |  | 583 | /\*\* |
  |  | 584 | \* If any message/notice was set during the execution then this function will output that message. |
  |  | 585 | \* |
  |  | 586 | \* @return boolean |
  |  | 587 | \*/ |
  | 567 | 588 | public function notices() { |
  | 568 | 589 | $message = SwpmTransfer::get\_instance()->get('status'); |
  | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=2991476#L571) | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=3010737#L592) |  |
  | 571 | 592 | return false; |
  | 572 | 593 | } |
  |  | 594 |  |
  |  | 595 | $output = ''; |
  | 573 | 596 | if ($message['succeeded']) { |
  | 574 |  | ~~echo "<div id='swpm\_message' class='swpm\_success'>"~~; |
  |  | 597 | $output .= '<div class="notice notice-success is-dismissible">'; |
  | 575 | 598 | $succeeded = true; |
  | 576 | 599 | } else { |
  | 577 |  | echo "<div id='swpm\_message' class='swpm\_error'>"; |
  | 578 |  | } |
  | 579 |  | echo $message['message']; |
  |  | 600 | $output .= '<div class="notice notice-error is-dismissible">'; |
  |  | 601 | } |
  |  | 602 | $output .= '<p><b>'; |
  |  | 603 | $output .= $message['message']; |
  |  | 604 | $output .= '</b></p>'; |
  | 580 | 605 | $extra = isset($message['extra']) ? $message['extra'] : array(); |
  | 581 | 606 | if (is\_string($extra)) { |
  | 582 |  | ~~echo~~ $extra; |
  |  | 607 | $output .= $extra; |
  | 583 | 608 | } else if (is\_array($extra) && !empty($extra)) { |
  | 584 |  | ~~echo '<ul~~>'; |
  |  | 609 | $output .= '<ol style="margin-top: 0.5rem">'; |
  | 585 | 610 | foreach ($extra as $key => $value) { |
  | 586 |  | ~~echo~~ '<li>' . $value . '</li>'; |
  | 587 |  | } |
  | 588 |  | ~~echo '</u~~l>'; |
  | 589 |  | } |
  | 590 |  | ~~echo "</div>"~~; |
  |  | 611 | $output .= '<li>' . $value . '</li>'; |
  |  | 612 | } |
  |  | 613 | $output .= '</ol>'; |
  |  | 614 | } |
  |  | 615 | $output .= '</div>'; |
  | 591 | 616 | if (isset($message['pass\_reset\_sent'])) { |
  | 592 | 617 | $succeeded = true; |
  | 593 | 618 | } |
  |  | 619 |  |
  |  | 620 | echo $output; |
  | 594 | 621 | return $succeeded; |
  | 595 | 622 | } |
  | 596 | 623 |  |
  | 597 |  | /\* |
  |  | 624 | /\*\* |
  | 598 | 625 | \* This function is hooked to WordPress's admin\_notices action hook |
  | 599 | 626 | \* It is used to show any plugin specific notices/warnings in the admin interface |
  | 600 | 627 | \*/ |
  | 601 |  |  |
  | 602 | 628 | public function do\_admin\_notices() { |
  | 603 |  | $this->notices(); //Show any execution specific notices in the admin interface. |
  |  | 629 | //Show any execution specific notices in the admin interface. |
  |  | 630 | $this->notices(); |
  | 604 | 631 | //Show any other general warnings/notices to the admin. |
  | 605 | 632 | if (SwpmMiscUtils::is\_swpm\_admin\_page()) { |
  | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=2991476#L611) | […](/browser/simple-membership/trunk/classes/class.simple-wp-membership.php?rev=3010737#L638) |  |
  | 611 | 638 | $sandbox\_enabled = $settings->get\_value('enable-sandbox-testing'); |
  | 612 | 639 | if ($sandbox\_enabled) { |
  | 613 |  | $msg .= '<p>' . ~~SwpmUtils::\_('You have the sandbox payment mode enabled in plugin settings. Make sure to turn off the sandbox mode when you want to do live transactions.~~') . '</p>'; |
  |  | 640 | $msg .= '<p>' . \_\_('You have the sandbox payment mode enabled in plugin settings. Make sure to turn off the sandbox mode when you want to do live transactions.', 'simple-membership') . '</p>'; |
  | 614 | 641 | } |
  | 615 | 642 |  |
  | 616 | 643 | if (!empty($msg)) {//Show warning messages if any. |
  | 617 |  | echo '<div id="message" class="~~error~~">'; |
  |  | 644 | echo '<div id="message" class="notice notice-warning">'; |
  | 618 | 645 | echo $msg; |
  | 619 | 646 | echo '</div>'; |
* ## [simple-membership/trunk/classes/class.swpm-members.php](/changeset/3010737/simple-membership/trunk/classes/class.swpm-members.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/class.swpm-members.php")

  | [r2991476](/browser/simple-membership/trunk/classes/class.swpm-members.php?rev=2991476#L66 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/class.swpm-members.php?rev=3010737#L66 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 66 | 66 |  |
  | 67 | 67 | function column\_account\_state( $item ) { |
  | 68 |  | $acc\_state\_str = ucfirst( $item['account\_state'] ); |
  | 69 |  | return SwpmUtils::\_( $acc\_state\_str ); |
  |  | 68 | $account\_state\_column\_val = isset( $item['account\_state'] ) ? $item['account\_state'] : ''; |
  |  | 69 | if ($account\_state\_column\_val == 'activation\_required'){ |
  |  | 70 | //For better translation support. |
  |  | 71 | $acc\_state\_str = \_\_( 'Activation Required', 'simple-membership' ); |
  |  | 72 | } else { |
  |  | 73 | $acc\_state\_str = \_\_( ucfirst( $account\_state\_column\_val ), 'simple-membership' ); |
  |  | 74 | } |
  |  | 75 | return $acc\_state\_str; |
  | 70 | 76 | } |
  | 71 | 77 |  |
* ## [simple-membership/trunk/classes/class.swpm-settings.php](/changeset/3010737/simple-membership/trunk/classes/class.swpm-settings.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/class.swpm-settings.php")

  | [r2991476](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=2991476#L328 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=3010737#L328 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 328 | 328 | private function tab\_2() { |
  | 329 | 329 | //Register settings sections and fileds for the payment settings tab. |
  | 330 |  | register\_setting( 'swpm-settings-tab-2', 'swpm-settings', array( $this, 'sanitize\_tab\_2' ) ); |
  |  | 330 | //register\_setting( 'swpm-settings-tab-2', 'swpm-settings', array( $this, 'sanitize\_tab\_2' ) ); |
  | 331 | 331 |  |
  | 332 | 332 | //This settings section has no heading. Useful for hooking at this section and doing arbitrary request parameter checks and show response accordingly (on this settings tab) |
  | 333 |  | add\_settings\_section( 'swpm-settings-tab-2-before-other-fields', '', array( &$this, 'swpm\_settings\_tab\_2\_before\_fields\_callback' ), 'simple\_wp\_membership\_settings' ); |
  |  | 333 | //add\_settings\_section( 'swpm-settings-tab-2-before-other-fields', '', array( &$this, 'swpm\_settings\_tab\_2\_before\_fields\_callback' ), 'simple\_wp\_membership\_settings' ); |
  | 334 | 334 |  |
  | 335 | 335 | //Sandbox or Testmode payment settings section. |
  | 336 |  | add\_settings\_section( 'testmode-payment-settings', SwpmUtils::\_( 'Sandbox or Test Mode Payment Settings' ), array( &$this, 'testmode\_payment\_settings\_callback' ), 'simple\_wp\_membership\_settings' ); |
  | 337 |  |  |
  | 338 |  | add\_settings\_field( |
  | 339 |  | 'enable-sandbox-testing', |
  | 340 |  | SwpmUtils::\_( 'Enable Sandbox or Test Mode' ), |
  | 341 |  | array( &$this, 'checkbox\_callback' ), |
  | 342 |  | 'simple\_wp\_membership\_settings', |
  | 343 |  | 'testmode-payment-settings', |
  | 344 |  | array( |
  | 345 |  | 'item'    => 'enable-sandbox-testing', |
  | 346 |  | 'message' => SwpmUtils::\_( 'Enable this option if you want to do sandbox payment testing.' ), |
  | 347 |  | ) |
  | 348 |  | ); |
  |  | 336 | //add\_settings\_section( 'testmode-payment-settings', SwpmUtils::\_( 'Sandbox or Test Mode Payment Settings' ), array( &$this, 'testmode\_payment\_settings\_callback' ), 'simple\_wp\_membership\_settings' ); |
  |  | 337 |  |
  |  | 338 | // add\_settings\_field( |
  |  | 339 | //  'enable-sandbox-testing', |
  |  | 340 | //  SwpmUtils::\_( 'Enable Sandbox or Test Mode' ), |
  |  | 341 | //  array( &$this, 'checkbox\_callback' ), |
  |  | 342 | //  'simple\_wp\_membership\_settings', |
  |  | 343 | //  'testmode-payment-settings', |
  |  | 344 | //  array( |
  |  | 345 | //      'item'    => 'enable-sandbox-testing', |
  |  | 346 | //      'message' => SwpmUtils::\_( 'Enable this option if you want to do sandbox payment testing.' ), |
  |  | 347 | //  ) |
  |  | 348 | // ); |
  | 349 | 349 |  |
  | 350 | 350 | //PayPal (PPCP) account connection settings (no heading). We will use our custom HTML code to render the section. |
  | 351 | 351 | //add\_settings\_section( 'paypal-ppcp-connection-settings', '', array( &$this, 'paypal\_ppcp\_connection\_settings\_callback' ), 'simple\_wp\_membership\_settings' ); |
  | 352 | 352 |  |
  | 353 |  |  |
  | 354 |  | ~~//PayPal checkout (new) settings section.~~ |
  | 355 |  | ~~add\_settings\_section( 'paypal-checkout-settings', SwpmUtils::\_( 'PayPal Settings' ), array( &$this, 'paypal\_checkout\_settings\_callback' ), 'simple\_wp\_membership\_settings' );~~ |
  | 356 |  |  |
  | 357 |  | ~~add\_settings\_field(~~ |
  | 358 |  | ~~'paypal-live-client-id',~~ |
  | 359 |  | ~~SwpmUtils::\_( 'Live Client ID' ),~~ |
  | 360 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 361 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 362 |  | ~~'paypal-checkout-settings',~~ |
  | 363 |  | ~~array(~~ |
  | 364 |  | ~~'item'    => 'paypal-live-client-id',~~ |
  | 365 |  | ~~'message' => SwpmUtils::\_( 'Enter your PayPal Client ID for live mode.' ),~~ |
  | 366 |  | ~~)~~ |
  | 367 |  | ~~);~~ |
  | 368 |  | ~~add\_settings\_field(~~ |
  | 369 |  | ~~'paypal-live-secret-key',~~ |
  | 370 |  | ~~SwpmUtils::\_( 'Live Secret Key' ),~~ |
  | 371 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 372 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 373 |  | ~~'paypal-checkout-settings',~~ |
  | 374 |  | ~~array(~~ |
  | 375 |  | ~~'item'    => 'paypal-live-secret-key',~~ |
  | 376 |  | ~~'message' => SwpmUtils::\_( 'Enter your PayPal Secret Key for live mode.' ),~~ |
  | 377 |  | ~~)~~ |
  | 378 |  | ~~);~~ |
  | 379 |  | ~~add\_settings\_field(~~ |
  | 380 |  | ~~'paypal-sandbox-client-id',~~ |
  | 381 |  | ~~SwpmUtils::\_( 'Sandbox Client ID' ),~~ |
  | 382 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 383 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 384 |  | ~~'paypal-checkout-settings',~~ |
  | 385 |  | ~~array(~~ |
  | 386 |  | ~~'item'    => 'paypal-sandbox-client-id',~~ |
  | 387 |  | ~~'message' => SwpmUtils::\_( 'Enter your PayPal Client ID for sandbox mode.' ),~~ |
  | 388 |  | ~~)~~ |
  | 389 |  | ~~);~~ |
  | 390 |  | ~~add\_settings\_field(~~ |
  | 391 |  | ~~'paypal-sandbox-secret-key',~~ |
  | 392 |  | ~~SwpmUtils::\_( 'Sandbox Secret Key' ),~~ |
  | 393 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 394 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 395 |  | ~~'paypal-checkout-settings',~~ |
  | 396 |  | ~~array(~~ |
  | 397 |  | ~~'item'    => 'paypal-sandbox-secret-key',~~ |
  | 398 |  | ~~'message' => SwpmUtils::\_( 'Enter your PayPal Secret Key for sandbox mode.' ),~~ |
  | 399 |  | ~~)~~ |
  | 400 |  | ~~);~~ |
  | 401 |  |  |
  | 402 |  | ~~//PayPal checkout (new) Webhook settings section (no heading). This section will be used to add our custom HTML code to handle the webhook creation and status update.~~ |
  | 403 |  | ~~add\_settings\_section( 'paypal-webhooks-settings', '', array( &$this, 'paypal\_webhooks\_settings\_callback' ), 'simple\_wp\_membership\_settings' );~~ |
  | 404 |  |  |
  | 405 |  |  |
  | 406 |  | ~~//Stripe global settings section.~~ |
  | 407 |  | ~~add\_settings\_section( 'stripe-global-settings', SwpmUtils::\_( 'Stripe Global Settings' ), array( &$this, 'stripe\_global\_settings\_callback' ), 'simple\_wp\_membership\_settings' );~~ |
  | 408 |  |  |
  | 409 |  | ~~add\_settings\_field(~~ |
  | 410 |  | ~~'stripe-prefill-member-email',~~ |
  | 411 |  | ~~SwpmUtils::\_( 'Pre-fill Member Email Address' ),~~ |
  | 412 |  | ~~array( $this, 'checkbox\_callback' ),~~ |
  | 413 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 414 |  | ~~'stripe-global-settings',~~ |
  | 415 |  | ~~array(~~ |
  | 416 |  | ~~'item'    => 'stripe-prefill-member-email',~~ |
  | 417 |  | ~~'message' => SwpmUtils::\_( 'Pre-fills the email address of the logged-in member on the Stripe checkout form when possible' ),~~ |
  | 418 |  | ~~)~~ |
  | 419 |  | ~~);~~ |
  | 420 |  | ~~add\_settings\_field(~~ |
  | 421 |  | ~~'stripe-test-public-key',~~ |
  | 422 |  | ~~SwpmUtils::\_( 'Test Publishable Key' ),~~ |
  | 423 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 424 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 425 |  | ~~'stripe-global-settings',~~ |
  | 426 |  | ~~array(~~ |
  | 427 |  | ~~'item'    => 'stripe-test-public-key',~~ |
  | 428 |  | ~~'message' => SwpmUtils::\_( 'Stripe API Test publishable key' ),~~ |
  | 429 |  | ~~)~~ |
  | 430 |  | ~~);~~ |
  | 431 |  | ~~add\_settings\_field(~~ |
  | 432 |  | ~~'stripe-test-secret-key',~~ |
  | 433 |  | ~~SwpmUtils::\_( 'Test Secret Key' ),~~ |
  | 434 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 435 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 436 |  | ~~'stripe-global-settings',~~ |
  | 437 |  | ~~array(~~ |
  | 438 |  | ~~'item'    => 'stripe-test-secret-key',~~ |
  | 439 |  | ~~'message' => SwpmUtils::\_( 'Stripe API Test secret key' ),~~ |
  | 440 |  | ~~)~~ |
  | 441 |  | ~~);~~ |
  | 442 |  | ~~add\_settings\_field(~~ |
  | 443 |  | ~~'stripe-live-public-key',~~ |
  | 444 |  | ~~SwpmUtils::\_( 'Live Publishable Key' ),~~ |
  | 445 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 446 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 447 |  | ~~'stripe-global-settings',~~ |
  | 448 |  | ~~array(~~ |
  | 449 |  | ~~'item'    => 'stripe-live-public-key',~~ |
  | 450 |  | ~~'message' => SwpmUtils::\_( 'Stripe API Live publishable key' ),~~ |
  | 451 |  | ~~)~~ |
  | 452 |  | ~~);~~ |
  | 453 |  | ~~add\_settings\_field(~~ |
  | 454 |  | ~~'stripe-live-secret-key',~~ |
  | 455 |  | ~~SwpmUtils::\_( 'Live Secret Key' ),~~ |
  | 456 |  | ~~array( $this, 'textfield\_long\_callback' ),~~ |
  | 457 |  | ~~'simple\_wp\_membership\_settings',~~ |
  | 458 |  | ~~'stripe-global-settings',~~ |
  | 459 |  | ~~array(~~ |
  | 460 |  | ~~'item'    => 'stripe-live-secret-key',~~ |
  | 461 |  | ~~'message' => SwpmUtils::\_( 'Stripe API Live secret key' ),~~ |
  | 462 |  | ~~)~~ |
  | 463 |  | ~~);~~ |
  | 464 | 353 | } |
  | 465 | 354 |  |
  | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=2991476#L1255) | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=3010737#L1144) |  |
  | 1255 | 1144 | public function testndebug\_settings\_callback() { |
  | 1256 | 1145 | \_e( 'Testing and Debug Related Settings.', 'simple-membership' ); |
  | 1257 |  | ~~}~~ |
  | 1258 |  |  |
  | 1259 |  | ~~public function swpm\_settings\_tab\_2\_before\_fields\_callback() {~~ |
  | 1260 |  | ~~//Show settings updated message for tab 2~~ |
  | 1261 |  | ~~if ( isset( $\_REQUEST['settings-updated'] ) ) {~~ |
  | 1262 |  | ~~echo '<div id="message" class="updated fade"><p>' . SwpmUtils::\_( 'Settings updated!' ) . '</p></div>';~~ |
  | 1263 |  | ~~}~~ |
  | 1264 |  | ~~}~~ |
  | 1265 |  |  |
  | 1266 |  | ~~public function testmode\_payment\_settings\_callback() {~~ |
  | 1267 |  | ~~\_e( 'This section allows you to enable/disable sandbox or test mode for the payment buttons.', 'simple-membership' );~~ |
  | 1268 |  | ~~}~~ |
  | 1269 |  |  |
  | 1270 |  | ~~public function paypal\_checkout\_settings\_callback() {~~ |
  | 1271 |  | ~~\_e( 'Configure the PayPal API credentials for the new PayPal checkout.', 'simple-membership' );~~ |
  | 1272 |  | ~~echo '&nbsp;' . '<a href="https://simple-membership-plugin.com/getting-paypal-api-credentials" target="\_blank">' . SwpmUtils::\_( 'Read this documentation' ) . '</a> ' . SwpmUtils::\_( 'to learn how to get your PayPal API credentials.' );~~ |
  | 1273 |  | ~~}~~ |
  | 1274 |  |  |
  | 1275 |  | ~~public function paypal\_ppcp\_connection\_settings\_callback() {~~ |
  | 1276 |  | ~~echo '<h2 id="paypal-ppcp-connection-section">' . SwpmUtils::\_( 'PayPal Account Setup' ) . '</h2>';~~ |
  | 1277 |  |  |
  | 1278 |  | ~~$ppcp\_onboarding\_instance = SWPM\_PayPal\_PPCP\_Onboarding::get\_instance();~~ |
  | 1279 |  |  |
  | 1280 |  | ~~//TODO - if all API credentials are missing, show a message.~~ |
  | 1281 |  | ~~$all\_api\_creds\_missing = false;~~ |
  | 1282 |  | ~~if( empty( $this->get\_value('paypal-sandbox-client-id')) && empty( $this->get\_value('paypal-sandbox-secret-key')) && empty( $this->get\_value('paypal-live-client-id')) && empty( $this->get\_value('paypal-live-secret-key')) ){~~ |
  | 1283 |  | ~~$all\_api\_creds\_missing = true;~~ |
  | 1284 |  | ~~}~~ |
  | 1285 |  | ~~?>~~ |
  | 1286 |  | ~~<table class="form-table" role="presentation">~~ |
  | 1287 |  | ~~<tbody>~~ |
  | 1288 |  | ~~<tr>~~ |
  | 1289 |  | ~~<th scope="row"><?php \_e('Live Account Connnection Status', 'simple-membership'); ?></th>~~ |
  | 1290 |  | ~~<td>~~ |
  | 1291 |  | ~~<?php~~ |
  | 1292 |  | ~~//TODO - Check if the live account is connected~~ |
  | 1293 |  | ~~$live\_account\_connection\_status = 'connected';~~ |
  | 1294 |  | ~~if( empty( $this->get\_value('paypal-live-client-id')) || empty( $this->get\_value('paypal-live-secret-key')) ){~~ |
  | 1295 |  | ~~//Sandbox API keys are missing. Account is not connected.~~ |
  | 1296 |  | ~~$live\_account\_connection\_status = 'not-connected';~~ |
  | 1297 |  | ~~}~~ |
  | 1298 |  |  |
  | 1299 |  | ~~if( $live\_account\_connection\_status == 'connected'){~~ |
  | 1300 |  | ~~//Production account connected~~ |
  | 1301 |  | ~~echo '<div class="swpm-paypal-live-account-connection-status"><span class="dashicons dashicons-yes" style="color:green;"></span>&nbsp;';~~ |
  | 1302 |  | ~~\_e( 'Live account is connected. If you experience any issues, please disconnect and reconnect.', 'simple-membership' );~~ |
  | 1303 |  | ~~echo '</div>';~~ |
  | 1304 |  | ~~//TODO - Show disconnect option for live account.~~ |
  | 1305 |  | ~~//$ppcp\_onboarding\_instance->output\_live\_ac\_disconnect\_link();~~ |
  | 1306 |  | ~~} else {~~ |
  | 1307 |  | ~~//Production account is NOT connected.~~ |
  | 1308 |  | ~~echo '<div class="swpm-paypal-live-account-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1309 |  | ~~\_e( 'Live PayPal account is not connected.', 'simple-membership');~~ |
  | 1310 |  | ~~echo '</div>';~~ |
  | 1311 |  |  |
  | 1312 |  | ~~//TODO - Show the onboarding link~~ |
  | 1313 |  | ~~//ppcp\_onboarding\_instance->output\_live\_onboarding\_link\_code();~~ |
  | 1314 |  | ~~}~~ |
  | 1315 |  | ~~?>~~ |
  | 1316 |  | ~~</td>~~ |
  | 1317 |  | ~~</tr>~~ |
  | 1318 |  | ~~<tr>~~ |
  | 1319 |  | ~~<th scope="row"><?php \_e('Sandbox Account Connnection Status', 'simple-membership'); ?></th>~~ |
  | 1320 |  | ~~<td>~~ |
  | 1321 |  | ~~<?php~~ |
  | 1322 |  | ~~//Check if the sandbox account is connected~~ |
  | 1323 |  | ~~$sandbox\_account\_connection\_status = 'connected';~~ |
  | 1324 |  | ~~if( empty( $this->get\_value('paypal-sandbox-client-id')) || empty( $this->get\_value('paypal-sandbox-secret-key')) ){~~ |
  | 1325 |  | ~~//Sandbox API keys are missing. Account is not connected.~~ |
  | 1326 |  | ~~$sandbox\_account\_connection\_status = 'not-connected';~~ |
  | 1327 |  | ~~}~~ |
  | 1328 |  |  |
  | 1329 |  | ~~if( $sandbox\_account\_connection\_status == 'connected'){~~ |
  | 1330 |  | ~~//Test account connected~~ |
  | 1331 |  | ~~echo '<div class="swpm-paypal-test-account-connection-status"><span class="dashicons dashicons-yes" style="color:green;"></span>&nbsp;';~~ |
  | 1332 |  | ~~\_e( 'Sandbox account is connected. If you experience any issues, please disconnect and reconnect.', 'simple-membership' );~~ |
  | 1333 |  | ~~echo '</div>';~~ |
  | 1334 |  | ~~//Show disconnect option for sandbox account.~~ |
  | 1335 |  | ~~$ppcp\_onboarding\_instance->output\_sandbox\_ac\_disconnect\_link();~~ |
  | 1336 |  | ~~} else {~~ |
  | 1337 |  | ~~//Sandbox account is NOT connected.~~ |
  | 1338 |  | ~~echo '<div class="swpm-paypal-sandbox-account-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1339 |  | ~~\_e( 'Sandbox PayPal account is not connected.', 'simple-membership');~~ |
  | 1340 |  | ~~echo '</div>';~~ |
  | 1341 |  |  |
  | 1342 |  | ~~//Show the onboarding link for sandbox account.~~ |
  | 1343 |  | ~~$ppcp\_onboarding\_instance->output\_sandbox\_onboarding\_link\_code();~~ |
  | 1344 |  | ~~}~~ |
  | 1345 |  | ~~?>~~ |
  | 1346 |  | ~~</td>~~ |
  | 1347 |  | ~~</tr>~~ |
  | 1348 |  |  |
  | 1349 |  | ~~</tbody>~~ |
  | 1350 |  | ~~</table>~~ |
  | 1351 |  | ~~<?php~~ |
  | 1352 |  | ~~}~~ |
  | 1353 |  |  |
  | 1354 |  | ~~public function paypal\_webhooks\_settings\_callback() {~~ |
  | 1355 |  | ~~echo '<h2 id="paypal-subscription-webhooks">' . SwpmUtils::\_( 'PayPal Webhooks' ) . '</h2>';~~ |
  | 1356 |  | ~~echo '<p>' . SwpmUtils::\_( 'The PayPal payment buttons that uses the new API require webhooks. The plugin will auto-create the required webhooks when you create a PayPal payment button.' ) . '</p>';~~ |
  | 1357 |  | ~~echo '<p>' . SwpmUtils::\_( 'If you have issues with the webhooks, you can delete it and create again.' ) . '</p>';~~ |
  | 1358 |  |  |
  | 1359 |  | ~~$all\_api\_creds\_missing = false;~~ |
  | 1360 |  | ~~if( empty( $this->get\_value('paypal-sandbox-client-id')) && empty( $this->get\_value('paypal-sandbox-secret-key')) && empty( $this->get\_value('paypal-live-client-id')) && empty( $this->get\_value('paypal-live-secret-key')) ){~~ |
  | 1361 |  | ~~$all\_api\_creds\_missing = true;~~ |
  | 1362 |  | ~~}~~ |
  | 1363 |  | ~~?>~~ |
  | 1364 |  | ~~<table class="form-table" role="presentation">~~ |
  | 1365 |  | ~~<tbody>~~ |
  | 1366 |  | ~~<tr>~~ |
  | 1367 |  | ~~<th scope="row">Live Webhook Status</th>~~ |
  | 1368 |  | ~~<td>~~ |
  | 1369 |  | ~~<?php~~ |
  | 1370 |  | ~~$production\_webhook\_id = get\_option( 'swpm\_paypal\_webhook\_id\_production' );~~ |
  | 1371 |  | ~~if( !empty($production\_webhook\_id)){~~ |
  | 1372 |  | ~~//Production webhook exists~~ |
  | 1373 |  | ~~echo '<span class="swpm-paypal-live-webhook-status"><span class="dashicons dashicons-yes" style="color:green;"></span>&nbsp;';~~ |
  | 1374 |  | ~~\_e( 'Live Webhook exists. If you still have issues with webhooks, you can delete it and create again.', 'simple-membership' );~~ |
  | 1375 |  | ~~echo '</span>';~~ |
  | 1376 |  | ~~} else {~~ |
  | 1377 |  | ~~//Production webhook does not exist~~ |
  | 1378 |  | ~~if( empty( $this->get\_value('paypal-live-client-id')) || empty( $this->get\_value('paypal-live-secret-key')) ){~~ |
  | 1379 |  | ~~echo '<p><span class="swpm-paypal-live-webhook-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1380 |  | ~~\_e( 'Live PayPal API credentials are not set. Please set the Live PayPal API credentials first.', 'simple-membership');~~ |
  | 1381 |  | ~~echo '</span></p>';~~ |
  | 1382 |  | ~~} else {~~ |
  | 1383 |  | ~~echo '<span class="swpm-paypal-live-webhook-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1384 |  | ~~\_e( 'No webhook found. Use the following Create Live Webhook link to create a new webhook automatically.', 'simple-membership' );~~ |
  | 1385 |  | ~~echo '</span>';~~ |
  | 1386 |  | ~~$create\_live\_webhook\_url = admin\_url( 'admin.php?page=simple\_wp\_membership\_settings&tab=2&swpm\_paypal\_create\_live\_webhook=1' );~~ |
  | 1387 |  | ~~$create\_live\_webhook\_url\_nonced = add\_query\_arg( '\_wpnonce', wp\_create\_nonce( 'swpm\_paypal\_create\_live\_webhook' ), $create\_live\_webhook\_url );~~ |
  | 1388 |  | ~~echo '<p><a class="button swpm-paypal-create-live-webhook-btn" href="' . esc\_url\_raw( $create\_live\_webhook\_url\_nonced ) . '" target="\_blank">'.SwpmUtils::\_('Create Live Webhook').'</a></p>';~~ |
  | 1389 |  | ~~}~~ |
  | 1390 |  | ~~}~~ |
  | 1391 |  | ~~?>~~ |
  | 1392 |  | ~~</td>~~ |
  | 1393 |  | ~~</tr>~~ |
  | 1394 |  | ~~<tr>~~ |
  | 1395 |  | ~~<th scope="row">Test Webhook Status</th>~~ |
  | 1396 |  | ~~<td>~~ |
  | 1397 |  | ~~<?php~~ |
  | 1398 |  | ~~$sandbox\_webhook\_id = get\_option( 'swpm\_paypal\_webhook\_id\_sandbox' );~~ |
  | 1399 |  | ~~if( !empty($sandbox\_webhook\_id)){~~ |
  | 1400 |  | ~~//Sandbox webhook exists~~ |
  | 1401 |  | ~~echo '<span class="swpm-paypal-sandbox-webhook-status"><span class="dashicons dashicons-yes" style="color:green;"></span>&nbsp;';~~ |
  | 1402 |  | ~~\_e( 'Sandbox Webhook exists. If you still have issues with webhooks, you can delete it and create again.', 'simple-membership');~~ |
  | 1403 |  | ~~echo '</span>';~~ |
  | 1404 |  | ~~} else {~~ |
  | 1405 |  | ~~//Sandbox webhook does not exist~~ |
  | 1406 |  | ~~if( empty( $this->get\_value('paypal-sandbox-client-id')) || empty( $this->get\_value('paypal-sandbox-secret-key')) ){~~ |
  | 1407 |  | ~~echo '<p><span class="swpm-paypal-sandbox-webhook-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1408 |  | ~~\_e( 'Sanbbox PayPal API credentials are not set. Please set the Sandbox PayPal API credentials first.', 'simple-membership' );~~ |
  | 1409 |  | ~~echo '</span></p>';~~ |
  | 1410 |  | ~~} else {~~ |
  | 1411 |  | ~~echo '<span class="swpm-paypal-sandbox-webhook-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp;';~~ |
  | 1412 |  | ~~\_e( 'No webhook found. Use the following Create Sandbox Webhook link to create a new webhook automatically.', 'simple-membership' );~~ |
  | 1413 |  | ~~echo '</span>';~~ |
  | 1414 |  | ~~$create\_sandbox\_webhook\_url = admin\_url( 'admin.php?page=simple\_wp\_membership\_settings&tab=2&swpm\_paypal\_create\_sandbox\_webhook=1' );~~ |
  | 1415 |  | ~~$create\_sandbox\_webhook\_url\_nonced = add\_query\_arg( '\_wpnonce', wp\_create\_nonce( 'swpm\_paypal\_create\_sandbox\_webhook' ), $create\_sandbox\_webhook\_url );~~ |
  | 1416 |  | ~~echo '<p><a class="button swpm-paypal-create-sandbox-webhook-btn" href="' . esc\_url\_raw( $create\_sandbox\_webhook\_url\_nonced ) . '" target="\_blank">'.SwpmUtils::\_('Create Sandbox Webhook').'</a></p>';~~ |
  | 1417 |  | ~~}~~ |
  | 1418 |  | ~~}~~ |
  | 1419 |  | ~~?>~~ |
  | 1420 |  | ~~</td>~~ |
  | 1421 |  | ~~</tr>~~ |
  | 1422 |  | ~~<tr>~~ |
  | 1423 |  | ~~<th scope="row"><?php \_e('Delete Webhooks', 'simple-membership'); ?></th>~~ |
  | 1424 |  | ~~<td>~~ |
  | 1425 |  | ~~<?php~~ |
  | 1426 |  | ~~if( $all\_api\_creds\_missing ){~~ |
  | 1427 |  | ~~echo '<p><span class="swpm-paypal-delete-webhook-status"><span class="dashicons dashicons-no" style="color: red;"></span>&nbsp';~~ |
  | 1428 |  | ~~\_e( 'PayPal API credentials are missing. Please set the PayPal API credentials.', 'simple-membership' );~~ |
  | 1429 |  | ~~echo '</span></p>';~~ |
  | 1430 |  | ~~} else {~~ |
  | 1431 |  | ~~$delete\_webhook\_url = admin\_url( 'admin.php?page=simple\_wp\_membership\_settings&tab=2&swpm\_paypal\_delete\_webhook=1' );~~ |
  | 1432 |  | ~~$delete\_webhook\_url\_nonced = add\_query\_arg( '\_wpnonce', wp\_create\_nonce( 'swpm\_paypal\_delete\_webhook' ), $delete\_webhook\_url );~~ |
  | 1433 |  | ~~echo '<p><a class="button swpm-paypal-delete-webhook-btn" href="'.esc\_url\_raw($delete\_webhook\_url\_nonced).'" target="\_blank">'.SwpmUtils::\_('Delete Webhooks').'</a></p>';~~ |
  | 1434 |  | ~~}~~ |
  | 1435 |  | ~~?>~~ |
  | 1436 |  | ~~</td>~~ |
  | 1437 |  | ~~</tr>~~ |
  | 1438 |  | ~~</tbody>~~ |
  | 1439 |  | ~~</table>~~ |
  | 1440 |  | ~~<?php~~ |
  | 1441 |  | ~~}~~ |
  | 1442 |  |  |
  | 1443 |  | ~~public function stripe\_global\_settings\_callback() {~~ |
  | 1444 |  | ~~\_e( 'This section allows you to configure Stripe payment related settings.', 'simple-membership' );~~ |
  | 1445 | 1146 | } |
  | 1446 | 1147 |  |
  | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=2991476#L1593) | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=3010737#L1294) |  |
  | 1593 | 1294 |  |
  | 1594 | 1295 | public function sanitize\_tab\_2( $input ) { |
  | 1595 |  | if ( empty( $this->settings ) ) { |
  | 1596 |  | $this->settings = (array) get\_option( 'swpm-settings' ); |
  | 1597 |  | } |
  | 1598 |  | $output = $this->settings; |
  | 1599 |  |  |
  | 1600 |  | $output['enable-sandbox-testing'] = isset( $input['enable-sandbox-testing'] ) ? esc\_attr( $input['enable-sandbox-testing'] ) : ''; |
  | 1601 |  |  |
  | 1602 |  | $output['paypal-live-client-id'] = sanitize\_text\_field( $input['paypal-live-client-id'] ); |
  | 1603 |  | $output['paypal-live-secret-key'] = sanitize\_text\_field( $input['paypal-live-secret-key'] ); |
  | 1604 |  | $output['paypal-sandbox-client-id'] = sanitize\_text\_field( $input['paypal-sandbox-client-id'] ); |
  | 1605 |  | $output['paypal-sandbox-secret-key'] = sanitize\_text\_field( $input['paypal-sandbox-secret-key'] ); |
  | 1606 |  |  |
  | 1607 |  | $output['stripe-prefill-member-email'] = isset( $input['stripe-prefill-member-email'] ) ? esc\_attr( $input['stripe-prefill-member-email'] ) : 0; |
  | 1608 |  | $output['stripe-test-public-key'] = sanitize\_text\_field( $input['stripe-test-public-key'] ); |
  | 1609 |  | $output['stripe-test-secret-key'] = sanitize\_text\_field( $input['stripe-test-secret-key'] ); |
  | 1610 |  | $output['stripe-live-public-key'] = sanitize\_text\_field( $input['stripe-live-public-key'] ); |
  | 1611 |  | $output['stripe-live-secret-key'] = sanitize\_text\_field( $input['stripe-live-secret-key'] ); |
  | 1612 |  |  |
  | 1613 |  | return $output; |
  |  | 1296 | //This is the callback function for the second tab. |
  |  | 1297 | //It sanitizes the input data for the second tab. |
  |  | 1298 | //This tab has been moved to the payments menu. In the future, we can remove this tab or re-use it for something else. |
  | 1614 | 1299 | } |
  | 1615 | 1300 |  |
  | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=2991476#L1767) | […](/browser/simple-membership/trunk/classes/class.swpm-settings.php?rev=3010737#L1452) |  |
  | 1767 | 1452 | break; |
  | 1768 | 1453 | case 6: |
  | 1769 |  | //Blacklist & whitelist settings |
  | 1770 |  | include SIMPLE\_WP\_MEMBERSHIP\_PATH . 'views/admin\_settings.php'; |
  | 1771 |  | break; |
  |  | 1454 | //Blacklist & whitelist settings |
  |  | 1455 | include SIMPLE\_WP\_MEMBERSHIP\_PATH . 'views/admin\_settings.php'; |
  |  | 1456 | break; |
  | 1772 | 1457 | case 7: |
  | 1773 | 1458 | //Addon settings |
* ## [simple-membership/trunk/classes/class.swpm-utils-member.php](/changeset/3010737/simple-membership/trunk/classes/class.swpm-utils-member.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/class.swpm-utils-member.php")

  | [r2867650](/browser/simple-membership/trunk/classes/class.swpm-utils-member.php?rev=2867650#L153 "Show revision 2867650 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/class.swpm-utils-member.php?rev=3010737#L153 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 153 | 153 | return $result; |
  | 154 | 154 | } |
  |  | 155 |  |
  |  | 156 | /\*\* |
  |  | 157 | \* Retrieves all members with a given membership level id and a given account state |
  |  | 158 | \* '-1' as $level\_id represents all membership levels. |
  |  | 159 | \* 'all' as $account\_state represents all account states. |
  |  | 160 | \* |
  |  | 161 | \* @param int|string $level\_id Membership level id. |
  |  | 162 | \* @param string $account\_state Account state. |
  |  | 163 | \* @return object Members |
  |  | 164 | \*/ |
  |  | 165 | public static function get\_all\_members\_of\_a\_level\_and\_a\_state($level\_id, $account\_state) { |
  |  | 166 | global $wpdb; |
  |  | 167 |  |
  |  | 168 | $query  = "SELECT \* FROM {$wpdb->prefix}swpm\_members\_tbl"; |
  |  | 169 |  |
  |  | 170 | // Check if 'WHERE' clause need to be used or not. |
  |  | 171 | if($level\_id != -1 || $account\_state != 'all'){ |
  |  | 172 |  |
  |  | 173 | $placeholders = array(); |
  |  | 174 | $where\_clauses = array(); |
  |  | 175 |  |
  |  | 176 | if ($level\_id != -1) { |
  |  | 177 | $where\_clauses[] = "membership\_level = %d"; |
  |  | 178 | $placeholders[] = $level\_id; |
  |  | 179 | } |
  |  | 180 | if ($account\_state != 'all') { |
  |  | 181 | $where\_clauses[] = "account\_state = %s"; |
  |  | 182 | $placeholders[] = $account\_state; |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | $query .= " WHERE " . implode(" AND ", $where\_clauses); |
  |  | 186 |  |
  |  | 187 | // query preparation is not required as there are not placeholders. |
  |  | 188 | $query = $wpdb->prepare($query, $placeholders); |
  |  | 189 | } |
  |  | 190 |  |
  |  | 191 | $result = $wpdb->get\_results( $query ); |
  |  | 192 |  |
  |  | 193 | return $result; |
  |  | 194 | } |
  |  | 195 |  |
  | 155 | 196 |  |
  | 156 | 197 | /\* |
* ## [simple-membership/trunk/classes/class.swpm-utils.php](/changeset/3010737/simple-membership/trunk/classes/class.swpm-utils.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/class.swpm-utils.php")

  | [r2994826](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=2994826#L22 "Show revision 2994826 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=3010737#L22 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | } |
  | 23 | 23 |  |
  | 24 |  | //Override the settings menu (options.php) update capability according to the role set in "Admin Dashboard Access Permission" option. |
  | 25 |  | add\_filter( 'option\_page\_capability\_swpm-settings-tab-1', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  | 26 |  | add\_filter( 'option\_page\_capability\_swpm-settings-tab-2', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  | 27 |  | add\_filter( 'option\_page\_capability\_swpm-settings-tab-3', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  | 28 |  | add\_filter( 'option\_page\_capability\_swpm-settings-tab-4', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  | 29 |  | add\_filter( 'option\_page\_capability\_swpm-settings-tab-5', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  | 30 |  |  |
  | 31 |  | } |
  | 32 |  |  |
  | 33 |  | public static function swpm\_settings\_update\_capability($capability){ |
  | 34 |  | if ( defined('SWPM\_MANAGEMENT\_PERMISSION') ){ |
  | 35 |  | //Use SWPM defined one. |
  | 36 |  | $capability = SWPM\_MANAGEMENT\_PERMISSION; |
  | 37 |  | } else { |
  | 38 |  | //Use default. |
  | 39 |  | $capability = 'manage\_options'; |
  | 40 |  | } |
  | 41 |  | return $capability; |
  | 42 |  | } |
  |  | 24 | //Override the settings menu (options.php) update capability according to the role set in "Admin Dashboard Access Permission" option. |
  |  | 25 | add\_filter( 'option\_page\_capability\_swpm-settings-tab-1', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  |  | 26 | add\_filter( 'option\_page\_capability\_swpm-settings-tab-2', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  |  | 27 | add\_filter( 'option\_page\_capability\_swpm-settings-tab-3', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  |  | 28 | add\_filter( 'option\_page\_capability\_swpm-settings-tab-4', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  |  | 29 | add\_filter( 'option\_page\_capability\_swpm-settings-tab-5', 'SwpmUtils::swpm\_settings\_update\_capability' ); |
  |  | 30 |  |
  |  | 31 | } |
  |  | 32 |  |
  |  | 33 | public static function swpm\_settings\_update\_capability($capability){ |
  |  | 34 | if ( defined('SWPM\_MANAGEMENT\_PERMISSION') ){ |
  |  | 35 | //Use SWPM defined one. |
  |  | 36 | $capability = SWPM\_MANAGEMENT\_PERMISSION; |
  |  | 37 | } else { |
  |  | 38 | //Use default. |
  |  | 39 | $capability = 'manage\_options'; |
  |  | 40 | } |
  |  | 41 | return $capability; |
  |  | 42 | } |
  | 43 | 43 |  |
  | 44 | 44 | public static function subscription\_type\_dropdown( $selected ) { |
  | […](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=2994826#L132) | […](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=3010737#L132) |  |
  | 132 | 132 | } |
  | 133 | 133 |  |
  | 134 |  | public static function account\_state\_dropdown( $selected = 'active' ) { |
  |  | 134 | public static function account\_state\_dropdown( $selected = 'active' , $option\_all = false) { |
  | 135 | 135 | $options = self::get\_account\_state\_options(); |
  | 136 | 136 | $html    = ''; |
  | […](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=2994826#L141) | […](/browser/simple-membership/trunk/classes/class.swpm-utils.php?rev=3010737#L141) |  |
  | 141 | 141 | } |
  | 142 | 142 |  |
  | 143 |  | public static function membership\_level\_dropdown( $selected = 0 ) { |
  |  | 143 | public static function membership\_level\_dropdown( $selected = 0, $option\_all = false ) { |
  | 144 | 144 | $options = ''; |
  | 145 | 145 | global $wpdb; |
* ## [simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php](/changeset/3010737/simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php "Show the changeset 3010737 restricted to simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php")

  | [r2991476](/browser/simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php?rev=2991476#L16 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/classes/shortcode-related/class.swpm-shortcodes-handler.php?rev=3010737#L16 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 16 | 16 | add\_shortcode( 'swpm\_stripe\_subscription\_cancel\_link', array( $this, 'swpm\_stripe\_cancel\_subs\_link\_sc' ) ); |
  | 17 | 17 |  |
  | 18 |  | //TODO - WIP (~~This will be moved to the shortcode implementation section later~~) |
  | 19 |  | //include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'views/payments/payment-gateway/paypal\_~~buy\_now\_ppcp~~\_button\_shortcode\_view.php' ); |
  |  | 18 | //TODO - WIP (Later, this will be moved to the shortcode implementation section like the other ones) |
  |  | 19 | //include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'views/payments/payment-gateway/paypal\_advanced\_buy\_now\_button\_shortcode\_view.php' ); |
  | 20 | 20 |  |
  | 21 | 21 | } |
* ## [simple-membership/trunk/css/swpm.common.css](/changeset/3010737/simple-membership/trunk/css/swpm.common.css "Show the changeset 3010737 restricted to simple-membership/trunk/css/swpm.common.css")

  | [r2991476](/browser/simple-membership/trunk/css/swpm.common.css?rev=2991476#L84 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/css/swpm.common.css?rev=3010737#L84 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 84 | 84 | border-color: #059B53; |
  | 85 | 85 | color: #043B14; |
  |  | 86 | border-radius: 3px 3px 3px 3px; |
  |  | 87 | border-style: solid; |
  |  | 88 | border-width: 1px; |
  |  | 89 | } |
  |  | 90 |  |
  |  | 91 | /\* Wrap directly with this class (not to be used with a paragraph tag) \*/ |
  |  | 92 | .swpm-blue-box { |
  |  | 93 | margin: 10px 0px; |
  |  | 94 | padding: 15px 10px; |
  |  | 95 | background-color: #E7F4FE; |
  |  | 96 | border-color: #AACEE6; |
  |  | 97 | color: #1D263B; |
  | 86 | 98 | border-radius: 3px 3px 3px 3px; |
  | 87 | 99 | border-style: solid; |
* ## [simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php](/changeset/3010737/simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php "Show the changeset 3010737 restricted to simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php")

  | [r2875084](/browser/simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php?rev=2875084#L11 "Show revision 2875084 of this file in browser") | [r3010737](/browser/simple-membership/trunk/ipn/swpm-stripe-buy-now-ipn.php?rev=3010737#L11 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | SwpmLog::log\_simple\_debug( 'Stripe Buy Now IPN received. Processing request...', true ); |
  | 12 | 12 | // SwpmLog::log\_simple\_debug(print\_r($\_REQUEST, true), true);//Useful for debugging purpose |
  |  | 13 |  |
  |  | 14 | if( !isset($\_REQUEST['item\_number']) || !isset($\_REQUEST['item\_price']) ){ |
  |  | 15 | SwpmLog::log\_simple\_debug( 'The Stripe Buy Now IPN request URL was accessed, but it is missing some required parameters. Aborting...', false ); |
  |  | 16 | wp\_die( esc\_html( 'The Stripe Buy Now IPN request URL was accessed, but it is missing some required parameters. Aborting...' ) ); |
  |  | 17 | } |
  | 13 | 18 |  |
  | 14 | 19 | // Include the Stripe library. |
* ## [simple-membership/trunk/languages/simple-membership.pot](/changeset/3010737/simple-membership/trunk/languages/simple-membership.pot "Show the changeset 3010737 restricted to simple-membership/trunk/languages/simple-membership.pot")

  | [r2991476](/browser/simple-membership/trunk/languages/simple-membership.pot?rev=2991476#L4146 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/languages/simple-membership.pot?rev=3010737#L4146 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 4146 | 4146 |  |
  | 4147 | 4147 | #: views/payments/payment-gateway/paypal\_buy\_now\_new\_button\_shortcode\_view.php:81 |
  | 4148 |  | ~~#: views/payments/payment-gateway/paypal\_buy\_now\_ppcp\_button\_shortcode\_view.php:85~~ |
  | 4149 | 4148 | #: views/payments/payment-gateway/paypal\_subscription\_new\_button\_shortcode\_view.php:77 |
  | 4150 | 4149 | msgid "Transaction completed successfully!" |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L28 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L28 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 28 | 28 |  |
  | 29 | 29 | $query\_args = array(); |
  | 30 |  | $query\_args['components'] = 'buttons,~~hosted-fields';~~ |
  |  | 30 | $query\_args['components'] = 'buttons,card-fields';//'buttons,card-fields,hosted-fields' |
  | 31 | 31 | $query\_args['client-id'] = $client\_id;//Seller client ID |
  | 32 |  | $query\_args['merchant-id'] = $merchant\_id;//Seller merchant ID |
  |  | 32 | if(!empty($merchant\_id)){ |
  |  | 33 | $query\_args['merchant-id'] = $merchant\_id;//Seller merchant ID |
  |  | 34 | } else { |
  |  | 35 | //Merchant ID is not mandatory for 'card-fields' component. |
  |  | 36 | $pp\_acdc\_msg\_str = \_\_( 'Note: Merchant ID value is empty so the SDK URL will not include this parameter.', 'simple-membership' ); |
  |  | 37 | SwpmLog::log\_simple\_debug($pp\_acdc\_msg\_str, true); |
  |  | 38 | } |
  | 33 | 39 | $query\_args['currency'] = $currency; |
  | 34 | 40 | $query\_args['intent'] = 'capture'; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L36) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L42) |  |
  | 36 | 42 | $base\_url = 'https://www.paypal.com/sdk/js'; |
  | 37 | 43 | $sdk\_src\_url = add\_query\_arg( $query\_args, $base\_url ); |
  | 38 |  | //Example URL = "https://www.paypal.com/sdk/js?components=buttons,~~hoste~~d-fields&client-id=".$client\_id."&merchant-id=".$merchant\_id."&currency=USD&intent=capture"; |
  |  | 44 | //Example URL = "https://www.paypal.com/sdk/js?components=buttons,card-fields&client-id=".$client\_id."&merchant-id=".$merchant\_id."&currency=USD&intent=capture"; |
  | 39 | 45 |  |
  | 40 | 46 | //Encode the URL to prevent &currency=USD or other parameters from being converted to special symbol. |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L65) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L71) |  |
  | 65 | 71 | \* PayPal requirement: A client token needs to be generated for each time the card fields render on the page. |
  | 66 | 72 | \*/ |
  | 67 |  | public function genera~~r~~te\_client\_token( $environment\_mode = 'production' ){ |
  |  | 73 | public function generate\_client\_token( $environment\_mode = 'production' ){ |
  | 68 | 74 | //Generate a customer ID. |
  | 69 | 75 | $customer\_id = self::generate\_customer\_id(); |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L113) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L119) |  |
  | 113 | 119 | $json = json\_decode( wp\_remote\_retrieve\_body( $response ) ); |
  | 114 | 120 | $client\_token = isset( $json->client\_token) ? $json->client\_token : ''; |
  |  | 121 |  |
  | 115 | 122 | return $client\_token; |
  | 116 | 123 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L134) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L141) |  |
  | 134 | 141 |  |
  | 135 | 142 | if( !is\_array( $data ) ){ |
  | 136 |  | SwpmLog::log\_simple\_debug( 'Data is not an array format. Converting JSON to array data.', true ); |
  | 137 |  | $data = json\_decode( $data, true);//Convert the JSON string to an array (Vanilla JS AJAX data will be in JSON format). |
  | 138 |  | } |
  | 139 |  |  |
  | 140 |  | //TODO - Debugging purpose. |
  | 141 |  | SwpmLog::log\_array\_data\_to\_debug( $data, true ); |
  |  | 143 | //Convert the JSON string to an array (Vanilla JS AJAX data will be in JSON format). |
  |  | 144 | $data = json\_decode( $data, true); |
  |  | 145 | } |
  | 142 | 146 |  |
  | 143 | 147 | $button\_id = isset( $data['button\_id'] ) ? sanitize\_text\_field( $data['button\_id'] ) : ''; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L167) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L171) |  |
  | 167 | 171 | $digital\_goods\_enabled = 1; |
  | 168 | 172 |  |
  | 169 |  | //TODO - remove this later. |
  | 170 |  | SwpmLog::log\_simple\_debug( 'acdc\_setup\_order - about to make API call...', true ); |
  | 171 |  |  |
  | 172 |  | //TODO - Create the order using the PayPal API. |
  | 173 |  | //https://developer.paypal.com/docs/api/orders/v2/#orders\_create |
  |  | 173 | // Create the order using the PayPal API. |
  |  | 174 | // https://developer.paypal.com/docs/api/orders/v2/#orders\_create |
  | 174 | 175 | $data = array( |
  | 175 | 176 | 'item\_name' => $item\_name, |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L179) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L180) |  |
  | 179 | 180 | 'digital\_goods\_enabled' => $digital\_goods\_enabled, |
  | 180 | 181 | ); |
  |  | 182 |  |
  | 181 | 183 | $api\_injector = new SWPM\_PayPal\_Request\_API\_Injector(); |
  | 182 |  | $response = $api\_injector->create\_paypal\_order( $data ); |
  |  | 184 | $response = $api\_injector->create\_paypal\_order\_by\_url\_and\_args( $data ); |
  |  | 185 | // SwpmLog::log\_simple\_debug('--- Var Export Below ---', true); |
  |  | 186 | // $debug = var\_export($response, true); |
  |  | 187 | // SwpmLog::log\_simple\_debug($debug, true); |
  |  | 188 |  |
  | 183 | 189 | if($response !== false){ |
  | 184 | 190 | $paypal\_order\_id = $response; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L194) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L200) |  |
  | 194 | 200 | } |
  | 195 | 201 |  |
  | 196 |  | ~~SwpmLog::log\_simple\_debug( 'acdc\_setup\_order - API call done. Sending AJAX response back.'~~, true ); |
  |  | 202 | SwpmLog::log\_simple\_debug( 'acdc\_setup\_order done. PayPal Order ID: ' . $paypal\_order\_id, true ); |
  | 197 | 203 |  |
  | 198 | 204 | //If everything is processed successfully, send the success response. |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L218) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L224) |  |
  | 218 | 224 | $on\_page\_button\_id = isset( $\_POST['on\_page\_button\_id'] ) ? sanitize\_text\_field( $\_POST['on\_page\_button\_id'] ) : ''; |
  | 219 | 225 | //$button\_id = isset( $data['button\_id'] ) ? sanitize\_text\_field( $data['button\_id'] ) : ''; |
  | 220 |  | SwpmLog::log\_~~array\_data\_to~~\_debug( 'Received request - swpm\_acdc\_capture\_order. Order ID: ' . $order\_id . ', on\_page\_button\_id: ' . $on\_page\_button\_id, true ); |
  |  | 226 | SwpmLog::log\_simple\_debug( 'Received request - swpm\_acdc\_capture\_order. Order ID: ' . $order\_id . ', on\_page\_button\_id: ' . $on\_page\_button\_id, true ); |
  | 221 | 227 |  |
  | 222 | 228 | // Check nonce. |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=2991476#L232) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-acdc-related.php?rev=3010737#L238) |  |
  | 232 | 238 |  |
  | 233 | 239 | // Capture the order using the PayPal API - https://developer.paypal.com/docs/api/orders/v2/#orders\_capture |
  | 234 |  | ~~$order\_data = array( 'order\_id' => $order\_id );~~ |
  | 235 | 240 | $api\_injector = new SWPM\_PayPal\_Request\_API\_Injector(); |
  | 236 |  | $response = $api\_injector->capture\_paypal\_order( $order\_~~data~~ ); |
  |  | 241 | $response = $api\_injector->capture\_paypal\_order( $order\_id ); |
  | 237 | 242 | if($response !== false){ |
  | 238 | 243 | $paypal\_capture\_id = $response; |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=2991476#L37 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=3010737#L37 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 37 | 37 | //The cached token is valid. Return it. |
  | 38 | 38 | $token\_string = $token['token\_value']; |
  | 39 |  | SwpmLog::log\_simple\_debug('Using the cached ~~bearer~~ token (since it is still valid). Environment mode: ' . $environment\_mode, true); |
  |  | 39 | SwpmLog::log\_simple\_debug('Using the cached PayPal API access token (since it is still valid). Environment mode: ' . $environment\_mode, true); |
  | 40 | 40 | return $token\_string; |
  | 41 | 41 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=2991476#L65) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=3010737#L65) |  |
  | 65 | 65 | } |
  | 66 | 66 |  |
  | 67 |  | SwpmLog::log\_simple\_debug('~~Creating a new bearer~~ token for environment mode: ' . $environment\_mode, true); |
  |  | 67 | SwpmLog::log\_simple\_debug('[New Token] Creating a new PayPal API access token for environment mode: ' . $environment\_mode, true); |
  | 68 | 68 |  |
  | 69 | 69 | if( $environment\_mode == 'sandbox' ){ |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=2991476#L95) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=3010737#L95) |  |
  | 95 | 95 | $response = SWPM\_PayPal\_Request\_API::send\_request\_by\_url\_and\_args( $url, $args ); |
  | 96 | 96 |  |
  | 97 |  | if ( is\_wp\_error( $response ) ) { |
  | 98 |  | //WP could not post the request. |
  | 99 |  | $error\_msg = $response->get\_error\_message();//Get the error from the WP\_Error object. |
  | 100 |  | SwpmLog::log\_simple\_debug( 'Failed to post the request to the PayPal API. Error: ' . $error\_msg, false ); |
  |  | 97 | if ( $response === false ) { |
  |  | 98 | //WP could not post the request. It has already logged the error in the log file. So just return ''. |
  | 101 | 99 | return false; |
  | 102 | 100 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=2991476#L115) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-bearer.php?rev=3010737#L113) |  |
  | 115 | 113 | //Cache/save the bearer token in the database. |
  | 116 | 114 | self::cache\_token( $token\_string, $environment\_mode ); |
  |  | 115 |  |
  |  | 116 | SwpmLog::log\_simple\_debug('PayPal access token created successfully.', true); |
  | 117 | 117 |  |
  | 118 | 118 | return $token\_string; |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=2991476#L10 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=3010737#L10 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 10 | 10 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php' ); |
  | 11 | 11 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-utility-functions.php' );//Misc project specific utility functions. |
  |  | 12 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-utility-ipn-related.php' );//Misc IPN related utility functions. |
  | 12 | 13 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-cache.php' ); |
  | 13 | 14 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-bearer.php' ); |
  |  | 15 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-button-ajax-handler.php' ); |
  | 14 | 16 | include\_once( SIMPLE\_WP\_MEMBERSHIP\_PATH . 'lib/paypal/class-swpm-paypal-acdc-related.php' ); |
  | 15 | 17 |  |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=2991476#L31) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=3010737#L33) |  |
  | 31 | 33 | public static $partner\_client\_id\_sandbox = 'AeO65uHbDsjjFBdx3DO6wffuH2wIHHRDNiF5jmNgXOC8o3rRKkmCJnpmuGzvURwqpyIv-CUYH9cwiuhX'; |
  | 32 | 34 |  |
  |  | 35 | public static $pp\_api\_connection\_settings\_menu\_page = 'admin.php?page=simple\_wp\_membership\_payments&tab=payment\_settings&subtab=ps\_pp\_api'; |
  |  | 36 |  |
  | 33 | 37 |  |
  | 34 | 38 | public function \_\_construct() { |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=2991476#L39) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=3010737#L43) |  |
  | 39 | 43 | } |
  | 40 | 44 |  |
  |  | 45 | //Initialize the PayPal Ajax Create and Capture Order Class so it can handle the ajax request(s). |
  |  | 46 | new SWPM\_PayPal\_Button\_Ajax\_Hander(); |
  |  | 47 |  |
  | 41 | 48 | //Initialize the PayPal OnApprove IPN Handler so it can handle the 'onApprove' ajax request(s). |
  | 42 | 49 | new SWPM\_PayPal\_OnApprove\_IPN\_Handler(); |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=2991476#L46) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-main.php?rev=3010737#L53) |  |
  | 46 | 53 |  |
  | 47 | 54 | //Initialize the PayPal onboarding serverside class so it can handle the 'onboardedCallback' ajax request. |
  | 48 |  | new SWPM\_PayPal\_PPCP\_Onboarding\_Serverside(); |
  |  | 55 | new SWPM\_PayPal\_PPCP\_Onboarding\_Serverside(); |
  | 49 | 56 |  |
  | 50 | 57 | } |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php")

  | [r2902081](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=2902081#L18 "Show revision 2902081 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=3010737#L18 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 18 | 18 | \*/ |
  | 19 | 19 | public function setup\_ajax\_request\_actions() { |
  | 20 |  | ~~//Handle the onApprove ajax request for 'Buy Now' type buttons~~ |
  | 21 |  | ~~add\_action( 'wp\_ajax\_swpm\_onapprove\_create\_order', array(&$this, 'swpm\_onapprove\_create\_order' ) );~~ |
  | 22 |  | ~~add\_action( 'wp\_ajax\_nopriv\_swpm\_onapprove\_create\_order', array(&$this, 'swpm\_onapprove\_create\_order' ) );~~ |
  | 23 |  |  |
  | 24 | 20 | //Handle the onApprove ajax request for 'Subscription' type buttons |
  | 25 | 21 | add\_action( 'wp\_ajax\_swpm\_onapprove\_create\_subscription', array(&$this, 'swpm\_onapprove\_create\_subscription' ) ); |
  | 26 | 22 | add\_action( 'wp\_ajax\_nopriv\_swpm\_onapprove\_create\_subscription', array(&$this, 'swpm\_onapprove\_create\_subscription' ) ); |
  | 27 |  | ~~}~~ |
  | 28 |  |  |
  | 29 |  | ~~/\*\*~~ |
  | 30 |  | ~~\* Handle the onApprove ajax request for 'Buy Now' type buttons~~ |
  | 31 |  | ~~\*/~~ |
  | 32 |  | ~~public function swpm\_onapprove\_create\_order(){~~ |
  | 33 |  |  |
  | 34 |  | ~~//Get the data from the request~~ |
  | 35 |  | ~~$data = isset( $\_POST['data'] ) ? stripslashes\_deep( $\_POST['data'] ) : array();~~ |
  | 36 |  | ~~if ( empty( $data ) ) {~~ |
  | 37 |  | ~~wp\_send\_json(~~ |
  | 38 |  | ~~array(~~ |
  | 39 |  | ~~'success' => false,~~ |
  | 40 |  | ~~'err\_msg'  => \_\_( 'Empty data received.', 'simple-membership' ),~~ |
  | 41 |  | ~~)~~ |
  | 42 |  | ~~);~~ |
  | 43 |  | ~~}~~ |
  | 44 |  | ~~//SwpmLog::log\_array\_data\_to\_debug( $data, true );//Debugging purpose~~ |
  | 45 |  |  |
  | 46 |  | ~~$on\_page\_button\_id = isset( $data['on\_page\_button\_id'] ) ? sanitize\_text\_field( $data['on\_page\_button\_id'] ) : '';~~ |
  | 47 |  | ~~SwpmLog::log\_simple\_debug( 'OnApprove ajax request received for createOrder. On Page Button ID: ' . $on\_page\_button\_id, true );~~ |
  | 48 |  |  |
  | 49 |  | ~~// Check nonce.~~ |
  | 50 |  | ~~if ( ! check\_ajax\_referer( $on\_page\_button\_id, '\_wpnonce', false ) ) {~~ |
  | 51 |  | ~~wp\_send\_json(~~ |
  | 52 |  | ~~array(~~ |
  | 53 |  | ~~'success' => false,~~ |
  | 54 |  | ~~'err\_msg'  => \_\_( 'Nonce check failed. The page was most likely cached. Please reload the page and try again.', 'simple-membership' ),~~ |
  | 55 |  | ~~)~~ |
  | 56 |  | ~~);~~ |
  | 57 |  | ~~exit;~~ |
  | 58 |  | ~~}~~ |
  | 59 |  |  |
  | 60 |  | ~~//Get the transaction data from the request~~ |
  | 61 |  | ~~$txn\_data = isset( $\_POST['txn\_data'] ) ? stripslashes\_deep( $\_POST['txn\_data'] ) : array();~~ |
  | 62 |  | ~~if ( empty( $txn\_data ) ) {~~ |
  | 63 |  | ~~wp\_send\_json(~~ |
  | 64 |  | ~~array(~~ |
  | 65 |  | ~~'success' => false,~~ |
  | 66 |  | ~~'err\_msg'  => \_\_( 'Empty transaction data received.', 'simple-membership' ),~~ |
  | 67 |  | ~~)~~ |
  | 68 |  | ~~);~~ |
  | 69 |  | ~~}~~ |
  | 70 |  | ~~//SwpmLog::log\_array\_data\_to\_debug( $txn\_data, true );//Debugging purpose.~~ |
  | 71 |  |  |
  | 72 |  |  |
  | 73 |  | ~~//Create the IPN data array from the transaction data.~~ |
  | 74 |  | ~~$this->create\_ipn\_data\_array\_from\_create\_order\_txn\_data( $data, $txn\_data );~~ |
  | 75 |  | ~~SwpmLog::log\_array\_data\_to\_debug( $this->ipn\_data, true );//Debugging purpose.~~ |
  | 76 |  |  |
  | 77 |  | ~~//Validate the buy now txn data before using it.~~ |
  | 78 |  | ~~$validation\_response = $this->validate\_buy\_now\_checkout\_txn\_data( $data, $txn\_data );~~ |
  | 79 |  | ~~if( $validation\_response !== true ){~~ |
  | 80 |  | ~~wp\_send\_json(~~ |
  | 81 |  | ~~array(~~ |
  | 82 |  | ~~'success' => false,~~ |
  | 83 |  | ~~'err\_msg'  => $validation\_response,~~ |
  | 84 |  | ~~)~~ |
  | 85 |  | ~~);~~ |
  | 86 |  | ~~exit;~~ |
  | 87 |  | ~~}~~ |
  | 88 |  |  |
  | 89 |  | ~~//Process the IPN data array~~ |
  | 90 |  | ~~SwpmLog::log\_simple\_debug( 'Validation passed. Going to create/update member account and save transaction data.', true );~~ |
  | 91 |  | ~~$this->create\_membership\_and\_save\_txn\_data( $data, $txn\_data );~~ |
  | 92 |  |  |
  | 93 |  | ~~// Trigger the IPN processed action hook (so other plugins can can listen for this event).~~ |
  | 94 |  | ~~do\_action( 'swpm\_paypal\_buy\_now\_checkout\_ipn\_processed', $this->ipn\_data );~~ |
  | 95 |  | ~~do\_action( 'swpm\_payment\_ipn\_processed', $this->ipn\_data );~~ |
  | 96 |  |  |
  | 97 |  | ~~//If everything is processed successfully, send the success response.~~ |
  | 98 |  | ~~wp\_send\_json( array( 'success' => true ) );~~ |
  | 99 |  | ~~exit;~~ |
  | 100 |  | ~~}~~ |
  | 101 |  |  |
  | 102 |  | ~~public function create\_ipn\_data\_array\_from\_create\_order\_txn\_data( $data, $txn\_data ) {~~ |
  | 103 |  | ~~$ipn = array();~~ |
  | 104 |  |  |
  | 105 |  | ~~//Get the custom field value from the request~~ |
  | 106 |  | ~~$custom = isset($data['custom\_field']) ? $data['custom\_field'] : '';~~ |
  | 107 |  | ~~$custom = urldecode( $custom );//Decode it just in case it was encoded.~~ |
  | 108 |  |  |
  | 109 |  | ~~if(isset($data['orderID'])){~~ |
  | 110 |  | ~~//Add the PayPal API orderID value to the reference parameter. So it gets saved with custom field data. This will be used to also save it to the reference DB column field when saving the transaction.~~ |
  | 111 |  | ~~$data['custom\_field'] = $custom . '&reference=' . $data['orderID'];~~ |
  | 112 |  | ~~}~~ |
  | 113 |  |  |
  | 114 |  | ~~//Parse the custom field to read the IP address.~~ |
  | 115 |  | ~~$customvariables = SwpmTransactions::parse\_custom\_var( $custom );~~ |
  | 116 |  |  |
  | 117 |  | ~~$purchase\_units = isset($txn\_data['purchase\_units']) ? $txn\_data['purchase\_units'] : array();~~ |
  | 118 |  |  |
  | 119 |  | ~~//The $data['orderID'] is the ID for the order created using createOrder API call. The Transaction ID is the ID for the captured payment.~~ |
  | 120 |  | ~~$txn\_id = isset($txn\_data['purchase\_units'][0]['payments']['captures'][0]['id']) ? $txn\_data['purchase\_units'][0]['payments']['captures'][0]['id'] : '';~~ |
  | 121 |  |  |
  | 122 |  | ~~$address\_street = isset($txn\_data['purchase\_units'][0]['shipping']['address']['address\_line\_1']) ? $txn\_data['purchase\_units'][0]['shipping']['address']['address\_line\_1'] : '';~~ |
  | 123 |  | ~~if ( isset ( $txn\_data['purchase\_units'][0]['shipping']['address']['address\_line\_2'] )){~~ |
  | 124 |  | ~~//If address line 2 is present, add it to the address.~~ |
  | 125 |  | ~~$address\_street .= ", " . $txn\_data['purchase\_units'][0]['shipping']['address']['address\_line\_2'];~~ |
  | 126 |  | ~~}~~ |
  | 127 |  |  |
  | 128 |  | ~~$ipn['gateway'] = 'paypal\_buy\_now\_checkout';~~ |
  | 129 |  | ~~$ipn['txn\_type'] = 'pp\_buy\_now\_new';~~ |
  | 130 |  | ~~$ipn['custom'] = isset($data['custom\_field']) ? $data['custom\_field'] : '';~~ |
  | 131 |  | ~~$ipn['txn\_id'] = $txn\_id;~~ |
  | 132 |  | ~~$ipn['subscr\_id'] = $txn\_id;//Same as txn\_id for one-time payments.~~ |
  | 133 |  |  |
  | 134 |  | ~~$ipn['item\_number'] = isset($data['button\_id']) ? $data['button\_id'] : '';~~ |
  | 135 |  | ~~$ipn['item\_name'] = isset($data['item\_name']) ? $data['item\_name'] : '';~~ |
  | 136 |  |  |
  | 137 |  | ~~$ipn['status'] = isset($txn\_data['status']) ? ucfirst( strtolower($txn\_data['status']) ) : '';~~ |
  | 138 |  | ~~$ipn['payment\_status'] = isset($txn\_data['status']) ? ucfirst( strtolower($txn\_data['status']) ) : '';~~ |
  | 139 |  |  |
  | 140 |  | ~~//Amount and currency.~~ |
  | 141 |  | ~~$ipn['mc\_gross'] = isset($txn\_data['purchase\_units'][0]['amount']['value']) ? $txn\_data['purchase\_units'][0]['amount']['value'] : '';~~ |
  | 142 |  | ~~$ipn['mc\_currency'] = isset($txn\_data['purchase\_units'][0]['amount']['currency\_code']) ? $txn\_data['purchase\_units'][0]['amount']['currency\_code'] : '';~~ |
  | 143 |  | ~~$ipn['quantity'] = 1;~~ |
  | 144 |  |  |
  | 145 |  | ~~// customer info.~~ |
  | 146 |  | ~~$ipn['ip'] = isset($customvariables['user\_ip']) ? $customvariables['user\_ip'] : '';~~ |
  | 147 |  | ~~$ipn['first\_name'] = isset($txn\_data['payer']['name']['given\_name']) ? $txn\_data['payer']['name']['given\_name'] : '';~~ |
  | 148 |  | ~~$ipn['last\_name'] = isset($txn\_data['payer']['name']['surname']) ? $txn\_data['payer']['name']['surname'] : '';~~ |
  | 149 |  | ~~$ipn['payer\_email'] = isset($txn\_data['payer']['email\_address']) ? $txn\_data['payer']['email\_address'] : '';~~ |
  | 150 |  | ~~$ipn['payer\_id'] = isset($txn\_data['payer']['payer\_id']) ? $txn\_data['payer']['payer\_id'] : '';~~ |
  | 151 |  | ~~$ipn['address\_street'] = $address\_street;~~ |
  | 152 |  | ~~$ipn['address\_city']    = isset($txn\_data['purchase\_units'][0]['shipping']['address']['admin\_area\_2']) ? $txn\_data['purchase\_units'][0]['shipping']['address']['admin\_area\_2'] : '';~~ |
  | 153 |  | ~~$ipn['address\_state']   = isset($txn\_data['purchase\_units'][0]['shipping']['address']['admin\_area\_1']) ? $txn\_data['purchase\_units'][0]['shipping']['address']['admin\_area\_1'] : '';~~ |
  | 154 |  | ~~$ipn['address\_zip']     = isset($txn\_data['purchase\_units'][0]['shipping']['address']['postal\_code']) ? $txn\_data['purchase\_units'][0]['shipping']['address']['postal\_code'] : '';~~ |
  | 155 |  | ~~$country\_code = isset($txn\_data['purchase\_units'][0]['shipping']['address']['country\_code']) ? $txn\_data['purchase\_units'][0]['shipping']['address']['country\_code'] : '';~~ |
  | 156 |  | ~~$ipn['address\_country'] = SwpmMiscUtils::get\_country\_name\_by\_country\_code($country\_code);~~ |
  | 157 |  | ~~//Additional variables~~ |
  | 158 |  | ~~//$ipn['reason\_code'] = $txn\_data['reason\_code'];~~ |
  | 159 |  |  |
  | 160 |  | ~~$this->ipn\_data = $ipn;~~ |
  | 161 |  | ~~}~~ |
  | 162 |  |  |
  | 163 |  | ~~/\*\*~~ |
  | 164 |  | ~~\* Validate that the transaction/order exists in PayPal and the price matches the price in the DB.~~ |
  | 165 |  | ~~\*/~~ |
  | 166 |  | ~~public function validate\_buy\_now\_checkout\_txn\_data( $data, $txn\_data ) {~~ |
  | 167 |  | ~~//Get the transaction/order details from PayPal API endpoint - /v2/checkout/orders/{$order\_id}~~ |
  | 168 |  | ~~$pp\_orderID = $data['orderID'];~~ |
  | 169 |  | ~~$button\_id = $data['button\_id'];~~ |
  | 170 |  |  |
  | 171 |  | ~~$validation\_error\_msg = '';~~ |
  | 172 |  |  |
  | 173 |  | ~~//This is for on-site checkout only. So the 'mode' and API creds will be whatever is currently set in the settings.~~ |
  | 174 |  | ~~$api\_injector = new SWPM\_PayPal\_Request\_API\_Injector();~~ |
  | 175 |  | ~~$order\_details = $api\_injector->get\_paypal\_order\_details( $pp\_orderID );~~ |
  | 176 |  | ~~if( $order\_details !== false ){~~ |
  | 177 |  | ~~//The order details were retrieved successfully.~~ |
  | 178 |  | ~~if(is\_object($order\_details)){~~ |
  | 179 |  | ~~//Convert the object to an array.~~ |
  | 180 |  | ~~$order\_details = json\_decode(json\_encode($order\_details), true);~~ |
  | 181 |  | ~~}~~ |
  | 182 |  | ~~//SwpmLog::log\_array\_data\_to\_debug( $order\_details, true );//Debugging only.~~ |
  | 183 |  |  |
  | 184 |  | ~~//Check that the amount matches with what we expect.~~ |
  | 185 |  | ~~$amount = isset($order\_details['purchase\_units'][0]['amount']['value']) ? $order\_details['purchase\_units'][0]['amount']['value'] : 0;~~ |
  | 186 |  |  |
  | 187 |  | ~~$payment\_amount\_expected = get\_post\_meta( $button\_id, 'payment\_amount', true );~~ |
  | 188 |  | ~~if( floatval($amount) < floatval($payment\_amount\_expected) ){~~ |
  | 189 |  | ~~//The amount does not match.~~ |
  | 190 |  | ~~$validation\_error\_msg = 'Validation Error! The payment amount does not match. Button ID: ' . $button\_id . ', PayPal Order ID: ' . $pp\_orderID . ', Amount Received: ' . $amount . ', Amount Expected: ' . $payment\_amount\_expected;~~ |
  | 191 |  | ~~SwpmLog::log\_simple\_debug( $validation\_error\_msg, false );~~ |
  | 192 |  | ~~return $validation\_error\_msg;~~ |
  | 193 |  | ~~}~~ |
  | 194 |  |  |
  | 195 |  | ~~//Check that the currency matches with what we expect.~~ |
  | 196 |  | ~~$currency = isset($order\_details['purchase\_units'][0]['amount']['currency\_code']) ? $order\_details['purchase\_units'][0]['amount']['currency\_code'] : '';~~ |
  | 197 |  | ~~$currency\_expected = get\_post\_meta( $button\_id, 'payment\_currency', true );~~ |
  | 198 |  | ~~if( $currency != $currency\_expected ){~~ |
  | 199 |  | ~~//The currency does not match.~~ |
  | 200 |  | ~~$validation\_error\_msg = 'Validation Error! The payment currency does not match. Button ID: ' . $button\_id . ', PayPal Order ID: ' . $pp\_orderID . ', Currency Received: ' . $currency . ', Currency Expected: ' . $currency\_expected;~~ |
  | 201 |  | ~~SwpmLog::log\_simple\_debug( $validation\_error\_msg, false );~~ |
  | 202 |  | ~~return $validation\_error\_msg;~~ |
  | 203 |  | ~~}~~ |
  | 204 |  |  |
  | 205 |  | ~~} else {~~ |
  | 206 |  | ~~//Error getting subscription details.~~ |
  | 207 |  | ~~$validation\_error\_msg = 'Validation Error! Failed to get transaction/order details from the PayPal API. PayPal Order ID: ' . $pp\_orderID;~~ |
  | 208 |  | ~~//TODO - Show additional error details if available.~~ |
  | 209 |  | ~~SwpmLog::log\_simple\_debug( $validation\_error\_msg, false );~~ |
  | 210 |  | ~~return $validation\_error\_msg;~~ |
  | 211 |  | ~~}~~ |
  | 212 |  |  |
  | 213 |  | ~~//All good. The data is valid.~~ |
  | 214 |  | ~~return true;~~ |
  | 215 | 23 | } |
  | 216 | 24 |  |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=2902081#L276) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=3010737#L84) |  |
  | 276 | 84 | //Process the IPN data array |
  | 277 | 85 | SwpmLog::log\_simple\_debug( 'Validation passed. Going to create/update member account and save transaction data.', true ); |
  | 278 |  | ~~$this->create\_membership\_and\_save\_txn\_data( $data, $tx~~n\_data ); |
  |  | 86 | SWPM\_PayPal\_Utility\_IPN\_Related::create\_membership\_and\_save\_txn\_data( $data, $txn\_data, $this->ipn\_data ); |
  | 279 | 87 |  |
  | 280 | 88 | // Trigger the IPN processed action hook (so other plugins can can listen for this event). |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=2902081#L433) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-onapprove-ipn-handler.php?rev=3010737#L241) |  |
  | 433 | 241 | } |
  | 434 | 242 |  |
  | 435 |  | ~~public function create\_membership\_and\_save\_txn\_data( $data, $txn\_data ){~~ |
  | 436 |  | ~~//Check if this is a duplicate notification.~~ |
  | 437 |  | ~~if( self::is\_txn\_already\_processed($this->ipn\_data)){~~ |
  | 438 |  | ~~//This transaction notification has already been processed. So we don't need to process it again.~~ |
  | 439 |  | ~~return true;~~ |
  | 440 |  | ~~}~~ |
  | 441 |  |  |
  | 442 |  | ~~$button\_id = $data['button\_id'];~~ |
  | 443 |  | ~~$txn\_id = isset($this->ipn\_data['txn\_id']) ? $this->ipn\_data['txn\_id'] : '';~~ |
  | 444 |  | ~~$txn\_type = isset($this->ipn\_data['txn\_type']) ? $this->ipn\_data['txn\_type'] : '';~~ |
  | 445 |  | ~~SwpmLog::log\_simple\_debug( 'Transaction type: ' . $txn\_type . ', Transaction ID: ' . $txn\_id, true );~~ |
  | 446 |  |  |
  | 447 |  | ~~// Custom variables~~ |
  | 448 |  | ~~$custom = isset($this->ipn\_data['custom']) ? $this->ipn\_data['custom'] : '';~~ |
  | 449 |  | ~~$customvariables = SwpmTransactions::parse\_custom\_var( $custom );~~ |
  | 450 |  |  |
  | 451 |  | ~~// Membership level ID.~~ |
  | 452 |  | ~~$membership\_level\_id = get\_post\_meta($button\_id, 'membership\_level\_id', true);~~ |
  | 453 |  | ~~SwpmLog::log\_simple\_debug( 'Membership payment paid for membership level ID: ' . $membership\_level\_id, true );~~ |
  | 454 |  | ~~if ( ! empty( $membership\_level\_id ) ) {~~ |
  | 455 |  | ~~$swpm\_id = '';~~ |
  | 456 |  | ~~if ( isset( $customvariables['swpm\_id'] ) ) {~~ |
  | 457 |  | ~~$swpm\_id = $customvariables['swpm\_id'];~~ |
  | 458 |  | ~~}~~ |
  | 459 |  |  |
  | 460 |  | ~~// Process the user profile creation/update.~~ |
  | 461 |  | ~~swpm\_handle\_subsc\_signup\_stand\_alone( $this->ipn\_data, $membership\_level\_id, $txn\_id, $swpm\_id );~~ |
  | 462 |  |  |
  | 463 |  | ~~} else {~~ |
  | 464 |  | ~~SwpmLog::log\_simple\_debug( 'Membership level ID is missing in the button configuration! Cannot process this notification.', false );~~ |
  | 465 |  | ~~}~~ |
  | 466 |  |  |
  | 467 |  | ~~// Save the transaction data.~~ |
  | 468 |  | ~~SwpmLog::log\_simple\_debug( 'Saving transaction data to the database table.', true );~~ |
  | 469 |  | ~~SwpmTransactions::save\_txn\_record( $this->ipn\_data, array() );~~ |
  | 470 |  | ~~SwpmLog::log\_simple\_debug( 'Transaction data saved.', true );~~ |
  | 471 |  |  |
  | 472 |  | ~~return true;~~ |
  | 473 |  | ~~}~~ |
  | 474 |  |  |
  | 475 |  | ~~public static function is\_txn\_already\_processed( $ipn\_data ){~~ |
  | 476 |  | ~~// Query the DB to check if we have already processed this transaction or not.~~ |
  | 477 |  | ~~global $wpdb;~~ |
  | 478 |  | ~~$txn\_id = isset($ipn\_data['txn\_id']) ? $ipn\_data['txn\_id'] : '';~~ |
  | 479 |  | ~~$payer\_email = isset($ipn\_data['payer\_email']) ? $ipn\_data['payer\_email'] : '';~~ |
  | 480 |  | ~~$txn\_row = $wpdb->get\_row( $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}swpm\_payments\_tbl WHERE txn\_id = %s and email = %s", $txn\_id, $payer\_email ), OBJECT );~~ |
  | 481 |  | ~~if (!empty($txn\_row)) {~~ |
  | 482 |  | ~~// And if we have already processed it, do nothing and return true~~ |
  | 483 |  | ~~SwpmLog::log\_simple\_debug( "This transaction has already been processed (Txn ID: ".$txn\_id.", Payer Email: ".$payer\_email."). This looks to be a duplicate notification. Nothing to do here.", true );~~ |
  | 484 |  | ~~return true;~~ |
  | 485 |  | ~~}~~ |
  | 486 |  | ~~return false;~~ |
  | 487 |  | ~~}~~ |
  | 488 | 243 | } |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=2991476#L211 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=3010737#L211 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 211 | 211 | } |
  | 212 | 212 |  |
  | 213 |  | public function create\_paypal\_order( $data ){ |
  |  | 213 | /\* |
  |  | 214 | \* Creates a PayPal order. Returns the order ID if successful. |
  |  | 215 | \* The $additional\_args array can be used to pass additional arguments to the function to return the raw response or response body. |
  |  | 216 | \*/ |
  |  | 217 | public function create\_paypal\_order\_by\_url\_and\_args( $data, $additional\_args = array()){ |
  | 214 | 218 | $payment\_amount = isset($data['payment\_amount']) ? $data['payment\_amount'] : ''; |
  | 215 | 219 | $quantity = isset($data['quantity']) ? $data['quantity'] : 1; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=2991476#L218) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=3010737#L222) |  |
  | 218 | 222 | //$digital\_goods\_enabled = isset($data['digital\_goods\_enabled']) ? $data['digital\_goods\_enabled'] : 1; |
  | 219 | 223 |  |
  |  | 224 | //https://developer.paypal.com/docs/api/orders/v2/#orders\_create |
  | 220 | 225 | $order\_data = [ |
  | 221 |  | "intent" => "CAPTURE", |
  | 222 |  | "purchase\_units" => [ |
  | 223 |  | [ |
  | 224 |  | "amount" => [ |
  | 225 |  | "value" => $payment\_amount, |
  | 226 |  | "currency\_code" => $currency, |
  | 227 |  | "breakdown" => [ |
  | 228 |  | "item\_total" => [ |
  | 229 |  | "currency\_code" => $currency, |
  | 230 |  | "value" => $payment\_amount \* $quantity, |
  | 231 |  | ] |
  | 232 |  | ] |
  |  | 226 | "intent" => "CAPTURE", |
  |  | 227 | "purchase\_units" => [ |
  |  | 228 | [ |
  |  | 229 | "amount" => [ |
  |  | 230 | "value" => $payment\_amount, |
  |  | 231 | "currency\_code" => $currency, |
  |  | 232 | "breakdown" => [ |
  |  | 233 | "item\_total" => [ |
  |  | 234 | "currency\_code" => $currency, |
  |  | 235 | "value" => $payment\_amount \* $quantity, |
  |  | 236 | ] |
  |  | 237 | ] |
  |  | 238 | ], |
  |  | 239 | "items" => [ |
  |  | 240 | [ |
  |  | 241 | "name" => $item\_name, |
  |  | 242 | "quantity" => $quantity, |
  |  | 243 | "unit\_amount" => [ |
  |  | 244 | "value" => $payment\_amount, |
  |  | 245 | "currency\_code" => $currency, |
  |  | 246 | ] |
  |  | 247 | ] |
  | 233 | 248 | ], |
  | 234 |  | "items" => [ |
  | 235 |  | [ |
  | 236 |  | "name" => $item\_name, |
  | 237 |  | "quantity" => $quantity, |
  | 238 |  | // "category" => $digital\_goods\_enabled ? "PHYSICAL\_GOODS" : "DIGITAL\_GOODS", |
  | 239 |  | "unit\_amount" => [ |
  | 240 |  | "value" => $payment\_amount, |
  | 241 |  | "currency\_code" => $currency, |
  | 242 |  | ] |
  | 243 |  | ] |
  | 244 |  | ] |
  | 245 |  | ] |
  | 246 |  | ] |
  | 247 |  | ]; |
  | 248 |  |  |
  | 249 |  | $endpoint = '/v2/checkout/orders'; |
  | 250 |  | $response = $this->paypal\_req\_api->post($endpoint, $order\_data); |
  |  | 249 | "description" => $item\_name, |
  |  | 250 | ] |
  |  | 251 | ] |
  |  | 252 | ]; |
  |  | 253 |  |
  |  | 254 | //A simple order data for testing |
  |  | 255 | // $order\_data = [ |
  |  | 256 | //     "intent" => "CAPTURE", |
  |  | 257 | //     "purchase\_units" => [ |
  |  | 258 | //         [ |
  |  | 259 | //             amount => [ |
  |  | 260 | //             currency\_code => "USD", |
  |  | 261 | //             value => "100.00", |
  |  | 262 | //             ], |
  |  | 263 | //         ], |
  |  | 264 | //     ], |
  |  | 265 | // ]; |
  |  | 266 |  |
  |  | 267 | $environment\_mode = 'sandbox'; |
  |  | 268 | //Token |
  |  | 269 | //Get the bearer/access token. |
  |  | 270 | $bearer = SWPM\_PayPal\_Bearer::get\_instance(); |
  |  | 271 | $bearer\_token = $bearer->get\_bearer\_token( $environment\_mode ); |
  |  | 272 | $access\_token = $bearer\_token; |
  |  | 273 |  |
  |  | 274 | //Args |
  |  | 275 | $args = array( |
  |  | 276 | 'method'  => 'POST', |
  |  | 277 | 'headers' => array( |
  |  | 278 | 'Authorization' => 'Bearer ' . $access\_token, |
  |  | 279 | 'Content-Type'  => 'application/json', |
  |  | 280 | 'PayPal-Partner-Attribution-Id' => 'TipsandTricks\_SP\_PPCP', |
  |  | 281 | ), |
  |  | 282 | ); |
  |  | 283 |  |
  |  | 284 | $args['body'] = wp\_json\_encode( $order\_data ); |
  |  | 285 |  |
  |  | 286 | //PayPal create-order using URL and Args |
  |  | 287 | //Get the API base URL. |
  |  | 288 | $api\_base\_url = SWPM\_PayPal\_Utility\_Functions::get\_api\_base\_url\_by\_environment\_mode( $environment\_mode ); |
  |  | 289 | $url = trailingslashit( $api\_base\_url ) . 'v2/checkout/orders'; |
  |  | 290 |  |
  |  | 291 | SwpmLog::log\_simple\_debug('Executing order create (v2/checkout/orders) using URL and args.', true); |
  |  | 292 | $response = SWPM\_PayPal\_Request\_API::send\_request\_by\_url\_and\_args( $url, $args ); |
  |  | 293 |  |
  |  | 294 | //Check if we need to return the body or raw response instead of just the order ID. |
  |  | 295 | if( isset($additional\_args['return\_raw\_response']) && $additional\_args['return\_raw\_response'] ){ |
  |  | 296 | //Return the raw response instead of just the order ID. |
  |  | 297 | return $response; |
  |  | 298 | } else if ( isset( $additional\_args['return\_response\_body'] ) && $additional\_args['return\_response\_body'] ){ |
  |  | 299 | //Return the response body instead of just the order ID. |
  |  | 300 | return wp\_remote\_retrieve\_body( $response ); |
  |  | 301 | } |
  |  | 302 |  |
  |  | 303 | //Return the standard response. |
  | 251 | 304 | if ( $response !== false){ |
  | 252 | 305 | //Response is a success! |
  | 253 |  | $created\_order\_id = $response->id; |
  |  | 306 | $json\_response\_body = json\_decode( wp\_remote\_retrieve\_body( $response ) ); |
  |  | 307 | $created\_order\_id = $json\_response\_body->id; |
  |  | 308 | SwpmLog::log\_simple\_debug('Order-create response. Order ID: '. $created\_order\_id, true); |
  | 254 | 309 | return $created\_order\_id; |
  | 255 | 310 | } else { |
  | 256 |  | //The process\_request\_result() function has debug lines that can be uncommented to check further details. |
  | 257 |  | //We can also pass the $additional\_args['return\_raw\_response'] = true to the post() function to get the raw response. |
  | 258 |  | return false; |
  | 259 |  | } |
  | 260 |  | } |
  | 261 |  |  |
  | 262 |  | public function capture\_paypal\_order( $order\_data = array() ){ |
  | 263 |  | //Get the PayPal order ID from the data. |
  | 264 |  | $order\_id = isset($order\_data['order\_id']) ? $order\_data['order\_id'] : ''; |
  |  | 311 | //There was a WP Error with the remote request. Enable debug logging to get more details from the log file. |
  |  | 312 | return false; |
  |  | 313 | } |
  |  | 314 | } |
  |  | 315 |  |
  |  | 316 | public function capture\_paypal\_order( $order\_id, $additional\_args = array() ){ |
  | 265 | 317 | if( empty($order\_id) ){ |
  | 266 |  | return false; |
  | 267 |  | } |
  | 268 |  |  |
  |  | 318 | SwpmLog::log\_simple\_debug('Empty PayPal order ID received. cannot process this request.', false); |
  |  | 319 | return false; |
  |  | 320 | } |
  |  | 321 | $order\_data = array( 'order\_id' => $order\_id ); |
  |  | 322 |  |
  |  | 323 | //https://developer.paypal.com/docs/api/orders/v2/#orders\_capture |
  | 269 | 324 | $endpoint = '/v2/checkout/orders/' . $order\_id . '/capture'; |
  | 270 |  | $response = $this->paypal\_req\_api->post($endpoint, $order\_data); |
  |  | 325 | $response = $this->paypal\_req\_api->post($endpoint, $order\_data, $additional\_args); |
  |  | 326 |  |
  |  | 327 | //Check if we need to return the raw response or body (set in additional args). |
  |  | 328 | if( isset($additional\_args['return\_raw\_response']) || $additional\_args['return\_response\_body'] ){ |
  |  | 329 | //Return whatever we got from the API call according to the additional args. |
  |  | 330 | return $response; |
  |  | 331 | } |
  |  | 332 |  |
  |  | 333 | //Return the standard response. |
  | 271 | 334 | if ( $response !== false){ |
  | 272 | 335 | //Response is a success! |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=2991476#L274) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api-injector.php?rev=3010737#L337) |  |
  | 274 | 337 | return $capture\_id; |
  | 275 | 338 | } else { |
  | 276 |  | //Failed to capture the order. |
  | 277 |  | //The process\_request\_result() function has debug lines that can be uncommented to check further details. |
  | 278 |  | //We can also pass the $additional\_args['return\_raw\_response'] = true to the post() function to get the raw response. |
  | 279 |  | return false; |
  | 280 |  | } |
  | 281 |  |  |
  | 282 |  | } |
  |  | 339 | //Failed to capture the order. The process\_request\_result() function has debug lines to reveal more details. |
  |  | 340 | return false; |
  |  | 341 | } |
  |  | 342 |  |
  |  | 343 | } |
  | 283 | 344 |  |
  | 284 | 345 | } |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L148 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L148 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 148 | 148 | $jwt\_payload = array( 'iss' => $partner\_client\_id, 'payer\_id' => $seller\_merchant\_id ); |
  | 149 | 149 | $pp\_auth\_assertion = base64\_encode(json\_encode($jwt\_header\_data)).'.'.base64\_encode(json\_encode($jwt\_payload)).'.';//The signature is empty |
  | 150 |  | ~~//TODO - Debug purpose only~~ |
  | 151 |  | ~~SwpmLog::log\_simple\_debug('Created auth assertion value using merchant ID: ' . $seller\_merchant\_id . ', client ID: ' . $partner\_client\_id, true);~~ |
  | 152 | 150 | return $pp\_auth\_assertion; |
  | 153 | 151 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L172) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L170) |  |
  | 172 | 170 | $request\_url = $api\_base\_url . $endpoint; //Example: https://api-m.sandbox.paypal.com/v1/billing/plans |
  | 173 | 171 |  |
  |  | 172 | //Add the request URL to the additional args so it can be logged (if needed). |
  |  | 173 | $additional\_args['request\_url'] = $request\_url; |
  |  | 174 |  |
  | 174 | 175 | $res = wp\_remote\_get( |
  | 175 | 176 | $request\_url, |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L180) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L181) |  |
  | 180 | 181 | ); |
  | 181 | 182 |  |
  | 182 |  | if( isset( $additional\_args['return\_raw\_response'] ) && $additional\_args['return\_raw\_response'] ){ |
  |  | 183 | //Check if we need to return the body or raw response |
  |  | 184 | if( isset($additional\_args['return\_raw\_response']) && $additional\_args['return\_raw\_response'] ){ |
  |  | 185 | //Return the raw response |
  | 183 | 186 | return $res; |
  | 184 |  | } |
  |  | 187 | } else if ( isset( $additional\_args['return\_response\_body'] ) && $additional\_args['return\_response\_body'] ){ |
  |  | 188 | //Return the response body |
  |  | 189 | return wp\_remote\_retrieve\_body( $res ); |
  |  | 190 | } |
  |  | 191 |  |
  | 185 | 192 | $status\_code = isset( $additional\_args['status\_code'] ) ? $additional\_args['status\_code'] : 200; |
  | 186 |  | $return = $this->process\_request\_result( $res, $status\_code ); |
  |  | 193 | $return = $this->process\_request\_result( $res, $status\_code, $additional\_args ); |
  | 187 | 194 |  |
  | 188 | 195 | return $return; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L210) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L217) |  |
  | 210 | 217 | $request\_url = $api\_base\_url . $endpoint; //Example: https://api-m.sandbox.paypal.com/v1/catalogs/products |
  | 211 | 218 |  |
  |  | 219 | //Add the request URL to the additional args so it can be logged (if needed). |
  |  | 220 | $additional\_args['request\_url'] = $request\_url; |
  |  | 221 |  |
  | 212 | 222 | $res = wp\_remote\_post( |
  | 213 | 223 | $request\_url, |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L218) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L228) |  |
  | 218 | 228 | ); |
  | 219 | 229 |  |
  | 220 |  | if( isset( $additional\_args['return\_raw\_response'] ) && $additional\_args['return\_raw\_response'] ){ |
  |  | 230 | //Check if we need to return the body or raw response |
  |  | 231 | if( isset($additional\_args['return\_raw\_response']) && $additional\_args['return\_raw\_response'] ){ |
  |  | 232 | //Return the raw response |
  | 221 | 233 | return $res; |
  | 222 |  | } |
  |  | 234 | } else if ( isset( $additional\_args['return\_response\_body'] ) && $additional\_args['return\_response\_body'] ){ |
  |  | 235 | //Return the response body |
  |  | 236 | return wp\_remote\_retrieve\_body( $res ); |
  |  | 237 | } |
  |  | 238 |  |
  | 223 | 239 | //POST success response status code is 201 by default |
  | 224 | 240 | $status\_code = isset( $additional\_args['status\_code'] ) ? $additional\_args['status\_code'] : 201; |
  | 225 |  | $return = $this->process\_request\_result( $res, $status\_code ); |
  |  | 241 | $return = $this->process\_request\_result( $res, $status\_code, $additional\_args ); |
  | 226 | 242 |  |
  | 227 | 243 | return $return; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L242) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L258) |  |
  | 242 | 258 | $api\_base\_url = $this->get\_api\_base\_url(); |
  | 243 | 259 | $request\_url = $api\_base\_url . $endpoint; //Example: https://api-m.sandbox.paypal.com/v1/catalogs/products |
  |  | 260 |  |
  |  | 261 | //Add the request URL to the additional args so it can be logged (if needed). |
  |  | 262 | $additional\_args['request\_url'] = $request\_url; |
  | 244 | 263 |  |
  | 245 | 264 | $res = wp\_remote\_request( |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L252) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L271) |  |
  | 252 | 271 | ); |
  | 253 | 272 |  |
  | 254 |  | if( isset( $additional\_args['return\_raw\_response'] ) && $additional\_args['return\_raw\_response'] ){ |
  |  | 273 | //Check if we need to return the body or raw response |
  |  | 274 | if( isset($additional\_args['return\_raw\_response']) && $additional\_args['return\_raw\_response'] ){ |
  |  | 275 | //Return the raw response |
  | 255 | 276 | return $res; |
  | 256 |  | } |
  | 257 |  | //DELETE success response status code is 204 by default |
  |  | 277 | } else if ( isset( $additional\_args['return\_response\_body'] ) && $additional\_args['return\_response\_body'] ){ |
  |  | 278 | //Return the response body |
  |  | 279 | return wp\_remote\_retrieve\_body( $res ); |
  |  | 280 | } |
  |  | 281 |  |
  |  | 282 | //DELETE action's success response status code is 204 by default |
  | 258 | 283 | $status\_code = isset( $additional\_args['status\_code'] ) ? $additional\_args['status\_code'] : 204; |
  | 259 |  | $return = $this->process\_request\_result( $res, $status\_code ); |
  |  | 284 | $return = $this->process\_request\_result( $res, $status\_code, $additional\_args ); |
  | 260 | 285 |  |
  | 261 | 286 | return $return; |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L265) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L290) |  |
  | 265 | 290 | \* Minimizes the amount of response code check the source code has to do. |
  | 266 | 291 | \*/ |
  | 267 |  | private function process\_request\_result( $res, $status\_code = 200 ) { |
  |  | 292 | private function process\_request\_result( $res, $status\_code = 200, $additional\_args = array() ) { |
  | 268 | 293 | if (is\_wp\_error( $res )) { |
  | 269 | 294 | $this->last\_error['error\_message'] = $res->get\_error\_message(); |
  | 270 | 295 | $this->last\_error['error\_code'] = $res->get\_error\_code(); |
  |  | 296 | //This usually means that WordPress failed to make the request to the API endpoint correctly. Log this error so the debug option can reveal the details. |
  |  | 297 | $this->log\_api\_error\_response( $res, $this->last\_error['error\_message'], $additional\_args ); |
  | 271 | 298 | return false; |
  | 272 | 299 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L284) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L311) |  |
  | 284 | 311 | $this->last\_error['error\_message'] = 'Error! The body of the response is empty. Check that the expected response status code is correct.'; |
  | 285 | 312 | } |
  |  | 313 | //Log this error so the debug option can reveal the details. |
  |  | 314 | $this->log\_api\_error\_response( $res, $this->last\_error['error\_message'], $additional\_args ); |
  | 286 | 315 | return false; |
  | 287 | 316 | } |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L290) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L319) |  |
  | 290 | 319 |  |
  | 291 | 320 | //=== Debug purposes === |
  | 292 |  | //SwpmLog::log\_simple\_debug( '----- PayPal REST API response output -----', true ); |
  | 293 |  | //PayPal debug id |
  |  | 321 | // SwpmLog::log\_simple\_debug( '----- PayPal REST API response output -----', true ); |
  | 294 | 322 | // $paypal\_debug\_id = wp\_remote\_retrieve\_header( $res, 'paypal-debug-id' ); |
  | 295 | 323 | // SwpmLog::log\_simple\_debug( 'PayPal Debug ID from the REST API response: ' . $paypal\_debug\_id, true ); |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L299) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L327) |  |
  | 299 | 327 |  |
  | 300 | 328 | return $response\_body; |
  |  | 329 | } |
  |  | 330 |  |
  |  | 331 | public function log\_api\_error\_response( $response, $error\_message, $additional\_args = array() ) { |
  |  | 332 | //Log the error message. |
  |  | 333 | SwpmLog::log\_simple\_debug( 'Error occurred with the PayPal API request. Error message: ' . $error\_message, false ); |
  |  | 334 | //Log the PayPal debug id for PayPal API Error. |
  |  | 335 | $paypal\_debug\_id\_and\_info = SWPM\_PayPal\_Request\_API::get\_paypal\_debug\_id\_and\_info($response, $additional\_args); |
  |  | 336 | SwpmLog::log\_simple\_debug( $paypal\_debug\_id\_and\_info, false ); |
  |  | 337 | } |
  |  | 338 |  |
  |  | 339 | /\* |
  |  | 340 | \* Returns the PayPal debug ID and info from the API response. |
  |  | 341 | \*/ |
  |  | 342 | public static function get\_paypal\_debug\_id\_and\_info($response, $additional\_args = array()) { |
  |  | 343 | $paypal\_debug\_id = wp\_remote\_retrieve\_header( $response, 'paypal-debug-id' ); |
  |  | 344 | $paypal\_debug\_id\_and\_info = 'PayPal Debug ID: ' . $paypal\_debug\_id; |
  |  | 345 | if (isset($additional\_args['request\_url'])){ |
  |  | 346 | $paypal\_debug\_id\_and\_info .= ', Request URL: ' . $additional\_args['request\_url']; |
  |  | 347 | } |
  |  | 348 | return $paypal\_debug\_id\_and\_info; |
  | 301 | 349 | } |
  | 302 | 350 |  |
  | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=2991476#L331) | […](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-request-api.php?rev=3010737#L379) |  |
  | 331 | 379 | $response = wp\_remote\_get( $url, $args ); |
  | 332 | 380 |  |
  |  | 381 | if ( is\_wp\_error($response) ) { |
  |  | 382 | // Error occurred with the API request. Lets log the error. |
  |  | 383 | $error\_message = $response->get\_error\_message(); |
  |  | 384 | SwpmLog::log\_simple\_debug( 'Error occurred with the PayPal API (by URL) request. Error message: ' . $error\_message, false ); |
  |  | 385 | // Log the PayPal debug id for PayPal API Error. |
  |  | 386 | $paypal\_debug\_id = wp\_remote\_retrieve\_header( $response, 'paypal-debug-id' ); |
  |  | 387 | SwpmLog::log\_simple\_debug( 'PayPal Debug ID: ' . $paypal\_debug\_id . ', Request URL: ' . $url , false ); |
  |  | 388 | return false; |
  |  | 389 | } |
  |  | 390 |  |
  | 333 | 391 | //=== Debug purposes === |
  | 334 | 392 | //PayPal debug id |
  | 335 | 393 | $paypal\_debug\_id = wp\_remote\_retrieve\_header( $response, 'paypal-debug-id' ); |
  | 336 |  | SwpmLog::log\_simple\_debug( 'PayPal Debug ID from the REST API ~~response: ' . $paypal\_debug\_id~~, true ); |
  | 337 |  | //~~Debug the request body~~ |
  | 338 |  | //$response\_body = wp\_remote\_retrieve\_body( $response ); |
  | 339 |  | //$response\_body\_json\_decoded = json\_decode( $response\_body ); |
  | 340 |  | //SwpmLog::log\_array\_data\_to\_debug( $response\_body\_json\_decoded, true ); |
  | 341 |  | //~~Debug the full response (header and body)~~ |
  |  | 394 | SwpmLog::log\_simple\_debug( 'PayPal Debug ID from the REST API (by URL) request. Debug ID: ' . $paypal\_debug\_id . ', Request URL: ' . $url, true ); |
  |  | 395 | //-- Debug the request body -- |
  |  | 396 | // $response\_body = wp\_remote\_retrieve\_body( $response ); |
  |  | 397 | // $response\_body\_json\_decoded = json\_decode( $response\_body ); |
  |  | 398 | // SwpmLog::log\_array\_data\_to\_debug( $response\_body\_json\_decoded, true ); |
  |  | 399 | //-- Debug the full response (header and body) -- |
  | 342 | 400 | //$response\_full\_var\_exported = var\_export( $response, true ); |
  | 343 |  | //SwpmLog::log\_simple\_debug( 'PayPal API response body: ' . $debug\_api\_response, true ); |
  |  | 401 | //SwpmLog::log\_simple\_debug( 'PayPal API (by URL) response body: ' . $debug\_api\_response, true ); |
  | 344 | 402 | //=== End of debug purposes === |
  | 345 | 403 |  |
* ## [simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php](/changeset/3010737/simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php")

  | [r2867650](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php?rev=2867650#L122 "Show revision 2867650 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/class-swpm-paypal-webhook.php?rev=3010737#L122 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 122 | 122 | //$additional\_args = array( 'return\_raw\_response' => '1', 'status\_code' => '200' ); |
  | 123 | 123 | $response = $this->paypal\_req\_api->get($endpoint, $params ); |
  | 124 |  |  |
  | 125 |  | ~~//var\_dump( $response );//TODO - remove this line~~ |
  | 126 | 124 |  |
  | 127 | 125 | if( $response !== false){ |
* ## [simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php](/changeset/3010737/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php")

  | [r2991476](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L74 "Show revision 2991476 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L74 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 74 | 74 | ); |
  | 75 | 75 | } |
  | 76 |  | ~~//SwpmLog::log\_array\_data\_to\_debug( $seller\_api\_credentials, true );//TODO - Debugging purpose~~ |
  | 77 | 76 |  |
  | 78 | 77 | //Save the credentials to the database. |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L86) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L85) |  |
  | 86 | 85 | //=== Seller account status === |
  | 87 | 86 | $seller\_account\_status = $this->get\_seller\_account\_status\_data\_using\_bearer\_token($bearer\_token, $seller\_api\_credentials, $environment\_mode ); |
  | 88 |  | SwpmLog::log\_array\_data\_to\_debug( $seller\_account\_status, true );~~//TODO - Debugging purpose~~ |
  |  | 87 | SwpmLog::log\_array\_data\_to\_debug( $seller\_account\_status, true ); |
  | 89 | 88 | if( ! $seller\_account\_status ){ |
  | 90 | 89 | //Failed to get seller account status. |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L121) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L120) |  |
  | 121 | 120 | ); |
  | 122 | 121 | } |
  |  | 122 | SwpmLog::log\_simple\_debug( 'PPCP\_STANDARD vetting\_status: ' . $seller\_account\_status['ppcp\_standard\_vetting\_status'], true ); |
  |  | 123 | SwpmLog::log\_simple\_debug( 'CUSTOM\_CARD\_PROCESSING status: ' . $seller\_account\_status['custom\_card\_processing\_status'], true ); |
  | 123 | 124 |  |
  | 124 | 125 | //Webhooks will be created (if not already created) when the admin creates subsription payment buttons |
  | 125 | 126 |  |
  | 126 |  | //Save the onboarding complete flag to the database. |
  |  | 127 | //Save the onboarding complete and other related flag to the database. |
  | 127 | 128 | $settings = SwpmSettings::get\_instance(); |
  |  | 129 | $settings->set\_value('paypal-ppcp-vetting-status-'.$environment\_mode, $seller\_account\_status['ppcp\_standard\_vetting\_status']); // ACDC Related - PPCP\_STANDARD vetting\_status |
  |  | 130 | $settings->set\_value('paypal-ppcp-custom-card-processing-status-'.$environment\_mode, $seller\_account\_status['custom\_card\_processing\_status']); // ACDC Related - CUSTOM\_CARD\_PROCESSING Status |
  | 128 | 131 | $settings->set\_value('paypal-ppcp-onboarding-'.$environment\_mode, 'completed'); |
  | 129 | 132 | $settings->save(); |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L194) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L197) |  |
  | 194 | 197 | } |
  | 195 | 198 |  |
  | 196 |  | //Success. return the credentials. |
  |  | 199 | // ACDC Related - Check 'PPCP\_STANDARD' vetting\_status & 'CUSTOM\_CARD\_PROCESSING' Status |
  |  | 200 | // Check if products is set and is an array |
  |  | 201 | $ppcp\_standard\_vetting\_status = ''; |
  |  | 202 | if (isset($json->products) && is\_array($json->products)) { |
  |  | 203 | foreach ($json->products as $product) { |
  |  | 204 | // Check if the name property exists and equals 'PPCP\_STANDARD' |
  |  | 205 | if (isset($product->name) && $product->name === 'PPCP\_STANDARD') { |
  |  | 206 | // Check if vetting\_status property exists |
  |  | 207 | if (isset($product->vetting\_status)) { |
  |  | 208 | $ppcp\_standard\_vetting\_status = $product->vetting\_status; |
  |  | 209 | // Break the loop if the desired product is found |
  |  | 210 | break; |
  |  | 211 | } |
  |  | 212 | } |
  |  | 213 | } |
  |  | 214 | } |
  |  | 215 |  |
  |  | 216 | // Check if capabilities is set and is an array |
  |  | 217 | $custom\_card\_processing\_status = ''; |
  |  | 218 | if (isset($json->capabilities) && is\_array($json->capabilities)) { |
  |  | 219 | foreach ($json->capabilities as $capability) { |
  |  | 220 | // Check if the name property exists and equals 'CUSTOM\_CARD\_PROCESSING' |
  |  | 221 | if (isset($capability->name) && $capability->name === 'CUSTOM\_CARD\_PROCESSING') { |
  |  | 222 | // Check if status property exists |
  |  | 223 | if (isset($capability->status)) { |
  |  | 224 | $custom\_card\_processing\_status = $capability->status; |
  |  | 225 | // We found the status, no need to continue the loop |
  |  | 226 | break; |
  |  | 227 | } |
  |  | 228 | } |
  |  | 229 | } |
  |  | 230 | } |
  |  | 231 |  |
  |  | 232 | //Success. return the data we will use. |
  | 197 | 233 | return array( |
  | 198 | 234 | 'merchant\_id' => $json->merchant\_id, |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L200) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L236) |  |
  | 200 | 236 | 'payments\_receivable' => $json->payments\_receivable, |
  | 201 | 237 | 'primary\_email\_confirmed' => $json->primary\_email\_confirmed, |
  |  | 238 | 'ppcp\_standard\_vetting\_status' => $ppcp\_standard\_vetting\_status, // ACDC Related - PPCP\_STANDARD vetting\_status |
  |  | 239 | 'custom\_card\_processing\_status' => $custom\_card\_processing\_status, // ACDC Related - CUSTOM\_CARD\_PROCESSING Status |
  | 202 | 240 | ); |
  | 203 | 241 |  |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=2991476#L263) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding-serverside.php?rev=3010737#L301) |  |
  | 263 | 301 | $settings->save(); |
  | 264 | 302 | SwpmLog::log\_simple\_debug( 'Seller API credentials (environment mode: '.$environment\_mode.') reset/removed successfully.', true ); |
  |  | 303 |  |
  |  | 304 | //Delete any cached token using the old credentials (so it is forced to generate and cache a new one after onboarding (when new API call is made))) |
  |  | 305 | SWPM\_PayPal\_Bearer::delete\_cached\_token(); |
  |  | 306 | SwpmLog::log\_simple\_debug( 'Executed delete PayPal bearer cached token function (to clean it up).', true ); |
  | 265 | 307 | } |
  | 266 | 308 |  |
* ## [simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php](/changeset/3010737/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php "Show the changeset 3010737 restricted to simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php")

  | [r2960602](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=2960602#L38 "Show revision 2960602 of this file in browser") | [r3010737](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=3010737#L38 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 38 | 38 |  |
  | 39 | 39 | public static function generate\_return\_url\_after\_onboarding( $environment\_mode = 'production' ){ |
  | 40 |  | $base\_url = admin\_url('admin.php?page=simple\_wp\_membership\_settings'); |
  |  | 40 | $pp\_settings\_base\_path = SWPM\_PayPal\_Main::$pp\_api\_connection\_settings\_menu\_page; |
  |  | 41 | $base\_url = admin\_url($pp\_settings\_base\_path); |
  | 41 | 42 | $query\_args = array(); |
  | 42 |  | ~~$query\_args['tab'] = '2';~~ |
  | 43 | 43 | $query\_args['swpm\_ppcp\_after\_onboarding'] = '1'; |
  | 44 | 44 | $query\_args['environment\_mode'] = $environment\_mode; |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=2960602#L58) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=3010737#L58) |  |
  | 58 | 58 | $query\_args['product'] = 'PPCP';// 'EXPRESS\_CHECKOUT'; |
  | 59 | 59 | $query\_args['integrationType'] = 'FO'; |
  | 60 |  | $query\_args['features'] = 'PAYMENT,REFUND'; |
  |  | 60 | $query\_args['features'] = 'PAYMENT,REFUND,BILLING\_AGREEMENT'; |
  | 61 | 61 | $query\_args['partnerClientId'] = SWPM\_PayPal\_Main::$partner\_client\_id\_sandbox; |
  | 62 | 62 | $query\_args['returnToPartnerUrl'] = self::generate\_return\_url\_after\_onboarding('sandbox'); |
  | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=2960602#L132) | […](/browser/simple-membership/trunk/lib/paypal/onboarding-related/class-swpm-paypal-onboarding.php?rev=3010737#L132) |  |
  | 132 | 132 |  |
  | 133 | 133 | public function output\_sandbox\_ac\_disconnect\_link(){ |
  | 134 |  | $sandbox\_disconnect\_url = admin\_url('admin.php?page=simple\_wp\_membership\_settings&tab=2&swpm\_ppcp\_sandbox\_disconnect=1'); |
  |  | 134 | $disonnect\_link\_path = SWPM\_PayPal\_Main::$pp\_api\_connection\_settings\_menu\_page . '&swpm\_ppcp\_sandbox\_disconnect=1'; |
  |  | 135 | $sandbox\_disconnect\_url = admin\_url($disonnect\_link\_path); |
  | 135 | 136 | $ac\_disconnect\_nonce = wp\_create\_nonce('swpm\_sandbox\_ac\_disconnect\_nonce'); |
  | 136 | 137 | $sandbox\_disconnect\_url\_nonced = add\_query\_arg('\_wpnonce', $ac\_disconnect\_nonce, $sandbox\_disconnect\_url); |
* ## [simple-membership/trunk/readme.txt](/changeset/3010737/simple-membership/trunk/readme.txt "Show the changeset 3010737 restricted to simple-membership/trunk/readme.txt")

  | [r2994826](/browser/simple-membership/trunk/readme.txt?rev=2994826#L6 "Show revision 2994826 of this file in browser") | [r3010737](/browser/simple-membership/trunk/readme.txt?rev=3010737#L6 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | Requires PHP: 5.6 |
  | 7 | 7 | Tested up to: 6.4 |
  | 8 |  | Stable tag: 4.3.~~8~~ |
  |  | 8 | Stable tag: 4.3.9 |
  | 9 | 9 | License: GPLv2 or later |
  | 10 | 10 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/simple-membership/trunk/readme.txt?rev=2994826#L88) | […](/browser/simple-membership/trunk/readme.txt?rev=3010737#L88) |  |
  | 88 | 88 | \* Allow your members to delete their membership accounts. |
  | 89 | 89 | \* Send quick notification email to your members. |
  |  | 90 | \* Email all members by membership level, with an option to filter by account status. |
  | 90 | 91 | \* Customize the password reset email for members. |
  | 91 | 92 | \* Use Google reCAPTCHA on your member registration form. |
  | […](/browser/simple-membership/trunk/readme.txt?rev=2994826#L170) | […](/browser/simple-membership/trunk/readme.txt?rev=3010737#L171) |  |
  | 170 | 171 | == Changelog == |
  | 171 | 172 |  |
  |  | 173 | = 4.3.9 = |
  |  | 174 | - Note: Significant updates have been made to the PayPal's new API related code in this release. Please take a backup of your site before updating. |
  |  | 175 | - The 'Payment Settings' tab has been moved to the 'Payments' menu. Allowing all payment configuration related functions to be under one menu. |
  |  | 176 | - The 'Payment Settings' menu has been divided into multiple sub-menus for better organization. |
  |  | 177 | - Added a new option in the PayPal API tab to allow manual deletion of the PayPal API access token cache. |
  |  | 178 | - The PayPal buy now (New API) button's JavaScript code has been updated to reflect the latest PayPal API related changes. |
  |  | 179 | - If WP Login form is used, our plugin will let WP handle the post-login redirection. |
  |  | 180 | - Honor the 'redirect\_to' parameter in the post login redirection function. |
  |  | 181 | - Added an empty check to the Stripe buy now IPN handling function. |
  |  | 182 | - Translation improvement for 'activation-required' account status display in the user's profile. |
  |  | 183 | - Better formatting for the admin edit interface error message. |
  |  | 184 | - Added output escaping in the new PayPal API settings tab. |
  |  | 185 | - Added a new filter 'swpm\_send\_direct\_email\_body\_settings'. |
  |  | 186 | - The following new options has been added in the 'Send Direct Email' feature. Thanks to Dennis. |
  |  | 187 | - Send Direct Email -> Send email based on member's account status. |
  |  | 188 | - Send Direct Email -> Send a copy of email to the site admin. |
  |  | 189 | - Send Direct Email -> List email recipients as a preview. |
  |  | 190 |  |
  | 172 | 191 | = 4.3.8 = |
  | 173 | 192 | - Minor translation related update in the admin edit member interface. |
* ## [simple-membership/trunk/simple-wp-membership.php](/changeset/3010737/simple-membership/trunk/simple-wp-membership.php "Show the changeset 3010737 restricted to simple-membership/trunk/simple-wp-membership.php")

  | [r2994826](/browser/simple-membership/trunk/simple-wp-membership.php?rev=2994826#L2 "Show revision 2994826 of this file in browser") | [r3010737](/browser/simple-membership/trunk/simple-wp-membership.php?rev=3010737#L2 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | /\* |
  | 3 | 3 | Plugin Name: Simple WordPress Membership |
  | 4 |  | Version: 4.3.~~8~~ |
  |  | 4 | Version: 4.3.9 |
  | 5 | 5 | Plugin URI: https://simple-membership-plugin.com/ |
  | 6 | 6 | Author: smp7, wp.insider |
  | […](/browser/simple-membership/trunk/simple-wp-membership.php?rev=2994826#L17) | […](/browser/simple-membership/trunk/simple-wp-membership.php?rev=3010737#L17) |  |
  | 17 | 17 | } |
  | 18 | 18 |  |
  | 19 |  | define( 'SIMPLE\_WP\_MEMBERSHIP\_VER', '4.3.~~8~~' ); |
  |  | 19 | define( 'SIMPLE\_WP\_MEMBERSHIP\_VER', '4.3.9' ); |
  | 20 | 20 | define( 'SIMPLE\_WP\_MEMBERSHIP\_DB\_VER', '1.3' ); |
  | 21 | 21 | define( 'SIMPLE\_WP\_MEMBERSHIP\_SITE\_HOME\_URL', home\_url() ); |
* ## [simple-membership/trunk/views/admin\_settings.php](/changeset/3010737/simple-membership/trunk/views/admin_settings.php "Show the changeset 3010737 restricted to simple-membership/trunk/views/admin_settings.php")

  | [r2867650](/browser/simple-membership/trunk/views/admin_settings.php?rev=2867650#L1 "Show revision 2867650 of this file in browser") | [r3010737](/browser/simple-membership/trunk/views/admin_settings.php?rev=3010737#L1 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  |  | 1 | <?php |
  |  | 2 | //This file is used to render the settings form for the admin settings page. |
  |  | 3 | //We can also use settings section (with empty heading) inside the tab\_1() or tab\_2() method to render arbitrary HTML code. |
  |  | 4 | //Search the code with 'swpm-documentation' to see an example of this. |
  |  | 5 | //However, you can't add your own forms in there since it will be wrapped by the main settings form (so it will be a form inside a form situation). |
  |  | 6 | //You can create links to use GET query arguments. |
  | 1 | 7 |  |
  |  | 8 | ?> |
  | 2 | 9 | <!-- This file outputs the settings form fields for a lot of the settings pages --> |
  | 3 | 10 | <form action="options.php" method="POST"> |
* ## [simple-membership/trunk/views/payments/admin\_payment\_settings.php](/changeset/3010737/simple-membership/trunk/views/payments/admin_payment_settings.php "Show the changeset 3010737 restricted to simple-membership/trunk/views/payments/admin_payment_settings.php")

  | [r2960602](/browser/simple-membership/trunk/views/payments/admin_payment_settings.php?rev=2960602#L1 "Show revision 2960602 of this file in browser") | [r3010737](/browser/simple-membership/trunk/views/payments/admin_payment_settings.php?rev=3010737#L1 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 |  | //T~~his file is used to render the settings page for the payment settings tab~~. |
  |  | 2 | //TODO - this menu tab can be removed in the future. It is here for backward compatibility. |
  | 3 | 3 |  |
  | 4 |  | ~~//Tab overview message and documentation link.~~ |
  | 5 |  | ~~echo '<div class="swpm-grey-box">';~~ |
  | 6 |  | ~~echo '<p>';~~ |
  | 7 |  | ~~\_e('You can create membership payment buttons from the ', 'simple-membership');~~ |
  | 8 |  | ~~echo '<a href="admin.php?page=simple\_wp\_membership\_payments&tab=create\_new\_button" target="\_blank">' . SwpmUtils::\_('payments menu') . '</a>';~~ |
  | 9 |  | ~~\_e(' of this plugin (useful if you want to offer paid memberships on the site).', 'simple-membership');~~ |
  | 10 |  | ~~\_e(' Read the ', 'simple-membership');~~ |
  | 11 |  | ~~echo '<a href="https://simple-membership-plugin.com/simple-membership-documentation/#membership-payment-options" target="\_blank">' . SwpmUtils::\_('membership payment section') . '</a>';~~ |
  | 12 |  | ~~\_e(' of our documentation to learn more about creating membership payment buttons.', 'simple-membership');~~ |
  | 13 |  | ~~echo '</p>';~~ |
  | 14 |  | ~~echo '</div>';~~ |
  | 15 |  |  |
  | 16 |  | ~~//Any other arbitrary HTML code and forms can be added here.~~ |
  | 17 |  | ~~//We can also use settings section (with empty heading) inside the tab\_2() method to render arbitrary HTML code.~~ |
  | 18 |  | ~~//However, you can't add forms in there since it will be wrapped by the main settings form. You can create links to use GET query arguments.~~ |
  | 19 |  | ~~//See the "paypal-webhooks-settings" section for example.~~ |
  | 20 |  |  |
  | 21 |  | ~~//Handle the webhook create/delete requests~~ |
  | 22 |  | ~~if (isset($\_GET['swpm\_paypal\_create\_live\_webhook'])){~~ |
  | 23 |  | ~~check\_admin\_referer( 'swpm\_paypal\_create\_live\_webhook' );~~ |
  | 24 |  | ~~$pp\_webhook = new SWPM\_PayPal\_Webhook();~~ |
  | 25 |  | ~~$ret = $pp\_webhook->check\_and\_create\_webhook\_for\_live\_mode();~~ |
  | 26 |  |  |
  | 27 |  | ~~//Create the response message.~~ |
  | 28 |  | ~~$live\_wh\_create\_result = '';~~ |
  | 29 |  | ~~if( isset($ret['status']) && ($ret['status'] == 'yes' )){~~ |
  | 30 |  | ~~//Add an extra checkmark in the message for visual appeal.~~ |
  | 31 |  | ~~$live\_wh\_create\_result .= '<span class="dashicons dashicons-yes" style="color:green;"></span>' . \_\_(' Success! ', 'simple-membership');~~ |
  | 32 |  | ~~}~~ |
  | 33 |  | ~~$live\_wh\_create\_result .= isset($ret['msg']) ? $ret['msg'] : '';~~ |
  | 34 |  | ~~$live\_wh\_create\_result .= '<p><a href="#paypal-subscription-webhooks">Click here</a> to go to the webhook section below.</p>';~~ |
  | 35 |  | ~~echo '<div class="swpm-yellow-box"><p><strong>Create Live Webhook: </strong>' . $live\_wh\_create\_result . '</p></div>';~~ |
  | 36 |  |  |
  | 37 |  | ~~}~~ |
  | 38 |  | ~~if (isset($\_GET['swpm\_paypal\_create\_sandbox\_webhook'])){~~ |
  | 39 |  | ~~check\_admin\_referer( 'swpm\_paypal\_create\_sandbox\_webhook' );~~ |
  | 40 |  | ~~$pp\_webhook = new SWPM\_PayPal\_Webhook();~~ |
  | 41 |  | ~~$ret = $pp\_webhook->check\_and\_create\_webhook\_for\_sandbox\_mode();~~ |
  | 42 |  |  |
  | 43 |  | ~~//Create the response message.~~ |
  | 44 |  | ~~$sandbox\_wh\_create\_result = '';~~ |
  | 45 |  | ~~if( isset($ret['status']) && ($ret['status'] == 'yes' )){~~ |
  | 46 |  | ~~//Add an extra checkmark in the message for visual appeal.~~ |
  | 47 |  | ~~$sandbox\_wh\_create\_result .= '<span class="dashicons dashicons-yes" style="color:green;"></span>' . \_\_(' Success! ', 'simple-membership');~~ |
  | 48 |  | ~~}~~ |
  | 49 |  | ~~$sandbox\_wh\_create\_result .= isset($ret['msg']) ? $ret['msg'] : '';~~ |
  | 50 |  | ~~$sandbox\_wh\_create\_result .= '<p><a href="#paypal-subscription-webhooks">Click here</a> to go to the webhook section below.</p>';~~ |
  | 51 |  | ~~echo '<div class="swpm-yellow-box"><p><strong>Create Sandbox Webhook: </strong>' . $sandbox\_wh\_create\_result . '</p></div>';~~ |
  | 52 |  | ~~}~~ |
  | 53 |  | ~~if (isset($\_GET['swpm\_paypal\_delete\_webhook'])){~~ |
  | 54 |  | ~~check\_admin\_referer( 'swpm\_paypal\_delete\_webhook' );~~ |
  | 55 |  | ~~$pp\_webhook = new SWPM\_PayPal\_Webhook();~~ |
  | 56 |  | ~~$delete\_action\_result = $pp\_webhook->check\_and\_delete\_webhooks\_for\_both\_modes();~~ |
  | 57 |  | ~~$delete\_action\_result .= '<p><a href="#paypal-subscription-webhooks">Click here</a> to go to the webhook section below.</p>';~~ |
  | 58 |  | ~~echo '<div class="swpm-yellow-box"><p>' . $delete\_action\_result . '</p></div>';~~ |
  | 59 |  | ~~}~~ |
  | 60 |  |  |
  | 61 |  | ~~if (isset($\_GET['swpm\_ppcp\_after\_onboarding'])){~~ |
  | 62 |  | ~~$environment\_mode = isset($\_GET['environment\_mode']) ? $\_GET['environment\_mode'] : '';~~ |
  | 63 |  | ~~$onboarding\_action\_result = '<p>PayPal merchant account connection setup completed for environment mode: '. $environment\_mode .'</p>';~~ |
  | 64 |  | ~~$onboarding\_action\_result .= '<p><a href="#paypal-ppcp-connection-section">Click here</a> to go to the PayPal Account Setup section below.</p>';~~ |
  | 65 |  | ~~echo '<div class="swpm-yellow-box"><p>' . $onboarding\_action\_result . '</p></div>';~~ |
  | 66 |  | ~~}~~ |
  | 67 |  | ~~if (isset($\_GET['swpm\_ppcp\_sandbox\_disconnect'])){~~ |
  | 68 |  | ~~//Verify nonce~~ |
  | 69 |  | ~~check\_admin\_referer( 'swpm\_sandbox\_ac\_disconnect\_nonce' );~~ |
  | 70 |  |  |
  | 71 |  | ~~SWPM\_PayPal\_PPCP\_Onboarding\_Serverside::reset\_seller\_api\_credentials('sandbox');~~ |
  | 72 |  | ~~$disconnect\_action\_result = '<p>PayPal sandbox account disconnected.</p>';~~ |
  | 73 |  | ~~$disconnect\_action\_result .= '<p><a href="#paypal-ppcp-connection-section">Click here</a> to go to the PayPal Account Setup section below.</p>';~~ |
  | 74 |  | ~~echo '<div class="swpm-yellow-box"><p>' . $disconnect\_action\_result . '</p></div>';~~ |
  | 75 |  | ~~}~~ |
  | 76 | 4 | ?> |
  | 77 |  |  |
  | 78 |  | <!-- render the rest of the settings fields for tab-2 --> |
  | 79 |  | <form action="options.php" method="POST"> |
  | 80 |  | <input type="hidden" name="tab" value="2" /> |
  | 81 |  | <?php settings\_fields('swpm-settings-tab-' . $current\_tab); ?> |
  | 82 |  | <?php do\_settings\_sections('simple\_wp\_membership\_settings'); ?> |
  | 83 |  | <?php submit\_button(); ?> |
  | 84 |  | </form> |
  |  | 5 | <div class="swpm-yellow-box"> |
  |  | 6 | <p> |
  |  | 7 | <?php \_e('The payment settings have moved to the <b>Payment Settings</b> tab in the <strong>Payments</strong> menu. Click the link below to navigate to the new location.','simple-membership');?> |
  |  | 8 | </p> |
  |  | 9 | <p> |
  |  | 10 | <a class="button-primary" href="admin.php?page=simple\_wp\_membership\_payments&tab=payment\_settings"><?php \_e('Go to the new Payment Settings location','simple-membership');?></a> |
  |  | 11 | </p> |
  |  | 12 | </div> |
  |  | 13 | <?php |
* ## [simple-membership/trunk/views/payments/payment-gateway/paypal\_buy\_now\_new\_button\_shortcode\_view.php](/changeset/3010737/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php "Show the changeset 3010737 restricted to simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php")

  | [r2994826](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=2994826#L105 "Show revision 2994826 of this file in browser") | [r3010737](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737#L105 "Show revision 3010737 of this file in browser") |  |
  | --- | --- | --- |
  | 105 | 105 | $on\_page\_embed\_button\_id = $pp\_js\_button->get\_next\_button\_id(); |
  | 106 | 106 | //Create nonce for this button. |
  | 107 |  | $nonce = wp\_create\_nonce($on\_page\_embed\_button\_id); |
  |  | 107 | $wp\_nonce = wp\_create\_nonce($on\_page\_embed\_button\_id); |
  | 108 | 108 |  |
  | 109 | 109 | $output = ''; |
  | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=2994826#L121) | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737#L121) |  |
  | 121 | 121 | $( document ).on( "swpm\_paypal\_sdk\_loaded", function() { |
  | 122 | 122 | //Anything that goes here will only be executed after the PayPal SDK is loaded. |
  |  | 123 | console.log('PayPal JS SDK is loaded.'); |
  | 123 | 124 |  |
  | 124 | 125 | var js\_currency\_code = '<?php echo esc\_js($currency); ?>'; |
  | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=2994826#L137) | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737#L138) |  |
  | 137 | 138 | layout: '<?php echo esc\_js($btn\_layout); ?>', |
  | 138 | 139 | }, |
  | 139 |  |  |
  | 140 |  | // set up the transaction |
  | 141 |  | createOrder: function(data, actions) { |
  | 142 |  | // Create the order |
  | 143 |  | // https://developer.paypal.com/docs/api/orders/v2/#orders\_create |
  | 144 |  | var order\_data = { |
  | 145 |  | intent: 'CAPTURE', |
  | 146 |  | purchase\_units: [{ |
  | 147 |  | amount: { |
  | 148 |  | value: js\_payment\_amount, |
  | 149 |  | currency\_code: '<?php echo esc\_js($currency); ?>', |
  | 150 |  | breakdown: { |
  | 151 |  | item\_total: { |
  | 152 |  | currency\_code: '<?php echo esc\_js($currency); ?>', |
  | 153 |  | value: js\_payment\_amount \* js\_quantity, |
  | 154 |  | } |
  | 155 |  | } |
  |  | 140 |  |
  |  | 141 | // Setup the transaction. |
  |  | 142 | async createOrder() { |
  |  | 143 | // Create the order in PayPal using the PayPal API. |
  |  | 144 | // https://developer.paypal.com/docs/checkout/standard/integrate/ |
  |  | 145 | // The server-side Create Order API is used to generate the Order. Then the Order-ID is returned. |
  |  | 146 | console.log('Setting up the AJAX request for create-order call.'); |
  |  | 147 | let pp\_bn\_data = {}; |
  |  | 148 | pp\_bn\_data.button\_id = '<?php echo esc\_js($button\_id); ?>'; |
  |  | 149 | pp\_bn\_data.on\_page\_button\_id = '<?php echo esc\_js($on\_page\_embed\_button\_id); ?>'; |
  |  | 150 | pp\_bn\_data.item\_name = '<?php echo esc\_js($item\_name); ?>'; |
  |  | 151 | let post\_data = 'action=swpm\_pp\_create\_order&data=' + JSON.stringify(pp\_bn\_data) + '&\_wpnonce=<?php echo $wp\_nonce; ?>'; |
  |  | 152 | try { |
  |  | 153 | // Using fetch for AJAX request. This is supported in all modern browsers. |
  |  | 154 | const response = await fetch("<?php echo admin\_url( 'admin-ajax.php' ); ?>", { |
  |  | 155 | method: "post", |
  |  | 156 | headers: { |
  |  | 157 | 'Content-Type': 'application/x-www-form-urlencoded' |
  | 156 | 158 | }, |
  | 157 |  | items: [{ |
  | 158 |  | name: '<?php echo esc\_js($item\_name); ?>', |
  | 159 |  | quantity: js\_quantity, |
  | 160 |  | unit\_amount: { |
  | 161 |  | value: js\_payment\_amount, |
  | 162 |  | currency\_code: '<?php echo esc\_js($currency); ?>', |
  | 163 |  | } |
  | 164 |  | }], |
  | 165 |  | description: '<?php echo esc\_js($item\_name); ?>', |
  | 166 |  | }] |
  | 167 |  | }; |
  | 168 |  | return actions.order.create( order\_data ); |
  |  | 159 | body: post\_data |
  |  | 160 | }); |
  |  | 161 |  |
  |  | 162 | const response\_data = await response.json(); |
  |  | 163 |  |
  |  | 164 | if (response\_data.order\_id) { |
  |  | 165 | console.log('Create-order API call to PayPal completed successfully.'); |
  |  | 166 | //If we need to see the order details, uncomment the following line. |
  |  | 167 | //const order\_data = response\_data.order\_data; |
  |  | 168 | //console.log('Order data: ' + JSON.stringify(order\_data)); |
  |  | 169 | return response\_data.order\_id; |
  |  | 170 | } else { |
  |  | 171 | const error\_message = JSON.stringify(response\_data); |
  |  | 172 | throw new Error(error\_message); |
  |  | 173 | } |
  |  | 174 | } catch (error) { |
  |  | 175 | console.error(error); |
  |  | 176 | alert('Could not initiate PayPal Checkout...\n\n' + error); |
  |  | 177 | } |
  | 169 | 178 | }, |
  | 170 | 179 |  |
  | 171 |  | // ~~notify the buyer that the subscription is successful~~ |
  | 172 |  | ~~onApprove: function~~(data, actions) { |
  |  | 180 | // handle the onApprove event |
  |  | 181 | async onApprove(data, actions) { |
  | 173 | 182 | console.log('Successfully created a transaction.'); |
  | 174 | 183 |  |
  | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=2994826#L179) | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737#L188) |  |
  | 179 | 188 | pp\_button\_spinner\_conainer.css('display', 'inline-block');//Show the spinner. |
  | 180 | 189 |  |
  | 181 |  | //Get the order/transaction details and send AJAX request to process the transaction. |
  | 182 |  | actions.order.capture().then( function( txn\_data ) { |
  | 183 |  | //console.log( 'Transaction details: ' + JSON.stringify( txn\_data ) ); |
  | 184 |  |  |
  | 185 |  | //Ajax request to process the transaction. This will process it similar to how an IPN request is handled. |
  | 186 |  | var custom = document.getElementById('<?php echo esc\_attr($on\_page\_embed\_button\_id."-custom-field"); ?>').value; |
  | 187 |  | data.custom\_field = custom; |
  | 188 |  | data.button\_id = '<?php echo esc\_js($button\_id); ?>'; |
  | 189 |  | data.on\_page\_button\_id = '<?php echo esc\_js($on\_page\_embed\_button\_id); ?>'; |
  | 190 |  | data.item\_name = '<?php echo esc\_js($item\_name); ?>'; |
  | 191 |  | jQuery.post( '<?php echo admin\_url('admin-ajax.php'); ?>', { action: 'swpm\_onapprove\_create\_order', data: data, txn\_data: txn\_data, \_wpnonce: '<?php echo $nonce; ?>'}, function( response ) { |
  | 192 |  | //console.log( 'Response from the server: ' + JSON.stringify( response ) ); |
  | 193 |  | if ( response.success ) { |
  | 194 |  | //Success response. |
  | 195 |  |  |
  | 196 |  | //Redirect to the Thank you page URL if it is set. |
  | 197 |  | return\_url = '<?php echo esc\_url\_raw($return\_url); ?>'; |
  | 198 |  | if( return\_url ){ |
  | 199 |  | //redirect to the Thank you page URL. |
  | 200 |  | console.log('Redirecting to the Thank you page URL: ' + return\_url); |
  | 201 |  | window.location.href = return\_url; |
  | 202 |  | return; |
  | 203 |  | } else { |
  | 204 |  | //No return URL is set. Just show a success message. |
  | 205 |  | txn\_success\_msg = '<?php echo esc\_attr($txn\_success\_message); ?>'; |
  | 206 |  | alert(txn\_success\_msg); |
  | 207 |  | } |
  | 208 |  |  |
  |  | 190 | // Capture the order in PayPal using the PayPal API. |
  |  | 191 | // https://developer.paypal.com/docs/checkout/standard/integrate/ |
  |  | 192 | // The server-side capture-order API is used. Then the Capture-ID is returned. |
  |  | 193 | console.log('Setting up the AJAX request for capture-order call.'); |
  |  | 194 | let pp\_bn\_data = {}; |
  |  | 195 | pp\_bn\_data.order\_id = data.orderID; |
  |  | 196 | pp\_bn\_data.button\_id = '<?php echo esc\_js($button\_id); ?>'; |
  |  | 197 | pp\_bn\_data.on\_page\_button\_id = '<?php echo esc\_js($on\_page\_embed\_button\_id); ?>'; |
  |  | 198 | pp\_bn\_data.item\_name = '<?php echo esc\_js($item\_name); ?>'; |
  |  | 199 | //Add custom\_field data. It is important to encode the custom\_field data so it doesn't mess up the data with & character. |
  |  | 200 | const custom\_data = document.getElementById('<?php echo esc\_attr($on\_page\_embed\_button\_id."-custom-field"); ?>').value; |
  |  | 201 | pp\_bn\_data.custom\_field = encodeURIComponent(custom\_data); |
  |  | 202 | let post\_data = 'action=swpm\_pp\_capture\_order&data=' + JSON.stringify(pp\_bn\_data) + '&\_wpnonce=<?php echo $wp\_nonce; ?>'; |
  |  | 203 | try { |
  |  | 204 | const response = await fetch("<?php echo admin\_url( 'admin-ajax.php' ); ?>", { |
  |  | 205 | method: "post", |
  |  | 206 | headers: { |
  |  | 207 | 'Content-Type': 'application/x-www-form-urlencoded' |
  |  | 208 | }, |
  |  | 209 | body: post\_data |
  |  | 210 | }); |
  |  | 211 |  |
  |  | 212 | const response\_data = await response.json(); |
  |  | 213 | const txn\_data = response\_data.txn\_data; |
  |  | 214 | const error\_detail = txn\_data?.details?.[0]; |
  |  | 215 | const error\_msg = response\_data.error\_msg;//Our custom error message. |
  |  | 216 | // Three cases to handle: |
  |  | 217 | // (1) Recoverable INSTRUMENT\_DECLINED -> call actions.restart() |
  |  | 218 | // (2) Other non-recoverable errors -> Show a failure message |
  |  | 219 | // (3) Successful transaction -> Show confirmation or thank you message |
  |  | 220 |  |
  |  | 221 | if (response\_data.capture\_id) { |
  |  | 222 | // Successful transaction -> Show confirmation or thank you message |
  |  | 223 | console.log('Capture-order API call to PayPal completed successfully.'); |
  |  | 224 |  |
  |  | 225 | //Redirect to the Thank you page URL if it is set. |
  |  | 226 | return\_url = '<?php echo esc\_url\_raw($return\_url); ?>'; |
  |  | 227 | if( return\_url ){ |
  |  | 228 | //redirect to the Thank you page URL. |
  |  | 229 | console.log('Redirecting to the Thank you page URL: ' + return\_url); |
  |  | 230 | window.location.href = return\_url; |
  |  | 231 | return; |
  | 209 | 232 | } else { |
  | 210 |  | //~~Error response from the AJAX IPN hanler. Show the error~~ message. |
  | 211 |  | ~~console.log( 'Error response: ' + JSON.stringify( response.err\_msg ) )~~; |
  | 212 |  | alert(~~JSON.stringify( response )~~ ); |
  |  | 233 | //No return URL is set. Just show a success message. |
  |  | 234 | txn\_success\_msg = '<?php echo esc\_attr($txn\_success\_message); ?>'; |
  |  | 235 | alert(txn\_success\_msg); |
  | 213 | 236 | } |
  | 214 | 237 |  |
  | 215 |  | //Return the button and the spinner back to their orignal display state. |
  | 216 |  | pp\_button\_container.show();//Show the buttons |
  | 217 |  | pp\_button\_spinner\_conainer.hide();//Hide the spinner. |
  | 218 |  |  |
  | 219 |  | }); |
  | 220 |  |  |
  | 221 |  | }); |
  |  | 238 | } else if (error\_detail?.issue === "INSTRUMENT\_DECLINED") { |
  |  | 239 | // Recoverable INSTRUMENT\_DECLINED -> call actions.restart() |
  |  | 240 | console.log('Recoverable INSTRUMENT\_DECLINED error. Calling actions.restart()'); |
  |  | 241 | return actions.restart(); |
  |  | 242 | } else if ( error\_msg && error\_msg.trim() !== '' ) { |
  |  | 243 | //Our custom error message from the server. |
  |  | 244 | console.error('Error occurred during PayPal checkout process.'); |
  |  | 245 | console.error( error\_msg ); |
  |  | 246 | alert( error\_msg ); |
  |  | 247 | } else { |
  |  | 248 | // Other non-recoverable errors -> Show a failure message |
  |  | 249 | console.error('Non-recoverable error occurred during PayPal checkout process.'); |
  |  | 250 | console.error( error\_detail ); |
  |  | 251 | //alert('Error occurred with the transaction. Enable debug logging to get more details.\n\n' + JSON.stringify(error\_detail)); |
  |  | 252 | } |
  |  | 253 |  |
  |  | 254 | //Return the button and the spinner back to their orignal display state. |
  |  | 255 | pp\_button\_container.show();//Show the buttons |
  |  | 256 | pp\_button\_spinner\_conainer.hide();//Hide the spinner. |
  |  | 257 |  |
  |  | 258 | } catch (error) { |
  |  | 259 | console.error(error); |
  |  | 260 | alert('Sorry, your transaction could not be processed...\n\n' + error); |
  |  | 261 | } |
  | 222 | 262 | }, |
  | 223 | 263 |  |
  | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=2994826#L230) | […](/browser/simple-membership/trunk/views/payments/payment-gateway/paypal_buy_now_new_button_shortcode_view.php?rev=3010737#L270) |  |
  | 230 | 270 | // handle onCancel event |
  | 231 | 271 | onCancel: function(data) { |
  | 232 |  | console.log('Checkout operation cancelled by the customer.~~Data: ' + JSON.stringify(data)~~); |
  |  | 272 | console.log('Checkout operation cancelled by the customer.'); |
  | 233 | 273 | //Return to the parent page which the button does by default. |
  | 234 | 274 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3010737)
* [Zip Archive](?format=zip&new=3010737)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_55ab5209_20250114_191003.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Simple Membership <= 4.3.8 - Reflected Cross-Site Scripting Vulnerability via environment\_mode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Simple Membership <= 4.3.8 - Reflected Cross-Site Scripting Vulnerability via environment\_mode

6.1

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-6882](https://www.cve.org/CVERecord?id=CVE-2023-6882) |
| --- | --- |
| CVSS | 6.1 (Medium) |
| Publicly Published | December 18, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Rein Daelman (trein)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/rein-daelman) |

### Description

The Simple Membership plugin for WordPress is vulnerable to Reflected Cross-Site Scripting via the ‘environment\_mode’ parameter in all versions up to, and including, 4.3.8 due to insufficient input sanitization and output escaping. This makes it possible for unauthenticated attackers to inject arbitrary web scripts in pages that execute if they can successfully trick a user into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3010737/simple-membership)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-membership%2Fsimple-membership-438-reflected-cross-site-scripting-vulnerability-via-environment-mode&t=Simple%20Membership%20%3C%3D%204.3.8%20-%20Reflected%20Cross-Site%20Scripting%20Vulnerability%20via%20environment_mode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-membership%2Fsimple-membership-438-reflected-cross-site-scripting-vulnerability-via-environment-mode&text=Simple%20Membership%20%3C%3D%204.3.8%20-%20Reflected%20Cross-Site%20Scripting%20Vulnerability%20via%20environment_mode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fsimple-membership%2Fsimple-membership-438-reflected-cross-site-scripting-vulnerability-via-environment-mode "LinkedIn")
Email

## Vulnerability Details for Simple Membership

#### [Simple Membership](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/simple-membership)

| Software Type | Plugin |
| --- | --- |
| Software Slug | simple-membership [(view on wordpress.org)](https://wordpress.org/plugins/simple-membership) |
| Patched? | Yes |
| Remediation | Update to version 4.3.9, or a newer patched version |
| Affected Version | * <= 4.3.8 |
| Patched Version | * 4.3.9 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


