=== Content from github.com_99ca4aa4_20250114_182801.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fprefecthq%2Fprefect%2Fcommit%2F227dfcc7e3374c212a4bcd68b14e090b1c02d9d3)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fprefecthq%2Fprefect%2Fcommit%2F227dfcc7e3374c212a4bcd68b14e090b1c02d9d3)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=PrefectHQ%2Fprefect)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[PrefectHQ](/PrefectHQ)
/
**[prefect](/PrefectHQ/prefect)**
Public

* [Notifications](/login?return_to=%2FPrefectHQ%2Fprefect) You must be signed in to change notification settings
* [Fork
  1.7k](/login?return_to=%2FPrefectHQ%2Fprefect)
* [Star
   18k](/login?return_to=%2FPrefectHQ%2Fprefect)

* [Code](/PrefectHQ/prefect)
* [Issues
  935](/PrefectHQ/prefect/issues)
* [Pull requests
  35](/PrefectHQ/prefect/pulls)
* [Discussions](/PrefectHQ/prefect/discussions)
* [Actions](/PrefectHQ/prefect/actions)
* [Security](/PrefectHQ/prefect/security)
* [Insights](/PrefectHQ/prefect/pulse)

Additional navigation options

* [Code](/PrefectHQ/prefect)
* [Issues](/PrefectHQ/prefect/issues)
* [Pull requests](/PrefectHQ/prefect/pulls)
* [Discussions](/PrefectHQ/prefect/discussions)
* [Actions](/PrefectHQ/prefect/actions)
* [Security](/PrefectHQ/prefect/security)
* [Insights](/PrefectHQ/prefect/pulse)

## Commit

[Permalink](/PrefectHQ/prefect/commit/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add CSRF support to orchestration client ([#12314](https://github.com/PrefectHQ/prefect/pull/12314))

[Browse files](/PrefectHQ/prefect/tree/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3)
Browse the repository at this point in the history

* Loading branch information

[![@bunchesofdonald](https://avatars.githubusercontent.com/u/354286?s=40&v=4)](/bunchesofdonald)

[bunchesofdonald](/PrefectHQ/prefect/commits?author=bunchesofdonald "View all commits by bunchesofdonald")
authored
Mar 18, 2024

1 parent
[e04c2cb](/PrefectHQ/prefect/commit/e04c2cbe146b679cf7048e370537ec413dedc721)

commit 227dfcc

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**362 additions**
and
**19 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src/prefect

  + client

    - src/prefect/client/base.py
      [base.py](#diff-c7202e918a26b08ee22425b63adfa8c3392b04e15b4780466cb879a8f8d72194)
    - src/prefect/client/cloud.py
      [cloud.py](#diff-5a511ac64f00b69748c693dfcb62f815958978fea3a9abe42e0698d298f55d13)
    - src/prefect/client/orchestration.py
      [orchestration.py](#diff-a52d8326344d84ccd617e704df9a030fd4a813a8d705510f778538423e7cf21d)
    - schemas

      * src/prefect/client/schemas/objects.py
        [objects.py](#diff-ef5a2fbfd2a049d62f31acff73d7cb79c7f0c5532f167854b1d1be16452105c6)
  + src/prefect/settings.py
    [settings.py](#diff-652b63566d2fcd4e36ea4e8509b4e0cd56e607b9e54e043acbde5bb6907a599b)
* tests

  + cli

    - tests/cli/test\_worker.py
      [test\_worker.py](#diff-66be2eeab9fe5009824e8d5040a54c014d766faa108693c7953707ec1b0bbb62)
  + client

    - tests/client/test\_base\_client.py
      [test\_base\_client.py](#diff-f3afda7e8e6866a06eb1a39ea800e8ac1d58a2c412caec280b1d4f3e98810a65)
    - tests/client/test\_prefect\_client.py
      [test\_prefect\_client.py](#diff-78da5d958809b7f163aa49ffcff0ee9a7d854fada6be1e0286e039dfa51d78b4)
  + tests/test\_deployments.py
    [test\_deployments.py](#diff-26563fecc56512b2fcb65c63773494a3aba065ffbb88eff2e36fddc46672563b)

## There are no files selected for viewing

83 changes: 73 additions & 10 deletions

83
[src/prefect/client/base.py](#diff-c7202e918a26b08ee22425b63adfa8c3392b04e15b4780466cb879a8f8d72194 "src/prefect/client/base.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/src/prefect/client/base.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,16 +1,18 @@ |
|  |  | import copy |
|  |  | import sys |
|  |  | import threading |
|  |  | import uuid |
|  |  | from collections import defaultdict |
|  |  | from contextlib import asynccontextmanager |
|  |  | from functools import partial |
|  |  | from datetime import datetime, timezone |
|  |  | from typing import ( |
|  |  | Any, |
|  |  | AsyncGenerator, |
|  |  | Awaitable, |
|  |  | Callable, |
|  |  | Dict, |
|  |  | MutableMapping, |
|  |  | Optional, |
|  |  | Protocol, |
|  |  | Set, |
|  |  | Tuple, |
| Expand All | | @@ -21,10 +23,11 @@ |
|  |  | import anyio |
|  |  | import httpx |
|  |  | from asgi\_lifespan import LifespanManager |
|  |  | from httpx import HTTPStatusError, Response |
|  |  | from httpx import HTTPStatusError, Request, Response |
|  |  | from prefect.\_vendor.starlette import status |
|  |  | from typing\_extensions import Self |
|  |  |  |
|  |  | from prefect.client.schemas.objects import CsrfToken |
|  |  | from prefect.exceptions import PrefectHTTPStatusError |
|  |  | from prefect.logging import get\_logger |
|  |  | from prefect.settings import ( |
| Expand Down  Expand Up | | @@ -188,9 +191,20 @@ class PrefectHttpxClient(httpx.AsyncClient): |
|  |  | [Configuring Cloudflare Rate Limiting](https://support.cloudflare.com/hc/en-us/articles/115001635128-Configuring-Rate-Limiting-from-UI) |
|  |  | """ |
|  |  |  |
|  |  | def \_\_init\_\_(self, \*args, enable\_csrf\_support: bool = False, \*\*kwargs): |
|  |  | self.enable\_csrf\_support: bool = enable\_csrf\_support |
|  |  | self.csrf\_token: Optional[str] = None |
|  |  | self.csrf\_token\_expiration: Optional[datetime] = None |
|  |  | self.csrf\_client\_id: uuid.UUID = uuid.uuid4() |
|  |  |  |
|  |  | super().\_\_init\_\_(\*args, \*\*kwargs) |
|  |  |  |
|  |  | async def \_send\_with\_retry( |
|  |  | self, |
|  |  | request: Callable, |
|  |  | request: Request, |
|  |  | send: Callable[[Request], Awaitable[Response]], |
|  |  | send\_args: Tuple, |
|  |  | send\_kwargs: Dict, |
|  |  | retry\_codes: Set[int] = set(), |
|  |  | retry\_exceptions: Tuple[Exception, ...] = tuple(), |
|  |  | ): |
| Expand All | | @@ -207,21 +221,34 @@ async def \_send\_with\_retry( |
|  |  | try\_count = 0 |
|  |  | response = None |
|  |  |  |
|  |  | is\_change\_request = request.method.lower() in {"post", "put", "patch", "delete"} |
|  |  |  |
|  |  | if self.enable\_csrf\_support and is\_change\_request: |
|  |  | await self.\_add\_csrf\_headers(request=request) |
|  |  |  |
|  |  | while try\_count <= PREFECT\_CLIENT\_MAX\_RETRIES.value(): |
|  |  | try\_count += 1 |
|  |  | retry\_seconds = None |
|  |  | exc\_info = None |
|  |  |  |
|  |  | try: |
|  |  | response = await request() |
|  |  | response = await send(request, \*send\_args, \*\*send\_kwargs) |
|  |  | except retry\_exceptions: # type: ignore |
|  |  | if try\_count > PREFECT\_CLIENT\_MAX\_RETRIES.value(): |
|  |  | raise |
|  |  | # Otherwise, we will ignore this error but capture the info for logging |
|  |  | exc\_info = sys.exc\_info() |
|  |  | else: |
|  |  | # We got a response; return immediately if it is not retryable |
|  |  | if response.status\_code not in retry\_codes: |
|  |  | # We got a response; check if it's a CSRF error, otherwise |
|  |  | # return immediately if it is not retryable |
|  |  | if ( |
|  |  | response.status\_code == status.HTTP\_403\_FORBIDDEN |
|  |  | and "Invalid CSRF token" in response.text |
|  |  | ): |
|  |  | # We got a CSRF error, clear the token and try again |
|  |  | self.csrf\_token = None |
|  |  | await self.\_add\_csrf\_headers(request) |
|  |  | elif response.status\_code not in retry\_codes: |
|  |  | return response |
|  |  |  |
|  |  | if "Retry-After" in response.headers: |
| Expand Down  Expand Up | | @@ -268,19 +295,24 @@ async def \_send\_with\_retry( |
|  |  | # We ran out of retries, return the failed response |
|  |  | return response |
|  |  |  |
|  |  | async def send(self, \*args, \*\*kwargs) -> Response: |
|  |  | async def send(self, request: Request, \*args, \*\*kwargs) -> Response: |
|  |  | """ |
|  |  | Send a request with automatic retry behavior for the following status codes: |
|  |  |  |
|  |  | - 403 Forbidden, if the request failed due to CSRF protection |
|  |  | - 408 Request Timeout |
|  |  | - 429 CloudFlare-style rate limiting |
|  |  | - 502 Bad Gateway |
|  |  | - 503 Service unavailable |
|  |  | - Any additional status codes provided in `PREFECT\_CLIENT\_RETRY\_EXTRA\_CODES` |
|  |  | """ |
|  |  |  |
|  |  | api\_request = partial(super().send, \*args, \*\*kwargs) |
|  |  |  |
|  |  | super\_send = super().send |
|  |  | response = await self.\_send\_with\_retry( |
|  |  | request=api\_request, |
|  |  | request=request, |
|  |  | send=super\_send, |
|  |  | send\_args=args, |
|  |  | send\_kwargs=kwargs, |
|  |  | retry\_codes={ |
|  |  | status.HTTP\_429\_TOO\_MANY\_REQUESTS, |
|  |  | status.HTTP\_503\_SERVICE\_UNAVAILABLE, |
| Expand Down  Expand Up | | @@ -312,3 +344,34 @@ async def send(self, \*args, \*\*kwargs) -> Response: |
|  |  | response.raise\_for\_status() |
|  |  |  |
|  |  | return response |
|  |  |  |
|  |  | async def \_add\_csrf\_headers(self, request: Request): |
|  |  | now = datetime.now(timezone.utc) |
|  |  |  |
|  |  | if not self.enable\_csrf\_support: |
|  |  | return |
|  |  |  |
|  |  | if not self.csrf\_token or ( |
|  |  | self.csrf\_token\_expiration and now > self.csrf\_token\_expiration |
|  |  | ): |
|  |  | token\_request = self.build\_request( |
|  |  | "GET", f"/csrf-token?client={self.csrf\_client\_id}" |
|  |  | ) |
|  |  |  |
|  |  | try: |
|  |  | token\_response = await self.send(token\_request) |
|  |  | except PrefectHTTPStatusError as exc: |
|  |  | if exc.response.status\_code == status.HTTP\_404\_NOT\_FOUND: |
|  |  | # The token endpoint is not available, likely an older |
|  |  | # server version; disable CSRF support |
|  |  | self.enable\_csrf\_support = False |
|  |  | return |
|  |  |  |
|  |  | raise |
|  |  |  |
|  |  | token: CsrfToken = CsrfToken.parse\_obj(token\_response.json()) |
|  |  | self.csrf\_token = token.token |
|  |  | self.csrf\_token\_expiration = token.expiration |
|  |  |  |
|  |  | request.headers["Prefect-Csrf-Token"] = self.csrf\_token |
|  |  | request.headers["Prefect-Csrf-Client"] = str(self.csrf\_client\_id) |

2 changes: 1 addition & 1 deletion

2
[src/prefect/client/cloud.py](#diff-5a511ac64f00b69748c693dfcb62f815958978fea3a9abe42e0698d298f55d13 "src/prefect/client/cloud.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/src/prefect/client/cloud.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -72,7 +72,7 @@ def \_\_init\_\_( |
|  |  | httpx\_settings.setdefault("base\_url", host) |
|  |  | if not PREFECT\_UNIT\_TEST\_MODE.value(): |
|  |  | httpx\_settings.setdefault("follow\_redirects", True) |
|  |  | self.\_client = PrefectHttpxClient(\*\*httpx\_settings) |
|  |  | self.\_client = PrefectHttpxClient(\*\*httpx\_settings, enable\_csrf\_support=False) |
|  |  |  |
|  |  | async def api\_healthcheck(self): |
|  |  | """ |
| Expand Down | |  |

11 changes: 10 additions & 1 deletion

11
[src/prefect/client/orchestration.py](#diff-a52d8326344d84ccd617e704df9a030fd4a813a8d705510f778538423e7cf21d "src/prefect/client/orchestration.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/src/prefect/client/orchestration.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -136,6 +136,7 @@ |
|  |  | PREFECT\_API\_REQUEST\_TIMEOUT, |
|  |  | PREFECT\_API\_TLS\_INSECURE\_SKIP\_VERIFY, |
|  |  | PREFECT\_API\_URL, |
|  |  | PREFECT\_CLIENT\_CSRF\_SUPPORT\_ENABLED, |
|  |  | PREFECT\_CLOUD\_API\_URL, |
|  |  | PREFECT\_UNIT\_TEST\_MODE, |
|  |  | ) |
| Expand Down  Expand Up | | @@ -316,7 +317,15 @@ def \_\_init\_\_( |
|  |  |  |
|  |  | if not PREFECT\_UNIT\_TEST\_MODE: |
|  |  | httpx\_settings.setdefault("follow\_redirects", True) |
|  |  | self.\_client = PrefectHttpxClient(\*\*httpx\_settings) |
|  |  |  |
|  |  | enable\_csrf\_support = ( |
|  |  | self.server\_type != ServerType.CLOUD |
|  |  | and PREFECT\_CLIENT\_CSRF\_SUPPORT\_ENABLED.value() |
|  |  | ) |
|  |  |  |
|  |  | self.\_client = PrefectHttpxClient( |
|  |  | \*\*httpx\_settings, enable\_csrf\_support=enable\_csrf\_support |
|  |  | ) |
|  |  | self.\_loop = None |
|  |  |  |
|  |  | # See https://www.python-httpx.org/advanced/#custom-transports |
| Expand Down | |  |

13 changes: 13 additions & 0 deletions

13
[src/prefect/client/schemas/objects.py](#diff-ef5a2fbfd2a049d62f31acff73d7cb79c7f0c5532f167854b1d1be16452105c6 "src/prefect/client/schemas/objects.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/src/prefect/client/schemas/objects.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1632,3 +1632,16 @@ class GlobalConcurrencyLimit(ObjectBaseModel): |
|  |  | " is used as a rate limit." |
|  |  | ), |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | class CsrfToken(ObjectBaseModel): |
|  |  | token: str = Field( |
|  |  | default=..., |
|  |  | description="The CSRF token", |
|  |  | ) |
|  |  | client: str = Field( |
|  |  | default=..., description="The client id associated with the CSRF token" |
|  |  | ) |
|  |  | expiration: DateTimeTZ = Field( |
|  |  | default=..., description="The expiration time of the CSRF token" |
|  |  | ) |

41 changes: 38 additions & 3 deletions

41
[src/prefect/settings.py](#diff-652b63566d2fcd4e36ea4e8509b4e0cd56e607b9e54e043acbde5bb6907a599b "src/prefect/settings.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/src/prefect/settings.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -657,6 +657,21 @@ def default\_cloud\_ui\_url(settings, value): |
|  |  | may result in unexpected behavior. |
|  |  | """ |
|  |  |  |
|  |  | PREFECT\_CLIENT\_CSRF\_SUPPORT\_ENABLED = Setting(bool, default=True) |
|  |  | """ |
|  |  | Determines if CSRF token handling is active in the Prefect client for API |
|  |  | requests. |
|  |  |  |
|  |  | When enabled (`True`), the client automatically manages CSRF tokens by |
|  |  | retrieving, storing, and including them in applicable state-changing requests |
|  |  | (POST, PUT, PATCH, DELETE) to the API. |
|  |  |  |
|  |  | Disabling this setting (`False`) means the client will not handle CSRF tokens, |
|  |  | which might be suitable for environments where CSRF protection is disabled. |
|  |  |  |
|  |  | Defaults to `True`, ensuring CSRF protection is enabled by default. |
|  |  | """ |
|  |  |  |
|  |  | PREFECT\_CLOUD\_API\_URL = Setting( |
|  |  | str, |
|  |  | default="https://api.prefect.cloud/api", |
| Expand Down  Expand Up | | @@ -1208,11 +1223,31 @@ def default\_cloud\_ui\_url(settings, value): |
|  |  | """ |
|  |  |  |
|  |  | PREFECT\_SERVER\_CSRF\_PROTECTION\_ENABLED = Setting(bool, default=False) |
|  |  | """Whether or not to protect the API from CSRF attacks. Experimental and |
|  |  | currently defaults to `False`.""" |
|  |  | """ |
|  |  | Controls the activation of CSRF protection for the Prefect server API. |
|  |  |  |
|  |  | When enabled (`True`), the server enforces CSRF validation checks on incoming |
|  |  | state-changing requests (POST, PUT, PATCH, DELETE), requiring a valid CSRF |
|  |  | token to be included in the request headers or body. This adds a layer of |
|  |  | security by preventing unauthorized or malicious sites from making requests on |
|  |  | behalf of authenticated users. |
|  |  |  |
|  |  | It is recommended to enable this setting in production environments where the |
|  |  | API is exposed to web clients to safeguard against CSRF attacks. |
|  |  |  |
|  |  | Note: Enabling this setting requires corresponding support in the client for |
|  |  | CSRF token management. See PREFECT\_CLIENT\_CSRF\_SUPPORT\_ENABLED for more. |
|  |  | """ |
|  |  |  |
|  |  | PREFECT\_SERVER\_CSRF\_TOKEN\_EXPIRATION = Setting(timedelta, default=timedelta(hours=1)) |
|  |  | """How long a CSRF token is valid for. Defaults to 1 hour.""" |
|  |  | """ |
|  |  | Specifies the duration for which a CSRF token remains valid after being issued |
|  |  | by the server. |
|  |  |  |
|  |  | The default expiration time is set to 1 hour, which offers a reasonable |
|  |  | compromise. Adjust this setting based on your specific security requirements |
|  |  | and usage patterns. |
|  |  | """ |
|  |  |  |
|  |  | PREFECT\_UI\_ENABLED = Setting( |
|  |  | bool, |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[tests/cli/test\_worker.py](#diff-66be2eeab9fe5009824e8d5040a54c014d766faa108693c7953707ec1b0bbb62 "tests/cli/test_worker.py")

Show comments

[View file](/PrefectHQ/prefect/blob/227dfcc7e3374c212a4bcd68b14e090b1c02d9d3/tests/cli/test_worker.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -67,6 +67,7 @@ async def kubernetes\_work\_pool(prefect\_client: PrefectClient): |
|  |  | with respx.mock( |
|  |  | assert\_all\_mocked=False, base\_url=PREFECT\_API\_URL.value() |
|  |  | ) as respx\_mock: |
|  |  | respx\_mock.get("/csrf-token", params={"client": ANY}).pass\_through() |
|  |  | respx\_mock.route(path\_\_startswith="/work\_pools/").pass\_through() |
|  |  | respx\_mock.route(path\_\_startswith="/flow\_runs/").pass\_through() |
|  |  | respx\_mock.get("/collections/views/aggregate-worker-metadata").mock( |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `227dfcc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fprefecthq%2Fprefect%2Fcommit%2F227dfcc7e3374c212a4bcd68b14e090b1c02d9d3) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from huntr.com_7f40c466_20250114_182802.html ===


* [![logo](/horizontal-logo-wh.svg)](/)
* [Bounties](/bounties)
* [Partners](/partners)
* Community
* Info
[SUBMIT REPORT](/bounties/disclose)

Supported by [Protect AI](https://protectai.com/) and leading the way to [MLSecOps](https://mlsecops.com) and greater AI security.

© 2024

[Privacy Policy](/privacy)[Terms of Service](/terms)[Code of Conduct](/code-of-conduct)Cookie Preferences[Contact Us](/contact-us)
