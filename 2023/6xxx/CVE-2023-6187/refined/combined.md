=== Content from plugins.trac.wordpress.org_ef094fb2_20250114_192706.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2997319%2Fpaid-memberships-pro%2Ftags%2F2.12.4%2Fincludes%2Ffields.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2974438/paid-memberships-pro/trunk/includes/fields.php "Changeset 2974438 for paid-memberships-pro/tags/2.12.4/includes/fields.php")
* Next Change →

---

# Changeset [2997319](/changeset/2997319 "Show full changeset") for [paid-memberships-pro/tags/2.12.4/includes/fields.php](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/16/2023 09:10:45 PM
([14 months](/timeline?from=2023-11-16T21%3A10%3A45Z&precision=second "See timeline at 11/16/2023 09:10:45 PM") ago)

Author:
strangerstudios
Message:

2.12.4 File upload security fix.

Location:
[paid-memberships-pro/tags/2.12.4](/browser/paid-memberships-pro/tags/2.12.4?rev=2997319)
Files:

1 edited
1 copied

* [.](/browser/paid-memberships-pro/tags/2.12.4?rev=2997319 "Show entry in browser")
  (copied)
  *(copied from [paid-memberships-pro/trunk](/browser/paid-memberships-pro/trunk?rev=2974438 "Show original file (revision 2997315)"))*
* [includes/fields.php](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319 "Show entry in browser")
  (modified)
  ([5 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [paid-memberships-pro/tags/2.12.4/includes/fields.php](/changeset/2997319/paid-memberships-pro/tags/2.12.4/includes/fields.php "Show the changeset 2997319 restricted to paid-memberships-pro/tags/2.12.4/includes/fields.php")

  | [r2974438](/browser/paid-memberships-pro/trunk/includes/fields.php?rev=2974438#L490 "Show revision 2974438 of this file in browser") | [r2997319](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319#L490 "Show revision 2997319 of this file in browser") |  |
  | --- | --- | --- |
  | 490 | 490 | } |
  | 491 | 491 |  |
  | 492 |  | if(isset($\_REQUEST[$field->name])) |
  | 493 |  | $value = pmpro\_sanitize( $\_REQUEST[$field->name], $field ); //phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
  | 494 |  | elseif(isset($\_FILES[$field->name])) |
  | 495 |  | { |
  | 496 |  | $value = sanitize\_file\_name( $\_FILES[$field->name]['name'] ); |
  | 497 |  |  |
  | 498 |  | //handle empty file but the user already has a file |
  | 499 |  | if(empty($value) && !empty($\_REQUEST[$field->name . "\_old"])) |
  | 500 |  | $value = sanitize\_file\_name( $\_REQUEST[$field->name . "\_old"] ); |
  | 501 |  | elseif(!empty($value)) |
  | 502 |  | { |
  | 503 |  | //check extension against allowed extensions |
  | 504 |  | $filetype = wp\_check\_filetype\_and\_ext( sanitize\_text\_field( $\_FILES[$field->name]['tmp\_name'] ), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ); |
  | 505 |  | if((!$filetype['type'] || !$filetype['ext'] ) && !current\_user\_can( 'unfiltered\_upload' )) |
  | 506 |  | { |
  | 507 |  | if($okay)   //only want to update message if there is no previous error |
  | 508 |  | pmpro\_setMessage( sprintf( \_\_( "Sorry, the file type for %s is not permitted for security reasons.", "paid-memberships-pro"), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ), "pmpro\_error"); |
  | 509 |  | return false; |
  | 510 |  | } |
  | 511 |  | else |
  | 512 |  | { |
  | 513 |  | //check for specific extensions anyway |
  | 514 |  | if(!empty($field->ext) && !in\_array($filetype['ext'], $field->ext)) |
  | 515 |  | { |
  | 516 |  | if($okay)   //only want to update message if there is no previous error |
  | 517 |  | pmpro\_setMessage( sprintf( \_\_( "Sorry, the file type for %s is not permitted for security reasons.", "paid-memberships-pro"), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ), "pmpro\_error"); |
  | 518 |  | return false; |
  | 519 |  | } |
  | 520 |  | } |
  |  | 492 | // If this is a file upload, check whether the file is allowed. |
  |  | 493 | if ( isset( $\_FILES[ $field->name ] ) && ! empty( $\_FILES[$field->name]['name'] ) ) { |
  |  | 494 | $upload\_check = pmpro\_check\_upload( $field->name ); |
  |  | 495 | if ( is\_wp\_error( $upload\_check ) ) { |
  |  | 496 | pmpro\_setMessage( $upload\_check->get\_error\_message(), 'pmpro\_error' ); |
  |  | 497 | return false; |
  | 521 | 498 | } |
  | 522 | 499 | } |
  | 523 |  | ~~else~~ |
  | 524 |  | ~~$value = false;~~ |
  | 525 | 500 |  |
  | 526 | 501 | if( ! $field->was\_filled\_if\_needed() ) { |
  | […](/browser/paid-memberships-pro/trunk/includes/fields.php?rev=2974438#L561) | […](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319#L536) |  |
  | 561 | 536 | /\*\* |
  | 562 | 537 | \* Sessions vars for TwoCheckout. PayPal Express was updated to store in order meta. |
  |  | 538 | \* |
  |  | 539 | \* @deprecated 2.12.4 Use pmpro\_after\_checkout\_save\_fields instead to save fields immediately or pmpro\_save\_checkout\_data\_to\_order for delayed checkouts. |
  | 563 | 540 | \*/ |
  | 564 | 541 | function pmpro\_paypalexpress\_session\_vars\_for\_user\_fields() { |
  | 565 | 542 | global $pmpro\_user\_fields; |
  |  | 543 |  |
  |  | 544 | \_deprecated\_function( \_\_FUNCTION\_\_, '2.12.4', 'pmpro\_after\_checkout\_save\_fields' ); |
  | 566 | 545 |  |
  | 567 | 546 | //save our added fields in session while the user goes off to PayPal |
  | […](/browser/paid-memberships-pro/trunk/includes/fields.php?rev=2974438#L588) | […](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319#L567) |  |
  | 588 | 567 | We need to save the file somewhere and save values in $\_SESSION |
  | 589 | 568 | \*/ |
  | 590 |  |  |
  | 591 |  | // Make sure file was uploaded. |
  | 592 |  | if ( ! is\_uploaded\_file( sanitize\_text\_field( $\_FILES[$field->name]['tmp\_name'] ) ) ) { |
  | 593 |  | continue; |
  |  | 569 | // Make sure the file is allowed. |
  |  | 570 | $upload\_check = pmpro\_check\_upload( $field->name ); |
  |  | 571 | if ( is\_wp\_error( $upload\_check ) ) { |
  |  | 572 | continue; |
  |  | 573 | } |
  |  | 574 |  |
  |  | 575 | // Get $file and $filetype. |
  |  | 576 | $file = array\_map( 'sanitize\_text\_field', $\_FILES[ $field->name ] ); |
  |  | 577 | $filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); |
  |  | 578 |  |
  |  | 579 | // Make sure file was uploaded during this page load. |
  |  | 580 | if ( ! is\_uploaded\_file( sanitize\_text\_field( $file['tmp\_name'] ) ) ) { |
  |  | 581 | continue; |
  | 594 | 582 | } |
  | 595 | 583 |  |
  | […](/browser/paid-memberships-pro/trunk/includes/fields.php?rev=2974438#L605) | […](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319#L593) |  |
  | 605 | 593 |  |
  | 606 | 594 | //move file |
  | 607 |  | $new\_filename = $pmprorh\_dir . basename( sanitize\_file\_name( $~~\_FILES[$field->name]~~['name'] ) ); |
  | 608 |  | move\_uploaded\_file( sanitize\_text\_field( $~~\_FILES[$field->name]~~['tmp\_name'] ), $new\_filename ); |
  |  | 595 | $new\_filename = $pmprorh\_dir . basename( sanitize\_file\_name( $file['name'] ) ); |
  |  | 596 | move\_uploaded\_file( sanitize\_text\_field( $$file['tmp\_name'] ), $new\_filename ); |
  | 609 | 597 |  |
  | 610 | 598 | //update location of file |
  | […](/browser/paid-memberships-pro/trunk/includes/fields.php?rev=2974438#L612) | […](/browser/paid-memberships-pro/tags/2.12.4/includes/fields.php?rev=2997319#L600) |  |
  | 612 | 600 |  |
  | 613 | 601 | //save file info in session |
  | 614 |  | $\_SESSION[$field->name] = array\_map( 'sanitize\_text\_field', $\_FILES[$field->name] ); |
  | 615 |  | } |
  | 616 |  | } |
  | 617 |  | } |
  | 618 |  | } |
  | 619 |  | } |
  | 620 |  | add\_action( 'pmpro\_before\_send\_to\_twocheckout', 'pmpro\_paypalexpress\_session\_vars\_for\_user\_fields', 10, 0); |
  |  | 602 | $\_SESSION[$field->name] = array\_map( 'sanitize\_text\_field', $file ); |
  |  | 603 | } |
  |  | 604 | } |
  |  | 605 | } |
  |  | 606 | } |
  |  | 607 | } |
  | 621 | 608 |  |
  | 622 | 609 | /\*\* |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2997319)
* [Zip Archive](?format=zip&new=2997319)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.paidmembershipspro.com_7570e5ec_20250114_192708.html ===


php esc\_html\_e( "Dismiss", "sitewide-sales" ); ?
[Introductory Pricing: Save 50% on your first year of any plan. Use coupon code:

**FIRSTYEAR50**](/pricing/)

Search for:

* [Log In](https://www.paidmembershipspro.com/login/)
* [Welcome](https://www.paidmembershipspro.com/)
* [Features](https://www.paidmembershipspro.com/features/)
* [Pricing](https://www.paidmembershipspro.com/pricing/)
* [Documentation](https://www.paidmembershipspro.com/documentation/)
* [Case Studies](https://www.paidmembershipspro.com/category/case-study/)
* [Add Ons](/add-ons/)
* [Support](https://www.paidmembershipspro.com/support/)
* [Learn](https://www.paidmembershipspro.com/learn/)
* [Events](https://www.paidmembershipspro.com/live/)
* [Blog](https://www.paidmembershipspro.com/blog/)
* [Contact](https://www.paidmembershipspro.com/contact/)

### Log In

Username or Email Address

Password

 Remember Me

Show Password

[Join Now](https://www.paidmembershipspro.com/pricing/) | [Lost Password?](https://www.paidmembershipspro.com/login/?action=reset_pass)

[Skip to content](#content)

[Paid Memberships Pro](https://www.paidmembershipspro.com/)

WordPress Membership Plugin

* [Log In](https://www.paidmembershipspro.com/login/?redirect_to=https%3A%2F%2Fwww.paidmembershipspro.com%2Fpmpro-update-2-12-4%2F)
* [Choose a Plan](https://www.paidmembershipspro.com/pricing/)

 Toggle Mobile Menu

* [Features](https://www.paidmembershipspro.com/features/)
  + [Product Overview](https://www.paidmembershipspro.com/features/)
  + [Screenshots](https://www.paidmembershipspro.com/features/screenshots/)
  + [About Us](https://www.paidmembershipspro.com/about/)
* [Pricing](https://www.paidmembershipspro.com/pricing/)
* [Documentation](https://www.paidmembershipspro.com/documentation/)
  + [Initial Setup](https://www.paidmembershipspro.com/documentation/initial-plugin-setup/)
  + [Payment Gateways](https://www.paidmembershipspro.com/gateway/)
* [Case Studies](https://www.paidmembershipspro.com/category/case-study/)
* [Add Ons](/add-ons/)
* [Support](https://www.paidmembershipspro.com/support/)
* [Learn](https://www.paidmembershipspro.com/learn/)
* [Events](https://www.paidmembershipspro.com/live/)
* [Blog](https://www.paidmembershipspro.com/blog/)
* Search for:

[Home](https://www.paidmembershipspro.com)
 >
[Blog](/blog/)
 >
PMPro Security Update 2.12.4
# PMPro Security Update 2.12.4

 Estimated reading time: 3 minutes

[Tweet](https://twitter.com/share?url=https://www.paidmembershipspro.com/pmpro-update-2-12-4/&text=PMPro%C2%A0Security%20Update%202.12.4 "Share on Twitter")[Facebook](https://www.facebook.com/sharer/sharer.php?u=https://www.paidmembershipspro.com/pmpro-update-2-12-4/&display=popup&ref=plugin&src=share_button "Share on Facebook")[LinkedIn](https://www.linkedin.com/shareArticle?mini=true&url=https://www.paidmembershipspro.com/pmpro-update-2-12-4/ "Share on LinkedIn")

Version 2.12.4 of Paid Memberships Pro is out with a very important security fix.

This update fixes an issue where, in some cases, users could upload files at checkout with disallowed file types (e.g. `.php` files). These files could then be accessed to run arbitrary code on the server.

Thanks to István Márton and WordFence for the responsible disclosure of this issue.

**While only sites with certain user field configurations are vulnerable to the security attack as disclosed, we are encouraging all sites to update.**

You can update Paid Memberships Pro from the plugins page of your WordPress dashboard or get the [latest version of PMPro here](/documentation/download/).

![Development Changelog for Paid Memberships Pro Release Updates](https://www.paidmembershipspro.com/wp-content/uploads/2022/08/pmpro-development-release-notes-blog-default-1024x576.jpg)
## Table of contents

* [How to Confirm Whether This Impacted Your Site](#h-how-to-confirm-whether-this-impacted-your-site)
  + [Who is Potentially Impacted](#h-who-is-potentially-impacted)
  + [How to Update and Protect Your Site](#h-how-to-update-and-protect-your-site)
* [The full list of updates in v2.12.4 is below.](#h-the-full-list-of-updates-in-v2-12-4-is-below)

## How to Confirm Whether This Impacted Your Site

The information below aims to help site owners identify whether this security issue specifically impacted their site. We’ve also included steps to clean up any potentially malicious files.

### Who is Potentially Impacted

Any site with PMPro User Fields set in a `profile only` group, or otherwise marked to not appear at checkout, could be vulnerable to this attack.

*The fields did not have to be file type fields.*

### How to Update and Protect Your Site

1. The first thing to do is **back up your site and then update to the latest version of PMPro** (v2.12.4 or higher).
2. **Next, search for malicious files** in the `../wp-content/uploads/pmpro-register-helper/` folder.
   * If you don’t have a `pmpro-register-helper` folder in your `/wp-content/uploads/` folder, you have confirmed that this vulnerability hasn’t been used.
   * If you do have that folder, that means you likely have file type fields defined in PMPro.
3. **For sites with a small number of users:** browse through the files to look for any malicious looking files. There should not be any `.php`, `.js`, or `.html` files in that folder.
4. **If you find a malicious file,** back it up safely (it can be useful for identification), and then delete the file from your server.
   * At this point, you should assume your website has been hacked. You should work with your host or a company like WordFence to fully restore and secure your site.

#### Linux Command For Advanced Developers

Here is a Linux command you can run to scan for possible malicious files in the `pmpro-register-helper` folder. First navigate to your `/wp-content/uploads` folder under your web root, then run:

```
find pmpro-register-helper/ \( -name ".php" -o -name ".html" -o -name ".htm" -o -name ".js" -o -name ".exe" -o -name ".bat" -o -name ".sh" -o -name ".py" -o -name ".pl" -o -name ".cgi" -o -name ".asp" -o -name ".aspx" -o -name "*.jar" \)
```
## The full list of updates in v2.12.4 is below.

* **SECURITY:** Fixed security issue where in some cases users could upload files at checkout with disallowed file types, e.g. `.php` files that could then be accessed to run arbitrary code on the server. (Thanks, István Márton and WordFence)
* **ENHANCEMENT:** New icons for LifterLMS and the GA4 Add On.
* **BUG FIX/ENHANCEMENT:** Fixed issues with the notifications shown when updating billing details. (Thanks, dwanjuki on GitHub)

![Jason Coleman](https://secure.gravatar.com/avatar/fc98dc7b6690c7a987a779e4f06e763f?s=80&d=identicon&r=g)

Author: Jason Coleman

Jason Coleman is the co-founder and CEO of Paid Memberships Pro, the most trusted membership platform that grows with you. With a deep passion for open source software, Jason is the author of [Building Web Apps With WordPress](https://www.oreilly.com/library/view/building-web-apps/9781491990070/), published by O'Reilly Media.

Jason's entrepreneurial spirit is driven by uncertainty, risk, and the thrill of new opportunities. With over two decades of experience in development, management, and marketing, he is committed to Paid Memberships Pro: the only open source platform focused on helping creators get paid so they can find freedom in their life and fulfill their goals.

[View more articles by Jason Coleman »](https://www.paidmembershipspro.com/author/jason-coleman/)

Was this article helpful?YesNo
Posted in [Release Notes](https://www.paidmembershipspro.com/category/release-notes/). Bookmark the [permalink](https://www.paidmembershipspro.com/pmpro-update-2-12-4/). Last updated: November 16, 2023.

Post navigation
[← Unlocking Content on Specific Dates With PMPro: Series Add On Alternative](https://www.paidmembershipspro.com/unlock-content-specific-dates/)[Paid Memberships Pro vs. Substack →](https://www.paidmembershipspro.com/paid-memberships-pro-vs-substack/)

**Recommended by top influencers, users, and web hosts**

Plugin Reviews

4.3 out of 5

![G2](https://www.paidmembershipspro.com/wp-content/uploads/2023/07/G2-150x150.png)

4.8 out of 5

![Capterra](https://www.paidmembershipspro.com/wp-content/uploads/2023/07/Capterra-300x67.png)

5 out of 5

### We’re 100% GPL

Our plugin's code is **not obfuscated**, **runs on as many sites as you want** and **can be customized to fit your project's needs**. We just ask that you follow the GPLv2 guidelines by applying the GPLv2 license to any altered or unaltered version of PMPro that you distribute. [License Details »](/license/)

[![GPL v2](/wp-content/uploads/2015/07/GPL-v2.png)](https://www.gnu.org/licenses/gpl-2.0.html)
### Recent Articles and Updates

* [![Banner image for WS Form blog post](https://www.paidmembershipspro.com/wp-content/uploads/2025/01/member-submit-content-ws-form_1-150x150.jpg)](https://www.paidmembershipspro.com/member-submitted-content-with-ws-form/)
  [Let Members Submit Content Using WS Form and PMPro](https://www.paidmembershipspro.com/member-submitted-content-with-ws-form/)
* [![Banner Image for Create a Three-Tiered Structure with the Group Accounts Add On](https://www.paidmembershipspro.com/wp-content/uploads/2024/12/three-tiered-group-account-150x150.jpg)](https://www.paidmembershipspro.com/three-tiered-structure-group-accounts/)
  [Create a Three-Tiered Structure With the Group Accounts Add On](https://www.paidmembershipspro.com/three-tiered-structure-group-accounts/)
* [![](https://www.paidmembershipspro.com/wp-content/uploads/2024/12/private-member-only-live-stream-150x150.webp)](https://www.paidmembershipspro.com/member-only-live-stream/)
  [Host Private Member-Only Live Streams](https://www.paidmembershipspro.com/member-only-live-stream/)

### Platform

* [Pricing](https://www.paidmembershipspro.com/pricing/)
* [Features](https://www.paidmembershipspro.com/features/)
* [Product Comparison](https://www.paidmembershipspro.com/category/product-comparison/)
* [Reviews](https://www.paidmembershipspro.com/paid-memberships-pro-review/)
* [Case Studies](https://www.paidmembershipspro.com/category/case-study/)
* [Screenshots](https://www.paidmembershipspro.com/features/screenshots/)
* [Videos](https://www.paidmembershipspro.com/videos/)
* [Step-by-Step Guides](https://www.paidmembershipspro.com/step-by-step-guides/)
### Use Cases

* [Associations](https://www.paidmembershipspro.com/associations/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Blog & News](https://www.paidmembershipspro.com/blog-news/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Community](https://www.paidmembershipspro.com/communities/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Courses](https://www.paidmembershipspro.com/courses/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Directory & Listing](https://www.paidmembershipspro.com/add-ons/member-directory/?utm_source=footer&utm_medium=Directory-Listing&utm_campaign=use-cases "Directory-Listing")
* [Paid Newsletter](https://www.paidmembershipspro.com/paid-newsletters/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Podcast](https://www.paidmembershipspro.com/membership-site-podcasting-benefits/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
* [Videos](https://www.paidmembershipspro.com/private-videos/?utm_source=footer&utm_medium=&utm_campaign=use-cases)
### Add Ons

* [Free](https://www.paidmembershipspro.com/add-on-category/free/)
* [Standard](https://www.paidmembershipspro.com/add-on-category/standard/)
* [Plus](https://www.paidmembershipspro.com/add-on-category/plus/)
* [Admin](https://www.paidmembershipspro.com/add-on-category/admin/)
* [Integration](https://www.paidmembershipspro.com/add-on-category/integration/)
* [Payment](https://www.paidmembershipspro.com/add-on-category/payment/)
* [Third Party](https://www.paidmembershipspro.com/add-on-category/third-party/)
* [View All](/add-ons/)
### Get Help

* [Support](https://www.paidmembershipspro.com/support/)
* [Documentation](https://www.paidmembershipspro.com/documentation/)
* [Download & Install](https://www.paidmembershipspro.com/documentation/download/)
* [Hosting](https://www.paidmembershipspro.com/recommendations-web-hosting-support-pmpro/)
* [Developers](https://www.paidmembershipspro.com/developers/)
* [Blog](https://www.paidmembershipspro.com/blog/)
* [Slack Community](https://www.paidmembershipspro.com/slack/)
* [Contact Us](https://www.paidmembershipspro.com/contact/)
### Company

* [About Us](https://www.paidmembershipspro.com/about/)
* [Events](https://www.paidmembershipspro.com/live/)
* [Brand Assets](https://www.paidmembershipspro.com/about/resources/)
* [Affiliates](https://www.paidmembershipspro.com/affiliate-program/)
* [Accessibility Statement](https://www.paidmembershipspro.com/accessibility-statement/)
* [Privacy Policy](https://www.paidmembershipspro.com/privacy-policy/)
* [Terms of Service](https://www.paidmembershipspro.com/terms-of-service/)

Join Us On

© 2025 Paid Memberships Pro™. Paid Memberships Pro is a trademark of Stranger Studios, LLC. All Rights Reserved.

 [**Open Office Hours: Win Back Members and Re-Engage Old Members with Kim** • Thursday, January 16th at 11am ET. **SEE DETAILS ▸**](/live)



=== Content from plugins.trac.wordpress.org_25412260_20250114_192707.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2997319%2Fpaid-memberships-pro%2Ftags%2F2.12.4%2Fincludes%2Ffunctions.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2974438/paid-memberships-pro/trunk/includes/functions.php "Changeset 2974438 for paid-memberships-pro/tags/2.12.4/includes/functions.php")
* Next Change →

---

# Changeset [2997319](/changeset/2997319 "Show full changeset") for [paid-memberships-pro/tags/2.12.4/includes/functions.php](/browser/paid-memberships-pro/tags/2.12.4/includes/functions.php?rev=2997319 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
11/16/2023 09:10:45 PM
([14 months](/timeline?from=2023-11-16T21%3A10%3A45Z&precision=second "See timeline at 11/16/2023 09:10:45 PM") ago)

Author:
strangerstudios
Message:

2.12.4 File upload security fix.

Location:
[paid-memberships-pro/tags/2.12.4](/browser/paid-memberships-pro/tags/2.12.4?rev=2997319)
Files:

1 edited
1 copied

* [.](/browser/paid-memberships-pro/tags/2.12.4?rev=2997319 "Show entry in browser")
  (copied)
  *(copied from [paid-memberships-pro/trunk](/browser/paid-memberships-pro/trunk?rev=2974438 "Show original file (revision 2997315)"))*
* [includes/functions.php](/browser/paid-memberships-pro/tags/2.12.4/includes/functions.php?rev=2997319 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [paid-memberships-pro/tags/2.12.4/includes/functions.php](/changeset/2997319/paid-memberships-pro/tags/2.12.4/includes/functions.php "Show the changeset 2997319 restricted to paid-memberships-pro/tags/2.12.4/includes/functions.php")

  | [r2974438](/browser/paid-memberships-pro/trunk/includes/functions.php?rev=2974438#L4411 "Show revision 2974438 of this file in browser") | [r2997319](/browser/paid-memberships-pro/tags/2.12.4/includes/functions.php?rev=2997319#L4411 "Show revision 2997319 of this file in browser") |  |
  | --- | --- | --- |
  | 4411 | 4411 | return $sanitized\_period; |
  | 4412 | 4412 | } |
  |  | 4413 |  |
  |  | 4414 | /\*\* |
  |  | 4415 | \* Check whether a file should be allowed to be uploaded. |
  |  | 4416 | \* |
  |  | 4417 | \* By default, only files assiciated with a user field can be uploaded, |
  |  | 4418 | \* but there is a filter to allow other files to be uploaded as well. |
  |  | 4419 | \* |
  |  | 4420 | \* @since 2.12.4 |
  |  | 4421 | \* |
  |  | 4422 | \* @param $file\_index string The array index of the file to check in the $\_FILES array. |
  |  | 4423 | \* @return true|WP\_Error True if the file is allowed, otherwise a WP\_Error object. |
  |  | 4424 | \*/ |
  |  | 4425 | function pmpro\_check\_upload( $file\_index ) { |
  |  | 4426 | global $pmpro\_user\_fields; |
  |  | 4427 |  |
  |  | 4428 | // Check if the file was uploaded. |
  |  | 4429 | if ( empty( $\_FILES[ $file\_index ] ) ) { |
  |  | 4430 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'No file was uploaded.', 'paid-memberships-pro' ) ); |
  |  | 4431 | } |
  |  | 4432 |  |
  |  | 4433 | // Get the file info. |
  |  | 4434 | $file = array\_map( 'sanitize\_text\_field', $\_FILES[ $file\_index ] ); |
  |  | 4435 | if ( empty( $file['name'] ) ) { |
  |  | 4436 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'No file name found.', 'paid-memberships-pro' ) ); |
  |  | 4437 | } |
  |  | 4438 |  |
  |  | 4439 | // If the current user cannot does not have the unfiltered\_upload permission, check if the file is an allowed file type. |
  |  | 4440 | if ( ! current\_user\_can( 'unfiltered\_upload' ) ) { |
  |  | 4441 | $filetype = wp\_check\_filetype\_and\_ext( $file['tmp\_name'], $file['name'] ); |
  |  | 4442 | if ( empty( $filetype['ext'] ) || empty( $filetype['type'] ) ) { |
  |  | 4443 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file type.', 'paid-memberships-pro' ) ); |
  |  | 4444 | } |
  |  | 4445 | } |
  |  | 4446 |  |
  |  | 4447 | // If this is an upload for a user field, we need to perform additional checks. |
  |  | 4448 | $is\_user\_field = false; |
  |  | 4449 | if ( ! empty( $pmpro\_user\_fields ) && is\_array( $pmpro\_user\_fields ) ) { |
  |  | 4450 | foreach ( $pmpro\_user\_fields as $checkout\_box ) { |
  |  | 4451 | foreach ( $checkout\_box as $field ) { |
  |  | 4452 | if ( $field->name == $file\_index ) { |
  |  | 4453 | // This file is being uploaded for a user field. |
  |  | 4454 | $is\_user\_field = true; |
  |  | 4455 |  |
  |  | 4456 | // First, make sure that this is a 'file' field. |
  |  | 4457 | if ( $field->type !== 'file' ) { |
  |  | 4458 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid field input.', 'paid-memberships-pro' ) ); |
  |  | 4459 | } |
  |  | 4460 |  |
  |  | 4461 | // If there are allowed file types, check if the file is an allowed file type. |
  |  | 4462 | // It does not look like the ext property is documented anywhere, but keeping it in case sites are using it. |
  |  | 4463 | if ( ! empty( $field->ext ) && is\_array( $field->ext ) && ! in\_array( $filetype['ext'], $field->ext ) ) { |
  |  | 4464 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file type.', 'paid-memberships-pro' ) ); |
  |  | 4465 | } |
  |  | 4466 | } |
  |  | 4467 | } |
  |  | 4468 | } |
  |  | 4469 | } |
  |  | 4470 |  |
  |  | 4471 | if ( ! $is\_user\_field ) { |
  |  | 4472 | /\*\* |
  |  | 4473 | \* Filter whether a file not associated with a user field can be uploaded. |
  |  | 4474 | \* |
  |  | 4475 | \* @since 2.12.4 |
  |  | 4476 | \* |
  |  | 4477 | \* @param bool $allow\_upload True if the file can be uploaded, otherwise false. |
  |  | 4478 | \* @param array $file The file info. |
  |  | 4479 | \* @param array $filetype The file type info. |
  |  | 4480 | \*/ |
  |  | 4481 | if ( ! apply\_filters( 'pmpro\_allow\_uploading\_non\_user\_field\_file', false, $file, $filetype ) ) { |
  |  | 4482 | return new WP\_Error( 'pmpro\_upload\_error', \_\_( 'Invalid file submission.', 'paid-memberships-pro' ) ); |
  |  | 4483 | } |
  |  | 4484 | } |
  |  | 4485 |  |
  |  | 4486 |  |
  |  | 4487 | // If we made it this far, the file is allowed. |
  |  | 4488 | return true; |
  |  | 4489 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2997319)
* [Zip Archive](?format=zip&new=2997319)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_59f16213_20250114_192709.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Paid Memberships Pro <= 2.12.3 - Authenticated (Subscriber+) Arbitrary File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Paid Memberships Pro <= 2.12.3 - Authenticated (Subscriber+) Arbitrary File Upload

7.5

**Unrestricted Upload of File with Dangerous Type**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2023-6187](https://www.cve.org/CVERecord?id=CVE-2023-6187) |
| --- | --- |
| CVSS | 7.5 (High) |
| Publicly Published | November 16, 2023 |
| Last Updated | November 30, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The Paid Memberships Pro plugin for WordPress is vulnerable to arbitrary file uploads due to insufficient file type validation in the 'pmpro\_paypalexpress\_session\_vars\_for\_user\_fields' function in versions up to, and including, 2.12.3. This makes it possible for authenticated attackers with subscriber privileges or above, to upload arbitrary files on the affected site's server which may make remote code execution possible. This can be exploited if 2Checkout (deprecated since version 2.6) or PayPal Express is set as the payment method and a custom user field is added that is only visible at profile, and not visible at checkout according to its settings.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/paid-memberships-pro/tags/2.12.3/includes/fields.php#L564)
* [www.paidmembershipspro.com](https://www.paidmembershipspro.com/pmpro-update-2-12-4/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2997319/paid-memberships-pro/tags/2.12.4/includes/functions.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2997319/paid-memberships-pro/tags/2.12.4/includes/fields.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2123-authenticated-subscriber-arbitrary-file-upload&t=Paid%20Memberships%20Pro%20%3C%3D%202.12.3%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2123-authenticated-subscriber-arbitrary-file-upload&text=Paid%20Memberships%20Pro%20%3C%3D%202.12.3%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2123-authenticated-subscriber-arbitrary-file-upload "LinkedIn")
Email

## Vulnerability Details for Paid Memberships Pro – Content Restriction, User Registration, & Paid Subscriptions

#### [Paid Memberships Pro – Content Restriction, User Registration, & Paid Subscriptions](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/paid-memberships-pro)

| Software Type | Plugin |
| --- | --- |
| Software Slug | paid-memberships-pro [(view on wordpress.org)](https://wordpress.org/plugins/paid-memberships-pro) |
| Patched? | Yes |
| Remediation | Update to version 2.12.4, or a newer patched version |
| Affected Version | * <= 2.12.3 |
| Patched Version | * 2.12.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_0851fe5f_20250114_192658.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpaid-memberships-pro%2Ftags%2F2.12.3%2Fincludes%2Ffields.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/paid-memberships-pro/tags/2.12.3/includes/fields.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/paid-memberships-pro/tags/2.12.3/includes/fields.php)

---

# [source:](/browser?order=name "Go to repository root") [paid-memberships-pro](/browser/paid-memberships-pro?order=name "View paid-memberships-pro")/[tags](/browser/paid-memberships-pro/tags?order=name "View tags")/[2.12.3](/browser/paid-memberships-pro/tags/2.12.3?order=name "View 2.12.3")/[includes](/browser/paid-memberships-pro/tags/2.12.3/includes?order=name "View includes")/[fields.php](/browser/paid-memberships-pro/tags/2.12.3/includes/fields.php?order=name "View fields.php")

View diff against:

View revision:

| [Last change](/changeset/2974438/paid-memberships-pro/tags/2.12.3/includes/fields.php "View differences") on this file was [2974438](/changeset/2974438/ "View changeset 2974438"), checked in by strangerstudios, [16 months ago](/timeline?from=2023-10-03T18%3A33%3A18Z&precision=second "See timeline at 10/03/2023 06:33:18 PM") |
| --- |
| 2.12.3 enhancements and bug fixes. |
| **File size:** 63.1 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | // Global to store field groups and user fields. |
| [3](#L3) | global $pmpro\_field\_groups, $pmpro\_user\_fields; |
| [4](#L4) | $pmpro\_user\_fields = array(); |
| [5](#L5) |  |
| [6](#L6) | // Add default group. |
| [7](#L7) | $cb = new stdClass(); |
| [8](#L8) | $cb->name = 'checkout\_boxes'; |
| [9](#L9) | $cb->label = apply\_filters( 'pmpro\_default\_field\_group\_label', \_\_( 'More Information','paid-memberships-pro' ) ); |
| [10](#L10) | $cb->order = 0; |
| [11](#L11) | $pmpro\_field\_groups = array( 'checkout\_boxes' => $cb ); |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* Check if a variable is a PMPro\_Field. |
| [15](#L15) | \* Also checks for PMProRH\_Field. |
| [16](#L16) | \*/ |
| [17](#L17) | function pmpro\_is\_field( $var ) { |
| [18](#L18) | if ( is\_a( $var, 'PMPro\_Field' ) || is\_a( $var, 'PMProRH\_Field' ) ) { |
| [19](#L19) | return true; |
| [20](#L20) | } else { |
| [21](#L21) | return false; |
| [22](#L22) | } |
| [23](#L23) | } |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* Add a field to the PMProRH regisration fields global |
| [27](#L27) | \* |
| [28](#L28) | \*      $where refers to various hooks in the PMPro checkout page and can be: |
| [29](#L29) | \*      - after\_username |
| [30](#L30) | \*      - after\_password |
| [31](#L31) | \*      - after\_email |
| [32](#L32) | \*      - after\_captcha |
| [33](#L33) | \*      - checkout\_boxes |
| [34](#L34) | \*      - after\_billing\_fields |
| [35](#L35) | \*      - before\_submit\_button |
| [36](#L36) | \*      - just\_profile (make sure you set the profile attr of the field to true or admins) |
| [37](#L37) | \*/ |
| [38](#L38) | function pmpro\_add\_user\_field( $where, $field ) { |
| [39](#L39) | global $pmpro\_user\_fields; |
| [40](#L40) |  |
| [41](#L41) | /\*\* |
| [42](#L42) | \* Filter the group to add the field to. |
| [43](#L43) | \* |
| [44](#L44) | \* @since 2.9.3 |
| [45](#L45) | \* |
| [46](#L46) | \* @param string $where The name of the group to add the field to. |
| [47](#L47) | \* @param PMProField $field The field being added. |
| [48](#L48) | \*/ |
| [49](#L49) | $where = apply\_filters( 'pmpro\_add\_user\_field\_where', $where, $field ); |
| [50](#L50) |  |
| [51](#L51) | /\*\* |
| [52](#L52) | \* Filter the field to add. |
| [53](#L53) | \* |
| [54](#L54) | \* @since 2.9.3 |
| [55](#L55) | \* |
| [56](#L56) | \* @param PMProField $field The field being added. |
| [57](#L57) | \* @param string $where The name of the group to add the field to. |
| [58](#L58) | \*/ |
| [59](#L59) | $field = apply\_filters( 'pmpro\_add\_user\_field', $field, $where ); |
| [60](#L60) |  |
| [61](#L61) | if(empty($pmpro\_user\_fields[$where])) { |
| [62](#L62) | $pmpro\_user\_fields[$where] = array(); |
| [63](#L63) | } |
| [64](#L64) | if ( ! empty( $field ) && pmpro\_is\_field( $field ) ) { |
| [65](#L65) | $pmpro\_user\_fields[$where][] = $field; |
| [66](#L66) | return true; |
| [67](#L67) | } |
| [68](#L68) |  |
| [69](#L69) | return false; |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* Add a new checkout box to the checkout\_boxes section. |
| [74](#L74) | \* You can then use this as the $where parameter |
| [75](#L75) | \* to pmprorh\_add\_registration\_field. |
| [76](#L76) | \* |
| [77](#L77) | \* Name must contain no spaces or special characters. |
| [78](#L78) | \*/ |
| [79](#L79) | function pmpro\_add\_field\_group( $name, $label = NULL, $description = '', $order = NULL ) { |
| [80](#L80) | global $pmpro\_field\_groups; |
| [81](#L81) |  |
| [82](#L82) | $temp = new stdClass(); |
| [83](#L83) | $temp->name = $name; |
| [84](#L84) | $temp->label = $label; |
| [85](#L85) | $temp->description = $description; |
| [86](#L86) | $temp->order = $order; |
| [87](#L87) |  |
| [88](#L88) | //defaults |
| [89](#L89) | if( empty( $temp->label ) ) { |
| [90](#L90) | $temp->label = ucwords($temp->name); |
| [91](#L91) | } |
| [92](#L92) | if( ! isset( $order ) ) { |
| [93](#L93) | $lastbox = pmpro\_array\_end( $pmpro\_field\_groups ); |
| [94](#L94) | $temp->order = $lastbox->order + 1; |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | $pmpro\_field\_groups[$name] = $temp; |
| [98](#L98) | usort( $pmpro\_field\_groups, 'pmpro\_sort\_by\_order' ); |
| [99](#L99) |  |
| [100](#L100) | return true; |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | /\*\* |
| [104](#L104) | \* Add a new User Taxonomy. You can then use this as the user\_taxonomny parameter to pmprorh\_add\_registration\_field. |
| [105](#L105) | \* |
| [106](#L106) | \* @param string $name The singular name for the taxonomy object. |
| [107](#L107) | \* @param string $name\_plural The plural name for the taxonomy object. |
| [108](#L108) | \* |
| [109](#L109) | \*/ |
| [110](#L110) | function pmpro\_add\_user\_taxonomy( $name, $name\_plural ) { |
| [111](#L111) | global $pmpro\_user\_taxonomies; |
| [112](#L112) |  |
| [113](#L113) | // Sanitize the taxonomy $name and make sure it is less than 32 characters. |
| [114](#L114) | $safe\_name = sanitize\_key( $name ); |
| [115](#L115) | if ( strlen( $safe\_name ) > 32 ) { |
| [116](#L116) | $safe\_name = substr( $safe\_name, 0, 32 ); |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | // Add to the global so we can keep track. |
| [120](#L120) | $pmpro\_user\_taxonomies = (array) $pmpro\_user\_taxonomies; |
| [121](#L121) | $pmpro\_user\_taxonomies[] = $safe\_name; |
| [122](#L122) |  |
| [123](#L123) | // Make sure name and plural name are less than 32 characters. |
| [124](#L124) | if ( strlen( $name ) > 32 ) { |
| [125](#L125) | $name = substr( $name, 0, 32 ); |
| [126](#L126) | } |
| [127](#L127) | if ( strlen( $name\_plural ) > 32 ) { |
| [128](#L128) | $name\_plural = substr( $name\_plural, 0, 32 ); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | $pmpro\_user\_taxonomy\_labels = array( |
| [132](#L132) | 'name' => ucwords( $name ), |
| [133](#L133) | 'singular\_name' => ucwords( $name ), |
| [134](#L134) | 'menu\_name' => ucwords( $name\_plural ), |
| [135](#L135) | 'search\_items' => sprintf( \_\_( 'Search %s', 'paid-memberships-pro' ), ucwords( $name\_plural ) ), |
| [136](#L136) | 'popular\_items' => sprintf( \_\_( 'Popular %s', 'paid-memberships-pro' ), ucwords( $name\_plural ) ), |
| [137](#L137) | 'all\_items' => sprintf( \_\_( 'All %s', 'paid-memberships-pro' ), ucwords( $name\_plural ) ), |
| [138](#L138) | 'edit\_item' => sprintf( \_\_( 'Edit %s', 'paid-memberships-pro' ), ucwords( $name ) ), |
| [139](#L139) | 'update\_item' => sprintf( \_\_( 'Update %s', 'paid-memberships-pro' ), ucwords( $name ) ), |
| [140](#L140) | 'add\_new\_item' => sprintf( \_\_( 'Add New %s', 'paid-memberships-pro' ), ucwords( $name ) ), |
| [141](#L141) | 'new\_item\_name' => sprintf( \_\_( 'New %s Name', 'paid-memberships-pro' ), ucwords( $name ) ), |
| [142](#L142) | 'separate\_items\_with\_commas' => sprintf( \_\_( 'Separate %s with commas', 'paid-memberships-pro' ), $name\_plural ), |
| [143](#L143) | 'add\_or\_remove\_items' => sprintf( \_\_( 'Add or remove %s', 'paid-memberships-pro' ), $name\_plural ), |
| [144](#L144) | 'choose\_from\_most\_used' => sprintf( \_\_( 'Choose from the most popular %s', 'paid-memberships-pro' ), $name\_plural ), |
| [145](#L145) | ); |
| [146](#L146) |  |
| [147](#L147) | /\*\* |
| [148](#L148) | \* Filter the args passed to the user taxonomy created. |
| [149](#L149) | \* |
| [150](#L150) | \* @param array $pmpro\_user\_taxonomy\_args The arguments passed to the register\_taxonomy function. |
| [151](#L151) | \* |
| [152](#L152) | \*/ |
| [153](#L153) | $pmpro\_user\_taxonomy\_args = apply\_filters( 'pmpro\_user\_taxonomy\_args', array( |
| [154](#L154) | 'public' => false, |
| [155](#L155) | 'labels' => $pmpro\_user\_taxonomy\_labels, |
| [156](#L156) | 'rewrite' => false, |
| [157](#L157) | 'show\_ui' => true, |
| [158](#L158) | 'capabilities' => array( |
| [159](#L159) | 'manage\_terms' => 'edit\_users', |
| [160](#L160) | 'edit\_terms'   => 'edit\_users', |
| [161](#L161) | 'delete\_terms' => 'edit\_users', |
| [162](#L162) | 'assign\_terms' => 'read', |
| [163](#L163) | ), |
| [164](#L164) | ) |
| [165](#L165) | ); |
| [166](#L166) | register\_taxonomy( $safe\_name, 'user', $pmpro\_user\_taxonomy\_args ); |
| [167](#L167) |  |
| [168](#L168) | /\*\* |
| [169](#L169) | \* Add admin page for the registered user taxonomies. |
| [170](#L170) | \*/ |
| [171](#L171) | add\_action( 'admin\_menu', function() use ( $pmpro\_user\_taxonomy\_labels, $safe\_name ) { |
| [172](#L172) | add\_users\_page( |
| [173](#L173) | esc\_attr( $pmpro\_user\_taxonomy\_labels['menu\_name'] ), |
| [174](#L174) | esc\_attr( $pmpro\_user\_taxonomy\_labels['menu\_name'] ), |
| [175](#L175) | 'edit\_users', |
| [176](#L176) | 'edit-tags.php?taxonomy=' . $safe\_name |
| [177](#L177) | ); |
| [178](#L178) | } ); |
| [179](#L179) |  |
| [180](#L180) | /\*\* |
| [181](#L181) | \* Update parent file name to fix the selected menu issue for a user taaxonomy. |
| [182](#L182) | \*/ |
| [183](#L183) | add\_filter( 'parent\_file', function( $parent\_file ) use ( $safe\_name ) { |
| [184](#L184) | global $submenu\_file; |
| [185](#L185) | if ( |
| [186](#L186) | isset($\_GET['taxonomy']) && |
| [187](#L187) | $\_GET['taxonomy'] == $safe\_name && |
| [188](#L188) | $submenu\_file == 'edit-tags.php?taxonomy=' . $safe\_name |
| [189](#L189) | ) { |
| [190](#L190) | $parent\_file = 'users.php'; |
| [191](#L191) | } |
| [192](#L192) | return $parent\_file; |
| [193](#L193) | } ); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\*\* |
| [197](#L197) | \* Get a field group by name. |
| [198](#L198) | \*/ |
| [199](#L199) | function pmpro\_get\_field\_group\_by\_name( $name ) { |
| [200](#L200) | global $pmpro\_field\_groups; |
| [201](#L201) | if( ! empty( $pmpro\_field\_groups ) ) { |
| [202](#L202) | foreach( $pmpro\_field\_groups as $group ) { |
| [203](#L203) | if( $group->name == $name ) { |
| [204](#L204) | return $group; |
| [205](#L205) | } |
| [206](#L206) | } |
| [207](#L207) | } |
| [208](#L208) | return false; |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | /\*\* |
| [212](#L212) | \* Check if a user field is enabled for the current checkout level. |
| [213](#L213) | \*/ |
| [214](#L214) | function pmpro\_check\_field\_for\_level( $field, $scope = 'default', $args = NULL ) { |
| [215](#L215) | global $pmpro\_level, $pmpro\_checkout\_level\_ids; |
| [216](#L216) | if ( ! empty( $field->levels ) ) { |
| [217](#L217) | if ( 'profile' === $scope ) { |
| [218](#L218) | // Expecting the args to be the user id. |
| [219](#L219) | if ( pmpro\_hasMembershipLevel( $field->levels, $args ) ) { |
| [220](#L220) | return true; |
| [221](#L221) | } else { |
| [222](#L222) | return false; |
| [223](#L223) | } |
| [224](#L224) | } else { |
| [225](#L225) | if ( empty( $pmpro\_checkout\_level\_ids ) && ! empty( $pmpro\_level ) && ! empty( $pmpro\_level->id ) ) { |
| [226](#L226) | $pmpro\_checkout\_level\_ids = array( $pmpro\_level->id ); |
| [227](#L227) | } |
| [228](#L228) | if ( ! is\_array( $field->levels ) ) { |
| [229](#L229) | $field\_levels = array( $field->levels ); |
| [230](#L230) | } else { |
| [231](#L231) | $field\_levels = $field->levels; |
| [232](#L232) | } |
| [233](#L233) | if ( ! empty( $pmpro\_checkout\_level\_ids ) ) { |
| [234](#L234) | // Check against $\_REQUEST. |
| [235](#L235) | return ( ! empty( array\_intersect( $field\_levels, $pmpro\_checkout\_level\_ids ) ) ); |
| [236](#L236) | } |
| [237](#L237) | return false; |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | return true; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | /\*\* |
| [245](#L245) | \* Find fields in a group and display them at checkout. |
| [246](#L246) | \*/ |
| [247](#L247) | function pmpro\_display\_fields\_in\_group( $group, $scope = 'checkout' ) { |
| [248](#L248) | global $pmpro\_user\_fields; |
| [249](#L249) |  |
| [250](#L250) | if( ! empty( $pmpro\_user\_fields[$group] ) ) { |
| [251](#L251) | foreach( $pmpro\_user\_fields[$group] as $field ) { |
| [252](#L252) | if ( ! pmpro\_is\_field( $field ) ) { |
| [253](#L253) | continue; |
| [254](#L254) | } |
| [255](#L255) |  |
| [256](#L256) | if ( ! pmpro\_check\_field\_for\_level( $field ) ) { |
| [257](#L257) | continue; |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | if ( $scope == 'checkout' ) { |
| [261](#L261) | if( ! isset( $field->profile ) || $field->profile !== 'only' && $field->profile !== 'only\_admin' ) { |
| [262](#L262) | $field->displayAtCheckout(); |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) | } |
| [266](#L266) | } |
| [267](#L267) | } |
| [268](#L268) |  |
| [269](#L269) | /\*\* |
| [270](#L270) | \* Cycle through extra fields. Show them at checkout. |
| [271](#L271) | \*/ |
| [272](#L272) | // after\_username |
| [273](#L273) | function pmpro\_checkout\_after\_username\_fields() { |
| [274](#L274) | pmpro\_display\_fields\_in\_group( 'after\_username', 'checkout' ); |
| [275](#L275) | } |
| [276](#L276) | add\_action( 'pmpro\_checkout\_after\_username', 'pmpro\_checkout\_after\_username\_fields' ); |
| [277](#L277) |  |
| [278](#L278) | //after\_password |
| [279](#L279) | function pmpro\_checkout\_after\_password\_fields() { |
| [280](#L280) | pmpro\_display\_fields\_in\_group( 'after\_password', 'checkout' ); |
| [281](#L281) | } |
| [282](#L282) | add\_action( 'pmpro\_checkout\_after\_password', 'pmpro\_checkout\_after\_password\_fields' ); |
| [283](#L283) |  |
| [284](#L284) | //after\_email |
| [285](#L285) | function pmpro\_checkout\_after\_email\_fields() { |
| [286](#L286) | pmpro\_display\_fields\_in\_group( 'after\_email', 'checkout' ); |
| [287](#L287) | } |
| [288](#L288) | add\_action( 'pmpro\_checkout\_after\_email', 'pmpro\_checkout\_after\_email\_fields' ); |
| [289](#L289) |  |
| [290](#L290) | //after captcha |
| [291](#L291) | function pmpro\_checkout\_after\_captcha\_fields() { |
| [292](#L292) | pmpro\_display\_fields\_in\_group( 'after\_captcha', 'checkout' ); |
| [293](#L293) | } |
| [294](#L294) | add\_action( 'pmpro\_checkout\_after\_captcha', 'pmpro\_checkout\_after\_captcha\_fields' ); |
| [295](#L295) |  |
| [296](#L296) | //checkout boxes |
| [297](#L297) | function pmpro\_checkout\_boxes\_fields() { |
| [298](#L298) | global $pmpro\_user\_fields, $pmpro\_field\_groups; |
| [299](#L299) |  |
| [300](#L300) | foreach($pmpro\_field\_groups as $cb) |
| [301](#L301) | { |
| [302](#L302) | //how many fields to show at checkout? |
| [303](#L303) | $n = 0; |
| [304](#L304) | if(!empty($pmpro\_user\_fields[$cb->name])) |
| [305](#L305) | foreach($pmpro\_user\_fields[$cb->name] as $field) |
| [306](#L306) | if(pmpro\_is\_field($field) && pmpro\_check\_field\_for\_level($field) && (!isset($field->profile) || (isset($field->profile) && $field->profile !== "only" && $field->profile !== "only\_admin")))            $n++; |
| [307](#L307) |  |
| [308](#L308) | if($n > 0) { |
| [309](#L309) | ?> |
| [310](#L310) | <div id="pmpro\_checkout\_box-<?php echo sanitize\_title( $cb->name ); ?>" class="pmpro\_checkout"> |
| [311](#L311) | <hr /> |
| [312](#L312) | <h2> |
| [313](#L313) | <span class="pmpro\_checkout-h2-name"><?php echo wp\_kses\_post( $cb->label );?></span> |
| [314](#L314) | </h2> |
| [315](#L315) | <div class="pmpro\_checkout-fields"> |
| [316](#L316) | <?php if(!empty($cb->description)) { ?> |
| [317](#L317) | <div class="pmpro\_checkout\_decription"><?php echo wp\_kses\_post( $cb->description ); ?></div> |
| [318](#L318) | <?php } ?> |
| [319](#L319) |  |
| [320](#L320) | <?php |
| [321](#L321) | foreach($pmpro\_user\_fields[$cb->name] as $field) { |
| [322](#L322) | if( pmpro\_is\_field($field) && pmpro\_check\_field\_for\_level($field) && (!isset($field->profile) || (isset($field->profile) && $field->profile !== "only" && $field->profile !== "only\_admin"))) { |
| [323](#L323) | $field->displayAtCheckout(); |
| [324](#L324) | } |
| [325](#L325) | } |
| [326](#L326) | ?> |
| [327](#L327) | </div> <!-- end pmpro\_checkout-fields --> |
| [328](#L328) | </div> <!-- end pmpro\_checkout\_box-name --> |
| [329](#L329) | <?php |
| [330](#L330) | } |
| [331](#L331) | } |
| [332](#L332) | } |
| [333](#L333) | add\_action( 'pmpro\_checkout\_boxes', 'pmpro\_checkout\_boxes\_fields' ); |
| [334](#L334) |  |
| [335](#L335) | //after\_pricing\_fields |
| [336](#L336) | function pmpro\_checkout\_after\_pricing\_fields() { |
| [337](#L337) | pmpro\_display\_fields\_in\_group( 'after\_pricing\_fields', 'checkout' ); |
| [338](#L338) | } |
| [339](#L339) | add\_action( 'pmpro\_checkout\_after\_pricing\_fields', 'pmpro\_checkout\_after\_pricing\_fields' ); |
| [340](#L340) |  |
| [341](#L341) | //after\_billing\_fields |
| [342](#L342) | function pmpro\_checkout\_after\_billing\_fields() { |
| [343](#L343) | pmpro\_display\_fields\_in\_group( 'after\_billing\_fields', 'checkout' ); |
| [344](#L344) | } |
| [345](#L345) | add\_action( 'pmpro\_checkout\_after\_billing\_fields', 'pmpro\_checkout\_after\_billing\_fields'); |
| [346](#L346) |  |
| [347](#L347) | //before submit button |
| [348](#L348) | function pmpro\_checkout\_before\_submit\_button\_fields() { |
| [349](#L349) | pmpro\_display\_fields\_in\_group( 'before\_submit\_button', 'checkout' ); |
| [350](#L350) | } |
| [351](#L351) | add\_action( 'pmpro\_checkout\_before\_submit\_button', 'pmpro\_checkout\_before\_submit\_button\_fields'); |
| [352](#L352) |  |
| [353](#L353) | // After tos fields. |
| [354](#L354) | function pmpro\_checkout\_after\_tos\_fields() { |
| [355](#L355) | pmpro\_display\_fields\_in\_group( 'after\_tos\_fields', 'checkout' ); |
| [356](#L356) | } |
| [357](#L357) | add\_action( 'pmpro\_checkout\_after\_tos\_fields', 'pmpro\_checkout\_after\_tos\_fields' ); |
| [358](#L358) |  |
| [359](#L359) | /\*\* |
| [360](#L360) | \* Update the fields at checkout. |
| [361](#L361) | \*/ |
| [362](#L362) | function pmpro\_after\_checkout\_save\_fields( $user\_id, $order ) { |
| [363](#L363) | global $pmpro\_user\_fields; |
| [364](#L364) |  |
| [365](#L365) | //any fields? |
| [366](#L366) | if(!empty($pmpro\_user\_fields)) |
| [367](#L367) | { |
| [368](#L368) | //cycle through groups |
| [369](#L369) | foreach($pmpro\_user\_fields as $where => $fields) |
| [370](#L370) | { |
| [371](#L371) | //cycle through fields |
| [372](#L372) | foreach($fields as $field) |
| [373](#L373) | { |
| [374](#L374) | if( ! pmpro\_is\_field( $field ) ) { |
| [375](#L375) | continue; |
| [376](#L376) | } |
| [377](#L377) |  |
| [378](#L378) | if ( ! pmpro\_check\_field\_for\_level( $field, "profile", $user\_id ) ) { |
| [379](#L379) | continue; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | if(!empty($field->profile) && ($field->profile === "only" || $field->profile === "only\_admin")) { |
| [383](#L383) | continue;   //wasn't shown at checkout |
| [384](#L384) | } |
| [385](#L385) |  |
| [386](#L386) | //assume no value |
| [387](#L387) | $value = NULL; |
| [388](#L388) |  |
| [389](#L389) | // Where are we getting the value from? We sanitize $value right after this. |
| [390](#L390) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [391](#L391) | if(isset($\_REQUEST[$field->name])) |
| [392](#L392) | { |
| [393](#L393) | //request |
| [394](#L394) | $value = $\_REQUEST[$field->name]; |
| [395](#L395) | } |
| [396](#L396) | elseif(isset($\_REQUEST[$field->name . '\_checkbox']) && $field->type == 'checkbox') |
| [397](#L397) | { |
| [398](#L398) | //unchecked checkbox |
| [399](#L399) | $value = 0; |
| [400](#L400) | } |
| [401](#L401) | elseif(!empty($\_POST[$field->name . "\_checkbox"]) && in\_array( $field->type, array( 'checkbox', 'checkbox\_grouped', 'select2' ) ) )     //handle unchecked checkboxes |
| [402](#L402) | { |
| [403](#L403) | //unchecked checkbox |
| [404](#L404) | $value = array(); |
| [405](#L405) | } |
| [406](#L406) | elseif(isset($\_SESSION[$field->name])) |
| [407](#L407) | { |
| [408](#L408) | //file or value? |
| [409](#L409) | if(is\_array($\_SESSION[$field->name]) && isset($\_SESSION[$field->name]['name'])) |
| [410](#L410) | { |
| [411](#L411) | //add to files global |
| [412](#L412) | $\_FILES[$field->name] = $\_SESSION[$field->name]; |
| [413](#L413) |  |
| [414](#L414) | //set value to name |
| [415](#L415) | $value = $\_SESSION[$field->name]['name']; |
| [416](#L416) | } |
| [417](#L417) | else |
| [418](#L418) | { |
| [419](#L419) | //session |
| [420](#L420) | $value = $\_SESSION[$field->name]; |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | //unset |
| [424](#L424) | unset($\_SESSION[$field->name]); |
| [425](#L425) | } |
| [426](#L426) | elseif(isset($\_FILES[$field->name])) |
| [427](#L427) | { |
| [428](#L428) | //file |
| [429](#L429) | $value = $\_FILES[$field->name]['name']; |
| [430](#L430) | } |
| [431](#L431) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [432](#L432) |  |
| [433](#L433) | //update user meta |
| [434](#L434) | if(isset($value)) |
| [435](#L435) | { |
| [436](#L436) | if ( ! empty( $field->sanitize ) ) { |
| [437](#L437) | $value = pmpro\_sanitize( $value, $field ); |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | //callback? |
| [441](#L441) | if(!empty($field->save\_function)) |
| [442](#L442) | call\_user\_func( $field->save\_function, $user\_id, $field->name, $value, $order ); |
| [443](#L443) | else |
| [444](#L444) | update\_user\_meta($user\_id, $field->meta\_key, $value); |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) | } |
| [449](#L449) | } |
| [450](#L450) | add\_action( 'pmpro\_after\_checkout', 'pmpro\_after\_checkout\_save\_fields', 10, 2 ); |
| [451](#L451) | add\_action( 'pmpro\_before\_send\_to\_paypal\_standard', 'pmpro\_after\_checkout\_save\_fields', 20, 2 );        //for paypal standard we need to do this just before sending the user to paypal |
| [452](#L452) | add\_action( 'pmpro\_before\_send\_to\_twocheckout', 'pmpro\_after\_checkout\_save\_fields', 20, 2 );    //for 2checkout we need to do this just before sending the user to 2checkout |
| [453](#L453) | add\_action( 'pmpro\_before\_send\_to\_gourl', 'pmpro\_after\_checkout\_save\_fields', 20, 2 );  //for the GoURL Bitcoin Gateway Add On |
| [454](#L454) | add\_action( 'pmpro\_before\_send\_to\_payfast', 'pmpro\_after\_checkout\_save\_fields', 20, 2 );        //for the Payfast Gateway Add On |
| [455](#L455) |  |
| [456](#L456) | /\*\* |
| [457](#L457) | \* Require required fields. |
| [458](#L458) | \*/ |
| [459](#L459) | function pmpro\_registration\_checks\_for\_user\_fields( $okay ) { |
| [460](#L460) | global $current\_user; |
| [461](#L461) |  |
| [462](#L462) | //arrays to store fields that were required and missed |
| [463](#L463) | $required = array(); |
| [464](#L464) | $required\_labels = array(); |
| [465](#L465) |  |
| [466](#L466) | //any fields? |
| [467](#L467) | global $pmpro\_user\_fields; |
| [468](#L468) | if(!empty($pmpro\_user\_fields)) |
| [469](#L469) | { |
| [470](#L470) | //cycle through groups |
| [471](#L471) | foreach($pmpro\_user\_fields as $where => $fields) |
| [472](#L472) | { |
| [473](#L473) | //cycle through fields |
| [474](#L474) | foreach($fields as $field) |
| [475](#L475) | { |
| [476](#L476) | //handle arrays |
| [477](#L477) | $field->name = preg\_replace('/\[\]$/', '', $field->name); |
| [478](#L478) |  |
| [479](#L479) | //if the field is not for this level, skip it |
| [480](#L480) | if( ! pmpro\_is\_field( $field ) ) { |
| [481](#L481) | continue; |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | if ( ! pmpro\_check\_field\_for\_level( $field ) ) { |
| [485](#L485) | continue; |
| [486](#L486) | } |
| [487](#L487) |  |
| [488](#L488) | if(!empty($field->profile) && ($field->profile === "only" || $field->profile === "only\_admin")) { |
| [489](#L489) | continue;   //wasn't shown at checkout |
| [490](#L490) | } |
| [491](#L491) |  |
| [492](#L492) | if(isset($\_REQUEST[$field->name])) |
| [493](#L493) | $value = pmpro\_sanitize( $\_REQUEST[$field->name], $field ); //phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [494](#L494) | elseif(isset($\_FILES[$field->name])) |
| [495](#L495) | { |
| [496](#L496) | $value = sanitize\_file\_name( $\_FILES[$field->name]['name'] ); |
| [497](#L497) |  |
| [498](#L498) | //handle empty file but the user already has a file |
| [499](#L499) | if(empty($value) && !empty($\_REQUEST[$field->name . "\_old"])) |
| [500](#L500) | $value = sanitize\_file\_name( $\_REQUEST[$field->name . "\_old"] ); |
| [501](#L501) | elseif(!empty($value)) |
| [502](#L502) | { |
| [503](#L503) | //check extension against allowed extensions |
| [504](#L504) | $filetype = wp\_check\_filetype\_and\_ext( sanitize\_text\_field( $\_FILES[$field->name]['tmp\_name'] ), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ); |
| [505](#L505) | if((!$filetype['type'] || !$filetype['ext'] ) && !current\_user\_can( 'unfiltered\_upload' )) |
| [506](#L506) | { |
| [507](#L507) | if($okay)       //only want to update message if there is no previous error |
| [508](#L508) | pmpro\_setMessage( sprintf( \_\_( "Sorry, the file type for %s is not permitted for security reasons.", "paid-memberships-pro"), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ), "pmpro\_error"); |
| [509](#L509) | return false; |
| [510](#L510) | } |
| [511](#L511) | else |
| [512](#L512) | { |
| [513](#L513) | //check for specific extensions anyway |
| [514](#L514) | if(!empty($field->ext) && !in\_array($filetype['ext'], $field->ext)) |
| [515](#L515) | { |
| [516](#L516) | if($okay)       //only want to update message if there is no previous error |
| [517](#L517) | pmpro\_setMessage( sprintf( \_\_( "Sorry, the file type for %s is not permitted for security reasons.", "paid-memberships-pro"), sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ), "pmpro\_error"); |
| [518](#L518) | return false; |
| [519](#L519) | } |
| [520](#L520) | } |
| [521](#L521) | } |
| [522](#L522) | } |
| [523](#L523) | else |
| [524](#L524) | $value = false; |
| [525](#L525) |  |
| [526](#L526) | if( ! $field->was\_filled\_if\_needed() ) { |
| [527](#L527) | $required[] = $field->name; |
| [528](#L528) | $required\_labels[] = $field->label; |
| [529](#L529) | } |
| [530](#L530) | } |
| [531](#L531) | } |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | if(!empty($required)) |
| [535](#L535) | { |
| [536](#L536) | $required = array\_unique($required); |
| [537](#L537) |  |
| [538](#L538) | //add them to error fields |
| [539](#L539) | global $pmpro\_error\_fields; |
| [540](#L540) | $pmpro\_error\_fields = array\_merge((array)$pmpro\_error\_fields, $required); |
| [541](#L541) |  |
| [542](#L542) | if( count( $required ) == 1 ) { |
| [543](#L543) | $pmpro\_msg = sprintf( \_\_( 'The %s field is required.', 'paid-memberships-pro' ),  implode(", ", $required\_labels) ); |
| [544](#L544) | $pmpro\_msgt = 'pmpro\_error'; |
| [545](#L545) | } else { |
| [546](#L546) | $pmpro\_msg = sprintf( \_\_( 'The %s fields are required.', 'paid-memberships-pro' ),  implode(", ", $required\_labels) ); |
| [547](#L547) | $pmpro\_msgt = 'pmpro\_error'; |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | if($okay) |
| [551](#L551) | pmpro\_setMessage($pmpro\_msg, $pmpro\_msgt); |
| [552](#L552) |  |
| [553](#L553) | return false; |
| [554](#L554) | } |
| [555](#L555) |  |
| [556](#L556) | //return whatever status was before |
| [557](#L557) | return $okay; |
| [558](#L558) | } |
| [559](#L559) | add\_filter( 'pmpro\_registration\_checks', 'pmpro\_registration\_checks\_for\_user\_fields' ); |
| [560](#L560) |  |
| [561](#L561) | /\*\* |
| [562](#L562) | \* Sessions vars for TwoCheckout. PayPal Express was updated to store in order meta. |
| [563](#L563) | \*/ |
| [564](#L564) | function pmpro\_paypalexpress\_session\_vars\_for\_user\_fields() { |
| [565](#L565) | global $pmpro\_user\_fields; |
| [566](#L566) |  |
| [567](#L567) | //save our added fields in session while the user goes off to PayPal |
| [568](#L568) | if(!empty($pmpro\_user\_fields)) |
| [569](#L569) | { |
| [570](#L570) | //cycle through groups |
| [571](#L571) | foreach($pmpro\_user\_fields as $where => $fields) |
| [572](#L572) | { |
| [573](#L573) | //cycle through fields |
| [574](#L574) | foreach($fields as $field) |
| [575](#L575) | { |
| [576](#L576) | if( ! pmpro\_is\_field( $field ) ) { |
| [577](#L577) | continue; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | if ( ! pmpro\_check\_field\_for\_level( $field ) ) { |
| [581](#L581) | continue; |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | if( isset( $\_REQUEST[$field->name] ) ) { |
| [585](#L585) | $\_SESSION[$field->name] = pmpro\_sanitize( $\_REQUEST[$field->name], $field ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [586](#L586) | } elseif ( isset( $\_FILES[$field->name] ) ) { |
| [587](#L587) | /\* |
| [588](#L588) | We need to save the file somewhere and save values in $\_SESSION |
| [589](#L589) | \*/ |
| [590](#L590) |  |
| [591](#L591) | // Make sure file was uploaded. |
| [592](#L592) | if ( ! is\_uploaded\_file( sanitize\_text\_field( $\_FILES[$field->name]['tmp\_name'] ) ) ) { |
| [593](#L593) | continue; |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | //check for a register helper directory in wp-content |
| [597](#L597) | $upload\_dir = wp\_upload\_dir(); |
| [598](#L598) | $pmprorh\_dir = $upload\_dir['basedir'] . "/pmpro-register-helper/tmp/"; |
| [599](#L599) |  |
| [600](#L600) | //create the dir and subdir if needed |
| [601](#L601) | if(!is\_dir($pmprorh\_dir)) |
| [602](#L602) | { |
| [603](#L603) | wp\_mkdir\_p($pmprorh\_dir); |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | //move file |
| [607](#L607) | $new\_filename = $pmprorh\_dir . basename( sanitize\_file\_name( $\_FILES[$field->name]['name'] ) ); |
| [608](#L608) | move\_uploaded\_file( sanitize\_text\_field( $\_FILES[$field->name]['tmp\_name'] ), $new\_filename ); |
| [609](#L609) |  |
| [610](#L610) | //update location of file |
| [611](#L611) | $\_FILES[$field->name]['tmp\_name'] = $new\_filename; |
| [612](#L612) |  |
| [613](#L613) | //save file info in session |
| [614](#L614) | $\_SESSION[$field->name] = array\_map( 'sanitize\_text\_field', $\_FILES[$field->name] ); |
| [615](#L615) | } |
| [616](#L616) | } |
| [617](#L617) | } |
| [618](#L618) | } |
| [619](#L619) | } |
| [620](#L620) | add\_action( 'pmpro\_before\_send\_to\_twocheckout', 'pmpro\_paypalexpress\_session\_vars\_for\_user\_fields', 10, 0); |
| [621](#L621) |  |
| [622](#L622) | /\*\* |
| [623](#L623) | \* Show user fields in profile. |
| [624](#L624) | \*/ |
| [625](#L625) | function pmpro\_show\_user\_fields\_in\_profile( $user, $withlocations = false ) { |
| [626](#L626) | global $pmpro\_user\_fields; |
| [627](#L627) |  |
| [628](#L628) | //which fields are marked for the profile |
| [629](#L629) | $profile\_fields = pmpro\_get\_user\_fields\_for\_profile($user->ID, $withlocations); |
| [630](#L630) |  |
| [631](#L631) | //show the fields |
| [632](#L632) | if(!empty($profile\_fields) && $withlocations) |
| [633](#L633) | { |
| [634](#L634) | foreach($profile\_fields as $where => $fields) |
| [635](#L635) | { |
| [636](#L636) | $box = pmpro\_get\_field\_group\_by\_name($where); |
| [637](#L637) |  |
| [638](#L638) | if ( !empty($box->label) ) { |
| [639](#L639) | ?> |
| [640](#L640) | <h2><?php echo wp\_kses\_post( $box->label ); ?></h2> |
| [641](#L641) | <?php |
| [642](#L642) | if ( ! empty( $box->description ) ) { |
| [643](#L643) | ?> |
| [644](#L644) | <p><?php echo wp\_kses\_post( $box->description ); ?></p> |
| [645](#L645) | <?php |
| [646](#L646) | } |
| [647](#L647) | } |
| [648](#L648) | ?> |
| [649](#L649) |  |
| [650](#L650) |  |
| [651](#L651) | <table class="form-table"> |
| [652](#L652) | <?php |
| [653](#L653) | //cycle through groups |
| [654](#L654) | foreach($fields as $field) |
| [655](#L655) | { |
| [656](#L656) | if ( pmpro\_is\_field( $field ) ) |
| [657](#L657) | $field->displayInProfile($user->ID); |
| [658](#L658) | } |
| [659](#L659) | ?> |
| [660](#L660) | </table> |
| [661](#L661) | <?php |
| [662](#L662) | } |
| [663](#L663) | } |
| [664](#L664) | elseif(!empty($profile\_fields)) |
| [665](#L665) | { |
| [666](#L666) | ?> |
| [667](#L667) | <table class="form-table"> |
| [668](#L668) | <?php |
| [669](#L669) | //cycle through groups |
| [670](#L670) | foreach($profile\_fields as $field) |
| [671](#L671) | { |
| [672](#L672) | if ( pmpro\_is\_field( $field ) ) { |
| [673](#L673) | $field->displayInProfile($user->ID); |
| [674](#L674) | } |
| [675](#L675) | } |
| [676](#L676) | ?> |
| [677](#L677) | </table> |
| [678](#L678) | <?php |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) | function pmpro\_show\_user\_fields\_in\_profile\_with\_locations( $user ) { |
| [682](#L682) | pmpro\_show\_user\_fields\_in\_profile($user, true); |
| [683](#L683) | } |
| [684](#L684) | add\_action( 'show\_user\_profile', 'pmpro\_show\_user\_fields\_in\_profile\_with\_locations' ); |
| [685](#L685) | add\_action( 'edit\_user\_profile', 'pmpro\_show\_user\_fields\_in\_profile\_with\_locations' ); |
| [686](#L686) |  |
| [687](#L687) | /\*\* |
| [688](#L688) | \* Show Profile fields on the frontend "Member Profile Edit" page. |
| [689](#L689) | \* |
| [690](#L690) | \* @since 2.3 |
| [691](#L691) | \*/ |
| [692](#L692) | function pmpro\_show\_user\_fields\_in\_frontend\_profile( $user, $withlocations = false ) { |
| [693](#L693) | global $pmpro\_user\_fields; |
| [694](#L694) |  |
| [695](#L695) | //which fields are marked for the profile |
| [696](#L696) | $profile\_fields = pmpro\_get\_user\_fields\_for\_profile($user->ID, $withlocations); |
| [697](#L697) |  |
| [698](#L698) | //show the fields |
| [699](#L699) | if ( ! empty( $profile\_fields ) && $withlocations ) { |
| [700](#L700) | foreach( $profile\_fields as $where => $fields ) { |
| [701](#L701) | $box = pmpro\_get\_field\_group\_by\_name( $where ); |
| [702](#L702) |  |
| [703](#L703) | // Only show on front-end if there are fields to be shown. |
| [704](#L704) | $show\_fields = false; |
| [705](#L705) | foreach( $fields as $key => $field ) { |
| [706](#L706) | if ( $field->profile !== 'only\_admin' ) { |
| [707](#L707) | $show\_fields = true; |
| [708](#L708) | } |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | // Bail if there are no fields to show on the front-end profile. |
| [712](#L712) | if ( ! $show\_fields ) { |
| [713](#L713) | continue; |
| [714](#L714) | } |
| [715](#L715) | ?> |
| [716](#L716) |  |
| [717](#L717) | <div class="pmpro\_checkout\_box-<?php echo sanitize\_title( $where ); ?>"> |
| [718](#L718) | <?php if ( ! empty( $box->label ) ) { ?> |
| [719](#L719) | <h2><?php echo wp\_kses\_post( $box->label ); ?></h2> |
| [720](#L720) | <?php } ?> |
| [721](#L721) |  |
| [722](#L722) | <div class="pmpro\_member\_profile\_edit-fields"> |
| [723](#L723) | <?php if ( ! empty( $box->description ) ) { ?> |
| [724](#L724) | <div class="pmpro\_checkout\_description"><?php echo wp\_kses\_post( $box->description ); ?></div> |
| [725](#L725) | <?php } ?> |
| [726](#L726) |  |
| [727](#L727) | <?php |
| [728](#L728) | // Cycle through groups. |
| [729](#L729) | foreach( $fields as $field ) { |
| [730](#L730) | if ( pmpro\_is\_field( $field ) && $field->profile !== 'only\_admin' ) { |
| [731](#L731) | $field->displayAtCheckout( $user->ID ); |
| [732](#L732) | } |
| [733](#L733) | } |
| [734](#L734) | ?> |
| [735](#L735) | </div> <!-- end pmpro\_member\_profile\_edit-fields --> |
| [736](#L736) | </div> <!-- end pmpro\_checkout\_box-name --> |
| [737](#L737) | <?php |
| [738](#L738) | } |
| [739](#L739) | } elseif ( ! empty( $profile\_fields ) ) { ?> |
| [740](#L740) | <div class="pmpro\_member\_profile\_edit-fields"> |
| [741](#L741) | <?php |
| [742](#L742) | // Cycle through groups. |
| [743](#L743) | foreach( $profile\_fields as $field ) { |
| [744](#L744) | if ( pmpro\_is\_field( $field ) && $field->profile !== 'only\_admin' ) { |
| [745](#L745) | $field->displayAtCheckout( $user->ID ); |
| [746](#L746) | } |
| [747](#L747) | } |
| [748](#L748) | ?> |
| [749](#L749) | </div> <!-- end pmpro\_member\_profile\_edit-fields --> |
| [750](#L750) | <?php |
| [751](#L751) | } |
| [752](#L752) | } |
| [753](#L753) | function pmpro\_show\_user\_fields\_in\_frontend\_profile\_with\_locations( $user ) { |
| [754](#L754) | pmpro\_show\_user\_fields\_in\_frontend\_profile($user, true); |
| [755](#L755) | } |
| [756](#L756) | add\_action( 'pmpro\_show\_user\_profile', 'pmpro\_show\_user\_fields\_in\_frontend\_profile\_with\_locations' ); |
| [757](#L757) |  |
| [758](#L758) | /\*\* |
| [759](#L759) | \* Show user fields on the Add Member form |
| [760](#L760) | \* when using the Add Member Admin Add On. |
| [761](#L761) | \*/ |
| [762](#L762) | // Add fields to form. |
| [763](#L763) | function pmpro\_add\_member\_admin\_fields( $user = null, $user\_id = null) |
| [764](#L764) | { |
| [765](#L765) | global $pmpro\_user\_fields; |
| [766](#L766) |  |
| [767](#L767) | $addmember\_fields = array(); |
| [768](#L768) | if(!empty($pmpro\_user\_fields)) |
| [769](#L769) | { |
| [770](#L770) | //cycle through groups |
| [771](#L771) | foreach($pmpro\_user\_fields as $where => $fields) |
| [772](#L772) | { |
| [773](#L773) | //cycle through fields |
| [774](#L774) | foreach($fields as $field) |
| [775](#L775) | { |
| [776](#L776) | if(pmpro\_is\_field($field) && isset($field->addmember) && !empty($field->addmember) && ( in\_array( strtolower( $field->addmember ), array( 'true', 'yes' ) ) || true == $field->addmember ) ) |
| [777](#L777) | { |
| [778](#L778) | $addmember\_fields[] = $field; |
| [779](#L779) | } |
| [780](#L780) | } |
| [781](#L781) | } |
| [782](#L782) | } |
| [783](#L783) |  |
| [784](#L784) |  |
| [785](#L785) | //show the fields |
| [786](#L786) | if(!empty($addmember\_fields)) |
| [787](#L787) | { |
| [788](#L788) | ?> |
| [789](#L789) | <?php |
| [790](#L790) | //cycle through groups |
| [791](#L791) | foreach($addmember\_fields as $field) |
| [792](#L792) | { |
| [793](#L793) | if(empty($user\_id) && !empty($user) && !empty($user->ID)) { |
| [794](#L794) | $user\_id = $user->ID; |
| [795](#L795) | } |
| [796](#L796) |  |
| [797](#L797) | if( pmpro\_is\_field( $field ) ) { |
| [798](#L798) | $field->displayInProfile($user\_id); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | } |
| [802](#L802) | ?> |
| [803](#L803) | <?php |
| [804](#L804) | } |
| [805](#L805) | } |
| [806](#L806) | add\_action( 'pmpro\_add\_member\_fields', 'pmpro\_add\_member\_admin\_fields', 10, 2 ); |
| [807](#L807) |  |
| [808](#L808) | /\*\* |
| [809](#L809) | \* Save user fields on the Add Member Admin form. |
| [810](#L810) | \* Hooks into pmpro\_add\_member\_added. |
| [811](#L811) | \* @since 2.9 |
| [812](#L812) | \* @param int $uid The user ID. |
| [813](#L813) | \* @param object $user The user object. |
| [814](#L814) | \* @return void |
| [815](#L815) | \*/ |
| [816](#L816) | function pmpro\_add\_member\_admin\_save\_user\_fields( $uid = null, $user = null ) { |
| [817](#L817) | global $pmpro\_user\_fields; |
| [818](#L818) |  |
| [819](#L819) | // Use the ID from the $user object if passed in. |
| [820](#L820) | if ( ! empty( $user ) && is\_object( $user ) ) { |
| [821](#L821) | $user\_id = $user->ID; |
| [822](#L822) | } |
| [823](#L823) |  |
| [824](#L824) | // Otherwise, let's use the $uid passed in. |
| [825](#L825) | if ( !empty( $uid ) && ( empty( $user ) || !is\_object( $user ) ) ) { |
| [826](#L826) | $user\_id = $uid; |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | // check whether the user login variable contains something useful |
| [830](#L830) | if (empty($user\_id)) { |
| [831](#L831) |  |
| [832](#L832) | pmpro\_setMessage( \_\_( 'Unable to add/update user fields for this member', 'paid-memberships-pro' ), 'pmpro\_error' ); |
| [833](#L833) |  |
| [834](#L834) | return false; |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | $addmember\_fields = array(); |
| [838](#L838) | if(!empty($pmpro\_user\_fields)) |
| [839](#L839) | { |
| [840](#L840) | //cycle through groups |
| [841](#L841) | foreach($pmpro\_user\_fields as $where => $fields) |
| [842](#L842) | { |
| [843](#L843) | //cycle through fields |
| [844](#L844) | foreach($fields as $field) |
| [845](#L845) | { |
| [846](#L846) | if(pmpro\_is\_field($field) && isset($field->addmember) && !empty($field->addmember) && ( in\_array( strtolower( $field->addmember ), array( 'true', 'yes' ) ) || true == $field->addmember ) ) |
| [847](#L847) | { |
| [848](#L848) | $addmember\_fields[] = $field; |
| [849](#L849) | } |
| [850](#L850) | } |
| [851](#L851) | } |
| [852](#L852) | } |
| [853](#L853) |  |
| [854](#L854) | //save our added fields in session while the user goes off to PayPal |
| [855](#L855) | if(!empty($addmember\_fields)) |
| [856](#L856) | { |
| [857](#L857) | //cycle through fields |
| [858](#L858) | foreach($addmember\_fields as $field) |
| [859](#L859) | { |
| [860](#L860) | if(pmpro\_is\_field($field) && isset($\_POST[$field->name]) || isset($\_FILES[$field->name])) |
| [861](#L861) | { |
| [862](#L862) | // Sanitize by default, or not. Some fields may have custom save functions/etc. |
| [863](#L863) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [864](#L864) | if ( ! empty( $field->sanitize ) && isset( $\_POST[ $field->name ] ) ) { |
| [865](#L865) | $value = pmpro\_sanitize( $\_POST[ $field->name ], $field ); |
| [866](#L866) | } elseif( isset($\_POST[$field->name]) ) { |
| [867](#L867) | $value = $\_POST[ $field->name ]; |
| [868](#L868) | } else { |
| [869](#L869) | $value = $\_FILES[$field->name]; |
| [870](#L870) | } |
| [871](#L871) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [872](#L872) |  |
| [873](#L873) | //callback? |
| [874](#L874) | if(!empty($field->save\_function)) |
| [875](#L875) | call\_user\_func($field->save\_function, $user\_id, $field->name, $value ); |
| [876](#L876) | else |
| [877](#L877) | update\_user\_meta($user\_id, $field->meta\_key, $value ); |
| [878](#L878) | } |
| [879](#L879) | elseif(pmpro\_is\_field($field) && !empty($\_POST[$field->name . "\_checkbox"]) && $field->type == 'checkbox')  //handle unchecked checkboxes |
| [880](#L880) | { |
| [881](#L881) | //callback? |
| [882](#L882) | if(!empty($field->save\_function)) |
| [883](#L883) | call\_user\_func($field->save\_function, $user\_id, $field->name, 0); |
| [884](#L884) | else |
| [885](#L885) | update\_user\_meta($user\_id, $field->meta\_key, 0); |
| [886](#L886) | } |
| [887](#L887) | elseif(!empty($\_POST[$field->name . "\_checkbox"]) && in\_array( $field->type, array( 'checkbox', 'checkbox\_grouped', 'select2' ) ) )     //handle unchecked checkboxes |
| [888](#L888) | { |
| [889](#L889) | //callback? |
| [890](#L890) | if(!empty($field->save\_function)) |
| [891](#L891) | call\_user\_func($field->save\_function, $user\_id, $field->name, array()); |
| [892](#L892) | else |
| [893](#L893) | update\_user\_meta($user\_id, $field->meta\_key, array()); |
| [894](#L894) | } |
| [895](#L895) | } |
| [896](#L896) | } |
| [897](#L897) | } |
| [898](#L898) | add\_action( 'pmpro\_add\_member\_added', 'pmpro\_add\_member\_admin\_save\_user\_fields', 10, 2 ); |
| [899](#L899) |  |
| [900](#L900) | /\*\* |
| [901](#L901) | \* Get RH fields which are set to showup in the Members List CSV Export. |
| [902](#L902) | \*/ |
| [903](#L903) | function pmpro\_get\_user\_fields\_for\_csv() { |
| [904](#L904) | global $pmpro\_user\_fields; |
| [905](#L905) |  |
| [906](#L906) | $csv\_fields = array(); |
| [907](#L907) | if(!empty($pmpro\_user\_fields)) |
| [908](#L908) | { |
| [909](#L909) | //cycle through groups |
| [910](#L910) | foreach($pmpro\_user\_fields as $where => $fields) |
| [911](#L911) | { |
| [912](#L912) | //cycle through fields |
| [913](#L913) | foreach($fields as $field) |
| [914](#L914) | { |
| [915](#L915) | if(pmpro\_is\_field($field) && !empty($field->memberslistcsv) && ($field->memberslistcsv == "true")) |
| [916](#L916) | { |
| [917](#L917) | $csv\_fields[] = $field; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | } |
| [921](#L921) | } |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | return $csv\_fields; |
| [925](#L925) | } |
| [926](#L926) |  |
| [927](#L927) | /\*\* |
| [928](#L928) | \* Get user fields which are marked to show in the profile. |
| [929](#L929) | \* If a $user\_id is passed in, get fields based on the user's level. |
| [930](#L930) | \*/ |
| [931](#L931) | function pmpro\_get\_user\_fields\_for\_profile( $user\_id, $withlocations = false ) { |
| [932](#L932) | global $pmpro\_user\_fields; |
| [933](#L933) |  |
| [934](#L934) | $profile\_fields = array(); |
| [935](#L935) | if(!empty($pmpro\_user\_fields)) |
| [936](#L936) | { |
| [937](#L937) | //cycle through groups |
| [938](#L938) | foreach($pmpro\_user\_fields as $where => $fields) |
| [939](#L939) | { |
| [940](#L940) | //cycle through fields |
| [941](#L941) | foreach($fields as $field) |
| [942](#L942) | { |
| [943](#L943) | if( ! pmpro\_is\_field( $field ) ) { |
| [944](#L944) | continue; |
| [945](#L945) | } |
| [946](#L946) |  |
| [947](#L947) | if ( ! pmpro\_check\_field\_for\_level( $field, "profile", $user\_id ) ) { |
| [948](#L948) | continue; |
| [949](#L949) | } |
| [950](#L950) |  |
| [951](#L951) | if(!empty($field->profile) && ($field->profile === "admins" || $field->profile === "admin" || $field->profile === "only\_admin")) |
| [952](#L952) | { |
| [953](#L953) | if( current\_user\_can( 'manage\_options' ) || current\_user\_can( 'pmpro\_membership\_manager' ) ) |
| [954](#L954) | { |
| [955](#L955) | if($withlocations) |
| [956](#L956) | $profile\_fields[$where][] = $field; |
| [957](#L957) | else |
| [958](#L958) | $profile\_fields[] = $field; |
| [959](#L959) | } |
| [960](#L960) | } |
| [961](#L961) | elseif(!empty($field->profile)) |
| [962](#L962) | { |
| [963](#L963) | if($withlocations) |
| [964](#L964) | $profile\_fields[$where][] = $field; |
| [965](#L965) | else |
| [966](#L966) | $profile\_fields[] = $field; |
| [967](#L967) | } |
| [968](#L968) | } |
| [969](#L969) | } |
| [970](#L970) | } |
| [971](#L971) |  |
| [972](#L972) | return $profile\_fields; |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | /\*\* |
| [976](#L976) | \* Change the enctype of the edit user form in case files need to be uploaded. |
| [977](#L977) | \*/ |
| [978](#L978) | function pmpro\_user\_edit\_form\_tag() { |
| [979](#L979) | echo ' enctype="multipart/form-data"'; |
| [980](#L980) | } |
| [981](#L981) | add\_action( 'user\_edit\_form\_tag', 'pmpro\_user\_edit\_form\_tag' ); |
| [982](#L982) |  |
| [983](#L983) | /\*\* |
| [984](#L984) | \* Save profile fields. |
| [985](#L985) | \*/ |
| [986](#L986) | function pmpro\_save\_user\_fields\_in\_profile( $user\_id ) |
| [987](#L987) | { |
| [988](#L988) | if ( !current\_user\_can( 'edit\_user', $user\_id ) ) |
| [989](#L989) | return false; |
| [990](#L990) |  |
| [991](#L991) | $profile\_fields = pmpro\_get\_user\_fields\_for\_profile($user\_id); |
| [992](#L992) |  |
| [993](#L993) | //save our added fields in session while the user goes off to PayPal |
| [994](#L994) | if(!empty($profile\_fields)) |
| [995](#L995) | { |
| [996](#L996) | //cycle through fields |
| [997](#L997) | foreach($profile\_fields as $field) |
| [998](#L998) | { |
| [999](#L999) | if( ! pmpro\_is\_field( $field ) ) { |
| [1000](#L1000) | continue; |
| [1001](#L1001) | } |
| [1002](#L1002) |  |
| [1003](#L1003) | if(isset($\_POST[$field->name]) || isset($\_FILES[$field->name])) |
| [1004](#L1004) | { |
| [1005](#L1005) | // Sanitize by default, or not. Some fields may have custom save functions/etc. |
| [1006](#L1006) | // phpcs:disable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [1007](#L1007) | if ( ! empty( $field->sanitize ) && isset( $\_POST[ $field->name ] ) ) { |
| [1008](#L1008) | $value = pmpro\_sanitize( $\_POST[ $field->name ], $field ); |
| [1009](#L1009) | } elseif( isset($\_POST[$field->name]) ) { |
| [1010](#L1010) | $value = $\_POST[ $field->name ]; |
| [1011](#L1011) | } else { |
| [1012](#L1012) | $value = $\_FILES[$field->name]; |
| [1013](#L1013) | } |
| [1014](#L1014) | // phpcs:enable WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [1015](#L1015) |  |
| [1016](#L1016) | //callback? |
| [1017](#L1017) | if(!empty($field->save\_function)) |
| [1018](#L1018) | call\_user\_func($field->save\_function, $user\_id, $field->name, $value); |
| [1019](#L1019) | else |
| [1020](#L1020) | update\_user\_meta($user\_id, $field->meta\_key, $value); |
| [1021](#L1021) | } |
| [1022](#L1022) | elseif(!empty($\_POST[$field->name . "\_checkbox"]) && $field->type == 'checkbox')        //handle unchecked checkboxes |
| [1023](#L1023) | { |
| [1024](#L1024) | //callback? |
| [1025](#L1025) | if(!empty($field->save\_function)) |
| [1026](#L1026) | call\_user\_func($field->save\_function, $user\_id, $field->name, 0); |
| [1027](#L1027) | else |
| [1028](#L1028) | update\_user\_meta($user\_id, $field->meta\_key, 0); |
| [1029](#L1029) | } |
| [1030](#L1030) | elseif(!empty($\_POST[$field->name . "\_checkbox"]) && in\_array( $field->type, array( 'checkbox', 'checkbox\_grouped', 'select2' ) ) )     //handle unchecked checkboxes |
| [1031](#L1031) | { |
| [1032](#L1032) | //callback? |
| [1033](#L1033) | if(!empty($field->save\_function)) |
| [1034](#L1034) | call\_user\_func($field->save\_function, $user\_id, $field->name, array()); |
| [1035](#L1035) | else |
| [1036](#L1036) | update\_user\_meta($user\_id, $field->meta\_key, array()); |
| [1037](#L1037) | } |
| [1038](#L1038) | } |
| [1039](#L1039) | } |
| [1040](#L1040) | } |
| [1041](#L1041) | add\_action( 'personal\_options\_update', 'pmpro\_save\_user\_fields\_in\_profile' ); |
| [1042](#L1042) | add\_action( 'edit\_user\_profile\_update', 'pmpro\_save\_user\_fields\_in\_profile' ); |
| [1043](#L1043) | add\_action( 'pmpro\_personal\_options\_update', 'pmpro\_save\_user\_fields\_in\_profile' ); |
| [1044](#L1044) |  |
| [1045](#L1045) | /\*\* |
| [1046](#L1046) | \* Add user fields to confirmation email. |
| [1047](#L1047) | \*/ |
| [1048](#L1048) | function pmpro\_add\_user\_fields\_to\_email( $email ) { |
| [1049](#L1049) | global $wpdb, $pmpro\_user\_fields, $pmpro\_field\_groups; |
| [1050](#L1050) |  |
| [1051](#L1051) | //only update admin confirmation emails |
| [1052](#L1052) | if ( ! empty( $email ) && strpos( $email->template, "checkout" ) !== false && strpos( $email->template, "admin" ) !== false ) { |
| [1053](#L1053) | //get the user\_id from the email |
| [1054](#L1054) | $user\_id = $wpdb->get\_var( "SELECT ID FROM $wpdb->users WHERE user\_email = '" . esc\_sql( $email->data['user\_email'] ) . "' LIMIT 1" ); |
| [1055](#L1055) | $level\_id = empty( $email->data['membership\_id'] ) ? null : intval( $email->data['membership\_id'] ); |
| [1056](#L1056) |  |
| [1057](#L1057) | if ( ! empty( $user\_id ) ) { |
| [1058](#L1058) |  |
| [1059](#L1059) |  |
| [1060](#L1060) | //add to bottom of email |
| [1061](#L1061) | if ( ! empty( $pmpro\_field\_groups ) ) { |
| [1062](#L1062) | $fields\_content = "<p>" . \_\_( 'Extra Fields:', 'paid-memberships-pro' ) . "<br />"; |
| [1063](#L1063) | $added\_field = false; |
| [1064](#L1064) | //cycle through groups |
| [1065](#L1065) | foreach( $pmpro\_field\_groups as $group ) { |
| [1066](#L1066) |  |
| [1067](#L1067) | // Get the groups name so we can grab it from the associative array. |
| [1068](#L1068) | $group\_name = $group->name; |
| [1069](#L1069) |  |
| [1070](#L1070) | // Skip if there are no fields in this group. |
| [1071](#L1071) | if ( empty( $pmpro\_user\_fields[$group\_name] ) ) { |
| [1072](#L1072) | continue; |
| [1073](#L1073) | } |
| [1074](#L1074) |  |
| [1075](#L1075) | //cycle through groups and fields associated with that group. |
| [1076](#L1076) | foreach( $pmpro\_user\_fields[$group\_name] as $field ) { |
| [1077](#L1077) |  |
| [1078](#L1078) | if ( ! pmpro\_is\_field( $field ) ) { |
| [1079](#L1079) | continue; |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | // If the field is showing only in the profile or to admins we can skip it. |
| [1083](#L1083) | if ( ! empty( $field->profile ) && ( $field->profile === "only" || $field->profile === "only\_admin" ) ) { |
| [1084](#L1084) | continue; |
| [1085](#L1085) | } |
| [1086](#L1086) |  |
| [1087](#L1087) | // Let's make sure the field level ID's are the same as the one they checked out for. |
| [1088](#L1088) | if ( ! empty( $field->levels ) &&  ( empty( $level\_id) || ! in\_array( $level\_id, $field->levels ) ) ) { |
| [1089](#L1089) | continue; |
| [1090](#L1090) | } |
| [1091](#L1091) |  |
| [1092](#L1092) | $fields\_content .= "- " . esc\_html( $field->label ) . ": "; |
| [1093](#L1093) | $value = get\_user\_meta( $user\_id, $field->name, true); |
| [1094](#L1094) |  |
| [1095](#L1095) | // Get the label value for field types that have labels. |
| [1096](#L1096) | $value = pmpro\_get\_label\_for\_user\_field\_value( $field->name, $value ); |
| [1097](#L1097) |  |
| [1098](#L1098) | if ( $field->type == "file" && is\_array( $value ) && ! empty( $value['fullurl'] ) ) { |
| [1099](#L1099) | $fields\_content .= pmpro\_sanitize( $value['fullurl'], $field ); |
| [1100](#L1100) | } elseif( is\_array( $value  ) ) { |
| [1101](#L1101) | $fields\_content .= implode(", ", pmpro\_sanitize( $value, $field ) ); |
| [1102](#L1102) | } else { |
| [1103](#L1103) | $fields\_content .= pmpro\_sanitize( $value, $field ); |
| [1104](#L1104) | } |
| [1105](#L1105) |  |
| [1106](#L1106) | $fields\_content .= "<br />"; |
| [1107](#L1107) | $added\_field = true; |
| [1108](#L1108) | } |
| [1109](#L1109) | } |
| [1110](#L1110) | $fields\_content .= "</p>"; |
| [1111](#L1111) | if ( $added\_field ) { |
| [1112](#L1112) | $email->body .= $fields\_content; |
| [1113](#L1113) | } |
| [1114](#L1114) | } |
| [1115](#L1115) | } |
| [1116](#L1116) | } |
| [1117](#L1117) |  |
| [1118](#L1118) | return $email; |
| [1119](#L1119) | } |
| [1120](#L1120) | add\_filter( 'pmpro\_email\_filter', 'pmpro\_add\_user\_fields\_to\_email', 10, 2 ); |
| [1121](#L1121) |  |
| [1122](#L1122) | /\*\* |
| [1123](#L1123) | \* Add CSV fields to the Member's List CSV Export. |
| [1124](#L1124) | \*/ |
| [1125](#L1125) | function pmpro\_members\_list\_csv\_extra\_columns\_for\_user\_fields($columns) |
| [1126](#L1126) | { |
| [1127](#L1127) | $csv\_cols = pmpro\_get\_user\_fields\_for\_csv(); |
| [1128](#L1128) | foreach($csv\_cols as $key => $value) |
| [1129](#L1129) | { |
| [1130](#L1130) | $columns[$value->meta\_key] = "pmpro\_csv\_columns\_for\_user\_fields"; |
| [1131](#L1131) | } |
| [1132](#L1132) |  |
| [1133](#L1133) | return $columns; |
| [1134](#L1134) | } |
| [1135](#L1135) | add\_filter( 'pmpro\_members\_list\_csv\_extra\_columns', 'pmpro\_members\_list\_csv\_extra\_columns\_for\_user\_fields', 10 ); |
| [1136](#L1136) |  |
| [1137](#L1137) | /\*\* |
| [1138](#L1138) | \* Get user meta for the added CSV columns. |
| [1139](#L1139) | \*/ |
| [1140](#L1140) | function pmpro\_csv\_columns\_for\_user\_fields( $user, $column ) { |
| [1141](#L1141) | if(!empty($user->metavalues->{$column})) |
| [1142](#L1142) | { |
| [1143](#L1143) | // check for multiple values |
| [1144](#L1144) | $value = maybe\_unserialize($user->metavalues->{$column}); |
| [1145](#L1145) | if(is\_array($value)) |
| [1146](#L1146) | $value = join(',', $value); |
| [1147](#L1147) |  |
| [1148](#L1148) | return $value; |
| [1149](#L1149) | } |
| [1150](#L1150) | else |
| [1151](#L1151) | { |
| [1152](#L1152) | return ""; |
| [1153](#L1153) | } |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | /\*\* |
| [1157](#L1157) | \* Delete old files in wp-content/uploads/pmpro-register-helper/tmp every day. |
| [1158](#L1158) | \*/ |
| [1159](#L1159) | function pmpro\_cron\_delete\_tmp() { |
| [1160](#L1160) | $upload\_dir = wp\_upload\_dir(); |
| [1161](#L1161) | $pmprorh\_dir = $upload\_dir['basedir'] . "/paid-memberships-pro/tmp/"; |
| [1162](#L1162) |  |
| [1163](#L1163) | if(file\_exists($pmprorh\_dir) && $handle = opendir($pmprorh\_dir)) |
| [1164](#L1164) | { |
| [1165](#L1165) | while(false !== ($file = readdir($handle))) |
| [1166](#L1166) | { |
| [1167](#L1167) | $file = $pmprorh\_dir . $file; |
| [1168](#L1168) | $filelastmodified = filemtime($file); |
| [1169](#L1169) | if(is\_file($file) && (time() - $filelastmodified) > 3600) |
| [1170](#L1170) | { |
| [1171](#L1171) | unlink($file); |
| [1172](#L1172) | } |
| [1173](#L1173) | } |
| [1174](#L1174) |  |
| [1175](#L1175) | closedir($handle); |
| [1176](#L1176) | } |
| [1177](#L1177) |  |
| [1178](#L1178) | exit; |
| [1179](#L1179) | } |
| [1180](#L1180) | add\_action( 'pmpro\_cron\_delete\_tmp', 'pmpro\_cron\_delete\_tmp' ); |
| [1181](#L1181) |  |
| [1182](#L1182) | /\*\* |
| [1183](#L1183) | \* Get user fields from global. |
| [1184](#L1184) | \* @since 2.9.3 |
| [1185](#L1185) | \*/ |
| [1186](#L1186) | function pmpro\_get\_user\_fields() { |
| [1187](#L1187) | global $pmpro\_user\_fields; |
| [1188](#L1188) |  |
| [1189](#L1189) | return (array)$pmpro\_user\_fields; |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | // Code for the user fields settings page. |
| [1193](#L1193) | /\*\* |
| [1194](#L1194) | \* Get field group HTML for settings. |
| [1195](#L1195) | \*/ |
| [1196](#L1196) | function pmpro\_get\_field\_group\_html( $group = null ) { |
| [1197](#L1197) | if ( ! empty( $group ) ) { |
| [1198](#L1198) | // Assume group stdClass in format we save to settings. |
| [1199](#L1199) | $group\_name = $group->name; |
| [1200](#L1200) | $group\_show\_checkout = $group->checkout; |
| [1201](#L1201) | $group\_show\_profile = $group->profile; |
| [1202](#L1202) | $group\_description = $group->description; |
| [1203](#L1203) | $group\_levels = $group->levels; |
| [1204](#L1204) | $group\_fields = $group->fields; |
| [1205](#L1205) | } else { |
| [1206](#L1206) | // Default group settings. |
| [1207](#L1207) | $group\_name = ''; |
| [1208](#L1208) | $group\_show\_checkout = 'yes'; |
| [1209](#L1209) | $group\_show\_profile = 'yes'; |
| [1210](#L1210) | $group\_description = ''; |
| [1211](#L1211) | $group\_levels = array(); |
| [1212](#L1212) | $group\_fields = array(); |
| [1213](#L1213) | } |
| [1214](#L1214) |  |
| [1215](#L1215) | // Other vars |
| [1216](#L1216) | $levels = pmpro\_sort\_levels\_by\_order( pmpro\_getAllLevels( true, true ) ); |
| [1217](#L1217) |  |
| [1218](#L1218) | // Render field group HTML. |
| [1219](#L1219) | ?> |
| [1220](#L1220) | <div class="pmpro\_userfield-group"> |
| [1221](#L1221) | <div class="pmpro\_userfield-group-header"> |
| [1222](#L1222) | <div class="pmpro\_userfield-group-buttons"> |
| [1223](#L1223) | <button type="button" aria-disabled="false" class="pmpro\_userfield-group-buttons-button pmpro\_userfield-group-buttons-button-move-up" aria-label="<?php esc\_attr\_e( 'Move up', 'paid-memberships-pro' ); ?>"> |
| [1224](#L1224) | <span class="dashicons dashicons-arrow-up-alt2"></span> |
| [1225](#L1225) | </button> |
| [1226](#L1226) | <span class="pmpro\_userfield-group-buttons-description"><?php esc\_html\_e( 'Move Group Up', 'paid-memberships-pro' ); ?></span> |
| [1227](#L1227) |  |
| [1228](#L1228) | <button type="button" aria-disabled="false" class="pmpro\_userfield-group-buttons-button pmpro\_userfield-group-buttons-button-move-down" aria-label="<?php esc\_attr\_e( 'Move down', 'paid-memberships-pro' ); ?>"> |
| [1229](#L1229) | <span class="dashicons dashicons-arrow-down-alt2"></span> |
| [1230](#L1230) | </button> |
| [1231](#L1231) | <span id="pmpro\_userfield-group-buttons-description-2" class="pmpro\_userfield-group-buttons-description"><?php esc\_html\_e( 'Move Group Down', 'paid-memberships-pro' ); ?></span> |
| [1232](#L1232) | </div> <!-- end pmpro\_userfield-group-buttons --> |
| [1233](#L1233) | <h3> |
| [1234](#L1234) | <label> |
| [1235](#L1235) | <?php esc\_html\_e( 'Group Name', 'paid-memberships-pro' ); ?> |
| [1236](#L1236) | <input type="text" name="pmpro\_userfields\_group\_name" placeholder="<?php esc\_attr\_e( 'Group Name', 'paid-memberships-pro' ); ?>" value="<?php echo esc\_attr( $group\_name ); ?>" /> |
| [1237](#L1237) | </label> |
| [1238](#L1238) | </h3> |
| [1239](#L1239) | <button type="button" aria-disabled="false" class="pmpro\_userfield-group-buttons-button pmpro\_userfield-group-buttons-button-toggle-group" aria-label="<?php esc\_attr\_e( 'Expand and Edit Group', 'paid-memberships-pro' ); ?>"> |
| [1240](#L1240) | <span class="dashicons dashicons-arrow-up"></span> |
| [1241](#L1241) | </button> |
| [1242](#L1242) | <span class="pmpro\_userfield-group-buttons-description"><?php esc\_html\_e( 'Expand and Edit Group', 'paid-memberships-pro' ); ?></span> |
| [1243](#L1243) | </div> <!-- end pmpro\_userfield-group-header --> |
| [1244](#L1244) |  |
| [1245](#L1245) | <div class="pmpro\_userfield-inside"> |
| [1246](#L1246) | <div class="pmpro\_userfield-field-settings"> |
| [1247](#L1247) |  |
| [1248](#L1248) | <div class="pmpro\_userfield-field-setting"> |
| [1249](#L1249) | <label> |
| [1250](#L1250) | <?php esc\_html\_e( 'Show fields at checkout?', 'paid-memberships-pro' ); ?><br /> |
| [1251](#L1251) | <select name="pmpro\_userfields\_group\_checkout"> |
| [1252](#L1252) | <option value="yes" <?php selected( $group\_show\_checkout, 'yes' ); ?>><?php esc\_html\_e( 'Yes', 'paid-memberships-pro' ); ?></option> |
| [1253](#L1253) | <option value="no" <?php selected( $group\_show\_checkout, 'no' ); ?>><?php esc\_html\_e( 'No', 'paid-memberships-pro' ); ?></option> |
| [1254](#L1254) | </select> |
| [1255](#L1255) | </label> |
| [1256](#L1256) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1257](#L1257) |  |
| [1258](#L1258) | <div class="pmpro\_userfield-field-setting"> |
| [1259](#L1259) | <label> |
| [1260](#L1260) | <?php esc\_html\_e( 'Show fields on user profile?', 'paid-memberships-pro' ); ?><br /> |
| [1261](#L1261) | <select name="pmpro\_userfields\_group\_profile"> |
| [1262](#L1262) | <option value="yes" <?php selected( $group\_show\_profile, 'yes' ); ?>><?php esc\_html\_e( 'Yes', 'paid-memberships-pro' ); ?></option> |
| [1263](#L1263) | <option value="admins" <?php selected( $group\_show\_profile, 'admins' ); ?>><?php esc\_html\_e( 'Yes (only admins)', 'paid-memberships-pro' ); ?></option> |
| [1264](#L1264) | <option value="no" <?php selected( $group\_show\_profile, 'no' ); ?>><?php esc\_html\_e( 'No', 'paid-memberships-pro' ); ?></option> |
| [1265](#L1265) | </select> |
| [1266](#L1266) | </label> |
| [1267](#L1267) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1268](#L1268) |  |
| [1269](#L1269) | <div class="pmpro\_userfield-field-setting"> |
| [1270](#L1270) | <label> |
| [1271](#L1271) | <?php esc\_html\_e( 'Description (optional, visible to users)', 'paid-memberships-pro' ); ?><br /> |
| [1272](#L1272) | <textarea name="pmpro\_userfields\_group\_description"><?php echo esc\_textarea( $group\_description );?></textarea> |
| [1273](#L1273) | </label> |
| [1274](#L1274) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1275](#L1275) |  |
| [1276](#L1276) | <div class="pmpro\_userfield-field-setting"> |
| [1277](#L1277) | <?php esc\_html\_e( 'Restrict Fields for Membership Levels', 'paid-memberships-pro' ); ?><br /> |
| [1278](#L1278) | <div class="pmpro\_checkbox\_box" <?php if ( count( $levels ) > 3 ) { ?>style="height: 90px; overflow: auto;"<?php } ?>> |
| [1279](#L1279) | <?php foreach( $levels as $level ) { ?> |
| [1280](#L1280) | <div class="pmpro\_clickable"> |
| [1281](#L1281) | <label> |
| [1282](#L1282) | <input type="checkbox" id="pmpro\_userfields\_group\_membership\_<?php echo esc\_attr( $level->id); ?>" name="pmpro\_userfields\_group\_membership[]" <?php checked( true, in\_array( $level->id, $group\_levels ) );?>> |
| [1283](#L1283) | <?php echo esc\_html( $level->name ); ?> |
| [1284](#L1284) | </label> |
| [1285](#L1285) | </div> |
| [1286](#L1286) | <?php } ?> |
| [1287](#L1287) | </div> |
| [1288](#L1288) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1289](#L1289) |  |
| [1290](#L1290) | </div> <!-- end pmpro\_userfield-field-settings --> |
| [1291](#L1291) |  |
| [1292](#L1292) | <h3><?php esc\_html\_e( 'Manage Fields in This Group', 'paid-memberships-pro' ); ?></h3> |
| [1293](#L1293) |  |
| [1294](#L1294) | <ul class="pmpro\_userfield-group-thead"> |
| [1295](#L1295) | <li class="pmpro\_userfield-group-column-order"><?php esc\_html\_e( 'Order', 'paid-memberships-pro'); ?></li> |
| [1296](#L1296) | <li class="pmpro\_userfield-group-column-label"><?php esc\_html\_e( 'Label', 'paid-memberships-pro'); ?></li> |
| [1297](#L1297) | <li class="pmpro\_userfield-group-column-name"><?php esc\_html\_e( 'Name', 'paid-memberships-pro'); ?></li> |
| [1298](#L1298) | <li class="pmpro\_userfield-group-column-type"><?php esc\_html\_e( 'Type', 'paid-memberships-pro'); ?></li> |
| [1299](#L1299) | </ul> |
| [1300](#L1300) |  |
| [1301](#L1301) | <div class="pmpro\_userfield-group-fields"> |
| [1302](#L1302) | <?php |
| [1303](#L1303) | if ( ! empty( $group->fields ) ) { |
| [1304](#L1304) | foreach ( $group->fields as $field ) { |
| [1305](#L1305) | echo pmpro\_get\_field\_html( $field ); |
| [1306](#L1306) | } |
| [1307](#L1307) | } |
| [1308](#L1308) | ?> |
| [1309](#L1309) |  |
| [1310](#L1310) | <!-- end pmpro\_userfield-group-fields --> |
| [1311](#L1311) |  |
| [1312](#L1312) | </div> <!-- end pmpro\_userfield-inside --> |
| [1313](#L1313) |  |
| [1314](#L1314) | <div class="pmpro\_userfield-group-actions"> |
| [1315](#L1315) | <button name="pmpro\_userfields\_add\_field" class="button button-secondary button-hero"> |
| [1316](#L1316) | <?php |
| [1317](#L1317) | /\* translators: a plus sign dashicon \*/ |
| [1318](#L1318) | printf( esc\_html\_\_( '%s Add Field', 'paid-memberships-pro' ), '<span class="dashicons dashicons-plus"></span>' ); ?> |
| [1319](#L1319) | </button> |
| [1320](#L1320) | <button name="pmpro\_userfields\_delete\_group" class="button button-secondary is-destructive"> |
| [1321](#L1321) | <?php esc\_html\_e( 'Delete Group', 'paid-memberships-pro' ); ?> |
| [1322](#L1322) | </button> |
| [1323](#L1323) | </div> <!-- end pmpro\_userfield-group-actions --> |
| [1324](#L1324) |  |
| [1325](#L1325) | </div> <!-- end pmpro\_userfield-group --> |
| [1326](#L1326) | </div> <!-- end inside --> |
| [1327](#L1327) | <?php |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | /\*\* |
| [1331](#L1331) | \* Get field HTML for settings. |
| [1332](#L1332) | \*/ |
| [1333](#L1333) | function pmpro\_get\_field\_html( $field = null ) { |
| [1334](#L1334) | if ( ! empty( $field ) ) { |
| [1335](#L1335) | // Assume field stdClass in format we save to settings. |
| [1336](#L1336) | $field\_label = $field->label; |
| [1337](#L1337) | $field\_name = $field->name; |
| [1338](#L1338) | $field\_type = $field->type; |
| [1339](#L1339) | $field\_required = $field->required; |
| [1340](#L1340) | $field\_readonly = $field->readonly; |
| [1341](#L1341) | $field\_profile = $field->profile; |
| [1342](#L1342) | $field\_wrapper\_class = $field->wrapper\_class; |
| [1343](#L1343) | $field\_element\_class = $field->element\_class; |
| [1344](#L1344) | $field\_hint = $field->hint; |
| [1345](#L1345) | $field\_options = $field->options; |
| [1346](#L1346) | } else { |
| [1347](#L1347) | // Default field values |
| [1348](#L1348) | $field\_label = ''; |
| [1349](#L1349) | $field\_name = ''; |
| [1350](#L1350) | $field\_type = ''; |
| [1351](#L1351) | $field\_required = false; |
| [1352](#L1352) | $field\_readonly = false; |
| [1353](#L1353) | $field\_profile = ''; |
| [1354](#L1354) | $field\_wrapper\_class = ''; |
| [1355](#L1355) | $field\_element\_class = ''; |
| [1356](#L1356) | $field\_hint = ''; |
| [1357](#L1357) | $field\_options = ''; |
| [1358](#L1358) | } |
| [1359](#L1359) |  |
| [1360](#L1360) | // Other vars |
| [1361](#L1361) | $levels = pmpro\_sort\_levels\_by\_order( pmpro\_getAllLevels( true, true ) ); |
| [1362](#L1362) | ?> |
| [1363](#L1363) | <div class="pmpro\_userfield-group-field pmpro\_userfield-group-field-collapse"> |
| [1364](#L1364) | <ul class="pmpro\_userfield-group-tbody"> |
| [1365](#L1365) | <li class="pmpro\_userfield-group-column-order"> |
| [1366](#L1366) | <div class="pmpro\_userfield-group-buttons"> |
| [1367](#L1367) | <button type="button" aria-disabled="false" class="pmpro\_userfield-group-buttons-button pmpro\_userfield-field-buttons-button-move-up" aria-label="<?php esc\_attr\_e( 'Move up', 'paid-memberships-pro' ); ?>"> |
| [1368](#L1368) | <span class="dashicons dashicons-arrow-up-alt2"></span> |
| [1369](#L1369) | </button> |
| [1370](#L1370) | <span class="pmpro\_userfield-group-buttons-description"><?php esc\_html\_e( 'Move Field Up', 'paid-memberships-pro' ); ?></span> |
| [1371](#L1371) |  |
| [1372](#L1372) | <button type="button" aria-disabled="false" class="pmpro\_userfield-group-buttons-button pmpro\_userfield-field-buttons-button-move-down" aria-label="<?php esc\_attr\_e( 'Move down', 'paid-memberships-pro' ); ?>"> |
| [1373](#L1373) | <span class="dashicons dashicons-arrow-down-alt2"></span> |
| [1374](#L1374) | </button> |
| [1375](#L1375) | <span class="pmpro\_userfield-group-buttons-description"><?php esc\_html\_e( 'Move Field Down', 'paid-memberships-pro' ); ?></span> |
| [1376](#L1376) | </div> <!-- end pmpro\_userfield-group-buttons --> |
| [1377](#L1377) | </li> |
| [1378](#L1378) | <li class="pmpro\_userfield-group-column-label"> |
| [1379](#L1379) | <span class="pmpro\_userfield-label"><?php echo strip\_tags( wp\_kses\_post( $field\_label ) );?></span> |
| [1380](#L1380) | <div class="pmpro\_userfield-field-options"> |
| [1381](#L1381) | <a class="edit-field" title="<?php esc\_attr\_e( 'Edit field', 'paid-memberships-pro' ); ?>" href="javascript:void(0);"><?php esc\_html\_e( 'Edit', 'paid-memberships-pro' ); ?></a> | |
| [1382](#L1382) | <a class="duplicate-field" title="<?php esc\_attr\_e( 'Duplicate field', 'paid-memberships-pro' ); ?>" href="javascript:void(0);"><?php esc\_html\_e( 'Duplicate', 'paid-memberships-pro' ); ?></a> | |
| [1383](#L1383) | <a class="delete-field" title="<?php esc\_attr\_e( 'Delete field', 'paid-memberships-pro' ); ?>" href="javascript:void(0);"><?php esc\_html\_e( 'Delete', 'paid-memberships-pro' ); ?></a> |
| [1384](#L1384) | </div> <!-- end pmpro\_userfield-group-options --> |
| [1385](#L1385) | </li> |
| [1386](#L1386) | <li class="pmpro\_userfield-group-column-name"><?php echo esc\_html( $field\_name); ?></li> |
| [1387](#L1387) | <li class="pmpro\_userfield-group-column-type"><?php echo esc\_html( $field\_type); ?></li> |
| [1388](#L1388) | </ul> |
| [1389](#L1389) |  |
| [1390](#L1390) | <div class="pmpro\_userfield-field-settings" style="display: none;"> |
| [1391](#L1391) |  |
| [1392](#L1392) | <div class="pmpro\_userfield-field-setting"> |
| [1393](#L1393) | <label> |
| [1394](#L1394) | <?php esc\_html\_e( 'Label', 'paid-memberships-pro' ); ?><br /> |
| [1395](#L1395) | <input type="text" name="pmpro\_userfields\_field\_label" value="<?php echo esc\_attr( $field\_label );?>" /> |
| [1396](#L1396) | </label> |
| [1397](#L1397) | <span class="description"><?php esc\_html\_e( 'Brief descriptive text for the field. Shown on user forms.', 'paid-memberships-pro' ); ?></span> |
| [1398](#L1398) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1399](#L1399) |  |
| [1400](#L1400) | <div class="pmpro\_userfield-field-setting"> |
| [1401](#L1401) | <label> |
| [1402](#L1402) | <?php esc\_html\_e( 'Name', 'paid-memberships-pro' ); ?><br /> |
| [1403](#L1403) | <input type="text" name="pmpro\_userfields\_field\_name" value="<?php echo esc\_attr( $field\_name );?>" /> |
| [1404](#L1404) | </label> |
| [1405](#L1405) | <span class="description"><?php esc\_html\_e( 'Single word with no spaces. Underscores are allowed.', 'paid-memberships-pro' ); ?></span> |
| [1406](#L1406) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1407](#L1407) |  |
| [1408](#L1408) | <div class="pmpro\_userfield-field-setting"> |
| [1409](#L1409) | <label> |
| [1410](#L1410) | <?php esc\_html\_e( 'Type', 'paid-memberships-pro' ); ?><br /> |
| [1411](#L1411) | <select name="pmpro\_userfields\_field\_type" /> |
| [1412](#L1412) | <option value="text" <?php selected( $field\_type, 'text' ); ?>><?php esc\_html\_e( 'Text', 'paid-memberships-pro' ); ?></option> |
| [1413](#L1413) | <option value="textarea" <?php selected( $field\_type, 'textarea' ); ?>><?php esc\_html\_e( 'Text Area', 'paid-memberships-pro' ); ?></option> |
| [1414](#L1414) | <option value="checkbox" <?php selected( $field\_type, 'checkbox' ); ?>><?php esc\_html\_e( 'Checkbox', 'paid-memberships-pro' ); ?></option> |
| [1415](#L1415) | <option value="radio" <?php selected( $field\_type, 'radio' ); ?>><?php esc\_html\_e( 'Radio', 'paid-memberships-pro' ); ?></option> |
| [1416](#L1416) | <option value="select" <?php selected( $field\_type, 'select' ); ?>><?php esc\_html\_e( 'Select / Dropdown', 'paid-memberships-pro' ); ?></option> |
| [1417](#L1417) | <option value="select2" <?php selected( $field\_type, 'select2' ); ?>><?php esc\_html\_e( 'Select2 / Autocomplete', 'paid-memberships-pro' ); ?></option> |
| [1418](#L1418) | <option value="multiselect" <?php selected( $field\_type, 'multiselect' ); ?>><?php esc\_html\_e( 'Multi Select', 'paid-memberships-pro' ); ?></option> |
| [1419](#L1419) | <option value="file" <?php selected( $field\_type, 'file' ); ?>><?php esc\_html\_e( 'File', 'paid-memberships-pro' ); ?></option> |
| [1420](#L1420) | <option value="number" <?php selected( $field\_type, 'number' ); ?>><?php esc\_html\_e( 'Number', 'paid-memberships-pro' ); ?></option> |
| [1421](#L1421) | <option value="date" <?php selected( $field\_type, 'date' ); ?>><?php esc\_html\_e( 'Date', 'paid-memberships-pro' ); ?></option> |
| [1422](#L1422) | <option value="readonly" <?php selected( $field\_type, 'readonly' ); ?>><?php esc\_html\_e( 'Read-Only', 'paid-memberships-pro' ); ?></option> |
| [1423](#L1423) | <option value="hidden" <?php selected( $field\_type, 'hidden' ); ?>><?php esc\_html\_e( 'Hidden', 'paid-memberships-pro' ); ?></option> |
| [1424](#L1424) | </select> |
| [1425](#L1425) | </label> |
| [1426](#L1426) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1427](#L1427) |  |
| [1428](#L1428) | <div class="pmpro\_userfield-field-setting pmpro\_userfield-field-setting-dual"> |
| [1429](#L1429) | <div class="pmpro\_userfield-field-setting"> |
| [1430](#L1430) | <label> |
| [1431](#L1431) | <?php esc\_html\_e( 'Required at Checkout?', 'paid-memberships-pro' ); ?><br /> |
| [1432](#L1432) | <select name="pmpro\_userfields\_field\_required"> |
| [1433](#L1433) | <option value="no" <?php selected( $field\_required, 'no' );?>><?php esc\_html\_e( 'No', 'paid-memberships-pro' ); ?></option> |
| [1434](#L1434) | <option value="yes" <?php selected( $field\_required, 'yes' );?>><?php esc\_html\_e( 'Yes', 'paid-memberships-pro' ); ?></option> |
| [1435](#L1435) | </select> |
| [1436](#L1436) | </label> |
| [1437](#L1437) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1438](#L1438) |  |
| [1439](#L1439) | <div class="pmpro\_userfield-field-setting"> |
| [1440](#L1440) | <label> |
| [1441](#L1441) | <?php esc\_html\_e( 'Read Only?', 'paid-memberships-pro' ); ?><br /> |
| [1442](#L1442) | <select name="pmpro\_userfields\_field\_readonly"> |
| [1443](#L1443) | <option value="no" <?php selected( $field\_readonly, 'no' );?>><?php esc\_html\_e( 'No', 'paid-memberships-pro' ); ?></option> |
| [1444](#L1444) | <option value="yes" <?php selected( $field\_readonly, 'yes' );?>><?php esc\_html\_e( 'Yes', 'paid-memberships-pro' ); ?></option> |
| [1445](#L1445) | </select> |
| [1446](#L1446) | </label> |
| [1447](#L1447) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1448](#L1448) | </div> <!-- end pmpro\_userfield-field-setting-dual --> |
| [1449](#L1449) |  |
| [1450](#L1450) | <div class="pmpro\_userfield-field-setting"> |
| [1451](#L1451) | <label> |
| [1452](#L1452) | <?php esc\_html\_e( 'Show field on user profile?', 'paid-memberships-pro' ); ?><br /> |
| [1453](#L1453) | <select name="pmpro\_userfields\_field\_profile"> |
| [1454](#L1454) | <option value="" <?php selected( empty( $field\_profile ), 0);?>><?php esc\_html\_e( '[Inherit Group Setting]', 'paid-memberships-pro' ); ?></option> |
| [1455](#L1455) | <option value="yes" <?php selected( $field\_profile, 'yes' );?>><?php esc\_html\_e( 'Yes', 'paid-memberships-pro' ); ?></option> |
| [1456](#L1456) | <option value="admins" <?php selected( $field\_profile, 'admins' );?>><?php esc\_html\_e( 'Yes (only admins)', 'paid-memberships-pro' ); ?></option> |
| [1457](#L1457) | <option value="no" <?php selected( $field\_profile, 'no' );?>><?php esc\_html\_e( 'No', 'paid-memberships-pro' ); ?></option> |
| [1458](#L1458) | </select> |
| [1459](#L1459) | </label> |
| [1460](#L1460) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1461](#L1461) |  |
| [1462](#L1462) | <div class="pmpro\_userfield-field-setting pmpro\_userfield-field-setting-dual"> |
| [1463](#L1463) | <div class="pmpro\_userfield-field-setting"> |
| [1464](#L1464) | <label> |
| [1465](#L1465) | <?php esc\_html\_e( 'Field Wrapper Class (optional)', 'paid-memberships-pro' ); ?><br /> |
| [1466](#L1466) | <input type="text" name="pmpro\_userfields\_field\_class" value="<?php echo esc\_attr( $field\_wrapper\_class );?>" /> |
| [1467](#L1467) | </label> |
| [1468](#L1468) | <span class="description"><?php esc\_html\_e( 'Assign a custom CSS selector to the field\'s wrapping div', 'paid-memberships-pro' ); ?>.</span> |
| [1469](#L1469) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1470](#L1470) |  |
| [1471](#L1471) | <div class="pmpro\_userfield-field-setting"> |
| [1472](#L1472) | <label> |
| [1473](#L1473) | <?php esc\_html\_e( 'Field Element Class (optional)', 'paid-memberships-pro' ); ?><br /> |
| [1474](#L1474) | <input type="text" name="pmpro\_userfields\_field\_divclass" value="<?php echo esc\_attr( $field\_element\_class );?>" /> |
| [1475](#L1475) | </label> |
| [1476](#L1476) | <span class="description"><?php esc\_html\_e( 'Assign a custom CSS selector to the field', 'paid-memberships-pro' ); ?></span> |
| [1477](#L1477) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1478](#L1478) | </div> <!-- end pmpro\_userfield-field-setting-dual --> |
| [1479](#L1479) |  |
| [1480](#L1480) | <div class="pmpro\_userfield-field-setting"> |
| [1481](#L1481) | <label> |
| [1482](#L1482) | <?php esc\_html\_e( 'Hint (optional)', 'paid-memberships-pro' ); ?><br /> |
| [1483](#L1483) | <textarea name="pmpro\_userfields\_field\_hint" /><?php echo esc\_textarea( $field\_hint );?></textarea> |
| [1484](#L1484) | </label> |
| [1485](#L1485) | <span class="description"><?php esc\_html\_e( 'Descriptive text for users or admins submitting the field.', 'paid-memberships-pro' ); ?></span> |
| [1486](#L1486) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1487](#L1487) |  |
| [1488](#L1488) | <div class="pmpro\_userfield-field-setting"> |
| [1489](#L1489) | <label> |
| [1490](#L1490) | <?php esc\_html\_e( 'Options', 'paid-memberships-pro' ); ?><br /> |
| [1491](#L1491) | <textarea name="pmpro\_userfields\_field\_options" /><?php echo esc\_textarea( $field\_options );?></textarea> |
| [1492](#L1492) | </label> |
| [1493](#L1493) | <span class="description"><?php esc\_html\_e( 'One option per line. To set separate values and labels, use value:label.', 'paid-memberships-pro' ); ?></span> |
| [1494](#L1494) | </div> <!-- end pmpro\_userfield-field-setting --> |
| [1495](#L1495) |  |
| [1496](#L1496) | <div class="pmpro\_userfield-field-actions"> |
| [1497](#L1497) | <button name="pmpro\_userfields\_close\_field" class="button button-secondary pmpro\_userfields\_close\_field"> |
| [1498](#L1498) | <?php esc\_html\_e( 'Close Field', 'paid-memberships-pro' ); ?> |
| [1499](#L1499) | </button> |
| [1500](#L1500) | <button name="pmpro\_userfields\_delete\_field" class="button button-secondary is-destructive"> |
| [1501](#L1501) | <?php \_e( 'Delete Field', 'paid-memberships-pro' ); ?> |
| [1502](#L1502) | </button> |
| [1503](#L1503) | </div> <!-- end pmpro\_userfield-field-actions --> |
| [1504](#L1504) | </div> <!-- end pmpro\_userfield-field-settings --> |
| [1505](#L1505) | </div> <!-- end pmpro\_userfield-group-field --> |
| [1506](#L1506) | <?php |
| [1507](#L1507) | } |
| [1508](#L1508) |  |
| [1509](#L1509) | /\*\* |
| [1510](#L1510) | \* Get user fields from options. |
| [1511](#L1511) | \* |
| [1512](#L1512) | \* This function will not return fields that are added through code. |
| [1513](#L1513) | \*/ |
| [1514](#L1514) | function pmpro\_get\_user\_fields\_settings() { |
| [1515](#L1515) | $default\_user\_fields\_settings = array( |
| [1516](#L1516) | (object) array( |
| [1517](#L1517) | 'name' => \_\_( 'More Information', 'paid-memberships-pro' ), |
| [1518](#L1518) | 'checkout' => 'yes', |
| [1519](#L1519) | 'profile' => 'yes', |
| [1520](#L1520) | 'description' => '', |
| [1521](#L1521) | 'levels' => array(), |
| [1522](#L1522) | 'fields' => array(), |
| [1523](#L1523) | ) |
| [1524](#L1524) | ); |
| [1525](#L1525) |  |
| [1526](#L1526) | $settings = get\_option( 'pmpro\_user\_fields\_settings', $default\_user\_fields\_settings ); |
| [1527](#L1527) |  |
| [1528](#L1528) | // TODO: Might want to validate the format the settings are in here. |
| [1529](#L1529) |  |
| [1530](#L1530) | return $settings; |
| [1531](#L1531) | } |
| [1532](#L1532) |  |
| [1533](#L1533) | /\*\* |
| [1534](#L1534) | \* Load user field settings into the fields global var. |
| [1535](#L1535) | \*/ |
| [1536](#L1536) | function pmpro\_load\_user\_fields\_from\_settings() { |
| [1537](#L1537) | global $pmpro\_user\_fields, $pmpro\_field\_groups; |
| [1538](#L1538) | $settings\_groups = pmpro\_get\_user\_fields\_settings(); |
| [1539](#L1539) |  |
| [1540](#L1540) | foreach ( $settings\_groups as $group ) { |
| [1541](#L1541) | pmpro\_add\_field\_group( $group->name, $group->name, $group->description ); |
| [1542](#L1542) |  |
| [1543](#L1543) | // Figure out profile value. Change 2 settings values into 1 field value. |
| [1544](#L1544) | if ( $group->checkout === 'yes' ) { |
| [1545](#L1545) | if ( $group->profile === 'yes' ) { |
| [1546](#L1546) | $group\_profile = true; |
| [1547](#L1547) | } elseif ( $group->profile === 'admins' ) { |
| [1548](#L1548) | $group\_profile = 'admin'; |
| [1549](#L1549) | } else { |
| [1550](#L1550) | $group\_profile = false; |
| [1551](#L1551) | } |
| [1552](#L1552) | } else { |
| [1553](#L1553) | if ( $group->profile === 'yes' ) { |
| [1554](#L1554) | $group\_profile = 'only'; |
| [1555](#L1555) | } elseif ( $group->profile === 'admins' ) { |
| [1556](#L1556) | $group\_profile = 'only\_admin'; |
| [1557](#L1557) | } else { |
| [1558](#L1558) | // Hide from checkout AND profile? Okay, skip this group. |
| [1559](#L1559) | continue; |
| [1560](#L1560) | } |
| [1561](#L1561) | } |
| [1562](#L1562) |  |
| [1563](#L1563) | foreach ( $group->fields as $settings\_field ) { |
| [1564](#L1564) | // Figure out field profile from settings and group profile. |
| [1565](#L1565) | if ( empty( $settings\_field->profile ) || $settings\_field->profile === '[Inherit Group Setting]' ) { |
| [1566](#L1566) | $profile = $group\_profile; |
| [1567](#L1567) | } else { |
| [1568](#L1568) | if ( $settings\_field->profile === 'yes' ) { |
| [1569](#L1569) | $profile = true; |
| [1570](#L1570) | } elseif ( $settings\_field->profile === 'no' ) { |
| [1571](#L1571) | $profile = false; |
| [1572](#L1572) | } elseif ( $settings\_field->profile === 'admins' ) { |
| [1573](#L1573) | $profile = 'admin'; |
| [1574](#L1574) | } else { |
| [1575](#L1575) | // default to no |
| [1576](#L1576) | $profile = false; |
| [1577](#L1577) | } |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | // Figure out options. |
| [1581](#L1581) | $option\_types = array( 'radio', 'select', 'select2', 'multiselect' ); |
| [1582](#L1582) | if ( in\_array( $settings\_field->type, $option\_types ) ) { |
| [1583](#L1583) | $options = array(); |
| [1584](#L1584) | $settings\_options = explode( "\n", $settings\_field->options ); |
| [1585](#L1585) | foreach( $settings\_options as $settings\_option ) { |
| [1586](#L1586) | if ( strpos( $settings\_option, ':' ) !== false ) { |
| [1587](#L1587) | $parts = explode( ':', $settings\_option ); |
| [1588](#L1588) | $options[trim( $parts[0] )] = trim( $parts[1] ); |
| [1589](#L1589) | } else { |
| [1590](#L1590) | $options[] = $settings\_option; |
| [1591](#L1591) | } |
| [1592](#L1592) | } |
| [1593](#L1593) | } else { |
| [1594](#L1594) | $options = false; |
| [1595](#L1595) | } |
| [1596](#L1596) |  |
| [1597](#L1597) | // Set field levels based on group. |
| [1598](#L1598) | $levels = $group->levels; |
| [1599](#L1599) |  |
| [1600](#L1600) | $field = new PMPro\_Field( |
| [1601](#L1601) | $settings\_field->name, |
| [1602](#L1602) | $settings\_field->type, |
| [1603](#L1603) | array( |
| [1604](#L1604) | 'label' => $settings\_field->label, |
| [1605](#L1605) | 'required' => filter\_var( $settings\_field->required, FILTER\_VALIDATE\_BOOLEAN ), |
| [1606](#L1606) | 'readonly' => filter\_var( $settings\_field->readonly, FILTER\_VALIDATE\_BOOLEAN ), |
| [1607](#L1607) | 'profile' => $profile, |
| [1608](#L1608) | 'class' => $settings\_field->element\_class, |
| [1609](#L1609) | 'divclass' => $settings\_field->wrapper\_class, |
| [1610](#L1610) | 'hint' => $settings\_field->hint, |
| [1611](#L1611) | 'options' => $options, |
| [1612](#L1612) | 'levels' => $levels, |
| [1613](#L1613) | 'memberslistcsv' => true, |
| [1614](#L1614) | ) |
| [1615](#L1615) | ); |
| [1616](#L1616) | pmpro\_add\_user\_field( $group->name, $field ); |
| [1617](#L1617) | } |
| [1618](#L1618) | } |
| [1619](#L1619) | } |
| [1620](#L1620) | add\_action( 'init', 'pmpro\_load\_user\_fields\_from\_settings', 1 ); |
| [1621](#L1621) |  |
| [1622](#L1622) | /\*\* |
| [1623](#L1623) | \* Check if user is adding custom user fields with code. |
| [1624](#L1624) | \* |
| [1625](#L1625) | \* @since 2.9 |
| [1626](#L1626) | \* |
| [1627](#L1627) | \* @return bool True if user is adding custom user fields with code. |
| [1628](#L1628) | \*/ |
| [1629](#L1629) | function pmpro\_has\_coded\_user\_fields() { |
| [1630](#L1630) | global $pmpro\_user\_fields, $pmprorh\_registration\_fields; |
| [1631](#L1631) |  |
| [1632](#L1632) | // Check if coded fields are being added using the PMPro Register Helper Add On active. |
| [1633](#L1633) | if ( ! empty( $pmprorh\_registration\_fields ) ) { |
| [1634](#L1634) | return true; |
| [1635](#L1635) | } |
| [1636](#L1636) |  |
| [1637](#L1637) | // Check if coded fields are being added using the PMPro Register Helper Add On inactive. |
| [1638](#L1638) | $num\_db\_fields = array\_sum( array\_map( function ($group) { return count( $group->fields ); }, pmpro\_get\_user\_fields\_settings() ) ); // Fields from UI settings page. |
| [1639](#L1639) | $num\_global\_fields = array\_sum( array\_map( 'count', $pmpro\_user\_fields ) ); // Total loaded fields. |
| [1640](#L1640) | return $num\_global\_fields > $num\_db\_fields; |
| [1641](#L1641) | } |
| [1642](#L1642) |  |
| [1643](#L1643) | /\*\* |
| [1644](#L1644) | \* Gets the label(s) for a passed user field value. |
| [1645](#L1645) | \* |
| [1646](#L1646) | \* @since 2.11 |
| [1647](#L1647) | \* |
| [1648](#L1648) | \* @param string $field\_name  The name of the field that the value belongs to. |
| [1649](#L1649) | \* @param string|array $field\_value The value to get the label for. |
| [1650](#L1650) | \* |
| [1651](#L1651) | \* @return string|array The label(s) for the passed value. Will be same type as $field\_value. |
| [1652](#L1652) | \*/ |
| [1653](#L1653) | function pmpro\_get\_label\_for\_user\_field\_value( $field\_name, $field\_value ) { |
| [1654](#L1654) | global $pmpro\_user\_fields; |
| [1655](#L1655) | foreach ( $pmpro\_user\_fields as $user\_field\_group ) { // Loop through each user field group. |
| [1656](#L1656) | foreach ( $user\_field\_group as $user\_field ) { // Loop through each user field in the group. |
| [1657](#L1657) | // Check if this is the user field that we are displaying. |
| [1658](#L1658) | if ( $user\_field->name !== $field\_name ) { |
| [1659](#L1659) | continue; |
| [1660](#L1660) | } |
| [1661](#L1661) |  |
| [1662](#L1662) | // Make sure that we have a valid user field. |
| [1663](#L1663) | if ( ! pmpro\_is\_field( $user\_field ) ) { |
| [1664](#L1664) | continue; |
| [1665](#L1665) | } |
| [1666](#L1666) |  |
| [1667](#L1667) | // Check if this is the user field that we are displaying. |
| [1668](#L1668) | if ( empty( $user\_field->options ) ) { |
| [1669](#L1669) | continue; |
| [1670](#L1670) | } |
| [1671](#L1671) |  |
| [1672](#L1672) | // Make sure that $options is an array. |
| [1673](#L1673) | if ( ! is\_array( $user\_field->options ) ) { |
| [1674](#L1674) | continue; |
| [1675](#L1675) | } |
| [1676](#L1676) |  |
| [1677](#L1677) | // Replace meta values with their corresponding labels. |
| [1678](#L1678) | if ( is\_array( $field\_value ) ) { |
| [1679](#L1679) | foreach ( $field\_value as $key => $value ) { |
| [1680](#L1680) | if ( isset( $user\_field->options[ $value ] ) ) { |
| [1681](#L1681) | $field\_value[ $key ] = $user\_field->options[ $value ]; |
| [1682](#L1682) | } |
| [1683](#L1683) | } |
| [1684](#L1684) | } else { |
| [1685](#L1685) | if ( isset( $user\_field->options[ $field\_value ] ) ) { |
| [1686](#L1686) | $field\_value = $user\_field->options[ $field\_value ]; |
| [1687](#L1687) | } |
| [1688](#L1688) | } |
| [1689](#L1689) | } |
| [1690](#L1690) | } |
| [1691](#L1691) | return $field\_value; |
| [1692](#L1692) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/paid-memberships-pro/tags/2.12.3/includes/fields.php?format=txt)
* [Original Format](/export/3222454/paid-memberships-pro/tags/2.12.3/includes/fields.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


