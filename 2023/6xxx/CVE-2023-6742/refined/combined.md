=== Content from www.wordfence.com_3675f4f6_20250115_082451.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Envira Gallery Lite <= 1.8.7.2 - Missing Authorization to Gallery Modification via envira\_gallery\_insert\_images

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Envira Gallery Lite <= 1.8.7.2 - Missing Authorization to Gallery Modification via envira\_gallery\_insert\_images

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-6742](https://www.cve.org/CVERecord?id=CVE-2023-6742) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | January 8, 2024 |
| Last Updated | January 22, 2024 |
| Researcher | [Nex Team](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/nex-team) |

### Description

The Gallery Plugin for WordPress – Envira Photo Gallery plugin for WordPress is vulnerable to unauthorized modification of data due to an improper capability check on the 'envira\_gallery\_insert\_images' function in all versions up to, and including, 1.8.7.1. This makes it possible for authenticated attackers, with contributor access and above, to modify galleries on other users' posts.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/envira-gallery-lite/trunk/includes/admin/ajax.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3017115/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fenvira-gallery-lite%2Fenvira-gallery-lite-1872-missing-authorization-to-gallery-modification-via-envira-gallery-insert-images&t=Envira%20Gallery%20Lite%20%3C%3D%201.8.7.2%20-%20Missing%20Authorization%20to%20Gallery%20Modification%20via%20envira_gallery_insert_images "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fenvira-gallery-lite%2Fenvira-gallery-lite-1872-missing-authorization-to-gallery-modification-via-envira-gallery-insert-images&text=Envira%20Gallery%20Lite%20%3C%3D%201.8.7.2%20-%20Missing%20Authorization%20to%20Gallery%20Modification%20via%20envira_gallery_insert_images "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fenvira-gallery-lite%2Fenvira-gallery-lite-1872-missing-authorization-to-gallery-modification-via-envira-gallery-insert-images "LinkedIn")
Email

## Vulnerability Details for Gallery Plugin for WordPress – Envira Photo Gallery

#### [Gallery Plugin for WordPress – Envira Photo Gallery](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/envira-gallery-lite)

| Software Type | Plugin |
| --- | --- |
| Software Slug | envira-gallery-lite [(view on wordpress.org)](https://wordpress.org/plugins/envira-gallery-lite) |
| Patched? | Yes |
| Remediation | Update to version 1.8.7.3, or a newer patched version |
| Affected Version | * <= 1.8.7.2 |
| Patched Version | * 1.8.7.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_ac412d14_20250115_082437.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fenvira-gallery-lite%2Ftrunk%2Fincludes%2Fadmin%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=3091601 "Revision 3091601")
* Next Revision →
* [Blame](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/envira-gallery-lite/trunk/includes/admin/ajax.php)

---

# [source:](/browser?order=name "Go to repository root") [envira-gallery-lite](/browser/envira-gallery-lite?order=name "View envira-gallery-lite")/[trunk](/browser/envira-gallery-lite/trunk?order=name "View trunk")/[includes](/browser/envira-gallery-lite/trunk/includes?order=name "View includes")/[admin](/browser/envira-gallery-lite/trunk/includes/admin?order=name "View admin")/[ajax.php](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?order=name "View ajax.php")

View diff against:

View revision:

| [Last change](/changeset/3133202/envira-gallery-lite/trunk/includes/admin/ajax.php "View differences") on this file was [3133202](/changeset/3133202/ "View changeset 3133202"), checked in by poxtron, [5 months ago](/timeline?from=2024-08-09T12%3A32%3A26Z&precision=second "See timeline at 08/09/2024 12:32:26 PM") |
| --- |
| Release 1.8.15 |
| **File size:** 43.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Handles all admin ajax interactions for the Envira Gallery plugin. |
| [4](#L4) | \* |
| [5](#L5) | \* @since 1.0.0 |
| [6](#L6) | \* |
| [7](#L7) | \* @package Envira\_Gallery |
| [8](#L8) | \* @author  Envira Gallery Team |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | add\_action( 'wp\_ajax\_envira\_gallery\_change\_type', 'envira\_gallery\_ajax\_change\_type' ); |
| [12](#L12) | /\*\* |
| [13](#L13) | \* Changes the type of gallery to the user selection. |
| [14](#L14) | \* |
| [15](#L15) | \* @since 1.0.0 |
| [16](#L16) | \*/ |
| [17](#L17) | function envira\_gallery\_ajax\_change\_type() { |
| [18](#L18) |  |
| [19](#L19) | // Run a security check first. |
| [20](#L20) | check\_admin\_referer( 'envira-gallery-change-type', 'nonce' ); |
| [21](#L21) |  |
| [22](#L22) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [23](#L23) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [24](#L24) | } |
| [25](#L25) |  |
| [26](#L26) | // Prepare variables. |
| [27](#L27) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [28](#L28) | $post    = get\_post( $post\_id ); |
| [29](#L29) | $type    = isset( $\_POST['type'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['type'] ) ) : null; |
| [30](#L30) |  |
| [31](#L31) | // Retrieve the data for the type selected. |
| [32](#L32) | ob\_start(); |
| [33](#L33) | $instance = Envira\_Gallery\_Metaboxes::get\_instance(); |
| [34](#L34) | $instance->images\_display( $type, $post ); |
| [35](#L35) | $html = ob\_get\_clean(); |
| [36](#L36) |  |
| [37](#L37) | // Send back the response. |
| [38](#L38) | echo wp\_json\_encode( |
| [39](#L39) | [ |
| [40](#L40) | 'type' => $type, |
| [41](#L41) | 'html' => $html, |
| [42](#L42) | ] |
| [43](#L43) | ); |
| [44](#L44) | die; |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) | add\_action( 'wp\_ajax\_envira\_gallery\_set\_user\_setting', 'envira\_gallery\_ajax\_set\_user\_setting' ); |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Stores a user setting for the logged in WordPress User |
| [50](#L50) | \* |
| [51](#L51) | \* @since 1.5.0 |
| [52](#L52) | \*/ |
| [53](#L53) | function envira\_gallery\_ajax\_set\_user\_setting() { |
| [54](#L54) |  |
| [55](#L55) | // Run a security check first. |
| [56](#L56) | check\_admin\_referer( 'envira-gallery-set-user-setting', 'nonce' ); |
| [57](#L57) |  |
| [58](#L58) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [59](#L59) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [60](#L60) | } |
| [61](#L61) |  |
| [62](#L62) | // Prepare variables. |
| [63](#L63) | $name  = isset( $\_POST['name'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['name'] ) ) : ''; |
| [64](#L64) | $value = isset( $\_POST['value'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['value'] ) ) : ''; |
| [65](#L65) |  |
| [66](#L66) | // Set user setting. |
| [67](#L67) | set\_user\_setting( $name, $value ); |
| [68](#L68) |  |
| [69](#L69) | // Send back the response. |
| [70](#L70) | wp\_send\_json\_success(); |
| [71](#L71) | die(); |
| [72](#L72) | } |
| [73](#L73) |  |
| [74](#L74) | add\_action( 'wp\_ajax\_envira\_gallery\_load\_image', 'envira\_gallery\_ajax\_load\_image' ); |
| [75](#L75) | /\*\* |
| [76](#L76) | \* Loads an image into a gallery. |
| [77](#L77) | \* |
| [78](#L78) | \* @since 1.0.0 |
| [79](#L79) | \*/ |
| [80](#L80) | function envira\_gallery\_ajax\_load\_image() { |
| [81](#L81) |  |
| [82](#L82) | // Run a security check first. |
| [83](#L83) | check\_admin\_referer( 'envira-gallery-load-image', 'nonce' ); |
| [84](#L84) |  |
| [85](#L85) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [86](#L86) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | // Prepare variables. |
| [90](#L90) | $id      = isset( $\_POST['id'] ) ? absint( wp\_unslash( $\_POST['id'] ) ) : null; |
| [91](#L91) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [92](#L92) |  |
| [93](#L93) | // Set post meta to show that this image is attached to one or more Envira galleries. |
| [94](#L94) | $has\_gallery = get\_post\_meta( $id, '\_eg\_has\_gallery', true ); |
| [95](#L95) | if ( empty( $has\_gallery ) ) { |
| [96](#L96) | $has\_gallery = []; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | $has\_gallery[] = $post\_id; |
| [100](#L100) | update\_post\_meta( $id, '\_eg\_has\_gallery', $has\_gallery ); |
| [101](#L101) |  |
| [102](#L102) | // Set post meta to show that this image is attached to a gallery on this page. |
| [103](#L103) | $in\_gallery = get\_post\_meta( $post\_id, '\_eg\_in\_gallery', true ); |
| [104](#L104) | if ( empty( $in\_gallery ) ) { |
| [105](#L105) | $in\_gallery = []; |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | $in\_gallery[] = $id; |
| [109](#L109) | update\_post\_meta( $post\_id, '\_eg\_in\_gallery', $in\_gallery ); |
| [110](#L110) |  |
| [111](#L111) | // Set data and order of image in gallery. |
| [112](#L112) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [113](#L113) | if ( empty( $gallery\_data ) ) { |
| [114](#L114) | $gallery\_data = []; |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | // If no gallery ID has been set, set it now. |
| [118](#L118) | if ( empty( $gallery\_data['id'] ) ) { |
| [119](#L119) | $gallery\_data['id'] = $post\_id; |
| [120](#L120) | } |
| [121](#L121) |  |
| [122](#L122) | // Set data and update the meta information. |
| [123](#L123) | $gallery\_data = envira\_gallery\_ajax\_prepare\_gallery\_data( $gallery\_data, $id ); |
| [124](#L124) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [125](#L125) |  |
| [126](#L126) | // Run hook before building out the item. |
| [127](#L127) | do\_action( 'envira\_gallery\_ajax\_load\_image', $id, $post\_id ); |
| [128](#L128) |  |
| [129](#L129) | // Build out the individual HTML output for the gallery image that has just been uploaded. |
| [130](#L130) | $html = Envira\_Gallery\_Metaboxes::get\_instance()->get\_gallery\_item( $id, $gallery\_data['gallery'][ $id ], $post\_id ); |
| [131](#L131) |  |
| [132](#L132) | // Allow addons to filter the HTML output. |
| [133](#L133) | $html = apply\_filters( 'envira\_gallery\_ajax\_get\_gallery\_item\_html', $html, $gallery\_data, $id, $post\_id ); |
| [134](#L134) |  |
| [135](#L135) | // Flush the gallery cache. |
| [136](#L136) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [137](#L137) |  |
| [138](#L138) | echo wp\_json\_encode( $html ); |
| [139](#L139) | die; |
| [140](#L140) | } |
| [141](#L141) |  |
| [142](#L142) | add\_action( 'wp\_ajax\_envira\_gallery\_insert\_images', 'envira\_gallery\_ajax\_insert\_images' ); |
| [143](#L143) | /\*\* |
| [144](#L144) | \* Inserts one or more images from the Media Library into a gallery. |
| [145](#L145) | \* |
| [146](#L146) | \* @since 1.0.0 |
| [147](#L147) | \*/ |
| [148](#L148) | function envira\_gallery\_ajax\_insert\_images() { |
| [149](#L149) |  |
| [150](#L150) | // Run a security check first. |
| [151](#L151) | check\_admin\_referer( 'envira-gallery-insert-images', 'nonce' ); |
| [152](#L152) |  |
| [153](#L153) | // Get the Envira Gallery ID. |
| [154](#L154) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [155](#L155) |  |
| [156](#L156) | if ( null === $post\_id ) { |
| [157](#L157) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | if ( ! current\_user\_can( 'edit\_post', $post\_id ) ) { |
| [161](#L161) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [162](#L162) | } |
| [163](#L163) |  |
| [164](#L164) | // Prepare variables. |
| [165](#L165) | $images = []; |
| [166](#L166) |  |
| [167](#L167) | if ( isset( $\_POST['images'] ) ) { |
| [168](#L168) | $images = json\_decode( sanitize\_text\_field( wp\_unslash( $\_POST['images'] ) ), true ); |
| [169](#L169) | } |
| [170](#L170) |  |
| [171](#L171) | // Grab and update any gallery data if necessary. |
| [172](#L172) | $in\_gallery = get\_post\_meta( $post\_id, '\_eg\_in\_gallery', true ); |
| [173](#L173) | if ( empty( $in\_gallery ) ) { |
| [174](#L174) | $in\_gallery = []; |
| [175](#L175) | } |
| [176](#L176) |  |
| [177](#L177) | // Set data and order of image in gallery. |
| [178](#L178) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [179](#L179) | if ( empty( $gallery\_data ) ) { |
| [180](#L180) | $gallery\_data = []; |
| [181](#L181) | } |
| [182](#L182) |  |
| [183](#L183) | // If no gallery ID has been set, set it now. |
| [184](#L184) | if ( empty( $gallery\_data['id'] ) ) { |
| [185](#L185) | $gallery\_data['id'] = $post\_id; |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | // Loop through the images and add them to the gallery. |
| [189](#L189) | foreach ( (array) $images as $i => $image ) { |
| [190](#L190) |  |
| [191](#L191) | // If the image is already in the gallery, lets skip it since we don't want to override the image metadata settings. |
| [192](#L192) | if ( in\_array( $image['id'], $in\_gallery, true ) ) { |
| [193](#L193) | continue; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | // Update the attachment image post meta first. |
| [197](#L197) | $has\_gallery = get\_post\_meta( $image['id'], '\_eg\_has\_gallery', true ); |
| [198](#L198) | if ( empty( $has\_gallery ) ) { |
| [199](#L199) | $has\_gallery = []; |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | $has\_gallery[] = $post\_id; |
| [203](#L203) | update\_post\_meta( $image['id'], '\_eg\_has\_gallery', $has\_gallery ); |
| [204](#L204) |  |
| [205](#L205) | // Now add the image to the gallery for this particular post. |
| [206](#L206) | $in\_gallery[] = $image['id']; |
| [207](#L207) | $gallery\_data = envira\_gallery\_ajax\_prepare\_gallery\_data( $gallery\_data, $image['id'], $image ); |
| [208](#L208) | } |
| [209](#L209) |  |
| [210](#L210) | // Update the gallery data. |
| [211](#L211) | update\_post\_meta( $post\_id, '\_eg\_in\_gallery', $in\_gallery ); |
| [212](#L212) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [213](#L213) |  |
| [214](#L214) | // Run hook before finishing. |
| [215](#L215) | do\_action( 'envira\_gallery\_ajax\_insert\_images', $images, $post\_id ); |
| [216](#L216) |  |
| [217](#L217) | // Flush the gallery cache. |
| [218](#L218) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [219](#L219) |  |
| [220](#L220) | // Return a HTML string comprising of all gallery images, so the UI can be updated. |
| [221](#L221) | $html = ''; |
| [222](#L222) | foreach ( (array) $gallery\_data['gallery'] as $id => $data ) { |
| [223](#L223) | $html .= Envira\_Gallery\_Metaboxes::get\_instance()->get\_gallery\_item( $id, $data, $post\_id ); |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | // Output JSON and exit. |
| [227](#L227) | echo wp\_json\_encode( [ 'success' => $html ] ); |
| [228](#L228) | die; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | add\_action( 'wp\_ajax\_envira\_gallery\_sort\_images', 'envira\_gallery\_ajax\_sort\_images' ); |
| [232](#L232) | /\*\* |
| [233](#L233) | \* Sorts images based on user-dragged position in the gallery. |
| [234](#L234) | \* |
| [235](#L235) | \* @since 1.0.0 |
| [236](#L236) | \*/ |
| [237](#L237) | function envira\_gallery\_ajax\_sort\_images() { |
| [238](#L238) |  |
| [239](#L239) | // Run a security check first. |
| [240](#L240) | check\_admin\_referer( 'envira-gallery-sort', 'nonce' ); |
| [241](#L241) |  |
| [242](#L242) | // Get the Envira Gallery ID. |
| [243](#L243) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [244](#L244) |  |
| [245](#L245) | if ( null === $post\_id ) { |
| [246](#L246) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [247](#L247) | } |
| [248](#L248) |  |
| [249](#L249) | if ( ! current\_user\_can( 'edit\_post', $post\_id ) ) { |
| [250](#L250) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | // Prepare variables. |
| [254](#L254) | $order        = isset( $\_POST['order'] ) ? explode( ',', wp\_unslash( $\_POST['order'] ) ) : ''; // @codingStandardsIgnoreLine |
| [255](#L255) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [256](#L256) |  |
| [257](#L257) | // Copy the gallery config, removing the images |
| [258](#L258) | // Stops config from getting lost when sorting + not clicking Publish/Update. |
| [259](#L259) | $new\_order = $gallery\_data; |
| [260](#L260) | unset( $new\_order['gallery'] ); |
| [261](#L261) | $new\_order['gallery'] = []; |
| [262](#L262) |  |
| [263](#L263) | // Loop through the order and generate a new array based on order received. |
| [264](#L264) | foreach ( $order as $id ) { |
| [265](#L265) | $new\_order['gallery'][ $id ] = $gallery\_data['gallery'][ $id ]; |
| [266](#L266) | } |
| [267](#L267) |  |
| [268](#L268) | // Update the gallery data. |
| [269](#L269) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $new\_order ); |
| [270](#L270) |  |
| [271](#L271) | // Flush the gallery cache. |
| [272](#L272) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [273](#L273) |  |
| [274](#L274) | echo wp\_json\_encode( true ); |
| [275](#L275) | die; |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | add\_action( 'wp\_ajax\_envira\_gallery\_remove\_image', 'envira\_gallery\_ajax\_remove\_image' ); |
| [279](#L279) | /\*\* |
| [280](#L280) | \* Removes an image from a gallery. |
| [281](#L281) | \* |
| [282](#L282) | \* @since 1.0.0 |
| [283](#L283) | \*/ |
| [284](#L284) | function envira\_gallery\_ajax\_remove\_image() { |
| [285](#L285) |  |
| [286](#L286) | // Run a security check first. |
| [287](#L287) | check\_admin\_referer( 'envira-gallery-remove-image', 'nonce' ); |
| [288](#L288) |  |
| [289](#L289) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [290](#L290) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | // Prepare variables. |
| [294](#L294) | $post\_id      = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [295](#L295) | $attach\_id    = isset( $\_POST['attachment\_id'] ) ? absint( wp\_unslash( $\_POST['attachment\_id'] ) ) : null; |
| [296](#L296) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [297](#L297) | $in\_gallery   = get\_post\_meta( $post\_id, '\_eg\_in\_gallery', true ); |
| [298](#L298) | $has\_gallery  = get\_post\_meta( $attach\_id, '\_eg\_has\_gallery', true ); |
| [299](#L299) |  |
| [300](#L300) | // Unset the image from the gallery, in\_gallery and has\_gallery checkers. |
| [301](#L301) | unset( $gallery\_data['gallery'][ $attach\_id ] ); |
| [302](#L302) | $key = array\_search( $attach\_id, (array) $in\_gallery, true ); |
| [303](#L303) | if ( false !== $key ) { |
| [304](#L304) | unset( $in\_gallery[ $key ] ); |
| [305](#L305) | } |
| [306](#L306) | $key = array\_search( $post\_id, (array) $has\_gallery, true ); |
| [307](#L307) |  |
| [308](#L308) | if ( false !== $key ) { |
| [309](#L309) | unset( $has\_gallery[ $key ] ); |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | // Update the gallery data. |
| [313](#L313) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [314](#L314) | update\_post\_meta( $post\_id, '\_eg\_in\_gallery', $in\_gallery ); |
| [315](#L315) | update\_post\_meta( $attach\_id, '\_eg\_has\_gallery', $has\_gallery ); |
| [316](#L316) |  |
| [317](#L317) | // Run hook before finishing the reponse. |
| [318](#L318) | do\_action( 'envira\_gallery\_ajax\_remove\_image', $attach\_id, $post\_id ); |
| [319](#L319) |  |
| [320](#L320) | // Flush the gallery cache. |
| [321](#L321) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [322](#L322) |  |
| [323](#L323) | echo wp\_json\_encode( true ); |
| [324](#L324) | die; |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | add\_action( 'wp\_ajax\_envira\_gallery\_remove\_images', 'envira\_gallery\_ajax\_remove\_images' ); |
| [328](#L328) | /\*\* |
| [329](#L329) | \* Removes multiple images from a gallery. |
| [330](#L330) | \* |
| [331](#L331) | \* @since 1.3.2.4 |
| [332](#L332) | \*/ |
| [333](#L333) | function envira\_gallery\_ajax\_remove\_images() { |
| [334](#L334) |  |
| [335](#L335) | // Run a security check first. |
| [336](#L336) | check\_admin\_referer( 'envira-gallery-remove-image', 'nonce' ); |
| [337](#L337) |  |
| [338](#L338) | // Get the Envira Gallery ID. |
| [339](#L339) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [340](#L340) |  |
| [341](#L341) | if ( null === $post\_id ) { |
| [342](#L342) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | if ( ! current\_user\_can( 'edit\_post', $post\_id ) ) { |
| [346](#L346) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | // Prepare variables. |
| [350](#L350) | $attach\_ids   = isset( $\_POST['attachment\_ids'] ) ? array\_map( 'absint', wp\_unslash( (array) $\_POST['attachment\_ids'] ) ) : []; |
| [351](#L351) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [352](#L352) | $in\_gallery   = get\_post\_meta( $post\_id, '\_eg\_in\_gallery', true ); |
| [353](#L353) |  |
| [354](#L354) | foreach ( (array) $attach\_ids as $attach\_id ) { |
| [355](#L355) | $has\_gallery = get\_post\_meta( $attach\_id, '\_eg\_has\_gallery', true ); |
| [356](#L356) |  |
| [357](#L357) | // Unset the image from the gallery, in\_gallery and has\_gallery checkers. |
| [358](#L358) | unset( $gallery\_data['gallery'][ $attach\_id ] ); |
| [359](#L359) |  |
| [360](#L360) | $key = array\_search( $attach\_id, (array) $in\_gallery, true ); |
| [361](#L361) | if ( false !== $key ) { |
| [362](#L362) | unset( $in\_gallery[ $key ] ); |
| [363](#L363) | } |
| [364](#L364) |  |
| [365](#L365) | $key = array\_search( $post\_id, (array) $has\_gallery, true ); |
| [366](#L366) | if ( false !== $key ) { |
| [367](#L367) | unset( $has\_gallery[ $key ] ); |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | // Update the attachment data. |
| [371](#L371) | update\_post\_meta( $attach\_id, '\_eg\_has\_gallery', $has\_gallery ); |
| [372](#L372) | } |
| [373](#L373) |  |
| [374](#L374) | // Update the gallery data. |
| [375](#L375) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [376](#L376) | update\_post\_meta( $post\_id, '\_eg\_in\_gallery', $in\_gallery ); |
| [377](#L377) |  |
| [378](#L378) | // Run hook before finishing the reponse. |
| [379](#L379) | do\_action( 'envira\_gallery\_ajax\_remove\_images', $post\_id ); |
| [380](#L380) |  |
| [381](#L381) | // Flush the gallery cache. |
| [382](#L382) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [383](#L383) |  |
| [384](#L384) | echo wp\_json\_encode( true ); |
| [385](#L385) | die; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | add\_action( 'wp\_ajax\_envira\_gallery\_save\_meta', 'envira\_gallery\_ajax\_save\_meta' ); |
| [389](#L389) | /\*\* |
| [390](#L390) | \* Saves the metadata for an image in a gallery. |
| [391](#L391) | \* |
| [392](#L392) | \* @since 1.0.0 |
| [393](#L393) | \*/ |
| [394](#L394) | function envira\_gallery\_ajax\_save\_meta() { |
| [395](#L395) |  |
| [396](#L396) | // Run a security check first. |
| [397](#L397) | check\_ajax\_referer( 'envira-gallery-save-meta', 'nonce' ); |
| [398](#L398) |  |
| [399](#L399) | // Get the Envira Gallery ID. |
| [400](#L400) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [401](#L401) |  |
| [402](#L402) | if ( null === $post\_id ) { |
| [403](#L403) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | if ( ! current\_user\_can( 'edit\_post', $post\_id ) ) { |
| [407](#L407) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | // Prepare variables. |
| [411](#L411) | $attach\_id    = isset( $\_POST['attach\_id'] ) ? absint( wp\_unslash( $\_POST['attach\_id'] ) ) : null; |
| [412](#L412) | $meta         = isset( $\_POST['meta'] ) ? array\_map( 'sanitize\_text\_field', wp\_unslash( (array) $\_POST['meta'] ) ) : []; |
| [413](#L413) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [414](#L414) |  |
| [415](#L415) | // Prevent invalid data from being saved. |
| [416](#L416) | if ( ! $post\_id || ! $attach\_id || empty( $meta['src'] ) ) { |
| [417](#L417) | wp\_send\_json\_error( 'Unable to save' ); |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | $wp\_kses\_allowed\_html = [ |
| [421](#L421) | 'a'      => [ |
| [422](#L422) | 'href'                => [], |
| [423](#L423) | 'target'              => [], |
| [424](#L424) | 'class'               => [], |
| [425](#L425) | 'title'               => [], |
| [426](#L426) | 'data-status'         => [], |
| [427](#L427) | 'data-envira-tooltip' => [], |
| [428](#L428) | 'data-id'             => [], |
| [429](#L429) | ], |
| [430](#L430) | 'br'     => [], |
| [431](#L431) | 'img'    => [ |
| [432](#L432) | 'src'   => [], |
| [433](#L433) | 'class' => [], |
| [434](#L434) | 'alt'   => [], |
| [435](#L435) | ], |
| [436](#L436) | 'div'    => [ |
| [437](#L437) | 'class' => [], |
| [438](#L438) | ], |
| [439](#L439) | 'li'     => [ |
| [440](#L440) | 'id'                              => [], |
| [441](#L441) | 'class'                           => [], |
| [442](#L442) | 'data-envira-gallery-image'       => [], |
| [443](#L443) | 'data-envira-gallery-image-model' => [], |
| [444](#L444) | ], |
| [445](#L445) | 'em'     => [], |
| [446](#L446) | 'span'   => [ |
| [447](#L447) | 'class' => [], |
| [448](#L448) | ], |
| [449](#L449) | 'strong' => [], |
| [450](#L450) | ]; |
| [451](#L451) |  |
| [452](#L452) | if ( isset( $meta['title'] ) ) { |
| [453](#L453) | $gallery\_data['gallery'][ $attach\_id ]['title'] = trim( wp\_kses( $meta['title'], $wp\_kses\_allowed\_html ) ); |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | if ( isset( $meta['alt'] ) ) { |
| [457](#L457) | $gallery\_data['gallery'][ $attach\_id ]['alt'] = trim( esc\_html( $meta['alt'] ) ); |
| [458](#L458) | } |
| [459](#L459) |  |
| [460](#L460) | if ( isset( $meta['link'] ) ) { |
| [461](#L461) | $gallery\_data['gallery'][ $attach\_id ]['link'] = esc\_url( $meta['link'] ); |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | if ( isset( $meta['link\_new\_window'] ) ) { |
| [465](#L465) | $gallery\_data['gallery'][ $attach\_id ]['link\_new\_window'] = trim( $meta['link\_new\_window'] ); |
| [466](#L466) | } |
| [467](#L467) |  |
| [468](#L468) | // Allow filtering of meta before saving. |
| [469](#L469) | $gallery\_data = apply\_filters( 'envira\_gallery\_ajax\_save\_meta', $gallery\_data, $meta, $attach\_id, $post\_id ); |
| [470](#L470) |  |
| [471](#L471) | // Update the gallery data. |
| [472](#L472) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [473](#L473) |  |
| [474](#L474) | // Flush the gallery cache. |
| [475](#L475) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [476](#L476) |  |
| [477](#L477) | // Done. |
| [478](#L478) | wp\_send\_json\_success(); |
| [479](#L479) | die; |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | add\_action( 'wp\_ajax\_envira\_gallery\_save\_bulk\_meta', 'envira\_gallery\_ajax\_save\_bulk\_meta' ); |
| [483](#L483) | /\*\* |
| [484](#L484) | \* Saves the metadata for multiple images in a gallery (bulk edit). |
| [485](#L485) | \* |
| [486](#L486) | \* @since 1.4.2.2 |
| [487](#L487) | \*/ |
| [488](#L488) | function envira\_gallery\_ajax\_save\_bulk\_meta() { |
| [489](#L489) |  |
| [490](#L490) | // Run a security check first. |
| [491](#L491) | check\_admin\_referer( 'envira-gallery-save-meta', 'nonce' ); |
| [492](#L492) |  |
| [493](#L493) | // Get the Envira Gallery ID. |
| [494](#L494) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [495](#L495) |  |
| [496](#L496) | if ( null === $post\_id ) { |
| [497](#L497) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [498](#L498) | } |
| [499](#L499) |  |
| [500](#L500) | if ( ! current\_user\_can( 'edit\_post', $post\_id ) ) { |
| [501](#L501) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | // Prepare variables. |
| [505](#L505) | $image\_ids = isset( $\_POST['image\_ids'] ) ? wp\_unslash( $\_POST['image\_ids'] ) : array(); // @codingStandardsIgnoreLine - Array |
| [506](#L506) | $meta      = isset( $\_POST['meta'] ) ? wp\_unslash( $\_POST['meta'] ) : array(); // @codingStandardsIgnoreLine - Array |
| [507](#L507) |  |
| [508](#L508) | // Check the required variables exist. |
| [509](#L509) | if ( empty( $post\_id ) ) { |
| [510](#L510) | wp\_send\_json\_error(); |
| [511](#L511) | } |
| [512](#L512) | if ( empty( $image\_ids ) || ! is\_array( $image\_ids ) ) { |
| [513](#L513) | wp\_send\_json\_error(); |
| [514](#L514) | } |
| [515](#L515) | if ( empty( $meta ) || ! is\_array( $meta ) ) { |
| [516](#L516) | wp\_send\_json\_error(); |
| [517](#L517) | } |
| [518](#L518) |  |
| [519](#L519) | // Get gallery. |
| [520](#L520) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [521](#L521) | if ( empty( $gallery\_data ) || ! is\_array( $gallery\_data ) ) { |
| [522](#L522) | wp\_send\_json\_error(); |
| [523](#L523) | } |
| [524](#L524) |  |
| [525](#L525) | // Iterate through gallery images, updating the metadata. |
| [526](#L526) | foreach ( $image\_ids as $image\_id ) { |
| [527](#L527) | // If the image isn't in the gallery, something went wrong - so skip this image. |
| [528](#L528) | if ( ! isset( $gallery\_data['gallery'][ $image\_id ] ) ) { |
| [529](#L529) | continue; |
| [530](#L530) | } |
| [531](#L531) |  |
| [532](#L532) | // Update image metadata. |
| [533](#L533) | if ( isset( $meta['title'] ) && ! empty( $meta['title'] ) ) { |
| [534](#L534) | $gallery\_data['gallery'][ $image\_id ]['title'] = trim( $meta['title'] ); |
| [535](#L535) | } |
| [536](#L536) |  |
| [537](#L537) | if ( isset( $meta['alt'] ) && ! empty( $meta['alt'] ) ) { |
| [538](#L538) | $gallery\_data['gallery'][ $image\_id ]['alt'] = trim( esc\_html( $meta['alt'] ) ); |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | if ( isset( $meta['link'] ) && ! empty( $meta['link'] ) ) { |
| [542](#L542) | $gallery\_data['gallery'][ $image\_id ]['link'] = esc\_url( $meta['link'] ); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | if ( isset( $meta['link\_new\_window'] ) && ! empty( $meta['link\_new\_window'] ) ) { |
| [546](#L546) | $gallery\_data['gallery'][ $image\_id ]['link\_new\_window'] = trim( $meta['link\_new\_window'] ); |
| [547](#L547) | } |
| [548](#L548) |  |
| [549](#L549) | if ( isset( $meta['caption'] ) && ! empty( $meta['caption'] ) ) { |
| [550](#L550) | $gallery\_data['gallery'][ $image\_id ]['caption'] = trim( $meta['caption'] ); |
| [551](#L551) | } |
| [552](#L552) |  |
| [553](#L553) | // Allow filtering of meta before saving. |
| [554](#L554) | $gallery\_data = apply\_filters( 'envira\_gallery\_ajax\_save\_bulk\_meta', $gallery\_data, $meta, $image\_id, $post\_id ); |
| [555](#L555) | } |
| [556](#L556) |  |
| [557](#L557) | // Update the gallery data. |
| [558](#L558) | update\_post\_meta( $post\_id, '\_eg\_gallery\_data', $gallery\_data ); |
| [559](#L559) |  |
| [560](#L560) | // Flush the gallery cache. |
| [561](#L561) | Envira\_Gallery\_Common::get\_instance()->flush\_gallery\_caches( $post\_id ); |
| [562](#L562) |  |
| [563](#L563) | // Done. |
| [564](#L564) | wp\_send\_json\_success(); |
| [565](#L565) | die; |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | add\_action( 'wp\_ajax\_envira\_gallery\_refresh', 'envira\_gallery\_ajax\_refresh' ); |
| [569](#L569) | /\*\* |
| [570](#L570) | \* Refreshes the DOM view for a gallery. |
| [571](#L571) | \* |
| [572](#L572) | \* @since 1.0.0 |
| [573](#L573) | \*/ |
| [574](#L574) | function envira\_gallery\_ajax\_refresh() { |
| [575](#L575) |  |
| [576](#L576) | // Run a security check first. |
| [577](#L577) | check\_admin\_referer( 'envira-gallery-refresh', 'nonce' ); |
| [578](#L578) |  |
| [579](#L579) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [580](#L580) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [581](#L581) | } |
| [582](#L582) |  |
| [583](#L583) | // Prepare variables. |
| [584](#L584) | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
| [585](#L585) | $gallery = ''; |
| [586](#L586) |  |
| [587](#L587) | // Grab all gallery data. |
| [588](#L588) | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
| [589](#L589) |  |
| [590](#L590) | // If there are no gallery items, don't do anything. |
| [591](#L591) | if ( empty( $gallery\_data ) || empty( $gallery\_data['gallery'] ) ) { |
| [592](#L592) | echo wp\_json\_encode( [ 'error' => true ] ); |
| [593](#L593) | die; |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | // Loop through the data and build out the gallery view. |
| [597](#L597) | foreach ( (array) $gallery\_data['gallery'] as $id => $data ) { |
| [598](#L598) | $gallery .= Envira\_Gallery\_Metaboxes::get\_instance()->get\_gallery\_item( $id, $data, $post\_id ); |
| [599](#L599) | } |
| [600](#L600) |  |
| [601](#L601) | echo wp\_json\_encode( [ 'success' => $gallery ] ); |
| [602](#L602) | die; |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | add\_action( 'wp\_ajax\_envira\_gallery\_load\_gallery\_data', 'envira\_gallery\_ajax\_load\_gallery\_data' ); |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* Retrieves and return gallery data for the specified ID. |
| [609](#L609) | \* |
| [610](#L610) | \* @since 1.0.0 |
| [611](#L611) | \*/ |
| [612](#L612) | function envira\_gallery\_ajax\_load\_gallery\_data() { |
| [613](#L613) | check\_admin\_referer( 'envira-gallery-load-gallery', 'nonce' ); |
| [614](#L614) | $gallery\_id = isset( $\_POST['post\_id'] ) ? absint( sanitize\_key( $\_POST['post\_id'] ) ) : null; |
| [615](#L615) |  |
| [616](#L616) | if ( ! current\_user\_can( 'edit\_post', $gallery\_id ) ) { |
| [617](#L617) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [618](#L618) | } |
| [619](#L619) |  |
| [620](#L620) | $gallery\_data = get\_post\_meta( $gallery\_id, '\_eg\_gallery\_data', true ); |
| [621](#L621) |  |
| [622](#L622) | // Send back the gallery data. |
| [623](#L623) | echo wp\_json\_encode( $gallery\_data ); |
| [624](#L624) | die; |
| [625](#L625) | } |
| [626](#L626) |  |
| [627](#L627) | add\_action( 'wp\_ajax\_envira\_gallery\_install\_addon', 'envira\_gallery\_ajax\_install\_addon' ); |
| [628](#L628) | /\*\* |
| [629](#L629) | \* Installs an Envira addon. |
| [630](#L630) | \* |
| [631](#L631) | \* @since 1.0.0 |
| [632](#L632) | \*/ |
| [633](#L633) | function envira\_gallery\_ajax\_install\_addon() { |
| [634](#L634) |  |
| [635](#L635) | // Run a security check first. |
| [636](#L636) | check\_admin\_referer( 'envira-gallery-install', 'nonce' ); |
| [637](#L637) |  |
| [638](#L638) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [639](#L639) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to install plugins.', 'envira-gallery-lite' ) ] ); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | // Install the addon. |
| [643](#L643) | if ( isset( $\_POST['plugin'] ) ) { |
| [644](#L644) | $download\_url = esc\_url\_raw( wp\_unslash( $\_POST['plugin'] ) ); |
| [645](#L645) | global $hook\_suffix; |
| [646](#L646) |  |
| [647](#L647) | // Set the current screen to avoid undefined notices. |
| [648](#L648) | set\_current\_screen(); |
| [649](#L649) |  |
| [650](#L650) | // Start output bufferring to catch the filesystem form if credentials are needed. |
| [651](#L651) | ob\_start(); |
| [652](#L652) | $creds = request\_filesystem\_credentials( $url, $method, false, false, null ); |
| [653](#L653) | if ( false === $creds ) { |
| [654](#L654) | $form = ob\_get\_clean(); |
| [655](#L655) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [656](#L656) | die; |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | // If we are not authenticated, make it happen now. |
| [660](#L660) | if ( ! WP\_Filesystem( $creds ) ) { |
| [661](#L661) | ob\_start(); |
| [662](#L662) | request\_filesystem\_credentials( $url, $method, true, false, null ); |
| [663](#L663) | $form = ob\_get\_clean(); |
| [664](#L664) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [665](#L665) | die; |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | // We do not need any extra credentials if we have gotten this far, so let's install the plugin. |
| [669](#L669) | require\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [670](#L670) | require\_once plugin\_dir\_path( Envira\_Gallery::get\_instance()->file ) . 'includes/admin/skin.php'; |
| [671](#L671) |  |
| [672](#L672) | // Create the plugin upgrader with our custom skin. |
| [673](#L673) | $skin      = new Envira\_Gallery\_Skin(); |
| [674](#L674) | $installer = new Plugin\_Upgrader( $skin ); |
| [675](#L675) | $installer->install( $download\_url ); |
| [676](#L676) |  |
| [677](#L677) | // Flush the cache and return the newly installed plugin basename. |
| [678](#L678) | wp\_cache\_flush(); |
| [679](#L679) | if ( $installer->plugin\_info() ) { |
| [680](#L680) | $plugin\_basename = $installer->plugin\_info(); |
| [681](#L681) | echo wp\_json\_encode( [ 'plugin' => $plugin\_basename ] ); |
| [682](#L682) | die; |
| [683](#L683) | } |
| [684](#L684) | } |
| [685](#L685) |  |
| [686](#L686) | // Send back a response. |
| [687](#L687) | echo wp\_json\_encode( true ); |
| [688](#L688) | die; |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) | add\_action( 'wp\_ajax\_envira\_gallery\_activate\_addon', 'envira\_gallery\_ajax\_activate\_addon' ); |
| [692](#L692) | /\*\* |
| [693](#L693) | \* Activates an Envira addon. |
| [694](#L694) | \* |
| [695](#L695) | \* @since 1.0.0 |
| [696](#L696) | \*/ |
| [697](#L697) | function envira\_gallery\_ajax\_activate\_addon() { |
| [698](#L698) |  |
| [699](#L699) | // Run a security check first. |
| [700](#L700) | check\_admin\_referer( 'envira-gallery-activate', 'nonce' ); |
| [701](#L701) |  |
| [702](#L702) | if ( ! current\_user\_can( 'activate\_plugins' ) ) { |
| [703](#L703) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to activate plugins.', 'envira-gallery-lite' ) ] ); |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | // Activate the addon. |
| [707](#L707) | if ( isset( $\_POST['plugin'] ) ) { |
| [708](#L708) | $activate = activate\_plugin( wp\_unslash( $\_POST['plugin'] ) );  // @codingStandardsIgnoreLine |
| [709](#L709) |  |
| [710](#L710) | if ( is\_wp\_error( $activate ) ) { |
| [711](#L711) | echo wp\_json\_encode( [ 'error' => $activate->get\_error\_message() ] ); |
| [712](#L712) | die; |
| [713](#L713) | } |
| [714](#L714) | } |
| [715](#L715) |  |
| [716](#L716) | echo wp\_json\_encode( true ); |
| [717](#L717) | die; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | add\_action( 'wp\_ajax\_envira\_gallery\_deactivate\_addon', 'envira\_gallery\_ajax\_deactivate\_addon' ); |
| [721](#L721) | /\*\* |
| [722](#L722) | \* Deactivates an Envira addon. |
| [723](#L723) | \* |
| [724](#L724) | \* @since 1.0.0 |
| [725](#L725) | \*/ |
| [726](#L726) | function envira\_gallery\_ajax\_deactivate\_addon() { |
| [727](#L727) |  |
| [728](#L728) | // Run a security check first. |
| [729](#L729) | check\_admin\_referer( 'envira-gallery-deactivate', 'nonce' ); |
| [730](#L730) |  |
| [731](#L731) | if ( ! current\_user\_can( 'activate\_plugins' ) ) { |
| [732](#L732) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to deactivate plugins.', 'envira-gallery-lite' ) ] ); |
| [733](#L733) | } |
| [734](#L734) |  |
| [735](#L735) | // Deactivate the addon. |
| [736](#L736) | if ( isset( $\_POST['plugin'] ) ) { |
| [737](#L737) | $deactivate = deactivate\_plugins( wp\_unslash( $\_POST['plugin'] ) );  // @codingStandardsIgnoreLine |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | echo wp\_json\_encode( true ); |
| [741](#L741) | die; |
| [742](#L742) | } |
| [743](#L743) | /\*\* |
| [744](#L744) | \* Helper function to prepare the metadata for an image in a gallery. |
| [745](#L745) | \* |
| [746](#L746) | \* @since 1.0.0 |
| [747](#L747) | \* |
| [748](#L748) | \* @param array $gallery\_data   Array of data for the gallery. |
| [749](#L749) | \* @param int   $id             The attachment ID to prepare data for. |
| [750](#L750) | \* @param array $image          Attachment image. Populated if inserting from the Media Library. |
| [751](#L751) | \* @return array $gallery\_data Amended gallery data with updated image metadata. |
| [752](#L752) | \*/ |
| [753](#L753) | function envira\_gallery\_ajax\_prepare\_gallery\_data( $gallery\_data, $id, $image = false ) { |
| [754](#L754) | // Get attachment. |
| [755](#L755) | $attachment   = get\_post( $id ); |
| [756](#L756) | $url          = wp\_get\_attachment\_image\_src( $id, 'full' ); |
| [757](#L757) | $url\_from\_src = isset( $url[0] ) ? esc\_url( $url[0] ) : ''; |
| [758](#L758) |  |
| [759](#L759) | // Depending on whether we're inserting from the Media Library or not, prepare the image array. |
| [760](#L760) | if ( ! $image ) { |
| [761](#L761) | $alt\_text  = get\_post\_meta( $id, '\_wp\_attachment\_image\_alt', true ); |
| [762](#L762) | $new\_image = [ |
| [763](#L763) | 'status'  => 'active', |
| [764](#L764) | 'src'     => $url\_from\_src, |
| [765](#L765) | 'title'   => get\_the\_title( $id ), |
| [766](#L766) | 'link'    => $url\_from\_src, |
| [767](#L767) | 'alt'     => ! empty( $alt\_text ) ? $alt\_text : '', |
| [768](#L768) | 'caption' => ! empty( $attachment->post\_excerpt ) ? $attachment->post\_excerpt : '', |
| [769](#L769) | 'thumb'   => '', |
| [770](#L770) | ]; |
| [771](#L771) | } else { |
| [772](#L772) | $src       = isset( $image['src'] ) ? $image['src'] : ( ! empty( $image['url'] ) ? $image['url'] : $url\_from\_src ); |
| [773](#L773) | $link      = isset( $image['link'] ) && wp\_http\_validate\_url( $image['link'] ) ? $image['link'] : $src; |
| [774](#L774) | $new\_image = [ |
| [775](#L775) | 'status'  => 'active', |
| [776](#L776) | 'src'     => $src, |
| [777](#L777) | 'title'   => $image['title'], |
| [778](#L778) | 'link'    => $link, |
| [779](#L779) | 'alt'     => $image['alt'], |
| [780](#L780) | 'caption' => $image['caption'], |
| [781](#L781) | 'thumb'   => '', |
| [782](#L782) | ]; |
| [783](#L783) | } |
| [784](#L784) |  |
| [785](#L785) | // Allow Addons to possibly add metadata now. |
| [786](#L786) | $image = apply\_filters( 'envira\_gallery\_ajax\_prepare\_gallery\_data\_item', $new\_image, $image, $id, $gallery\_data ); |
| [787](#L787) |  |
| [788](#L788) | // If gallery data is not an array (i.e. we have no images), just add the image to the array. |
| [789](#L789) | if ( ! isset( $gallery\_data['gallery'] ) || ! is\_array( $gallery\_data['gallery'] ) ) { |
| [790](#L790) | $gallery\_data['gallery']        = []; |
| [791](#L791) | $gallery\_data['gallery'][ $id ] = $image; |
| [792](#L792) | } else { |
| [793](#L793) |  |
| [794](#L794) | // Add image, this will default to the end of the array. |
| [795](#L795) | $gallery\_data['gallery'][ $id ] = $image; |
| [796](#L796) |  |
| [797](#L797) | } |
| [798](#L798) |  |
| [799](#L799) | // Filter and return. |
| [800](#L800) | $gallery\_data = apply\_filters( 'envira\_gallery\_ajax\_item\_data', $gallery\_data, $attachment, $id, $image ); |
| [801](#L801) |  |
| [802](#L802) | return $gallery\_data; |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | /\*\* |
| [806](#L806) | \* Called whenever a notice is dismissed in Envira Gallery or its Addons. |
| [807](#L807) | \* |
| [808](#L808) | \* Updates a key's value in the options table to mark the notice as dismissed, |
| [809](#L809) | \* preventing it from displaying again |
| [810](#L810) | \* |
| [811](#L811) | \* @since 1.3.5 |
| [812](#L812) | \*/ |
| [813](#L813) | function envira\_gallery\_ajax\_dismiss\_notice() { |
| [814](#L814) |  |
| [815](#L815) | // Run a security check first. |
| [816](#L816) | check\_admin\_referer( 'envira-gallery-dismiss-notice', 'nonce' ); |
| [817](#L817) |  |
| [818](#L818) | if ( ! current\_user\_can( 'edit\_dashboard' ) ) { |
| [819](#L819) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to dismiss notices.', 'envira-gallery-lite' ) ] ); |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | // Deactivate the notice. |
| [823](#L823) | if ( isset( $\_POST['notice'] ) ) { |
| [824](#L824) | // Init the notice class and mark notice as deactivated. |
| [825](#L825) | $notice = Envira\_Gallery\_Notice\_Admin::get\_instance(); |
| [826](#L826) | $notice->dismiss( sanitize\_text\_field( wp\_unslash( $\_POST['notice'] ) ) ); |
| [827](#L827) |  |
| [828](#L828) | echo wp\_json\_encode( true ); |
| [829](#L829) | die; |
| [830](#L830) | } |
| [831](#L831) |  |
| [832](#L832) | // If here, an error occured. |
| [833](#L833) | echo wp\_json\_encode( false ); |
| [834](#L834) | die; |
| [835](#L835) | } |
| [836](#L836) | add\_action( 'wp\_ajax\_envira\_gallery\_ajax\_dismiss\_notice', 'envira\_gallery\_ajax\_dismiss\_notice' ); |
| [837](#L837) |  |
| [838](#L838) |  |
| [839](#L839) | add\_action( 'wp\_ajax\_envira\_gallery\_ajax\_dismiss\_topbar', 'envira\_gallery\_ajax\_dismiss\_topbar' ); |
| [840](#L840) |  |
| [841](#L841) | /\*\* |
| [842](#L842) | \* Dismiss top bar |
| [843](#L843) | \* |
| [844](#L844) | \* @return void |
| [845](#L845) | \*/ |
| [846](#L846) | function envira\_gallery\_ajax\_dismiss\_topbar() { |
| [847](#L847) | // Run a security check first. |
| [848](#L848) | check\_admin\_referer( 'envira-gallery-dismiss-topbar', 'nonce' ); |
| [849](#L849) |  |
| [850](#L850) | if ( ! current\_user\_can( 'edit\_dashboard' ) ) { |
| [851](#L851) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to dismiss notices.', 'envira-gallery-lite' ) ] ); |
| [852](#L852) | } |
| [853](#L853) |  |
| [854](#L854) | update\_option( 'envira\_pro\_upgrade\_header\_dismissed', true ); |
| [855](#L855) |  |
| [856](#L856) | wp\_send\_json\_success(); |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | add\_action( 'wp\_ajax\_envira\_gallery\_get\_attachment\_links', 'envira\_gallery\_get\_attachment\_links' ); |
| [860](#L860) |  |
| [861](#L861) | /\*\* |
| [862](#L862) | \* Returns the media link (direct image URL) for the given attachment ID |
| [863](#L863) | \* |
| [864](#L864) | \* @since 1.4.1.4 |
| [865](#L865) | \*/ |
| [866](#L866) | function envira\_gallery\_get\_attachment\_links() { |
| [867](#L867) |  |
| [868](#L868) | // Check nonce. |
| [869](#L869) | check\_ajax\_referer( 'envira-gallery-save-meta', 'nonce' ); |
| [870](#L870) |  |
| [871](#L871) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [872](#L872) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [873](#L873) | } |
| [874](#L874) |  |
| [875](#L875) | // Get required inputs. |
| [876](#L876) | $attachment\_id = isset( $\_POST['attachment\_id'] ) ? absint( wp\_unslash( $\_POST['attachment\_id'] ) ) : null; |
| [877](#L877) |  |
| [878](#L878) | // Return the attachment's links. |
| [879](#L879) | wp\_send\_json\_success( |
| [880](#L880) | [ |
| [881](#L881) | 'media\_link'      => wp\_get\_attachment\_url( $attachment\_id ), |
| [882](#L882) | 'attachment\_page' => get\_attachment\_link( $attachment\_id ), |
| [883](#L883) | ] |
| [884](#L884) | ); |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | add\_action( 'wp\_ajax\_envira\_gallery\_editor\_get\_galleries', 'envira\_gallery\_editor\_get\_galleries' ); |
| [888](#L888) |  |
| [889](#L889) | /\*\* |
| [890](#L890) | \* Returns Galleries, with an optional search term. |
| [891](#L891) | \* |
| [892](#L892) | \* @since 1.5.0 |
| [893](#L893) | \*/ |
| [894](#L894) | function envira\_gallery\_editor\_get\_galleries() { |
| [895](#L895) |  |
| [896](#L896) | // Check nonce. |
| [897](#L897) | check\_admin\_referer( 'envira-gallery-editor-get-galleries', 'nonce' ); |
| [898](#L898) |  |
| [899](#L899) | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
| [900](#L900) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [901](#L901) | } |
| [902](#L902) |  |
| [903](#L903) | // Get POSTed fields. |
| [904](#L904) | $search       = isset( $\_POST['search'] ) ? (bool) wp\_unslash( $\_POST['search'] ) : false; // @codingStandardsIgnoreLine |
| [905](#L905) | $search\_terms = isset( $\_POST['search\_terms'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['search\_terms'] ) ) : ''; // @codingStandardsIgnoreLine |
| [906](#L906) | $prepend\_ids  = isset( $\_POST['prepend\_ids'] ) ? stripslashes\_deep( wp\_unslash( $\_POST['prepend\_ids'] ) ) : array(); // @codingStandardsIgnoreLine |
| [907](#L907) | $results      = []; |
| [908](#L908) |  |
| [909](#L909) | // Get galleries. |
| [910](#L910) | $instance  = Envira\_Gallery\_Lite::get\_instance(); |
| [911](#L911) | $galleries = $instance->get\_galleries( false, true, ( $search ? $search\_terms : '' ) ); |
| [912](#L912) |  |
| [913](#L913) | // Build array of just the data we need. |
| [914](#L914) | foreach ( (array) $galleries as $gallery ) { |
| [915](#L915) | // Get the thumbnail of the first image. |
| [916](#L916) | if ( isset( $gallery['gallery'] ) && ! empty( $gallery['gallery'] ) ) { |
| [917](#L917) | // Get the first image. |
| [918](#L918) | reset( $gallery['gallery'] ); |
| [919](#L919) | $key       = key( $gallery['gallery'] ); |
| [920](#L920) | $thumbnail = wp\_get\_attachment\_image\_src( $key, 'thumbnail' ); |
| [921](#L921) | } |
| [922](#L922) |  |
| [923](#L923) | if ( ! empty( $gallery['config']['title'] ) ) { |
| [924](#L924) | $gallery\_title = $gallery['config']['title']; |
| [925](#L925) | } else { |
| [926](#L926) | $gallery\_title = false; |
| [927](#L927) | } |
| [928](#L928) |  |
| [929](#L929) | // Check to make sure variables are there. |
| [930](#L930) | $gallery\_id          = false; |
| [931](#L931) | $gallery\_config\_slug = false; |
| [932](#L932) |  |
| [933](#L933) | if ( isset( $gallery['id'] ) ) { |
| [934](#L934) | $gallery\_id = $gallery['id']; |
| [935](#L935) | } |
| [936](#L936) | if ( isset( $gallery['config']['slug'] ) ) { |
| [937](#L937) | $gallery\_config\_slug = $gallery['config']['slug']; |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | // Add gallery to results. |
| [941](#L941) | $results[] = [ |
| [942](#L942) | 'id'        => $gallery\_id, |
| [943](#L943) | 'slug'      => $gallery\_config\_slug, |
| [944](#L944) | 'title'     => $gallery\_title, |
| [945](#L945) | 'thumbnail' => ( ( isset( $thumbnail ) && is\_array( $thumbnail ) ) ? $thumbnail[0] : '' ), |
| [946](#L946) | 'action'    => 'gallery', // Tells the editor modal whether this is a Gallery or Album for the shortcode output. |
| [947](#L947) | ]; |
| [948](#L948) | } |
| [949](#L949) |  |
| [950](#L950) | // If any prepended Gallery IDs were specified, get them now. |
| [951](#L951) | // These will typically be a Defaults Gallery, which wouldn't be included in the above get\_galleries() call. |
| [952](#L952) | if ( is\_array( $prepend\_ids ) && count( $prepend\_ids ) > 0 ) { |
| [953](#L953) | $prepend\_results = []; |
| [954](#L954) |  |
| [955](#L955) | // Get each Gallery. |
| [956](#L956) | foreach ( $prepend\_ids as $gallery\_id ) { |
| [957](#L957) | // Get gallery. |
| [958](#L958) | $gallery = get\_post\_meta( $gallery\_id, '\_eg\_gallery\_data', true ); |
| [959](#L959) |  |
| [960](#L960) | // Get gallery first image. |
| [961](#L961) | if ( isset( $gallery['gallery'] ) && ! empty( $gallery['gallery'] ) ) { |
| [962](#L962) | // Get the first image. |
| [963](#L963) | reset( $gallery['gallery'] ); |
| [964](#L964) | $key       = key( $gallery['gallery'] ); |
| [965](#L965) | $thumbnail = wp\_get\_attachment\_image\_src( $key, 'thumbnail' ); |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | // Add gallery to results. |
| [969](#L969) | $prepend\_results[] = [ |
| [970](#L970) | 'id'        => $gallery['id'], |
| [971](#L971) | 'slug'      => $gallery['config']['slug'], |
| [972](#L972) | 'title'     => $gallery['config']['title'], |
| [973](#L973) | 'thumbnail' => ( ( isset( $thumbnail ) && is\_array( $thumbnail ) ) ? $thumbnail[0] : '' ), |
| [974](#L974) | 'action'    => 'gallery', // Tells the editor modal whether this is a Gallery or Album for the shortcode output. |
| [975](#L975) | ]; |
| [976](#L976) | } |
| [977](#L977) |  |
| [978](#L978) | // Add to results. |
| [979](#L979) | if ( is\_array( $prepend\_results ) && count( $prepend\_results ) > 0 ) { |
| [980](#L980) | $results = array\_merge( $prepend\_results, $results ); |
| [981](#L981) | } |
| [982](#L982) | } |
| [983](#L983) |  |
| [984](#L984) | // Return galleries. |
| [985](#L985) | wp\_send\_json\_success( $results ); |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | add\_action( 'wp\_ajax\_envira\_gallery\_move\_media', 'envira\_gallery\_move\_media' ); |
| [989](#L989) |  |
| [990](#L990) | /\*\* |
| [991](#L991) | \* Moves media (images) from one Gallery to another |
| [992](#L992) | \* |
| [993](#L993) | \* @since 1.5.0.3 |
| [994](#L994) | \*/ |
| [995](#L995) | function envira\_gallery\_move\_media() { |
| [996](#L996) |  |
| [997](#L997) | // Check nonce. |
| [998](#L998) | check\_admin\_referer( 'envira-gallery-move-media', 'nonce' ); |
| [999](#L999) |  |
| [1000](#L1000) | // Get the Envira Gallery ID. |
| [1001](#L1001) | $from\_gallery\_id = isset( $\_POST['from\_gallery\_id'] ) ? absint( wp\_unslash( $\_POST['from\_gallery\_id'] ) ) : null; |
| [1002](#L1002) |  |
| [1003](#L1003) | if ( null === $from\_gallery\_id ) { |
| [1004](#L1004) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | if ( ! current\_user\_can( 'edit\_post', $from\_gallery\_id ) ) { |
| [1008](#L1008) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
| [1009](#L1009) | } |
| [1010](#L1010) |  |
| [1011](#L1011) | // Get POSTed fields. |
| [1012](#L1012) | $to\_gallery\_id = isset( $\_POST['to\_gallery\_id'] ) ? absint( $\_POST['to\_gallery\_id'] ) : null; |
| [1013](#L1013) | $image\_ids       = isset( $\_POST['image\_ids'] ) ? wp\_unslash( $\_POST['image\_ids'] ) : array(); // @codingStandardsIgnoreLine |
| [1014](#L1014) |  |
| [1015](#L1015) | if ( ! $from\_gallery\_id ) { |
| [1016](#L1016) | wp\_send\_json\_error( \_\_( 'The From Gallery ID has not been specified.', 'envira-gallery-lite' ) ); |
| [1017](#L1017) | } |
| [1018](#L1018) | if ( ! $to\_gallery\_id ) { |
| [1019](#L1019) | wp\_send\_json\_error( \_\_( 'The From Gallery ID has not been specified.', 'envira-gallery-lite' ) ); |
| [1020](#L1020) | } |
| [1021](#L1021) | if ( count( $image\_ids ) === 0 ) { |
| [1022](#L1022) | wp\_send\_json\_error( \_\_( 'No images were selected to be moved between Galleries.', 'envira-gallery-lite' ) ); |
| [1023](#L1023) | } |
| [1024](#L1024) |  |
| [1025](#L1025) | // Get from and to Galleries. |
| [1026](#L1026) | $from\_gallery = Envira\_Gallery::get\_instance()->get\_gallery( $from\_gallery\_id ); |
| [1027](#L1027) | $to\_gallery   = Envira\_Gallery::get\_instance()->get\_gallery( $to\_gallery\_id ); |
| [1028](#L1028) |  |
| [1029](#L1029) | // Iterate through each image ID, adding the image to $to\_gallery, then removing from $from\_gallery. |
| [1030](#L1030) | foreach ( $image\_ids as $image\_id ) { |
| [1031](#L1031) | // Check the image exists in $from\_gallery. |
| [1032](#L1032) | // If not, skip this image. |
| [1033](#L1033) | if ( ! isset( $from\_gallery['gallery'][ $image\_id ] ) ) { |
| [1034](#L1034) | continue; |
| [1035](#L1035) | } |
| [1036](#L1036) |  |
| [1037](#L1037) | // Copy the image to $to\_gallery. |
| [1038](#L1038) | $to\_gallery['gallery'][ $image\_id ] = $from\_gallery['gallery'][ $image\_id ]; |
| [1039](#L1039) |  |
| [1040](#L1040) | // Remove the image from $from\_gallery. |
| [1041](#L1041) | unset( $from\_gallery['gallery'][ $image\_id ] ); |
| [1042](#L1042) | } |
| [1043](#L1043) |  |
| [1044](#L1044) | // Save both Galleries. |
| [1045](#L1045) | update\_post\_meta( $from\_gallery\_id, '\_eg\_gallery\_data', $from\_gallery ); |
| [1046](#L1046) | update\_post\_meta( $to\_gallery\_id, '\_eg\_gallery\_data', $to\_gallery ); |
| [1047](#L1047) |  |
| [1048](#L1048) | // Return success. |
| [1049](#L1049) | wp\_send\_json\_success(); |
| [1050](#L1050) | } |
| [1051](#L1051) | add\_action( 'wp\_ajax\_envira\_activate\_partner', 'envira\_activate\_partner' ); |
| [1052](#L1052) |  |
| [1053](#L1053) | /\*\* |
| [1054](#L1054) | \* Helper method to activate partner |
| [1055](#L1055) | \* |
| [1056](#L1056) | \* @since 1.90 |
| [1057](#L1057) | \* |
| [1058](#L1058) | \* @return void |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | function envira\_activate\_partner() { |
| [1061](#L1061) | // Run a security check first. |
| [1062](#L1062) | check\_admin\_referer( 'envira-gallery-activate-partner', 'nonce' ); |
| [1063](#L1063) |  |
| [1064](#L1064) | if ( ! current\_user\_can( 'activate\_plugins' ) ) { |
| [1065](#L1065) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to activate plugins.', 'envira-gallery-lite' ) ] ); |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | // Activate the addon. |
| [1069](#L1069) | if ( isset( $\_POST['basename'] ) ) { |
| [1070](#L1070) | $activate = activate\_plugin( sanitize\_text\_field( wp\_unslash( $\_POST['basename'] ) ) ); |
| [1071](#L1071) |  |
| [1072](#L1072) | if ( is\_wp\_error( $activate ) ) { |
| [1073](#L1073) | echo wp\_json\_encode( [ 'error' => $activate->get\_error\_message() ] ); |
| [1074](#L1074) | die; |
| [1075](#L1075) | } |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | echo wp\_json\_encode( true ); |
| [1079](#L1079) | die; |
| [1080](#L1080) | } |
| [1081](#L1081) |  |
| [1082](#L1082) | add\_action( 'wp\_ajax\_envira\_deactivate\_partner', 'envira\_deactivate\_partner' ); |
| [1083](#L1083) |  |
| [1084](#L1084) | /\*\* |
| [1085](#L1085) | \* Helper method to deactivate partner |
| [1086](#L1086) | \* |
| [1087](#L1087) | \* @since 1.90 |
| [1088](#L1088) | \* |
| [1089](#L1089) | \* @return void |
| [1090](#L1090) | \*/ |
| [1091](#L1091) | function envira\_deactivate\_partner() { |
| [1092](#L1092) | // Run a security check first. |
| [1093](#L1093) | check\_admin\_referer( 'envira-gallery-deactivate-partner', 'nonce' ); |
| [1094](#L1094) |  |
| [1095](#L1095) | if ( ! current\_user\_can( 'activate\_plugins' ) ) { |
| [1096](#L1096) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to deactivate plugins.', 'envira-gallery-lite' ) ] ); |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | // Deactivate the addon. |
| [1100](#L1100) | if ( isset( $\_POST['basename'] ) ) { |
| [1101](#L1101) | $deactivate = deactivate\_plugins( wp\_unslash( $\_POST['basename'] ) );  // @codingStandardsIgnoreLine |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | echo wp\_json\_encode( true ); |
| [1105](#L1105) | die; |
| [1106](#L1106) | } |
| [1107](#L1107) | add\_action( 'wp\_ajax\_envira\_install\_partner', 'envira\_install\_partner' ); |
| [1108](#L1108) |  |
| [1109](#L1109) | /\*\* |
| [1110](#L1110) | \* Helper method to install partner |
| [1111](#L1111) | \* |
| [1112](#L1112) | \* @since 1.90 |
| [1113](#L1113) | \* |
| [1114](#L1114) | \* @return void |
| [1115](#L1115) | \*/ |
| [1116](#L1116) | function envira\_install\_partner() { |
| [1117](#L1117) |  |
| [1118](#L1118) | check\_admin\_referer( 'envira-gallery-install-partner', 'nonce' ); |
| [1119](#L1119) |  |
| [1120](#L1120) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [1121](#L1121) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to install plugins.', 'envira-gallery-lite' ) ] ); |
| [1122](#L1122) | } |
| [1123](#L1123) |  |
| [1124](#L1124) | // Install the addon. |
| [1125](#L1125) | if ( isset( $\_POST['download\_url'] ) ) { |
| [1126](#L1126) |  |
| [1127](#L1127) | $download\_url = esc\_url\_raw( wp\_unslash( $\_POST['download\_url'] ) ); |
| [1128](#L1128) | global $hook\_suffix; |
| [1129](#L1129) |  |
| [1130](#L1130) | // Set the current screen to avoid undefined notices. |
| [1131](#L1131) | set\_current\_screen(); |
| [1132](#L1132) |  |
| [1133](#L1133) | $method = ''; |
| [1134](#L1134) | $url    = esc\_url( admin\_url( 'edit.php?post\_type=envira&page=envira-gallery-lite-about-us' ) ); |
| [1135](#L1135) |  |
| [1136](#L1136) | // Start output bufferring to catch the filesystem form if credentials are needed. |
| [1137](#L1137) | ob\_start(); |
| [1138](#L1138) | $creds = request\_filesystem\_credentials( $url, $method, false, false, null ); |
| [1139](#L1139) | if ( false === $creds ) { |
| [1140](#L1140) | $form = ob\_get\_clean(); |
| [1141](#L1141) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [1142](#L1142) | die; |
| [1143](#L1143) | } |
| [1144](#L1144) |  |
| [1145](#L1145) | // If we are not authenticated, make it happen now. |
| [1146](#L1146) | if ( ! WP\_Filesystem( $creds ) ) { |
| [1147](#L1147) | ob\_start(); |
| [1148](#L1148) | request\_filesystem\_credentials( $url, $method, true, false, null ); |
| [1149](#L1149) | $form = ob\_get\_clean(); |
| [1150](#L1150) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [1151](#L1151) | die; |
| [1152](#L1152) | } |
| [1153](#L1153) |  |
| [1154](#L1154) | // We do not need any extra credentials if we have gotten this far, so let's install the plugin. |
| [1155](#L1155) | require\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [1156](#L1156) | require\_once plugin\_dir\_path( ENVIRA\_LITE\_FILE ) . 'includes/global/Installer\_Skin.php'; |
| [1157](#L1157) |  |
| [1158](#L1158) | // Create the plugin upgrader with our custom skin. |
| [1159](#L1159) | $skin      = new Envira\_Lite\_Installer\_Skin(); |
| [1160](#L1160) | $installer = new Plugin\_Upgrader( $skin ); |
| [1161](#L1161) | $installer->install( $download\_url ); |
| [1162](#L1162) |  |
| [1163](#L1163) | // Flush the cache and return the newly installed plugin basename. |
| [1164](#L1164) | wp\_cache\_flush(); |
| [1165](#L1165) |  |
| [1166](#L1166) | if ( $installer->plugin\_info() ) { |
| [1167](#L1167) | $plugin\_basename = $installer->plugin\_info(); |
| [1168](#L1168) |  |
| [1169](#L1169) | $active = activate\_plugin( $plugin\_basename, false, false, true ); |
| [1170](#L1170) |  |
| [1171](#L1171) | wp\_send\_json\_success( [ 'plugin' => $plugin\_basename ] ); |
| [1172](#L1172) |  |
| [1173](#L1173) | die(); |
| [1174](#L1174) | } |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | // Send back a response. |
| [1178](#L1178) | echo wp\_json\_encode( true ); |
| [1179](#L1179) | die; |
| [1180](#L1180) | } |
| [1181](#L1181) |  |
| [1182](#L1182) |  |
| [1183](#L1183) | add\_action( 'wp\_ajax\_envira\_connect', 'envira\_connect' ); |
| [1184](#L1184) |  |
| [1185](#L1185) | /\*\* |
| [1186](#L1186) | \* Connects To Envira Gallery Pro |
| [1187](#L1187) | \* |
| [1188](#L1188) | \* @since 1.8.7 |
| [1189](#L1189) | \* |
| [1190](#L1190) | \* @return void |
| [1191](#L1191) | \*/ |
| [1192](#L1192) | function envira\_connect() { |
| [1193](#L1193) | // Run a security check. |
| [1194](#L1194) | check\_ajax\_referer( 'envira\_gallery\_connect' ); |
| [1195](#L1195) |  |
| [1196](#L1196) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [1197](#L1197) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to install plugins.', 'envira-gallery-lite' ) ] ); |
| [1198](#L1198) | } |
| [1199](#L1199) |  |
| [1200](#L1200) | $key = ! empty( $\_POST['key'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['key'] ) ) : ''; |
| [1201](#L1201) | if ( empty( $key ) ) { |
| [1202](#L1202) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Please enter your license key to connect.', 'envira-gallery-lite' ) ] ); |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | $valid\_key = envira\_api\_remote\_request( 'verify-key', [ 'tgm-lite-key' => $key ] ); |
| [1206](#L1206) |  |
| [1207](#L1207) | // If it returns false, send back a generic error message and return. |
| [1208](#L1208) | if ( ! $valid\_key ) { |
| [1209](#L1209) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'There was an error connecting to the remote key API. Please try again later.', 'envira-gallery-lite' ) ] ); |
| [1210](#L1210) | } |
| [1211](#L1211) |  |
| [1212](#L1212) | // If an error is returned, set the error and return. |
| [1213](#L1213) | if ( ! empty( $valid\_key->error ) ) { |
| [1214](#L1214) | wp\_send\_json\_error( [ 'message' => wp\_kses\_post( $valid\_key->error ) ] ); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | $option = get\_option( 'envira\_gallery' ); |
| [1218](#L1218) |  |
| [1219](#L1219) | if ( ! is\_array( $option ) ) { |
| [1220](#L1220) | $option = []; |
| [1221](#L1221) | } |
| [1222](#L1222) |  |
| [1223](#L1223) | $option['key']         = $key; |
| [1224](#L1224) | $option['type']        = isset( $valid\_key->type ) ? $valid\_key->type : $option['type']; |
| [1225](#L1225) | $option['is\_expired']  = false; |
| [1226](#L1226) | $option['is\_disabled'] = false; |
| [1227](#L1227) | $option['is\_invalid']  = false; |
| [1228](#L1228) |  |
| [1229](#L1229) | update\_option( 'envira\_gallery', $option ); |
| [1230](#L1230) |  |
| [1231](#L1231) | // Install addons from onboarding. |
| [1232](#L1232) |  |
| [1233](#L1233) | $onboarding = ! empty( $\_POST['onboarding'] ) && sanitize\_text\_field( wp\_unslash( $\_POST['onboarding'] ) ); |
| [1234](#L1234) |  |
| [1235](#L1235) | if ( $onboarding ) { |
| [1236](#L1236) | ( new OnboardingWizard() )->install\_selected\_addons( $key ); |
| [1237](#L1237) | } |
| [1238](#L1238) |  |
| [1239](#L1239) | $pro\_path = trailingslashit( WP\_PLUGIN\_DIR ) . '/envira-gallery/envira-gallery.php'; |
| [1240](#L1240) |  |
| [1241](#L1241) | if ( file\_exists( $pro\_path ) ) { |
| [1242](#L1242) |  |
| [1243](#L1243) | $active = activate\_plugin( 'envira-gallery/envira-gallery.php', false, false, true ); |
| [1244](#L1244) |  |
| [1245](#L1245) | // Deactivate Lite. |
| [1246](#L1246) | $plugin = plugin\_basename( ENVIRA\_LITE\_FILE ); |
| [1247](#L1247) |  |
| [1248](#L1248) | deactivate\_plugins( $plugin ); |
| [1249](#L1249) |  |
| [1250](#L1250) | do\_action( 'envira\_lite\_plugin\_deactivated', $plugin ); |
| [1251](#L1251) |  |
| [1252](#L1252) | wp\_send\_json\_success( |
| [1253](#L1253) | [ |
| [1254](#L1254) | 'message' => esc\_html\_\_( 'Congratulations! This site is now receiving automatic updates.', 'envira-gallery-lite' ), |
| [1255](#L1255) | 'reload'  => true, |
| [1256](#L1256) | ] |
| [1257](#L1257) | ); |
| [1258](#L1258) | } |
| [1259](#L1259) |  |
| [1260](#L1260) | if ( ! isset( $valid\_key->download\_url ) ) { |
| [1261](#L1261) | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'There was an error connecting to the remote key API. Please try again later.', 'envira-gallery-lite' ) ] ); |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | $download\_url = esc\_url\_raw( $valid\_key->download\_url ); |
| [1265](#L1265) |  |
| [1266](#L1266) | // Start output bufferring to catch the filesystem form if credentials are needed. |
| [1267](#L1267) | ob\_start(); |
| [1268](#L1268) |  |
| [1269](#L1269) | $method = ''; |
| [1270](#L1270) | $url    = esc\_url( admin\_url( 'edit.php?post\_type=envira&page=envira-gallery-lite-about-us' ) ); |
| [1271](#L1271) |  |
| [1272](#L1272) | $creds = request\_filesystem\_credentials( $url, $method, false, false, null ); |
| [1273](#L1273) | if ( false === $creds ) { |
| [1274](#L1274) | $form = ob\_get\_clean(); |
| [1275](#L1275) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [1276](#L1276) | die; |
| [1277](#L1277) | } |
| [1278](#L1278) | // If we are not authenticated, make it happen now. |
| [1279](#L1279) | if ( ! WP\_Filesystem( $creds ) ) { |
| [1280](#L1280) | ob\_start(); |
| [1281](#L1281) | request\_filesystem\_credentials( $url, $method, true, false, null ); |
| [1282](#L1282) | $form = ob\_get\_clean(); |
| [1283](#L1283) | echo wp\_json\_encode( [ 'form' => $form ] ); |
| [1284](#L1284) | die; |
| [1285](#L1285) | } |
| [1286](#L1286) | // We do not need any extra credentials if we have gotten this far, so let's install the plugin. |
| [1287](#L1287) | require\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [1288](#L1288) | require\_once plugin\_dir\_path( ENVIRA\_LITE\_FILE ) . 'includes/global/Installer\_Skin.php'; |
| [1289](#L1289) |  |
| [1290](#L1290) | // Create the plugin upgrader with our custom skin. |
| [1291](#L1291) | $skin      = new Envira\_Lite\_Installer\_Skin(); |
| [1292](#L1292) | $installer = new Plugin\_Upgrader( $skin ); |
| [1293](#L1293) | $installer->install( $download\_url ); |
| [1294](#L1294) |  |
| [1295](#L1295) | // Flush the cache and return the newly installed plugin basename. |
| [1296](#L1296) | wp\_cache\_flush(); |
| [1297](#L1297) |  |
| [1298](#L1298) | if ( $installer->plugin\_info() ) { |
| [1299](#L1299) |  |
| [1300](#L1300) | $plugin\_basename = $installer->plugin\_info(); |
| [1301](#L1301) |  |
| [1302](#L1302) | $active = activate\_plugin( $plugin\_basename, false, false, true ); |
| [1303](#L1303) |  |
| [1304](#L1304) | // Deactivate Lite. |
| [1305](#L1305) | $plugin = plugin\_basename( ENVIRA\_LITE\_FILE ); |
| [1306](#L1306) |  |
| [1307](#L1307) | deactivate\_plugins( $plugin ); |
| [1308](#L1308) |  |
| [1309](#L1309) | do\_action( 'envira\_lite\_plugin\_deactivated', $plugin ); |
| [1310](#L1310) |  |
| [1311](#L1311) | wp\_send\_json\_success( |
| [1312](#L1312) | [ |
| [1313](#L1313) | 'message' => esc\_html\_\_( 'Congratulations! This site is now receiving automatic updates.', 'envira-gallery-lite' ), |
| [1314](#L1314) | 'reload'  => true, |
| [1315](#L1315) | ] |
| [1316](#L1316) | ); |
| [1317](#L1317) | } |
| [1318](#L1318) | } |
| [1319](#L1319) |  |
| [1320](#L1320) | /\*\* |
| [1321](#L1321) | \* Queries the remote URL via wp\_remote\_post and returns a json decoded response. |
| [1322](#L1322) | \* |
| [1323](#L1323) | \* @since 1.8.7 |
| [1324](#L1324) | \* |
| [1325](#L1325) | \* @param string $action        The name of the $\_POST action var. |
| [1326](#L1326) | \* @param array  $body           The content to retrieve from the remote URL. |
| [1327](#L1327) | \* @param array  $headers        The headers to send to the remote URL. |
| [1328](#L1328) | \* @param string $return\_format The format for returning content from the remote URL. |
| [1329](#L1329) | \* @return string|bool          Json decoded response on success, false on failure. |
| [1330](#L1330) | \*/ |
| [1331](#L1331) | function envira\_api\_remote\_request( $action, $body = [], $headers = [], $return\_format = 'json' ) { |
| [1332](#L1332) |  |
| [1333](#L1333) | // Build the body of the request. |
| [1334](#L1334) | $body = wp\_parse\_args( |
| [1335](#L1335) | $body, |
| [1336](#L1336) | [ |
| [1337](#L1337) | 'tgm-updater-action'     => $action, |
| [1338](#L1338) | 'tgm-plugin-key'         => '', |
| [1339](#L1339) | 'tgm-updater-wp-version' => get\_bloginfo( 'version' ), |
| [1340](#L1340) | 'tgm-updater-referer'    => site\_url(), |
| [1341](#L1341) | ] |
| [1342](#L1342) | ); |
| [1343](#L1343) | $body = http\_build\_query( $body, '', '&' ); |
| [1344](#L1344) | // Build the headers of the request. |
| [1345](#L1345) | $headers = wp\_parse\_args( |
| [1346](#L1346) | $headers, |
| [1347](#L1347) | [ |
| [1348](#L1348) | 'Content-Type'   => 'application/x-www-form-urlencoded', |
| [1349](#L1349) | 'Content-Length' => strlen( $body ), |
| [1350](#L1350) | ] |
| [1351](#L1351) | ); |
| [1352](#L1352) | // Setup variable for wp\_remote\_post. |
| [1353](#L1353) | $post = [ |
| [1354](#L1354) | 'headers' => $headers, |
| [1355](#L1355) | 'body'    => $body, |
| [1356](#L1356) | ]; |
| [1357](#L1357) | // Allow us to define the api url for development. |
| [1358](#L1358) | $api\_url = defined( 'ENVIRA\_API\_URL' ) ? ENVIRA\_API\_URL : 'https://enviragallery.com'; |
| [1359](#L1359) | // Perform the query and retrieve the response. |
| [1360](#L1360) | $response      = wp\_remote\_post( $api\_url, $post ); |
| [1361](#L1361) | $response\_code = wp\_remote\_retrieve\_response\_code( $response ); /\* log this for API issues \*/ |
| [1362](#L1362) | $response\_body = wp\_remote\_retrieve\_body( $response ); |
| [1363](#L1363) |  |
| [1364](#L1364) | // Bail out early if there are any errors. |
| [1365](#L1365) | if ( 200 !== $response\_code || is\_wp\_error( $response\_body ) ) { |
| [1366](#L1366) | return false; |
| [1367](#L1367) | } |
| [1368](#L1368) | // Return the json decoded content. |
| [1369](#L1369) | return json\_decode( $response\_body ); |
| [1370](#L1370) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?format=txt)
* [Original Format](/export/3222676/envira-gallery-lite/trunk/includes/admin/ajax.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_4fd6593b_20250115_082448.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3017115%2Fenvira-gallery-lite%2Ftags%2F1.8.7.3%2Fincludes%2Fadmin%2Fajax.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2996579/envira-gallery-lite/trunk/includes/admin/ajax.php "Changeset 2996579 for envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php")
* Next Change →

---

# Changeset [3017115](/changeset/3017115 "Show full changeset") for [envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
01/03/2024 04:49:13 PM
([13 months](/timeline?from=2024-01-03T16%3A49%3A13Z&precision=second "See timeline at 01/03/2024 04:49:13 PM") ago)

Author:
chrisakelley
Message:

Release 1.8.7.3

Location:
[envira-gallery-lite/tags/1.8.7.3](/browser/envira-gallery-lite/tags/1.8.7.3?rev=3017115)
Files:

1 edited
1 copied

* [.](/browser/envira-gallery-lite/tags/1.8.7.3?rev=3017115 "Show entry in browser")
  (copied)
  *(copied from [envira-gallery-lite/trunk](/browser/envira-gallery-lite/trunk?rev=3009674 "Show original file (revision 3017114)"))*
* [includes/admin/ajax.php](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115 "Show entry in browser")
  (modified)
  ([8 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php](/changeset/3017115/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php "Show the changeset 3017115 restricted to envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php")

  | [r2996579](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L151 "Show revision 2996579 of this file in browser") | [r3017115](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L151 "Show revision 3017115 of this file in browser") |  |
  | --- | --- | --- |
  | 151 | 151 | check\_admin\_referer( 'envira-gallery-insert-images', 'nonce' ); |
  | 152 | 152 |  |
  | 153 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  |  | 153 | // Get the Envira Gallery ID. |
  |  | 154 | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
  |  | 155 |  |
  |  | 156 | if ( null === $post\_id ) { |
  |  | 157 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 158 | } |
  |  | 159 |  |
  |  | 160 | if ( ! current\_user\_can( 'edit\_posts', $post\_id ) ) { |
  | 154 | 161 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 155 | 162 | } |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L161) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L168) |  |
  | 161 | 168 | $images = json\_decode( sanitize\_text\_field( wp\_unslash( $\_POST['images'] ) ), true ); |
  | 162 | 169 | } |
  | 163 |  |  |
  | 164 |  | ~~// Get the Envira Gallery ID.~~ |
  | 165 |  | ~~$post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null;~~ |
  | 166 | 170 |  |
  | 167 | 171 | // Grab and update any gallery data if necessary. |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L236) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L240) |  |
  | 236 | 240 | check\_admin\_referer( 'envira-gallery-sort', 'nonce' ); |
  | 237 | 241 |  |
  | 238 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  |  | 242 | // Get the Envira Gallery ID. |
  |  | 243 | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
  |  | 244 |  |
  |  | 245 | if ( null === $post\_id ) { |
  |  | 246 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 247 | } |
  |  | 248 |  |
  |  | 249 | if ( ! current\_user\_can( 'edit\_posts', $post\_id ) ) { |
  | 239 | 250 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 240 | 251 | } |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L242) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L253) |  |
  | 242 | 253 | // Prepare variables. |
  | 243 | 254 | $order        = isset( $\_POST['order'] ) ? explode( ',', wp\_unslash( $\_POST['order'] ) ) : ''; // @codingStandardsIgnoreLine |
  | 244 |  | ~~$post\_id      = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null;~~ |
  | 245 | 255 | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
  | 246 | 256 |  |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L326) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L336) |  |
  | 326 | 336 | check\_admin\_referer( 'envira-gallery-remove-image', 'nonce' ); |
  | 327 | 337 |  |
  | 328 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  |  | 338 | // Get the Envira Gallery ID. |
  |  | 339 | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
  |  | 340 |  |
  |  | 341 | if ( null === $post\_id ) { |
  |  | 342 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 343 | } |
  |  | 344 |  |
  |  | 345 | if ( ! current\_user\_can( 'edit\_posts', $post\_id ) ) { |
  | 329 | 346 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 330 | 347 | } |
  | 331 | 348 |  |
  | 332 |  |  |
  | 333 | 349 | // Prepare variables. |
  | 334 |  | ~~$post\_id      = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null;~~ |
  | 335 | 350 | $attach\_ids   = isset( $\_POST['attachment\_ids'] ) ? array\_map( 'absint', wp\_unslash( (array) $\_POST['attachment\_ids'] ) ) : []; |
  | 336 | 351 | $gallery\_data = get\_post\_meta( $post\_id, '\_eg\_gallery\_data', true ); |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L382) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L397) |  |
  | 382 | 397 | check\_ajax\_referer( 'envira-gallery-save-meta', 'nonce' ); |
  | 383 | 398 |  |
  | 384 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  |  | 399 | // Get the Envira Gallery ID. |
  |  | 400 | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
  |  | 401 |  |
  |  | 402 | if ( null === $post\_id ) { |
  |  | 403 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 404 | } |
  |  | 405 |  |
  |  | 406 | if ( ! current\_user\_can( 'edit\_posts', $post\_id ) ) { |
  | 385 | 407 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 386 | 408 | } |
  | 387 | 409 |  |
  | 388 | 410 | // Prepare variables. |
  | 389 |  | ~~$post\_id      = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null;~~ |
  | 390 | 411 | $attach\_id    = isset( $\_POST['attach\_id'] ) ? absint( wp\_unslash( $\_POST['attach\_id'] ) ) : null; |
  | 391 | 412 | $meta         = isset( $\_POST['meta'] ) ? array\_map( 'sanitize\_text\_field', wp\_unslash( (array) $\_POST['meta'] ) ) : []; |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L470) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L491) |  |
  | 470 | 491 | check\_admin\_referer( 'envira-gallery-save-meta', 'nonce' ); |
  | 471 | 492 |  |
  | 472 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  |  | 493 | // Get the Envira Gallery ID. |
  |  | 494 | $post\_id = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null; |
  |  | 495 |  |
  |  | 496 | if ( null === $post\_id ) { |
  |  | 497 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 498 | } |
  |  | 499 |  |
  |  | 500 | if ( ! current\_user\_can( 'edit\_posts', $post\_id ) ) { |
  | 473 | 501 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 474 | 502 | } |
  | 475 | 503 |  |
  | 476 | 504 | // Prepare variables. |
  | 477 |  | ~~$post\_id   = isset( $\_POST['post\_id'] ) ? absint( wp\_unslash( $\_POST['post\_id'] ) ) : null;~~ |
  | 478 | 505 | $image\_ids = isset( $\_POST['image\_ids'] ) ? wp\_unslash( $\_POST['image\_ids'] ) : array(); // @codingStandardsIgnoreLine - Array |
  | 479 | 506 | $meta      = isset( $\_POST['meta'] ) ? wp\_unslash( $\_POST['meta'] ) : array(); // @codingStandardsIgnoreLine - Array |
  | […](/browser/envira-gallery-lite/trunk/includes/admin/ajax.php?rev=2996579#L973) | […](/browser/envira-gallery-lite/tags/1.8.7.3/includes/admin/ajax.php?rev=3017115#L1000) |  |
  | 973 | 1000 | check\_admin\_referer( 'envira-gallery-move-media', 'nonce' ); |
  | 974 | 1001 |  |
  | 975 |  | if ( ! current\_user\_can( 'edit\_posts' ) ) { |
  | 976 |  | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to move media.', 'envira-gallery-lite' ) ] ); |
  |  | 1002 | // Get the Envira Gallery ID. |
  |  | 1003 | $from\_gallery\_id = isset( $\_POST['from\_gallery\_id'] ) ? absint( wp\_unslash( $\_POST['from\_gallery\_id'] ) ) : null; |
  |  | 1004 |  |
  |  | 1005 | if ( null === $from\_gallery\_id ) { |
  |  | 1006 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'Invalid Post ID.', 'envira-gallery-lite' ) ] ); |
  |  | 1007 | } |
  |  | 1008 |  |
  |  | 1009 | if ( ! current\_user\_can( 'edit\_posts', $from\_gallery\_id ) ) { |
  |  | 1010 | wp\_send\_json\_error( [ 'message' => esc\_html\_\_( 'You are not allowed to edit galleries.', 'envira-gallery-lite' ) ] ); |
  | 977 | 1011 | } |
  | 978 | 1012 |  |
  | 979 | 1013 | // Get POSTed fields. |
  | 980 |  | ~~$from\_gallery\_id = isset( $\_POST['from\_gallery\_id'] ) ? absint( $\_POST['from\_gallery\_id'] ) : null;~~ |
  | 981 | 1014 | $to\_gallery\_id   = isset( $\_POST['to\_gallery\_id'] ) ? absint( $\_POST['to\_gallery\_id'] ) : null; |
  | 982 | 1015 | $image\_ids       = isset( $\_POST['image\_ids'] ) ? wp\_unslash( $\_POST['image\_ids'] ) : array(); // @codingStandardsIgnoreLine |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3017115)
* [Zip Archive](?format=zip&new=3017115)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


