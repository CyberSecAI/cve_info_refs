=== Content from plugins.trac.wordpress.org_e8f9e7ba_20250115_084859.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=3058329 "Revision 3058329")
* Next Revision →
* [Blame](/browser/paid-memberships-pro/trunk/includes/rest-api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/paid-memberships-pro/trunk/includes/rest-api.php)

---

# [source:](/browser?order=name "Go to repository root") [paid-memberships-pro](/browser/paid-memberships-pro?order=name "View paid-memberships-pro")/[trunk](/browser/paid-memberships-pro/trunk?order=name "View trunk")/[includes](/browser/paid-memberships-pro/trunk/includes?order=name "View includes")/[rest-api.php](/browser/paid-memberships-pro/trunk/includes/rest-api.php?order=name "View rest-api.php")

View diff against:

View revision:

| [Last change](/changeset/3069136/paid-memberships-pro/trunk/includes/rest-api.php "View differences") on this file was [3069136](/changeset/3069136/ "View changeset 3069136"), checked in by dlparker1005, [9 months ago](/timeline?from=2024-04-11T16%3A21%3A05Z&precision=second "See timeline at 04/11/2024 04:21:05 PM") |
| --- |
| 3.0.2 - disable custom page templates, bug fixes |
| **File size:** 43.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( class\_exists( 'WP\_REST\_Controller' ) ) { |
| [4](#L4) | class PMPro\_REST\_API\_Routes extends WP\_REST\_Controller { |
| [5](#L5) |  |
| [6](#L6) | public function pmpro\_rest\_api\_register\_routes() { |
| [7](#L7) |  |
| [8](#L8) | // ================ DEPRECATED ================ // |
| [9](#L9) | $namespace = 'wp/v2'; |
| [10](#L10) | register\_rest\_route( $namespace, '/users/(?P<id>\d+)'.'/pmpro\_membership\_level' , |
| [11](#L11) | array( |
| [12](#L12) | array( |
| [13](#L13) | 'methods'         => WP\_REST\_Server::READABLE, |
| [14](#L14) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
| [15](#L15) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [16](#L16) | ),)); |
| [17](#L17) |  |
| [18](#L18) | register\_rest\_route( $namespace, '/posts/(?P<post\_id>\d+)'.'/user\_id/(?P<user\_id>\d+)/pmpro\_has\_membership\_access' , |
| [19](#L19) | array( |
| [20](#L20) | array( |
| [21](#L21) | 'methods'         => WP\_REST\_Server::READABLE, |
| [22](#L22) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access' ), |
| [23](#L23) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [24](#L24) | ),)); |
| [25](#L25) | // ================================================  // |
| [26](#L26) |  |
| [27](#L27) | $pmpro\_namespace = 'pmpro/v1'; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Get user access for a specific post. |
| [31](#L31) | \* @since 2.3 |
| [32](#L32) | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access |
| [33](#L33) | \*/ |
| [34](#L34) | register\_rest\_route( $pmpro\_namespace, '/has\_membership\_access', |
| [35](#L35) | array( |
| [36](#L36) | array( |
| [37](#L37) | 'methods'  => WP\_REST\_Server::READABLE, |
| [38](#L38) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access'), |
| [39](#L39) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [40](#L40) | ))); |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* Get a membership level for a user. |
| [44](#L44) | \* @since 2.3 |
| [45](#L45) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user |
| [46](#L46) | \*/ |
| [47](#L47) | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_level\_for\_user', |
| [48](#L48) | array( |
| [49](#L49) | array( |
| [50](#L50) | 'methods'         => WP\_REST\_Server::READABLE, |
| [51](#L51) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
| [52](#L52) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [53](#L53) | ),)); |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Get a membership level for a user. |
| [57](#L57) | \* @since 2.3 |
| [58](#L58) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user |
| [59](#L59) | \*/ |
| [60](#L60) | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_levels\_for\_user', |
| [61](#L61) | array( |
| [62](#L62) | array( |
| [63](#L63) | 'methods'         => WP\_REST\_Server::READABLE, |
| [64](#L64) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_levels\_for\_user' ), |
| [65](#L65) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [66](#L66) | ),)); |
| [67](#L67) |  |
| [68](#L68) |  |
| [69](#L69) | /\*\* |
| [70](#L70) | \* Change a user's membership level. This also supports to cancel a membership if you pass through 0. |
| [71](#L71) | \* @since 2.3 |
| [72](#L72) | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
| [73](#L73) | \*/ |
| [74](#L74) | register\_rest\_route( $pmpro\_namespace, '/change\_membership\_level', |
| [75](#L75) | array( |
| [76](#L76) | array( |
| [77](#L77) | 'methods'       => 'POST,PUT,PATCH', |
| [78](#L78) | 'callback'      => array( $this, 'pmpro\_rest\_api\_change\_membership\_level' ), |
| [79](#L79) | 'args'  => array( |
| [80](#L80) | 'user\_id' => array(), |
| [81](#L81) | 'level\_id' => array(), |
| [82](#L82) | 'email' => array(), |
| [83](#L83) | 'first\_name' => array(), |
| [84](#L84) | 'last\_name' => array(), |
| [85](#L85) | 'user\_url' => array(), |
| [86](#L86) | 'user\_login' => array(), |
| [87](#L87) | 'description' => array(), |
| [88](#L88) | 'create\_user' => array(), |
| [89](#L89) | ), |
| [90](#L90) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [91](#L91) | ) |
| [92](#L92) | ) |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Cancel a membership level. |
| [97](#L97) | \* @since 2.3 |
| [98](#L98) | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
| [99](#L99) | \*/ |
| [100](#L100) | register\_rest\_route( $pmpro\_namespace, '/cancel\_membership\_level', |
| [101](#L101) | array( |
| [102](#L102) | array( |
| [103](#L103) | 'methods'       => 'POST,PUT,PATCH', |
| [104](#L104) | 'callback'      => array( $this, 'pmpro\_rest\_api\_cancel\_membership\_level' ), |
| [105](#L105) | 'args'  => array( |
| [106](#L106) | 'user\_id' => array(), |
| [107](#L107) | 'level\_id' => array() |
| [108](#L108) | ), |
| [109](#L109) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [110](#L110) | ) |
| [111](#L111) | ) |
| [112](#L112) | ); |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Delete/Retrieve/Update/Create a Membership Level. |
| [116](#L116) | \* @since 2.3 |
| [117](#L117) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level |
| [118](#L118) | \*/ |
| [119](#L119) | register\_rest\_route( $pmpro\_namespace, '/membership\_level' , |
| [120](#L120) | array( |
| [121](#L121) | array( |
| [122](#L122) | 'methods'         => WP\_REST\_Server::READABLE, |
| [123](#L123) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level' ), |
| [124](#L124) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [125](#L125) | ), |
| [126](#L126) | array( |
| [127](#L127) | 'methods'         => 'POST,PUT,PATCH', |
| [128](#L128) | 'callback'        => array( $this, 'pmpro\_rest\_api\_set\_membership\_level' ), |
| [129](#L129) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [130](#L130) | ), |
| [131](#L131) | array( |
| [132](#L132) | 'methods'               => 'DELETE', |
| [133](#L133) | 'callback'        => array( $this, 'pmpro\_rest\_api\_delete\_membership\_level' ), |
| [134](#L134) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [135](#L135) | ) |
| [136](#L136) | )); |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* Get all membership levels. |
| [140](#L140) | \* @since 3.0 |
| [141](#L141) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_levels |
| [142](#L142) | \*/ |
| [143](#L143) | register\_rest\_route( $pmpro\_namespace, '/membership\_levels', |
| [144](#L144) | array( |
| [145](#L145) | array( |
| [146](#L146) | 'methods'         => WP\_REST\_Server::READABLE, |
| [147](#L147) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_levels' ), |
| [148](#L148) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [149](#L149) | ), |
| [150](#L150) | ) |
| [151](#L151) | ); |
| [152](#L152) |  |
| [153](#L153) | /\*\* |
| [154](#L154) | \* Create/Retrieve discount code. |
| [155](#L155) | \* @since 2.3 |
| [156](#L156) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [157](#L157) | \*/ |
| [158](#L158) | register\_rest\_route( $pmpro\_namespace, '/discount\_code', |
| [159](#L159) | array( |
| [160](#L160) | array( |
| [161](#L161) | 'methods' => WP\_REST\_Server::READABLE, |
| [162](#L162) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_discount\_code' ), |
| [163](#L163) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [164](#L164) | ), |
| [165](#L165) | array( |
| [166](#L166) | 'methods' => 'POST,PUT,PATCH', |
| [167](#L167) | 'callback' => array( $this, 'pmpro\_rest\_api\_set\_discount\_code' ), |
| [168](#L168) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [169](#L169) | ), |
| [170](#L170) | )); |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* Retrieve an order. |
| [174](#L174) | \* @since 2.8 |
| [175](#L175) | \* Example: https://example.com/wp-json/pmpro/v1/order |
| [176](#L176) | \*/ |
| [177](#L177) | register\_rest\_route( $pmpro\_namespace, '/order', |
| [178](#L178) | array( |
| [179](#L179) | array( |
| [180](#L180) | 'methods' => WP\_REST\_Server::READABLE, |
| [181](#L181) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_order' ), |
| [182](#L182) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [183](#L183) | ), |
| [184](#L184) | )); |
| [185](#L185) | add\_filter( 'pmpro\_rest\_api\_permissions', array( $this, 'pmpro\_rest\_api\_permissions\_get\_order' ), 10, 2 ); |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* Get membership level after checkout options are applied. |
| [189](#L189) | \* @since 2.4 |
| [190](#L190) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
| [191](#L191) | \*/ |
| [192](#L192) | register\_rest\_route( $pmpro\_namespace, '/checkout\_level', |
| [193](#L193) | array( |
| [194](#L194) | array( |
| [195](#L195) | 'methods' => WP\_REST\_Server::READABLE, |
| [196](#L196) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_level' ), |
| [197](#L197) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [198](#L198) | ), |
| [199](#L199) | )); |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Get membership levels after checkout options are applied. |
| [203](#L203) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
| [204](#L204) | \* @deprecated 3.0 |
| [205](#L205) | \*/ |
| [206](#L206) | register\_rest\_route( $pmpro\_namespace, '/checkout\_levels', |
| [207](#L207) | array( |
| [208](#L208) | array( |
| [209](#L209) | 'methods' => WP\_REST\_Server::READABLE, |
| [210](#L210) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_levels' ), |
| [211](#L211) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [212](#L212) | ), |
| [213](#L213) | )); |
| [214](#L214) |  |
| [215](#L215) | /\*\* |
| [216](#L216) | \* Authentication route for Zapier integration. |
| [217](#L217) | \* |
| [218](#L218) | \* Used to do authentication when connecting Zapier to PMPro. |
| [219](#L219) | \* |
| [220](#L220) | \* @since 2.6.0 |
| [221](#L221) | \*/ |
| [222](#L222) | register\_rest\_route( $pmpro\_namespace, '/me', |
| [223](#L223) | array( |
| [224](#L224) | array( |
| [225](#L225) | 'methods' => WP\_REST\_Server::READABLE, |
| [226](#L226) | 'callback' => array( $this, 'validate\_me' ), |
| [227](#L227) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [228](#L228) | ), |
| [229](#L229) | ) |
| [230](#L230) | ); |
| [231](#L231) |  |
| [232](#L232) | /\*\* |
| [233](#L233) | \* Get the last couple of membership levels/members. |
| [234](#L234) | \* |
| [235](#L235) | \* @since 2.6.0 |
| [236](#L236) | \*/ |
| [237](#L237) | register\_rest\_route( $pmpro\_namespace, '/recent\_memberships', |
| [238](#L238) | array( |
| [239](#L239) | array( |
| [240](#L240) | 'methods'  => WP\_REST\_Server::READABLE, |
| [241](#L241) | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_memberships' ), |
| [242](#L242) | 'args'  => array( |
| [243](#L243) | 'status' => array(), |
| [244](#L244) | ), |
| [245](#L245) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [246](#L246) | ) |
| [247](#L247) | )); |
| [248](#L248) |  |
| [249](#L249) | register\_rest\_route( $pmpro\_namespace, '/recent\_orders', |
| [250](#L250) | array( |
| [251](#L251) | array( |
| [252](#L252) | 'methods'  => WP\_REST\_Server::READABLE, |
| [253](#L253) | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_orders' ), |
| [254](#L254) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [255](#L255) | ) |
| [256](#L256) | ) |
| [257](#L257) | ); |
| [258](#L258) |  |
| [259](#L259) | /\*\* |
| [260](#L260) | \* Get the IDs that a post has been restricted to. |
| [261](#L261) | \* @since 3.0 |
| [262](#L262) | \* Example: https://example.com/wp-json/pmpro/v1/post\_restrictions |
| [263](#L263) | \*/ |
| [264](#L264) | register\_rest\_route( $pmpro\_namespace, '/post\_restrictions', |
| [265](#L265) | array( |
| [266](#L266) | array( |
| [267](#L267) | 'methods'  => WP\_REST\_Server::READABLE, |
| [268](#L268) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_post\_restrictions' ), |
| [269](#L269) | 'args'     => array( |
| [270](#L270) | 'post\_id' => array(), |
| [271](#L271) | ), |
| [272](#L272) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [273](#L273) | ), |
| [274](#L274) | array( |
| [275](#L275) | 'methods'  => WP\_REST\_Server::EDITABLE, |
| [276](#L276) | 'args'     => array( |
| [277](#L277) | 'post\_id' => array(), |
| [278](#L278) | 'level\_ids' => array(), |
| [279](#L279) | ), |
| [280](#L280) | 'callback' => array( $this, 'pmpro\_rest\_api\_set\_post\_restrictions' ), |
| [281](#L281) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [282](#L282) | ) |
| [283](#L283) | ) |
| [284](#L284) | ); |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Get user's membership level. |
| [289](#L289) | \* @since 2.3 |
| [290](#L290) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user?user\_id=1 |
| [291](#L291) | \*/ |
| [292](#L292) | function pmpro\_rest\_api\_get\_membership\_level\_for\_user($request) { |
| [293](#L293) | $params = $request->get\_params(); |
| [294](#L294) |  |
| [295](#L295) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [296](#L296) |  |
| [297](#L297) | // Param id was used instead (old style endpoint). |
| [298](#L298) | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
| [299](#L299) | $user\_id = intval( $params['id'] ); |
| [300](#L300) | } |
| [301](#L301) |  |
| [302](#L302) | // Query by email. |
| [303](#L303) | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
| [304](#L304) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [305](#L305) | $user\_id = $user->ID; |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | if ( ! empty( $user\_id ) ) { |
| [309](#L309) | $level = pmpro\_getMembershipLevelForUser( $user\_id ); |
| [310](#L310) | } else { |
| [311](#L311) | $level = false; |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | return new WP\_REST\_Response( $level, 200 ); |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | /\*\* |
| [318](#L318) | \* Get user's membership levels. (MMPU) |
| [319](#L319) | \* @since 2.3 |
| [320](#L320) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user?user\_id=1 |
| [321](#L321) | \*/ |
| [322](#L322) | function pmpro\_rest\_api\_get\_membership\_levels\_for\_user($request) { |
| [323](#L323) | $params = $request->get\_params(); |
| [324](#L324) |  |
| [325](#L325) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [326](#L326) |  |
| [327](#L327) | // Param id was used instead. |
| [328](#L328) | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
| [329](#L329) | $user\_id = intval( $params['id'] ); |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | // Param email was used instead. |
| [333](#L333) | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
| [334](#L334) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [335](#L335) | $user\_id = $user->ID; |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | if ( ! empty( $user\_id ) ) { |
| [339](#L339) | $levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [340](#L340) | } else { |
| [341](#L341) | $levels = false; |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | return new WP\_REST\_Response( $levels, 200 ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Get user's access status for a specific post. |
| [349](#L349) | \* @since 2.3 |
| [350](#L350) | \* Example: https://example.com/wp-json/wp/v2/posts/58/user\_id/2/pmpro\_has\_membership\_access |
| [351](#L351) | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access?post\_id=58&user\_id=2 |
| [352](#L352) | \*/ |
| [353](#L353) | function pmpro\_rest\_api\_get\_has\_membership\_access($request) { |
| [354](#L354) | $params = $request->get\_params(); |
| [355](#L355) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [356](#L356) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [357](#L357) |  |
| [358](#L358) | if ( empty( $user\_id ) ) { |
| [359](#L359) | // see if they sent an email |
| [360](#L360) | if ( ! empty( $params['email'] ) ) { |
| [361](#L361) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [362](#L362) | $user\_id = $user->ID; |
| [363](#L363) | } else { |
| [364](#L364) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [365](#L365) | } |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | if ( ! empty( $user\_id ) ) { |
| [369](#L369) | $has\_access = pmpro\_has\_membership\_access( $post\_id, $user\_id ); |
| [370](#L370) | } else { |
| [371](#L371) | // No good user, so say no. |
| [372](#L372) | // Technically this will make public posts look restricted. |
| [373](#L373) | $has\_access = false; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | return new WP\_REST\_Response( $has\_access, 200 ); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | /\*\* |
| [380](#L380) | \* Change a user's membership level. |
| [381](#L381) | \* @since 2.3 |
| [382](#L382) | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
| [383](#L383) | \*/ |
| [384](#L384) | function pmpro\_rest\_api\_change\_membership\_level( $request ) { |
| [385](#L385) | $params = $request->get\_params(); |
| [386](#L386) | $user\_id = isset( $params['user\_id'] ) ? (int) $params['user\_id'] : null; |
| [387](#L387) | $level\_id = isset( $params['level\_id'] ) ? (int) $params['level\_id'] : null; |
| [388](#L388) | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
| [389](#L389) | $first\_name = isset( $params['first\_name'] ) ? sanitize\_text\_field( $params['first\_name'] ) : ''; |
| [390](#L390) | $last\_name = isset( $params['last\_name'] ) ? sanitize\_text\_field( $params['last\_name'] ) : ''; |
| [391](#L391) | $username = isset( $params['user\_login'] ) ? sanitize\_text\_field( $params['user\_login'] ) : $email; |
| [392](#L392) | $user\_url = isset( $params['user\_url'] ) ? sanitize\_text\_field( $params['user\_url'] ) : ''; |
| [393](#L393) | $description = isset( $params['description'] ) ? sanitize\_textarea\_field( $params['description'] ) : ''; |
| [394](#L394) | $create\_user = isset( $params['create\_user'] ) ? filter\_var( $params['create\_user'], FILTER\_VALIDATE\_BOOLEAN ) : false; |
| [395](#L395) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [396](#L396) |  |
| [397](#L397) | if ( empty( $user\_id ) ) { |
| [398](#L398) |  |
| [399](#L399) | // see if they sent an email |
| [400](#L400) | if ( ! empty( $email ) ) { |
| [401](#L401) |  |
| [402](#L402) | $user = get\_user\_by( 'email', $email ); |
| [403](#L403) |  |
| [404](#L404) | // Assume the user doesn't already exist. |
| [405](#L405) | if ( $create\_user && ! $user ) { |
| [406](#L406) |  |
| [407](#L407) | /\*\* |
| [408](#L408) | \* Filter the user data arguments for wp\_insert\_user when creating the user via the REST API. |
| [409](#L409) | \* @since 2.7.4 |
| [410](#L410) | \* @param array $user\_data An associative array with user arguments when creating the user. See https://developer.wordpress.org/reference/functions/wp\_insert\_user/ for reference. |
| [411](#L411) | \*/ |
| [412](#L412) | $user\_data = apply\_filters( 'pmpro\_api\_new\_user\_array', array( |
| [413](#L413) | 'user\_pass' => wp\_generate\_password(), |
| [414](#L414) | 'user\_email' => $email, |
| [415](#L415) | 'user\_login' => $username, |
| [416](#L416) | 'first\_name' => $first\_name, |
| [417](#L417) | 'last\_name' => $last\_name, |
| [418](#L418) | 'user\_url' => $user\_url, |
| [419](#L419) | 'description' => $description |
| [420](#L420) | ) |
| [421](#L421) | ); |
| [422](#L422) |  |
| [423](#L423) | $user\_id = wp\_insert\_user( $user\_data ); |
| [424](#L424) |  |
| [425](#L425) | if ( is\_wp\_error( $user\_id ) ) { |
| [426](#L426) | $error = $user\_id->get\_error\_message(); |
| [427](#L427) | return new WP\_REST\_Response( $error, 500 ); // Assume it failed and return a 500 error occurred like core WordPress. |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | pmpro\_maybe\_send\_wp\_new\_user\_notification( $user\_id, $level\_id ); |
| [431](#L431) | } else { |
| [432](#L432) | $user\_id = $user->ID; |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | } else { |
| [436](#L436) |  |
| [437](#L437) | if ( 'json' === $response\_type ) { |
| [438](#L438) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user information passed through.' ) ); |
| [439](#L439) | } |
| [440](#L440) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [441](#L441) | } |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | if ( ! function\_exists( 'pmpro\_changeMembershipLevel' ) ) { |
| [445](#L445) | if ( 'json' === $response\_type ) { |
| [446](#L446) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Paid Memberships Pro function not found.' ) ); |
| [447](#L447) | } |
| [448](#L448) | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | // Make sure we have a user\_id by now. |
| [452](#L452) | if ( empty( $user\_id ) ) { |
| [453](#L453) | if ( 'json' === $response\_type ) { |
| [454](#L454) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user found with that email address. Try the create\_user parameter.' ) ); |
| [455](#L455) | } |
| [456](#L456) | return new WP\_REST\_Response( 'No user found with that email address. Try the create\_user parameter.', 404 ); |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | /\*\* |
| [460](#L460) | \* Filter to allow admin levels to be changed via the REST API or Zapier application. |
| [461](#L461) | \* Defaults to false to prevent admin users from having their level changed via API. |
| [462](#L462) | \* @since 2.7.4 |
| [463](#L463) | \* @param boolean $can\_change\_admin\_users Should API calls change admin account membership levels. |
| [464](#L464) | \*/ |
| [465](#L465) | $can\_change\_admin\_users = apply\_filters( 'pmpro\_api\_change\_membership\_level\_for\_admin\_users', false ); |
| [466](#L466) | if ( ! $can\_change\_admin\_users && user\_can( $user\_id, 'manage\_options' ) ) { |
| [467](#L467) | if ( 'json' === $response\_type ) { |
| [468](#L468) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Sorry, you are not allowed to edit admin accounts.' ) ); |
| [469](#L469) | } |
| [470](#L470) | return new WP\_REST\_Response( 'Sorry, you are not allowed to edit admin accounts.', 403 ); |
| [471](#L471) | } |
| [472](#L472) |  |
| [473](#L473) | $response = pmpro\_changeMembershipLevel( $level\_id, $user\_id ); |
| [474](#L474) |  |
| [475](#L475) | if ( 'json' === $response\_type ) { |
| [476](#L476) | wp\_send\_json\_success( array( 'user\_id' => $user\_id, 'level\_changed' => $level\_id, 'response' => $response, 'status' => 200 ) ); |
| [477](#L477) | } |
| [478](#L478) | return new WP\_REST\_Response( $response, 200 ); |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Cancel a user's membership level. |
| [483](#L483) | \* @since 2.3 |
| [484](#L484) | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
| [485](#L485) | \*/ |
| [486](#L486) | function pmpro\_rest\_api\_cancel\_membership\_level( $request ) { |
| [487](#L487) | $params = $request->get\_params(); |
| [488](#L488) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [489](#L489) | $level\_id = isset( $params['level\_id'] ) ? intval( $params['level\_id'] ) : null; |
| [490](#L490) | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
| [491](#L491) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [492](#L492) |  |
| [493](#L493) | if ( empty( $user\_id ) ) { |
| [494](#L494) | // see if they sent an email |
| [495](#L495) | if ( ! empty( $email ) ) { |
| [496](#L496) | $user = get\_user\_by( 'email', $email ); |
| [497](#L497) | $user\_id = $user->ID; |
| [498](#L498) | } else { |
| [499](#L499) | if ( 'json' === $response\_type ) { |
| [500](#L500) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | if ( empty( $level\_id ) ) { |
| [508](#L508) | if ( 'json' === $response\_type ) { |
| [509](#L509) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | return new WP\_REST\_Response( 'No membership level ID data.', 400 ); |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | if ( ! function\_exists( 'pmpro\_cancelMembershipLevel' ) ) { |
| [516](#L516) | if ( 'json' === $response\_type ) { |
| [517](#L517) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | if ( ! empty( $user\_id ) ) { |
| [524](#L524) | $response = pmpro\_cancelMembershipLevel( $level\_id, $user\_id, 'inactive' ); |
| [525](#L525) | } else { |
| [526](#L526) | $response = false; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | if ( 'json' === $response\_type ) { |
| [530](#L530) | wp\_send\_json\_success( array( 'email' => $email ) ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | return new WP\_REST\_Response( $response, 200 ); |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | /\*\* |
| [537](#L537) | \* Endpoint to get membership level data |
| [538](#L538) | \* @since 2.3 |
| [539](#L539) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [540](#L540) | \*/ |
| [541](#L541) | function pmpro\_rest\_api\_get\_membership\_level( $request ) { |
| [542](#L542) |  |
| [543](#L543) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [544](#L544) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $params = $request->get\_params(); |
| [548](#L548) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : null; |
| [549](#L549) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : false; |
| [550](#L550) |  |
| [551](#L551) | if ( empty( $id ) ) { |
| [552](#L552) | return new WP\_REST\_Response( 'ID not passed through', 400 ); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | $level = new PMPro\_Membership\_Level( $id ); |
| [556](#L556) |  |
| [557](#L557) | // Hide confirmation message if not an admin or member. |
| [558](#L558) | if ( ! empty( $level->confirmation ) |
| [559](#L559) | && ! pmpro\_hasMembershipLevel( $id ) |
| [560](#L560) | && ! current\_user\_can( 'pmpro\_edit\_members' ) ) { |
| [561](#L561) | $level->confirmation = ''; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | if ( 'json' === $response\_type ) { |
| [565](#L565) | wp\_send\_json\_success( array( 'level' => $level ) ); |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | return new WP\_REST\_Response( $level, 200 ); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Create/Update a Membership Level |
| [573](#L573) | \* @since 2.3 |
| [574](#L574) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [575](#L575) | \*/ |
| [576](#L576) | function pmpro\_rest\_api\_set\_membership\_level( $request ) { |
| [577](#L577) |  |
| [578](#L578) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [579](#L579) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | $params = $request->get\_params(); |
| [583](#L583) | $method = $request->get\_method(); |
| [584](#L584) |  |
| [585](#L585) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
| [586](#L586) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [587](#L587) |  |
| [588](#L588) | // Pass through an ID only for PUT/PATCH methods. POST treats it as a brand new level. |
| [589](#L589) | if ( ! empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
| [590](#L590) | $level = new PMPro\_Membership\_Level( $id ); |
| [591](#L591) | } elseif ( empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
| [592](#L592) | return false; // Error trying to update |
| [593](#L593) | } elseif ( $method === 'POST' ) { |
| [594](#L594) | $level = new PMPro\_Membership\_Level(); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | $name = isset( $params['name'] ) ? sanitize\_text\_field( $params['name'] ) : $level->name; |
| [598](#L598) | $description = isset( $params['description'] ) ? sanitize\_text\_field( $params['description'] ) : $level->description; |
| [599](#L599) | $confirmation = isset( $params['confirmation'] ) ? sanitize\_text\_field( $params['confirmation'] ) : $level->confirmation; |
| [600](#L600) | $initial\_payment = isset( $params['initial\_payment'] ) ? floatval( $params['initial\_payment'] ) : $level->initial\_payment; |
| [601](#L601) | $billing\_amount = isset( $params['billing\_amount'] ) ? floatval( $params['billing\_amount'] ) : $level->billing\_amount; |
| [602](#L602) | $cycle\_number = isset( $params['cycle\_number'] ) ? intval( $params['cycle\_number'] ) : $level->cycle\_number; |
| [603](#L603) | $cycle\_period = isset( $params['cycle\_period'] ) ? pmpro\_sanitize\_period( $params['cycle\_period'] ) : $level->cycle\_period; |
| [604](#L604) | $billing\_limit = isset( $params['billing\_limit'] ) ? sanitize\_text\_field( $params['billing\_limit'] ) : $level->billing\_limit; |
| [605](#L605) | $trial\_amount = isset( $params['trial\_amount'] ) ? floatval( $params['trial\_amount'] ) : $level->trial\_amount; |
| [606](#L606) | $trial\_limit = isset( $params['trial\_limit'] ) ? floatval( $params['trial\_limit'] ) : $level->trial\_limit; |
| [607](#L607) | $allow\_signups = isset( $params['allow\_signups'] ) ? intval( $params['allow\_signups'] ) : $level->allow\_signups; |
| [608](#L608) | $expiration\_number = isset( $params['expiration\_number'] ) ? intval( $params['expiration\_number'] ) : $level->expiration\_number; |
| [609](#L609) | $expiration\_period = isset( $params['expiration\_period'] ) ? intval( $params['expiration\_period'] ) : $level->expiration\_period; |
| [610](#L610) | $categories = isset( $params['categories'] ) ? PMPro\_REST\_API\_Routes::pmpro\_rest\_api\_convert\_to\_array( sanitize\_text\_field( $params['categories'] ) ) : $level->categories; |
| [611](#L611) |  |
| [612](#L612) | // Set Level Object and save it. |
| [613](#L613) | $level->name = $name; |
| [614](#L614) | $level->description = $description; |
| [615](#L615) | $level->confirmation = $confirmation; |
| [616](#L616) | $level->initial\_payment = $initial\_payment; |
| [617](#L617) | $level->billing\_amount = $billing\_amount; |
| [618](#L618) | $level->cycle\_number = $cycle\_number; |
| [619](#L619) | $level->billing\_limit = $billing\_limit; |
| [620](#L620) | $level->trial\_amount = $trial\_amount; |
| [621](#L621) | $level->allow\_signups = $allow\_signups; |
| [622](#L622) | $level->expiration\_number = $expiration\_number; |
| [623](#L623) | $level->expiration\_period = $expiration\_period; |
| [624](#L624) | $level->categories = $categories; |
| [625](#L625) | $level->save(); |
| [626](#L626) |  |
| [627](#L627) | if ( 'json' === $response\_type ) { |
| [628](#L628) | wp\_send\_json\_success( array( "level" => $level ) ); |
| [629](#L629) | } |
| [630](#L630) |  |
| [631](#L631) | return new WP\_REST\_Response( $level, 200 ); |
| [632](#L632) |  |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | /\*\* |
| [636](#L636) | \* Delete membership level and remove users from level. (And cancel their subscription.) |
| [637](#L637) | \* @since 2.3 |
| [638](#L638) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [639](#L639) | \*/ |
| [640](#L640) | function pmpro\_rest\_api\_delete\_membership\_level( $request ) { |
| [641](#L641) |  |
| [642](#L642) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [643](#L643) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | $params = $request->get\_params(); |
| [647](#L647) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
| [648](#L648) |  |
| [649](#L649) | if ( empty( $id ) ) { |
| [650](#L650) | return new WP\_REST\_Response( 'ID not passed through.', 400 ); |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | $level = new PMPro\_Membership\_Level( $id ); |
| [654](#L654) |  |
| [655](#L655) | return new WP\_REST\_Response( $level->delete(), 200 ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* Get all membership levels. |
| [660](#L660) | \* @since 3.0 |
| [661](#L661) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_levels |
| [662](#L662) | \*/ |
| [663](#L663) | function pmpro\_rest\_api\_get\_membership\_levels( $request ) { |
| [664](#L664) |  |
| [665](#L665) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [666](#L666) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | $params = $request->get\_params(); |
| [670](#L670) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [671](#L671) |  |
| [672](#L672) | $levels = pmpro\_getAllLevels( true, true ); |
| [673](#L673) |  |
| [674](#L674) | // Hide confirmation message if not an admin or member. |
| [675](#L675) | if ( ! current\_user\_can( 'manage\_options' ) && ! current\_user\_can( 'pmpro\_membershiplevels' ) ) { |
| [676](#L676) | foreach ( $levels as $level ) { |
| [677](#L677) | if ( ! pmpro\_hasMembershipLevel( $level->id ) ) { |
| [678](#L678) | $level->confirmation = ''; |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | if ( 'json' === $response\_type ) { |
| [684](#L684) | wp\_send\_json\_success( array( "levels" => $levels ) ); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | return new WP\_REST\_Response( $levels, 200 ); |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | /\*\* |
| [691](#L691) | \* Get a discount code |
| [692](#L692) | \* @since 2.3 |
| [693](#L693) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [694](#L694) | \*/ |
| [695](#L695) | function pmpro\_rest\_api\_get\_discount\_code( $request ) { |
| [696](#L696) | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
| [697](#L697) | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | $params = $request->get\_params(); |
| [701](#L701) | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [702](#L702) |  |
| [703](#L703) | if ( empty( $code ) ) { |
| [704](#L704) | return new WP\_REST\_Response( 'No discount code sent.', 400 ); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | return new WP\_REST\_Response( new PMPro\_Discount\_Code( $code ), 200 ); |
| [708](#L708) |  |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | /\*\* |
| [712](#L712) | \* Create/update a discount code. |
| [713](#L713) | \* @since 2.3 |
| [714](#L714) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [715](#L715) | \*/ |
| [716](#L716) | function pmpro\_rest\_api\_set\_discount\_code( $request ) { |
| [717](#L717) |  |
| [718](#L718) | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
| [719](#L719) | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | $params = $request->get\_params(); |
| [723](#L723) | $method = $request->get\_method(); |
| [724](#L724) | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : ''; |
| [725](#L725) | $uses = isset( $params['uses'] ) ? intval( $params['uses'] ) : ''; |
| [726](#L726) | $starts = isset( $params['starts'] ) ? sanitize\_text\_field( $params['starts'] ) : ''; |
| [727](#L727) | $expires = isset( $params['expires'] ) ? sanitize\_text\_field( $params['expires'] ) : ''; |
| [728](#L728) | $levels = isset( $params['levels'] ) ? sanitize\_text\_field( $params['levels'] ) : null; |
| [729](#L729) |  |
| [730](#L730) | if ( ! empty( $levels ) ) { |
| [731](#L731) | $levels = json\_decode( $levels, true ); |
| [732](#L732) |  |
| [733](#L733) | if ( is\_array( $levels ) ) { |
| [734](#L734) | $levels\_array = array(); |
| [735](#L735) | foreach( $levels as $level ){ |
| [736](#L736) | $levels\_array[$level['level']] = array( |
| [737](#L737) | 'initial\_payment' => isset( $level['initial\_payment'] ) ? $level['initial\_payment'] : null, |
| [738](#L738) | 'billing\_amount' => isset( $level['billing\_amount'] ) ? $level['billing\_amount'] : null, |
| [739](#L739) | 'cycle\_number' => isset( $level['cycle\_number'] ) ? $level['cycle\_number'] : null, |
| [740](#L740) | 'cycle\_period' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
| [741](#L741) | 'billing\_limit' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
| [742](#L742) | 'custom\_trial' => isset( $level['custom\_trial'] ) ? $level['custom\_trial'] : null, |
| [743](#L743) | 'trial\_amount' => isset( $level['trial\_amount'] ) ? $level['trial\_amount'] : null, |
| [744](#L744) | 'trial\_limit' => isset( $level['trial\_limit'] ) ? $level['trial\_limit'] : null, |
| [745](#L745) | 'expiration\_number' => isset( $level['expiration\_number'] ) ?  : null, |
| [746](#L746) | 'expiration\_period' => isset( $level['expiration\_period'] ) ?  : null |
| [747](#L747) | ); |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | $discount\_code = new PMPro\_Discount\_Code(); |
| [753](#L753) |  |
| [754](#L754) | // See if code already exists when POSTING. |
| [755](#L755) | if ( $method == 'POST' && ! empty( $code ) ) { |
| [756](#L756) | // See if discount code exists. |
| [757](#L757) | if ( is\_numeric( $code ) ) { |
| [758](#L758) | $discount\_code->get\_discount\_code\_by\_id( $code ); |
| [759](#L759) | } else { |
| [760](#L760) | $discount\_code->get\_discount\_code\_by\_code( $code ); |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | if ( ! empty( $discount\_code->id ) ) { |
| [764](#L764) | return new WP\_REST\_Response( 'Discount code already exists.', 400 ); |
| [765](#L765) | } |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | $discount\_code->code = $code; |
| [769](#L769) | $discount\_code->starts = $starts; |
| [770](#L770) | $discount\_code->expires = $expires; |
| [771](#L771) | $discount\_code->uses = $uses; |
| [772](#L772) | $discount\_code->levels = !empty( $levels\_array ) ? $levels\_array : $levels; |
| [773](#L773) | $discount\_code->save(); |
| [774](#L774) |  |
| [775](#L775) | return new WP\_REST\_Response( $discount\_code, 200 ); |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Get an order. |
| [780](#L780) | \* @since 2.8 |
| [781](#L781) | \* Example: https://example.com/wp-json/pmpro/v1/order |
| [782](#L782) | \*/ |
| [783](#L783) | function pmpro\_rest\_api\_get\_order( $request ) { |
| [784](#L784) | if ( ! class\_exists( 'MemberOrder' ) ) { |
| [785](#L785) | return new WP\_REST\_Response( 'Paid Memberships Pro order class not found.', 404 ); |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | $params = $request->get\_params(); |
| [789](#L789) | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [790](#L790) |  |
| [791](#L791) | if ( empty( $code ) ) { |
| [792](#L792) | return new WP\_REST\_Response( 'No order code sent.', 400 ); |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | // Build the order object to return. |
| [796](#L796) | // Need to do this because the order object now has private properties. |
| [797](#L797) | $order = new MemberOrder( $code ); |
| [798](#L798) | $order\_data\_to\_return = new stdClass(); |
| [799](#L799) | if ( ! empty( $order->id ) ) { |
| [800](#L800) | $order\_data\_to\_return->id = $order->id; |
| [801](#L801) | $order\_data\_to\_return->code = $order->code; |
| [802](#L802) | $order\_data\_to\_return->user\_id = $order->user\_id; |
| [803](#L803) | $order\_data\_to\_return->membership\_id = $order->membership\_id; |
| [804](#L804) | $order\_data\_to\_return->billing = $order->billing; |
| [805](#L805) | $order\_data\_to\_return->subtotal = $order->subtotal; |
| [806](#L806) | $order\_data\_to\_return->tax = $order->tax; |
| [807](#L807) | $order\_data\_to\_return->total = $order->total; |
| [808](#L808) | $order\_data\_to\_return->payment\_type = $order->payment\_type; |
| [809](#L809) | $order\_data\_to\_return->cardtype = $order->cardtype; |
| [810](#L810) | $order\_data\_to\_return->accountnumber = $order->accountnumber; |
| [811](#L811) | $order\_data\_to\_return->expirationmonth = $order->expirationmonth; |
| [812](#L812) | $order\_data\_to\_return->expirationyear = $order->expirationyear; |
| [813](#L813) | $order\_data\_to\_return->status = $order->status; |
| [814](#L814) | $order\_data\_to\_return->gateway = $order->gateway; |
| [815](#L815) | $order\_data\_to\_return->gateway\_environment = $order->gateway\_environment; |
| [816](#L816) | $order\_data\_to\_return->payment\_transaction\_id = $order->payment\_transaction\_id; |
| [817](#L817) | $order\_data\_to\_return->subscription\_transaction\_id = $order->subscription\_transaction\_id; |
| [818](#L818) | $order\_data\_to\_return->timestamp = $order->timestamp; |
| [819](#L819) | $order\_data\_to\_return->affiliate\_id = $order->affiliate\_id; |
| [820](#L820) | $order\_data\_to\_return->affiliate\_subid = $order->affiliate\_subid; |
| [821](#L821) | $order\_data\_to\_return->notes = $order->notes; |
| [822](#L822) | $order\_data\_to\_return->checkout\_id = $order->checkout\_id; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | return new WP\_REST\_Response( $order\_data\_to\_return, 200 ); |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | /\*\* |
| [829](#L829) | \* Make sure that users can GET their own orders. |
| [830](#L830) | \* @since 2.8 |
| [831](#L831) | \*/ |
| [832](#L832) | function pmpro\_rest\_api\_permissions\_get\_order( $permission, $request ) { |
| [833](#L833) | $method = $request->get\_method(); |
| [834](#L834) | $route  = $request->get\_route(); |
| [835](#L835) |  |
| [836](#L836) | // Check if the user does not have access but is trying to get an order. |
| [837](#L837) | if ( ! $permission && 'GET' === $method && '/pmpro/v1/order' === $route ) { |
| [838](#L838) | // Check if the order belongs to the user. |
| [839](#L839) | $params = $request->get\_params(); |
| [840](#L840) | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [841](#L841) |  |
| [842](#L842) | if ( ! empty( $code ) ) { |
| [843](#L843) | $order = new MemberOrder( $code ); |
| [844](#L844) |  |
| [845](#L845) | if ( $order->user\_id == get\_current\_user\_id() ) { |
| [846](#L846) | return true; |
| [847](#L847) | } |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) | return $permission; |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | /\*\* |
| [854](#L854) | \* Get a membership level at checkout. |
| [855](#L855) | \* |
| [856](#L856) | \* @since 2.4 |
| [857](#L857) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
| [858](#L858) | \*/ |
| [859](#L859) | function pmpro\_rest\_api\_get\_checkout\_level( $request ) { |
| [860](#L860) | $params = $request->get\_params(); |
| [861](#L861) |  |
| [862](#L862) | if ( isset( $params['pmpro\_level' ] ) ) { |
| [863](#L863) | $level\_id = intval( $params['pmpro\_level'] ); |
| [864](#L864) | } elseif ( isset( $params['level\_id'] ) ) { |
| [865](#L865) | $level\_id = intval( $params['level\_id'] ); |
| [866](#L866) | } elseif ( isset( $params['level'] ) ) { |
| [867](#L867) | $level\_id = intval( $params['level'] ); |
| [868](#L868) | } |
| [869](#L869) |  |
| [870](#L870) | if ( empty( $level\_id ) ) { |
| [871](#L871) | return new WP\_REST\_Response( 'No level found.', 400 ); |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | if ( isset( $params['pmpro\_discount\_code'] ) ) { |
| [875](#L875) | $discount\_code = sanitize\_text\_field( $params['pmpro\_discount\_code'] ); |
| [876](#L876) | } elseif ( isset( $params['discount\_code'] ) ) { |
| [877](#L877) | $discount\_code = sanitize\_text\_field( $params['discount\_code'] ); |
| [878](#L878) | } else { |
| [879](#L879) | $discount\_code = null; |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | $checkout\_level = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
| [883](#L883) |  |
| [884](#L884) | if ( ! empty( $checkout\_level ) ) { |
| [885](#L885) | // Hide confirmation message if not an admin or member. |
| [886](#L886) | if ( ! empty( $checkout\_level->confirmation ) |
| [887](#L887) | && ! pmpro\_hasMembershipLevel( $level\_id ) |
| [888](#L888) | && ! current\_user\_can( 'pmpro\_edit\_members' ) ) { |
| [889](#L889) | $checkout\_level->confirmation = ''; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | // Also add a formatted version of the initial payment. |
| [893](#L893) | $checkout\_level->initial\_payment\_formatted = pmpro\_formatPrice( $checkout\_level->initial\_payment ); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | return new WP\_REST\_Response( $checkout\_level ); |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Get membership levels at checkout. |
| [901](#L901) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
| [902](#L902) | \* |
| [903](#L903) | \* @deprecated 3.0 Use the /pmpro/v1/checkout\_level endpoint instead. |
| [904](#L904) | \*/ |
| [905](#L905) | function pmpro\_rest\_api\_get\_checkout\_levels( $request ) { |
| [906](#L906) | $params = $request->get\_params(); |
| [907](#L907) |  |
| [908](#L908) | global $pmpro\_checkout\_level\_ids; |
| [909](#L909) | if ( ! empty( $pmpro\_checkout\_level\_ids ) ) { |
| [910](#L910) | // MMPU Compatibility... |
| [911](#L911) | $level\_ids = $pmpro\_checkout\_level\_ids; |
| [912](#L912) | } elseif ( isset( $params['pmpro\_level' ] ) ) { |
| [913](#L913) | $level\_ids = explode( '+', intval( $params['pmpro\_level'] ) ); |
| [914](#L914) | }elseif ( isset( $params['level\_id'] ) ) { |
| [915](#L915) | $level\_ids = explode( '+', intval( $params['level\_id'] ) ); |
| [916](#L916) | } elseif ( isset( $params['level'] ) ) { |
| [917](#L917) | $level\_ids = explode( '+', intval( $params['level'] ) ); |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | if ( empty( $level\_ids ) ) { |
| [921](#L921) | return new WP\_REST\_Response( 'No levels found.', 400 ); |
| [922](#L922) | } |
| [923](#L923) | $discount\_code = isset( $params['discount\_code'] ) ? sanitize\_text\_field( $params['discount\_code'] ) : null; |
| [924](#L924) |  |
| [925](#L925) | $r = array(); |
| [926](#L926) | $r['initial\_payment'] = 0.00; |
| [927](#L927) | foreach ( $level\_ids as $level\_id ) { |
| [928](#L928) | $r[ $level\_id ] = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
| [929](#L929) |  |
| [930](#L930) | // Increment the total initial\_paymnent. |
| [931](#L931) | if ( ! empty( $r[ $level\_id ]->initial\_payment ) ) { |
| [932](#L932) | $r['initial\_payment'] += floatval( $r[ $level\_id ]->initial\_payment ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | // Hide confirmation message if not an admin or member. |
| [936](#L936) | if ( ! empty( $r[ $level\_id ]->confirmation ) |
| [937](#L937) | && ! pmpro\_hasMembershipLevel( $level\_id ) |
| [938](#L938) | && ! current\_user\_can( 'pmpro\_membershiplevels' ) ) { |
| [939](#L939) | $r[ $level\_id ]->confirmation = ''; |
| [940](#L940) | } |
| [941](#L941) | } |
| [942](#L942) | $r['initial\_payment\_formatted'] = pmpro\_formatPrice( $r['initial\_payment'] ); |
| [943](#L943) | return new WP\_REST\_Response( $r ); |
| [944](#L944) | } |
| [945](#L945) |  |
| [946](#L946) |  |
| [947](#L947) | /// ZAPIER TRIGGERS |
| [948](#L948) | /\*\* |
| [949](#L949) | \* Handle authentication testing for the Zapier API. |
| [950](#L950) | \* |
| [951](#L951) | \* @since 2.6.0 |
| [952](#L952) | \* |
| [953](#L953) | \* @param WP\_REST\_Request $request The REST request. |
| [954](#L954) | \*/ |
| [955](#L955) | public function validate\_me( $request ) { |
| [956](#L956) |  |
| [957](#L957) | $params = $request->get\_params(); |
| [958](#L958) |  |
| [959](#L959) | if ( is\_user\_logged\_in() ) { |
| [960](#L960) | $me = wp\_get\_current\_user()->display\_name; |
| [961](#L961) | } else { |
| [962](#L962) | $me = false; |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | wp\_send\_json\_success( array( 'username' => $me ) ); |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | /\*\* |
| [969](#L969) | \* Handle requests for the list of recent memberships. |
| [970](#L970) | \* |
| [971](#L971) | \* @since 2.6.0 |
| [972](#L972) | \* |
| [973](#L973) | \* @param WP\_REST\_Request $request The REST request. |
| [974](#L974) | \* |
| [975](#L975) | \* @return WP\_REST\_Response The REST response. |
| [976](#L976) | \*/ |
| [977](#L977) | public function pmpro\_rest\_api\_recent\_memberships( $request ) { |
| [978](#L978) | $params = $request->get\_params(); |
| [979](#L979) | if ( isset($params['limit']) ) { |
| [980](#L980) | $limit = intval( $params['limit'] ); |
| [981](#L981) | } else { |
| [982](#L982) | $limit = 1; |
| [983](#L983) | } |
| [984](#L984) | /\*\* |
| [985](#L985) | \* Allow filtering the total number of recent members to show in the /recent\_memberships PMPro endpoint. |
| [986](#L986) | \* |
| [987](#L987) | \* @param int $limit The total number of recent members to show. |
| [988](#L988) | \*/ |
| [989](#L989) | $limit = apply\_filters( 'pmpro\_trigger\_recent\_members\_limit', $limit ); |
| [990](#L990) |  |
| [991](#L991) | if ( empty( $params['level\_status'] ) ) { |
| [992](#L992) | $level\_status = [ 'active' ]; |
| [993](#L993) | } else { |
| [994](#L994) | $level\_status = sanitize\_text\_field( trim( $params['level\_status'] ) ); |
| [995](#L995) |  |
| [996](#L996) | // Force it into an array so we can implode it in the query itself. |
| [997](#L997) | $level\_status = explode( ',', $level\_status ); |
| [998](#L998) | } |
| [999](#L999) |  |
| [1000](#L1000) | // Set up values to prepare. |
| [1001](#L1001) | $prepare   = $level\_status; |
| [1002](#L1002) | $prepare[] = $limit; |
| [1003](#L1003) |  |
| [1004](#L1004) | // Set up the placeholders we want to use. |
| [1005](#L1005) | $level\_status\_placeholders = implode( ', ', array\_fill( 0, count( $level\_status ), '%s' ) ); |
| [1006](#L1006) |  |
| [1007](#L1007) | // Grab the useful information. |
| [1008](#L1008) | global $wpdb; |
| [1009](#L1009) |  |
| [1010](#L1010) | $sql = " |
| [1011](#L1011) | SELECT |
| [1012](#L1012) | `mu`.`user\_id` as `id`, |
| [1013](#L1013) | `u`.`user\_email`, |
| [1014](#L1014) | `u`.`user\_nicename`, |
| [1015](#L1015) | `mu`.`membership\_id`, |
| [1016](#L1016) | `ml`.`name` as membership\_name, |
| [1017](#L1017) | `mu`.`status`, |
| [1018](#L1018) | `mu`.`modified` |
| [1019](#L1019) | FROM `{$wpdb->pmpro\_memberships\_users}` AS `mu` |
| [1020](#L1020) | LEFT JOIN `{$wpdb->users}` AS `u` |
| [1021](#L1021) | ON `mu`.`user\_id` = `u`.`id` |
| [1022](#L1022) | LEFT JOIN `{$wpdb->pmpro\_membership\_levels}` AS `ml` |
| [1023](#L1023) | ON `ml`.`id` = `mu`.`membership\_id` |
| [1024](#L1024) | WHERE |
| [1025](#L1025) | `mu`.`status` IN ( {$level\_status\_placeholders} ) |
| [1026](#L1026) | ORDER BY |
| [1027](#L1027) | `mu`.`modified` DESC |
| [1028](#L1028) | LIMIT %d |
| [1029](#L1029) | "; |
| [1030](#L1030) |  |
| [1031](#L1031) | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $prepare ) ); |
| [1032](#L1032) |  |
| [1033](#L1033) | // Let's format the date to ISO8601 |
| [1034](#L1034) | $results[0]->modified = pmpro\_format\_date\_iso8601( $results[0]->modified ); |
| [1035](#L1035) |  |
| [1036](#L1036) | return new WP\_REST\_Response( $results, 200 ); |
| [1037](#L1037) |  |
| [1038](#L1038) | } |
| [1039](#L1039) |  |
| [1040](#L1040) | /\*\* |
| [1041](#L1041) | \* Handle requests for the list of recent orders. |
| [1042](#L1042) | \* |
| [1043](#L1043) | \* @since 2.6.0 |
| [1044](#L1044) | \* |
| [1045](#L1045) | \* @param WP\_REST\_Request $request The REST request. |
| [1046](#L1046) | \* |
| [1047](#L1047) | \* @return WP\_REST\_Response The REST response. |
| [1048](#L1048) | \*/ |
| [1049](#L1049) | public function pmpro\_rest\_api\_recent\_orders( $request ) { |
| [1050](#L1050) | $params = $request->get\_params(); |
| [1051](#L1051) |  |
| [1052](#L1052) | if ( isset($params['limit']) ) { |
| [1053](#L1053) | $orders\_limit = intval( $params['limit'] ); |
| [1054](#L1054) | } else { |
| [1055](#L1055) | $orders\_limit = 1; |
| [1056](#L1056) | } |
| [1057](#L1057) |  |
| [1058](#L1058) | $limit = apply\_filters( 'pmpro\_trigger\_recent\_orders\_limit', $orders\_limit ); |
| [1059](#L1059) |  |
| [1060](#L1060) | global $wpdb; |
| [1061](#L1061) |  |
| [1062](#L1062) | $sql = " |
| [1063](#L1063) | SELECT |
| [1064](#L1064) | `o`.`id`, |
| [1065](#L1065) | `o`.`code`, |
| [1066](#L1066) | `u`.`ID` AS `user\_id`, |
| [1067](#L1067) | `u`.`user\_email`, |
| [1068](#L1068) | `u`.`user\_nicename`, |
| [1069](#L1069) | `o`.`membership\_id`, |
| [1070](#L1070) | `o`.`billing\_name`, |
| [1071](#L1071) | `o`.`billing\_street`, |
| [1072](#L1072) | `o`.`billing\_city`, |
| [1073](#L1073) | `o`.`billing\_state`, |
| [1074](#L1074) | `o`.`billing\_zip`, |
| [1075](#L1075) | `o`.`billing\_country`, |
| [1076](#L1076) | `o`.`billing\_phone`, |
| [1077](#L1077) | `o`.`subtotal`, |
| [1078](#L1078) | `o`.`tax`, |
| [1079](#L1079) | `o`.`total`, |
| [1080](#L1080) | `o`.`status`, |
| [1081](#L1081) | `o`.`gateway`, |
| [1082](#L1082) | `o`.`gateway\_environment`, |
| [1083](#L1083) | `o`.`timestamp` |
| [1084](#L1084) | FROM `{$wpdb->pmpro\_membership\_orders}` AS `o` |
| [1085](#L1085) | LEFT JOIN `{$wpdb->users}` AS `u` |
| [1086](#L1086) | ON `o`.`user\_id` = `u`.`ID` |
| [1087](#L1087) | ORDER BY |
| [1088](#L1088) | `o`.`timestamp` DESC |
| [1089](#L1089) | LIMIT %d |
| [1090](#L1090) | "; |
| [1091](#L1091) |  |
| [1092](#L1092) | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $limit ) ); |
| [1093](#L1093) |  |
| [1094](#L1094) | $results[0]->timestamp = pmpro\_format\_date\_iso8601( $results[0]->timestamp ); |
| [1095](#L1095) |  |
| [1096](#L1096) | return new WP\_REST\_Response( $results, 200 ); |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | /\*\* |
| [1100](#L1100) | \* Get the membership level IDs restricting a given post. |
| [1101](#L1101) | \* |
| [1102](#L1102) | \* @since 3.0 |
| [1103](#L1103) | \* |
| [1104](#L1104) | \* @param WP\_REST\_Request $request The REST request. |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @return WP\_REST\_Response The REST response. |
| [1107](#L1107) | \*/ |
| [1108](#L1108) | public function pmpro\_rest\_api\_get\_post\_restrictions( $request ) { |
| [1109](#L1109) | global $wpdb; |
| [1110](#L1110) |  |
| [1111](#L1111) | $params = $request->get\_params(); |
| [1112](#L1112) |  |
| [1113](#L1113) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [1114](#L1114) |  |
| [1115](#L1115) | if ( empty( $post\_id ) ) { |
| [1116](#L1116) | return new WP\_REST\_Response( array( 'error' => 'No post ID provided.' ), 400 ); |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | $level\_ids = $wpdb->get\_results( $wpdb->prepare( "SELECT `membership\_id` FROM `{$wpdb->pmpro\_memberships\_pages}` WHERE `page\_id` = %d", $post\_id ) ); |
| [1120](#L1120) |  |
| [1121](#L1121) | return new WP\_REST\_Response( $level\_ids, 200 ); |
| [1122](#L1122) | } |
| [1123](#L1123) |  |
| [1124](#L1124) | /\*\* |
| [1125](#L1125) | \* Set the membership level IDs restricting a given post. |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @since 3.0 |
| [1128](#L1128) | \* |
| [1129](#L1129) | \* @param WP\_REST\_Request $request The REST request. |
| [1130](#L1130) | \* @return WP\_REST\_Response The REST response. |
| [1131](#L1131) | \*/ |
| [1132](#L1132) | public function pmpro\_rest\_api\_set\_post\_restrictions( $request ) { |
| [1133](#L1133) | global $wpdb; |
| [1134](#L1134) |  |
| [1135](#L1135) | $params = $request->get\_params(); |
| [1136](#L1136) |  |
| [1137](#L1137) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [1138](#L1138) | $level\_ids = isset( $params['level\_ids'] ) ? array\_map( 'intval', $params['level\_ids'] ) : null; |
| [1139](#L1139) |  |
| [1140](#L1140) | if ( empty( $post\_id ) ) { |
| [1141](#L1141) | return new WP\_REST\_Response( array( 'error' => 'No post ID provided.' ), 400 ); |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | if ( ! is\_array( $level\_ids ) ) { |
| [1145](#L1145) | return new WP\_REST\_Response( array( 'error' => 'No level IDs provided.' ), 400 ); |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | // Delete existing restrictions. |
| [1149](#L1149) | $wpdb->query( "DELETE FROM {$wpdb->pmpro\_memberships\_pages} WHERE page\_id = '" . intval( $post\_id ) . "'" ); |
| [1150](#L1150) |  |
| [1151](#L1151) | // Add new restrictions. |
| [1152](#L1152) | foreach ( $level\_ids as $level\_id ) { |
| [1153](#L1153) | $wpdb->query( "INSERT INTO {$wpdb->pmpro\_memberships\_pages} (membership\_id, page\_id) VALUES('" . intval( $level\_id ) . "', '" . intval( $post\_id ) . "')" ); |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | return new WP\_REST\_Response( array( 'success' => $level\_ids ), 200 ); |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) | /\*\* |
| [1160](#L1160) | \* Default permissions check for endpoints/routes. |
| [1161](#L1161) | \* Defaults to 'subscriber' for all GET requests and |
| [1162](#L1162) | \* 'administrator' for any other type of request. |
| [1163](#L1163) | \* |
| [1164](#L1164) | \* @since 2.3 |
| [1165](#L1165) | \* @since 2.12.6 Now allowing arrays in $route\_caps so you can have a different permission per HTTP method. |
| [1166](#L1166) | \*/ |
| [1167](#L1167) | function pmpro\_rest\_api\_get\_permissions\_check( $request ) { |
| [1168](#L1168) |  |
| [1169](#L1169) | $method = $request->get\_method(); |
| [1170](#L1170) | $route = $request->get\_route(); |
| [1171](#L1171) |  |
| [1172](#L1172) | // Default to requiring pmpro\_edit\_members capability. |
| [1173](#L1173) | // NOTE: This basically means that anyone with the pmpro\_edit\_members capability could potentially do anything made available through the API in this file. |
| [1174](#L1174) | $permission = current\_user\_can( 'pmpro\_edit\_members' ); |
| [1175](#L1175) |  |
| [1176](#L1176) | // Check other caps for some routes. |
| [1177](#L1177) | $route\_caps = array( |
| [1178](#L1178) | '/pmpro/v1/has\_membership\_access' => 'pmpro\_edit\_members', |
| [1179](#L1179) | '/pmpro/v1/get\_membership\_level\_for\_user' => 'pmpro\_edit\_members', |
| [1180](#L1180) | '/pmpro/v1/get\_membership\_levels\_for\_user' => 'pmpro\_edit\_members', |
| [1181](#L1181) | '/pmpro/v1/change\_membership\_level' => 'pmpro\_edit\_members', |
| [1182](#L1182) | '/pmpro/v1/cancel\_membership\_level' => 'pmpro\_edit\_members', |
| [1183](#L1183) | '/pmpro/v1/membership\_level' => array( |
| [1184](#L1184) | 'GET' => true, |
| [1185](#L1185) | 'POST' => 'pmpro\_membershiplevels', |
| [1186](#L1186) | 'PUT' => 'pmpro\_membershiplevels', |
| [1187](#L1187) | 'PATCH' => 'pmpro\_membershiplevels', |
| [1188](#L1188) | 'DELETE' => 'pmpro\_membershiplevels', |
| [1189](#L1189) | ), |
| [1190](#L1190) | '/pmpro/v1/membership\_levels' => true, |
| [1191](#L1191) | '/pmpro/v1/discount\_code' => 'pmpro\_discountcodes', |
| [1192](#L1192) | '/pmpro/v1/order' => 'pmpro\_orders', |
| [1193](#L1193) | '/pmpro/v1/checkout\_level' => true, |
| [1194](#L1194) | '/pmpro/v1/checkout\_levels' => true, |
| [1195](#L1195) | '/pmpro/v1/me' => true, |
| [1196](#L1196) | '/pmpro/v1/recent\_memberships' => 'pmpro\_edit\_members', |
| [1197](#L1197) | '/pmpro/v1/recent\_orders' => 'pmpro\_orders', |
| [1198](#L1198) | '/pmpro/v1/post\_restrictions' => 'pmpro\_edit\_members', |
| [1199](#L1199) | ); |
| [1200](#L1200) | $route\_caps = apply\_filters( 'pmpro\_rest\_api\_route\_capabilities', $route\_caps, $request ); |
| [1201](#L1201) |  |
| [1202](#L1202) | // Check if we have a specific permission to check for this route/method. |
| [1203](#L1203) | if ( isset( $route\_caps[$route] ) ) { |
| [1204](#L1204) | // Find the permission to check. |
| [1205](#L1205) | if ( is\_array ( $route\_caps[$route] ) && isset( $route\_caps[$route][$method] ) ) { |
| [1206](#L1206) | // Different permission for this method, use it. |
| [1207](#L1207) | $permission\_to\_check = $route\_caps[$route][$method]; |
| [1208](#L1208) | } elseif ( is\_array( $route\_caps[$route] ) ) { |
| [1209](#L1209) | // No permission for this method, default to false. |
| [1210](#L1210) | $permission\_to\_check = false; |
| [1211](#L1211) | } else { |
| [1212](#L1212) | // Same permission for all methods, use it. |
| [1213](#L1213) | $permission\_to\_check = $route\_caps[$route]; |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | // Check the permission. |
| [1217](#L1217) | if ( $permission\_to\_check === true || $permission\_to\_check === false ) { |
| [1218](#L1218) | // For true or false, just pass it along. |
| [1219](#L1219) | $permission = $permission\_to\_check; |
| [1220](#L1220) | } else { |
| [1221](#L1221) | // Check if the current user has this capability. |
| [1222](#L1222) | $permission = current\_user\_can( $permission ); |
| [1223](#L1223) | } |
| [1224](#L1224) | } |
| [1225](#L1225) |  |
| [1226](#L1226) | // Is the request method allowed? We disable DELETE by default. |
| [1227](#L1227) | if ( ! in\_array( $method, pmpro\_get\_rest\_api\_methods( $route ) ) ) { |
| [1228](#L1228) | $permission = false; |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | $permission = apply\_filters( 'pmpro\_rest\_api\_permissions', $permission, $request ); |
| [1232](#L1232) | return $permission; |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | /\*\* |
| [1236](#L1236) | \*      Helper function to convert comma separated items to an array. |
| [1237](#L1237) | \* @since 2.3 |
| [1238](#L1238) | \*/ |
| [1239](#L1239) | function pmpro\_rest\_api\_convert\_to\_array( $string ) { |
| [1240](#L1240) | return explode( ',', $string ); |
| [1241](#L1241) | } |
| [1242](#L1242) | } // End of class |
| [1243](#L1243) |  |
| [1244](#L1244) | /\*\* |
| [1245](#L1245) | \* Register the routes for Paid Memberships Pro. |
| [1246](#L1246) | \* @since 2.3 |
| [1247](#L1247) | \*/ |
| [1248](#L1248) | function pmpro\_rest\_api\_register\_custom\_routes() { |
| [1249](#L1249) | $pmpro\_rest\_api\_routes = new PMPro\_REST\_API\_Routes; |
| [1250](#L1250) | $pmpro\_rest\_api\_routes->pmpro\_rest\_api\_register\_routes(); |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | add\_action( 'rest\_api\_init', 'pmpro\_rest\_api\_register\_custom\_routes', 5 ); |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) |  |
| [1257](#L1257) | /\*\* |
| [1258](#L1258) | \* Get the allowed methods for PMPro REST API endpoints. |
| [1259](#L1259) | \* To enable DELETE, hook into this filter. |
| [1260](#L1260) | \* @since 2.3 |
| [1261](#L1261) | \*/ |
| [1262](#L1262) | function pmpro\_get\_rest\_api\_methods( $route = NULL ) { |
| [1263](#L1263) | $methods = array( 'GET', 'POST', 'PUT', 'PATCH' ); |
| [1264](#L1264) | $methods = apply\_filters( 'pmpro\_rest\_api\_methods', $methods, $route ); |
| [1265](#L1265) | return $methods; |
| [1266](#L1266) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/paid-memberships-pro/trunk/includes/rest-api.php?format=txt)
* [Original Format](/export/3222692/paid-memberships-pro/trunk/includes/rest-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_860aaafb_20250115_084857.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=3058329 "Revision 3058329")
* Next Revision →
* [Blame](/browser/paid-memberships-pro/trunk/includes/rest-api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/paid-memberships-pro/trunk/includes/rest-api.php)

---

# [source:](/browser?order=name "Go to repository root") [paid-memberships-pro](/browser/paid-memberships-pro?order=name "View paid-memberships-pro")/[trunk](/browser/paid-memberships-pro/trunk?order=name "View trunk")/[includes](/browser/paid-memberships-pro/trunk/includes?order=name "View includes")/[rest-api.php](/browser/paid-memberships-pro/trunk/includes/rest-api.php?order=name "View rest-api.php")

View diff against:

View revision:

| [Last change](/changeset/3069136/paid-memberships-pro/trunk/includes/rest-api.php "View differences") on this file was [3069136](/changeset/3069136/ "View changeset 3069136"), checked in by dlparker1005, [9 months ago](/timeline?from=2024-04-11T16%3A21%3A05Z&precision=second "See timeline at 04/11/2024 04:21:05 PM") |
| --- |
| 3.0.2 - disable custom page templates, bug fixes |
| **File size:** 43.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | if ( class\_exists( 'WP\_REST\_Controller' ) ) { |
| [4](#L4) | class PMPro\_REST\_API\_Routes extends WP\_REST\_Controller { |
| [5](#L5) |  |
| [6](#L6) | public function pmpro\_rest\_api\_register\_routes() { |
| [7](#L7) |  |
| [8](#L8) | // ================ DEPRECATED ================ // |
| [9](#L9) | $namespace = 'wp/v2'; |
| [10](#L10) | register\_rest\_route( $namespace, '/users/(?P<id>\d+)'.'/pmpro\_membership\_level' , |
| [11](#L11) | array( |
| [12](#L12) | array( |
| [13](#L13) | 'methods'         => WP\_REST\_Server::READABLE, |
| [14](#L14) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
| [15](#L15) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [16](#L16) | ),)); |
| [17](#L17) |  |
| [18](#L18) | register\_rest\_route( $namespace, '/posts/(?P<post\_id>\d+)'.'/user\_id/(?P<user\_id>\d+)/pmpro\_has\_membership\_access' , |
| [19](#L19) | array( |
| [20](#L20) | array( |
| [21](#L21) | 'methods'         => WP\_REST\_Server::READABLE, |
| [22](#L22) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access' ), |
| [23](#L23) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [24](#L24) | ),)); |
| [25](#L25) | // ================================================  // |
| [26](#L26) |  |
| [27](#L27) | $pmpro\_namespace = 'pmpro/v1'; |
| [28](#L28) |  |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Get user access for a specific post. |
| [31](#L31) | \* @since 2.3 |
| [32](#L32) | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access |
| [33](#L33) | \*/ |
| [34](#L34) | register\_rest\_route( $pmpro\_namespace, '/has\_membership\_access', |
| [35](#L35) | array( |
| [36](#L36) | array( |
| [37](#L37) | 'methods'  => WP\_REST\_Server::READABLE, |
| [38](#L38) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access'), |
| [39](#L39) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [40](#L40) | ))); |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* Get a membership level for a user. |
| [44](#L44) | \* @since 2.3 |
| [45](#L45) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user |
| [46](#L46) | \*/ |
| [47](#L47) | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_level\_for\_user', |
| [48](#L48) | array( |
| [49](#L49) | array( |
| [50](#L50) | 'methods'         => WP\_REST\_Server::READABLE, |
| [51](#L51) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
| [52](#L52) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [53](#L53) | ),)); |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Get a membership level for a user. |
| [57](#L57) | \* @since 2.3 |
| [58](#L58) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user |
| [59](#L59) | \*/ |
| [60](#L60) | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_levels\_for\_user', |
| [61](#L61) | array( |
| [62](#L62) | array( |
| [63](#L63) | 'methods'         => WP\_REST\_Server::READABLE, |
| [64](#L64) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_levels\_for\_user' ), |
| [65](#L65) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [66](#L66) | ),)); |
| [67](#L67) |  |
| [68](#L68) |  |
| [69](#L69) | /\*\* |
| [70](#L70) | \* Change a user's membership level. This also supports to cancel a membership if you pass through 0. |
| [71](#L71) | \* @since 2.3 |
| [72](#L72) | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
| [73](#L73) | \*/ |
| [74](#L74) | register\_rest\_route( $pmpro\_namespace, '/change\_membership\_level', |
| [75](#L75) | array( |
| [76](#L76) | array( |
| [77](#L77) | 'methods'       => 'POST,PUT,PATCH', |
| [78](#L78) | 'callback'      => array( $this, 'pmpro\_rest\_api\_change\_membership\_level' ), |
| [79](#L79) | 'args'  => array( |
| [80](#L80) | 'user\_id' => array(), |
| [81](#L81) | 'level\_id' => array(), |
| [82](#L82) | 'email' => array(), |
| [83](#L83) | 'first\_name' => array(), |
| [84](#L84) | 'last\_name' => array(), |
| [85](#L85) | 'user\_url' => array(), |
| [86](#L86) | 'user\_login' => array(), |
| [87](#L87) | 'description' => array(), |
| [88](#L88) | 'create\_user' => array(), |
| [89](#L89) | ), |
| [90](#L90) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [91](#L91) | ) |
| [92](#L92) | ) |
| [93](#L93) | ); |
| [94](#L94) |  |
| [95](#L95) | /\*\* |
| [96](#L96) | \* Cancel a membership level. |
| [97](#L97) | \* @since 2.3 |
| [98](#L98) | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
| [99](#L99) | \*/ |
| [100](#L100) | register\_rest\_route( $pmpro\_namespace, '/cancel\_membership\_level', |
| [101](#L101) | array( |
| [102](#L102) | array( |
| [103](#L103) | 'methods'       => 'POST,PUT,PATCH', |
| [104](#L104) | 'callback'      => array( $this, 'pmpro\_rest\_api\_cancel\_membership\_level' ), |
| [105](#L105) | 'args'  => array( |
| [106](#L106) | 'user\_id' => array(), |
| [107](#L107) | 'level\_id' => array() |
| [108](#L108) | ), |
| [109](#L109) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [110](#L110) | ) |
| [111](#L111) | ) |
| [112](#L112) | ); |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Delete/Retrieve/Update/Create a Membership Level. |
| [116](#L116) | \* @since 2.3 |
| [117](#L117) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level |
| [118](#L118) | \*/ |
| [119](#L119) | register\_rest\_route( $pmpro\_namespace, '/membership\_level' , |
| [120](#L120) | array( |
| [121](#L121) | array( |
| [122](#L122) | 'methods'         => WP\_REST\_Server::READABLE, |
| [123](#L123) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level' ), |
| [124](#L124) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [125](#L125) | ), |
| [126](#L126) | array( |
| [127](#L127) | 'methods'         => 'POST,PUT,PATCH', |
| [128](#L128) | 'callback'        => array( $this, 'pmpro\_rest\_api\_set\_membership\_level' ), |
| [129](#L129) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [130](#L130) | ), |
| [131](#L131) | array( |
| [132](#L132) | 'methods'               => 'DELETE', |
| [133](#L133) | 'callback'        => array( $this, 'pmpro\_rest\_api\_delete\_membership\_level' ), |
| [134](#L134) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [135](#L135) | ) |
| [136](#L136) | )); |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* Get all membership levels. |
| [140](#L140) | \* @since 3.0 |
| [141](#L141) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_levels |
| [142](#L142) | \*/ |
| [143](#L143) | register\_rest\_route( $pmpro\_namespace, '/membership\_levels', |
| [144](#L144) | array( |
| [145](#L145) | array( |
| [146](#L146) | 'methods'         => WP\_REST\_Server::READABLE, |
| [147](#L147) | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_levels' ), |
| [148](#L148) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [149](#L149) | ), |
| [150](#L150) | ) |
| [151](#L151) | ); |
| [152](#L152) |  |
| [153](#L153) | /\*\* |
| [154](#L154) | \* Create/Retrieve discount code. |
| [155](#L155) | \* @since 2.3 |
| [156](#L156) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [157](#L157) | \*/ |
| [158](#L158) | register\_rest\_route( $pmpro\_namespace, '/discount\_code', |
| [159](#L159) | array( |
| [160](#L160) | array( |
| [161](#L161) | 'methods' => WP\_REST\_Server::READABLE, |
| [162](#L162) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_discount\_code' ), |
| [163](#L163) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [164](#L164) | ), |
| [165](#L165) | array( |
| [166](#L166) | 'methods' => 'POST,PUT,PATCH', |
| [167](#L167) | 'callback' => array( $this, 'pmpro\_rest\_api\_set\_discount\_code' ), |
| [168](#L168) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [169](#L169) | ), |
| [170](#L170) | )); |
| [171](#L171) |  |
| [172](#L172) | /\*\* |
| [173](#L173) | \* Retrieve an order. |
| [174](#L174) | \* @since 2.8 |
| [175](#L175) | \* Example: https://example.com/wp-json/pmpro/v1/order |
| [176](#L176) | \*/ |
| [177](#L177) | register\_rest\_route( $pmpro\_namespace, '/order', |
| [178](#L178) | array( |
| [179](#L179) | array( |
| [180](#L180) | 'methods' => WP\_REST\_Server::READABLE, |
| [181](#L181) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_order' ), |
| [182](#L182) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [183](#L183) | ), |
| [184](#L184) | )); |
| [185](#L185) | add\_filter( 'pmpro\_rest\_api\_permissions', array( $this, 'pmpro\_rest\_api\_permissions\_get\_order' ), 10, 2 ); |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* Get membership level after checkout options are applied. |
| [189](#L189) | \* @since 2.4 |
| [190](#L190) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
| [191](#L191) | \*/ |
| [192](#L192) | register\_rest\_route( $pmpro\_namespace, '/checkout\_level', |
| [193](#L193) | array( |
| [194](#L194) | array( |
| [195](#L195) | 'methods' => WP\_REST\_Server::READABLE, |
| [196](#L196) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_level' ), |
| [197](#L197) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [198](#L198) | ), |
| [199](#L199) | )); |
| [200](#L200) |  |
| [201](#L201) | /\*\* |
| [202](#L202) | \* Get membership levels after checkout options are applied. |
| [203](#L203) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
| [204](#L204) | \* @deprecated 3.0 |
| [205](#L205) | \*/ |
| [206](#L206) | register\_rest\_route( $pmpro\_namespace, '/checkout\_levels', |
| [207](#L207) | array( |
| [208](#L208) | array( |
| [209](#L209) | 'methods' => WP\_REST\_Server::READABLE, |
| [210](#L210) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_levels' ), |
| [211](#L211) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [212](#L212) | ), |
| [213](#L213) | )); |
| [214](#L214) |  |
| [215](#L215) | /\*\* |
| [216](#L216) | \* Authentication route for Zapier integration. |
| [217](#L217) | \* |
| [218](#L218) | \* Used to do authentication when connecting Zapier to PMPro. |
| [219](#L219) | \* |
| [220](#L220) | \* @since 2.6.0 |
| [221](#L221) | \*/ |
| [222](#L222) | register\_rest\_route( $pmpro\_namespace, '/me', |
| [223](#L223) | array( |
| [224](#L224) | array( |
| [225](#L225) | 'methods' => WP\_REST\_Server::READABLE, |
| [226](#L226) | 'callback' => array( $this, 'validate\_me' ), |
| [227](#L227) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
| [228](#L228) | ), |
| [229](#L229) | ) |
| [230](#L230) | ); |
| [231](#L231) |  |
| [232](#L232) | /\*\* |
| [233](#L233) | \* Get the last couple of membership levels/members. |
| [234](#L234) | \* |
| [235](#L235) | \* @since 2.6.0 |
| [236](#L236) | \*/ |
| [237](#L237) | register\_rest\_route( $pmpro\_namespace, '/recent\_memberships', |
| [238](#L238) | array( |
| [239](#L239) | array( |
| [240](#L240) | 'methods'  => WP\_REST\_Server::READABLE, |
| [241](#L241) | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_memberships' ), |
| [242](#L242) | 'args'  => array( |
| [243](#L243) | 'status' => array(), |
| [244](#L244) | ), |
| [245](#L245) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [246](#L246) | ) |
| [247](#L247) | )); |
| [248](#L248) |  |
| [249](#L249) | register\_rest\_route( $pmpro\_namespace, '/recent\_orders', |
| [250](#L250) | array( |
| [251](#L251) | array( |
| [252](#L252) | 'methods'  => WP\_REST\_Server::READABLE, |
| [253](#L253) | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_orders' ), |
| [254](#L254) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [255](#L255) | ) |
| [256](#L256) | ) |
| [257](#L257) | ); |
| [258](#L258) |  |
| [259](#L259) | /\*\* |
| [260](#L260) | \* Get the IDs that a post has been restricted to. |
| [261](#L261) | \* @since 3.0 |
| [262](#L262) | \* Example: https://example.com/wp-json/pmpro/v1/post\_restrictions |
| [263](#L263) | \*/ |
| [264](#L264) | register\_rest\_route( $pmpro\_namespace, '/post\_restrictions', |
| [265](#L265) | array( |
| [266](#L266) | array( |
| [267](#L267) | 'methods'  => WP\_REST\_Server::READABLE, |
| [268](#L268) | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_post\_restrictions' ), |
| [269](#L269) | 'args'     => array( |
| [270](#L270) | 'post\_id' => array(), |
| [271](#L271) | ), |
| [272](#L272) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [273](#L273) | ), |
| [274](#L274) | array( |
| [275](#L275) | 'methods'  => WP\_REST\_Server::EDITABLE, |
| [276](#L276) | 'args'     => array( |
| [277](#L277) | 'post\_id' => array(), |
| [278](#L278) | 'level\_ids' => array(), |
| [279](#L279) | ), |
| [280](#L280) | 'callback' => array( $this, 'pmpro\_rest\_api\_set\_post\_restrictions' ), |
| [281](#L281) | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
| [282](#L282) | ) |
| [283](#L283) | ) |
| [284](#L284) | ); |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | /\*\* |
| [288](#L288) | \* Get user's membership level. |
| [289](#L289) | \* @since 2.3 |
| [290](#L290) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user?user\_id=1 |
| [291](#L291) | \*/ |
| [292](#L292) | function pmpro\_rest\_api\_get\_membership\_level\_for\_user($request) { |
| [293](#L293) | $params = $request->get\_params(); |
| [294](#L294) |  |
| [295](#L295) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [296](#L296) |  |
| [297](#L297) | // Param id was used instead (old style endpoint). |
| [298](#L298) | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
| [299](#L299) | $user\_id = intval( $params['id'] ); |
| [300](#L300) | } |
| [301](#L301) |  |
| [302](#L302) | // Query by email. |
| [303](#L303) | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
| [304](#L304) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [305](#L305) | $user\_id = $user->ID; |
| [306](#L306) | } |
| [307](#L307) |  |
| [308](#L308) | if ( ! empty( $user\_id ) ) { |
| [309](#L309) | $level = pmpro\_getMembershipLevelForUser( $user\_id ); |
| [310](#L310) | } else { |
| [311](#L311) | $level = false; |
| [312](#L312) | } |
| [313](#L313) |  |
| [314](#L314) | return new WP\_REST\_Response( $level, 200 ); |
| [315](#L315) | } |
| [316](#L316) |  |
| [317](#L317) | /\*\* |
| [318](#L318) | \* Get user's membership levels. (MMPU) |
| [319](#L319) | \* @since 2.3 |
| [320](#L320) | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user?user\_id=1 |
| [321](#L321) | \*/ |
| [322](#L322) | function pmpro\_rest\_api\_get\_membership\_levels\_for\_user($request) { |
| [323](#L323) | $params = $request->get\_params(); |
| [324](#L324) |  |
| [325](#L325) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [326](#L326) |  |
| [327](#L327) | // Param id was used instead. |
| [328](#L328) | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
| [329](#L329) | $user\_id = intval( $params['id'] ); |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | // Param email was used instead. |
| [333](#L333) | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
| [334](#L334) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [335](#L335) | $user\_id = $user->ID; |
| [336](#L336) | } |
| [337](#L337) |  |
| [338](#L338) | if ( ! empty( $user\_id ) ) { |
| [339](#L339) | $levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
| [340](#L340) | } else { |
| [341](#L341) | $levels = false; |
| [342](#L342) | } |
| [343](#L343) |  |
| [344](#L344) | return new WP\_REST\_Response( $levels, 200 ); |
| [345](#L345) | } |
| [346](#L346) |  |
| [347](#L347) | /\*\* |
| [348](#L348) | \* Get user's access status for a specific post. |
| [349](#L349) | \* @since 2.3 |
| [350](#L350) | \* Example: https://example.com/wp-json/wp/v2/posts/58/user\_id/2/pmpro\_has\_membership\_access |
| [351](#L351) | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access?post\_id=58&user\_id=2 |
| [352](#L352) | \*/ |
| [353](#L353) | function pmpro\_rest\_api\_get\_has\_membership\_access($request) { |
| [354](#L354) | $params = $request->get\_params(); |
| [355](#L355) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [356](#L356) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [357](#L357) |  |
| [358](#L358) | if ( empty( $user\_id ) ) { |
| [359](#L359) | // see if they sent an email |
| [360](#L360) | if ( ! empty( $params['email'] ) ) { |
| [361](#L361) | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
| [362](#L362) | $user\_id = $user->ID; |
| [363](#L363) | } else { |
| [364](#L364) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [365](#L365) | } |
| [366](#L366) | } |
| [367](#L367) |  |
| [368](#L368) | if ( ! empty( $user\_id ) ) { |
| [369](#L369) | $has\_access = pmpro\_has\_membership\_access( $post\_id, $user\_id ); |
| [370](#L370) | } else { |
| [371](#L371) | // No good user, so say no. |
| [372](#L372) | // Technically this will make public posts look restricted. |
| [373](#L373) | $has\_access = false; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | return new WP\_REST\_Response( $has\_access, 200 ); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | /\*\* |
| [380](#L380) | \* Change a user's membership level. |
| [381](#L381) | \* @since 2.3 |
| [382](#L382) | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
| [383](#L383) | \*/ |
| [384](#L384) | function pmpro\_rest\_api\_change\_membership\_level( $request ) { |
| [385](#L385) | $params = $request->get\_params(); |
| [386](#L386) | $user\_id = isset( $params['user\_id'] ) ? (int) $params['user\_id'] : null; |
| [387](#L387) | $level\_id = isset( $params['level\_id'] ) ? (int) $params['level\_id'] : null; |
| [388](#L388) | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
| [389](#L389) | $first\_name = isset( $params['first\_name'] ) ? sanitize\_text\_field( $params['first\_name'] ) : ''; |
| [390](#L390) | $last\_name = isset( $params['last\_name'] ) ? sanitize\_text\_field( $params['last\_name'] ) : ''; |
| [391](#L391) | $username = isset( $params['user\_login'] ) ? sanitize\_text\_field( $params['user\_login'] ) : $email; |
| [392](#L392) | $user\_url = isset( $params['user\_url'] ) ? sanitize\_text\_field( $params['user\_url'] ) : ''; |
| [393](#L393) | $description = isset( $params['description'] ) ? sanitize\_textarea\_field( $params['description'] ) : ''; |
| [394](#L394) | $create\_user = isset( $params['create\_user'] ) ? filter\_var( $params['create\_user'], FILTER\_VALIDATE\_BOOLEAN ) : false; |
| [395](#L395) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [396](#L396) |  |
| [397](#L397) | if ( empty( $user\_id ) ) { |
| [398](#L398) |  |
| [399](#L399) | // see if they sent an email |
| [400](#L400) | if ( ! empty( $email ) ) { |
| [401](#L401) |  |
| [402](#L402) | $user = get\_user\_by( 'email', $email ); |
| [403](#L403) |  |
| [404](#L404) | // Assume the user doesn't already exist. |
| [405](#L405) | if ( $create\_user && ! $user ) { |
| [406](#L406) |  |
| [407](#L407) | /\*\* |
| [408](#L408) | \* Filter the user data arguments for wp\_insert\_user when creating the user via the REST API. |
| [409](#L409) | \* @since 2.7.4 |
| [410](#L410) | \* @param array $user\_data An associative array with user arguments when creating the user. See https://developer.wordpress.org/reference/functions/wp\_insert\_user/ for reference. |
| [411](#L411) | \*/ |
| [412](#L412) | $user\_data = apply\_filters( 'pmpro\_api\_new\_user\_array', array( |
| [413](#L413) | 'user\_pass' => wp\_generate\_password(), |
| [414](#L414) | 'user\_email' => $email, |
| [415](#L415) | 'user\_login' => $username, |
| [416](#L416) | 'first\_name' => $first\_name, |
| [417](#L417) | 'last\_name' => $last\_name, |
| [418](#L418) | 'user\_url' => $user\_url, |
| [419](#L419) | 'description' => $description |
| [420](#L420) | ) |
| [421](#L421) | ); |
| [422](#L422) |  |
| [423](#L423) | $user\_id = wp\_insert\_user( $user\_data ); |
| [424](#L424) |  |
| [425](#L425) | if ( is\_wp\_error( $user\_id ) ) { |
| [426](#L426) | $error = $user\_id->get\_error\_message(); |
| [427](#L427) | return new WP\_REST\_Response( $error, 500 ); // Assume it failed and return a 500 error occurred like core WordPress. |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | pmpro\_maybe\_send\_wp\_new\_user\_notification( $user\_id, $level\_id ); |
| [431](#L431) | } else { |
| [432](#L432) | $user\_id = $user->ID; |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | } else { |
| [436](#L436) |  |
| [437](#L437) | if ( 'json' === $response\_type ) { |
| [438](#L438) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user information passed through.' ) ); |
| [439](#L439) | } |
| [440](#L440) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [441](#L441) | } |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | if ( ! function\_exists( 'pmpro\_changeMembershipLevel' ) ) { |
| [445](#L445) | if ( 'json' === $response\_type ) { |
| [446](#L446) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Paid Memberships Pro function not found.' ) ); |
| [447](#L447) | } |
| [448](#L448) | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
| [449](#L449) | } |
| [450](#L450) |  |
| [451](#L451) | // Make sure we have a user\_id by now. |
| [452](#L452) | if ( empty( $user\_id ) ) { |
| [453](#L453) | if ( 'json' === $response\_type ) { |
| [454](#L454) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user found with that email address. Try the create\_user parameter.' ) ); |
| [455](#L455) | } |
| [456](#L456) | return new WP\_REST\_Response( 'No user found with that email address. Try the create\_user parameter.', 404 ); |
| [457](#L457) | } |
| [458](#L458) |  |
| [459](#L459) | /\*\* |
| [460](#L460) | \* Filter to allow admin levels to be changed via the REST API or Zapier application. |
| [461](#L461) | \* Defaults to false to prevent admin users from having their level changed via API. |
| [462](#L462) | \* @since 2.7.4 |
| [463](#L463) | \* @param boolean $can\_change\_admin\_users Should API calls change admin account membership levels. |
| [464](#L464) | \*/ |
| [465](#L465) | $can\_change\_admin\_users = apply\_filters( 'pmpro\_api\_change\_membership\_level\_for\_admin\_users', false ); |
| [466](#L466) | if ( ! $can\_change\_admin\_users && user\_can( $user\_id, 'manage\_options' ) ) { |
| [467](#L467) | if ( 'json' === $response\_type ) { |
| [468](#L468) | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Sorry, you are not allowed to edit admin accounts.' ) ); |
| [469](#L469) | } |
| [470](#L470) | return new WP\_REST\_Response( 'Sorry, you are not allowed to edit admin accounts.', 403 ); |
| [471](#L471) | } |
| [472](#L472) |  |
| [473](#L473) | $response = pmpro\_changeMembershipLevel( $level\_id, $user\_id ); |
| [474](#L474) |  |
| [475](#L475) | if ( 'json' === $response\_type ) { |
| [476](#L476) | wp\_send\_json\_success( array( 'user\_id' => $user\_id, 'level\_changed' => $level\_id, 'response' => $response, 'status' => 200 ) ); |
| [477](#L477) | } |
| [478](#L478) | return new WP\_REST\_Response( $response, 200 ); |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | /\*\* |
| [482](#L482) | \* Cancel a user's membership level. |
| [483](#L483) | \* @since 2.3 |
| [484](#L484) | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
| [485](#L485) | \*/ |
| [486](#L486) | function pmpro\_rest\_api\_cancel\_membership\_level( $request ) { |
| [487](#L487) | $params = $request->get\_params(); |
| [488](#L488) | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
| [489](#L489) | $level\_id = isset( $params['level\_id'] ) ? intval( $params['level\_id'] ) : null; |
| [490](#L490) | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
| [491](#L491) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [492](#L492) |  |
| [493](#L493) | if ( empty( $user\_id ) ) { |
| [494](#L494) | // see if they sent an email |
| [495](#L495) | if ( ! empty( $email ) ) { |
| [496](#L496) | $user = get\_user\_by( 'email', $email ); |
| [497](#L497) | $user\_id = $user->ID; |
| [498](#L498) | } else { |
| [499](#L499) | if ( 'json' === $response\_type ) { |
| [500](#L500) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
| [504](#L504) | } |
| [505](#L505) | } |
| [506](#L506) |  |
| [507](#L507) | if ( empty( $level\_id ) ) { |
| [508](#L508) | if ( 'json' === $response\_type ) { |
| [509](#L509) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [510](#L510) | } |
| [511](#L511) |  |
| [512](#L512) | return new WP\_REST\_Response( 'No membership level ID data.', 400 ); |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | if ( ! function\_exists( 'pmpro\_cancelMembershipLevel' ) ) { |
| [516](#L516) | if ( 'json' === $response\_type ) { |
| [517](#L517) | wp\_send\_json\_error( array( 'email' => $email ) ); |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | if ( ! empty( $user\_id ) ) { |
| [524](#L524) | $response = pmpro\_cancelMembershipLevel( $level\_id, $user\_id, 'inactive' ); |
| [525](#L525) | } else { |
| [526](#L526) | $response = false; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | if ( 'json' === $response\_type ) { |
| [530](#L530) | wp\_send\_json\_success( array( 'email' => $email ) ); |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | return new WP\_REST\_Response( $response, 200 ); |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | /\*\* |
| [537](#L537) | \* Endpoint to get membership level data |
| [538](#L538) | \* @since 2.3 |
| [539](#L539) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [540](#L540) | \*/ |
| [541](#L541) | function pmpro\_rest\_api\_get\_membership\_level( $request ) { |
| [542](#L542) |  |
| [543](#L543) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [544](#L544) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | $params = $request->get\_params(); |
| [548](#L548) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : null; |
| [549](#L549) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : false; |
| [550](#L550) |  |
| [551](#L551) | if ( empty( $id ) ) { |
| [552](#L552) | return new WP\_REST\_Response( 'ID not passed through', 400 ); |
| [553](#L553) | } |
| [554](#L554) |  |
| [555](#L555) | $level = new PMPro\_Membership\_Level( $id ); |
| [556](#L556) |  |
| [557](#L557) | // Hide confirmation message if not an admin or member. |
| [558](#L558) | if ( ! empty( $level->confirmation ) |
| [559](#L559) | && ! pmpro\_hasMembershipLevel( $id ) |
| [560](#L560) | && ! current\_user\_can( 'pmpro\_edit\_members' ) ) { |
| [561](#L561) | $level->confirmation = ''; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | if ( 'json' === $response\_type ) { |
| [565](#L565) | wp\_send\_json\_success( array( 'level' => $level ) ); |
| [566](#L566) | } |
| [567](#L567) |  |
| [568](#L568) | return new WP\_REST\_Response( $level, 200 ); |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | /\*\* |
| [572](#L572) | \* Create/Update a Membership Level |
| [573](#L573) | \* @since 2.3 |
| [574](#L574) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [575](#L575) | \*/ |
| [576](#L576) | function pmpro\_rest\_api\_set\_membership\_level( $request ) { |
| [577](#L577) |  |
| [578](#L578) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [579](#L579) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [580](#L580) | } |
| [581](#L581) |  |
| [582](#L582) | $params = $request->get\_params(); |
| [583](#L583) | $method = $request->get\_method(); |
| [584](#L584) |  |
| [585](#L585) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
| [586](#L586) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [587](#L587) |  |
| [588](#L588) | // Pass through an ID only for PUT/PATCH methods. POST treats it as a brand new level. |
| [589](#L589) | if ( ! empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
| [590](#L590) | $level = new PMPro\_Membership\_Level( $id ); |
| [591](#L591) | } elseif ( empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
| [592](#L592) | return false; // Error trying to update |
| [593](#L593) | } elseif ( $method === 'POST' ) { |
| [594](#L594) | $level = new PMPro\_Membership\_Level(); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | $name = isset( $params['name'] ) ? sanitize\_text\_field( $params['name'] ) : $level->name; |
| [598](#L598) | $description = isset( $params['description'] ) ? sanitize\_text\_field( $params['description'] ) : $level->description; |
| [599](#L599) | $confirmation = isset( $params['confirmation'] ) ? sanitize\_text\_field( $params['confirmation'] ) : $level->confirmation; |
| [600](#L600) | $initial\_payment = isset( $params['initial\_payment'] ) ? floatval( $params['initial\_payment'] ) : $level->initial\_payment; |
| [601](#L601) | $billing\_amount = isset( $params['billing\_amount'] ) ? floatval( $params['billing\_amount'] ) : $level->billing\_amount; |
| [602](#L602) | $cycle\_number = isset( $params['cycle\_number'] ) ? intval( $params['cycle\_number'] ) : $level->cycle\_number; |
| [603](#L603) | $cycle\_period = isset( $params['cycle\_period'] ) ? pmpro\_sanitize\_period( $params['cycle\_period'] ) : $level->cycle\_period; |
| [604](#L604) | $billing\_limit = isset( $params['billing\_limit'] ) ? sanitize\_text\_field( $params['billing\_limit'] ) : $level->billing\_limit; |
| [605](#L605) | $trial\_amount = isset( $params['trial\_amount'] ) ? floatval( $params['trial\_amount'] ) : $level->trial\_amount; |
| [606](#L606) | $trial\_limit = isset( $params['trial\_limit'] ) ? floatval( $params['trial\_limit'] ) : $level->trial\_limit; |
| [607](#L607) | $allow\_signups = isset( $params['allow\_signups'] ) ? intval( $params['allow\_signups'] ) : $level->allow\_signups; |
| [608](#L608) | $expiration\_number = isset( $params['expiration\_number'] ) ? intval( $params['expiration\_number'] ) : $level->expiration\_number; |
| [609](#L609) | $expiration\_period = isset( $params['expiration\_period'] ) ? intval( $params['expiration\_period'] ) : $level->expiration\_period; |
| [610](#L610) | $categories = isset( $params['categories'] ) ? PMPro\_REST\_API\_Routes::pmpro\_rest\_api\_convert\_to\_array( sanitize\_text\_field( $params['categories'] ) ) : $level->categories; |
| [611](#L611) |  |
| [612](#L612) | // Set Level Object and save it. |
| [613](#L613) | $level->name = $name; |
| [614](#L614) | $level->description = $description; |
| [615](#L615) | $level->confirmation = $confirmation; |
| [616](#L616) | $level->initial\_payment = $initial\_payment; |
| [617](#L617) | $level->billing\_amount = $billing\_amount; |
| [618](#L618) | $level->cycle\_number = $cycle\_number; |
| [619](#L619) | $level->billing\_limit = $billing\_limit; |
| [620](#L620) | $level->trial\_amount = $trial\_amount; |
| [621](#L621) | $level->allow\_signups = $allow\_signups; |
| [622](#L622) | $level->expiration\_number = $expiration\_number; |
| [623](#L623) | $level->expiration\_period = $expiration\_period; |
| [624](#L624) | $level->categories = $categories; |
| [625](#L625) | $level->save(); |
| [626](#L626) |  |
| [627](#L627) | if ( 'json' === $response\_type ) { |
| [628](#L628) | wp\_send\_json\_success( array( "level" => $level ) ); |
| [629](#L629) | } |
| [630](#L630) |  |
| [631](#L631) | return new WP\_REST\_Response( $level, 200 ); |
| [632](#L632) |  |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | /\*\* |
| [636](#L636) | \* Delete membership level and remove users from level. (And cancel their subscription.) |
| [637](#L637) | \* @since 2.3 |
| [638](#L638) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
| [639](#L639) | \*/ |
| [640](#L640) | function pmpro\_rest\_api\_delete\_membership\_level( $request ) { |
| [641](#L641) |  |
| [642](#L642) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [643](#L643) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [644](#L644) | } |
| [645](#L645) |  |
| [646](#L646) | $params = $request->get\_params(); |
| [647](#L647) | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
| [648](#L648) |  |
| [649](#L649) | if ( empty( $id ) ) { |
| [650](#L650) | return new WP\_REST\_Response( 'ID not passed through.', 400 ); |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | $level = new PMPro\_Membership\_Level( $id ); |
| [654](#L654) |  |
| [655](#L655) | return new WP\_REST\_Response( $level->delete(), 200 ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | /\*\* |
| [659](#L659) | \* Get all membership levels. |
| [660](#L660) | \* @since 3.0 |
| [661](#L661) | \* Example: https://example.com/wp-json/pmpro/v1/membership\_levels |
| [662](#L662) | \*/ |
| [663](#L663) | function pmpro\_rest\_api\_get\_membership\_levels( $request ) { |
| [664](#L664) |  |
| [665](#L665) | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
| [666](#L666) | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | $params = $request->get\_params(); |
| [670](#L670) | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
| [671](#L671) |  |
| [672](#L672) | $levels = pmpro\_getAllLevels( true, true ); |
| [673](#L673) |  |
| [674](#L674) | // Hide confirmation message if not an admin or member. |
| [675](#L675) | if ( ! current\_user\_can( 'manage\_options' ) && ! current\_user\_can( 'pmpro\_membershiplevels' ) ) { |
| [676](#L676) | foreach ( $levels as $level ) { |
| [677](#L677) | if ( ! pmpro\_hasMembershipLevel( $level->id ) ) { |
| [678](#L678) | $level->confirmation = ''; |
| [679](#L679) | } |
| [680](#L680) | } |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | if ( 'json' === $response\_type ) { |
| [684](#L684) | wp\_send\_json\_success( array( "levels" => $levels ) ); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | return new WP\_REST\_Response( $levels, 200 ); |
| [688](#L688) | } |
| [689](#L689) |  |
| [690](#L690) | /\*\* |
| [691](#L691) | \* Get a discount code |
| [692](#L692) | \* @since 2.3 |
| [693](#L693) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [694](#L694) | \*/ |
| [695](#L695) | function pmpro\_rest\_api\_get\_discount\_code( $request ) { |
| [696](#L696) | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
| [697](#L697) | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
| [698](#L698) | } |
| [699](#L699) |  |
| [700](#L700) | $params = $request->get\_params(); |
| [701](#L701) | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [702](#L702) |  |
| [703](#L703) | if ( empty( $code ) ) { |
| [704](#L704) | return new WP\_REST\_Response( 'No discount code sent.', 400 ); |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | return new WP\_REST\_Response( new PMPro\_Discount\_Code( $code ), 200 ); |
| [708](#L708) |  |
| [709](#L709) | } |
| [710](#L710) |  |
| [711](#L711) | /\*\* |
| [712](#L712) | \* Create/update a discount code. |
| [713](#L713) | \* @since 2.3 |
| [714](#L714) | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
| [715](#L715) | \*/ |
| [716](#L716) | function pmpro\_rest\_api\_set\_discount\_code( $request ) { |
| [717](#L717) |  |
| [718](#L718) | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
| [719](#L719) | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
| [720](#L720) | } |
| [721](#L721) |  |
| [722](#L722) | $params = $request->get\_params(); |
| [723](#L723) | $method = $request->get\_method(); |
| [724](#L724) | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : ''; |
| [725](#L725) | $uses = isset( $params['uses'] ) ? intval( $params['uses'] ) : ''; |
| [726](#L726) | $starts = isset( $params['starts'] ) ? sanitize\_text\_field( $params['starts'] ) : ''; |
| [727](#L727) | $expires = isset( $params['expires'] ) ? sanitize\_text\_field( $params['expires'] ) : ''; |
| [728](#L728) | $levels = isset( $params['levels'] ) ? sanitize\_text\_field( $params['levels'] ) : null; |
| [729](#L729) |  |
| [730](#L730) | if ( ! empty( $levels ) ) { |
| [731](#L731) | $levels = json\_decode( $levels, true ); |
| [732](#L732) |  |
| [733](#L733) | if ( is\_array( $levels ) ) { |
| [734](#L734) | $levels\_array = array(); |
| [735](#L735) | foreach( $levels as $level ){ |
| [736](#L736) | $levels\_array[$level['level']] = array( |
| [737](#L737) | 'initial\_payment' => isset( $level['initial\_payment'] ) ? $level['initial\_payment'] : null, |
| [738](#L738) | 'billing\_amount' => isset( $level['billing\_amount'] ) ? $level['billing\_amount'] : null, |
| [739](#L739) | 'cycle\_number' => isset( $level['cycle\_number'] ) ? $level['cycle\_number'] : null, |
| [740](#L740) | 'cycle\_period' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
| [741](#L741) | 'billing\_limit' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
| [742](#L742) | 'custom\_trial' => isset( $level['custom\_trial'] ) ? $level['custom\_trial'] : null, |
| [743](#L743) | 'trial\_amount' => isset( $level['trial\_amount'] ) ? $level['trial\_amount'] : null, |
| [744](#L744) | 'trial\_limit' => isset( $level['trial\_limit'] ) ? $level['trial\_limit'] : null, |
| [745](#L745) | 'expiration\_number' => isset( $level['expiration\_number'] ) ?  : null, |
| [746](#L746) | 'expiration\_period' => isset( $level['expiration\_period'] ) ?  : null |
| [747](#L747) | ); |
| [748](#L748) | } |
| [749](#L749) | } |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | $discount\_code = new PMPro\_Discount\_Code(); |
| [753](#L753) |  |
| [754](#L754) | // See if code already exists when POSTING. |
| [755](#L755) | if ( $method == 'POST' && ! empty( $code ) ) { |
| [756](#L756) | // See if discount code exists. |
| [757](#L757) | if ( is\_numeric( $code ) ) { |
| [758](#L758) | $discount\_code->get\_discount\_code\_by\_id( $code ); |
| [759](#L759) | } else { |
| [760](#L760) | $discount\_code->get\_discount\_code\_by\_code( $code ); |
| [761](#L761) | } |
| [762](#L762) |  |
| [763](#L763) | if ( ! empty( $discount\_code->id ) ) { |
| [764](#L764) | return new WP\_REST\_Response( 'Discount code already exists.', 400 ); |
| [765](#L765) | } |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | $discount\_code->code = $code; |
| [769](#L769) | $discount\_code->starts = $starts; |
| [770](#L770) | $discount\_code->expires = $expires; |
| [771](#L771) | $discount\_code->uses = $uses; |
| [772](#L772) | $discount\_code->levels = !empty( $levels\_array ) ? $levels\_array : $levels; |
| [773](#L773) | $discount\_code->save(); |
| [774](#L774) |  |
| [775](#L775) | return new WP\_REST\_Response( $discount\_code, 200 ); |
| [776](#L776) | } |
| [777](#L777) |  |
| [778](#L778) | /\*\* |
| [779](#L779) | \* Get an order. |
| [780](#L780) | \* @since 2.8 |
| [781](#L781) | \* Example: https://example.com/wp-json/pmpro/v1/order |
| [782](#L782) | \*/ |
| [783](#L783) | function pmpro\_rest\_api\_get\_order( $request ) { |
| [784](#L784) | if ( ! class\_exists( 'MemberOrder' ) ) { |
| [785](#L785) | return new WP\_REST\_Response( 'Paid Memberships Pro order class not found.', 404 ); |
| [786](#L786) | } |
| [787](#L787) |  |
| [788](#L788) | $params = $request->get\_params(); |
| [789](#L789) | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [790](#L790) |  |
| [791](#L791) | if ( empty( $code ) ) { |
| [792](#L792) | return new WP\_REST\_Response( 'No order code sent.', 400 ); |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | // Build the order object to return. |
| [796](#L796) | // Need to do this because the order object now has private properties. |
| [797](#L797) | $order = new MemberOrder( $code ); |
| [798](#L798) | $order\_data\_to\_return = new stdClass(); |
| [799](#L799) | if ( ! empty( $order->id ) ) { |
| [800](#L800) | $order\_data\_to\_return->id = $order->id; |
| [801](#L801) | $order\_data\_to\_return->code = $order->code; |
| [802](#L802) | $order\_data\_to\_return->user\_id = $order->user\_id; |
| [803](#L803) | $order\_data\_to\_return->membership\_id = $order->membership\_id; |
| [804](#L804) | $order\_data\_to\_return->billing = $order->billing; |
| [805](#L805) | $order\_data\_to\_return->subtotal = $order->subtotal; |
| [806](#L806) | $order\_data\_to\_return->tax = $order->tax; |
| [807](#L807) | $order\_data\_to\_return->total = $order->total; |
| [808](#L808) | $order\_data\_to\_return->payment\_type = $order->payment\_type; |
| [809](#L809) | $order\_data\_to\_return->cardtype = $order->cardtype; |
| [810](#L810) | $order\_data\_to\_return->accountnumber = $order->accountnumber; |
| [811](#L811) | $order\_data\_to\_return->expirationmonth = $order->expirationmonth; |
| [812](#L812) | $order\_data\_to\_return->expirationyear = $order->expirationyear; |
| [813](#L813) | $order\_data\_to\_return->status = $order->status; |
| [814](#L814) | $order\_data\_to\_return->gateway = $order->gateway; |
| [815](#L815) | $order\_data\_to\_return->gateway\_environment = $order->gateway\_environment; |
| [816](#L816) | $order\_data\_to\_return->payment\_transaction\_id = $order->payment\_transaction\_id; |
| [817](#L817) | $order\_data\_to\_return->subscription\_transaction\_id = $order->subscription\_transaction\_id; |
| [818](#L818) | $order\_data\_to\_return->timestamp = $order->timestamp; |
| [819](#L819) | $order\_data\_to\_return->affiliate\_id = $order->affiliate\_id; |
| [820](#L820) | $order\_data\_to\_return->affiliate\_subid = $order->affiliate\_subid; |
| [821](#L821) | $order\_data\_to\_return->notes = $order->notes; |
| [822](#L822) | $order\_data\_to\_return->checkout\_id = $order->checkout\_id; |
| [823](#L823) | } |
| [824](#L824) |  |
| [825](#L825) | return new WP\_REST\_Response( $order\_data\_to\_return, 200 ); |
| [826](#L826) | } |
| [827](#L827) |  |
| [828](#L828) | /\*\* |
| [829](#L829) | \* Make sure that users can GET their own orders. |
| [830](#L830) | \* @since 2.8 |
| [831](#L831) | \*/ |
| [832](#L832) | function pmpro\_rest\_api\_permissions\_get\_order( $permission, $request ) { |
| [833](#L833) | $method = $request->get\_method(); |
| [834](#L834) | $route  = $request->get\_route(); |
| [835](#L835) |  |
| [836](#L836) | // Check if the user does not have access but is trying to get an order. |
| [837](#L837) | if ( ! $permission && 'GET' === $method && '/pmpro/v1/order' === $route ) { |
| [838](#L838) | // Check if the order belongs to the user. |
| [839](#L839) | $params = $request->get\_params(); |
| [840](#L840) | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
| [841](#L841) |  |
| [842](#L842) | if ( ! empty( $code ) ) { |
| [843](#L843) | $order = new MemberOrder( $code ); |
| [844](#L844) |  |
| [845](#L845) | if ( $order->user\_id == get\_current\_user\_id() ) { |
| [846](#L846) | return true; |
| [847](#L847) | } |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) | return $permission; |
| [851](#L851) | } |
| [852](#L852) |  |
| [853](#L853) | /\*\* |
| [854](#L854) | \* Get a membership level at checkout. |
| [855](#L855) | \* |
| [856](#L856) | \* @since 2.4 |
| [857](#L857) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
| [858](#L858) | \*/ |
| [859](#L859) | function pmpro\_rest\_api\_get\_checkout\_level( $request ) { |
| [860](#L860) | $params = $request->get\_params(); |
| [861](#L861) |  |
| [862](#L862) | if ( isset( $params['pmpro\_level' ] ) ) { |
| [863](#L863) | $level\_id = intval( $params['pmpro\_level'] ); |
| [864](#L864) | } elseif ( isset( $params['level\_id'] ) ) { |
| [865](#L865) | $level\_id = intval( $params['level\_id'] ); |
| [866](#L866) | } elseif ( isset( $params['level'] ) ) { |
| [867](#L867) | $level\_id = intval( $params['level'] ); |
| [868](#L868) | } |
| [869](#L869) |  |
| [870](#L870) | if ( empty( $level\_id ) ) { |
| [871](#L871) | return new WP\_REST\_Response( 'No level found.', 400 ); |
| [872](#L872) | } |
| [873](#L873) |  |
| [874](#L874) | if ( isset( $params['pmpro\_discount\_code'] ) ) { |
| [875](#L875) | $discount\_code = sanitize\_text\_field( $params['pmpro\_discount\_code'] ); |
| [876](#L876) | } elseif ( isset( $params['discount\_code'] ) ) { |
| [877](#L877) | $discount\_code = sanitize\_text\_field( $params['discount\_code'] ); |
| [878](#L878) | } else { |
| [879](#L879) | $discount\_code = null; |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | $checkout\_level = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
| [883](#L883) |  |
| [884](#L884) | if ( ! empty( $checkout\_level ) ) { |
| [885](#L885) | // Hide confirmation message if not an admin or member. |
| [886](#L886) | if ( ! empty( $checkout\_level->confirmation ) |
| [887](#L887) | && ! pmpro\_hasMembershipLevel( $level\_id ) |
| [888](#L888) | && ! current\_user\_can( 'pmpro\_edit\_members' ) ) { |
| [889](#L889) | $checkout\_level->confirmation = ''; |
| [890](#L890) | } |
| [891](#L891) |  |
| [892](#L892) | // Also add a formatted version of the initial payment. |
| [893](#L893) | $checkout\_level->initial\_payment\_formatted = pmpro\_formatPrice( $checkout\_level->initial\_payment ); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | return new WP\_REST\_Response( $checkout\_level ); |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | /\*\* |
| [900](#L900) | \* Get membership levels at checkout. |
| [901](#L901) | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
| [902](#L902) | \* |
| [903](#L903) | \* @deprecated 3.0 Use the /pmpro/v1/checkout\_level endpoint instead. |
| [904](#L904) | \*/ |
| [905](#L905) | function pmpro\_rest\_api\_get\_checkout\_levels( $request ) { |
| [906](#L906) | $params = $request->get\_params(); |
| [907](#L907) |  |
| [908](#L908) | global $pmpro\_checkout\_level\_ids; |
| [909](#L909) | if ( ! empty( $pmpro\_checkout\_level\_ids ) ) { |
| [910](#L910) | // MMPU Compatibility... |
| [911](#L911) | $level\_ids = $pmpro\_checkout\_level\_ids; |
| [912](#L912) | } elseif ( isset( $params['pmpro\_level' ] ) ) { |
| [913](#L913) | $level\_ids = explode( '+', intval( $params['pmpro\_level'] ) ); |
| [914](#L914) | }elseif ( isset( $params['level\_id'] ) ) { |
| [915](#L915) | $level\_ids = explode( '+', intval( $params['level\_id'] ) ); |
| [916](#L916) | } elseif ( isset( $params['level'] ) ) { |
| [917](#L917) | $level\_ids = explode( '+', intval( $params['level'] ) ); |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | if ( empty( $level\_ids ) ) { |
| [921](#L921) | return new WP\_REST\_Response( 'No levels found.', 400 ); |
| [922](#L922) | } |
| [923](#L923) | $discount\_code = isset( $params['discount\_code'] ) ? sanitize\_text\_field( $params['discount\_code'] ) : null; |
| [924](#L924) |  |
| [925](#L925) | $r = array(); |
| [926](#L926) | $r['initial\_payment'] = 0.00; |
| [927](#L927) | foreach ( $level\_ids as $level\_id ) { |
| [928](#L928) | $r[ $level\_id ] = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
| [929](#L929) |  |
| [930](#L930) | // Increment the total initial\_paymnent. |
| [931](#L931) | if ( ! empty( $r[ $level\_id ]->initial\_payment ) ) { |
| [932](#L932) | $r['initial\_payment'] += floatval( $r[ $level\_id ]->initial\_payment ); |
| [933](#L933) | } |
| [934](#L934) |  |
| [935](#L935) | // Hide confirmation message if not an admin or member. |
| [936](#L936) | if ( ! empty( $r[ $level\_id ]->confirmation ) |
| [937](#L937) | && ! pmpro\_hasMembershipLevel( $level\_id ) |
| [938](#L938) | && ! current\_user\_can( 'pmpro\_membershiplevels' ) ) { |
| [939](#L939) | $r[ $level\_id ]->confirmation = ''; |
| [940](#L940) | } |
| [941](#L941) | } |
| [942](#L942) | $r['initial\_payment\_formatted'] = pmpro\_formatPrice( $r['initial\_payment'] ); |
| [943](#L943) | return new WP\_REST\_Response( $r ); |
| [944](#L944) | } |
| [945](#L945) |  |
| [946](#L946) |  |
| [947](#L947) | /// ZAPIER TRIGGERS |
| [948](#L948) | /\*\* |
| [949](#L949) | \* Handle authentication testing for the Zapier API. |
| [950](#L950) | \* |
| [951](#L951) | \* @since 2.6.0 |
| [952](#L952) | \* |
| [953](#L953) | \* @param WP\_REST\_Request $request The REST request. |
| [954](#L954) | \*/ |
| [955](#L955) | public function validate\_me( $request ) { |
| [956](#L956) |  |
| [957](#L957) | $params = $request->get\_params(); |
| [958](#L958) |  |
| [959](#L959) | if ( is\_user\_logged\_in() ) { |
| [960](#L960) | $me = wp\_get\_current\_user()->display\_name; |
| [961](#L961) | } else { |
| [962](#L962) | $me = false; |
| [963](#L963) | } |
| [964](#L964) |  |
| [965](#L965) | wp\_send\_json\_success( array( 'username' => $me ) ); |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | /\*\* |
| [969](#L969) | \* Handle requests for the list of recent memberships. |
| [970](#L970) | \* |
| [971](#L971) | \* @since 2.6.0 |
| [972](#L972) | \* |
| [973](#L973) | \* @param WP\_REST\_Request $request The REST request. |
| [974](#L974) | \* |
| [975](#L975) | \* @return WP\_REST\_Response The REST response. |
| [976](#L976) | \*/ |
| [977](#L977) | public function pmpro\_rest\_api\_recent\_memberships( $request ) { |
| [978](#L978) | $params = $request->get\_params(); |
| [979](#L979) | if ( isset($params['limit']) ) { |
| [980](#L980) | $limit = intval( $params['limit'] ); |
| [981](#L981) | } else { |
| [982](#L982) | $limit = 1; |
| [983](#L983) | } |
| [984](#L984) | /\*\* |
| [985](#L985) | \* Allow filtering the total number of recent members to show in the /recent\_memberships PMPro endpoint. |
| [986](#L986) | \* |
| [987](#L987) | \* @param int $limit The total number of recent members to show. |
| [988](#L988) | \*/ |
| [989](#L989) | $limit = apply\_filters( 'pmpro\_trigger\_recent\_members\_limit', $limit ); |
| [990](#L990) |  |
| [991](#L991) | if ( empty( $params['level\_status'] ) ) { |
| [992](#L992) | $level\_status = [ 'active' ]; |
| [993](#L993) | } else { |
| [994](#L994) | $level\_status = sanitize\_text\_field( trim( $params['level\_status'] ) ); |
| [995](#L995) |  |
| [996](#L996) | // Force it into an array so we can implode it in the query itself. |
| [997](#L997) | $level\_status = explode( ',', $level\_status ); |
| [998](#L998) | } |
| [999](#L999) |  |
| [1000](#L1000) | // Set up values to prepare. |
| [1001](#L1001) | $prepare   = $level\_status; |
| [1002](#L1002) | $prepare[] = $limit; |
| [1003](#L1003) |  |
| [1004](#L1004) | // Set up the placeholders we want to use. |
| [1005](#L1005) | $level\_status\_placeholders = implode( ', ', array\_fill( 0, count( $level\_status ), '%s' ) ); |
| [1006](#L1006) |  |
| [1007](#L1007) | // Grab the useful information. |
| [1008](#L1008) | global $wpdb; |
| [1009](#L1009) |  |
| [1010](#L1010) | $sql = " |
| [1011](#L1011) | SELECT |
| [1012](#L1012) | `mu`.`user\_id` as `id`, |
| [1013](#L1013) | `u`.`user\_email`, |
| [1014](#L1014) | `u`.`user\_nicename`, |
| [1015](#L1015) | `mu`.`membership\_id`, |
| [1016](#L1016) | `ml`.`name` as membership\_name, |
| [1017](#L1017) | `mu`.`status`, |
| [1018](#L1018) | `mu`.`modified` |
| [1019](#L1019) | FROM `{$wpdb->pmpro\_memberships\_users}` AS `mu` |
| [1020](#L1020) | LEFT JOIN `{$wpdb->users}` AS `u` |
| [1021](#L1021) | ON `mu`.`user\_id` = `u`.`id` |
| [1022](#L1022) | LEFT JOIN `{$wpdb->pmpro\_membership\_levels}` AS `ml` |
| [1023](#L1023) | ON `ml`.`id` = `mu`.`membership\_id` |
| [1024](#L1024) | WHERE |
| [1025](#L1025) | `mu`.`status` IN ( {$level\_status\_placeholders} ) |
| [1026](#L1026) | ORDER BY |
| [1027](#L1027) | `mu`.`modified` DESC |
| [1028](#L1028) | LIMIT %d |
| [1029](#L1029) | "; |
| [1030](#L1030) |  |
| [1031](#L1031) | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $prepare ) ); |
| [1032](#L1032) |  |
| [1033](#L1033) | // Let's format the date to ISO8601 |
| [1034](#L1034) | $results[0]->modified = pmpro\_format\_date\_iso8601( $results[0]->modified ); |
| [1035](#L1035) |  |
| [1036](#L1036) | return new WP\_REST\_Response( $results, 200 ); |
| [1037](#L1037) |  |
| [1038](#L1038) | } |
| [1039](#L1039) |  |
| [1040](#L1040) | /\*\* |
| [1041](#L1041) | \* Handle requests for the list of recent orders. |
| [1042](#L1042) | \* |
| [1043](#L1043) | \* @since 2.6.0 |
| [1044](#L1044) | \* |
| [1045](#L1045) | \* @param WP\_REST\_Request $request The REST request. |
| [1046](#L1046) | \* |
| [1047](#L1047) | \* @return WP\_REST\_Response The REST response. |
| [1048](#L1048) | \*/ |
| [1049](#L1049) | public function pmpro\_rest\_api\_recent\_orders( $request ) { |
| [1050](#L1050) | $params = $request->get\_params(); |
| [1051](#L1051) |  |
| [1052](#L1052) | if ( isset($params['limit']) ) { |
| [1053](#L1053) | $orders\_limit = intval( $params['limit'] ); |
| [1054](#L1054) | } else { |
| [1055](#L1055) | $orders\_limit = 1; |
| [1056](#L1056) | } |
| [1057](#L1057) |  |
| [1058](#L1058) | $limit = apply\_filters( 'pmpro\_trigger\_recent\_orders\_limit', $orders\_limit ); |
| [1059](#L1059) |  |
| [1060](#L1060) | global $wpdb; |
| [1061](#L1061) |  |
| [1062](#L1062) | $sql = " |
| [1063](#L1063) | SELECT |
| [1064](#L1064) | `o`.`id`, |
| [1065](#L1065) | `o`.`code`, |
| [1066](#L1066) | `u`.`ID` AS `user\_id`, |
| [1067](#L1067) | `u`.`user\_email`, |
| [1068](#L1068) | `u`.`user\_nicename`, |
| [1069](#L1069) | `o`.`membership\_id`, |
| [1070](#L1070) | `o`.`billing\_name`, |
| [1071](#L1071) | `o`.`billing\_street`, |
| [1072](#L1072) | `o`.`billing\_city`, |
| [1073](#L1073) | `o`.`billing\_state`, |
| [1074](#L1074) | `o`.`billing\_zip`, |
| [1075](#L1075) | `o`.`billing\_country`, |
| [1076](#L1076) | `o`.`billing\_phone`, |
| [1077](#L1077) | `o`.`subtotal`, |
| [1078](#L1078) | `o`.`tax`, |
| [1079](#L1079) | `o`.`total`, |
| [1080](#L1080) | `o`.`status`, |
| [1081](#L1081) | `o`.`gateway`, |
| [1082](#L1082) | `o`.`gateway\_environment`, |
| [1083](#L1083) | `o`.`timestamp` |
| [1084](#L1084) | FROM `{$wpdb->pmpro\_membership\_orders}` AS `o` |
| [1085](#L1085) | LEFT JOIN `{$wpdb->users}` AS `u` |
| [1086](#L1086) | ON `o`.`user\_id` = `u`.`ID` |
| [1087](#L1087) | ORDER BY |
| [1088](#L1088) | `o`.`timestamp` DESC |
| [1089](#L1089) | LIMIT %d |
| [1090](#L1090) | "; |
| [1091](#L1091) |  |
| [1092](#L1092) | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $limit ) ); |
| [1093](#L1093) |  |
| [1094](#L1094) | $results[0]->timestamp = pmpro\_format\_date\_iso8601( $results[0]->timestamp ); |
| [1095](#L1095) |  |
| [1096](#L1096) | return new WP\_REST\_Response( $results, 200 ); |
| [1097](#L1097) | } |
| [1098](#L1098) |  |
| [1099](#L1099) | /\*\* |
| [1100](#L1100) | \* Get the membership level IDs restricting a given post. |
| [1101](#L1101) | \* |
| [1102](#L1102) | \* @since 3.0 |
| [1103](#L1103) | \* |
| [1104](#L1104) | \* @param WP\_REST\_Request $request The REST request. |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @return WP\_REST\_Response The REST response. |
| [1107](#L1107) | \*/ |
| [1108](#L1108) | public function pmpro\_rest\_api\_get\_post\_restrictions( $request ) { |
| [1109](#L1109) | global $wpdb; |
| [1110](#L1110) |  |
| [1111](#L1111) | $params = $request->get\_params(); |
| [1112](#L1112) |  |
| [1113](#L1113) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [1114](#L1114) |  |
| [1115](#L1115) | if ( empty( $post\_id ) ) { |
| [1116](#L1116) | return new WP\_REST\_Response( array( 'error' => 'No post ID provided.' ), 400 ); |
| [1117](#L1117) | } |
| [1118](#L1118) |  |
| [1119](#L1119) | $level\_ids = $wpdb->get\_results( $wpdb->prepare( "SELECT `membership\_id` FROM `{$wpdb->pmpro\_memberships\_pages}` WHERE `page\_id` = %d", $post\_id ) ); |
| [1120](#L1120) |  |
| [1121](#L1121) | return new WP\_REST\_Response( $level\_ids, 200 ); |
| [1122](#L1122) | } |
| [1123](#L1123) |  |
| [1124](#L1124) | /\*\* |
| [1125](#L1125) | \* Set the membership level IDs restricting a given post. |
| [1126](#L1126) | \* |
| [1127](#L1127) | \* @since 3.0 |
| [1128](#L1128) | \* |
| [1129](#L1129) | \* @param WP\_REST\_Request $request The REST request. |
| [1130](#L1130) | \* @return WP\_REST\_Response The REST response. |
| [1131](#L1131) | \*/ |
| [1132](#L1132) | public function pmpro\_rest\_api\_set\_post\_restrictions( $request ) { |
| [1133](#L1133) | global $wpdb; |
| [1134](#L1134) |  |
| [1135](#L1135) | $params = $request->get\_params(); |
| [1136](#L1136) |  |
| [1137](#L1137) | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
| [1138](#L1138) | $level\_ids = isset( $params['level\_ids'] ) ? array\_map( 'intval', $params['level\_ids'] ) : null; |
| [1139](#L1139) |  |
| [1140](#L1140) | if ( empty( $post\_id ) ) { |
| [1141](#L1141) | return new WP\_REST\_Response( array( 'error' => 'No post ID provided.' ), 400 ); |
| [1142](#L1142) | } |
| [1143](#L1143) |  |
| [1144](#L1144) | if ( ! is\_array( $level\_ids ) ) { |
| [1145](#L1145) | return new WP\_REST\_Response( array( 'error' => 'No level IDs provided.' ), 400 ); |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | // Delete existing restrictions. |
| [1149](#L1149) | $wpdb->query( "DELETE FROM {$wpdb->pmpro\_memberships\_pages} WHERE page\_id = '" . intval( $post\_id ) . "'" ); |
| [1150](#L1150) |  |
| [1151](#L1151) | // Add new restrictions. |
| [1152](#L1152) | foreach ( $level\_ids as $level\_id ) { |
| [1153](#L1153) | $wpdb->query( "INSERT INTO {$wpdb->pmpro\_memberships\_pages} (membership\_id, page\_id) VALUES('" . intval( $level\_id ) . "', '" . intval( $post\_id ) . "')" ); |
| [1154](#L1154) | } |
| [1155](#L1155) |  |
| [1156](#L1156) | return new WP\_REST\_Response( array( 'success' => $level\_ids ), 200 ); |
| [1157](#L1157) | } |
| [1158](#L1158) |  |
| [1159](#L1159) | /\*\* |
| [1160](#L1160) | \* Default permissions check for endpoints/routes. |
| [1161](#L1161) | \* Defaults to 'subscriber' for all GET requests and |
| [1162](#L1162) | \* 'administrator' for any other type of request. |
| [1163](#L1163) | \* |
| [1164](#L1164) | \* @since 2.3 |
| [1165](#L1165) | \* @since 2.12.6 Now allowing arrays in $route\_caps so you can have a different permission per HTTP method. |
| [1166](#L1166) | \*/ |
| [1167](#L1167) | function pmpro\_rest\_api\_get\_permissions\_check( $request ) { |
| [1168](#L1168) |  |
| [1169](#L1169) | $method = $request->get\_method(); |
| [1170](#L1170) | $route = $request->get\_route(); |
| [1171](#L1171) |  |
| [1172](#L1172) | // Default to requiring pmpro\_edit\_members capability. |
| [1173](#L1173) | // NOTE: This basically means that anyone with the pmpro\_edit\_members capability could potentially do anything made available through the API in this file. |
| [1174](#L1174) | $permission = current\_user\_can( 'pmpro\_edit\_members' ); |
| [1175](#L1175) |  |
| [1176](#L1176) | // Check other caps for some routes. |
| [1177](#L1177) | $route\_caps = array( |
| [1178](#L1178) | '/pmpro/v1/has\_membership\_access' => 'pmpro\_edit\_members', |
| [1179](#L1179) | '/pmpro/v1/get\_membership\_level\_for\_user' => 'pmpro\_edit\_members', |
| [1180](#L1180) | '/pmpro/v1/get\_membership\_levels\_for\_user' => 'pmpro\_edit\_members', |
| [1181](#L1181) | '/pmpro/v1/change\_membership\_level' => 'pmpro\_edit\_members', |
| [1182](#L1182) | '/pmpro/v1/cancel\_membership\_level' => 'pmpro\_edit\_members', |
| [1183](#L1183) | '/pmpro/v1/membership\_level' => array( |
| [1184](#L1184) | 'GET' => true, |
| [1185](#L1185) | 'POST' => 'pmpro\_membershiplevels', |
| [1186](#L1186) | 'PUT' => 'pmpro\_membershiplevels', |
| [1187](#L1187) | 'PATCH' => 'pmpro\_membershiplevels', |
| [1188](#L1188) | 'DELETE' => 'pmpro\_membershiplevels', |
| [1189](#L1189) | ), |
| [1190](#L1190) | '/pmpro/v1/membership\_levels' => true, |
| [1191](#L1191) | '/pmpro/v1/discount\_code' => 'pmpro\_discountcodes', |
| [1192](#L1192) | '/pmpro/v1/order' => 'pmpro\_orders', |
| [1193](#L1193) | '/pmpro/v1/checkout\_level' => true, |
| [1194](#L1194) | '/pmpro/v1/checkout\_levels' => true, |
| [1195](#L1195) | '/pmpro/v1/me' => true, |
| [1196](#L1196) | '/pmpro/v1/recent\_memberships' => 'pmpro\_edit\_members', |
| [1197](#L1197) | '/pmpro/v1/recent\_orders' => 'pmpro\_orders', |
| [1198](#L1198) | '/pmpro/v1/post\_restrictions' => 'pmpro\_edit\_members', |
| [1199](#L1199) | ); |
| [1200](#L1200) | $route\_caps = apply\_filters( 'pmpro\_rest\_api\_route\_capabilities', $route\_caps, $request ); |
| [1201](#L1201) |  |
| [1202](#L1202) | // Check if we have a specific permission to check for this route/method. |
| [1203](#L1203) | if ( isset( $route\_caps[$route] ) ) { |
| [1204](#L1204) | // Find the permission to check. |
| [1205](#L1205) | if ( is\_array ( $route\_caps[$route] ) && isset( $route\_caps[$route][$method] ) ) { |
| [1206](#L1206) | // Different permission for this method, use it. |
| [1207](#L1207) | $permission\_to\_check = $route\_caps[$route][$method]; |
| [1208](#L1208) | } elseif ( is\_array( $route\_caps[$route] ) ) { |
| [1209](#L1209) | // No permission for this method, default to false. |
| [1210](#L1210) | $permission\_to\_check = false; |
| [1211](#L1211) | } else { |
| [1212](#L1212) | // Same permission for all methods, use it. |
| [1213](#L1213) | $permission\_to\_check = $route\_caps[$route]; |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | // Check the permission. |
| [1217](#L1217) | if ( $permission\_to\_check === true || $permission\_to\_check === false ) { |
| [1218](#L1218) | // For true or false, just pass it along. |
| [1219](#L1219) | $permission = $permission\_to\_check; |
| [1220](#L1220) | } else { |
| [1221](#L1221) | // Check if the current user has this capability. |
| [1222](#L1222) | $permission = current\_user\_can( $permission ); |
| [1223](#L1223) | } |
| [1224](#L1224) | } |
| [1225](#L1225) |  |
| [1226](#L1226) | // Is the request method allowed? We disable DELETE by default. |
| [1227](#L1227) | if ( ! in\_array( $method, pmpro\_get\_rest\_api\_methods( $route ) ) ) { |
| [1228](#L1228) | $permission = false; |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | $permission = apply\_filters( 'pmpro\_rest\_api\_permissions', $permission, $request ); |
| [1232](#L1232) | return $permission; |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | /\*\* |
| [1236](#L1236) | \*      Helper function to convert comma separated items to an array. |
| [1237](#L1237) | \* @since 2.3 |
| [1238](#L1238) | \*/ |
| [1239](#L1239) | function pmpro\_rest\_api\_convert\_to\_array( $string ) { |
| [1240](#L1240) | return explode( ',', $string ); |
| [1241](#L1241) | } |
| [1242](#L1242) | } // End of class |
| [1243](#L1243) |  |
| [1244](#L1244) | /\*\* |
| [1245](#L1245) | \* Register the routes for Paid Memberships Pro. |
| [1246](#L1246) | \* @since 2.3 |
| [1247](#L1247) | \*/ |
| [1248](#L1248) | function pmpro\_rest\_api\_register\_custom\_routes() { |
| [1249](#L1249) | $pmpro\_rest\_api\_routes = new PMPro\_REST\_API\_Routes; |
| [1250](#L1250) | $pmpro\_rest\_api\_routes->pmpro\_rest\_api\_register\_routes(); |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | add\_action( 'rest\_api\_init', 'pmpro\_rest\_api\_register\_custom\_routes', 5 ); |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) |  |
| [1257](#L1257) | /\*\* |
| [1258](#L1258) | \* Get the allowed methods for PMPro REST API endpoints. |
| [1259](#L1259) | \* To enable DELETE, hook into this filter. |
| [1260](#L1260) | \* @since 2.3 |
| [1261](#L1261) | \*/ |
| [1262](#L1262) | function pmpro\_get\_rest\_api\_methods( $route = NULL ) { |
| [1263](#L1263) | $methods = array( 'GET', 'POST', 'PUT', 'PATCH' ); |
| [1264](#L1264) | $methods = apply\_filters( 'pmpro\_rest\_api\_methods', $methods, $route ); |
| [1265](#L1265) | return $methods; |
| [1266](#L1266) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/paid-memberships-pro/trunk/includes/rest-api.php?format=txt)
* [Original Format](/export/3222692/paid-memberships-pro/trunk/includes/rest-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_163b792a_20250115_084902.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3011575%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php%3Fcontextall%3D1%26old%3D2947813%26old_path%3D%252Fpaid-memberships-pro%252Ftrunk%252Fincludes%252Frest-api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2947813/paid-memberships-pro/trunk/includes/rest-api.php?old=3011575&old_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)

---

# Changes in [paid-memberships-pro/trunk/includes/rest-api.php](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=3011575 "Show entry in browser") [[2947813:3011575]](/log/paid-memberships-pro/trunk/includes/rest-api.php?rev=3011575&stop_rev=2947813 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [paid-memberships-pro/trunk/includes/rest-api.php](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=3011575 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [paid-memberships-pro/trunk/includes/rest-api.php](/changeset/3011575/paid-memberships-pro/trunk/includes/rest-api.php?old=2947813&old_path=paid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php "Show the [2947813:3011575] differences restricted to paid-memberships-pro/trunk/includes/rest-api.php")

  | [r2947813](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=2947813#L1 "Show revision 2947813 of this file in browser") | [r3011575](/browser/paid-memberships-pro/trunk/includes/rest-api.php?rev=3011575#L1 "Show revision 3011575 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | if ( class\_exists( 'WP\_REST\_Controller' ) ) { |
  | 4 | 4 | class PMPro\_REST\_API\_Routes extends WP\_REST\_Controller { |
  | 5 | 5 |  |
  | 6 | 6 | public function pmpro\_rest\_api\_register\_routes() { |
  | 7 | 7 |  |
  | 8 | 8 | // ================ DEPRECATED ================ // |
  | 9 | 9 | $namespace = 'wp/v2'; |
  | 10 | 10 | register\_rest\_route( $namespace, '/users/(?P<id>\d+)'.'/pmpro\_membership\_level' , |
  | 11 | 11 | array( |
  | 12 | 12 | array( |
  | 13 | 13 | 'methods'         => WP\_REST\_Server::READABLE, |
  | 14 | 14 | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
  | 15 | 15 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 16 | 16 | ),)); |
  | 17 | 17 |  |
  | 18 | 18 | register\_rest\_route( $namespace, '/posts/(?P<post\_id>\d+)'.'/user\_id/(?P<user\_id>\d+)/pmpro\_has\_membership\_access' , |
  | 19 | 19 | array( |
  | 20 | 20 | array( |
  | 21 | 21 | 'methods'         => WP\_REST\_Server::READABLE, |
  | 22 | 22 | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access' ), |
  | 23 | 23 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 24 | 24 | ),)); |
  | 25 | 25 | // ================================================  // |
  | 26 | 26 |  |
  | 27 | 27 | $pmpro\_namespace = 'pmpro/v1'; |
  | 28 | 28 |  |
  | 29 | 29 | /\*\* |
  | 30 | 30 | \* Get user access for a specific post. |
  | 31 | 31 | \* @since 2.3 |
  | 32 | 32 | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access |
  | 33 | 33 | \*/ |
  | 34 | 34 | register\_rest\_route( $pmpro\_namespace, '/has\_membership\_access', |
  | 35 | 35 | array( |
  | 36 | 36 | array( |
  | 37 | 37 | 'methods'  => WP\_REST\_Server::READABLE, |
  | 38 | 38 | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_has\_membership\_access'), |
  | 39 | 39 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 40 | 40 | ))); |
  | 41 | 41 |  |
  | 42 | 42 | /\*\* |
  | 43 | 43 | \* Get a membership level for a user. |
  | 44 | 44 | \* @since 2.3 |
  | 45 | 45 | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user |
  | 46 | 46 | \*/ |
  | 47 | 47 | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_level\_for\_user', |
  | 48 | 48 | array( |
  | 49 | 49 | array( |
  | 50 | 50 | 'methods'         => WP\_REST\_Server::READABLE, |
  | 51 | 51 | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level\_for\_user' ), |
  | 52 | 52 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 53 | 53 | ),)); |
  | 54 | 54 |  |
  | 55 | 55 | /\*\* |
  | 56 | 56 | \* Get a membership level for a user. |
  | 57 | 57 | \* @since 2.3 |
  | 58 | 58 | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user |
  | 59 | 59 | \*/ |
  | 60 | 60 | register\_rest\_route( $pmpro\_namespace, '/get\_membership\_levels\_for\_user', |
  | 61 | 61 | array( |
  | 62 | 62 | array( |
  | 63 | 63 | 'methods'         => WP\_REST\_Server::READABLE, |
  | 64 | 64 | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_levels\_for\_user' ), |
  | 65 | 65 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 66 | 66 | ),)); |
  | 67 | 67 |  |
  | 68 | 68 |  |
  | 69 | 69 | /\*\* |
  | 70 | 70 | \* Change a user's membership level. This also supports to cancel a membership if you pass through 0. |
  | 71 | 71 | \* @since 2.3 |
  | 72 | 72 | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
  | 73 | 73 | \*/ |
  | 74 | 74 | register\_rest\_route( $pmpro\_namespace, '/change\_membership\_level', |
  | 75 | 75 | array( |
  | 76 | 76 | array( |
  | 77 | 77 | 'methods'   => 'POST,PUT,PATCH', |
  | 78 | 78 | 'callback'  => array( $this, 'pmpro\_rest\_api\_change\_membership\_level' ), |
  | 79 | 79 | 'args'  => array( |
  | 80 | 80 | 'user\_id' => array(), |
  | 81 | 81 | 'level\_id' => array(), |
  | 82 | 82 | 'email' => array(), |
  | 83 | 83 | 'first\_name' => array(), |
  | 84 | 84 | 'last\_name' => array(), |
  | 85 | 85 | 'user\_url' => array(), |
  | 86 | 86 | 'user\_login' => array(), |
  | 87 | 87 | 'description' => array(), |
  | 88 | 88 | 'create\_user' => array(), |
  | 89 | 89 | ), |
  | 90 | 90 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 91 | 91 | ) |
  | 92 | 92 | ) |
  | 93 | 93 | ); |
  | 94 | 94 |  |
  | 95 | 95 | /\*\* |
  | 96 | 96 | \* Cancel a membership level. |
  | 97 | 97 | \* @since 2.3 |
  | 98 | 98 | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
  | 99 | 99 | \*/ |
  | 100 | 100 | register\_rest\_route( $pmpro\_namespace, '/cancel\_membership\_level', |
  | 101 | 101 | array( |
  | 102 | 102 | array( |
  | 103 | 103 | 'methods'   => 'POST,PUT,PATCH', |
  | 104 | 104 | 'callback'  => array( $this, 'pmpro\_rest\_api\_cancel\_membership\_level' ), |
  | 105 | 105 | 'args'  => array( |
  | 106 | 106 | 'user\_id' => array(), |
  | 107 | 107 | 'level\_id' => array() |
  | 108 | 108 | ), |
  | 109 | 109 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 110 | 110 | ) |
  | 111 | 111 | ) |
  | 112 | 112 | ); |
  | 113 | 113 |  |
  | 114 | 114 | /\*\* |
  | 115 | 115 | \* Delete/Retrieve/Update/Create a Membership Level. |
  | 116 | 116 | \* @since 2.3 |
  | 117 | 117 | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level |
  | 118 | 118 | \*/ |
  | 119 | 119 | register\_rest\_route( $pmpro\_namespace, '/membership\_level' , |
  | 120 | 120 | array( |
  | 121 | 121 | array( |
  | 122 | 122 | 'methods'         => WP\_REST\_Server::READABLE, |
  | 123 | 123 | 'callback'        => array( $this, 'pmpro\_rest\_api\_get\_membership\_level' ), |
  | 124 | 124 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 125 | 125 | ), |
  | 126 | 126 | array( |
  | 127 | 127 | 'methods'         => 'POST,PUT,PATCH', |
  | 128 | 128 | 'callback'        => array( $this, 'pmpro\_rest\_api\_set\_membership\_level' ), |
  | 129 | 129 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 130 | 130 | ), |
  | 131 | 131 | array( |
  | 132 | 132 | 'methods'       => 'DELETE', |
  | 133 | 133 | 'callback'        => array( $this, 'pmpro\_rest\_api\_delete\_membership\_level' ), |
  | 134 | 134 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 135 | 135 | ) |
  | 136 | 136 | )); |
  | 137 | 137 |  |
  | 138 | 138 | /\*\* |
  | 139 | 139 | \* Create/Retrieve discount code. |
  | 140 | 140 | \* @since 2.3 |
  | 141 | 141 | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
  | 142 | 142 | \*/ |
  | 143 | 143 | register\_rest\_route( $pmpro\_namespace, '/discount\_code', |
  | 144 | 144 | array( |
  | 145 | 145 | array( |
  | 146 | 146 | 'methods' => WP\_REST\_Server::READABLE, |
  | 147 | 147 | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_discount\_code' ), |
  | 148 | 148 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 149 | 149 | ), |
  | 150 | 150 | array( |
  | 151 | 151 | 'methods' => 'POST,PUT,PATCH', |
  | 152 | 152 | 'callback' => array( $this, 'pmpro\_rest\_api\_set\_discount\_code' ), |
  | 153 | 153 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 154 | 154 | ), |
  | 155 | 155 | )); |
  | 156 | 156 |  |
  | 157 | 157 | /\*\* |
  | 158 | 158 | \* Retrieve an order. |
  | 159 | 159 | \* @since 2.8 |
  | 160 | 160 | \* Example: https://example.com/wp-json/pmpro/v1/order |
  | 161 | 161 | \*/ |
  | 162 | 162 | register\_rest\_route( $pmpro\_namespace, '/order', |
  | 163 | 163 | array( |
  | 164 | 164 | array( |
  | 165 | 165 | 'methods' => WP\_REST\_Server::READABLE, |
  | 166 | 166 | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_order' ), |
  | 167 | 167 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 168 | 168 | ), |
  | 169 | 169 | )); |
  | 170 | 170 | add\_filter( 'pmpro\_rest\_api\_permissions', array( $this, 'pmpro\_rest\_api\_permissions\_get\_order' ), 10, 2 ); |
  | 171 | 171 |  |
  | 172 | 172 | /\*\* |
  | 173 | 173 | \* Get membership level after checkout options are applied. |
  | 174 | 174 | \* @since 2.4 |
  | 175 | 175 | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
  | 176 | 176 | \*/ |
  | 177 | 177 | register\_rest\_route( $pmpro\_namespace, '/checkout\_level', |
  | 178 | 178 | array( |
  | 179 | 179 | array( |
  | 180 | 180 | 'methods' => WP\_REST\_Server::READABLE, |
  | 181 | 181 | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_level' ), |
  | 182 | 182 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 183 | 183 | ), |
  | 184 | 184 | )); |
  | 185 | 185 |  |
  | 186 | 186 | /\*\* |
  | 187 | 187 | \* Get membership levels after checkout options are applied. |
  | 188 | 188 | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
  | 189 | 189 | \*/ |
  | 190 | 190 | register\_rest\_route( $pmpro\_namespace, '/checkout\_levels', |
  | 191 | 191 | array( |
  | 192 | 192 | array( |
  | 193 | 193 | 'methods' => WP\_REST\_Server::READABLE, |
  | 194 | 194 | 'callback' => array( $this, 'pmpro\_rest\_api\_get\_checkout\_levels' ), |
  | 195 | 195 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 196 | 196 | ), |
  | 197 | 197 | )); |
  | 198 | 198 |  |
  | 199 | 199 | /\*\* |
  | 200 | 200 | \* Authentication route for Zapier integration. |
  | 201 | 201 | \* |
  | 202 | 202 | \* Used to do authentication when connecting Zapier to PMPro. |
  | 203 | 203 | \* |
  | 204 | 204 | \* @since 2.6.0 |
  | 205 | 205 | \*/ |
  | 206 | 206 | register\_rest\_route( $pmpro\_namespace, '/me', |
  | 207 | 207 | array( |
  | 208 | 208 | array( |
  | 209 | 209 | 'methods' => WP\_REST\_Server::READABLE, |
  | 210 | 210 | 'callback' => array( $this, 'validate\_me' ), |
  | 211 | 211 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ) |
  | 212 | 212 | ), |
  | 213 | 213 | ) |
  | 214 | 214 | ); |
  | 215 | 215 |  |
  | 216 | 216 | /\*\* |
  | 217 | 217 | \* Get the last couple of membership levels/members. |
  | 218 | 218 | \* |
  | 219 | 219 | \* @since 2.6.0 |
  | 220 | 220 | \*/ |
  | 221 | 221 | register\_rest\_route( $pmpro\_namespace, '/recent\_memberships', |
  | 222 | 222 | array( |
  | 223 | 223 | array( |
  | 224 | 224 | 'methods'  => WP\_REST\_Server::READABLE, |
  | 225 | 225 | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_memberships' ), |
  | 226 | 226 | 'args'  => array( |
  | 227 | 227 | 'status' => array(), |
  | 228 | 228 | ), |
  | 229 | 229 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 230 | 230 | ) |
  | 231 | 231 | )); |
  | 232 | 232 |  |
  | 233 | 233 | register\_rest\_route( $pmpro\_namespace, '/recent\_orders', |
  | 234 | 234 | array( |
  | 235 | 235 | array( |
  | 236 | 236 | 'methods'  => WP\_REST\_Server::READABLE, |
  | 237 | 237 | 'callback' => array( $this, 'pmpro\_rest\_api\_recent\_orders' ), |
  | 238 | 238 | 'permission\_callback' => array( $this, 'pmpro\_rest\_api\_get\_permissions\_check' ), |
  | 239 | 239 | ) |
  | 240 | 240 | ) |
  | 241 | 241 | ); |
  | 242 | 242 | } |
  | 243 | 243 |  |
  | 244 | 244 | /\*\* |
  | 245 | 245 | \* Get user's membership level. |
  | 246 | 246 | \* @since 2.3 |
  | 247 | 247 | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_level\_for\_user?user\_id=1 |
  | 248 | 248 | \*/ |
  | 249 | 249 | function pmpro\_rest\_api\_get\_membership\_level\_for\_user($request) { |
  | 250 | 250 | $params = $request->get\_params(); |
  | 251 | 251 |  |
  | 252 | 252 | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
  | 253 | 253 |  |
  | 254 | 254 | // Param id was used instead (old style endpoint). |
  | 255 | 255 | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
  | 256 | 256 | $user\_id = intval( $params['id'] ); |
  | 257 | 257 | } |
  | 258 | 258 |  |
  | 259 | 259 | // Query by email. |
  | 260 | 260 | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
  | 261 | 261 | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
  | 262 | 262 | $user\_id = $user->ID; |
  | 263 | 263 | } |
  | 264 | 264 |  |
  | 265 | 265 | if ( ! empty( $user\_id ) ) { |
  | 266 | 266 | $level = pmpro\_getMembershipLevelForUser( $user\_id ); |
  | 267 | 267 | } else { |
  | 268 | 268 | $level = false; |
  | 269 | 269 | } |
  | 270 | 270 |  |
  | 271 | 271 | return new WP\_REST\_Response( $level, 200 ); |
  | 272 | 272 | } |
  | 273 | 273 |  |
  | 274 | 274 | /\*\* |
  | 275 | 275 | \* Get user's membership levels. (MMPU) |
  | 276 | 276 | \* @since 2.3 |
  | 277 | 277 | \* Example: https://example.com/wp-json/pmpro/v1/get\_membership\_levels\_for\_user?user\_id=1 |
  | 278 | 278 | \*/ |
  | 279 | 279 | function pmpro\_rest\_api\_get\_membership\_levels\_for\_user($request) { |
  | 280 | 280 | $params = $request->get\_params(); |
  | 281 | 281 |  |
  | 282 | 282 | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
  | 283 | 283 |  |
  | 284 | 284 | // Param id was used instead. |
  | 285 | 285 | if ( empty( $user\_id ) && !empty( $params['id'] ) ) { |
  | 286 | 286 | $user\_id = intval( $params['id'] ); |
  | 287 | 287 | } |
  | 288 | 288 |  |
  | 289 | 289 | // Param email was used instead. |
  | 290 | 290 | if ( empty( $user\_id ) && !empty( $params['email'] ) ) { |
  | 291 | 291 | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
  | 292 | 292 | $user\_id = $user->ID; |
  | 293 | 293 | } |
  | 294 | 294 |  |
  | 295 | 295 | if ( ! empty( $user\_id ) ) { |
  | 296 | 296 | $levels = pmpro\_getMembershipLevelsForUser( $user\_id ); |
  | 297 | 297 | } else { |
  | 298 | 298 | $levels = false; |
  | 299 | 299 | } |
  | 300 | 300 |  |
  | 301 | 301 | return new WP\_REST\_Response( $levels, 200 ); |
  | 302 | 302 | } |
  | 303 | 303 |  |
  | 304 | 304 | /\*\* |
  | 305 | 305 | \* Get user's access status for a specific post. |
  | 306 | 306 | \* @since 2.3 |
  | 307 | 307 | \* Example: https://example.com/wp-json/wp/v2/posts/58/user\_id/2/pmpro\_has\_membership\_access |
  | 308 | 308 | \* Example: https://example.com/wp-json/pmpro/v1/has\_membership\_access?post\_id=58&user\_id=2 |
  | 309 | 309 | \*/ |
  | 310 | 310 | function pmpro\_rest\_api\_get\_has\_membership\_access($request) { |
  | 311 | 311 | $params = $request->get\_params(); |
  | 312 | 312 | $post\_id = isset( $params['post\_id'] ) ? intval( $params['post\_id'] ) : null; |
  | 313 | 313 | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
  | 314 | 314 |  |
  | 315 | 315 | if ( empty( $user\_id ) ) { |
  | 316 | 316 | // see if they sent an email |
  | 317 | 317 | if ( ! empty( $params['email'] ) ) { |
  | 318 | 318 | $user = get\_user\_by( 'email', sanitize\_email( $params['email'] ) ); |
  | 319 | 319 | $user\_id = $user->ID; |
  | 320 | 320 | } else { |
  | 321 | 321 | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
  | 322 | 322 | } |
  | 323 | 323 | } |
  | 324 | 324 |  |
  | 325 | 325 | if ( ! empty( $user\_id ) ) { |
  | 326 | 326 | $has\_access = pmpro\_has\_membership\_access( $post\_id, $user\_id ); |
  | 327 | 327 | } else { |
  | 328 | 328 | // No good user, so say no. |
  | 329 | 329 | // Technically this will make public posts look restricted. |
  | 330 | 330 | $has\_access = false; |
  | 331 | 331 | } |
  | 332 | 332 |  |
  | 333 | 333 | return new WP\_REST\_Response( $has\_access, 200 ); |
  | 334 | 334 | } |
  | 335 | 335 |  |
  | 336 | 336 | /\*\* |
  | 337 | 337 | \* Change a user's membership level. |
  | 338 | 338 | \* @since 2.3 |
  | 339 | 339 | \* Example: https://example.com/wp-json/pmpro/v1/change\_membership\_level |
  | 340 | 340 | \*/ |
  | 341 | 341 | function pmpro\_rest\_api\_change\_membership\_level( $request ) { |
  | 342 | 342 | $params = $request->get\_params(); |
  | 343 | 343 | $user\_id = isset( $params['user\_id'] ) ? (int) $params['user\_id'] : null; |
  | 344 | 344 | $level\_id = isset( $params['level\_id'] ) ? (int) $params['level\_id'] : null; |
  | 345 | 345 | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
  | 346 | 346 | $first\_name = isset( $params['first\_name'] ) ? sanitize\_text\_field( $params['first\_name'] ) : ''; |
  | 347 | 347 | $last\_name = isset( $params['last\_name'] ) ? sanitize\_text\_field( $params['last\_name'] ) : ''; |
  | 348 | 348 | $username = isset( $params['user\_login'] ) ? sanitize\_text\_field( $params['user\_login'] ) : $email; |
  | 349 | 349 | $user\_url = isset( $params['user\_url'] ) ? sanitize\_text\_field( $params['user\_url'] ) : ''; |
  | 350 | 350 | $description = isset( $params['description'] ) ? sanitize\_textarea\_field( $params['description'] ) : ''; |
  | 351 | 351 | $create\_user = isset( $params['create\_user'] ) ? filter\_var( $params['create\_user'], FILTER\_VALIDATE\_BOOLEAN ) : false; |
  | 352 | 352 | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
  | 353 | 353 |  |
  | 354 | 354 | if ( empty( $user\_id ) ) { |
  | 355 | 355 |  |
  | 356 | 356 | // see if they sent an email |
  | 357 | 357 | if ( ! empty( $email ) ) { |
  | 358 | 358 |  |
  | 359 | 359 | $user = get\_user\_by( 'email', $email ); |
  | 360 | 360 |  |
  | 361 | 361 | // Assume the user doesn't already exist. |
  | 362 | 362 | if ( $create\_user && ! $user ) { |
  | 363 | 363 |  |
  | 364 | 364 | /\*\* |
  | 365 | 365 | \* Filter the user data arguments for wp\_insert\_user when creating the user via the REST API. |
  | 366 | 366 | \* @since 2.7.4 |
  | 367 | 367 | \* @param array $user\_data An associative array with user arguments when creating the user. See https://developer.wordpress.org/reference/functions/wp\_insert\_user/ for reference. |
  | 368 | 368 | \*/ |
  | 369 | 369 | $user\_data = apply\_filters( 'pmpro\_api\_new\_user\_array', array( |
  | 370 | 370 | 'user\_pass' => wp\_generate\_password(), |
  | 371 | 371 | 'user\_email' => $email, |
  | 372 | 372 | 'user\_login' => $username, |
  | 373 | 373 | 'first\_name' => $first\_name, |
  | 374 | 374 | 'last\_name' => $last\_name, |
  | 375 | 375 | 'user\_url' => $user\_url, |
  | 376 | 376 | 'description' => $description |
  | 377 | 377 | ) |
  | 378 | 378 | ); |
  | 379 | 379 |  |
  | 380 | 380 | $user\_id = wp\_insert\_user( $user\_data ); |
  | 381 | 381 |  |
  | 382 | 382 | if ( is\_wp\_error( $user\_id ) ) { |
  | 383 | 383 | $error = $user\_id->get\_error\_message(); |
  | 384 | 384 | return new WP\_REST\_Response( $error, 500 ); // Assume it failed and return a 500 error occured like core WordPress. |
  | 385 | 385 | } |
  | 386 | 386 |  |
  | 387 | 387 | pmpro\_maybe\_send\_wp\_new\_user\_notification( $user\_id, $level\_id ); |
  | 388 | 388 | } else { |
  | 389 | 389 | $user\_id = $user->ID; |
  | 390 | 390 | } |
  | 391 | 391 |  |
  | 392 | 392 | } else { |
  | 393 | 393 |  |
  | 394 | 394 | if ( 'json' === $response\_type ) { |
  | 395 | 395 | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user information passed through.' ) ); |
  | 396 | 396 | } |
  | 397 | 397 | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
  | 398 | 398 | } |
  | 399 | 399 | } |
  | 400 | 400 |  |
  | 401 | 401 | if ( ! function\_exists( 'pmpro\_changeMembershipLevel' ) ) { |
  | 402 | 402 | if ( 'json' === $response\_type ) { |
  | 403 | 403 | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Paid Memberships Pro function not found.' ) ); |
  | 404 | 404 | } |
  | 405 | 405 | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
  | 406 | 406 | } |
  | 407 | 407 |  |
  | 408 | 408 | // Make sure we have a user\_id by now. |
  | 409 | 409 | if ( empty( $user\_id ) ) { |
  | 410 | 410 | if ( 'json' === $response\_type ) { |
  | 411 | 411 | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'No user found with that email address. Try the create\_user parameter.' ) ); |
  | 412 | 412 | } |
  | 413 | 413 | return new WP\_REST\_Response( 'No user found with that email address. Try the create\_user parameter.', 404 ); |
  | 414 | 414 | } |
  | 415 | 415 |  |
  | 416 | 416 | /\*\* |
  | 417 | 417 | \* Filter to allow admin levels to be changed via the REST API or Zapier application. |
  | 418 | 418 | \* Defaults to false to prevent admin users from having their level changed via API. |
  | 419 | 419 | \* @since 2.7.4 |
  | 420 | 420 | \* @param boolean $can\_change\_admin\_users Should API calls change admin account membership levels. |
  | 421 | 421 | \*/ |
  | 422 | 422 | $can\_change\_admin\_users = apply\_filters( 'pmpro\_api\_change\_membership\_level\_for\_admin\_users', false ); |
  | 423 | 423 | if ( ! $can\_change\_admin\_users && user\_can( $user\_id, 'manage\_options' ) ) { |
  | 424 | 424 | if ( 'json' === $response\_type ) { |
  | 425 | 425 | wp\_send\_json\_error( array( 'email' => $email, 'error' => 'Sorry, you are not allowed to edit admin accounts.' ) ); |
  | 426 | 426 | } |
  | 427 | 427 | return new WP\_REST\_Response( 'Sorry, you are not allowed to edit admin accounts.', 403 ); |
  | 428 | 428 | } |
  | 429 | 429 |  |
  | 430 | 430 | $response = pmpro\_changeMembershipLevel( $level\_id, $user\_id ); |
  | 431 | 431 |  |
  | 432 | 432 | if ( 'json' === $response\_type ) { |
  | 433 | 433 | wp\_send\_json\_success( array( 'user\_id' => $user\_id, 'level\_changed' => $level\_id, 'response' => $response, 'status' => 200 ) ); |
  | 434 | 434 | } |
  | 435 | 435 | return new WP\_REST\_Response( $response, 200 ); |
  | 436 | 436 | } |
  | 437 | 437 |  |
  | 438 | 438 | /\*\* |
  | 439 | 439 | \* Cancel a user's membership level. |
  | 440 | 440 | \* @since 2.3 |
  | 441 | 441 | \* Example: https://example.com/wp-json/pmpro/v1/cancel\_membership\_level |
  | 442 | 442 | \*/ |
  | 443 | 443 | function pmpro\_rest\_api\_cancel\_membership\_level( $request ) { |
  | 444 | 444 | $params = $request->get\_params(); |
  | 445 | 445 | $user\_id = isset( $params['user\_id'] ) ? intval( $params['user\_id'] ) : null; |
  | 446 | 446 | $level\_id = isset( $params['level\_id'] ) ? intval( $params['level\_id'] ) : null; |
  | 447 | 447 | $email = isset( $params['email'] ) ? sanitize\_email( $params['email'] ) : null; |
  | 448 | 448 | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
  | 449 | 449 |  |
  | 450 | 450 | if ( empty( $user\_id ) ) { |
  | 451 | 451 | // see if they sent an email |
  | 452 | 452 | if ( ! empty( $email ) ) { |
  | 453 | 453 | $user = get\_user\_by( 'email', $email ); |
  | 454 | 454 | $user\_id = $user->ID; |
  | 455 | 455 | } else { |
  | 456 | 456 | if ( 'json' === $response\_type ) { |
  | 457 | 457 | wp\_send\_json\_error( array( 'email' => $email ) ); |
  | 458 | 458 | } |
  | 459 | 459 |  |
  | 460 | 460 | return new WP\_REST\_Response( 'No user information passed through.', 404 ); |
  | 461 | 461 | } |
  | 462 | 462 | } |
  | 463 | 463 |  |
  | 464 | 464 | if ( empty( $level\_id ) ) { |
  | 465 | 465 | if ( 'json' === $response\_type ) { |
  | 466 | 466 | wp\_send\_json\_error( array( 'email' => $email ) ); |
  | 467 | 467 | } |
  | 468 | 468 |  |
  | 469 | 469 | return new WP\_REST\_Response( 'No membership level ID data.', 400 ); |
  | 470 | 470 | } |
  | 471 | 471 |  |
  | 472 | 472 | if ( ! function\_exists( 'pmpro\_cancelMembershipLevel' ) ) { |
  | 473 | 473 | if ( 'json' === $response\_type ) { |
  | 474 | 474 | wp\_send\_json\_error( array( 'email' => $email ) ); |
  | 475 | 475 | } |
  | 476 | 476 |  |
  | 477 | 477 | return new WP\_REST\_Response( 'Paid Memberships Pro function not found.', 404 ); |
  | 478 | 478 | } |
  | 479 | 479 |  |
  | 480 | 480 | if ( ! empty( $user\_id ) ) { |
  | 481 | 481 | $response = pmpro\_cancelMembershipLevel( $level\_id, $user\_id, 'inactive' ); |
  | 482 | 482 | } else { |
  | 483 | 483 | $response = false; |
  | 484 | 484 | } |
  | 485 | 485 |  |
  | 486 | 486 | if ( 'json' === $response\_type ) { |
  | 487 | 487 | wp\_send\_json\_success( array( 'email' => $email ) ); |
  | 488 | 488 | } |
  | 489 | 489 |  |
  | 490 | 490 | return new WP\_REST\_Response( $response, 200 ); |
  | 491 | 491 | } |
  | 492 | 492 |  |
  | 493 | 493 | /\*\* |
  | 494 | 494 | \* Endpoint to get membership level data |
  | 495 | 495 | \* @since 2.3 |
  | 496 | 496 | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
  | 497 | 497 | \*/ |
  | 498 | 498 | function pmpro\_rest\_api\_get\_membership\_level( $request ) { |
  | 499 | 499 |  |
  | 500 | 500 | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
  | 501 | 501 | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
  | 502 | 502 | } |
  | 503 | 503 |  |
  | 504 | 504 | $params = $request->get\_params(); |
  | 505 | 505 | $id = isset( $params['id'] ) ? intval( $params['id'] ) : null; |
  | 506 | 506 | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : false; |
  | 507 | 507 |  |
  | 508 | 508 | if ( empty( $id ) ) { |
  | 509 | 509 | return new WP\_REST\_Response( 'ID not passed through', 400 ); |
  | 510 | 510 | } |
  | 511 | 511 |  |
  | 512 | 512 | $level = new PMPro\_Membership\_Level( $id ); |
  | 513 | 513 |  |
  | 514 | 514 | // Hide confirmation message if not an admin or member. |
  | 515 | 515 | if ( ! empty( $level->confirmation ) |
  | 516 | 516 | && ! pmpro\_hasMembershipLevel( $id ) |
  | 517 | 517 | && ! current\_user\_can( 'pmpro\_edit\_memberships' ) ) { |
  | 518 | 518 | $level->confirmation = ''; |
  | 519 | 519 | } |
  | 520 | 520 |  |
  | 521 | 521 | if ( 'json' === $response\_type ) { |
  | 522 | 522 | wp\_send\_json\_success( array( 'level' => $level ) ); |
  | 523 | 523 | } |
  | 524 | 524 |  |
  | 525 | 525 | return new WP\_REST\_Response( $level, 200 ); |
  | 526 | 526 | } |
  | 527 | 527 |  |
  | 528 | 528 | /\*\* |
  | 529 | 529 | \* Create/Update a Membership Level |
  | 530 | 530 | \* @since 2.3 |
  | 531 | 531 | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
  | 532 | 532 | \*/ |
  | 533 | 533 | function pmpro\_rest\_api\_set\_membership\_level( $request ) { |
  | 534 | 534 |  |
  | 535 | 535 | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
  | 536 | 536 | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
  | 537 | 537 | } |
  | 538 | 538 |  |
  | 539 | 539 | $params = $request->get\_params(); |
  | 540 | 540 | $method = $request->get\_method(); |
  | 541 | 541 |  |
  | 542 | 542 | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
  | 543 | 543 | $response\_type = isset( $params['response\_type'] ) ? sanitize\_text\_field( $params['response\_type'] ) : null; |
  | 544 | 544 |  |
  | 545 | 545 | // Pass through an ID only for PUT/PATCH methods. POST treats it as a brand new level. |
  | 546 | 546 | if ( ! empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
  | 547 | 547 | $level = new PMPro\_Membership\_Level( $id ); |
  | 548 | 548 | } elseif ( empty( $id ) && ( $method === 'PUT' || $method === 'PATCH' ) ) { |
  | 549 | 549 | return false; // Error trying to update |
  | 550 | 550 | } elseif ( $method === 'POST' ) { |
  | 551 | 551 | $level = new PMPro\_Membership\_Level(); |
  | 552 | 552 | } |
  | 553 | 553 |  |
  | 554 | 554 | $name = isset( $params['name'] ) ? sanitize\_text\_field( $params['name'] ) : $level->name; |
  | 555 | 555 | $description = isset( $params['description'] ) ? sanitize\_text\_field( $params['description'] ) : $level->description; |
  | 556 | 556 | $confirmation = isset( $params['confirmation'] ) ? sanitize\_text\_field( $params['confirmation'] ) : $level->confirmation; |
  | 557 | 557 | $initial\_payment = isset( $params['initial\_payment'] ) ? floatval( $params['initial\_payment'] ) : $level->initial\_payment; |
  | 558 | 558 | $billing\_amount = isset( $params['billing\_amount'] ) ? floatval( $params['billing\_amount'] ) : $level->billing\_amount; |
  | 559 | 559 | $cycle\_number = isset( $params['cycle\_number'] ) ? intval( $params['cycle\_number'] ) : $level->cycle\_number; |
  | 560 | 560 | $cycle\_period = isset( $params['cycle\_period'] ) ? pmpro\_sanitize\_period( $params['cycle\_period'] ) : $level->cycle\_period; |
  | 561 | 561 | $billing\_limit = isset( $params['billing\_limit'] ) ? sanitize\_text\_field( $params['billing\_limit'] ) : $level->billing\_limit; |
  | 562 | 562 | $trial\_amount = isset( $params['trial\_amount'] ) ? floatval( $params['trial\_amount'] ) : $level->trial\_amount; |
  | 563 | 563 | $trial\_limit = isset( $params['trial\_limit'] ) ? floatval( $params['trial\_limit'] ) : $level->trial\_limit; |
  | 564 | 564 | $allow\_signups = isset( $params['allow\_signups'] ) ? intval( $params['allow\_signups'] ) : $level->allow\_signups; |
  | 565 | 565 | $expiration\_number = isset( $params['expiration\_number'] ) ? intval( $params['expiration\_number'] ) : $level->expiration\_number; |
  | 566 | 566 | $expiration\_period = isset( $params['expiration\_period'] ) ? intval( $params['expiration\_period'] ) : $level->expiration\_period; |
  | 567 | 567 | $categories = isset( $params['categories'] ) ? PMPro\_REST\_API\_Routes::pmpro\_rest\_api\_convert\_to\_array( sanitize\_text\_field( $params['categories'] ) ) : $level->categories; |
  | 568 | 568 |  |
  | 569 | 569 | // Set Level Object and save it. |
  | 570 | 570 | $level->name = $name; |
  | 571 | 571 | $level->description = $description; |
  | 572 | 572 | $level->confirmation = $confirmation; |
  | 573 | 573 | $level->initial\_payment = $initial\_payment; |
  | 574 | 574 | $level->billing\_amount = $billing\_amount; |
  | 575 | 575 | $level->cycle\_number = $cycle\_number; |
  | 576 | 576 | $level->billing\_limit = $billing\_limit; |
  | 577 | 577 | $level->trial\_amount = $trial\_amount; |
  | 578 | 578 | $level->allow\_signups = $allow\_signups; |
  | 579 | 579 | $level->expiration\_number = $expiration\_number; |
  | 580 | 580 | $level->expiration\_period = $expiration\_period; |
  | 581 | 581 | $level->categories = $categories; |
  | 582 | 582 | $level->save(); |
  | 583 | 583 |  |
  | 584 | 584 | if ( 'json' === $response\_type ) { |
  | 585 | 585 | wp\_send\_json\_success( array( "level" => $level ) ); |
  | 586 | 586 | } |
  | 587 | 587 |  |
  | 588 | 588 | return new WP\_REST\_Response( $level, 200 ); |
  | 589 | 589 |  |
  | 590 | 590 | } |
  | 591 | 591 |  |
  | 592 | 592 | /\*\* |
  | 593 | 593 | \* Delete membership level and remove users from level. (And cancel their subscription.) |
  | 594 | 594 | \* @since 2.3 |
  | 595 | 595 | \* Example: https://example.com/wp-json/pmpro/v1/membership\_level/ |
  | 596 | 596 | \*/ |
  | 597 | 597 | function pmpro\_rest\_api\_delete\_membership\_level( $request ) { |
  | 598 | 598 |  |
  | 599 | 599 | if ( ! class\_exists( 'PMPro\_Membership\_Level' ) ) { |
  | 600 | 600 | return new WP\_REST\_Response( 'Paid Memberships Pro level class not found.', 404 ); |
  | 601 | 601 | } |
  | 602 | 602 |  |
  | 603 | 603 | $params = $request->get\_params(); |
  | 604 | 604 | $id = isset( $params['id'] ) ? intval( $params['id'] ) : ''; |
  | 605 | 605 |  |
  | 606 | 606 | if ( empty( $id ) ) { |
  | 607 | 607 | return new WP\_REST\_Response( 'ID not passed through.', 400 ); |
  | 608 | 608 | } |
  | 609 | 609 |  |
  | 610 | 610 | $level = new PMPro\_Membership\_Level( $id ); |
  | 611 | 611 |  |
  | 612 | 612 | return new WP\_REST\_Response( $level->delete(), 200 ); |
  | 613 | 613 | } |
  | 614 | 614 |  |
  | 615 | 615 | /\*\* |
  | 616 | 616 | \* Get a discount code |
  | 617 | 617 | \* @since 2.3 |
  | 618 | 618 | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
  | 619 | 619 | \*/ |
  | 620 | 620 | function pmpro\_rest\_api\_get\_discount\_code( $request ) { |
  | 621 | 621 | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
  | 622 | 622 | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
  | 623 | 623 | } |
  | 624 | 624 |  |
  | 625 | 625 | $params = $request->get\_params(); |
  | 626 | 626 | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
  | 627 | 627 |  |
  | 628 | 628 | if ( empty( $code ) ) { |
  | 629 | 629 | return new WP\_REST\_Response( 'No discount code sent.', 400 ); |
  | 630 | 630 | } |
  | 631 | 631 |  |
  | 632 | 632 | return new WP\_REST\_Response( new PMPro\_Discount\_Code( $code ), 200 ); |
  | 633 | 633 |  |
  | 634 | 634 | } |
  | 635 | 635 |  |
  | 636 | 636 | /\*\* |
  | 637 | 637 | \* Create/update a discount code. |
  | 638 | 638 | \* @since 2.3 |
  | 639 | 639 | \* Example: https://example.com/wp-json/pmpro/v1/discount\_code |
  | 640 | 640 | \*/ |
  | 641 | 641 | function pmpro\_rest\_api\_set\_discount\_code( $request ) { |
  | 642 | 642 |  |
  | 643 | 643 | if ( ! class\_exists( 'PMPro\_Discount\_Code' ) ) { |
  | 644 | 644 | return new WP\_REST\_Response( 'Paid Memberships Pro discount code class not found.', 404 ); |
  | 645 | 645 | } |
  | 646 | 646 |  |
  | 647 | 647 | $params = $request->get\_params(); |
  | 648 | 648 | $method = $request->get\_method(); |
  | 649 | 649 | $code = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : ''; |
  | 650 | 650 | $uses = isset( $params['uses'] ) ? intval( $params['uses'] ) : ''; |
  | 651 | 651 | $starts = isset( $params['starts'] ) ? sanitize\_text\_field( $params['starts'] ) : ''; |
  | 652 | 652 | $expires = isset( $params['expires'] ) ? sanitize\_text\_field( $params['expires'] ) : ''; |
  | 653 | 653 | $levels = isset( $params['levels'] ) ? sanitize\_text\_field( $params['levels'] ) : null; |
  | 654 | 654 |  |
  | 655 | 655 | if ( ! empty( $levels ) ) { |
  | 656 | 656 | $levels = json\_decode( $levels, true ); |
  | 657 | 657 |  |
  | 658 | 658 | if ( is\_array( $levels ) ) { |
  | 659 | 659 | $levels\_array = array(); |
  | 660 | 660 | foreach( $levels as $level ){ |
  | 661 | 661 | $levels\_array[$level['level']] = array( |
  | 662 | 662 | 'initial\_payment' => isset( $level['initial\_payment'] ) ? $level['initial\_payment'] : null, |
  | 663 | 663 | 'billing\_amount' => isset( $level['billing\_amount'] ) ? $level['billing\_amount'] : null, |
  | 664 | 664 | 'cycle\_number' => isset( $level['cycle\_number'] ) ? $level['cycle\_number'] : null, |
  | 665 | 665 | 'cycle\_period' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
  | 666 | 666 | 'billing\_limit' => isset( $level['cycle\_period'] ) ? $level['cycle\_period'] : null, |
  | 667 | 667 | 'custom\_trial' => isset( $level['custom\_trial'] ) ? $level['custom\_trial'] : null, |
  | 668 | 668 | 'trial\_amount' => isset( $level['trial\_amount'] ) ? $level['trial\_amount'] : null, |
  | 669 | 669 | 'trial\_limit' => isset( $level['trial\_limit'] ) ? $level['trial\_limit'] : null, |
  | 670 | 670 | 'expiration\_number' => isset( $level['expiration\_number'] ) ?  : null, |
  | 671 | 671 | 'expiration\_period' => isset( $level['expiration\_period'] ) ?  : null |
  | 672 | 672 | ); |
  | 673 | 673 | } |
  | 674 | 674 | } |
  | 675 | 675 | } |
  | 676 | 676 |  |
  | 677 | 677 | $discount\_code = new PMPro\_Discount\_Code(); |
  | 678 | 678 |  |
  | 679 | 679 | // See if code already exists when POSTING. |
  | 680 | 680 | if ( $method == 'POST' && ! empty( $code ) ) { |
  | 681 | 681 | // See if discount code exists. |
  | 682 | 682 | if ( is\_numeric( $code ) ) { |
  | 683 | 683 | $discount\_code->get\_discount\_code\_by\_id( $code ); |
  | 684 | 684 | } else { |
  | 685 | 685 | $discount\_code->get\_discount\_code\_by\_code( $code ); |
  | 686 | 686 | } |
  | 687 | 687 |  |
  | 688 | 688 | if ( ! empty( $discount\_code->id ) ) { |
  | 689 | 689 | return new WP\_REST\_Response( 'Discount code already exists.', 400 ); |
  | 690 | 690 | } |
  | 691 | 691 | } |
  | 692 | 692 |  |
  | 693 | 693 | $discount\_code->code = $code; |
  | 694 | 694 | $discount\_code->starts = $starts; |
  | 695 | 695 | $discount\_code->expires = $expires; |
  | 696 | 696 | $discount\_code->uses = $uses; |
  | 697 | 697 | $discount\_code->levels = !empty( $levels\_array ) ? $levels\_array : $levels; |
  | 698 | 698 | $discount\_code->save(); |
  | 699 | 699 |  |
  | 700 | 700 | return new WP\_REST\_Response( $discount\_code, 200 ); |
  | 701 | 701 | } |
  | 702 | 702 |  |
  | 703 | 703 | /\*\* |
  | 704 | 704 | \* Get an order. |
  | 705 | 705 | \* @since 2.8 |
  | 706 | 706 | \* Example: https://example.com/wp-json/pmpro/v1/order |
  | 707 | 707 | \*/ |
  | 708 | 708 | function pmpro\_rest\_api\_get\_order( $request ) { |
  | 709 | 709 | if ( ! class\_exists( 'MemberOrder' ) ) { |
  | 710 | 710 | return new WP\_REST\_Response( 'Paid Memberships Pro order class not found.', 404 ); |
  | 711 | 711 | } |
  | 712 | 712 |  |
  | 713 | 713 | $params = $request->get\_params(); |
  | 714 | 714 | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
  | 715 | 715 |  |
  | 716 | 716 | if ( empty( $code ) ) { |
  | 717 | 717 | return new WP\_REST\_Response( 'No order code sent.', 400 ); |
  | 718 | 718 | } |
  | 719 | 719 |  |
  | 720 | 720 | // Build the order object to return. |
  | 721 | 721 | // Need to do this because the order object now has private properties. |
  | 722 | 722 | $order = new MemberOrder( $code ); |
  | 723 | 723 | $order\_data\_to\_return = new stdClass(); |
  | 724 | 724 | if ( ! empty( $order->id ) ) { |
  | 725 | 725 | $order\_data\_to\_return->id = $order->id; |
  | 726 | 726 | $order\_data\_to\_return->code = $order->code; |
  | 727 | 727 | $order\_data\_to\_return->user\_id = $order->user\_id; |
  | 728 | 728 | $order\_data\_to\_return->membership\_id = $order->membership\_id; |
  | 729 | 729 | $order\_data\_to\_return->billing = $order->billing; |
  | 730 | 730 | $order\_data\_to\_return->subtotal = $order->subtotal; |
  | 731 | 731 | $order\_data\_to\_return->tax = $order->tax; |
  | 732 | 732 | $order\_data\_to\_return->total = $order->total; |
  | 733 | 733 | $order\_data\_to\_return->payment\_type = $order->payment\_type; |
  | 734 | 734 | $order\_data\_to\_return->cardtype = $order->cardtype; |
  | 735 | 735 | $order\_data\_to\_return->accountnumber = $order->accountnumber; |
  | 736 | 736 | $order\_data\_to\_return->expirationmonth = $order->expirationmonth; |
  | 737 | 737 | $order\_data\_to\_return->expirationyear = $order->expirationyear; |
  | 738 | 738 | $order\_data\_to\_return->status = $order->status; |
  | 739 | 739 | $order\_data\_to\_return->gateway = $order->gateway; |
  | 740 | 740 | $order\_data\_to\_return->gateway\_environment = $order->gateway\_environment; |
  | 741 | 741 | $order\_data\_to\_return->payment\_transaction\_id = $order->payment\_transaction\_id; |
  | 742 | 742 | $order\_data\_to\_return->subscription\_transaction\_id = $order->subscription\_transaction\_id; |
  | 743 | 743 | $order\_data\_to\_return->timestamp = $order->timestamp; |
  | 744 | 744 | $order\_data\_to\_return->affiliate\_id = $order->affiliate\_id; |
  | 745 | 745 | $order\_data\_to\_return->affiliate\_subid = $order->affiliate\_subid; |
  | 746 | 746 | $order\_data\_to\_return->notes = $order->notes; |
  | 747 | 747 | $order\_data\_to\_return->checkout\_id = $order->checkout\_id; |
  | 748 | 748 | } |
  | 749 | 749 |  |
  | 750 | 750 | return new WP\_REST\_Response( $order\_data\_to\_return, 200 ); |
  | 751 | 751 | } |
  | 752 | 752 |  |
  | 753 | 753 | /\*\* |
  | 754 | 754 | \* Make sure that users can GET their own orders. |
  | 755 | 755 | \* @since 2.8 |
  | 756 | 756 | \*/ |
  | 757 | 757 | function pmpro\_rest\_api\_permissions\_get\_order( $permission, $request ) { |
  | 758 | 758 | $method = $request->get\_method(); |
  | 759 | 759 | $route  = $request->get\_route(); |
  | 760 | 760 |  |
  | 761 | 761 | // Check if the user does not have access but is trying to get an order. |
  | 762 | 762 | if ( ! $permission && 'GET' === $method && '/pmpro/v1/order' === $route ) { |
  | 763 | 763 | // Check if the order belongs to the user. |
  | 764 | 764 | $params = $request->get\_params(); |
  | 765 | 765 | $code   = isset( $params['code'] ) ? sanitize\_text\_field( $params['code'] ) : null; |
  | 766 | 766 |  |
  | 767 | 767 | if ( ! empty( $code ) ) { |
  | 768 | 768 | $order = new MemberOrder( $code ); |
  | 769 | 769 |  |
  | 770 | 770 | if ( $order->user\_id == get\_current\_user\_id() ) { |
  | 771 | 771 | return true; |
  | 772 | 772 | } |
  | 773 | 773 | } |
  | 774 | 774 | } |
  | 775 | 775 | return $permission; |
  | 776 | 776 | } |
  | 777 | 777 |  |
  | 778 | 778 | /\*\* |
  | 779 | 779 | \* Get a membership level at checkout. |
  | 780 | 780 | \* Note: Not compatible with MMPU. |
  | 781 | 781 | \* @since 2.4 |
  | 782 | 782 | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_level |
  | 783 | 783 | \*/ |
  | 784 | 784 | function pmpro\_rest\_api\_get\_checkout\_level( $request ) { |
  | 785 | 785 | $params = $request->get\_params(); |
  | 786 | 786 |  |
  | 787 | 787 | if ( isset( $params['level\_id'] ) ) { |
  | 788 | 788 | $level\_id = intval( $params['level\_id'] ); |
  | 789 | 789 | } elseif ( isset( $params['level'] ) ) { |
  | 790 | 790 | $level\_id = intval( $params['level'] ); |
  | 791 | 791 | } |
  | 792 | 792 |  |
  | 793 | 793 | if ( empty( $level\_id ) ) { |
  | 794 | 794 | return new WP\_REST\_Response( 'No level found.', 400 ); |
  | 795 | 795 | } |
  | 796 | 796 |  |
  | 797 | 797 | $discount\_code = isset( $params['discount\_code'] ) ? sanitize\_text\_field( $params['discount\_code'] ) : null; |
  | 798 | 798 | $checkout\_level = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
  | 799 | 799 |  |
  | 800 | 800 | // Hide confirmation message if not an admin or member. |
  | 801 | 801 | if ( ! empty( $checkout\_level->confirmation ) |
  | 802 | 802 | && ! pmpro\_hasMembershipLevel( $level\_id ) |
  | 803 | 803 | && ! current\_user\_can( 'pmpro\_edit\_memberships' ) ) { |
  | 804 | 804 | $checkout\_level->confirmation = ''; |
  | 805 | 805 | } |
  | 806 | 806 |  |
  | 807 | 807 | return new WP\_REST\_Response( $checkout\_level ); |
  | 808 | 808 | } |
  | 809 | 809 |  |
  | 810 | 810 | /\*\* |
  | 811 | 811 | \* Get membership levels at checkout. |
  | 812 | 812 | \* Example: https://example.com/wp-json/pmpro/v1/checkout\_levels |
  | 813 | 813 | \*/ |
  | 814 | 814 | function pmpro\_rest\_api\_get\_checkout\_levels( $request ) { |
  | 815 | 815 | $params = $request->get\_params(); |
  | 816 | 816 |  |
  | 817 | 817 | global $pmpro\_checkout\_level\_ids; |
  | 818 | 818 | if ( ! empty( $pmpro\_checkout\_level\_ids ) ) { |
  | 819 | 819 | // MMPU Compatibility... |
  | 820 | 820 | $level\_ids = $pmpro\_checkout\_level\_ids; |
  | 821 | 821 | } elseif ( isset( $params['level\_id'] ) ) { |
  | 822 | 822 | $level\_ids = explode( '+', intval( $params['level\_id'] ) ); |
  | 823 | 823 | } elseif ( isset( $params['level'] ) ) { |
  | 824 | 824 | $level\_ids = explode( '+', intval( $params['level'] ) ); |
  | 825 | 825 | } |
  | 826 | 826 |  |
  | 827 | 827 | if ( empty( $level\_ids ) ) { |
  | 828 | 828 | return new WP\_REST\_Response( 'No levels found.', 400 ); |
  | 829 | 829 | } |
  | 830 | 830 | $discount\_code = isset( $params['discount\_code'] ) ? sanitize\_text\_field( $params['discount\_code'] ) : null; |
  | 831 | 831 |  |
  | 832 | 832 | $r = array(); |
  | 833 | 833 | $r['initial\_payment'] = 0.00; |
  | 834 | 834 | foreach ( $level\_ids as $level\_id ) { |
  | 835 | 835 | $r[ $level\_id ] = pmpro\_getLevelAtCheckout( $level\_id, $discount\_code ); |
  |  | 836 |  |
  |  | 837 | // Increment the total initial\_paymnent. |
  | 836 | 838 | if ( ! empty( $r[ $level\_id ]->initial\_payment ) ) { |
  | 837 | 839 | $r['initial\_payment'] += floatval( $r[ $level\_id ]->initial\_payment ); |
  |  | 840 | } |
  |  | 841 |  |
  |  | 842 | // Hide confirmation message if not an admin or member. |
  |  | 843 | if ( ! empty( $r[ $level\_id ]->confirmation ) |
  |  | 844 | && ! pmpro\_hasMembershipLevel( $level\_id ) |
  |  | 845 | && ! current\_user\_can( 'pmpro\_edit\_memberships' ) ) { |
  |  | 846 | $r[ $level\_id ]->confirmation = ''; |
  | 838 | 847 | } |
  | 839 | 848 | } |
  | 840 | 849 | $r['initial\_payment\_formatted'] = pmpro\_formatPrice( $r['initial\_payment'] ); |
  | 841 | 850 | return new WP\_REST\_Response( $r ); |
  | 842 | 851 | } |
  | 843 | 852 |  |
  | 844 | 853 |  |
  | 845 | 854 | /// ZAPIER TRIGGERS |
  | 846 | 855 | /\*\* |
  | 847 | 856 | \* Handle authentication testing for the Zapier API. |
  | 848 | 857 | \* |
  | 849 | 858 | \* @since 2.6.0 |
  | 850 | 859 | \* |
  | 851 | 860 | \* @param WP\_REST\_Request $request The REST request. |
  | 852 | 861 | \*/ |
  | 853 | 862 | public function validate\_me( $request ) { |
  | 854 | 863 |  |
  | 855 | 864 | $params = $request->get\_params(); |
  | 856 | 865 |  |
  | 857 | 866 | if ( is\_user\_logged\_in() ) { |
  | 858 | 867 | $me = wp\_get\_current\_user()->display\_name; |
  | 859 | 868 | } else { |
  | 860 | 869 | $me = false; |
  | 861 | 870 | } |
  | 862 | 871 |  |
  | 863 | 872 | wp\_send\_json\_success( array( 'username' => $me ) ); |
  | 864 | 873 | } |
  | 865 | 874 |  |
  | 866 | 875 | /\*\* |
  | 867 | 876 | \* Handle requests for the list of recent memberships. |
  | 868 | 877 | \* |
  | 869 | 878 | \* @since 2.6.0 |
  | 870 | 879 | \* |
  | 871 | 880 | \* @param WP\_REST\_Request $request The REST request. |
  | 872 | 881 | \* |
  | 873 | 882 | \* @return WP\_REST\_Response The REST response. |
  | 874 | 883 | \*/ |
  | 875 | 884 | public function pmpro\_rest\_api\_recent\_memberships( $request ) { |
  | 876 | 885 | $params = $request->get\_params(); |
  | 877 | 886 | if ( isset($params['limit']) ) { |
  | 878 | 887 | $limit = intval( $params['limit'] ); |
  | 879 | 888 | } else { |
  | 880 | 889 | $limit = 1; |
  | 881 | 890 | } |
  | 882 | 891 | /\*\* |
  | 883 | 892 | \* Allow filtering the total number of recent members to show in the /recent\_memberships PMPro endpoint. |
  | 884 | 893 | \* |
  | 885 | 894 | \* @param int $limit The total number of recent members to show. |
  | 886 | 895 | \*/ |
  | 887 | 896 | $limit = apply\_filters( 'pmpro\_trigger\_recent\_members\_limit', $limit ); |
  | 888 | 897 |  |
  | 889 | 898 | if ( empty( $params['level\_status'] ) ) { |
  | 890 | 899 | $level\_status = [ 'active' ]; |
  | 891 | 900 | } else { |
  | 892 | 901 | $level\_status = sanitize\_text\_field( trim( $params['level\_status'] ) ); |
  | 893 | 902 |  |
  | 894 | 903 | // Force it into an array so we can implode it in the query itself. |
  | 895 | 904 | $level\_status = explode( ',', $level\_status ); |
  | 896 | 905 | } |
  | 897 | 906 |  |
  | 898 | 907 | // Set up values to prepare. |
  | 899 | 908 | $prepare   = $level\_status; |
  | 900 | 909 | $prepare[] = $limit; |
  | 901 | 910 |  |
  | 902 | 911 | // Set up the placeholders we want to use. |
  | 903 | 912 | $level\_status\_placeholders = implode( ', ', array\_fill( 0, count( $level\_status ), '%s' ) ); |
  | 904 | 913 |  |
  | 905 | 914 | // Grab the useful information. |
  | 906 | 915 | global $wpdb; |
  | 907 | 916 |  |
  | 908 | 917 | $sql = " |
  | 909 | 918 | SELECT |
  | 910 | 919 | `mu`.`user\_id` as `id`, |
  | 911 | 920 | `u`.`user\_email`, |
  | 912 | 921 | `u`.`user\_nicename`, |
  | 913 | 922 | `mu`.`membership\_id`, |
  | 914 | 923 | `ml`.`name` as membership\_name, |
  | 915 | 924 | `mu`.`status`, |
  | 916 | 925 | `mu`.`modified` |
  | 917 | 926 | FROM `{$wpdb->pmpro\_memberships\_users}` AS `mu` |
  | 918 | 927 | LEFT JOIN `{$wpdb->users}` AS `u` |
  | 919 | 928 | ON `mu`.`user\_id` = `u`.`id` |
  | 920 | 929 | LEFT JOIN `{$wpdb->pmpro\_membership\_levels}` AS `ml` |
  | 921 | 930 | ON `ml`.`id` = `mu`.`membership\_id` |
  | 922 | 931 | WHERE |
  | 923 | 932 | `mu`.`status` IN ( {$level\_status\_placeholders} ) |
  | 924 | 933 | ORDER BY |
  | 925 | 934 | `mu`.`modified` DESC |
  | 926 | 935 | LIMIT %d |
  | 927 | 936 | "; |
  | 928 | 937 |  |
  | 929 | 938 | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $prepare ) ); |
  | 930 | 939 |  |
  | 931 | 940 | // Let's format the date to ISO8601 |
  | 932 | 941 | $results[0]->modified = pmpro\_format\_date\_iso8601( $results[0]->modified ); |
  | 933 | 942 |  |
  | 934 | 943 | return new WP\_REST\_Response( $results, 200 ); |
  | 935 | 944 |  |
  | 936 | 945 | } |
  | 937 | 946 |  |
  | 938 | 947 | /\*\* |
  | 939 | 948 | \* Handle requests for the list of recent orders. |
  | 940 | 949 | \* |
  | 941 | 950 | \* @since 2.6.0 |
  | 942 | 951 | \* |
  | 943 | 952 | \* @param WP\_REST\_Request $request The REST request. |
  | 944 | 953 | \* |
  | 945 | 954 | \* @return WP\_REST\_Response The REST response. |
  | 946 | 955 | \*/ |
  | 947 | 956 | public function pmpro\_rest\_api\_recent\_orders( $request ) { |
  | 948 | 957 | $params = $request->get\_params(); |
  | 949 | 958 |  |
  | 950 | 959 | if ( isset($params['limit']) ) { |
  | 951 | 960 | $orders\_limit = intval( $params['limit'] ); |
  | 952 | 961 | } else { |
  | 953 | 962 | $orders\_limit = 1; |
  | 954 | 963 | } |
  | 955 | 964 |  |
  | 956 | 965 | $limit = apply\_filters( 'pmpro\_trigger\_recent\_orders\_limit', $orders\_limit ); |
  | 957 | 966 |  |
  | 958 | 967 | global $wpdb; |
  | 959 | 968 |  |
  | 960 | 969 | $sql = " |
  | 961 | 970 | SELECT |
  | 962 | 971 | `o`.`id`, |
  | 963 | 972 | `o`.`code`, |
  | 964 | 973 | `u`.`ID` AS `user\_id`, |
  | 965 | 974 | `u`.`user\_email`, |
  | 966 | 975 | `u`.`user\_nicename`, |
  | 967 | 976 | `o`.`membership\_id`, |
  | 968 | 977 | `o`.`billing\_name`, |
  | 969 | 978 | `o`.`billing\_street`, |
  | 970 | 979 | `o`.`billing\_city`, |
  | 971 | 980 | `o`.`billing\_state`, |
  | 972 | 981 | `o`.`billing\_zip`, |
  | 973 | 982 | `o`.`billing\_country`, |
  | 974 | 983 | `o`.`billing\_phone`, |
  | 975 | 984 | `o`.`subtotal`, |
  | 976 | 985 | `o`.`tax`, |
  | 977 | 986 | `o`.`total`, |
  | 978 | 987 | `o`.`status`, |
  | 979 | 988 | `o`.`gateway`, |
  | 980 | 989 | `o`.`gateway\_environment`, |
  | 981 | 990 | `o`.`timestamp` |
  | 982 | 991 | FROM `{$wpdb->pmpro\_membership\_orders}` AS `o` |
  | 983 | 992 | LEFT JOIN `{$wpdb->users}` AS `u` |
  | 984 | 993 | ON `o`.`user\_id` = `u`.`ID` |
  | 985 | 994 | ORDER BY |
  | 986 | 995 | `o`.`timestamp` DESC |
  | 987 | 996 | LIMIT %d |
  | 988 | 997 | "; |
  | 989 | 998 |  |
  | 990 | 999 | $results = $wpdb->get\_results( $wpdb->prepare( $sql, $limit ) ); |
  | 991 | 1000 |  |
  | 992 | 1001 | $results[0]->timestamp = pmpro\_format\_date\_iso8601( $results[0]->timestamp ); |
  | 993 | 1002 |  |
  | 994 | 1003 | return new WP\_REST\_Response( $results, 200 ); |
  | 995 | 1004 | } |
  | 996 | 1005 |  |
  | 997 | 1006 | /\*\* |
  | 998 | 1007 | \* Default permissions check for endpoints/routes. |
  | 999 | 1008 | \* Defaults to 'subscriber' for all GET requests and |
  | 1000 | 1009 | \* 'administrator' for any other type of request. |
  | 1001 | 1010 | \* |
  | 1002 | 1011 | \* @since 2.3 |
  |  | 1012 | \* @since 2.12.6 Now allowing arrays in $route\_caps so you can have a different permission per HTTP method. |
  | 1003 | 1013 | \*/ |
  | 1004 | 1014 | function pmpro\_rest\_api\_get\_permissions\_check( $request ) { |
  | 1005 | 1015 |  |
  | 1006 | 1016 | $method = $request->get\_method(); |
  | 1007 | 1017 | $route = $request->get\_route(); |
  | 1008 | 1018 |  |
  | 1009 | 1019 | // Default to requiring pmpro\_edit\_memberships capability. |
  |  | 1020 | // NOTE: This basically means that anyone with the pmpro\_edit\_memberships capability could potentially do anything made available through the API in this file. |
  | 1010 | 1021 | $permission = current\_user\_can( 'pmpro\_edit\_memberships' ); |
  | 1011 | 1022 |  |
  | 1012 | 1023 | // Check other caps for some routes. |
  | 1013 | 1024 | $route\_caps = array( |
  | 1014 | 1025 | '/pmpro/v1/has\_membership\_access' => 'pmpro\_edit\_memberships', |
  | 1015 | 1026 | '/pmpro/v1/get\_membership\_level\_for\_user' => 'pmpro\_edit\_memberships', |
  | 1016 | 1027 | '/pmpro/v1/get\_membership\_levels\_for\_user' => 'pmpro\_edit\_memberships', |
  | 1017 | 1028 | '/pmpro/v1/change\_membership\_level' => 'pmpro\_edit\_memberships', |
  | 1018 | 1029 | '/pmpro/v1/cancel\_membership\_level' => 'pmpro\_edit\_memberships', |
  | 1019 |  | '/pmpro/v1/membership\_level' => true, |
  |  | 1030 | '/pmpro/v1/membership\_level' => array( |
  |  | 1031 | 'GET' => true, |
  |  | 1032 | 'POST' => 'pmpro\_edit\_memberships', |
  |  | 1033 | 'PUT' => 'pmpro\_edit\_memberships', |
  |  | 1034 | 'PATCH' => 'pmpro\_edit\_memberships', |
  |  | 1035 | 'DELETE' => 'pmpro\_edit\_memberships', |
  |  | 1036 | ), |
  | 1020 | 1037 | '/pmpro/v1/discount\_code' => 'pmpro\_discountcodes', |
  | 1021 | 1038 | '/pmpro/v1/order' => 'pmpro\_orders', |
  | 1022 | 1039 | '/pmpro/v1/checkout\_level' => true, |
  | 1023 | 1040 | '/pmpro/v1/checkout\_levels' => true, |
  | 1024 | 1041 | '/pmpro/v1/me' => true, |
  | 1025 | 1042 | '/pmpro/v1/recent\_memberships' => 'pmpro\_edit\_memberships', |
  | 1026 | 1043 | '/pmpro/v1/recent\_orders' => 'pmpro\_orders' |
  | 1027 | 1044 | ); |
  | 1028 |  | $route\_caps = apply\_filters( 'pmpro\_rest\_api\_route\_capabilities', $route\_caps, $request ); |
  | 1029 |  |  |
  |  | 1045 | $route\_caps = apply\_filters( 'pmpro\_rest\_api\_route\_capabilities', $route\_caps, $request ); |
  |  | 1046 |  |
  |  | 1047 | // Check if we have a specific permission to check for this route/method. |
  | 1030 | 1048 | if ( isset( $route\_caps[$route] ) ) { |
  | 1031 |  | if ( $route\_caps[$route] === true ) { |
  | 1032 |  | // public |
  | 1033 |  | $permission = true; |
  | 1034 |  | } else { |
  | 1035 |  | $permission = current\_user\_can( $route\_caps[$route] ); |
  | 1036 |  | } |
  |  | 1049 | // Find the permission to check. |
  |  | 1050 | if ( is\_array ( $route\_caps[$route] ) && isset( $route\_caps[$route][$method] ) ) { |
  |  | 1051 | // Different permission for this method, use it. |
  |  | 1052 | $permission\_to\_check = $route\_caps[$route][$method]; |
  |  | 1053 | } elseif ( is\_array( $route\_caps[$route] ) ) { |
  |  | 1054 | // No permission for this method, default to false. |
  |  | 1055 | $permission\_to\_check = false; |
  |  | 1056 | } else { |
  |  | 1057 | // Same permission for all methods, use it. |
  |  | 1058 | $permission\_to\_check = $route\_caps[$route]; |
  |  | 1059 | } |
  |  | 1060 |  |
  |  | 1061 | // Check the permission. |
  |  | 1062 | if ( $permission\_to\_check === true || $permission\_to\_check === false ) { |
  |  | 1063 | // For true or false, just pass it along. |
  |  | 1064 | $permission = $permission\_to\_check; |
  |  | 1065 | } else { |
  |  | 1066 | // Check if the current user has this capability. |
  |  | 1067 | $permission = current\_user\_can( $permission ); |
  |  | 1068 | } |
  | 1037 | 1069 | } |
  | 1038 | 1070 |  |
  | 1039 | 1071 | // Is the request method allowed? We disable DELETE by default. |
  | 1040 | 1072 | if ( ! in\_array( $method, pmpro\_get\_rest\_api\_methods( $route ) ) ) { |
  | 1041 | 1073 | $permission = false; |
  | 1042 | 1074 | } |
  | 1043 | 1075 |  |
  | 1044 | 1076 | $permission = apply\_filters( 'pmpro\_rest\_api\_permissions', $permission, $request ); |
  | 1045 | 1077 | return $permission; |
  | 1046 | 1078 | } |
  | 1047 | 1079 |  |
  | 1048 | 1080 | /\*\* |
  | 1049 | 1081 | \*  Helper function to convert comma separated items to an array. |
  | 1050 | 1082 | \* @since 2.3 |
  | 1051 | 1083 | \*/ |
  | 1052 | 1084 | function pmpro\_rest\_api\_convert\_to\_array( $string ) { |
  | 1053 | 1085 | return explode( ',', $string ); |
  | 1054 | 1086 | } |
  | 1055 | 1087 | } // End of class |
  | 1056 | 1088 |  |
  | 1057 | 1089 | /\*\* |
  | 1058 | 1090 | \* Register the routes for Paid Memberships Pro. |
  | 1059 | 1091 | \* @since 2.3 |
  | 1060 | 1092 | \*/ |
  | 1061 | 1093 | function pmpro\_rest\_api\_register\_custom\_routes() { |
  | 1062 | 1094 | $pmpro\_rest\_api\_routes = new PMPro\_REST\_API\_Routes; |
  | 1063 | 1095 | $pmpro\_rest\_api\_routes->pmpro\_rest\_api\_register\_routes(); |
  | 1064 | 1096 | } |
  | 1065 | 1097 |  |
  | 1066 | 1098 | add\_action( 'rest\_api\_init', 'pmpro\_rest\_api\_register\_custom\_routes', 5 ); |
  | 1067 | 1099 | } |
  | 1068 | 1100 |  |
  | 1069 | 1101 |  |
  | 1070 | 1102 | /\*\* |
  | 1071 | 1103 | \* Get the allowed methods for PMPro REST API endpoints. |
  | 1072 | 1104 | \* To enable DELETE, hook into this filter. |
  | 1073 | 1105 | \* @since 2.3 |
  | 1074 | 1106 | \*/ |
  | 1075 | 1107 | function pmpro\_get\_rest\_api\_methods( $route = NULL ) { |
  | 1076 | 1108 | $methods = array( 'GET', 'POST', 'PUT', 'PATCH' ); |
  | 1077 | 1109 | $methods = apply\_filters( 'pmpro\_rest\_api\_methods', $methods, $route ); |
  | 1078 | 1110 | return $methods; |
  | 1079 | 1111 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3011575&old=2947813&new_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php&old_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)
* [Zip Archive](?format=zip&new=3011575&old=2947813&new_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php&old_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_89d68264_20250115_084904.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Paid Memberships Pro <= 2.12.5 - Missing Authorization via API

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Paid Memberships Pro <= 2.12.5 - Missing Authorization via API

5.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2023-6855](https://www.cve.org/CVERecord?id=CVE-2023-6855) |
| --- | --- |
| CVSS | 5.3 (Medium) |
| Publicly Published | December 21, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Webbernaut](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/webbernaut) |

### Description

The Paid Memberships Pro – Content Restriction, User Registration, & Paid Subscriptions plugin for WordPress is vulnerable to unauthorized modification of membership levels created by the plugin due to an incorrectly implemented capability check in the pmpro\_rest\_api\_get\_permissions\_check function in all versions up to 2.12.5 (inclusive). This makes it possible for unauthenticated attackers to change membership levels including prices.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/paid-memberships-pro/trunk/includes/rest-api.php#L528)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/paid-memberships-pro/trunk/includes/rest-api.php#L997)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3011575/paid-memberships-pro/trunk/includes/rest-api.php?contextall=1&old=2947813&old_path=%2Fpaid-memberships-pro%2Ftrunk%2Fincludes%2Frest-api.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2125-missing-authorization-via-api&t=Paid%20Memberships%20Pro%20%3C%3D%202.12.5%20-%20Missing%20Authorization%20via%20API "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2125-missing-authorization-via-api&text=Paid%20Memberships%20Pro%20%3C%3D%202.12.5%20-%20Missing%20Authorization%20via%20API "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fpaid-memberships-pro%2Fpaid-memberships-pro-2125-missing-authorization-via-api "LinkedIn")
Email

## Vulnerability Details for Paid Memberships Pro – Content Restriction, User Registration, & Paid Subscriptions

#### [Paid Memberships Pro – Content Restriction, User Registration, & Paid Subscriptions](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/paid-memberships-pro)

| Software Type | Plugin |
| --- | --- |
| Software Slug | paid-memberships-pro [(view on wordpress.org)](https://wordpress.org/plugins/paid-memberships-pro) |
| Patched? | Yes |
| Remediation | Update to version 2.12.6, or a newer patched version |
| Affected Version | * <= 2.12.5 |
| Patched Version | * 2.12.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


