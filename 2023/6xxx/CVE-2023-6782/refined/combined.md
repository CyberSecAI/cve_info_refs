=== Content from plugins.trac.wordpress.org_6ed5c72d_20250114_230626.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3010797%2540accelerated-mobile-pages%252Ftrunk%26old%3D2998126%2540accelerated-mobile-pages%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2998126/accelerated-mobile-pages/trunk?old=3010797&old_path=%2Faccelerated-mobile-pages%2Ftrunk)

---

# Changes in [accelerated-mobile-pages/trunk](/browser/accelerated-mobile-pages/trunk?rev=3010797 "Show entry in browser") [[2998126:3010797]](/log/accelerated-mobile-pages/trunk?rev=3010797&stop_rev=2998126 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[accelerated-mobile-pages/trunk](/browser/accelerated-mobile-pages/trunk?rev=3010797)
Files:

5 edited

* [README.md](/browser/accelerated-mobile-pages/trunk/README.md?rev=3010797 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))
* [accelerated-moblie-pages.php](/browser/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?rev=3010797 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [changelog.txt](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=3010797 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [readme.txt](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3010797 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [templates/features.php](/browser/accelerated-mobile-pages/trunk/templates/features.php?rev=3010797 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [accelerated-mobile-pages/trunk/README.md](/changeset/3010797/accelerated-mobile-pages/trunk/README.md?old=2998126&old_path=accelerated-mobile-pages%2Ftrunk%2FREADME.md "Show the [2998126:3010797] differences restricted to accelerated-mobile-pages/trunk/README.md")

  | [r2998126](/browser/accelerated-mobile-pages/trunk/README.md?rev=2998126#L4 "Show revision 2998126 of this file in browser") | [r3010797](/browser/accelerated-mobile-pages/trunk/README.md?rev=3010797#L4 "Show revision 3010797 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Donate link: https://www.paypal.me/Kaludi/25 |
  | 5 | 5 | Requires at least: 3.0 |
  | 6 |  | Tested up to: 6.4~~.1~~ |
  | 7 |  | Stable tag: 1.0.92 |
  |  | 6 | Tested up to: 6.4 |
  |  | 7 | Stable tag: 1.0.92.1 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/accelerated-mobile-pages/trunk/README.md?rev=2998126#L199) | […](/browser/accelerated-mobile-pages/trunk/README.md?rev=3010797#L199) |  |
  | 199 | 199 | == Changelog == |
  | 200 | 200 |  |
  |  | 201 | = 1.0.92.1 (16th December 2023) = |
  |  | 202 | \* Fixed:  Cross-Site Scripting issue on shortcode [amp-gist] for contributer+ access (Reported by Wordfence) |
  |  | 203 |  |
  | 201 | 204 | = 1.0.92 (18th November 2023) = |
  | 202 | 205 | \* New: Compatibility with Publytics.net #5477 |
* ## [accelerated-mobile-pages/trunk/accelerated-moblie-pages.php](/changeset/3010797/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?old=2998126&old_path=accelerated-mobile-pages%2Ftrunk%2Faccelerated-moblie-pages.php "Show the [2998126:3010797] differences restricted to accelerated-mobile-pages/trunk/accelerated-moblie-pages.php")

  | [r2998126](/browser/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?rev=2998126#L4 "Show revision 2998126 of this file in browser") | [r3010797](/browser/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?rev=3010797#L4 "Show revision 3010797 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Plugin URI: https://wordpress.org/plugins/accelerated-mobile-pages/ |
  | 5 | 5 | Description: AMP for WP - Accelerated Mobile Pages for WordPress |
  | 6 |  | Version: 1.0.92 |
  |  | 6 | Version: 1.0.92.1 |
  | 7 | 7 | Author: Ahmed Kaludi, Mohammed Kaludi |
  | 8 | 8 | Author URI: https://ampforwp.com/ |
  | […](/browser/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?rev=2998126#L21) | […](/browser/accelerated-mobile-pages/trunk/accelerated-moblie-pages.php?rev=3010797#L21) |  |
  | 21 | 21 | define('AMPFORWP\_IMAGE\_DIR',plugin\_dir\_url(\_\_FILE\_\_).'images'); |
  | 22 | 22 | define('AMPFORWP\_MAIN\_PLUGIN\_DIR', plugin\_dir\_path( \_\_DIR\_\_ ) ); |
  | 23 |  | define('AMPFORWP\_VERSION','1.0.92'); |
  |  | 23 | define('AMPFORWP\_VERSION','1.0.92.1'); |
  | 24 | 24 | define('AMPFORWP\_EXTENSION\_DIR',plugin\_dir\_path(\_\_FILE\_\_).'includes/options/extensions'); |
  | 25 | 25 | define('AMPFORWP\_ANALYTICS\_URL',plugin\_dir\_url(\_\_FILE\_\_).'includes/features/analytics'); |
* ## [accelerated-mobile-pages/trunk/changelog.txt](/changeset/3010797/accelerated-mobile-pages/trunk/changelog.txt?old=2998126&old_path=accelerated-mobile-pages%2Ftrunk%2Fchangelog.txt "Show the [2998126:3010797] differences restricted to accelerated-mobile-pages/trunk/changelog.txt")

  | [r2998126](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=2998126#L1 "Show revision 2998126 of this file in browser") | [r3010797](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=3010797#L1 "Show revision 3010797 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | == Changelog == |
  |  | 2 |  |
  |  | 3 | = 1.0.92.1 (16th December 2023) = |
  |  | 4 | \* Fixed:  Cross-Site Scripting issue on shortcode [amp-gist] for contributer+ access (Reported by Wordfence) |
  | 2 | 5 |  |
  | 3 | 6 | = 1.0.92 (18th November 2023) = |
* ## [accelerated-mobile-pages/trunk/readme.txt](/changeset/3010797/accelerated-mobile-pages/trunk/readme.txt?old=2998126&old_path=accelerated-mobile-pages%2Ftrunk%2Freadme.txt "Show the [2998126:3010797] differences restricted to accelerated-mobile-pages/trunk/readme.txt")

  | [r2998126](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=2998126#L4 "Show revision 2998126 of this file in browser") | [r3010797](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3010797#L4 "Show revision 3010797 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Donate link: https://www.paypal.me/Kaludi/25 |
  | 5 | 5 | Requires at least: 3.0 |
  | 6 |  | Tested up to: 6.4~~.1~~ |
  | 7 |  | Stable tag: 1.0.92 |
  |  | 6 | Tested up to: 6.4 |
  |  | 7 | Stable tag: 1.0.92.1 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=2998126#L196) | […](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3010797#L196) |  |
  | 196 | 196 | == Changelog == |
  | 197 | 197 |  |
  |  | 198 | = 1.0.92.1 (16th December 2023) = |
  |  | 199 | \* Fixed:  Cross-Site Scripting issue on shortcode [amp-gist] for contributer+ access (Reported by Wordfence) |
  |  | 200 |  |
  | 198 | 201 | = 1.0.92 (18th November 2023) = |
  | 199 | 202 | \* New: Compatibility with Publytics.net #5477 |
* ## [accelerated-mobile-pages/trunk/templates/features.php](/changeset/3010797/accelerated-mobile-pages/trunk/templates/features.php?old=2998126&old_path=accelerated-mobile-pages%2Ftrunk%2Ftemplates%2Ffeatures.php "Show the [2998126:3010797] differences restricted to accelerated-mobile-pages/trunk/templates/features.php")

  | [r2998126](/browser/accelerated-mobile-pages/trunk/templates/features.php?rev=2998126#L3608 "Show revision 2998126 of this file in browser") | [r3010797](/browser/accelerated-mobile-pages/trunk/templates/features.php?rev=3010797#L3608 "Show revision 3010797 of this file in browser") |  |
  | --- | --- | --- |
  | 3608 | 3608 | $height = '250'; |
  | 3609 | 3609 | } |
  | 3610 |  | return '<amp-gist data-gistid='. esc\_attr($atts['id']) .' |
  |  | 3610 | // adding sanitization for gist id |
  |  | 3611 | $sanitized\_id = preg\_replace('/[^a-z0-9\-]/', '', $atts['id']); |
  |  | 3612 | if($sanitized\_id){ |
  |  | 3613 | return '<amp-gist data-gistid='. esc\_attr($sanitized\_id) .' |
  | 3611 | 3614 | layout="fixed-height" |
  | 3612 | 3615 | height="'. esc\_attr($height) .'"> |
  | 3613 | 3616 | </amp-gist>'; |
  |  | 3617 | } |
  |  | 3618 |  |
  | 3614 | 3619 | } |
  | 3615 | 3620 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3010797&old=2998126&new_path=%2Faccelerated-mobile-pages%2Ftrunk&old_path=%2Faccelerated-mobile-pages%2Ftrunk)
* [Zip Archive](?format=zip&new=3010797&old=2998126&new_path=%2Faccelerated-mobile-pages%2Ftrunk&old_path=%2Faccelerated-mobile-pages%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_3f3942a7_20250114_230628.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AMP for WP – Accelerated Mobile Pages <= 1.0.92 - Authenticated (Contributor+) Cross-Site Scripting via Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AMP for WP – Accelerated Mobile Pages <= 1.0.92 - Authenticated (Contributor+) Cross-Site Scripting via Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2023-6782](https://www.cve.org/CVERecord?id=CVE-2023-6782) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | December 18, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Ngô Thiên An (ancorn\_) - VNPT-VCI](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/ngo-thien-an-ancorn) |

### Description

The AMP for WP – Accelerated Mobile Pages plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the plugin's shortcode(s) in all versions up to, and including, 1.0.92 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers with contributor-level and above permissions to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.svn.wordpress.org](https://plugins.svn.wordpress.org/accelerated-mobile-pages/trunk/templates/features.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&new=3010797%40accelerated-mobile-pages%2Ftrunk&old=2998126%40accelerated-mobile-pages%2Ftrunk&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-1092-authenticated-contributor-cross-site-scripting-via-shortcode&t=AMP%20for%20WP%20%E2%80%93%20Accelerated%20Mobile%20Pages%20%3C%3D%201.0.92%20-%20Authenticated%20%28Contributor%2B%29%20Cross-Site%20Scripting%20via%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-1092-authenticated-contributor-cross-site-scripting-via-shortcode&text=AMP%20for%20WP%20%E2%80%93%20Accelerated%20Mobile%20Pages%20%3C%3D%201.0.92%20-%20Authenticated%20%28Contributor%2B%29%20Cross-Site%20Scripting%20via%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-1092-authenticated-contributor-cross-site-scripting-via-shortcode "LinkedIn")
Email

## Vulnerability Details for AMP for WP – Accelerated Mobile Pages

#### [AMP for WP – Accelerated Mobile Pages](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/accelerated-mobile-pages)

| Software Type | Plugin |
| --- | --- |
| Software Slug | accelerated-mobile-pages [(view on wordpress.org)](https://wordpress.org/plugins/accelerated-mobile-pages) |
| Patched? | Yes |
| Remediation | Update to version 1.0.92.1, or a newer patched version |
| Affected Version | * <= 1.0.92 |
| Patched Version | * 1.0.92.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.svn.wordpress.org_7d99f367_20250114_230624.html ===
php
use AMPforWP\AMPVendor\AMP\_Content;
// Exit if accessed directly
if ( ! defined( 'ABSPATH' ) ) {
exit;
}
/\* This file will contain all the Extra FEATURES.
0.9. AMP Design Manager Files
1. Add Home REL canonical
2. Custom Design
3. Custom Style files
4. Custom Header files
4.1 Custom Meta-Author files
4.2 Custom Meta-Taxonomy files
4.5 Added hook to add more layout.
5. Customize with Width of the site
6. Add required Javascripts for extra AMP features
6.1 Adding Analytics Scripts
7. Footer for AMP Pages
8. Add Main tag as a Wrapper ( removed in 0.8.9 )
9. Advertisement code
10. Analytics Area
10.1 Analytics Support added for Google Analytics
10.2 Analytics Support added for segment.com
10.3 Analytics Support added for Piwik
10.4 Analytics Support added for quantcast
10.5 Analytics Support added for comscore
10.6 Analytics Support added for Effective Measure
10.7 Analytics Support added for StatCounter
10.8 Analytics Support added for Histats Analytics
10.9 Analytics Support added for Yandex Metrika
10.10 Analytics Support added for Chartbeat Analytics
10.11 Analytics Support added for Alexa Metrics
11. Strip unwanted codes and tags from the\_content
12. Add Logo URL in the structured metadata
13. Add Custom Placeholder Image for Structured Data.
14. Adds a meta box to the post editing screen for AMP on-off on specific pages.
15. Disable New Relic's extra script that its adds in AMP pages.
16. Remove Unwanted Scripts
17. Archives Canonical in AMP version
18. Custom Canonical for Homepage
19. Remove Canonical tags
20. Remove the default Google font for performance ( removed in 0.8.9 )
21. Remove Schema data from All In One Schema.org Rich Snippets Plugin
22. Removing author links from comments Issue #180
23. The analytics tag appears more than once in the document. This will soon be an error
24. Seperate Sticky Single Social Icons
25. Yoast meta Support
26. Extending Title Tagand De-Hooking the Standard one from AMP
27. Fixing the defer tag issue [Finally!]
28. Properly removes AMP if turned off from Post panel
29. Remove analytics code if Already added by Glue or Yoast SEO
30. TagDiv menu issue removed
31. removing scripts added by cleantalk
32. various lazy loading plugins Support
33. Google tag manager support added
34. social share boost compatibility Ticket #387
35. Disqus Comments Support
36. remove photon support in AMP
37. compatibility with wp-html-compression
38. #529 editable archives
39. #560 Header and Footer Editable html enabled script area
40. Meta Robots
41. Rewrite URL only on save #511
42. registeing AMP sidebars
43. custom actions for widgets output
44. auto adding /amp for the menu
45. search,frontpage,homepage structured data
46. search search search everywhere #615
47. social js properly adding when required
48. Remove all unwanted scripts on search pages
49. Properly adding ad Script the AMP way
50. Properly adding noditification Scritps the AMP way
51. Adding Digg Digg compatibility with AMP
52. Adding a generalized sanitizer function for purifiying normal html to amp-html
53. Removed AMP-WooCommerce Code and added it in AMP-WooCommerce #929
54. Change the default values of post meta for AMP pages.
55. Call Now Button Feature added
56. Multi Translation Feature #540
57. Adding Updated date at in the Content
58. YouTube Shortcode compatablity with AMP #557
59. Comment Button URL
60. Remove Category Layout modification code added by TagDiv #842 and #796
61. Add Gist Support
62. Adding Meta viewport via hook instead of direct #878
63. Frontpage Comments #682
64. PageBuilder
65. Remove Filters code added through Class by other plugins
66. Make AMP compatible with Squirrly SEO
69. Post Pagination #834 #857
70. Hide AMP by specific Categories #872
71. Alt tag for thumbnails #1013 and For Post ID in Body tag #1006
72. Blacklist Sanitizer Added back #1024
73. View AMP Site below View Site In Dashboard #1076
74. Featured Image check from Custom Fields
75. Dev Mode in AMP
76. Body Class for AMP pages
77. AMP Blog Details
78. Saved Custom Post Types for AMP in Options for Structured Data
79. Favicon for AMP
80. Mobile Preview styling
81. Duplicate Featured Image Support
82. Grab Featured Image from The Content
83. Advance Analytics(Google Analytics)
84. Inline Related Posts
85. Caption for Gallery Images
86. minify the content of pages
87. Post Thumbnail
88. Author Details
89. Facebook Pixel
90. Set Header last modified information
91. Comment Author Gravatar URL
92. View AMP in Admin Bar
93. added AMP url purifire for amphtml
94. OneSignal Push Notifications
95. Modify menu link attributes for SiteNavigationElement Schema Markup #1229 #1345
96. ampforwp\_is\_front\_page() ampforwp\_is\_home() and ampforwp\_is\_blog is created
97. Change the format of the post date on Loops #1384
98. Create Dynamic url of amp according to the permalink structure #1318
99. Merriweather Font Management
100. Flags compatibility in Menu
101. Function for Logo attributes
102. SD Feature Image Guidlines #2838
\*/
// AMP Components
// AMP LOGO
add\_amp\_theme\_support('AMP-logo');
// AMP Loop
add\_amp\_theme\_support('AMP-loop');
// GDPR
if(ampforwp\_get\_setting('amp-gdpr-compliance-switch')) {
add\_amp\_theme\_support('AMP-gdpr');
}
// Menu
add\_amp\_theme\_support('AMP-menu');
// Adding AMP-related things to the main theme
global $redux\_builder\_amp;
// 0.9. AMP Design Manager Files
require AMPFORWP\_PLUGIN\_DIR .'templates/design-manager.php';
// Custom Frontpage items
require AMPFORWP\_PLUGIN\_DIR .'templates/frontpage-elements.php';
require AMPFORWP\_PLUGIN\_DIR . '/classes/class-ampforwp-youtube-embed.php' ;
// Custom Post Types
require AMPFORWP\_PLUGIN\_DIR .'templates/ampforwp-custom-post-type.php';
if ((true == ampforwp\_get\_setting('ampforwp-infinite-scroll-single')) && (true == ampforwp\_get\_setting('ampforwp-infinite-scroll') || true == ampforwp\_get\_setting('ampforwp-wcp-infinite-scroll') ) ) {
require AMPFORWP\_PLUGIN\_DIR .'templates/ampforwp-infinite-scroll-select-post-meta.php';
}
// TODO: Update this function
function ampforwp\_include\_customizer\_files(){
global $redux\_builder\_amp;
$amp\_plugin\_data;
$amp\_plugin\_activation\_check;
include\_once( ABSPATH . 'wp-admin/includes/plugin.php' );
$amp\_plugin\_activation\_check = is\_plugin\_active( 'amp/amp.php' );
if ( isset ($redux\_builder\_amp['amp-design-selector']) && 4 != $redux\_builder\_amp['amp-design-selector'] ) {
return require AMPFORWP\_PLUGIN\_DIR .'templates/customizer/customizer.php' ;
}
}
ampforwp\_include\_customizer\_files();
//0.
define('AMPFORWP\_COMMENTS\_PER\_PAGE', ampforwp\_define\_comments\_number() );
// Define number of comments
function ampforwp\_define\_comments\_number(){
global $redux\_builder\_amp;
$number\_of\_comments = '';
if(isset($redux\_builder\_amp['ampforwp-number-of-comments'])){
$number\_of\_comments = $redux\_builder\_amp['ampforwp-number-of-comments'];
}
return $number\_of\_comments;
}
// 1. Add Home REL canonical
// Add AMP rel-canonical for home and archive pages
add\_action('amp\_init','ampforwp\_allow\_homepage');
function ampforwp\_allow\_homepage() {
add\_action( 'wp', 'ampforwp\_add\_endpoint\_actions' );
}
function ampforwp\_add\_endpoint\_actions() {
$ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint();
if ( $ampforwp\_is\_amp\_endpoint ) {
AMPforWP\AMPVendor\amp\_prepare\_render();
} else {
add\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
}
$cpage\_var = get\_query\_var('cpage');
if ( $cpage\_var = 1) :
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
endif;
}
function ampforwp\_amphtml\_generator(){
global $redux\_builder\_amp;
global $wp, $post;
$post\_id = '';
$endpoint\_check = false;
$endpoint\_check = ampforwp\_get\_setting('amp-core-end-point');
if( is\_attachment() ) {
return;
}
if(get\_query\_var('paged') && true == ampforwp\_get\_setting('amp-paginated-pages-indexing')) {
return;
}
if( is\_home() && is\_front\_page() && !ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) {
return;
}
if( is\_front\_page() && ! ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) {
return;
}
// HIDE/SHOW TAG AND CATEGORY #4326
if(is\_tag() || is\_category() || is\_tax()){
$amp\_queried\_object = get\_queried\_object();
if (is\_object($amp\_queried\_object) && property\_exists($amp\_queried\_object, 'term\_id'))
{
$term\_id = $amp\_queried\_object->term\_id;
$tax\_status = ampforwp\_get\_taxonomy\_meta($term\_id,'status');
if($tax\_status==false){
return;
}
}else{
return;
}
}else if(is\_single()){
$tax\_status = ampforwp\_get\_taxonomy\_meta('','post\_status');
if($tax\_status==false){
return;
}
}
// Skip this condition for woocommerce product archive and shop pages.
if( function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') && (function\_exists('is\_product\_category') && !is\_product\_category()) && (function\_exists('is\_product\_tag') && !is\_product\_tag()) && (function\_exists('is\_shop') && !is\_shop() ) ){
if( is\_archive() && ( !ampforwp\_get\_setting('ampforwp-archive-support') || ( is\_category() && !ampforwp\_get\_setting('ampforwp-archive-support-cat') ) || ( is\_tag() && !ampforwp\_get\_setting('ampforwp-archive-support-tag') ))){
return;
}
}
// When amp woocommerce pro plugin is not active.
if ( is\_archive() && !function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') ) {
if(!ampforwp\_get\_setting('ampforwp-archive-support')){
return;
}
if( is\_category() && !ampforwp\_get\_setting('ampforwp-archive-support-cat') ){
return;
}
if( is\_tag() && !ampforwp\_get\_setting('ampforwp-archive-support-tag') ){
return;
}
}
// #1192 Password Protected posts exclusion
if(post\_password\_required( $post )){
return;
}
// #2018 404 exclusion
if(is\_404()){
return;
}
// #1443 AMP should be skip on the check out page
if(class\_exists( 'WooCommerce' )){
if(function\_exists('is\_checkout') && is\_checkout()){
return;
}
if(function\_exists('is\_account\_page') && is\_account\_page()){
return;
}
}
// Search results on/off option #3786
if(is\_search() && 0 == ampforwp\_get\_setting('amp-redirection-search')){
return;
}
if(function\_exists('yith\_wishlist\_constructor')){
$class = get\_body\_class();
if(in\_array("woocommerce-wishlist", $class)){
return;
}
}
// #872 no-amphtml if selected as hide from settings
if ( is\_category\_amp\_disabled() ) {
return;
}
if ( is\_page() && ! ampforwp\_get\_setting('amp-on-off-for-all-pages') && ! is\_home() && ! is\_front\_page() ) {
return;
}
if ( is\_home() && ! ampforwp\_is\_blog() && !ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) {
return;
}
if(is\_author()){
$amp\_auth\_url = ampforwp\_get\_author\_page\_url();
return esc\_url\_raw($amp\_auth\_url);
}
if (!ampforwp\_is\_home() && !ampforwp\_is\_front\_page() && !ampforwp\_is\_blog() && !is\_category() && !is\_tag() && !is\_singular( array('page', 'attachment', 'post')) && !function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support')){
global $post\_type;
if (empty(ampforwp\_get\_setting('ampforwp-custom-type'))) {
return;
}
}
$page\_for\_posts = intval(get\_option( 'page\_for\_posts' ));
$post\_id = ampforwp\_get\_the\_ID();
if ( ampforwp\_is\_blog() && ! ampforwp\_get\_setting('amp-on-off-for-all-pages') && ($page\_for\_posts != $post\_id ) ) {
return;
}
$query\_arg\_array = $wp->query\_vars;
if( in\_array( "cpage" , $query\_arg\_array ) ) {
if( is\_front\_page() && $wp->query\_vars['cpage'] >= '2' ) {
return;
}
if( is\_singular() && $wp->query\_vars['cpage'] >= '2' ) {
return;
}
}
if ( is\_home() || is\_front\_page() || is\_archive() ){
global $wp;
$current\_archive\_url = home\_url( $wp->request );
// If its custom permalink with /index.php/ #3279
if ( is\_archive() && false !== strpos($wp->matched\_rule, 'index.php') && false === strpos($current\_archive\_url, 'index.php') ) {
$current\_archive\_url = home\_url( 'index.php/' . $wp->request );
}
$amp\_url = trailingslashit($current\_archive\_url);
if ($endpoint\_check && (is\_tax() || is\_post\_type\_archive())) {
$amp\_url = ampforwp\_url\_controller($amp\_url);
}
} else {
$amp\_url = AMPforWP\AMPVendor\amp\_get\_permalink( get\_queried\_object\_id() );
}
global $post;
if ( is\_singular() ) {
$post\_id = get\_the\_ID();
}
if ( ampforwp\_is\_blog() ) {
$post\_id = ampforwp\_get\_blog\_details('id');
}
$ampforwp\_amp\_post\_on\_off\_meta = get\_post\_meta( $post\_id,'ampforwp-amp-on-off',true);
if ( ( is\_singular() || ampforwp\_is\_blog() ) && $ampforwp\_amp\_post\_on\_off\_meta === 'hide-amp' ) {
//dont Echo anything
} else {
$supported\_types = ampforwp\_get\_all\_post\_types();
if(isset($supported\_types['web-story'])){
$supported\_types['web-story'] = '';
}
$supported\_types = apply\_filters('get\_amp\_supported\_post\_types',$supported\_types);
$type = get\_post\_type();
if(is\_home() || is\_front\_page()){
if( ampforwp\_get\_setting('ampforwp-homepage-on-off-support') == 1
&& ampforwp\_get\_setting('amp-on-off-for-all-posts') == 0
&& ampforwp\_get\_setting('amp-on-off-for-all-pages') == 0 ){
$supported\_types['post'] = 'post';
}
}
$supported\_amp\_post\_types = in\_array( $type , $supported\_types );
$query\_arg\_array = $wp->query\_vars;
if( array\_key\_exists( 'paged' , $query\_arg\_array ) ) {
if ( (is\_home() || is\_archive()) && $wp->query\_vars['paged'] >= '2' ) {
$new\_url = home\_url('/');
// If its custom permalink with /index.php/ #3537
if ( (is\_home() || is\_archive()) && false !== strpos($wp->matched\_rule, 'index.php') && false === strpos( home\_url( $wp->request ), 'index.php') ) {
$new\_url = home\_url( 'index.php' );
$o\_url = home\_url();
$new\_url = str\_replace($o\_url, $new\_url, $amp\_url);
$new\_url = user\_trailingslashit($new\_url);
$amp\_url = $new\_url;
}
$category\_path = $wp->request;
if ( null != $category\_path && true != $endpoint\_check) {
$explode\_path = explode("/",$category\_path);
$inserted = array(AMPFORWP\_AMP\_QUERY\_VAR);
array\_splice( $explode\_path, -2, 0, $inserted );
$impode\_url = implode('/', $explode\_path);
$amp\_url = $new\_url . $impode\_url ;
}
}
if( is\_search() && $wp->query\_vars['paged'] >= '2' ) {
$current\_search\_url =trailingslashit(get\_home\_url()) . $wp->request .'/'."?amp=1&s=".get\_search\_query();
}
}
if (!$endpoint\_check) {
$amp\_url = user\_trailingslashit($amp\_url);
}
if( is\_search() ) {
$current\_search\_url =trailingslashit(get\_home\_url())."?amp=1&s=".get\_search\_query();
$amp\_url = untrailingslashit($current\_search\_url);
}
// URL Purifier
if(!ampforwp\_get\_setting('amp-core-end-point') && !ampforwp\_get\_setting('ampforwp-amp-takeover')){
$amp\_url = ampforwp\_url\_purifier($amp\_url);
}
if(true == ampforwp\_get\_setting('amp-core-end-point') && (!is\_home() && !is\_front\_page() && !is\_archive())){
$amp\_url = add\_query\_arg( 'amp', '', get\_the\_permalink() );
}
if( $supported\_amp\_post\_types || ampforwp\_is\_front\_page() ) {
if(true == ampforwp\_get\_setting('amp-core-end-point')){
if( class\_exists('SitePress') ){
if( get\_option('permalink\_structure') ){
global $sitepress\_settings, $wp;
$wpml\_lang\_checker = false;
if($sitepress\_settings[ 'language\_negotiation\_type' ] == 3){
$amp\_url = esc\_url($amp\_url);
$active\_langs = $sitepress\_settings['active\_languages'];
foreach ($active\_langs as $active\_lang) {
if (preg\_match('/\?lang='.$active\_lang.'/', $amp\_url)){
$amp\_url = preg\_replace('/&amp=1/', '', $amp\_url);
$amp\_url = preg\_replace('/#038;amp/', '', $amp\_url);
$amp\_url = str\_replace('?lang='.$active\_lang, '?amp=1', $amp\_url);
$amp\_url = add\_query\_arg( 'lang',$active\_lang, $amp\_url);
}
}
}
}
}
}
if (is\_category() && class\_exists('WPSEO\_Options') && method\_exists('WPSEO\_Options', 'get') && WPSEO\_Options::get( 'stripcategorybase' ) == true && false == ampforwp\_get\_setting('ampforwp-category-base-removel-link')) {
return;
}
if (is\_category() && class\_exists('RankMath') && RankMath\Helper::get\_settings( 'general.strip\_category\_base' ) == true && false == ampforwp\_get\_setting('ampforwp-category-base-removel-link')) {
return;
}
if (is\_preview()) {
$amp\_url = preg\_replace('/(.\*?)&(.\*?)/', '$1&&$2', $amp\_url);
}
if(ampforwp\_get\_setting('amp-core-end-point') && ampforwp\_get\_setting('ampforwp-amp-takeover') && is\_singular()){
$amp\_url = get\_the\_permalink();
}else if(ampforwp\_get\_setting('amp-core-end-point') && (ampforwp\_is\_home() || ampforwp\_is\_front\_page() || ampforwp\_is\_blog() || is\_category() || is\_tag() || is\_front\_page())){
$amp\_url = ampforwp\_url\_controller($amp\_url);
}
$amp\_url = apply\_filters('ampforwp\_modify\_rel\_canonical',$amp\_url);
return esc\_url\_raw($amp\_url);
}
}
return;
}
// AMPHTML when using custom page and then creating a blog page
add\_action('amp\_init','ampforwp\_allow\_homepage\_as\_blog');
function ampforwp\_allow\_homepage\_as\_blog() {
if(function\_exists('mfn\_opts\_setup')){
remove\_action( 'pre\_get\_posts', 'mfn\_search' );
}
add\_action( 'wp', 'ampforwp\_static\_blog' , 11 );
}
function ampforwp\_static\_blog(){
global $page;
$modify\_canonical = ampforwp\_is\_front\_page();
$get\_front\_page\_reading\_settings = get\_option('page\_on\_front');
// Homepage support on
$get\_amp\_homepage\_support = ampforwp\_get\_setting('ampforwp-homepage-on-off-support');
if ( 'page' == get\_option( 'show\_on\_front') && is\_front\_page() && $get\_front\_page\_reading\_settings && $get\_amp\_homepage\_support ){
$modify\_canonical = true;
}
if ( true == $modify\_canonical && $page >= 2 && is\_page() && false == ampforwp\_get\_setting('amp-core-end-point') ) {
add\_filter('ampforwp\_modify\_rel\_canonical','ampforwp\_modify\_amphtml\_static\_blog');
}
}
function ampforwp\_modify\_amphtml\_static\_blog($amp\_url) {
$explode\_url = $amp\_endpoint = $offset = "";
$explode\_url = explode('/', $amp\_url);
$explode\_url = array\_flip($explode\_url);
unset($explode\_url[AMPFORWP\_AMP\_QUERY\_VAR]);
$explode\_url = array\_flip($explode\_url);
$amp\_endpoint = array(AMPFORWP\_AMP\_QUERY\_VAR);
$offset = count($explode\_url) - 2;
array\_splice( $explode\_url, $offset, 0, $amp\_endpoint );
$amp\_url = implode('/', $explode\_url);
return $amp\_url;
}
function ampforwp\_home\_archive\_rel\_canonical() {
$amp\_url = "";
$amp\_url = ampforwp\_amphtml\_generator();
if ( $amp\_url ) {
printf('', esc\_url($amp\_url));
if(false==ampforwp\_get\_setting('hide-amp-version-from-source')){
printf('', esc\_html\_\_( 'AMP for WP', 'accelerated-mobile-pages' ), esc\_attr(AMPFORWP\_VERSION) );
}
}
} //end of ampforwp\_home\_archive\_rel\_canonical()
// Remove default wordpress rel canonical
add\_filter('amp\_frontend\_show\_canonical','ampforwp\_remove\_default\_canonical');
if (! function\_exists('ampforwp\_remove\_default\_canonical') ) {
function ampforwp\_remove\_default\_canonical() {
return false;
}
}
// 2. Custom Design
// Add Homepage AMP file code
add\_filter( 'amp\_post\_template\_file', 'ampforwp\_custom\_template', 10, 3 );
function ampforwp\_custom\_template( $file, $type, $post ) {
global $redux\_builder\_amp;
// Custom Homepage and Archive file
$slug = array();
$current\_url\_in\_pieces = array();
$ampforwp\_custom\_post\_page = ampforwp\_custom\_post\_page();
if ( 'single' === $type ) {
// Homepage and FrontPage
if ( is\_home() || ( true == $redux\_builder\_amp['ampforwp-amp-takeover'] && is\_front\_page() ) ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/index.php';
}
if ( ampforwp\_is\_blog() ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/index.php';
}
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
if ( ampforwp\_is\_front\_page() || ( (true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) && is\_front\_page() && ampforwp\_get\_setting('amp-frontpage-select-option')) ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/frontpage.php';
}
// Archive Pages
if ( is\_archive() && $redux\_builder\_amp['ampforwp-archive-support'] && 'single' === $type ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/archive.php';
}
// Search pages
if ( is\_search() ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/search.php';
}
// 404 Pages #2042
if ( is\_404() && 'single' === $type ) {
add\_filter('ampforwp\_modify\_rel\_url','ampforwp\_404\_canonical');
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/404.php';
}
}
// Polylang compatibility
// For Frontpage
if ( 'single' === $type && ampforwp\_polylang\_front\_page() && true == $redux\_builder\_amp['amp-frontpage-select-option'] ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/frontpage.php';
}
return $file;
}
add\_filter('amp\_post\_template\_dir','ampforwp\_new\_dir');
function ampforwp\_new\_dir( $dir ) {
global $redux\_builder\_amp;
if ( 1 == $redux\_builder\_amp['amp-design-selector'] || 2 == $redux\_builder\_amp['amp-design-selector'] || 3 == $redux\_builder\_amp['amp-design-selector'] ) {
$dir = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector();
}
else {
$dir = AMPFORWP\_CUSTOM\_THEME;
}
return $dir;
}
//3.5
add\_filter( 'amp\_post\_template\_file', 'ampforwp\_empty\_filter', 10, 3 );
function ampforwp\_empty\_filter( $file, $type, $post ) {
if ( 'empty-filter' === $type ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/empty-filter.php';
}
return $file;
}
// 4. Custom Header files
add\_filter( 'amp\_post\_template\_file', 'ampforwp\_custom\_header', 10, 3 );
function ampforwp\_custom\_header( $file, $type, $post ) {
if ( 'header-bar' === $type ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/header-bar.php';
}
return $file;
}
// 4.1 Custom Meta-Author files
add\_filter( 'amp\_post\_template\_file', 'ampforwp\_set\_custom\_meta\_author', 10, 3 );
function ampforwp\_set\_custom\_meta\_author( $file, $type, $post ) {
if ( 'meta-author' === $type ) {
$file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/empty-filter.php';
}
return $file;
}
// 4.2 Custom Meta-Taxonomy files
add\_filter( 'amp\_post\_template\_file', 'ampforwp\_set\_custom\_meta\_taxonomy', 10, 3 );
function ampforwp\_set\_custom\_meta\_taxonomy( $file, $type, $post ) {
if ( 'meta-taxonomy' === $type ) {
$file = AMPFORWP\_PLUGIN\_DIR . 'templates/design-manager/empty-filter.php';
}
return $file;
}
// 5. Customize with Width of the site
add\_filter( 'amp\_content\_max\_width', 'ampforwp\_change\_content\_width' );
function ampforwp\_change\_content\_width( $content\_max\_width ) {
return 1000;
}
// 6. Add required Javascripts for extra AMP features
// Code updated and added the JS proper way #336
add\_filter('amp\_post\_template\_data','ampforwp\_add\_amp\_social\_share\_script', 20);
function ampforwp\_add\_amp\_social\_share\_script( $data ){
global $redux\_builder\_amp;
$social\_check = $social\_check\_page = false;
if ( is\_page() && isset($redux\_builder\_amp['ampforwp-page-social']) && $redux\_builder\_amp['ampforwp-page-social'] ) {
$social\_check\_page = true;
}
if ( 4 == ampforwp\_get\_setting('amp-design-selector') ) {
$social\_check = true;
}
if ( '4' !== ampforwp\_get\_setting('amp-design-selector') && defined('AMPFORWP\_DM\_SOCIAL\_CHECK') && 'true' === AMPFORWP\_DM\_SOCIAL\_CHECK ) {
$social\_check = true;
}
if( ampforwp\_get\_setting('enable-single-social-icons') == true || defined('AMPFORWP\_DM\_SOCIAL\_CHECK') && AMPFORWP\_DM\_SOCIAL\_CHECK === 'true' ) {
if( (is\_singular() || $social\_check\_page ) && is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp() ) {
if ( empty( $data['amp\_component\_scripts']['amp-social-share'] ) ) {
$data['amp\_component\_scripts']['amp-social-share'] = 'https://cdn.ampproject.org/v0/amp-social-share-0.1.js';
}
}
}
// Facebook Like Script
$fb\_like = false;
$isBBPress = (function\_exists('is\_bbpress') ? is\_bbpress() : false );
if ( true == ampforwp\_get\_setting('ampforwp-facebook-like-button') ){
if ( is\_single() && ( true == ampforwp\_get\_setting('enable-single-social-icons') || (true == ampforwp\_get\_setting('ampforwp-social-share') && $social\_check) ) && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && !$isBBPress) {
$fb\_like = true;
}
if ( is\_page() && ( true == ampforwp\_get\_setting('ampforwp-page-sticky-social') || ( $social\_check\_page && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) ) ) ) {
$fb\_like = true;
}
if ( true == ampforwp\_get\_setting('enable-single-social-icons') && checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && is\_singular()) {
$fb\_like = true;
}
}
if ( true == $fb\_like ) {
if(empty($data['amp\_component\_scripts']['amp-facebook-like'])){
$data['amp\_component\_scripts']['amp-facebook-like'] = 'https://cdn.ampproject.org/v0/amp-facebook-like-0.1.js';
}
}
return $data;
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_amp\_related\_scripts', 20 );
function ampforwp\_add\_amp\_related\_scripts( $data ) {
global $redux\_builder\_amp;
// Adding Sidebar Script
if ( isset($redux\_builder\_amp['ampforwp-amp-menu']) && $redux\_builder\_amp['ampforwp-amp-menu'] && 4 != $redux\_builder\_amp['amp-design-selector'] ) {
if ( empty( $data['amp\_component\_scripts']['amp-sidebar'] ) ) {
$data['amp\_component\_scripts']['amp-sidebar'] = 'https://cdn.ampproject.org/v0/amp-sidebar-0.1.js';
}
}
return $data;
}
// 8. Add Main tag as a Wrapper
// Removed this code after moving to design manager
// 9. Advertisement code
// Moved to ads-functions.php
// 10. Analytics Area
// Moved to analytics-functions.php
// 11. Strip unwanted codes and tags from the\_content
add\_action( 'pre\_amp\_render\_post','ampforwp\_strip\_invalid\_content');
function ampforwp\_strip\_invalid\_content() {
add\_filter( 'the\_content', 'ampforwp\_the\_content\_filter', 2 );
}
function ampforwp\_the\_content\_filter( $content ) {
$content = preg\_replace('/property=[^>]\*/', '', $content);
$content = preg\_replace('/vocab=[^>]\*/', '', $content);
$content = preg\_replace('/noshade=[^>]\*/', '', $content);
$content = preg\_replace('/contenteditable=[^>]\*/', '', $content);
$content = preg\_replace('/non-refundable=[^>]\*/', '', $content);
$content = preg\_replace('/security=[^>]\*/', '', $content);
$content = preg\_replace('/deposit=[^>]\*/', '', $content);
$content = preg\_replace('/nowrap="nowrap"/', '', $content);
$content = preg\_replace('#(.\*?)#i', '', $content);
$content = preg\_replace('#(.\*?)#i', '', $content);
$content = preg\_replace('#(.\*?)#i', '', $content);
$content = preg\_replace('##i', '', $content);
//Removed because class is being removed from table #2699
$content = preg\_replace('/href="javascript:void\*/', ' ', $content);
// Convert the Wistia embed into URL to build amp-wistia-player and remove unnecesarry wistia code
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
$content = preg\_replace('/

PRIVACY

php } }
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_global\_head\_scripts');
function ampforwp\_global\_head\_scripts($data){
$content = $data['post\_amp\_content'];
$script\_slug = '';
$script\_url = '';
if( ampforwp\_get\_setting('amp-header-text-area-for-html') ) {
$allscripts = ampforwp\_get\_setting('amp-header-text-area-for-html');
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
preg\_match\_all('/<script(.\*?)custom-element=\"(.\*?)\"(.\*?)src=\"(.\*?)\"(.\*?)<\/script>/', $allscripts, $matches);
$script\_slug = $matches[2];
$script\_url = $matches[4];
if($matches){
foreach ($script\_slug as $key => $slug) {
if(preg\_match('/<\/'.$slug.'>/', $content)){
if ( empty( $data['amp\_component\_scripts'][$slug] ) ) {
$data['amp\_component\_scripts'][$slug] = $script\_url[$key];
}
}
}
}
}
return $data;
}
add\_action('amp\_post\_template\_head','ampforwp\_header\_html\_output',11);
function ampforwp\_header\_html\_output() {
if( ampforwp\_get\_setting('ampforwp-seo-custom-additional-meta') ){
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo strip\_tags( ampforwp\_get\_setting('ampforwp-seo-custom-additional-meta'), '' );
}
if( ampforwp\_get\_setting('amp-header-text-area-for-html') ) {
$allhtml = ampforwp\_get\_setting('amp-header-text-area-for-html');
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
$allhtml = preg\_replace('/<\/script>/','', $allhtml);
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $allhtml;
}
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
}
add\_filter('amp\_post\_template\_data','ampforwp\_set\_body\_content\_script', 20);
function ampforwp\_set\_body\_content\_script($data){
if( ampforwp\_get\_setting('amp-body-text-area') || ampforwp\_get\_setting('amp-footer-text-area-for-html') ) {
$head\_content = ampforwp\_get\_setting('amp-header-text-area-for-html');
preg\_match\_all('/"amp-(.\*?)"/', $head\_content, $matches1);
$body\_content = ampforwp\_get\_setting('amp-body-text-area');
preg\_match\_all('/<\/amp-(.\*?)>/', $body\_content, $matches);
if(ampforwp\_get\_setting('amp-footer-text-area-for-html') ) {
$footer\_content = ampforwp\_get\_setting('amp-footer-text-area-for-html');
preg\_match\_all('/<\/amp-(.\*?)>/', $footer\_content, $matches);
}
if(isset($matches[1][0])){
$amp\_comp = $matches[1];
for($i=0;$i= 2 && !$redux\_builder\_amp['ampforwp-robots-archive-sub-pages-sitewide'] ) {
$talk\_to\_robots = true;
}
}
$query\_array = $wp->query\_vars;
if( array\_key\_exists( 'page' , $query\_array ) ) {
$page = $wp->query\_vars['page'];
if ( $redux\_builder\_amp['amp-frontpage-select-option'] && $page >= '2') {
$talk\_to\_robots = true;
}
}
if( $talk\_to\_robots ) {
$meta\_content = "noindex,noarchive";
}
// Genesis
if ( function\_exists('genesis\_get\_robots\_meta\_content') && 'genesis' == ampforwp\_get\_setting('ampforwp-seo-selection') ) {
$meta\_content = genesis\_get\_robots\_meta\_content();
}
// All in One SEO #1720
if ( class\_exists('All\_in\_One\_SEO\_Pack') ) {
$aios\_class = $page = $opts = $aios\_meta = $aiosp\_noindex = $aiosp\_nofollow = '';
$noindex = 'index';
$nofollow = 'follow';
$aios\_class = new All\_in\_One\_SEO\_Pack();
if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_page\_number')) {
$page = $aios\_class->get\_page\_number();
}
if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_current\_options')) {
$opts = $aios\_class->get\_current\_options( array(), 'aiosp' );
}
if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_robots\_meta')) {
$aios\_meta = $aios\_class->get\_robots\_meta();
}
if ( ( is\_category() && ! empty( $aioseop\_options['aiosp\_category\_noindex'] ) ) || ( ! is\_category() && is\_archive() && ! is\_tag() && ! is\_tax() || ( is\_tag() && ! empty( $aioseop\_options['aiosp\_tags\_noindex'] ) ) || ( is\_search() && ! empty( $aioseop\_options['aiosp\_search\_noindex'] ) )
) ){
$noindex = 'noindex';
} elseif ( is\_single() || is\_page() || $aios\_class->is\_static\_posts\_page() || is\_attachment() || is\_category() || is\_tag() || is\_tax() || ( $page > 1 ) ) {
$post\_type = get\_post\_type();
if ( ! empty( $opts ) ) {
$aiosp\_noindex = htmlspecialchars( stripslashes( $opts['aiosp\_noindex'] ) );
$aiosp\_nofollow = htmlspecialchars( stripslashes( $opts['aiosp\_nofollow'] ) );
}
if ( $aiosp\_noindex || $aiosp\_nofollow || ! empty( $aioseop\_options['aiosp\_cpostnoindex'] )
|| ! empty( $aioseop\_options['aiosp\_cpostnofollow'] ) || ! empty( $aioseop\_options['aiosp\_paginated\_noindex'] ) || ! empty( $aioseop\_options['aiosp\_paginated\_nofollow'] )
) {
if ( ( $aiosp\_noindex == 'on' ) || ( ( ! empty( $aioseop\_options['aiosp\_paginated\_noindex'] ) ) && $page > 1 ) ||
( ( $aiosp\_noindex == '' ) && ( ! empty( $aioseop\_options['aiosp\_cpostnoindex'] ) ) && in\_array( $post\_type, $aioseop\_options['aiosp\_cpostnoindex'] ) )
) {
$noindex = 'noindex';
}
if ( ( $aiosp\_nofollow == 'on' ) || ( ( ! empty( $aioseop\_options['aiosp\_paginated\_nofollow'] ) ) && $page > 1 ) ||
( ( $aiosp\_nofollow == '' ) && ( ! empty( $aioseop\_options['aiosp\_cpostnofollow'] ) ) && in\_array( $post\_type, $aioseop\_options['aiosp\_cpostnofollow'] ) )
) {
$nofollow = 'nofollow';
}
}
}
if ( is\_singular() && is\_object($aios\_class) && property\_exists($aios\_class,'is\_password\_protected') && $aios\_class->is\_password\_protected() && apply\_filters( 'aiosp\_noindex\_password\_posts', false ) ) {
$noindex = 'noindex';
}
$robots\_meta = $noindex . ',' . $nofollow;
if ( $robots\_meta == 'index,follow' ) {
$robots\_meta = '';
}
if ( !empty($robots\_meta) ) {
$meta\_content = $robots\_meta;
}
}
// Meta Robots Tag From Yoast #1563
if ( class\_exists('WPSEO\_Frontend') && 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && is\_singular() && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) {
$class\_instance = '';
$class\_instance = WPSEO\_Frontend::get\_instance();
// robots() will return and print the meta robots tag
$class\_instance->robots();
// Empty the above meta content to avoid duplicate meta robot tags
$meta\_content = '';
}
$meta\_content = apply\_filters('ampforwp\_robots\_meta', $meta\_content);
if ( isset($redux\_builder\_amp['amp-inspection-tool']) && true == $redux\_builder\_amp['amp-inspection-tool'] ) {
$talk\_to\_robots = $meta\_content = '';
}
if ( $meta\_content ) {
if ( ( is\_archive() && $talk\_to\_robots ) || is\_singular() || is\_home() ) {
echo '';
}
}
}
// 41. Rewrite URL only on save #511
function ampforwp\_auto\_flush\_on\_save($redux\_builder\_amp) {
if ( $redux\_builder\_amp['amp-on-off-for-all-pages'] == 1 || $redux\_builder\_amp['ampforwp-archive-support'] == 1 || $redux\_builder\_amp['fb-instant-article-switch'] == 1 ) {
global $wp\_rewrite;
$wp\_rewrite->flush\_rules();
}
$options = $new\_options = array();
if ( is\_array(ampforwp\_get\_setting('hide-amp-categories')) && !is\_array(ampforwp\_get\_setting('hide-amp-categories2'))) {
$options = array\_keys(array\_filter($redux\_builder\_amp['hide-amp-categories'] ) );
foreach ($options as $option ) {
$new\_options[] = $option;
}
$redux\_builder\_amp['hide-amp-categories2'] = $new\_options;
$redux\_builder\_amp['hide-amp-categories'] = '';
update\_option('redux\_builder\_amp',$redux\_builder\_amp);
}
}
add\_action("redux/options/redux\_builder\_amp/saved",'ampforwp\_auto\_flush\_on\_save', 10, 1);
// 42. registeing AMP sidebars
add\_action('init', 'ampforwp\_add\_widget\_support');
function ampforwp\_add\_widget\_support() {
if (function\_exists('register\_sidebar')) {
global $redux\_builder\_amp;
register\_sidebar(array(
'name' => 'AMP Above Loop [HomePage]',
'id' => 'ampforwp-above-loop',
'description' => 'This Widget will be display on AMP HomePage Above the loop ',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

'
));
register\_sidebar(array(
'name' => 'AMP Below Loop [HomePage]',
'id' => 'ampforwp-below-loop',
'description' => 'This Widget will be display on AMP HomePage Below the loop',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

'
));
register\_sidebar(array(
'name' => 'AMP Below the Header [Site Wide]',
'id' => 'ampforwp-below-header',
'description' => 'This Widget will be display after the header bar',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

'
));
register\_sidebar(array(
'name' => 'AMP Above the Footer [Site Wide]',
'id' => 'ampforwp-above-footer',
'description' => 'This Widget display Above the Footer',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

'
));
if ( function\_exists('ampforwp\_custom\_theme\_files\_register') ) {
$desc = "**Update: [Introducing PageBuilder 2.0](https://ampforwp.com/tutorials/article/amp-page-builder-installation/)**
Drag and Drop the AMP Modules in this Widget Area and then assign this widget area to a page [(Need Help?)](http://ampforwp.com/tutorials/page-builder)";
$placeholder = 'PLACEHOLDER';
register\_sidebar(array(
'name' => 'Page Builder (AMP) [Legacy]',
'id' => 'layout-builder',
'description' => $placeholder,
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

'
));
add\_action( 'widgets\_admin\_page', function() use ( $desc, $placeholder ) {
add\_filter( 'esc\_html', function( $safe\_text, $text ) use ( $desc, $placeholder ) {
if ( $text !== $placeholder )
return $safe\_text;
remove\_filter( current\_filter(), \_\_FUNCTION\_\_ );
return $desc;
}, 10, 2 );
});
}
}
}
// 43. custom actions for widgets output
add\_action( 'ampforwp\_home\_above\_loop' , 'ampforwp\_output\_widget\_content\_above\_loop' );
add\_action( 'ampforwp\_frontpage\_above\_loop' , 'ampforwp\_output\_widget\_content\_above\_loop' );
function ampforwp\_output\_widget\_content\_above\_loop() {
$sanitized\_sidebar = "";
$sidebar\_output = "";
$sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-loop');
if ( $sanitized\_sidebar) {
$sidebar\_output = $sanitized\_sidebar->get\_amp\_content();
$sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output));
}
if ( $sidebar\_output ) { ?>
php echo do\_shortcode($sidebar\_output); ?

php }
}
add\_action( 'ampforwp\_home\_below\_loop' , 'ampforwp\_output\_widget\_content\_below\_loop' );
add\_action( 'ampforwp\_frontpage\_below\_loop' , 'ampforwp\_output\_widget\_content\_below\_loop' );
function ampforwp\_output\_widget\_content\_below\_loop() {
$sanitized\_sidebar = "";
$sidebar\_output = "";
$sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-loop');
if ( $sanitized\_sidebar) {
$sidebar\_output = $sanitized\_sidebar-get\_amp\_content();
$sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output));
}
if ( $sidebar\_output ) { ?>
php echo do\_shortcode($sidebar\_output); ?

php }
}
add\_action( 'ampforwp\_after\_header' , 'ampforwp\_output\_widget\_content\_below\_the\_header' );
add\_action('below\_the\_header\_design\_1','ampforwp\_output\_widget\_content\_below\_the\_header');
function ampforwp\_output\_widget\_content\_below\_the\_header() {
$sanitized\_sidebar = "";
$sidebar\_output = "";
$sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-header');
if ( $sanitized\_sidebar) {
$sidebar\_output = $sanitized\_sidebar-get\_amp\_content();
$sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output));
}
if ( $sidebar\_output ) { ?>
php echo do\_shortcode($sidebar\_output); ?

php }
}
add\_action( 'amp\_post\_template\_above\_footer' , 'ampforwp\_output\_widget\_content\_above\_the\_footer' );
function ampforwp\_output\_widget\_content\_above\_the\_footer() {
$sanitized\_sidebar = "";
$sidebar\_output = "";
$sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-footer');
if ( $sanitized\_sidebar) {
$sidebar\_output = $sanitized\_sidebar-get\_amp\_content();
$sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output));
}
if ( $sidebar\_output ) { ?>
php echo do\_shortcode($sidebar\_output); ?

php }
}
// Filter the sidebars content to make it work properly with carousels
add\_filter('ampforwp\_modify\_sidebars\_content','ampforwp\_sidebars\_carousel\_content');
function ampforwp\_sidebars\_carousel\_content($content){
$content = str\_replace(array(':openbrack:',':closebrack:'), array('[',']'), $content);
return $content;
}
// Sidebar Content Sanitizer
function ampforwp\_sidebar\_content\_sanitizer($sidebar){
global $redux\_builder\_amp;
$sanitized\_sidebar = "";
$non\_sanitized\_sidebar = "";
$sidebar\_data = array();
$blacklist\_array = array();
// Remove some blacklist tags from sidebars only when search,archives and categories widgets are active #2835
if ( is\_active\_widget(false,false,'search') || is\_active\_widget(false,false,'archives') || is\_active\_widget(false,false,'categories') ) {
$blacklist\_array['non-content'] = 'non-content';
}
ob\_start();
dynamic\_sidebar( $sidebar );
$non\_sanitized\_sidebar = ob\_get\_contents();
ob\_end\_clean();
if ( $non\_sanitized\_sidebar ) {
$sanitized\_sidebar = new AMPforWP\_Content( $non\_sanitized\_sidebar,
apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' = array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_DailyMotion\_Embed\_Handler' => array(),
'AMP\_Vimeo\_Embed\_Handler' => array(),
'AMP\_SoundCloud\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Pinterest\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
) ),
apply\_filters( 'amp\_sidebar\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => $blacklist\_array,
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Playbuzz\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
'AMP\_Tag\_And\_Attribute\_Sanitizer' => array(),
) ), array('non-content'=>'non-content')
);
}
if ( is\_active\_widget(false,false,'search') && $sanitized\_sidebar) {
// Allow some blacklisted tags #1400
add\_filter('ampforwp\_modify\_sidebars\_content','ampforwp\_modified\_search\_sidebar');
}
return $sanitized\_sidebar;
}
function ampforwp\_modified\_search\_sidebar( $content ) {
global $redux\_builder\_amp;
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
$dom = '';
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($content);
$nodes = $dom->getElementsByTagName( 'form' );
$num\_nodes = $nodes->length;
if ( 0 !== $num\_nodes ) {
for ( $i = 0; $i < $nodes->length; ++$i ) {
$element = $nodes->item( $i );
if (ampforwp\_get\_setting('ampforwp-amp-takeover') == false && $mob\_pres\_link == false ) {
$amp\_query\_variable = 'amp';
$amp\_query\_variable\_val = '1';
}
if ( ! $element->hasAttribute('action-xhr') ){
$action\_url = $element->getAttribute('action');
$action\_url = preg\_replace('#^http?:#', '', $action\_url);
$element->setAttribute('action', $action\_url);
}
$element->setAttribute('target', '\_top');
$input\_nodes = $element->getElementsByTagName('input');
if ( 0 !== $input\_nodes->length ) {
for ( $i = 0; $i < $input\_nodes->length; ++$i ) {
$input\_node = $input\_nodes->item( $i );
if ( 'submit' !== $input\_node->getAttribute('type') ) {
$input\_submit = $dom->createElement('input');
$input\_submit->setAttribute('type', 'submit');
$input\_submit->setAttribute('class', 'search-submit');
}
}
if ( $input\_submit ) {
$element->appendChild($input\_submit);
}
}
}
}
// Remove http/https from Audio and Video URLs #1400
$video\_nodes = $dom->getElementsByTagName( 'amp-video' );
$num\_nodes = $video\_nodes->length;
if ( 0 !== $num\_nodes ) {
for ( $i = 0; $i < $video\_nodes->length; ++$i ) {
$element = $video\_nodes->item( $i );
$source = $element->childNodes->item(0);
$source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') ));
$source = $element->childNodes->item(1);
if($source)
$source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') ));
}
}
$audio = $dom->getElementsByTagName( 'amp-audio' );
$num\_nodes = $audio->length;
if ( 0 !== $num\_nodes ) {
for ( $i = 0; $i < $audio->length; ++$i ) {
$element = $audio->item( $i );
$source = $element->childNodes->item(0);
$source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') ));
$source = $element->childNodes->item(1);
$source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') ));
}
}
$content = AMP\_DOM\_Utils::get\_content\_from\_dom($dom);
return $content;
}
function ampforwp\_sidebar\_blacklist\_tags($tags) {
$form = array\_search('form', $tags);
$input = array\_search('input', $tags);
$label = array\_search('label', $tags);
$textarea = array\_search('textarea', $tags);
$select = array\_search('select', $tags);
$option = array\_search('option', $tags);
if ( $input ) {
unset($tags[$input]);
}
if ( $label ) {
unset($tags[$label]);
}
if ( $textarea ) { unset($tags[$textarea]); }
if ( $select ) { unset($tags[$select]); }
if ( $option ) { unset($tags[$option]); }
return $tags;
}
// Sidebar Scripts
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_sidebar\_data', 85 );
function ampforwp\_add\_sidebar\_data( $data ) {
$sanitized\_data\_above\_loop = '';
$sanitized\_data\_below\_loop = '';
$sanitized\_data\_below\_header = '';
$sanitized\_data\_above\_footer = '';
$sanitized\_data\_swift\_sidebar = '';
$sanitized\_data\_swift\_footer = '';
// Get the Data
$sanitized\_data\_above\_loop = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-loop');
$sanitized\_data\_below\_loop = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-loop');
$sanitized\_data\_below\_header = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-header');
$sanitized\_data\_above\_footer = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-footer');
$sanitized\_data\_swift\_sidebar = ampforwp\_sidebar\_content\_sanitizer('swift-sidebar');
$sanitized\_data\_swift\_footer = ampforwp\_sidebar\_content\_sanitizer('swift-footer-widget-area');
if ( $sanitized\_data\_above\_loop ) {
// Add Scripts
if ( $sanitized\_data\_above\_loop->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_above\_loop->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_above\_loop->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_above\_loop->get\_amp\_styles() ) {
foreach ($sanitized\_data\_above\_loop->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
if ( $sanitized\_data\_below\_loop ) {
// Add Scripts
if ( $sanitized\_data\_below\_loop->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_below\_loop->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_below\_loop->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_below\_loop->get\_amp\_styles() ) {
foreach ($sanitized\_data\_below\_loop->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
if ( $sanitized\_data\_below\_header ) {
// Add Scripts
if ( $sanitized\_data\_below\_header->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_below\_header->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_below\_header->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_below\_header->get\_amp\_styles() ) {
foreach ($sanitized\_data\_below\_header->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
if ( $sanitized\_data\_above\_footer ) {
// Add Scripts
if ( $sanitized\_data\_above\_footer->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_above\_footer->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_above\_footer->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_above\_footer->get\_amp\_styles() ) {
foreach ($sanitized\_data\_above\_footer->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
if ( $sanitized\_data\_swift\_sidebar ) {
// Add Scripts
if ( $sanitized\_data\_swift\_sidebar->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_swift\_sidebar->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_swift\_sidebar->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_swift\_sidebar->get\_amp\_styles() ) {
foreach ($sanitized\_data\_swift\_sidebar->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
if ( $sanitized\_data\_swift\_footer ) {
// Add Scripts
if ( $sanitized\_data\_swift\_footer->get\_amp\_scripts() ) {
foreach ($sanitized\_data\_swift\_footer->get\_amp\_scripts() as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// Form script #1400
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_swift\_footer->get\_amp\_content());
if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) {
if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){
$data['amp\_component\_scripts']['amp-form'] = 'https://cdn.ampproject.org/v0/amp-form-0.1.js';
}
}
// Add Styles
if ( $sanitized\_data\_swift\_footer->get\_amp\_styles() ) {
foreach ($sanitized\_data\_swift\_footer->get\_amp\_styles() as $key => $value ) {
if( empty( $data['post\_amp\_styles'][$key] ) ){
$data['post\_amp\_styles'][$key] = $value;
}
}
}
}
return $data;
}
// 44. auto adding /amp for the menu
add\_action('amp\_init','ampforwp\_auto\_add\_amp\_menu\_link\_insert');
function ampforwp\_auto\_add\_amp\_menu\_link\_insert() {
add\_action( 'pre\_amp\_render\_post', 'ampforwp\_auto\_add\_amp\_in\_link\_check', 99 );
}
function ampforwp\_auto\_add\_amp\_in\_link\_check() {
$ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint();
$add\_amp\_menu = get\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link');
if ( false == $add\_amp\_menu || ( 'on' && 0 == ampforwp\_get\_setting('ampforwp-auto-amp-menu-link') ) ) {
delete\_transient('ampforwp\_header\_menu');
delete\_transient('ampforwp\_footer\_menu');
set\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link', 'off');
}
if ( $ampforwp\_is\_amp\_endpoint && ampforwp\_get\_setting('ampforwp-auto-amp-menu-link') == 1 ) {
if( 'off' == $add\_amp\_menu ) {
delete\_transient('ampforwp\_header\_menu');
delete\_transient('ampforwp\_footer\_menu');
set\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link', 'on');
}
add\_filter( 'nav\_menu\_link\_attributes', 'ampforwp\_auto\_add\_amp\_in\_menu\_link', 10, 3 );
}
}
function ampforwp\_auto\_add\_amp\_in\_menu\_link( $atts, $item, $args ) {
if($item->type=='post\_type' && !in\_array($item->object, ampforwp\_get\_all\_post\_types()) ){
return $atts;
}
if($item->type=='taxonomy' && !in\_array($item->object, ampforwp\_get\_all\_post\_types()) ){
return $atts;
}
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
if(ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true){
return $atts;
}
$url = $atts['href'];
if($url){
$is\_external = ampforwp\_isexternal($url);
}
if($is\_external){
return $atts;
}
if(ampforwp\_get\_setting('amp-core-end-point') == 1 ){
$atts['href'] = user\_trailingslashit(trailingslashit( $atts['href'] ) );
$atts['href'] = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1', $atts['href']);
}
else{
if(false === strpos($atts['href'], "#")){
$atts['href'] = user\_trailingslashit(trailingslashit( $atts['href'] ) . AMPFORWP\_AMP\_QUERY\_VAR);
}
}
$atts = apply\_filters('ampforwp\_auto\_add\_amp\_menu\_url',$atts);
return $atts;
}
// 45. searchpage, frontpage, homepage structured data
// Moved to structured-data-functions.php
// 46. search search search everywhere #615
require 'search-functions.php';
// 47. social js properly adding when required
if( !function\_exists( 'is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp' ) ) {
function is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp() {
global $redux\_builder\_amp;
if( $redux\_builder\_amp['enable-single-facebook-share'] ||
$redux\_builder\_amp['enable-single-twitter-share'] ||
$redux\_builder\_amp['enable-single-email-share'] ||
$redux\_builder\_amp['enable-single-pinterest-share'] ||
$redux\_builder\_amp['enable-single-linkedin-share'] ) {
return true;
}
return false;
}
}
// 48. Remove all unwanted scripts on search pages
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_remove\_scripts\_search\_page' );
function ampforwp\_remove\_scripts\_search\_page( $data ) {
if( is\_search() ) {
// Remove all unwanted scripts on search pages
unset( $data['amp\_component\_scripts']);
}
return $data;
}
// 49. Properly adding ad Script the AMP way
// Moved to ads-functions.php
// internal function for checing if social profiles have been set
if( !function\_exists('ampforwp\_checking\_any\_social\_profiles') ) {
function ampforwp\_checking\_any\_social\_profiles() {
global $redux\_builder\_amp;
if(
$redux\_builder\_amp['enable-single-twittter-profile'] ||
$redux\_builder\_amp['enable-single-facebook-profile'] ||
$redux\_builder\_amp['enable-single-pintrest-profile'] ||
$redux\_builder\_amp['enable-single-google-plus-profile'] ||
$redux\_builder\_amp['enable-single-linkdin-profile'] ||
$redux\_builder\_amp['enable-single-youtube-profile'] ||
$redux\_builder\_amp['enable-single-instagram-profile'] ||
$redux\_builder\_amp['enable-single-VKontakte-profile'] ||
$redux\_builder\_amp['enable-single-reddit-profile'] ||
$redux\_builder\_amp['enable-single-snapchat-profile'] ||
$redux\_builder\_amp['enable-single-Tumblr-profile']
) {
return true;
}
return false;
}
}
// 50. Properly adding noditification Scritps the AMP way
// Moved to notice-bar-functions.php
//52. Adding a generalized sanitizer function for purifiying normal html to amp-html
function ampforwp\_content\_sanitizer( $content ) {
global $post;
$amp\_custom\_post\_content\_input = $content;
if ( !empty( $amp\_custom\_post\_content\_input ) ) {
$amp\_custom\_content = new AMPFORWP\_Content( $amp\_custom\_post\_content\_input,
apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' => array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
'AMP\_Tiktok\_Embed\_Handler'=>array(),
) ),
apply\_filters( 'amp\_content\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
),$post )
);
if ( $amp\_custom\_content ) {
global $data;
$data = (array) $data;
$data['amp\_component\_scripts'] = $amp\_custom\_content->get\_amp\_scripts();
$data['post\_amp\_styles'] = $amp\_custom\_content->get\_amp\_styles();
return $amp\_custom\_content->get\_amp\_content();
}
return '';
}
}
//53. Removed AMP-WooCommerce Code and added it in AMP-WooCommerce #929
// Adding the styling for AMP Woocommerce latest Products(AMP-WooCommerce Widgets)
add\_action('amp\_post\_template\_css','amp\_latest\_products\_styling',PHP\_INT\_MAX);
function amp\_latest\_products\_styling() {
if ( class\_exists( 'woocommerce' ) ) { ?>
.ampforwp\_wc\_shortcode{margin-top: 0;padding:0;display:inline-block;width: 100%;}
.ampforwp\_wc\_shortcode li{position: relative;width:29%; font-size:12px; line-height: 1; float: left;list-style-type: none;margin:2%;}
.ampforwp\_wc\_shortcode .onsale{position: absolute;top: 0;right: 0;background: #ddd;padding: 7px;font-size: 12px;}
.single-post .ampforwp\_wc\_shortcode li amp-img{margin:0}
.ampforwp-wc-title{margin: 8px 0px 10px 0px;font-size: 13px;}
.ampforwp-wc-price{color:#444}
.wc\_widgettitle{text-align:center;margin-bottom: 0px;}
.ampforwp-wc-price, .ampforwp\_wc\_star\_rating{float:left;margin-right: 10px;}
php }
}
// 54. Change the default values of post meta for AMP pages. #746
add\_action('admin\_head','ampforwp\_change\_default\_amp\_page\_meta');
function ampforwp\_change\_default\_amp\_page\_meta() {
if ( ! current\_user\_can('manage\_options') ) {
return ;
}
global $redux\_builder\_amp;
$check\_meta = get\_option('ampforwp\_default\_pages\_to');
$checker = 'show';
$control = $redux\_builder\_amp['amp-pages-meta-default'];
$meta\_value\_to\_upate = 'default';
if ( $control === 'hide' ) {
$checker = 'hide';
$meta\_value\_to\_upate = 'hide-amp';
}
// Check and Run only if the value has been changed, else return
if ( $check\_meta === $checker ) {
return;
}
// Get all the pages and update the post meta
$pages = get\_pages(array());
foreach($pages as $page){
update\_post\_meta($page-ID,'ampforwp-amp-on-off', $meta\_value\_to\_upate);
}
// Update the option as the process has been done and update an option
update\_option('ampforwp\_default\_pages\_to', $checker);
return ;
}
// Adding the meta="description" from yoast or from the content
add\_action('amp\_post\_template\_head','ampforwp\_meta\_description');
function ampforwp\_meta\_description() {
global $redux\_builder\_amp;
if ( false == ampforwp\_get\_setting('ampforwp-seo-meta-desc') || ('rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') && is\_singular() )) {
return;
}
if (function\_exists('aioseo\_pro\_just\_activated') && 'aioseo' == ampforwp\_get\_setting('ampforwp-seo-selection') ) {
return;
}
$desc = ampforwp\_generate\_meta\_desc();
if ( $desc && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) {
echo '';
}else if(class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')){
$yoast\_desc = addslashes( wp\_strip\_all\_tags( WPSEO\_Meta::get\_value('metadesc', ampforwp\_get\_the\_ID() ) ) );
$yoast\_desc\_meta = get\_option( 'wpseo\_titles' );
if(isset($yoast\_desc\_meta['metadesc-page'])){
$yoast\_desc\_meta = $yoast\_desc\_meta['metadesc-page'];
}
if(empty($yoast\_desc)){
$yoast\_desc = $yoast\_desc\_meta;
}
if ($yoast\_desc && ampforwp\_is\_front\_page()) {
echo '';
}
elseif ($desc && ampforwp\_is\_home() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) ){
echo '';
}
}
}
// All in One Seo Compatibility #1557
if(defined( 'AIOSEO\_VERSION' ) && version\_compare(AIOSEO\_VERSION,'4.0.0', '<')){
add\_filter('aioseop\_amp\_description', '\_\_return\_false');
}
// 55. Call Now Button Feature added
add\_action('ampforwp\_call\_button','ampforwp\_call\_button\_html\_output');
function ampforwp\_call\_button\_html\_output(){
global $redux\_builder\_amp;
if ( $redux\_builder\_amp['ampforwp-callnow-button'] ) { ?>

 php
}
}
// 56. Multi Translation Feature #540
// Moved to functions.php
// 57. Adding Updated date at in the Content
add\_action('ampforwp\_after\_post\_content','ampforwp\_add\_modified\_date');
function ampforwp\_add\_modified\_date($post\_object){
global $redux\_builder\_amp;
if ( is\_single() && $redux\_builder\_amp['post-modified-date'] == true && ( ! checkAMPforPageBuilderStatus( get\_the\_ID() ) ) ) { ?

php
$date\_notice\_type = ampforwp\_get\_setting('ampforwp-post-date-notice-type');
if( $date\_notice\_type == "modified" && $post\_object-get( 'post\_modified\_timestamp' ) !== $post\_object->get( 'post\_publish\_timestamp' ) ){
$date\_notice\_text = ampforwp\_get\_setting('amp-translator-modified-date-text');
$date = $post\_object->get( 'post\_modified\_timestamp' );
echo esc\_html(
sprintf(
/\* translators: %s: date \*/
ampforwp\_translation( $date\_notice\_text ,'This article was last modified on ' ) . ' %s ',
date\_i18n( get\_option( 'date\_format' ) , $date )
)
);
if(true == ampforwp\_get\_setting('ampforwp-post-date-notice-time')){
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo get\_the\_modified\_time();
}
}elseif($date\_notice\_type == "published"){
$date\_notice\_text = ampforwp\_get\_setting('amp-translator-published-date-text');
$date = $post\_object->get( 'post\_publish\_timestamp' );
echo esc\_html(
sprintf(
/\* translators: %s: date \*/
ampforwp\_translation( $date\_notice\_text ,'This article was last modified on ' ) . ' %s ',
date\_i18n( get\_option( 'date\_format' ) , $date )
)
);
if(true == ampforwp\_get\_setting('ampforwp-post-date-notice-time')){
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo get\_the\_time();
}
}
?>

 php
}
}
// 58. YouTube Shortcode compatablity with AMP #557 #971
add\_filter('amp\_content\_embed\_handlers','ampforwp\_youtube\_shortcode\_embedder');
function ampforwp\_youtube\_shortcode\_embedder($data){
unset($data['AMP\_YouTube\_Embed\_Handler']);
$data[ 'AMPforWP\_YouTube\_Embed\_Handler' ] = array();
return $data;
}
if ( ! function\_exists( 'ampforwp\_youtube\_shortcode') ) {
function ampforwp\_youtube\_shortcode( $params, $old\_format\_support = false ) {
$str = '';
$parsed\_url = array();
$youtube\_url = 'https://www.youtube.com/watch?v=';
if(isset( $params['id']) ){
$parsed\_url = parse\_url( $params['id'] );
}
$server = 'www.youtube.com';
if ( in\_array( $server, $parsed\_url ) === false ) {
if(isset($params['id']) && $params['id']){
$new\_url = $youtube\_url . $params['id'] ;
$params['id'] = $new\_url;
}
}
if ( $old\_format\_support && isset( $params[0] ) ) {
$str = ltrim( $params[0], '=' );
} elseif ( is\_array( $params ) ) {
foreach ( array\_keys( $params ) as $key ) {
if ( ! is\_numeric( $key ) ) {
$str = $key . '=' . $params[ $key ];
}
}
}
return str\_replace( array( '&amp;', '&#038;' ), '&', $str );
}
}
// Add extra params in amp-youtube
add\_filter('amp\_youtube\_params', 'ampforwp\_youtube\_modified\_params');
if( ! function\_exists(' ampforwp\_youtube\_modified\_params ') ){
function ampforwp\_youtube\_modified\_params($amp\_youtube){
$check = '';
$param = '';
// Check for extra params
$check = preg\_match('/(.\*?)&(.\*)/', $amp\_youtube['data-videoid']);
if(1 === $check){
// Grab the extra param
$param = preg\_replace('/(.\*?)&(.\*)/', '$2', $amp\_youtube['data-videoid']);
// Parse the string into variables
parse\_str($param, $query\_args);
// Check for rel param
if(isset($query\_args['rel'])){
// Add the rel param in amp-youtube's data-param
$amp\_youtube['data-param-rel'] = $query\_args['rel'];
}
// Remove that param from URL
$amp\_youtube['data-videoid'] = preg\_replace('/&(.\*)/', '', $amp\_youtube['data-videoid']);
// Plyr Plugin Compatibility #1505
if ( class\_exists('Plyr') ) {
$amp\_youtube['data-param-rel'] = 0;
$amp\_youtube['data-param-autoplay'] = 0;
$amp\_youtube['data-param-showinfo'] = 0;
}
}
return $amp\_youtube;
}
}
// 59. Comment Button URL
function ampforwp\_comment\_button\_url(){
global $redux\_builder\_amp;
$button\_url = "";
if(ampforwp\_get\_setting('amp-mobile-redirection')==1){
$button\_url = add\_query\_arg( array( 'nonamp' = '1' ), get\_permalink() );
$button\_url = $button\_url. '#commentform';
}
elseif ( ampforwp\_get\_setting('ampforwp-amp-takeover') ) {
$button\_url = user\_trailingslashit(get\_the\_permalink()).'#comments';
}
else{
$button\_url = get\_permalink(). '#commentform';
}
return esc\_url( apply\_filters( 'ampforwp\_comment\_button\_url', $button\_url ) );
}
// 60. Remove Category Layout modification code added by TagDiv #842 and #796
// #1683
add\_action('pre\_amp\_render\_post', 'ampforwp\_remove\_tagdiv\_category\_layout');
function ampforwp\_remove\_tagdiv\_category\_layout(){
if ( function\_exists( 'ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() ) {
remove\_action('pre\_get\_posts', 'td\_modify\_main\_query\_for\_category\_page',9);
}
}
// 61. Add Gist Support
add\_shortcode('amp-gist', 'ampforwp\_gist\_shortcode\_generator');
function ampforwp\_gist\_shortcode\_generator($atts) {
extract(shortcode\_atts(array(
'id' =>'' ,
'layout' => 'fixed-height',
'height' => 200,
), $atts));
if ( empty ( $height ) ) {
$height = '250';
}
// adding sanitization for gist id
$sanitized\_id = preg\_replace('/[^a-z0-9\-]/', '', $atts['id']);
if($sanitized\_id){
return '
';
}
}
// Code updated and added the JS proper way #336
add\_filter('amp\_post\_template\_data','ampforwp\_add\_amp\_gist\_script', 100);
function ampforwp\_add\_amp\_gist\_script( $data ){
global $redux\_builder\_amp;
$content = "";
$content = $data['post'];
if( $content ){
$content = $content->post\_content;
if( is\_single() ) {
if( has\_shortcode( $content, 'amp-gist' ) ){
if ( empty( $data['amp\_component\_scripts']['amp-gist'] ) ) {
$data['amp\_component\_scripts']['amp-gist'] = 'https://cdn.ampproject.org/v0/amp-gist-0.1.js';
}
}
}
}
return $data;
}
// 62. Adding Meta viewport via hook instead of direct #878
add\_action( 'amp\_post\_template\_head','ampforwp\_add\_meta\_viewport', 9);
function ampforwp\_add\_meta\_viewport() {
$output = '';
$output = '
';
if (ampforwp\_get\_setting('ampforwp-meta-viewport') == false) {
$output = '';
}
if(!class\_exists( 'AMPforWP\_Mobile\_Detect') && !ampforwp\_get\_setting('amp-mobile-redirection')){
ampforwp\_require\_file( AMPFORWP\_PLUGIN\_DIR.'/includes/vendor/Mobile\_Detect.php ');
}
if(class\_exists('AMPforWP\_Mobile\_Detect')){
$mobile\_detect = new AMPforWP\_Mobile\_Detect;
$isMobile = $mobile\_detect->isMobile();
$isTablet = $mobile\_detect->isTablet();
if( $isMobile || $isTablet ){
$output = '';
}
}
global $is\_safari;
if ($is\_safari) {
$output .= '';
}
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo apply\_filters('ampforwp\_modify\_meta\_viewport\_filter',$output);
}
// 63. Frontpage Comments #682
function ampforwp\_frontpage\_comments() {
global $redux\_builder\_amp;
$data = get\_option( 'ampforwp\_design',array());
$enable\_comments = false;
$post\_id = "";
$post\_id = ampforwp\_get\_frontpage\_id();
if (empty($data)) {
$data['elements'] = "meta\_info:1,title:1,featured\_image:1,content:1,meta\_taxonomy:1,social\_icons:1,comments:1,related\_posts:1";
}
if( isset( $data['elements'] ) || ! empty( $data['elements'] ) ){
$options = explode( ',', $data['elements'] );
};
if ($options): foreach ($options as $key=>$value) {
switch ($value) {
case 'comments:1':
$enable\_comments = true;
break;
}
} endif;
if ( $enable\_comments ) { ?>
php
$comment\_button\_url = "";
$postID = '';
// Gather comments for a Front from post id
$postID = ampforwp\_get\_frontpage\_id();
$comment\_order = get\_option( 'comment\_order' );
$comments = get\_comments(array(
'post\_id' = $postID,
'order' => esc\_attr($comment\_order),
'status' => 'approve' //Change this to the type of comments to be displayed
));
$comment\_button\_url = get\_permalink( $post\_id );
$comment\_button\_url = apply\_filters('ampforwp\_frontpage\_comments\_url',$comment\_button\_url );
if ( $comments ) { ?>
### php global $redux\_builder\_amp; echo esc\_html(ampforwp\_translation($redux\_builder\_amp['amp-translator-view-comments-text'] , 'View Comments' ))?

php
$page = (get\_query\_var('page')) ? get\_query\_var('page') : 1;
$total\_comments = get\_comments( array(
'orderby' = 'post\_date' ,
'order' => 'DESC',
'post\_id' => $postID,
'status' => 'approve',
'parent' =>0 )
);
$pages = ceil(count($total\_comments)/AMPFORWP\_COMMENTS\_PER\_PAGE);
$pagination\_args = array(
'base' => @add\_query\_arg('page','%#%'),
'format' => '?page=%#%',
'total' => $pages,
'current' => $page,
'show\_all' => False,
'end\_size' => 1,
'mid\_size' => 2,
'prev\_next' => True,
'prev\_text' => ampforwp\_translation($redux\_builder\_amp['amp-translator-previous-text'], 'Previous'),
'next\_text' => ampforwp\_translation( $redux\_builder\_amp['amp-translator-next-text'], 'Next'),
'type' => 'plain'
);
// Display the list of comments
function ampforwp\_custom\_translated\_comment($comment, $args, $depth){
$GLOBALS['comment'] = $comment;
global $redux\_builder\_amp; ?>* >
  php
  printf('<b class="fn"%s '.esc\_html(ampforwp\_translation(ampforwp\_get\_setting('amp-translator-says-text'),'says')).':', get\_comment\_author\_link()) ?>

  [php
  // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
  // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
  printf( esc\_html(ampforwp\_translation( ('%1$s '. ampforwp\_translation($redux\_builder\_amp['amp-translator-at-text'],'at').' %2$s'), '%1$s at %2$s')) , get\_comment\_date(), get\_comment\_time())?](%3C?php echo esc_url(untrailingslashit( htmlspecialchars( get_comment_link( $comment->comment_ID ) ) )) ?>)
  php edit\_comment\_link( esc\_html(ampforwp\_translation( $redux\_builder\_amp['amp-translator-Edit-text'], 'Edit' ) )) ?

  php
  // $pattern = "~[^a-zA-Z0-9\_ !@#$%^&\*();\\\/|<\"'+.,:?=-]~";
  $emoji\_content = get\_comment\_text();
  // $emoji\_free\_comments = preg\_replace($pattern,'',$emoji\_content);
  $emoji\_content = wpautop( $emoji\_content );
  $sanitizer = new AMPFORWP\_Content( $emoji\_content, array(), apply\_filters( 'ampforwp\_content\_sanitizers', array( 'AMP\_Img\_Sanitizer' => array(),
  'AMP\_Video\_Sanitizer' => array() ) ) );
  $sanitized\_comment\_content = $sanitizer->get\_amp\_content();
  //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
  echo make\_clickable( $sanitized\_comment\_content );//amphtml content, no kses
  ?>

php
}// end of ampforwp\_custom\_translated\_comment()
wp\_list\_comments( array(
'per\_page' = AMPFORWP\_COMMENTS\_PER\_PAGE, //Allow comment pagination
'page' => $page,
'style' => 'li',
'type' => 'comment',
'max\_depth' => 5,
'avatar\_size' => 0,
'callback' => 'ampforwp\_custom\_translated\_comment',
'reverse\_top\_level' => false //Show the latest comments at the top of the list
), $comments);
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo paginate\_links( $pagination\_args );?>
php
}
if ( comments\_open($postID) ) {
$comment\_button\_url = add\_query\_arg( array( 'nonamp' = '1' ), $comment\_button\_url );?>
[php echo esc\_html(ampforwp\_translation( $redux\_builder\_amp['amp-translator-leave-a-comment-text'], 'Leave a Comment' )); ?](%3C?php echo esc_url( $comment_button_url ) . '#commentform' ?>)
php
}?
 php
}
}
// 64. PageBuilder
add\_action('pre\_amp\_render\_post','ampforwp\_apply\_layout\_builder\_on\_pages',20);
function ampforwp\_apply\_layout\_builder\_on\_pages($post\_id) {
global $redux\_builder\_amp;
$sidebar\_check = null;
if ( ampforwp\_is\_front\_page() ) {
$post\_id = ampforwp\_get\_frontpage\_id();
}
if ( function\_exists('ampforwp\_custom\_theme\_files\_register') ) {
if ( is\_page() ) {
$sidebar\_check = get\_post\_meta( $post\_id,'ampforwp\_custom\_sidebar\_select',true);
}
// Add Styling Builder Elements
add\_action('amp\_post\_template\_css', 'ampforwp\_pagebuilder\_styling', 20);
if ( 'layout-builder' == $sidebar\_check ) {
// Removed Titles for Pagebuilder elements
remove\_filter( 'ampforwp\_design\_elements', 'ampforwp\_add\_element\_the\_title' );
remove\_action('ampforwp\_design\_2\_frontpage\_title','ampforwp\_design\_2\_frontpage\_title');
remove\_action('ampforwp\_design\_2\_frontpage\_title','ampforwp\_design\_2\_frontpage\_title');
}
}
}
function ampforwp\_remove\_post\_elements($elements) {
$elements = array('empty-filter');
return $elements ;
}
function ampforwp\_pagebuilder\_styling() { ?
.amp\_cb\_module{font-size:14px;line-height:1.5;margin-top:30px;margin-bottom:10px;padding:0 20px;}
.amp\_cb\_module h4{margin:17px 0 6px 0;}
.amp\_cb\_module p{margin: 8px 0px 10px 0px;}
.amp\_cb\_blurb{text-align: center}
.amp\_cb\_blurb amp-img{margin:0 auto;}
.flex-grid {display:flex;justify-content: space-between;}
.amp\_module\_title{text-align: center;font-size: 14px;margin-bottom: 12px;padding-bottom: 4px;text-transform: uppercase;letter-spacing: 1px;border-bottom: 1px solid #f1f1f1;}
.clmn {flex: 1;padding: 5px}
.amp\_cb\_btn{margin-top: 20px;text-align: center;margin-bottom: 30px;}
.amp\_cb\_btn a{background: #f92c8b;color: #fff;font-size: 14px;padding: 9px 20px;border-radius: 3px;box-shadow: 1px 1px 4px #ccc;margin:6px;}
.amp\_cb\_btn .m\_btn{font-size: 16px; padding: 10px 20px;}
.amp\_cb\_btn .l\_btn{font-size: 18px; padding: 15px 48px;font-weight:bold;}
@media (max-width: 430px) { .flex-grid {display: block;} }
php }
// Add the scripts and style in header
function ampforwp\_generate\_pagebuilder\_data() {
$sanitized\_sidebar = "";
$non\_sanitized\_sidebar = "";
$sidebar\_data = array();
ob\_start();
dynamic\_sidebar( 'layout-builder' );
$non\_sanitized\_sidebar = ob\_get\_contents();
ob\_end\_clean();
$sanitized\_sidebar = new AMPFORWP\_Content( $non\_sanitized\_sidebar,
apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' = array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
'AMP\_Tiktok\_Embed\_Handler'=>array(),
) ),
apply\_filters( 'amp\_content\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
) )
);
$sidebar\_data['content'] = $sanitized\_sidebar->get\_amp\_content();
$sidebar\_data['script'] = $sanitized\_sidebar->get\_amp\_scripts();
$sidebar\_data['style'] = $sanitized\_sidebar->get\_amp\_styles();
return $sidebar\_data;
}
function ampforwp\_builder\_checker() {
global $post, $redux\_builder\_amp;
$pagebuilder\_check = '';
$post\_id = '';
$is\_legacy\_enabled = '';
$is\_legacy\_enabled = function\_exists('ampforwp\_custom\_theme\_files\_register');
if ( $post ) {
$post\_id = $post->ID;
}
if ( ampforwp\_is\_front\_page() ) {
$post\_id = ampforwp\_get\_frontpage\_id();
}
if ( $post\_id && $is\_legacy\_enabled ) {
$pagebuilder\_check = get\_post\_meta( $post\_id,'ampforwp\_custom\_sidebar\_select',true);
}
if ( $pagebuilder\_check === 'layout-builder' ) {
return ampforwp\_generate\_pagebuilder\_data();
}
return;
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_pagebuilder\_data' );
function ampforwp\_add\_pagebuilder\_data( $data ) {
$sanitized\_data = '';
$sanitized\_data = ampforwp\_builder\_checker();
if ( $sanitized\_data ) {
$data[ 'post\_amp\_content' ] = $sanitized\_data['content'];
$data[ 'amp\_component\_scripts' ] = $sanitized\_data['script'];
$data[ 'post\_amp\_styles' ] = $sanitized\_data['style'];
}
return $data;
}
/\*\*
\* 65. Remove Filters code added through Class by other plugins
\*
\* Allow to remove method for an hook when, it's a class method used and class don't have variable, but you know the class name :)
\* Code from https://github.com/herewithme/wp-filters-extras
\*/
function ampforwp\_remove\_filters\_for\_class( $hook\_name = '', $class\_name ='', $method\_name = '', $priority = 0 ) {
global $wp\_filter;
// Take only filters on right hook name and priority
if ( !isset($wp\_filter[$hook\_name][$priority]) || !is\_array($wp\_filter[$hook\_name][$priority]) )
return false;
// Loop on filters registered
foreach( (array) $wp\_filter[$hook\_name][$priority] as $unique\_id => $filter\_array ) {
// Test if filter is an array ! (always for class/method)
if ( isset($filter\_array['function']) && is\_array($filter\_array['function']) ) {
// Test if object is a class, class and method is equal to param !
if ( is\_object($filter\_array['function'][0]) && get\_class($filter\_array['function'][0]) && get\_class($filter\_array['function'][0]) == $class\_name && $filter\_array['function'][1] == $method\_name ) {
// Test for WordPress >= 4.7 WP\_Hook class (https://make.wordpress.org/core/2016/09/08/wp\_hook-next-generation-actions-and-filters/)
if( is\_a( $wp\_filter[$hook\_name], 'WP\_Hook' ) ) {
unset( $wp\_filter[$hook\_name]->callbacks[$priority][$unique\_id] );
}
else {
unset($wp\_filter[$hook\_name][$priority][$unique\_id]);
}
}
}
}
return false;
}
// BuddyPress Compatibility
add\_action('amp\_init','ampforwp\_allow\_homepage\_bp');
function ampforwp\_allow\_homepage\_bp() {
add\_action( 'wp', 'ampforwp\_remove\_rel\_on\_bp' );
}
function ampforwp\_remove\_rel\_on\_bp(){
if(function\_exists('bp\_is\_activity\_component')||function\_exists('bp\_is\_members\_component')||function\_exists('bp\_is\_groups\_component'))
{
if(bp\_is\_activity\_component()|| bp\_is\_members\_component() || bp\_is\_groups\_component()){
remove\_action( 'wp\_head', 'amp\_frontend\_add\_canonical');
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
}
}
// Removing AMP from WPForo Forums Pages #592
if(class\_exists('wpForo')){
global $wpdb,$wpforo;
$foid = ampforwp\_get\_the\_ID();
$fid = $wpforo->pageid;
if($foid==$fid){
remove\_action( 'wp\_head', 'amp\_frontend\_add\_canonical');
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
}
}
}
// 66. Make AMP compatible with Squirrly SEO
add\_action('pre\_amp\_render\_post','ampforwp\_remove\_sq\_seo');
function ampforwp\_remove\_sq\_seo() {
$ampforwp\_sq\_google\_analytics = '';
$ampforwp\_sq\_amp\_analytics = '';
if ( class\_exists( 'SQ\_Tools' ) ) {
$ampforwp\_sq\_google\_analytics = SQ\_Tools::$options['sq\_google\_analytics'];
$ampforwp\_sq\_amp\_analytics = SQ\_Tools::$options['sq\_auto\_amp'];
}
if ( $ampforwp\_sq\_google\_analytics && $ampforwp\_sq\_amp\_analytics ) {
remove\_action('amp\_post\_template\_head','ampforwp\_register\_analytics\_script', 20);
}
}
//67 View Non AMP
function ampforwp\_view\_nonamp(){
global $redux\_builder\_amp, $post, $wp;
$nofollow = $page = $amp\_url = $non\_amp\_url = '';
if( true == ampforwp\_get\_setting('ampforwp-nofollow-view-nonamp') ){
$nofollow = 'rel=nofollow';
}
$amp\_url = ampforwp\_amphtml\_generator();
$amp\_url = explode('/', $amp\_url);
$amp\_url = array\_flip($amp\_url);
$endpoint = AMPFORWP\_AMP\_QUERY\_VAR;
if (ampforwp\_get\_setting('amp-core-end-point')) {
$endpoint = '?'. $endpoint;
}
unset($amp\_url[$endpoint]);
$non\_amp\_url = array\_flip($amp\_url);
$non\_amp\_url = implode('/', $non\_amp\_url);
$query\_arg\_array = $wp->query\_vars;
if( array\_key\_exists( "page" , $query\_arg\_array ) ) {
$page = $wp->query\_vars['page'];
}
if ( $page >= '2') {
$non\_amp\_url = trailingslashit( $non\_amp\_url . '?page=' . $page);
}
if ( ampforwp\_get\_setting('amp-mobile-redirection')==true && ampforwp\_get\_setting('amp-mob-redirection-pres-link')==false) {
$non\_amp\_url = user\_trailingslashit($non\_amp\_url);
$non\_amp\_url = add\_query\_arg('nonamp','1',$non\_amp\_url);
}
else
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
$non\_amp\_url = user\_trailingslashit($non\_amp\_url);
if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) {
$non\_amp\_url = '';
}
$permalink = get\_option('permalink\_structure');
if(strpos($permalink, '/%year%/%monthnum%/%day%/%postname%/') !== false){
$non\_amp\_url = get\_permalink(ampforwp\_get\_the\_ID());
}
if ( $non\_amp\_url ) { ?> [title="php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_get\_setting('amp-translator-non-amp-page-text') ?">php if(function\_exists('pll\_\_')){
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo pll\_\_(esc\_html( ampforwp\_get\_setting('amp-translator-non-amp-page-text')));
}else{echo esc\_html( ampforwp\_get\_setting('amp-translator-non-amp-page-text'));}?](%3C?php echo esc_url(apply_filters('ampforwp_view_nonamp_url', $non_amp_url) ) ?>) php }
}
//68. Facebook Instant Articles
add\_action('init', 'ampforwp\_fb\_instant\_article\_feed\_generator');
function ampforwp\_fb\_instant\_article\_feed\_generator() {
if( ampforwp\_get\_setting('fb-instant-article-switch') ) {
add\_feed('instant\_articles', 'ampforwp\_fb\_instant\_article\_feed\_function');
add\_action( 'ampforwp\_fbia\_head', 'ampforwp\_fbia\_meta\_tags' );
require AMPFORWP\_PLUGIN\_DIR . '/templates/instant-articles/instant-article-sanitizer.php';
}
}
function ampforwp\_fb\_instant\_article\_feed\_function() {
add\_filter('pre\_option\_rss\_use\_excerpt', '\_\_return\_zero');
load\_template( AMPFORWP\_PLUGIN\_DIR . '/feeds/instant-article-feed.php' );
}
if ( ! function\_exists('ampforwp\_fbia\_meta\_tags') ) {
function ampforwp\_fbia\_meta\_tags(){
global $redux\_builder\_amp;
// undefined index fb-instant-page-id #2610
$fb\_page\_id = '';
$fb\_page\_id = ampforwp\_get\_setting('fb-instant-page-id');
// Page ID meta Tag
if( $fb\_page\_id ) { ?
php }
// undefined index fb-instant-page-id ends here #2610
$post = get\_post();
// If there's no current post, return
if ( ! $post ) {
return;
}
$url = get\_permalink();
$url = add\_query\_arg( 'ia\_markup', '1', $url );
// ia markup meta tag
if( ampforwp\_get\_setting('fb-instant-crawler-ingestion') ) { ?
php }
}
}
// 69. Post Pagination #834 #857
function ampforwp\_post\_pagination( $args = '' ) {
wp\_reset\_postdata();
global $page, $numpages, $multipage, $more, $redux\_builder\_amp;
if ( ampforwp\_is\_front\_page() ) {
$id = ampforwp\_get\_frontpage\_id();
$content\_post = get\_post($id);
$content = $content\_post-post\_content;
$checker = preg\_match('//', $content);
if ( 1 === $checker ) {
$multipage = $more = 1;
$ampforwp\_new\_content = explode('', $content);
$queried\_var = get\_query\_var('paged');
if ( $queried\_var > 1 ) {
$page = $queried\_var;
}
$numpages = count($ampforwp\_new\_content);
}
}else{
$amp\_current\_post\_id =ampforwp\_get\_the\_ID();
$amp\_custom\_content\_enable = get\_post\_meta( $amp\_current\_post\_id , 'ampforwp\_custom\_content\_editor\_checkbox', true);
if($amp\_custom\_content\_enable=='yes'){
$content = get\_post\_meta ( $amp\_current\_post\_id, 'ampforwp\_custom\_content\_editor', true );
$content = html\_entity\_decode($content);
$checker = preg\_match('//', $content);
if ( 1 === $checker ) {
$multipage = $more = 1;
$ampforwp\_new\_content = explode('', $content);
$queried\_var = get\_query\_var('paged');
if ( $queried\_var > 1 ) {
$page = $queried\_var;
}
$numpages = count($ampforwp\_new\_content);
}
}else if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){
$id = ampforwp\_get\_the\_ID();
$content = get\_post\_field( 'post\_content', $id);
if ($content) {
$sanitizer\_obj = new AMPFORWP\_Content( $content,
apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' => array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_DailyMotion\_Embed\_Handler' => array(),
'AMP\_Vimeo\_Embed\_Handler' => array(),
'AMP\_SoundCloud\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Pinterest\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
'AMP\_Playlist\_Embed\_Handler' => array(),
'AMP\_Tiktok\_Embed\_Handler'=>array(),
) ),
apply\_filters( 'amp\_content\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Playbuzz\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
) ) );
$content = $sanitizer\_obj->get\_amp\_content();
$checker = preg\_match('//', $content);
if ( 1 === $checker ) {
$multipage = $more = 1;
$ampforwp\_new\_content = explode('', $content);
$queried\_var = get\_query\_var('paged');
if ( $queried\_var > 1 ) {
$page = $queried\_var;
}
$numpages = count($ampforwp\_new\_content);
}
}
}
}
$defaults = array(
'before' => '

' . '' . ampforwp\_translation($redux\_builder\_amp['amp-translator-page-text'], 'Page') . ':',
'after' => '

',
'link\_before' => '',
'link\_after' => '',
'next\_or\_number' => 'number',
'separator' => ' ',
'nextpagelink' => ampforwp\_translation($redux\_builder\_amp['amp-translator-next-text'], 'Next'),
'previouspagelink' => ampforwp\_translation($redux\_builder\_amp['amp-translator-previous-text'], 'Previous'),
'pagelink' => '%',
'echo' => 1
);
$params = wp\_parse\_args( $args, $defaults );
/\*\*
\* Filters the arguments used in retrieving page links for paginated posts.
\* @param array $params An array of arguments for page links for paginated posts.
\*/
$r = apply\_filters( 'ampforwp\_post\_pagination\_args', $params );
if ( isset($redux\_builder\_amp['ampforwp-pagination-select']) && 2 == $redux\_builder\_amp['ampforwp-pagination-select'] ) {
$r['next\_or\_number'] = 'next';
$r['before'] = '

';
$r['after'] = '

';
}
$output = '';
if ( $multipage ) {
if ( 'number' == $r['next\_or\_number'] ) {
$output .= $r['before'];
for ( $i = 1; $i <= $numpages; $i++ ) {
$link = $r['link\_before'] . str\_replace( '%', ''.$i.'', $r['pagelink'] ) . $r['link\_after'];
if ( $i != $page || ! $more && 1 == $page ) {
$link = ampforwp\_post\_paginated\_link\_generator( $i ) . $link . '';
}
/\*\*
\* Filters the HTML output of individual page number links.
\* @param string $link The page number HTML output.
\* @param int $i Page number for paginated posts' page links.
\*/
$link = apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $i );
// Use the custom links separator beginning with the second link.
$output .= ( 1 === $i ) ? ' ' : $r['separator'];
$output .= $link;
}
$output .= $r['after'];
} elseif ( $more ) {
$output .= $r['before'];
$prev = $page - 1;
if ( $prev > 0 ) {
$link = ampforwp\_post\_paginated\_link\_generator( $prev ) . $r['link\_before'] . $r['previouspagelink'] . $r['link\_after'] . '';
$output .= apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $prev );
}
$output .= $r['separator'];
$text = $page . ' of ' . $numpages;
$output .= apply\_filters( 'ampforwp\_post\_pagination\_page', $text, $page, $numpages);
$next = $page + 1;
if ( $next <= $numpages ) {
$output .= $r['separator'];
$link = ampforwp\_post\_paginated\_link\_generator( $next ) . $r['link\_before'] . $r['nextpagelink'] . $r['link\_after'] . '';
$output .= apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $next );
}
$output .= $r['after'];
}
}
/\*\*
\* Filters the HTML output of page links for paginated posts.
\* @param string $output HTML output of paginated posts' page links.
\* @param array $args An array of arguments.
\*/
$html = apply\_filters( 'ampforwp\_post\_pagination', $output, $args );
if($redux\_builder\_amp['amp-pagination']) {
if ( $r['echo'] ) {
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $html;
}
return $html;
}
}
/\*\*
\* Helper function for ampforwp\_post\_pagination().
\* @access private
\*
\* @global WP\_Rewrite $wp\_rewrite
\*
\* @param int $i Page number.
\* @return string Link.
\*/
function ampforwp\_post\_paginated\_link\_generator( $i ) {
global $wp\_rewrite;
$post = get\_post();
if ( ampforwp\_is\_front\_page() ) {
$id = ampforwp\_get\_frontpage\_id();
$post = get\_post($id);
}
$query\_args = array();
if ( 1 == $i ) {
$url = get\_permalink();
if(ampforwp\_is\_front\_page()){
$url = get\_home\_url();
}
} else {
if ( '' == get\_option('permalink\_structure') || in\_array($post->post\_status, array('draft', 'pending')) ) {
$url = add\_query\_arg( 'page', $i, get\_permalink() );
if(ampforwp\_is\_front\_page()){
$url = add\_query\_arg( 'page', $i, get\_home\_url() );
}
}
elseif ( ampforwp\_is\_front\_page() )
$url = trailingslashit(get\_home\_url()) . user\_trailingslashit("$wp\_rewrite->pagination\_base/" . $i, 'single\_paged');
else
$url = trailingslashit(get\_permalink()) . user\_trailingslashit($i, 'single\_paged');
}
if ( is\_preview() ) {
// phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Reason: We are not processing form information.
if ( ( 'draft' !== $post->post\_status ) && isset( $\_GET['preview\_id'], $\_GET['preview\_nonce'] ) ) {
// phpcs:ignore WordPress.Security.NonceVerification.Recommended,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
$query\_args['preview\_id'] = wp\_unslash( $\_GET['preview\_id'] );
// phpcs:ignore WordPress.Security.NonceVerification.Recommended,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized
$query\_args['preview\_nonce'] = wp\_unslash( $\_GET['preview\_nonce'] );
}
$url = get\_preview\_post\_link( $post, $query\_args, $url );
}
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
if ( false == ampforwp\_get\_setting('ampforwp-amp-takeover') && $mob\_pres\_link == false) {
if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){
$url = ampforwp\_url\_controller($url);
}else{
$url = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1',$url);
}
}
return '[';
}
// Modify the content to make Pagination work on Pages and FrontPage #2253
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_post\_paginated\_content');
function ampforwp\_post\_paginated\_content($content){
//Embed pinterest images to the amp #4361
if(preg\_match('/<\/a>/', $content)){
$content = preg\_replace('/<\/a>/', '', $content);
}
if ( is\_singular() || ampforwp\_is\_front\_page() ){
global $redux\_builder\_amp, $page, $multipage;
$ampforwp\_new\_content = $ampforwp\_the\_content = $checker = '';
if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){
if (get\_query\_var('paged') > 1) {
$id = ampforwp\_get\_the\_ID();
$content = get\_post\_field( 'post\_content', $id);
}
if ($content) {
$sanitizer\_obj = new AMPFORWP\_Content( $content,
apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' => array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_DailyMotion\_Embed\_Handler' => array(),
'AMP\_Vimeo\_Embed\_Handler' => array(),
'AMP\_SoundCloud\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Pinterest\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
'AMP\_Playlist\_Embed\_Handler' => array(),
'AMP\_Tiktok\_Embed\_Handler'=>array(),
) ),
apply\_filters( 'amp\_content\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Playbuzz\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
) ) );
$content = $sanitizer\_obj->get\_amp\_content();
$queried\_var = get\_query\_var('paged');
$con = explode("", $content);
if($queried\_var>=2){
if(isset($con[$queried\_var-1])){
$content = $con[$queried\_var-1];
}
}
}
$ampforwp\_the\_content = $content;
$checker = preg\_match('//', $ampforwp\_the\_content);
if ( 1 === $checker && true == ampforwp\_get\_setting('amp-pagination') ) {
$multipage = 1;
$ampforwp\_new\_content = explode('', $ampforwp\_the\_content);
$queried\_var = get\_query\_var('page');
if ( ampforwp\_is\_front\_page() ) {
$queried\_var = get\_query\_var('paged');
}
if ( $queried\_var > 1 ) {
$queried\_var = $queried\_var -1 ;
}
else {
$queried\_var = 0;
}
return $ampforwp\_new\_content[$queried\_var];
}
else {
return $ampforwp\_the\_content;
}
}
}
return $content;
}
add\_filter('ampforwp\_modify\_rel\_canonical','ampforwp\_modify\_rel\_amphtml\_paginated\_post');
function ampforwp\_modify\_rel\_amphtml\_paginated\_post($url) {
if(is\_single()){
$post\_paginated\_page='';
$post\_paginated\_page = get\_query\_var('page');
$permalink\_structure = '';
$permalink\_structure = get\_option('permalink\_structure');
if($post\_paginated\_page){
$url = get\_permalink();
if('' == $permalink\_structure){
$new\_url = add\_query\_arg('page',$post\_paginated\_page,$url);
}
else{
$new\_url = trailingslashit($url) . user\_trailingslashit($post\_paginated\_page);
}
if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true ){
$new\_url = ampforwp\_url\_controller($new\_url);
}else{
$new\_url = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1',$new\_url);
}
return $new\_url;
}
}
return $url;
}
add\_action('amp\_post\_template\_head','ampforwp\_modify\_rel\_canonical\_paginated\_post',9);
function ampforwp\_modify\_rel\_canonical\_paginated\_post(){
if(is\_single()){
$post\_paginated\_page='';
$post\_paginated\_page = get\_query\_var('page');
if($post\_paginated\_page && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')){
remove\_action( 'amp\_post\_template\_head', 'AMPforWP\\AMPVendor\\amp\_post\_template\_add\_canonical' );
add\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_paginated\_post');
}
}
}
function ampforwp\_rel\_canonical\_paginated\_post(){
$post\_paginated\_page='';
$new\_canonical\_url = '';
$permalink\_structure = '';
$permalink\_structure = get\_option('permalink\_structure');
global $post;
$current\_post\_id = $post->ID;
$new\_canonical\_url = get\_permalink($current\_post\_id);
$new\_canonical\_url = trailingslashit($new\_canonical\_url);
$post\_paginated\_page = get\_query\_var('page');
if($post\_paginated\_page){
if('' == $permalink\_structure){
$new\_canonical\_url = add\_query\_arg('page',$post\_paginated\_page,$new\_canonical\_url);
}
else{
$new\_canonical\_url = $new\_canonical\_url.$post\_paginated\_page;
}
?>
php }
}
add\_action('ampforwp\_after\_post\_content','ampforwp\_post\_pagination');
// Generating Canonical Url for Yoast no index pages.
add\_filter( 'wpseo\_robots\_array', 'ampforwp\_yoast\_no\_index\_condition\_check',20,2);
function ampforwp\_yoast\_no\_index\_condition\_check($robots,$object){
global $yoast\_data;
if($robots['index'] == 'noindex'){
$yoast\_data['canonical'] = $object-model->permalink;
add\_action( 'amp\_post\_template\_head', 'ampforwp\_generate\_yoast\_no\_index\_canonical\_url' );
}
return $robots;
}
function ampforwp\_generate\_yoast\_no\_index\_canonical\_url(){
global $yoast\_data;
if(isset($yoast\_data['canonical'])){
$canonical\_url = $yoast\_data['canonical'];
if(ampforwp\_is\_home() || ampforwp\_is\_front\_page()){
$canonical\_url = user\_trailingslashit(get\_home\_url());
} ?>

php }
}
// Modified Homepage wrong canonical url generated by yoast
add\_action('pre\_amp\_render\_post','ampforwp\_modify\_yoast\_amp\_homepage\_canonical');
function ampforwp\_modify\_yoast\_amp\_homepage\_canonical(){
add\_filter('wpseo\_canonical','ampforwp\_modify\_yoast\_homepage\_canonical\_url',20);
}
function ampforwp\_modify\_yoast\_homepage\_canonical\_url($canonical\_url){
if(ampforwp\_is\_home() || ampforwp\_is\_front\_page()){
$canonical\_url = user\_trailingslashit(get\_home\_url());
}
return esc\_url($canonical\_url);
}
// 70. Hide AMP by specific Categories & Tags #872
function ampforwp\_posts\_to\_remove () {
if(is\_category()){
if(ampforwp\_get\_setting('ampforwp-archive-support-cat')==false){
return false;
}
}
if(is\_tag()){
if(ampforwp\_get\_setting('ampforwp-archive-support-tag')==false){
return false;
}
}
if(ampforwp\_get\_setting('hide-amp-categories2')){
if ( has\_category(array\_filter(ampforwp\_get\_setting('hide-amp-categories2'))) ) {
return true;
}
}
if( ampforwp\_get\_setting('hide-amp-tags-bulk-option2') ) {
if ( has\_tag(array\_filter(ampforwp\_get\_setting('hide-amp-tags-bulk-option2') )) ) {
return true;
}
}
return false;
}
// Excluded Categories
if ( ! function\_exists('ampforwp\_exclude\_archive') ) {
function ampforwp\_exclude\_archive($archive = 'cat'){
global $redux\_builder\_amp;
$exclude = array();
// Categories
if ( is\_array(ampforwp\_get\_setting('hide-amp-categories2')) && 'cat' == $archive ) {
$exclude = array\_values(array\_filter(ampforwp\_get\_setting('hide-amp-categories2') ) );
return $exclude;
}
// Tags
if ( is\_array(ampforwp\_get\_setting('hide-amp-tags-bulk-option2')) && 'tag' == $archive ) {
$exclude = array\_values(array\_filter(ampforwp\_get\_setting('hide-amp-tags-bulk-option2')));
return $exclude;
}
}
}
add\_filter( 'amp\_skip\_post', 'ampforwp\_cat\_specific\_skip\_amp\_post', 10, 3 );
function ampforwp\_cat\_specific\_skip\_amp\_post( $skip, $post\_id, $post ) {
$skip\_this\_post = '';
$skip\_this\_post = ampforwp\_posts\_to\_remove();
$skip\_this\_post = apply\_filters( 'ampforwp\_skip\_category', $skip\_this\_post );
wp\_reset\_postdata();
if ( $skip\_this\_post ) {
$skip = true;
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
// #999 Disable mobile redirection
remove\_action( 'template\_redirect', 'ampforwp\_page\_template\_redirect', 30 );
}
return $skip;
}
// Exclude Posts from Loops based on Hide AMP Bulk Cats and Tags #2375
add\_filter('ampforwp\_query\_args', 'ampforwp\_exclude\_archive\_args');
function ampforwp\_exclude\_archive\_args( $args ) {
global $redux\_builder\_amp;
if ( ampforwp\_exclude\_archive() ) {
$args['category\_\_not\_in'] = ampforwp\_exclude\_archive();
}
if ( ampforwp\_exclude\_archive('tag') ) {
$args['tag\_\_not\_in'] = ampforwp\_exclude\_archive('tag');
}
return $args;
}
add\_action('pre\_amp\_render\_post', 'ampforwp\_home\_archive\_canonical\_setter');
function ampforwp\_home\_archive\_canonical\_setter(){
add\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_home\_archive');
// Remove the canonical from the homepage if the Yoast 14 and above version is available
// Except for the homepage
if( class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') ) {
// phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Reason: We are not processing form information.
if ( ampforwp\_is\_home() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) && !isset($\_GET['lang'])) {
return ;
}
// phpcs:ignore WordPress.Security.NonceVerification.Recommended -- Reason: We are not processing form information.
if(ampforwp\_is\_front\_page() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) && !isset($\_GET['lang']) && !ampforwp\_get\_setting('ampforwp-amp-takeover')){
return ;
}
if(is\_search()){
return;
}
if(is\_tax()){
return;
}
remove\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_home\_archive');
if(function\_exists('wpseo\_premium\_init') && ! is\_singular() ){
add\_action( 'amp\_post\_template\_head', 'AMPforWP\\AMPVendor\\amp\_post\_template\_add\_canonical' );
}
}
}
function ampforwp\_rel\_canonical\_home\_archive(){
if (function\_exists('aioseo') && ((aioseo()-pro && (version\_compare(AIOSEO\_VERSION,'4.2.6')>=0)) || (!aioseo()->pro && (version\_compare(AIOSEO\_VERSION,'4.2.4')>0)))) {
return;
}
global $redux\_builder\_amp;
global $wp;
$current\_archive\_url = '';
$amp\_url = '';
$remove = '';
$query\_arg\_array = '';
$page = '' ;
if ( is\_home() || is\_front\_page() || (is\_archive() && ampforwp\_get\_setting('ampforwp-archive-support')) ) {
$current\_archive\_url = home\_url( $wp->request );
$amp\_url = trailingslashit($current\_archive\_url);
$amp\_url = explode('/', $amp\_url);
$amp\_url = array\_flip($amp\_url);
if(isset($amp\_url['amp'])){
unset($amp\_url['amp']);
}
$amp\_url = array\_flip($amp\_url);
$amp\_url = implode('/', $amp\_url);
$query\_arg\_array = $wp->query\_vars;
if( array\_key\_exists( "page" , $query\_arg\_array ) ) {
$page = $wp->query\_vars['page'];
}
if ( $page >= '2') {
$amp\_url = trailingslashit( $amp\_url . '?page=' . $page);
} ?>

php }
if(is\_search()){
$paged = get\_query\_var( 'paged' );
$current\_search\_url = trailingslashit(get\_home\_url())."?s=".get\_search\_query();
$amp\_url = untrailingslashit($current\_search\_url);
if ($paged  1 ) {
global $wp;
$current\_archive\_url = home\_url( $wp->request );
$amp\_url = trailingslashit($current\_archive\_url);
$remove = '/'. AMPFORWP\_AMP\_QUERY\_VAR;
$amp\_url = str\_replace($remove, '', $amp\_url) ;
$amp\_url = $amp\_url ."?s=".get\_search\_query();
}
?>

php
}
}
// 71. Alt tag for thumbnails #1013
function ampforwp\_thumbnail\_alt(){
$thumb\_id = '';
$thumb\_alt = '';
$thumb\_id = get\_post\_thumbnail\_id();
$thumb\_alt = get\_post\_meta( $thumb\_id, '\_wp\_attachment\_image\_alt', true) ;
if($thumb\_alt){
echo ' alt="' . esc\_attr($thumb\_alt) . '" ';
}
}
// 72. Blacklist Sanitizer Added back #1024
add\_filter('amp\_content\_sanitizers', 'ampforwp\_add\_blacklist\_sanitizer');
function ampforwp\_add\_blacklist\_sanitizer($data){
// Blacklist Sanitizer Added back until we find a better solution to replace it
$data['AMP\_Blacklist\_Sanitizer'] = array();
return $data;
}
//Compatibility with WP User Avatar #975
function ampforwp\_get\_wp\_user\_avatar($object='',$type=''){
include\_once( ABSPATH . 'wp-admin/includes/plugin.php' );
if(class\_exists('WP\_User\_Avatar\_Functions') && defined('PPRESS\_VERSION\_NUMBER') && version\_compare(PPRESS\_VERSION\_NUMBER,'3.0', '<')){
$user\_avatar\_url = '';
$user\_avatar\_url = get\_wp\_user\_avatar\_src($object);
return $user\_avatar\_url;
}
}
add\_filter('get\_amp\_supported\_post\_types','ampforwp\_supported\_post\_types');
function ampforwp\_supported\_post\_types($supported\_types){
global $redux\_builder\_amp;
include\_once( ABSPATH . 'wp-admin/includes/plugin.php' );
if( is\_plugin\_active( 'amp-custom-post-type/amp-custom-post-type.php' ) ) {
if ( isset($redux\_builder\_amp['ampforwp-custom-type']) && $redux\_builder\_amp['ampforwp-custom-type'] ) {
foreach($redux\_builder\_amp['ampforwp-custom-type'] as $custom\_post){
$supported\_types[] = $custom\_post;
}
}
}
if( is\_plugin\_active( 'amp-woocommerce/amp-woocommerce.php' ) ) {
if( !in\_array("product", $supported\_types) ){
$supported\_types[]= 'product';
}
}
return $supported\_types;
}
// is\_category\_amp\_disabled #872 & #2549
function is\_category\_amp\_disabled(){
if(is\_archive() && ampforwp\_get\_setting('ampforwp-archive-support') ){
if(is\_tag() && is\_array(ampforwp\_get\_setting('hide-amp-tags-bulk-option2') ) ) {
if ( in\_array(get\_query\_var( 'tag\_id' ), ampforwp\_get\_setting('hide-amp-tags-bulk-option2')) ){
return true;
}
}//tags check area closed
if ( is\_category() && is\_array(ampforwp\_get\_setting('hide-amp-categories2')) ) {
if ( in\_array(get\_query\_var( 'cat' ), ampforwp\_get\_setting('hide-amp-categories2') ) ){
return true;
}
}
}
return false;
}
// 73. View AMP Site below View Site In Dashboard #1076
add\_action( 'admin\_bar\_menu', 'ampforwp\_visit\_amp\_in\_admin\_bar',999 );
function ampforwp\_visit\_amp\_in\_admin\_bar($admin\_bar) {
global $redux\_builder\_amp;
if ( ampforwp\_get\_setting('ampforwp-homepage-on-off-support') && false == ampforwp\_get\_setting('ampforwp-amp-takeover') ) {
$args = array(
'parent' = 'site-name',
'id' => 'view-amp',
'title' => 'Visit AMP',
'href' => ampforwp\_url\_controller( get\_home\_url() ),
'meta' => array('target' => '\_blank')
);
$admin\_bar->add\_node( $args );
}
}
// Things to be added in the Body Tag #1064
add\_action('ampforwp\_body\_beginning','ampforwp\_body\_beginning\_html\_output',11);
function ampforwp\_body\_beginning\_html\_output(){
if( ampforwp\_get\_setting('amp-body-text-area') ) {
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_get\_setting('amp-body-text-area') ;
}
}
add\_filter('get\_amp\_supported\_post\_types','is\_amp\_post\_support\_enabled');
function is\_amp\_post\_support\_enabled($supportedTypes){
global $redux\_builder\_amp;
if( isset( $redux\_builder\_amp['amp-on-off-for-all-posts'] ) ) {
if($redux\_builder\_amp['amp-on-off-for-all-posts']!='1'){
$index = array\_search('post',$supportedTypes);
unset($supportedTypes[$index]);
}elseif($redux\_builder\_amp['amp-on-off-for-all-posts']==1){
$supportedTypes[] = 'post';
$supportedTypes = array\_unique($supportedTypes);
}
}
return $supportedTypes;
}
// 74. Featured Image check from Custom Fields
// Moved to functions.php
function ampforwp\_cf\_featured\_image\_src($param=""){
global $redux\_builder\_amp, $post;
if($redux\_builder\_amp['ampforwp-custom-fields-featured-image-switch']){
$post\_id = '';
$custom\_fields = '';
$featured\_image\_field = '';
$output = '';
$custom\_fields\_name = array();
$post\_id = get\_the\_ID();
$custom\_fields = get\_post\_custom($post\_id);
foreach ($custom\_fields as $key => $value) {
$custom\_fields\_name[] = $key;
}
$featured\_image\_field = $redux\_builder\_amp['ampforwp-custom-fields-featured-image'];
if(in\_array($featured\_image\_field, $custom\_fields\_name)){
$amp\_img\_src = $custom\_fields[$featured\_image\_field][0];
$image = @getimagesize($amp\_img\_src);
if(empty($image) || $image==false){
$img\_id = attachment\_url\_to\_postid($amp\_img\_src);
$imageDetail = wp\_get\_attachment\_image\_src( $img\_id , 'full');
$image[0] = $imageDetail[1];
$image[1] = $imageDetail[2];
}
switch ($param) {
case 'url':
$output = $amp\_img\_src;
break;
case 'width':
$output = $image[0];
break;
case 'height':
$output = $image[1];
break;
default:
$output = $amp\_img\_src;
break;
}
return $output;
}
}
}
// 75. Dev Mode in AMP
add\_action('amp\_init','ampforwp\_dev\_mode');
function ampforwp\_dev\_mode(){
global $redux\_builder\_amp;
if(isset($redux\_builder\_amp['ampforwp-development-mode']) && $redux\_builder\_amp['ampforwp-development-mode']){
add\_action( 'wp', 'ampforwp\_dev\_mode\_remove\_amphtml' );
add\_action( 'amp\_post\_template\_head', 'ampforwp\_dev\_mode\_add\_noindex' );
}
}
// Remove amphtml from non-AMP
function ampforwp\_dev\_mode\_remove\_amphtml(){
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
}
// Add noindex,nofollow in the AMP
if ( ! function\_exists('ampforwp\_dev\_mode\_add\_noindex') ) {
function ampforwp\_dev\_mode\_add\_noindex() {
global $redux\_builder\_amp;
if ( isset( $redux\_builder\_amp['amp-inspection-tool'] ) && false == $redux\_builder\_amp['amp-inspection-tool'] ){
echo '';
}
}
}
// 76. Body Class for AMP pages
if (! function\_exists( 'ampforwp\_body\_class' ) ) {
function ampforwp\_body\_class( $class = '' ) {
// Separates classes with a single space, collates classes for body element
echo 'class="' . esc\_attr(join( ' ', ampforwp\_get\_body\_class( $class ) )) . '"';
}
}
if (! function\_exists( 'ampforwp\_get\_body\_class' ) ) {
function ampforwp\_get\_body\_class( $class = '' ){
global $wp\_query, $redux\_builder\_amp, $post;
$classes = array();
$post\_id = '';
$post\_type = '';
$classes[] = 'body';
if ( is\_singular() ) {
$post\_id = $post->ID;
$classes[] = 'single-post';
}
if ( ampforwp\_is\_front\_page() ) {
$post\_id = ampforwp\_get\_frontpage\_id();
}
if ( ampforwp\_is\_front\_page() ) {
$classes[] = 'amp-frontpage';
}
if(true == ampforwp\_get\_setting('amp-rtl-select-option')){
$classes[] = 'rtl';
}
$classes[] = $post\_id;
if ( $post\_id ) {
$classes[] = 'post-id-' . $post\_id;
$classes[] = 'singular-' . $post\_id;
}
if ( is\_page() ) {
$classes[] = 'amp-single-page';
}
if ( is\_post\_type\_archive() ) {
$post\_type = get\_queried\_object();
$classes[] = 'type-'. $post\_type->rewrite['slug'];
}
if ( is\_archive() ) {
$page\_id = get\_queried\_object\_id();
$classes[] = 'archives\_body archive-'. $page\_id;
}
if ( ! empty( $class ) ) {
if ( !is\_array( $class ) )
$class = preg\_split( '#\s+#', $class );
$classes = array\_merge( $classes, $class );
} else {
// Ensure that we always coerce class to being an array.
$class = array();
}
if(is\_tax()){
$term = get\_queried\_object();
if ( isset( $term->term\_id ) ) {
$term\_class = sanitize\_html\_class( $term->slug, $term->term\_id );
if ( is\_numeric( $term\_class ) || ! trim( $term\_class, '-' ) ) {
$term\_class = $term->term\_id;
}
$classes[] = 'tax-' . sanitize\_html\_class( $term->taxonomy );
$classes[] = 'term-' . $term\_class;
$classes[] = 'term-' . $term->term\_id;
}
}else{
$classes[] = get\_post\_type();
}
$classes[] = AMPFORWP\_VERSION;
$classes = array\_map( 'esc\_attr', $classes );
$classes = apply\_filters( 'ampforwp\_body\_class', $classes, $class );
return array\_unique( $classes );
}
}
// Fallback for ticket #1006
function ampforwp\_the\_body\_class(){ return ;}
// 77. AMP Blog Details
// Moved to functions.php
// 78. Saved Custom Post Types for AMP in Options for Structured Data
add\_action("redux/options/redux\_builder\_amp/saved",'ampforwp\_save\_custom\_post\_types\_sd', 10, 1);
if(! function\_exists('ampforwp\_save\_custom\_post\_types\_sd') ) {
function ampforwp\_save\_custom\_post\_types\_sd( $redux\_builder\_amp ){
global $redux\_builder\_amp;
$post\_types = array();
$saved\_custom\_posts = array();
$count\_current\_pt = "";
$count\_saved\_pt = "";
$array\_1 = "";
$array\_2 = "";
$saved\_custom\_posts = get\_option('ampforwp\_custom\_post\_types');
$post\_types = ampforwp\_get\_all\_post\_types();
if (empty($post\_types)) {
$post\_types = array();
}
if (empty($saved\_custom\_posts)) {
update\_option('ampforwp\_custom\_post\_types', $post\_types, false);
}
if ( empty( $saved\_custom\_posts ) ) {
$saved\_custom\_posts = array();
}
$count\_current\_pt = count( $post\_types );
$count\_saved\_pt = count( $saved\_custom\_posts );
if ( $count\_current\_pt > $count\_saved\_pt) {
$array\_1 = $post\_types;
$array\_2 = $saved\_custom\_posts;
} else {
$array\_1 = $saved\_custom\_posts;
$array\_2 = $post\_types;
}
if( array\_diff( $array\_1, $array\_2 ) ){
update\_option('ampforwp\_custom\_post\_types', $post\_types, false);
}
}
}
// 79. Favicon for AMP
add\_action('amp\_post\_template\_head','wp\_site\_icon');
// 81. Duplicate Featured Image Support
add\_filter('ampforwp\_allow\_featured\_image', 'ampforwp\_enable\_post\_and\_featured\_image');
function ampforwp\_enable\_post\_and\_featured\_image($show\_image){
global $redux\_builder\_amp;
if ( isset($redux\_builder\_amp['ampforwp-duplicate-featured-image']) && $redux\_builder\_amp['ampforwp-duplicate-featured-image'] == 1 ) {
$show\_image = true;
}
return $show\_image;
}
// 82. Grab Featured Image from The Content
function ampforwp\_get\_featured\_image\_from\_content( $featured\_image = "", $size="") {
if(get\_the\_post\_thumbnail\_url()){
return;
}
global $post, $posts;
$image\_url = $image\_width = $image\_height = $output = $matches = $output\_fig = $amp\_html\_sanitizer = $amp\_html = $image\_html = $featured\_image\_output = $matches\_fig = $figure = $output\_fig\_image = $matches\_fig\_img = '';
ob\_start();
ob\_end\_clean();
// Match all the images from the content
if(is\_object($post)){
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
$output = preg\_match\_all('//i', $post->post\_content, $matches);
// Match all the figure tags from the content
$output\_fig = preg\_match\_all('/\[caption.+id=[\'"]([^\'"]+).\*]/i', $post->post\_content, $matches\_fig);
if ( $output\_fig && $matches\_fig[0][0] ) {
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
$output\_fig\_image = preg\_match\_all('/(.\*)\[/i', $matches\_fig[0][0], $matches\_fig\_img);
// Check if the first image is inside the figure and it got caption
if ( $matches\_fig\_img[1][0] == $matches[1][0] && $matches\_fig\_img[4][0]) {
$figure = true;
}
}
}
//Grab the First Image
if ((is\_array($matches) && $matches[0]) || $output==0 ) {
if($output==1){
$image\_url = $matches[1][0];
$image\_html = $matches[0][0];
$image\_width = $matches[2][0];
$image\_height = $matches[3][0];
}
if($output==0 && is\_object($post) && isset($post->post\_content)){
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
if(preg\_match('/()<\/figure>/', $post->post\_content, $fm)){
if(isset( $fm[2])){
$dom = new DOMDocument();
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
preg\_match('//', $fm[2],$fmatch);
if(isset($fmatch[0])){
$image\_html = $fmatch[0];
$dom->loadHTML($image\_html);
$x = new DOMXPath($dom);
foreach($x->query("//img") as $node){
$node->setAttribute("width","1366");
$node->setAttribute("height","600");
}
$image\_html = $dom->saveHtml();
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
preg\_match\_all('//', $image\_html, $fimg);
if(isset($fimg[0][0])){
$image\_html =''.$fimg[0][0].'';
if(isset($fmatch[1])){
$image\_url = $fmatch[1];
$image\_width = 1366;
$image\_height = 600;
}
}
}
}
}else{
// phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage
preg\_match\_all('//i', $post->post\_content, $matches);
if(isset($matches[2][0])){
$image\_html = $matches[0][0];
$image\_url = $matches[2][0];
$image\_width = 1366;
$image\_height = 600;
}
}
}
// Sanitize it
$amp\_html\_sanitizer = new AMPFORWP\_Content( $image\_html, array(), apply\_filters( 'ampforwp\_content\_sanitizers', array( 'AMP\_Img\_Sanitizer' => array(), 'AMP\_Style\_Sanitizer' => array() ) ) );
$amp\_html = $amp\_html\_sanitizer->get\_amp\_content();
// If its figure then add the figcaption inside the figure
if ( $figure ) {
$amp\_html = $amp\_html . '

' . esc\_attr($matches\_fig\_img[4][0]) . '

';
}
// Filter to remove that image from the content
add\_filter('ampforwp\_modify\_the\_content','featured\_image\_content\_filter');
if ( isset( $size ) && '' !== $size) {
$image\_id = attachment\_url\_to\_postid( $image\_url );
if ($image\_id) {
$image\_array = wp\_get\_attachment\_image\_src($image\_id, $size, true);
$image\_url = $image\_array[0];
$image\_width = $image\_array[1];
$image\_height = $image\_array[2];
}
}
}
switch ($featured\_image) {
case 'image':
$featured\_image\_output = $amp\_html;
break;
case 'url':
$featured\_image\_output = $image\_url;
break;
case 'width':
$featured\_image\_output = $image\_width;
break;
case 'height':
$featured\_image\_output = $image\_height;
break;
default:
$featured\_image\_output = $amp\_html;
break;
}
return $featured\_image\_output;
}
// Remove 1st image from the content if Featured image from the content option is enabled
if( ! function\_exists( 'featured\_image\_content\_filter' ) ){
function featured\_image\_content\_filter($content){
global $redux\_builder\_amp;
$featured\_image = "";
$featured\_image = ampforwp\_get\_featured\_image\_from\_content('url');
if( $featured\_image && false == $redux\_builder\_amp['ampforwp-duplicate-featured-image']){
// Change the src to use it in the pattern
$featured\_image = str\_replace('/', '\/', $featured\_image);
// Remove the figure (due to caption)
$content = preg\_replace('//', '', $content);
// Remove the amp-img
if(false == has\_post\_thumbnail()){
$content = preg\_replace('//', '', $content);
}
}
return $content;
}
}
// 84. Inline Related Posts
function ampforwp\_inline\_related\_posts(){
global $post, $redux\_builder\_amp;
$string\_number\_of\_related\_posts = $redux\_builder\_amp['ampforwp-number-of-inline-related-posts'];
$int\_number\_of\_related\_posts = round(abs(floatval($string\_number\_of\_related\_posts)));
// declaring this variable here to prevent debug errors
$args = null;
$orderby = 'ID';
if( isset( $redux\_builder\_amp['ampforwp-inline-related-posts-order'] ) && $redux\_builder\_amp['ampforwp-inline-related-posts-order'] ){
$orderby = 'rand';
}
// Custom Post types
if( $current\_post\_type = get\_post\_type( $post )) {
// The query arguments
//#1263
if($current\_post\_type != 'page'){
$args = array(
'posts\_per\_page'=> $int\_number\_of\_related\_posts,
'order' => 'DESC',
'orderby' => $orderby,
'post\_type' => $current\_post\_type,
'no\_found\_rows' => true,
/\* phpcs:ignore WordPressVIPMinimum.Performance.WPQueryParams.PostNotIn\_post\_\_not\_in \*/
'post\_\_not\_in' => array( $post->ID )
);
}
}//end of block for custom Post types
if($redux\_builder\_amp['ampforwp-inline-related-posts-type']==2){
$categories = get\_the\_category($post->ID);
if ($categories) {
$category\_ids = array();
foreach($categories as $individual\_category) $category\_ids[] = $individual\_category->term\_id;
$args=array(
'category\_\_in' => $category\_ids,
/\* phpcs:ignore WordPressVIPMinimum.Performance.WPQueryParams.PostNotIn\_post\_\_not\_in \*/
'post\_\_not\_in' => array($post->ID),
'posts\_per\_page'=> $int\_number\_of\_related\_posts,
'ignore\_sticky\_posts'=>1,
'has\_password' => false ,
'post\_status'=> 'publish',
'no\_found\_rows' => true,
'orderby' => $orderby
);
}
} //end of block for categories
//code block for tags
if($redux\_builder\_amp['ampforwp-inline-related-posts-type']==1) {
$ampforwp\_tags = get\_the\_tags($post->ID);
if ($ampforwp\_tags) {
$tag\_ids = array();
foreach($ampforwp\_tags as $individual\_tag) $tag\_ids[] = $individual\_tag->term\_id;
$args=array(
'tag\_\_in' => $tag\_ids,
/\* phpcs:ignore WordPressVIPMinimum.Performance.WPQueryParams.PostNotIn\_post\_\_not\_in \*/
'post\_\_not\_in' => array($post->ID),
'posts\_per\_page'=> $int\_number\_of\_related\_posts,
'ignore\_sticky\_posts'=>1,
'has\_password' => false ,
'post\_status'=> 'publish',
'no\_found\_rows' => true,
'orderby' => $orderby
);
}
}//end of block for tags
if(true == ampforwp\_get\_setting('ampforwp-in-content-related-posts-days-switch')){
$date\_range = strtotime ( '-' . ampforwp\_get\_setting('ampforwp-in-content-related-posts-days-text') .' day' );
$args['date\_query'] = array(
array(
'after' => array(
'year' => gmdate( 'Y', esc\_html( $date\_range ) ),
'month' => gmdate( 'm', esc\_html( $date\_range ) ),
'day' => gmdate( 'd', esc\_html( $date\_range )),
),
)
);
}
$args = apply\_filters('ampforwp\_inlne\_related\_posts\_query\_args', $args);
$inline\_related\_posts = '';
$my\_query = new wp\_query( $args );
if( $my\_query->have\_posts() ) {
$inline\_related\_posts\_img = '';
$inline\_related\_posts = '
'.esc\_html(ampforwp\_translation( ampforwp\_get\_setting('amp-translator-incontent-related-text'), 'Related Post' )).'

';
while( $my\_query->have\_posts() ) {
$my\_query->the\_post();
$related\_post\_permalink = get\_permalink();
$related\_post\_permalink = trailingslashit($related\_post\_permalink);
$related\_post\_permalink = ampforwp\_url\_controller( $related\_post\_permalink );
$related\_post\_permalink = ampforwp\_modify\_url\_utm\_params($related\_post\_permalink);
if ( ampforwp\_has\_post\_thumbnail() ) {
$title\_class = 'has\_related\_thumbnail';
} else {
$title\_class = 'no\_related\_thumbnail';
}
$inline\_related\_posts .= '2. ';
   if ( true == $redux\_builder\_amp['ampforwp-single-related-posts-image'] ) {
   $inline\_related\_posts .= '[';
   $thumb\_url\_2 = ampforwp\_get\_post\_thumbnail('url');
   if ( ampforwp\_has\_post\_thumbnail() ) {
   if( 4 == $redux\_builder\_amp['amp-design-selector'] ){
   $r\_width = 220;
   $r\_height = 134;
   if(function\_exists('ampforwp\_get\_retina\_image\_settings')){
   $ret\_config = ampforwp\_get\_retina\_image\_settings($r\_width,$r\_height);
   $r\_width = intval($ret\_config['width']);
   $r\_height = intval($ret\_config['height']);
   }
   $thumb\_url\_2 = ampforwp\_aq\_resize( $thumb\_url\_2, $r\_width , $r\_height , true, false, true );
   $inline\_related\_posts\_img = '';
   if(!isset($thumb\_url\_2[0]) && is\_null($thumb\_url\_2[0]) || wp\_check\_filetype(ampforwp\_get\_post\_thumbnail('url') == 'svg')){
   $thumb\_url = ampforwp\_get\_post\_thumbnail('url');
   $inline\_related\_posts\_img = '';
   }
   }
   else{
   $r\_width = 150;
   $r\_height = 150;
   if(function\_exists('ampforwp\_get\_retina\_image\_settings')){
   $ret\_config = ampforwp\_get\_retina\_image\_settings($r\_width,$r\_height);
   $r\_width = intval($ret\_config['width']);
   $r\_height = intval($ret\_config['height']);
   }
   $thumb\_url\_2 = ampforwp\_aq\_resize( $thumb\_url\_2, $r\_width , $r\_height , true, false,true );
   $thumb\_url = $thumb\_url\_2[0];
   $thumb\_width = $thumb\_url\_2[1];
   $thumb\_height = $thumb\_url\_2[2];
   $inline\_related\_posts\_img = '';
   if(!isset($thumb\_url\_2[0]) && is\_null($thumb\_url\_2[0]) || wp\_check\_filetype(ampforwp\_get\_post\_thumbnail('url') == 'svg')){
   $thumb\_url = ampforwp\_get\_post\_thumbnail('url');
   $inline\_related\_posts\_img = '';
   }
   }
   $inline\_related\_posts\_img = apply\_filters("ampforwp\_modify\_inline\_rp\_loop\_image",$inline\_related\_posts\_img);
   $inline\_related\_posts .= $inline\_related\_posts\_img;
   }
   $inline\_related\_posts .='](%27.esc_url%28%20%24related_post_permalink%20%29.%27 "'.esc_attr(get_the_title()).'")';
   }
   $inline\_related\_posts .='';
   $inline\_related\_posts .='['.get\_the\_title().'](%27.esc_url%28%20%24related_post_permalink%20%29.%27)';
   if(ampforwp\_get\_setting('ampforwp-incontent-related-posts-excerpt')==1){
   if( has\_excerpt() ){
   $content ='

   '.get\_the\_excerpt().'

   ';
   }else{
   $content ='

   '.get\_the\_content().'

   ';
   }
   $inline\_related\_posts .= '

   '. wp\_trim\_words( strip\_shortcodes( $content ) , 15 ).'

   ';
   }
   $inline\_related\_posts .= '
';
}
$inline\_related\_posts .= '
';
}
wp\_reset\_postdata();
return $inline\_related\_posts;
//related posts code ends here
}
add\_action('pre\_amp\_render\_post','ampforwp\_add\_inline\_related\_posts');
function ampforwp\_add\_inline\_related\_posts(){
global $redux\_builder\_amp;
if($redux\_builder\_amp['ampforwp-inline-related-posts'] == 1 && is\_single() && ampforwp\_inline\_related\_posts() ){
if( isset($redux\_builder\_amp['ampforwp-inline-related-posts-display-type']) && $redux\_builder\_amp['ampforwp-inline-related-posts-display-type']=='middle' ){
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_generate\_inline\_related\_posts');
}else{
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_generate\_inline\_related\_posts\_by\_paragraph');
}
}
}
function ampforwp\_generate\_inline\_related\_posts($content){
global $post;
$break\_point = '';
$content\_parts = explode($break\_point, $content);
array\_walk($content\_parts, function(&$value, $key) {
$value = trim($value);
if( !empty($value) && (strpos($value, "

")!==false || strpos($value, "
> ")!==false)){
> $value .= '

';
$value .= '';
}
}
);
if(count($content\_parts)>1){
$no\_of\_parts = count($content\_parts);
$half\_index = floor($no\_of\_parts / 2);
$half\_content = array\_chunk($content\_parts, $half\_index);
$html =''.ampforwp\_inline\_related\_posts().'';
$half\_content[0][] = $html;
$final\_content ='';
foreach ($half\_content as $key => $value) {
$final\_content .= implode("", $value);
}
$content = $final\_content;
}
return $content;
}
function ampforwp\_generate\_inline\_related\_posts\_by\_paragraph($content){
global $redux\_builder\_amp;
$total\_count = '';
$int\_number\_of\_paragraphs = (integer) ampforwp\_get\_setting('ampforwp-related-posts-after-number-of-paragraphs');
if(isset($int\_number\_of\_paragraphs) && $int\_number\_of\_paragraphs!=''){
if($int\_number\_of\_paragraphs == 0){
$content = ''.ampforwp\_inline\_related\_posts().''.$content;
}else{
$total\_count = explode("", $content);
$total\_count = count($total\_count); // call count() only once, it's faster
if($total\_count < $int\_number\_of\_paragraphs){
$content = $content.''.ampforwp\_inline\_related\_posts().'';
}else{
$content = preg\_replace\_callback('#(

.\*?

)#', 'ampforwp\_add\_related\_post\_after\_paragraph', $content);
}
}
}else{
$content = $content.''.ampforwp\_inline\_related\_posts().'';
}
return $content;
}
function ampforwp\_add\_related\_post\_after\_paragraph($matches)
{
global $redux\_builder\_amp;
static $count = 0;
$ret = '';
$int\_number\_of\_paragraphs = (integer) ampforwp\_get\_setting('ampforwp-related-posts-after-number-of-paragraphs');
$ret = $matches[1];
if (++$count == $int\_number\_of\_paragraphs){
$ret .= ''.ampforwp\_inline\_related\_posts().'';
}
return $ret;
}
// 85. Caption for Gallery Images
// Add extra key=>value pair into the attachment array
add\_filter('amp\_gallery\_image\_params','ampforwp\_gallery\_new\_params', 10, 2);
function ampforwp\_gallery\_new\_params($urls, $attachment\_id ){
$img\_caption = $captext = '';
$new\_urls = $caption = array();
if(isset($urls['caption']) && $urls['caption'] ){
$img\_caption = $urls['caption'];
}
$captext = $img\_caption;
if($captext==""){
$captext = get\_post( $attachment\_id)->post\_excerpt;
}
if($captext){
// Append only when caption is present
$caption = array('caption'=>$captext);
$new\_urls = array\_merge($urls,$caption);
return $new\_urls;
}
else{
//If there's No caption
return $urls;
}
}
if( !function\_exists( 'ampforwp\_carousel\_class\_magic' ) ){
function ampforwp\_carousel\_class\_magic($content){
$content = str\_replace(array(':openbrack:',':closebrack:'), array('[',']'), $content);
return $content;
}
}
// 86. minify the content of pages
// Moved to performance-functions.php
// 87. Post Thumbnail
// Checker for Post Thumbnail
if( !function\_exists('ampforwp\_has\_post\_thumbnail')){
function ampforwp\_has\_post\_thumbnail(){
global $post, $redux\_builder\_amp;
if(class\_exists('Bunyad') && Bunyad::posts()->meta('featured\_video') ){
return true;
}elseif(function\_exists('has\_post\_video') && has\_post\_video($post->ID)){
return true;
}elseif(has\_post\_thumbnail()){
return true;
}
elseif(ampforwp\_is\_custom\_field\_featured\_image() && ampforwp\_cf\_featured\_image\_src()){
return true;
}
elseif(isset($redux\_builder\_amp['ampforwp-featured-image-from-content']) && $redux\_builder\_amp['ampforwp-featured-image-from-content'] == true){
if( ampforwp\_get\_featured\_image\_from\_content() || ampforwp\_get\_featured\_image\_from\_content('url') ){
return true;
}
}
else
return false;
}
}
// Get Post Thumbnail URL
if( !function\_exists('ampforwp\_get\_post\_thumbnail')){
function ampforwp\_get\_post\_thumbnail($param="", $size=""){
global $post, $redux\_builder\_amp;
$thumb\_url = '';
$thumb\_width = '';
$thumb\_height = '';
$output = '';
if ( has\_post\_thumbnail()) {
if( empty($size) ) {
$size = 'medium';
}
$thumb\_id = get\_post\_thumbnail\_id();
$thumb\_url\_array = wp\_get\_attachment\_image\_src($thumb\_id, $size , true);
$thumb\_url = $thumb\_url\_array[0];
$thumb\_width = $thumb\_url\_array[1];
$thumb\_height = $thumb\_url\_array[2];
$thumb\_alt = '';
$thumb\_alt = get\_post\_meta ( $thumb\_id, '\_wp\_attachment\_image\_alt', true );
}
if(ampforwp\_is\_custom\_field\_featured\_image() && ampforwp\_cf\_featured\_image\_src()){
$thumb\_url = ampforwp\_cf\_featured\_image\_src();
$thumb\_width = ampforwp\_cf\_featured\_image\_src('width');
$thumb\_height = ampforwp\_cf\_featured\_image\_src('height');
}
if( true == $redux\_builder\_amp['ampforwp-featured-image-from-content'] && ampforwp\_get\_featured\_image\_from\_content('url') ){
$thumb\_url = ampforwp\_get\_featured\_image\_from\_content('url', $size);
$thumb\_width = ampforwp\_get\_featured\_image\_from\_content('width', $size);
$thumb\_height = ampforwp\_get\_featured\_image\_from\_content('height', $size);
}
switch ($param) {
case 'url':
$output = $thumb\_url;
break;
case 'width':
$output = $thumb\_width;
break;
case 'height':
$output = $thumb\_height;
break;
case 'alt':
$output = $thumb\_alt;
break;
default:
$output = $thumb\_url;
break;
}
return $output;
}
}
// 88. Author Details
// Author Page URL
if( ! function\_exists( 'ampforwp\_get\_author\_page\_url' ) ){
function ampforwp\_get\_author\_page\_url(){
global $redux\_builder\_amp, $post;
$author\_id = '';
$author\_page\_url = '';
$author\_id = get\_the\_author\_meta( 'ID' );
$author\_page\_url = get\_author\_posts\_url( $author\_id );
// If Archive support is enabled
if( isset($redux\_builder\_amp['ampforwp-archive-support'] ) && $redux\_builder\_amp['ampforwp-archive-support'] ){
$author\_page\_url = ampforwp\_url\_controller( $author\_page\_url );
}
return $author\_page\_url;
}
}
// Author Meta
if( ! function\_exists( 'ampforwp\_get\_author\_details' ) ){
function ampforwp\_get\_author\_details( $post\_author , $params='' ){
global $redux\_builder\_amp, $post;
$post\_author\_url = '';
$post\_author\_name = '';
$post\_author\_name = $post\_author->display\_name;
$post\_author\_url = ampforwp\_get\_author\_page\_url();
$and\_text = '';
$and\_text = ampforwp\_translation($redux\_builder\_amp['amp-translator-and-text'], 'and' );
if ( function\_exists('coauthors') ) {
$post\_author\_name = coauthors($and\_text,$and\_text,null,null,false);
}
if ( function\_exists('coauthors\_posts\_links') ) {
$post\_author\_url = coauthors\_posts\_links($and\_text,$and\_text,null,null,false);
}
switch ($params) {
case 'meta-info':
if( isset($redux\_builder\_amp['ampforwp-author-page-url']) && $redux\_builder\_amp['ampforwp-author-page-url'] ) {
if ( function\_exists('coauthors\_posts\_links') ) {
return ''. $post\_author\_url .'';
}
return '['.esc\_html( $post\_author\_name ).'](%27.esc_url%28%24post_author_url%29.%27 "'.esc_html( $post_author_name ).'")';
}
else {
return '' .esc\_html( $post\_author\_name ).'';
}
break;
case 'meta-taxonomy':
if( isset($redux\_builder\_amp['ampforwp-author-page-url']) && $redux\_builder\_amp['ampforwp-author-page-url'] ) {
if ( function\_exists('coauthors\_posts\_links') ) {
return $post\_author\_url;
}
return '[**' . esc\_html( $post\_author\_name ) . '**](%27%20.%20esc_url%28%24post_author_url%29%20.%20%27%20): ';
}
else{
return ' **' . esc\_html( $post\_author\_name) . '**: ';
}
break;
}
}
}
// 89. Facebook Pixel
// Moved to analytics-functions.php
// 91. Comment Author Gravatar URL
if( ! function\_exists('ampforwp\_get\_comments\_gravatar') ){
function ampforwp\_get\_comments\_gravatar( $comment ) {
global $redux\_builder\_amp;
if(isset($redux\_builder\_amp['ampforwp-display-avatar']) && $redux\_builder\_amp['ampforwp-display-avatar']==0){
return '';
}
if (class\_exists('FV\_Gravatar\_Cache')) {
$options = get\_option('fv\_gravatar\_cache');
$size = !empty($options['size']) ? $options['size'] : '96';
$email\_hash = md5(strtolower(trim($comment->comment\_author\_email)));
$upload\_dir = wp\_upload\_dir();
$cache\_dir = $upload\_dir['basedir'] . '/fv-gravatar-cache/';
$cache\_url = $upload\_dir['baseurl'] . '/fv-gravatar-cache/';
$cached\_avatar\_path = $cache\_dir . $email\_hash . 'x' . $size . '.png';
$default\_avatar\_url = $cache\_url . 'mystery' . esc\_html($size) . '.png';
if (file\_exists($cached\_avatar\_path)) {
$avatar\_url = $cache\_url . $email\_hash . 'x' . $size . '.png';
} else {
$avatar\_url = $default\_avatar\_url;
}
return $avatar\_url;
}
$gravatar\_exists = ampforwp\_gravatar\_checker($comment->comment\_author\_email);
if(class\_exists('SimpleUserAvatar\_Public')){
$id\_or\_email = strtolower(trim($comment->comment\_author\_email));
$avatar = get\_avatar\_url($comment, apply\_filters('ampforwp\_get\_comments\_gravatar', '60'), '');
$avatar = ampforwp\_simple\_user\_avatar\_compatibility($avatar,$id\_or\_email);
return $avatar;
}
if (null !== ampforwp\_get\_wp\_user\_avatar($comment, 'comment')) {
return ampforwp\_get\_wp\_user\_avatar($comment, 'comment');
} elseif ($gravatar\_exists) {
return get\_avatar\_url($comment, apply\_filters('ampforwp\_get\_comments\_gravatar', '60'), '');
} else {
return apply\_filters('ampforwp\_get\_comments\_gravatar', '');
}
}
}
function ampforwp\_simple\_user\_avatar\_compatibility($avatar,$id\_or\_email){
$user = get\_user\_by('email', $id\_or\_email);
$user\_id = (int)$user->ID;
$attachment\_id = get\_user\_meta($user\_id, SUA\_USER\_META\_KEY, true);
if (empty($attachment\_id) || !is\_numeric($attachment\_id)) {
return $avatar;
}
$attachment\_src = wp\_get\_attachment\_image\_src($attachment\_id, 'medium');
if ($attachment\_src !== false && !empty($attachment\_src)) {
$avatar = $attachment\_src[0];
}
return $avatar;
}
// Gravatar Checker
if ( ! function\_exists('ampforwp\_gravatar\_checker') ) {
function ampforwp\_gravatar\_checker( $email ) {
$uri = "";
// Craft a potential url and test its headers
$hash = md5(strtolower(trim($email)));
$gravatar\_server = 0;
if ( $hash ) {
$gravatar\_server = hexdec( $hash[0] ) % 3;
} else {
$gravatar\_server = wp\_rand( 0, 2 );
}
if ( is\_ssl() ) {
$uri = 'https://secure.gravatar.com/avatar/' . $hash;
} else {
$uri = sprintf( 'http://%d.gravatar.com/avatar/%s', $gravatar\_server, $hash );
}
if($uri){
$response = wp\_remote\_get(esc\_url\_raw($uri));
$response\_code = wp\_remote\_retrieve\_response\_code($response);
}
//If its 404
if ($response\_code!=200) {
$has\_valid\_avatar = FALSE;
}else {
$has\_valid\_avatar = TRUE;
}
return $has\_valid\_avatar;
}
}
function ampfowp\_add\_extra\_css(){
echo '';
}
if ( is\_user\_logged\_in() ) {
add\_action('wp\_head', 'ampfowp\_add\_extra\_css');
}
// 92. View AMP in Admin Bar
add\_action( 'wp\_before\_admin\_bar\_render', 'ampforwp\_view\_amp\_admin\_bar' );
if( ! function\_exists( 'ampforwp\_view\_amp\_admin\_bar' ) ) {
function ampforwp\_view\_amp\_admin\_bar( ) {
global $wp\_admin\_bar, $post, $wp\_post\_types, $redux\_builder\_amp;
$post\_type\_title = $current\_url = '';
$supported\_amp\_post\_types = array();
// Get all post types supported by AMP
$supported\_amp\_post\_types = ampforwp\_get\_all\_post\_types();
$current\_access = false;
// Check for Admin
if ( is\_admin() ) {
$current\_screen = get\_current\_screen();
$current\_access = ('post' == $current\_screen->base && 'add' != $current\_screen->action);
}elseif(is\_user\_logged\_in()){
$current\_user = wp\_get\_current\_user();
$current\_access = current\_user\_can('edit\_posts',$current\_user );
}
// Check for Screen base, user ability to read and visibility
if ($current\_access && (isset($post->ID) && $post->ID && current\_user\_can('read\_post', $post->ID ))
&& ( isset ( $wp\_post\_types[ $post->post\_type ]->public ) && $wp\_post\_types[$post->post\_type]->public )
&& ( isset ( $wp\_post\_types[ $post->post\_type ]->show\_in\_admin\_bar ) && $wp\_post\_types[$post->post\_type]->show\_in\_admin\_bar ) ) {
// Check if current post type is AMPed or not
if( $supported\_amp\_post\_types && in\_array($post->post\_type, $supported\_amp\_post\_types) ){
// If AMP on Posts or Pages is off then do nothing
if($post->post\_type == 'post' && !ampforwp\_get\_setting('amp-on-off-for-all-posts') || $post->post\_type == 'page' && !ampforwp\_get\_setting('amp-on-off-for-all-pages')) {
return;
}
if( is\_archive() && is\_category() ){
if(!ampforwp\_get\_setting('ampforwp-archive-support') || !ampforwp\_get\_setting('ampforwp-archive-support-cat') ){
return ;
}
}elseif( is\_archive() && is\_tag() ){
if(!ampforwp\_get\_setting('ampforwp-archive-support') || !ampforwp\_get\_setting('ampforwp-archive-support-tag') ){
return ;
}
}elseif( is\_archive() && is\_tax()){
$taxonomies = ampforwp\_get\_setting('ampforwp-custom-taxonomies');
if(empty($taxonomies)){
return ;
}else{
$term\_id = get\_queried\_object()->term\_id;
$termObj = get\_term( $term\_id);
if( in\_array($termObj->taxonomy, $taxonomies)){
}else{
return ;
}
}
}
if( is\_archive() && is\_category()){
$term\_id = get\_queried\_object()->term\_id;
$termObj = get\_term( $term\_id);
$taxonomy\_objects = get\_object\_taxonomies( 'post', 'objects' );
$post\_type\_title = $taxonomy\_objects[$termObj->taxonomy]->labels->singular\_name;
if(ampforwp\_get\_setting('ampforwp-archive-support') == true && ampforwp\_get\_setting('ampforwp-archive-support-cat') == true){
$current\_url = get\_term\_link($term\_id);
}
}elseif( is\_archive() && is\_tag()){
$term\_id = get\_queried\_object()->term\_id;
$termObj = get\_term( $term\_id);
$taxonomy\_objects = get\_object\_taxonomies( 'post', 'objects' );
$post\_type\_title = $taxonomy\_objects[$termObj->taxonomy]->labels->singular\_name;
if(ampforwp\_get\_setting('ampforwp-archive-support') == true && ampforwp\_get\_setting('ampforwp-archive-support-tag') == true){
$current\_url = get\_term\_link($term\_id);
}
}elseif(is\_archive() && is\_tax()){
$term\_id = get\_queried\_object()->term\_id;
$termObj = get\_term( $term\_id);
$taxonomy\_objects = get\_taxonomy( $termObj->taxonomy );
$post\_type\_title = $taxonomy\_objects->labels->singular\_name;
$current\_url = get\_term\_link($term\_id);
}else{
$post\_type\_title = ucfirst($post->post\_type);
$current\_url = get\_permalink( $post->ID );
if(is\_home()){
$current\_url = home\_url();
}
}
if (is\_preview()) {
$current\_url = $current\_url .'&=1&preview=true';
$wp\_admin\_bar->add\_node(array(
'id' => 'ampforwp-view-amp',
'title' => 'View ' . esc\_html($post\_type\_title) . ' (AMP)' ,
'href' => esc\_url($current\_url)
));
}else{
$wp\_admin\_bar->add\_node(array(
'id' => 'ampforwp-view-amp',
'title' => 'View ' . esc\_html($post\_type\_title) . ' (AMP)' ,
'href' => ampforwp\_url\_controller($current\_url)
));
}
}
}
}
}
// 94. OneSignal Push Notifications
// Moved to push-notification-functions.php
// 95. Modify menu link attributes for SiteNavigationElement Schema Markup #1229 #1345
add\_filter( 'nav\_menu\_link\_attributes', 'ampforwp\_nav\_menu\_link\_attributes', 10, 3 );
if( ! function\_exists( 'ampforwp\_nav\_menu\_link\_attributes' ) ) {
function ampforwp\_nav\_menu\_link\_attributes( $atts, $item, $args ) {
if ( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ) {
// Manipulate link attributes
$atts['itemprop'] = "url";
}
return $atts;
}
}
// 96. ampforwp\_is\_front\_page() ampforwp\_is\_home() and ampforwp\_is\_blog is created
// Moved to functions.php
// 97. Change the format of the post date on Loops #1384
add\_filter('ampforwp\_modify\_post\_date', 'ampforwp\_full\_post\_date\_loops');
if( ! function\_exists( 'ampforwp\_full\_post\_date\_loops' ) ){
function ampforwp\_full\_post\_date\_loops($full\_date){
global $redux\_builder\_amp;
if( is\_home() || is\_archive() ){
if( 2 == $redux\_builder\_amp['ampforwp-post-date-format'] ){
$full\_date = get\_the\_date();
if( 2 == $redux\_builder\_amp['ampforwp-post-date-global'] ){
$full\_date = get\_the\_modified\_date();
}
}
if( 1 == $redux\_builder\_amp['ampforwp-post-date-format'] ){
$time = ampforwp\_get\_the\_time();
$date = human\_time\_diff( $time, current\_time('timestamp') );
if( $redux\_builder\_amp['ampforwp-post-date-format-text'] ){
$full\_date = $redux\_builder\_amp['ampforwp-post-date-format-text'];
// Change the % days into the actual number of days
$full\_date = str\_replace('% days', $date, $full\_date);
$full\_date = str\_replace('ago', ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago'), $full\_date);
}
}
}
if(is\_single() && 1 == $redux\_builder\_amp['ampforwp-post-date-format']){
$time = ampforwp\_get\_the\_time();
$date = human\_time\_diff( $time, current\_time('timestamp') );
$full\_date = human\_time\_diff( $time, current\_time('timestamp') ) .' '. ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago');
if( $redux\_builder\_amp['ampforwp-post-date-format-text'] ){
$full\_date = $redux\_builder\_amp['ampforwp-post-date-format-text'];
// Change the % days into the actual number of days
$full\_date = str\_replace('% days', $date, $full\_date);
$full\_date = str\_replace('ago', ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago'), $full\_date);
}
}
return $full\_date;
}
}
if(!function\_exists('ampforwp\_get\_the\_time')){
function ampforwp\_get\_the\_time(){
$time = get\_the\_time('U', get\_the\_ID());
if( 2 == ampforwp\_get\_setting('ampforwp-post-date-global') ){
$time = get\_the\_modified\_time('U', get\_the\_ID() );
}
if(defined('ECWD\_VERSION')){
global $ecwd\_options;
$tz = $ecwd\_options['time\_zone'];
$ewwetz = new DateTime( get\_the\_time('c', get\_the\_ID()) );
if( 2 == ampforwp\_get\_setting('ampforwp-post-date-global') ){
$ewwetz = new DateTime( get\_the\_modified\_time('c', get\_the\_ID()) );
}
$ewwetz->setTimezone(new DateTimeZone($tz));
$time = $ewwetz->format('U');
}
return $time;
}
}
// 99. Merriweather Font Management
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_merriweather\_font\_management' );
function ampforwp\_merriweather\_font\_management( $data ) {
if ( 1 != ampforwp\_get\_setting('amp-design-selector') || ( false == ampforwp\_get\_setting('ampforwp-d1-font') && 1 == ampforwp\_get\_setting('amp-design-selector') ) ) {
unset($data['font\_urls']['merriweather']);
}
return $data;
}
// 100. Flags compatibility in Menu
add\_filter('ampforwp\_menu\_content','ampforwp\_modify\_menu\_content');
if( ! function\_exists(' ampforwp\_modify\_menu\_content ') ){
function ampforwp\_modify\_menu\_content($menu){
// Return $menu If tagDiv Composer plugin is active
if(function\_exists('tdc\_error\_handler')){
return $menu;
}
$dom = '';
$nodes = '';
$num\_nodes = '';
if( !empty( $menu ) && preg\_match('/]\*src\s\*=\s\*"[^"]\*"[^>]\*>/i', $menu)){
// Create a new document
$dom = new DOMDocument();
if( function\_exists( 'mb\_convert\_encoding' ) ){
$menu = @mb\_convert\_encoding($menu, 'HTML-ENTITIES', 'UTF-8');
}
else{
$menu = preg\_replace( '/&[^amp|#038].\*?;/', 'x', $menu ); // multi-byte characters converted to X
}
// To Suppress Warnings
libxml\_use\_internal\_errors(true);
$dom->loadHTML($menu);
libxml\_use\_internal\_errors(false);
// get all the img's
$nodes = $dom->getElementsByTagName( 'img' );
$num\_nodes = $nodes->length;
for ( $i = $num\_nodes - 1; $i >= 0; $i-- ) {
$node = $nodes->item( $i );
// Set The Width and Height if there in none
if ( '' === $node->getAttribute( 'width' ) ) {
$node->setAttribute('width', 15);
}
if( '' === $node->getAttribute( 'height' ) ){
$node->setAttribute('height', 15);
}
}
$menu = $dom->saveHTML();
}
return $menu;
}
}
/\*
\* Fetches the logo data
\* More details about the fix https://github.com/ahmedkaludi/accelerated-mobile-pages/pull/2317
\* Props to: https://github.com/saucal for suggesting the fix.
\*/
function ampforwp\_default\_logo\_data() {
global $redux\_builder\_amp, $ampwforwp\_default\_logo\_data;
if( $ampwforwp\_default\_logo\_data ) {
return $ampwforwp\_default\_logo\_data;
}
$logo\_id = '';
$image = array();
$value = '';
$logo\_alt = '';
$logo\_id = get\_theme\_mod( 'custom\_logo' );
if(isset($redux\_builder\_amp['opt-media']['id']) && empty( $logo\_id ) ) {
$logo\_id = (integer) $redux\_builder\_amp['opt-media']['id'];
}
if( empty( $logo\_id ) ) {
return false;
}
if( ! wp\_attachment\_is( 'image', $logo\_id ) || ampforwp\_get\_setting('opt-media','url') ) {
$logo\_url = ampforwp\_get\_setting('opt-media','url');
$image[0] = ampforwp\_get\_setting('opt-media','width');
$image[1] = ampforwp\_get\_setting('opt-media','height');
if(empty($image)){
$image = @getimagesize( $logo\_url );
}
if ( empty($image[0]) || empty($image[1]) ) {
$image[0] = '190';
$image[1] = '36';
}
} else {
$imageDetail = wp\_get\_attachment\_image\_src( $logo\_id , 'full');
$logo\_url = $imageDetail[0];
$image[0] = $imageDetail[1];
$image[1] = $imageDetail[2];
if ( 0 === $image[1] ) {
$image[0] = '190';
$image[1] = '36';
}
}
$logo\_alt = get\_post\_meta( $logo\_id, '\_wp\_attachment\_image\_alt', true);
$ampwforwp\_default\_logo\_data = array(
'logo\_id' => $logo\_id,
'logo\_url' => $logo\_url,
'logo\_alt' => $logo\_alt,
'logo\_size' => $image
);
return $ampwforwp\_default\_logo\_data;
}
// 101. Function for Logo attributes
function ampforwp\_default\_logo($param=""){
global $redux\_builder\_amp;
$value = '';
$data = ampforwp\_default\_logo\_data();
if( ! $data ) {
if($param!="width" && $param!="height"){
return $value;
}
}
switch ($param) {
case 'url':
$value = $data['logo\_url'];
break;
case 'width':
if (true == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions') && 'prescribed' ==ampforwp\_get\_setting('ampforwp-custom-logo-dimensions-options')) {
$value = trim(ampforwp\_get\_setting('opt-media-width'));
if($value==""){
$value = 190;
}
}
else
$value = '';
if(isset($data['logo\_size'][0])){
$value = $data['logo\_size'][0];
}
if($value==""){
$value = 190;
}
break;
case 'height':
if (true == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions') && 'prescribed' == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions-options')) {
$value = trim(ampforwp\_get\_setting('opt-media-height'));
if($value==""){
$value = 36;
}
}
else
$value = '';
if(isset($data['logo\_size'][1])){
$value = $data['logo\_size'][1];
}
if($value==""){
$value = 36;
}
break;
case 'alt':
if(isset($data['logo\_alt'][0])){
$value = $data['logo\_alt'];
}
else
$value = get\_bloginfo('name');
break;
default:
$value = $data['logo\_url'];
break;
}
return $value;
}
// Envira Lazy Load compatibility
add\_filter('envira\_gallery\_pre\_data', 'ampforwp\_envira\_lazy\_load');
if( ! function\_exists(' ampforwp\_envira\_lazy\_load ') ){
function ampforwp\_envira\_lazy\_load($data){
if( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ){
if(function\_exists('envira\_get\_config')){
$checker = envira\_get\_config( 'lazy\_loading', $data);
if( 1 === $checker){
$data['config']['lazy\_loading'] = 0;
}
}
}
return $data;
}
}
#1581 Instagram Sanitizer
add\_filter( 'amp\_content\_sanitizers', 'ampforwp\_instagram\_sanitizer', 10, 1 );
function ampforwp\_instagram\_sanitizer( $sanitizer\_classes ) {
require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-instagram-sanitizer.php' );
$sanitizer\_classes[ 'AMPFORWP\_Instagram\_Embed\_Sanitizer' ] = array();
return $sanitizer\_classes;
}
// Allowed Tags
if ( ! function\_exists('ampforwp\_allowed\_tags') ) {
function ampforwp\_allowed\_tags() {
$allowed\_tags = '';
$allowed\_tags = wp\_kses\_allowed\_html('post');
$allowed\_tags['a']['itemprop'] = true;
$allowed\_tags['span']['itemprop'] = true;
return $allowed\_tags;
}
}
// List of Subpages/Childpages on Pages
add\_action('ampforwp\_after\_post\_content', 'ampforwp\_list\_subpages');
if ( ! function\_exists('ampforwp\_list\_subpages') ) {
function ampforwp\_list\_subpages() {
if (class\_exists('AddWidgetAfterContent')) {
$sanitized\_output = '';
$sanitized\_output = ampforwp\_sidebar\_content\_sanitizer('add-widget-after-content');
if ( $sanitized\_output) {
$sanitized\_output = $sanitized\_output->get\_amp\_content();?>
php echo do\_shortcode($sanitized\_output); ?

php }
}
global $post, $redux\_builder\_amp;
if ( is\_page() && true == $redux\_builder\_amp['ampforwp\_subpages\_list'] ) {
$pages = '';
$pages = wp\_list\_pages( array(
'echo' = 0,
'child\_of' => $post->ID,
'title\_li' => '',
) );
$pages = preg\_replace('/href="(.\*?)"/', 'href="$1/amp/"', $pages);
echo wp\_kses($pages, ampforwp\_allowed\_tags());
}
}
}
// Disable wptextturize #1458
add\_action('init','ampforwp\_wptexturize\_disabler');
if ( ! function\_exists('ampforwp\_wptexturize\_disabler') ) {
function ampforwp\_wptexturize\_disabler(){
global $redux\_builder\_amp;
if ( isset($redux\_builder\_amp['ampforwp-wptexturize']) && true == $redux\_builder\_amp['ampforwp-wptexturize'] ) {
remove\_filter('the\_content', 'wptexturize');
remove\_filter('the\_title', 'wptexturize');
}
}
}
// amp-vimeo proper video id for 3 parameter url
add\_filter('amp\_vimeo\_parse\_url','amp\_vimeo\_parse\_url\_video\_id');
function amp\_vimeo\_parse\_url\_video\_id($tok){
if (in\_array("ondemand", $tok) && sizeof($tok)==3){
$tok = '';
return $tok;
}
if(sizeof($tok)==3){
return $tok[1];
}else{
return end($tok);
}
}
// Cart Page URL
if( ! function\_exists( 'ampforwp\_wc\_cart\_page\_url' ) ){
function ampforwp\_wc\_cart\_page\_url(){
if(function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') && (function\_exists('wc\_get\_cart\_url') || function\_exists('get\_cart\_url'))){
global $woocommerce;
$cart\_url = function\_exists( 'wc\_get\_cart\_url' ) ? wc\_get\_cart\_url() : $woocommerce->cart->get\_cart\_url();
$cart\_url = ampforwp\_url\_controller($cart\_url);
return $cart\_url;
}
else
return '#';
}
}
// Add Google Font support
add\_action('amp\_post\_template\_css', 'ampforwp\_google\_fonts\_generator');
if ( ! function\_exists( 'ampforwp\_google\_fonts\_generator' ) ) {
function ampforwp\_google\_fonts\_generator() {
global $redux\_builder\_amp;
if( 1!=ampforwp\_get\_setting('ampforwp-google-font-switch') || true == ampforwp\_get\_setting('amp\_google\_font\_restrict')){
return;
}
if(isset($redux\_builder\_amp['google\_current\_font\_data'])){
$font\_data = json\_decode(stripslashes($redux\_builder\_amp['google\_current\_font\_data']));
}
$font\_weight = "";
$font\_output = "";
$font\_type = "";
if(isset( $redux\_builder\_amp['amp\_font\_type'])){
$font\_type = $redux\_builder\_amp['amp\_font\_type'];
}
if ( $font\_type && ampforwp\_get\_setting('amp\_font\_selector') != 'Segoe UI') {
foreach ($font\_type as $key => $value) {
// Font Weight generator
$font\_weight = (int) $value;
$font\_weight = ( $font\_weight != 0 ? $font\_weight : 400 );
// Font Stlye Generator
$font\_style = preg\_replace('/\d+/u', '', $value);
$font\_style = ( $font\_style == 'italic' ? 'italic' : 'normal' );
// Local Generator
// Font Weight
$font\_local\_weight = '';
if ( $font\_weight === 100 ) {
$font\_local\_weight = 'Thin';
}
if ( $font\_weight === 200 ) {
$font\_local\_weight = 'Ultra Light';
}
if ( $font\_weight === 300 ) {
$font\_local\_weight = 'Light';
}
if ( $font\_weight === 400 ) {
$font\_local\_weight = 'Regular';
}
if ( $font\_weight === 500 ) {
$font\_local\_weight = 'Medium';
}
if ( $font\_weight === 600 ) {
$font\_local\_weight = 'SemiBold';
}
if ( $font\_weight === 700 ) {
$font\_local\_weight = 'Bold';
}
if ( $font\_weight === 800 ) {
$font\_local\_weight = 'ExtraBold';
}
if ( $font\_weight === 900 ) {
$font\_local\_weight = 'Black';
}
// Font Style
$font\_local\_type = '';
if ('italic' === $font\_style) {
$font\_local\_type = 'Italic';
}
$font\_output .= "@font-face { ";
$font\_output .= "font-family: " . $redux\_builder\_amp['amp\_font\_selector']. ';' ;
$font\_output .= "font-display: optional;";
$font\_output .= "font-style: " . $font\_style . ';';
$font\_output .= "font-weight: " . $font\_weight . ';' ;
$font\_output .= "src: local('". $redux\_builder\_amp['amp\_font\_selector']." ".$font\_local\_weight." ".$font\_local\_type."'), local('". $redux\_builder\_amp['amp\_font\_selector']."-".$font\_local\_weight.$font\_local\_type."'), url(" .str\_replace("http://", "https://", $font\_data->files->$value) . ');' ;
$font\_output .= "}";
}
}
//for Single content Font Family
if(ampforwp\_get\_setting('content-font-family-enable') && (is\_singular() || (ampforwp\_get\_setting('amp-design-selector')!=4) ) ){
if(ampforwp\_get\_setting('google\_current\_font\_data\_content\_single')){
$font\_data = json\_decode(stripslashes(ampforwp\_get\_setting('google\_current\_font\_data\_content\_single')));
}
$font\_output .= "\n";
if( ampforwp\_get\_setting('amp\_font\_type\_content\_single') ){
$font\_type = ampforwp\_get\_setting('amp\_font\_type\_content\_single');
}
if ( $font\_type && ampforwp\_get\_setting('amp\_font\_selector\_content\_single') != 'Segoe UI') {
foreach ($font\_type as $key => $value) {
// Font Weight generator
$font\_weight = (int) $value;
$font\_weight = ( $font\_weight != 0 ? $font\_weight : 400 );
// Font Stlye Generator
$font\_style = preg\_replace('/\d+/u', '', $value);
$font\_style = ( $font\_style == 'italic' ? 'italic' : 'normal' );
// Local Generator
// Font Weight
$font\_local\_weight = '';
if ( $font\_weight === 100 ) {
$font\_local\_weight = 'Thin';
}
if ( $font\_weight === 200 ) {
$font\_local\_weight = 'Ultra Light';
}
if ( $font\_weight === 300 ) {
$font\_local\_weight = 'Light';
}
if ( $font\_weight === 400 ) {
$font\_local\_weight = 'Regular';
}
if ( $font\_weight === 500 ) {
$font\_local\_weight = 'Medium';
}
if ( $font\_weight === 600 ) {
$font\_local\_weight = 'SemiBold';
}
if ( $font\_weight === 700 ) {
$font\_local\_weight = 'Bold';
}
if ( $font\_weight === 800 ) {
$font\_local\_weight = 'ExtraBold';
}
if ( $font\_weight === 900 ) {
$font\_local\_weight = 'Black';
}
// Font Style
$font\_local\_type = '';
if ('italic' === $font\_style) {
$font\_local\_type = 'Italic';
}
$font\_output .= "@font-face { ";
$font\_output .= "font-family: " . esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single')). ';' ;
if (ampforwp\_get\_setting('ampforwp\_font\_display') == 'optional') {
$font\_output .= "font-display: optional".';';
}else{
$font\_output .= "font-display: swap".';';
}
$font\_output .= "font-style: " . esc\_attr($font\_style) . ';';
$font\_output .= "font-weight: " . esc\_attr($font\_weight) . ';' ;
$font\_output .= "src: local('". esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single'))." ".esc\_attr($font\_local\_weight)." ".esc\_attr($font\_local\_type)."'), local('". esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single'))."-".esc\_attr($font\_local\_weight).$font\_local\_type."'), url(" .esc\_url(str\_replace("http://", "https://", $font\_data->files->$value)) . ');' ;
$font\_output .= "}";
}
}
}
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $font\_output; // escaped above
}
}
function swifttheme\_footer\_widgets\_init() {
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Widget Below Header', 'accelerated-mobile-pages' ),
'id' => 'ampforwp-below-header',
'description' => esc\_html\_\_( 'This Widget will be display on Below Header area', 'accelerated-mobile-pages' ),
'class'=>'w-bl',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Widget Above Loop', 'accelerated-mobile-pages' ),
'id' => 'ampforwp-above-loop',
'description' => esc\_html\_\_( 'This Widget will be display on Above Loop area', 'accelerated-mobile-pages' ),
'class'=>'w-bl',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Widget Below loop', 'accelerated-mobile-pages' ),
'id' => 'ampforwp-below-loop',
'description' => esc\_html\_\_( 'This Widget will be display on Below loop area', 'accelerated-mobile-pages' ),
'class'=>'w-bl',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Widget Above Footer', 'accelerated-mobile-pages' ),
'id' => 'ampforwp-above-footer',
'description' => esc\_html\_\_( 'This Widget will be display on Above Footer area', 'accelerated-mobile-pages' ),
'class'=>'w-bl',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
if(ampforwp\_design\_selector()==4 || ampforwp\_design\_selector()==3 || ampforwp\_design\_selector()==2 || ampforwp\_design\_selector()==1){
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Footer', 'accelerated-mobile-pages' ),
'id' => 'swift-footer-widget-area',
'description' => esc\_html\_\_( 'The Footer widget area', 'accelerated-mobile-pages' ),
'class'=>'w-bl',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
if(true == ampforwp\_get\_setting('gnrl-sidebar')){
register\_sidebar( array(
'name' => esc\_html\_\_( 'AMP Sidebar', 'accelerated-mobile-pages' ),
'id' => 'swift-sidebar',
'description' => esc\_html\_\_( 'The Swift Sidebar', 'accelerated-mobile-pages' ),
'class'=>'amp-sidebar',
'before\_widget' => '',
'after\_widget' => '',
'before\_title' => '
#### ', 'after\_title' => '

',
) );
}
}
}
add\_action( 'init', 'swifttheme\_footer\_widgets\_init' );
// AMP Takeover
function ampforwp\_is\_non\_amp( $type="" ) {
global $redux\_builder\_amp;
$non\_amp = false;
$ampforwp\_amp\_post\_on\_off\_meta = $post\_id = '';
$post\_id = get\_the\_ID();
if ( ampforwp\_is\_front\_page() ) {
$post\_id = ampforwp\_get\_frontpage\_id();
}
if ( false !== get\_query\_var( 'amp', false ) ) {
return false;
}
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
if (""===$type && (ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) ) {
$non\_amp = true;
// Check for Posts
if ( is\_single() && false == ampforwp\_get\_setting('amp-on-off-for-all-posts') ) {
return false;
}
// Archives
if ( is\_archive() && false == ampforwp\_get\_setting('ampforwp-archive-support') ) {
return false;
}
// Pages
if ( is\_page() && false == ampforwp\_get\_setting('amp-on-off-for-all-pages') ) {
return false;
}
//Blogpage
$page\_for\_posts = intval(get\_option( 'page\_for\_posts' ));
if ( $page\_for\_posts == ampforwp\_get\_the\_ID() ) {
return true;
}
// Homepage
if ( is\_home() && false == ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) {
return false;
}
// Search #2681
if ( is\_search() && ( (4 == ampforwp\_get\_setting('amp-design-selector') && false == ampforwp\_get\_setting('amp-swift-search-feature') ) ) ){
return false;
}
//Removed AMP Takeover when custom 404 Page is selected in enfold theme #4723
if ( function\_exists('avia\_preload\_screen') && !empty(avia\_get\_option('error404\_page')) && is\_404() ) {
return false;
}
// Enabling AMP Takeover only when selected in Custom Post Type
$supported\_types\_for\_takeover = array();
$supported\_types\_for\_takeover = ampforwp\_get\_all\_post\_types();
if( $supported\_types\_for\_takeover ){
$current\_type = get\_post\_type(get\_the\_ID());
if( $current\_type==false){
$non\_amp = true;
}else{
if(!in\_array($current\_type, $supported\_types\_for\_takeover) && !is\_404() && !is\_search()){
return ;
}
}
}
if ( is\_front\_page() && false == ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) {
return false;
}
if ( is\_feed() ) {
return false;
}
if(get\_query\_var( 'robots' )){
return;
}
if ( function\_exists('is\_embed') && is\_embed() ){
return;
}
if(is\_search() && 0 == ampforwp\_get\_setting('amp-redirection-search')){
return false;
}
}elseif( (
ampforwp\_get\_setting('amp-design-selector') == 4)
&&
(
true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')
)
||
(
'non\_amp\_check\_convert' === $type
&& true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')
) ) {
$non\_amp = true;
}
// Convert AMP to WP issues fixed #2493
//Blogposts
if ( is\_home() && ampforwp\_get\_setting('ampforwp-homepage-on-off-support') == false ) {
return;
}
// Pages
if ( is\_page() && false == ampforwp\_get\_setting('amp-on-off-for-all-pages') ) {
return;
}
if ( is\_singular() || ampforwp\_is\_front\_page() || ampforwp\_is\_blog() ) {
$ampforwp\_amp\_post\_on\_off\_meta = get\_post\_meta( $post\_id,'ampforwp-amp-on-off',true);
if($ampforwp\_amp\_post\_on\_off\_meta == 'hide-amp'){
return false;
}
}
// Removing the AMP on login register etc of Theme My Login plugin
if (function\_exists('tml\_register\_default\_actions')){
$tml\_pages = tml\_get\_actions();
$pages = array();
if ( isset($tml\_pages) && $tml\_pages ) {
foreach ($tml\_pages as $page) {
$pages[] = $page->get\_slug();
}
}
if(in\_array(get\_query\_var('action'), $pages) ){
return false;
}
}
return $non\_amp;
}
function ampforwp\_mobile\_redirect\_preseve\_link(){
$redirectToAMP = false;
if(ampforwp\_get\_setting('amp-mobile-redirection') == true && ampforwp\_get\_setting('amp-mob-redirection-pres-link') == true){
require\_once AMPFORWP\_PLUGIN\_DIR.'/includes/vendor/Mobile\_Detect.php';
$mobile\_detect = new AMPforWP\_Mobile\_Detect;
$isMobile = $mobile\_detect->isMobile();
$isTablet = $mobile\_detect->isTablet();
$isTabletUserAction = ampforwp\_get\_setting('amp-tablet-redirection');
if( $isMobile && $isTabletUserAction && $isTablet ){ //Only For tablet
$redirectToAMP = true;
}else if($isMobile && !$isTablet){ // Only for mobile
$redirectToAMP = true;
}
}
return $redirectToAMP;
}
// Remove wpautop from specific posts which contain amp-components
add\_action('pre\_amp\_render\_post','ampforwp\_custom\_wpautop');
function ampforwp\_custom\_wpautop(){
if ( is\_single() ) {
if ( get\_post\_meta(get\_the\_ID(), 'ampforwp-wpautop', true) == 'false') {
remove\_filter('the\_content', 'wpautop');
}
}
if(function\_exists('ubermenu\_get\_nav\_menu\_args')){
add\_filter( 'ubermenu\_nav\_menu\_args' ,'ampforwp\_modify\_ubermenu\_nav\_menu\_args' , 10,2);
}
}
function ampforwp\_modify\_ubermenu\_nav\_menu\_args($args , $config\_id){
$args['menu\_class'] = 'amp-menu '.$args['menu\_class'];
return $args;
}
// Backward Compatibility for AMP Preview #1529
if ( ! function\_exists('get\_preview\_post\_link') ) {
function get\_preview\_post\_link( $post = null, $query\_args = array(), $preview\_link = '' ) {
$post = get\_post( $post );
if ( ! $post ) {
return;
}
$post\_type\_object = get\_post\_type\_object( $post->post\_type );
if ( is\_post\_type\_viewable( $post\_type\_object ) ) {
if ( ! $preview\_link ) {
$preview\_link = set\_url\_scheme( get\_permalink( $post ) );
}
$query\_args['preview'] = 'true';
$preview\_link = add\_query\_arg( $query\_args, $preview\_link );
}
return apply\_filters( 'preview\_post\_link', $preview\_link, $post );
}
}
// Homepage Loop Modifier #1701
add\_filter('ampforwp\_query\_args','ampforwp\_homepage\_loop');
function ampforwp\_homepage\_loop( $args ) {
global $redux\_builder\_amp;
if ( is\_home() ) {
$post\_type = 'post';
// Check if Custom Post Type is selected
if ('' != ampforwp\_get\_setting('ampforwp-homepage-loop-type') ) {
$post\_type = ampforwp\_get\_setting('ampforwp-homepage-loop-type');
}
$args['post\_type'] = $post\_type;
// Exclude Categories if any selected
if ('' != ampforwp\_get\_setting('ampforwp-homepage-loop-cats') ) {
$args['category\_\_not\_in'] = ampforwp\_get\_setting('ampforwp-homepage-loop-cats');
}
}
if(function\_exists('ampforwp\_is\_home') && ampforwp\_is\_home() && isset($redux\_builder\_amp['amp-no-of-posts-home-page'])){
$args['posts\_per\_page'] = $redux\_builder\_amp['amp-no-of-posts-home-page'];
}
if(function\_exists('is\_category') && is\_category() && isset($redux\_builder\_amp['amp-no-of-posts-cat-page'])){
$args['posts\_per\_archive\_page'] = $redux\_builder\_amp['amp-no-of-posts-cat-page'];
}
return $args;
}
//To modify number of posts #5503
add\_filter( 'pre\_get\_posts', 'ampforwp\_modify\_no\_of\_posts' );
function ampforwp\_modify\_no\_of\_posts( $query ) {
global $redux\_builder\_amp;
$amp\_q\_ck = is\_object($query) ? $query->query : '';
if(isset($amp\_q\_ck['amp']) && $amp\_q\_ck['amp'] == 1){
if(function\_exists('ampforwp\_is\_home') && ampforwp\_is\_home() && isset($redux\_builder\_amp['amp-no-of-posts-home-page'])){
$query->set( 'posts\_per\_page', $redux\_builder\_amp['amp-no-of-posts-home-page']);
}
if(function\_exists('is\_category') && is\_category() && isset($redux\_builder\_amp['amp-no-of-posts-cat-page'])){
$query->set( 'posts\_per\_page', $redux\_builder\_amp['amp-no-of-posts-cat-page']);
}
}
}
// To get correct comments count #1662
add\_filter('get\_comments\_number', 'ampforwp\_comment\_count', 0);
function ampforwp\_comment\_count( $count ) {
/\* TODO: Allowed memory size exhausted #1865
get\_comments() was trying to access by Id and because the ID is not present on amp frontpages. It is getting exhausted. Need to recreate issue and validate the hypothesis
\*/
if ( ! is\_admin() && function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() && is\_single() ) {
global $id;
$get\_comments = get\_comments('status=approve&post\_id=' . $id);
$comments\_by\_type = separate\_comments($get\_comments);
return count($comments\_by\_type['comment']);
}
else {
return $count;
}
}
// Glue underline css compatibility #1743 #1932
add\_action('amp\_post\_template\_css', 'ampforwp\_glue\_css\_comp', PHP\_INT\_MAX );
if ( ! function\_exists('ampforwp\_glue\_css\_comp') ) {
function ampforwp\_glue\_css\_comp() {
global $redux\_builder\_amp;
if (class\_exists('YoastSEO\_AMP\_Frontend') ) { ?>
a {text-decoration:none;}
html {background:none;}
php }
if ( isset($redux\_builder\_amp['ampforwp-underline-content-links']) && $redux\_builder\_amp['ampforwp-underline-content-links'] ) { ?
.the\_content a {text-decoration:underline;}
php }
}
}
// Filter for Frontpage id
add\_filter('ampforwp\_modify\_frontpage\_id', 'ampforwp\_modified\_frontpage\_id');
if( ! function\_exists('ampforwp\_modified\_frontpage\_id') ) {
function ampforwp\_modified\_frontpage\_id($page\_id){
include\_once( ABSPATH . 'wp-admin/includes/plugin.php' );
// WPML Compatibility #1111
if( is\_plugin\_active( 'sitepress-multilingual-cms/sitepress.php' )){
$page\_id = get\_option('page\_on\_front');
}
// Polylang Compatibility #1779
elseif( ampforwp\_polylang\_front\_page() ){
$frontpage\_id = get\_option('page\_on\_front');
if($frontpage\_id){
$page\_id = pll\_get\_post($frontpage\_id);
}
}
return $page\_id;
}
}
// AMP to WP Theme Ads
add\_filter('ampforwp\_modify\_ads', 'ampforwp\_nonamp\_ads',10, 5);
if ( ! function\_exists('ampforwp\_nonamp\_ads') ) {
function ampforwp\_nonamp\_ads($output, $width, $height, $client\_id, $data\_slot) {
if ( ampforwp\_is\_non\_amp('non\_amp\_check\_convert') ) {
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
$output = ' <div class="add-wrapper" style="text-align:center;"

';
}
return $output;
}
}
//AMP to WP Theme Analytics
add\_action('wp\_footer','ampforwp\_nonamp\_analytics');
if ( ! function\_exists('ampforwp\_nonamp\_analytics') ) {
function ampforwp\_nonamp\_analytics() {
global $redux\_builder\_amp;
$ga\_account = $redux\_builder\_amp['ga-feild'];
if ( ampforwp\_is\_non\_amp("non\_amp\_check\_convert") ) {
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo "
";
}
}
}
// Coauthors Compatibility #1895
add\_filter('coauthors\_posts\_link', 'ampforwp\_coauthors\_links');
function ampforwp\_coauthors\_links($args){
global $redux\_builder\_amp;
if ( function\_exists('ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() && true == $redux\_builder\_amp['ampforwp-archive-support']) {
$args['href'] = ampforwp\_url\_controller($args['href']);
}
return $args;
}
//remove anchor from the image when lightbox option is enabled #2695
add\_action('pre\_amp\_render\_post','ampforwp\_remove\_ahref\_lightbox');
function ampforwp\_remove\_ahref\_lightbox(){
if(true == ampforwp\_get\_setting('ampforwp-amp-img-lightbox') ){
add\_filter( 'the\_content', 'ampforwp\_remove\_ahref\_lightbox\_in\_amp' );
add\_filter('tablepress\_table\_render\_data','amforwp\_remove\_tp\_image\_href');
}
}
function ampforwp\_remove\_ahref\_lightbox\_in\_amp( $content ) {
/\* phpcs:ignore PluginCheck.CodeAnalysis.ImageFunctions.NonEnqueuedImage \*/
preg\_match\_all('/((.\*?)]\*>)/', $content, $matches);
if( count($matches[3])){
for( $i=0;$i(]\*>)<\/a>/i', '$3', $content);
}
}
}
return $content;
}
function amforwp\_remove\_tp\_image\_href( $orig\_table){
$tablepressData = array();
$j = 0;
foreach ($orig\_table['data'] as $cols) {
for($i=0;$i< count($cols);$i++){
$tablepressData[$j][$i] = preg\_replace("/]+\>(]+\>)<\/a>/i",'$1', $cols[$i]);
}
$j++;
}
$orig\_table['data'] = $tablepressData;
return $orig\_table;
}
// amp-image-lightbox #1892
if ( ! function\_exists('ampforwp\_amp\_img\_lightbox') ) {
function ampforwp\_amp\_img\_lightbox(){
echo '';
}
}
// New Image attributes for amp-image-lightbox #1892
add\_filter('amp\_img\_attributes', 'ampforwp\_img\_new\_attrs');
function ampforwp\_img\_new\_attrs($attributes) {
global $redux\_builder\_amp;
if ( ampforwp\_get\_setting('ampforwp-amp-img-lightbox') ) {
$attributes['on'] = 'tap:amp-img-lightbox';
$attributes['role'] = 'button';
$attributes['tabindex'] = '0';
}
return $attributes;
}
// Facebook Comments script for AMP2WP
add\_action('ampforwp\_body\_beginning', 'ampforwp\_amp2wp\_fb');
if ( ! function\_exists('ampforwp\_amp2wp\_fb') ) {
function ampforwp\_amp2wp\_fb(){
global $redux\_builder\_amp;
if( ampforwp\_is\_non\_amp() && isset($redux\_builder\_amp['ampforwp-amp-convert-to-wp']) && $redux\_builder\_amp['ampforwp-amp-convert-to-wp'] && ($redux\_builder\_amp['ampforwp-facebook-comments-support'] || $redux\_builder\_amp['ampforwp-facebook-like-button']) ) {
echo '
';
}
}
}
// Removing AMPHTML Added by Facebook's Instant Article's Plugin #2043
add\_action( 'wp', 'ampforwp\_remove\_instant\_articles\_amp\_markup' );
function ampforwp\_remove\_instant\_articles\_amp\_markup(){
if(class\_exists('Instant\_Articles\_AMP\_Markup')){
remove\_action( 'wp\_head', array('Instant\_Articles\_AMP\_Markup', 'inject\_link\_rel') );
}
// #1696
if(function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint()){
if(class\_exists('SQ\_Classes\_ObjController')){
$SQ\_Classes\_ObjController = new SQ\_Classes\_ObjController();
$sq\_analytics\_class\_obj = $SQ\_Classes\_ObjController::getClass('SQ\_Models\_Services\_Analytics');
}
}
}
// #2042
function ampforwp\_404\_canonical(){
global $wp;
return home\_url( $wp->request );
}
// #2001 removing unused JS from the Paginated Posts
add\_filter('ampforwp\_post\_content\_filter', 'ampforwp\_paginated\_post\_content');
function ampforwp\_paginated\_post\_content($content){
global $numpages;
if(is\_singular()){
if ( get\_query\_var( 'paged' ) ) {
$paged = get\_query\_var('paged');
} elseif ( get\_query\_var( 'page' ) ) {
$paged = get\_query\_var('page');
} else {
$paged = 1;
}
if( $numpages >= 2 && true == ampforwp\_get\_setting('amp-pagination') ){
return get\_the\_content();
}
}
return $content;
}
// GDPR Compliancy #2040
// Moved to notice-bar-functions.php
// Thrive Leads Compatibility #2067
add\_filter('thrive\_leads\_skip\_request', 'ampforwp\_skip\_thrive\_leads');
if ( ! function\_exists('ampforwp\_skip\_thrive\_leads') ) {
function ampforwp\_skip\_thrive\_leads($skip) {
// Skip thrive leads on AMP
if ( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ) {
return true;
}
return $skip;
}
}
// Re-save permalink once the post value changed in Redading Settings #2190
add\_action( 'update\_option', 'ampforwp\_resave\_permalink', 10, 3 );
function ampforwp\_resave\_permalink( $option, $old\_value, $value ){
if('posts\_per\_page' === $option){
if($old\_value != $value){
delete\_transient( 'ampforwp\_current\_version\_check' );
}
}
}
// Canonical From Yoast #2118 and All in One SEO #1720 and Rank Math #2701
function ampforwp\_generate\_canonical(){
global $redux\_builder\_amp;
$canonical = '';
$canonical = $WPSEO\_Frontend = $All\_in\_One\_SEO\_Pack = $opts = '';
if ( 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-yoast-canonical') && class\_exists('WPSEO\_Frontend') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) {
$WPSEO\_Frontend = WPSEO\_Frontend::get\_instance();
$canonical = $WPSEO\_Frontend->canonical(false);
}
elseif ( 'aioseo' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-aioseo-canonical') && class\_exists('All\_in\_One\_SEO\_Pack') ) {
$All\_in\_One\_SEO\_Pack = new All\_in\_One\_SEO\_Pack();
$opts = $All\_in\_One\_SEO\_Pack->get\_current\_options( array(), 'aiosp' );
$canonical = $opts['aiosp\_custom\_link'];
}
elseif ( defined( 'RANK\_MATH\_FILE' ) && 'rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') && ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-canonical' ) ) {
$canonical = \RankMath\Paper\Paper::get()->get\_canonical();
}
return $canonical;
}
add\_filter('amp\_post\_template\_data', 'ampforwp\_modified\_canonical', 85);
function ampforwp\_modified\_canonical( $data ) {
$canonical = '';
$canonical = ampforwp\_generate\_canonical();
if ( !empty($canonical) ) {
$data['canonical\_url'] = $canonical;
}
return $data;
}
if(class\_exists('WPSEO\_Frontend') && 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-yoast-canonical') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') ){
add\_filter('ampforwp\_modify\_rel\_url','ampforwp\_yoast\_canonical');
}
function ampforwp\_yoast\_canonical($canonical){
if(ampforwp\_is\_front\_page()){
$canonical = ampforwp\_generate\_canonical();
}
return $canonical;
}
// #2220 Remove Space Shortcode by Pro Theme from THEMCO
add\_action('pre\_amp\_render\_post','ampforwp\_remove\_space\_shortcodes');
function ampforwp\_remove\_space\_shortcodes(){
add\_filter('the\_content','ampforwp\_remove\_pro\_theme\_space\_shortcodes');
}
function ampforwp\_remove\_pro\_theme\_space\_shortcodes($content){
if(has\_shortcode( $content, 'gap' )){
remove\_shortcode( 'gap' );
// to remove the useless shortcode from the AMP Content
add\_shortcode( 'gap', 'ampforwp\_return\_no\_gap' );
}
return $content;
}
function ampforwp\_return\_no\_gap(){
return;
}
/\*
#2229 Function to check the option for comments to display on post, page or both.
\*/
function ampforwp\_get\_comments\_status(){
global $redux\_builder\_amp;
$display\_comments\_on = "";
if ( false == ampforwp\_get\_setting('ampforwp-display-on-pages') && true == ampforwp\_get\_setting('ampforwp-display-on-posts') ) {
$display\_comments\_on = is\_single();
}
if ( true == ampforwp\_get\_setting('ampforwp-display-on-pages') && false == ampforwp\_get\_setting('ampforwp-display-on-posts') ) {
$display\_comments\_on = is\_page();
}
if ( true == ampforwp\_get\_setting('ampforwp-display-on-pages') && true == ampforwp\_get\_setting('ampforwp-display-on-posts')) {
$display\_comments\_on = is\_singular();
if ( ampforwp\_is\_front\_page() ) {
$display\_comments\_on = ampforwp\_is\_front\_page();
}
}
$display\_comments\_on = apply\_filters('ampforwp\_comments\_visibility', $display\_comments\_on);
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
return $display\_comments\_on;
}
// Vuukle Comments Support #2075
add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_vuukle\_comments\_support');
function ampforwp\_vuukle\_comments\_support() {
global $redux\_builder\_amp;
if ( true == ampforwp\_get\_setting('ampforwp-vuukle-comments-support') && comments\_open() && ampforwp\_get\_setting('amp-design-selector') != 4) {
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo ampforwp\_vuukle\_comments\_markup();
}
}
function ampforwp\_vuukle\_comments\_markup() {
global $redux\_builder\_amp,$post;
$apiKey = $locale = '';
$tag\_name ='';
$img = get\_the\_post\_thumbnail\_url();
$tags = get\_the\_tags($post->ID);
if( isset($redux\_builder\_amp['ampforwp-vuukle-comments-apiKey']) && $redux\_builder\_amp['ampforwp-vuukle-comments-apiKey'] !== ""){
$apiKey = $redux\_builder\_amp['ampforwp-vuukle-comments-apiKey'];
}
$display\_comments\_on = false;
$display\_comments\_on = ampforwp\_get\_comments\_status();
$siteUrl = trim(site\_url(), '/');
if (!preg\_match('#^http(s)?://#', $siteUrl)) {
$siteUrl = 'http://' . $siteUrl;
}
if($img == false){
$img = plugins\_url('accelerated-mobile-pages/images/150x150.png');
}
if($tags){
foreach($tags as $individual\_tag) {
$tag\_name = $individual\_tag->name;
}
}
$urlParts = parse\_url($siteUrl);
$siteUrl = preg\_replace('/^www\./', '', $urlParts['host']);// remove www
$srcUrl = 'https://cdn.vuukle.com/amp.html?';
$srcUrl = add\_query\_arg('url' ,get\_permalink(), $srcUrl);
$srcUrl = add\_query\_arg('host' ,$siteUrl, $srcUrl);
$srcUrl = add\_query\_arg('id' , $post->ID, $srcUrl);
if(!empty($apiKey)){
$srcUrl = add\_query\_arg('apiKey' , $apiKey, $srcUrl);
}
$srcUrl = add\_query\_arg('title' , urlencode($post->post\_title), $srcUrl);
$srcUrl = add\_query\_arg('img' , esc\_url($img), $srcUrl);
$srcUrl = add\_query\_arg('tags' , urlencode($tag\_name), $srcUrl);
if(ampforwp\_get\_setting('ampforwp-vuukle-comments-emoji')==false){
$srcUrl = add\_query\_arg('emotes' , 'false', $srcUrl);
}
$consent = '';
if(ampforwp\_get\_data\_consent()){
$consent = 'data-block-on-consent ';
}
$vuukle\_html ='';
if ( $display\_comments\_on ) {
$vuukle\_html .= '
Show comments';
}
return $vuukle\_html;
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_vuukle\_scripts' );
function ampforwp\_add\_vuukle\_scripts( $data ) {
global $redux\_builder\_amp;
$display\_comments\_on = "";
$display\_comments\_on = ampforwp\_get\_comments\_status();
if ( ampforwp\_get\_setting('ampforwp-vuukle-comments-support') && $display\_comments\_on) {
if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) {
$data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js';
}
if (ampforwp\_get\_setting('ampforwp-vuukle-Ads-before-comments') && empty( $data['amp\_component\_scripts']['amp-ad'] ) ) {
$data['amp\_component\_scripts']['amp-ad'] = 'https://cdn.ampproject.org/v0/amp-ad-0.1.js';
}
}
return $data;
}
//spotim #2076
add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_spotim\_comments\_support');
function ampforwp\_spotim\_comments\_support() {
global $redux\_builder\_amp;
if ( 4 != $redux\_builder\_amp['amp-design-selector']
&& isset($redux\_builder\_amp['ampforwp-spotim-comments-support'])
&& $redux\_builder\_amp['ampforwp-spotim-comments-support']==1
) {
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_spotim\_comments\_markup();
}
}
function ampforwp\_spotim\_comments\_markup() {
global $post;
$display\_comments\_on = false;
$display\_comments\_on = ampforwp\_get\_comments\_status();
if (! $display\_comments\_on ) {
return '';
}
$spotId ='';
if( true == ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey') && ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey') !== ""){
$spotId = ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey');
}
$srcUrl = 'https://amp.spot.im/production.html?spot\_im\_highlight\_immediate=true';
$srcUrl = add\_query\_arg('spotId' ,$spotId, $srcUrl);
$srcUrl = add\_query\_arg('postId' , $post->ID, $srcUrl);
$spotim\_html = '

Load more...
';
return $spotim\_html;
}
//spotim script
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_spotim\_scripts' );
function ampforwp\_add\_spotim\_scripts( $data ) {
global $redux\_builder\_amp;
$display\_comments\_on = "";
$display\_comments\_on = ampforwp\_get\_comments\_status();
if ( 4 != $redux\_builder\_amp['amp-design-selector']
&& isset($redux\_builder\_amp['ampforwp-spotim-comments-support'])
&& $redux\_builder\_amp['ampforwp-spotim-comments-support']
&& $display\_comments\_on && comments\_open()
) {
if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) {
$data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js';
}
}
return $data;
}
//spotim css
add\_action('amp\_post\_template\_css','ampforwp\_spotim\_vuukle\_styling',60);
function ampforwp\_spotim\_vuukle\_styling(){
global $redux\_builder\_amp;
$display\_comments\_on = "";
$display\_comments\_on = ampforwp\_get\_comments\_status();
if ( isset($redux\_builder\_amp['ampforwp-spotim-comments-support'])
&& $redux\_builder\_amp['ampforwp-spotim-comments-support']
&& $display\_comments\_on && comments\_open() ) {
?>.spot-im-amp-overflow {
background: white;
font-size: 15px;
padding: 15px 0;
text-align: center;
font-family: Helvetica, Arial, sans-serif;
color: #307fe2;
}php
}
if ( isset($redux\_builder\_amp['ampforwp-vuukle-comments-support'])
&& $redux\_builder\_amp['ampforwp-vuukle-comments-support']
&& $display\_comments\_on && comments\_open() ) { ?
.afwp-vuukle-support{
display: block;text-align: center;background: #1f87e5;color: #fff;border-radius: 4px;
} php
}
}
function ampforwp\_check\_excerpt(){
global $redux\_builder\_amp;
$value = '';
$value = ( isset( $redux\_builder\_amp['excerpt-option'] ) && $redux\_builder\_amp['excerpt-option'] ) ;
if ( null === $value ) {
$value = '1';
}
return $value;
}
// Back to top
add\_action( 'ampforwp\_body\_beginning' ,'ampforwp\_back\_to\_top\_markup');
function ampforwp\_back\_to\_top\_markup(){
if(true == ampforwp\_get\_setting('ampforwp-footer-top')){
echo '<div id="backtotop"';
}
}
// rel="next" & rel="prev" pagination meta tags #2343
add\_action( 'amp\_post\_template\_head', 'ampforwp\_rel\_next\_prev' );
function ampforwp\_rel\_next\_prev(){
global $paged;
if(ampforwp\_is\_front\_page()){
return ;
}
if ( get\_previous\_posts\_link() ) { ?>
php
}
if ( get\_next\_posts\_link() ) { ?
php
}
}
// Content Sneak Peek #2246
add\_action('pre\_amp\_render\_post', 'ampforwp\_content\_sneak\_peek');
if ( ! function\_exists('ampforwp\_content\_sneak\_peek') ) {
function ampforwp\_content\_sneak\_peek() {
global $redux\_builder\_amp;
if ( ampforwp\_get\_setting('content-sneak-peek') && is\_single() && 'post' == get\_post\_type() ) {
add\_filter('ampforwp\_modify\_the\_content', 'ampforwp\_sneak\_peek\_content\_modifier');
add\_action('amp\_post\_template\_css','ampforwp\_sneak\_peek\_css');
add\_filter('ampforwp\_post\_template\_data','ampforwp\_sneak\_peek\_scripts');
}
}
}
// Content Sneak Peek content
function ampforwp\_sneak\_peek\_content\_modifier($content){
if ( strlen($content) = 3000 ) {
$content = '' . $content . '';
$content = $content . '';
$content = $content . ''.ampforwp\_translation(ampforwp\_get\_setting('content-sneak-peek-btn-text'), 'Show Full Article').'';
}
return $content;
}
// Content Sneak Peek Scripts css
function ampforwp\_sneak\_peek\_css(){
global $redux\_builder\_amp;
$height = $txt\_color = $btn\_color = '';
$height = ampforwp\_get\_setting('content-sneak-peek-height');
$btn\_color = $redux\_builder\_amp['content-sneak-peek-btn-color']['color'];
$txt\_color = $redux\_builder\_amp['content-sneak-peek-txt-color']['color'];?>
.fd-h{height: php echo esc\_attr($height); ?;overflow: hidden;position: relative;}
.fd-b-c{text-align: center;margin: 0px 0px 30px 0px;}
.fd-b-c .fd-b:hover{cursor:pointer;}
.fd-b-c .fd-b {border:none;border-radius: 5px;color: php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_sanitize\_color($txt\_color); ?;font-size: 16px;font-weight: 700;padding: 12px 32px 12px 32px;background-color: php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_sanitize\_color($btn\_color); ?;
}
.fd-h:after {
content: "";
display: inline-block;
position: absolute;
background: linear-gradient(to bottom,rgba(255,255,255,0) 0,rgba(255,255,255,1) 100%);
width:100%;
bottom: 0;
top:auto;
height:230px;
}
php }
// Content Sneak Peek Scripts
function ampforwp\_sneak\_peek\_scripts($data) {
if ( empty( $data['amp\_component\_scripts']['amp-bind'] ) ) {
$data['amp\_component\_scripts']['amp-bind'] = 'https://cdn.ampproject.org/v0/amp-bind-0.1.js';
}
return $data;
}
// #1575 Thrive Content Support
add\_action('amp\_init','ampforwp\_thrive\_architect\_content');
function ampforwp\_thrive\_architect\_content(){
if(function\_exists('tve\_wp\_action') && !function\_exists('et\_setup\_theme')){
if(checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){
add\_filter( 'ampforwp\_modify\_the\_content','ampforwp\_thrive\_content');
}
}
$url\_path = parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH);
if($url\_path=="" || $url\_path==null){
$url\_path = $url\_path.'/';
}
$url\_path = trim($url\_path,'/' );
if ( function\_exists( 'ampforwp\_is\_amp\_inURL' ) && ampforwp\_is\_amp\_inURL($url\_path) ) {
//#3254 Remove action for Woodmart theme lazyload feature
remove\_action( 'init', 'woodmart\_lazy\_loading\_init', 120 );
}
}
function ampforwp\_thrive\_content($content){
$post\_id = "";
if ( ampforwp\_is\_front\_page() ){
$post\_id = ampforwp\_get\_frontpage\_id();
$content = get\_post\_field( 'post\_content', $post\_id );
}
$sanitizer\_obj = new AMPFORWP\_Content( $content,
array(),
apply\_filters( 'ampforwp\_content\_sanitizers',
array( 'AMP\_Img\_Sanitizer' = array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
)
)
);
$content = $sanitizer\_obj->get\_amp\_content();
return $content;
}
// Instant Articles Meta Box
add\_action( 'add\_meta\_boxes', 'ampforwp\_ia\_meta\_box' );
if ( ! function\_exists('ampforwp\_ia\_meta\_box') ) {
function ampforwp\_ia\_meta\_box() {
global $post;
if( ampforwp\_get\_setting('fb-instant-article-switch') && $post->post\_type == 'post' ) {
add\_meta\_box( 'ampforwp\_ia\_meta', esc\_html\_\_( 'Show Instant Article for Current Post?','accelerated-mobile-pages' ), 'ampforwp\_ia\_meta\_callback', 'post','side' );
}
}
}
// Callback function for Instant Articles Meta Box.
function ampforwp\_ia\_meta\_callback( $post ) {
global $redux\_builder\_amp;
wp\_nonce\_field( basename( \_\_FILE\_\_ ), 'ampforwp\_ia\_nonce' );
$ampforwp\_stored\_meta = get\_post\_meta( ampforwp\_get\_the\_ID() );
if ( ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off']) && ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off'][0]) && $ampforwp\_stored\_meta['ampforwp-ia-on-off'][0] == 'hide-ia') {
$exclude\_post\_value = get\_option('ampforwp\_ia\_exclude\_post');
if ( $exclude\_post\_value == null ) {
$exclude\_post\_value[] = 0;
}
if ( $exclude\_post\_value ) {
if ( ! in\_array( ampforwp\_get\_the\_ID(), $exclude\_post\_value ) ) {
$exclude\_post\_value[] = ampforwp\_get\_the\_ID();
update\_option('ampforwp\_ia\_exclude\_post', $exclude\_post\_value, false);
}
}
} else {
$exclude\_post\_value = get\_option('ampforwp\_ia\_exclude\_post');
if ( $exclude\_post\_value == null ) {
$exclude\_post\_value[] = 0;
}
if ( $exclude\_post\_value ) {
if ( in\_array( ampforwp\_get\_the\_ID(), $exclude\_post\_value ) ) {
$exclude\_ids = array\_diff($exclude\_post\_value, array(ampforwp\_get\_the\_ID()) );
update\_option('ampforwp\_ia\_exclude\_post', $exclude\_ids, false);
}
}
}
$ampforwp\_current\_ia\_value='hide-ia';
if(ampforwp\_role\_based\_access\_options()==true){
$ampforwp\_current\_ia\_value='default';
}
if ( ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off']) && ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off'][0])){
$ampforwp\_current\_ia\_value= $ampforwp\_stored\_meta['ampforwp-ia-on-off'][0];
}
?>

>
php esc\_html\_e( 'Enable', 'accelerated-mobile-pages' )?

>
php esc\_html\_e( 'Disable', 'accelerated-mobile-pages' )?

php }
// Total Plus compatibility #2511
add\_action('current\_screen', 'ampforwp\_totalplus\_comp\_admin');
function ampforwp\_totalplus\_comp\_admin() {
$screen = get\_current\_screen();
if ( 'toplevel\_page\_amp\_options' == $screen-base ) {
remove\_action('admin\_enqueue\_scripts', 'total\_plus\_admin\_scripts', 100);
// Save option is not showing with a basix theme #3366
if(function\_exists('addPanelCSS')){
remove\_action( 'admin\_enqueue\_scripts', 'addPanelCSS');
}
}
}
// uploading the images with SVG format #2431
function ampforwp\_upload\_svg($file\_types){
$new\_filetypes = array();
$new\_filetypes['svg'] = 'image/svg+xml';
$file\_types = array\_merge($file\_types, $new\_filetypes );
return $file\_types;
}
add\_action('upload\_mimes', 'ampforwp\_upload\_svg');
// Ajax functions
add\_action( 'wp\_ajax\_ampforwp\_categories', 'ampforwp\_ajax\_cats' );
function ampforwp\_ajax\_cats(){
$return = array();
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
if( isset( $\_GET[ 'security' ] ) && isset($\_GET[ 'security' ]['security']) && wp\_verify\_nonce($\_GET[ 'security' ]['security'],'ampforwp-verify-request') ){
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
$categories = get\_categories(array('search'=> esc\_html($\_GET['q']),'number'=>500,'hide\_empty' => 0));
$categories\_array = array();
if ( $categories ) :
foreach ($categories as $cat ) {
$return[] = array($cat->cat\_ID,$cat->name);// array( Cat ID, Cat Name )
}
endif;
}
wp\_send\_json( $return );
}
add\_action( 'wp\_ajax\_ampforwp\_tags', 'ampforwp\_ajax\_tags' );
function ampforwp\_ajax\_tags(){
$return = array();
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
if( isset( $\_GET[ 'security' ] ) && isset($\_GET[ 'security' ]['security']) && wp\_verify\_nonce($\_GET[ 'security' ]['security'],'ampforwp-verify-request') ){
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
$tags = get\_tags(array('search'=> esc\_html($\_GET['q']),'number'=>500));
if ( $tags ) :
foreach ($tags as $tag ) {
$return[] = array($tag->term\_id,$tag->name);// array( Tag ID, tag Name )
}
endif;
}
wp\_send\_json( $return );
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_backtotop' );
function ampforwp\_backtotop( $data ) {
global $redux\_builder\_amp;
if(true == ampforwp\_get\_setting('ampforwp-footer-top')){
$dom = AMP\_DOM\_Utils::get\_dom\_from\_content($data['post\_amp\_content']);
if ( 0 !== $dom->getElementsByTagName( 'amp-position-observer' )->length ) {
if ( empty( $data['amp\_component\_scripts']['amp-position-observer'] ) ) {
$data['amp\_component\_scripts']['amp-position-observer'] = 'https://cdn.ampproject.org/v0/amp-position-observer-0.1.js';
}
}
if ( 0 !== $dom->getElementsByTagName( 'amp-animation' )->length ) {
if ( empty( $data['amp\_component\_scripts']['amp-animation'] ) ) {
$data['amp\_component\_scripts']['amp-animation'] = 'https://cdn.ampproject.org/v0/amp-animation-0.1.js';
}
}
}
return $data;
}
// Jannah Theme Subtitle Support #2732
add\_action('ampforwp\_below\_the\_title','ampforwp\_jannah\_subtitle');
function ampforwp\_jannah\_subtitle(){
if (function\_exists('jannah\_theme\_name') && function\_exists('tie\_get\_postdata')){?>
## php echo esc\_html(tie\_get\_postdata( 'tie\_post\_sub\_title' ))?

php
}
}
// SD Feature Image Guidlines #2838
add\_filter( 'amp\_post\_template\_metadata', 'ampforwp\_sd\_feature\_image\_guidlines', 22, 1 );
if ( ! function\_exists('ampforwp\_sd\_feature\_image\_guidlines') ) {
function ampforwp\_sd\_feature\_image\_guidlines($metadata){
if ( isset($metadata['image']['width']) && $metadata['image']['width'] <= 1200 ){
$image\_width = 1280;
$image\_height = 720;
$image = ampforwp\_aq\_resize( $metadata['image']['url'], $image\_width, $image\_height, true, false, true );
$image\_url = isset( $image[0] ) ? $image[0] : '';
$metadata['image']['url'] = $image\_url;
$metadata['image']['width'] = $image\_width;
$metadata['image']['height'] = $image\_height;
}
return $metadata;
}
}
// Gutenberg Modules CSS #2707
if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking') == true && ampforwp\_is\_gutenberg\_active()){
add\_action('amp\_post\_template\_css', 'ampforwp\_gutenberg\_css');
}
if ( ! function\_exists('ampforwp\_gutenberg\_css') ) {
function ampforwp\_gutenberg\_css(){
$color\_data = get\_theme\_support('editor-color-palette');
$background = '#32373c';
if(isset($color\_data[0]) && isset($color\_data[0][0]) && isset($color\_data[0][0]['color'])){
$background = $color\_data[0][0]['color'];
}
?
.wp-block-button { color: #fff}
.wp-block-button a {background-color: php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_sanitize\_color($background);?;border-radius: 28px;color: inherit;display: inline-block;padding: 12px 24px;}
.wp-block-cover{position:relative;background-color: #000;background-size: cover;background-position: center center;min-height: 430px;width: 100%;margin: 1.5em 0 1.5em 0;display: flex;justify-content: center;align-items: center;overflow: hidden;}
.wp-block-cover-text{color: #fff;font-size: 2em;line-height: 1.25;z-index: 1;}
.wp-block-cover-image.has-background-dim::before, .wp-block-cover.has-background-dim::before {content: "";position: absolute;top: 0;left: 0;bottom: 0;right: 0;background-color: inherit;opacity: .5;z-index: 1;} php
if ( $color\_data ) {
foreach ($color\_data[0] as $key ) { ?
.has-php echo esc\_attr($key['slug']);?-color { color: php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_sanitize\_color($key['color']);?;} .has-php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo esc\_attr($key['slug']);?-background-color { background-color: php
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo ampforwp\_sanitize\_color($key['color']);? }
php
}
}
}
}
// Subtitles Plugin Support #2853
add\_action('ampforwp\_below\_the\_title','ampforwp\_subtitles\_support');
if ( ! function\_exists('ampforwp\_subtitles\_support') ) {
function ampforwp\_subtitles\_support(){
if (class\_exists('Subtitles')){
$post\_id = get\_the\_ID();
if(ampforwp\_is\_front\_page()){
$post\_id = ampforwp\_get\_frontpage\_id();
}
// exit if no post id is available.
if (empty($post\_id)){
return;
}
$subtitle = "";
$subtitle = get\_post\_meta( $post\_id, Subtitles::SUBTITLE\_META\_KEY, true );
?
## php echo esc\_html($subtitle) ?

php
}
}
}
// AMPforWP Global Sanitizer
add\_action('pre\_amp\_render\_post','ampforwp\_comments\_sanitizer', 15);
function ampforwp\_comments\_sanitizer(){
global $ampforwp\_data;
$comments\_scripts = array();
$comments = $postID = $comment\_text = '';
$postID = get\_the\_ID();
if ( ampforwp\_is\_front\_page() ) {
$postID = ampforwp\_get\_frontpage\_id();
}
if ( ampforwp\_get\_comments\_status() && true == ampforwp\_get\_setting('wordpress-comments-support') ) {
$comment\_order = get\_option( 'comment\_order' );
$comments = get\_comments(array(
'post\_id' = $postID,
'order' => esc\_attr($comment\_order),
'status' => 'approve' //Change this to the type of comments to be displayed
) );
foreach ($comments as $comment) {
$comment\_data = get\_comment( $comment->comment\_ID );
$comment\_text = $comment\_data->comment\_content;
$comment\_text = wpautop( $comment\_text );
$sanitizer = new AMPforWP\_Content( $comment\_text, apply\_filters( 'amp\_content\_embed\_handlers', array(
'AMP\_Reddit\_Embed\_Handler' => array(),
'AMP\_Twitter\_Embed\_Handler' => array(),
'AMP\_YouTube\_Embed\_Handler' => array(),
'AMP\_DailyMotion\_Embed\_Handler' => array(),
'AMP\_Vimeo\_Embed\_Handler' => array(),
'AMP\_SoundCloud\_Embed\_Handler' => array(),
'AMP\_Instagram\_Embed\_Handler' => array(),
'AMP\_Vine\_Embed\_Handler' => array(),
'AMP\_Facebook\_Embed\_Handler' => array(),
'AMP\_Pinterest\_Embed\_Handler' => array(),
'AMP\_Gallery\_Embed\_Handler' => array(),
'AMP\_Tiktok\_Embed\_Handler'=>array(),
) ), apply\_filters( 'amp\_sidebar\_sanitizers', array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Playbuzz\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
),
) ) );
if ( $sanitizer ) {
$sanitizer\_scripts = $sanitizer->get\_amp\_scripts();
if ( $sanitizer\_scripts ){
$comments\_scripts = array\_merge($comments\_scripts, $sanitizer\_scripts);
}
}
}
if ( $comments\_scripts ) {
$ampforwp\_data['comments']['scripts'] = $comments\_scripts;
}
}
}
// AMPforWP Global Scripts
add\_filter('amp\_post\_template\_data','ampforwp\_add\_global\_scripts');
function ampforwp\_add\_global\_scripts($data){
global $ampforwp\_data;
$comments\_scripts = array();
// Add Comments Scripts #2827
if ( $comments\_scripts ) {
$comments\_scripts = $ampforwp\_data['comments']['scripts'];
}
if ( !empty($comments\_scripts) ) {
foreach ($comments\_scripts as $key => $value ) {
if( empty( $data['amp\_component\_scripts'][$key] ) ){
$data['amp\_component\_scripts'][$key] = $value;
}
}
}
// AddThis Support #3068
if ( ampforwp\_get\_setting('enable-add-this-option') && ( is\_single() || (is\_page() && ampforwp\_get\_setting('ampforwp-page-social') ) ) && !ampforwp\_woocommerce\_conditional\_check() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && ( ampforwp\_get\_setting('addthis-floating-share') == true || ampforwp\_get\_setting('addthis-inline-share') == true)) {
if ( empty( $data['amp\_component\_scripts']['amp-addthis'] ) ) {
$data['amp\_component\_scripts']['amp-addthis'] = 'https://cdn.ampproject.org/v0/amp-addthis-0.1.js';
}
}
// Featured video SmartMag theme Compatibility #2559:
if( function\_exists('get\_the\_post\_video') || class\_exists('Bunyad') ) {
if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) {
$data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js';
}
}
//Appearance option for Related Posts #1545
if ( true == ampforwp\_get\_setting('ampforwp-single-related-posts-switch') && ampforwp\_get\_setting('rp\_design\_type') == '3') {
if ( empty( $data['amp\_component\_scripts']['amp-carousel'] ) ) {
$data['amp\_component\_scripts']['amp-carousel'] = 'https://cdn.ampproject.org/v0/amp-carousel-0.2.js';
}
}
return $data;
}
if ( ! function\_exists('ampforwp\_get\_weglot\_url') ) {
function ampforwp\_get\_weglot\_url(){
$url = weglot\_get\_full\_url\_no\_language();
$current\_lang = weglot\_get\_current\_and\_original\_language();
$original\_lang = $current\_lang['original'];
$current\_lang = $current\_lang['current'];
if($current\_lang == $original\_lang ){
return $url;
}else{
$url = trailingslashit($url) . $current\_lang;
return esc\_url(user\_trailingslashit($url));
}
}
}
// Rank Math SEO Compatibility #2701
// og tags and Schema
add\_action('amp\_post\_template\_head','ampforwp\_rank\_math');
if ( ! function\_exists('ampforwp\_rank\_math') ) {
function ampforwp\_rank\_math(){
// Early Bail if Rank Math is not selected in SEO Plugin Integration.
if ( 'rank\_math' !== ampforwp\_get\_setting('ampforwp-seo-selection') ) {
return;
}
// Remove Canonical & Title Tag added by the Rank Math plugin.
remove\_all\_actions( 'rank\_math/head', 20 );
remove\_all\_actions( 'rank\_math/head', 1 );
// Remove meta tags added by the Rank Math plugin.
if ( ! ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-meta' ) ) {
$json\_ld\_data = isset( $wp\_filter['rank\_math/json\_ld'] ) ? $wp\_filter['rank\_math/json\_ld'] : '';
remove\_all\_actions( 'rank\_math/opengraph/facebook' );
remove\_all\_actions( 'rank\_math/opengraph/twitter' );
add\_filter( 'rank\_math/frontend/robots', function() {
return [];
});
}else if(ampforwp\_is\_front\_page()){
add\_filter( 'rank\_math/frontend/robots', function() {
return [];
});
}
// Remove ld+json data added by the Rank math plugin.
if ( ! ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-schema' ) ) {
remove\_all\_actions( 'rank\_math/json\_ld' );
}
if(class\_exists('RankMath') && true == ampforwp\_get\_setting('ampforwp-amp-takeover') && ( ampforwp\_is\_home() || ampforwp\_is\_front\_page())){
$google = RankMath\Helper::get\_settings( 'general.google\_verify' );
$bing = RankMath\Helper::get\_settings( 'general.bing\_verify' );
$baidu = RankMath\Helper::get\_settings( 'general.baidu\_verify' );
$alexa = RankMath\Helper::get\_settings( 'general.alexa\_verify' );
$yandex = RankMath\Helper::get\_settings( 'general.yandex\_verify' );
$pinterest = RankMath\Helper::get\_settings( 'general.pinterest\_verify' );
$norton = RankMath\Helper::get\_settings( 'general.norton\_verify' );
if(!empty($google)){?>
php }
if(!empty($bing)){?

php }
if(!empty($baidu)){?

php }
if(!empty($alexa)){?

php }
if(!empty($yandex)){?

php }
if(!empty($pinterest)){?

php }
if(!empty($norton)){?

php }
}
do\_action( 'rank\_math/head' );
}
}
#1160 Embedly Sanitizer
add\_filter( 'amp\_content\_sanitizers', 'ampforwp\_embedly\_sanitizer', 10, 1 );
function ampforwp\_embedly\_sanitizer( $sanitizer\_classes ) {
if ( class\_exists('WP\_Embedly') ) {
require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-embedly-sanitizer.php' );
$sanitizer\_classes[ 'AMPforWP\_Embedly\_Sanitizer' ] = array();
}
return $sanitizer\_classes;
}
add\_filter('ampforwp\_is\_amp\_endpoint\_takeover', "ampforwp\_bulktool\_takeover");
if (! function\_exists('ampforwp\_bulktool\_takeover') ) {
function ampforwp\_bulktool\_takeover($data){
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp') || $mob\_pres\_link == true) {
$bulk\_option = ampforwp\_get\_setting('amp-pages-meta-default');
$ampforwp\_stored\_meta = get\_post\_meta( ampforwp\_get\_the\_ID(),'ampforwp-amp-on-off',true);
if(is\_page() && $bulk\_option == "hide" && !isset($ampforwp\_stored\_meta)){
remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 );
return false;
}
}
return $data;
}
}
add\_filter('ampforwp\_is\_amp\_endpoint\_takeover','ampforwp\_disable\_takovr\_elementor\_preview');
function ampforwp\_disable\_takovr\_elementor\_preview($data){
if ( did\_action( 'elementor/loaded' ) ) {
if( \Elementor\Plugin::$instance-preview->is\_preview\_mode() ){
return false;
}else{
return $data;
}
}
return $data;
}
// Multiple Images #2259
// Moved to structured-data-functions.php
// schema.org/SiteNavigationElement missing from menus #1229 & #2952
// Moved to structured-data-functions.php
// WP Subtitle Support #2831
add\_action('ampforwp\_below\_the\_title','ampforwp\_wpsubtitle\_support');
if (! function\_exists('ampforwp\_wpsubtitle\_support') ) {
function ampforwp\_wpsubtitle\_support(){
if(class\_exists('WPSubtitle')){?>
## php the\_subtitle(); ?

php
}
}
}
// Fallbacks for Vendor AMP #2287
// Class AMP\_Base\_Sanitizer
if ( ! class\_exists('AMP\_Base\_Sanitizer') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Base\_Sanitizer') ) {
abstract class AMP\_Base\_Sanitizer extends AMPforWP\AMPVendor\AMP\_Base\_Sanitizer
{
}
}
// Class AMP\_Base\_Embed\_Handler
if ( ! class\_exists('AMP\_Base\_Embed\_Handler') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Base\_Embed\_Handler') ) {
abstract class AMP\_Base\_Embed\_Handler extends AMPforWP\AMPVendor\AMP\_Base\_Embed\_Handler
{
}
}
// Class AMP\_HTML\_Utils
if ( ! class\_exists('AMP\_HTML\_Utils') && class\_exists('AMPforWP\\AMPVendor\\AMP\_HTML\_Utils') ) {
class AMP\_HTML\_Utils extends AMPforWP\AMPVendor\AMP\_HTML\_Utils{}
}
// Class AMP\_DOM\_Utils
if ( ! class\_exists('AMP\_DOM\_Utils') && class\_exists('AMPforWP\\AMPVendor\\AMP\_DOM\_Utils') ) {
class AMP\_DOM\_Utils extends AMPforWP\AMPVendor\AMP\_DOM\_Utils{}
}
// Function is\_amp\_endpoint
add\_action('pre\_amp\_render\_post', 'ampforwp\_is\_amp\_endpoint\_old');
if ( !function\_exists('ampforwp\_is\_amp\_endpoint\_old') ) {
function ampforwp\_is\_amp\_endpoint\_old(){
if ( !function\_exists('amp\_activate') && ! function\_exists('is\_amp\_endpoint') ){
function is\_amp\_endpoint(){
return ampforwp\_is\_amp\_endpoint();
}
}
// Class AMP\_Post\_Template
if ( ! class\_exists('AMP\_Post\_Template') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Post\_Template') ) {
class AMP\_Post\_Template extends AMPforWP\AMPVendor\AMP\_Post\_Template{}
}
}
}
// End Fallbacks for Vendor AMP
// ampforwp\_post\_template\_data filter #2287
add\_filter('amp\_post\_template\_data', 'ampforwp\_post\_template\_data');
function ampforwp\_post\_template\_data( $data ) {
// Run through our filter
$data = apply\_filters('ampforwp\_post\_template\_data', $data );
return $data;
}
if(false==ampforwp\_get\_setting('hide-amp-version-from-source')){
add\_action('amp\_meta','ampforwp\_generator');
if ( ! function\_exists('ampforwp\_generator') ) {
function ampforwp\_generator(){
if(true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')){
?

php }
}
}
}
// #2497 Ivory Search Compatibility Added
add\_filter('ampforwp\_menu\_content','ampforwp\_modify\_ivory\_search');
if( ! function\_exists(' ampforwp\_modify\_ivory\_search ') ){
function ampforwp\_modify\_ivory\_search($menu){
if(!class\_exists('Ivory\_Search')){
return $menu;
}
$dom = '';
$nodes = '';
$num\_nodes = '';
if( !empty( $menu ) ){
// Create a new document
$dom = new DOMDocument();
if( function\_exists( 'mb\_convert\_encoding' ) ){
$menu = mb\_convert\_encoding($menu, 'HTML-ENTITIES', 'UTF-8');
}
else{
$menu = preg\_replace( '/&.\*?;/', 'x', $menu ); // multi-byte characters converted to X
}
// To Suppress Warnings
libxml\_use\_internal\_errors(true);
$dom-loadHTML($menu);
libxml\_use\_internal\_errors(false);
// get all the forms
$nodes = $dom->getElementsByTagName( 'form' );
$num\_nodes = $nodes->length;
for ( $i = $num\_nodes - 1; $i >= 0; $i-- ) {
$node = $nodes->item( $i );
// Set The Width and Height if there in none
if ( '' === $node->getAttribute( 'target' ) ) {
$node->setAttribute('target', '\_top');
}
if ( $node->getAttribute('action')){
$action\_url = '';
$action\_url = $node->getAttribute('action');
$action\_url = preg\_replace('#^http?:#', '', $action\_url);
$node->setAttribute('action', $action\_url);
}
}
$menu = $dom->saveHTML();
}
return $menu;
}
}
add\_action('amp\_post\_template\_css','ampforwp\_ivory\_search\_css');
function ampforwp\_ivory\_search\_css(){
if(class\_exists('Ivory\_Search')){?>
svg.icon.icon-search {
display: none;
}
input.search-field {
display: inline-block;
}
svg.search-icon {
display: none;
}
php } }
// Font Awesome Icons added for Swift
add\_action('amp\_post\_template\_head', 'ampforwp\_fontawesome\_canonical\_link');
function ampforwp\_fontawesome\_canonical\_link(){
if ( ampforwp\_get\_setting('ampforwp\_font\_icon') == 'fontawesome-icons' ){ /\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedStylesheet,PluginCheck.CodeAnalysis.Offloading.OffloadedContent \*/ ?
php /\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedStylesheet,PluginCheck.CodeAnalysis.Offloading.OffloadedContent \*/?
php }
}
add\_action('amp\_post\_template\_head', 'ampforwp\_set\_dns\_preload\_urls');
function ampforwp\_set\_dns\_preload\_urls(){
// Open graph tag is not loading from the SEO framework #4399
if (function\_exists('the\_seo\_framework') && 'seo\_framework' == ampforwp\_get\_setting('ampforwp-seo-selection')) {
$og\_tsf = \the\_seo\_framework();
if($og\_tsf){
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf-og\_image();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_locale();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_type();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_title();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_image();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_description();
//phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
echo $og\_tsf->og\_sitename();
}
}
$prefetch = ampforwp\_get\_setting('amp-prefetch-options');
$data\_arr = array();
if(is\_array($prefetch)){
foreach ( $prefetch as $k => $value ) {
if(is\_array($value)){
foreach ($value as $tk => $tval) {
$temp\_arr = array();
$temp\_arr['name'][] = $k;
$temp\_arr['type'][] = $tk;
foreach ($tval as $ck => $cval) {
$temp\_arr['value'][] = $cval;
}
$data\_arr[] = $temp\_arr;
}
}
}
if(isset($data\_arr[0]) && !empty($data\_arr)){
$val\_count = count($data\_arr[0]['value']);
for($i=0;$i<$val\_count;$i++){
for($j=0;$j
 href="php echo esc\_url($value);?" crossorigin>
php
}
}
}
}
}
}
}
// Yoast BreadCrumbs #1473
add\_action('pre\_amp\_render\_post', 'ampforwp\_yoast\_breadcrumbs');
if ( ! function\_exists('ampforwp\_yoast\_breadcrumbs') ) {
function ampforwp\_yoast\_breadcrumbs(){
if ( ampforwp\_get\_setting('ampforwp-yoast-bread-crumb') ) {
// Remove the separator of Yoast
add\_filter('wpseo\_breadcrumb\_separator','ampforwp\_yoast\_breadcrumbs\_sep');
function ampforwp\_yoast\_breadcrumbs\_sep($sep) {
$sep = '';
return $sep;
}
// Remove xmlns:v to avoid validation error
add\_filter('wpseo\_breadcrumb\_output','ampforwp\_yoast\_breadcrumbs\_modified\_output');
function ampforwp\_yoast\_breadcrumbs\_modified\_output($output){
$output = str\_replace('xmlns:v="http://rdf.data-vocabulary.org/#"', '', $output);
return $output;
}
// Change the wrapper to div
add\_filter('wpseo\_breadcrumb\_output\_wrapper', 'ampforwp\_yoast\_breadcrumbs\_wrapper');
function ampforwp\_yoast\_breadcrumbs\_wrapper($wrap) {
$wrap = 'div';
return $wrap;
}
// Add the Breadcrumbs class to wrapper
add\_filter('wpseo\_breadcrumb\_output\_class','ampforwp\_yoast\_breadcrumbs\_wrapper\_class');
function ampforwp\_yoast\_breadcrumbs\_wrapper\_class($class) {
$class = 'breadcrumbs';
return $class;
}
}
}
}
function ampforwp\_yoast\_breadcrumbs\_output(){
if ( class\_exists('WPSEO\_Options') && method\_exists('WPSEO\_Options', 'get') ){
$breadcrumb = '';
if ( true == ampforwp\_get\_setting('ampforwp-yoast-bread-crumb') && true === WPSEO\_Options::get( 'breadcrumbs-enable' ) && function\_exists('yoast\_breadcrumb')) {
$breadcrumb = yoast\_breadcrumb('','', false);
if( true == ampforwp\_get\_setting('convert-internal-nonamplinks-to-amp') && preg\_match('/<a\s+href="(.\*?)"(.\*?)<\/a>/', $breadcrumb)){
$breadcrumb = preg\_replace('/(.\*?)<\/a>/', '[$2](%241/%27.user_trailingslashit%28AMPFORWP_AMP_QUERY_VAR%29.%27)', $breadcrumb);
}
return $breadcrumb;
}
}
}
// Slide Anything compatibility #2891
add\_filter('amp\_content\_embed\_handlers','ampforwp\_slide\_anything\_embed');
function ampforwp\_slide\_anything\_embed($data) {
if ( function\_exists('cpt\_slider\_plugin\_activation') ) {
require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-slide-anything-embed.php' );
$data['AMPFORWP\_Slide\_Anything\_Embed\_Handler'] = array();
}
return $data;
}
// Revolution Slider compatibility #1464
add\_action('pre\_amp\_render\_post', 'ampforwp\_initialise\_rev\_slider');
if ( ! function\_exists('ampforwp\_initialise\_rev\_slider') ) {
function ampforwp\_initialise\_rev\_slider(){
if ( class\_exists('RevSliderOutput') ){
require AMPFORWP\_PLUGIN\_DIR .'/classes/class-ampforwp-rev-slider.php';
}
}
}
add\_filter('amp\_content\_embed\_handlers','ampforwp\_rev\_slider\_embed');
function ampforwp\_rev\_slider\_embed($data) {
if ( class\_exists('RevSliderOutput') ){
$data['AMP\_Rev\_Slider\_Embed\_Handler'] = array();
}
return $data;
}
// Photo Gallery by 10Web Compatibility #1811
add\_action('pre\_amp\_render\_post', 'ampforwp\_initialise\_photo\_gallery');
if ( ! function\_exists('ampforwp\_initialise\_photo\_gallery') ) {
function ampforwp\_initialise\_photo\_gallery(){
if ( class\_exists('BWG') ) {
require AMPFORWP\_PLUGIN\_DIR .'/classes/class-ampforwp-photo-gallery-embed.php';
}
}
}
add\_filter('amp\_content\_embed\_handlers','ampforwp\_photo\_gallery\_embed');
function ampforwp\_photo\_gallery\_embed($data) {
if ( class\_exists('BWG') ) {
$data['AMPforWP\_Photo\_Gallery\_Embed\_Handler'] = array();
}
return $data;
}
function ampforwp\_rel\_attributes\_social\_links(){
$rel\_attributes = array();
if (true == ampforwp\_get\_setting('ampforwp-social-no-follow')) {
$rel\_attributes[] = 'nofollow';
}
if (true == ampforwp\_get\_setting('ampforwp-social-no-referrer')) {
$rel\_attributes[] = 'noreferrer';
}
if (true == ampforwp\_get\_setting('ampforwp-social-no-opener')) {
$rel\_attributes[] = 'noopener';
}
$rel\_attributes = apply\_filters('ampforwp\_rel\_attributes\_social\_links', $rel\_attributes);
$rel\_attributes = array\_map('esc\_attr', $rel\_attributes);
if ( $rel\_attributes ) {
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo 'rel="' . implode(" ",$rel\_attributes).'"';
}
return;
}
// Fallback added
function ampforwp\_nofollow\_social\_links(){
ampforwp\_rel\_attributes\_social\_links();
return ;
}
function ampforwp\_nofollow\_notification(){
if(true == ampforwp\_get\_setting('ampforwp-notifications-nofollow')){
echo 'rel=nofollow';
return;
}
return false;
}
// Featured Video SmartMag theme Compatibility CSS #2559
add\_action('amp\_post\_template\_css', 'ampforwp\_featured\_video\_plus\_css');
function ampforwp\_featured\_video\_plus\_css(){
if( function\_exists('get\_the\_post\_video') ) {?>
.fvp-onload{display:none}
php }
if(class\_exists('Bunyad')){ ?
.amp-featured-image amp-iframe, .amp-wp-article-featured-image amp-iframe { margin:auto; height:100%; }
.f\_vid { background: #000; }
php }
}
function ampforwp\_webp\_featured\_image() {
$post\_id = ampforwp\_get\_the\_ID();
if ( ! has\_post\_thumbnail( $post\_id )) {
return false;
}
$thumb\_id = get\_post\_thumbnail\_id($post\_id);
$image\_size = apply\_filters( 'ampforwp\_featured\_image', 'full' );
$image = wp\_get\_attachment\_image\_src( $thumb\_id, $image\_size );
if( $image ) {
if(empty($image[1])){
$image[1] = 750;
}
if(empty($image[2])){
$image[2] = 500;
}
$thumb\_alt = get\_post\_meta( $thumb\_id, '\_wp\_attachment\_image\_alt', true);
if($thumb\_alt){
$alt = $thumb\_alt;
}
else{
$alt = get\_the\_title( $post\_id );
}
$alt = convert\_chars( stripslashes( $alt ) );
$image\_output = "<amp-img src='".esc\_url($image[0])."' width='".esc\_attr($image[1])."' height='".esc\_attr($image[2])."' layout='responsive' alt='".esc\_attr($alt)."' ";?>
php
if(1 == ampforwp\_get\_setting('amp-design-selector') || 2 == ampforwp\_get\_setting('amp-design-selector') || 3 == ampforwp\_get\_setting('amp-design-selector')){?
php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo $image\_output; // escaped above
?

php }
}
}
// Keep the default WordPress form for AMP #3000
add\_filter('get\_search\_form', 'ampforwp\_search\_form');
if ( ! function\_exists('ampforwp\_search\_form') ) {
function ampforwp\_search\_form($form){
if ( ampforwp\_is\_amp\_endpoint() ) {
$placeholder = ampforwp\_translation(ampforwp\_get\_setting('ampforwp-search-placeholder'), 'Type Here' );
if (function\_exists('pll\_\_')) {
$placeholder = pll\_\_(esc\_html( ampforwp\_get\_setting('ampforwp-search-placeholder')));
}
$widgetlabel = ampforwp\_translation(ampforwp\_get\_setting('ampforwp-search-widget-label'), 'Search for:' );
$form = '<form role="search" method="get" id="searchform" class="search-form" action="' . esc\_url( home\_url( '/' ) ) . '" target="\_top"
' . esc\_html( $widgetlabel) . '

';
}
return $form;
}
}
//Saving all taxonomies in Transient
add\_action('init','ampforwp\_generate\_taxonomies\_transient');
function ampforwp\_generate\_taxonomies\_transient(){
$taxonomies = get\_transient('ampforwp\_get\_taxonomies');
$tax\_arr = array();
$args = array(
'public' => true,
'\_builtin' => false,
);
$output = 'objects'; // or objects
$operator = 'and'; // 'and' or 'or'
$alltaxonomies = get\_taxonomies( $args, $output, $operator );
if ($alltaxonomies) {
foreach ($alltaxonomies as $taxKey => $taxVal) {
$tax\_arr[$taxVal->name] = $taxVal->labels->singular\_name;
}
}
if ( false == $taxonomies ) {
set\_transient('ampforwp\_get\_taxonomies',$tax\_arr);
}else{
if(count($tax\_arr) > count($taxonomies)){
$result = array\_diff\_assoc($tax\_arr,$taxonomies);
}elseif( count($taxonomies) > count($tax\_arr)){
$result = array\_diff\_assoc($taxonomies,$tax\_arr);
}
if( !empty($result)){
delete\_transient('ampforwp\_get\_taxonomies');
}
}
return $taxonomies;
}
// Include Opengraph.php #3261
add\_action('pre\_amp\_render\_post', 'ampforwp\_include\_opengraph');
if ( ! function\_exists('ampforwp\_include\_opengraph') ) {
function ampforwp\_include\_opengraph(){
if ( true == ampforwp\_get\_setting('ampforwp-seo-og-meta-tags') && '' == ampforwp\_get\_setting('ampforwp-seo-selection') ) {
require\_once AMPFORWP\_PLUGIN\_DIR."includes/features/opengraph.php";
}
}
}
add\_action('wp\_ajax\_ampforwp\_import\_file\_from\_file','ampforwp\_import\_settings\_from\_file');
function ampforwp\_import\_settings\_from\_file(){
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
if ( wp\_verify\_nonce( $\_POST['security'], 'ampforwp\_import\_file' ) && current\_user\_can( 'manage\_options' ) ) {
if(isset($\_FILES["file"]["tmp\_name"])){
/\* phpcs:ignore WordPress.WP.AlternativeFunctions.file\_get\_contents\_file\_get\_contents, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
$content = file\_get\_contents($\_FILES["file"]["tmp\_name"]);
if ( ! empty ( $content ) ) {
$imported\_options = json\_decode( $content, true );
}
$plugin\_options = get\_option('redux\_builder\_amp');
if ( ! empty ( $imported\_options ) && is\_array( $imported\_options ) && isset ( $imported\_options['redux-backup'] ) && $imported\_options['redux-backup'] == '1' ) {
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo $content;
}
}
}
}
add\_filter('ampforwp\_loop\_image\_update','ampforwp\_recentpost\_link\_to\_nonamp');
function ampforwp\_recentpost\_link\_to\_nonamp($image\_link\_data){
if( true == ampforwp\_get\_setting('ampforwp-recentpost-posts-link') ){
$image\_link\_data['image\_link'] = get\_permalink();
}else{
$image\_link\_data['image\_link'] = ampforwp\_url\_controller( get\_permalink() ) ;
}
return $image\_link\_data;
}
#3596 link to nonamp option on title for recent posts
add\_filter('ampforwp\_loop\_permalink\_update','ampforwp\_recentpost\_title\_link\_to\_nonamp');
function ampforwp\_recentpost\_title\_link\_to\_nonamp($title\_link){
if( true == ampforwp\_get\_setting('ampforwp-recentpost-posts-link') ){
$title\_link = get\_permalink();
}else{
$title\_link = ampforwp\_url\_controller( get\_permalink() ) ;
}
return $title\_link;
}
// Post Meta Revisions #3548 -- start here --
add\_filter( '\_wp\_post\_revision\_field\_amp\_page\_builder', 'ampforwp\_meta\_revi\_pb\_field', 22, 2 );
add\_action( 'save\_post', 'ampforwp\_meta\_revi\_save\_post', 10, 2 );
add\_action( 'wp\_restore\_post\_revision', 'ampforwp\_meta\_restore\_revision', 10, 2 );
add\_filter( '\_wp\_post\_revision\_fields', 'ampforwp\_meta\_revi\_fields' );
// Displaying the meta field on the revisions screen
function ampforwp\_meta\_revi\_fields( $fields ) {
$fields['post\_title'] = 'Title';
$fields['post\_content'] = 'Content';
$fields['post\_excerpt'] = 'Excerpt';
$fields['amp-page-builder'] = 'AMP Page Builder';
return $fields;
}
// Displaying the meta field on the revisions screen
function ampforwp\_meta\_revi\_pb\_field( $value, $field ) {
global $revision;
return get\_metadata( 'post', $revision->ID, $field, true );
}
// Reverting to the correct revision of the meta field when a post is reverted
function ampforwp\_meta\_restore\_revision( $post\_id, $revision\_id ) {
if ( ! current\_user\_can('edit\_posts') && ! current\_user\_can('edit\_pages') ) {
return;
}
$post = get\_post( $post\_id );
$revision = get\_post( $revision\_id );
$meta = get\_metadata( 'post', $revision->ID, 'amp-page-builder', true );
if ( false === $meta ) {
delete\_post\_meta( $post\_id, 'amp-page-builder' );
}
else{
update\_post\_meta( $post\_id, 'amp-page-builder', $meta );
}
}
// Storing a revision of the meta field when a post is saved
function ampforwp\_meta\_revi\_save\_post( $post\_id, $post ) {
if ( ! current\_user\_can('edit\_posts') && ! current\_user\_can('edit\_pages') ) {
return;
}
if ( $parent\_id = wp\_is\_post\_revision( $post\_id ) ) {
$parent = get\_post( $parent\_id );
$pb\_meta = get\_post\_meta( $parent->ID, 'amp-page-builder', true );
if ( false !== $pb\_meta ){
add\_metadata( 'post', $post\_id, 'amp-page-builder', $pb\_meta );
}
}
}
// Post Meta Revisions #3548 -- end here --
// FOR ADMIN MENU BAR
add\_action( 'pre\_amp\_render\_post', 'ampforwp\_front\_admin\_menu\_bar' );
function ampforwp\_front\_admin\_menu\_bar(){
if( is\_user\_logged\_in() ){
$pref = get\_user\_option( "show\_admin\_bar\_front", get\_current\_user\_id() );
if($pref==="true"){
if(class\_exists('QM\_Plugin') && class\_exists('QM\_Dispatchers') && ampforwp\_get\_setting('ampforwp-query-monitor')){
$dis = QM\_Dispatchers::get( 'html' );
if(is\_object($dis) && $dis->did\_footer==false){
$dis->did\_footer = true;
add\_action( 'amp\_post\_template\_head', 'ampforwp\_query\_monitor\_script' );
add\_action( 'amp\_post\_template\_head', 'ampforwp\_manual\_qm\_script', 11 );
}
}
add\_action("ampforwp\_admin\_menu\_bar\_front", function(){
add\_action('wp\_before\_admin\_bar\_render','ampforwp\_add\_admin\_menu\_front');
wp\_admin\_bar\_render();
});
add\_action( 'admin\_bar\_init', 'ampforwp\_init\_admin\_bar');
add\_action( 'wp\_before\_admin\_bar\_render','ampforwp\_remove\_before\_admin\_bar\_redner',9);
add\_action( 'admin\_bar\_menu', 'ampforwp\_remove\_admin\_menu\_front',999);
add\_action('amp\_post\_template\_css', 'ampforwp\_head\_css');
}
}
}
function ampforwp\_remove\_before\_admin\_bar\_redner(){
remove\_action( 'wp\_before\_admin\_bar\_render', 'wp\_customize\_support\_script' );
}
function ampforwp\_init\_admin\_bar(){
remove\_action( 'wp\_head', '\_admin\_bar\_bump\_cb' );
remove\_action( 'wp\_head', 'wp\_admin\_bar\_header' );
}
global $wp\_filesystem;
function ampforwp\_head\_css(){
global $ampforwpTemplate, $redux\_builder\_amp, $wp\_filesystem;
$css = "";
if( is\_user\_logged\_in() ){
$pref = get\_user\_option( "show\_admin\_bar\_front", get\_current\_user\_id() );
if($pref==="true"){
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php';
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php';
$wp\_filesystem = new WP\_Filesystem\_Direct( array() );
if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking')==1){
if(ampforwp\_is\_home()){
$tscss = "home";
}elseif(ampforwp\_is\_blog()){
$tscss = "blog";
}elseif(ampforwp\_is\_front\_page()){
$tscss = "post-".ampforwp\_get\_frontpage\_id();
}elseif(is\_singular()){
$tscss = "post-".ampforwp\_get\_the\_ID();
}elseif(is\_archive()){
$page\_id = get\_queried\_object\_id();
$tscss = "archive-".intval($page\_id);
}
$tscss = $tscss.'-admin';
$upload\_dir = wp\_upload\_dir();
$ts\_file = esc\_attr($upload\_dir['basedir']) . '/' . 'ampforwp-tree-shaking/\_transient\_'.esc\_attr($tscss).".css";
if(file\_exists($ts\_file)){
$css = $wp\_filesystem->get\_contents($ts\_file);
if(preg\_match("/#wpadminbar/", $css)==0){
$user\_dirname = $upload\_dir['basedir'] . '/' . 'ampforwp-tree-shaking';
if(file\_exists($user\_dirname)){
$files = glob($user\_dirname . '/\*');
foreach($files as $file){
if(is\_file($file) && strpos($file, '\_transient')!==false ){
wp\_delete\_file( $file );
}
}
}
}
}
}
$css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/templates/template-mode/admin-bar.css");
$incurl = includes\_url();
$incurl = trailingslashit($incurl) .'fonts/dashicons.ttf?50db0456fde2a241f005968eede3f987';
$css.='@font-face{font-family:dashicons;src:url('.$incurl.'/fonts/dashicons.ttf?50db0456fde2a241f005968eede3f987) format("truetype");
font-weight:400;font-style:normal}
#wp-admin-bar-my-account .avatar{float:right;margin-top:7px;margin-left:5px;height:18px;width:18px;border:1px solid #82878c}#wp-admin-bar-wpseo-notifications .yoast-issue-counter{float:right}@media(max-width:782px){#wpadminbar~header #headerwrap{top:46px}}';
if(ampforwp\_get\_setting('amp-design-selector')!=3){
$css.='#wpadminbar~header{margin-top:32px}@media(max-width:782px){#wpadminbar~header{margin-top:46px}}';
}else{
$css.='#wpadminbar~header #headerwrap{top:32px}@media(max-width:782px){#wpadminbar~header #headerwrap{margin-top:46px}}';
}
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo ampforwp\_css\_sanitizer($css);
}
}
}
function ampforwp\_css\_sanitizer($css){
$css = preg\_replace( '/\s\*!important/', '', $css, -1, $important\_count );
$css = preg\_replace( '/overflow(-[xy])?\s\*:\s\*(auto|scroll)\s\*;?\s\*/', '', $css, -1, $overlow\_count );
$css = preg\_replace('!/\\*[^\*]\*\\*+([^/][^\*]\*\\*+)\*/!', '', $css);
$css = str\_replace(array (chr(10), ' {', '{ ', ' }', '} ', '( ', ' )', ' :', ': ', ' ;', '; ', ' ,', ', ', ';}', '::-' ), array('', '{', '{', '}', '}', '(', ')', ':', ':', ';', ';', ',', ', ', '}', ' ::-'), $css);
return $css;
}
function ampforwp\_get\_remote\_content($src){
if($src){
$arg = array( "sslverify" => false, "timeout" => 60 ) ;
$response = wp\_remote\_get( $src, $arg );
if ( wp\_remote\_retrieve\_response\_code($response) == 200 && is\_array( $response ) ) {
$header = wp\_remote\_retrieve\_headers($response); // array of http header lines
$contentData = wp\_remote\_retrieve\_body($response); // use the content
return $contentData;
}
}else{
/\* phpcs:ignore WordPress.WP.AlternativeFunctions.file\_get\_contents\_file\_get\_contents \*/
return $contentData = file\_get\_contents( $src );
}
return '';
}
function ampforwp\_add\_admin\_menu\_front(){
global $wp\_admin\_bar;
$dom = new DOMDocument();
$my\_account = $wp\_admin\_bar->get\_node('my-account');
$title = '';
if(is\_object($my\_account)){
$title = ampforwp\_content\_sanitizer($my\_account->title);
}
$wp\_admin\_bar->add\_menu( array(
'id' => 'my-account',
'title' => $title
) );
$user\_info = $wp\_admin\_bar->get\_node('user-info');
if(is\_object($user\_info)){
$title = $user\_info->title;
}
if($title){
// To Suppress Warnings
libxml\_use\_internal\_errors(true);
$dom->loadHTML($title);
libxml\_use\_internal\_errors(false);
$anchors = $dom -> getElementsByTagName('img');
$src="";
foreach($anchors as $im){
$src = $im->getAttribute('src');
}
$authname = get\_the\_author\_meta('nickname');
$title = ''.esc\_html($authname).'';
$wp\_admin\_bar->add\_menu( array(
'id' => 'user-info',
'title' => $title
) );
if(class\_exists('WPSEO\_Options')){
$wp\_admin\_bar->add\_menu( array(
'id' => 'wpseo-menu',
'title' => "SEO"
) );
}
$wp\_admin\_bar->remove\_menu( 'ampforwp-view-amp' );
if(function\_exists('autoptimize\_autoload')){
$wp\_admin\_bar->remove\_menu( 'autoptimize' );
}
if (is\_preview()) {
$url = get\_preview\_post\_link();
$wp\_admin\_bar->add\_node(array(
'id' => 'ampforwp-view-non-amp',
'title' => 'View Non-AMP',
'href' => esc\_url($url)
));
}
else{
$url = ampforwp\_get\_non\_amp\_url();
$wp\_admin\_bar->add\_node(array(
'id' => 'ampforwp-view-non-amp',
'title' => 'View Non-AMP' ,
'href' => esc\_url($url)
));
}
}
}
function ampforwp\_remove\_admin\_menu\_front($wp){
$node\_arr = ['search','admin-bar-likes-widget'];
for($i=0;$iremove\_node($node\_arr[$i]);
}
}
function ampforwp\_manual\_qm\_script() {
wp\_print\_scripts( array(
'query-monitor',
) );
wp\_print\_styles( array(
'query-monitor',
) );
}
function ampforwp\_query\_monitor\_script() {
global $wp\_locale;
$qm = plugins\_url();
$deps = array(
'jquery',
);
if ( defined( 'QM\_NO\_JQUERY' ) && QM\_NO\_JQUERY ) {
$deps = array();
}
$css = 'query-monitor';
if ( method\_exists( 'Dark\_Mode', 'is\_using\_dark\_mode' ) && is\_user\_logged\_in() ) {
if ( Dark\_Mode::is\_using\_dark\_mode() ) {
$css .= '-dark';
}
} elseif ( defined( 'QM\_DARK\_MODE' ) && QM\_DARK\_MODE ) {
$css .= '-dark';
}
wp\_enqueue\_style(
'query-monitor',
esc\_attr($qm)."/query-monitor/assets/{$css}.css",
array( 'dashicons' ),
AMPFORWP\_VERSION
);
wp\_enqueue\_script(
'query-monitor',
esc\_attr($qm).'/query-monitor/assets/query-monitor.js',
$deps,
AMPFORWP\_VERSION,
false
);
wp\_localize\_script(
'query-monitor',
'qm\_number\_format',
$wp\_locale->number\_format
);
wp\_localize\_script(
'query-monitor',
'qm\_l10n',
array(
'ajax\_error' => esc\_html\_\_( 'PHP Errors in Ajax Response', 'accelerated-mobile-pages' ),
'ajaxurl' => admin\_url( 'admin-ajax.php' ),
'auth\_nonce' => array(
'on' => wp\_create\_nonce( 'qm-auth-on' ),
'off' => wp\_create\_nonce( 'qm-auth-off' ),
'editor-set' => wp\_create\_nonce( 'qm-editor-set' ),
),
)
);
}
function ampforwp\_get\_non\_amp\_url(){
global $post, $wp;
$nofollow = $page = $amp\_url = $non\_amp\_url = '';
if( true == ampforwp\_get\_setting('ampforwp-nofollow-view-nonamp') ){
$nofollow = 'rel=nofollow';
}
$amp\_url = untrailingslashit( home\_url( $wp->request ) );
$amp\_url = explode('/', $amp\_url);
$amp\_url = array\_flip($amp\_url);
unset($amp\_url[AMPFORWP\_AMP\_QUERY\_VAR]);
$non\_amp\_url = array\_flip($amp\_url);
$non\_amp\_url = implode('/', $non\_amp\_url);
$query\_arg\_array = $wp->query\_vars;
if( array\_key\_exists( "page" , $query\_arg\_array ) ) {
$page = $wp->query\_vars['page'];
}
if ( $page >= '2') {
$non\_amp\_url = trailingslashit( $non\_amp\_url . '?page=' . $page);
}
if ( ampforwp\_get\_setting('amp-mobile-redirection') == true && ampforwp\_get\_setting('amp-mob-redirection-pres-link') == false) {
$non\_amp\_url = add\_query\_arg('nonamp','1',$non\_amp\_url);
}
else
$non\_amp\_url = user\_trailingslashit($non\_amp\_url);
$mob\_pres\_link = false;
if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){
$mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link();
}
if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) {
$non\_amp\_url = '';
}
if ( $non\_amp\_url ) {
return apply\_filters('ampforwp\_view\_nonamp\_url', $non\_amp\_url);
}
}
add\_action( 'wp\_ajax\_ampforwp\_set\_option\_panel\_view', 'ampforwp\_set\_option\_panel\_view' );
function ampforwp\_set\_option\_panel\_view(){
if(!is\_admin() && !current\_user\_can('manage\_options')){
return ;
}
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
if(!wp\_verify\_nonce($\_POST['verify\_nonce'],'ampforwp-verify-request') ){
echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ;
die;
}
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated \*/
$opt\_type = intval($\_POST['option\_type']);
if($opt\_type==1 || $opt\_type==2){
$opt = get\_option("ampforwp\_option\_panel\_view\_type");
if($opt){
update\_option("ampforwp\_option\_panel\_view\_type", $opt\_type, false);
}else{
add\_option("ampforwp\_option\_panel\_view\_type", $opt\_type);
}
}
}
add\_action('admin\_head', 'ampforwp\_remove\_admin\_help');
if(!function\_exists('ampforwp\_remove\_admin\_help')){
function ampforwp\_remove\_admin\_help(){
if(!is\_admin() && !current\_user\_can('manage\_options')){
return ;
}
$screen = get\_current\_screen();
if ( 'toplevel\_page\_amp\_options' == $screen->base ) {
$screen->remove\_help\_tabs();
}
}
}
if(!function\_exists('ampforwp\_sassy\_icon\_style')){
function ampforwp\_sassy\_icon\_style(){
global $wp\_filesystem;
$css = get\_transient('ampforwp\_sassy\_css');
if($css == false){
if(!is\_object($wp\_filesystem)){
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php';
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php';
$wp\_filesystem = new WP\_Filesystem\_Direct( array() );
}
$css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/includes/sassy-style.css");
set\_transient('ampforwp\_sassy\_css', $css);
}
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo ampforwp\_css\_sanitizer($css);
}
}
if(function\_exists('heateor\_sss\_run')){
add\_action('amp\_post\_template\_css', 'ampforwp\_sassy\_icon\_style');
}
function ampforwp\_nofollow\_cta\_header\_link(){
if(true == ampforwp\_get\_setting('ampforwp-header-cta-link-nofollow')){
echo 'rel=nofollow';
return;
}
return false;
}
// Generating canonical url when FlexMLS plugin is active.
if(class\_exists('flexmlsConnectPageSearchResults')){
add\_action('pre\_amp\_render\_post','ampforwp\_flexmls\_canonical');
}
function ampforwp\_flexmls\_canonical(){
add\_filter('wpseo\_canonical','ampforwp\_flexmls\_generate\_canonical\_url',99,2);
}
function ampforwp\_flexmls\_generate\_canonical\_url($canonical,$object){
$canonical = $object->model->permalink;
return esc\_url($canonical);
}
// Font Selector
if( ! function\_exists('ampforwp\_font\_selector') ) {
function ampforwp\_font\_selector( $container ) {
global $redux\_builder\_amp;
$fontFamily = '';
if(1==ampforwp\_get\_setting('ampforwp-google-font-switch')){
return sanitize\_text\_field($fontFamily);
}
if(empty($container)) {
$container = 'body';
}
if ( 'content' == $container && ampforwp\_get\_setting('amp\_font\_selector\_content\_single') && 1 != ampforwp\_get\_setting('amp\_font\_selector\_content\_single') ) {
$fontFamily = "font-family: '".ampforwp\_get\_setting('amp\_font\_selector\_content\_single')."';";
}
if ( 'body' == $container && ampforwp\_get\_setting('amp\_font\_selector') && 1 != ampforwp\_get\_setting('amp\_font\_selector') ) {
$fontFamily = "font-family: '".ampforwp\_get\_setting('amp\_font\_selector')."'";
}
return sanitize\_text\_field($fontFamily);
}
}
if(class\_exists('WPSEO\_Options')){
add\_filter('ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_duplicate\_canonical',25);
}
function ampforwp\_remove\_duplicate\_canonical($content){
if( class\_exists( 'DOMDocument' ) && ! empty( $content ) && is\_string( $content ) ){
$comp\_dom = new DOMDocument();
@$comp\_dom->loadHTML($content);
$xpath = new DOMXPath( $comp\_dom );
$count = 0;
$nodes = $xpath->query('//link[@rel="canonical"]');
$con = '';
foreach ($nodes as $node) {
$count++;
}
if($count>1){
if(preg\_match("/]\*?\brel=[\'\"]canonical[\'\"][^>]\*>/", $content, $matches, PREG\_OFFSET\_CAPTURE)){
$content = preg\_replace("/]\*?\brel=[\'\"]canonical[\'\"][^>]\*>/", "", $content);
$content = substr\_replace($content, $matches[0][0], $matches[0][1], 0);
}
}
}
return $content;
}
// Font URL controller
if ( ! function\_exists('ampforwp\_font\_url') ) {
function ampforwp\_font\_url($font\_url){
return apply\_filters('ampforwp\_font\_url', $font\_url);
}
}
//Need to add full short pixel plugin compatibility #3782
if(class\_exists('ShortPixelAPI')){
add\_filter( 'ampforwp\_the\_content\_last\_filter','ampforwp\_short\_pixel\_cdn');
}
function ampforwp\_short\_pixel\_cdn($content){
$api\_url = get\_option('spai\_settings\_api\_url');
$compress\_level = get\_option('spai\_settings\_compress\_level');
if('0'== $compress\_level){
$compress\_level = '+q\_lossless';
}
if('1'== $compress\_level){
$compress\_level = '+q\_lossy';
}
if('2'== $compress\_level){
$compress\_level = '+q\_glossy';
}
$compress\_level .= '+ret\_img+to\_webp/';
if(!empty($api\_url)){
$content = preg\_replace('/]\*)>/','',$content);
}
return $content;
}
if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking') == true && ampforwp\_is\_gutenberg\_active()){
add\_action('amp\_post\_template\_css','ampforwp\_gutenberg\_block\_styles');
}
if(!function\_exists('ampforwp\_gutenberg\_block\_styles')){
function ampforwp\_gutenberg\_block\_styles(){
$gutenberg\_styles = $block\_css = '';
ob\_start();
wp\_print\_styles('wp-block-library');
$block\_css .= ob\_get\_contents();
ob\_end\_clean();
preg\_match("/href='(.\*?)'/", $block\_css, $matches);
$style\_path = explode('?', $matches[1]);
$gutenberg\_styles = get\_transient('ampforwp\_gutenberg\_styles');
if($gutenberg\_styles == false){
$response = wp\_remote\_get( $style\_path[0] );
if( is\_array( $response ) && ! is\_wp\_error( $response ) ){
set\_transient('ampforwp\_gutenberg\_styles', $response['body'], 24 \* HOUR\_IN\_SECONDS );
}
}
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo ampforwp\_css\_sanitizer($gutenberg\_styles);
}
}
function ampforwp\_is\_gutenberg\_active() {
$gutenberg = false;
$block\_editor = false;
$use\_block\_editor = '';
if ( has\_filter( 'replace\_editor', 'gutenberg\_init' ) ) {
$gutenberg = true;
}
if ( version\_compare( $GLOBALS['wp\_version'], '5.0-beta', '>' ) ) {
$block\_editor = true;
}
if ( ! $gutenberg && ! $block\_editor ) {
return false;
}
if ( !class\_exists('Classic\_Editor') ) {
return true;
}
$use\_block\_editor = ( get\_option( 'classic-editor-replace' ) === 'no-replace' );
return $use\_block\_editor;
}
add\_filter( 'amp\_post\_template\_data', 'ampforwp\_pblayout\_head\_scripts');
$pb\_remove\_script = array();
function ampforwp\_pblayout\_head\_scripts($data){
$postId = ampforwp\_get\_the\_ID();
$ampforwp\_pagebuilder\_enable = get\_post\_meta($postId,'ampforwp\_page\_builder\_enable', true);
if(isset($ampforwp\_pagebuilder\_enable) && $ampforwp\_pagebuilder\_enable=="yes"){
$previousData = get\_post\_meta($postId,'amp-page-builder');
$previousData = isset($previousData[0])? $previousData[0]: null;
$previousData = (str\_replace("'", "'", $previousData));
$totalRows = 1;
$totalmodules = 1;
if(!empty($previousData)){
$jsonData = json\_decode($previousData,true);
if(isset($jsonData['rows']) && count($jsonData['rows'])>0){
$totalRows = $jsonData['totalrows'];
$totalmodules = $jsonData['totalmodules'];
$previousData = wp\_json\_encode($jsonData);
}else{
$jsonData['rows'] = array();
$jsonData['totalrows']=1;
$jsonData['totalmodules'] = 1;
$previousData = wp\_json\_encode($jsonData);
}
}
$jarr = json\_decode($previousData);
if(isset($jarr->settingdata->scripts\_data)){
$script\_data = $jarr->settingdata->scripts\_data;
$content = $data['post\_amp\_content'];
$script\_slug = '';
$allscripts = $script\_data;
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
preg\_match\_all('/<\/script>/', $allscripts, $matches);
if($matches){
if(isset($matches[2])){
$script\_slug = $matches[2];
foreach ($script\_slug as $key => $slug) {
if(!preg\_match('/'.$slug.'/', $content)){
global $pb\_remove\_script;
$pb\_remove\_script[]= esc\_attr($slug);
}
}
}
add\_filter( 'ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_unused\_pb\_amp\_script',12);
}
}
}
return $data;
}
function ampforwp\_remove\_unused\_pb\_amp\_script($data){
global $pb\_remove\_script;
for($i=0;$i<\/script>/', '', $data);
}
return $data;
}
if(class\_exists('RankMath')){
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_rank\_math\_nofollow\_to\_external\_link');
}
function ampforwp\_rank\_math\_nofollow\_to\_external\_link($content){
$rank\_math\_external\_link = RankMath\Helper::get\_settings( 'general.nofollow\_external\_links' );
if($rank\_math\_external\_link){
preg\_match\_all('/[(.\*?)<\/a>/', $content, $matches);
for($i=0;$i
.tg:checked + .hamb-mnu > .m-ctr {
margin-right: 0%;
}
.m-ctr{
margin-right: -100%;
float: left;
}
php } if(ampforwp\_get\_setting('header-position-type') == '2'){?
.tg:checked + .hamb-mnu > .m-ctr {
margin-right: calc(100% - php echo esc\_html(ampforwp\_get\_setting('header-overlay-width'))?);
}
.m-ctr{
margin-right: 100%;
float: right;
}
php }
}
}
}
}
add\_filter('ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_unwanted\_code',10);
function ampforwp\_remove\_unwanted\_code($content){
// Mediavine validation issue with form and amp-consent #4206
if(preg\_match('/<amp-consent id="mv-consent" layout="nodisplay"(.\*?)<\/amp-consent>/s', $content)){
$content = preg\_replace('/(.\*?)<\/amp-consent>/s', '', $content);
}
if(preg\_match('/(.\*?)<\/form>/s', $content)){
$content = preg\_replace('/(.\*?)<\/form>/s', '', $content);
}
// close #4206
// Ticket #4539
if(function\_exists('orbital\_setup')){
if(preg\_match('/';
$content = str\_replace('', $script\_tag, $content);
}
}
}
}
}
if (empty($content)) {
return '';
}
$comp\_dom = new DOMDocument();
@$comp\_dom->loadHTML($content);
$xpath = new DOMXPath( $comp\_dom );
$elements = $xpath->query("\*/script[@custom-element]");
$component\_arr = array();
$elements\_arr = array();
if (!is\_null($elements)) {
foreach ($elements as $element) {
$component\_arr[]= $element->getAttribute('custom-element');
$elements\_arr[] = $comp\_dom->saveHTML($element);
}
}
if (!is\_null($elements)) {
if(!empty($component\_arr)){
$excl\_arr = array('amp-bind','amp-access','amp-analytics','amp-access-laterpay','amp-access-poool','amp-dynamic-css-classes','amp-fx-collection','amp-inputmask','amp-lightbox-gallery','amp-inputmask','amp-mustache','amp-subscriptions-google','amp-subscriptions','amp-video-docking','amp-story');
$inc\_elem\_arr = array();
for($r=0;$r/", $content) && !$is\_script){
$remove\_comp = $elements\_arr[$i];
$content = str\_replace($remove\_comp, '', $content);
}else if(in\_array($component, $inc\_elem\_arr )){
for($rc=0;$rc(.\*?)<\/script>/s', $content,$rmc)){
if(isset($rmc[0])){
$remove\_comp = $rmc[0];
$content = str\_replace($remove\_comp, '', $content);
}
}
}
}
}
// REMOVING DUPLICATE SCRIPT.
$count\_elem = array\_count\_values($component\_arr)[$component];
if($count\_elem>1){
$content = preg\_replace('/(.\*?)<\/script>/s','',$content,1,$component\_arr[$i]);
}
}
}
}
}
//OTHER COMPONENT CHECK
$other\_comp\_arr = array('amp-mustache'=>'amp-mustache','amp-embed'=>'amp-ad','form'=>'amp-form','amp-access'=>'amp-access','amp-fx'=>'amp-fx-collection');
if (preg\_match('//', $content)) {
$other\_comp\_arr['amp-carousel'] = 'amp-lightbox-gallery';
}
foreach ($other\_comp\_arr as $key => $value) {
$ocomp = $value;
$celem = 'element';
if($ocomp=='amp-mustache'){
$celem = 'template';
}
if(preg\_match('/(type|template|id)="('.$ocomp.')"/', $content) || preg\_match("/<\/$key>/", $content) || preg\_match("/amp-fx/", $content)){
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}
}
$amp\_video = $xpath->query("//amp-video");
foreach($amp\_video as $node) {
if($node->hasAttribute('dock')){
if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){
$celem = 'element';
$ocomp = 'amp-video-docking';
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}else{
if(preg\_match('//','', $content);
}
}
}
}
$amp\_video\_iframe = $xpath->query("//amp-video-iframe");
foreach($amp\_video\_iframe as $node) {
if($node->hasAttribute('dock')){
if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){
$celem = 'element';
$ocomp = 'amp-video-docking';
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}else{
if(preg\_match('//','', $content);
}
}
}
}
$amp\_youtube = $xpath->query("//amp-youtube");
foreach($amp\_youtube as $node) {
if($node->hasAttribute('dock')){
if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){
$celem = 'element';
$ocomp = 'amp-video-docking';
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}else{
if(preg\_match('//','', $content);
}
}
}
}
$amp\_brid\_player = $xpath->query("//amp-brid-player");
foreach($amp\_brid\_player as $node) {
if($node->hasAttribute('dock')){
if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){
$celem = 'element';
$ocomp = 'amp-video-docking';
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}else{
if(preg\_match('//','', $content);
}
}
}
}
$amp\_brightcove = $xpath->query("//amp-brightcove");
foreach($amp\_brightcove as $node) {
if($node->hasAttribute('dock')){
if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){
$celem = 'element';
$ocomp = 'amp-video-docking';
if(!preg\_match('/(.\*?)<\/script>/s', $content)){
$o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js';
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
$script\_tag = '';
$content = str\_replace('', $script\_tag, $content);
}
}else{
if(preg\_match('//','', $content);
}
}
}
}
$allscripts = apply\_filters( 'ampforwp\_modify\_scripts', $allscripts);
// Scripts added from Options panel should have higher priority #4064
if( $allscripts || (ampforwp\_get\_setting('amp-header-text-area-for-html') && ampforwp\_get\_setting('amp-header-text-area-for-html')!="")) {
$allscripts .= ampforwp\_get\_setting('amp-header-text-area-for-html');
/\* phpcs:ignore WordPress.WP.EnqueuedResources.NonEnqueuedScript \*/
preg\_match\_all('/(.\*?)<\/script>/s', $allscripts, $rep);
if($rep){
if(isset($rep[2]) && isset($rep[4])){
$script\_slug = $rep[2];
$script\_url = $rep[4];
for($s=0;$s(.\*?)<\/script>/', $content, $conmatch)){
if(isset($conmatch[3]) && $conmatch[3]!=""){
$rep\_url = $conmatch[3];
if(preg\_match('/https/', $rep\_url)){
$content = str\_replace($rep\_url, $surl, $content);
}
}
}
}
}
}
}
}
return $content;
}
if(!function\_exists('ampforwp\_get\_retina\_image\_settings')){
function ampforwp\_get\_retina\_image\_settings($width,$height){
$data['width'] = intval($width);
$data['height'] = intval($height);
if ( 1 == ampforwp\_get\_setting('ampforwp-retina-images') ) {
$resolution = 2;
if (ampforwp\_get\_setting('ampforwp-retina-images-res')) {
$resolution = ampforwp\_get\_setting('ampforwp-retina-images-res');
}
$width = $width \* $resolution;
$height = $height \* $resolution;
$data['width'] = intval($width);
$data['height'] = intval($height);
}
return $data;
}
}
if(!function\_exists('ampforwp\_add\_fallback\_element')){
function ampforwp\_add\_fallback\_element($content='',$tag=''){
preg\_match\_all('/<'.$tag.' (.\*?)<\/'.$tag.'>/', $content, $matches);
if(!empty($matches) && false == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')){
if(isset($matches[0])){
$con = "";
for($i=0;$i";
}else{
$fallback\_img = "";//$m\_content, $m1\_content escaped above.
}
$content = str\_replace("$match", $fallback\_img, $content);
}
}
}
}
return $content;
}
}
// added fix for youtube video not displaying on AMP using Elementor #5322
add\_filter('ampforwp\_modify\_the\_content','amp\_youtube\_the\_content');
function amp\_youtube\_the\_content($content){
/\* Check if youtube embed plugin is active
This is the solution for facade mode issue
if facade mode is enabled in embed youtube plugin then video was not working so this is the
solution for that issue
\*/
if(is\_plugin\_active('youtube-embed-plus/youtube.php')){
$youtube\_all\_opts = get\_option('youtubeprefs\_alloptions');
if(!empty($youtube\_all\_opts) && isset($youtube\_all\_opts['facade\_mode'])){
if($youtube\_all\_opts['facade\_mode'] == 1){
preg\_match\_all('#(.\*?)<\/figure>#is', $content, $video\_matches);
if(!empty($video\_matches) && is\_array($video\_matches)){
foreach ($video\_matches as $vmkey => $vmvalue) {
if(is\_array($vmvalue)){
foreach ($vmvalue as $vmkey1 => $vmvalue1) {
if(!empty($vmvalue1)){
$dochtml = new DOMDocument();
$dochtml->loadHTML($vmvalue1);
$div\_tags = $dochtml->getElementsByTagName('div');
if(!empty($div\_tags)){
foreach($div\_tags as $div\_tag) {
$facade\_src = $div\_tag->getAttribute('data-facadesrc');
if(!empty($facade\_src)){
$get\_id = get\_video\_id\_from\_url($facade\_src);
$content\_html = '

';
$content = str\_replace($vmvalue1, $content\_html, $content);
} // facade\_src if end
} // div\_tags foreach end
} // div\_tags if end
} // vmvalue1 if end
} // vmvalue foreach end
} // vmvalue if end
} // video\_matches foreach end
} // video\_matches if end
} // facade\_mode if end
} // youtube\_all\_opts if end
} // is\_plugin\_active if end
// checking is Elementor is installed and activated
if ( did\_action( 'elementor/loaded' ) ) {
preg\_match\_all('//', $content, $matches);
foreach($matches[3] as $video){
$video\_attr = json\_decode($video);
$get\_url = $video\_attr->youtube\_url;
$get\_id = get\_video\_id\_from\_url($get\_url);
if(ampforwp\_get\_setting('ampforwp-amp-video-lightbox')==true)
{
$content\_html=preg\_replace('//','

', $content);
}
else
{
$content\_html = preg\_replace('//','', $content);
}
return $content\_html;
}
}
return $content;
}
function get\_video\_id\_from\_url( $url ) {
$short\_url\_host = 'youtu.be';
$video\_id = false;
$parsed\_url = parse\_url( $url );
if(!isset($parsed\_url['host'])){
$parsed\_url['host'] = '';
}
if ($short\_url\_host === substr( $parsed\_url['host'], -strlen($short\_url\_host ) ) ) {
// youtu.be/{id}
$parts = explode( '/', $parsed\_url['path'] );
if ( ! empty( $parts ) ) {
$video\_id = $parts[1];
}
} else {
// ?v={id} or ?list={id}
if(isset($parsed\_url['query'])){
parse\_str( $parsed\_url['query'], $query\_args );
}
if ( isset( $query\_args['v'] ) ) {
if ( false !== strpos( $query\_args['v'], '?' ) ) {
$video\_id = strtok( $query\_args['v'], '?' );
}
else{
$video\_id = $query\_args['v'];
}
}
}
if ( empty( $video\_id ) ) {
// /(v|e|embed)/{id}
$parts = explode( '/', $parsed\_url['path'] );
if ( in\_array( $parts[1], array( 'v', 'e', 'embed' ) ) ) {
$video\_id = $parts[2];
}
}
return $video\_id;
}
if(!function\_exists('ampforwp\_imagify\_webp\_compatibility')){
function ampforwp\_imagify\_webp\_compatibility($content){
if(function\_exists('\_imagify\_init')){
preg\_match\_all('/src="(.\*?)"/', $content,$src);
$imageify\_opt = get\_option( 'imagify\_settings' );
$convert\_to\_webp = false;
if(isset($imageify\_opt['convert\_to\_webp'])){
$convert\_to\_webp = $imageify\_opt['convert\_to\_webp'];
}
$display\_webp = false;
if(isset($imageify\_opt['display\_webp'])){
$display\_webp = $imageify\_opt['display\_webp'];
}
if($convert\_to\_webp && $display\_webp){
$img\_url = esc\_url($src[1][0]);
if(!preg\_match('/\.webp/', $img\_url)){
$rep\_url = esc\_url($src[1][0]).".webp";
if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){
$upload\_dir = wp\_upload\_dir()['basedir'];
$img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url);
if(file\_exists($img\_file)){
$content = str\_replace($img\_url, $rep\_url, $content);
}
}
}
}
}
$content = str\_replace('.webp.webp','.webp',$content);
return $content;
}
}
if(!function\_exists('ampforwp\_set\_default\_fallback\_image')){
function ampforwp\_set\_default\_fallback\_image($content){
if(!function\_exists('\_imagify\_init') && !function\_exists('ewww\_image\_optimizer\_webp\_initialize') && !has\_action('penci\_loop\_product\_image')){
preg\_match\_all('/src="(.\*?)"/', $content,$cc); // need to check extenstion for fallback.
if(isset($cc[1][0])){
$img = $cc[1][0];
$defaul\_fallback\_img = ampforwp\_get\_setting('ampforwp\_default\_fallback\_image');
if(isset($defaul\_fallback\_img['url']) && $defaul\_fallback\_img['url']!=''){
$defaul\_fallback\_img = esc\_url($defaul\_fallback\_img['url']);
$content = str\_replace($img, $defaul\_fallback\_img, $content); // need to change fallback extenstion.
}
}
}
return $content;
}
}
if(!function\_exists('ampforwp\_ewww\_webp\_compatibility')){
function ampforwp\_ewww\_webp\_compatibility($content){
if(defined( 'EWWW\_IO\_CLOUD\_PLUGIN' )){
preg\_match\_all('/src="(.\*?)"/', $content,$src);
if(isset($src[1][0])){
$img\_url = esc\_url($src[1][0]);
if(!preg\_match('/\.webp/', $img\_url)){
$rep\_url = esc\_url($src[1][0]).".webp";
if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){
$upload\_dir = wp\_upload\_dir()['basedir'];
$img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url);
if(file\_exists($img\_file)){
$content = str\_replace($img\_url, $rep\_url, $content);
}
}
}
}
}
$content = str\_replace('.webp.webp','.webp',$content);
return $content;
}
}
if(!function\_exists('ampforwp\_check\_image\_existance')){
function ampforwp\_check\_image\_existance($image){
if(preg\_match('/wp-content\/uploads/', $image)){
$img\_arr = explode('wp-content', $image);
if(!empty($img\_arr) && isset($img\_arr[1])){
$img = WP\_CONTENT\_DIR.$img\_arr[1];
if(!file\_exists($img)){
if(preg\_match('/\d+x\d+/', $image,$ma)){
$t\_sizes = explode('x', $ma[0]);
$width = $t\_sizes[0];
$height = $t\_sizes[1];
$image = preg\_replace('/-\d+x\d+/','', $image);
$resize = ampforwp\_aq\_resize( $image, $width , $height , true, false, true );
if(isset($resize[0])){
$image = $resize[0];
}
}
}
}
}
return $image;
}
}
if (function\_exists('themify\_builder\_activate')) {
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_themify\_compatibility');
}
function ampforwp\_themify\_compatibility($content){
$get\_data = get\_post\_meta(ampforwp\_get\_the\_ID(),'\_themify\_builder\_settings\_json',true);
if($get\_data){
$decode = json\_decode($get\_data,true);
$cols = '';
for($i=0;$i $value) {
foreach ($value['mod\_settings'] as $key => $val) {
$content.=$val;
}
}
}
}
}
}
}
return $content;
}
add\_action( 'wp\_ajax\_ampforwp\_referesh\_related\_post', 'ampforwp\_referesh\_related\_post' );
function ampforwp\_referesh\_related\_post(){
/\* phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
if(!wp\_verify\_nonce($\_POST['verify\_nonce'],'ampforwp\_refresh\_related\_poost') ){
echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ;
die;
}
$orderby = 'ID';
$args=array(
'fields' => 'ids',
'post\_type' => 'post',
'posts\_per\_page'=> 30,
'orderby' => $orderby,
'ignore\_sticky\_posts'=>1,
'has\_password' => false ,
'post\_status'=> 'publish',
'no\_found\_rows' => true,
/\* phpcs:ignore WordPress.DB.SlowDBQuery.slow\_db\_query\_meta\_query \*/
'meta\_query' => array(
array(
'key' => 'ampforwp-amp-on-off',
'compare' => 'NOT EXISTS',
)
)
);
$my\_query = new wp\_query( $args );
while( $my\_query->have\_posts() ) {
$my\_query->the\_post();
update\_post\_meta(get\_the\_ID(),'ampforwp-amp-on-off','default');
}
/\*$args=array(
'fields' => 'ids',
'post\_status' => 'publish',
'ignore\_sticky\_posts' => true,
'posts\_per\_page' => 50,
'no\_found\_rows' => true,
'meta\_query' => array(
array(
'key' => 'ampforwp-ia-on-off',
'compare' => 'NOT EXISTS',
)
)
);
$my\_query = new wp\_query( $args );
while( $my\_query->have\_posts() ) {
$my\_query->the\_post();
update\_post\_meta(get\_the\_ID(),'ampforwp-ia-on-off','default');
}\*/
$data['response'] = ampforwp\_get\_post\_percent();
echo wp\_json\_encode($data);
}
// HIDE/SHOW TAG AND CATEGORY #4326
function ampforwp\_save\_taxonomy\_meta($term\_id){
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing \*/
if(isset($\_POST['amp\_taxonomy'])){
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing,WordPress.Security.ValidatedSanitizedInput.MissingUnslash \*/
$cat\_status = sanitize\_text\_field($\_POST['amp\_taxonomy']);
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing,WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash \*/
$hide\_tax = sanitize\_text\_field($\_POST['hide\_tax']);
add\_term\_meta($term\_id, 'amp\_taxonomy', $cat\_status );
add\_term\_meta( $term\_id,'amp\_hide\_tax', $hide\_tax);
}
}
function ampforwp\_update\_taxonomy\_meta($term\_id, $term\_id1){
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing \*/
if(isset($\_POST['amp\_taxonomy'])){
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing,WordPress.Security.ValidatedSanitizedInput.MissingUnslash \*/
$cat\_status = sanitize\_text\_field($\_POST['amp\_taxonomy']);
/\* phpcs:ignore WordPress.Security.NonceVerification.Missing,WordPress.Security.ValidatedSanitizedInput.InputNotValidated,WordPress.Security.ValidatedSanitizedInput.MissingUnslash \*/
$hide\_tax = sanitize\_text\_field($\_POST['hide\_tax']);
update\_term\_meta( $term\_id,'amp\_taxonomy', $cat\_status);
update\_term\_meta( $term\_id,'amp\_hide\_tax', $hide\_tax);
}
}
/\* phpcs:ignore WordPress.Security.NonceVerification.Recommended \*/
if ( isset( $\_REQUEST['taxonomy'] )) {
/\* phpcs:ignore WordPress.Security.NonceVerification.Recommended,WordPress.Security.ValidatedSanitizedInput.MissingUnslash,WordPress.Security.ValidatedSanitizedInput.InputNotSanitized \*/
$taxonomy = $\_REQUEST['taxonomy'];
add\_action('edited\_'.esc\_attr($taxonomy), 'ampforwp\_update\_taxonomy\_meta',10,2);
add\_action('create\_'.esc\_attr($taxonomy), 'ampforwp\_save\_taxonomy\_meta', 10);
add\_action('edited\_'.esc\_attr($taxonomy), 'ampforwp\_update\_taxonomy\_meta',10,2);
add\_action('create\_'.esc\_attr($taxonomy), 'ampforwp\_save\_taxonomy\_meta', 10);
add\_action (esc\_attr($taxonomy).'\_edit\_form\_fields', 'ampforwp\_extra\_category\_fields');
add\_action (esc\_attr($taxonomy).'\_add\_form\_fields', 'ampforwp\_extra\_category\_fields');
}
function ampforwp\_extra\_category\_fields( $tag ) {
$label = 'Category';
if(is\_object($tag)){
if($tag->taxonomy=="post\_tag"){
$label = 'Tag';
}else if($tag->taxonomy!='category'){
$label = $tag->taxonomy;
}
}else{
if($tag=='post\_tag'){
$label = 'Tag';
}
}
?>|php if(!isset($tag-term\_id)){?>  | AMP Show Hide  You can enable or disable AMP on this category. [Learn More](https://ampforwp.com/tutorials/article/how-to-show-hide-the-amp-from-the-categories-or-product-pages-or-any-custom-taxonomy-in-amp/).   **php echo esc\_attr($label);?:** Hide from php echo esc\_attr($label);? Archive Page.  **php echo esc\_attr($label);? & Posts:**  Hide from php echo esc\_attr($label);? Archive Page and all it's posts |php }else{
$term\_data = ampforwp\_get\_taxonomy\_meta($tag-term\_id);
$visible = '';
$visible\_status = '';
if(isset($term\_data['visible']) && !empty($term\_data['visible'])){
$visible = $term\_data['visible'][0];
$visible\_status = $term\_data['visible\_status'][0];
}
?> AMP | >Show >Hide |php }?
php
}
//4710 Added support to load featured image for lazy load option of Dues theme.
if(function\_exists('wpg\_lazyload\_image\_attributes')){
add\_action('wp','ampforwp\_dues\_theme\_load\_featured\_image');
}
function ampforwp\_dues\_theme\_load\_featured\_image(){
if(ampforwp\_is\_amp\_endpoint()){
remove\_filter( 'wp\_get\_attachment\_image\_attributes', 'wpg\_lazyload\_image\_attributes', 8, 3 );
}
}
if(function\_exists('rocket\_activation')){
add\_filter("ampforwp\_the\_content\_last\_filter",'ampforwp\_wp\_rocket\_compatibility',25);
}
function ampforwp\_wp\_rocket\_compatibility($content){
$cdn\_url = get\_option('wp\_rocket\_settings');
if($cdn\_url['cdn'] == 1){
$img\_cdn\_url = '';
$cnds\_arr = array();
if(!empty($cdn\_url['cdn\_zone']) && !empty($cdn\_url['cdn\_cnames'])){
foreach ($cdn\_url['cdn\_zone'] as $key = $element) {
if(isset($cdn\_url['cdn\_cnames'][$key]) && $cdn\_url['cdn\_cnames'][$key]!=''){
$cnds\_arr[$element] = $cdn\_url['cdn\_cnames'][$key];
}
}
}
if(isset($cnds\_arr['images'])){
$img\_cdn\_url = $cnds\_arr['images'];
$img\_cdn\_url = apply\_filters( 'ampforwp\_modify\_wp\_rocket\_cdn\_url', $img\_cdn\_url );
}else if(isset($cnds\_arr['all'])){
$img\_cdn\_url = $cnds\_arr['all'];
}
if($img\_cdn\_url!=''){
$parse\_url = parse\_url($img\_cdn\_url);
if(!isset($parse\_url['scheme'])){
if(!preg\_match('/\/\//', $img\_cdn\_url)){
$img\_cdn\_url = '//'.$img\_cdn\_url;
}
}
$comp\_dom = new DOMDocument();
@$comp\_dom->loadHTML($content);
$xpath = new DOMXPath( $comp\_dom );
$nodes = $xpath->query('//amp-img[@src]');
$home\_url = home\_url();
foreach ($nodes as $node) {
$url = $node->getAttribute('src');
$srcset = $node->getAttribute('srcset');
$is\_external = ampforwp\_isexternal($url);
if(!$is\_external && !$node->hasAttribute('fallback')){
$img\_src = str\_replace($home\_url, $img\_cdn\_url, $url);
$content = str\_replace($url, $img\_src, $content);
$srcset\_arr = explode(",", $srcset);
for($i=0;$i

php
}
if(function\_exists('herald\_theme\_setup')){
add\_filter('the\_content', 'ampforwp\_herald\_popup\_media\_in\_content', 100, 1 );
add\_filter('bbp\_get\_topic\_content','herald\_popup\_media\_in\_content');
add\_filter('bbp\_get\_reply\_content','herald\_popup\_media\_in\_content');
}
function ampforwp\_herald\_popup\_media\_in\_content( $content ) {
if(ampforwp\_is\_amp\_endpoint()){
if (function\_exists('herald\_get\_option') && herald\_get\_option( 'on\_single\_img\_popup' ) ) {
if(preg\_match("/<a class=\"herald-popup-img\" href=('|\")(.\*?).(bmp|gif|jpeg|jpg|png)('|\")/i", $content,$matches)){
$content = preg\_replace( "/[/i", '![]() $url, 1 => $width, 2 => $height);
}
}
add\_filter('ampforwp\_post\_template\_data','ampforwp\_amp\_bind\_script');
function ampforwp\_amp\_bind\_script($data) {
if ( empty( $data['amp\_component\_scripts']['amp-bind'] ) ) {
$data['amp\_component\_scripts']['amp-bind'] = 'https://cdn.ampproject.org/v0/amp-bind-latest.js';
}
return $data;
}
add\_filter('ampforwp\_post\_template\_data','ampforwp\_amp\_story\_player\_script',12);
function ampforwp\_amp\_story\_player\_script($data) {
if ( isset($data['post'])) {
$post\_content = $data['post']->post\_content;
if ( (preg\_match('//s', $post\_content) || preg\_match('/web-stories/', $post\_content )) && empty( $data['amp\_component\_scripts']['amp-story-player'] ) ) {
$data['amp\_component\_scripts']['amp-story-player'] = 'https://cdn.ampproject.org/v0/amp-story-player-latest.js';
}
}
return $data;
}
if(!function\_exists('ampforwp\_video\_lightbox')){
function ampforwp\_video\_lightbox($content){
$video\_tags\_arr = array('amp-youtube');
add\_action('amp\_post\_template\_css','ampforwp\_video\_lightbox\_css',30);
for($i=0;$i/', $content, $matches);
if(!empty($matches)){
if(isset($matches[0])){
$con = "";
for($i=0;$igetElementsByTagName( 'amp-youtube' );
$video\_id ='';
$width = 800;
$height = 450;
foreach ($nodes as $key => $node) {
$video\_id = $node->getAttribute('data-videoid');
$width =$node->getAttribute('width');
$height =$node->getAttribute('height');
}
$amp\_light\_box = '
'.$match.'

';
$content = str\_replace("$match", $amp\_light\_box, $content);
}
}
}
}
return $content;
}
}
function ampforwp\_video\_lightbox\_css(){
echo '.amp-video-box,.amp-video-img{width:100%;margin:0 auto;text-align:center}
.amp-lightbox-video{background:rgba(0,0,0,.8);width:100%;height:100%;position:absolute;display:flex;align-items:center;justify-content:center}
.amp-video-box{max-width:800px}
.amp-video-img{max-width:600px;position:relative}
.amp-lightbox-video .lb-x { top: 100px; right: 5%; }
.amp-video-play-on-image{cursor:pointer;margin:auto;width:56px;height:56px;-webkit-border-radius:50%;border-radius:50%;background-color:rgba(0,0,0,.2);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAMAAADVRocKAAAAY1BMVEVHcEz///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////80LMUcAAAAIHRSTlMA1d4MSXeg9glf6yEq4hfnnr7Z8qm5U/3Jm1pwFJcmBYTgJ9QAAAIjSURBVGje7VnJdoMwDFSMHVMSQljCklX//5U99NQHGEm22gtz9tPAWNYKsGPHDiou1h3rpvDD4Iumvjp7SWg86yeDM5ipz5KYt53HFfjORn+8KzEI88iizLe4icLlUvtfFZJQ3kXmTzWScTsJPr9FBtovpvn8iExMrJu4jMjGyHh67xIFMOSLOFcoQnUmfr/QPmL1JulfohiGcA/5iBEYt33piFG4br4vjMTGizu1sQRt2FlrjMZNVSBExEBszaoUBOW6JzlMArf6A0XIOzyZoMgkPwDnA5nhsWz/E4wRnBxhVuoTDBMAkGVarma6TQKyTN3iFfttAqJMg1/y1B4JBFSZ+gWCiUZAk+m1QGCIBCSZmoVEhlQCkkxPppP+JiDIZNlxiFmYOXaqnEX2sEwTO9XMq6egTPXsfMMlCMt0mB0v2ARBmYrZYS8gCMjkZ2cHCcG6TMPfE6hLpH7J6m6a+KHN67urdqhQD3bq4Vo94ainTP2kn7RssbqFF7a5buk4dP9T/Ib9KEH5Dg/lBkS/hVJvAiEvU9gPtLFwT0HQh1r9m/IoQX8YEj+t2JwCX+PsT7ojtWH8EIaCJmIo+FQeaxJHs9LBbPkGIt4ilQxjxi8ajj+BgZztra8P8MBcUAi2LCdGXJKsWADgTozeppeuoXJXEPKXfM0FANnDaC7qtlaNbfyq8Uep/rXQYDUvm0M6XKyb6sPPuvdwm5x9wo4dO6j4BoilN6H4pmTiAAAAAElFTkSuQmCC);background-position:center;-webkit-background-size:48px 48px;background-size:48px 48px;position:absolute;top:0;bottom:0;left:0;right:0}';
}
if (class\_exists('WPSEO\_Options')) {
add\_filter('yoast\_seo\_development\_mode','ampforwp\_yoast\_seo\_development');
add\_filter('wpseo\_debug\_json\_data','ampforwp\_remove\_homepage\_breadcrumb');
}
function ampforwp\_yoast\_seo\_development($dev){
$url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' );
if (ampforwp\_get\_setting('ampforwp-seo-selection') == 'yoast' && ampforwp\_get\_setting('ampforwp-seo-yoast-schema') && ampforwp\_is\_home() && function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) {
$dev = true;
}
return $dev;
}
function ampforwp\_remove\_homepage\_breadcrumb($data){
$url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' );
if (ampforwp\_get\_setting('ampforwp-seo-selection') == 'yoast' && ampforwp\_get\_setting('ampforwp-seo-yoast-schema') && ampforwp\_is\_home() && function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) {
if (isset($data["@graph"][2]["breadcrumb"])) {
unset($data["@graph"][2]["breadcrumb"]);
}
if(array\_key\_exists(3, $data["@graph"])) {
if (!empty($data["@graph"][3]["@type"]) && $data["@graph"][3]["@type"] == 'BreadcrumbList') {
unset($data["@graph"][3]);
}
}
}
return $data;
}
//Twitter title #2744
function ampforwp\_sanitize\_twitter\_title($post\_title){
$post\_title = html\_entity\_decode( $post\_title, ENT\_QUOTES, 'UTF-8' );
$post\_title = rawurlencode( $post\_title );
$post\_title = esc\_html( $post\_title );
return $post\_title;
}
if (function\_exists('i2\_pros\_cons\_setup')) {
add\_action('amp\_post\_template\_css','ampforwp\_i2prosandcons');
}
function ampforwp\_i2prosandcons(){
$options = get\_option( 'i2\_pros\_and\_cons');
$prosHeadingBackground = $options['pros\_heading\_background'];
$consHeadingBackground = $options['cons\_heading\_background'];
$prosBackground = $options['pros\_background'];
$consBackground = $options['cons\_background'];
$headingFontSize = $options['heading\_font\_size'];
$sectionFontSize = $options['body\_font\_size'];
$headingColor = $options['heading\_color'];
$sectionColor = $options['body\_color'];?>
.i2-pros-cons-main-wrapper .i2-pros-cons-wrapper {
display: table;
width: 100%;
}
.i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons {
display: table-cell;
width: 50%;
margin-bottom: 15px;
position: relative;
}
.i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros .i2-pros-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros .i2-cons-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons .i2-pros-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons .i2-cons-title {
padding: 5px 15px 5px;
margin: 0px;
display: block;
}
.i2-pros-cons-wrapper .i2-pros-title {
background-color:php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($prosHeadingBackground); ?;
font-size:php echo esc\_html($headingFontSize); ?px;
}
.i2-pros-cons-wrapper .i2-cons-title, .i2-pros-cons-wrapper .i2-pros-title {
color: #ffffff!important;
font-size:php echo esc\_html($headingFontSize); ?px;
}
.i2-pros {
background-color: php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($prosBackground); ?;
}
.i2-cons{
background-color: php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($consBackground); ?;
}
.i2-pros-cons-wrapper ul li{
font-size:php echo esc\_html($sectionFontSize); ?px;
}
.artl-cnt ul li:before {
content: "\e315";
display: inline-block;
width: 0;
background: #333;
position: absolute;
top: 0px;
left: 0px;
font-family: 'icomoon';
}
.i2-pros-cons-wrapper .i2-cons-title {
background-color: php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($consHeadingBackground); ?;
}
.i2-pros-cons-wrapper .i2-pros, .i2-pros-cons-wrapper .i2-cons{
color: php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($sectionColor); ?;
}
.i2-pros-cons-wrapper .i2-cons-title, .i2-pros-cons-wrapper .i2-pros-title {
color: php /\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/ echo ampforwp\_sanitize\_color($headingColor); ?;
}
php }
function ampforwp\_modify\_url\_utm\_params($url){
if(true == ampforwp\_get\_setting('ampforwp-related-post-utm-tracking-switch') && !empty(ampforwp\_get\_setting('ampforwp-related-posts-utm-tracking'))){
$modify\_url = ampforwp\_get\_setting('ampforwp-related-posts-utm-tracking');
$modify\_url = apply\_filters('ampforwp\_modify\_related\_post\_url', $modify\_url);
$url = add\_query\_arg($modify\_url, '' , $url);
return esc\_url\_raw($url);
}
return esc\_url\_raw($url);
}
if(true == ampforwp\_get\_setting('ampforwp-recent-post-utm-tracking-switch') && !empty(ampforwp\_get\_setting('ampforwp-recent-posts-utm-tracking'))){
add\_filter('ampforwp\_loop\_permalink\_update','ampforwp\_recent\_posts\_utm\_tracking');
}
function ampforwp\_recent\_posts\_utm\_tracking($recent\_post\_permalink){
if(is\_single()){
$modify\_url = ampforwp\_get\_setting('ampforwp-recent-posts-utm-tracking');
$modify\_url = apply\_filters('ampforwp\_modify\_recent\_post\_url', $modify\_url);
$recent\_post\_permalink = add\_query\_arg($modify\_url, '' , $recent\_post\_permalink);
return esc\_url\_raw($recent\_post\_permalink);
}
return esc\_url\_raw($recent\_post\_permalink);
}
if(ampforwp\_get\_setting('ampforwp-facebook-comments-support')){
add\_action('amp\_post\_template\_head','ampforwp\_facebook\_moderation\_tool');
}
function ampforwp\_facebook\_moderation\_tool(){
$facebook\_app\_id = ampforwp\_get\_setting('ampforwp-fb-moderation-app-id');
if($facebook\_app\_id!=''){
?

php
}
$facebook\_admin\_id = ampforwp\_get\_setting('ampforwp-fb-moderation-admin-id');
if($facebook\_admin\_id!=''){
$ids = explode(",", $facebook\_admin\_id);
for($i=0;$i<count($ids);$i++){
$id = $ids[$i];
if($id!=''){
?

php
}
}
}
}
//Schema Pro FAQ block compatibility #4956
add\_filter('ampforwp\_modify\_the\_content','ampforwp\_schema\_pro\_faq\_block');
function ampforwp\_schema\_pro\_faq\_block($content\_buffer){
if (!function\_exists('on\_bsf\_aiosrs\_pro\_activate')) {
return $content\_buffer;
}
preg\_match\_all('/<div class="wp-block-wpsp-faq(.\*?)class="wpsp-question"(.\*?)<\/(.\*?)>(.\*?)class="wpsp-faq-content">

(.\*?)<\/p>/', $content\_buffer, $matches);
if(is\_array($matches)){
$schema = array();
$schema['@context'] = 'https://schema.org';
$schema['type'] = 'FAQPage';
for($i=0;$i $question ) {
$schema['mainEntity'][ $key ]['@type'] = 'Question';
$schema['mainEntity'][ $key ]['name'] = $question;
}
foreach ( $answers as $key => $answer ) {
$schema['mainEntity'][ $key ]['acceptedAnswer']['@type'] = 'Answer';
$schema['mainEntity'][ $key ]['acceptedAnswer']['text'] = $answer;
}
}
$schema = '';
$content\_buffer = preg\_replace('/(Embed from Getty Images<\/a>/', $content, $matches)){
if(isset($matches[0])){
for($i=0;$i';
$description = get\_the\_archive\_description();
$sanitizer = new AMPFORWP\_Content( $iframe, array(),
apply\_filters( 'ampforwp\_content\_sanitizers',
array(
'AMP\_Style\_Sanitizer' => array(),
'AMP\_Blacklist\_Sanitizer' => array(),
'AMP\_Img\_Sanitizer' => array(),
'AMP\_Video\_Sanitizer' => array(),
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
)
) ) );
$iframe\_content = $sanitizer->get\_amp\_content();
$content = str\_replace($full\_content, $iframe\_content, $content );
}
}
}
}
}
}
}
return $content;
}
if(function\_exists('vp\_pfui\_admin\_init') && function\_exists('penci\_setup')){
add\_action('ampforwp\_before\_post\_content','ampforwp\_pennews\_audio\_embed');
}
function ampforwp\_pennews\_audio\_embed(){
$audio = get\_post\_meta(ampforwp\_get\_the\_ID(), '\_format\_audio\_embed', true);
if(empty($audio)){
return;
}
$audio = preg\_replace('//', '', $audio);
$audio\_str = substr( $audio, -4 );
$html ='';
if ( wp\_oembed\_get( $audio ) ) {
$html .= wp\_oembed\_get( $audio );
}elseif( $audio\_str == '.mp3' ) {
$html .= do\_shortcode('[audio src="'. esc\_url( $audio ) .'"]');
}else{
$html .= do\_shortcode( $audio );
}
$html .= '';
$sanitizer = new AMPFORWP\_Content( $html, array(),
apply\_filters( 'ampforwp\_content\_sanitizers',
array(
'AMP\_Audio\_Sanitizer' => array(),
'AMP\_Iframe\_Sanitizer' => array(
'add\_placeholder' => true,
)
) ) );
$sanitized\_html = $sanitizer->get\_amp\_content();
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo $sanitized\_html;
}
if(function\_exists('penci\_soledad\_theme\_setup')){
add\_action('ampforwp\_before\_post\_content','ampforwp\_penci\_format\_video\_embed');
add\_filter('ampforwp\_modify\_featured\_image','ampforwp\_penci\_remove\_featured\_image');
}
//Show Video
function ampforwp\_penci\_format\_video\_embed($content){
$penci\_video = get\_post\_meta( get\_the\_ID(), '\_format\_video\_embed', true );
if(!empty($penci\_video) && $penci\_video != ''){
$video\_id = '';
$penci\_video = 'https://www.youtube.com/watch?v=pMFEDv9Chlw';
$video\_html = '';
if(strpos($penci\_video, 'youtu') !== false){
if (preg\_match('%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"&?/ ]{11})%i', $penci\_video, $match)){
$video\_id = $match[1];
$video\_html .= '';
}
}elseif(strpos($penci\_video, 'vimeo')){
if (preg\_match('%^https?:\/\/(?:www\.|player\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]\*)\/videos\/|album\/(\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)(?:[?]?.\*)$%im', $penci\_video, $regs)){
$video\_id = $regs[3];
$video\_html .= '';
}
}else{
$video\_html .= '

Your browser doesn\'t support HTML5 video.

/', $content\_buffer, $matches);
if(is\_array($matches) && isset($matches[4][0])){
$img\_url = $matches[4][0];
if (!empty($img\_url)) {
$content\_buffer = preg\_replace('//', '', $content\_buffer);
$content\_buffer = preg\_replace('//', '', $content\_buffer);
return $content\_buffer;
}
}
}
return $content\_buffer;
}
function ampforwp\_mobile\_redirection\_js() {
$url\_to\_redirect = ampforwp\_amphtml\_generator();?>

php }
function ampforwp\_webp\_express\_compatibility($content){
if(function\_exists('webp\_express\_process\_post')){
preg\_match\_all('/src="(.\*?)"/', $content,$src);
if(isset($src[1][0])){
$img\_url = esc\_url($src[1][0]);
if(preg\_match('/m\.media-amazon/', $img\_url)){
return $content;
}
if(!preg\_match('/\.webp/', $img\_url)){
$config = \WebPExpress\Config::loadConfigAndFix();
if($config['destination-folder'] == 'mingled'){
$img\_url\_webp = $img\_url;
}else{
$img\_url\_webp = preg\_replace('/http(.\*?)\/wp-content(.\*?)/', 'http$1/wp-content/webp-express/webp-images$2', $img\_url);
if($config['destination-structure'] == 'doc-root'){
$img\_url\_webp = preg\_replace('/http(.\*?)\/wp-content(.\*?)/', 'http$1/wp-content/webp-express/webp-images/doc-root/wp-content$2', $img\_url);
}
}
if(!preg\_match('/\.webp/', $img\_url)){
$img\_url\_webp = esc\_url($img\_url\_webp).".webp";
$content = str\_replace($img\_url, $img\_url\_webp, $content);
}
}
}
}
return $content;
}
add\_action('amp\_post\_template\_css','ampforwp\_set\_local\_font',33);
if(!function\_exists('ampforwp\_set\_local\_font')){
function ampforwp\_set\_local\_font(){
if(ampforwp\_get\_setting('ampforwp-local-font-switch') && ampforwp\_get\_setting('ampforwp-local-font-upload','url')!=""){
$upload\_dir = wp\_upload\_dir();
$user\_dirname = $upload\_dir['basedir'] . '/' . 'ampforwp-local-fonts';
if ( file\_exists( $user\_dirname ) ) {
$font\_name = '';
$files = glob( $user\_dirname . '/\*' );
$font\_css = '@font-face {';
$i = 0;
foreach ( $files as $file ) {
$fonts = explode("/", $file);
$font\_name = end($fonts);
$ext = end(explode(".", $font\_name));
if($ext!='zip'){
$font\_arr = explode('-', $font\_name);
$font\_family = $font\_arr[0];
if($i==0){
$font\_css .= "font-family: '".esc\_attr(ucfirst($font\_family))."'; font-style: normal; font-weight: 400;";
}
$font\_path = $upload\_dir['baseurl'].'/'.'ampforwp-local-fonts/'.$font\_name;
if($ext=='eot'){
$font\_css .= "src: url('".esc\_url($font\_path)."'); src: url('".esc\_url($font\_path)."?#iefix') format('embedded-opentype'),";
}else if($ext=='svg'){
$font\_css .= "src: url('".esc\_url($font\_path)."?#".esc\_attr(ucfirst($font\_family))."') format('svg'),";
}else if($ext=='ttf'){
$font\_css .= "src: url('".esc\_url($font\_path)."') format('truetype'),";
}else{
$font\_css .= "src: url('".esc\_url($font\_path)."') format('".esc\_attr($ext)."'),";
}
$i++;
}
}
$font\_css .= '}';
if(!empty($font\_family) && $font\_family != ''){
$font\_css .= "body, .cntn-wrp {font-family: '".esc\_attr(ucfirst($font\_family))."'}";
}
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo $font\_css;
}
}
}
}
function ampforwp\_year\_shortcode() {
$year = gmdate('Y');
return $year;
}
add\_shortcode('ampforwp\_current\_year', 'ampforwp\_year\_shortcode');
function ampforwp\_litespeed\_webp\_compatibility($content){
if(class\_exists( 'WP\_Offload\_Media\_Autoloader')){
return $content;
}
if(function\_exists( 'run\_litespeed\_cache' )){
preg\_match\_all('/src="(.\*?)"/', $content,$src);
if(isset($src[1][0])){
$img\_url = esc\_url($src[1][0]);
if(!preg\_match('/\.webp/', $img\_url)){
$rep\_url = esc\_url($src[1][0]).".webp";
if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){
$upload\_dir = wp\_upload\_dir()['basedir'];
$img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url);
if(file\_exists($img\_file)){
$content = str\_replace($img\_url, $rep\_url, $content);
}
}
}
}
}
$content = str\_replace('.webp.webp','.webp',$content);
return $content;
}
if (ampforwp\_get\_setting('amp-core-end-point') && function\_exists('get\_rocket\_cache\_query\_string') ) {
add\_filter('rocket\_cache\_query\_strings', 'ampforwp\_rocket\_cache\_query\_string');
}
function ampforwp\_rocket\_cache\_query\_string($query\_strings){
array\_push($query\_strings,"amp");
return $query\_strings;
}
function ampforwp\_publisher\_desk\_ads\_insert( $ads, $content ) {
if ( ! is\_array( $ads ) ) {
return $content;
}
$closing\_p = '</p';
$paragraphs = explode( $closing\_p, $content );
foreach ($paragraphs as $index => $paragraph) {
if ( trim( $paragraph ) ) {
$paragraphs[$index] .= $closing\_p;
}
$n = $index + 1;
if ( isset( $ads[ $n ] ) ) {
$paragraphs[$index] .= $ads[ $n ];
}
}
return implode( '', $paragraphs );
}
add\_filter( 'ampforwp\_modify\_the\_content', 'ampforwp\_publisher\_desk\_ads' );
function ampforwp\_publisher\_desk\_ads( $content ) {
if (!ampforwp\_get\_setting('ampforwp-ads-publisherdesk')) {
return $content;
}
$pub\_id = $url = '';
$pub\_id = ampforwp\_get\_setting('ampforwp-publisherdesk-id');
if (!empty($pub\_id)) {
$url = 'https://cdn.tpdads.com/json/amp-tags/'.esc\_html($pub\_id).'.json';
}
$data\_api = wp\_remote\_get($url);
if (is\_array($data\_api) && !empty($data\_api['body'])) {
$json\_data\_api = json\_decode( $data\_api['body'] );
$addList = array();
if(!empty($json\_data\_api->customHTMLAboveContentAd)){
$content = $json\_data\_api->customHTMLAboveContentAd[0]." ".$content;
}
if(!empty($json\_data\_api->customHTMLBelowContentAd)){
$content .= $json\_data\_api->customHTMLBelowContentAd[0];
}
if ( is\_single() && !empty($pub\_id) && !empty($json\_data\_api) ) {
if(isset($json\_data\_api->inContentPlacementMethod) && $json\_data\_api->inContentPlacementMethod=='Auto'){
$addList[3] = $json\_data\_api->customHTMLInContentAds[0];
$addList[6] = $json\_data\_api->customHTMLInContentAds[1];
$addList[9] = $json\_data\_api->customHTMLInContentAds[2];
}
else{
if( isset( $json\_data\_api->afterParagraphNumbers ) && $json\_data\_api->afterParagraphNumbers ) {
for ($i=0; $i < count($json\_data\_api->afterParagraphNumbers); $i++) {
$addList[$json\_data\_api->afterParagraphNumbers[$i]] = $json\_data\_api->customHTMLInContentAds[$i];
}
}
}
$content = ampforwp\_publisher\_desk\_ads\_insert( $addList, $content );
if ( isset( $json\_data\_api->stickyCustomHTMLAd[0] ) ) {
$content .= $json\_data\_api->stickyCustomHTMLAd[0];
}
$content = preg\_replace('/json="/', 'json=\"' , $content);
$content = preg\_replace('/rtc-config="/', 'rtc-config=\"' , $content);
}
}
return $content;
}
// #5274 AMP Take over conflict with WPML
add\_filter('ampforwp\_is\_amp\_endpoint\_takeover', 'ampforwp\_wpml\_takeover\_compatibility');
function ampforwp\_wpml\_takeover\_compatibility($return) {
/\* phpcs:ignore WordPress.Security.NonceVerification.Recommended \*/
if (is\_user\_logged\_in() && !empty($\_GET['wpml-app'])) {
return false;
}
return $return;
};
if(class\_exists('SuperRelatedPosts')){
add\_action('amp\_post\_template\_css', 'ampforwp\_super\_related\_posts\_style');
}
function ampforwp\_super\_related\_posts\_style(){
global $wp\_filesystem;
$css = get\_transient('ampforwp\_super\_related\_posts');
if($css == false){
if(!is\_object($wp\_filesystem)){
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php';
require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php';
$wp\_filesystem = new WP\_Filesystem\_Direct( array() );
}
$css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/includes/super-related-posts.css");
set\_transient('ampforwp\_super\_related\_posts', $css);
}
/\* phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped \*/
echo ampforwp\_css\_sanitizer($css);
}
if( function\_exists('ampforwp\_get\_setting') && true == ampforwp\_get\_setting('amp-core-end-point') && class\_exists('RankMath') && RankMath\Helper::get\_settings( 'general.wc\_remove\_product\_base' ) ){
add\_filter( 'ampforwp\_is\_amp\_endpoint', 'ampforwp\_rankmath\_endpoint\_fix', 20, 1);
}
function ampforwp\_rankmath\_endpoint\_fix($flag){
/\* phpcs:ignore WordPress.Security.NonceVerification.Recommended \*/
if(isset($\_GET['amp'])){
return false;
}
}
add\_filter('wp\_handle\_upload\_prefilter', 'ampforwp\_sanitize\_svg\_upload');
/\*\*
\* Sanitize SVG files before upload.
\*
\* This function checks if the uploaded file is an SVG. If it is, it sanitizes the SVG file by removing
\* any](%28%27%7C%5C%22%29%28.%2A?).(bmp|gif|jpeg|jpg|png)('|\"))](%28.%2A?))](%27%20.%20esc_url%28%20%24url%20%29%20.%20%27)
