=== Content from plugins.trac.wordpress.org_ffacbf87_20250114_185157.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3009011%2Fhost-analyticsjs-local)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3009003/host-analyticsjs-local "Changeset 3009003 for host-analyticsjs-local")
* [Next Change](/changeset/3064913/host-analyticsjs-local "Changeset 3064913 for host-analyticsjs-local") →

---

# Changeset [3009011](/changeset/3009011 "Show full changeset") for [host-analyticsjs-local](/browser/host-analyticsjs-local?rev=3009011 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/12/2023 07:02:38 PM
([13 months](/timeline?from=2023-12-12T19%3A02%3A38Z&precision=second "See timeline at 12/12/2023 07:02:38 PM") ago)

Author:
DaanvandenBergh
Message:

Update to version 4.7.15 from GitHub

Location:
[host-analyticsjs-local](/browser/host-analyticsjs-local?rev=3009011)
Files:

6 edited
1 copied

* [tags/4.7.15](/browser/host-analyticsjs-local/tags/4.7.15?rev=3009011 "Show entry in browser")
  (copied)
  *(copied from [host-analyticsjs-local/trunk](/browser/host-analyticsjs-local/trunk?rev=3009003 "Show original file (revision 3009010)"))*
* [tags/4.7.15/host-analyticsjs-local.php](/browser/host-analyticsjs-local/tags/4.7.15/host-analyticsjs-local.php?rev=3009011 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))
* [tags/4.7.15/includes/class-caos.php](/browser/host-analyticsjs-local/tags/4.7.15/includes/class-caos.php?rev=3009011 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [tags/4.7.15/readme.txt](/browser/host-analyticsjs-local/tags/4.7.15/readme.txt?rev=3009011 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [trunk/host-analyticsjs-local.php](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3009011 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [trunk/includes/class-caos.php](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009011 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [trunk/readme.txt](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009011 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [host-analyticsjs-local/tags/4.7.15/host-analyticsjs-local.php](/changeset/3009011/host-analyticsjs-local/tags/4.7.15/host-analyticsjs-local.php "Show the changeset 3009011 restricted to host-analyticsjs-local/tags/4.7.15/host-analyticsjs-local.php")

  | [r3009003](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3009003#L4 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/tags/4.7.15/host-analyticsjs-local.php?rev=3009011#L4 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://daan.dev/wordpress/caos/ |
  | 5 | 5 | \* Description: Completely optimize Google Analytics 4 for your WordPress Website - host gtag.js locally or use Minimal Analytics and much more! |
  | 6 |  | \* Version: 4.7.1~~4~~ |
  |  | 6 | \* Version: 4.7.15 |
  | 7 | 7 | \* Author: Daan from Daan.dev |
  | 8 | 8 | \* Author URI: https://daan.dev/ |
* ## [host-analyticsjs-local/tags/4.7.15/includes/class-caos.php](/changeset/3009011/host-analyticsjs-local/tags/4.7.15/includes/class-caos.php "Show the changeset 3009011 restricted to host-analyticsjs-local/tags/4.7.15/includes/class-caos.php")

  | [r3009003](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009003#L336 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/tags/4.7.15/includes/class-caos.php?rev=3009011#L336 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 336 | 336 |  |
  | 337 | 337 | /\*\* |
  | 338 |  | \* @return CAOS\_~~Admin\_UpdateFiles~~ |
  |  | 338 | \* @return CAOS\_Cron|void |
  | 339 | 339 | \*/ |
  | 340 | 340 | public function do\_update\_after\_save() { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009003#L406) | […](/browser/host-analyticsjs-local/tags/4.7.15/includes/class-caos.php?rev=3009011#L406) |  |
  | 406 | 406 | return; |
  | 407 | 407 | } |
  | 408 |  |  |
  | 409 |  | $action = $\_GET[ 'tab' ] ?~~? 'caos-basic-setting~~s'; |
  |  | 408 |  |
  |  | 409 | $action = $\_GET[ 'tab' ] ? $\_GET[ 'tab' ] . '-options' : 'caos-basic-settings-options'; |
  | 410 | 410 | $nonce  = $\_POST[ '\_wpnonce' ] ?? ''; |
  | 411 | 411 |  |
  | 412 |  | wp\_verify\_nonce( $nonce, $action ); |
  |  | 412 | if ( wp\_verify\_nonce( $nonce, $action ) < 1 ) { |
  |  | 413 | return; |
  |  | 414 | } |
  | 413 | 415 |  |
  | 414 | 416 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
* ## [host-analyticsjs-local/tags/4.7.15/readme.txt](/changeset/3009011/host-analyticsjs-local/tags/4.7.15/readme.txt "Show the changeset 3009011 restricted to host-analyticsjs-local/tags/4.7.15/readme.txt")

  | [r3009003](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009003#L4 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/tags/4.7.15/readme.txt?rev=3009011#L4 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.4 |
  | 6 |  | Stable tag: 4.7.1~~4~~ |
  |  | 6 | Stable tag: 4.7.15 |
  | 7 | 7 | Requires PHP: 7.0 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009003#L77) | […](/browser/host-analyticsjs-local/tags/4.7.15/readme.txt?rev=3009011#L77) |  |
  | 77 | 77 | == Changelog == |
  | 78 | 78 |  |
  |  | 79 | = 4.7.15 = |
  |  | 80 | \* Fixed: This time a proper fix against CSRF attacks. It's been a long day. Sorry, guys! |
  |  | 81 |  |
  | 79 | 82 | = 4.7.14 = |
  | 80 | 83 | \* Fixed: undefined array key \_wpnonce. (Big Oops! on my end, sorry about that.) |
* ## [host-analyticsjs-local/trunk/host-analyticsjs-local.php](/changeset/3009011/host-analyticsjs-local/trunk/host-analyticsjs-local.php "Show the changeset 3009011 restricted to host-analyticsjs-local/trunk/host-analyticsjs-local.php")

  | [r3009003](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3009003#L4 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3009011#L4 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://daan.dev/wordpress/caos/ |
  | 5 | 5 | \* Description: Completely optimize Google Analytics 4 for your WordPress Website - host gtag.js locally or use Minimal Analytics and much more! |
  | 6 |  | \* Version: 4.7.1~~4~~ |
  |  | 6 | \* Version: 4.7.15 |
  | 7 | 7 | \* Author: Daan from Daan.dev |
  | 8 | 8 | \* Author URI: https://daan.dev/ |
* ## [host-analyticsjs-local/trunk/includes/class-caos.php](/changeset/3009011/host-analyticsjs-local/trunk/includes/class-caos.php "Show the changeset 3009011 restricted to host-analyticsjs-local/trunk/includes/class-caos.php")

  | [r3009003](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009003#L336 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009011#L336 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 336 | 336 |  |
  | 337 | 337 | /\*\* |
  | 338 |  | \* @return CAOS\_~~Admin\_UpdateFiles~~ |
  |  | 338 | \* @return CAOS\_Cron|void |
  | 339 | 339 | \*/ |
  | 340 | 340 | public function do\_update\_after\_save() { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009003#L406) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3009011#L406) |  |
  | 406 | 406 | return; |
  | 407 | 407 | } |
  | 408 |  |  |
  | 409 |  | $action = $\_GET[ 'tab' ] ?~~? 'caos-basic-setting~~s'; |
  |  | 408 |  |
  |  | 409 | $action = $\_GET[ 'tab' ] ? $\_GET[ 'tab' ] . '-options' : 'caos-basic-settings-options'; |
  | 410 | 410 | $nonce  = $\_POST[ '\_wpnonce' ] ?? ''; |
  | 411 | 411 |  |
  | 412 |  | wp\_verify\_nonce( $nonce, $action ); |
  |  | 412 | if ( wp\_verify\_nonce( $nonce, $action ) < 1 ) { |
  |  | 413 | return; |
  |  | 414 | } |
  | 413 | 415 |  |
  | 414 | 416 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
* ## [host-analyticsjs-local/trunk/readme.txt](/changeset/3009011/host-analyticsjs-local/trunk/readme.txt "Show the changeset 3009011 restricted to host-analyticsjs-local/trunk/readme.txt")

  | [r3009003](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009003#L4 "Show revision 3009003 of this file in browser") | [r3009011](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009011#L4 "Show revision 3009011 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.4 |
  | 6 |  | Stable tag: 4.7.1~~4~~ |
  |  | 6 | Stable tag: 4.7.15 |
  | 7 | 7 | Requires PHP: 7.0 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009003#L77) | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3009011#L77) |  |
  | 77 | 77 | == Changelog == |
  | 78 | 78 |  |
  |  | 79 | = 4.7.15 = |
  |  | 80 | \* Fixed: This time a proper fix against CSRF attacks. It's been a long day. Sorry, guys! |
  |  | 81 |  |
  | 79 | 82 | = 4.7.14 = |
  | 80 | 83 | \* Fixed: undefined array key \_wpnonce. (Big Oops! on my end, sorry about that.) |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3009011)
* [Zip Archive](?format=zip&new=3009011)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_62f43d5d_20250114_185149.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fhost-analyticsjs-local%2Ftags%2F4.7.12%2Fincludes%2Fclass-caos.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2957916 "Revision 2957916")
* [Next Revision](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878 "Revision 3008878") →
* [Blame](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/host-analyticsjs-local/tags/4.7.12/includes/class-caos.php)

---

# [source:](/browser?order=name "Go to repository root") [host-analyticsjs-local](/browser/host-analyticsjs-local?order=name "View host-analyticsjs-local")/[tags](/browser/host-analyticsjs-local/tags?order=name "View tags")/[4.7.12](/browser/host-analyticsjs-local/tags/4.7.12?order=name "View 4.7.12")/[includes](/browser/host-analyticsjs-local/tags/4.7.12/includes?order=name "View includes")/[class-caos.php](/browser/host-analyticsjs-local/tags/4.7.12/includes/class-caos.php?order=name "View class-caos.php")

View diff against:

View revision:

| [Last change](/changeset/2981201/host-analyticsjs-local/trunk/includes/class-caos.php "View differences") on this file was [2981201](/changeset/2981201/ "View changeset 2981201"), checked in by DaanvandenBergh, [15 months ago](/timeline?from=2023-10-19T13%3A16%3A23Z&precision=second "See timeline at 10/19/2023 01:16:23 PM") |
| --- |
| Update to version 4.7.11 from GitHub |
| **File size:** 11.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | defined( 'ABSPATH' ) || exit; |
| [3](#L3) |  |
| [4](#L4) | /\* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* |
| [5](#L5) | \*  ██████╗ █████╗  ██████╗ ███████╗ |
| [6](#L6) | \* ██╔════╝██╔══██╗██╔═══██╗██╔════╝ |
| [7](#L7) | \* ██║     ███████║██║   ██║███████╗ |
| [8](#L8) | \* ██║     ██╔══██║██║   ██║╚════██║ |
| [9](#L9) | \* ╚██████╗██║  ██║╚██████╔╝███████║ |
| [10](#L10) | \*  ╚═════╝╚═╝  ╚═╝ ╚═════╝ ╚══════╝ |
| [11](#L11) | \* |
| [12](#L12) | \* @author   : Daan van den Bergh |
| [13](#L13) | \* @url      : https://daan.dev/wordpress/caos/ |
| [14](#L14) | \* @copyright: © 2021 - 2023 Daan van den Bergh |
| [15](#L15) | \* @license  : GPL2v2 or later |
| [16](#L16) | \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \*/ |
| [17](#L17) | class CAOS { |
| [18](#L18) | /\*\* |
| [19](#L19) | \* Used to check if CAOS Pro is (de)activated and update files (e.g. gtag.js) accordingly. |
| [20](#L20) | \*/ |
| [21](#L21) | const CAOS\_PRO\_PLUGIN\_SLUG = 'caos-pro'; |
| [22](#L22) |  |
| [23](#L23) | /\*\* |
| [24](#L24) | \* CAOS constructor. |
| [25](#L25) | \*/ |
| [26](#L26) | public function \_\_construct() { |
| [27](#L27) | $this->define\_constants(); |
| [28](#L28) | $this->do\_setup(); |
| [29](#L29) |  |
| [30](#L30) | if ( version\_compare( CAOS\_STORED\_DB\_VERSION, CAOS\_DB\_VERSION ) < 0 ) { |
| [31](#L31) | new CAOS\_DB(); |
| [32](#L32) | } |
| [33](#L33) |  |
| [34](#L34) | if ( is\_admin() ) { |
| [35](#L35) | do\_action( 'caos\_before\_admin' ); |
| [36](#L36) |  |
| [37](#L37) | new CAOS\_Ajax(); |
| [38](#L38) | new CAOS\_Admin\_Settings(); |
| [39](#L39) | } |
| [40](#L40) |  |
| [41](#L41) | if ( ! is\_admin() ) { |
| [42](#L42) | do\_action( 'caos\_before\_frontend' ); |
| [43](#L43) |  |
| [44](#L44) | new CAOS\_Frontend\_Compatibility(); |
| [45](#L45) | new CAOS\_Frontend\_Functions(); |
| [46](#L46) | new CAOS\_Frontend\_Tracking(); |
| [47](#L47) | } |
| [48](#L48) |  |
| [49](#L49) | // Update Settings |
| [50](#L50) | add\_action( 'admin\_init', [ $this, 'update\_settings' ] ); |
| [51](#L51) |  |
| [52](#L52) | // Automatic File Updates |
| [53](#L53) | add\_action( 'activated\_plugin', [ $this, 'maybe\_do\_update' ] ); |
| [54](#L54) | add\_action( 'deactivated\_plugin', [ $this, 'maybe\_do\_update' ] ); |
| [55](#L55) | add\_action( 'admin\_init', [ $this, 'do\_update\_after\_save' ] ); |
| [56](#L56) | add\_action( 'in\_plugin\_update\_message-' . CAOS\_PLUGIN\_BASENAME, [ $this, 'render\_update\_notice' ], 11, 2 ); |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | /\*\* |
| [60](#L60) | \* Define constants |
| [61](#L61) | \*/ |
| [62](#L62) | public function define\_constants() { |
| [63](#L63) | global $caos\_file\_aliases; |
| [64](#L64) |  |
| [65](#L65) | $caos\_file\_aliases = get\_option( CAOS\_Admin\_Settings::CAOS\_CRON\_FILE\_ALIASES ); |
| [66](#L66) |  |
| [67](#L67) | define( 'CAOS\_SITE\_URL', 'https://daan.dev/blog' ); |
| [68](#L68) | define( 'CAOS\_STORED\_DB\_VERSION', esc\_attr( get\_option( CAOS\_Admin\_Settings::CAOS\_DB\_VERSION, '4.2.1' ) ) ); |
| [69](#L69) | define( 'CAOS\_CRON', 'caos\_update\_analytics\_js' ); |
| [70](#L70) | } |
| [71](#L71) |  |
| [72](#L72) | /\*\* |
| [73](#L73) | \* @since v4.7.3 |
| [74](#L74) | \* |
| [75](#L75) | \* @return string Absolute path to CAOS' cache directory. |
| [76](#L76) | \*/ |
| [77](#L77) | public static function get\_local\_dir() { |
| [78](#L78) | return apply\_filters( 'caos\_local\_dir', WP\_CONTENT\_DIR . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) ); |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | /\*\* |
| [82](#L82) | \* @return false|array Global variable containing all saved file aliases. |
| [83](#L83) | \*/ |
| [84](#L84) | public static function get\_file\_aliases() { |
| [85](#L85) | global $caos\_file\_aliases; |
| [86](#L86) |  |
| [87](#L87) | return $caos\_file\_aliases; |
| [88](#L88) | } |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* Get alias of JS library. |
| [92](#L92) | \* |
| [93](#L93) | \* @return string |
| [94](#L94) | \*/ |
| [95](#L95) | public static function get\_file\_alias() { |
| [96](#L96) | $file\_aliases = self::get\_file\_aliases(); |
| [97](#L97) |  |
| [98](#L98) | if ( ! $file\_aliases ) { |
| [99](#L99) | return ''; |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | return $file\_aliases['gtag'] ?? ''; |
| [103](#L103) | } |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* @param  array $file\_aliases |
| [107](#L107) | \* @param  bool  $write |
| [108](#L108) | \* @return bool |
| [109](#L109) | \*/ |
| [110](#L110) | public static function set\_file\_aliases( $file\_aliases, $write = false ) { |
| [111](#L111) | global $caos\_file\_aliases; |
| [112](#L112) |  |
| [113](#L113) | $caos\_file\_aliases = $file\_aliases; |
| [114](#L114) |  |
| [115](#L115) | if ( $write ) { |
| [116](#L116) | return update\_option( CAOS\_Admin\_Settings::CAOS\_CRON\_FILE\_ALIASES, $file\_aliases ); |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | /\*\* |
| [120](#L120) | \* There's no reason to assume that updating a global variable would fail. Always return true at this point. |
| [121](#L121) | \*/ |
| [122](#L122) | return true; |
| [123](#L123) | } |
| [124](#L124) |  |
| [125](#L125) | /\*\* |
| [126](#L126) | \* @param  string $alias |
| [127](#L127) | \* @param  bool   $write |
| [128](#L128) | \* @return bool |
| [129](#L129) | \*/ |
| [130](#L130) | public static function set\_file\_alias( $alias, $write = false ) { |
| [131](#L131) | $file\_aliases = self::get\_file\_aliases(); |
| [132](#L132) |  |
| [133](#L133) | $file\_aliases['gtag'] = $alias; |
| [134](#L134) |  |
| [135](#L135) | return self::set\_file\_aliases( $file\_aliases, $write ); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | /\*\* |
| [139](#L139) | \* Includes backwards compatibility for pre 3.11.0 |
| [140](#L140) | \* |
| [141](#L141) | \* @since 3.11.0 |
| [142](#L142) | \* |
| [143](#L143) | \* @return string|void |
| [144](#L144) | \*/ |
| [145](#L145) | public static function get\_file\_alias\_path() { |
| [146](#L146) | $file\_path = self::get\_local\_dir() . 'gtag.js'; |
| [147](#L147) |  |
| [148](#L148) | // Backwards compatibility |
| [149](#L149) | if ( ! self::get\_file\_aliases() ) { |
| [150](#L150) | return $file\_path; |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | $file\_alias = self::get\_file\_alias() ?? ''; |
| [154](#L154) |  |
| [155](#L155) | // Backwards compatibility |
| [156](#L156) | if ( ! $file\_alias ) { |
| [157](#L157) | return $file\_path; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | return self::get\_local\_dir() . $file\_alias; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | /\*\* |
| [164](#L164) | \* Global debug logging function. |
| [165](#L165) | \* |
| [166](#L166) | \* @param  mixed $message |
| [167](#L167) | \* @return void |
| [168](#L168) | \*/ |
| [169](#L169) | public static function debug( $message ) { |
| [170](#L170) | if ( ! defined( 'CAOS\_DEBUG\_MODE' ) || CAOS\_DEBUG\_MODE === false ) { |
| [171](#L171) | return; |
| [172](#L172) | } |
| [173](#L173) |  |
| [174](#L174) | // phpcs:ignore |
| [175](#L175) | error\_log( current\_time( 'Y-m-d H:i:s' ) . ": $message\n", 3, trailingslashit( WP\_CONTENT\_DIR ) . 'caos-debug.log' ); |
| [176](#L176) | } |
| [177](#L177) |  |
| [178](#L178) | /\*\* |
| [179](#L179) | \* @return CAOS\_Setup |
| [180](#L180) | \*/ |
| [181](#L181) | private function do\_setup() { |
| [182](#L182) | register\_uninstall\_hook( CAOS\_PLUGIN\_FILE, 'CAOS::do\_uninstall' ); |
| [183](#L183) |  |
| [184](#L184) | return new CAOS\_Setup(); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | /\*\* |
| [188](#L188) | \* Triggers when CAOS (Pro) is (de)activated. |
| [189](#L189) | \* |
| [190](#L190) | \* @return CAOS\_Cron |
| [191](#L191) | \*/ |
| [192](#L192) | public function trigger\_cron\_script() { |
| [193](#L193) | return new CAOS\_Cron(); |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\*\* |
| [197](#L197) | \* Check if (de)activated plugin is CAOS Pro and if so, update. |
| [198](#L198) | \*/ |
| [199](#L199) | public function maybe\_do\_update( $plugin ) { |
| [200](#L200) | if ( strpos( $plugin, self::CAOS\_PRO\_PLUGIN\_SLUG ) === false ) { |
| [201](#L201) | return; |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | $this->trigger\_cron\_script(); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | /\*\* |
| [208](#L208) | \* @return CAOS\_Admin\_UpdateFiles |
| [209](#L209) | \*/ |
| [210](#L210) | public function do\_update\_after\_save() { |
| [211](#L211) | $settings\_page    = $\_GET['page'] ?? ''; |
| [212](#L212) | $settings\_updated = $\_GET['settings-updated'] ?? ''; |
| [213](#L213) |  |
| [214](#L214) | if ( CAOS\_Admin\_Settings::CAOS\_ADMIN\_PAGE !== $settings\_page ) { |
| [215](#L215) | return; |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | if ( ! $settings\_updated ) { |
| [219](#L219) | return; |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | /\*\* |
| [223](#L223) | \* No need to update any files if we're using Minimal Analytics. Can't believe I'm only finding out about this now... |
| [224](#L224) | \* |
| [225](#L225) | \* @since 4.7.0 |
| [226](#L226) | \*/ |
| [227](#L227) | if ( self::get( 'tracking\_code' ) === 'minimal\_ga4' ) { |
| [228](#L228) | return; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | return $this->trigger\_cron\_script(); |
| [232](#L232) | } |
| [233](#L233) |  |
| [234](#L234) | /\*\* |
| [235](#L235) | \* Render update notices if available. |
| [236](#L236) | \* |
| [237](#L237) | \* @param  mixed $plugin |
| [238](#L238) | \* @param  mixed $response |
| [239](#L239) | \* @return void |
| [240](#L240) | \*/ |
| [241](#L241) | public function render\_update\_notice( $plugin, $response ) { |
| [242](#L242) | $current\_version = $plugin['Version']; |
| [243](#L243) | $new\_version     = $plugin['new\_version']; |
| [244](#L244) |  |
| [245](#L245) | if ( version\_compare( $current\_version, $new\_version, '<' ) ) { |
| [246](#L246) | $response = wp\_remote\_get( 'https://daan.dev/caos-update-notices.json' ); |
| [247](#L247) |  |
| [248](#L248) | if ( is\_wp\_error( $response ) ) { |
| [249](#L249) | return; |
| [250](#L250) | } |
| [251](#L251) |  |
| [252](#L252) | $update\_notices = (array) json\_decode( wp\_remote\_retrieve\_body( $response ) ); |
| [253](#L253) |  |
| [254](#L254) | if ( ! isset( $update\_notices[ $new\_version ] ) ) { |
| [255](#L255) | return; |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | printf( |
| [259](#L259) | ' <strong>' . \_\_( 'This update includes major changes. Please <a href="%s" target="\_blank">read this</a> before updating.', 'host-analyticsjs-local' ) . '</strong>', |
| [260](#L260) | $update\_notices[ $new\_version ]->url |
| [261](#L261) | ); |
| [262](#L262) | } |
| [263](#L263) | } |
| [264](#L264) |  |
| [265](#L265) | /\*\* |
| [266](#L266) | \* Returns early if File Aliases option doesn't exist for Backwards Compatibility. |
| [267](#L267) | \* |
| [268](#L268) | \* @since 3.11.0 |
| [269](#L269) | \* |
| [270](#L270) | \* @return string |
| [271](#L271) | \*/ |
| [272](#L272) | public static function get\_local\_file\_url() { |
| [273](#L273) | $url = content\_url() . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) . 'gtag.js'; |
| [274](#L274) |  |
| [275](#L275) | /\*\* |
| [276](#L276) | \* is\_ssl() fails when behind a load balancer or reverse proxy. That's why we double check here if |
| [277](#L277) | \* SSL is enabled and rewrite accordingly. |
| [278](#L278) | \*/ |
| [279](#L279) | if ( strpos( home\_url(), 'https://' ) !== false && ! is\_ssl() ) { |
| [280](#L280) | $url = str\_replace( 'http://', 'https://', $url ); |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | if ( self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ) ) { |
| [284](#L284) | $url = str\_replace( get\_home\_url( get\_current\_blog\_id() ), '//' . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ), $url ); |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | $file\_alias = self::get\_file\_alias(); |
| [288](#L288) |  |
| [289](#L289) | if ( ! $file\_alias ) { |
| [290](#L290) | return $url; |
| [291](#L291) | } |
| [292](#L292) |  |
| [293](#L293) | $url = str\_replace( 'gtag.js', $file\_alias, $url ); |
| [294](#L294) |  |
| [295](#L295) | return apply\_filters( 'caos\_local\_file\_url', $url ); |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | /\*\* |
| [299](#L299) | \* @return CAOS\_Uninstall |
| [300](#L300) | \* @throws ReflectionException |
| [301](#L301) | \*/ |
| [302](#L302) | public static function do\_uninstall() { |
| [303](#L303) | return new CAOS\_Uninstall(); |
| [304](#L304) | } |
| [305](#L305) |  |
| [306](#L306) | /\*\* |
| [307](#L307) | \* File downloader |
| [308](#L308) | \* |
| [309](#L309) | \* @param mixed  $local\_file |
| [310](#L310) | \* @param mixed  $remote\_file |
| [311](#L311) | \* @param string $file |
| [312](#L312) | \* @param bool   $is\_plugin |
| [313](#L313) | \* |
| [314](#L314) | \* @return string |
| [315](#L315) | \*/ |
| [316](#L316) | public static function download\_file( |
| [317](#L317) | $remote\_file, |
| [318](#L318) | $file = '' |
| [319](#L319) | ) { |
| [320](#L320) | $download = new CAOS\_FileManager(); |
| [321](#L321) |  |
| [322](#L322) | return $download->download\_file( $remote\_file, $file ); |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | /\*\* |
| [326](#L326) | \* @param string $path |
| [327](#L327) | \* |
| [328](#L328) | \* @return bool |
| [329](#L329) | \*/ |
| [330](#L330) | public static function create\_dir\_r( $path ) { |
| [331](#L331) | $file\_manager = new CAOS\_FileManager(); |
| [332](#L332) |  |
| [333](#L333) | return $file\_manager->create\_dir\_recursive( $path ); |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | /\*\* |
| [337](#L337) | \* @param string $file |
| [338](#L338) | \* @param string $find |
| [339](#L339) | \* @param string $replace |
| [340](#L340) | \* |
| [341](#L341) | \* @return int|false |
| [342](#L342) | \*/ |
| [343](#L343) | public static function find\_replace\_in( $file, $find, $replace ) { |
| [344](#L344) | $file\_manager = new CAOS\_FileManager(); |
| [345](#L345) |  |
| [346](#L346) | return $file\_manager->find\_replace\_in( $file, $find, $replace ); |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | /\*\* |
| [350](#L350) | \* |
| [351](#L351) | \*/ |
| [352](#L352) | public static function uses\_minimal\_analytics() { |
| [353](#L353) | return self::get( CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_TRACKING\_CODE ) === 'minimal\_ga4'; |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | /\*\* |
| [357](#L357) | \* Method to retrieve settings from database. |
| [358](#L358) | \* |
| [359](#L359) | \* @filter caos\_setting\_{$name} |
| [360](#L360) | \* |
| [361](#L361) | \* @param string $name               Any constant from the CAOS\_Admin\_Settings class. |
| [362](#L362) | \* @param mixed  $default (optional) The option's default value if it isn't set (yet). |
| [363](#L363) | \* |
| [364](#L364) | \* @since v4.5.1 |
| [365](#L365) | \* |
| [366](#L366) | \* @return mixed |
| [367](#L367) | \*/ |
| [368](#L368) | public static function get( $name, $default = null ) { |
| [369](#L369) | $value = self::get\_settings()[ $name ] ?? ''; |
| [370](#L370) |  |
| [371](#L371) | if ( empty( $value ) && $default !== null ) { |
| [372](#L372) | $value = $default; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | /\*\* |
| [376](#L376) | \* This allows for WPML (and similar plugins) to use different tracking IDs on different languages/sites. |
| [377](#L377) | \*/ |
| [378](#L378) | if ( $name === CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_MEASUREMENT\_ID ) { |
| [379](#L379) | $translated\_tracking\_id = \_x( 'G-123ABC789', 'Define a different Measurement ID for this language/site.', 'host-analyticsjs-local' ); |
| [380](#L380) |  |
| [381](#L381) | if ( $translated\_tracking\_id !== 'G-123ABC789' ) { |
| [382](#L382) | $value = $translated\_tracking\_id; |
| [383](#L383) | } |
| [384](#L384) | } |
| [385](#L385) |  |
| [386](#L386) | return apply\_filters( "caos\_setting\_$name", $value ); |
| [387](#L387) | } |
| [388](#L388) |  |
| [389](#L389) | /\*\* |
| [390](#L390) | \* Gets all settings for CAOS. |
| [391](#L391) | \* |
| [392](#L392) | \* @since 4.5.1 |
| [393](#L393) | \* |
| [394](#L394) | \* @return array |
| [395](#L395) | \*/ |
| [396](#L396) | public static function get\_settings() { |
| [397](#L397) | static $settings; |
| [398](#L398) |  |
| [399](#L399) | if ( empty( $settings ) ) { |
| [400](#L400) | $settings = get\_option( 'caos\_settings', [] ); |
| [401](#L401) | } |
| [402](#L402) |  |
| [403](#L403) | return apply\_filters( 'caos\_settings', $settings ); |
| [404](#L404) | } |
| [405](#L405) |  |
| [406](#L406) | /\*\* |
| [407](#L407) | \* We use a custom update action, because we're storing multidimensional arrays upon form submit. |
| [408](#L408) | \* |
| [409](#L409) | \* This prevents us from having to use AJAX, serialize(), stringify() and eventually having to json\_decode() it, i.e. |
| [410](#L410) | \* a lot of headaches. |
| [411](#L411) | \* |
| [412](#L412) | \* @since v4.6.0 |
| [413](#L413) | \*/ |
| [414](#L414) | public function update\_settings() { |
| [415](#L415) | // phpcs:ignore WordPress.Security |
| [416](#L416) | if ( empty( $\_POST['action'] ) || $\_POST['action'] !== 'caos-update' ) { |
| [417](#L417) | return; |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | // phpcs:ignore |
| [421](#L421) | $post\_data = $this->clean($\_POST); |
| [422](#L422) |  |
| [423](#L423) | $options = apply\_filters( |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Any options that're better off in their own DB row (e.g. due to size) can be added using this filter. |
| [426](#L426) | \* |
| [427](#L427) | \* @since v4.6.0 |
| [428](#L428) | \*/ |
| [429](#L429) | 'caos\_update\_settings\_serialized', |
| [430](#L430) | [ |
| [431](#L431) | 'caos\_settings', |
| [432](#L432) | ] |
| [433](#L433) | ); |
| [434](#L434) |  |
| [435](#L435) | foreach ( $options as $option ) { |
| [436](#L436) | if ( ! empty( $post\_data[ $option ] ) ) { |
| [437](#L437) | $current\_options = get\_option( $option ); |
| [438](#L438) |  |
| [439](#L439) | if ( $current\_options ) { |
| [440](#L440) | $merged = array\_replace( $current\_options, $post\_data[ $option ] ); |
| [441](#L441) |  |
| [442](#L442) | update\_option( $option, $merged ); |
| [443](#L443) | } else { |
| [444](#L444) | update\_option( $option, $post\_data[ $option ] ); |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | /\*\* |
| [450](#L450) | \* Additional update actions can be added here. |
| [451](#L451) | \* |
| [452](#L452) | \* @since v4.6.0 |
| [453](#L453) | \*/ |
| [454](#L454) | do\_action( 'caos\_update\_settings' ); |
| [455](#L455) |  |
| [456](#L456) | // Redirect back to the settings page that was submitted. |
| [457](#L457) | $goback = add\_query\_arg( 'settings-updated', 'true', wp\_get\_referer() ); |
| [458](#L458) | wp\_redirect( $goback ); |
| [459](#L459) | exit; |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | /\*\* |
| [463](#L463) | \* Clean variables using `sanitize\_text\_field`. |
| [464](#L464) | \* Arrays are cleaned recursively. Non-scalar values are ignored. |
| [465](#L465) | \* |
| [466](#L466) | \* @param string|array $var Sanitize the variable. |
| [467](#L467) | \* |
| [468](#L468) | \* @since 4.6.0 |
| [469](#L469) | \* |
| [470](#L470) | \* @return string|array |
| [471](#L471) | \*/ |
| [472](#L472) | private function clean( $var ) { |
| [473](#L473) | if ( is\_array( $var ) ) { |
| [474](#L474) | return array\_map( [ \_\_CLASS\_\_, \_\_METHOD\_\_ ], $var ); |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | return is\_scalar( $var ) ? sanitize\_text\_field( wp\_unslash( $var ) ) : $var; |
| [478](#L478) | } |
| [479](#L479) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/host-analyticsjs-local/tags/4.7.12/includes/class-caos.php?format=txt)
* [Original Format](/export/3222443/host-analyticsjs-local/tags/4.7.12/includes/class-caos.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f0a36113_20250114_185158.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# CAOS | Host Google Analytics Locally <= 4.7.14 - Missing Authorization to Unauthenticated Plugin Settings Update

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   CAOS | Host Google Analytics Locally <= 4.7.14 - Missing Authorization to Unauthenticated Plugin Settings Update

6.5

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:L)

| CVE | [CVE-2023-6637](https://www.cve.org/CVERecord?id=CVE-2023-6637) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | December 12, 2023 |
| Last Updated | January 11, 2024 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The CAOS | Host Google Analytics Locally plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the 'update\_settings' function in versions up to, and including, 4.7.14. This makes it possible for unauthenticated attackers to update plugin settings.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/host-analyticsjs-local/tags/4.7.12/includes/class-caos.php#L414)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3008878/host-analyticsjs-local#file8)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3009011/host-analyticsjs-local#file5)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhost-analyticsjs-local%2Fcaos-host-google-analytics-locally-4714-missing-authorization-to-unauthenticated-plugin-settings-update&t=CAOS%20%7C%20Host%20Google%20Analytics%20Locally%20%3C%3D%204.7.14%20-%20Missing%20Authorization%20to%20Unauthenticated%20Plugin%20Settings%20Update "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhost-analyticsjs-local%2Fcaos-host-google-analytics-locally-4714-missing-authorization-to-unauthenticated-plugin-settings-update&text=CAOS%20%7C%20Host%20Google%20Analytics%20Locally%20%3C%3D%204.7.14%20-%20Missing%20Authorization%20to%20Unauthenticated%20Plugin%20Settings%20Update "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhost-analyticsjs-local%2Fcaos-host-google-analytics-locally-4714-missing-authorization-to-unauthenticated-plugin-settings-update "LinkedIn")
Email

## Vulnerability Details for CAOS | Host Google Analytics Locally

#### [CAOS | Host Google Analytics Locally](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/host-analyticsjs-local)

| Software Type | Plugin |
| --- | --- |
| Software Slug | host-analyticsjs-local [(view on wordpress.org)](https://wordpress.org/plugins/host-analyticsjs-local) |
| Patched? | Yes |
| Remediation | Update to version 4.7.15, or a newer patched version |
| Affected Version | * <= 4.7.14 |
| Patched Version | * 4.7.15 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_c8d54bb2_20250114_185154.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3008878%2Fhost-analyticsjs-local)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2992257/host-analyticsjs-local "Changeset 2992257 for host-analyticsjs-local")
* [Next Change](/changeset/3009003/host-analyticsjs-local "Changeset 3009003 for host-analyticsjs-local") →

---

# Changeset [3008878](/changeset/3008878 "Show full changeset") for [host-analyticsjs-local](/browser/host-analyticsjs-local?rev=3008878 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
12/12/2023 03:17:13 PM
([13 months](/timeline?from=2023-12-12T15%3A17%3A13Z&precision=second "See timeline at 12/12/2023 03:17:13 PM") ago)

Author:
DaanvandenBergh
Message:

Update to version 4.7.13 from GitHub

Location:
[host-analyticsjs-local](/browser/host-analyticsjs-local?rev=3008878)
Files:

2 deleted
8 edited
1 copied

* [tags/4.7.13](/browser/host-analyticsjs-local/tags/4.7.13?rev=3008878 "Show entry in browser")
  (copied)
  *(copied from [host-analyticsjs-local/trunk](/browser/host-analyticsjs-local/trunk?rev=2992257 "Show original file (revision 3008877)"))*
* [tags/4.7.13/assets/js/detect-ad-block.js](/browser/host-analyticsjs-local/trunk/assets/js/detect-ad-block.js?rev=2657748 "Show what was removed (content at revision 3008877)")
  (deleted)
* [tags/4.7.13/host-analyticsjs-local.php](/browser/host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file2 "Show differences"))
* [tags/4.7.13/includes/class-caos.php](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878 "Show entry in browser")
  (modified)
  ([13 diffs](#file3 "Show differences"))
* [tags/4.7.13/includes/class-cron.php](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-cron.php?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file4 "Show differences"))
* [tags/4.7.13/readme.txt](/browser/host-analyticsjs-local/tags/4.7.13/readme.txt?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [trunk/assets/js/detect-ad-block.js](/browser/host-analyticsjs-local/trunk/assets/js/detect-ad-block.js?rev=2657748 "Show what was removed (content at revision 3008877)")
  (deleted)
* [trunk/host-analyticsjs-local.php](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [trunk/includes/class-caos.php](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878 "Show entry in browser")
  (modified)
  ([13 diffs](#file8 "Show differences"))
* [trunk/includes/class-cron.php](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [trunk/readme.txt](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3008878 "Show entry in browser")
  (modified)
  ([2 diffs](#file10 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php](/changeset/3008878/host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php "Show the changeset 3008878 restricted to host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php")

  | [r2992257](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=2992257#L4 "Show revision 2992257 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php?rev=3008878#L4 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://daan.dev/wordpress/caos/ |
  | 5 | 5 | \* Description: Completely optimize Google Analytics 4 for your WordPress Website - host gtag.js locally or use Minimal Analytics and much more! |
  | 6 |  | \* Version: 4.7.1~~2~~ |
  |  | 6 | \* Version: 4.7.13 |
  | 7 | 7 | \* Author: Daan from Daan.dev |
  | 8 | 8 | \* Author URI: https://daan.dev/ |
  | […](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=2992257#L29) | […](/browser/host-analyticsjs-local/tags/4.7.13/host-analyticsjs-local.php?rev=3008878#L29) |  |
  | 29 | 29 | $path = explode( '\_', $class ); |
  | 30 | 30 |  |
  | 31 |  | if ( $path[~~0~~] != 'CAOS' ) { |
  |  | 31 | if ( $path[ 0 ] != 'CAOS' ) { |
  | 32 | 32 | return; |
  | 33 | 33 | } |
* ## [host-analyticsjs-local/tags/4.7.13/includes/class-caos.php](/changeset/3008878/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php "Show the changeset 3008878 restricted to host-analyticsjs-local/tags/4.7.13/includes/class-caos.php")

  | [r2981201](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L15 "Show revision 2981201 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L15 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | \* @license  : GPL2v2 or later |
  | 16 | 16 | \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \*/ |
  |  | 17 |  |
  | 17 | 18 | class CAOS { |
  | 18 | 19 | /\*\* |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L71) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L72) |  |
  | 71 | 72 |  |
  | 72 | 73 | /\*\* |
  | 73 |  | \* @since v4.7.3 |
  | 74 |  | \* |
  | 75 |  | \* @return string Absolute path to CAOS' cache directory. |
  | 76 |  | \*/ |
  | 77 |  | public static function get\_local\_dir() { |
  | 78 |  | return apply\_filters( 'caos\_local\_dir', WP\_CONTENT\_DIR . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) ); |
  |  | 74 | \* @return CAOS\_Setup |
  |  | 75 | \*/ |
  |  | 76 | private function do\_setup() { |
  |  | 77 | register\_uninstall\_hook( CAOS\_PLUGIN\_FILE, 'CAOS::do\_uninstall' ); |
  |  | 78 |  |
  |  | 79 | return new CAOS\_Setup(); |
  |  | 80 | } |
  |  | 81 |  |
  |  | 82 | /\*\* |
  |  | 83 | \* @param string $alias |
  |  | 84 | \* @param bool   $write |
  |  | 85 | \* |
  |  | 86 | \* @return bool |
  |  | 87 | \*/ |
  |  | 88 | public static function set\_file\_alias( $alias, $write = false ) { |
  |  | 89 | $file\_aliases = self::get\_file\_aliases(); |
  |  | 90 |  |
  |  | 91 | $file\_aliases[ 'gtag' ] = $alias; |
  |  | 92 |  |
  |  | 93 | return self::set\_file\_aliases( $file\_aliases, $write ); |
  | 79 | 94 | } |
  | 80 | 95 |  |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L89) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L104) |  |
  | 89 | 104 |  |
  | 90 | 105 | /\*\* |
  | 91 |  | \* Get alias of JS library. |
  | 92 |  | \* |
  | 93 |  | \* @return string |
  | 94 |  | \*/ |
  | 95 |  | public static function get\_file\_alias() { |
  | 96 |  | $file\_aliases = self::get\_file\_aliases(); |
  | 97 |  |  |
  | 98 |  | if ( ! $file\_aliases ) { |
  | 99 |  | return ''; |
  | 100 |  | } |
  | 101 |  |  |
  | 102 |  | return $file\_aliases['gtag'] ?? ''; |
  | 103 |  | } |
  | 104 |  |  |
  | 105 |  | /\*\* |
  | 106 |  | \* @param  array $file\_aliases |
  | 107 |  | \* @param  bool  $write |
  |  | 106 | \* @param array $file\_aliases |
  |  | 107 | \* @param bool  $write |
  |  | 108 | \* |
  | 108 | 109 | \* @return bool |
  | 109 | 110 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L124) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L125) |  |
  | 124 | 125 |  |
  | 125 | 126 | /\*\* |
  | 126 |  | ~~\* @param  string $alias~~ |
  | 127 |  | ~~\* @param  bool   $write~~ |
  | 128 |  | ~~\* @return bool~~ |
  | 129 |  | ~~\*/~~ |
  | 130 |  | ~~public static function set\_file\_alias( $alias, $write = false ) {~~ |
  | 131 |  | ~~$file\_aliases = self::get\_file\_aliases();~~ |
  | 132 |  |  |
  | 133 |  | ~~$file\_aliases['gtag'] = $alias;~~ |
  | 134 |  |  |
  | 135 |  | ~~return self::set\_file\_aliases( $file\_aliases, $write );~~ |
  | 136 |  | ~~}~~ |
  | 137 |  |  |
  | 138 |  | ~~/\*\*~~ |
  | 139 | 127 | \* Includes backwards compatibility for pre 3.11.0 |
  | 140 |  | ~~\*~~ |
  | 141 | 128 | \* @since 3.11.0 |
  | 142 |  | ~~\*~~ |
  | 143 | 129 | \* @return string|void |
  | 144 | 130 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L162) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L148) |  |
  | 162 | 148 |  |
  | 163 | 149 | /\*\* |
  |  | 150 | \* @since v4.7.3 |
  |  | 151 | \* @return string Absolute path to CAOS' cache directory. |
  |  | 152 | \*/ |
  |  | 153 | public static function get\_local\_dir() { |
  |  | 154 | return apply\_filters( 'caos\_local\_dir', WP\_CONTENT\_DIR . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) ); |
  |  | 155 | } |
  |  | 156 |  |
  |  | 157 | /\*\* |
  |  | 158 | \* Method to retrieve settings from database. |
  |  | 159 | \* @filter caos\_setting\_{$name} |
  |  | 160 | \* @since  v4.5.1 |
  |  | 161 | \* |
  |  | 162 | \* @param mixed  $default (optional) The option's default value if it isn't set (yet). |
  |  | 163 | \* @param string $name    Any constant from the CAOS\_Admin\_Settings class. |
  |  | 164 | \* |
  |  | 165 | \* @return mixed |
  |  | 166 | \*/ |
  |  | 167 | public static function get( $name, $default = null ) { |
  |  | 168 | $value = self::get\_settings()[ $name ] ?? ''; |
  |  | 169 |  |
  |  | 170 | if ( empty( $value ) && $default !== null ) { |
  |  | 171 | $value = $default; |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | /\*\* |
  |  | 175 | \* This allows for WPML (and similar plugins) to use different tracking IDs on different languages/sites. |
  |  | 176 | \*/ |
  |  | 177 | if ( $name === CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_MEASUREMENT\_ID ) { |
  |  | 178 | $translated\_tracking\_id = \_x( 'G-123ABC789', 'Define a different Measurement ID for this language/site.', 'host-analyticsjs-local' ); |
  |  | 179 |  |
  |  | 180 | if ( $translated\_tracking\_id !== 'G-123ABC789' ) { |
  |  | 181 | $value = $translated\_tracking\_id; |
  |  | 182 | } |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | return apply\_filters( "caos\_setting\_$name", $value ); |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | /\*\* |
  |  | 189 | \* Gets all settings for CAOS. |
  |  | 190 | \* @since 4.5.1 |
  |  | 191 | \* @return array |
  |  | 192 | \*/ |
  |  | 193 | public static function get\_settings() { |
  |  | 194 | static $settings; |
  |  | 195 |  |
  |  | 196 | if ( empty( $settings ) ) { |
  |  | 197 | $settings = get\_option( 'caos\_settings', [] ); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | return apply\_filters( 'caos\_settings', $settings ); |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | /\*\* |
  |  | 204 | \* Get alias of JS library. |
  |  | 205 | \* @return string |
  |  | 206 | \*/ |
  |  | 207 | public static function get\_file\_alias() { |
  |  | 208 | $file\_aliases = self::get\_file\_aliases(); |
  |  | 209 |  |
  |  | 210 | if ( ! $file\_aliases ) { |
  |  | 211 | return ''; |
  |  | 212 | } |
  |  | 213 |  |
  |  | 214 | return $file\_aliases[ 'gtag' ] ?? ''; |
  |  | 215 | } |
  |  | 216 |  |
  |  | 217 | /\*\* |
  | 164 | 218 | \* Global debug logging function. |
  | 165 | 219 | \* |
  | 166 |  | \* @param  mixed $message |
  |  | 220 | \* @param mixed $message |
  |  | 221 | \* |
  | 167 | 222 | \* @return void |
  | 168 | 223 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L177) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L232) |  |
  | 177 | 232 |  |
  | 178 | 233 | /\*\* |
  | 179 |  | \* @return CAOS\_Setup |
  | 180 |  | \*/ |
  | 181 |  | private function do\_setup() { |
  | 182 |  | register\_uninstall\_hook( CAOS\_PLUGIN\_FILE, 'CAOS::do\_uninstall' ); |
  | 183 |  |  |
  | 184 |  | return new CAOS\_Setup(); |
  |  | 234 | \* Returns early if File Aliases option doesn't exist for Backwards Compatibility. |
  |  | 235 | \* @since 3.11.0 |
  |  | 236 | \* @return string |
  |  | 237 | \*/ |
  |  | 238 | public static function get\_local\_file\_url() { |
  |  | 239 | $url = content\_url() . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) . 'gtag.js'; |
  |  | 240 |  |
  |  | 241 | /\*\* |
  |  | 242 | \* is\_ssl() fails when behind a load balancer or reverse proxy. That's why we double check here if |
  |  | 243 | \* SSL is enabled and rewrite accordingly. |
  |  | 244 | \*/ |
  |  | 245 | if ( strpos( home\_url(), 'https://' ) !== false && ! is\_ssl() ) { |
  |  | 246 | $url = str\_replace( 'http://', 'https://', $url ); |
  |  | 247 | } |
  |  | 248 |  |
  |  | 249 | if ( self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ) ) { |
  |  | 250 | $url = str\_replace( get\_home\_url( get\_current\_blog\_id() ), '//' . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ), $url ); |
  |  | 251 | } |
  |  | 252 |  |
  |  | 253 | $file\_alias = self::get\_file\_alias(); |
  |  | 254 |  |
  |  | 255 | if ( ! $file\_alias ) { |
  |  | 256 | return $url; |
  |  | 257 | } |
  |  | 258 |  |
  |  | 259 | $url = str\_replace( 'gtag.js', $file\_alias, $url ); |
  |  | 260 |  |
  |  | 261 | return apply\_filters( 'caos\_local\_file\_url', $url ); |
  |  | 262 | } |
  |  | 263 |  |
  |  | 264 | /\*\* |
  |  | 265 | \* @return CAOS\_Uninstall |
  |  | 266 | \* @throws ReflectionException |
  |  | 267 | \*/ |
  |  | 268 | public static function do\_uninstall() { |
  |  | 269 | return new CAOS\_Uninstall(); |
  |  | 270 | } |
  |  | 271 |  |
  |  | 272 | /\*\* |
  |  | 273 | \* File downloader |
  |  | 274 | \* |
  |  | 275 | \* @param mixed  $local\_file |
  |  | 276 | \* @param mixed  $remote\_file |
  |  | 277 | \* @param string $file |
  |  | 278 | \* |
  |  | 279 | \* @return string |
  |  | 280 | \*/ |
  |  | 281 | public static function download\_file( $remote\_file, $file = '' ) { |
  |  | 282 | $download = new CAOS\_FileManager(); |
  |  | 283 |  |
  |  | 284 | return $download->download\_file( $remote\_file, $file ); |
  |  | 285 | } |
  |  | 286 |  |
  |  | 287 | /\*\* |
  |  | 288 | \* @param string $path |
  |  | 289 | \* |
  |  | 290 | \* @return bool |
  |  | 291 | \*/ |
  |  | 292 | public static function create\_dir\_r( $path ) { |
  |  | 293 | $file\_manager = new CAOS\_FileManager(); |
  |  | 294 |  |
  |  | 295 | return $file\_manager->create\_dir\_recursive( $path ); |
  |  | 296 | } |
  |  | 297 |  |
  |  | 298 | /\*\* |
  |  | 299 | \* @param string $file |
  |  | 300 | \* @param string $find |
  |  | 301 | \* @param string $replace |
  |  | 302 | \* |
  |  | 303 | \* @return int|false |
  |  | 304 | \*/ |
  |  | 305 | public static function find\_replace\_in( $file, $find, $replace ) { |
  |  | 306 | $file\_manager = new CAOS\_FileManager(); |
  |  | 307 |  |
  |  | 308 | return $file\_manager->find\_replace\_in( $file, $find, $replace ); |
  |  | 309 | } |
  |  | 310 |  |
  |  | 311 | /\*\* |
  |  | 312 | \* |
  |  | 313 | \*/ |
  |  | 314 | public static function uses\_minimal\_analytics() { |
  |  | 315 | return self::get( CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_TRACKING\_CODE ) === 'minimal\_ga4'; |
  |  | 316 | } |
  |  | 317 |  |
  |  | 318 | /\*\* |
  |  | 319 | \* Check if (de)activated plugin is CAOS Pro and if so, update. |
  |  | 320 | \*/ |
  |  | 321 | public function maybe\_do\_update( $plugin ) { |
  |  | 322 | if ( strpos( $plugin, self::CAOS\_PRO\_PLUGIN\_SLUG ) === false ) { |
  |  | 323 | return; |
  |  | 324 | } |
  |  | 325 |  |
  |  | 326 | $this->trigger\_cron\_script(); |
  | 185 | 327 | } |
  | 186 | 328 |  |
  | 187 | 329 | /\*\* |
  | 188 | 330 | \* Triggers when CAOS (Pro) is (de)activated. |
  | 189 |  | ~~\*~~ |
  | 190 | 331 | \* @return CAOS\_Cron |
  | 191 | 332 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L195) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L336) |  |
  | 195 | 336 |  |
  | 196 | 337 | /\*\* |
  | 197 |  | ~~\* Check if (de)activated plugin is CAOS Pro and if so, update.~~ |
  | 198 |  | ~~\*/~~ |
  | 199 |  | ~~public function maybe\_do\_update( $plugin ) {~~ |
  | 200 |  | ~~if ( strpos( $plugin, self::CAOS\_PRO\_PLUGIN\_SLUG ) === false ) {~~ |
  | 201 |  | ~~return;~~ |
  | 202 |  | ~~}~~ |
  | 203 |  |  |
  | 204 |  | ~~$this->trigger\_cron\_script();~~ |
  | 205 |  | ~~}~~ |
  | 206 |  |  |
  | 207 |  | ~~/\*\*~~ |
  | 208 | 338 | \* @return CAOS\_Admin\_UpdateFiles |
  | 209 | 339 | \*/ |
  | 210 | 340 | public function do\_update\_after\_save() { |
  | 211 |  | $settings\_page    = $\_GET[~~'page'~~] ?? ''; |
  | 212 |  | $settings\_updated = $\_GET[~~'settings-updated'~~] ?? ''; |
  |  | 341 | $settings\_page    = $\_GET[ 'page' ] ?? ''; |
  |  | 342 | $settings\_updated = $\_GET[ 'settings-updated' ] ?? ''; |
  | 213 | 343 |  |
  | 214 | 344 | if ( CAOS\_Admin\_Settings::CAOS\_ADMIN\_PAGE !== $settings\_page ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L222) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L352) |  |
  | 222 | 352 | /\*\* |
  | 223 | 353 | \* No need to update any files if we're using Minimal Analytics. Can't believe I'm only finding out about this now... |
  | 224 |  | ~~\*~~ |
  | 225 | 354 | \* @since 4.7.0 |
  | 226 | 355 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L235) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L364) |  |
  | 235 | 364 | \* Render update notices if available. |
  | 236 | 365 | \* |
  | 237 |  | \* @param  mixed $plugin |
  | 238 |  | \* @param  mixed $response |
  |  | 366 | \* @param mixed $plugin |
  |  | 367 | \* @param mixed $response |
  |  | 368 | \* |
  | 239 | 369 | \* @return void |
  | 240 | 370 | \*/ |
  | 241 | 371 | public function render\_update\_notice( $plugin, $response ) { |
  | 242 |  | $current\_version = $plugin[~~'Version'~~]; |
  | 243 |  | $new\_version     = $plugin[~~'new\_version'~~]; |
  |  | 372 | $current\_version = $plugin[ 'Version' ]; |
  |  | 373 | $new\_version     = $plugin[ 'new\_version' ]; |
  | 244 | 374 |  |
  | 245 | 375 | if ( version\_compare( $current\_version, $new\_version, '<' ) ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L257) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L387) |  |
  | 257 | 387 |  |
  | 258 | 388 | printf( |
  | 259 |  | ' <strong>' . \_\_( 'This update includes major changes. Please <a href="%s" target="\_blank">read this</a> before updating.', 'host-analyticsjs-local' ) . '</strong>', |
  |  | 389 | ' <strong>' . \_\_( |
  |  | 390 | 'This update includes major changes. Please <a href="%s" target="\_blank">read this</a> before updating.', |
  |  | 391 | 'host-analyticsjs-local' |
  |  | 392 | ) . '</strong>', |
  | 260 | 393 | $update\_notices[ $new\_version ]->url |
  | 261 | 394 | ); |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L264) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L397) |  |
  | 264 | 397 |  |
  | 265 | 398 | /\*\* |
  | 266 |  | ~~\* Returns early if File Aliases option doesn't exist for Backwards Compatibility.~~ |
  | 267 |  | ~~\*~~ |
  | 268 |  | ~~\* @since 3.11.0~~ |
  | 269 |  | ~~\*~~ |
  | 270 |  | ~~\* @return string~~ |
  | 271 |  | ~~\*/~~ |
  | 272 |  | ~~public static function get\_local\_file\_url() {~~ |
  | 273 |  | ~~$url = content\_url() . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) . 'gtag.js';~~ |
  | 274 |  |  |
  | 275 |  | ~~/\*\*~~ |
  | 276 |  | ~~\* is\_ssl() fails when behind a load balancer or reverse proxy. That's why we double check here if~~ |
  | 277 |  | ~~\* SSL is enabled and rewrite accordingly.~~ |
  | 278 |  | ~~\*/~~ |
  | 279 |  | ~~if ( strpos( home\_url(), 'https://' ) !== false && ! is\_ssl() ) {~~ |
  | 280 |  | ~~$url = str\_replace( 'http://', 'https://', $url );~~ |
  | 281 |  | ~~}~~ |
  | 282 |  |  |
  | 283 |  | ~~if ( self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ) ) {~~ |
  | 284 |  | ~~$url = str\_replace( get\_home\_url( get\_current\_blog\_id() ), '//' . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ), $url );~~ |
  | 285 |  | ~~}~~ |
  | 286 |  |  |
  | 287 |  | ~~$file\_alias = self::get\_file\_alias();~~ |
  | 288 |  |  |
  | 289 |  | ~~if ( ! $file\_alias ) {~~ |
  | 290 |  | ~~return $url;~~ |
  | 291 |  | ~~}~~ |
  | 292 |  |  |
  | 293 |  | ~~$url = str\_replace( 'gtag.js', $file\_alias, $url );~~ |
  | 294 |  |  |
  | 295 |  | ~~return apply\_filters( 'caos\_local\_file\_url', $url );~~ |
  | 296 |  | ~~}~~ |
  | 297 |  |  |
  | 298 |  | ~~/\*\*~~ |
  | 299 |  | ~~\* @return CAOS\_Uninstall~~ |
  | 300 |  | ~~\* @throws ReflectionException~~ |
  | 301 |  | ~~\*/~~ |
  | 302 |  | ~~public static function do\_uninstall() {~~ |
  | 303 |  | ~~return new CAOS\_Uninstall();~~ |
  | 304 |  | ~~}~~ |
  | 305 |  |  |
  | 306 |  | ~~/\*\*~~ |
  | 307 |  | ~~\* File downloader~~ |
  | 308 |  | ~~\*~~ |
  | 309 |  | ~~\* @param mixed  $local\_file~~ |
  | 310 |  | ~~\* @param mixed  $remote\_file~~ |
  | 311 |  | ~~\* @param string $file~~ |
  | 312 |  | ~~\* @param bool   $is\_plugin~~ |
  | 313 |  | ~~\*~~ |
  | 314 |  | ~~\* @return string~~ |
  | 315 |  | ~~\*/~~ |
  | 316 |  | ~~public static function download\_file(~~ |
  | 317 |  | ~~$remote\_file,~~ |
  | 318 |  | ~~$file = ''~~ |
  | 319 |  | ~~) {~~ |
  | 320 |  | ~~$download = new CAOS\_FileManager();~~ |
  | 321 |  |  |
  | 322 |  | ~~return $download->download\_file( $remote\_file, $file );~~ |
  | 323 |  | ~~}~~ |
  | 324 |  |  |
  | 325 |  | ~~/\*\*~~ |
  | 326 |  | ~~\* @param string $path~~ |
  | 327 |  | ~~\*~~ |
  | 328 |  | ~~\* @return bool~~ |
  | 329 |  | ~~\*/~~ |
  | 330 |  | ~~public static function create\_dir\_r( $path ) {~~ |
  | 331 |  | ~~$file\_manager = new CAOS\_FileManager();~~ |
  | 332 |  |  |
  | 333 |  | ~~return $file\_manager->create\_dir\_recursive( $path );~~ |
  | 334 |  | ~~}~~ |
  | 335 |  |  |
  | 336 |  | ~~/\*\*~~ |
  | 337 |  | ~~\* @param string $file~~ |
  | 338 |  | ~~\* @param string $find~~ |
  | 339 |  | ~~\* @param string $replace~~ |
  | 340 |  | ~~\*~~ |
  | 341 |  | ~~\* @return int|false~~ |
  | 342 |  | ~~\*/~~ |
  | 343 |  | ~~public static function find\_replace\_in( $file, $find, $replace ) {~~ |
  | 344 |  | ~~$file\_manager = new CAOS\_FileManager();~~ |
  | 345 |  |  |
  | 346 |  | ~~return $file\_manager->find\_replace\_in( $file, $find, $replace );~~ |
  | 347 |  | ~~}~~ |
  | 348 |  |  |
  | 349 |  | ~~/\*\*~~ |
  | 350 |  | ~~\*~~ |
  | 351 |  | ~~\*/~~ |
  | 352 |  | ~~public static function uses\_minimal\_analytics() {~~ |
  | 353 |  | ~~return self::get( CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_TRACKING\_CODE ) === 'minimal\_ga4';~~ |
  | 354 |  | ~~}~~ |
  | 355 |  |  |
  | 356 |  | ~~/\*\*~~ |
  | 357 |  | ~~\* Method to retrieve settings from database.~~ |
  | 358 |  | ~~\*~~ |
  | 359 |  | ~~\* @filter caos\_setting\_{$name}~~ |
  | 360 |  | ~~\*~~ |
  | 361 |  | ~~\* @param string $name               Any constant from the CAOS\_Admin\_Settings class.~~ |
  | 362 |  | ~~\* @param mixed  $default (optional) The option's default value if it isn't set (yet).~~ |
  | 363 |  | ~~\*~~ |
  | 364 |  | ~~\* @since v4.5.1~~ |
  | 365 |  | ~~\*~~ |
  | 366 |  | ~~\* @return mixed~~ |
  | 367 |  | ~~\*/~~ |
  | 368 |  | ~~public static function get( $name, $default = null ) {~~ |
  | 369 |  | ~~$value = self::get\_settings()[ $name ] ?? '';~~ |
  | 370 |  |  |
  | 371 |  | ~~if ( empty( $value ) && $default !== null ) {~~ |
  | 372 |  | ~~$value = $default;~~ |
  | 373 |  | ~~}~~ |
  | 374 |  |  |
  | 375 |  | ~~/\*\*~~ |
  | 376 |  | ~~\* This allows for WPML (and similar plugins) to use different tracking IDs on different languages/sites.~~ |
  | 377 |  | ~~\*/~~ |
  | 378 |  | ~~if ( $name === CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_MEASUREMENT\_ID ) {~~ |
  | 379 |  | ~~$translated\_tracking\_id = \_x( 'G-123ABC789', 'Define a different Measurement ID for this language/site.', 'host-analyticsjs-local' );~~ |
  | 380 |  |  |
  | 381 |  | ~~if ( $translated\_tracking\_id !== 'G-123ABC789' ) {~~ |
  | 382 |  | ~~$value = $translated\_tracking\_id;~~ |
  | 383 |  | ~~}~~ |
  | 384 |  | ~~}~~ |
  | 385 |  |  |
  | 386 |  | ~~return apply\_filters( "caos\_setting\_$name", $value );~~ |
  | 387 |  | ~~}~~ |
  | 388 |  |  |
  | 389 |  | ~~/\*\*~~ |
  | 390 |  | ~~\* Gets all settings for CAOS.~~ |
  | 391 |  | ~~\*~~ |
  | 392 |  | ~~\* @since 4.5.1~~ |
  | 393 |  | ~~\*~~ |
  | 394 |  | ~~\* @return array~~ |
  | 395 |  | ~~\*/~~ |
  | 396 |  | ~~public static function get\_settings() {~~ |
  | 397 |  | ~~static $settings;~~ |
  | 398 |  |  |
  | 399 |  | ~~if ( empty( $settings ) ) {~~ |
  | 400 |  | ~~$settings = get\_option( 'caos\_settings', [] );~~ |
  | 401 |  | ~~}~~ |
  | 402 |  |  |
  | 403 |  | ~~return apply\_filters( 'caos\_settings', $settings );~~ |
  | 404 |  | ~~}~~ |
  | 405 |  |  |
  | 406 |  | ~~/\*\*~~ |
  | 407 | 399 | \* We use a custom update action, because we're storing multidimensional arrays upon form submit. |
  | 408 |  | ~~\*~~ |
  | 409 | 400 | \* This prevents us from having to use AJAX, serialize(), stringify() and eventually having to json\_decode() it, i.e. |
  | 410 | 401 | \* a lot of headaches. |
  | 411 |  | ~~\*~~ |
  | 412 | 402 | \* @since v4.6.0 |
  | 413 | 403 | \*/ |
  | 414 | 404 | public function update\_settings() { |
  | 415 |  | ~~// phpcs:ignore WordPress.Security~~ |
  | 416 |  | if ( empty( $\_POST['action'] ) || $\_POST['action'] !== 'caos-update' ) { |
  | 417 |  | ~~return~~; |
  | 418 |  | } |
  | 419 |  |  |
  | 420 |  | ~~// phpcs:ignore~~ |
  | 421 |  | ~~$post\_data = $this->clean($\_POST);~~ |
  | 422 |  |  |
  | 423 |  | ~~$options = apply\_filters(~~ |
  | 424 |  | ~~/\*\*~~ |
  | 425 |  | ~~\* Any options that're better off in their own DB row (e.g. due to size) can be added using this filter.~~ |
  | 426 |  | \* |
  | 427 |  | ~~\* @since v4.6.0~~ |
  | 428 |  | \*/ |
  | 429 |  | ~~'caos\_update\_settings\_serialized',~~ |
  | 430 |  | ~~[~~ |
  | 431 |  | ~~'caos\_settings',~~ |
  | 432 |  | ~~]~~ |
  | 433 |  | ); |
  |  | 405 | $action = $\_GET[ 'tab' ] ?? 'caos-basic-settings'; |
  |  | 406 |  |
  |  | 407 | wp\_verify\_nonce( $\_POST[ '\_wpnonce' ], $action ); |
  |  | 408 |  |
  |  | 409 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 410 | return; |
  |  | 411 | } |
  |  | 412 |  |
  |  | 413 | if ( empty( $\_POST[ 'action' ] ) || $\_POST[ 'action' ] !== 'caos-update' ) { |
  |  | 414 | return; |
  |  | 415 | } |
  |  | 416 |  |
  |  | 417 | $post\_data = $this->clean( $\_POST ); |
  |  | 418 |  |
  |  | 419 | /\*\* |
  |  | 420 | \* Any options that're better off in their own DB row (e.g. due to size) can be added using this filter. |
  |  | 421 | \* @since v4.6.0 |
  |  | 422 | \*/ |
  |  | 423 | $options = apply\_filters( 'caos\_update\_settings\_serialized', [ 'caos\_settings', ] ); |
  | 434 | 424 |  |
  | 435 | 425 | foreach ( $options as $option ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L449) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L439) |  |
  | 449 | 439 | /\*\* |
  | 450 | 440 | \* Additional update actions can be added here. |
  | 451 |  | ~~\*~~ |
  | 452 | 441 | \* @since v4.6.0 |
  | 453 | 442 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L463) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-caos.php?rev=3008878#L452) |  |
  | 463 | 452 | \* Clean variables using `sanitize\_text\_field`. |
  | 464 | 453 | \* Arrays are cleaned recursively. Non-scalar values are ignored. |
  |  | 454 | \* @since 4.6.0 |
  | 465 | 455 | \* |
  | 466 | 456 | \* @param string|array $var Sanitize the variable. |
  | 467 |  | ~~\*~~ |
  | 468 |  | ~~\* @since 4.6.0~~ |
  | 469 | 457 | \* |
  | 470 | 458 | \* @return string|array |
* ## [host-analyticsjs-local/tags/4.7.13/includes/class-cron.php](/changeset/3008878/host-analyticsjs-local/tags/4.7.13/includes/class-cron.php "Show the changeset 3008878 restricted to host-analyticsjs-local/tags/4.7.13/includes/class-cron.php")

  | [r2945403](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=2945403#L40 "Show revision 2945403 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-cron.php?rev=3008878#L40 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 40 | 40 | $downloaded\_files = $this->download(); |
  | 41 | 41 |  |
  | 42 |  | // Only sent a success message if this is a AJAX request. |
  |  | 42 | // Only sent a success message if this is an AJAX request. |
  | 43 | 43 | if ( ! wp\_doing\_cron() && ! empty( $downloaded\_files ) ) { |
  | 44 | 44 | $review\_link = apply\_filters( 'caos\_manual\_download\_review\_link', $this->review ); |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=2945403#L49) | […](/browser/host-analyticsjs-local/tags/4.7.13/includes/class-cron.php?rev=3008878#L49) |  |
  | 49 | 49 | ); |
  | 50 | 50 |  |
  | 51 |  | CAOS\_Admin\_Notice::set\_notice( $notice . ' ' . sprintf( \_\_( 'Would you be willing to <a href="%1$s" target="\_blank">write a review</a> or <a href="%2$s" target="\_blank">tweet</a> about it?', 'host-analyticsjs-local' ), $review\_link, $tweet\_link ), 'success', 'all', 'file\_downloaded' ); |
  |  | 51 | CAOS\_Admin\_Notice::set\_notice( |
  |  | 52 | $notice . |
  |  | 53 | ' ' . |
  |  | 54 | sprintf( |
  |  | 55 | \_\_( |
  |  | 56 | 'Would you be willing to <a href="%1$s" target="\_blank">write a review</a> or <a href="%2$s" target="\_blank">tweet</a> about it?', |
  |  | 57 | 'host-analyticsjs-local' |
  |  | 58 | ), |
  |  | 59 | $review\_link, |
  |  | 60 | $tweet\_link |
  |  | 61 | ), |
  |  | 62 | 'success', |
  |  | 63 | 'all', |
  |  | 64 | 'file\_downloaded' |
  |  | 65 | ); |
  | 52 | 66 | } |
  | 53 | 67 | } |
* ## [host-analyticsjs-local/tags/4.7.13/readme.txt](/changeset/3008878/host-analyticsjs-local/tags/4.7.13/readme.txt "Show the changeset 3008878 restricted to host-analyticsjs-local/tags/4.7.13/readme.txt")

  | [r2992257](/browser/host-analyticsjs-local/trunk/readme.txt?rev=2992257#L4 "Show revision 2992257 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/tags/4.7.13/readme.txt?rev=3008878#L4 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.4 |
  | 6 |  | Stable tag: 4.7.1~~2~~ |
  |  | 6 | Stable tag: 4.7.13 |
  | 7 | 7 | Requires PHP: 7.0 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=2992257#L77) | […](/browser/host-analyticsjs-local/tags/4.7.13/readme.txt?rev=3008878#L77) |  |
  | 77 | 77 | == Changelog == |
  | 78 | 78 |  |
  |  | 79 | = 4.7.13 | December 12th, 2023 = |
  |  | 80 | \* Fixed: CSRF issue in custom Update Settings logic. |
  |  | 81 |  |
  | 79 | 82 | = 4.7.12 | November 8th, 2023 = |
  | 80 | 83 | \* Tested with WP 6.4 |
* ## [host-analyticsjs-local/trunk/host-analyticsjs-local.php](/changeset/3008878/host-analyticsjs-local/trunk/host-analyticsjs-local.php "Show the changeset 3008878 restricted to host-analyticsjs-local/trunk/host-analyticsjs-local.php")

  | [r2992257](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=2992257#L4 "Show revision 2992257 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3008878#L4 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | \* Plugin URI: https://daan.dev/wordpress/caos/ |
  | 5 | 5 | \* Description: Completely optimize Google Analytics 4 for your WordPress Website - host gtag.js locally or use Minimal Analytics and much more! |
  | 6 |  | \* Version: 4.7.1~~2~~ |
  |  | 6 | \* Version: 4.7.13 |
  | 7 | 7 | \* Author: Daan from Daan.dev |
  | 8 | 8 | \* Author URI: https://daan.dev/ |
  | […](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=2992257#L29) | […](/browser/host-analyticsjs-local/trunk/host-analyticsjs-local.php?rev=3008878#L29) |  |
  | 29 | 29 | $path = explode( '\_', $class ); |
  | 30 | 30 |  |
  | 31 |  | if ( $path[~~0~~] != 'CAOS' ) { |
  |  | 31 | if ( $path[ 0 ] != 'CAOS' ) { |
  | 32 | 32 | return; |
  | 33 | 33 | } |
* ## [host-analyticsjs-local/trunk/includes/class-caos.php](/changeset/3008878/host-analyticsjs-local/trunk/includes/class-caos.php "Show the changeset 3008878 restricted to host-analyticsjs-local/trunk/includes/class-caos.php")

  | [r2981201](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L15 "Show revision 2981201 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L15 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 15 | 15 | \* @license  : GPL2v2 or later |
  | 16 | 16 | \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \* \*/ |
  |  | 17 |  |
  | 17 | 18 | class CAOS { |
  | 18 | 19 | /\*\* |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L71) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L72) |  |
  | 71 | 72 |  |
  | 72 | 73 | /\*\* |
  | 73 |  | \* @since v4.7.3 |
  | 74 |  | \* |
  | 75 |  | \* @return string Absolute path to CAOS' cache directory. |
  | 76 |  | \*/ |
  | 77 |  | public static function get\_local\_dir() { |
  | 78 |  | return apply\_filters( 'caos\_local\_dir', WP\_CONTENT\_DIR . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) ); |
  |  | 74 | \* @return CAOS\_Setup |
  |  | 75 | \*/ |
  |  | 76 | private function do\_setup() { |
  |  | 77 | register\_uninstall\_hook( CAOS\_PLUGIN\_FILE, 'CAOS::do\_uninstall' ); |
  |  | 78 |  |
  |  | 79 | return new CAOS\_Setup(); |
  |  | 80 | } |
  |  | 81 |  |
  |  | 82 | /\*\* |
  |  | 83 | \* @param string $alias |
  |  | 84 | \* @param bool   $write |
  |  | 85 | \* |
  |  | 86 | \* @return bool |
  |  | 87 | \*/ |
  |  | 88 | public static function set\_file\_alias( $alias, $write = false ) { |
  |  | 89 | $file\_aliases = self::get\_file\_aliases(); |
  |  | 90 |  |
  |  | 91 | $file\_aliases[ 'gtag' ] = $alias; |
  |  | 92 |  |
  |  | 93 | return self::set\_file\_aliases( $file\_aliases, $write ); |
  | 79 | 94 | } |
  | 80 | 95 |  |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L89) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L104) |  |
  | 89 | 104 |  |
  | 90 | 105 | /\*\* |
  | 91 |  | \* Get alias of JS library. |
  | 92 |  | \* |
  | 93 |  | \* @return string |
  | 94 |  | \*/ |
  | 95 |  | public static function get\_file\_alias() { |
  | 96 |  | $file\_aliases = self::get\_file\_aliases(); |
  | 97 |  |  |
  | 98 |  | if ( ! $file\_aliases ) { |
  | 99 |  | return ''; |
  | 100 |  | } |
  | 101 |  |  |
  | 102 |  | return $file\_aliases['gtag'] ?? ''; |
  | 103 |  | } |
  | 104 |  |  |
  | 105 |  | /\*\* |
  | 106 |  | \* @param  array $file\_aliases |
  | 107 |  | \* @param  bool  $write |
  |  | 106 | \* @param array $file\_aliases |
  |  | 107 | \* @param bool  $write |
  |  | 108 | \* |
  | 108 | 109 | \* @return bool |
  | 109 | 110 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L124) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L125) |  |
  | 124 | 125 |  |
  | 125 | 126 | /\*\* |
  | 126 |  | ~~\* @param  string $alias~~ |
  | 127 |  | ~~\* @param  bool   $write~~ |
  | 128 |  | ~~\* @return bool~~ |
  | 129 |  | ~~\*/~~ |
  | 130 |  | ~~public static function set\_file\_alias( $alias, $write = false ) {~~ |
  | 131 |  | ~~$file\_aliases = self::get\_file\_aliases();~~ |
  | 132 |  |  |
  | 133 |  | ~~$file\_aliases['gtag'] = $alias;~~ |
  | 134 |  |  |
  | 135 |  | ~~return self::set\_file\_aliases( $file\_aliases, $write );~~ |
  | 136 |  | ~~}~~ |
  | 137 |  |  |
  | 138 |  | ~~/\*\*~~ |
  | 139 | 127 | \* Includes backwards compatibility for pre 3.11.0 |
  | 140 |  | ~~\*~~ |
  | 141 | 128 | \* @since 3.11.0 |
  | 142 |  | ~~\*~~ |
  | 143 | 129 | \* @return string|void |
  | 144 | 130 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L162) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L148) |  |
  | 162 | 148 |  |
  | 163 | 149 | /\*\* |
  |  | 150 | \* @since v4.7.3 |
  |  | 151 | \* @return string Absolute path to CAOS' cache directory. |
  |  | 152 | \*/ |
  |  | 153 | public static function get\_local\_dir() { |
  |  | 154 | return apply\_filters( 'caos\_local\_dir', WP\_CONTENT\_DIR . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) ); |
  |  | 155 | } |
  |  | 156 |  |
  |  | 157 | /\*\* |
  |  | 158 | \* Method to retrieve settings from database. |
  |  | 159 | \* @filter caos\_setting\_{$name} |
  |  | 160 | \* @since  v4.5.1 |
  |  | 161 | \* |
  |  | 162 | \* @param mixed  $default (optional) The option's default value if it isn't set (yet). |
  |  | 163 | \* @param string $name    Any constant from the CAOS\_Admin\_Settings class. |
  |  | 164 | \* |
  |  | 165 | \* @return mixed |
  |  | 166 | \*/ |
  |  | 167 | public static function get( $name, $default = null ) { |
  |  | 168 | $value = self::get\_settings()[ $name ] ?? ''; |
  |  | 169 |  |
  |  | 170 | if ( empty( $value ) && $default !== null ) { |
  |  | 171 | $value = $default; |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | /\*\* |
  |  | 175 | \* This allows for WPML (and similar plugins) to use different tracking IDs on different languages/sites. |
  |  | 176 | \*/ |
  |  | 177 | if ( $name === CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_MEASUREMENT\_ID ) { |
  |  | 178 | $translated\_tracking\_id = \_x( 'G-123ABC789', 'Define a different Measurement ID for this language/site.', 'host-analyticsjs-local' ); |
  |  | 179 |  |
  |  | 180 | if ( $translated\_tracking\_id !== 'G-123ABC789' ) { |
  |  | 181 | $value = $translated\_tracking\_id; |
  |  | 182 | } |
  |  | 183 | } |
  |  | 184 |  |
  |  | 185 | return apply\_filters( "caos\_setting\_$name", $value ); |
  |  | 186 | } |
  |  | 187 |  |
  |  | 188 | /\*\* |
  |  | 189 | \* Gets all settings for CAOS. |
  |  | 190 | \* @since 4.5.1 |
  |  | 191 | \* @return array |
  |  | 192 | \*/ |
  |  | 193 | public static function get\_settings() { |
  |  | 194 | static $settings; |
  |  | 195 |  |
  |  | 196 | if ( empty( $settings ) ) { |
  |  | 197 | $settings = get\_option( 'caos\_settings', [] ); |
  |  | 198 | } |
  |  | 199 |  |
  |  | 200 | return apply\_filters( 'caos\_settings', $settings ); |
  |  | 201 | } |
  |  | 202 |  |
  |  | 203 | /\*\* |
  |  | 204 | \* Get alias of JS library. |
  |  | 205 | \* @return string |
  |  | 206 | \*/ |
  |  | 207 | public static function get\_file\_alias() { |
  |  | 208 | $file\_aliases = self::get\_file\_aliases(); |
  |  | 209 |  |
  |  | 210 | if ( ! $file\_aliases ) { |
  |  | 211 | return ''; |
  |  | 212 | } |
  |  | 213 |  |
  |  | 214 | return $file\_aliases[ 'gtag' ] ?? ''; |
  |  | 215 | } |
  |  | 216 |  |
  |  | 217 | /\*\* |
  | 164 | 218 | \* Global debug logging function. |
  | 165 | 219 | \* |
  | 166 |  | \* @param  mixed $message |
  |  | 220 | \* @param mixed $message |
  |  | 221 | \* |
  | 167 | 222 | \* @return void |
  | 168 | 223 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L177) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L232) |  |
  | 177 | 232 |  |
  | 178 | 233 | /\*\* |
  | 179 |  | \* @return CAOS\_Setup |
  | 180 |  | \*/ |
  | 181 |  | private function do\_setup() { |
  | 182 |  | register\_uninstall\_hook( CAOS\_PLUGIN\_FILE, 'CAOS::do\_uninstall' ); |
  | 183 |  |  |
  | 184 |  | return new CAOS\_Setup(); |
  |  | 234 | \* Returns early if File Aliases option doesn't exist for Backwards Compatibility. |
  |  | 235 | \* @since 3.11.0 |
  |  | 236 | \* @return string |
  |  | 237 | \*/ |
  |  | 238 | public static function get\_local\_file\_url() { |
  |  | 239 | $url = content\_url() . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) . 'gtag.js'; |
  |  | 240 |  |
  |  | 241 | /\*\* |
  |  | 242 | \* is\_ssl() fails when behind a load balancer or reverse proxy. That's why we double check here if |
  |  | 243 | \* SSL is enabled and rewrite accordingly. |
  |  | 244 | \*/ |
  |  | 245 | if ( strpos( home\_url(), 'https://' ) !== false && ! is\_ssl() ) { |
  |  | 246 | $url = str\_replace( 'http://', 'https://', $url ); |
  |  | 247 | } |
  |  | 248 |  |
  |  | 249 | if ( self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ) ) { |
  |  | 250 | $url = str\_replace( get\_home\_url( get\_current\_blog\_id() ), '//' . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ), $url ); |
  |  | 251 | } |
  |  | 252 |  |
  |  | 253 | $file\_alias = self::get\_file\_alias(); |
  |  | 254 |  |
  |  | 255 | if ( ! $file\_alias ) { |
  |  | 256 | return $url; |
  |  | 257 | } |
  |  | 258 |  |
  |  | 259 | $url = str\_replace( 'gtag.js', $file\_alias, $url ); |
  |  | 260 |  |
  |  | 261 | return apply\_filters( 'caos\_local\_file\_url', $url ); |
  |  | 262 | } |
  |  | 263 |  |
  |  | 264 | /\*\* |
  |  | 265 | \* @return CAOS\_Uninstall |
  |  | 266 | \* @throws ReflectionException |
  |  | 267 | \*/ |
  |  | 268 | public static function do\_uninstall() { |
  |  | 269 | return new CAOS\_Uninstall(); |
  |  | 270 | } |
  |  | 271 |  |
  |  | 272 | /\*\* |
  |  | 273 | \* File downloader |
  |  | 274 | \* |
  |  | 275 | \* @param mixed  $local\_file |
  |  | 276 | \* @param mixed  $remote\_file |
  |  | 277 | \* @param string $file |
  |  | 278 | \* |
  |  | 279 | \* @return string |
  |  | 280 | \*/ |
  |  | 281 | public static function download\_file( $remote\_file, $file = '' ) { |
  |  | 282 | $download = new CAOS\_FileManager(); |
  |  | 283 |  |
  |  | 284 | return $download->download\_file( $remote\_file, $file ); |
  |  | 285 | } |
  |  | 286 |  |
  |  | 287 | /\*\* |
  |  | 288 | \* @param string $path |
  |  | 289 | \* |
  |  | 290 | \* @return bool |
  |  | 291 | \*/ |
  |  | 292 | public static function create\_dir\_r( $path ) { |
  |  | 293 | $file\_manager = new CAOS\_FileManager(); |
  |  | 294 |  |
  |  | 295 | return $file\_manager->create\_dir\_recursive( $path ); |
  |  | 296 | } |
  |  | 297 |  |
  |  | 298 | /\*\* |
  |  | 299 | \* @param string $file |
  |  | 300 | \* @param string $find |
  |  | 301 | \* @param string $replace |
  |  | 302 | \* |
  |  | 303 | \* @return int|false |
  |  | 304 | \*/ |
  |  | 305 | public static function find\_replace\_in( $file, $find, $replace ) { |
  |  | 306 | $file\_manager = new CAOS\_FileManager(); |
  |  | 307 |  |
  |  | 308 | return $file\_manager->find\_replace\_in( $file, $find, $replace ); |
  |  | 309 | } |
  |  | 310 |  |
  |  | 311 | /\*\* |
  |  | 312 | \* |
  |  | 313 | \*/ |
  |  | 314 | public static function uses\_minimal\_analytics() { |
  |  | 315 | return self::get( CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_TRACKING\_CODE ) === 'minimal\_ga4'; |
  |  | 316 | } |
  |  | 317 |  |
  |  | 318 | /\*\* |
  |  | 319 | \* Check if (de)activated plugin is CAOS Pro and if so, update. |
  |  | 320 | \*/ |
  |  | 321 | public function maybe\_do\_update( $plugin ) { |
  |  | 322 | if ( strpos( $plugin, self::CAOS\_PRO\_PLUGIN\_SLUG ) === false ) { |
  |  | 323 | return; |
  |  | 324 | } |
  |  | 325 |  |
  |  | 326 | $this->trigger\_cron\_script(); |
  | 185 | 327 | } |
  | 186 | 328 |  |
  | 187 | 329 | /\*\* |
  | 188 | 330 | \* Triggers when CAOS (Pro) is (de)activated. |
  | 189 |  | ~~\*~~ |
  | 190 | 331 | \* @return CAOS\_Cron |
  | 191 | 332 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L195) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L336) |  |
  | 195 | 336 |  |
  | 196 | 337 | /\*\* |
  | 197 |  | ~~\* Check if (de)activated plugin is CAOS Pro and if so, update.~~ |
  | 198 |  | ~~\*/~~ |
  | 199 |  | ~~public function maybe\_do\_update( $plugin ) {~~ |
  | 200 |  | ~~if ( strpos( $plugin, self::CAOS\_PRO\_PLUGIN\_SLUG ) === false ) {~~ |
  | 201 |  | ~~return;~~ |
  | 202 |  | ~~}~~ |
  | 203 |  |  |
  | 204 |  | ~~$this->trigger\_cron\_script();~~ |
  | 205 |  | ~~}~~ |
  | 206 |  |  |
  | 207 |  | ~~/\*\*~~ |
  | 208 | 338 | \* @return CAOS\_Admin\_UpdateFiles |
  | 209 | 339 | \*/ |
  | 210 | 340 | public function do\_update\_after\_save() { |
  | 211 |  | $settings\_page    = $\_GET[~~'page'~~] ?? ''; |
  | 212 |  | $settings\_updated = $\_GET[~~'settings-updated'~~] ?? ''; |
  |  | 341 | $settings\_page    = $\_GET[ 'page' ] ?? ''; |
  |  | 342 | $settings\_updated = $\_GET[ 'settings-updated' ] ?? ''; |
  | 213 | 343 |  |
  | 214 | 344 | if ( CAOS\_Admin\_Settings::CAOS\_ADMIN\_PAGE !== $settings\_page ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L222) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L352) |  |
  | 222 | 352 | /\*\* |
  | 223 | 353 | \* No need to update any files if we're using Minimal Analytics. Can't believe I'm only finding out about this now... |
  | 224 |  | ~~\*~~ |
  | 225 | 354 | \* @since 4.7.0 |
  | 226 | 355 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L235) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L364) |  |
  | 235 | 364 | \* Render update notices if available. |
  | 236 | 365 | \* |
  | 237 |  | \* @param  mixed $plugin |
  | 238 |  | \* @param  mixed $response |
  |  | 366 | \* @param mixed $plugin |
  |  | 367 | \* @param mixed $response |
  |  | 368 | \* |
  | 239 | 369 | \* @return void |
  | 240 | 370 | \*/ |
  | 241 | 371 | public function render\_update\_notice( $plugin, $response ) { |
  | 242 |  | $current\_version = $plugin[~~'Version'~~]; |
  | 243 |  | $new\_version     = $plugin[~~'new\_version'~~]; |
  |  | 372 | $current\_version = $plugin[ 'Version' ]; |
  |  | 373 | $new\_version     = $plugin[ 'new\_version' ]; |
  | 244 | 374 |  |
  | 245 | 375 | if ( version\_compare( $current\_version, $new\_version, '<' ) ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L257) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L387) |  |
  | 257 | 387 |  |
  | 258 | 388 | printf( |
  | 259 |  | ' <strong>' . \_\_( 'This update includes major changes. Please <a href="%s" target="\_blank">read this</a> before updating.', 'host-analyticsjs-local' ) . '</strong>', |
  |  | 389 | ' <strong>' . \_\_( |
  |  | 390 | 'This update includes major changes. Please <a href="%s" target="\_blank">read this</a> before updating.', |
  |  | 391 | 'host-analyticsjs-local' |
  |  | 392 | ) . '</strong>', |
  | 260 | 393 | $update\_notices[ $new\_version ]->url |
  | 261 | 394 | ); |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L264) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L397) |  |
  | 264 | 397 |  |
  | 265 | 398 | /\*\* |
  | 266 |  | ~~\* Returns early if File Aliases option doesn't exist for Backwards Compatibility.~~ |
  | 267 |  | ~~\*~~ |
  | 268 |  | ~~\* @since 3.11.0~~ |
  | 269 |  | ~~\*~~ |
  | 270 |  | ~~\* @return string~~ |
  | 271 |  | ~~\*/~~ |
  | 272 |  | ~~public static function get\_local\_file\_url() {~~ |
  | 273 |  | ~~$url = content\_url() . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CACHE\_DIR, '/uploads/caos/' ) . 'gtag.js';~~ |
  | 274 |  |  |
  | 275 |  | ~~/\*\*~~ |
  | 276 |  | ~~\* is\_ssl() fails when behind a load balancer or reverse proxy. That's why we double check here if~~ |
  | 277 |  | ~~\* SSL is enabled and rewrite accordingly.~~ |
  | 278 |  | ~~\*/~~ |
  | 279 |  | ~~if ( strpos( home\_url(), 'https://' ) !== false && ! is\_ssl() ) {~~ |
  | 280 |  | ~~$url = str\_replace( 'http://', 'https://', $url );~~ |
  | 281 |  | ~~}~~ |
  | 282 |  |  |
  | 283 |  | ~~if ( self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ) ) {~~ |
  | 284 |  | ~~$url = str\_replace( get\_home\_url( get\_current\_blog\_id() ), '//' . self::get( CAOS\_Admin\_Settings::CAOS\_ADV\_SETTING\_CDN\_URL ), $url );~~ |
  | 285 |  | ~~}~~ |
  | 286 |  |  |
  | 287 |  | ~~$file\_alias = self::get\_file\_alias();~~ |
  | 288 |  |  |
  | 289 |  | ~~if ( ! $file\_alias ) {~~ |
  | 290 |  | ~~return $url;~~ |
  | 291 |  | ~~}~~ |
  | 292 |  |  |
  | 293 |  | ~~$url = str\_replace( 'gtag.js', $file\_alias, $url );~~ |
  | 294 |  |  |
  | 295 |  | ~~return apply\_filters( 'caos\_local\_file\_url', $url );~~ |
  | 296 |  | ~~}~~ |
  | 297 |  |  |
  | 298 |  | ~~/\*\*~~ |
  | 299 |  | ~~\* @return CAOS\_Uninstall~~ |
  | 300 |  | ~~\* @throws ReflectionException~~ |
  | 301 |  | ~~\*/~~ |
  | 302 |  | ~~public static function do\_uninstall() {~~ |
  | 303 |  | ~~return new CAOS\_Uninstall();~~ |
  | 304 |  | ~~}~~ |
  | 305 |  |  |
  | 306 |  | ~~/\*\*~~ |
  | 307 |  | ~~\* File downloader~~ |
  | 308 |  | ~~\*~~ |
  | 309 |  | ~~\* @param mixed  $local\_file~~ |
  | 310 |  | ~~\* @param mixed  $remote\_file~~ |
  | 311 |  | ~~\* @param string $file~~ |
  | 312 |  | ~~\* @param bool   $is\_plugin~~ |
  | 313 |  | ~~\*~~ |
  | 314 |  | ~~\* @return string~~ |
  | 315 |  | ~~\*/~~ |
  | 316 |  | ~~public static function download\_file(~~ |
  | 317 |  | ~~$remote\_file,~~ |
  | 318 |  | ~~$file = ''~~ |
  | 319 |  | ~~) {~~ |
  | 320 |  | ~~$download = new CAOS\_FileManager();~~ |
  | 321 |  |  |
  | 322 |  | ~~return $download->download\_file( $remote\_file, $file );~~ |
  | 323 |  | ~~}~~ |
  | 324 |  |  |
  | 325 |  | ~~/\*\*~~ |
  | 326 |  | ~~\* @param string $path~~ |
  | 327 |  | ~~\*~~ |
  | 328 |  | ~~\* @return bool~~ |
  | 329 |  | ~~\*/~~ |
  | 330 |  | ~~public static function create\_dir\_r( $path ) {~~ |
  | 331 |  | ~~$file\_manager = new CAOS\_FileManager();~~ |
  | 332 |  |  |
  | 333 |  | ~~return $file\_manager->create\_dir\_recursive( $path );~~ |
  | 334 |  | ~~}~~ |
  | 335 |  |  |
  | 336 |  | ~~/\*\*~~ |
  | 337 |  | ~~\* @param string $file~~ |
  | 338 |  | ~~\* @param string $find~~ |
  | 339 |  | ~~\* @param string $replace~~ |
  | 340 |  | ~~\*~~ |
  | 341 |  | ~~\* @return int|false~~ |
  | 342 |  | ~~\*/~~ |
  | 343 |  | ~~public static function find\_replace\_in( $file, $find, $replace ) {~~ |
  | 344 |  | ~~$file\_manager = new CAOS\_FileManager();~~ |
  | 345 |  |  |
  | 346 |  | ~~return $file\_manager->find\_replace\_in( $file, $find, $replace );~~ |
  | 347 |  | ~~}~~ |
  | 348 |  |  |
  | 349 |  | ~~/\*\*~~ |
  | 350 |  | ~~\*~~ |
  | 351 |  | ~~\*/~~ |
  | 352 |  | ~~public static function uses\_minimal\_analytics() {~~ |
  | 353 |  | ~~return self::get( CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_TRACKING\_CODE ) === 'minimal\_ga4';~~ |
  | 354 |  | ~~}~~ |
  | 355 |  |  |
  | 356 |  | ~~/\*\*~~ |
  | 357 |  | ~~\* Method to retrieve settings from database.~~ |
  | 358 |  | ~~\*~~ |
  | 359 |  | ~~\* @filter caos\_setting\_{$name}~~ |
  | 360 |  | ~~\*~~ |
  | 361 |  | ~~\* @param string $name               Any constant from the CAOS\_Admin\_Settings class.~~ |
  | 362 |  | ~~\* @param mixed  $default (optional) The option's default value if it isn't set (yet).~~ |
  | 363 |  | ~~\*~~ |
  | 364 |  | ~~\* @since v4.5.1~~ |
  | 365 |  | ~~\*~~ |
  | 366 |  | ~~\* @return mixed~~ |
  | 367 |  | ~~\*/~~ |
  | 368 |  | ~~public static function get( $name, $default = null ) {~~ |
  | 369 |  | ~~$value = self::get\_settings()[ $name ] ?? '';~~ |
  | 370 |  |  |
  | 371 |  | ~~if ( empty( $value ) && $default !== null ) {~~ |
  | 372 |  | ~~$value = $default;~~ |
  | 373 |  | ~~}~~ |
  | 374 |  |  |
  | 375 |  | ~~/\*\*~~ |
  | 376 |  | ~~\* This allows for WPML (and similar plugins) to use different tracking IDs on different languages/sites.~~ |
  | 377 |  | ~~\*/~~ |
  | 378 |  | ~~if ( $name === CAOS\_Admin\_Settings::CAOS\_BASIC\_SETTING\_MEASUREMENT\_ID ) {~~ |
  | 379 |  | ~~$translated\_tracking\_id = \_x( 'G-123ABC789', 'Define a different Measurement ID for this language/site.', 'host-analyticsjs-local' );~~ |
  | 380 |  |  |
  | 381 |  | ~~if ( $translated\_tracking\_id !== 'G-123ABC789' ) {~~ |
  | 382 |  | ~~$value = $translated\_tracking\_id;~~ |
  | 383 |  | ~~}~~ |
  | 384 |  | ~~}~~ |
  | 385 |  |  |
  | 386 |  | ~~return apply\_filters( "caos\_setting\_$name", $value );~~ |
  | 387 |  | ~~}~~ |
  | 388 |  |  |
  | 389 |  | ~~/\*\*~~ |
  | 390 |  | ~~\* Gets all settings for CAOS.~~ |
  | 391 |  | ~~\*~~ |
  | 392 |  | ~~\* @since 4.5.1~~ |
  | 393 |  | ~~\*~~ |
  | 394 |  | ~~\* @return array~~ |
  | 395 |  | ~~\*/~~ |
  | 396 |  | ~~public static function get\_settings() {~~ |
  | 397 |  | ~~static $settings;~~ |
  | 398 |  |  |
  | 399 |  | ~~if ( empty( $settings ) ) {~~ |
  | 400 |  | ~~$settings = get\_option( 'caos\_settings', [] );~~ |
  | 401 |  | ~~}~~ |
  | 402 |  |  |
  | 403 |  | ~~return apply\_filters( 'caos\_settings', $settings );~~ |
  | 404 |  | ~~}~~ |
  | 405 |  |  |
  | 406 |  | ~~/\*\*~~ |
  | 407 | 399 | \* We use a custom update action, because we're storing multidimensional arrays upon form submit. |
  | 408 |  | ~~\*~~ |
  | 409 | 400 | \* This prevents us from having to use AJAX, serialize(), stringify() and eventually having to json\_decode() it, i.e. |
  | 410 | 401 | \* a lot of headaches. |
  | 411 |  | ~~\*~~ |
  | 412 | 402 | \* @since v4.6.0 |
  | 413 | 403 | \*/ |
  | 414 | 404 | public function update\_settings() { |
  | 415 |  | ~~// phpcs:ignore WordPress.Security~~ |
  | 416 |  | if ( empty( $\_POST['action'] ) || $\_POST['action'] !== 'caos-update' ) { |
  | 417 |  | ~~return~~; |
  | 418 |  | } |
  | 419 |  |  |
  | 420 |  | ~~// phpcs:ignore~~ |
  | 421 |  | ~~$post\_data = $this->clean($\_POST);~~ |
  | 422 |  |  |
  | 423 |  | ~~$options = apply\_filters(~~ |
  | 424 |  | ~~/\*\*~~ |
  | 425 |  | ~~\* Any options that're better off in their own DB row (e.g. due to size) can be added using this filter.~~ |
  | 426 |  | \* |
  | 427 |  | ~~\* @since v4.6.0~~ |
  | 428 |  | \*/ |
  | 429 |  | ~~'caos\_update\_settings\_serialized',~~ |
  | 430 |  | ~~[~~ |
  | 431 |  | ~~'caos\_settings',~~ |
  | 432 |  | ~~]~~ |
  | 433 |  | ); |
  |  | 405 | $action = $\_GET[ 'tab' ] ?? 'caos-basic-settings'; |
  |  | 406 |  |
  |  | 407 | wp\_verify\_nonce( $\_POST[ '\_wpnonce' ], $action ); |
  |  | 408 |  |
  |  | 409 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 410 | return; |
  |  | 411 | } |
  |  | 412 |  |
  |  | 413 | if ( empty( $\_POST[ 'action' ] ) || $\_POST[ 'action' ] !== 'caos-update' ) { |
  |  | 414 | return; |
  |  | 415 | } |
  |  | 416 |  |
  |  | 417 | $post\_data = $this->clean( $\_POST ); |
  |  | 418 |  |
  |  | 419 | /\*\* |
  |  | 420 | \* Any options that're better off in their own DB row (e.g. due to size) can be added using this filter. |
  |  | 421 | \* @since v4.6.0 |
  |  | 422 | \*/ |
  |  | 423 | $options = apply\_filters( 'caos\_update\_settings\_serialized', [ 'caos\_settings', ] ); |
  | 434 | 424 |  |
  | 435 | 425 | foreach ( $options as $option ) { |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L449) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L439) |  |
  | 449 | 439 | /\*\* |
  | 450 | 440 | \* Additional update actions can be added here. |
  | 451 |  | ~~\*~~ |
  | 452 | 441 | \* @since v4.6.0 |
  | 453 | 442 | \*/ |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=2981201#L463) | […](/browser/host-analyticsjs-local/trunk/includes/class-caos.php?rev=3008878#L452) |  |
  | 463 | 452 | \* Clean variables using `sanitize\_text\_field`. |
  | 464 | 453 | \* Arrays are cleaned recursively. Non-scalar values are ignored. |
  |  | 454 | \* @since 4.6.0 |
  | 465 | 455 | \* |
  | 466 | 456 | \* @param string|array $var Sanitize the variable. |
  | 467 |  | ~~\*~~ |
  | 468 |  | ~~\* @since 4.6.0~~ |
  | 469 | 457 | \* |
  | 470 | 458 | \* @return string|array |
* ## [host-analyticsjs-local/trunk/includes/class-cron.php](/changeset/3008878/host-analyticsjs-local/trunk/includes/class-cron.php "Show the changeset 3008878 restricted to host-analyticsjs-local/trunk/includes/class-cron.php")

  | [r2945403](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=2945403#L40 "Show revision 2945403 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=3008878#L40 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 40 | 40 | $downloaded\_files = $this->download(); |
  | 41 | 41 |  |
  | 42 |  | // Only sent a success message if this is a AJAX request. |
  |  | 42 | // Only sent a success message if this is an AJAX request. |
  | 43 | 43 | if ( ! wp\_doing\_cron() && ! empty( $downloaded\_files ) ) { |
  | 44 | 44 | $review\_link = apply\_filters( 'caos\_manual\_download\_review\_link', $this->review ); |
  | […](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=2945403#L49) | […](/browser/host-analyticsjs-local/trunk/includes/class-cron.php?rev=3008878#L49) |  |
  | 49 | 49 | ); |
  | 50 | 50 |  |
  | 51 |  | CAOS\_Admin\_Notice::set\_notice( $notice . ' ' . sprintf( \_\_( 'Would you be willing to <a href="%1$s" target="\_blank">write a review</a> or <a href="%2$s" target="\_blank">tweet</a> about it?', 'host-analyticsjs-local' ), $review\_link, $tweet\_link ), 'success', 'all', 'file\_downloaded' ); |
  |  | 51 | CAOS\_Admin\_Notice::set\_notice( |
  |  | 52 | $notice . |
  |  | 53 | ' ' . |
  |  | 54 | sprintf( |
  |  | 55 | \_\_( |
  |  | 56 | 'Would you be willing to <a href="%1$s" target="\_blank">write a review</a> or <a href="%2$s" target="\_blank">tweet</a> about it?', |
  |  | 57 | 'host-analyticsjs-local' |
  |  | 58 | ), |
  |  | 59 | $review\_link, |
  |  | 60 | $tweet\_link |
  |  | 61 | ), |
  |  | 62 | 'success', |
  |  | 63 | 'all', |
  |  | 64 | 'file\_downloaded' |
  |  | 65 | ); |
  | 52 | 66 | } |
  | 53 | 67 | } |
* ## [host-analyticsjs-local/trunk/readme.txt](/changeset/3008878/host-analyticsjs-local/trunk/readme.txt "Show the changeset 3008878 restricted to host-analyticsjs-local/trunk/readme.txt")

  | [r2992257](/browser/host-analyticsjs-local/trunk/readme.txt?rev=2992257#L4 "Show revision 2992257 of this file in browser") | [r3008878](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3008878#L4 "Show revision 3008878 of this file in browser") |  |
  | --- | --- | --- |
  | 4 | 4 | Requires at least: 4.6 |
  | 5 | 5 | Tested up to: 6.4 |
  | 6 |  | Stable tag: 4.7.1~~2~~ |
  |  | 6 | Stable tag: 4.7.13 |
  | 7 | 7 | Requires PHP: 7.0 |
  | 8 | 8 | License: GPLv2 or later |
  | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=2992257#L77) | […](/browser/host-analyticsjs-local/trunk/readme.txt?rev=3008878#L77) |  |
  | 77 | 77 | == Changelog == |
  | 78 | 78 |  |
  |  | 79 | = 4.7.13 | December 12th, 2023 = |
  |  | 80 | \* Fixed: CSRF issue in custom Update Settings logic. |
  |  | 81 |  |
  | 79 | 82 | = 4.7.12 | November 8th, 2023 = |
  | 80 | 83 | \* Tested with WP 6.4 |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3008878)
* [Zip Archive](?format=zip&new=3008878)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


