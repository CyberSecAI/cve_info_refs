=== Content from www.mozilla.org_a227e78f_20250115_101043.html ===


## Help us improve your Mozilla experience

In addition to Cookies necessary for this site to function, we’d like your permission to set some additional Cookies to better understand your browsing needs and improve your experience. Rest assured — we value your privacy.

Accept All Additional Cookies

Reject All Additional Cookies

[Cookie settings](/en-US/privacy/websites/cookie-settings/)

Menu
[![Mozilla](https://www.mozilla.org/media/img/logos/m24/lockup-black.f2ddba3f0724.svg)](/en-US/)

* [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
  Firefox browsers](/en-US/firefox/)
  Close Firefox browsers menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Desktop](/en-US/firefox/new/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for iOS](/en-US/firefox/browsers/mobile/ios/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/logo.eb1324e44442.svg)
    ## Firefox for Android](/en-US/firefox/browsers/mobile/android/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/browser/focus/logo.aac3e33175cb.svg)
    ## Firefox Focus](/en-US/firefox/browsers/mobile/focus/)
  + [## Firefox blog](https://blog.mozilla.org/firefox/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=firefox)
* [Products](/en-US/products/)
  Close Products menu
  + [![](https://www.mozilla.org/media/protocol/img/logos/mozilla/vpn/logo.c648f487bfb8.svg)
    ## Mozilla VPN](/en-US/products/vpn/)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/monitor/logo.d97e5516f9e6.svg)
    ## Mozilla Monitor](https://monitor.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/firefox/relay/logo-white.d42a8b52e44c.svg)
    ## Firefox Relay](https://relay.firefox.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/protocol/img/logos/pocket/logo.17446bc33a5d.svg)
    ## Pocket](https://getpocket.com/firefox_learnmore/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/nav/icons/icon-mdn-plus.f54475f980ab.svg)
    ## MDN Plus](https://developer.mozilla.org/plus?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/fakespot/logo-blue.3973b8fe9631.svg)
    ## Fakespot](https://fakespot.com/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=products)
  + [![](https://www.mozilla.org/media/img/logos/thunderbird/logo-thunderbird.121e9c0fed45.svg)
    ## Thunderbird](https://www.thunderbird.net/)

  [All products](/en-US/products/)
* [About us](/en-US/about/)
  Close About us menu

  Our Mission

  + [## About Mozilla](/en-US/about/)
  + [## The Mozilla Manifesto](/en-US/about/manifesto/)
  + [## Get Involved](/en-US/contribute/)
  + [## Innovation Projects](https://future.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Blog](https://blog.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)

  Our Work

  + [## Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla.ai](https://www.mozilla.ai/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Ventures](https://mozilla.vc/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=nav&utm_content=about-us)
  + [## Mozilla Advertising](/en-US/advertising/)

## Menu

* Mozilla Security

## [Mozilla Security](/en-US/security/)

* [Advisories](/en-US/security/advisories/)
* [Known Vulnerabilities](/en-US/security/known-vulnerabilities/)
* [Mozilla Security Blog](https://blog.mozilla.com/security/)
* [Security Bug Bounty](/en-US/security/bug-bounty/)
* [Third-party Injection Policy](/en-US/security/third-party-software-injection/)

## [Client Bug Bounty](/en-US/security/client-bug-bounty/)

* [Frequently Asked Questions](/en-US/security/bug-bounty/faq/)
* [Hall of Fame](/en-US/security/bug-bounty/hall-of-fame/)

## [Web Bug Bounty](/en-US/security/web-bug-bounty/)

* [Eligible Websites](/en-US/security/bug-bounty/web-eligible-sites/)
* [Frequently Asked Questions](/en-US/security/bug-bounty/faq-webapp/)
* [Hall of Fame](/en-US/security/bug-bounty/web-hall-of-fame/)

# Mozilla Foundation Security Advisory 2023-01

## Security Vulnerabilities fixed in Firefox 109

Announced
January 17, 2023
Impact
high
Products
Firefox
Fixed in

* Firefox 109

#### [#CVE-2023-23597: Logic bug in process allocation allowed to read arbitrary files](#CVE-2023-23597)

Reporter
Niklas Baumstark
Impact
high
##### Description

A compromised web child process could disable web security opening restrictions, leading to a new child process being spawned within the `file://` context. Given a reliable exploit primitive, this new process could be exploited again leading to arbitrary file read.

##### References

* [Bug 1538028](https://bugzilla.mozilla.org/show_bug.cgi?id=1538028)

#### [#CVE-2023-23598: Arbitrary file read from GTK drag and drop on Linux](#CVE-2023-23598)

Reporter
Tom Schuster
Impact
high
##### Description

Due to the Firefox GTK wrapper code's use of text/plain for drag data and GTK treating all text/plain MIMEs containing file URLs as being dragged a website could arbitrarily read a file via a call to `DataTransfer.setData`.

##### References

* [Bug 1800425](https://bugzilla.mozilla.org/show_bug.cgi?id=1800425)

#### [#CVE-2023-23599: Malicious command could be hidden in devtools output on Windows](#CVE-2023-23599)

Reporter
Vadim
Impact
moderate
##### Description

When copying a network request from the developer tools panel as a curl command the output was not being properly sanitized and could allow arbitrary commands to be hidden within.

##### References

* [Bug 1777800](https://bugzilla.mozilla.org/show_bug.cgi?id=1777800)

#### [#CVE-2023-23600: Notification permissions persisted between Normal and Private Browsing on Android](#CVE-2023-23600)

Reporter
Kazuki Nomoto of Waseda University
Impact
moderate
##### Description

Per origin notification permissions were being stored in a way that didn't take into account what browsing context the permission was granted in. This lead to the possibility of notifications to be displayed during different browsing sessions.
*This bug only affects Firefox for Android. Other operating systems are unaffected.*

##### References

* [Bug 1787034](https://bugzilla.mozilla.org/show_bug.cgi?id=1787034)

#### [#CVE-2023-23601: URL being dragged from cross-origin iframe into same tab triggers navigation](#CVE-2023-23601)

Reporter
Luan Herrera
Impact
moderate
##### Description

Navigations were being allowed when dragging a URL from a cross-origin iframe into the same tab which could lead to website spoofing attacks

##### References

* [Bug 1794268](https://bugzilla.mozilla.org/show_bug.cgi?id=1794268)

#### [#CVE-2023-23602: Content Security Policy wasn't being correctly applied to WebSockets in WebWorkers](#CVE-2023-23602)

Reporter
Dave Vandyke
Impact
moderate
##### Description

A mishandled security check when creating a WebSocket in a WebWorker caused the Content Security Policy connect-src header to be ignored. This could lead to connections to restricted origins from inside WebWorkers.

##### References

* [Bug 1800890](https://bugzilla.mozilla.org/show_bug.cgi?id=1800890)

#### [#CVE-2023-23603: Calls to console.log allowed bypasing Content Security Policy via format directive](#CVE-2023-23603)

Reporter
Dan Veditz
Impact
low
##### Description

Regular expressions used to filter out forbidden properties and values from style directives in calls to `console.log` weren't accounting for external URLs. Data could then be potentially exfiltrated from the browser.

##### References

* [Bug 1800832](https://bugzilla.mozilla.org/show_bug.cgi?id=1800832)

#### [#CVE-2023-23604: Creation of duplicate SystemPrincipal from less secure contexts](#CVE-2023-23604)

Reporter
Nika Layzell
Impact
low
##### Description

A duplicate `SystemPrincipal` object could be created when parsing a non-system html document via `DOMParser::ParseFromSafeString`. This could have lead to bypassing web security checks.

##### References

* [Bug 1802346](https://bugzilla.mozilla.org/show_bug.cgi?id=1802346)

#### [#CVE-2023-23605: Memory safety bugs fixed in Firefox 109 and Firefox ESR 102.7](#CVE-2023-23605)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 108 and Firefox ESR 102.6. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 109 and Firefox ESR 102.7](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1764921%2C1802690%2C1806974)

#### [#CVE-2023-23606: Memory safety bugs fixed in Firefox 109](#CVE-2023-23606)

Reporter
Mozilla developers
Impact
high
##### Description

Mozilla developers and the Mozilla Fuzzing Team reported memory safety bugs present in Firefox 108. Some of these bugs showed evidence of memory corruption and we presume that with enough effort some of these could have been exploited to run arbitrary code.

##### References

* [Memory safety bugs fixed in Firefox 109](https://bugzilla.mozilla.org/buglist.cgi?bug_id=1764974%2C1798591%2C1799201%2C1800446%2C1801248%2C1802100%2C1803393%2C1804626%2C1804971%2C1807004)

## Company

* [Leadership](/about/leadership/)
* [Press Center](https://blog.mozilla.org/category/mozilla/news/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=company)
* [Careers](/en-US/careers/)
* [Contact](/en-US/contact/)

## Support

* [Product Help](https://support.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [File a Bug](https://bugzilla.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)
* [Localize Mozilla](https://pontoon.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=support)

## Resources

* [Advertise with Mozilla](/en-US/advertising/)
* [Firefox Release Notes](/firefox/134.0.1/releasenotes/)

## Developers

* [Developer Edition](/en-US/firefox/developer/)
* [Enterprise](/en-US/firefox/enterprise/)
* [Tools](https://firefox-source-docs.mozilla.org/devtools-user/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer&utm_content=developers)
* [MDN](https://developer.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer)

## Follow @Mozilla

* [X (formerly Twitter) (@mozilla)](https://twitter.com/mozilla)
* [Instagram (@mozilla)](https://www.instagram.com/mozilla/)
* [LinkedIn (@mozilla)](https://www.linkedin.com/company/mozilla-corporation/)
* [TikTok (@mozilla)](https://www.tiktok.com/%40mozilla)
* [Spotify (@mozilla)](https://open.spotify.com/show/0vT7LJMeVDxyQ2ZamHKu08?si=_uDRD6bRR_6M5YZyISGXgA)

## Follow @Firefox

* [X (formerly Twitter) (@firefox)](https://twitter.com/firefox)
* [Instagram (@firefox)](https://www.instagram.com/firefox/)
* [YouTube (@firefoxchannel)](https://www.youtube.com/user/firefoxchannel)
* [TikTok (@firefox)](https://www.tiktok.com/%40firefox)

[Donate](https://foundation.mozilla.org/?form=moco-donate-footer)

Visit [Mozilla Corporation’s](/en-US/) not-for-profit parent, the [Mozilla Foundation](https://foundation.mozilla.org/?utm_source=www.mozilla.org&utm_medium=referral&utm_campaign=footer).

Portions of this content are ©1998–2025 by individual mozilla.org contributors. Content available under a [Creative Commons license](/en-US/foundation/licensing/website-content/).

* [Website Privacy Notice](/en-US/privacy/websites/)
* [Cookies](/en-US/privacy/websites/cookie-settings/)
* [Legal](/en-US/about/legal/)
* [Community Participation Guidelines](/en-US/about/governance/policies/participation/)
* [About this site](/en-US/about/this-site/)

![](https://www.mozilla.org/media/img/logos/m24/wordmark-white.2d673bb5b33a.svg)



=== Content from bugzilla.mozilla.org_0e65dd43_20250115_101040.html ===


![](/static/v20250114.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1802346)
* [XML](/show_bug.cgi?ctype=xml&id=1802346)

Closed
[Bug 1802346](/show_bug.cgi?id=1802346)
(CVE-2023-23604)

Opened 2 years ago
Closed 2 years ago

# DOMParser.parseFromSafeString creates multiple SystemPrincipal instances

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

DOMParser.parseFromSafeString creates multiple SystemPrincipal instances

## Categories

### (Core :: DOM: Core & HTML, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML#DOM%3A%20Core%20%26%20HTML)

DOM: Core & HTML
▾

Core :: DOM: Core & HTML
Issues in DOM tree [https://dom.spec.whatwg.org](https://dom.spec.whatwg.org/) & HTML [https://html.spec.whatwg.org](https://html.spec.whatwg.org/) that do not fit into any other DOM or HTML component or which span multiple DOM or HTML components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

--

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

109 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix) |
| firefox107 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=wontfix) |
| firefox108 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox108&o1=equals&v1=wontfix) |
| firefox109 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | wontfix |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox107 |  | wontfix |
| firefox108 |  | wontfix |
| firefox109 |  | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: nika, Assigned: nika)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/fcf93a5a624020bf2256443c69e08b51?d=mm&size=40)  [nika](/user_profile?user_id=534482)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/fcf93a5a624020bf2256443c69e08b51?d=mm&size=40)  [nika](/user_profile?user_id=534482)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/b89a42ca4c4d59c27f33c399bb1ecc7b?d=mm&size=40)  [farre](/user_profile?user_id=566192)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

7 people

## References

### (Blocks 1 open bug, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1809392](/show_bug.cgi?id=1809392 "NEW - Proposing new clang static analysis rule that disallows singleton to be created multiple times"), [1443925](/show_bug.cgi?id=1443925 "RESOLVED FIXED - Make nsIPrincipal objects threadsafe")

Dependency [tree](/showdependencytree.cgi?id=1802346&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1802346)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1786558](/show_bug.cgi?id=1786558 "RESOLVED FIXED - Fix SecurityError: Node.appendChild: Adopting nodes across docgroups in chrome documents is unsupported on about pages")

[1467970](/show_bug.cgi?id=1467970 "RESOLVED FIXED - Forbid node adoption across the chrome/content boundary")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: regression, sec-low, Whiteboard: [post-critsmash-triage][adv-main109+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-23604

[Keywords:](/describekeywords.cgi)

[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main109+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [btot](/user_profile?user_id=553429) | [qe-verify](#a960195_553429 "2 years ago") | - |
| --- | --- | --- |
| [btot](/user_profile?user_id=553429) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files)

| [Bug 1802346 - Use the owner principal in ParseFromSafeString, r=smaug!](/attachment.cgi?id=9305163)  [2 years ago](#c2)  [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9305163&action=edit) | [Review](/attachment.cgi?id=9305163) |
| --- | --- | --- |
| [Bug 1802346 - Part 2: Add principal tests to test\_domparsing.xhtml, r=smaug!](/attachment.cgi?id=9305180)  [2 years ago](#c4)  [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9305180&action=edit) | [Review](/attachment.cgi?id=9305180) |
| [advisory.txt](/attachment.cgi?id=9312397)  [2 years ago](#c11)  [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341)   263 bytes, text/plain |  | [Details](/attachment.cgi?id=9312397&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1802346#c0)• 2 years ago |
|  | |

Since [bug 1467970](/show_bug.cgi?id=1467970 "RESOLVED FIXED - Forbid node adoption across the chrome/content boundary"), `DOMParser::ParseFromSafeString` creates a brand new `SystemPrincipal` instance when being used to parse with a non-system principal. This is bad, as lots of code in gecko assumes that there is only a single system principal instance, and so will check if a principal is the system principal by pointer identity. For example, [`nsContentUtils::IsChromeDoc`](https://searchfox.org/mozilla-central/rev/5a49163b7012ded5fa1c4da5aa4f8d3f7c85a5e7/dom/base/nsContentUtils.cpp#4319) uses pointer identity to check if a principal is the system principal.

I discovered this because I fixed this issue as part of my work on [bug 1443925](/show_bug.cgi?id=1443925 "RESOLVED FIXED - Make nsIPrincipal objects threadsafe"), and it started causing screenshots test failures. It turns out that this method right now is used to parse a safe string for a non-system document [in `ScreenshotsOverlayChild.sys.mjs`](https://searchfox.org/mozilla-central/rev/5a49163b7012ded5fa1c4da5aa4f8d3f7c85a5e7/browser/components/screenshots/ScreenshotsOverlayChild.sys.mjs#359) since [bug 1786558](/show_bug.cgi?id=1786558 "RESOLVED FIXED - Fix SecurityError: Node.appendChild: Adopting nodes across docgroups in chrome documents is unsupported on about pages") , and then the parsed node is adopted into the content document on the next line. Normally, this would be blocked by [the check in `nsINode`](https://searchfox.org/mozilla-central/rev/5a49163b7012ded5fa1c4da5aa4f8d3f7c85a5e7/dom/base/nsINode.cpp#3502-3510), however the `nsContentUtils::IsChromeDoc` check failed to notice the chrome -> content adoption due to the system principal having a different pointer identity.

After fixing the code to use a single common system principal, tests started failing as the adoption in `ScreenshotsOverlayChild` no longer worked.

I'm marking this as a security bug, as there may be other security checks bypassed or broken by having multiple system principals, and I don't know what sorts of issues it could cause.

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1802346#c1)• 2 years ago |
|  | |

Adding [bug 1786558](/show_bug.cgi?id=1786558 "RESOLVED FIXED - Fix SecurityError: Node.appendChild: Adopting nodes across docgroups in chrome documents is unsupported on about pages") as a regressed-by as well, as that bug is the reason why the fix here isn't simple.

Regressed by: [1786558](/show_bug.cgi?id=1786558 "RESOLVED FIXED - Fix SecurityError: Node.appendChild: Adopting nodes across docgroups in chrome documents is unsupported on about pages")

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1802346#c2)• 2 years ago |
|  | |

Attached file
[Bug 1802346 - Use the owner principal in ParseFromSafeString, r=smaug!](attachment.cgi?id=9305163)
— [Details](attachment.cgi?id=9305163&action=edit)

This is done rather than using the system principal to avoid potential

cross-docgroup adoption issues.

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a3432_600971)• 2 years ago |

Assignee: nobody → nikaStatus: NEW → ASSIGNED

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1802346#c3)• 2 years ago |
|  | |

Came up with a reasonable solution, where we change the semantics of `DOMParser::ParseFromSafeString` to always mimic the target document's principal, rather than hard-coding `SystemPrincipal`. This avoids the adoption issues with the caller, while also no longer creating multiple `SystemPrincipal` instances.

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1802346#c4)• 2 years ago |
|  | |

Attached file
[Bug 1802346 - Part 2: Add principal tests to test\_domparsing.xhtml, r=smaug!](attachment.cgi?id=9305180)
— [Details](attachment.cgi?id=9305180&action=edit)

Depends on D163017

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1802346#c5)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1802346&comment_id=16174334 "1 revision") |
|  | |

Is it possible to either MOZ\_CRASH or even add compile-time restrictions that enforce the single-ton-ness of the system principal? That would help prevent reintroductions of this issue.

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1802346#c6)• 2 years ago |
|  | |

(In reply to :Gijs (he/him) from [comment #5](/show_bug.cgi?id=1802346#c5 "RESOLVED FIXED - DOMParser.parseFromSafeString creates multiple SystemPrincipal instances"))

> Is it possible to either MOZ\_CRASH or even add compile-time restrictions that enforce the single-ton-ness of the system principal? That would help prevent reintroductions of this issue.

I'm going to hide the ability to construct new instances of the system principal in my patches for [bug 1443925](/show_bug.cgi?id=1443925 "RESOLVED FIXED - Make nsIPrincipal objects threadsafe") (specifically <https://phabricator.services.mozilla.com/D163035>, where I hide the ability to construct one, and make it a hard singleton with assertions). If I wasn't imminently doing that, I'd want to add more assertions to the actual class itself, but assuming I can get those patches landed somewhat quickly, I'm not sure if it's worth it.

Flags: needinfo?(nika)

|  | [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1802346#c7)• 2 years ago |
|  | |

Neither :smaug nor I think this is sec-high, and as I can't imagine a way someone could manipulate these very short-lived chrome-only documents with a duplicate system principal off I'm inclined to think it isn't even sec-moderate. Marking as sec-low.

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1802346#c8)• 2 years ago |
|  | |

Use the owner principal in ParseFromSafeString, r=smaug

<https://hg.mozilla.org/integration/autoland/rev/dcf80a1e5e45ab6cc6ed6a611ad20687437ae5b4>

<https://hg.mozilla.org/mozilla-central/rev/dcf80a1e5e45>

Group: dom-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years ago
[status-firefox109](/buglist.cgi?f1=cf_status_firefox109&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox109&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 109 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a287199_75935)• 2 years ago |

[status-firefox107](/buglist.cgi?f1=cf_status_firefox107&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox107&o1=equals&v1=wontfix)
[status-firefox108](/buglist.cgi?f1=cf_status_firefox108&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox108&o1=equals&v1=wontfix)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=wontfix)

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1802346#c9)• 2 years ago |
|  | |

I was looking at the bugmail and noticed that this is actually in a wrong component.

Component: DOM: HTML Parser → DOM: Core & HTML

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1802346#c10)• 2 years ago |
|  | |

Part 2: Add principal tests to test\_domparsing.xhtml, r=smaug

<https://hg.mozilla.org/integration/autoland/rev/03a29bff819faafc59db1c15877b7aa542cacc14>

<https://hg.mozilla.org/mozilla-central/rev/03a29bff819f>

|  | [Brindusa Tot, Desktop QA](/user_profile?user_id=553429) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a960195_553429)• 2 years ago |

Flags: qe-verify-Whiteboard: [post-critsmash-triage]

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a4026686_428608)• 2 years ago |

Blocks: [1809392](/show_bug.cgi?id=1809392 "NEW - Proposing new clang static analysis rule that disallows singleton to be created multiple times")

|  | [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a4296384_626341)• 2 years ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main109+]

|  | [June Wilde (she/her) [:jewilde]](/user_profile?user_id=626341) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1802346#c11)• 2 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9312397)
— [Details](attachment.cgi?id=9312397&action=edit)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a4554333_428608)• 2 years ago |

Alias: CVE-2023-23604

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1802346#a20314059_1689)• 1 years ago |

Group: core-security-releaseKeywords: [regression](/buglist.cgi?keywords=regression&resolution=---)
You need to [log in](/show_bug.cgi?id=1802346&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Nika Layzell [:nika] (ni? for response)](/user_profile?user_id=534482)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


