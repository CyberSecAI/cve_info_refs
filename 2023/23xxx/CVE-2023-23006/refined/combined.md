=== Content from github.com_3c030cdf_20250115_093754.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6b8b42585886c59a008015083282aae434349094)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6b8b42585886c59a008015083282aae434349094)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.8k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/6b8b42585886c59a008015083282aae434349094)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

net/mlx5: DR, Fix NULL vs IS\_ERR checking in dr\_domain\_init\_resources

[Browse files](/torvalds/linux/tree/6b8b42585886c59a008015083282aae434349094)
Browse the repository at this point in the history

```
The mlx5_get_uars_page() function  returns error pointers.
Using IS_ERR() to check the return value to fix this.

Fixes: [4ec9e7b](https://github.com/torvalds/linux/commit/4ec9e7b02697eca8dc9853ea559c18029c38da36) ("net/mlx5: DR, Expose steering domain functionality")
Signed-off-by: Miaoqian Lin <linmq006@gmail.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
```

* Loading branch information

[![@Yuuoniy](https://avatars.githubusercontent.com/u/22578377?s=40&v=4)](/Yuuoniy)

[Yuuoniy](/torvalds/linux/commits?author=Yuuoniy "View all commits by Yuuoniy")
authored and
Saeed Mahameed
committed
Dec 23, 2021

1 parent
[d1652b7](/torvalds/linux/commit/d1652b70d07cc3eed96210c876c4879e1655f20e)

commit 6b8b425

Showing
**1 changed file**
with
**3 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

5 changes: 3 additions & 2 deletions

5
[drivers/net/ethernet/mellanox/mlx5/core/steering/dr\_domain.c](#diff-7527c95051a49addee8fc9b9e5539a05b757b8f2d8882117acecd81c428b678a "drivers/net/ethernet/mellanox/mlx5/core/steering/dr_domain.c")

Show comments

[View file](/torvalds/linux/blob/6b8b42585886c59a008015083282aae434349094/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_domain.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ |
|  |  | /\* Copyright (c) 2019 Mellanox Technologies. \*/ |
|  |  |  |
|  |  | #include <linux/mlx5/eswitch.h> |
|  |  | #include <linux/err.h> |
|  |  | #include "dr\_types.h" |
|  |  |  |
|  |  | #define DR\_DOMAIN\_SW\_STEERING\_SUPPORTED(dmn, dmn\_type) \ |
| Expand Down  Expand Up | | @@ -72,9 +73,9 @@ static int dr\_domain\_init\_resources(struct mlx5dr\_domain \*dmn) |
|  |  | } |
|  |  |  |
|  |  | dmn->uar = mlx5\_get\_uars\_page(dmn->mdev); |
|  |  | if (!dmn->uar) { |
|  |  | if (IS\_ERR(dmn->uar)) { |
|  |  | mlx5dr\_err(dmn, "Couldn't allocate UAR\n"); |
|  |  | ret = -ENOMEM; |
|  |  | ret = PTR\_ERR(dmn->uar); |
|  |  | goto clean\_pd; |
|  |  | } |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `6b8b425`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F6b8b42585886c59a008015083282aae434349094) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from cdn.kernel.org_1d09fb03_20250115_093753.html ===
commit 734eb1fd2073f503f5c6b44f1c0d453ca6986b84
Author: Greg Kroah-Hartman
Date: Wed Jan 5 12:42:40 2022 +0100
Linux 5.15.13
Link: https://lore.kernel.org/r/20220103142056.911344037@linuxfoundation.org
Tested-by: Guenter Roeck
Tested-by: Linux Kernel Functional Testing
Tested-by: Rudi Heitbaum
Tested-by: Jon Hunter
Link: https://lore.kernel.org/r/20220104073845.629257314@linuxfoundation.org
Tested-by: Sudip Mukherjee
Tested-by: Florian Fainelli
Tested-by: Guenter Roeck
Tested-by: Shuah Khan
Tested-by: Linux Kernel Functional Testing
Tested-by: Zan Aziz
Signed-off-by: Greg Kroah-Hartman
commit bc5fce3dff9a7f3c75311128dcb17daf96776b82
Author: Adrian Hunter
Date: Wed Dec 15 10:06:36 2021 +0200
perf scripts python: intel-pt-events.py: Fix printing of switch events
commit 0f80bfbf4919e32f52fe1312c3900ff4fbb7eeb9 upstream.
The intel-pt-events.py script displays only the last of consecutive switch
statements but that may not be the last switch event for the CPU. Fix by
keeping a dictionary of last context switch keyed by CPU, and make it
possible to see all switch events by adding option --all-switch-events.
Fixes: a92bf335fd82eeee ("perf scripts python: intel-pt-events.py: Add branches to script")
Signed-off-by: Adrian Hunter
Cc: Jiri Olsa
Cc: Namhyung Kim
Cc: Riccardo Mancini
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20211215080636.149562-4-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 632ee8a1786a54a970ff03f136c41baa79c86c8a
Author: Adrian Hunter
Date: Wed Dec 15 10:06:35 2021 +0200
perf script: Fix CPU filtering of a script's switch events
commit 5e0c325cdb714409a5b242c9e73a1b61157abb36 upstream.
CPU filtering was not being applied to a script's switch events.
Fixes: 5bf83c29a0ad2e78 ("perf script: Add scripting operation process\_switch()")
Signed-off-by: Adrian Hunter
Acked-by: Namhyung Kim
Cc: Jiri Olsa
Cc: Riccardo Mancini
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20211215080636.149562-3-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 90d273381bfbaa34ca5bc650b3cdf4ded78c1025
Author: Adrian Hunter
Date: Wed Dec 15 10:06:34 2021 +0200
perf intel-pt: Fix parsing of VM time correlation arguments
commit a78abde220243d6f44a265fe36c49957f6fa9851 upstream.
Parser did not take ':' into account.
Example:
Before:
$ perf record -e intel\_pt//u uname
Linux
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.026 MB perf.data ]
$ perf inject -i perf.data --vm-time-correlation="dry-run 123"
$ perf inject -i perf.data --vm-time-correlation="dry-run 123:456"
Failed to parse VM Time Correlation options
0x620 [0x98]: failed to process type: 70 [Invalid argument]
$
After:
$ perf inject -i perf.data --vm-time-correlation="dry-run 123:456"
$
Fixes: e3ff42bdebcfeb5f ("perf intel-pt: Parse VM Time Correlation options and set up decoding")
Signed-off-by: Adrian Hunter
Acked-by: Namhyung Kim
Cc: Jiri Olsa
Cc: Riccardo Mancini
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20211215080636.149562-2-adrian.hunter@intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Greg Kroah-Hartman
commit 47b5d0a7532d39e42a938f81e3904268145c341d
Author: Christian Brauner
Date: Thu Dec 30 20:23:09 2021 +0100
fs/mount\_setattr: always cleanup mount\_kattr
commit 012e332286e2bb9f6ac77d195f17e74b2963d663 upstream.
Make sure that finish\_mount\_kattr() is called after mount\_kattr was
succesfully built in both the success and failure case to prevent
leaking any references we took when we built it. We returned early if
path lookup failed thereby risking to leak an additional reference we
took when building mount\_kattr when an idmapped mount was requested.
Cc: linux-fsdevel@vger.kernel.org
Cc: stable@vger.kernel.org
Fixes: 9caccd41541a ("fs: introduce MOUNT\_ATTR\_IDMAP")
Signed-off-by: Christian Brauner
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 08eacbd141e2495d2fcdde84358a06c4f95cbb13
Author: Muchun Song
Date: Tue Dec 28 18:41:45 2021 +0800
net: fix use-after-free in tw\_timer\_handler
commit e22e45fc9e41bf9fcc1e92cfb78eb92786728ef0 upstream.
A real world panic issue was found as follow in Linux 5.4.
BUG: unable to handle page fault for address: ffffde49a863de28
PGD 7e6fe62067 P4D 7e6fe62067 PUD 7e6fe63067 PMD f51e064067 PTE 0
RIP: 0010:tw\_timer\_handler+0x20/0x40
Call Trace:
call\_timer\_fn+0x2b/0x120
run\_timer\_softirq+0x1ef/0x450
\_\_do\_softirq+0x10d/0x2b8
irq\_exit+0xc7/0xd0
smp\_apic\_timer\_interrupt+0x68/0x120
apic\_timer\_interrupt+0xf/0x20
This issue was also reported since 2017 in the thread [1],
unfortunately, the issue was still can be reproduced after fixing
DCCP.
The ipv4\_mib\_exit\_net is called before tcp\_sk\_exit\_batch when a net
namespace is destroyed since tcp\_sk\_ops is registered befrore
ipv4\_mib\_ops, which means tcp\_sk\_ops is in the front of ipv4\_mib\_ops
in the list of pernet\_list. There will be a use-after-free on
net->mib.net\_statistics in tw\_timer\_handler after ipv4\_mib\_exit\_net
if there are some inflight time-wait timers.
This bug is not introduced by commit f2bf415cfed7 ("mib: add net to
NET\_ADD\_STATS\_BH") since the net\_statistics is a global variable
instead of dynamic allocation and freeing. Actually, commit
61a7e26028b9 ("mib: put net statistics on struct net") introduces
the bug since it put net statistics on struct net and free it when
net namespace is destroyed.
Moving init\_ipv4\_mibs() to the front of tcp\_init() to fix this bug
and replace pr\_crit() with panic() since continuing is meaningless
when init\_ipv4\_mibs() fails.
[1] https://groups.google.com/g/syzkaller/c/p1tn-\_Kc6l4/m/smuL\_FMAAgAJ?pli=1
Fixes: 61a7e26028b9 ("mib: put net statistics on struct net")
Signed-off-by: Muchun Song
Cc: Cong Wang
Cc: Fam Zheng
Cc:
Link: https://lore.kernel.org/r/20211228104145.9426-1-songmuchun@bytedance.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Greg Kroah-Hartman
commit ffe4a1ba1a82c416a6b3a09d46594f6a885ae141
Author: SeongJae Park
Date: Thu Dec 30 20:12:34 2021 -0800
mm/damon/dbgfs: fix 'struct pid' leaks in 'dbgfs\_target\_ids\_write()'
commit ebb3f994dd92f8fb4d70c7541091216c1e10cb71 upstream.
DAMON debugfs interface increases the reference counts of 'struct pid's
for targets from the 'target\_ids' file write callback
('dbgfs\_target\_ids\_write()'), but decreases the counts only in DAMON
monitoring termination callback ('dbgfs\_before\_terminate()').
Therefore, when 'target\_ids' file is repeatedly written without DAMON
monitoring start/termination, the reference count is not decreased and
therefore memory for the 'struct pid' cannot be freed. This commit
fixes this issue by decreasing the reference counts when 'target\_ids' is
written.
Link: https://lkml.kernel.org/r/20211229124029.23348-1-sj@kernel.org
Fixes: 4bc05954d007 ("mm/damon: implement a debugfs-based user space interface")
Signed-off-by: SeongJae Park
Cc:  [5.15+]
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 466267ced87dd514fc0f64e477c3ef5bb881d4f3
Author: Leo L. Schwab
Date: Thu Dec 30 21:05:00 2021 -0800
Input: spaceball - fix parsing of movement data packets
commit bc7ec91718c49d938849697cfad98fcd9877cc26 upstream.
The spaceball.c module was not properly parsing the movement reports
coming from the device. The code read axis data as signed 16-bit
little-endian values starting at offset 2.
In fact, axis data in Spaceball movement reports are signed 16-bit
big-endian values starting at offset 3. This was determined first by
visually inspecting the data packets, and later verified by consulting:
http://spacemice.org/pdf/SpaceBall\_2003-3003\_Protocol.pdf
If this ever worked properly, it was in the time before Git...
Signed-off-by: Leo L. Schwab
Link: https://lore.kernel.org/r/20211221101630.1146385-1-ewhac@ewhac.org
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit e79ff8c68acb1eddf709d3ac84716868f2a91012
Author: Pavel Skripkin
Date: Thu Dec 30 20:57:46 2021 -0800
Input: appletouch - initialize work before device registration
commit 9f3ccdc3f6ef10084ceb3a47df0961bec6196fd0 upstream.
Syzbot has reported warning in \_\_flush\_work(). This warning is caused by
work->func == NULL, which means missing work initialization.
This may happen, since input\_dev->close() calls
cancel\_work\_sync(&dev->work), but dev->work initalization happens \_after\_
input\_register\_device() call.
So this patch moves dev->work initialization before registering input
device
Fixes: 5a6eb676d3bc ("Input: appletouch - improve powersaving for Geyser3 devices")
Reported-and-tested-by: syzbot+b88c5eae27386b252bbd@syzkaller.appspotmail.com
Signed-off-by: Pavel Skripkin
Link: https://lore.kernel.org/r/20211230141151.17300-1-paskripkin@gmail.com
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 90ffed2d5e0df2cad053c7ff1e60623980d380f4
Author: Alexey Makhalov
Date: Mon Dec 20 11:05:14 2021 -0800
scsi: vmw\_pvscsi: Set residual data length conditionally
commit 142c779d05d1fef75134c3cb63f52ccbc96d9e1f upstream.
The PVSCSI implementation in the VMware hypervisor under specific
configuration ("SCSI Bus Sharing" set to "Physical") returns zero dataLen
in the completion descriptor for READ CAPACITY(16). As a result, the kernel
can not detect proper disk geometry. This can be recognized by the kernel
message:
[ 0.776588] sd 1:0:0:0: [sdb] Sector size 0 reported, assuming 512.
The PVSCSI implementation in QEMU does not set dataLen at all, keeping it
zeroed. This leads to a boot hang as was reported by Shmulik Ladkani.
It is likely that the controller returns the garbage at the end of the
buffer. Residual length should be set by the driver in that case. The SCSI
layer will erase corresponding data. See commit bdb2b8cab439 ("[SCSI] erase
invalid data returned by device") for details.
Commit e662502b3a78 ("scsi: vmw\_pvscsi: Set correct residual data length")
introduced the issue by setting residual length unconditionally, causing
the SCSI layer to erase the useful payload beyond dataLen when this value
is returned as 0.
As a result, considering existing issues in implementations of PVSCSI
controllers, we do not want to call scsi\_set\_resid() when dataLen ==
0. Calling scsi\_set\_resid() has no effect if dataLen equals buffer length.
Link: https://lore.kernel.org/lkml/20210824120028.30d9c071@blondie/
Link: https://lore.kernel.org/r/20211220190514.55935-1-amakhalov@vmware.com
Fixes: e662502b3a78 ("scsi: vmw\_pvscsi: Set correct residual data length")
Cc: Matt Wang
Cc: Martin K. Petersen
Cc: Vishal Bhakta
Cc: VMware PV-Drivers
Cc: James E.J. Bottomley
Cc: linux-scsi@vger.kernel.org
Cc: stable@vger.kernel.org
Reported-and-suggested-by: Shmulik Ladkani
Signed-off-by: Alexey Makhalov
Signed-off-by: Martin K. Petersen
Signed-off-by: Greg Kroah-Hartman
commit 17691bada6b2f1d5f1c0f6d28cd9d0727023b0ff
Author: Todd Kjos
Date: Mon Dec 20 11:01:50 2021 -0800
binder: fix async\_free\_space accounting for empty parcels
commit cfd0d84ba28c18b531648c9d4a35ecca89ad9901 upstream.
In 4.13, commit 74310e06be4d ("android: binder: Move buffer out of area shared with user space")
fixed a kernel structure visibility issue. As part of that patch,
sizeof(void \*) was used as the buffer size for 0-length data payloads so
the driver could detect abusive clients sending 0-length asynchronous
transactions to a server by enforcing limits on async\_free\_size.
Unfortunately, on the "free" side, the accounting of async\_free\_space
did not add the sizeof(void \*) back. The result was that up to 8-bytes of
async\_free\_space were leaked on every async transaction of 8-bytes or
less. These small transactions are uncommon, so this accounting issue
has gone undetected for several years.
The fix is to use "buffer\_size" (the allocated buffer size) instead of
"size" (the logical buffer size) when updating the async\_free\_space
during the free operation. These are the same except for this
corner case of asynchronous transactions with payloads < 8 bytes.
Fixes: 74310e06be4d ("android: binder: Move buffer out of area shared with user space")
Signed-off-by: Todd Kjos
Cc: stable@vger.kernel.org # 4.14+
Link: https://lore.kernel.org/r/20211220190150.2107077-1-tkjos@google.com
Signed-off-by: Greg Kroah-Hartman
commit 90d2beed5e753805c5eab656b8d48257638fe543
Author: Andra Paraschiv
Date: Mon Dec 20 19:58:56 2021 +0000
nitro\_enclaves: Use get\_user\_pages\_unlocked() call to handle mmap assert
commit 3a0152b219523227c2a62a0a122cf99608287176 upstream.
After commit 5b78ed24e8ec ("mm/pagemap: add mmap\_assert\_locked()
annotations to find\_vma\*()"), the call to get\_user\_pages() will trigger
the mmap assert.
static inline void mmap\_assert\_locked(struct mm\_struct \*mm)
{
lockdep\_assert\_held(&mm->mmap\_lock);
VM\_BUG\_ON\_MM(!rwsem\_is\_locked(&mm->mmap\_lock), mm);
}
[ 62.521410] kernel BUG at include/linux/mmap\_lock.h:156!
...........................................................
[ 62.538938] RIP: 0010:find\_vma+0x32/0x80
...........................................................
[ 62.605889] Call Trace:
[ 62.608502]
[ 62.610956] ? lock\_timer\_base+0x61/0x80
[ 62.614106] find\_extend\_vma+0x19/0x80
[ 62.617195] \_\_get\_user\_pages+0x9b/0x6a0
[ 62.620356] \_\_gup\_longterm\_locked+0x42d/0x450
[ 62.623721] ? finish\_wait+0x41/0x80
[ 62.626748] ? \_\_kmalloc+0x178/0x2f0
[ 62.629768] ne\_set\_user\_memory\_region\_ioctl.isra.0+0x225/0x6a0 [nitro\_enclaves]
[ 62.635776] ne\_enclave\_ioctl+0x1cf/0x6d7 [nitro\_enclaves]
[ 62.639541] \_\_x64\_sys\_ioctl+0x82/0xb0
[ 62.642620] do\_syscall\_64+0x3b/0x90
[ 62.645642] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Use get\_user\_pages\_unlocked() when setting the enclave memory regions.
That's a similar pattern as mmap\_read\_lock() used together with
get\_user\_pages().
Fixes: 5b78ed24e8ec ("mm/pagemap: add mmap\_assert\_locked() annotations to find\_vma\*()")
Cc: stable@vger.kernel.org
Signed-off-by: Andra Paraschiv
Link: https://lore.kernel.org/r/20211220195856.6549-1-andraprs@amazon.com
Signed-off-by: Greg Kroah-Hartman
commit 0c823e0b469786b7ac33e8011a6566114c8aac5d
Author: Chunfeng Yun
Date: Sat Dec 18 17:57:49 2021 +0800
usb: mtu3: set interval of FS intr and isoc endpoint
commit 43f3b8cbcf93da7c2755af4a543280c31f4adf16 upstream.
Add support to set interval also for FS intr and isoc endpoint.
Fixes: 4d79e042ed8b ("usb: mtu3: add support for usb3.1 IP")
Cc: stable@vger.kernel.org
Signed-off-by: Chunfeng Yun
Link: https://lore.kernel.org/r/20211218095749.6250-4-chunfeng.yun@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit 249ddfbe00570d6dc76208e88017937d4d374c79
Author: Chunfeng Yun
Date: Sat Dec 18 17:57:48 2021 +0800
usb: mtu3: fix list\_head check warning
commit 8c313e3bfd9adae8d5c4ba1cc696dcbc86fbf9bf upstream.
This is caused by uninitialization of list\_head.
BUG: KASAN: use-after-free in \_\_list\_del\_entry\_valid+0x34/0xe4
Call trace:
dump\_backtrace+0x0/0x298
show\_stack+0x24/0x34
dump\_stack+0x130/0x1a8
print\_address\_description+0x88/0x56c
\_\_kasan\_report+0x1b8/0x2a0
kasan\_report+0x14/0x20
\_\_asan\_load8+0x9c/0xa0
\_\_list\_del\_entry\_valid+0x34/0xe4
mtu3\_req\_complete+0x4c/0x300 [mtu3]
mtu3\_gadget\_stop+0x168/0x448 [mtu3]
usb\_gadget\_unregister\_driver+0x204/0x3a0
unregister\_gadget\_item+0x44/0xa4
Fixes: 83374e035b62 ("usb: mtu3: add tracepoints to help debug")
Cc: stable@vger.kernel.org
Reported-by: Yuwen Ng
Signed-off-by: Chunfeng Yun
Link: https://lore.kernel.org/r/20211218095749.6250-3-chunfeng.yun@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit dace4123e304caf993f3b6c2f3565351d8592ef4
Author: Chunfeng Yun
Date: Sat Dec 18 17:57:47 2021 +0800
usb: mtu3: add memory barrier before set GPD's HWO
commit a7aae769ca626819a7f9f078ebdc69a8a1b00c81 upstream.
There is a seldom issue that the controller access invalid address
and trigger devapc or emimpu violation. That is due to memory access
is out of order and cause gpd data is not correct.
Add mb() to prohibit compiler or cpu from reordering to make sure GPD
is fully written before setting its HWO.
Fixes: 48e0d3735aa5 ("usb: mtu3: supports new QMU format")
Cc: stable@vger.kernel.org
Reported-by: Eddie Hung
Signed-off-by: Chunfeng Yun
Link: https://lore.kernel.org/r/20211218095749.6250-2-chunfeng.yun@mediatek.com
Signed-off-by: Greg Kroah-Hartman
commit ebef2aa29f370b5096c16020c104e393192ef684
Author: Vincent Pelletier
Date: Sat Dec 18 02:18:40 2021 +0000
usb: gadget: f\_fs: Clear ffs\_eventfd in ffs\_data\_clear.
commit b1e0887379422975f237d43d8839b751a6bcf154 upstream.
ffs\_data\_clear is indirectly called from both ffs\_fs\_kill\_sb and
ffs\_ep0\_release, so it ends up being called twice when userland closes ep0
and then unmounts f\_fs.
If userland provided an eventfd along with function's USB descriptors, it
ends up calling eventfd\_ctx\_put as many times, causing a refcount
underflow.
NULL-ify ffs\_eventfd to prevent these extraneous eventfd\_ctx\_put calls.
Also, set epfiles to NULL right after de-allocating it, for readability.
For completeness, ffs\_data\_clear actually ends up being called thrice, the
last call being before the whole ffs structure gets freed, so when this
specific sequence happens there is a second underflow happening (but not
being reported):
/sys/kernel/debug/tracing# modprobe usb\_f\_fs
/sys/kernel/debug/tracing# echo ffs\_data\_clear > set\_ftrace\_filter
/sys/kernel/debug/tracing# echo function > current\_tracer
/sys/kernel/debug/tracing# echo 1 > tracing\_on
(setup gadget, run and kill function userland process, teardown gadget)
/sys/kernel/debug/tracing# echo 0 > tracing\_on
/sys/kernel/debug/tracing# cat trace
smartcard-openp-436 [000] ..... 1946.208786: ffs\_data\_clear <-ffs\_data\_closed
smartcard-openp-431 [000] ..... 1946.279147: ffs\_data\_clear <-ffs\_data\_closed
smartcard-openp-431 [000] .n... 1946.905512: ffs\_data\_clear <-ffs\_data\_put
Warning output corresponding to above trace:
[ 1946.284139] WARNING: CPU: 0 PID: 431 at lib/refcount.c:28 refcount\_warn\_saturate+0x110/0x15c
[ 1946.293094] refcount\_t: underflow; use-after-free.
[ 1946.298164] Modules linked in: usb\_f\_ncm(E) u\_ether(E) usb\_f\_fs(E) hci\_uart(E) btqca(E) btrtl(E) btbcm(E) btintel(E) bluetooth(E) nls\_ascii(E) nls\_cp437(E) vfat(E) fat(E) bcm2835\_v4l2(CE) bcm2835\_mmal\_vchiq(CE) videobuf2\_vmalloc(E) videobuf2\_memops(E) sha512\_generic(E) videobuf2\_v4l2(E) sha512\_arm(E) videobuf2\_common(E) videodev(E) cpufreq\_dt(E) snd\_bcm2835(CE) brcmfmac(E) mc(E) vc4(E) ctr(E) brcmutil(E) snd\_soc\_core(E) snd\_pcm\_dmaengine(E) drbg(E) snd\_pcm(E) snd\_timer(E) snd(E) soundcore(E) drm\_kms\_helper(E) cec(E) ansi\_cprng(E) rc\_core(E) syscopyarea(E) raspberrypi\_cpufreq(E) sysfillrect(E) sysimgblt(E) cfg80211(E) max17040\_battery(OE) raspberrypi\_hwmon(E) fb\_sys\_fops(E) regmap\_i2c(E) ecdh\_generic(E) rfkill(E) ecc(E) bcm2835\_rng(E) rng\_core(E) vchiq(CE) leds\_gpio(E) libcomposite(E) fuse(E) configfs(E) ip\_tables(E) x\_tables(E) autofs4(E) ext4(E) crc16(E) mbcache(E) jbd2(E) crc32c\_generic(E) sdhci\_iproc(E) sdhci\_pltfm(E) sdhci(E)
[ 1946.399633] CPU: 0 PID: 431 Comm: smartcard-openp Tainted: G C OE 5.15.0-1-rpi #1 Debian 5.15.3-1
[ 1946.417950] Hardware name: BCM2835
[ 1946.425442] Backtrace:
[ 1946.432048] [] (dump\_backtrace) from [] (show\_stack+0x20/0x24)
[ 1946.448226] r7:00000009 r6:0000001c r5:c04a948c r4:c0a64e2c
[ 1946.458412] [] (show\_stack) from [] (dump\_stack+0x28/0x30)
[ 1946.470380] [] (dump\_stack) from [] (\_\_warn+0xe8/0x154)
[ 1946.482067] r5:c04a948c r4:c0a71dc8
[ 1946.490184] [] (\_\_warn) from [] (warn\_slowpath\_fmt+0xa0/0xe4)
[ 1946.506758] r7:00000009 r6:0000001c r5:c0a71dc8 r4:c0a71e04
[ 1946.517070] [] (warn\_slowpath\_fmt) from [] (refcount\_warn\_saturate+0x110/0x15c)
[ 1946.535309] r8:c0100224 r7:c0dfcb84 r6:ffffffff r5:c3b84c00 r4:c24a17c0
[ 1946.546708] [] (refcount\_warn\_saturate) from [] (eventfd\_ctx\_put+0x48/0x74)
[ 1946.564476] [] (eventfd\_ctx\_put) from [] (ffs\_data\_clear+0xd0/0x118 [usb\_f\_fs])
[ 1946.582664] r5:c3b84c00 r4:c2695b00
[ 1946.590668] [] (ffs\_data\_clear [usb\_f\_fs]) from [] (ffs\_data\_closed+0x9c/0x150 [usb\_f\_fs])
[ 1946.609608] r5:bf54d014 r4:c2695b00
[ 1946.617522] [] (ffs\_data\_closed [usb\_f\_fs]) from [] (ffs\_fs\_kill\_sb+0x2c/0x30 [usb\_f\_fs])
[ 1946.636217] r7:c0dfcb84 r6:c3a12260 r5:bf54d014 r4:c229f000
[ 1946.646273] [] (ffs\_fs\_kill\_sb [usb\_f\_fs]) from [] (deactivate\_locked\_super+0x54/0x9c)
[ 1946.664893] r5:bf54d014 r4:c229f000
[ 1946.672921] [] (deactivate\_locked\_super) from [] (deactivate\_super+0x60/0x64)
[ 1946.690722] r5:c2a09000 r4:c229f000
[ 1946.698706] [] (deactivate\_super) from [] (cleanup\_mnt+0xe4/0x14c)
[ 1946.715553] r5:c2a09000 r4:00000000
[ 1946.723528] [] (cleanup\_mnt) from [] (\_\_cleanup\_mnt+0x1c/0x20)
[ 1946.739922] r7:c0dfcb84 r6:c3a12260 r5:c3a126fc r4:00000000
[ 1946.750088] [] (\_\_cleanup\_mnt) from [] (task\_work\_run+0x84/0xb8)
[ 1946.766602] [] (task\_work\_run) from [] (do\_work\_pending+0x470/0x56c)
[ 1946.783540] r7:5ac3c35a r6:c0d0424c r5:c200bfb0 r4:c200a000
[ 1946.793614] [] (do\_work\_pending) from [] (slow\_work\_pending+0xc/0x20)
[ 1946.810553] Exception stack(0xc200bfb0 to 0xc200bff8)
[ 1946.820129] bfa0: 00000000 00000000 000000aa b5e21430
[ 1946.837104] bfc0: bef867a0 00000001 bef86840 00000034 bef86838 bef86790 bef86794 bef867a0
[ 1946.854125] bfe0: 00000000 bef86798 b67b7a1c b6d626a4 60000010 b5a23760
[ 1946.865335] r10:00000000 r9:c200a000 r8:c0100224 r7:00000034 r6:bef86840 r5:00000001
[ 1946.881914] r4:bef867a0
[ 1946.888793] ---[ end trace 7387f2a9725b28d0 ]---
Fixes: 5e33f6fdf735 ("usb: gadget: ffs: add eventfd notification about ffs events")
Cc: stable
Signed-off-by: Vincent Pelletier
Link: https://lore.kernel.org/r/f79eeea29f3f98de6782a064ec0f7351ad2f598f.1639793920.git.plr.vincent@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 81f8de4b6af6713871d8cae6f72d8972dea857fd
Author: Mathias Nyman
Date: Tue Dec 21 13:28:25 2021 +0200
xhci: Fresco FL1100 controller should not have BROKEN\_MSI quirk set.
commit e4844092581ceec22489b66c42edc88bc6079783 upstream.
The Fresco Logic FL1100 controller needs the TRUST\_TX\_LENGTH quirk like
other Fresco controllers, but should not have the BROKEN\_MSI quirks set.
BROKEN\_MSI quirk causes issues in detecting usb drives connected to docks
with this FL1100 controller.
The BROKEN\_MSI flag was apparently accidentally set together with the
TRUST\_TX\_LENGTH quirk
Original patch went to stable so this should go there as well.
Fixes: ea0f69d82119 ("xhci: Enable trust tx length quirk for Fresco FL11 USB controller")
Cc: stable@vger.kernel.org
cc: Nikolay Martynov
Signed-off-by: Mathias Nyman
Link: https://lore.kernel.org/r/20211221112825.54690-2-mathias.nyman@linux.intel.com
Signed-off-by: Greg Kroah-Hartman
commit 0f591d17e36e08313b0c440b99b0e57b47e01a9a
Author: Angus Wang
Date: Thu Dec 9 17:27:01 2021 -0500
drm/amd/display: Changed pipe split policy to allow for multi-display pipe split
commit ee2698cf79cc759a397c61086c758d4cc85938bf upstream.
[WHY]
Current implementation of pipe split policy prevents pipe split with
multiple displays connected, which caused the MCLK speed to be stuck at
max
[HOW]
Changed the pipe split policies so that pipe split is allowed for
multi-display configurations
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1522
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1709
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1655
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1403
Note this is a backport of this commit from amdgpu drm-next for 5.16.
Tested-by: Daniel Wheeler
Reviewed-by: Aric Cyr
Acked-by: Rodrigo Siqueira
Signed-off-by: Angus Wang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 94ba5b0fb52d6dbf1f200351876a839afb74aedd
Author: Alex Deucher
Date: Wed Dec 15 22:13:56 2021 -0500
drm/amdgpu: add support for IP discovery gc\_info table v2
commit 5e713c6afa34c0fd6f113bf7bb1c2847172d7b20 upstream.
Used on gfx9 based systems. Fixes incorrect CU counts reported
in the kernel log.
Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1833
Reviewed-by: Hawking Zhang
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 97fd2b6c0340ad06872feda449bf6168ee56a35a
Author: chen gong
Date: Thu Dec 9 19:47:10 2021 +0800
drm/amdgpu: When the VCN(1.0) block is suspended, powergating is explicitly enabled
commit b7865173cf6ae59942e2c69326a06e1c1df5ecf6 upstream.
Play a video on the raven (or PCO, raven2) platform, and then do the S3
test. When resume, the following error will be reported:
amdgpu 0000:02:00.0: [drm:amdgpu\_ring\_test\_helper [amdgpu]] \*ERROR\* ring
vcn\_dec test failed (-110)
[drm:amdgpu\_device\_ip\_resume\_phase2 [amdgpu]] \*ERROR\* resume of IP block
 failed -110
amdgpu 0000:02:00.0: amdgpu: amdgpu\_device\_ip\_resume failed (-110).
PM: dpm\_run\_callback(): pci\_pm\_resume+0x0/0x90 returns -110
[why]
When playing the video: The power state flag of the vcn block is set to
POWER\_STATE\_ON.
When doing suspend: There is no change to the power state flag of the
vcn block, it is still POWER\_STATE\_ON.
When doing resume: Need to open the power gate of the vcn block and set
the power state flag of the VCN block to POWER\_STATE\_ON.
But at this time, the power state flag of the vcn block is already
POWER\_STATE\_ON. The power status flag check in the "8f2cdef drm/amd/pm:
avoid duplicate powergate/ungate setting" patch will return the
amdgpu\_dpm\_set\_powergating\_by\_smu function directly.
As a result, the gate of the power was not opened, causing the
subsequent ring test to fail.
[how]
In the suspend function of the vcn block, explicitly change the power
state flag of the vcn block to POWER\_STATE\_OFF.
BugLink: https://gitlab.freedesktop.org/drm/amd/-/issues/1828
Signed-off-by: chen gong
Reviewed-by: Evan Quan
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit 2ee1296e06555a0a3678c25982d23788c1e1acd2
Author: Christian König
Date: Tue Dec 7 10:10:15 2021 +0100
drm/nouveau: wait for the exclusive fence after the shared ones v2
commit 67f74302f45d5d862f22ced3297624e50ac352f0 upstream.
Always waiting for the exclusive fence resulted on some performance
regressions. So try to wait for the shared fences first, then the
exclusive fence should always be signaled already.
v2: fix incorrectly placed "(", add some comment why we do this.
Signed-off-by: Christian König
Tested-by: Stefan Fritsch
Tested-by: Dan Moulding
Acked-by: Ben Skeggs
Signed-off-by: Christian König
Cc:
Link: https://patchwork.freedesktop.org/patch/msgid/20211209102335.18321-1-christian.koenig@amd.com
Signed-off-by: Greg Kroah-Hartman
commit e6310938479696675fca9657d99dbad4042dbbf1
Author: Dmitry V. Levin
Date: Sun Dec 26 16:01:27 2021 +0300
uapi: fix linux/nfc.h userspace compilation errors
commit 7175f02c4e5f5a9430113ab9ca0fd0ce98b28a51 upstream.
Replace sa\_family\_t with \_\_kernel\_sa\_family\_t to fix the following
linux/nfc.h userspace compilation errors:
/usr/include/linux/nfc.h:266:2: error: unknown type name 'sa\_family\_t'
sa\_family\_t sa\_family;
/usr/include/linux/nfc.h:274:2: error: unknown type name 'sa\_family\_t'
sa\_family\_t sa\_family;
Fixes: 23b7869c0fd0 ("NFC: add the NFC socket raw protocol")
Fixes: d646960f7986 ("NFC: Initial LLCP support")
Cc:
Signed-off-by: Dmitry V. Levin
Reviewed-by: Krzysztof Kozlowski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit 7b006d5a5aad0c6a2658abcc4db25b65449f9113
Author: Krzysztof Kozlowski
Date: Sun Dec 26 13:03:47 2021 +0100
nfc: uapi: use kernel size\_t to fix user-space builds
commit 79b69a83705e621b258ac6d8ae6d3bfdb4b930aa upstream.
Fix user-space builds if it includes /usr/include/linux/nfc.h before
some of other headers:
/usr/include/linux/nfc.h:281:9: error: unknown type name ‘size\_t’
281 | size\_t service\_name\_len;
| ^~~~~~
Fixes: d646960f7986 ("NFC: Initial LLCP support")
Cc:
Signed-off-by: Krzysztof Kozlowski
Signed-off-by: David S. Miller
Signed-off-by: Greg Kroah-Hartman
commit f68599581067e8a5a8901ba9eb270b4519690e26
Author: Pavel Skripkin
Date: Fri Dec 31 01:47:50 2021 +0300
i2c: validate user data in compat ioctl
[ Upstream commit bb436283e25aaf1533ce061605d23a9564447bdf ]
Wrong user data may cause warning in i2c\_transfer(), ex: zero msgs.
Userspace should not be able to trigger warnings, so this patch adds
validation checks for user data in compact ioctl to prevent reported
warnings
Reported-and-tested-by: syzbot+e417648b303855b91d8a@syzkaller.appspotmail.com
Fixes: 7d5cb45655f2 ("i2c compat ioctls: move to ->compat\_ioctl()")
Signed-off-by: Pavel Skripkin
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 17f5a2bc2ffed2ba8240308b99ba730249516c1b
Author: Miaoqian Lin
Date: Thu Dec 30 12:26:27 2021 +0000
fsl/fman: Fix missing put\_device() call in fman\_port\_probe
[ Upstream commit bf2b09fedc17248b315f80fb249087b7d28a69a6 ]
The reference taken by 'of\_find\_device\_by\_node()' must be released when
not needed anymore.
Add the corresponding 'put\_device()' in the and error handling paths.
Fixes: 18a6c85fcc78 ("fsl/fman: Add FMan Port Support")
Signed-off-by: Miaoqian Lin
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 20426341c071aee68ff04558c208582bae11e435
Author: Jianguo Wu
Date: Thu Dec 30 18:40:29 2021 +0800
selftests: net: using ping6 for IPv6 in udpgro\_fwd.sh
[ Upstream commit 8b3170e07539855ee91bc5e2fa7780a4c9b5c7aa ]
udpgro\_fwd.sh output following message:
ping: 2001:db8:1::100: Address family for hostname not supported
Using ping6 when pinging IPv6 addresses.
Fixes: a062260a9d5f ("selftests: net: add UDP GRO forwarding self-tests")
Signed-off-by: Jianguo Wu
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6eb92fb14689d0fa2064a4a28311bfc8d7cc54f5
Author: Jiasheng Jiang
Date: Wed Dec 29 11:21:18 2021 +0800
net/ncsi: check for error return from call to nla\_put\_u32
[ Upstream commit 92a34ab169f9eefe29cd420ce96b0a0a2a1da853 ]
As we can see from the comment of the nla\_put() that it could return
-EMSGSIZE if the tailroom of the skb is insufficient.
Therefore, it should be better to check the return value of the
nla\_put\_u32 and return the error code if error accurs.
Also, there are many other functions have the same problem, and if this
patch is correct, I will commit a new version to fix all.
Fixes: 955dc68cb9b2 ("net/ncsi: Add generic netlink family")
Signed-off-by: Jiasheng Jiang
Link: https://lore.kernel.org/r/20211229032118.1706294-1-jiasheng@iscas.ac.cn
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 62320f472fc235560926feb32dc1f64adf4c1387
Author: Nikolay Aleksandrov
Date: Tue Dec 28 17:31:42 2021 +0200
net: bridge: mcast: fix br\_multicast\_ctx\_vlan\_global\_disabled helper
[ Upstream commit 168fed986b3a7ec7b98cab1fe84e2f282b9e6a8f ]
We need to first check if the context is a vlan one, then we need to
check the global bridge multicast vlan snooping flag, and finally the
vlan's multicast flag, otherwise we will unnecessarily enable vlan mcast
processing (e.g. querier timers).
Fixes: 7b54aaaf53cb ("net: bridge: multicast: add vlan state initialization and control")
Signed-off-by: Nikolay Aleksandrov
Link: https://lore.kernel.org/r/20211228153142.536969-1-nikolay@nvidia.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 5943eb7bbac34b5eedfb2fabbd8298dd0988a85f
Author: Jianguo Wu
Date: Wed Dec 29 15:27:30 2021 +0800
selftests: net: Fix a typo in udpgro\_fwd.sh
[ Upstream commit add25d6d6c85f7b6d00a055ee0a4169acf845681 ]
$rvs -> $rcv
Fixes: a062260a9d5f ("selftests: net: add UDP GRO forwarding self-tests")
Signed-off-by: Jianguo Wu
Link: https://lore.kernel.org/r/d247d7c8-a03a-0abf-3c71-4006a051d133@163.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 676345fa9c5587480c1bf657a54f148a2756e93e
Author: wujianguo
Date: Wed Dec 29 18:58:10 2021 +0800
selftests/net: udpgso\_bench\_tx: fix dst ip argument
[ Upstream commit 9c1952aeaa98b3cfc49e2a79cb2c7d6a674213e9 ]
udpgso\_bench\_tx call setup\_sockaddr() for dest address before
parsing all arguments, if we specify "-p ${dst\_port}" after "-D ${dst\_ip}",
then ${dst\_port} will be ignored, and using default cfg\_port 8000.
This will cause test case "multiple GRO socks" failed in udpgro.sh.
Setup sockaddr after parsing all arguments.
Fixes: 3a687bef148d ("selftests: udp gso benchmark")
Signed-off-by: Jianguo Wu
Reviewed-by: Willem de Bruijn
Link: https://lore.kernel.org/r/ff620d9f-5b52-06ab-5286-44b945453002@163.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit f1157fe47992a9210b96752071ab679354771f61
Author: Nikolay Aleksandrov
Date: Mon Dec 27 19:21:16 2021 +0200
net: bridge: mcast: add and enforce startup query interval minimum
[ Upstream commit f83a112bd91a494cdee671aec74e777470fb4a07 ]
As reported[1] if startup query interval is set too low in combination with
large number of startup queries and we have multiple bridges or even a
single bridge with multiple querier vlans configured we can crash the
machine. Add a 1 second minimum which must be enforced by overwriting the
value if set lower (i.e. without returning an error) to avoid breaking
user-space. If that happens a log message is emitted to let the admin know
that the startup interval has been set to the minimum. It doesn't make
sense to make the startup interval lower than the normal query interval
so use the same value of 1 second. The issue has been present since these
intervals could be user-controlled.
[1] https://lore.kernel.org/netdev/e8b9ce41-57b9-b6e2-a46a-ff9c791cf0ba@gmail.com/
Fixes: d902eee43f19 ("bridge: Add multicast count/interval sysfs entries")
Reported-by: Eric Dumazet
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a22ac8009f7e747e2bc1c76679bf1505718e2400
Author: Nikolay Aleksandrov
Date: Mon Dec 27 19:21:15 2021 +0200
net: bridge: mcast: add and enforce query interval minimum
[ Upstream commit 99b40610956a8a8755653a67392e2a8b772453be ]
As reported[1] if query interval is set too low and we have multiple
bridges or even a single bridge with multiple querier vlans configured
we can crash the machine. Add a 1 second minimum which must be enforced
by overwriting the value if set lower (i.e. without returning an error) to
avoid breaking user-space. If that happens a log message is emitted to let
the administrator know that the interval has been set to the minimum.
The issue has been present since these intervals could be user-controlled.
[1] https://lore.kernel.org/netdev/e8b9ce41-57b9-b6e2-a46a-ff9c791cf0ba@gmail.com/
Fixes: d902eee43f19 ("bridge: Add multicast count/interval sysfs entries")
Reported-by: Eric Dumazet
Signed-off-by: Nikolay Aleksandrov
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a780f0dd250776234bcb5ff67ed4a8e7e3d1d89c
Author: Gal Pressman
Date: Mon Nov 29 11:08:41 2021 +0200
net/mlx5e: Fix wrong features assignment in case of error
[ Upstream commit 992d8a4e38f0527f24e273ce3a9cd6dea1a6a436 ]
In case of an error in mlx5e\_set\_features(), 'netdev->features' must be
updated with the correct state of the device to indicate which features
were updated successfully.
To do that we maintain a copy of 'netdev->features' and update it after
successful feature changes, so we can assign it to back to
'netdev->features' if needed.
However, since not all netdev features are handled by the driver (e.g.
GRO/TSO/etc), some features may not be updated correctly in case of an
error updating another feature.
For example, while requesting to disable TSO (feature which is not
handled by the driver) and enable HW-GRO, if an error occurs during
HW-GRO enable, 'oper\_features' will be assigned with 'netdev->features'
and HW-GRO turned off. TSO will remain enabled in such case, which is a
bug.
To solve that, instead of using 'netdev->features' as the baseline of
'oper\_features' and changing it on set feature success, use 'features'
instead and update it in case of errors.
Fixes: 75b81ce719b7 ("net/mlx5e: Don't override netdev features field unless in error flow")
Signed-off-by: Gal Pressman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 30a26a8c506fd25bc16094970f4bee587f540145
Author: Christophe JAILLET
Date: Sun Dec 26 15:06:17 2021 +0100
ionic: Initialize the 'lif->dbid\_inuse' bitmap
[ Upstream commit 140c7bc7d1195750342ea0e6ab76179499ae7cd7 ]
When allocated, this bitmap is not initialized. Only the first bit is set a
few lines below.
Use bitmap\_zalloc() to make sure that it is cleared before being used.
Fixes: 6461b446f2a0 ("ionic: Add interrupts and doorbells")
Signed-off-by: Christophe JAILLET
Signed-off-by: Shannon Nelson
Link: https://lore.kernel.org/r/6a478eae0b5e6c63774e1f0ddb1a3f8c38fa8ade.1640527506.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit a3dffd1d067782642138c290bb93049fd52cd00c
Author: Nicholas Kazlauskas
Date: Thu Dec 9 16:05:36 2021 -0500
drm/amd/display: Set optimize\_pwr\_state for DCN31
[ Upstream commit 33735c1c8d0223170d79dbe166976d9cd7339c7a ]
[Why]
We'll exit optimized power state to do link detection but we won't enter
back into the optimized power state.
This could potentially block s2idle entry depending on the sequencing,
but it also means we're losing some power during the transition period.
[How]
Hook up the handler like DCN21. It was also missed like the
exit\_optimized\_pwr\_state callback.
Fixes: 64b1d0e8d500 ("drm/amd/display: Add DCN3.1 HWSEQ")
Tested-by: Daniel Wheeler
Reviewed-by: Eric Yang
Acked-by: Rodrigo Siqueira
Signed-off-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 6af58ce9307f3c8939de7fb4fce077e7dff8fe44
Author: Nicholas Kazlauskas
Date: Thu Dec 9 13:53:36 2021 -0500
drm/amd/display: Send s0i2\_rdy in stream\_count == 0 optimization
[ Upstream commit a07f8b9983543d465b50870ab4f845d4d710ed3f ]
[Why]
Otherwise SMU won't mark Display as idle when trying to perform s2idle.
[How]
Mark the bit in the dcn31 codepath, doesn't apply to older ASIC.
It needed to be split from phy refclk off to prevent entering s2idle
when PSR was engaged but driver was not ready.
Fixes: 118a33151658 ("drm/amd/display: Add DCN3.1 clock manager support")
Tested-by: Daniel Wheeler
Reviewed-by: Eric Yang
Acked-by: Rodrigo Siqueira
Signed-off-by: Nicholas Kazlauskas
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit a87eb54df52f8ae3359668f8a86bb0c1cc7977b6
Author: James McLaughlin
Date: Fri Dec 17 16:49:33 2021 -0700
igc: Fix TX timestamp support for non-MSI-X platforms
[ Upstream commit f85846bbf43de38fb2c89fe7d2a085608c4eb25a ]
Time synchronization was not properly enabled on non-MSI-X platforms.
Fixes: 2c344ae24501 ("igc: Add support for TX timestamping")
Signed-off-by: James McLaughlin
Reviewed-by: Vinicius Costa Gomes
Tested-by: Nechama Kraus
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 10597585d7937d4ffd5fd4a89061eff480e8bac5
Author: Vinicius Costa Gomes
Date: Mon Dec 13 16:39:49 2021 -0800
igc: Do not enable crosstimestamping for i225-V models
[ Upstream commit 1e81dcc1ab7de7a789e60042ce82d5a612632599 ]
It was reported that when PCIe PTM is enabled, some lockups could
be observed with some integrated i225-V models.
While the issue is investigated, we can disable crosstimestamp for
those models and see no loss of functionality, because those models
don't have any support for time synchronization.
Fixes: a90ec8483732 ("igc: Add support for PTP getcrosststamp()")
Link: https://lore.kernel.org/all/924175a188159f4e03bd69908a91e606b574139b.camel@gmx.de/
Reported-by: Stefan Dietrich
Signed-off-by: Vinicius Costa Gomes
Tested-by: Nechama Kraus
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit b85f751d71ae8e2a15e9bda98852ea9af35282eb
Author: Dust Li
Date: Tue Dec 28 17:03:25 2021 +0800
net/smc: fix kernel panic caused by race of smc\_sock
[ Upstream commit 349d43127dac00c15231e8ffbcaabd70f7b0e544 ]
A crash occurs when smc\_cdc\_tx\_handler() tries to access smc\_sock
but smc\_release() has already freed it.
[ 4570.695099] BUG: unable to handle page fault for address: 000000002eae9e88
[ 4570.696048] #PF: supervisor write access in kernel mode
[ 4570.696728] #PF: error\_code(0x0002) - not-present page
[ 4570.697401] PGD 0 P4D 0
[ 4570.697716] Oops: 0002 [#1] PREEMPT SMP NOPTI
[ 4570.698228] CPU: 0 PID: 0 Comm: swapper/0 Not tainted 5.16.0-rc4+ #111
[ 4570.699013] Hardware name: Alibaba Cloud Alibaba Cloud ECS, BIOS 8c24b4c 04/0
[ 4570.699933] RIP: 0010:\_raw\_spin\_lock+0x1a/0x30
<...>
[ 4570.711446] Call Trace:
[ 4570.711746]
[ 4570.711992] smc\_cdc\_tx\_handler+0x41/0xc0
[ 4570.712470] smc\_wr\_tx\_tasklet\_fn+0x213/0x560
[ 4570.712981] ? smc\_cdc\_tx\_dismisser+0x10/0x10
[ 4570.713489] tasklet\_action\_common.isra.17+0x66/0x140
[ 4570.714083] \_\_do\_softirq+0x123/0x2f4
[ 4570.714521] irq\_exit\_rcu+0xc4/0xf0
[ 4570.714934] common\_interrupt+0xba/0xe0
Though smc\_cdc\_tx\_handler() checked the existence of smc connection,
smc\_release() may have already dismissed and released the smc socket
before smc\_cdc\_tx\_handler() further visits it.
smc\_cdc\_tx\_handler() |smc\_release()
if (!conn) |
|
|smc\_cdc\_tx\_dismiss\_slots()
| smc\_cdc\_tx\_dismisser()
|
|sock\_put(&smc->sk) <- last sock\_put,
| smc\_sock freed
bh\_lock\_sock(&smc->sk) (panic) |
To make sure we won't receive any CDC messages after we free the
smc\_sock, add a refcount on the smc\_connection for inflight CDC
message(posted to the QP but haven't received related CQE), and
don't release the smc\_connection until all the inflight CDC messages
haven been done, for both success or failed ones.
Using refcount on CDC messages brings another problem: when the link
is going to be destroyed, smcr\_link\_clear() will reset the QP, which
then remove all the pending CQEs related to the QP in the CQ. To make
sure all the CQEs will always come back so the refcount on the
smc\_connection can always reach 0, smc\_ib\_modify\_qp\_reset() was replaced
by smc\_ib\_modify\_qp\_error().
And remove the timeout in smc\_wr\_tx\_wait\_no\_pending\_sends() since we
need to wait for all pending WQEs done, or we may encounter use-after-
free when handling CQEs.
For IB device removal routine, we need to wait for all the QPs on that
device been destroyed before we can destroy CQs on the device, or
the refcount on smc\_connection won't reach 0 and smc\_sock cannot be
released.
Fixes: 5f08318f617b ("smc: connection data control (CDC)")
Reported-by: Wen Gu
Signed-off-by: Dust Li
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 85ce25935e06ccfbf89e502acb816c0841a8b59d
Author: Dust Li
Date: Tue Dec 28 17:03:24 2021 +0800
net/smc: don't send CDC/LLC message if link not ready
[ Upstream commit 90cee52f2e780345d3629e278291aea5ac74f40f ]
We found smc\_llc\_send\_link\_delete\_all() sometimes wait
for 2s timeout when testing with RDMA link up/down.
It is possible when a smc\_link is in ACTIVATING state,
the underlaying QP is still in RESET or RTR state, which
cannot send any messages out.
smc\_llc\_send\_link\_delete\_all() use smc\_link\_usable() to
checks whether the link is usable, if the QP is still in
RESET or RTR state, but the smc\_link is in ACTIVATING, this
LLC message will always fail without any CQE entering the
CQ, and we will always wait 2s before timeout.
Since we cannot send any messages through the QP before
the QP enter RTS. I add a wrapper smc\_link\_sendable()
which checks the state of QP along with the link state.
And replace smc\_link\_usable() with smc\_link\_sendable()
in all LLC & CDC message sending routine.
Fixes: 5f08318f617b ("smc: connection data control (CDC)")
Signed-off-by: Dust Li
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 238920381b8925d070d32d73cd9ce52ab29896fe
Author: Wei Yongjun
Date: Tue Dec 28 12:48:11 2021 +0000
NFC: st21nfca: Fix memory leak in device probe and remove
[ Upstream commit 1b9dadba502234eea7244879b8d5d126bfaf9f0c ]
'phy->pending\_skb' is alloced when device probe, but forgot to free
in the error handling path and remove path, this cause memory leak
as follows:
unreferenced object 0xffff88800bc06800 (size 512):
comm "8", pid 11775, jiffies 4295159829 (age 9.032s)
hex dump (first 32 bytes):
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................
backtrace:
[<00000000d66c09ce>] \_\_kmalloc\_node\_track\_caller+0x1ed/0x450
[<00000000c93382b3>] kmalloc\_reserve+0x37/0xd0
[<000000005fea522c>] \_\_alloc\_skb+0x124/0x380
[<0000000019f29f9a>] st21nfca\_hci\_i2c\_probe+0x170/0x8f2
Fix it by freeing 'pending\_skb' in error and remove.
Fixes: 68957303f44a ("NFC: ST21NFCA: Add driver for STMicroelectronics ST21NFCA NFC Chip")
Reported-by: Hulk Robot
Signed-off-by: Wei Yongjun
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c1babfe1b8109646e6d6f50e5192253cb153c499
Author: Aleksander Jan Bajkowski
Date: Mon Dec 27 17:22:03 2021 +0100
net: lantiq\_xrx200: fix statistics of received bytes
[ Upstream commit 5be60a945329d82f06fc755a43eeefbfc5f77d72 ]
Received frames have FCS truncated. There is no need
to subtract FCS length from the statistics.
Fixes: fe1a56420cf2 ("net: lantiq: Add Lantiq / Intel VRX200 Ethernet driver")
Signed-off-by: Aleksander Jan Bajkowski
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit c903a963b7e60a4016fdeb307047465fbc67feb1
Author: Christophe JAILLET
Date: Sun Dec 26 18:51:44 2021 +0100
net: ag71xx: Fix a potential double free in error handling paths
[ Upstream commit 1cd5384c88af5b59bf9f3b6c1a151bc14b88c2cd ]
'ndev' is a managed resource allocated with devm\_alloc\_etherdev(), so there
is no need to call free\_netdev() explicitly or there will be a double
free().
Simplify all error handling paths accordingly.
Fixes: d51b6ce441d3 ("net: ethernet: add ag71xx driver")
Signed-off-by: Christophe JAILLET
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 0d82faa347a13aaf7e583c20fe2d1a1d4f3a8f08
Author: Matthias-Christian Ott
Date: Sun Dec 26 23:12:08 2021 +0100
net: usb: pegasus: Do not drop long Ethernet frames
[ Upstream commit ca506fca461b260ab32952b610c3d4aadc6c11fd ]
The D-Link DSB-650TX (2001:4002) is unable to receive Ethernet frames
that are longer than 1518 octets, for example, Ethernet frames that
contain 802.1Q VLAN tags.
The frames are sent to the pegasus driver via USB but the driver
discards them because they have the Long\_pkt field set to 1 in the
received status report. The function read\_bulk\_callback of the pegasus
driver treats such received "packets" (in the terminology of the
hardware) as errors but the field simply does just indicate that the
Ethernet frame (MAC destination to FCS) is longer than 1518 octets.
It seems that in the 1990s there was a distinction between
"giant" (> 1518) and "runt" (< 64) frames and the hardware includes
flags to indicate this distinction. It seems that the purpose of the
distinction "giant" frames was to not allow infinitely long frames due
to transmission errors and to allow hardware to have an upper limit of
the frame size. However, the hardware already has such limit with its
2048 octet receive buffer and, therefore, Long\_pkt is merely a
convention and should not be treated as a receive error.
Actually, the hardware is even able to receive Ethernet frames with 2048
octets which exceeds the claimed limit frame size limit of the driver of
1536 octets (PEGASUS\_MTU).
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Matthias-Christian Ott
Reviewed-by: Andrew Lunn
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit cc70cbd3b1554b600a6cb10ae2bbbbb98f5f4956
Author: Karsten Graul
Date: Mon Dec 27 14:35:30 2021 +0100
net/smc: fix using of uninitialized completions
[ Upstream commit 6d7373dabfd3933ee30c40fc8c09d2a788f6ece1 ]
In smc\_wr\_tx\_send\_wait() the completion on index specified by
pend->idx is initialized and after smc\_wr\_tx\_send() was called the wait
for completion starts. pend->idx is used to get the correct index for
the wait, but the pend structure could already be cleared in
smc\_wr\_tx\_process\_cqe().
Introduce pnd\_idx to hold and use a local copy of the correct index.
Fixes: 09c61d24f96d ("net/smc: wait for departure of an IB message")
Signed-off-by: Karsten Graul
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 75799e71df1da11394740b43ae5686646179561d
Author: Xin Long
Date: Thu Dec 23 13:04:30 2021 -0500
sctp: use call\_rcu to free endpoint
[ Upstream commit 5ec7d18d1813a5bead0b495045606c93873aecbb ]
This patch is to delay the endpoint free by calling call\_rcu() to fix
another use-after-free issue in sctp\_sock\_dump():
BUG: KASAN: use-after-free in \_\_lock\_acquire+0x36d9/0x4c20
Call Trace:
\_\_lock\_acquire+0x36d9/0x4c20 kernel/locking/lockdep.c:3218
lock\_acquire+0x1ed/0x520 kernel/locking/lockdep.c:3844
\_\_raw\_spin\_lock\_bh include/linux/spinlock\_api\_smp.h:135 [inline]
\_raw\_spin\_lock\_bh+0x31/0x40 kernel/locking/spinlock.c:168
spin\_lock\_bh include/linux/spinlock.h:334 [inline]
\_\_lock\_sock+0x203/0x350 net/core/sock.c:2253
lock\_sock\_nested+0xfe/0x120 net/core/sock.c:2774
lock\_sock include/net/sock.h:1492 [inline]
sctp\_sock\_dump+0x122/0xb20 net/sctp/diag.c:324
sctp\_for\_each\_transport+0x2b5/0x370 net/sctp/socket.c:5091
sctp\_diag\_dump+0x3ac/0x660 net/sctp/diag.c:527
\_\_inet\_diag\_dump+0xa8/0x140 net/ipv4/inet\_diag.c:1049
inet\_diag\_dump+0x9b/0x110 net/ipv4/inet\_diag.c:1065
netlink\_dump+0x606/0x1080 net/netlink/af\_netlink.c:2244
\_\_netlink\_dump\_start+0x59a/0x7c0 net/netlink/af\_netlink.c:2352
netlink\_dump\_start include/linux/netlink.h:216 [inline]
inet\_diag\_handler\_cmd+0x2ce/0x3f0 net/ipv4/inet\_diag.c:1170
\_\_sock\_diag\_cmd net/core/sock\_diag.c:232 [inline]
sock\_diag\_rcv\_msg+0x31d/0x410 net/core/sock\_diag.c:263
netlink\_rcv\_skb+0x172/0x440 net/netlink/af\_netlink.c:2477
sock\_diag\_rcv+0x2a/0x40 net/core/sock\_diag.c:274
This issue occurs when asoc is peeled off and the old sk is freed after
getting it by asoc->base.sk and before calling lock\_sock(sk).
To prevent the sk free, as a holder of the sk, ep should be alive when
calling lock\_sock(). This patch uses call\_rcu() and moves sock\_put and
ep free into sctp\_endpoint\_destroy\_rcu(), so that it's safe to try to
hold the ep under rcu\_read\_lock in sctp\_transport\_traverse\_process().
If sctp\_endpoint\_hold() returns true, it means this ep is still alive
and we have held it and can continue to dump it; If it returns false,
it means this ep is dead and can be freed after rcu\_read\_unlock, and
we should skip it.
In sctp\_sock\_dump(), after locking the sk, if this ep is different from
tsp->asoc->ep, it means during this dumping, this asoc was peeled off
before calling lock\_sock(), and the sk should be skipped; If this ep is
the same with tsp->asoc->ep, it means no peeloff happens on this asoc,
and due to lock\_sock, no peeloff will happen either until release\_sock.
Note that delaying endpoint free won't delay the port release, as the
port release happens in sctp\_endpoint\_destroy() before calling call\_rcu().
Also, freeing endpoint by call\_rcu() makes it safe to access the sk by
asoc->base.sk in sctp\_assocs\_seq\_show() and sctp\_rcv().
Thanks Jones to bring this issue up.
v1->v2:
- improve the changelog.
- add kfree(ep) into sctp\_endpoint\_destroy\_rcu(), as Jakub noticed.
Reported-by: syzbot+9276d76e83e3bcde6c99@syzkaller.appspotmail.com
Reported-by: Lee Jones
Fixes: d25adbeb0cdb ("sctp: fix an use-after-free issue in sctp\_sock\_dump")
Signed-off-by: Xin Long
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit df06c8dd7aca2078dbbfafd7495da49700ab324f
Author: Coco Li
Date: Thu Dec 23 22:24:41 2021 +0000
selftests: Calculate udpgso segment count without header adjustment
[ Upstream commit 5471d5226c3b39b3d2f7011c082d5715795bd65c ]
The below referenced commit correctly updated the computation of number
of segments (gso\_size) by using only the gso payload size and
removing the header lengths.
With this change the regression test started failing. Update
the tests to match this new behavior.
Both IPv4 and IPv6 tests are updated, as a separate patch in this series
will update udp\_v6\_send\_skb to match this change in udp\_send\_skb.
Fixes: 158390e45612 ("udp: using datalen to cap max gso segments")
Signed-off-by: Coco Li
Reviewed-by: Willem de Bruijn
Link: https://lore.kernel.org/r/20211223222441.2975883-2-lixiaoyan@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 027282344397c5d24b3b7c7cd49ed2841f86c4ee
Author: Coco Li
Date: Thu Dec 23 22:24:40 2021 +0000
udp: using datalen to cap ipv6 udp max gso segments
[ Upstream commit 736ef37fd9a44f5966e25319d08ff7ea99ac79e8 ]
The max number of UDP gso segments is intended to cap to
UDP\_MAX\_SEGMENTS, this is checked in udp\_send\_skb().
skb->len contains network and transport header len here, we should use
only data len instead.
This is the ipv6 counterpart to the below referenced commit,
which missed the ipv6 change
Fixes: 158390e45612 ("udp: using datalen to cap max gso segments")
Signed-off-by: Coco Li
Reviewed-by: Willem de Bruijn
Link: https://lore.kernel.org/r/20211223222441.2975883-1-lixiaoyan@google.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 07f16b17416aaac5f20b1df108155fb97bfd50c5
Author: Chris Mi
Date: Thu Dec 2 11:18:02 2021 +0800
net/mlx5e: Delete forward rule for ct or sample action
[ Upstream commit 2820110d945923ab2f4901753e4ccbb2a506fa8e ]
When there is ct or sample action, the ct or sample rule will be deleted
and return. But if there is an extra mirror action, the forward rule can't
be deleted because of the return.
Fix it by removing the return.
Fixes: 69e2916ebce4 ("net/mlx5: CT: Add support for mirroring")
Fixes: f94d6389f6a8 ("net/mlx5e: TC, Add support to offload sample action")
Signed-off-by: Chris Mi
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit aa584ad8fa2928f1e61e5b3ab3e40ad30e5ed0e3
Author: Roi Dayan
Date: Mon Aug 23 13:33:17 2021 +0300
net/mlx5e: Use tc sample stubs instead of ifdefs in source file
[ Upstream commit f3e02e479debb37777696c9f984f75152beeb56d ]
Instead of having sparse ifdefs in source files use a single
ifdef in the tc sample header file and use stubs.
Signed-off-by: Roi Dayan
Reviewed-by: Maor Dickman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 12813ba11bf0d48cd6b8f5c4a1554affe764bb95
Author: Maxim Mikityanskiy
Date: Wed Jul 22 16:32:44 2020 +0300
net/mlx5e: Fix ICOSQ recovery flow for XSK
[ Upstream commit 19c4aba2d4e23997061fb11aed8a3e41334bfa14 ]
There are two ICOSQs per channel: one is needed for RX, and the other
for async operations (XSK TX, kTLS offload). Currently, the recovery
flow for both is the same, and async ICOSQ is mistakenly treated like
the regular ICOSQ.
This patch prevents running the regular ICOSQ recovery on async ICOSQ.
The purpose of async ICOSQ is to handle XSK wakeup requests and post
kTLS offload RX parameters, it has nothing to do with RQ and XSKRQ UMRs,
so the regular recovery sequence is not applicable here.
Fixes: be5323c8379f ("net/mlx5e: Report and recover from CQE error on ICOSQ")
Signed-off-by: Maxim Mikityanskiy
Reviewed-by: Aya Levin
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 144dbcc1454660fba116994c49d0686421aae3c0
Author: Maxim Mikityanskiy
Date: Tue Oct 12 19:40:09 2021 +0300
net/mlx5e: Fix interoperability between XSK and ICOSQ recovery flow
[ Upstream commit 17958d7cd731b977ae7d4af38d891c3a1235b5f1 ]
Both regular RQ and XSKRQ use the same ICOSQ for UMRs. When doing
recovery for the ICOSQ, don't forget to deactivate XSKRQ.
XSK can be opened and closed while channels are active, so a new mutex
prevents the ICOSQ recovery from running at the same time. The ICOSQ
recovery deactivates and reactivates XSKRQ, so any parallel change in
XSK state would break consistency. As the regular RQ is running, it's
not enough to just flush the recovery work, because it can be
rescheduled.
Fixes: be5323c8379f ("net/mlx5e: Report and recover from CQE error on ICOSQ")
Signed-off-by: Maxim Mikityanskiy
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 07f13d58a8ecc3baf9a488588fb38c5cb0db484f
Author: Amir Tzin
Date: Tue Nov 30 16:05:44 2021 +0200
net/mlx5e: Wrap the tx reporter dump callback to extract the sq
[ Upstream commit 918fc3855a6507a200e9cf22c20be852c0982687 ]
Function mlx5e\_tx\_reporter\_dump\_sq() casts its void \* argument to struct
mlx5e\_txqsq \*, but in TX-timeout-recovery flow the argument is actually
of type struct mlx5e\_tx\_timeout\_ctx \*.
mlx5\_core 0000:08:00.1 enp8s0f1: TX timeout detected
mlx5\_core 0000:08:00.1 enp8s0f1: TX timeout on queue: 1, SQ: 0x11ec, CQ: 0x146d, SQ Cons: 0x0 SQ Prod: 0x1, usecs since last trans: 21565000
BUG: stack guard page was hit at 0000000093f1a2de (stack is 00000000b66ea0dc..000000004d932dae)
kernel stack overflow (page fault): 0000 [#1] SMP NOPTI
CPU: 5 PID: 95 Comm: kworker/u20:1 Tainted: G W OE 5.13.0\_mlnx #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5e mlx5e\_tx\_timeout\_work [mlx5\_core]
RIP: 0010:mlx5e\_tx\_reporter\_dump\_sq+0xd3/0x180
[mlx5\_core]
Call Trace:
mlx5e\_tx\_reporter\_dump+0x43/0x1c0 [mlx5\_core]
devlink\_health\_do\_dump.part.91+0x71/0xd0
devlink\_health\_report+0x157/0x1b0
mlx5e\_reporter\_tx\_timeout+0xb9/0xf0 [mlx5\_core]
? mlx5e\_tx\_reporter\_err\_cqe\_recover+0x1d0/0x1d0
[mlx5\_core]
? mlx5e\_health\_queue\_dump+0xd0/0xd0 [mlx5\_core]
? update\_load\_avg+0x19b/0x550
? set\_next\_entity+0x72/0x80
? pick\_next\_task\_fair+0x227/0x340
? finish\_task\_switch+0xa2/0x280
mlx5e\_tx\_timeout\_work+0x83/0xb0 [mlx5\_core]
process\_one\_work+0x1de/0x3a0
worker\_thread+0x2d/0x3c0
? process\_one\_work+0x3a0/0x3a0
kthread+0x115/0x130
? kthread\_park+0x90/0x90
ret\_from\_fork+0x1f/0x30
--[ end trace 51ccabea504edaff ]---
RIP: 0010:mlx5e\_tx\_reporter\_dump\_sq+0xd3/0x180
PKRU: 55555554
Kernel panic - not syncing: Fatal exception
Kernel Offset: disabled
end Kernel panic - not syncing: Fatal exception
To fix this bug add a wrapper for mlx5e\_tx\_reporter\_dump\_sq() which
extracts the sq from struct mlx5e\_tx\_timeout\_ctx and set it as the
TX-timeout-recovery flow dump callback.
Fixes: 5f29458b77d5 ("net/mlx5e: Support dump callback in TX reporter")
Signed-off-by: Aya Levin
Signed-off-by: Amir Tzin
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 219419510c4e6c49f19490dd56c0254f55f3b740
Author: Chris Mi
Date: Tue Dec 14 03:52:53 2021 +0200
net/mlx5: Fix tc max supported prio for nic mode
[ Upstream commit d671e109bd8548d067b27e39e183a484430bf102 ]
Only prio 1 is supported if firmware doesn't support ignore flow
level for nic mode. The offending commit removed the check wrongly.
Add it back.
Fixes: 9a99c8f1253a ("net/mlx5e: E-Switch, Offload all chain 0 priorities when modify header and forward action is not supported")
Signed-off-by: Chris Mi
Reviewed-by: Roi Dayan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 5da639db8b719822e0569ff53c4c4b5a1bafa7f7
Author: Moshe Shemesh
Date: Tue Nov 23 20:08:13 2021 +0200
net/mlx5: Fix SF health recovery flow
[ Upstream commit 33de865f7bce3968676e43b0182af0a2dd359dae ]
SF do not directly control the PCI device. During recovery flow SF
should not be allowed to do pci disable or pci reset, its PF will do it.
It fixes the following kernel trace:
mlx5\_core.sf mlx5\_core.sf.25: mlx5\_health\_try\_recover:387:(pid 40948): starting health recovery flow
mlx5\_core 0000:03:00.0: mlx5\_pci\_slot\_reset was called
mlx5\_core 0000:03:00.0: wait vital counter value 0xab175 after 1 iterations
mlx5\_core.sf mlx5\_core.sf.25: firmware version: 24.32.532
mlx5\_core.sf mlx5\_core.sf.23: mlx5\_health\_try\_recover:387:(pid 40946): starting health recovery flow
mlx5\_core 0000:03:00.0: mlx5\_pci\_slot\_reset was called
mlx5\_core 0000:03:00.0: wait vital counter value 0xab193 after 1 iterations
mlx5\_core.sf mlx5\_core.sf.23: firmware version: 24.32.532
mlx5\_core.sf mlx5\_core.sf.25: mlx5\_cmd\_check:813:(pid 40948): ENABLE\_HCA(0x104) op\_mod(0x0) failed,
status bad resource state(0x9), syndrome (0x658908)
mlx5\_core.sf mlx5\_core.sf.25: mlx5\_function\_setup:1292:(pid 40948): enable hca failed
mlx5\_core.sf mlx5\_core.sf.25: mlx5\_health\_try\_recover:389:(pid 40948): health recovery failed
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Signed-off-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit c0cc069899fbec99ef5101b2f2d1b761b79285b8
Author: Shay Drory
Date: Wed Nov 24 23:10:57 2021 +0200
net/mlx5: Fix error print in case of IRQ request failed
[ Upstream commit aa968f922039706f6d13e8870b49e424d0a8d9ad ]
In case IRQ layer failed to find or to request irq, the driver is
printing the first cpu of the provided affinity as part of the error
print. Empty affinity is a valid input for the IRQ layer, and it is
an error to call cpumask\_first() on empty affinity.
Remove the first cpu print from the error message.
Fixes: c36326d38d93 ("net/mlx5: Round-Robin EQs over IRQs")
Signed-off-by: Shay Drory
Reviewed-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 4595dffccfa5b9360162c72cc0f6a33477d871cf
Author: Miaoqian Lin
Date: Wed Dec 22 06:54:53 2021 +0000
net/mlx5: DR, Fix NULL vs IS\_ERR checking in dr\_domain\_init\_resources
[ Upstream commit 6b8b42585886c59a008015083282aae434349094 ]
The mlx5\_get\_uars\_page() function returns error pointers.
Using IS\_ERR() to check the return value to fix this.
Fixes: 4ec9e7b02697 ("net/mlx5: DR, Expose steering domain functionality")
Signed-off-by: Miaoqian Lin
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit a68d72d899a2051e5a05f78aed9604fbc1f3ff34
Author: Dan Carpenter
Date: Tue Dec 14 10:05:27 2021 +0300
scsi: lpfc: Terminate string in lpfc\_debugfs\_nvmeio\_trc\_write()
[ Upstream commit 9020be114a47bf7ff33e179b3bb0016b91a098e6 ]
The "mybuf" string comes from the user, so we need to ensure that it is NUL
terminated.
Link: https://lore.kernel.org/r/20211214070527.GA27934@kili
Fixes: bd2cdd5e400f ("scsi: lpfc: NVME Initiator: Add debugfs support")
Reviewed-by: James Smart
Signed-off-by: Dan Carpenter
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 172fc0a7d7abdb94b94544765ae13348862b1abf
Author: Tom Rix
Date: Fri Dec 24 07:07:39 2021 -0800
selinux: initialize proto variable in selinux\_ip\_postroute\_compat()
commit 732bc2ff080c447f8524f40c970c481f5da6eed3 upstream.
Clang static analysis reports this warning
hooks.c:5765:6: warning: 4th function call argument is an uninitialized
value
if (selinux\_xfrm\_postroute\_last(sksec->sid, skb, &ad, proto))
^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
selinux\_parse\_skb() can return ok without setting proto. The later call
to selinux\_xfrm\_postroute\_last() does an early check of proto and can
return ok if the garbage proto value matches. So initialize proto.
Cc: stable@vger.kernel.org
Fixes: eef9b41622f2 ("selinux: cleanup selinux\_xfrm\_sock\_rcv\_skb() and selinux\_xfrm\_postroute\_last()")
Signed-off-by: Tom Rix
[PM: typo/spelling and checkpatch.pl description fixes]
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit f5cb610fa3d2c7b1deceb5c8fc3a7251b923fa70
Author: Javier Martinez Canillas
Date: Fri Nov 26 01:13:32 2021 +0100
efi: Move efifb\_setup\_from\_dmi() prototype from arch headers
commit 4bc5e64e6cf37007e436970024e5998ee0935651 upstream.
Commit 8633ef82f101 ("drivers/firmware: consolidate EFI framebuffer setup
for all arches") made the Generic System Framebuffers (sysfb) driver able
to be built on non-x86 architectures.
But it left the efifb\_setup\_from\_dmi() function prototype declaration in
the architecture specific headers. This could lead to the following
compiler warning as reported by the kernel test robot:
drivers/firmware/efi/sysfb\_efi.c:70:6: warning: no previous prototype for function 'efifb\_setup\_from\_dmi' [-Wmissing-prototypes]
void efifb\_setup\_from\_dmi(struct screen\_info \*si, const char \*opt)
^
drivers/firmware/efi/sysfb\_efi.c:70:1: note: declare 'static' if the function is not intended to be used outside of this translation unit
void efifb\_setup\_from\_dmi(struct screen\_info \*si, const char \*opt)
Fixes: 8633ef82f101 ("drivers/firmware: consolidate EFI framebuffer setup for all arches")
Reported-by: kernel test robot
Cc:  # 5.15.x
Signed-off-by: Javier Martinez Canillas
Acked-by: Thomas Zimmermann
Link: https://lore.kernel.org/r/20211126001333.555514-1-javierm@redhat.com
Signed-off-by: Ard Biesheuvel
Signed-off-by: Greg Kroah-Hartman
commit 5677e07723648bd024504235541213ec6f18a533
Author: Michael Ellerman
Date: Fri Dec 3 23:41:12 2021 +1100
powerpc/ptdump: Fix DEBUG\_WX since generic ptdump conversion
commit 8d84fca4375e3c35dadc16b8c7eee6821b2a575c upstream.
In note\_prot\_wx() we bail out without reporting anything if
CONFIG\_PPC\_DEBUG\_WX is disabled.
But CONFIG\_PPC\_DEBUG\_WX was removed in the conversion to generic ptdump,
we now need to use CONFIG\_DEBUG\_WX instead.
Fixes: e084728393a5 ("powerpc/ptdump: Convert powerpc to GENERIC\_PTDUMP")
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Michael Ellerman
Reviewed-by: Christophe Leroy
Link: https://lore.kernel.org/r/20211203124112.2912562-1-mpe@ellerman.id.au
Signed-off-by: Greg Kroah-Hartman
commit fc738764c9fa465a118300a78df4266263eaa8c4
Author: Heiko Carstens
Date: Thu Dec 23 17:43:14 2021 +0100
recordmcount.pl: fix typo in s390 mcount regex
commit 4eb1782eaa9fa1c224ad1fa0d13a9f09c3ab2d80 upstream.
Commit 85bf17b28f97 ("recordmcount.pl: look for jgnop instruction as well
as bcrl on s390") added a new alternative mnemonic for the existing brcl
instruction. This is required for the combination old gcc version (pre 9.0)
and binutils since version 2.37.
However at the same time this commit introduced a typo, replacing brcl with
bcrl. As a result no mcount locations are detected anymore with old gcc
versions (pre 9.0) and binutils before version 2.37.
Fix this by using the correct mnemonic again.
Reported-by: Miroslav Benes
Cc: Jerome Marchand
Cc:
Fixes: 85bf17b28f97 ("recordmcount.pl: look for jgnop instruction as well as bcrl on s390")
Link: https://lore.kernel.org/r/alpine.LSU.2.21.2112230949520.19849@pobox.suse.cz
Signed-off-by: Heiko Carstens
Signed-off-by: Greg Kroah-Hartman
commit 919f5678bae1f3ce630b970eccfd11f32a772ede
Author: Libin Yang
Date: Tue Dec 21 09:08:17 2021 +0800
ALSA: hda: intel-sdw-acpi: go through HDAS ACPI at max depth of 2
[ Upstream commit 78ea40efb48e978756db2ce45fcfa55bac056b91 ]
In the HDAS ACPI scope, the SoundWire may not be the direct child of HDAS.
It needs to go through the ACPI table at max depth of 2 to find the
SoundWire device from HDAS.
Reviewed-by: Péter Ujfalusi
Signed-off-by: Libin Yang
Signed-off-by: Pierre-Louis Bossart
Signed-off-by: Bard Liao
Link: https://lore.kernel.org/r/20211221010817.23636-3-yung-chuan.liao@linux.intel.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit cce476954401e3421afafb25bbaa926050688b1d
Author: Libin Yang
Date: Tue Dec 21 09:08:16 2021 +0800
ALSA: hda: intel-sdw-acpi: harden detection of controller
[ Upstream commit 385f287f9853da402d94278e59f594501c1d1dad ]
The existing code currently sets a pointer to an ACPI handle before
checking that it's actually a SoundWire controller. This can lead to
issues where the graph walk continues and eventually fails, but the
pointer was set already.
This patch changes the logic so that the information provided to
the caller is set when a controller is found.
Reviewed-by: Péter Ujfalusi
Signed-off-by: Libin Yang
Signed-off-by: Pierre-Louis Bossart
Signed-off-by: Bard Liao
Link: https://lore.kernel.org/r/20211221010817.23636-2-yung-chuan.liao@linux.intel.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 62f0a61fcb8a05302d2e5f0433b06f52729a214c
Author: Jackie Liu
Date: Fri Dec 17 10:07:54 2021 +0800
memblock: fix memblock\_phys\_alloc() section mismatch error
[ Upstream commit d7f55471db2719629f773c2d6b5742a69595bfd3 ]
Fix modpost Section mismatch error in memblock\_phys\_alloc()
[...]
WARNING: modpost: vmlinux.o(.text.unlikely+0x1dcc): Section mismatch in reference
from the function memblock\_phys\_alloc() to the function .init.text:memblock\_phys\_alloc\_range()
The function memblock\_phys\_alloc() references
the function \_\_init memblock\_phys\_alloc\_range().
This is often because memblock\_phys\_alloc lacks a \_\_init
annotation or the annotation of memblock\_phys\_alloc\_range is wrong.
ERROR: modpost: Section mismatches detected.
Set CONFIG\_SECTION\_MISMATCH\_WARN\_ONLY=y to allow them.
[...]
memblock\_phys\_alloc() is a one-line wrapper, make it \_\_always\_inline to
avoid these section mismatches.
Reported-by: k2ci
Suggested-by: Mike Rapoport
Signed-off-by: Jackie Liu
[rppt: slightly massaged changelog ]
Signed-off-by: Mike Rapoport
Link: https://lore.kernel.org/r/20211217020754.2874872-1-liu.yun@linux.dev
Signed-off-by: Sasha Levin
commit ea48bffecc3ed1fc137502ad7d4d396c904aa2d8
Author: Wang Qing
Date: Tue Dec 14 04:18:36 2021 -0800
platform/x86: apple-gmux: use resource\_size() with res
[ Upstream commit eb66fb03a727cde0ab9b1a3858de55c26f3007da ]
This should be (res->end - res->start + 1) here actually,
use resource\_size() derectly.
Signed-off-by: Wang Qing
Link: https://lore.kernel.org/r/1639484316-75873-1-git-send-email-wangqing@vivo.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 6964e81f11cec6980c9bb89e081fe1dc2d17ec27
Author: Miaoqian Lin
Date: Fri Dec 10 07:07:53 2021 +0000
platform/mellanox: mlxbf-pmc: Fix an IS\_ERR() vs NULL bug in mlxbf\_pmc\_map\_counters
[ Upstream commit 804034c4ffc502795cea9b3867acb2ec7fad99ba ]
The devm\_ioremap() function returns NULL on error, it doesn't return
error pointers. Also according to doc of device\_property\_read\_u64\_array,
values in info array are properties of device or NULL.
Signed-off-by: Miaoqian Lin
Link: https://lore.kernel.org/r/20211210070753.10761-1-linmq006@gmail.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit e96373f0a5f484bc1e193f9951dcb3adf24bf3f7
Author: Helge Deller
Date: Wed Dec 8 11:06:52 2021 +0100
parisc: Clear stale IIR value on instruction access rights trap
[ Upstream commit 484730e5862f6b872dca13840bed40fd7c60fa26 ]
When a trap 7 (Instruction access rights) occurs, this means the CPU
couldn't execute an instruction due to missing execute permissions on
the memory region. In this case it seems the CPU didn't even fetched
the instruction from memory and thus did not store it in the cr19 (IIR)
register before calling the trap handler. So, the trap handler will find
some random old stale value in cr19.
This patch simply overwrites the stale IIR value with a constant magic
"bad food" value (0xbaadf00d), in the hope people don't start to try to
understand the various random IIR values in trap 7 dumps.
Noticed-by: John David Anglin
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit 0d76daf2013ce1da20eab5e26bd81d983e1c18fb
Author: Paul Blakey
Date: Tue Dec 14 19:24:33 2021 +0200
net/sched: Extend qdisc control block with tc control block
[ Upstream commit ec624fe740b416fb68d536b37fb8eef46f90b5c2 ]
BPF layer extends the qdisc control block via struct bpf\_skb\_data\_end
and because of that there is no more room to add variables to the
qdisc layer control block without going over the skb->cb size.
Extend the qdisc control block with a tc control block,
and move all tc related variables to there as a pre-step for
extending the tc control block with additional members.
Signed-off-by: Paul Blakey
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 80176f65fa28898e7e20077e85989be479392cd2
Author: Tetsuo Handa
Date: Wed Dec 15 20:13:55 2021 +0900
tomoyo: use hwight16() in tomoyo\_domain\_quota\_is\_ok()
[ Upstream commit f702e1107601230eec707739038a89018ea3468d ]
hwight16() is much faster. While we are at it, no need to include
"perm =" part into data\_race() macro, for perm is a local variable
that cannot be accessed by other threads.
Signed-off-by: Tetsuo Handa
Signed-off-by: Sasha Levin
commit 3fe6a63b5dbdc0864f01d3171046af03d34ee747
Author: Dmitry Vyukov
Date: Tue Dec 14 10:45:26 2021 +0100
tomoyo: Check exceeded quota early in tomoyo\_domain\_quota\_is\_ok().
[ Upstream commit 04e57a2d952bbd34bc45744e72be3eecdc344294 ]
If tomoyo is used in a testing/fuzzing environment in learning mode,
for lots of domains the quota will be exceeded and stay exceeded
for prolonged periods of time. In such cases it's pointless (and slow)
to walk the whole acl list again and again just to rediscover that
the quota is exceeded. We already have the TOMOYO\_DIF\_QUOTA\_WARNED flag
that notes the overflow condition. Check it early to avoid the slowdown.
[penguin-kernel]
This patch causes a user visible change that the learning mode will not be
automatically resumed after the quota is increased. To resume the learning
mode, administrator will need to explicitly clear TOMOYO\_DIF\_QUOTA\_WARNED
flag after increasing the quota. But I think that this change is generally
preferable, for administrator likely wants to optimize the acl list for
that domain before increasing the quota, or that domain likely hits the
quota again. Therefore, don't try to care to clear TOMOYO\_DIF\_QUOTA\_WARNED
flag automatically when the quota for that domain changed.
Signed-off-by: Dmitry Vyukov
Signed-off-by: Tetsuo Handa
Signed-off-by: Sasha Levin
commit e97d5549f842dafb7d212e4269574efddc596d1a
Author: Samuel Čavoj
Date: Sat Dec 4 13:17:36 2021 -0800
Input: i8042 - enable deferred probe quirk for ASUS UM325UA
[ Upstream commit 44ee250aeeabb28b52a10397ac17ffb8bfe94839 ]
The ASUS UM325UA suffers from the same issue as the ASUS UX425UA, which
is a very similar laptop. The i8042 device is not usable immediately
after boot and fails to initialize, requiring a deferred retry.
Enable the deferred probe quirk for the UM325UA.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1190256
Signed-off-by: Samuel Čavoj
Link: https://lore.kernel.org/r/20211204015615.232948-1-samuel@cavoj.net
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit dd33054e4c18a54645072c7a62d46cdf6d05dace
Author: Takashi Iwai
Date: Sun Nov 28 23:21:41 2021 -0800
Input: i8042 - add deferred probe support
[ Upstream commit 9222ba68c3f4065f6364b99cc641b6b019ef2d42 ]
We've got a bug report about the non-working keyboard on ASUS ZenBook
UX425UA. It seems that the PS/2 device isn't ready immediately at
boot but takes some seconds to get ready. Until now, the only
workaround is to defer the probe, but it's available only when the
driver is a module. However, many distros, including openSUSE as in
the original report, build the PS/2 input drivers into kernel, hence
it won't work easily.
This patch adds the support for the deferred probe for i8042 stuff as
a workaround of the problem above. When the deferred probe mode is
enabled and the device couldn't be probed, it'll be repeated with the
standard deferred probe mechanism.
The deferred probe mode is enabled either via the new option
i8042.probe\_defer or via the quirk table entry. As of this patch, the
quirk table contains only ASUS ZenBook UX425UA.
The deferred probe part is based on Fabio's initial work.
BugLink: https://bugzilla.suse.com/show\_bug.cgi?id=1190256
Signed-off-by: Takashi Iwai
Tested-by: Samuel Čavoj
Link: https://lore.kernel.org/r/20211117063757.11380-1-tiwai@suse.de
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin

