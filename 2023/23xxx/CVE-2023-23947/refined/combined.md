=== Content from github.com_2d7f3fa0_20250114_191626.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fsecurity%2Fadvisories%2FGHSA-3jfq-742w-xg8j)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fsecurity%2Fadvisories%2FGHSA-3jfq-742w-xg8j)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=argoproj%2Fargo-cd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-cd](/argoproj/argo-cd)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-cd) You must be signed in to change notification settings
* [Fork
  5.6k](/login?return_to=%2Fargoproj%2Fargo-cd)
* [Star
   18.4k](/login?return_to=%2Fargoproj%2Fargo-cd)

* [Code](/argoproj/argo-cd)
* [Issues
  3.1k](/argoproj/argo-cd/issues)
* [Pull requests
  473](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects
  5](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

Additional navigation options

* [Code](/argoproj/argo-cd)
* [Issues](/argoproj/argo-cd/issues)
* [Pull requests](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

# Users with any cluster secret update access may update out-of-bounds cluster secrets

Critical

[crenshaw-dev](/crenshaw-dev)
published
GHSA-3jfq-742w-xg8j
Feb 16, 2023

## Package

gomod

github.com/argoproj/argo-cd
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

2.3.0-rc1 through 2.3.16, 2.4.22, 2.5.10, 2.6.1

## Patched versions

2.3.17, 2.4.23, 2.5.11, 2.6.2

## Description

### Impact

All Argo CD versions starting with v2.3.0-rc1 are vulnerable to an improper authorization bug which allows users who have the ability to update at least one cluster secret to update any cluster secret.

The attacker could use this access to escalate privileges (potentially controlling Kubernetes resources) or to break Argo CD functionality (by preventing connections to external clusters).

#### How the Attack Works

Argo CD stores [cluster access configurations](https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#clusters) as Kubernetes Secrets. To take advantage of the vulnerability, an attacker must know the server URL for the cluster secret they want to modify.

The attacker must be authenticated with the Argo CD API server, and they must be authorized to update at least one ([non project-scoped](https://argo-cd.readthedocs.io/en/stable/user-guide/projects/#project-scoped-repositories-and-clusters)) cluster. Then they must craft a malicious request to the Argo CD API server.

#### Removing Deployment Restrictions

A cluster Secret's `clusterResources` field determines whether Argo CD users may deploy cluster-scoped resources to that cluster. The `namespaces` field determines the namespaces to which Argo CD users may deploy resources.

You can use this command to determine whether any of your cluster configurations employ these restrictions (replace `argocd` with the namespace of your Argo CD installation):

```
kubectl get secret -n argocd -l 'argocd.argoproj.io/secret-type=cluster' -ojson | jq '.items |
  map(.data |= with_entries(.value |= @base64d)) |  # base64-decode secrets
  map(select(.data | (
    (.clusterResources != null and .clusterResources == "false") or # we deny cluster-scoped resource management
    (.namespaces != null and .namespaces != "")                     # we are only managing certain clusters
  )) | .metadata.name)'
```

The `clusterResources` and `namespaces` fields are one line of defense against unauthorized management of Kubernetes resources. Users should also have AppProject and RBAC restrictions in place.

If `clusterResources: "false"` or `namespaces: "some,namespaces"` are the *only* mechanisms preventing an attacker from maliciously managing certain resources via Argo CD, then this vulnerability could allow that attacker to manage out-of-bounds resources via Argo CD (create, get, update, delete).

#### Modifying Connection Parameters

Cluster secrets also hold client configuration for connecting to the remote cluster. One option is to skip TLS certificate verification. An attacker could disable certificate verification in an effort to achieve a malicious-in-the-middle (MITM) attack.

Alternatively, an attacker could apply an invalid configuration (for example, by setting an invalid bearer token) and achieve a denial-of-service by preventing Argo CD from managing the target cluster.

#### Changing Unscoped Clusters to be Scoped

The vulnerability also allows an attacker to modify a previously-unscoped cluster and make it [scoped](https://argo-cd.readthedocs.io/en/stable/user-guide/projects/#project-scoped-repositories-and-clusters). This is important if you are using `permitOnlyProjectScopedClusters: true` in a project under which the attacker can deploy. By scoping a previously-unscoped cluster under that project, they can grant themselves the ability to manage resources on the target cluster.

### Patches

A patch for this vulnerability has been released in the following Argo CD versions:

* v2.6.2
* v2.5.11
* v2.4.23
* v2.3.17

### Workarounds

The best way to mitigate the vulnerability is to upgrade. The following two sections explain other ways to mitigate the vulnerability if you are currently unable to upgrade.

#### Limit Users with Cluster Update Access

The only complete mitigation besides upgrading is to modify your RBAC configuration to completely revoke all `clusters, update` access.

To exploit this vulnerability, an attacker must have access to update at least one cluster configuration. Check your [RBAC configuration](https://argo-cd.readthedocs.io/en/stable/operator-manual/rbac/), for lines like this:

```
p, role:developers, clusters, update, *, allow
p, role:developers, clusters, *, *, allow
p, role:developers, *, update, *, allow

```

Revoke `clusters, update` access for any users who do not absolutely need that access.

#### Restrict Resource Management via AppProjects and RBAC

[AppProjects](https://argo-cd.readthedocs.io/en/stable/user-guide/projects/#projects) are a primary tool to restrict what resources may be managed via Argo CD.

You can use the `destinations` and `clusterResourceWhitelist` fields to apply similar restrictions as the `namespaces` and `clusterResources` fields described above.

```
apiVersion: argoproj.io/v1alpha1
kind: AppProject
spec:
  destinations:
  # Only allow Applications managed by this AppProject to manage to the `allowed-namespace` namespace.
  - namespace: 'allowed-namespace'
    server: 'https://your-server'
  # Do not allow Applications managed by this AppProject to manage any cluster-scoped resources.
  clusterResourceWhitelist: []
```

Along with adding AppProject restrictions, make sure that your RBAC restrictions are strict enough.

For example, limit `projects, update` access to Argo CD administrators only. Also use the `{project}` field in `applications, *, {project}/{application}` field to limit users' access to certain, restricted, AppProjects.

AppProject restrictions can only prevent Applications from managing out-of-bounds resources. It cannot prevent an attacker from maliciously changing cluster connection TLS configuration.

### For more information

* Open an issue in [the Argo CD issue tracker](https://github.com/argoproj/argo-cd/issues) or [discussions](https://github.com/argoproj/argo-cd/discussions)
* Join us on [Slack](https://argoproj.github.io/community/join-slack) in channel #argo-cd

### Severity

Critical

9.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
High

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2023-23947

### Weaknesses

No CWEs

### Credits

* [![@crenshaw-dev](https://avatars.githubusercontent.com/u/350466?s=40&v=4)](/crenshaw-dev)
  [crenshaw-dev](/crenshaw-dev)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4e7b3289_20250114_191625.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fcommit%2Ffbb0b99b1ac3361b253052bd30259fa43a520945)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fcommit%2Ffbb0b99b1ac3361b253052bd30259fa43a520945)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=argoproj%2Fargo-cd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[argoproj](/argoproj)
/
**[argo-cd](/argoproj/argo-cd)**
Public

* [Notifications](/login?return_to=%2Fargoproj%2Fargo-cd) You must be signed in to change notification settings
* [Fork
  5.6k](/login?return_to=%2Fargoproj%2Fargo-cd)
* [Star
   18.4k](/login?return_to=%2Fargoproj%2Fargo-cd)

* [Code](/argoproj/argo-cd)
* [Issues
  3.1k](/argoproj/argo-cd/issues)
* [Pull requests
  473](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects
  5](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

Additional navigation options

* [Code](/argoproj/argo-cd)
* [Issues](/argoproj/argo-cd/issues)
* [Pull requests](/argoproj/argo-cd/pulls)
* [Discussions](/argoproj/argo-cd/discussions)
* [Actions](/argoproj/argo-cd/actions)
* [Projects](/argoproj/argo-cd/projects)
* [Wiki](/argoproj/argo-cd/wiki)
* [Security](/argoproj/argo-cd/security)
* [Insights](/argoproj/argo-cd/pulse)

## Commit

[Permalink](/argoproj/argo-cd/commit/fbb0b99b1ac3361b253052bd30259fa43a520945)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-3jfq-742w-xg8j](https://github.com/advisories/GHSA-3jfq-742w-xg8j "GHSA-3jfq-742w-xg8j")

[Browse files](/argoproj/argo-cd/tree/fbb0b99b1ac3361b253052bd30259fa43a520945)
Browse the repository at this point in the history

```
fix test name

Signed-off-by: Michael Crenshaw <350466+crenshaw-dev@users.noreply.github.com>
```

* Loading branch information

[![@crenshaw-dev](https://avatars.githubusercontent.com/u/350466?s=40&v=4)](/crenshaw-dev)

[crenshaw-dev](/argoproj/argo-cd/commits?author=crenshaw-dev "View all commits by crenshaw-dev")
authored
Feb 16, 2023

1 parent
[974c2de](/argoproj/argo-cd/commit/974c2de1686521437fa755a180b8d0593e9c0533)

commit fbb0b99

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**123 additions**
and
**7 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* common

  + common/common.go
    [common.go](#diff-a70f47b70b2d542f3eaa01a097d0f6d97e1f49cee567e258d4afc2a79f07af92)
* server/cluster

  + server/cluster/cluster.go
    [cluster.go](#diff-47255bee56d3ad7830d9721f65c73fac53009229cb98c63c67745527d598835b)
  + server/cluster/cluster\_test.go
    [cluster\_test.go](#diff-98bf3a75d82fee3dd8aa16fc706c68ab62eb77d1cc2de2a87e14228853a2428c)

## There are no files selected for viewing

4 changes: 4 additions & 0 deletions

4
[common/common.go](#diff-a70f47b70b2d542f3eaa01a097d0f6d97e1f49cee567e258d4afc2a79f07af92 "common/common.go")

Show comments

[View file](/argoproj/argo-cd/blob/fbb0b99b1ac3361b253052bd30259fa43a520945/common/common.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -8,6 +8,8 @@ import ( |
|  |  | "time" |
|  |  |  |
|  |  | "github.com/sirupsen/logrus" |
|  |  | "google.golang.org/grpc/codes" |
|  |  | "google.golang.org/grpc/status" |
|  |  | ) |
|  |  |  |
|  |  | // Default service addresses and URLS of Argo CD internal services |
| Expand Down  Expand Up | | @@ -316,3 +318,5 @@ const ( |
|  |  | const TokenVerificationError = "failed to verify the token" |
|  |  |  |
|  |  | var TokenVerificationErr = errors.New(TokenVerificationError) |
|  |  |  |
|  |  | var PermissionDeniedAPIError = status.Error(codes.PermissionDenied, "permission denied") |

14 changes: 7 additions & 7 deletions

14
[server/cluster/cluster.go](#diff-47255bee56d3ad7830d9721f65c73fac53009229cb98c63c67745527d598835b "server/cluster/cluster.go")

Show comments

[View file](/argoproj/argo-cd/blob/fbb0b99b1ac3361b253052bd30259fa43a520945/server/cluster/cluster.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,11 +1,10 @@ |
|  |  | package cluster |
|  |  |  |
|  |  | import ( |
|  |  | "context" |
|  |  | "net/url" |
|  |  | "time" |
|  |  |  |
|  |  | "context" |
|  |  |  |
|  |  | "github.com/argoproj/gitops-engine/pkg/utils/kube" |
|  |  | log "github.com/sirupsen/logrus" |
|  |  | "google.golang.org/grpc/codes" |
| Expand All | | @@ -14,6 +13,7 @@ import ( |
|  |  | "k8s.io/apimachinery/pkg/util/sets" |
|  |  | "k8s.io/client-go/kubernetes" |
|  |  |  |
|  |  | "github.com/argoproj/argo-cd/v2/common" |
|  |  | "github.com/argoproj/argo-cd/v2/pkg/apiclient/cluster" |
|  |  | appv1 "github.com/argoproj/argo-cd/v2/pkg/apis/application/v1alpha1" |
|  |  | servercache "github.com/argoproj/argo-cd/v2/server/cache" |
| Expand Down  Expand Up | | @@ -135,7 +135,7 @@ func (s \*Server) Get(ctx context.Context, q \*cluster.ClusterQuery) (\*appv1.Clust |
|  |  | func (s \*Server) getClusterWith403IfNotExist(ctx context.Context, q \*cluster.ClusterQuery) (\*appv1.Cluster, error) { |
|  |  | repo, err := s.getCluster(ctx, q) |
|  |  | if err != nil || repo == nil { |
|  |  | return nil, status.Error(codes.PermissionDenied, "permission denied") |
|  |  | return nil, common.PermissionDeniedAPIError |
|  |  | } |
|  |  | return repo, nil |
|  |  | } |
| Expand Down  Expand Up | | @@ -221,14 +221,14 @@ func (s \*Server) Update(ctx context.Context, q \*cluster.ClusterUpdateRequest) (\* |
|  |  | } |
|  |  |  |
|  |  | // verify that user can do update inside project where cluster is located |
|  |  | if err := s.enf.EnforceErr(ctx.Value("claims"), rbacpolicy.ResourceClusters, rbacpolicy.ActionUpdate, createRBACObject(c.Project, q.Cluster.Server)); err != nil { |
|  |  | return nil, err |
|  |  | if !s.enf.Enforce(ctx.Value("claims"), rbacpolicy.ResourceClusters, rbacpolicy.ActionUpdate, createRBACObject(c.Project, c.Server)) { |
|  |  | return nil, common.PermissionDeniedAPIError |
|  |  | } |
|  |  |  |
|  |  | if len(q.UpdatedFields) == 0 || sets.NewString(q.UpdatedFields...).Has("project") { |
|  |  | // verify that user can do update inside project where cluster will be located |
|  |  | if err := s.enf.EnforceErr(ctx.Value("claims"), rbacpolicy.ResourceClusters, rbacpolicy.ActionUpdate, createRBACObject(q.Cluster.Project, q.Cluster.Server)); err != nil { |
|  |  | return nil, err |
|  |  | if !s.enf.Enforce(ctx.Value("claims"), rbacpolicy.ResourceClusters, rbacpolicy.ActionUpdate, createRBACObject(q.Cluster.Project, c.Server)) { |
|  |  | return nil, common.PermissionDeniedAPIError |
|  |  | } |
|  |  | } |
|  |  |  |
| Expand Down | |  |

112 changes: 112 additions & 0 deletions

112
[server/cluster/cluster\_test.go](#diff-98bf3a75d82fee3dd8aa16fc706c68ab62eb77d1cc2de2a87e14228853a2428c "server/cluster/cluster_test.go")

Show comments

[View file](/argoproj/argo-cd/blob/fbb0b99b1ac3361b253052bd30259fa43a520945/server/cluster/cluster_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,6 +3,7 @@ package cluster |
|  |  | import ( |
|  |  | "context" |
|  |  | "encoding/json" |
|  |  | "fmt" |
|  |  | "testing" |
|  |  | "time" |
|  |  |  |
| Expand Down  Expand Up | | @@ -49,6 +50,117 @@ func newNoopEnforcer() \*rbac.Enforcer { |
|  |  | return enf |
|  |  | } |
|  |  |  |
|  |  | func TestUpdateCluster\_RejectInvalidParams(t \*testing.T) { |
|  |  | testCases := []struct { |
|  |  | name string |
|  |  | request clusterapi.ClusterUpdateRequest |
|  |  | }{ |
|  |  | { |
|  |  | name: "allowed cluster URL in body, disallowed cluster URL in query", |
|  |  | request: clusterapi.ClusterUpdateRequest{Cluster: &v1alpha1.Cluster{Name: "", Server: "https://127.0.0.1", Project: "", ClusterResources: true}, Id: &clusterapi.ClusterID{Type: "", Value: "https://127.0.0.2"}, UpdatedFields: []string{"clusterResources", "project"}}, |
|  |  | }, |
|  |  | { |
|  |  | name: "allowed cluster URL in body, disallowed cluster name in query", |
|  |  | request: clusterapi.ClusterUpdateRequest{Cluster: &v1alpha1.Cluster{Name: "", Server: "https://127.0.0.1", Project: "", ClusterResources: true}, Id: &clusterapi.ClusterID{Type: "name", Value: "disallowed-unscoped"}, UpdatedFields: []string{"clusterResources", "project"}}, |
|  |  | }, |
|  |  | { |
|  |  | name: "allowed cluster URL in body, disallowed cluster name in query, changing unscoped to scoped", |
|  |  | request: clusterapi.ClusterUpdateRequest{Cluster: &v1alpha1.Cluster{Name: "", Server: "https://127.0.0.1", Project: "allowed-project", ClusterResources: true}, Id: &clusterapi.ClusterID{Type: "", Value: "https://127.0.0.2"}, UpdatedFields: []string{"clusterResources", "project"}}, |
|  |  | }, |
|  |  | { |
|  |  | name: "allowed cluster URL in body, disallowed cluster URL in query, changing unscoped to scoped", |
|  |  | request: clusterapi.ClusterUpdateRequest{Cluster: &v1alpha1.Cluster{Name: "", Server: "https://127.0.0.1", Project: "allowed-project", ClusterResources: true}, Id: &clusterapi.ClusterID{Type: "name", Value: "disallowed-unscoped"}, UpdatedFields: []string{"clusterResources", "project"}}, |
|  |  | }, |
|  |  | } |
|  |  |  |
|  |  | db := &dbmocks.ArgoDB{} |
|  |  |  |
|  |  | clusters := []v1alpha1.Cluster{ |
|  |  | { |
|  |  | Name: "allowed-unscoped", |
|  |  | Server: "https://127.0.0.1", |
|  |  | }, |
|  |  | { |
|  |  | Name: "disallowed-unscoped", |
|  |  | Server: "https://127.0.0.2", |
|  |  | }, |
|  |  | { |
|  |  | Name: "allowed-scoped", |
|  |  | Server: "https://127.0.0.3", |
|  |  | Project: "allowed-project", |
|  |  | }, |
|  |  | { |
|  |  | Name: "disallowed-scoped", |
|  |  | Server: "https://127.0.0.4", |
|  |  | Project: "disallowed-project", |
|  |  | }, |
|  |  | } |
|  |  |  |
|  |  | db.On("ListClusters", mock.Anything).Return( |
|  |  | func(ctx context.Context) \*v1alpha1.ClusterList { |
|  |  | return &v1alpha1.ClusterList{ |
|  |  | ListMeta: v1.ListMeta{}, |
|  |  | Items: clusters, |
|  |  | } |
|  |  | }, |
|  |  | func(ctx context.Context) error { |
|  |  | return nil |
|  |  | }, |
|  |  | ) |
|  |  | db.On("UpdateCluster", mock.Anything, mock.Anything).Return( |
|  |  | func(ctx context.Context, c \*v1alpha1.Cluster) \*v1alpha1.Cluster { |
|  |  | for \_, cluster := range clusters { |
|  |  | if c.Server == cluster.Server { |
|  |  | return c |
|  |  | } |
|  |  | } |
|  |  | return nil |
|  |  | }, |
|  |  | func(ctx context.Context, c \*v1alpha1.Cluster) error { |
|  |  | for \_, cluster := range clusters { |
|  |  | if c.Server == cluster.Server { |
|  |  | return nil |
|  |  | } |
|  |  | } |
|  |  | return fmt.Errorf("cluster '%s' not found", c.Server) |
|  |  | }, |
|  |  | ) |
|  |  | db.On("GetCluster", mock.Anything, mock.Anything).Return( |
|  |  | func(ctx context.Context, server string) \*v1alpha1.Cluster { |
|  |  | for \_, cluster := range clusters { |
|  |  | if server == cluster.Server { |
|  |  | return &cluster |
|  |  | } |
|  |  | } |
|  |  | return nil |
|  |  | }, |
|  |  | func(ctx context.Context, server string) error { |
|  |  | for \_, cluster := range clusters { |
|  |  | if server == cluster.Server { |
|  |  | return nil |
|  |  | } |
|  |  | } |
|  |  | return fmt.Errorf("cluster '%s' not found", server) |
|  |  | }, |
|  |  | ) |
|  |  |  |
|  |  | enf := rbac.NewEnforcer(fake.NewSimpleClientset(test.NewFakeConfigMap()), test.FakeArgoCDNamespace, common.ArgoCDConfigMapName, nil) |
|  |  | \_ = enf.SetBuiltinPolicy(`p, role:test, clusters, \*, https://127.0.0.1, allow |
|  |  | p, role:test, clusters, \*, allowed-project/\*, allow`) |
|  |  | enf.SetDefaultRole("role:test") |
|  |  | server := NewServer(db, enf, newServerInMemoryCache(), &kubetest.MockKubectlCmd{}) |
|  |  |  |
|  |  | for \_, c := range testCases { |
|  |  | cc := c |
|  |  | t.Run(cc.name, func(t \*testing.T) { |
|  |  | t.Parallel() |
|  |  | out, err := server.Update(context.Background(), &cc.request) |
|  |  | require.Nil(t, out) |
|  |  | assert.ErrorIs(t, err, common.PermissionDeniedAPIError) |
|  |  | }) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func TestGetCluster\_UrlEncodedName(t \*testing.T) { |
|  |  | db := &dbmocks.ArgoDB{} |
|  |  |  |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `fbb0b99`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fargoproj%2Fargo-cd%2Fcommit%2Ffbb0b99b1ac3361b253052bd30259fa43a520945) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


