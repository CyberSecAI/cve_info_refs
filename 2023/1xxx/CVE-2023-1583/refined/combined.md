=== Content from git.kernel.org_b295fb95_20250114_235122.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Savino Dicanosa <sd7.dev@pm.me> | 2023-03-21 19:44:02 +0000 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2023-03-22 11:04:55 -0600 |
| commit | [02a4d923e4400a36d340ea12d8058f69ebf3a383](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)) | |
| tree | [aaa0562aae658d643a59e6e5c31078ef6a9fc870](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383) | |
| parent | [74e2e17ee1f8d8a0928b90434ad7e2df70f8483e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=74e2e17ee1f8d8a0928b90434ad7e2df70f8483e) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383&id2=74e2e17ee1f8d8a0928b90434ad7e2df70f8483e)) | |
| download | [linux-02a4d923e4400a36d340ea12d8058f69ebf3a383.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-02a4d923e4400a36d340ea12d8058f69ebf3a383.tar.gz) | |

io\_uring/rsrc: fix null-ptr-deref in io\_file\_bitmap\_get()When fixed files are unregistered, file\_alloc\_end and alloc\_hint
are not cleared. This can later cause a NULL pointer dereference in
io\_file\_bitmap\_get() if auto index selection is enabled via
IORING\_FILE\_INDEX\_ALLOC:
[ 6.519129] BUG: kernel NULL pointer dereference, address: 0000000000000000
[...]
[ 6.541468] RIP: 0010:\_find\_next\_zero\_bit+0x1a/0x70
[...]
[ 6.560906] Call Trace:
[ 6.561322] <TASK>
[ 6.561672] io\_file\_bitmap\_get+0x38/0x60
[ 6.562281] io\_fixed\_fd\_install+0x63/0xb0
[ 6.562851] ? \_\_pfx\_io\_socket+0x10/0x10
[ 6.563396] io\_socket+0x93/0xf0
[ 6.563855] ? \_\_pfx\_io\_socket+0x10/0x10
[ 6.564411] io\_issue\_sqe+0x5b/0x3d0
[ 6.564914] io\_submit\_sqes+0x1de/0x650
[ 6.565452] \_\_do\_sys\_io\_uring\_enter+0x4fc/0xb20
[ 6.566083] ? \_\_do\_sys\_io\_uring\_register+0x11e/0xd80
[ 6.566779] do\_syscall\_64+0x3c/0x90
[ 6.567247] entry\_SYSCALL\_64\_after\_hwframe+0x72/0xdc
[...]
To fix the issue, set file alloc range and alloc\_hint to zero after
file tables are freed.
Cc: stable@vger.kernel.org
Fixes: 4278a0deb1f6 ("io\_uring: defer alloc\_hint update to io\_file\_bitmap\_set()")
Signed-off-by: Savino Dicanosa <sd7.dev@pm.me>
[axboe: add explicit bitmap == NULL check as well]
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)

| -rw-r--r-- | [io\_uring/filetable.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/io_uring/filetable.c?id=02a4d923e4400a36d340ea12d8058f69ebf3a383) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [io\_uring/rsrc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/io_uring/rsrc.c?id=02a4d923e4400a36d340ea12d8058f69ebf3a383) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 0 deletions

| diff --git a/io\_uring/filetable.c b/io\_uring/filetable.cindex 68dfc6936aa725..b80614e7d60511 100644--- a/[io\_uring/filetable.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/io_uring/filetable.c?id=74e2e17ee1f8d8a0928b90434ad7e2df70f8483e)+++ b/[io\_uring/filetable.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/io_uring/filetable.c?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)@@ -19,6 +19,9 @@ static int io\_file\_bitmap\_get(struct io\_ring\_ctx \*ctx) unsigned long nr = ctx->file\_alloc\_end; int ret; + if (!table->bitmap)+ return -ENFILE;+ do { ret = find\_next\_zero\_bit(table->bitmap, nr, table->alloc\_hint); if (ret != nr)diff --git a/io\_uring/rsrc.c b/io\_uring/rsrc.cindex e2bac9f8990295..7a43aed8e395cb 100644--- a/[io\_uring/rsrc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/io_uring/rsrc.c?id=74e2e17ee1f8d8a0928b90434ad7e2df70f8483e)+++ b/[io\_uring/rsrc.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/io_uring/rsrc.c?id=02a4d923e4400a36d340ea12d8058f69ebf3a383)@@ -794,6 +794,7 @@ void \_\_io\_sqe\_files\_unregister(struct io\_ring\_ctx \*ctx) } #endif io\_free\_file\_tables(&ctx->file\_table);+ io\_file\_table\_set\_alloc\_range(ctx, 0, 0); io\_rsrc\_data\_free(ctx->file\_data); ctx->file\_data = NULL; ctx->nr\_user\_files = 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-14 23:49:59 +0000


