=== Content from lore.kernel.org_00101c28_20250115_100448.html ===

```
[netdev.vger.kernel.org archive mirror](../../?t=20221122050035)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e81faa027747b7a1b60bb845b1158e7fa3653b97d) [PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc
@ 2022-11-18 21:44 Xin Long
  2022-11-18 21:45 ` [[PATCH net 1/2] tipc: set con sock](#m98e0188fe05e57ccd0806c1544738856c95b34dc) " Xin Long
                   ` [(3 more replies)](#r98e0188fe05e57ccd0806c1544738856c95b34dc)
  [0 siblings, 4 replies; 5+ messages in thread](#r81faa027747b7a1b60bb845b1158e7fa3653b97d)
From: Xin Long @ 2022-11-18 21:44 UTC ([permalink](../../cover.1668807842.git.lucien.xin%40gmail.com/) / [raw](../../cover.1668807842.git.lucien.xin%40gmail.com/raw))
  To: [network dev](../../../netdev/?t=20221118214512), tipc-discussion
  Cc: davem, kuba, Eric Dumazet, Paolo Abeni, Jon Maloy, Ying Xue,
	Wei Chen

The race exists beteen tipc_topsrv_accept() and tipc_conn_close(),
one is allocating the con while the other is freeing it and there
is no proper lock protecting it. Therefore, a null-pointer-defer
and a use-after-free may be triggered, see details on each patch.

Xin Long (2):
  tipc: set con sock in tipc_conn_alloc
  tipc: add an extra conn_get in tipc_conn_alloc

 net/tipc/topsrv.c | 20 +++++++++++---------
 1 file changed, 11 insertions(+), 9 deletions(-)

--
2.31.1

[^](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) [permalink](../../cover.1668807842.git.lucien.xin%40gmail.com/) [raw](../../cover.1668807842.git.lucien.xin%40gmail.com/raw) [reply](../../cover.1668807842.git.lucien.xin%40gmail.com/#R)	[[flat](../../cover.1668807842.git.lucien.xin%40gmail.com/T/#u)|[nested](../../cover.1668807842.git.lucien.xin%40gmail.com/t/#u)] [5+ messages in thread](#r81faa027747b7a1b60bb845b1158e7fa3653b97d)
```

---

```
[*](#e98e0188fe05e57ccd0806c1544738856c95b34dc) [PATCH net 1/2] tipc: set con sock in tipc_conn_alloc
  2022-11-18 21:44 [[PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) Xin Long
@ 2022-11-18 21:45 ` Xin Long
  2022-11-18 21:45 ` [[PATCH net 2/2] tipc: add an extra conn_get](#me5e050a7ebd300e6863556e24c3770a76917f776) " Xin Long
                   ` [(2 subsequent siblings)](#re5e050a7ebd300e6863556e24c3770a76917f776)
  [3 siblings, 0 replies; 5+ messages in thread](#r98e0188fe05e57ccd0806c1544738856c95b34dc)
From: Xin Long @ 2022-11-18 21:45 UTC ([permalink](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/) / [raw](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/raw))
  To: [network dev](../../../netdev/?t=20221118214513), tipc-discussion
  Cc: davem, kuba, Eric Dumazet, Paolo Abeni, Jon Maloy, Ying Xue,
	Wei Chen

A crash was reported by Wei Chen:

  BUG: kernel NULL pointer dereference, address: 0000000000000018
  RIP: 0010:tipc_conn_close+0x12/0x100
  Call Trace:
   tipc_topsrv_exit_net+0x139/0x320
   ops_exit_list.isra.9+0x49/0x80
   cleanup_net+0x31a/0x540
   process_one_work+0x3fa/0x9f0
   worker_thread+0x42/0x5c0

It was caused by !con->sock in tipc_conn_close(). In tipc_topsrv_accept(),
con is allocated in conn_idr then its sock is set:

  con = tipc_conn_alloc();
  ...                    <----[1]
  con->sock = newsock;

If tipc_conn_close() is called in anytime of [1], the null-pointer-def
is triggered by con->sock->sk due to con->sock is not yet set.

This patch fixes it by moving the con->sock setting to tipc_conn_alloc()
under s->idr_lock. So that con->sock can never be NULL when getting the
con from s->conn_idr. It will be also safer to move con->server and flag
CF_CONNECTED setting under s->idr_lock, as they should all be set before
tipc_conn_alloc() is called.

Fixes: c5fa7b3cf3cb ("tipc: introduce new TIPC server infrastructure")
Reported-by: Wei Chen <harperchen1110@gmail.com>
Signed-off-by: Xin Long <lucien.xin@gmail.com>
---
 [net/tipc/topsrv.c](#Z2e.:..:bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin::40gmail.com:1net:tipc:topsrv.c) | 11 +++++------
 1 file [changed](#e98e0188fe05e57ccd0806c1544738856c95b34dc), 5 insertions(+), 6 deletions(-)

[diff](#iZ2e.:..:bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin::40gmail.com:1net:tipc:topsrv.c) --git a/net/tipc/topsrv.c b/net/tipc/topsrv.c
index d92ec92f0b71..b0f9aa521670 100644
--- a/net/tipc/topsrv.c
+++ b/net/tipc/topsrv.c
@@ -176,7 +176,7 @@ static void tipc_conn_close(struct tipc_conn *con)
 	conn_put(con);
 }

-static struct tipc_conn *tipc_conn_alloc(struct tipc_topsrv *s)
+static struct tipc_conn *tipc_conn_alloc(struct tipc_topsrv *s, struct socket *sock)
 {
 	struct tipc_conn *con;
 	int ret;
@@ -202,10 +202,11 @@ static struct tipc_conn *tipc_conn_alloc(struct tipc_topsrv *s)
 	}
 	con->conid = ret;
 	s->idr_in_use++;
-	spin_unlock_bh(&s->idr_lock);

 	set_bit(CF_CONNECTED, &con->flags);
 	con->server = s;
+	con->sock = sock;
+	spin_unlock_bh(&s->idr_lock);

 	return con;
 }
@@ -467,7 +468,7 @@ static void tipc_topsrv_accept(struct work_struct *work)
 		ret = kernel_accept(lsock, &newsock, O_NONBLOCK);
 		if (ret < 0)
 			return;
-		con = tipc_conn_alloc(srv);
+		con = tipc_conn_alloc(srv, newsock);
 		if (IS_ERR(con)) {
 			ret = PTR_ERR(con);
 			sock_release(newsock);
@@ -479,7 +480,6 @@ static void tipc_topsrv_accept(struct work_struct *work)
 		newsk->sk_data_ready = tipc_conn_data_ready;
 		newsk->sk_write_space = tipc_conn_write_space;
 		newsk->sk_user_data = con;
-		con->sock = newsock;
 		write_unlock_bh(&newsk->sk_callback_lock);

 		/* Wake up receive process in case of 'SYN+' message */
@@ -577,12 +577,11 @@ bool tipc_topsrv_kern_subscr(struct net *net, u32 port, u32 type, u32 lower,
 	sub.filter = filter;
 	*(u64 *)&sub.usr_handle = (u64)port;

-	con = tipc_conn_alloc(tipc_topsrv(net));
+	con = tipc_conn_alloc(tipc_topsrv(net), NULL);
 	if (IS_ERR(con))
 		return false;

 	*conid = con->conid;
-	con->sock = NULL;
 	rc = tipc_conn_rcv_sub(tipc_topsrv(net), con, &sub);
 	if (rc >= 0)
 		return true;
--
2.31.1

[^](#m98e0188fe05e57ccd0806c1544738856c95b34dc) [permalink](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/) [raw](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/raw) [reply](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/#R) [related](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/#related)	[[flat](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/T/#u)|[nested](../../bc7bd3183f1c275c820690fc65b708238fe9e38e.1668807842.git.lucien.xin%40gmail.com/t/#u)] [5+ messages in thread](#r98e0188fe05e57ccd0806c1544738856c95b34dc)
```

---

```
[*](#ee5e050a7ebd300e6863556e24c3770a76917f776) [PATCH net 2/2] tipc: add an extra conn_get in tipc_conn_alloc
  2022-11-18 21:44 [[PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) Xin Long
  2022-11-18 21:45 ` [[PATCH net 1/2] tipc: set con sock](#m98e0188fe05e57ccd0806c1544738856c95b34dc) " Xin Long
@ 2022-11-18 21:45 ` Xin Long
  2022-11-22  0:47 ` [[PATCH net 0/2] tipc: fix two race issues](#mbae4f942d7118c1f54f09b12aef0b9f87fe4983f) " Jon Maloy
  2022-11-22  5:00 ` [patchwork-bot+netdevbpf](#mdc9509f4e788dfc4da024b743a877bc485e3fdbd)
  [3 siblings, 0 replies; 5+ messages in thread](#re5e050a7ebd300e6863556e24c3770a76917f776)
From: Xin Long @ 2022-11-18 21:45 UTC ([permalink](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/) / [raw](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/raw))
  To: [network dev](../../../netdev/?t=20221118214517), tipc-discussion
  Cc: davem, kuba, Eric Dumazet, Paolo Abeni, Jon Maloy, Ying Xue,
	Wei Chen

One extra conn_get() is needed in tipc_conn_alloc(), as after
tipc_conn_alloc() is called, tipc_conn_close() may free this
con before deferencing it in tipc_topsrv_accept():

   tipc_conn_alloc();
   newsk = newsock->sk;
                                 <---- tipc_conn_close();
   write_lock_bh(&sk->sk_callback_lock);
   newsk->sk_data_ready = tipc_conn_data_ready;

Then an uaf issue can be triggered:

  BUG: KASAN: use-after-free in tipc_topsrv_accept+0x1e7/0x370 [tipc]
  Call Trace:
   <TASK>
   dump_stack_lvl+0x33/0x46
   print_report+0x178/0x4b0
   kasan_report+0x8c/0x100
   kasan_check_range+0x179/0x1e0
   tipc_topsrv_accept+0x1e7/0x370 [tipc]
   process_one_work+0x6a3/0x1030
   worker_thread+0x8a/0xdf0

This patch fixes it by holding it in tipc_conn_alloc(), then after
all accessing in tipc_topsrv_accept() releasing it. Note when does
this in tipc_topsrv_kern_subscr(), as tipc_conn_rcv_sub() returns
0 or -1 only, we don't need to check for "> 0".

Fixes: c5fa7b3cf3cb ("tipc: introduce new TIPC server infrastructure")
Signed-off-by: Xin Long <lucien.xin@gmail.com>
---
 [net/tipc/topsrv.c](#Z2e.:..:4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin::40gmail.com:1net:tipc:topsrv.c) | 9 ++++++---
 1 file [changed](#ee5e050a7ebd300e6863556e24c3770a76917f776), 6 insertions(+), 3 deletions(-)

[diff](#iZ2e.:..:4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin::40gmail.com:1net:tipc:topsrv.c) --git a/net/tipc/topsrv.c b/net/tipc/topsrv.c
index b0f9aa521670..e3b427a70398 100644
--- a/net/tipc/topsrv.c
+++ b/net/tipc/topsrv.c
@@ -206,6 +206,7 @@ static struct tipc_conn *tipc_conn_alloc(struct tipc_topsrv *s, struct socket *s
 	set_bit(CF_CONNECTED, &con->flags);
 	con->server = s;
 	con->sock = sock;
+	conn_get(con);
 	spin_unlock_bh(&s->idr_lock);

 	return con;
@@ -484,6 +485,7 @@ static void tipc_topsrv_accept(struct work_struct *work)

 		/* Wake up receive process in case of 'SYN+' message */
 		newsk->sk_data_ready(newsk);
+		conn_put(con);
 	}
 }

@@ -583,10 +585,11 @@ bool tipc_topsrv_kern_subscr(struct net *net, u32 port, u32 type, u32 lower,

 	*conid = con->conid;
 	rc = tipc_conn_rcv_sub(tipc_topsrv(net), con, &sub);
-	if (rc >= 0)
-		return true;
+	if (rc)
+		conn_put(con);
+
 	conn_put(con);
-	return false;
+	return !rc;
 }

 void tipc_topsrv_kern_unsubscr(struct net *net, int conid)
--
2.31.1

[^](#me5e050a7ebd300e6863556e24c3770a76917f776) [permalink](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/) [raw](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/raw) [reply](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/#R) [related](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/#related)	[[flat](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/T/#u)|[nested](../../4e6c7e150d7268df5a166bbe19e14770bb70253d.1668807842.git.lucien.xin%40gmail.com/t/#u)] [5+ messages in thread](#re5e050a7ebd300e6863556e24c3770a76917f776)
```

---

```
[*](#ebae4f942d7118c1f54f09b12aef0b9f87fe4983f) Re: [PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc
  2022-11-18 21:44 [[PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) Xin Long
  2022-11-18 21:45 ` [[PATCH net 1/2] tipc: set con sock](#m98e0188fe05e57ccd0806c1544738856c95b34dc) " Xin Long
  2022-11-18 21:45 ` [[PATCH net 2/2] tipc: add an extra conn_get](#me5e050a7ebd300e6863556e24c3770a76917f776) " Xin Long
@ 2022-11-22  0:47 ` Jon Maloy
  2022-11-22  5:00 ` [patchwork-bot+netdevbpf](#mdc9509f4e788dfc4da024b743a877bc485e3fdbd)
  [3 siblings, 0 replies; 5+ messages in thread](#rbae4f942d7118c1f54f09b12aef0b9f87fe4983f)
From: Jon Maloy @ 2022-11-22  0:47 UTC ([permalink](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/) / [raw](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/raw))
  To: Xin Long, [network dev](../../../netdev/?t=20221122004831), tipc-discussion
  Cc: davem, kuba, Eric Dumazet, Paolo Abeni, Ying Xue, Wei Chen

On 11/18/22 16:44, Xin Long wrote:
> The race exists beteen tipc_topsrv_accept() and tipc_conn_close(),
> one is allocating the con while the other is freeing it and there
> is no proper lock protecting it. Therefore, a null-pointer-defer
> and a use-after-free may be triggered, see details on each patch.
>
> Xin Long (2):
>    tipc: set con sock in tipc_conn_alloc
>    tipc: add an extra conn_get in tipc_conn_alloc
>
>   net/tipc/topsrv.c | 20 +++++++++++---------
>   1 file changed, 11 insertions(+), 9 deletions(-)
>
Series
Acked-by: Jon Maloy <jmaloy@redhat.com>

[^](#mbae4f942d7118c1f54f09b12aef0b9f87fe4983f) [permalink](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/) [raw](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/raw) [reply](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/#R)	[[flat](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/T/#u)|[nested](../../ddde1e8f-4970-cc4b-144a-647679dbd1bb%40redhat.com/t/#u)] [5+ messages in thread](#rbae4f942d7118c1f54f09b12aef0b9f87fe4983f)
```

---

```
[*](#edc9509f4e788dfc4da024b743a877bc485e3fdbd) Re: [PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc
  2022-11-18 21:44 [[PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) Xin Long
                   ` [(2 preceding siblings ...)](#rbae4f942d7118c1f54f09b12aef0b9f87fe4983f)
  2022-11-22  0:47 ` [[PATCH net 0/2] tipc: fix two race issues](#mbae4f942d7118c1f54f09b12aef0b9f87fe4983f) " Jon Maloy
@ 2022-11-22  5:00 ` patchwork-bot+netdevbpf
  [3 siblings, 0 replies; 5+ messages in thread](#rdc9509f4e788dfc4da024b743a877bc485e3fdbd)
From: patchwork-bot+netdevbpf @ 2022-11-22  5:00 UTC ([permalink](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/) / [raw](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/raw))
  To: Xin Long
  Cc: [netdev](../../../netdev/?t=20221122050035), tipc-discussion, davem, kuba, edumazet, pabeni, jmaloy,
	ying.xue, harperchen1110

Hello:

This series was applied to netdev/net.git (master)
by Jakub Kicinski <kuba@kernel.org>:

On Fri, 18 Nov 2022 16:44:59 -0500 you wrote:
> The race exists beteen tipc_topsrv_accept() and tipc_conn_close(),
> one is allocating the con while the other is freeing it and there
> is no proper lock protecting it. Therefore, a null-pointer-defer
> and a use-after-free may be triggered, see details on each patch.
>
> Xin Long (2):
>   tipc: set con sock in tipc_conn_alloc
>   tipc: add an extra conn_get in tipc_conn_alloc
>
> [...]

Here is the summary with links:
  - [net,1/2] tipc: set con sock in tipc_conn_alloc
    <https://git.kernel.org/netdev/net/c/0e5d56c64afc>
  - [net,2/2] tipc: add an extra conn_get in tipc_conn_alloc
    <https://git.kernel.org/netdev/net/c/a7b42969d63f>

You are awesome, thank you!
--
Deet-doot-dot, I am a bot.
<https://korg.docs.kernel.org/patchwork/pwbot.html>

[^](#mdc9509f4e788dfc4da024b743a877bc485e3fdbd) [permalink](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/) [raw](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/raw) [reply](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/#R)	[[flat](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/T/#u)|[nested](../../166909322186.4259.10273863059651319220.git-patchwork-notify%40kernel.org/t/#u)] [5+ messages in thread](#rdc9509f4e788dfc4da024b743a877bc485e3fdbd)
```

---

```
end of thread, other threads:[[~2022-11-22  5:00 UTC](../../?t=20221122050035) | [newest](../../)]

Thread overview: 5+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-11-18 21:44 [[PATCH net 0/2] tipc: fix two race issues in tipc_conn_alloc](#m81faa027747b7a1b60bb845b1158e7fa3653b97d) Xin Long
2022-11-18 21:45 ` [[PATCH net 1/2] tipc: set con sock](#m98e0188fe05e57ccd0806c1544738856c95b34dc) " Xin Long
2022-11-18 21:45 ` [[PATCH net 2/2] tipc: add an extra conn_get](#me5e050a7ebd300e6863556e24c3770a76917f776) " Xin Long
2022-11-22  0:47 ` [[PATCH net 0/2] tipc: fix two race issues](#mbae4f942d7118c1f54f09b12aef0b9f87fe4983f) " Jon Maloy
2022-11-22  5:00 ` [patchwork-bot+netdevbpf](#mdc9509f4e788dfc4da024b743a877bc485e3fdbd)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

