=== Content from lore.kernel.org_6d33baeb_20250114_194909.html ===

```
[All of lore.kernel.org](../?t=20230313090635)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Zheng Wang <zyytlz.wz@163.com>
To: ericvh@gmail.com
Cc: lucho@ionkov.net, asmadeus@codewreck.org,
	linux_oss@crudebyte.com, davem@davemloft.net,
	edumazet@google.com, kuba@kernel.org, pabeni@redhat.com,
	v9fs-developer@lists.sourceforge.net, [netdev@vger.kernel.org](../../netdev/?t=20230313090635),
	[linux-kernel@vger.kernel.org](../../lkml/?t=20230313090635), hackerzheng666@gmail.com,
	1395428693sheep@gmail.com, alex000young@gmail.com,
	Zheng Wang <zyytlz.wz@163.com>
Subject: [[PATCH net v2] 9p/xen : Fix use after free bug in xen_9pfs_front_remove due  to race condition](#r)
Date: Mon, 13 Mar 2023 17:00:02 +0800	[[thread overview]](#r)
Message-ID: <20230313090002.3308025-1-zyytlz.wz@163.com> (<raw>)

In xen_9pfs_front_probe, it calls xen_9pfs_front_alloc_dataring
to init priv->rings and bound &ring->work with p9_xen_response.

When it calls xen_9pfs_front_event_handler to handle IRQ requests,
it will finally call schedule_work to start the work.

When we call xen_9pfs_front_remove to remove the driver, there
may be a sequence as follows:

Fix it by finishing the work before cleanup in xen_9pfs_front_free.

Note that, this bug is found by static analysis, which might be
false positive.

CPU0                  CPU1

                     |p9_xen_response
xen_9pfs_front_remove|
  xen_9pfs_front_free|
kfree(priv)          |
//free priv          |
                     |p9_tag_lookup
                     |//use priv->client

Fixes: 71ebd71921e4 ("xen/9pfs: connect to the backend")
Signed-off-by: Zheng Wang <zyytlz.wz@163.com>
---
v2:
- fix type error of ring found by kernel test robot
---
 [net/9p/trans_xen.c](#Z31net:9p:trans_xen.c) | 5 +++++
 1 file [changed](#related), 5 insertions(+)

[diff](#iZ31net:9p:trans_xen.c) --git a/net/9p/trans_xen.c b/net/9p/trans_xen.c
index c64050e839ac..83764431c066 100644
--- a/net/9p/trans_xen.c
+++ b/net/9p/trans_xen.c
@@ -274,12 +274,17 @@ static const struct xenbus_device_id xen_9pfs_front_ids[] = {
 static void xen_9pfs_front_free(struct xen_9pfs_front_priv *priv)
 {
 	int i, j;
+	struct xen_9pfs_dataring *ring = NULL;

 	write_lock(&xen_9pfs_lock);
 	list_del(&priv->list);
 	write_unlock(&xen_9pfs_lock);

 	for (i = 0; i < priv->num_rings; i++) {
+		/*cancel work*/
+		ring = &priv->rings[i];
+		cancel_work_sync(&ring->work);
+
 		if (!priv->rings[i].intf)
 			break;
 		if (priv->rings[i].irq > 0)
--
2.25.1

```

---

```
[next](../ZA8rDCw%2BmJmyETEx%40localhost.localdomain/)             [reply](#R)	other threads:[[~2023-03-13  9:06 UTC](../?t=20230313090635)|[newest](../)]

Thread overview: 10+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2023-03-13  9:00 [Zheng Wang [this message]](#t)
2023-03-13 13:54 ` [[PATCH net v2] 9p/xen : Fix use after free bug in xen_9pfs_front_remove due to race condition](../ZA8rDCw%2BmJmyETEx%40localhost.localdomain/) Michal Swiatkowski
2023-03-13 14:01   ` [Zheng Hacker](../CAJedcCwgvo3meC%3Dk_nPYrRzEj7Hzcy8kqrvHqHLvmPWLjCq_3Q%40mail.gmail.com/)
2023-03-13 14:07     ` [Michal Swiatkowski](../ZA8uMtMyYKhcEYQ/%40localhost.localdomain/)
2023-03-13 14:10       ` [Zheng Hacker](../CAJedcCzLs3d3r1%3D3oXzE1%3D0Y%3DVhAfj62S3BgMNZjKbHYW0Wiaw%40mail.gmail.com/)
2023-03-13 21:30   ` [Jakub Kicinski](../20230313143054.538565ac%40kernel.org/)
2023-03-13 22:07     ` [asmadeus](../ZA%2BetMBFSw/999Aq%40codewreck.org/)
2023-03-14  1:14       ` [Zheng Hacker](../CAJedcCyH_JvVeyFq1i8Udx%3DW7PO7F%2BaYeQp%2Br6dbWQLqMNgy_w%40mail.gmail.com/)
2023-03-14  1:07     ` [Zheng Hacker](../CAJedcCwXhrkfVOHz-%2BN%3DqZxP465JJ0wSJG37ppOAFNfDt0ABqQ%40mail.gmail.com/)
  -- strict thread matches above, loose matches on Subject: below --
2023-03-13 16:54 [Zheng Wang](../20230313165407.3766584-1-zyytlz.wz%40163.com/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:c64050e839a dfblob:83764431c06 )
 OR (
bs:"[PATCH net v2] 9p/xen : Fix use after free bug in xen_9pfs_front_remove due  to race condition" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20230313090002.3308025-1-zyytlz.wz@163.com \
    --to=zyytlz.wz@163.com \
    --cc=1395428693sheep@gmail.com \
    --cc=alex000young@gmail.com \
    --cc=asmadeus@codewreck.org \
    --cc=davem@davemloft.net \
    --cc=edumazet@google.com \
    --cc=ericvh@gmail.com \
    --cc=hackerzheng666@gmail.com \
    --cc=kuba@kernel.org \
    --cc=linux-kernel@vger.kernel.org \
    --cc=linux_oss@crudebyte.com \
    --cc=lucho@ionkov.net \
    --cc=netdev@vger.kernel.org \
    --cc=pabeni@redhat.com \
    --cc=v9fs-developer@lists.sourceforge.net \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

