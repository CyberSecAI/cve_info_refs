=== Content from plugins.trac.wordpress.org_a4fac17a_20250115_080402.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Funusedcss%2Ftags%2F1.7.1%2Fincludes%2Fmodules%2Funused-css%2FUnusedCSS_Admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/unusedcss/trunk/includes/modules/unused-css/UnusedCSS_Admin.php?rev=2839737 "Revision 2839737")
* [Next Revision](/browser/unusedcss/trunk/includes/modules/unused-css/UnusedCSS_Admin.php?rev=2877726 "Revision 2877726") →
* [Blame](/browser/unusedcss/trunk/includes/modules/unused-css/UnusedCSS_Admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/unusedcss/tags/1.7.1/includes/modules/unused-css/UnusedCSS_Admin.php)

---

# [source:](/browser?order=name "Go to repository root") [unusedcss](/browser/unusedcss?order=name "View unusedcss")/[tags](/browser/unusedcss/tags?order=name "View tags")/[1.7.1](/browser/unusedcss/tags/1.7.1?order=name "View 1.7.1")/[includes](/browser/unusedcss/tags/1.7.1/includes?order=name "View includes")/[modules](/browser/unusedcss/tags/1.7.1/includes/modules?order=name "View modules")/[unused-css](/browser/unusedcss/tags/1.7.1/includes/modules/unused-css?order=name "View unused-css")/[UnusedCSS\_Admin.php](/browser/unusedcss/tags/1.7.1/includes/modules/unused-css/UnusedCSS_Admin.php?order=name "View UnusedCSS_Admin.php")

View diff against:

View revision:

| [Last change](/changeset/2847136/unusedcss/trunk/includes/modules/unused-css/UnusedCSS_Admin.php "View differences") on this file was [2847136](/changeset/2847136/ "View changeset 2847136"), checked in by shakee93, [2 years ago](/timeline?from=2023-01-12T05%3A08%3A39Z&precision=second "See timeline at 01/12/2023 05:08:39 AM") |
| --- |
| Update to version 1.6.36 from GitHub |
| **File size:** 43.8 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | defined( 'ABSPATH' ) or die(); |
| [4](#L4) |  |
| [5](#L5) | /\*\* |
| [6](#L6) | \* Class UnusedCSS |
| [7](#L7) | \*/ |
| [8](#L8) | abstract class UnusedCSS\_Admin { |
| [9](#L9) |  |
| [10](#L10) | use RapidLoad\_Utils; |
| [11](#L11) |  |
| [12](#L12) | /\*\* |
| [13](#L13) | \* @var UnusedCSS\_Autoptimize |
| [14](#L14) | \*/ |
| [15](#L15) | public $uucss; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* @var bool |
| [19](#L19) | \*/ |
| [20](#L20) | public static $enabled = true; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Page related meta options |
| [24](#L24) | \* @var array |
| [25](#L25) | \*/ |
| [26](#L26) | public static $page\_options = [ |
| [27](#L27) | 'safelist', |
| [28](#L28) | 'exclude', |
| [29](#L29) | 'blocklist' |
| [30](#L30) | ]; |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* UnusedCSS constructor. |
| [34](#L34) | \* @param UnusedCSS $uucss |
| [35](#L35) | \*/ |
| [36](#L36) | public function \_\_construct($uucss) |
| [37](#L37) | { |
| [38](#L38) |  |
| [39](#L39) | $this->uucss = $uucss; |
| [40](#L40) |  |
| [41](#L41) | if(is\_admin()){ |
| [42](#L42) |  |
| [43](#L43) | add\_action( 'admin\_menu', array( $this, 'add\_uucss\_option\_page' ) ); |
| [44](#L44) |  |
| [45](#L45) | } |
| [46](#L46) |  |
| [47](#L47) |  |
| [48](#L48) | if (!self::$enabled) { |
| [49](#L49) | return; |
| [50](#L50) | } |
| [51](#L51) |  |
| [52](#L52) | add\_action( 'current\_screen', function () { |
| [53](#L53) |  |
| [54](#L54) | if ( get\_current\_screen() && get\_current\_screen()->base == 'settings\_page\_uucss' ) { |
| [55](#L55) | add\_action( 'admin\_enqueue\_scripts', [ $this, 'enqueueScripts' ] ); |
| [56](#L56) | } |
| [57](#L57) | } ); |
| [58](#L58) |  |
| [59](#L59) | $this->cache\_trigger\_hooks(); |
| [60](#L60) |  |
| [61](#L61) | add\_action( 'add\_meta\_boxes', [$this, 'add\_meta\_boxes'] ); |
| [62](#L62) | add\_action( 'save\_post', [$this, 'save\_meta\_box\_options'] , 10, 2); |
| [63](#L63) | add\_action( "uucss\_run\_gpsi\_test\_for\_all", [ $this, 'run\_gpsi\_test\_for\_all' ]); |
| [64](#L64) |  |
| [65](#L65) | add\_filter( 'plugin\_action\_links\_' . plugin\_basename( UUCSS\_PLUGIN\_FILE ), [ |
| [66](#L66) | $this, |
| [67](#L67) | 'add\_plugin\_action\_link' |
| [68](#L68) | ] ); |
| [69](#L69) |  |
| [70](#L70) | if(is\_admin()){ |
| [71](#L71) |  |
| [72](#L72) | $this->deactivate(); |
| [73](#L73) |  |
| [74](#L74) | add\_action('current\_screen', [$this, 'validate\_domain']); |
| [75](#L75) | add\_action('wp\_ajax\_clear\_page\_cache', [$this, 'clear\_page\_cache']); |
| [76](#L76) | add\_action('wp\_ajax\_mark\_faqs\_read', [$this, 'mark\_faqs\_read']); |
| [77](#L77) | add\_action('wp\_ajax\_mark\_notice\_read', [$this, 'mark\_notice\_read']); |
| [78](#L78) | add\_action('wp\_ajax\_frontend\_logs', [$this, 'frontend\_logs']); |
| [79](#L79) | add\_action('wp\_ajax\_uucss\_logs', [$this, 'uucss\_logs']); |
| [80](#L80) | add\_action('wp\_ajax\_clear\_uucss\_logs', [$this, 'clear\_uucss\_logs']); |
| [81](#L81) | add\_action( "wp\_ajax\_uucss\_test\_url", [ $this, 'uucss\_test\_url' ] ); |
| [82](#L82) | add\_action( "wp\_ajax\_uucss\_run\_gpsi\_status\_check\_for\_all", [ $this, 'run\_gpsi\_status\_check\_for\_all' ] ); |
| [83](#L83) | add\_action( "wp\_ajax\_uucss\_data", [ $this, 'uucss\_data' ] ); |
| [84](#L84) | add\_action( "wp\_ajax\_uucss\_license", [ $this, 'uucss\_license' ] ); |
| [85](#L85) | add\_action( "wp\_ajax\_uucss\_status", [ $this, 'uucss\_status' ] ); |
| [86](#L86) | add\_action( "wp\_ajax\_uucss\_rule\_stats", [ $this, 'uucss\_rule\_stats' ] ); |
| [87](#L87) | add\_action( "wp\_ajax\_suggest\_whitelist\_packs", [ $this, 'suggest\_whitelist\_packs' ] ); |
| [88](#L88) | add\_action( "wp\_ajax\_verify\_api\_key", [ $this, 'verify\_api\_key' ] ); |
| [89](#L89) | add\_action( "wp\_ajax\_uucss\_deactivate", [ $this, 'ajax\_deactivate' ] ); |
| [90](#L90) | add\_action( "wp\_ajax\_uucss\_connect", [ $this, 'uucss\_connect' ] ); |
| [91](#L91) | add\_action( "wp\_ajax\_attach\_rule", [ $this, 'attach\_rule' ] ); |
| [92](#L92) | add\_action( "wp\_ajax\_uucss\_update\_rule", [ $this, 'uucss\_update\_rule' ] ); |
| [93](#L93) | add\_action( 'wp\_ajax\_uucss\_queue', [$this, 'queue\_posts']); |
| [94](#L94) | add\_action( 'wp\_ajax\_rapidload\_notifications', [$this, 'rapidload\_notifications']); |
| [95](#L95) | add\_action( 'admin\_notices', [ $this, 'first\_uucss\_job' ] ); |
| [96](#L96) | add\_action( 'updated\_option', [ $this, 'clear\_cache\_on\_option\_update' ], 10, 3 ); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | add\_action( 'uucss\_sitemap\_queue', [$this, 'queue\_sitemap'], 10, 1); |
| [100](#L100) |  |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | function rapidload\_notifications(){ |
| [104](#L104) |  |
| [105](#L105) | wp\_send\_json\_success([ |
| [106](#L106) | 'faqs' => $this->get\_faqs(), |
| [107](#L107) | 'notifications' => $this->get\_public\_notices() |
| [108](#L108) | ]); |
| [109](#L109) |  |
| [110](#L110) | } |
| [111](#L111) |  |
| [112](#L112) | function queue\_posts(){ |
| [113](#L113) |  |
| [114](#L114) | if(!isset($\_REQUEST['post\_type'])) { |
| [115](#L115) | wp\_send\_json\_error('post type not found'); |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) | $type = isset($\_REQUEST['type']) ? $\_REQUEST['type'] : 'path'; |
| [119](#L119) | $rule = isset($\_REQUEST['rule']) ? $\_REQUEST['rule'] : false; |
| [120](#L120) | $regex = isset($\_REQUEST['regex']) ? $\_REQUEST['regex'] : false; |
| [121](#L121) |  |
| [122](#L122) | $post\_type = sanitize\_text\_field($\_REQUEST['post\_type']); |
| [123](#L123) |  |
| [124](#L124) | $list = isset($\_POST['url\_list']) ? $\_POST['url\_list'] : null; |
| [125](#L125) |  |
| [126](#L126) | $posts = null; |
| [127](#L127) |  |
| [128](#L128) | global $uucss; |
| [129](#L129) |  |
| [130](#L130) | if(isset($list) && is\_array($list) && !empty($list)){ |
| [131](#L131) |  |
| [132](#L132) | if($type == 'path'){ |
| [133](#L133) | UnusedCSS\_DB::requeue\_urls($list); |
| [134](#L134) | }else{ |
| [135](#L135) | UnusedCSS\_DB::requeue\_rules($list); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | $this->uucss->cleanCacheFiles(); |
| [139](#L139) |  |
| [140](#L140) | wp\_send\_json\_success('successfully links added to the queue'); |
| [141](#L141) | }else if($post\_type == 'current'){ |
| [142](#L142) |  |
| [143](#L143) | if($type == 'path'){ |
| [144](#L144) | RapidLoad\_Settings::clear\_links(true); |
| [145](#L145) | }else{ |
| [146](#L146) | UnusedCSS\_DB::clear\_rules(true); |
| [147](#L147) | } |
| [148](#L148) |  |
| [149](#L149) | $this->uucss->cleanCacheFiles(); |
| [150](#L150) |  |
| [151](#L151) | wp\_send\_json\_success('successfully links added to the queue'); |
| [152](#L152) |  |
| [153](#L153) | }else if($post\_type == 'processing'){ |
| [154](#L154) |  |
| [155](#L155) | if($type == 'path'){ |
| [156](#L156) | UnusedCSS\_DB::requeue\_jobs('processing'); |
| [157](#L157) | UnusedCSS\_DB::requeue\_jobs('waiting'); |
| [158](#L158) | }else{ |
| [159](#L159) | UnusedCSS\_DB::requeue\_rule\_jobs('processing'); |
| [160](#L160) | UnusedCSS\_DB::requeue\_rule\_jobs('waiting'); |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | $this->uucss->cleanCacheFiles(); |
| [164](#L164) |  |
| [165](#L165) | wp\_send\_json\_success('successfully links added to the queue'); |
| [166](#L166) |  |
| [167](#L167) | }else if($post\_type == 'warnings'){ |
| [168](#L168) |  |
| [169](#L169) | if($type == 'path'){ |
| [170](#L170) | UnusedCSS\_DB::requeue\_jobs('warnings'); |
| [171](#L171) | }else{ |
| [172](#L172) | UnusedCSS\_DB::requeue\_rule\_jobs('warnings'); |
| [173](#L173) | } |
| [174](#L174) |  |
| [175](#L175) | $this->uucss->cleanCacheFiles(); |
| [176](#L176) |  |
| [177](#L177) | wp\_send\_json\_success('successfully links added to the queue'); |
| [178](#L178) |  |
| [179](#L179) | }else if($post\_type == 'failed'){ |
| [180](#L180) |  |
| [181](#L181) | if($type == 'path'){ |
| [182](#L182) | UnusedCSS\_DB::requeue\_jobs(); |
| [183](#L183) | }else{ |
| [184](#L184) | UnusedCSS\_DB::requeue\_rule\_jobs(); |
| [185](#L185) | } |
| [186](#L186) |  |
| [187](#L187) | $this->uucss->cleanCacheFiles(); |
| [188](#L188) |  |
| [189](#L189) | wp\_send\_json\_success('successfully links added to the queue'); |
| [190](#L190) |  |
| [191](#L191) | }else if($post\_type == 'url'){ |
| [192](#L192) |  |
| [193](#L193) | $url = isset($\_REQUEST['url']) ? $\_REQUEST['url'] : false; |
| [194](#L194) |  |
| [195](#L195) | if($url && !$this->is\_url\_allowed($url)){ |
| [196](#L196) | wp\_send\_json\_error('url is excluded'); |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | $url\_object = false; |
| [200](#L200) |  |
| [201](#L201) | if($type == 'path'){ |
| [202](#L202) |  |
| [203](#L203) | $url\_object = new UnusedCSS\_Path([ |
| [204](#L204) | 'url' => $url |
| [205](#L205) | ]); |
| [206](#L206) |  |
| [207](#L207) | }else{ |
| [208](#L208) |  |
| [209](#L209) | $url\_object = new UnusedCSS\_Rule([ |
| [210](#L210) | 'rule' => $rule, |
| [211](#L211) | 'regex' => $regex |
| [212](#L212) | ]); |
| [213](#L213) |  |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | if(!$url\_object){ |
| [217](#L217) |  |
| [218](#L218) | wp\_send\_json\_error('Invalid URL'); |
| [219](#L219) |  |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | $url\_object->requeue(); |
| [223](#L223) | $url\_object->save(); |
| [224](#L224) |  |
| [225](#L225) | wp\_send\_json\_success('successfully link added to the queue'); |
| [226](#L226) |  |
| [227](#L227) | }else if($post\_type == 'site\_map'){ |
| [228](#L228) |  |
| [229](#L229) | $sitemap = isset($\_REQUEST['url']) ? $\_REQUEST['url'] : false; |
| [230](#L230) |  |
| [231](#L231) | if(!$sitemap){ |
| [232](#L232) |  |
| [233](#L233) | wp\_send\_json\_error('site map url required'); |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | $spawned = $this->schedule\_cron('uucss\_sitemap\_queue',[ |
| [237](#L237) | 'url' => $sitemap |
| [238](#L238) | ]); |
| [239](#L239) |  |
| [240](#L240) | wp\_send\_json\_success('Sitemap links scheduled to be added to the queue.'); |
| [241](#L241) |  |
| [242](#L242) | }else{ |
| [243](#L243) |  |
| [244](#L244) | $posts = new WP\_Query(array( |
| [245](#L245) | 'post\_type'=> $post\_type, |
| [246](#L246) | 'posts\_per\_page' => -1 |
| [247](#L247) | )); |
| [248](#L248) |  |
| [249](#L249) | } |
| [250](#L250) |  |
| [251](#L251) | if($posts && $posts->have\_posts()){ |
| [252](#L252) | while ($posts->have\_posts()){ |
| [253](#L253) | $posts->the\_post(); |
| [254](#L254) |  |
| [255](#L255) | $url = $this->transform\_url(get\_the\_permalink(get\_the\_ID())); |
| [256](#L256) |  |
| [257](#L257) | if($this->is\_url\_allowed($url)){ |
| [258](#L258) | new UnusedCSS\_Path([ |
| [259](#L259) | 'url' => $url |
| [260](#L260) | ]); |
| [261](#L261) | } |
| [262](#L262) |  |
| [263](#L263) | } |
| [264](#L264) | } |
| [265](#L265) |  |
| [266](#L266) | wp\_reset\_query(); |
| [267](#L267) |  |
| [268](#L268) | wp\_send\_json\_success('successfully links added to the queue'); |
| [269](#L269) |  |
| [270](#L270) | } |
| [271](#L271) |  |
| [272](#L272) | function queue\_sitemap($url = false){ |
| [273](#L273) |  |
| [274](#L274) | if(!$url){ |
| [275](#L275) |  |
| [276](#L276) | $url = apply\_filters('uucss/sitemap/default', stripslashes(get\_site\_url(get\_current\_blog\_id())) . '/sitemap\_index.xml'); |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | $site\_map = new RapidLoad\_Sitemap(); |
| [280](#L280) | $urls = $site\_map->process\_site\_map($url); |
| [281](#L281) |  |
| [282](#L282) | global $uucss; |
| [283](#L283) |  |
| [284](#L284) | if(isset($urls) && !empty($urls)){ |
| [285](#L285) |  |
| [286](#L286) | foreach ($urls as $url){ |
| [287](#L287) |  |
| [288](#L288) | if($this->is\_url\_allowed($this->transform\_url($url))){ |
| [289](#L289) |  |
| [290](#L290) | new UnusedCSS\_Path([ |
| [291](#L291) | 'url' => $url |
| [292](#L292) | ]); |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | } |
| [296](#L296) | } |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | public function add\_uucss\_option\_page() { |
| [300](#L300) |  |
| [301](#L301) | add\_submenu\_page( 'options-general.php', 'RapidLoad', 'RapidLoad', 'manage\_options', 'uucss', function () { |
| [302](#L302) | wp\_enqueue\_script( 'post' ); |
| [303](#L303) |  |
| [304](#L304) | ?> |
| [305](#L305) | <div class="wrap"> |
| [306](#L306) | <h1><?php \_e( 'RapidLoad Settings', 'autoptimize' ); ?></h1> |
| [307](#L307) | <?php |
| [308](#L308) | do\_action('uucss/options/before\_render\_form'); |
| [309](#L309) | ?> |
| [310](#L310) | <div> |
| [311](#L311) | <?php $this->render\_form() ?> |
| [312](#L312) | </div> |
| [313](#L313) | </div> |
| [314](#L314) |  |
| [315](#L315) | <?php |
| [316](#L316) | }); |
| [317](#L317) |  |
| [318](#L318) | register\_setting('autoptimize\_uucss\_settings', 'autoptimize\_uucss\_settings'); |
| [319](#L319) |  |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) | public function render\_form() { |
| [323](#L323) | $options = RapidLoad\_Base::fetch\_options(); |
| [324](#L324) |  |
| [325](#L325) | include('parts/options-page.html.php'); |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | public function uucss\_rule\_stats(){ |
| [329](#L329) |  |
| [330](#L330) | wp\_send\_json\_success([ |
| [331](#L331) | 'duplicateFiles' => UnusedCSS\_DB::get\_duplicate\_files() |
| [332](#L332) | ]); |
| [333](#L333) |  |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | public function uucss\_status(){ |
| [337](#L337) |  |
| [338](#L338) | $job\_counts = UnusedCSS\_DB::get\_job\_counts(); |
| [339](#L339) |  |
| [340](#L340) | wp\_send\_json\_success([ |
| [341](#L341) | 'cssStyleSheetsCount' => $this->uucss->cache\_file\_count(), |
| [342](#L342) | 'cssStyleSheetsSize' => $this->uucss->size(), |
| [343](#L343) | 'hits' => $job\_counts->hits, |
| [344](#L344) | 'success' => $job\_counts->success, |
| [345](#L345) | 'ruleBased' => $job\_counts->rule\_based, |
| [346](#L346) | 'queued' => $job\_counts->queued, |
| [347](#L347) | 'waiting' => $job\_counts->waiting, |
| [348](#L348) | 'processing' => $job\_counts->processing, |
| [349](#L349) | 'warnings' => $job\_counts->warnings, |
| [350](#L350) | 'failed' => $job\_counts->failed, |
| [351](#L351) | 'total' => $job\_counts->total, |
| [352](#L352) | ]); |
| [353](#L353) | } |
| [354](#L354) |  |
| [355](#L355) | public function uucss\_update\_rule(){ |
| [356](#L356) |  |
| [357](#L357) | if( !isset($\_REQUEST['rule']) || empty($\_REQUEST['rule']) || |
| [358](#L358) | !isset($\_REQUEST['url']) || empty($\_REQUEST['url']) |
| [359](#L359) | ){ |
| [360](#L360) | wp\_send\_json\_error('Required fields missing'); |
| [361](#L361) | } |
| [362](#L362) |  |
| [363](#L363) | $rule = $\_REQUEST['rule']; |
| [364](#L364) | $url = $\_REQUEST['url']; |
| [365](#L365) | $regex = isset($\_REQUEST['regex']) ? $\_REQUEST['regex'] : '/'; |
| [366](#L366) |  |
| [367](#L367) | $url = $this->transform\_url($url); |
| [368](#L368) |  |
| [369](#L369) | global $uucss; |
| [370](#L370) |  |
| [371](#L371) | if(!$this->is\_url\_allowed($url)){ |
| [372](#L372) | wp\_send\_json\_error('URL not allowed'); |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | if(!self::is\_url\_glob\_matched($url, $regex)){ |
| [376](#L376) | wp\_send\_json\_error('Invalid regex for the url'); |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) | $ruleObject = false; |
| [380](#L380) | $update\_mode = 'create'; |
| [381](#L381) |  |
| [382](#L382) | if(isset($\_REQUEST['old\_rule']) && isset($\_REQUEST['old\_regex'])){ |
| [383](#L383) |  |
| [384](#L384) | $old\_rule = $\_REQUEST['old\_rule']; |
| [385](#L385) | $old\_regex = $\_REQUEST['old\_regex']; |
| [386](#L386) | $old\_url = $\_REQUEST['old\_url']; |
| [387](#L387) |  |
| [388](#L388) | if(UnusedCSS\_DB::rule\_exists\_with\_error( $old\_rule, $old\_regex)){ |
| [389](#L389) |  |
| [390](#L390) | $ruleObject = new UnusedCSS\_Rule([ |
| [391](#L391) | 'rule' => $old\_rule, |
| [392](#L392) | 'regex' => $old\_regex |
| [393](#L393) | ]); |
| [394](#L394) |  |
| [395](#L395) | if(isset($\_REQUEST['old\_url']) && $\_REQUEST['old\_url'] != $url || |
| [396](#L396) | $\_REQUEST['old\_rule'] != $rule || $\_REQUEST['old\_regex'] != $regex){ |
| [397](#L397) | if(isset($\_REQUEST['requeue']) && $\_REQUEST['requeue'] == "1"){ |
| [398](#L398) | error\_log($\_REQUEST['requeue']); |
| [399](#L399) | $ruleObject->requeue(); |
| [400](#L400) | $ruleObject->releaseRule(); |
| [401](#L401) | } |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | $ruleObject->url = $url; |
| [405](#L405) | $ruleObject->rule = $rule; |
| [406](#L406) | $ruleObject->regex = $regex; |
| [407](#L407) | $ruleObject->save(); |
| [408](#L408) | $update\_mode = 'update'; |
| [409](#L409) |  |
| [410](#L410) |  |
| [411](#L411) |  |
| [412](#L412) | do\_action('uucss/rule/saved', $ruleObject, [ |
| [413](#L413) | 'rule' => $old\_rule, |
| [414](#L414) | 'regex' => $old\_regex, |
| [415](#L415) | 'url' => $old\_url |
| [416](#L416) | ]); |
| [417](#L417) |  |
| [418](#L418) | wp\_send\_json\_success('Rule updated successfully'); |
| [419](#L419) | } |
| [420](#L420) |  |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | if(UnusedCSS\_DB::rule\_exists\_with\_error($\_REQUEST['rule'], $\_REQUEST['regex'])){ |
| [424](#L424) | wp\_send\_json\_error('Rule already exist'); |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | $ruleObject = new UnusedCSS\_Rule([ |
| [428](#L428) | 'rule' => $rule, |
| [429](#L429) | 'url' => $url, |
| [430](#L430) | 'regex' => $regex, |
| [431](#L431) | ]); |
| [432](#L432) |  |
| [433](#L433) | do\_action('uucss/rule/saved', $ruleObject, false); |
| [434](#L434) |  |
| [435](#L435) | wp\_send\_json\_success('Rule updated successfully'); |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | public function attach\_rule(){ |
| [439](#L439) |  |
| [440](#L440) | $type = isset($\_REQUEST['type']) ? $\_REQUEST['type'] : false; |
| [441](#L441) | $url = isset($\_REQUEST['url']) ? $\_REQUEST['url'] : false; |
| [442](#L442) | $rule\_id = isset($\_REQUEST['rule\_id']) ? $\_REQUEST['rule\_id'] : false; |
| [443](#L443) |  |
| [444](#L444) | if(!$type || !$url){ |
| [445](#L445) | wp\_send\_json\_error('Required field missing'); |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | if($type == 'detach' && UnusedCSS\_DB::rule\_exist\_by\_url($url)){ |
| [449](#L449) | wp\_send\_json\_error('Rule exist with same url'); |
| [450](#L450) | } |
| [451](#L451) |  |
| [452](#L452) | if($type == 'detach' && UnusedCSS\_DB::link\_exists\_with\_error($url)){ |
| [453](#L453) |  |
| [454](#L454) | $path = new UnusedCSS\_Path([ |
| [455](#L455) | 'url' => $url |
| [456](#L456) | ]); |
| [457](#L457) | $path->attach\_rule(); |
| [458](#L458) | $path->save(); |
| [459](#L459) | wp\_send\_json\_success('Successfully detached from rule'); |
| [460](#L460) | } |
| [461](#L461) |  |
| [462](#L462) | if(!is\_numeric($rule\_id) || !$type || $type == 'attach' && !$rule\_id){ |
| [463](#L463) | wp\_send\_json\_error('Required field missing'); |
| [464](#L464) | } |
| [465](#L465) |  |
| [466](#L466) | if($type == 'attach'){ |
| [467](#L467) |  |
| [468](#L468) | $rule = UnusedCSS\_Rule::get\_rule\_from\_id($rule\_id); |
| [469](#L469) |  |
| [470](#L470) | if(!$rule){ |
| [471](#L471) | wp\_send\_json\_error('Rule not found'); |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | $path = new UnusedCSS\_Path([ |
| [475](#L475) | 'url' => $url |
| [476](#L476) | ]); |
| [477](#L477) |  |
| [478](#L478) | if(!self::is\_url\_glob\_matched($url, $rule->regex)){ |
| [479](#L479) | wp\_send\_json\_success('Pattern not matched'); |
| [480](#L480) | } |
| [481](#L481) |  |
| [482](#L482) | $path->attach\_rule($rule->id, $rule->rule); |
| [483](#L483) | $path->save(); |
| [484](#L484) | wp\_send\_json\_success('Successfully attached to rule'); |
| [485](#L485) | } |
| [486](#L486) |  |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | public static function is\_domain\_verified(){ |
| [490](#L490) | $options = self::get\_site\_option( 'autoptimize\_uucss\_settings' ); |
| [491](#L491) | return  $options['valid\_domain']; |
| [492](#L492) | } |
| [493](#L493) |  |
| [494](#L494) | public function clear\_cache\_on\_option\_update( $option, $old\_value, $value ) { |
| [495](#L495) |  |
| [496](#L496) | if ( $option == 'autoptimize\_uucss\_settings' && $this->uucss ) { |
| [497](#L497) |  |
| [498](#L498) | $needs\_to\_cleared = false; |
| [499](#L499) |  |
| [500](#L500) | $diffs = []; |
| [501](#L501) | $diffs\_invert = []; |
| [502](#L502) |  |
| [503](#L503) | if ( $old\_value && $value ) { |
| [504](#L504) | $diffs        = array\_diff\_key( $old\_value, $value ); |
| [505](#L505) | $diffs\_invert = array\_diff\_key( $value, $old\_value ); |
| [506](#L506) | } |
| [507](#L507) |  |
| [508](#L508) | if ( isset( $diffs\_invert['valid\_domain'] ) ) { |
| [509](#L509) | unset( $diffs\_invert['valid\_domain'] ); |
| [510](#L510) | } |
| [511](#L511) | if ( isset( $diffs['valid\_domain'] ) ) { |
| [512](#L512) | unset( $diffs['valid\_domain'] ); |
| [513](#L513) | } |
| [514](#L514) |  |
| [515](#L515) | $diffs = array\_merge( $diffs, $diffs\_invert ); |
| [516](#L516) |  |
| [517](#L517) | // if these settings are changed cache will be cleared |
| [518](#L518) | if ( isset( $diffs['uucss\_minify'] ) || |
| [519](#L519) | isset( $diffs['uucss\_keyframes'] ) || |
| [520](#L520) | isset( $diffs['uucss\_fontface'] ) || |
| [521](#L521) | isset( $diffs['uucss\_analyze\_javascript'] ) || |
| [522](#L522) | isset( $diffs['uucss\_safelist'] ) || |
| [523](#L523) | isset( $diffs['whitelist\_packs'] ) || |
| [524](#L524) | isset( $diffs['uucss\_blocklist'] ) || |
| [525](#L525) | isset( $diffs['uucss\_variables'] ) ) { |
| [526](#L526) | $needs\_to\_cleared = true; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | foreach ( [ 'whitelist\_packs', 'uucss\_safelist', 'uucss\_blocklist' ] as $compare\_value ) { |
| [530](#L530) | if ( isset( $value[ $compare\_value ] ) && isset( $old\_value[ $compare\_value ] ) && $old\_value[ $compare\_value ] !== $value[ $compare\_value ] ) { |
| [531](#L531) | $needs\_to\_cleared = true; |
| [532](#L532) | break; |
| [533](#L533) | } |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | if(isset( $diffs['uucss\_enable\_rules'] )){ |
| [537](#L537) | UnusedCSS\_DB::detach\_all\_rules(); |
| [538](#L538) | } |
| [539](#L539) |  |
| [540](#L540) | if ( $needs\_to\_cleared ) { |
| [541](#L541) |  |
| [542](#L542) | $this->uucss->clear\_cache( null, [ |
| [543](#L543) | 'soft' => true |
| [544](#L544) | ] ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | RapidLoad\_Base::fetch\_options(false); |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | public function deactivate() { |
| [553](#L553) |  |
| [554](#L554) | if ( ! isset( $\_REQUEST['deactivated'] ) || empty( $\_REQUEST['deactivated'] ) ) { |
| [555](#L555) | return; |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | if ( ! isset( $\_REQUEST['nonce'] ) || ! wp\_verify\_nonce( $\_REQUEST['nonce'], 'uucss\_activation' ) ) { |
| [559](#L559) | self::add\_admin\_notice( 'RapidLoad : Request verification failed for Activation. Contact support if the problem persists.', 'error' ); |
| [560](#L560) |  |
| [561](#L561) | return; |
| [562](#L562) | } |
| [563](#L563) |  |
| [564](#L564) | $options = self::get\_site\_option( 'autoptimize\_uucss\_settings' ); |
| [565](#L565) |  |
| [566](#L566) | unset( $options['uucss\_api\_key\_verified'] ); |
| [567](#L567) | unset( $options['uucss\_api\_key'] ); |
| [568](#L568) | unset( $options['whitelist\_packs'] ); |
| [569](#L569) |  |
| [570](#L570) | self::update\_site\_option( 'autoptimize\_uucss\_settings', $options ); |
| [571](#L571) |  |
| [572](#L572) | $cache\_key = 'pand-' . md5( 'first-uucss-job' ); |
| [573](#L573) | self::delete\_site\_option( $cache\_key ); |
| [574](#L574) |  |
| [575](#L575) | $this->uucss->vanish(); |
| [576](#L576) |  |
| [577](#L577) | self::$deactivating = true; |
| [578](#L578) |  |
| [579](#L579) | $notice = [ |
| [580](#L580) | 'action'      => 'activate', |
| [581](#L581) | 'message'     => 'RapidLoad : Deactivated your license for this site.', |
| [582](#L582) | 'main\_action' => [ |
| [583](#L583) | 'key'   => 'Reactivate', |
| [584](#L584) | 'value' => self::activation\_url( 'authorize' ) |
| [585](#L585) | ], |
| [586](#L586) | 'type'        => 'success' |
| [587](#L587) | ]; |
| [588](#L588) | self::add\_advanced\_admin\_notice( $notice ); |
| [589](#L589) |  |
| [590](#L590) | return; |
| [591](#L591) | } |
| [592](#L592) |  |
| [593](#L593) | public function first\_uucss\_job() { |
| [594](#L594) |  |
| [595](#L595) | if ( class\_exists('PAnD') && ! PAnD::is\_admin\_notice\_active( 'first-uucss-job-forever' ) ) { |
| [596](#L596) | return; |
| [597](#L597) | } |
| [598](#L598) |  |
| [599](#L599) | if(get\_current\_screen() && get\_current\_screen()->base == 'settings\_page\_uucss'){ |
| [600](#L600) | return; |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | $job = RapidLoad\_Settings::get\_first\_link(); |
| [604](#L604) |  |
| [605](#L605) | if ( $job && $job['status'] == 'success' ) : ?> |
| [606](#L606) | <div data-dismissible="first-uucss-job-forever" |
| [607](#L607) | class="updated notice uucss-notice notice-success is-dismissible"> |
| [608](#L608) | <h4><span class="dashicons dashicons-yes-alt"></span> RapidLoad successfully ran your first job!</h4> |
| [609](#L609) | <p><?php \_e( 'You slashed <strong>' . $job['meta']['stats']->reductionSize . ' </strong> of unused CSS - that\'s <strong>' . $job['meta']['stats']->reduction . '% </strong> of your total CSS file size. Way to go 👏', 'sample-text-domain' ); ?></p> |
| [610](#L610) | </div> |
| [611](#L611) | <?php endif; |
| [612](#L612) |  |
| [613](#L613) | if ( $job && $job['status'] == 'failed' ) : ?> |
| [614](#L614) | <div data-dismissible="first-uucss-job-forever" |
| [615](#L615) | class="error notice uucss-notice notice-error is-dismissible"> |
| [616](#L616) | <h4><span class="dashicons dashicons-no-alt"></span> RapidLoad : We were unable to remove unused css |
| [617](#L617) | from |
| [618](#L618) | your site 🤕</h4> |
| [619](#L619) |  |
| [620](#L620) | <div> |
| [621](#L621) | <p> Our team can help. Get in touch with support <a target="\_blank" |
| [622](#L622) | href="https://rapidload.zendesk.com/hc/en-us/requests/new">here</a> |
| [623](#L623) | </p> |
| [624](#L624) | <blockquote class="error notice"> |
| [625](#L625) | <strong>Link :</strong> <?php echo $job['url'] ?> <br> |
| [626](#L626) | <strong>Error :</strong> <?php echo $job['meta']['error']['code'] ?> <br> |
| [627](#L627) | <strong>Message :</strong> <?php echo $job['meta']['error']['message'] ?> |
| [628](#L628) | </blockquote> |
| [629](#L629) | </div> |
| [630](#L630) |  |
| [631](#L631) | </div> |
| [632](#L632) | <?php endif; |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | public function uucss\_connect(){ |
| [636](#L636) |  |
| [637](#L637) | if ( ! isset( $\_REQUEST['license\_key'] ) || empty( $\_REQUEST['license\_key'] ) ) { |
| [638](#L638) | wp\_send\_json\_error( 'License Key required' ); |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | $license\_key = $\_REQUEST['license\_key']; |
| [642](#L642) |  |
| [643](#L643) | $uucss\_api         = new RapidLoad\_Api(); |
| [644](#L644) | $uucss\_api->apiKey = $license\_key; |
| [645](#L645) | $results           = $uucss\_api->post( 'connect', [ 'url' => $this->transform\_url(get\_site\_url()), 'type' => 'wordpress' ] ); |
| [646](#L646) |  |
| [647](#L647) | if ( $uucss\_api->is\_error( $results ) ) { |
| [648](#L648) | if(isset($results->errors) && isset($results->errors[0])){ |
| [649](#L649) | wp\_send\_json\_error($results->errors[0]->detail); |
| [650](#L650) | }else{ |
| [651](#L651) | wp\_send\_json\_error('License Key verification fail'); |
| [652](#L652) | } |
| [653](#L653) | } |
| [654](#L654) |  |
| [655](#L655) | wp\_send\_json\_success([ |
| [656](#L656) | 'success' => true, |
| [657](#L657) | 'message' => 'License Key verification success', |
| [658](#L658) | 'activation\_nonce' => wp\_create\_nonce( 'uucss\_activation' ), |
| [659](#L659) | ]); |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | public function ajax\_deactivate() { |
| [663](#L663) |  |
| [664](#L664) | $options = self::get\_site\_option( 'autoptimize\_uucss\_settings' ); |
| [665](#L665) |  |
| [666](#L666) | $cache\_key = 'pand-' . md5( 'first-uucss-job' ); |
| [667](#L667) | self::delete\_site\_option( $cache\_key ); |
| [668](#L668) |  |
| [669](#L669) | $this->uucss->vanish(); |
| [670](#L670) |  |
| [671](#L671) | $api = new RapidLoad\_Api(); |
| [672](#L672) |  |
| [673](#L673) | // remove domain from authorized list |
| [674](#L674) | $api->post( 'deactivate', [ |
| [675](#L675) | 'url' => site\_url() |
| [676](#L676) | ] ); |
| [677](#L677) |  |
| [678](#L678) | unset( $options['uucss\_api\_key\_verified'] ); |
| [679](#L679) | unset( $options['uucss\_api\_key'] ); |
| [680](#L680) | unset( $options['whitelist\_packs'] ); |
| [681](#L681) |  |
| [682](#L682) | self::update\_site\_option( 'autoptimize\_uucss\_settings', $options ); |
| [683](#L683) |  |
| [684](#L684) | wp\_send\_json\_success( true ); |
| [685](#L685) | } |
| [686](#L686) |  |
| [687](#L687) | public function validate\_domain() { |
| [688](#L688) |  |
| [689](#L689) | if ( get\_current\_screen() && get\_current\_screen()->base != 'settings\_page\_uucss' ) { |
| [690](#L690) | return; |
| [691](#L691) | } |
| [692](#L692) |  |
| [693](#L693) | $options   = self::get\_site\_option( 'autoptimize\_uucss\_settings' ); |
| [694](#L694) |  |
| [695](#L695) | if(!isset( $options['uucss\_api\_key\_verified'] ) || $options['uucss\_api\_key\_verified'] != '1'){ |
| [696](#L696) | return; |
| [697](#L697) | } |
| [698](#L698) |  |
| [699](#L699) | $uucss\_api = new RapidLoad\_Api(); |
| [700](#L700) |  |
| [701](#L701) | if ( ! isset( $options['uucss\_api\_key'] ) ) { |
| [702](#L702) | return; |
| [703](#L703) | } |
| [704](#L704) |  |
| [705](#L705) | $results = $uucss\_api->get( 'verify', [ 'url' => site\_url(), 'token' => $options['uucss\_api\_key'] ] ); |
| [706](#L706) |  |
| [707](#L707) | if($uucss\_api->is\_error($results)){ |
| [708](#L708) | $options['valid\_domain'] = false; |
| [709](#L709) | self::update\_site\_option('autoptimize\_uucss\_settings', $options); |
| [710](#L710) | return; |
| [711](#L711) | } |
| [712](#L712) |  |
| [713](#L713) | if(!isset($options['valid\_domain']) || !$options['valid\_domain']){ |
| [714](#L714) | $options['valid\_domain'] = true; |
| [715](#L715) | self::update\_site\_option('autoptimize\_uucss\_settings', $options); |
| [716](#L716) | } |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | public function uucss\_data() { |
| [720](#L720) |  |
| [721](#L721) | if ( ! isset( $\_REQUEST['nonce'] ) || ! wp\_verify\_nonce( $\_REQUEST['nonce'], 'uucss\_nonce' ) ) { |
| [722](#L722) | wp\_send\_json\_error( 'UnusedCSS - Malformed Request Detected, Contact Support.' ); |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | $type = isset($\_REQUEST['type']) ? $\_REQUEST['type'] : 'path'; |
| [726](#L726) |  |
| [727](#L727) | $start = isset($\_REQUEST['start']) ? $\_REQUEST['start'] : 0; |
| [728](#L728) | $length = isset($\_REQUEST['length']) ? $\_REQUEST['length'] : 10; |
| [729](#L729) | $draw = isset($\_REQUEST['draw']) ? $\_REQUEST['draw'] : 1; |
| [730](#L730) |  |
| [731](#L731) | $status\_filter = isset($\_REQUEST['columns']) && |
| [732](#L732) | isset($\_REQUEST['columns'][0]) && |
| [733](#L733) | isset($\_REQUEST['columns'][0]['search']) && |
| [734](#L734) | isset($\_REQUEST['columns'][0]['search']['value']) ? |
| [735](#L735) | $\_REQUEST['columns'][0]['search']['value'] : false; |
| [736](#L736) |  |
| [737](#L737) | $filters = []; |
| [738](#L738) |  |
| [739](#L739) | if($status\_filter){ |
| [740](#L740) |  |
| [741](#L741) | if($status\_filter == 'warning'){ |
| [742](#L742) |  |
| [743](#L743) | $filters[] = " warnings IS NOT NULL "; |
| [744](#L744) | }else{ |
| [745](#L745) |  |
| [746](#L746) | $filters[] = " status = '". $status\_filter . "' AND warnings IS NULL "; |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | }else{ |
| [750](#L750) |  |
| [751](#L751) | $filters[] = " status != 'rule-based' "; |
| [752](#L752) |  |
| [753](#L753) | } |
| [754](#L754) |  |
| [755](#L755) | $url\_filter = isset($\_REQUEST['columns']) && |
| [756](#L756) | isset($\_REQUEST['columns'][1]) && |
| [757](#L757) | isset($\_REQUEST['columns'][1]['search']) && |
| [758](#L758) | isset($\_REQUEST['columns'][1]['search']['value']) ? |
| [759](#L759) | $\_REQUEST['columns'][1]['search']['value'] : false; |
| [760](#L760) |  |
| [761](#L761) | $url\_regex = isset($\_REQUEST['columns']) && |
| [762](#L762) | isset($\_REQUEST['columns'][1]) && |
| [763](#L763) | isset($\_REQUEST['columns'][1]['search']) && |
| [764](#L764) | isset($\_REQUEST['columns'][1]['search']['regex']) ? |
| [765](#L765) | $\_REQUEST['columns'][1]['search']['regex'] : false; |
| [766](#L766) |  |
| [767](#L767) | if($url\_regex == 'true' && $url\_filter){ |
| [768](#L768) |  |
| [769](#L769) | $filters[] = " url = '". $url\_filter . "' "; |
| [770](#L770) |  |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | if($url\_regex == 'false' && $url\_filter){ |
| [774](#L774) |  |
| [775](#L775) | $filters[] = " url LIKE '%". $url\_filter . "%' "; |
| [776](#L776) |  |
| [777](#L777) | } |
| [778](#L778) |  |
| [779](#L779) | $where\_clause = ''; |
| [780](#L780) |  |
| [781](#L781) | foreach ($filters as $key => $filter){ |
| [782](#L782) |  |
| [783](#L783) | if($key == 0){ |
| [784](#L784) |  |
| [785](#L785) | $where\_clause = ' WHERE '; |
| [786](#L786) | $where\_clause .= $filter; |
| [787](#L787) | }else{ |
| [788](#L788) |  |
| [789](#L789) | $where\_clause .= ' AND '; |
| [790](#L790) | $where\_clause .= $filter; |
| [791](#L791) | } |
| [792](#L792) |  |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | $data  = $type == 'path' ? |
| [796](#L796) | UnusedCSS\_DB::get\_links($start, $length, $where\_clause): |
| [797](#L797) | UnusedCSS\_DB::get\_rules($start, $length, $where\_clause); |
| [798](#L798) |  |
| [799](#L799) | wp\_send\_json([ |
| [800](#L800) | 'data' => $data, |
| [801](#L801) | "draw" => (int)$draw, |
| [802](#L802) | "recordsTotal" => $type == 'path' ? UnusedCSS\_DB::get\_total\_job\_count() : UnusedCSS\_DB::get\_total\_rule\_count(), |
| [803](#L803) | "recordsFiltered" => $type == 'path' ? UnusedCSS\_DB::get\_total\_job\_count($where\_clause) : UnusedCSS\_DB::get\_total\_rule\_count($where\_clause), |
| [804](#L804) | "success" => true |
| [805](#L805) | ]); |
| [806](#L806) | } |
| [807](#L807) |  |
| [808](#L808) | public function enqueueScripts() { |
| [809](#L809) |  |
| [810](#L810) | $deregister\_scripts = apply\_filters('uucss/scripts/deregister', ['select2']); |
| [811](#L811) |  |
| [812](#L812) | if(isset($deregister\_scripts) && is\_array($deregister\_scripts)){ |
| [813](#L813) | foreach ($deregister\_scripts as $deregister\_script){ |
| [814](#L814) | wp\_dequeue\_script($deregister\_script); |
| [815](#L815) | wp\_deregister\_script($deregister\_script); |
| [816](#L816) | } |
| [817](#L817) | } |
| [818](#L818) |  |
| [819](#L819) | wp\_enqueue\_script( 'select2', UUCSS\_PLUGIN\_URL . 'assets/libs/select2/select2.min.js', array( 'jquery' ) ); |
| [820](#L820) |  |
| [821](#L821) | wp\_enqueue\_script( 'datatables', UUCSS\_PLUGIN\_URL . 'assets/libs/datatables/jquery.dataTables.min.js', array( |
| [822](#L822) | 'jquery', |
| [823](#L823) | 'uucss\_admin' |
| [824](#L824) | ) ); |
| [825](#L825) | wp\_enqueue\_style( 'datatables', UUCSS\_PLUGIN\_URL . 'assets/libs/datatables/jquery.dataTables.min.css' ); |
| [826](#L826) |  |
| [827](#L827) | wp\_register\_script( 'uucss\_admin', UUCSS\_PLUGIN\_URL . 'assets/js/uucss\_admin.js', array( |
| [828](#L828) | 'jquery', |
| [829](#L829) | 'wp-util' |
| [830](#L830) | ), UUCSS\_VERSION ); |
| [831](#L831) |  |
| [832](#L832) | wp\_register\_script( 'uucss\_log', UUCSS\_PLUGIN\_URL . 'assets/js/uucss\_log.js', array( |
| [833](#L833) | 'jquery', |
| [834](#L834) | 'wp-util' |
| [835](#L835) | ), UUCSS\_VERSION ); |
| [836](#L836) |  |
| [837](#L837) | $deregister\_styles = apply\_filters('uucss/styles/deregister',[]); |
| [838](#L838) |  |
| [839](#L839) | if(isset($deregister\_styles) && is\_array($deregister\_styles)){ |
| [840](#L840) | foreach ($deregister\_styles as $deregister\_style){ |
| [841](#L841) | wp\_dequeue\_style($deregister\_style); |
| [842](#L842) | } |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | wp\_enqueue\_style( 'uucss\_admin', UUCSS\_PLUGIN\_URL . 'assets/css/uucss\_admin.css', [], UUCSS\_VERSION ); |
| [846](#L846) |  |
| [847](#L847) | global $rapidload; |
| [848](#L848) |  |
| [849](#L849) | $data = array( |
| [850](#L850) | 'api' => RapidLoad\_Api::get\_key(), |
| [851](#L851) | 'nonce' => wp\_create\_nonce( 'uucss\_nonce' ), |
| [852](#L852) | 'url' => site\_url(), |
| [853](#L853) | 'ajax\_url'          => admin\_url( 'admin-ajax.php' ), |
| [854](#L854) | 'setting\_url'       => admin\_url( 'options-general.php?page=uucss' ), |
| [855](#L855) | 'on\_board\_complete' => apply\_filters('uucss/on-board/complete', false), |
| [856](#L856) | 'api\_key\_verified' => self::is\_api\_key\_verified(), |
| [857](#L857) | 'notifications' => $this->getNotifications(), |
| [858](#L858) | 'faqs' => [], |
| [859](#L859) | 'public\_notices' => [], |
| [860](#L860) | 'dev\_mode' => apply\_filters('uucss/dev\_mode', isset($this->uucss->options['uucss\_dev\_mode'])) && $this->uucss->options['uucss\_dev\_mode'] == "1", |
| [861](#L861) | 'rules\_enabled' => $rapidload->rules\_enabled(), |
| [862](#L862) | 'cpcss\_enabled' => $rapidload->critical\_css\_enabled(), |
| [863](#L863) | 'home\_url' => home\_url(), |
| [864](#L864) | 'uucss\_enable\_debug' => ! empty( $this->uucss->options['uucss\_enable\_debug'] ) && '1' === $this->uucss->options['uucss\_enable\_debug'], |
| [865](#L865) | ); |
| [866](#L866) |  |
| [867](#L867) | wp\_localize\_script( 'uucss\_admin', 'uucss', $data ); |
| [868](#L868) |  |
| [869](#L869) | wp\_enqueue\_script( 'uucss\_admin' ); |
| [870](#L870) | wp\_enqueue\_script( 'uucss\_log' ); |
| [871](#L871) |  |
| [872](#L872) | wp\_enqueue\_style( 'select2', UUCSS\_PLUGIN\_URL . 'assets/libs/select2/select2.min.css' ); |
| [873](#L873) |  |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | public function getNotifications() { |
| [877](#L877) |  |
| [878](#L878) | return apply\_filters('uucss/notifications', []); |
| [879](#L879) | } |
| [880](#L880) |  |
| [881](#L881) | public function run\_gpsi\_test\_for\_all(){ |
| [882](#L882) |  |
| [883](#L883) | $links = UnusedCSS\_DB::get\_links\_where(" WHERE status IN('success','rule-based') "); |
| [884](#L884) |  |
| [885](#L885) | if(!empty($links)){ |
| [886](#L886) |  |
| [887](#L887) | foreach ($links as $link){ |
| [888](#L888) |  |
| [889](#L889) | if(isset($link['meta']) && |
| [890](#L890) | isset($link['meta']['stats']) && |
| [891](#L891) | isset($link['meta']['stats']->success\_count) && |
| [892](#L892) | $link['meta']['stats']->success\_count > 0 || |
| [893](#L893) | isset($link['success\_count']) && $link['success\_count'] |
| [894](#L894) | ){ |
| [895](#L895) | continue; |
| [896](#L896) | } |
| [897](#L897) |  |
| [898](#L898) | $this->get\_gpsi\_test\_result($link); |
| [899](#L899) |  |
| [900](#L900) | } |
| [901](#L901) |  |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) | public function run\_gpsi\_status\_check\_for\_all(){ |
| [907](#L907) |  |
| [908](#L908) | $spawned = wp\_schedule\_single\_event( time() + 5, 'uucss\_run\_gpsi\_test\_for\_all'); |
| [909](#L909) |  |
| [910](#L910) | wp\_send\_json\_success([ |
| [911](#L911) | 'spawned' => $spawned |
| [912](#L912) | ]); |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | public function get\_public\_notices(){ |
| [916](#L916) |  |
| [917](#L917) | $api = new RapidLoad\_Api(); |
| [918](#L918) |  |
| [919](#L919) | $result = $api->get('notification'); |
| [920](#L920) |  |
| [921](#L921) | $data = !$api->is\_error($result) && isset($result->data) ? $result->data : []; |
| [922](#L922) |  |
| [923](#L923) | $data = array\_filter($data, function ($notice){ |
| [924](#L924) | $notice\_read = UnusedCSS\_Admin::get\_site\_option('uucss\_notice\_' . $notice->id . '\_read'); |
| [925](#L925) | return empty($notice\_read); |
| [926](#L926) | }); |
| [927](#L927) |  |
| [928](#L928) | $keys = array\_keys($data); |
| [929](#L929) |  |
| [930](#L930) | if(empty($keys)){ |
| [931](#L931) | return $data; |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | $notices = []; |
| [935](#L935) |  |
| [936](#L936) | foreach ($data as $key => $notice){ |
| [937](#L937) | array\_push($notices, $notice); |
| [938](#L938) | } |
| [939](#L939) |  |
| [940](#L940) | return $notices; |
| [941](#L941) | } |
| [942](#L942) |  |
| [943](#L943) | public function get\_gpsi\_test\_result($link){ |
| [944](#L944) |  |
| [945](#L945) | $uucss\_api = new RapidLoad\_Api(); |
| [946](#L946) |  |
| [947](#L947) | $cached\_files = []; |
| [948](#L948) | $original\_files = []; |
| [949](#L949) |  |
| [950](#L950) | if(isset($link['files']) && !empty($link['files'])){ |
| [951](#L951) |  |
| [952](#L952) | $cached\_files = array\_filter($link['files'], function ($file){ |
| [953](#L953) | return !$this->str\_contains($file['original'], '//inline-style@'); |
| [954](#L954) | }); |
| [955](#L955) |  |
| [956](#L956) | $original\_files = array\_filter($link['files'], function ($file){ |
| [957](#L957) | return !$this->str\_contains($file['original'], '//inline-style@'); |
| [958](#L958) | }); |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) | do\_action( 'uucss/cached', [ |
| [962](#L962) | 'url' => $link['url'] |
| [963](#L963) | ]); |
| [964](#L964) |  |
| [965](#L965) | return $uucss\_api->post( 'test/wordpress', |
| [966](#L966) | [ |
| [967](#L967) | 'url' => urldecode($link['url']), |
| [968](#L968) | 'files' => !empty($cached\_files) ? array\_column($cached\_files, 'uucss') : [], |
| [969](#L969) | 'aoFiles' => !empty($original\_files) ? array\_column($original\_files, 'original') : [] |
| [970](#L970) | ]); |
| [971](#L971) |  |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | public function uucss\_test\_url(){ |
| [975](#L975) |  |
| [976](#L976) | global $uucss; |
| [977](#L977) |  |
| [978](#L978) | if(!isset($\_REQUEST['url'])){ |
| [979](#L979) | wp\_send\_json\_error('url required'); |
| [980](#L980) | } |
| [981](#L981) |  |
| [982](#L982) | $url = $\_REQUEST['url']; |
| [983](#L983) | $type = isset($\_REQUEST['type']) ? $\_REQUEST['type'] : 'path'; |
| [984](#L984) |  |
| [985](#L985) | if($type == 'rule'){ |
| [986](#L986) |  |
| [987](#L987) | if(!isset($\_REQUEST['rule']) || !isset($\_REQUEST['regex'])){ |
| [988](#L988) | wp\_send\_json\_error('rule and regex required'); |
| [989](#L989) | } |
| [990](#L990) |  |
| [991](#L991) | } |
| [992](#L992) |  |
| [993](#L993) | $uucss\_api = new RapidLoad\_Api(); |
| [994](#L994) |  |
| [995](#L995) | $link = $type == 'path' ? UnusedCSS\_DB::get\_link($url) : UnusedCSS\_DB::get\_rule($\_REQUEST['rule'],$\_REQUEST['regex']); |
| [996](#L996) |  |
| [997](#L997) | $result = $this->get\_gpsi\_test\_result($link); |
| [998](#L998) |  |
| [999](#L999) | if ( $uucss\_api->is\_error( $result ) ) { |
| [1000](#L1000) | if(isset($result->errors) && isset($result->errors[0])){ |
| [1001](#L1001) | wp\_send\_json\_error($result->errors[0]->detail); |
| [1002](#L1002) | }else{ |
| [1003](#L1003) | wp\_send\_json\_error($result); |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | wp\_send\_json\_success($result); |
| [1008](#L1008) | } |
| [1009](#L1009) |  |
| [1010](#L1010) | public function get\_faqs(){ |
| [1011](#L1011) |  |
| [1012](#L1012) | $rapidload\_faqs\_read = self::get\_site\_option('rapidload\_faqs\_read'); |
| [1013](#L1013) |  |
| [1014](#L1014) | if(!empty($rapidload\_faqs\_read)){ |
| [1015](#L1015) | return []; |
| [1016](#L1016) | } |
| [1017](#L1017) |  |
| [1018](#L1018) | $api = new RapidLoad\_Api(); |
| [1019](#L1019) |  |
| [1020](#L1020) | $result = $api->get('faqs'); |
| [1021](#L1021) |  |
| [1022](#L1022) | $default = [ |
| [1023](#L1023) | [ |
| [1024](#L1024) | "title" => "I enabled RapidLoad and now my site is broken. What do I do?", |
| [1025](#L1025) | "message" => "If you are encountering layout or styling issues on a RapidLoad optimized page, try enabling the “Load Original CSS Files” option or <a href='https://rapidload.zendesk.com/hc/en-us/articles/360063292673-Sitewide-Safelists-Blocklists'>adding safelist rules</a> for affected elements in the plugin Advanced Settings. Always remember to requeue affected pages after making plugin changes. Need more help? Head over to the RapidLoad docs for more information or to submit a Support request: <a href='https://rapidload.zendesk.com/hc/en-us'>https://rapidload.zendesk.com/hc/en-us</a>", |
| [1026](#L1026) | ], |
| [1027](#L1027) | [ |
| [1028](#L1028) | "title" => "Why am I still seeing the “Removed unused CSS” flag in Google Page Speed Insights?", |
| [1029](#L1029) | "message" => "It’s possible that the RapidLoad optimized version of the page is not yet being served. Try clearing your page cache and running the GPSI test again.", |
| [1030](#L1030) | ], |
| [1031](#L1031) | [ |
| [1032](#L1032) | "title" => "Will this plugin work with other caching plugins?", |
| [1033](#L1033) | "message" => "RapidLoad works with all major caching plugins. If you are using a little known caching plugin and are experiencing issues with RapidLoad, please submit your issue and caching plugin name to our support team and we will review.", |
| [1034](#L1034) | ], |
| [1035](#L1035) | [ |
| [1036](#L1036) | "title" => "Do I need to run this every time I make a change?", |
| [1037](#L1037) | "message" => "No! RapidLoad works in the background, so any new stylesheets that are added will be analyzed and optimized on the fly. Just set it and forget it!", |
| [1038](#L1038) | ], |
| [1039](#L1039) | [ |
| [1040](#L1040) | "title" => "Do you offer support if I need it?", |
| [1041](#L1041) | "message" => "Yes, our team is standing by to assist you! Submit a support ticket any time from the Support tab in the plugin and we’ll be happy to help.", |
| [1042](#L1042) | ] |
| [1043](#L1043) | ]; |
| [1044](#L1044) |  |
| [1045](#L1045) | return !$api->is\_error($result) && isset($result->data) ? $result->data : $default; |
| [1046](#L1046) | } |
| [1047](#L1047) |  |
| [1048](#L1048) | public function clear\_uucss\_logs(){ |
| [1049](#L1049) | $file\_system = new RapidLoad\_FileSystem(); |
| [1050](#L1050) |  |
| [1051](#L1051) | if(!$file\_system->exists(WP\_CONTENT\_DIR . '/uploads/rapidload/')){ |
| [1052](#L1052) | wp\_send\_json\_success(true); |
| [1053](#L1053) | } |
| [1054](#L1054) |  |
| [1055](#L1055) | $file\_system->delete\_folder(WP\_CONTENT\_DIR . '/uploads/rapidload/'); |
| [1056](#L1056) | wp\_send\_json\_success(true); |
| [1057](#L1057) | } |
| [1058](#L1058) |  |
| [1059](#L1059) | public function uucss\_logs(){ |
| [1060](#L1060) |  |
| [1061](#L1061) | $file\_system = new RapidLoad\_FileSystem(); |
| [1062](#L1062) |  |
| [1063](#L1063) | if(!$file\_system->exists(UUCSS\_LOG\_DIR . 'debug.log')){ |
| [1064](#L1064) | wp\_send\_json\_success([]); |
| [1065](#L1065) | } |
| [1066](#L1066) |  |
| [1067](#L1067) | $data = $file\_system->get\_contents(UUCSS\_LOG\_DIR . 'debug.log'); |
| [1068](#L1068) |  |
| [1069](#L1069) | if(empty($data)){ |
| [1070](#L1070) | wp\_send\_json\_success([]); |
| [1071](#L1071) | } |
| [1072](#L1072) |  |
| [1073](#L1073) | $data = '[' . $data . ']'; |
| [1074](#L1074) |  |
| [1075](#L1075) | wp\_send\_json\_success(json\_decode($data)); |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | public function frontend\_logs(){ |
| [1079](#L1079) |  |
| [1080](#L1080) | $args = []; |
| [1081](#L1081) |  |
| [1082](#L1082) | $args['type'] = isset($\_REQUEST['type']) && !empty($\_REQUEST['type']) ? $\_REQUEST['type'] : 'frontend'; |
| [1083](#L1083) | $args['log'] = isset($\_REQUEST['log']) && !empty($\_REQUEST['log']) ? $\_REQUEST['log'] : ''; |
| [1084](#L1084) | $args['url'] = isset($\_REQUEST['url']) && !empty($\_REQUEST['url']) ? $\_REQUEST['url'] : ''; |
| [1085](#L1085) |  |
| [1086](#L1086) | self::log($args); |
| [1087](#L1087) |  |
| [1088](#L1088) | wp\_send\_json\_success(true); |
| [1089](#L1089) | } |
| [1090](#L1090) |  |
| [1091](#L1091) | public function mark\_faqs\_read(){ |
| [1092](#L1092) |  |
| [1093](#L1093) | self::update\_site\_option('rapidload\_faqs\_read', true); |
| [1094](#L1094) | wp\_send\_json\_success(true); |
| [1095](#L1095) | } |
| [1096](#L1096) |  |
| [1097](#L1097) | public function mark\_notice\_read(){ |
| [1098](#L1098) |  |
| [1099](#L1099) | $notice\_id = isset($\_REQUEST['notice\_id']) ? $\_REQUEST['notice\_id'] : false; |
| [1100](#L1100) |  |
| [1101](#L1101) | if($notice\_id){ |
| [1102](#L1102) | self::update\_site\_option('uucss\_notice\_' . $notice\_id . '\_read', true); |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | wp\_send\_json\_success(true); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | public function clear\_page\_cache(){ |
| [1109](#L1109) |  |
| [1110](#L1110) | $url = isset($\_REQUEST['url']) ? $\_REQUEST['url'] : false; |
| [1111](#L1111) | $rule = isset($\_REQUEST['rule']) ? $\_REQUEST['rule'] : false; |
| [1112](#L1112) | $regex = isset($\_REQUEST['regex']) ? $\_REQUEST['regex'] : false; |
| [1113](#L1113) |  |
| [1114](#L1114) | $status = isset($\_REQUEST['status']) ? $\_REQUEST['status'] : false; |
| [1115](#L1115) |  |
| [1116](#L1116) | $type = isset($\_REQUEST['type']) ? $\_REQUEST['status'] : 'path'; |
| [1117](#L1117) |  |
| [1118](#L1118) | if($url){ |
| [1119](#L1119) |  |
| [1120](#L1120) | UnusedCSS\_DB::reset\_hits($url); |
| [1121](#L1121) | do\_action( 'uucss/cached', [ |
| [1122](#L1122) | 'url' => $url |
| [1123](#L1123) | ] ); |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | $links = false; |
| [1127](#L1127) |  |
| [1128](#L1128) | if($rule && $regex){ |
| [1129](#L1129) |  |
| [1130](#L1130) | $rule = UnusedCSS\_DB::get\_rule($rule, $regex); |
| [1131](#L1131) |  |
| [1132](#L1132) | if(isset($rule['id'])){ |
| [1133](#L1133) |  |
| [1134](#L1134) | $links = UnusedCSS\_DB::get\_links\_where(" WHERE rule\_id = " . $rule['id']); |
| [1135](#L1135) |  |
| [1136](#L1136) | } |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | if($status){ |
| [1140](#L1140) |  |
| [1141](#L1141) | UnusedCSS\_DB::reset\_hits(); |
| [1142](#L1142) |  |
| [1143](#L1143) | if($type == 'path'){ |
| [1144](#L1144) |  |
| [1145](#L1145) | $links = UnusedCSS\_DB::get\_links\_where(' '); |
| [1146](#L1146) |  |
| [1147](#L1147) | }else{ |
| [1148](#L1148) |  |
| [1149](#L1149) | $links = UnusedCSS\_DB::get\_rules\_where(' '); |
| [1150](#L1150) |  |
| [1151](#L1151) | } |
| [1152](#L1152) |  |
| [1153](#L1153) | } |
| [1154](#L1154) |  |
| [1155](#L1155) | if($links && !empty($links)){ |
| [1156](#L1156) |  |
| [1157](#L1157) | foreach ($links as $link){ |
| [1158](#L1158) |  |
| [1159](#L1159) | if(isset($link['url'])){ |
| [1160](#L1160) | self::uucss\_log($link['url']); |
| [1161](#L1161) | do\_action( 'uucss/cached', [ |
| [1162](#L1162) | 'url' => $link['url'] |
| [1163](#L1163) | ] ); |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) | wp\_send\_json\_success('page cache cleared'); |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | public static function is\_api\_key\_verified() { |
| [1172](#L1172) |  |
| [1173](#L1173) | $api\_key\_status = isset( RapidLoad\_Base::fetch\_options()['uucss\_api\_key\_verified'] ) ? RapidLoad\_Base::fetch\_options()['uucss\_api\_key\_verified'] : ''; |
| [1174](#L1174) |  |
| [1175](#L1175) | return $api\_key\_status == '1'; |
| [1176](#L1176) |  |
| [1177](#L1177) | } |
| [1178](#L1178) |  |
| [1179](#L1179) | public function add\_plugin\_action\_link( $links ) { |
| [1180](#L1180) |  |
| [1181](#L1181) | $\_links = array( |
| [1182](#L1182) | '<a href="' . admin\_url( 'options-general.php?page=uucss' ) . '">Settings</a>', |
| [1183](#L1183) | ); |
| [1184](#L1184) |  |
| [1185](#L1185) | return array\_merge( $\_links, $links ); |
| [1186](#L1186) | } |
| [1187](#L1187) |  |
| [1188](#L1188) | public function add\_meta\_boxes() |
| [1189](#L1189) | { |
| [1190](#L1190) | add\_meta\_box( |
| [1191](#L1191) | 'uucss-options', |
| [1192](#L1192) | \_\_( 'RapidLoad Options', 'uucss' ), |
| [1193](#L1193) | [$this, 'meta\_box'], |
| [1194](#L1194) | get\_post\_types(), |
| [1195](#L1195) | 'side' |
| [1196](#L1196) | ); |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | public function meta\_box( $post ) { |
| [1200](#L1200) |  |
| [1201](#L1201) | $options = RapidLoad\_Base::get\_page\_options($post->ID); |
| [1202](#L1202) |  |
| [1203](#L1203) | include('parts/admin-post.html.php'); |
| [1204](#L1204) | } |
| [1205](#L1205) |  |
| [1206](#L1206) | public function save\_meta\_box\_options($post\_id, $post) |
| [1207](#L1207) | { |
| [1208](#L1208) | if ( !isset( $\_POST['uucss\_nonce'] ) || !wp\_verify\_nonce( $\_POST['uucss\_nonce'], 'uucss\_option\_save' ) ) { |
| [1209](#L1209) | return; |
| [1210](#L1210) | } |
| [1211](#L1211) |  |
| [1212](#L1212) | if (defined('DOING\_AUTOSAVE') && DOING\_AUTOSAVE) { |
| [1213](#L1213) | return; |
| [1214](#L1214) | } |
| [1215](#L1215) |  |
| [1216](#L1216) | $this->update\_meta($post\_id); |
| [1217](#L1217) |  |
| [1218](#L1218) | } |
| [1219](#L1219) |  |
| [1220](#L1220) | public function cache\_trigger\_hooks() { |
| [1221](#L1221) | add\_action( 'save\_post', [ $this, 'cache\_on\_actions' ], 110, 3 ); |
| [1222](#L1222) | add\_action( 'untrash\_post', [ $this, 'cache\_on\_actions' ], 10, 1 ); |
| [1223](#L1223) | add\_action( 'wp\_trash\_post', [ $this, 'clear\_on\_actions' ], 10, 1 ); |
| [1224](#L1224) | add\_action( "wp\_ajax\_uucss\_purge\_url", [ $this, 'ajax\_purge\_url' ] ); |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | public static function suggest\_whitelist\_packs() { |
| [1228](#L1228) |  |
| [1229](#L1229) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [1230](#L1230) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [1231](#L1231) | } |
| [1232](#L1232) |  |
| [1233](#L1233) | $plugins        = get\_plugins(); |
| [1234](#L1234) | $active\_plugins = array\_map( function ( $key, $item ) { |
| [1235](#L1235) |  |
| [1236](#L1236) | $item['slug'] = $key; |
| [1237](#L1237) |  |
| [1238](#L1238) | return $item; |
| [1239](#L1239) | }, array\_keys( $plugins ), $plugins ); |
| [1240](#L1240) |  |
| [1241](#L1241) | $api = new RapidLoad\_Api(); |
| [1242](#L1242) |  |
| [1243](#L1243) | $data = $api->post( 'whitelist-packs/wp-suggest', [ |
| [1244](#L1244) | 'plugins' => $active\_plugins, |
| [1245](#L1245) | 'theme'   => get\_template(), |
| [1246](#L1246) | 'url'     => site\_url() |
| [1247](#L1247) | ] ); |
| [1248](#L1248) |  |
| [1249](#L1249) | if ( wp\_doing\_ajax() ) { |
| [1250](#L1250) | wp\_send\_json\_success( $data->data ); |
| [1251](#L1251) | } |
| [1252](#L1252) |  |
| [1253](#L1253) | return isset($data) && is\_array($data) ? $data : []; |
| [1254](#L1254) | } |
| [1255](#L1255) |  |
| [1256](#L1256) | public function uucss\_license() { |
| [1257](#L1257) |  |
| [1258](#L1258) | $api = new RapidLoad\_Api(); |
| [1259](#L1259) |  |
| [1260](#L1260) | $data = $api->get( 'license', [ |
| [1261](#L1261) | 'url' => $this->transform\_url(get\_site\_url()), |
| [1262](#L1262) | 'version' => UUCSS\_VERSION, |
| [1263](#L1263) | 'db\_version' => RapidLoad\_DB::$db\_version, |
| [1264](#L1264) | 'db\_version\_exist' => RapidLoad\_DB::$current\_version |
| [1265](#L1265) | ] ); |
| [1266](#L1266) |  |
| [1267](#L1267) | if ( ! is\_wp\_error( $data ) ) { |
| [1268](#L1268) |  |
| [1269](#L1269) | if ( isset( $data->errors ) ) { |
| [1270](#L1270) | wp\_send\_json\_error( $data->errors[0]->detail ); |
| [1271](#L1271) | } |
| [1272](#L1272) |  |
| [1273](#L1273) | if ( gettype( $data ) === 'string' ) { |
| [1274](#L1274) | wp\_send\_json\_error( $data ); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | do\_action( 'uucss/license-verified' ); |
| [1278](#L1278) |  |
| [1279](#L1279) | wp\_send\_json\_success( $data->data ); |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | wp\_send\_json\_error( 'unknown error occurred' ); |
| [1283](#L1283) | } |
| [1284](#L1284) |  |
| [1285](#L1285) | public function verify\_api\_key() { |
| [1286](#L1286) |  |
| [1287](#L1287) | if ( ! isset( $\_POST['api\_key'] ) ) { |
| [1288](#L1288) | wp\_send\_json\_error(); |
| [1289](#L1289) |  |
| [1290](#L1290) | return; |
| [1291](#L1291) | } |
| [1292](#L1292) |  |
| [1293](#L1293) | $uucss\_api         = new RapidLoad\_Api(); |
| [1294](#L1294) | $uucss\_api->apiKey = sanitize\_text\_field( $\_POST['api\_key'] ); |
| [1295](#L1295) |  |
| [1296](#L1296) | $results = $uucss\_api->get( 'verify' ); |
| [1297](#L1297) |  |
| [1298](#L1298) | if ( isset( $results->data ) ) { |
| [1299](#L1299) | wp\_send\_json\_success( true ); |
| [1300](#L1300) | } |
| [1301](#L1301) |  |
| [1302](#L1302) | wp\_send\_json\_error(); |
| [1303](#L1303) |  |
| [1304](#L1304) | } |
| [1305](#L1305) |  |
| [1306](#L1306) | public function ajax\_purge\_url() { |
| [1307](#L1307) |  |
| [1308](#L1308) | if ( ! isset( $\_POST['nonce'] ) || ! wp\_verify\_nonce( $\_POST['nonce'], 'uucss\_nonce' ) ) { |
| [1309](#L1309) | wp\_send\_json\_error( 'authentication failed' ); |
| [1310](#L1310) |  |
| [1311](#L1311) | return; |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | $args = isset($\_POST['args']) ? $\_POST['args'] : []; |
| [1315](#L1315) |  |
| [1316](#L1316) | if ( ! isset( $\_POST['url'] ) ) { |
| [1317](#L1317) | wp\_send\_json\_error(); |
| [1318](#L1318) |  |
| [1319](#L1319) | return; |
| [1320](#L1320) | } |
| [1321](#L1321) |  |
| [1322](#L1322) | if ( isset( $\_POST['args'] ) ) { |
| [1323](#L1323) | $args['post\_id'] = ( isset( $\_POST['args']['post\_id'] ) ) ? intval( $\_POST['args']['post\_id'] ) : null; |
| [1324](#L1324) | } |
| [1325](#L1325) |  |
| [1326](#L1326) | $url = esc\_url\_raw( $\_POST['url'] ); |
| [1327](#L1327) |  |
| [1328](#L1328) | if(isset($args['rule\_id'])){ |
| [1329](#L1329) | $rule = UnusedCSS\_Rule::get\_rule\_from\_id($args['rule\_id']); |
| [1330](#L1330) | if($rule){ |
| [1331](#L1331) | $url = $rule->url; |
| [1332](#L1332) | $args['rule'] = $rule->rule; |
| [1333](#L1333) | $args['regex'] = $rule->regex; |
| [1334](#L1334) | } |
| [1335](#L1335) | } |
| [1336](#L1336) |  |
| [1337](#L1337) | if ( isset( $\_POST['clear'] ) && boolval($\_POST['clear'] == 'true') ) { |
| [1338](#L1338) | $list = isset($\_POST['url\_list']) ? $\_POST['url\_list'] : null; |
| [1339](#L1339) |  |
| [1340](#L1340) | if(isset($list) && is\_array($list) && !empty($list)){ |
| [1341](#L1341) | foreach ($list as $item){ |
| [1342](#L1342) |  |
| [1343](#L1343) | $url = is\_array($item) && isset($item['url']) ? $item['url'] : $item; |
| [1344](#L1344) |  |
| [1345](#L1345) | if(is\_array($item) && isset($item['rule'])){ |
| [1346](#L1346) | $args['rule'] = $item['rule']; |
| [1347](#L1347) | } |
| [1348](#L1348) |  |
| [1349](#L1349) | if(is\_array($item) && isset($item['regex'])){ |
| [1350](#L1350) | $args['regex'] = $item['regex']; |
| [1351](#L1351) | } |
| [1352](#L1352) |  |
| [1353](#L1353) | $this->uucss->clear\_cache( $url, $args ); |
| [1354](#L1354) | } |
| [1355](#L1355) | }else{ |
| [1356](#L1356) | $this->uucss->clear\_cache( $url, $args ); |
| [1357](#L1357) | } |
| [1358](#L1358) |  |
| [1359](#L1359) | wp\_send\_json\_success( true ); |
| [1360](#L1360) | return; |
| [1361](#L1361) | } |
| [1362](#L1362) |  |
| [1363](#L1363) | if ( isset( $args["post\_id"] ) ) { |
| [1364](#L1364) | $args['options'] = $this->uucss->api\_options( $args["post\_id"] ); |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | $args['immediate'] = true; |
| [1368](#L1368) | $args['priority'] = true; |
| [1369](#L1369) |  |
| [1370](#L1370) | wp\_send\_json\_success( $this->uucss->cache( $url, $args ) ); |
| [1371](#L1371) | } |
| [1372](#L1372) |  |
| [1373](#L1373) | /\*\* |
| [1374](#L1374) | \* @param $post\_id |
| [1375](#L1375) | \* @param $post WP\_Post |
| [1376](#L1376) | \* @param $update |
| [1377](#L1377) | \*/ |
| [1378](#L1378) | public function cache\_on\_actions($post\_id, $post = null, $update = null) |
| [1379](#L1379) | { |
| [1380](#L1380) |  |
| [1381](#L1381) | $post = get\_post($post\_id); |
| [1382](#L1382) |  |
| [1383](#L1383) | if($post->post\_status == "publish") { |
| [1384](#L1384) |  |
| [1385](#L1385) | $this->clear\_on\_actions( $post->ID ); |
| [1386](#L1386) |  |
| [1387](#L1387) | $url = get\_permalink( $post ); |
| [1388](#L1388) |  |
| [1389](#L1389) | if(UnusedCSS\_DB::link\_exists\_with\_error($url) || !RapidLoad\_Base::get()->rules\_enabled()){ |
| [1390](#L1390) | $this->uucss->cache( $url ); |
| [1391](#L1391) | } |
| [1392](#L1392) |  |
| [1393](#L1393) | } |
| [1394](#L1394) | } |
| [1395](#L1395) |  |
| [1396](#L1396) | public function clear\_on\_actions($post\_ID) |
| [1397](#L1397) | { |
| [1398](#L1398) | $link = get\_permalink($post\_ID); |
| [1399](#L1399) |  |
| [1400](#L1400) | if($link){ |
| [1401](#L1401) | $this->uucss->clear\_cache($link); |
| [1402](#L1402) | } |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | public function update\_meta($post\_id) |
| [1406](#L1406) | { |
| [1407](#L1407) | foreach (self::$page\_options as $option) { |
| [1408](#L1408) |  |
| [1409](#L1409) | if ( ! isset( $\_POST[ 'uucss\_' . $option ] ) ) { |
| [1410](#L1410) | delete\_post\_meta( $post\_id, '\_uucss\_' . $option ); |
| [1411](#L1411) | continue; |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | $value = sanitize\_text\_field( $\_POST[ 'uucss\_' . $option ] ); |
| [1415](#L1415) |  |
| [1416](#L1416) | update\_post\_meta( $post\_id, '\_uucss\_' . $option, $value ); |
| [1417](#L1417) | } |
| [1418](#L1418) | } |
| [1419](#L1419) |  |
| [1420](#L1420) | public static function get\_site\_option($name) |
| [1421](#L1421) | { |
| [1422](#L1422) | if(is\_multisite()){ |
| [1423](#L1423) |  |
| [1424](#L1424) | return get\_blog\_option(get\_current\_blog\_id(), $name, false); |
| [1425](#L1425) |  |
| [1426](#L1426) | } |
| [1427](#L1427) | return get\_site\_option( $name, false ); |
| [1428](#L1428) | } |
| [1429](#L1429) |  |
| [1430](#L1430) | public static function update\_site\_option($name, $value){ |
| [1431](#L1431) |  |
| [1432](#L1432) | if(is\_multisite()){ |
| [1433](#L1433) |  |
| [1434](#L1434) | return update\_blog\_option(get\_current\_blog\_id(), $name, $value); |
| [1435](#L1435) |  |
| [1436](#L1436) | } |
| [1437](#L1437) | return update\_site\_option($name, $value); |
| [1438](#L1438) | } |
| [1439](#L1439) |  |
| [1440](#L1440) | public static function delete\_site\_option($name){ |
| [1441](#L1441) |  |
| [1442](#L1442) | if(is\_multisite()){ |
| [1443](#L1443) |  |
| [1444](#L1444) | return delete\_blog\_option(get\_current\_blog\_id(), $name); |
| [1445](#L1445) |  |
| [1446](#L1446) | } |
| [1447](#L1447) | return delete\_site\_option($name); |
| [1448](#L1448) | } |
| [1449](#L1449) |  |
| [1450](#L1450) | public static function first\_job\_done(){ |
| [1451](#L1451) | return (RapidLoad\_Settings::get\_first\_link() ? true :  false); |
| [1452](#L1452) | } |
| [1453](#L1453) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/unusedcss/tags/1.7.1/includes/modules/unused-css/UnusedCSS_Admin.php?format=txt)
* [Original Format](/export/3222666/unusedcss/tags/1.7.1/includes/modules/unused-css/UnusedCSS_Admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_4184f432_20250115_080404.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# RapidLoad Power-Up for Autoptimize <= 1.7.1 - Cross-Site Request Forgery

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   RapidLoad Power-Up for Autoptimize <= 1.7.1 - Cross-Site Request Forgery

6.3

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:L](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:L/I:L/A:L)

| CVE | [CVE-2023-1472](https://www.cve.org/CVERecord?id=CVE-2023-1472) |
| --- | --- |
| CVSS | 6.3 (Medium) |
| Publicly Published | March 17, 2023 |
| Last Updated | January 22, 2024 |
| Researcher | [Marco Wotschka - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/marco-wotschka) |

### Description

The RapidLoad Power-Up for Autoptimize plugin for WordPress is vulnerable to Cross-Site Request Forgery in versions up to, and including, 1.7.1. This is due to missing or incorrect nonce validation on its AJAX actions. This makes it possible for unauthenticated attackers to invoke those functions, via forged request granted they can trick a site administrator into performing an action such as clicking on a link. Actions include resetting the API key, accessing or deleting log files, and deleting cache among others.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/unusedcss/tags/1.7.1/includes/modules/unused-css/UnusedCSS_Admin.php#L70)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Funusedcss%2Frapidload-power-up-for-autoptimize-171-cross-site-request-forgery&t=RapidLoad%20Power-Up%20for%20Autoptimize%20%3C%3D%201.7.1%20-%20Cross-Site%20Request%20Forgery "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Funusedcss%2Frapidload-power-up-for-autoptimize-171-cross-site-request-forgery&text=RapidLoad%20Power-Up%20for%20Autoptimize%20%3C%3D%201.7.1%20-%20Cross-Site%20Request%20Forgery "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Funusedcss%2Frapidload-power-up-for-autoptimize-171-cross-site-request-forgery "LinkedIn")
Email

## Vulnerability Details for RapidLoad – Optimize Web Vitals Automatically

#### [RapidLoad – Optimize Web Vitals Automatically](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/unusedcss)

| Software Type | Plugin |
| --- | --- |
| Software Slug | unusedcss [(view on wordpress.org)](https://wordpress.org/plugins/unusedcss) |
| Patched? | Yes |
| Remediation | Update to version 1.7.2, or a newer patched version |
| Affected Version | * <= 1.7.1 |
| Patched Version | * 1.7.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation


